{
    "id": "f4129796-ca62-4794-850b-8d724b695cd8",
    "created_at": "2023-01-12T15:02:07.133459Z",
    "updated_at": "2025-03-27T02:11:06.202857Z",
    "deleted_at": null,
    "sha1_hash": "dffe3834bc39f4662898131dcfb9af9282010d52",
    "title": "2022-10-11 - The Russian SpyAgent – a Decade Later and RAT Tools Remain at Risk",
    "authors": "",
    "file_creation_date": "2022-10-23T13:16:55Z",
    "file_modification_date": "2022-10-23T13:16:55Z",
    "file_size": 2127170,
    "plain_text": "# The Russian SpyAgent – a Decade Later and RAT Tools Remain at Risk\n\n**deepinstinct.com/blog/the-russian-spyagent-a-decade-later-and-rat-tools-remain-at-risk**\n\nOctober 11, 2022\n\n## Unit 221B Validates >99% Zero-Day and <0.1% False Positive Threat Prevention Accuracy\n\n[Learn more](https://www.deepinstinct.com/blog/qa-with-unit-221b-ceo-lance-james)\n\nOCTOBER 11, 2022\n\n[Deep Instinct Threat Lab](https://www.deepinstinct.com/author/deep-instinct-research)\n\nDeep Instinct Threat Lab researchers have observed changes in the distribution scheme of SpyAgent (A.K.A.\nTeamSpy/TVRat/TeamBot/Sheldor), a malware that likely originated over a decade ago based on the historical timeline below.\n\nSpyAgent is a malware that abuses legitimate, well-known remote access tools (RAT). The recent changes observed by our team allow the\nmalware to stay stealthy while bypassing and evading many security products.\n\nAttackers evading existing security controls is a trend we see increasing. This is a problem for the industry as most security solutions that were\ndeveloped with an “assume breach” mindset will miss these stealthy attacks until is it far too late to stop the damage.\n\n### Historical Background on SpyAgent:\n\nIn a report from [2011, a malware named “Sheldor” used DLL search order hijacking to abuse TeamViewer 5.0 for malicious activities.](https://web.archive.org/web/20111226101507/go.eset.com/us/resources/white-papers/CARO_2011.pdf)\nIn a report from [2013, a malware named “TeamSpy” used DLL search order hijacking to abuse TeamViewer 6.0 for malicious activities.](https://web.archive.org/web/20130508171555/https:/www.crysys.hu/teamspy/teamspy.pdf)\nThe report also shows a relationship between “Sheldor” and “TeamSpy.”\nIn a report from [2016, a malware named “Spy-Agent” used DLL search order hijacking to abuse TeamViewer 6.0 for malicious activities.](https://vms.drweb.com/virus/?_is=1&i=8415393)\nThe report contains unique URI patterns that the malware uses to communicate with the C&C server.\nSpyAgent’s main capabilities are leveraged to enhance the usage of TeamViewer by hooking some of the functions used by legitimate\napplications.\nThe most important thing that SpyAgent does is obtain the client's unique ID, which is required to connect to a computer using\nTeamViewer.\nOther hooks disable logging and hide the GUI of the application to make it stealthy and avoid detection.\n\n### 10 years later:\n\n[A report published in 2021 showed that the “Spy-Agent” malware has been observed shifting from hijacking TeamViewer to hijacking](https://www.trendmicro.com/en_us/research/21/k/campaign-abusing-rats-uses-fake-websites.html)\n“Safib Assistant,” a Russian replica of TeamViewer.\nThe report demonstrates the distribution scheme of the malware, using fake crypto applications as a theme.\nThe fake applications are actually downloaders of multiple malware families, which include different RATs and stealers, such as RedLine.\n“SpyAgent” is one of the downloaded malware families.\n\n### Recent Changes\n\n\n-----\n\nay 0, a s a c a ge as obse ed t e a e c ypto ca pa g st see 0 stead o us g S S o o Setup d oppe s,\nexecutable files over 700MB were used to evade detection. This is because many security products limit the size of scanned files to\ncompensate for performance issues. This is similar to the way the “Quartz.dll” SpyAgent files are inflated to 1GB+, as noted in the 2021 report.\nThis is done by simply appending a large overlay of zeros to the file, and this technique allows the file to be compressed to the actual size\nwithout the overlay.\n\nFigure 1: Overlay of zeros appended at the end of the file to inflate its’ size to avoid detection\nDue to their large size, the files are not stored in public malware repositories or sandboxes.\n\n[The large overlayed executables are droppers which use Microsoft’s .NET ClickOnce launch utility “AppLaunch.exe” to download and execute](https://app.any.run/tasks/379dee24-c7f4-4255-a581-64d218fbe9f5/)\nmalware files from the web.\n\n[More malicious files related to this change can be found by searching the included txt file inside the zip:](https://www.virustotal.com/gui/file/0cfdd88e61fc93fbdc189de21b2cdaec357c2d8a82cddb532db894530d7d9a66/relations)\n\nFigure 2: Contents of the text file included in the zip archive\n\nFigure 3: More\n\narchives containing the same text file\nThe text translates from Russian into:\n\n1. We execute the client inside the archive\n2. We enter our wallets to receive payments\n3. We are happy everyday because of the profit!\n\nIn June 2022, additional changes were observed.\n\nThe SpyAgent theme is no longer related to crypto applications.\n\n\n-----\n\ne d oppe es a e o ce aga o Setup es, o e e, t ey o o ge do oad a y add t o a a a e e cept Spy ge t bu d ed t\n“Safib Assistant.”\n\nSince “Safib Assistant” is a legitimate tool, similar to TeamViwer, just less known, this change lowers the detection rate for the campaign as the\nonly real malware is “SpyAgent.”\n\nHowever, as previously was reported, the “SpyAgent” DLL files are very large.\n\n[T1027.001 is a known MITRE technique that adversaries use to “decrease the effectiveness of certain tools and detection capabilities that are](https://attack.mitre.org/techniques/T1027/001/)\nnot designed or configured to scan large files. This may also reduce the likelihood of being collected for analysis. Public file scanning services,\nsuch as VirusTotal, limits the maximum size of an uploaded file to be analyzed.”\n\nExample file\n\n1565d137d235b65af1d1e4963ebc02eaf36cc81f870534674983bc6f67e5e274 is an Inno Setup file that during the writing of this article was\ndetected by four security vendors:\n\nFigure 4: Detection rate at first submission (2022-07\n18 06:04:01 UTC)\nThis file is inside three different zip files, which are not related to a crypto theme.\n\nThe dropper silently installs “Safib Assistant,” the software’s main executable hash is\nb8dde42c70d8c4a3511d5edffbc9f7f0c03dbda980e29693e71344f76da6bb0f and it is detected by only two security vendors, although it is not\nmalicious without the SpyAgent DLL:\n\nFigure 5: Metadata of the “Safib Assistant” main executable\n\nThe SpyAgent C&C server is thief[.]lol which resolved during the analysis to the IP address 185.125.206[.]172.\n\nDuring our investigation, the C&C was still working, allowing us to confirm that the malware bundled with “Safib Assistant” is indeed\n“SpyAgent:”\n\n\n-----\n\nFigure 6: SpyAgent C2 panel\n\n### Conclusion\n\nBoth TeamViewer and “Safib Assistant” are legitimate remote admin tools, however, without the spy-agent malware DLL which adds stealth\nthey are less useful for cybercriminal operations.\n\nOn the other hand, there are several other legitimate remote admin tools that don’t require any additional malicious DLL files to be stealthy\nwhich are used as-is by cybercriminals.\n\nDeep Instinct classifies such tools as dual-use because they are 3rd-party software that is not necessarily allowed to be used in a corporate\nnetwork as it can be used maliciously.\n\nDeep Instinct blocks the Safib Assistant application.\n\n### MITRE ATT&CK:\n\n\n**Tactic**\n\n\n**Technique**\n\n\n**Obse**\n\n<C&C\n<9dig\nhash>\n\n\nDiscovery T1082 System\nInformation\nDiscovery\n\n\n**Description**\n\nSpyAgent computes environment hash as an MD5 of the string created by concatenating the\nfollowing:\n\nValue 1 =\nto_uppercase(crc32(HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Cryptography\\MachineGuid))\n\nValue 2 = to_uppercase(crc32(HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\ProductName))\n\nValue 3 = to_uppercase(crc32(user name))\n\nValue 4 = to_uppercase(crc32(computer name))\n\n\n-----\n\n**Tactic**\n\nDefense\nEvasion\n\nCommand\nand\nControl\n\n### IOC\n\n\n**Technique**\n\nT1027.001\nObfuscated Files or\nInformation: Binary\nPadding\n\nT1574.002 Hijack\nExecution Flow: DLL\nSide-Loading\n\nT1140\nDeobfuscate/Decode\nFiles or Information\n\nT1219 Remote\nAccess Software\n\nT1071.001 Web\nProtocols\n\n\n**Description**\n\n\nSpyAgent’s quartz.dll uses the “Safib Assistant” 8002d\n\n                                                          - Assi\n\nSpyAgent’s avicap32.dll uses TeamViewer 28c4c\n\n                                                - Team\n\nSpyAgent uses HTTP for command and control <C&C\n<9dig\nhash>\n\n\n**Obse**\n\n\nSpyAgent’s quartz.dll was artificially inflated to the size of 1GB e2eea\n– 7z f\nbundl\n\nSpyAgent’s dropper executable was artificially inflated to the size of 700MB c7271\n– zip f\n\n\nSpyAgent hooks and patches various API functions called by the original DLLs used by TeamViewer\nand Safib Assistant\n\nSpyAgent comes with a config file (.cfg) that contains an encrypted configuration. The bitmap file\n(.bmp) is used for deriving the key to decrypt the config file\n\n\n[tv.dll](https://www.welivesecurity.com/2011/01/14/sheldor-shocked/)\n\n[msimg](https://blog.avast.com/a-deeper-look-into-malware-abusing-teamviewer)\n\navicap\n\nquartz\n\n80896\n– bmp\n\n6f496\n– cfg f\n\n\n1565d137d235b65af1d1e4963ebc02eaf36cc81f870534674983bc6f67e5e274\n\nActive Spy Agent C2:\n\n23.19.227[.]217\n\n45.66.151[.]237\n\n108.62.118[.]48\n\njmai[.]ink\n\n[Back To Blog](https://www.deepinstinct.com/blog)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-10-11 - The Russian SpyAgent – a Decade Later and RAT Tools Remain at Risk.pdf"
    ],
    "report_names": [
        "2022-10-11 - The Russian SpyAgent – a Decade Later and RAT Tools Remain at Risk.pdf"
    ],
    "threat_actors": [
        {
            "id": "1d8dd2ca-5592-482e-b89d-6a7e1a49f4f6",
            "created_at": "2023-01-06T13:46:38.408359Z",
            "updated_at": "2025-03-27T02:00:02.826069Z",
            "deleted_at": null,
            "main_name": "TeamSpy Crew",
            "aliases": [
                "TeamSpy",
                "Team Bear",
                "Anger Bear",
                "IRON LYRIC"
            ],
            "source_name": "MISPGALAXY:TeamSpy Crew",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535727,
    "ts_updated_at": 1743041466,
    "ts_creation_date": 1666531015,
    "ts_modification_date": 1666531015,
    "files": {
        "pdf": "https://archive.orkl.eu/dffe3834bc39f4662898131dcfb9af9282010d52.pdf",
        "text": "https://archive.orkl.eu/dffe3834bc39f4662898131dcfb9af9282010d52.txt",
        "img": "https://archive.orkl.eu/dffe3834bc39f4662898131dcfb9af9282010d52.jpg"
    }
}