{
    "id": "dcee0198-cf92-472a-8dc3-bd9728edb4f8",
    "created_at": "2023-01-12T15:09:58.514365Z",
    "updated_at": "2025-03-27T02:17:27.641022Z",
    "deleted_at": null,
    "sha1_hash": "0fefe8b5d15927646d48c062fa39ddf10a5e2a55",
    "title": "2019-11-09 - APT34 Event Analysis Report",
    "authors": "",
    "file_creation_date": "2022-05-28T02:26:59Z",
    "file_modification_date": "2022-05-28T02:26:59Z",
    "file_size": 1638807,
    "plain_text": "# APT34 Event Analysis Report\n\n**nsfocusglobal.com/apt34-event-analysis-report/**\n\nNovember 9, 2019 | Mina Hao\n\n## 1 Overview\n\n\nNovember 9, 2019\n\n\nOn April 18, 2019 a hacker/hacker organization sold a toolkit of the APT34 group, under the false\nname of Lab Dookhtegan, on a Telegram channel. The organization also posted screenshots of the\ntool‚Äôs backend panels, where victim data had been collected. Early in the middle of March 2019, this\nhacker/hacker organization had released and sold this toolkit on the Internet. Interestingly, the CEO of\na security company in Kuwait took to Twitter to stress in particular the authenticity of this post.\n\n\n-----\n\nTools included in the leaked toolkit are listed as follows:\n\nGlimpse: a new trojan based on PowerShell, dubbed BondUpdater by Palo Alto Networks\nPoisonFrog: an old version of BondUpdater\nHyperShell\nHighShell: dubbed TwoFace by Palo Alto Networks\nMinionProject: Fox management interface with the HighShell module loaded\nWebmask: HTTP proxy hijacking tool, the main tool behind DNSpionage, used for DNS tunneling\n\nNSFOCUS Security Labs and NSFOCUS M01N Security Research Team made an analysis of this\ntoolkit together and found that tools included in the leaked toolkit differed from the previously released\nattacks tools of the APT34 group. In this report, we have made a detailed analysis of the leaked tools\nfrom the perspectives of tactics, techniques and procedures (TTPs).\n\n### 1.1 Distribution of Attack Targets by Industry\n\nIn addition to countries in the Middle East, APT34 has also hit China Mainland, China Taiwan, Turkey,\nAlbania, and other countries and regions. China Mainland and China Taiwan both received a large\nproportion of attacks.\n\nThrough analysis, we have found 12 malicious WebShell files used to target China Energy\nConservation and Environmental Protection Group, China Railway Construction Corporation, and\nWestern Securities Co., Ltd. among other Chinese companies, as well as six such files used to be\nagainst companies in Hong Kong, Macao, and Taiwan.\n\n\n-----\n\nThe released toolkit also contains a lot of passwords which are packaged and released in different\narchives according to information sources.\n\nFrom the above figure, we can see that the archive names contain airport names and oil company\nnames. More than 12,000 weak passwords were disclosed this time.\n\n\n-----\n\n### 1.2 About APT34\n\nThe APT34 group, named by FireEye, uses tools and attack approaches that bear a high resemblance\nto the OilRig organization, an organization active in the Middle East followed up by Palo Alto Networks.\nThe APT34 group started to carry out malicious activities as early as in 2014, targeting governments\nand the financial, energy, chemical, and telecom sectors. This group, though often seen in the Middle\nEast, also hits China, as indicated in files leaked this time.\n\nOn November 4, 2017, FireEye discovered that this group exploited the vulnerability (CVE-201711882) to launch attacks by leveraging tools similar to those leaked this time.\n\n## 2 TTPs\n\nDuring the functional analysis of APT34‚Äôs leaked sample, we have ascertained the attack tactics and\ntechniques used by this hacking group, via a reverse deduction based on attack procedures. Overall,\nfour phases of the kill chain are involved: privilege escalation, collection, exfiltration, and command\nand control.\n\n**Privilege Escalation**\n\nThis leaked sample uses multiple WebShell backdoor programs like HighShell, HyperShell, and\nMinionProject, each of which is a .NET program. Some of these programs encrypt the communications\nin order to evade defense measures. By reference to the tool use record documents included in the\nleaked files and the list of websites compromised by APT34, we can see that this hacking group\nmainly uses these WebShell programs, placed in /owa/auth/, to target the Outlook email system of the\nExchange server. This sample‚Äôs attack targets are found all around the world, including 14 enterprises\nin the energy and securities sectors in the Chinese mainland. By the time this report is released, some\nof those WebShell backdoor programs are still active.\n\nThe following figure shows WebShell backdoors targeting companies in China:\n\nThe following table lists URLs of active WebShells:\n\n\n-----\n\nWebShellWebShell WebsiteWebsite Country/RegionCountry/Region\n\nhttps://202.***.***.31/owa/auth/signout.aspx rtarf.*****.th Thailand\n\nhttps://202.***.***.4/owa/auth/signout.aspx rtarf.*****.th Thailand\n\nhttps://122.***.***.136/owa/auth/error3.aspx mail.*****.com.tw Taiwan\n\nhttps://202.***.***.169/owa/auth/signin.aspx *****.com{outlook}\n\nhttps://202.***.***.206/owa/auth/signout.aspx wmail.*****.com\n\nhttps://213.***.***.51/owa/auth/logon.aspx *****.gov.tr{outlook} Turkey\n\nhttps://1.***.***.13/owa/auth/error1.aspx mail.*****.cn China\n\nhttps://1.***.***.14/owa/auth/error1.aspx mail.*****.cn China\n\nhttps://114.***.***.1/owa/auth/error1.aspx mail.generali-*****.cn China\n\nhttps://180.***.***.217/owa/auth/error3.aspx exchange.*****.com.cn China\n\nhttps://180.***.***.230/owa/auth/error1.aspx *****.com.cn China\n\nhttps://210.***.***.26/owa/auth/error1.aspx lswebext.*****.com.cn China\n\nhttps://221.***.***.230/owa/auth/outlook.aspx mail.*****.com.cn China\n\nhttps://222.***.***.8/owa/auth/outlook.aspx mail.*****.com.cn China\n\nhttps://222.***.***.76/owa/auth/error1.aspx *****.*****.com.cn China\n\nhttps://58.***.***.113/owa/auth/error1.aspx mail.*****.com.cn China\n\nhttps://60.***.***.237/owa/auth/error3.aspx *****.cn China\n\nhttps://60.***.***.237/owa/auth/logoff.aspx *****.cn China\n\nhttps://202.***.***.218/owa/auth/error1.aspx mail.*****.com\n\nhttps://202.***.***.218/owa/auth/exppw.aspx mail.*****.com\n\nhttps://132.***.***.165/owa/auth/logout.aspx CSEX.*****.technion.ac.il Israel\n\nhttps://132.***.***.165/owa/auth/signout.aspx CSEX.csf.*****.ac.il Israel\n\nhttps://209.***.***.35/owa/auth/logout.aspx mail.*****.co.zw Zimbabwe\n\nhttps://114.***.***.22/owa/auth/login.aspx mail.******.ws Samoa\n\nhttps://114.***.***.3/owa/auth/login.aspx mail.*****.ws Samoa\n\nhttps://185.***.***.199/owa/auth/logout.aspx ******.com.sa Saudi Arabia\n\nhttps://46.***.****.125/owa/auth/signin.aspx *****.com.sa Saudi Arabia\n\nhttps://51.***.***.170/owa/auth/owaauth.aspx *****.edu.sa Saudi Arabia\n\n\n-----\n\nWebShell Website Country/Region\n\nhttps://91.***.***.155/owa/auth/signin.aspx *****.gov.sa Saudi Arabia\n\nhttps://83.***.***.132/owa/auth/logon.aspx mail.*****.com.ps{outlook} Palestine\n\nhttps://78.***.***.199/owa/auth/logon.aspx *****.gov.qa{outlook} Qatar\n\nhttps://110.***.***.90/owa/auth/errorff.aspx mail.fmis.*****.gov.kh Cambodia\n\nhttps://211.***.***.68/owa/auth/error1.aspx mailexchange.*****.co.kr North Korea\n\nhttps://168.***.***.220/owa/auth/error3.aspx mail.tc-*****.co Colombia\n\nhttps://213.***.***.221/owa/auth/errorff.aspx *****.gov.kw Kuwait\n\nhttps://77.***.***.125/owa/auth/logout.aspx {ul.*****.lb} Lebanon\n\nhttps://202.***.***.11/owa/auth/error1.aspx webmail.*****.com.mo Macao\n\nhttps://202.***.***.141/owa/auth/error3.aspx *****.must.edu.mo Macao\n\nhttps://213.***.***.73/owa/auth/error4.aspx ad.*****.eg{shell} Egypt\n\nhttps://200.***.***.13/owa/auth/error3.aspx sre.*****.mx Mexico\n\nhttps://202.***.***.68/owa/auth/error0.aspx mfa.*****.mn Myanmar\n\nhttps://202.***.***.68/owa/auth/error1.aspx mifa.*****.mn Myanmar\n\nhttps://197.***.***.10/owa/auth/logout.aspx mail.*****.gov.ng Nigeria\n\nhttps://41.***.***.221/owa/auth/logout.aspx mail.*****.gov.ng Nigeria\n\nhttps://mail.*****.ae/owa/auth/change_password.aspx mail.*****.ae United Arab\nEmirates\n\nhttps://mail.*****.com.sa/owa/auth/GetLoginToken.aspx mail.*****.com.sa Saudi Arabia\n\nhttps://webmail.*****.bh/owa/auth/Timeoutctl.aspx webmail.*****.bh Bahrain\n\nhttps://webmail.*****.bh/owa/auth/EventClass.aspx webmail.*****.bh Bahrain\n\nhttps://webmail.*****.bh/ecp/auth/EventClass.aspx webmail.*****.bh Bahrain\n\nhttp://*****.ae:8080/_layouts/WrkStatLog.aspx *****.ae United Arab\nEmirates\n\nhttps://www.*****.jo/statistic.aspx www.*****.jo Jordan\n\nhttps://e-*****.al/dptaktkonstatim.aspx e-*****.al Albania\n\nhttps://webmail.*****.ae/owa/auth/RedirSuiteService.aspx webmail.*****.ae United Arab\nEmirates\n\nhttps://webmail.*****.ae/owa/auth/handlerservice.aspx webmail.*****.ae United Arab\nEmirates\n\n\n-----\n\n**Collection**\n\nOur Webmask analysis of this leaked sample mainly focuses on attacks against Outlook. Through the\nanalysis, we found that such attacks used the email connection and man-in-the-browser (MITB)\ntechnologies. Also, we dissected the sample‚Äôs source code and instructions and discovered that this\ntool could steal users‚Äô email account passwords and cookies for Outlook authentication as well as\ninject code into traffic for further information collection.\n\n**Exfiltration**\n\nIn this phase, the Exfiltration Over Command and Control Channel tactic is applied. The attacker\nsends sensitive data to the controlled server using a DNS protocol through command and control, in a\nway to avoid information disclosure due to common data loss prevention techniques.\n\n\n-----\n\n**Command and Control**\n\nThe leaked sample used two remote access Trojans (RATs), poisonfrog.ps1 (old version) and\nGlimpse (dns_main.ps1) (new version), for remote control of the target server by using a DNS\nprotocol for communication.\n\nAfter a sample analysis, we found that both versions of RATs used PowerShell as an agent for code\nexecution, and prior to that, the RATs needed to hijack the victim‚Äôs DNS server for DNS redirection in\norder to parse the domain name suffix designated by the attacker. By generating a subdomain with a\nspecific algorithm, the victim‚Äôs machine performs a DNS query to request an A/TXT record of the\nsubdomain from the DNS server (C2 server) and obtains the IP address provided by the C2 server for\ncommunications. In addition, the attacker will create a scheduled task to execute the PowerShell script\nregularly to obtain information from the C2 server before executing commands. The C2 server mainly\nprovides command execution and file upload and download functions.\n\nThe C2 server of the old version already implements proxy detection and can download files from the\nremote server for web proxy configuration. The old version only supports the query of DNS A records\nand generates subdomain names that contain part of the UUID (Universally Unique Identifier) value of\nthe victim‚Äôs system.\n\nThe C2 server of the new version does not involve proxy configuration and deems that the DNS\nhijacking is already completed. It can parse DNS TXT records and generate subdomain names that do\nnot contain the UUID value of the victim‚Äôs system.\n\n\n-----\n\n## 3 Trojan and WebShell Analysis\n\nThe following figures show the directory structure of each tool used by this leaked sample:\n\nGlimpse:\n\nPoisonFrog:\n\n\n-----\n\nWebmask:\n\nWebshells_and_Panel:\n\nWhen sorting out files and trying to reproduce the sample, we found that remote control tools had an\nincomplete logic which renders one-click deployment impossible. These tools can run properly only\nafter an analysis and reconfiguration is completed. MinionProject, however, cannot directly execute\ndue to the lack of files.\n\n\n-----\n\nTo sum up, we believe that the leaked toolkit is incomplete, which should be noted during analysis of\nthe toolkit. So far, no backdoor is discovered left by the leaker.\n\n### 3.1 Glimpse\n\nGlimpse is a remote control tool that uses DNS tunneling. It consists of an agent, a panel, and a\nserver.\n\n**3.1.1 Agent**\n\nThe agent is a program at the controlled end.\n\n**Major Functions**\n\nThe startup script is runner_.vbs which is used to start the main script of PowerShell.\n\nThe main script is dns_main.ps1 used for communications with the server.\n\n**File-related Operations**\n\nThe program generates the directory PUBLIC\\Libraries\\guid\\ (hereinafter referred to as the agent\ndirectory in which guid is generated by Dns_main.ps1) and creates folders in this directory like\n**receivebox, sendbox, and done to communicate with the server by reading or writing into files in**\nthese folders.\n\n**Communication Process**\n\n1. The agent can communicate with the server through the ping mode (DNS A mode) or text mode\n\n(DNS TXT mode). Commands received by the agent from the server are saved as files with\nRCVD as the file name prefix in the \\receivebox\\ directory of the agent.\n2. Check the commands from the server and perform the related behavior.\n\nThe following table lists commands from the server.\n\n\nTrailing Byte\nof a\nCommand\nFile Name\n\n\nMeaning Operation\n\n\n-----\n\nTrailing Byte\nof a\nCommand\nFile Name\n\n\nMeaning Operation\n\n\n0 Executing\ncommands\nissued by the\nserver\n\n1 Uploading a\nfile\n\nOthers Downloading\na file\n\n\nReads contents from the command file, executes them as CMD\ncommands, and saves the command output as a file with proc as\nthe file name prefix in the agent directory, \\sendbox.\n\nPlaces the file designated in the body of the command file in the\nagent directory \\sendbox and sends this file to the C&C server.\n\nPlaces the command file in the agent directory \\done.\n\n\n1. After executing commands issued by the server, the agent will send the file saved in the agent\n\ndirectory \\sendbox to the server.\n\n**3.1.2 Panel**\n\nThe panel is the graphic panel of Glimpse, used to manage the communications between the agent\nand the server.\n\n**3.1.3 Server**\n\nThe server issues commands to the agent, instructing it what to do next.\n\n**Major Functions**\n\nThe server uses a DNS tunneling protocol for communications, issuing commands to the agent or\nreceiving files uploaded by the agent via the DNS tunnel of the A or TXT type.\n\n**File-related Operations**\n\nThe program generates the directory ALLUSERSPROFILE/Glimpse/dns/aid/ (hereinafter referred to\nas the server directory in which aid indicates the guid ID received from the agent) and then creates\nfolders like wait, receive, done, sended, and sending in this directory to communicate with the agent\n\n\n-----\n\nby reading or writing into files in those folders.\n\n**Communication Process**\n\n1. Receives false DNS requests from the agent.\n2. Parses information received from the agent by using local rules.\n\nFor a false DNS request, the contents are in the format of data.mainData.mainData2.mainData3, each\npart of which contains different contents.\n\n**Data**\n\n0‚Äì14 15‚Äìn n+1 n+2 n+3 n+4\n\ndataRand Unknown C reqNoIndex actionIndex T\n\nIf the data contains the trailing string CxxT (x indicates arbitrary characters), the server determines that\nthe data is based on a tunneling protocol.\n\nIf the data contains the trailing string in other formats than CxxT, the server forwards the data.\n\n**datarand: records the action and aid. The data location is variable and determined by both**\nreqNoIndex and actionIndex.\n\n**aid: ID of the packet, based on which the server directory is generated on the server.**\n\n**action: action of the agent.**\n\n\nValue of the\naction Field\n\n\nOperation\n\n\nM The agent checks the mode folder in the specific directory and handles ping\ninformation.\n\nW The server, in the DNS TXT manner, merges the contents in the wait folder in the\nserver directory and sends them.\n\nD The server sends the contents in the wait folder in the server directory as\nfragments in DNS TXT manner.\n\n0 The server disguises names of files in the wait folder as IP strings and sends\nthem to the agent.\n\n\n-----\n\nValue of the\naction Field\n\n\nOperation\n\n\n1 The server sends files in the wait folder as fragments to the agent in DNS A\nmanner.\n\n2 The server receives files by fragment from the agent in DNS A manner and saves\nthem in the part folder.\n\n**mainData: saves the body of the command file.**\n\n**mainData2: saves the command file name.**\n\n**mainData3: saves the domain name of the C&C server.**\n\n**Tunnel Format**\n\nThe server is a forged DNS server which responds to the agent‚Äôs DNS requests by returning\ndesignated IP strings. Different IP strings have different meanings, as shown in the following table.\n\nIP String Meaning\n\n99.250.250.199 The server responds to a new agent and creates a session.\n\n199.250.250.99 The server responds to the ping information of the agent.\n\n3.2.1.0 The server has files to be sent.\n\n24.125.a.b A file named a+b waits to be sent by the server.\n\n11.24.237.110 There are files to be sent by the server.\n\na.b.c.d The server sends fragments as DNS A records. In this IP string, a.b.c indicates\nthe data contents and d indicates the data index.\n\n1.2.3.0 Fragments are sent by the server.\n\na.2.3.b The server is receiving fragments from the agent. In this IP string, a indicates the\nagent ID and b indicates the fragment ID.\n\n253.25.42.87 The server has received fragments from the agent.\n\n### 3.2 PoisonFrog\n\n**Major Functions**\n\nPoisonFrog is a remote control tool that can steal information from the controlled server and execute\nCMD commands issued by the C&C server.\n\n**Operation Process**\n\n1. The ps1 script executes to release the hUpdater.ps1 and dUpdater.ps1 scripts and the\n\n**UpdateTask.vbs script as well as set Windows scheduled tasks.**\n\n\n-----\n\n2. The ps1 script accesses the C&C domain and uploads and downloads files as instructed by\n\ncommands issued via the domain.\n3. The ps1 script identifies the trailing character of the name of the file downloaded from the C&C\n\nserver as the command and operates on files in the specified directory as instructed by this\ncommand.\n4. As a scheduled task, the vbs script is set to execute every 10 minutes.\n\nThe following figure shows part of contents of the poisonfrog.ps1 script.\n\n**Component Analysis**\n\n**hUpdater.ps1**\n\nThis script is mainly used to send data to the C&C server and receive commands and files from this\nserver.\n\nWhen cfg.ini exists, the hUpdater.ps1 script will read contents from this file to extract the proxy and\ncommunicate with the C&C server in proxy mode.\n\nAs for command format parsing, the hUpdater.ps1 script obtains strings from the C&C server and\nsplits them into four or more arrays with angle brackets. SSA[0]<>SSA[1]<>SSA[2]<>SSA[3]<>SSA[4]\n<>SSA[5] is such an example. In the string, each array corresponds to a different response function.\nFor instance, when SSA[2] has a value other than not, it downloads files to a specified directory. The\nfollowing table describes functions of these arrays.\n\nCommand Description\n\nSSA[0] When SSA[0] has a value other than not, upload the file named SSA[0] to the URI\n**/fil/domain name/SSA[0] and then delete the original file.**\n\n\n-----\n\nCommand Description\n\nSSA[1] When SSA[1] has a value other than not, it uploads strings to a specified URL. SSA[1]\ncode has been commented out.\n\nSSA[2] When SSA[0] has a value other than not, download the file under /fil/SSA[3] to the\nlocal directory C:/‚Ä¶./SSA[0]/SSA[2].\n\nSSA[4] When SSA[4] has a value other than not, upload the SSA[4] file to /fil/domain\n**_name/SSA[0]._**\n\nSSA[5] When the array length is 2, continue to perform operations within the loop.\n\n**dUpdater.ps1**\n\nThe dUpdater.ps1 script parses the trailing character in the file name located first during the traversal\nof the receivebox folder, as a command. The following table describes the mapping between\ncommands and the script‚Äôs functions.\n\nCommand Description\n\n0 The dUpdater.ps1 script parses the contents in the ZZA[0] file in the receivebox folder\nand writes the contents into the ZZA[0] file in the sendbox directory. If the ZZA[0] file\nexists in the receivebox folder, this script will delete this file.\n\n1 If the contents in the ZZA[0] file in the receivebox folder is parsed as a file path, the\n**dUpdater.ps1 script copies this file to the sendbox directory and then deletes the**\n**ZZA[0] file in the receivebox folder.**\n\n2 The dUpdater.ps1 script moves the ZZA[0] file in the receivebox folder to the done/\ndirectory and types 200<> plus the path of the done/ directory as the content of this file\nand then deletes the ZZA[0] file in the receivebox folder.\n\n\n-----\n\n**Server-Side Scripts**\n\nThe scripts are used to assemble commands (e.g. SSA[0]<>SSA[1]<>SSA[2]<>SSA[3]<>SSA[4]\n<>SSA[5]) and store data. Each function has its own function.\n\nFunction Description\n\nPanel Serves as a control panel.\n\nNotFount Notifies the log-in user of the login failure.\n\nPosted Issues commands from the agent panel to upload and download files.\n\nDeletecommand Deletes commands from the database.\n\nDeleteagent Deletes the agent and its related files.\n\nDescriptionposted Describes information returned by the server.\n\nFileposted Sends files to the receive folder on the server.\n\nAgent Creates the receive, send, and wait folders in each agentID folder and stores\nfiles that contain commands in such folders and writes commands into the\ndatabase.\n\n### 3.3 WebMask\n\nThis tool is used by the APT34 group as a DNS proxy and for HTTP hijacking.\n\n\n-----\n\nMajor Functions\n\nThis tool consists of three parts:\n\nShell script sh: used for installation\n**py: used to steal passwords and for hijacking**\n**py, dnsd.js, and config.json: used to configure the local DNS proxy**\n\nComponent Analysis\n\nDNSd Module\n\nThis module starts the local DNS proxy. The configuration file and the IP address of the proxy server\nare specified with startup parameters. By default, the script only does DNS forwarding.\n\nThe DNSd module can be started using the python script (dnsd.py) or JavaScript (dnsd.js).\n\n**guide.txt explains two way to use the DNSd tool.**\n\n1. py is used as a transparent proxy.\n\n1. The native-dns module is used as a DNS proxy. As shown in the following figure, 195.229.237.52\n\nis the IP address of a DNS server in the United Arab Emirates and 185.162.235.106 is a bot IP\naddress used as an example.\n\n**Icap Module**\n\n\n-----\n\nThis module is a tool written in PyICAP. PyICAP is a python3 framework for writing ICAP servers.\nICAP is usually used to extend transparent proxy servers, implementing content filters in the\ntransparent HTTP proxy cache and performing specific services (can be specified by developers) for\nHTTP requests/responses.\n\nThe extract_login_password method is used to steal account passwords included in HTTP information\nand record them in a designated file. It extracts data in HTTP requests using regular expressions.\n\nMeanwhile, this tool records header information involved in HTTP interactions, including the user‚Äôs IP\naddress, request time, requested content, and recorded cookies. When analyzing the tool code, we\nfound hijacking code, i.e., the following JavaScript statement:\n\nWhen the hijacking code executes, the first img src leads the victim‚Äôs machine to access logo.jpg on\nthe attacker‚Äôs server. During the process, NTLM authentication will be conducted automatically to\nallow the attacker to obtain the NetNTLMv2 hash which can be used for man-in-the-middle (MITM)\nattacks.\n\nAssume that the attacker has taken control of the proxy. In this case, he can use his server to respond\nto DNS requests to WPAD, and then answer requests to obtain images that are actually PAC files.\n\n### 3.4 Webshells_and_Panel\n\nThe Webshells_and_Panel directory contains multiple WebShell tools written in C#:\n\n**simpleDownload.aspx: a simple tool only with the upload function.**\n\n\n-----\n\n**simple.aspx: a relatively complicated tool to provide authentication and command execution functions**\nbesides the upload function.\n\n**highshell.aspx: a full-featured tool that seems like the first version, providing functions like file upload,**\ncommand execution, and database manipulation. This version of tool was reported by Palo Alto\nNetworks in 2017.\n\nThis tool implements login authentication as follows:\n\nThe following shows how login authentication is implemented via pseudocode:\n\nBase64(sha256(bytes(cookies[‚Äúp‚Äù] + salt))) == pp\n\nBoth salt and pp are predefined values.\n\n\n-----\n\nThe configured cookie value can be used for authentication.\n\nIn addition, we have found multiple upgraded versions (minor differences exists between them) of\nHighShell in the Hypershell directory. The following figure shows HighShell 8.6.2.\n\nThis version of tool is rewritten with the Semantic UI framework and its backend has been split into\nseveral modules. Arguably, this version goes further in engineering than common versions. Like other\nversions, this version performs authentication based on cookies.\n\n## 4 YARA Rules\n\n/*\nYARA Rule Set\n\nAuthor: Florian Roth\n\nDate: 2019-04-17\n\nIdentifier: Leaked APT34 / OilRig tools\n\nReference: https://twitter.com/0xffff0800/status/1118406371165126656\n\n*/\n\nrule APT_APT34_PS_Malware_Apr19_1 {\n\nmeta:\n\ndescription = ‚ÄúDetects APT34 PowerShell malware‚Äù\n\nauthor = ‚ÄúFlorian Roth‚Äù\n\nreference = ‚Äúhttps://twitter.com/0xffff0800/status/1118406371165126656‚Äù\n\n\n-----\n\ndate 2019 04 17\n\nhash1 = ‚Äúb1d621091740e62c84fc8c62bcdad07873c8b61b83faba36097ef150fd6ec768‚Äù\n\nstrings:\n\n$x1 = ‚Äú= get-wmiobject Win32_ComputerSystemProduct | Select-Object -ExpandProperty UUID‚Äù\nascii\n\n$x2 = ‚ÄúWrite-Host \\‚Äùexcepton occured!\\‚Äù‚Äù ascii /* üôÇ */\n\n$s1 = ‚ÄúStart-Sleep -s 1;‚Äù fullword ascii\n\n$s2 = ‚ÄúStart-Sleep -m 100;‚Äù fullword ascii\n\ncondition:\n\n1 of ($x*) or 2 of them\n\n}\n\nrule APT_APT34_PS_Malware_Apr19_2 {\n\nmeta:\n\ndescription = ‚ÄúDetects APT34 PowerShell malware‚Äù\n\nauthor = ‚ÄúFlorian Roth‚Äù\n\nreference = ‚Äúhttps://twitter.com/0xffff0800/status/1118406371165126656‚Äù\n\ndate = ‚Äú2019-04-17‚Äù\n\nhash1 = ‚Äú2943e69e6c34232dee3236ced38d41d378784a317eeaf6b90482014210fcd459‚Äù\n\nstrings:\n\n$x1 = ‚Äú= \\‚Äùhttp://\\‚Äù + [System.Net.Dns]::GetHostAddresses(\\‚Äù‚Äù ascii\n\n$x2 = ‚Äú$t = get-wmiobject Win32_ComputerSystemProduct | Select-Object -ExpandProperty UUID‚Äù\nfullword ascii\n\n$x3 = ‚Äú| Where { $_ -notmatch ‚Äò^\\\\s+$‚Äô }‚Äù ascii\n\n$s1 = ‚Äú= new-object System.Net.WebProxy($u, $true);‚Äù fullword ascii\n\n$s2 = ‚Äù -eq \\‚Äùdom\\‚Äù){$‚Äù ascii\n\n$s3 = ‚Äù -eq \\‚Äùsrv\\‚Äù){$‚Äù ascii\n\n$s4 = ‚Äú+\\‚Äù<>\\‚Äù | Set-Content‚Äù ascii\n\ncondition:\n\n1 of ($x*) and 3 of them\n\n}\n\nrule APT_APT34_PS_Malware_Apr19_3 {\n\n\n-----\n\nmeta:\n\ndescription = ‚ÄúDetects APT34 PowerShell malware‚Äù\n\nauthor = ‚ÄúFlorian Roth‚Äù\n\nreference = ‚Äúhttps://twitter.com/0xffff0800/status/1118406371165126656‚Äù\n\ndate = ‚Äú2019-04-17‚Äù\n\nhash1 = ‚Äú27e03b98ae0f6f2650f378e9292384f1350f95ee4f3ac009e0113a8d9e2e14ed‚Äù\n\nstrings:\n\n$x1 = ‚ÄúPowershell.exe -exec bypass -file ${global:$address1}‚Äù\n\n$x2 = ‚Äúschtasks /create /F /ru SYSTEM /sc minute /mo 10 /tn‚Äù\n\n$x3 = ‚Äú\\‚Äù\\\\UpdateTasks\\\\UpdateTaskHosts\\‚Äù‚Äù\n\n$x4 = ‚Äúwscript /b \\\\`\\‚Äù${global:$address1‚Äù ascii\n\n$x5 = ‚Äú::FromBase64String([string]${global:$http_ag}))‚Äù ascii\n\n$x6 = ‚Äú.run command1, 0, false\\‚Äù | Out-File ‚Äù fullword ascii\n\n$x7 = ‚Äú\\\\UpdateTask.vbs‚Äù fullword ascii\n\n$x8 = ‚ÄúhUpdater.ps1‚Äù fullword ascii\n\ncondition:\n\n1 of them\n\n}\n\nSource: [https://github.com/Neo23x0/signature-base/blob/master/yara/apt_oilrig.yar](https://github.com/Neo23x0/signature-base/blob/master/yara/apt_oilrig.yar)\n\n## 5 Indicators of Compromise\n\nmyleftheart.com\n\nC:\\Users\\Public\\Public\\atag[0-9]{4}[A-Z]{2}\n\nC:\\Users\\Public\\Public\\dUpdater.ps1\n\nC:\\Users\\Public\\Public\\hUpdated.ps1\n\nC:\\Users\\Public\\Public\\UpdateTask.vbs\n\n27e03b98ae0f6f2650f378e9292384f1350f95ee4f3ac009e0113a8d9e2e14ed\n\nb1d621091740e62c84fc8c62bcdad07873c8b61b83faba36097ef150fd6ec768\n\n2943e69e6c34232dee3236ced38d41d378784a317eeaf6b90482014210fcd459\n\n\n-----\n\n07e791d18ea8f2f7ede2962522626b43f28cb242873a7bd55fff4feb91299741\n\ndd6d7af00ef4ca89a319a230cdd094275c3a1d365807fe5b34133324bdaa0229\n\n3ca3a957c526eaeabcf17b0b2cd345c0fffab549adfdf04470b6983b87f7ec62\n\nc9d5dc956841e000bfd8762e2f0b48b66c79b79500e894b4efa7fb9ba17e4e9e\n\na6a0fbfee08367046d3d26fb4b4cf7779f7fb6eaf7e60e1d9b6bf31c5be5b63e\n\nfe1b011fe089969d960d2dce2a61020725a02e15dbc812ee6b6ecc6a98875392\n\n185.***.***.61\n\n46.***.***.196\n\n185.***.***.80\n\n185.***.***.17\n\n185.***.***,252\n\n185.***.***.103\n\n70.***.***.34\n\n109.***.***.129\n\n185.***.***.140\n\n185.***.***.158\n\n178.***.***.230\n\n146.***.***.108\n\n23.***.***.76\n\n185.***.***.8\n\n95.***.***.172\n\n173.***.***.194\n\n173.***.***.201\n\n172.***.***.238\n\n23.***.***.69\n\n185.***.***.86\n\n185.***.***.56\n\n\n-----\n\n194. . .15\n\n185.***.***.63\n\n81.***.***.249\n\n213.***.***.32\n\n46.***.***.42\n\n185.***.***.157\n\n198.***.***.22\n\n213.***.***.9\n\n158.***.***.62\n\n168.***.***.92\n\n38.***.***.153\n\n176.***.***.215\n\n88.***.***.174\n\n190.***.***.59\n\n103.***.***.181\n\n217.***.***.122\n\n46.***.***.52\n\n185.***.***.35\n\n172.***.***.226\n\n103.***.***.14\n\n95.***.***.173\n\n142.***.***.99\n\n194.***.***.23\n\n194.***.***.10\n\n185.***.***.14\n\n185.***.***.35\n\n185.***.***.75\n\n\n-----\n\n185. . .157\n\n185.***.***.59\n\n185.***.***.217\n\n23.***.***.6\n\n185.***.***.63\n\n## 6 Mitigations\n\n1. Be cautious with emails from unknown sources. Do not open emails from strangers, such as\n\nthose containing links, so as to prevent information disclosure or computer viruses.\n2. Do not use weak passwords. Change passwords frequently and make sure strong enough\n\npasswords are used.\n3. Fix vulnerabilities in time, especially those in border devices. Enable automatic update on not\nfrequently-used devices to keep the devices and their software latest.\n4. Deploy border protection devices and an intelligence-based alerting system provided by security\n\nfirms to nip security hazards in the bud.\n\n## 7 Detection Means\n\nNetwork layer:\n\nCheck whether there are abnormal DNS parsing server addresses.\n\nCheck whether machines within the network send a great number of DNS requests every 50 ms.\n\nCheck whether there are abnormal domain name requests.\n\nHost layer:\n\nCheck whether the following directories or files exist on hosts:\n\nC:\\Users\\Public\\Public\\atag[0-9]{4}[A-Z]{2}\n\nC:\\Users\\Public\\Public\\dUpdater.ps1\n\nC:\\Users\\Public\\Public\\hUpdated.ps1\n\nC:\\Users\\Public\\Public\\UpdateTask.vbs\n\nCheck whether DNS server addresses are tampered with on hosts.\n\nCheck whether unknown files exist in the root directory of the HTTP server.\n\n## 8 References\n\nhttps://github.com/Neo23x0/signature-base/blob/master/yara/apt_oilrig.yar\n\nhttps://www fireeye com/blog/threat research/2017/12/targeted attack in middle east by apt34 html\n\n\n-----\n\n[OilRig Performs Tests on the TwoFace Webshell](https://unit42.paloaltonetworks.com/unit42-oilrig-performs-tests-twoface-webshell/)\n\n[OilRig Uses Updated BONDUPDATER to Target Middle Eastern Government](https://unit42.paloaltonetworks.com/unit42-oilrig-uses-updated-bondupdater-target-middle-eastern-government/)\n\nhttps://misterch0c.blogspot.com/2019/04/apt34-oilrig-leak.html\n\nhttps://raidforums.com/Thread-access-to-top-secret-information-and-hacking-tools-of-Iran-ministry-ofintelligence?pid=540189\n\nhttps://anonfile.com/8f8aL0S1mb/targets_txt\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-11-09 - APT34 Event Analysis Report.pdf"
    ],
    "report_names": [
        "2019-11-09 - APT34 Event Analysis Report.pdf"
    ],
    "threat_actors": [
        {
            "id": "ce10c1bd-4467-45f9-af83-28fc88e35ca4",
            "created_at": "2022-10-25T15:50:23.458833Z",
            "updated_at": "2025-03-27T02:00:55.475188Z",
            "deleted_at": null,
            "main_name": "APT34",
            "aliases": null,
            "source_name": "MITRE:APT34",
            "tools": [
                "netstat",
                "Systeminfo",
                "PsExec",
                "SEASHARPEE",
                "Tasklist",
                "Mimikatz",
                "POWRUNER",
                "certutil"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "4632103e-8035-4a83-9ecb-c1e12e21288c",
            "created_at": "2022-10-25T16:07:23.542255Z",
            "updated_at": "2025-03-27T02:02:09.854487Z",
            "deleted_at": null,
            "main_name": "DNSpionage",
            "aliases": [],
            "source_name": "ETDA:DNSpionage",
            "tools": [
                "Agent Drable",
                "AgentDrable",
                "CACTUSPIPE",
                "DNSpionage",
                "DropperBackdoor",
                "Karkoff",
                "MailDropper",
                "OILYFACE"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8d76e350-dfb5-4733-800d-876de41f690d",
            "created_at": "2023-01-06T13:46:38.841887Z",
            "updated_at": "2025-03-27T02:00:02.932838Z",
            "deleted_at": null,
            "main_name": "DNSpionage",
            "aliases": [
                "COBALT EDGEWATER"
            ],
            "source_name": "MISPGALAXY:DNSpionage",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3eebdb3f-f4e3-42e5-bb4d-f02a13328316",
            "created_at": "2024-05-01T02:03:08.014303Z",
            "updated_at": "2025-03-27T02:05:17.306592Z",
            "deleted_at": null,
            "main_name": "COBALT EDGEWATER",
            "aliases": [
                "Cold River ",
                "DNSpionage ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT EDGEWATER",
            "tools": [
                " DNSpionage",
                " Karkoff",
                " MailDropper",
                " SideTwist",
                " TWOTONE",
                "AgentDrable"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536198,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1653704819,
    "ts_modification_date": 1653704819,
    "files": {
        "pdf": "https://archive.orkl.eu/0fefe8b5d15927646d48c062fa39ddf10a5e2a55.pdf",
        "text": "https://archive.orkl.eu/0fefe8b5d15927646d48c062fa39ddf10a5e2a55.txt",
        "img": "https://archive.orkl.eu/0fefe8b5d15927646d48c062fa39ddf10a5e2a55.jpg"
    }
}