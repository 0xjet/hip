{
    "id": "d476915a-bc2a-4e1b-9824-83f57328e232",
    "created_at": "2023-01-12T15:09:27.883153Z",
    "updated_at": "2025-03-27T02:05:44.038125Z",
    "deleted_at": null,
    "sha1_hash": "6cb8ccbe7c2505d0bf2b8bffce9faf1e1201008b",
    "title": "2021-10-17 - Building highly interactive honeypots- CVE-2021-41773 case study",
    "authors": "",
    "file_creation_date": "2022-05-27T21:07:21Z",
    "file_modification_date": "2022-05-27T21:07:21Z",
    "file_size": 428097,
    "plain_text": "# Building highly interactive honeypots: CVE-2021-41773 case study\n\n**lopqto.me/posts/building-highly-interactive-honeypots**\n\nOct 17, 2021\n\nEvery day, as we drink our coffee in the office, new vulnerabilities pop out, some of which are\nhighly critical and need quick reactions. Exploiting some of these vulnerabilities is a cinch,\nlike the one found in Apache HTTPD “ CVE-2021-41773 ”, which is why they attract many\nattackers. In such situations, a precise solution is required to get information around the\nattack as quickly as possible. The gathered information can be used for different goals, for\nexample, to assist security engineers in knowing the attack patterns to defend themselves\nagainst it, or maybe for security researchers to gather intel and knowledge as much as\npossible; therefore, they can share it publicly. One of those solutions is a honeypot.\nEssentially, a honeypot acts as a decoy-based intrusion detection system to help us detect\nattacks and their patterns, and defend ourselves against them. This post (or maybe a series\nof posts) will discuss how to build a highly interactive honeypot for a vulnerability immediately\nand analyze the generated logs after successful or unsuccessful attacks.\n\n## The approach\n\n[While numerous honeypot applications are available for free (like dionaea and cowire), these](https://github.com/DinoTools/dionaea)\nprograms attempt to emulate a service and present the attacker with a fake service.\nHoneypots of this type are effective against autonomic attacks, but they fail to detect manual\nattacks or attacks with more than one stage. In addition, there are several techniques an\nattacker can use to uncover a honeypot.\n\nThe aforementioned approach has some shortcomings such as limited emulation on specific\nservices and challenging customization. About customization, researchers find it a timeconsuming task where in some specific scenarios, they cannot get the advantage of\ncustomizatoin. Moreover, it is good to point out that there is no honeypot for dozens of\nservices.\n\nTo overcome these hardships, rather than trying to emulate every possible aspect of the\nfaked system, we can grant access to a real system as it is easy, so the attacker has no way\nof knowing whether they are logged on to a honeypot or not. Securing a real system is not\neasy; however, it can be done using virtualization or containerization.\n\n\n-----\n\nThe honeypot is a vulnerable `Docker container affected by the` `CVE-2021-41773 .`\nInstances of `Filebeat and` `Auditbeat will collect the logs, and` `Elasticsearch will`\ncolorate them for us. Finally, `Kibana can provide a visualized dashboard.`\n\n## Vuleranble container\n\nA path traversal vulnerability and exploit just dropped in the wild for a specific version of\nApache (Apache/2.4.49). This vulnerability allows an unauthenticated attacker to execute a\npath traversal attack (and now shown RCE if MOD_CGI is enabled) to read files outside the\nvirtual directory path bounds. .\n\nTo build a vulnerable container for these types of vulnerabilities, we need the source code of\nthat specific vulnerable version. Luckily, there is a mirror of Apache HTTPD at [here!. After](https://github.com/apache/httpd/releases)\ndownloading the source code, we compile the vulnerable version and build a docker image\nwe can deploy quickly.\n\nThe assumption is you know how to install and use Docker; if you’re not familiar, please take\na look at [This Article!.](https://docs.docker.com/engine/install/)\n\nLet’s take a look at the content of the `Dockerfile :`\n\n\n-----\n\n```\nFROM ubuntu:20.04\nMAINTAINER lopqto <[email protected]>\n# Install the required packages\nRUN apt-get update && apt-get install -y \\\n  build-essential zlibc libapr1-dev \\\n  libaprutil1-dev libpcre3-dev zlib1g zlib1g-dev wget \\\n  subversion python3 autoconf libtool-bin\nWORKDIR /honeypot\n# Download the vulnerable version\nRUN wget https://github.com/apache/httpd/archive/refs/tags/2.4.49.tar.gz \\\n  && tar -xvf 2.4.49.tar.gz\nWORKDIR /honeypot/httpd-2.4.49/\n# Compile the vulenrable version\nRUN svn co http://svn.apache.org/repos/asf/apr/apr/trunk srclib/apr \\\n  && ./buildconf \\\n  && ./configure --prefix=/usr/local/apache2 \\\n  --enable-mods-shared=all --enable-deflate --enable-proxy \\\n  --enable-proxy-balancer --enable-proxy-http \\\n  && make && make install\nRUN mkdir -p /var/www/html && mkdir /var/log/apache2/\n# Update the required permissions for www-data\nRUN chown -hR www-data:www-data /var/www/html \\\n  && chown -hR www-data:www-data /var/log/apache2/ \\\n  && chown -hR www-data:www-data /usr/local/apache2/logs/\nUSER www-data\nWORKDIR /var/www/html\n# Run apache in foreground mode\nENTRYPOINT [\"/usr/local/apache2/bin/apachectl\", \"-D\", \"FOREGROUND\"]\n\n```\nTo build the vulnerable image:\n```\ndocker build . -t honeypot:latest\n\n## Test the vulnerable container\n\n```\nThe vulnerability requires specific permissions to be configured. Grab the default\n```\nhttpd.conf file and append these lines end of it:\n\n```\n\n-----\n\n```\n<VirtualHost :8080>\n     DocumentRoot /var/www/html\n     ErrorLog /var/log/apache2/error.log\n     CustomLog /var/log/apache2/access.log combined\n     <Directory />\n          Require all granted\n     </Directory>\n</VirtualHost>\n\n```\nThen try to run the vulnerable container with the new config file:\n```\ndocker run -p 80:8080 \\\n  -v $(pwd)/httpd.conf:/usr/local/apache2/conf/httpd.conf \\\n  apache:latest\n\n```\nTest the vulnerability by running:\n```\ncurl http://localhost/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh -d 'echo;whoami'\n\n```\nYou should see `www-data in output.`\n\n## Logging\n\nThe `Elasticsearch ELK stack (Elasticsearch, Logstash, and Kibana) is an ideal solution`\nfor search and analytics platforms on honeypot logs.\n\n[There are various how-to’s describing how to get ELK running (see here and](https://github.com/deviantony/docker-elk) [here for](https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html)\nexample), so I assume you already have a working ELK system.\n\n## HTTP requests logs\n\nA logger with these advantages is needed:\n\nNo need to modify the container’s configuration\nPrevent attackers from disabling the logger within the container\n\nBy default, Apache stores the access logs inside `/var/log/apache2/access.log and`\nerror logs inside `/var/log/apache2/error.log . We need to export these logs from the`\ncontainer and store them inside an `ElasticSearch instance. To do this, we will use`\n```\nFilebeat :\n\n```\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an\nagent on your servers, Filebeat monitors the log files or locations that you specify,\ncollects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n\n-----\n\nThe main configuration file will look like this:\n```\nfilebeat.config:\n modules:\n  path: ${path.config}/modules.d/*.yml\n  reload.enabled: false\noutput.elasticsearch:\n hosts: [\"${ELASTICSEARCH_HOST}:9200\"]\n username: ${ELASTICSEARCH_USERNAME}\n password: ${ELASTICSEARCH_PASSWORD}\nsetup.dashboards:\n enabled: true\nsetup.kibana:\n host: \"${KIBANA_HOST}:5601\"\n username: ${ELASTICSEARCH_USERNAME}\n password: ${ELASTICSEARCH_PASSWORD}\n\n```\nAnd for the `apache.yml we have:`\n```\n- module: apache\n access:\n  enabled: true\n  var.paths: [\"/log/access.log\"]\n error:\n  enabled: true\n  var.paths: [\"/log/error.log\"]\n\n```\nAnother option for this problem is to configure the containers to forward their Syslog data to\nthe host, but this can be disabled if the attacker has root access, so it is not ideal.\n\n## Executaion logs\n\nDocker runs on the same kernel as the host machine, so we can use kernel-level logging to\nsee what is happening inside the container. An off-the-shelf solution is to use a Linux audit\nsystem and configure it to log `execve and` `execveat system calls.`\n\nThe Linux Audit system provides a way to track security-relevant information on your\nsystem. Based on pre-configured rules, Audit generates log entries to record as much\ninformation about the events that are happening on your system as possible.\n\nThe sad news is Linux audit system does not support kernel namespaces, so logs cannot be\nfiltered for specific containers and the host machine. To make things easier, we defined a\ncustom user inside the `Dockerfile named` `www-data to filter out the related logs by this`\nuser.\n```\nUSER www-data\n\n```\nTo log the execution actions, we will use `Auditbeat :`\n\n\n-----\n\nAuditbeat is a lightweight shipper that you can install on your servers to audit the\nactivities of users and processes on your systems. For example, you can use\nAuditbeat to collect and centralize audit events from the Linux Audit Framework. You\ncan also use Auditbeat to detect changes to critical files, like binaries and configuration\nfiles, and identify potential security policy violations.\n\nThe `Auditbeat configuration file will look like this:`\n```\nauditbeat.modules:\n- module: auditd\n audit_rules: |\n  -a always,exit -F arch=b64 -S execve,execveat -k exec\noutput.elasticsearch:\n hosts: [\"${ELASTICSEARCH_HOST}:9200\"]\n username: ${ELASTICSEARCH_USERNAME}\n password: ${ELASTICSEARCH_PASSWORD}\nsetup.dashboards:\n enabled: true\nsetup.kibana:\n host: \"${KIBANA_HOST}:5601\"\n username: ${ELASTICSEARCH_USERNAME}\n password: ${ELASTICSEARCH_PASSWORD}\n\n## Putting it all together\n\n```\nAt this point, we have an ELK stack set up and running, `Kibana dashboards ready to`\nvisualize the logs, a vulnerable container prepared to be exposed on the internet, a\n```\nFilebeat instance ready to capture HTTP logs, and an Auditbeat instance to capture\n\n```\nexecuted commands.\n\nWe can create a simple `docker-compose.yml file to deploy the honeypot as fast as`\npossible and make things much more manageable. To install the `docker-compose, take a`\nlook at [here!.](https://docs.docker.com/compose/install/)\n\nContent of the `docker-compose.yml will be something like this:`\n\n\n-----\n\n```\nversion: 3.8 \nservices:\n honeypot:\n  build: ./\n  hostname: \"honeypot\"\n  networks:\n   - honeypot\n  ports:\n   - \"80:8080\"\n  volumes:\n   - logs:/var/log/apache2/\n   - $PWD/httpd.conf:/usr/local/apache2/conf/httpd.conf\n auditbeat:\n  image: docker.elastic.co/beats/auditbeat:7.15.0\n  hostname: \"auditbeat\"\n  user: root\n  pid: host\n  cap_add:\n   - AUDIT_CONTROL\n   - AUDIT_READ\n  networks:\n   - honeypot\n  volumes:\n   - auditbeat:/usr/share/auditbeat/data\n   - $PWD/auditbeat.yml:/usr/share/auditbeat/auditbeat.yml:ro\n  environment:\n   - ELASTICSEARCH_HOST=elk.host # Change\n   - KIBANA_HOST=kibana.host # Change\n   - ELASTICSEARCH_USERNAME=elastic # Change\n   - ELASTICSEARCH_PASSWORD=changeme # Change\n  command: [\"--strict.perms=false\"]\n  depends_on:\n   - honeypot\n filebeat:\n  image: docker.elastic.co/beats/filebeat:7.15.0\n  hostname: \"filebeat\"\n  user: root\n  networks:\n   - honeypot\n  volumes:\n   - filebeat:/usr/share/filebeat/data\n   - $PWD/filebeat.yml:/usr/share/filebeat/filebeat.yml\n   - $PWD/apache.yml:/usr/share/filebeat/modules.d/apache.yml\n   - logs:/log/:ro\n  environment:\n   - ELASTICSEARCH_HOST=elk.host # Change\n   - KIBANA_HOST=kibana.host # Change\n   - ELASTICSEARCH_USERNAME=elastic # Change\n   - ELASTICSEARCH_PASSWORD=changeme # Change\n  command: [\"--strict.perms=false\"]\n  depends_on:\n   - honeypot\n\n```\n\n-----\n\n```\nnetworks:\n honeypot:\nvolumes:\n auditbeat:\n filebeat:\n logs:\n\n```\nTo bring up the honeypot stack, run the following command:\n```\ndocker-compose up -d\n\n```\nThat’s it :). Now, we can trace the logs with the help of Kibana and some beautiful\ndashboards.\n```\nAuditbeat executions Dashboard:\nFilebeat Apache access and error logs dashboard:\n\n```\n\n-----\n\n## Conclusion\n\nWe can build interactive honeypots for a variety of vulnerabilities in such a short period of\ntime using containers. The ELK stack additionally provides us with some tools to gather\nvaluable logs, manage records easier, and visualize them for better understanding. Spending\ntime and effort, researchers can build honeypots to trace active threats and threat actors,\nsuch as miners, and share attack knowledge with other researchers. The information can be\nused to create threat feeds with a low likelihood of false positives. Additionally, engineers can\nuse honeypots as a decoy system inside of an organization.\n\n[The project has been shared on Github. You can use it as a starting point. I hope you find it](https://github.com/lopqto/CVE-2021-41773_Honeypot)\nuseful.\n\nYou’re more than welcome to share your thoughts and ideas. Feel free to ping me if you\nhave questions about this topic.\n\nEnjoy!\n\n## Read more\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-10-17 - Building highly interactive honeypots- CVE-2021-41773 case study.pdf"
    ],
    "report_names": [
        "2021-10-17 - Building highly interactive honeypots- CVE-2021-41773 case study.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536167,
    "ts_updated_at": 1743041144,
    "ts_creation_date": 1653685641,
    "ts_modification_date": 1653685641,
    "files": {
        "pdf": "https://archive.orkl.eu/6cb8ccbe7c2505d0bf2b8bffce9faf1e1201008b.pdf",
        "text": "https://archive.orkl.eu/6cb8ccbe7c2505d0bf2b8bffce9faf1e1201008b.txt",
        "img": "https://archive.orkl.eu/6cb8ccbe7c2505d0bf2b8bffce9faf1e1201008b.jpg"
    }
}