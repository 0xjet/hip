{
    "id": "5651c3ad-5f36-489f-b231-0c97e8871971",
    "created_at": "2023-05-06T02:09:32.199647Z",
    "updated_at": "2025-03-27T02:06:14.878777Z",
    "deleted_at": null,
    "sha1_hash": "b7de237be9551328b6a86406835c9861dee4cb6d",
    "title": "2023-04-06 - Neutralizing Tofsee Spambot – Part 2 - InMemoryConfig store vaccine",
    "authors": "",
    "file_creation_date": "2023-05-05T01:50:08Z",
    "file_modification_date": "2023-05-05T01:50:08Z",
    "file_size": 814857,
    "plain_text": "# Neutralizing Tofsee Spambot – Part 2 | InMemoryConfig store vaccine\n\n**[spamhaus.com/resource-center/neutralizing-tofsee-spambot-part-2-inmemoryconfig-store-vaccine/](https://www.spamhaus.com/resource-center/neutralizing-tofsee-spambot-part-2-inmemoryconfig-store-vaccine/)**\n\nApril 6, 2023\n\nHere’s the second in our three-part series focused on protecting against Tofsee malware.\nThis spambot is prolific, but various vaccines and kill switches are available to defend\nagainst Tofsee. Our malware researchers are sharing two vaccines and a network-based kill\nswitch in this series.\n\n## A recap\n\nIf you’re wondering what malware vaccines are and how they can be utilized, or you’d like to\nread about the first vaccine our researchers have shared relating to Tofsee and its binary file,\n[read this blog post. Alternatively, keep reading to learn about a second vaccine our team has](http://www.spamhaus.com/resource-center/neutralizing-tofsee-spambot-part-1-binary-file-vaccine)\nproduced, focused on polluting Tofsee’s internal configuration store.\n\n## A deeper dive into Tofsee’s config stores\n\nDuring the runtime of Tofsee and the communications with its command and control (C&C)\nserver, Tofsee stores various configuration values pertinent to the proper runtime of the code\nin a memory-based structure which we call the InMemoryConfig store. This is a circular\nlinked list structure, and Tofsee defines it as follows:\n\n**_InMemoryConfig store structure_**\n\n## Locations of Tofsee’s configuration storage\n\n\n-----\n\nEach ConfigValue buffer has its internal structure based on the ConfigType value. This\nchained config is dumped and stored in various locations on the infected system so Tofsee\ncan retrieve it after a reboot.\n\nThe various configuration storage locations are:\n\n**File Storage**\n\n1 %USERPROFILE%\\:.repos (ADS)\n\n2 %USERPROFILE%\\Local Settings:.repos\n\n3 %USERPROFILE%\\Local Settings\\Application\nData\\Microsoft\\Windows\\UsrClass.dat.repos\n\n4 %USERPROFILE%\\wincookie.repos\n\n**Registry storage**\n\n1: HKEY_CURRENT_USER\\\\Control Panel\\\\Buses\\\\Config0\n\n2: HKEY_CURRENT_USER\\\\SOFTWARE\\\\Microsoft\\\\Buses\\\\Config0\n\nA simple Tofsee xor algorithm encodes the data stored in one of these places:\n\nOnce retrieved and decoded, this data looks something like this in its raw parsed form:\n\n\n-----\n\nThe config stores of particular interest to us are the work_srv and start_srv structures. Both\nare retrieved during the initial C&C connection of the Tofsee botnet.\n\n## Tofsee’s botnet C&C environment\n\nTofsee has a tier-2 C&C ecosystem. The malware uses the hardcoded C&Cs in the binary\nonly once to retrieve a list of tier-2 peers. These tier-2 piers then act as forwarding C&Cs and\nare stored in the work_srv and start_srv config stores.\n\n**work_srv and start_srv have the following definition in the memory:**\n\nstruct srv\n\n{\nchar NumElements;\n\nstruct __srv\n\n{\nchar IP_C2[0x41];\n\nDWORD Port;\n\n}Src[NumElements]\n\n};\n\n\n-----\n\n## How can you exploit this for a vaccine?\n\nIn order to vaccinate Tofsee from connecting to first-tier or second-tier C&Cs, we can pollute\nthese config stores’ values before the start of the infection chain.\n\n**work_srv will point to a controlled sinkhole IP. In this example, we’re going to point it to**\n127.0.0.1. In addition to this, we will recalculate the crc32 of data buffer so that it passes the\nintegrity check inside the binary:\n\n**_Modified value for wrk_srv ( with proper crc32 hash value)_**\n\nTo create a vaccine, the above binary blob has to be encoded using the same algorithm and\nwritten back to one of the config store paths file or registry:\n\n**_“Config0” modified registry value for vaccine_**\n\nWhen Tofsee makes the connection, it only connects to the local sinkhole.\n\n\n-----\n\nSimple!\n\n[The final of our Tofsee series looks at a network-based kill switch to protect against this](http://www.spamhaus.com/resource-center/neutralizing-tofsee-spambot-part-3-network-based-kill-switch)\nmalware.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-04-06 - Neutralizing Tofsee Spambot – Part 2 - InMemoryConfig store vaccine.pdf"
    ],
    "report_names": [
        "2023-04-06 - Neutralizing Tofsee Spambot – Part 2 - InMemoryConfig store vaccine.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1683338972,
    "ts_updated_at": 1743041174,
    "ts_creation_date": 1683251408,
    "ts_modification_date": 1683251408,
    "files": {
        "pdf": "https://archive.orkl.eu/b7de237be9551328b6a86406835c9861dee4cb6d.pdf",
        "text": "https://archive.orkl.eu/b7de237be9551328b6a86406835c9861dee4cb6d.txt",
        "img": "https://archive.orkl.eu/b7de237be9551328b6a86406835c9861dee4cb6d.jpg"
    }
}