{
    "id": "8c0c524a-5a54-4964-a636-154c379ffc25",
    "created_at": "2022-10-25T16:48:16.571955Z",
    "updated_at": "2025-03-27T02:10:07.458338Z",
    "deleted_at": null,
    "sha1_hash": "293d6da465b3568edeba3f01e6b51ab5c504bce8",
    "title": "",
    "authors": "",
    "file_creation_date": "2020-10-05T12:27:55Z",
    "file_modification_date": "2020-10-05T12:27:58Z",
    "file_size": 849074,
    "plain_text": "# MosaicRegressor: Lurking in the Shadows of UEFI\n\n## Technical details\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n## Contents\n\n#### UEFI Bootkit \b 3\n\n RAR SFX droppers for the Curl-based downloaders \b 5\n\n BITS Downloaders \b 10\n\nMain thread \b 11\nC&C Communication \b 11\nBITS Transfer \b 11\nLoading the DLL modules \b 12\nBITS Downloader, extended \b 12\nSystem information \b 13\nPayload \b 14\nLanguage artifacts \b 15\nBITS Downloader, extended, MSVC 10 version \b 16\nBITS Downloader, “HHDump.dll” \b 16\nLoad.rem \b 17\nMain thread \b 17\nBITS Downloader, “cryptui.sep” \b 17\nBITS Downloader, 64-bit \b 18\n\n#### Curl-based downloaders \b 19\n\nC&C communication \b 19\nPayload ABI \b 20\nNotable file properties \b 20\nVariable parameters \b 20\nC&C URLs \b 20\nPayload DLL names \b 20\nC&C communication delay \b 21\nCurl-based downloader, extended \b 21\nC&C communication \b 21\nPayload \b 21\nCurl downloader, “OINFO11.OCX” \b 22\nRich header dump \b 22\nCallA \b 24\nCallB \b 24\nCallC \b 24\nWinRAR wrapper “load.rem” \b 24\nLoad \b 24\nIntermediate DLL loader “mapisp.dll” \b 25\nCryptoSysPrep \b 25\n\n#### E-mail downloader \b 26\n\n“Process” function \b 26\n\n#### OLE2 Equation dropper \b 27\n\nPayload of the OLE2 dropper, “Data.dll” \b 27\n\n#### Launcher for the Curl downloader \b 28\n\n Winhttp-based downloaders, extended \b 28\n\nC&C addresses and file names \b 29\nModification with the “ID” field \b 30\nC&C addresses and file names \b 30\n\n**2**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\nMosaicRegressor is a multi-stage and modular framework aimed at espionage and data gathering. It consists of downloaders,\nand occasionally multiple intermediate loaders, that are intended to fetch and execute payload on victim machines. In two\nknown cases, the initial stage of the framework was installed in the victim’s UEFI firmware, achieving the above-OS level of\npersistence.\n\n### UEFI Bootkit\n\nWhen inspecting the compromised UEFI firmware, we noticed four components that had unusual proximity in their assigned\nGUID values. These were two DXE drivers and two UEFI applications. Upon closer analysis, we could conclude that those\nwere compiled from the source code of a Hacking Team bootkit named VectorEDK, that was leaked in 2015 and is now\navailable online.\n\nRogue components found within the compromised UEFI firmware\n\nFollowing is an outline of the revealed components:\n\nF5B320F7E87CC6F9D02E28350BB87DE6 (SmmInterfaceBase)\nB53880397D331C6FE3493A9EF81CD76E (SmmAccessSub)\n91A473D3711C28C3C563284DFAFE926B (SmmReset)\nDD8D3718197A10097CD72A94ED223238 (Ntfs)\n\n- **SmmInterfaceBase: a DXE driver intended to deploy the bootkit itself on the system by registering a callback that will**\n\nbe invoked upon an event of type EFI_EVENT_GROUP_READY_TO_BOOT. The event occurs at a point when control can\nbe passed to the operating system’s bootloader, effectively allowing the callback to take effect before it. The callback\nwill, in turn, load and invoke further components of the bootkit, in this case ‘SmmAccessSub’.\nThis is equivalent to Hacking Team’s ‘rkloader’ component, and is built using its source code.\n\n- **Ntfs: a driver used to parse the NTFS file system to allow reading or writing to disk.**\n\n- **SmmReset: a UEFI application intended to mark the execution of the bootkit. This is done by setting the value of a**\n\nvariable named ‘fTA’ to a hard-coded GUID. The same is done by the original Vector-EDK bootkit as part of the bootkit’s\nmain business logic. In this case, it’s not invoked and it seems to be a residue from the open source code that was not\nproperly leveraged by the developers.\n\nSetting of the fTA variable with a predefined GUID to mark the execution of the bootkit\n\n**3**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n- **SmmAccessSub: the main bootkit component that serves as a persistent dropper for user-mode malware. It is executed by**\n\nthe callback registered during the execution of ‘SmmInterfaceBase’, and takes care of writing a binary embedded within it as\na file named ‘IntelUpdate.exe’ to the startup directory on disk. This allows the binary to run when Windows accomplishes\nthe boot process.\n\nThis is the only proprietary component amongst the ones we inspected, which doesn’t rely on Vector-EDK code.\nIt conducts the following actions to drop the intended file to disk:\n\n– Bootstraps pointers for SystemTable, BootServices and RuntimeServices global structures.\n\n– Tries to get a handle to the currently loaded image by invoking the HandleProtocol method with the EFI_LOADED_\n\nIMAGE_PROTOCOL_GUID argument.\n\n– If it succeeds, it attempts to find the root drive with Windows installation by enumerating all drives and checking that\n\nthe ‘\\Windows\\System32’ directory exists. A global EFI_FILE_PROTOCOL object that corresponds to the drive will be\ncreated at this point and referenced to open any further directories or files on this drive.\n\n– If the root drive is found, it looks for a marker file named ‘setupinf.log’ under the Windows directory and proceeds only\n\nif it doesn’t exist. In the absence of this file, it is created.\n\n– If the creation of ‘setupinf.log’ succeeds, it goes on to check if the ‘Users’ directory exists on the same drive.\n\n– If the ‘Users’ directory exists, it writes the ‘IntelUpdate.exe’ file (embedded in the UEFI application’s binary) under the\n\n‘\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup’ directory.\n\nCode from ‘SmmAccessSub’ used to write the embedded ‘IntelUpdate.exe’ binary to the Windows startup directory\n\n**4**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n### RAR SFX droppers for the Curl-based downloaders\n\nThese are several SFX droppers with decoy documents that were sent to victims by e-mail. Each contains a document and\na variant of a Curl-based downloader or a Winhttp-based downloader\n\n**b23e1fe87ae049f46180091d643c0201**\n\nThis file is a plain RAR archive with one EXE file inside.\n\n**Size** **Date** **Name** **MD5**\n\n221461 2018-03-27 Health and Ageing on the occasion 0efb785c75c3030c438698c77f6e960e\nof the World Health Day_180326.exe\n\nThe EXE file in turn is also a RAR SFX archive with the following contents:\n\n**0efb785c75c3030c438698c77f6e960e**\n\n**Size** **Date** **Name** **MD5**\n\n13520 2018-03-27 1.docx d197648a3fb0d8ff6318db922552e49e\n\n208896 2018-01-16 msreg.exe 61b4e0b1f14d93d7b176981964388291\n\nScreenshot of the document\n\nRAR SFX script:\n```\nPath=%appdata%\n Setup=%appdata%\\1.docx\n Setup=%appdata%\\msreg.exe\n Silent=1\n Overwrite=1\n\n```\n**3b3bc0a2772641d2fc2e7cbc6dda33ec**\n\n**Size** **Date** **Name** **MD5**\n\n500529 2018-01-17 1.docx 67cf741e627986e97293a8f38de492a7\n\n208896 2018-01-16 msreg.exe 61b4e0b1f14d93d7b176981964388291\n\n**5**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\nScreenshot of the document\n\nThis document contains an embedded external image with URL: http://43.252.228.179/ambeg.png\n\n**ae66ed2276336668e793b167b6950040**\n\n**Size** **Date** **Name** **MD5**\n\n208896 2018-01-16 msreg.exe 61b4e0b1f14d93d7b176981964388291\n\n499904 2018-01-17 6.docx 92f6c00da977110200b5a3359f5e1462\n\nThis document looks exactly like 3b3bc0a2772641d2fc2e7cbc6dda33ec but has no references to external images.\n\nRAR SFX script:\n```\nPath=%appdata%\n Setup=%appdata%\\6.docx\n Setup=%appdata%\\msreg.exe\n Silent=1\n Overwrite=1\n\n```\n**cfb072d1b50425ff162f02846ed263f9**\n\n**Size** **Date** **Name** **MD5**\n\n161280 2017-02-27 wq2.exe bd393a70e44fdf175c5b428286bb890f\n\n17728 2017-02-26 2.docx a69205984849744c39cfb421d8e97b1f\n\n**12b5fed367db92475b071b6d622e44cd**\n\n**Size** **Date** **Time** **Name** **MD5**\n\n46080 2013-09-27 06:38 contract.doc 6e949601ebdd5d50707c0af7d3f3c7a5\n\n95744 2018-01-04 03:50 winword.exe 08ecd8068617c86d7e3a3e810b106dce\n\n**6**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\nThe creation date set in the file “contract.doc” is 2013-09-27. The text inside the file is supposed to be displayed with the\nSimplified Chinese font “SimSun” but is unreadable and looks like a result of incorrect encoding.\n\nRAR SFX script:\n```\nPath=%appdata%\n Setup=winword.exe\n Setup=contract.doc\n Silent=1\n Overwrite=1\n\n```\n**70def87d180616406e010051ed773749**\n\n**Size** **Date** **Time** **Name** **MD5**\n\n25370 2017-06-12 09:39 0612.doc 449be89f939f5f909734c0e74a0b9751\n\n95744 2017-06-12 10:23 dwhost.exe 1732357d3a0081a87d56ee1ae8b4d205\n\nThe decoy document “0612.doc” is actually an RTF document written in Russian.\n\n**ae66ed2276336668e793b167b6950040**\n\n**Size** **Date** **Name** **MD5**\n\n208896 2018-01-16 msreg.exe 61b4e0b1f14d93d7b176981964388291\n\n499904 2018-01-17 6.docx 92f6c00da977110200b5a3359f5e1462\n\nThis document looks exactly like 3b3bc0a2772641d2fc2e7cbc6dda33ec but has no references to external images.\n\nRAR SFX script:\n```\nPath=%appdata%\n Setup=%appdata%\\6.docx\n Setup=%appdata%\\msreg.exe\n Silent=1\n Overwrite=1\n\n```\n**cfb072d1b50425ff162f02846ed263f9**\n\n**Size** **Date** **Name** **MD5**\n\n161280 2017-02-27 wq2.exe bd393a70e44fdf175c5b428286bb890f\n\n17728 2017-02-26 2.docx a69205984849744c39cfb421d8e97b1f\n\n**7**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n**12b5fed367db92475b071b6d622e44cd**\n\n**Size** **Date** **Time** **Name** **MD5**\n\n46080 2013-09-27 06:38 contract.doc 6e949601ebdd5d50707c0af7d3f3c7a5\n\n95744 2018-01-04 03:50 winword.exe 08ecd8068617c86d7e3a3e810b106dce\n\nThe creation date set in the file “contract.doc” is 2013-09-27. The text inside the file is supposed to be displayed with the\nSimplified Chinese font “SimSun” but is unreadable and looks like a result of incorrect encoding.\n\nRAR SFX script:\n```\nPath=%appdata%\n Setup=winword.exe\n Setup=contract.doc\n Silent=1\n Overwrite=1\n\n```\n**70def87d180616406e010051ed773749**\n\n**Size** **Date** **Time** **Name** **MD5**\n\n25370 2017-06-12 09:39 0612.doc 449be89f939f5f909734c0e74a0b9751\n\n95744 2017-06-12 10:23 dwhost.exe 1732357d3a0081a87d56ee1ae8b4d205\n\nThe decoy document “0612.doc” is actually an RTF document written in Russian.\n\nScreenshot of the document\n\n**8**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\nRAR SFX script:\n```\nPath=%appdata%\n Setup=dwhost.exe\n Setup=0612.doc\n Silent=1\n Overwrite=1\n\n```\n**7908b9935479081a6e0f681ccef2fdd9**\n\n**Size** **Date** **Time** **Name** **MD5**\n\n18521 2017-12-06 10:40 1206.doc\n\n95744 2017-11-30 15:02 return.exe\n\nScreenshot of the document\n\nRAR SFX script:\n```\nPath=%appdata%\n Setup=return.exe\n Setup=1206.doc\n Silent=1\n Overwrite=1\n\n```\n**3b58e122d9e17121416b146daab4db9d**\n\n**Size** **Date** **Time** **Name** **MD5**\n\n25088 2017-09-27 16:37 0927.doc\n\n73728 2017-09-25 15:27 dwhost.exe\n\n**9**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\nScreenshot of the document\n\nRAR SFX script:\n```\nPath=%appdata%\n Setup=dwhost.exe\n Setup=0927.doc\n Silent=1\n Overwrite=1\n\n### BITS Downloaders\n\n```\n**SHA256** e1d1d5e1c91d0f4142247b45fb18c0c7dcc94719f4340cf6443100364802aeae\n\n**MD5** b53880397d331c6fe3493a9ef81cd76e\n\n**Compiled** 2010.01.02 06:56:27 (GMT), 9.0\n\n**Type** I386 Windows GUI EXE\n\n**Size** 13312\n\nThe downloader is the application that is dropped by the “EFI dropper” module. When executed, it creates a BITS Job with\ndisplay name “test” of type BG_JOB_TYPE_UPLOAD. It creates a mutex to ensure only one instance is being executed.\n\n**10**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\nMutex name: “FindFirstFile Message Bi”\n\nEnumerates all BITS jobs. For a job whose display name contains the substrings “first_tf” or “second_tf” and overall display\nname is five or six characters (this never happens since the conditions are contradictory), it cancels the job, effectively\ninterrupting the transfer and removing temporary files. Then the module follows its business logic in a separate thread while\nrunning an empty window message loop in the startup thread.\n\n#### Main thread\n\nThe program contains four blocks of data encrypted with a simple one-byte XOR algorithm. Three of those blocks contain\nURL strings and the fourth contains a unique string, “D22”.\n\nIt builds an identification string following the format: %Computer name%-D22_32 or 64\n\nThe 32 or 64 suffix is chosen based on system identification. The system is supposed to be 64 if the program is able to\nlocate the file or directory named %WINDIR%\\SysWOW64\n\nThe program then follows into an infinite C&C communication loop. It delays for a hardcoded period of 20 minutes between\neach attempt.\n\n#### C&C Communication\n\nThe module compiles a final URL string following the format: URL from the decrypted buffer/identification string/on.z\n\nIt then attempts to download the contents of that URL to the file %TEMP%\\on.dat using its BITS transfer routine. The\ncontents of the file areignored and the file is deleted immediately after transfer. This initial download is used to determine\nthe valid C&C server. The module iterates through all three URLs hardcoded in its body and uses the first one that responds\nwithout error for further communication.\n\nIn case any of the C&C servers provided a valid response, the program sends another download request for: URL of the\nvalid C&C server/identification string/BeFileA.z The downloaded contents are then saved to: %TEMP%\\BeFileA.dll\n\nIt also tries to fetch the file using the URL: URL of the valid C&C server/identification string/BeFileC.z and save it to:\n%TEMP%\\BeFileC.dll\n\nThe file “BeFileA.dll” is downloaded only once during the duration of the program’s instance and is loaded in a separate thread.\nThe attempts to download the file “BeFileC.dll” occur in every communication period. The file is loaded in the same thread.\n\n#### BITS Transfer\n\nThe program creates a new BITS job. For a download job it names the job “first_tf” and for the upload tasks it uses the\nname “second_tf”. Other versions use slightly different strings as job names but they all start with “first” and “second”\ncorrespondingly, and are always identical to the names of the jobs that are cancelled during the startup. The job is started\nwith the priority setting “BG_JOB_PRIORITY_FOREGROUND”. It also toggles the security options “BG_SSL_IGNORE_\nCERT_CN_INVALID”, “BG_SSL_IGNORE_CERT_DATE_INVALID”, “BG_SSL_IGNORE_UNKNOWN_CA”, to accept invalid\nHTTPS certificates.\n\nIt then waits for up to about five minutes for the BITS job to complete, also extending the wait if the actual transfer is in\nprogress.\n\n**11**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n Loading the DLL modules\n\nThe module expects the files provided by the C&C server to be PE DLLs. They are loaded normally using the LoadLibrary\nAPI function. Each DLL may have one or more exported functions named “CallA”, “CallB”, “CallC”, “CallD”, “CallE”.\n\nAll exported functions are supposed to have the same ABI: cdecl calling convention, five arguments all passed by pointers.\nFollowing the execution of each function the program delays for one second and then processes the results returned in\nthese arguments. Depending on the data returned by the exported function, the program may then download or upload\narbitrary files from/to arbitrary URLs using its BITS transfer routine. Also, depending on the returned data, it may delete or\nleave the DLLs file on disk.\n\nThen it checks if a corresponding “dat” file exists in the %TEMP%directory. In case the file exists it uploads it to the C&C\nserver using the BITS transfer routine, the same URL except the last component is identical to the actual filename. The\n“dat” file is deleted if the upload succeeds.\n\n**C&C URLs** https://103.56.115.69/bisen (twice)\nhttps://menjitghyukl.myfirewall.org/thren\n\n**Unique ID** D22\n\n#### BITS Downloader, extended\n\n**SHA256** 14e48d3aa7b9058c56882eb61fa40cf1f52614fe8feb8a43658ad02a570147e0\nfc189b913bfd5995a7ed5c4e8a811ad237f7b973e120a25baccffbf4ea1d3838\naa9627a62eb193cc40f2a5ffd259035a43540b2abd634c80f0d988f7588fa23d\n19300fd4cf9dfa28d8d3331e9d48739c38d7151f330463ffe13d6809d5705f1a\n\n**MD5** dc14ee862dda3bcc0d2445fdcb3ee5ae\n88750b4a3c5e80fd82cf0dd534903fc0\nc63d3c25abd49ee131004e6401af856c\nd273cd2b96e78def437d9c1e37155e00\n\n**Compiled** 2008.01.01 11:58:33 (GMT), 9.0\n\n**Type** I386 Windows GUI EXE\n\n**Size** 62976\n\nThis module is similar to the “BITS Downloader” and appears to be based on the same code. The differences follow. It uses a\ndifferent mutex name: “set instance state”.\n\nAfter starting the C&C communication thread, the program sets the registry value HKEY_CURRENT_USER\\Software\\\nMicrosoft\\Windows\\CurrentVersion\\Run, value name qwinstd, to the location of its own executable. It also overwrites\nthe value if it is not equal to the location of the executable. This ensures the program’s automatic startup. Also the program\nsets up a timer callback routine to be called every second. The routine looks for the file %APPDATA%\\Microsoft\\Internet\nExplorer\\usk.rs. When such a file is found it acts as a kill switch: the file deleted, the BITS Jobs are cancelled and the\nprogram exits.\n\nInstead of the %TEMP% directory this version uses the directory %APPDATA%\\Microsoft\\Internet Explorer to store its\ntemporary files.\n\n**12**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n System information\n\nThe module creates a text file %APPDATA%\\Microsoft\\Internet Explorer\\%Computername%.dat and fills it with system\ninformation. Note the non-ASCII symbols 0xA3 and 0xBE used in the string literals. These were replaced with a colon\ncharacter (See “Language artifacts”).\n```\nHost Infomation:\n EXE ID: %Unique ID, see table%\n Host Name: %Computername%\n Current User Name: %USERNAME%\n PRIVILEGE: %User privilege%\n OS: Windows NT %Major%.%Minor%\\t%Service pack string%\\t%Product type%\\tSystemMetrics:\n%Build number for Windows 5.2%\\tSuiteMask hex: %Suite mask%\n OS BITS: %32 or 64%\n Host Power ON Time: %04d-%02d-%02d %02d:%02d\n Power ON Time: %d Hours %2d Minutes %2d Seconds *or*Power ON Time: %2d Minutes %2d Seconds\n =======================================================================================\n=================\n Installed Programe List 32:\n *the following list is the contents of registry keys from HKLM\\SOFTWARE\\Microsoft\\Windows\\\nCurrentVersion\\Uninstall*\n *%Item number%* *%Registry key last write timestamp in format %04d-%02d-%02d %02d:%02d%* \n%Display Name%\n *optional, when the program determines that it is running on a 64-bit OS, it disables\n64/32 registry reflection and enumerates the installed program list again, generating a\nsimilar list with a header “Installed Programe List 64”*\n\n```\nRemarks. The %User privilege% string is produced using the NetUserGetInfo API for the current user. Depending on\nthe returned result, it can be one of the strings: “Administrator”, “User”, “Guest”, “ACCESS_DENIED”, “COMPUTER_\nNAME_ERROR”, “USER_NAME_ERROR”. The %Product type% string is one of “VER_NT_SERVER”,“VER_NT_DOMAIN_\nCONTROLLER”, “VER_NT_WORKSTATION”\n\nOnce the report file is ready, the program creates a BITS job to upload it to the C&C server. The upload location follows the\nformat: URL of the C&C server/%Computername%.dat The file is deleted if the upload succeeds.\n\n**13**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n Payload\n\nWhen finished with uploading the system information report, the program then attempts to fetch the payload from the\nC&C server. The business logic is similar to the one of the “BITS Downloader”, with the following differences:\n\nFiles that are downloaded and executed in separate threads:\n\nFileA.dll fetched from %C&C URL%/%Computername%/FileA.z\n\nFileB.dll fetched from %C&C URL%/%Computername%/FileB.z\n\nFiles that are downloaded and executed in the current thread:\n\nFileC.dll fetched from %C&C URL%/%Computername%/FileC.z\n\nFileD.dll fetched from %C&C URL%/%Computername%/FileD.z\n\nEach DLL may have one or more exported functions named “CallA”, “CallB”, “CallC”, “CallD”, “CallE”, “CallF”, “CallG”, “CallH”,\n“CallI”, “CallJ”, “CallK”, “CallL”. Once finished, the program may delete the DLL file depending on the returned value.\n\nC&C URL:\n\n\n**Sample** **C&C URL**\n\n\nDC14EE862DDA3BCC0D2445FDCB3EE5AE https://43.252.228.84/bits\n\n88750B4A3C5E80FD82CF0DD534903FC0 https://103.243.24.171/bits\n\nC63D3C25ABD49EE131004E6401AF856C https://43.252.228.252/help\n\nD273CD2B96E78DEF437D9C1E37155E00 https://103.30.40.39/bits\n\nUnique IDs (“EXE ID” in the report):\n\n\n**Sample** **Unique ID**\n\n\nDC14EE862DDA3BCC0D2445FDCB3EE5AE da\n\n88750B4A3C5E80FD82CF0DD534903FC0 tan\n\nC63D3C25ABD49EE131004E6401AF856C t\n\nD273CD2B96E78DEF437D9C1E37155E00 0115\n\nC&C communication period: 15 minutes\n\n**14**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n Language artifacts\n\nMany strings contain the sequence 0xA3, 0xBE (hexadecimal). This is an invalid sequence for a UTF8 string and the LATIN1\nencoding translates these symbols to a pound sign followed by a “masculine ordinal indicator” (“£º”).\n\nДanguage artifacts\n\nAn attempt to iterate over all available iconv symbol tables trying to convert to UTF-8 produces possible candidates that\nproduce a more meaningful conversion for this byte sequence:\n```\nCN-GB//, “ : ” # EF BC 9A\n CP936//, “ : ” # EF BC 9A\n CP949//, “ : ” # EF BC 9A\n CSEUCKR//, “ : ” # EF BC 9A\n CSGB2312//, “ : ” # EF BC 9A\n EUC-CN//, “ : ” # EF BC 9A\n EUC-KR//, “ : ” # EF BC 9A\n EUCCN//, “ : ” # EF BC 9A\n EUCKR//, “ : ” # EF BC 9A\n GB2312//, “ : ” # EF BC 9A\n GB13000//, “ : ” # EF BC 9A\n GB18030//, “ : ” # EF BC 9A\n GBK//, “ : ” # EF BC 9A\n ISIRI-3342//, “!:” # 21 3A\n ISIRI3342//, “!:” # 21 3A\n MS936//, “ : ” # EF BC 9A\n MSCP949//, “ : ” # EF BC 9A\n OSF0004000A//, “ : ” # EF BC 9A\n OSF100203B5//, “ : ” # EF BC 9A\n UHC//, “ : ” # EF BC 9A\n WINDOWS-936//, “ : ” # EF BC 9A\n\n```\nGiven the context of the string preceding the symbol and line feed symbols following it, the best match is the “FULLWIDTH\nCOLON” Unicode character translated from one of the Chinese or Korean code pages (CP936 and CP949).\n\n**15**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n BITS Downloader, extended, MSVC 10 version\n\n**SHA256** 7eba9f6f9774c87fafc4aba403821fae73a50d387624d039d1b296cf0befca73\n\n**MD5** 72c514c0b96e3a31f6f1a85d8f28403c\n\n**Compiled** 2017.10.07 12:12:33 (GMT), 10.0\n\n**Type** I386 Windows GUI EXE\n\n**Size** 57344\n\nThis module is similar to the “BITS Downloader, extended” but was compiled with a more recent version of Visual Studio and\nbears minor differences.\n\nMutex name used: “foregrounduu state”\n\nPayloads downloaded and executed: “FileA.z”(“FileA.dll”), “FileB.z”(“FileB.dll”) and “FileC.z”(“FileC.dll”)\n\nExported function names executed from the payload DLLs: “CallA”, “CallB”, “CallC”, “CallD”, “CallE”.\n\n**C&C URL** https://103.39.109.252/insult\n\n**Unique ID (“EXE ID”)** Nli\n\n#### BITS Downloader, “HHDump.dll”\n\n**SHA256** b2982325d3231ba5959484b01f5b6492babd37f10a8736e6bf81b47253bc99eb\n\n**MD5** 9aa47dceccb306a80101f47ab148578d\n\n**Compiled** 2011.01.03 07:36:03 (GMT), 9.0\n\n**Type** I386 Windows GUI DLL\n\n**Size** 58368\n\n**Internal name** HHDump.dll\n\nThis module is a DLL version of a “BITS Downloader”. The library provides one exported function “SetFormName” that is\nempty; all the business logic is implemented in the DllMain function.\n\nThe DllMain function, when executed with the reason code of DLL_PROCESS_ATTACH, checks if the filename of the host\nprocess is equal to “vc9play.exe”. It then spawns its main thread if the filename matches.\n\n**C&C URL** https://43.252.228.84/quest\n\n**16**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n Load.rem\n\nThe module checks for the presence of the file %APPDATA%\\Microsoft\\Windows\\load.rem. If the file is present it follows in\na new thread: it copies it to %APPDATA%\\Microsoft\\Windows\\SendTo\\load.dll, then loads the copy as a regular DLL and\ncalls its function exported with the name “Load”, if present. The copy is deleted if the module fails to load it as a DLL.\n\n#### Main thread\n\nThe module enumerates and cancels BITS jobs if their names contain a substring “first job” or “second job” and the length\nof the name is either 9 or 10. This is an improvement over the original “BITS Downloader” that checked for a contradictory\ncondition that never becomes true.\n\nThe module creates a directory if it doesn’t exist: %APPDATA%\\Microsoft\\Network. Due to a bug, it will not attempt to\ncreate the directory if a file exists with the same name, failing later when the directory is required. This directory is then\nused to store any temporary files, instead of %TEMP% in the original “BITS Downloader”.\n\nFiles that are downloaded and executed in separate threads:\n\nDFileA.dll fetched from %C&C URL%/%Computername%/DFileA.z\n\nDFileD.dll fetched from %C&C URL%/%Computername%/DFileD.z\n\nFiles that are downloaded and executed in the current thread:\n\nDFileC.dll fetched from %C&C URL%/%Computername%/DFileC.z\n\nExported function names executed from the payload DLLs: “CallA”, “CallB”, “CallC”, “CallD”, “CallE”, “CallF”, “CallG”, “CallH”,\n“CallI”, “CallJ”, “CallK”, “CallL”, “CallM”, “CallN”, “CallO”, “CallP”, “Final”.\n\nThe signature of the function called “Final” is different from the rest: it takes 21 arguments that not only contain those\npassed to other functions but also the return values of the previous (Call…) functions called.\n\nC&C communication period: 30 minutes\n\nRemarks. “vc9play.exe” may refer to the component of software called “Virtual CD 9”.\n\n#### BITS Downloader, “cryptui.sep”\n\n**SHA256** 2826815873d90ad38c5aeeed57c09385d6ad9a3cebaa18757f557a698e9f92b6\n7e2b1bbffa7f05e7bf57ee60d162ef1e6f83b2e3fb5aa0da985add67af517901\n\n**MD5** 1c5377a54cbaa1b86279f63ee226b1df\n9f13636d5861066835ed5a79819aac28\n\n**Compiled** 2008.01.01 11:56:50 (GMT), 9.0\n\n**Type** AMD64 Windows GUI DLL\n\n**Size** 57856\n\n**Internal name** aeinv64.dll\n\n**17**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\nThis module is supposed to be loaded by the payload of a BITS Downloader named “FileA.dll” and is in turn another variation\nof a BITS Downloader. It is very similar to “HHDump.dll”. The following description includes only the differences.\n\nThe library provides one exported function with the name “RetrievePKCS7FromCA”. The DllMain function is empty and the\nmodule doesn’t have any checks for the name of the current executable.\n\nThe payload is loaded in the same way as “HHDump.dll”; the only difference is an additional optional call to the function\nexported with the name “CallQ” after the call to the function named “Final”.\n\nC&C communication period: 15 minutes\n\n\n**Sample** **C&C URL**\n\n\n1c5377a54cbaa1b86279f63ee226b1df https://103.243.26.211/bits\n\n9f13636d5861066835ed5a79819aac28 https://103.39.109.239/requry\n\n#### BITS Downloader, 64-bit\n\n**SHA256** bffe333c3470e6012924409b6aa48b20e9d12f181c0f6b03f50db64ddf7596a7\n\n**MD5** afc09deb7b205eadae4268f954444984\n\n**Compiled** 2010.01.02 06:40:26 (GMT), 9.0\n\n**Type** AMD64 Windows GUI EXE\n\n**Size** 55808\n\nThis executable is based on the codebase of the “BITS Downloader” but also contains pieces of boilerplate code that later\nappeared in “BITS Downloader, extended”. It is worth noting that the part of the code that checks for, and cancels, the BITS\njob by name uses the same name lengths as the first “BITS Downloader” (5 and 6) but the correct substring literals “first”\nand “second”.\n\nThis version does not create any mutex.\n\nC&C communication period: 15 minutes\n\nThis version uses the directory %APPDATA%\\Microsoft\\Internet Explorer to store its temporary files.\n\nThe module creates a text file %APPDATA%\\Microsoft\\Internet Explorer\\%Computername%.dat and writes a\nhardcoded string in there:\n\nLINE\n\nThe file is then uploaded to the C&C server using the same code that uploads the system information report in “BITS\nDownloader, extended”.\n\nThe names of payloads, filenames and exported function names that are executed from the payload DLLs is identical to the\none of “BITS Downloader, extended”.\n\n**18**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n**C&C URL** https://144.48.241.32/bits\n\n**Unique ID** tnb\n\n### Curl-based downloaders\n\n\n**SHA256** 230de38fc10b7c07af5aceb6ebbafa80c45c2b9123a7a167f85e8a05b5cf0db7\nb8425a5c05c01c1294ce75719049e1b4eab32c34cabe456c281f110976cf2ade\n25da7cc807578394716925afd30a9cc9d543e2fa2a2b25ce8f52160b3b4bc073\n\n**MD5** 9e182d30b070bb14a8922cff4837b94d\n61b4e0b1f14d93d7b176981964388291\n3d2835c35ba789bd86620f98cbfbf08b\n\n**Compiled** 2017.12.13 03:24:47 (GMT), 6.0\n\n**Type** I386 Windows GUI EXE\n\n**Size** 208896\n\nThis is a standalone application built using a generic “Hello world” template of a Win32 GUI application.\n\nAll string constants relevant to the business logic are stored in Base64-encoded form.\n\nThe program creates a hidden window with the name “curl_test” and class name “CURL_TEST”. Then it follows into the C&C\ncommunication routine.\n\n#### C&C communication\n\nThe module downloads several files from its C&C server. The URL of the server is hardcoded and varies among the samples.\n\nIt may download modules specific to either 32-bit or 64-bit target systems, using the suffix “32” or “64” correspondingly. For\neach DLL file the download routine enters an infinite loop and continues to the next module only when the current file has\nbeen download without errors. Each attempt is followed by a predefined delay that is different for each sample.\n\nThe first file to download is the following:\n\nURL of the C&C server/msreg_32.dll or URL of the C&C server/msreg_64.dll\n\nThe file is saved to: %APPDATA%\\msreg.dll.\n\nNext, the module attempts to download the files:\n\nURL of the C&C server/wrtreg_32.dll, saved to %TEMP%\\wrtreg_32.dll\n\nURL of the C&C server/wrtreg_64.dll, saved to %TEMP%\\wrtreg_64.dll\n\nThis library is then loaded, unloaded and deleted. The latter two libraries are downloaded and executed only if the file\nmsreg.dll is is nnot present on disk.\n\n**19**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\nThen the module continuously attempts to download another file:\n\nURL of the C&C server/%Computername%/%PayloadName.dll, saved to %APPDATA%\\%PayloadName%.dll\n(%PayloadName% varies, see the list of names)\n\nThe previous version of the file, if present, is moved to a temporary filename with the prefix %TEMP%\\34F and then\ndeleted. Every time a new such file is successfully downloaded, the module starts a new thread to execute it.\n\n#### Payload ABI\n\nThe payload file is expected to be a regular Windows DLL. The code that interacts with the library is similar to the one used\nin BITS Downloader. The file is loaded using the standard LoadLibraryA API function. Then it resolves the addresses of\nfunctions exported with the names “ExpA”, “ExpB”,“ExpC”, “ExpD”, “ExpE”, “ExpF”, “ExpG”. The functions, if present, are then\nconsequently called. Every function has to take five arguments passed on the stack by pointers.\n\nDepending on the returned values, the module can stop executing the exported functions, download files to disk or upload\ndata produced by the function to the C&C server. The data is uploaded with HTTP POST request to the URL:\n\nURL of the C&C server/upload.php\n\nThe POST request contains the part called “txt” as a file attachment, with its filename and contents provided by the\nexported function.\n\n#### Notable file properties\n\n[The binary is statically linked with libcurl and contains the version string “libcurl/7.49.1”. According to the official Curl website,](https://curl.haxx.se/docs/releases.html)\nversion 7.49.1 was released on May 30 2016.\n\nThe language identifier of the file’s resources is set to 2052 (“zh-CN”). One of the resources is its version information\ncontaining the application name “curl_test”.\n\n#### Variable parameters\n\n C&C URLs\n\n\n**Sample** **C&C URL**\n\n\n9e182d30b070bb14a8922cff4837b94d https://43.252.230.180\n\n61b4e0b1f14d93d7b176981964388291 https://43.252.228.179\n\n3d2835c35ba789bd86620f98cbfbf08b https://103.39.110.193\n\n#### Payload DLL names\n\n\n**Sample** **Payload DLL filename**\n\n\n9e182d30b070bb14a8922cff4837b94d rfvtgb.dll\n\n61b4e0b1f14d93d7b176981964388291 sdfcvb.dll\n\n3d2835c35ba789bd86620f98cbfbf08b newplgs.dll\n\n**20**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n C&C communication delay\n\n**Sample** **C&C communication period, min**\n\n9e182d30b070bb14a8922cff4837b94d 11\n\n61b4e0b1f14d93d7b176981964388291 8\n\n3d2835c35ba789bd86620f98cbfbf08b 15\n\n#### Curl-based downloader, extended\n\n**SHA256** 2c0df314dcdc9fa161f5f31369037f747a794e26cee6f8835cc37eef3077f782\n\n**MD5** 328ad6468f6edb80b3abf97ac39a0721\n\n**Compiled** 2010.01.01 12:37:47 (GMT), 6.0\n\n**Type** I386 Windows GUI EXE\n\n**Size** 208000\n\nThis module is built mostly from pieces of code found in the “BITS Downloader, extended”. However, the C&C\ncommunication routines are similar to those found in the “Curl-based downloader”.\n\nMutex name: “single UI”\n\nSets the autorun registry location: HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run,\nvalue dsuiext=%location of the executable%.\n\nEvery second the module checks for the presence of a kill switch file %APPDATA%\\Microsoft\\exitUI.rs and terminates if it\nis present.\n\nThe module enters an infinite C&C communication loop with a preset delay between each attempt.\n\n#### C&C communication\n\nFirst, the module sends a test GET request using the URL of the C&C server and continues if the attempt succeeds. Then\nit collects system information and writes the results into a text file %APPDATA%\\%Computername%.dat. The code that\ncollects the system information is identical to the one found in the “BITS Downloader”. Then the resulting file with the system\ninformation is sent to the C&C server in a POST request to %URL of the C&C server/upload.php. The code also checks if\nthere is a file %APPDATA%dat present on the disk and if so the file is uploaded instead.\n\nThe URL of the C&C server and the unique identifier (“EXE ID”) are hardcoded in the binary and encrypted with a simple\none-byte XOR operation.\n\n#### Payload\n\nWhen it has finished uploading the system information report the program then attempts to fetch the payload from the\nC&C server. The business logic is similar to the one for “BITS Downloader, extended”, with the following differences:\n\nFiles that are downloaded and executed in separate threads:\n\n**21**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n%APPDATA%\\Microsoft\\WebA.dll fetched from %C&C URL%/%Computername%/WebA.z\n\n%APPDATA%\\Microsoft\\WebB.dll fetched from %C&C URL%/%Computername%/WebB.z\n\nFiles that are downloaded and executed in the current thread:\n\n%APPDATA%\\Microsoft\\WebC.dll fetched from %C&C URL%/%Computername%/WebC.z\n\nEach DLL may have one or more exported functions named “FunA”, “FunB”, “FunC”, “FunD”, “FunE”, “FunF”, “FunG”, “FunH”,\n“FunI”, “FunJ”. Once finished, the program may delete the DLL file depending on the returned value. Depending on the data\nreturned by the functions the module may upload or download the files from the C&C server.\n\n**C&C URL** https://117.18.4.6\n\n**Unique ID (“EXE ID”)** o\n\nC&C communication period: 15 minutes\n\n#### Curl downloader, “OINFO11.OCX”\n\n**SHA256** 4b03409184b3206f7e3a43ff9f7713722c9acd871dd961d918f66e65d92f43f9\n\n**MD5** 7b213a6ce7ab30a62e84d81d455b4dea\n\n**Compiled** 2010.01.01 12:27:15 (GMT), 9.0\n\n**Type** I386 Windows GUI DLL\n\n**Size** 176128\n\n**Internal name** OINFO11.OCX\n\nThe module is a DLL based on the Curl-based downloader, extended. Only the differences are included in this description.\n\nMutex name: “Office Module”\n\nThe kill switch file is monitored in a separate thread. When that file is found, the module not only terminates the current\nprocess but also deletes the autorun registry value.\n\n#### Rich header dump\n\nThe 66 modules compiled with Visual Studio 6 are parts of the libcurl library identical to the one used in the “Curl-based\ndownloader”. The rest of the code was compiled with the more recent version 9 (VS 2008).\n\n**Raw data** **Type** **Count** **Produced by**\n\n0093 521E 00000002 sdk/imp 2 VS 2008 (build 21022)\n\n0096 4FBD 00000009 unknown 9 150 build 20413\n\n0095 521E 00000009 masm 9 VS 2008 (build 21022)\n\n**22**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n**Raw data** **Type**\n\n0083 521E 0000000B cobj 11\n\n000A 2636 00000042 cobj 66\n\n007B C627 0000000D sdk/imp 13\n\n0001 0000 000000A3 imports 163\n\n0084 521E 00000004 c++obj 4\n\n0092 521E 00000001 unknown 1\n\n0091 521E 00000001 linker 1\n\nC&C URL:\n\n\n**Sample** **C&C URL**\n\n\n7b213a6ce7ab30a62e84d81d455b4dea https://103.229.1.26\n\n17a11d22e491acb8c84f8636c3a41637 https://103.30.40.116\n\nUnique IDs (“EXE ID” in the report):\n\n\n**Sample** **Unique ID**\n\n\n7b213a6ce7ab30a62e84d81d455b4dea mo\n\n17a11d22e491acb8c84f8636c3a41637 amb\n\nC&C communication period: 15 minutes\n\nPayload of the BITS Downloader, “FileA.z”\n\n**SHA256** c093c3e366ef0d4bd759a467842868cb1dd974c17e5230499707ec5bee5af304\n\n**MD5** 89527f932188bd73572e2974f4344d46\n\n**Compiled** 2008.01.01 11:58:02 (GMT), 9.0\n\n**Type** I386 Windows GUI DLL\n\n**Size** 46592\n\n**Internal name** FileA.z\n\nThis module is a DLL library that matches the prototype of the payload of the BITS Downloader, extended and was\ndiscovered along with one of the downloader samples.\n\nThe library has an empty DllMain function and three exported functions with the names “CallA”, “CallB”, “CallC”. The\ndescription of these functions follows.\n\n**23**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n CallA\n\n- creates the directory %APPDATA%\\Microsoft\\Windows\n\n- deletes the file %APPDATA%\\Microsoft\\Windows\\mapisp.dll and, if this fails, renames the file to %TEMP%\\Hx101.tmp\n\n- returns the values that result in the BITS Downloader, fetching the file “SecondA.z” from the C&C server to\n\n%APPDATA%\\Microsoft\\Windows\\mapisp.dll\n\n#### CallB\n\n- creates the directory %APPDATA%\\Microsoft\\Windows\\SendTo\n\n- deletes the file %APPDATA%\\Microsoft\\Windows\\SendTo\\cryptui.sep and, if this fails,renames the file to\n\n%TEMP%\\Hx102.tmp\n\n- returns the values that result in the BITS Downloader, fetching the file “SecondB.z” from the C&C server to\n\n%APPDATA%\\Microsoft\\Windows\\SendTo\\cryptui.sep\n\n#### CallC\n\n- sets an autorun registry value : HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run,\n\nname mapisp to “rundll32.exe “%APPDATA%\\Microsoft\\Windows\\mapisp.dll”,CryptoSysPrep\n\n- checks if the files “mapisp.dll” (called “file a”) and “cryptiu.sep” (“file b”) are present\n\n- writes a log of operations into the file %APPDATA%\\Microsoft\\Internet Explorer\\FileOutA.dat and returns\n\nStrings written to the log depend on the results of the preceding operations:\n```\n“second file successA”\n “file a success” or “file a error”\n “file b success” or “file b error”\n “registry set success” or “registry set error”\n “do move file a” or “do not move file a”\n “do move file b” or “do not move file b”\n\n#### WinRAR wrapper “load.rem”\n\n```\n**SHA256** b47f8eda04def2df3d2c58199af5fdded338d08bee8fb3636f441a46bb3ff119\n\n**MD5** fa0a874926453e452e3b6ced045d2206\n\n**Compiled** 2011.01.02 07:00:22 (GMT), 9.0\n\n**Type** I386 Windows GUI DLL\n\n**Size** 43008\n\n**Internal name** load.rem\n\nThis module is referenced and loaded by the downloader modules. It is a DLL with an empty DllMain function and one\nexported function with the name “Load”.\n\n#### Load\n\nThe function is an infinite loop. Every five minutes it checks if there is a file named\n%APPDATA%\\Microsoft\\Windows\\LnkClass.dat. If the file is present, it then executes\n\n**24**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n“%APPDATA%\\Microsoft\\Windows\\LnkClass.dat” a -hpHFG5fv(*&# -r\n“%APPDATA%\\Microsoft\\Credentials\\MSI36C2.dat” %CSIDL_RECENT%\n\nHere, %CSIDL_RECENT% is the location of the “Recent documents” folder. Although the original file named LnkClass.dat\nwas not recovered, the command line is valid for a popular archiver called WinRAR - it is a command to store the contents\nof the “Recent Documents” folder in the archive named MSI36C2.dat encrypted with the password “HFG5fv(*&#”.\n\n#### Intermediate DLL loader “mapisp.dll”\n\n**SHA256** 2e7808e3cfebad45815b3de7b91ea39970e8d99c607c71cb70052cee0e140db4\n\n**MD5** 36b51d2c0d8f48a7dc834f4b9e477238\n\n**Compiled** 2008.01.01 12:03:43 (GMT), 9.0\n\n**Type** AMD64 Windows GUI DLL\n\n**Size** 41984\n\n**Internal name** capisp64.dll\n\n**SHA256** a651af2ce8338d979e6c9d7eed4b3f5c4500602565d36025b3079f9f05afcb33\n\n**MD5** df1b910626a380bffa22a757f419135c\n\n**Compiled** 2017.10.07 00:02:20 (GMT), 9.0\n\n**Type** AMD64 Windows GUI DLL\n\n**Size** 41984\n\n**Internal name** capisp.dll\n\nThis module is referenced by “FileA”. It is a DLL with an empty DllMain function and one exported function with the name\n“CryptoSysPrep”.\n\n#### CryptoSysPrep\n\nThe function checks for the presence of additional DLL files and loads them in separate threads:\n\n%APPDATA%\\Microsoft\\Windows\\SendTo\\cryptui.sep, called by function RetrievePKCS7FromCA\n\n%APPDATA%\\Microsoft\\Network\\sppsvc.sep, copied to %APPDATA%\\Microsoft\\sppsvc.tbl, then loaded and called by\nfunction “PlugA”\n\n%APPDATA%\\Microsoft\\Network\\subst.sep, copied to %APPDATA%\\Microsoft\\subst.tbl, then loaded and called by\nfunction “PlugB”\n\nAny of these DLL files are deleted if the module fails to load them. The function never returns.\n\nThe sample df1b910626a380bffa22a757f419135c loads all libraries in place.\n\n**25**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n### E-mail downloader, “ehlwapi.dll”\n\n\n**SHA256** e3d63dc50b6a477e0361e71f80e133337bab1d11e809387e8e3a058614780b21\n\n**MD5** e2f4914e38bb632e975cff14c39d8dcd\n\n**Compiled** 2009.01.03 01:57:17 (GMT), 8.0\n\n**Type** AMD64 Windows GUI DLL\n\n**Size** 556544\n\n**Internal name** netmgr.dll\n\nThis creates the mutex: “process attach Module”\n\nIt exports two functions, “Config” that just returns “3” and “Process” that spawns a new thread.\n\n#### “Process” function\n\nAll strings related to the business logic are encrypted with a homebrew algorithm similar to RC4 with a hardcoded extended\nS-Box of 1024 bytes.\n\nThe module checks if there is a file present at %COMMON_APPDATA%\\Microsoft\\Windows\\user.rem. If it is present, the\nfile is copied to %APPDATA\\Microsoft\\dfsadu.dll; then it is loaded and its export “MediaA” is called in a new thread.\n\nThen the function enters an infinite loop. Every 20 minutes it tries to connect to a POP3S server “pop.mail.ru”. The module\nuses the first of two pairs of hardcoded credentials that worked.\n\n\n**Login (password hardcoded but not shown)** **Feedback e-mail address**\n\n\nthtgoolnc@mail.ru thgetmmun@mail.ru\n\nthbububugyhb85@mail.ru thyhujubnmtt67@mail.ru\n\nThe module attempts to download the first e-mail message from the mailbox into the %TEMP% directory using a temporary\nfilename with the prefix “Ht”. If the download succeeds, it deletes the message via IMAPS using the same credentials.\n\nIt parses the MIME format using a code that appears to be similar to a widespread open-source class CMimeMessage\n(the class name is included in the RTTI information too). It extracts the message’s subject and continues if it is equal to\n“RepeatA”, “RepeatB”, “RepeatC”, “RepeatD”. If the subject matches one of the names, the attachment from that message is\nsaved and decrypted and then copied with a DLL extension:\n\n\n**Subject** **Temporary DLL name**\n\n\nRepeatA %TEMP%\\RepairA.dll\n\nRepeatB %TEMP%\\RepairB.dll\n\nRepeatC %TEMP%\\RepairC.dll\n\nRepeatD %TEMP%\\RepairD.dll\n\n**26**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\nThe DLL file is then loaded and called by export “MediaA”. Depending on the return value of that function, the DLL file may be\ndeleted or left on disk. Also, the module may encrypt a temporary file produced by the function, and send it as an attachment\nof type “application/x-msdownload” with the name “attach.dat”, to the “feedback” email address via SMTPS. The subject of\nthe message is set to “MINE UPLOAD” and the “From” field is set to the login used to retrieve the incoming messages.\n\n### OLE2 Equation dropper\n\n\nMD5: 33F21AC73AFF4DFF71316795282A3D06 (OLE2 part)\n\nThis is a recovered part of a weaponized document. Since most related code and documents described in public reports\nare known to be RTF documents, this one could also have been embedded in an RTF document.\n\nThe OLE2 stream creation date for all the streams is 2019-02-02. It contains composite objects of types “Microsoft\nEquation 3.0” and “Microsoft OLE 1.0 Native”. The Equation object uses a well-known exploit CVE-2018-0802 and the OLE\n1.0 holds the EXE file that is decrypted by the shellcode of the exploit.\n\nSeveral notable findings:\n\nThe OLE 1.0 Native CompObj stream contains the name in Russian “Пакет” along with the English name “Package”. It also has\na path inside “C:\\Users\\ADMINI~1\\AppData\\Local\\Temp\\8.t” that is used to drop the payload on disk.\n\nThe shellcode and the filename “8.t” are known to be produced by the “Royal Road / 8.t” used by several malicious actors.\n\nThe payload of the document is a dropper for a Curl downloader; the description follows.\n\n#### Payload of the OLE2 dropper, “Data.dll”\n\n**SHA256** ab021048f3d2c61cfbef9d4fb54148e81b2f2c887589e3e6813eb8c1dba36468\n\n**MD5** 6dbb092e081c3e23d555c2a460b96187\n\n**Compiled** 2009.12.31 23:53:59 (GMT), 6.0\n\n**Type** I386 Windows GUI DLL\n\n**Size** 253952\n\n**Internal name** Data.dll\n\nThe file is a DLL with four empty exports:\n\n??0CData@@QAE@XZ\n\n??4CData@@QAEAAV0@ABV0@@Z\n\n?fnData@@YAHXZ\n\n?nData@@3HA\n\n**27**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\nThe DllMain function decrypts (only the first 20 bytes are encrypted) and then drops an embedded EXE file to %TEMP%\\\nstore.exe and executes it. The EXE file is the “Curl-based downloader, extended”\n\n### Launcher for the Curl downloader, “msreg.exe”\n\n**SHA256** 35a476a77218128bd797c04b27f53049998c0951833e47b32455091d83ff4f02\n\n**MD5** a8516452fe7d4d5d2fd0685ccf8a64b2\n\n**Compiled** 2017.10.27 00:28:56 (GMT), 10.0\n\n**Type** AMD64 Windows GUI DLL\n\n**Size** 58880\n\nThis library is a utility for launching the executable %APPDATA%.exe that is an instance of a Curl-based downloader. It just\nstarts the executable from its DllMain function and returns.\n\n### Winhttp-based downloaders, extended\n\nThese samples seem to be based on the same code for collecting system information as the downloaders using BITS and\nCurl and use the same text messages with non-ASCII symbols. However the code in these files uses WinHTTP API for\nconnecting with the C&C servers and expects the payloads to be EXE files, not DLLs. The major differences follow.\n\nThe files contain RTTI information for two user-written classes called “CGetInfo” and “MyWinHTTP”.\n\n**SHA256** c2695ef5f3a400219caa2347f5b914c15d74a133efa24d96d121acfa7f95a67e\n64eabfc0612ac82eb80b8e955549b6a01899b712a99243d116e087828ca9e070\nadb8bfa6e227847c2ffa6e1c97d08280081426480ed9b2ce6af26a23fbd1334c\n0fdcea00a78e0263caa45205d09b107bd50a9696f59a66951e8b9afc42d54e02\n\n**MD5** 08ecd8068617c86d7e3a3e810b106dce\n1732357d3a0081a87d56ee1ae8b4d205\n74db88b890054259d2f16ff22c79144d\n7c3c4c4e7273c10dbbab628f6b2336d8\n\n**Compiled** 2017.05.11 08:33:49 (GMT), 11.0\n\n**Type** I386 Windows GUI EXE\n\n**Size** 95744\n\n**SHA256** 5c7a75d30713bb6873529efebd8bf0a28f8c3720ef4300804703dd33e2086fd0\n\n**MD5** 4769891fccc26c1583e0f21b1a18d2ba\n\n**Compiled** 2017.05.04 13:34:51 (GMT), 6.0\n\n**Type** I386 Windows GUI EXE\n\n**Size** 73728\n\n**28**\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\nIt sets the autorun registry location: HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run,\nvalue Media=%location of the executable%.\n\nThe program collects system information in a text file %APPDATA%%Computername%. The data is similar to the\none collected by other “extended downloaders”, but also includes the list of running processes (all samples except\n4769891fccc26c1583e0f21b1a18d2ba), installed services (4769891fccc26c1583e0f21b1a18d2ba only) and information about\nmounted disks and the listings of their root directories. The text file is uploaded to the C&C server with a POST request\nto %C&C server%/upload.php.\n\nThe module downloads two executable files. The first file is saved in the %STARTUP% folder and the second one is saved\nin the folder named %APPDATA%\\Microsoft and started immediately. The URLs and names of the files vary. The code also\ncontains references to the file “repeat” but that file is never downloaded. Existing files, if they are present and are different\nin size, are moved into a temporary file with the prefix %TEMP%\\341 and then deleted.\n\nEach file is downloaded from the URL constructed according to the format:\n%C&C server%/%Computername%/%filename%,\ni.e. “http://103.195.150.106/%Computername%/winword.exe”.\n\nThe code uses WinHTTP API functions to communicate with its C&C server via HTTP. It uses the default system UserAgent string or “Mozilla/4.0”.\n\n#### C&C addresses and file names\n\n\n**MD5** **C&C server** **Remote**\n**name**\n\n\n**Folder name** **Filename**\n\n\n08ecd8068617c86d7e3a3e810b106dce\n\n1732357d3a0081a87d56ee1ae8b4d205\n\n74db88b890054259d2f16ff22c79144d\n\n7c3c4c4e7273c10dbbab628f6b2336d8\n\n4769891fccc26c1583e0f21b1a18d2ba\n\n**29**\n\n\n103.195.150.106\n\n103.82.52.18\n\n144.48.241.167\n\n\ntasken.exe %STARTUP% tasken.exe\n\nwinword.exe %APPDATA%\\Microsoft winword.exe\n\ncohost.exe %STARTUP% cohost.exe\n\nwinlogon.exe %APPDATA%\\Microsoft winlogon.exe\n\ncohost.exe %STARTUP% remote.exe\n\ntime.exe %APPDATA%\\Microsoft time.exe\n\n\n103.82.52.18 cohost.exe %STARTUP% cohost.exe\n\n103.195.150.106 winword.exe %APPDATA%\\Microsoft winword.exe\n\n\n150.129.81.21\n\n\ncohost.exe %STARTUP% cohost.exe\n\nwinlogon.exe %APPDATA%\\Microsoft winlogon.exe\n\n\n-----\n\n#### MosaicRegressor: Lurking in the Shadows of UEFI\n\n Modification with the “ID” field\n\n**SHA256** f31034fffec424d6e4505318400ecc3b00f8c2107c1823510a037b11a49f0741\nf63ccdabade319cc73a3c5eb41a2877bdb70f4db8bf8414d49fd2f402845f27c\n\n**MD5** 0d3da5adb9bb63c7fcb0185756601749 13773bc34a47124743c9836c6ff80695\n\n**Compiled** 2018.01.29 02:57:16 (GMT), 10.0\n\n**Type** I386 Windows GUI EXE\n\n**Size** 87040\n\n**SHA256** eaa31ce8f9ec828e040801df9faa911e7b70f29f23a70f24504f6ec02f3504ff\n\n**MD5** 7ac0189801242d5261ab5c0c43c7f8d3\n\n**Compiled** 2018.02.01 06:36:46 (GMT), 10.0\n\n**Type** I386 Windows GUI EXE\n\n**Size** 87040\n\n**SHA256** fa116cf9410f1613003ca423ad6ca92657a61b8e9eda1b05caf4f30ca650aee5\n\n**MD5** d848d4ec24e678727b63251e54a0a5de\n\n**Compiled** 2017.07.21 03:01:45 (GMT), 6.0\n\n**Type** I386 Windows GUI EXE\n\n**Size** 73728\n\nThis is a variant of a WinHTTP-based downloader that only collects basic system information and also\nreports a unique hardcoded “ID” similar to the “EXE ID” string used in other types of downloaders. the sample\nd848d4ec24e678727b63251e54a0a5de also collects the information about installed system services.\n\n#### C&C addresses and file names\n\n\n**MD5** **ID** **C&C**\n**server**\n\n\n**Remote**\n**name**\n\n\n**Folder name** **Filename**\n\n\n0d3da5adb9bb63c7fcb0185756601749\n7ac0189801242d5261ab5c0c43c7f8d3\n\n13773bc34a47124743c9836c6ff80695\n\nd848d4ec24e678727b63251e54a0a5de\n\n**30**\n\n\nD01\n\nD01\n\nD02\n\n\n144.48.241.167\n\n43.252.228.75\n\n103.82.52.18\n\n\ntime.exe %STARTUP% time.exe\n\ncohost.exe %APPDATA%\\Microsoft cohost.exe\n\ncrss.exe %STARTUP% crss.exe\n\nwinlgon.exe %APPDATA%\\Microsoft winlgon.exe\n\ncohost.exe %STARTUP% cohost.exe\n\nwinlogon.exe %APPDATA%\\Microsoft winlogon.exe\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2020/2020.10.05.MosaicRegressor_Lurking_in_the_Shadows_of_UEFI/2020.10.05_-_MosaicRegressor_Lurking_in_the_Shadows_of_UEFI_Securelist_2020.pdf"
    ],
    "report_names": [
        "2020.10.05_-_MosaicRegressor_Lurking_in_the_Shadows_of_UEFI_Securelist_2020"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67bf0462-41a3-4da5-b876-187e9ef7c375",
            "created_at": "2022-10-25T16:07:23.44832Z",
            "updated_at": "2025-03-27T02:02:09.806007Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "Careto",
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "ETDA:Careto",
            "tools": [
                "Careto"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "a3687241-9876-477b-aa13-a7c368ffda58",
            "created_at": "2022-10-25T16:07:24.496902Z",
            "updated_at": "2025-03-27T02:02:10.256629Z",
            "deleted_at": null,
            "main_name": "Hacking Team",
            "aliases": [],
            "source_name": "ETDA:Hacking Team",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e90c06e4-e3e0-4f46-a3b5-17b84b31da62",
            "created_at": "2023-01-06T13:46:39.018236Z",
            "updated_at": "2025-03-27T02:00:02.978356Z",
            "deleted_at": null,
            "main_name": "Hacking Team",
            "aliases": [],
            "source_name": "MISPGALAXY:Hacking Team",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716496,
    "ts_updated_at": 1743041407,
    "ts_creation_date": 1601900875,
    "ts_modification_date": 1601900878,
    "files": {
        "pdf": "https://archive.orkl.eu/293d6da465b3568edeba3f01e6b51ab5c504bce8.pdf",
        "text": "https://archive.orkl.eu/293d6da465b3568edeba3f01e6b51ab5c504bce8.txt",
        "img": "https://archive.orkl.eu/293d6da465b3568edeba3f01e6b51ab5c504bce8.jpg"
    }
}