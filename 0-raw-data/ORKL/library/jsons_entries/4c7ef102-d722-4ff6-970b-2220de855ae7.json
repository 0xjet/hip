{
    "id": "4c7ef102-d722-4ff6-970b-2220de855ae7",
    "created_at": "2023-01-12T15:10:51.97922Z",
    "updated_at": "2025-03-27T02:05:51.090941Z",
    "deleted_at": null,
    "sha1_hash": "c1cba4c50a83b917e2163c383f663d2935cedb52",
    "title": "2013-05-17 - Alina- Following The Shadow Part 1",
    "authors": "",
    "file_creation_date": "2022-05-28T02:12:13Z",
    "file_modification_date": "2022-05-28T02:12:13Z",
    "file_size": 1352305,
    "plain_text": "# Alina: Following The Shadow Part 1\n\n**[trustwave.com/Resources/SpiderLabs-Blog/Alina--Following-The-Shadow-Part-1/](https://www.trustwave.com/Resources/SpiderLabs-Blog/Alina--Following-The-Shadow-Part-1/)**\n\nLast I [spoke with you, I went into the details of a family of Point of Sale (POS) malware,](http://blog.spiderlabs.com/2013/05/alina-shedding-some-light-on-this-malware-family.html)\n[named 'Alina'. At the time, I chose to talk about version 4.0, mainly because I felt it gave a](http://blog.spiderlabs.com/2013/05/alina-shedding-some-light-on-this-malware-family.html)\ngood representation of the entire family itself. In the course of my research, I've been able\nto acquire 12 distinct versions. As you may recall from the last blog post, Alina is versioned\nin the User-Agent field for all HTTP-based communication. For example, the User-Agent\nlast time around was \"Alina v4.0\". Knowing this, I plan on talking about the evolution of this\nmalware today, going from version 0.1 up to 5.5. Just for reference, I have the following\nversions at this time:\n\n0.1, 1.0, 2.0, 2.1, 3.1, 3.2, 3.3, 3.4, 3.5, 4.0, 5.2, 5.3, 5.5\n\nI'm going to break up this post into a few different sections, and talk about how the malware\nfamily has evolved over time with respect to various categories. As I started writing this, it\nbecame apparent that it wouldn't fit into one blog post. As such, I've split it up into different\nparts. For this blog post I'm going to focus on the creation timeline, exfiltration, and C&C.\n\n**Creation Timeline**\n\nAnyone familiar with the PE file format knows that there is a time-stamp field in the File\nHeader that typically stores the time the file was compiled (I briefly mention it in a previous\n[blog post, \"Basic Packers: Easy As Pie\" ). Attackers have the ability to 'stomp' this field of](http://blog.spiderlabs.com/2013/04/basic-packers-easy-as-pie.html)\n\n\n-----\n\ncourse, but there is no indication that any of the Alina samples were time stomped. Using\nthis information, along with the version information provided in the User-Agent field, we\nattempt to provide a timeline of just when these versions first appeared.\n\nI realize you may be noticing a few discrepancies with this timeline. The most obvious is\nlikely the fact that version 1.0 appears to be older than 0.1, or the fact that 3.1 is older than\n3.2. It's not an exact science I'm afraid, as we don't know exactly what the author was doing\nat the time. It's possible that he or she decided to simply recompile an older version and use\nit during a compromise, or perhaps some other events took place that would cause these\noddities. It is also curious to note that both version 3.1 and version 0.1 were compiled with\nthe 'debug' flag enabled. These are the only two versions in my possession that are\ncompiled using this flag, which further adds to the mystery surrounding these particular\nversions. At any rate, it provides us a decent look at a general timeline of when this\nmalware was created. Unfortunately, version 5.5 utilized a UPX Protector layer, which\ndestroyed the timestamp information in the PE header, which I'll discuss further in part 2.\nBased on the other information we have, however, it's likely fair to assume it was compiled\nsometime in March 2013, or early April of that same year.\n\n**Exfiltration**\n\nI talked about the exfiltration of version 4.0 in-depth during my last blog post, which you can\nfind [here. Let's take a step back, however, and look at how the author originally exfiltrated](http://blog.spiderlabs.com/2013/05/alina-shedding-some-light-on-this-malware-family.html)\ndata and evolved his or her technique's over time.\n\n\n-----\n\n**v0.1/v1.0**\n\nVersion 0.1 and 1.0 had a very simplistic technique for data exfiltration. Simply put,\neverything was sent in the clear with no obfuscation/encryption whatsoever. We can see an\nexample of this below:\n\nAs you can see, there is simply one POST parameter of 'alina' that contains the clear-text\ntrack data. The only difference regarding exfiltration between version 0.1 and 1.0 appears to\nbe the addition of the 'hwid' POST parameter in 1.0, which contains the volume serial\nnumber of the victim device. This is likely used as a unique identifier that allows the attacker\nto easily differentiate between victims.\n\n**v2.0**\n\nWe see a significant leap in the evolution of Alina's exfiltration in version 2.0 of the malware.\nNamely, the author has decided to change the POST parameter names to something more\ndiscrete. Specifically, the previously named 'alina' parameter has been changed to 'a', the\n'hwid' parameter has been renamed to 'b', and a new POST parameter of 'c' has been\n\n\n-----\n\nincluded, which contains the victim s hostname. We also begin seeing the first signs of\nencryption, as the track data has been XORed with a key of 0xAB, and then converted to\nhex. We see this technique of XORing the data and converting it to hex throughout future\nversions of Alina.\n\n(Decrypted 'a' parameter using Ruby)\n\n**v2.1**\n\nVersion 2.1 of Alina makes another leap in the evolution of this malware's exfiltration\ncapabilities. It is at this time that we begin to see actual commands being implemented\n(discussed further in the C&C section). The 'b' and 'c' parameters have remained\nuntouched, however, track data is no longer contained within the 'a' parameter. Instead, it is\ncontained within the POST parameter 'cdata'. The same encryption routine is used to\nobfuscate this track data. We also see the addition of the 'v' parameter, which contains the\nversion of Alina that is running.\n\nThe constant changing of POST parameters suggests that the author was either attempting\nto evade detections of network-based security solutions, or, perhaps more likely, simply was\nindecisive and was attempting to decide on the best way of sending this data to the server\nhe or she controlled\n\n\n-----\n\nIt was during this version that we also begin to see log messages being exfiltrated by the\nmalware. Specifically, the 'ldata' parameter was used to send out logs periodically when\ncertain events transpired. This log data was encrypted using the same XOR/hex technique\nused for track data. The malware also implemented a log level parameter in this version,\nwhich specified what logs to exfiltrate. We see this logging characteristic throughout a\nnumber of future versions of Alina.\n\n**v3.1**\n\nVersion 3.1 did not vary greatly with regard to data exfiltration. The only apparent difference\nwith POST requests is the addition of the \"p\" parameter, which contains the path of the\nAlina malware on the victim machine.\n\nAdditionally, it is in this version that we begin seeing a requirement for a 666 status code\nfrom the remote server. As mentioned in the last blog post, seeing a 666 status code is\nextremely unusual, and should raise an eyebrow or two for anyone monitoring network\ntraffic. The requirement for this status code is an unusual decision for the malware authors\nto implement.\n\nOne other interesting addition in this version is the support for multiple exfiltration URLs. In\ntotal, three distinct URLs were utilized in the sample analyzed. In the event that a URL did\nnot respond with the correct status code, or was unreachable, Alina simply attempted to try\nthe next URL in the list.\n\n**v3.2**\n\nThe main difference we see at this point is the fact that version 3.2 does not look for the\n'666' HTTP status code, as well as the removal of the log exfiltration request. This is an\nanomaly, as we see these features reintroduced in versions 3.3 and above. This further\nadds to the evidence that version 3.2 was in fact created before version 3.1, as it doesn't\nmake a lot of sense to remove this feature and then reintroduce it.\n\n**v3 3/v3 4/v3 5/v4 0**\n\n\n-----\n\nFrom an exfiltration point of view, this version acts the same as version 3.1. One minor\nchange we discover in version 3.4-4.0 is the removal of a minor piece of information in\noutbound log requests. Specifically, the output of the call to the Windows API call\nGetLastError is removed.\n\nAt this stage the author appears to be quite content with the exfiltration of his or her\nmalware, as we see minimal changes to the overall structure it employs. You can see an\nexample 'download' request of both versions below, illustrating the current POST parameter\nstructure for these versions:\n\n**v5.2/v5.3/v5.5**\n\nIt's clear that a lot of change occurred between versions 4.0 and 5.2. Referring to our\ntimeline, we see that about a month of time elapsed between these versions. This is\nabundantly clear with regard to exfiltration, as the author(s) have completely removed their\nprevious structure and replaced it with a custom one. HTTP POST requests are still the\ntransportation mechanism to exfiltrate data; however, the data inside this POST request is\ncompletely different. You can see this below. I display the raw hex of the request to illustrate\nthat non-ASCII data is being sent across the wire:\n\n\n-----\n\nAfter analysis of the binary, I was able to determine the encryption in use and map out the\nlayout of the data being sent. Like previous versions, a simply XOR scheme is utilized to\nobfuscate this data. The first 76 bytes of data are simply XORed against the key of 0xAA.\nThis provides us with the following (using the above request as an example):\n\nAny data past 76 bytes utilizes a different XOR scheme forobfuscation. Specifically, the\ndecoded data at byte offsets 18 through 35 areused as the XOR key. The screenshot below\nshows us the data starting at offset76:\n\n\n-----\n\nNow that we ve been able to decode the data, let s talkabout how it s structure. Specifically,\nlet's discuss how the data between byteoffsets 0 through 75 is structured. I haven't been\nable to identify everything,but there should be enough to provide you with a good grasp of\nthe data thatthis blob contains.\n\nBytes 0-1 : Static Value\nBytes 2-16 : Alina Version / User-Agent (\"Alina v5.2\")\nBytes 17-24 : Victim Volume Serial Number (Example: \"bc0b5931\")\nBytes 25-26 : 2 Random Bytes\nBytes 27-35 : Command (\"update\", \"cards\", etc.)\nBytes 36-67 : Victim Hostname\nBytes 68-71 : Unknown – Likely Random 4 Bytes\nBytes 72-75 : Unknown – Likely Random 4 Bytes\n\nOne other interesting thing to note regarding version 5.x. When we begin to see log\nrequests being sent across the wire and decoded, we notice some very unusual/interesting\nstrings being used, as shown below:\n\nIt's unclear what these strings, such as '[:112 <2>] {[!16!]}{[!46!]}' mean, however, if I had to\nspeculate I'd guess they were parsed by the server and used to indicate what data was\nsent. In the above example, it's possible that the '{[!16!]}' may represent process name,\nwhile '{[!46!]}' represents its PID. This is purely guesswork, as I have not been able to obtain\naccess to any Alina C&C servers.\n\n**Command and Control (C&C)**\n\n**v2.1-v4.0**\n\n\n-----\n\nCommand and control in Alina was not introduced until version 2.1. Up to this time, we\nsimply see the author decide to automatically upload any discovered data to a single host.\nHowever, when version 2.1 was released, we notice the author's decision to add an option\nto update the malware running on the infected host. This update request allows the author\nto perform two tasks—Update the malware or update the time interval between update\nrequests. It uses the same technique discussed in my previous blog post where I detailed\nversion 4.0. In fact, this technique is seen in every version between 2.1 and 4.0. As a recap,\nthe author sends a request with an 'update' or 'download' request, like the one shown\nbelow:\n\n(The response seen below was created using a mock server I created in Ruby. It is not the\nactual attacker's response).\n\nThe attacker, seeing this request, then has the option of responding with the following\ncommand:\n\nie:<update_interval>:<update_exe_location>\n\nIf the 'update_exe_location' parameter is specified, the malware will attempt to download\nthis file, copies it to a random name in the %TEMP% directory, and executes with an\nargument instructing the malware to delete the original and replace it with the new one.\n\nBy allowing the author to update the malware, it also gives him or her the option of updating\nthe exfiltration URLs, which are hardcoded inside of the binary itself. This update function\ncan in theory also be used as a download/execute component, which can be used to install\nother malware onto the system.\n\n\n-----\n\n**v5.x**\n\nAs we noticed with the exfiltration in version 5.x, we see a complete revamp of the network\ntraffic. This is equally true with regard to Alina's C&C. As you may recall from the Exfiltration\nsection, Alina uses byte offsets 18 through 35 as a XOR key. You may also recall that Alina\nuses offsets 27 through 35 as a command. The following commands have been\nidentified:card\n\ncards\nupdate\ndiag\n\nAdditionally, the following server responses have been identified, along with their\ndescription:\n\nupdateinterval=<integer>: Change interval between update requests\n\ncardinterval=<integer> : Change interval between card exfiltration\n\nlog=1 : Enable logging (not verified)\n\nlog=0 : Disable logging (not verified)\n\nupdate=<url>| : Update malware\n\ndlex=<url>| : Download/Execute file\n\nchk=? : Unknown\n\nIt's interesting to see the addition of an actual download/execute operation in version 5.x, as\nI speculated earlier about how the update command could be used for that same thing. All\nof the commands above are sent across the wire after being XORed with the XOR key used\nin the original request, which again helps to deter simple inspection of the traffic.\n\n**Conclusion**\n\nI realize I've only touched the surface with Alina, as I still haven't even talked about its\ninstallation process, techniques for grabbing track data, packers/crypters in use, etc, but I\npromise I'll do my best to address those details in part 2 of this blog post. Over the course\nof 3-4 months, we've been able to see the Alina authors continually update and improve\nupon their malware. It is likely we will continue to see this trend continue in the future,\nmaking it increasingly difficult to analyze over the wire or on disk. I've included the\nexfiltration URLs for all of the samples I was able to obtain in the wild (not in active cases),\nand also included the hashes for all of the samples in the appendix. Thanks for reading!\n\n[Continue Reading \"Alina: Following the Shadow Part 2\".](http://blog.spiderlabs.com/2013/06/alina-following-the-shadow-part-2.html)\n\n**Appendix**\n\n**Exfiltration URLs**\n\n\n-----\n\nhxxp://84.22.106.87/asdwer/1.php\nhxxp://204.188.242.201/ocz2/up.php\nhxxp://204.188.242.201/dada123/up.php\nhxxp://204.188.242.201/brand_new/up.php\nhxxp://204.188.242.201/sucky/upload.php\nhxxp://204.188.242.201/forum/login.php\nhxxp://193.169.87.147/e107/login.php\nhxxp://208.98.63.228/wp-admin/abc.php\nhxxp://208.98.63.226/goose/push.php\nhxxp://fastbussineslife.net/path/up.php\nhxxp://host3.com/path/up.php\nhxxp://jikobins.com/forum/login.php\nhxxp://zwaonoiy.com/wordpress/sam.php\nhxxp://jikobins.com/sucky/upload.php\nhxxp://ioconzus.com/sucky/upload.php\n\n**Hashes (MD5 Format)**\n\n1efeb85c8ec2c07dc0517ccca7e8d743\n\n37493eb319d126d0ab8f5a55da85563d\n\nc9e5752eea81f7d3521b1d2232afd3b8\n\na418410fa8b2617f3109dc289fa151c5\n\n71fbca87e863db0aca080b4f87cc36f2\n\nd31eb6e7f39dde0c2015dc2804c84a85\n\n5d333312e3dd0fb7b5823696e99000e9\n\n2139e613dc20df19daa6d90a0ff05591\n\n0de9765c9c40c2c2f372bf92e0ce7b68\n7cf5a421c3403441d84a0e34f81c3f0c\n\n1efeb85c8ec2c07dc0517ccca7e8d743\n\ne7e13912af192abe2f6ec90f6d429c6c\n\n6686eed5875f622f5ed21397acb41d86\n\na3ce818621074333723b07a5a5c22e5b\n\n8cdb63b3bfe16c0517e96b316eda3514\n\n99a307128daa407147d1c69d2824d703\n\n0ec4fada5b72e60756bcecec62fd6901\n\n7bef391ddb8f0058823b7aaa96b1ba43\n\n04474d2723d328ce28029c050ec6c0bb\n\n108785e2f5de11df0da4138b8dd819df\n\nRelated articles\n\n[Alina: Casting a Shadow on POS](http://blog.spiderlabs.com/2013/05/alina-shedding-some-light-on-this-malware-family.html)\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2013/2013-05-17 - Alina- Following The Shadow Part 1.pdf"
    ],
    "report_names": [
        "2013-05-17 - Alina- Following The Shadow Part 1.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536251,
    "ts_updated_at": 1743041151,
    "ts_creation_date": 1653703933,
    "ts_modification_date": 1653703933,
    "files": {
        "pdf": "https://archive.orkl.eu/c1cba4c50a83b917e2163c383f663d2935cedb52.pdf",
        "text": "https://archive.orkl.eu/c1cba4c50a83b917e2163c383f663d2935cedb52.txt",
        "img": "https://archive.orkl.eu/c1cba4c50a83b917e2163c383f663d2935cedb52.jpg"
    }
}