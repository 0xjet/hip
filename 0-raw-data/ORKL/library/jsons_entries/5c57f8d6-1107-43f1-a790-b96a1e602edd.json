{
    "id": "5c57f8d6-1107-43f1-a790-b96a1e602edd",
    "created_at": "2023-01-12T14:59:54.282114Z",
    "updated_at": "2025-03-27T02:08:40.337322Z",
    "deleted_at": null,
    "sha1_hash": "87c07dcbd6aabe0b4f13b44a694f406b1c0829e7",
    "title": "2021-08-04 - Cloudy with a Chance of APTNovel Microsoft 365 Attacks in the Wild",
    "authors": "",
    "file_creation_date": "2021-07-22T09:46:00Z",
    "file_modification_date": "2021-07-22T09:46:33Z",
    "file_size": 977661,
    "plain_text": "# Cloudy with a Chance of APT\n##### Novel Microsoft 365 Attacks in the Wild\n\nDoug Bienstock\n\nJosh Madeley\n\n\n-----\n\n#### @doughsec\n\n##### • Incident Response Manager – 7\n\n###### years @ Mandiant\n\n##### • Incident Response and Red\n\n###### Team lead\n\n##### • Author of adfsdump/spoof,\n\n###### pwnauth\n\n##### • Lifelong Green Bay Packers fan\n\n\n-----\n\n#### @MadeleyJosh\n\n#####  Manager of professional services\n\n###### – ~6 years @ Mandiant\n\n#####  Incident Response lead\n  Not an author of public tools\n  Canadian Ex-Pat that has\n\n###### adopted the Patriots as my team of choice\n\n\n-----\n\n#####  Last year demonstrated that Apex threat actors have become all stars at\n\n###### abusing Microsoft 365 to achieve their goals\n\n#####  Large scale espionage campaigns targeted data stored within Microsoft 365\n  Novel techniques used to:\n\n###### – Evade detection\n\n – Automate data theft\n\n – Persistent access beyond credential theft\n\n\n-----\n\n### Avoiding Detection\n\n\n-----\n\n#####  Bypass mailbox audit logging\n\n###### – Set-MailboxAuditBypassAssociation\n\n – The following scenarios are not logged\n\n  Mailbox Owner actions by specified users are not logged\n\n  Delegate actions performed by the users on other mailboxes\n\n  Admin Actions\n\n#####  Downgrade licenses to E3\n\n###### – Save the target organization some money\n\n – Disables MailItemsAccessed logging\n\n\n-----\n\n### Mailbox Folder Permission AbuseIf it aint broke, don't fix it.\n\n\n-----\n\n#####  Alternative to Mailbox Delegation\n  Mailbox owner, administrator, or an account with full access permissions can\n\n###### grant granular access to specific folders within a mailbox\n\n#####  Part of Exchange Web Services (EWS)\n  Many legitimate use cases will be seen in most environments\n\n###### – Sharing calendars\n\n – “Team” mailboxes\n\n – Assistants\n\n#####  First mentioned in red team context by Black Hills in 2017 post\n\nhttps://www.blackhillsinfosec.com/abusing-exchange-mailbox-permissions-mailsniper\n\n\n-----\n\n#####  Permissions can be assigned as individual permissions or roles\n  ReadItems grants access to read mail items in a specific folder\n  Roles that have the ReadItems permission\n\n###### – Author\n\n – Editor\n\n – NonEditingAuthor\n\n – Owner\n\n – PublishingEditor\n\n – PublishingAuthor\n\n – Reviewer*\n\n\n-----\n\n#####  Permissions can be assigned to individual users or mail-enabled security group\n  Anonymous\n\n###### – Any external, unauthenticated users\n\n#####  Default (aka “Everyone” in certain logs)\n\n###### – Any internal, authenticated users\n\n#####  By default, the access for both special users is set to None.\n\n\n-----\n\n#####  Neat: Assign the “Default” user “Reviewer” role to allow any authenticated user\n\n###### access to the mailbox folder\n\n – Permissions do not cascade down from child to parent for existing folders, but newly\n created folders do inherit\n\n – Set-MailboxFolderPermission cmdlet OR EWS Managed API calls using a tool like\n EWSEditor\n\n\n-----\n\n#####  Sign-Ins use EWS to access the modified folders and view email\n\n###### – Coded as “non-interactive” sign-ins\n\n – Non-existent in the Unified Audit Log and must be specifically enabled to forward to\n SIEM from other MSFT sources\n\n#####  Unified Audit Log records Set-MailboxPermission events\n\n###### – There will be noise from legitimate admin and background EXO activity\n\n#####  If Mail Items Accessed auditing is enabled look here\n\n###### – Throttling concerns\n\n#####  Enumerate Mailbox Folder Permissions with PowerShell\n\n###### – Can be slow and should be targeted towards high value accounts\n\n\n-----\n\n### Hijacking Enterprise Applications and App Registrations\n\n\n-----\n\n#####  Two types of Applications\n\n###### – App Registrations\n\n  Initial instance of an application, lives in the tenant that created the app\n\n  Serves as a \"blueprint\" to create a service principal in any tenant that uses the application\n\n – Enterprise Applications\n\n  AKA Service Principals\n\n  A ”copy” of the app registration that lives in the consuming tenant\n\n#####  Everything in Microsoft 365 uses this model, Microsoft Services like EXO are\n\n###### “first-party” Service Principals\n\n#####  The term \"application\" is used to refer to both Enterprise Applications and App\n\n###### Registrations\n\n\n-----\n\n#####  Two types of permissions can be assigned:\n\n###### – Delegated Permissions: Enable apps to perform API operations on behalf of a user – limited to access data that user has access to. Users consent to the permissions at runtime. The application acts as that user.\n\n – Application Permissions: Enable apps to perform API operations without a signed in user and access tenant wide data. Requires Admin Consent. The application acts as itself\n\n#####  Both App Registrations and Enterprise Applications can be assigned\n\n###### permissions\n\n\n-----\n\n#####  Applications can have secrets or certificates associated with them to allow\n\n###### authentication as the identity of the app\n\n – Roughly analogous to API Keys\n\n – Applications can have multiple secrets or certificates associated with them\n\n#####  Once created, they cannot be extracted from Azure AD\n  Both App Registrations and Enterprise Apps can have secrets assigned to them\n\n###### – Enterprise Apps can only have secrets assigned via PowerShell\n\n\n-----\n\n#####  Attackers have modified two key components of existing applications\n\n###### – Adding new MS Graph Application Permissions, specifically file.read and\n```\n    mail.read\n\n – Adding new credentials (both secrets and certificates)\n\n#####  Access tenant data remotely using the Graph API\n\n###### – Conditional Access Policies DO NOT APPLY when authenticating using app secrets\n\n – Service Principal sign-in logs were not available until mid-2020 and they don’t show in\n the UAL\n\n#####  There are dozens of Graph permissions to choose from\n\n###### – Domain.ReadWrite.All – Add a rogue IdP\n\n – Directory.ReadWrite.All\n\n```\n\n-----\n\n#####  Apps can be created as multi-tenant – customers can “add an app” to their\n\n###### tenant\n\n – The App Registration is the “master copy” of the app and is linked to all Enterprise Apps in customer tenants\n\n#####  If we compromise the App Registration we can access data stored in any\n\n###### tenant that has the Enterprise App copy\n\n – All we need is the friendly name (e.g. Microsoft.com) of the tenant we want to access\n\n – Good luck auditing activities that occur in someone else’s tenant\n\n#####  Caveats\n\n###### – Permissions in each individual tenant may be different\n\n\n-----\n\n-----\n\n### Golden SAML\n\n\n-----\n\n###### (4) (5)\n\n (6)\n\n <t:RequestSecurityTokenResponse xmlns:t=\"http://schemas.xmlsoap.org/ws/2005/02\n (3)\n /trust\"> <saml:Assertion xmlns:saml=\"urn:oasis:names:tc:SAML:1.0:assertio n”> <saml:Attribute AttributeName=\"UPN\" AttributeNamespace=\"http://schemas.xmlsoap. org/claims\"> <saml:AttributeValue>\n\n\n-----\n\n-----\n\n-----\n\n#####  Uses Key Derivation Function from NIST SP 800-108 in Counter Mode\n\n###### – DKM key is not used itself to decrypt Signing Certificate\n\n – Used as initial input for HMAC-SHA256 Key Derivation (NIST SP 800-108)\n\n  Mostly, but not exactly, follows the standard (because standards are hard ;)\n\n – Context is the Nonce decoded from blob\n\n – Label is the OIDs of the encryption algorithms decoded from blob\n\n – Outputs keys to use for AES encryption as well as SHA256 HMAC for verification\n of ciphertext\n\n\n-----\n\n#####  Claims issuance rules\n\n###### – Determines the claims that will\n be included in the issued SAML token – Order of rules matters – Defenders cannot see the\n claims that are put in the token BUT\n  MSFT can, to a degree\n  May be monitoring for tokens that have abnormal or unneeded claims\n\n\n-----\n\n#####  Token Lifetime\n\n###### – Set per Relying Party Trust – Default value of 0 == 60 minutes – Defenders cannot see the Token Lifetime of submitted SAML tokens BUT\n\n  Microsoft can\n  May be monitoring for abnormal token lifetimes\n\n – Spoofed tokens could have a lifetime of years, but will not be valid once the\n ADFS signing token is rotated after normal 365-day lifespan\n\n\n-----\n\n#####  Why dump the existing signing certificates when we can just use our\n\n###### own?\n\n – Access to the AD FS server not required\n\n – Similar to @DrAzureAD AAD Backdoor, but a little stealthier\n\n#####  Set-MsolDomainFederationSettings\n\n###### – Global Admin and other privileged roles have access through MSOnline\n PowerShell\n\n – Nothing happens on the AD FS server\n\n\n-----\n\n-----\n\n#####  Nothing to see here,\n\n###### totally normal, nothing was modified\n\n#####  No IP Address\n\n###### recorded\n\n\n-----\n\n### ADFS Replication\n\n\n-----\n\n#####  For larger orgs, AD FS servers can exist in a farm configuration\n  By default, all farm nodes use the same configuration and secrets\n  Nodes are kept in sync by a replication service that runs on the primary\n\n###### AD FS server (the first server that the AD FS role was installed on)\n\n – It actually runs on all farm nodes, useful for attackers\n\n\n-----\n\n#####  Replication service uses Windows Communication Framework (WCF)\n\n###### – Framework to easily build client server applications\n\n – Developer can build on top of preset channels (HTTP) and security (WS-\n Security, Kerberos)\n\n#####  Endpoint is available at http://sts.acme.com:80/policystoretransfer\n\n###### – Kerberos based authentication using WS-TRUST SPNEGO\n\n – Data payloads are encrypted using shared secret derived from the Kerberos\n session key\n\n\n-----\n\n-----\n\n#####  Quick and dirty\n\n###### WCF client to interact with the replication service\n\n#####  ~150 lines of code,\n\n###### most of it boilerplate WCF initialization\n\n\n-----\n\n#####  Edit the ObjectACL for the DKM key\n\n###### to allow domain users read access\n\n#####  Insert a new Authorization Policy\n\n###### into the AD FS database to permit access for the domain users GroupSID\n\n#####  Any domain user can obtain the\n\n###### AD FS signing key from anywhere on the internal network\n\n\n-----\n\n#####  AD FS servers expose port 80 to all systems by default\n\n###### – The AD FS role creates default firewall rules for us\n\n#####  Stealth is built in for us \n\n###### – Replication events are not logged at all\n\n – Editing the AD FS configuration database is not logged either\n\n – Auditing editing domain object ACLs (SACLs) is not often enabled in\n environments\n\n\n-----\n\n# The End\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-04 - Cloudy with a Chance of APTNovel Microsoft 365 Attacks in the Wild.pdf"
    ],
    "report_names": [
        "2021-08-04 - Cloudy with a Chance of APTNovel Microsoft 365 Attacks in the Wild.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535594,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1626947160,
    "ts_modification_date": 1626947193,
    "files": {
        "pdf": "https://archive.orkl.eu/87c07dcbd6aabe0b4f13b44a694f406b1c0829e7.pdf",
        "text": "https://archive.orkl.eu/87c07dcbd6aabe0b4f13b44a694f406b1c0829e7.txt",
        "img": "https://archive.orkl.eu/87c07dcbd6aabe0b4f13b44a694f406b1c0829e7.jpg"
    }
}