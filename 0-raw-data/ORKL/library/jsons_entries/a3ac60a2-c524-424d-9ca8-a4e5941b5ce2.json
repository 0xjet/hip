{
    "id": "a3ac60a2-c524-424d-9ca8-a4e5941b5ce2",
    "created_at": "2023-01-12T15:03:04.490908Z",
    "updated_at": "2025-03-27T02:09:34.563192Z",
    "deleted_at": null,
    "sha1_hash": "771243ee63838e684cdd74a5322faa1e339a69cc",
    "title": "2016-09-07 - The Missing Piece – Sophisticated OS X Backdoor Discovered",
    "authors": "",
    "file_creation_date": "2022-10-31T11:00:42Z",
    "file_modification_date": "2022-10-31T11:00:42Z",
    "file_size": 381835,
    "plain_text": "### www.dragos.com /blog/analyzing-pipedream-results-from-runtime-testing/\n\n# Analyzing PIPEDREAM: Results from Runtime Testing\n\n⋮ 10/27/2022\n\nBy Dragos, Inc.\n\nPIPEDREAM is the seventh known malware affecting industrial control systems (ICS). It’s a flexible ICS\nattack framework and the first cross-industry scalable ICS malware that could be used for disruptive or\n\ndestructive effects. Since the public release of information in April 2022, Dragos has been running\nPIPEDREAM malware against devices (i.e., runtime testing) to clarify what the toolset can do. This blog\n\npost is a summary of the runtime results. Dragos Principal Malware Analyst Jimmy Wylie presented this\n[information at DEFCON30 in detail on August 13, 2022, available on DEFCON’s YouTube channel and](https://www.youtube.com/user/DEFCONConference/videos)\n\n[embedded below. We also recommend that you read our previous blog discussing the PIPEDREAM](https://www.dragos.com/blog/industry-news/chernovite-pipedream-malware-targeting-industrial-control-systems/)\nmalware for details on each component, as we won’t be covering that here.\n\n\n-----\n\nhttps://youtu.be/_dz6VNYSSJ0\n\n## Key Takeaways\n\nWe’ve confirmed that EVILSCHOLAR can target CODESYSv3 devices. Schneider Electric\ncontrollers are likely only the initial target.\n\nBADOMEN can manipulate the 1S-Series of Servo Drives, not just the specific R88D-1SN10F-ECT\nServo Drive.\n\nBADOMEN cannot manipulate Omron Safety Controllers, but this is likely the next step in its\ndevelopment.\n\nEVILSCHOLAR and BADOMEN can achieve logic corruption and manipulation on target PLCs for\ndisruption and destructive effects.\n\n[None of our mitigation guidance has changed. Please see our previous whitepaper for that](https://hub.dragos.com/whitepaper/chernovite-pipedream)\nguidance.\n\n## Analysis Approach\n\nPIPEDREAM was an interesting case in that we had to analyze five malware samples in parallel, which\n\nwere essentially targeting four different “architectures”: Omron NX/NJ series controllers, CODESYSv3\nControllers, Open Platform Communications United Architecture (OPC UA) devices, and Windows OS.\n\nHere is the process we decided to follow.\n\nFirst, we focused on static analysis of the malware (think: reading the code) while we acquired the\n\nhardware. This first static analysis pass provided us enough information to release conservative\nmitigation advice for the malware. Once that process was finished, we began the runtime analysis with\n\nPCAP collection. During runtime analysis, we tested which techniques work on which devices and tested\nany hypotheses from the static analysis process.\n\n\n-----\n\nOnce runtime analysis was complete, we released updated details and specific mitigation advice. Then if\n\npriorities allowed, we did some follow-up research like further firmware analysis.\n\nSo, where are we now in this analysis process? We’re just about finished with runtime testing for all the\n\nvarious components and are beginning to release the results publicly and privately to customers, starting\nwith this blog.\n\nFigure: Testing the capabilities and impact of the PIPEDREAM malware in the Dragos\nlab.\n\n## Lab Testing Results\n\n**MOUSEHOLE**\n\nMOUSEHOLE was the most straightforward to test due to its reliance on an open source Open Platform\n\nCommunications United Architecture (OPC UA) library. We tested it on a Kepware OPC server connected\nto Rockwell PLCs, controlling a mock water pipeline process.\n\nAfter verifying that the malware could indeed interact with the OPC server correctly, we set about creating\nan automated attack, as that would likely be a more real-world attack scenario. In other words, we\n\nsuspect that the attacker would use MOUSEHOLE to recon the target OPC UA-controlled process,\nremove MOUSEHOLE from the network, and then deploy an automated version of MOUSEHOLE for\n\ndisruption.\n\nOur experiment on our pipeline was successful. We could automatically log in to the server, change the\n\nmaximum safe pounds per square inch (PSI) level (15 PSI → 100 PSI), set the pump speed to maximum,\n\n\n-----\n\nand close the solenoid valve. The PSI quickly moved beyond what was considered safe, and the pump\n\nbegan deadheading.\n\nView the video of the testing results in the DEF CON presentation above – MOUSEHOLE Operator View,\n\n[time stamp: 8:25; MOUSEHOLE Safe Shutdown, time stamp: 9:31; and, MOUSEHOLE Unsafe](https://youtu.be/_dz6VNYSSJ0?t=505)\n[Conditions, time stamp: 11:43.](https://youtu.be/_dz6VNYSSJ0?t=703)\n\n**EVILSCHOLAR**\n\nUnlike MOUSEHOLE, EVILSCHOLAR was more difficult to test in the beginning. EVILSCHOLAR\ncontains a custom CODESYSv3 implementation. That implementation, plus the built-in weirdness of\n\nstandard CODESYS, presented some issues for us when trying to figure out which errors were lab\nconfiguration errors versus potential EVILSCHOLAR problems.\n\nAt first, we thought maybe it was a firmware versioning issue, but that turned out to be a mistake. Instead,\nwe discovered that multiple parts of EVILSCHOLAR’s CODESYS implementation were broken due to a\n\nfew invalid assumptions by the adversary developer. We could connect to the TM241 and TM251 with no\nissues if the devices were on a network of the correct size. We spent a couple of weeks making\n\nadjustments to the code and were then able to connect to the TM241, TM251, Raspberry PI, and Hitachi\nEHV+.\n\nWhile we tested all the plugins in EVILSCHOLAR, we’ll only focus on testing its logic corruption potential.\nEVILSCHOLAR allows an operator to transfer files to and from the device using CODESYSv3. The\n\nprocess to test this is reasonably straightforward: pull the logic, disassemble it, modify it, and then\ntransfer it back. This experiment was also a success.\n\nWe could crash and manipulate logic on the TM251 controller, creating various error and output states. In\nboth cases, communications to the controller from the engineering workstation (EWS) are disabled\n\nunless you power cycle the device.\n\nUnfortunately, we can’t share much more about this as we are still working through the responsible\n\ndisclosure process. We reported the applicable vulnerabilities to Schneider Electric and CODESYS\nGroup on June 22, 2022.\n\nThe fact that some of EVILSCHOLAR’s code is broken doesn’t make the threat any less severe. The\n[CHERNOVITE threat group is likely investing plenty of time and money into developing EVILSCHOLAR.](https://www.dragos.com/threat/chernovite/)\n\nIf we were able to fix it in a couple of weeks, it’s only a matter of time before the adversary overcomes the\nissues.\n\n**BADOMEN**\n\nBADOMEN provides similar abilities to EVILSCHOLAR but targets Omron’s NX/NJ series controllers. Its\ncommand line console leverages CVE-2022-34151, a hard-coded credentials vulnerability, to interact with\n\nan HTTP Server on the controller. The server has various common gateway interface (CGI) endpoints\nthat both SYSMAC studio and BADOMEN use to manipulate and administer devices. In particular,\n\nBADOMEN leverages the “cpu.fcgi” and “ecat.fcgi” endpoints.\n\n\n-----\n\nWe ve tested almost all of BADOMEN s plugins, but for this blog, we ll focus on the malware s logic\n\ncorruption and manipulation potential. Using BADOMEN’s backup and transfer modules, we crashed an\nNX1P2 controller by modifying the entry point function of the compiled logic to branch to a bad address.\n\nThe crash prevents the EWS from doing a Program Upload and enabling Program Mode on the\ncontroller.\n\nTo recover, we tried to restore the controller via a secure digital memory card (SD) card which failed, but\nthis did, for unknown reasons, let us put the device in Program Mode. This then allowed us to factory\n\nreset the controller and restore the logic.\n\n**BADOMEN – Servo Testing**\n\n[BADOMEN contains a module to target Omron Servo Drives and their parameters via EtherCat. A Servo](https://www.ia.omron.com/products/category/motion_drives/servomotors_servo-drivers/)\n\nMotor spins a shaft. A Servo Drive powers the motor, controls the motor and handles communications\nback to the governing programmable logic controller (PLC). Servos can be found in pipelines opening\n\npressure control valves to regulate the flow of gas from point to point. They can also be found in electrical\nswitch yards where they are used to put vacuum breakers in an energized position.\n\nThese parameters are essentially configuration values. For example, there are parameters for controlling\nthe direction of rotation of the motor as well as detecting excessive speed. Initially, the malware appeared\n\nto target the R88D-1SN10F-ECT Servo Drive. We confirmed that the malware can manipulate\nparameters on this drive. The documentation showed that all drives in the 1S series shared the same\n\nfunctions and parameters. Thus, we purchased a smaller drive, the R88D-1SN01L-ECT, and its\ncompatible 120VAC motor, R88M-1M10030S-S2. We were also able to communicate with that drive\n\nusing BADOMEN. This result means that the servo module very likely affects all drives in Omron’s 1S\nseries servo drives.\n\n**BADOMEN – Logic Manipulation**\n\nThe Logic Corruption test proved that we could modify the running logic and get it to execute on the\ndevice. This meant that we should be able to make more meaningful changes to the logic to manipulate a\n\nprocess. Further, we wanted to change the servo motor speed, and the only way to make that happen\nwas to modify the appropriate ladder logic function arguments. Thus, it was natural to test logic\n\nmanipulation using the servo motor. (Also, it’s more fun to try this manipulation with a moving device and\nget visual feedback versus simply setting outputs.)\n\nWe started with creating a ladder logic program to spin the motor. Then, we disassembled the compiled\nladder logic to identify the call to MC_MoveRelative. Next, we modified the Velocity argument from 40\n\ndegrees per second to 18000 degrees per second, the maximum motor speed.\n\nView the video of the testing results in the DEF CON presentation above – BADOMEN Max Velocity, time\n\nstamp: 28:09.\n\n**BADOMEN – Safety Controller Testing**\n\n\n-----\n\nOne of the more worrisome aspects of BADOMEN s targeting of NX/NJ series Omron controllers is that\n\nthey are also used to communicate with an Omron safety controller, SL3300. That means that\n[BADOMEN might have the potential to manipulate a safety controller, similar to the TRISIS attack.](https://www.dragos.com/blog/industry-news/trisis-takeaways-defensive-techniques-and-trench-building-for-the-blue-team/)\n\nFrom the beginning, when configuring the SL3300, it was clear from the UI that safety programming was\na different process. In particular, transferring logic required separate DEBUG modes and Safety\n\nvalidation. We saw no references to these modes in the BADOMEN malware. Capturing a packet capture\n(PCAP) clarified the issue.\n\nWe realized that transferring safety logic occurs over a new CGI endpoint, “nxbus.fcgi,” with a different\nfunction (and probably protocol) than we had seen before. BADOMEN does not support this endpoint.\n\nWhile this is good news, for now, building support for this endpoint is a likely next step in development for\nBADOMEN, as safety controllers are a common part of ICS processes. Take the previous servo attack as\n\nan example. In the real world, a safety system would monitor the servo for over spinning and excessive\nvibration. So, conducting that kind of attack in an actual process would require disabling or changing the\n\nlogic on the corresponding safety controller.\n\n## In Conclusion\n\nPIPEDREAM is an existential threat to the ICS community. This toolset is likely being actively developed\n\nand financed. It is already capable of disruption across industries, including CRASHOVERRIDE-style\ndisruption, pipeline disruption, and servo manipulation. We’ve confirmed that PIPEDREAM, with little\n\ndevelopment effort, can target devices speaking the ubiquitous CODESYSv3 and OPC UA protocols. It\ncan manipulate servos in the 1S-Series of Omron Servo drives. While it cannot target Omron Safety\n\nControllers, this is undoubtedly the next step in its development. We’ve confirmed that the toolkit can\nachieve logic corruption and manipulation on CODESYSv3 and Omron devices.\n\nEssentially, our runtime testing has confirmed the results of our initial analysis and, if anything, proves\nthat this toolset is more threatening than we initially thought. However, it appears that the mitigation\n\nguidance we released in April 2022 still applies, and we recommend that site owners and operators\nimplement these mitigations where applicable.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/ICS SCADA/Pipedream/Dragos - Analyzing PIPEDREAM Results from Runtime Testing.pdf"
    ],
    "report_names": [
        "Dragos - Analyzing PIPEDREAM Results from Runtime Testing.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "091dc6fb-2650-4646-894a-41de0d463f94",
            "created_at": "2023-11-17T02:00:07.594612Z",
            "updated_at": "2025-03-27T02:00:03.230461Z",
            "deleted_at": null,
            "main_name": "Chernovite",
            "aliases": [],
            "source_name": "MISPGALAXY:Chernovite",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535784,
    "ts_updated_at": 1743041374,
    "ts_creation_date": 1667214042,
    "ts_modification_date": 1667214042,
    "files": {
        "pdf": "https://archive.orkl.eu/771243ee63838e684cdd74a5322faa1e339a69cc.pdf",
        "text": "https://archive.orkl.eu/771243ee63838e684cdd74a5322faa1e339a69cc.txt",
        "img": "https://archive.orkl.eu/771243ee63838e684cdd74a5322faa1e339a69cc.jpg"
    }
}