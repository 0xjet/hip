{
    "id": "7b4880d7-f0a8-4164-b285-260ac0059d2f",
    "created_at": "2023-01-12T15:01:21.739005Z",
    "updated_at": "2025-03-27T02:05:42.139038Z",
    "deleted_at": null,
    "sha1_hash": "8fcea963318f214f1b54d75b81b04ad7d7cf8305",
    "title": "2015-11-04 - A Technical Look At Dyreza",
    "authors": "",
    "file_creation_date": "2022-05-28T02:30:15Z",
    "file_modification_date": "2022-05-28T02:30:15Z",
    "file_size": 685800,
    "plain_text": "# A Technical Look At Dyreza\n\n**[blog.malwarebytes.com/threat-analysis/2015/11/a-technical-look-at-dyreza/](https://blog.malwarebytes.com/threat-analysis/2015/11/a-technical-look-at-dyreza/)**\n\nhasherezade November 4, 2015\n\nIn a [previous post we presented unpacking 2 payloads delivered in a spam campaign. A](https://blog.malwarebytes.org/intelligence/2015/10/unpacking-fraudulent-fax-dyreza-malware-from-spam/)\nmalicious duet – Upatre (malware downloader) and Dyreza (credential stealer). In this post\nwe will take a look at the core of Dyreza – and techniques that it uses.\n\nNote, that Dyreza is a complex piece of malware and various samples come with various\ntechniques – however, the main features remain common.\n\n## Analyzed samples\n\n[ff3d706015b7b142ee0a8f0ad7ea2911 – Dyreza executable- a persistent botnet agent,](https://www.virustotal.com/en/file/4853906a5ff7b3984d7536d469129a4905d68e8b8cbde75fbef022954a09b89f/analysis/)\ncarring DLLs with the core malicious activities\n\n[5a0e393031eb2accc914c1c832993d0b – Dyreza DLL (32bit)](https://www.virustotal.com/en/file/28db05ba075dd262878dcc4a16e639b197ffb45814d94b844820a173f8e68ce5/analysis/1446569055/#)\n[91b62d1380b73baea53a50d02c88a5c6 – Dyreza DLL (64 bit)](https://www.virustotal.com/en/file/49bf12a39c7634ca1cc2e82644de6a4c297879be883c5c1ab3ae1494eca2bc21/analysis/1446569125/)\n\n## Behavioral analysis\n\nWhen Dyreza starts to infect the computer – it spreads like fire. Observing it in Process\nExplorer, we can see many new processes appearing and disappearing. As we can notice, it\ndeploys explorer, svchost, taskeng… All this is done in order to obfuscate the flow of\nexecution, in hopes of confusing analyst.\n\n\n-----\n\n2 copies of the malicious file are dropped – in C:\\Windows and %APPDATA% – under\npseudo-random names, matching the regex: [a-zA-Z]{15}.exe, i.e vfHNLkMCYaxBGFy.exe\n\nThat persistence is achieved by adding a new task in the task scheduler – it deploys the\nmalicious sample after every minute, to ensure that it keeps running.\n\nCode injected into other processes (svchost, explorer) communicates with the C&C:\n\n[Checking on VirusTotal we can confirm, that contacted servers have been reported as](https://www.virustotal.com/)\nmalicious:\n\n[141.8.226.14 -> https://www.virustotal.com/en/ip-address/141.8.226.14/information/](https://www.virustotal.com/en/ip-address/141.8.226.14/information/)\n83.241.176.230 -> https://www.virustotal.com/en/ipaddress/83.241.176.230/information/\n197.231.198.234 -> https://www.virustotal.com/en/ipaddress/197.231.198.234/information/\n\nWhen we deploy any web browser, it directly injects the code into its process and deploys\nillegitimate connections.It is the way to keep in touch with the C&C, monitor user’s activity\nand steal credentials.\n\nWe can also see files created in a TEMP folder that are serving as a small database, where\nDyreza stores information, before they are sent to the C&C.\n\n## Inside the code\n\n\n-----\n\n**Main executable**\n\nDyreza doesn’t start on a machine that has less than 2 processors. This technique is used as\na defense, preventing file from running on VM. It is based on the observation that VM usually\nhave only one processor – in contrast to most physical machines used nowadays. It is\n[implemented by checking appropriate field in PEB (Process Environment Block), that is](https://en.wikipedia.org/wiki/Process_Environment_Block)\n[pointed by FS:[30]. Infection continues only if the condition is satisfied.](https://en.wikipedia.org/wiki/Win32_Thread_Information_Block)\n\nAt the beginning of execution, malware loads additional import table into a newly allocated\nmemory page. Names of modules and functions are decrypted at runtime.\n\nIt checks, if it is deployed under debugger – using function LookupPrivilegeValue with\nargument SeDebugPrivilege – if it returns non-zero value, execution is terminated.\n\n\n-----\n\nValid execution follows few alternative paths. Decision, by which path of to follow is made\nbased on the initial conditions – like, executable path and arguments with which the program\nwas run. When it is deployed for the first time (from a random location), it make its own copy\ninto C:\\Windows and %APPDATA% and deploy the copy as a new process. As an\nargument to a deployed copy (from C:\\Windows) it passes a path to the other copy.\n\nIf it is deployed from the valid path and the initial argument passed validation, it performs\nanother check – verifying if it is deployed for the first time. It is achieved by creating a\nspecific Global mutex (it’s name is a hash of Computer name and OS Version – fetched by\nfunctions: GetComputerName, RtlGetVersion).\n\nIf this condition is also satisfied and mutex already exist, then it follows the main path,\ndeploying the malicious code. First, the encrypted data and the key are loaded from the\nexecutable’s resources.\n\n_T1RY615NR – encrypted 32 bit code, UZGN53WMY – the key, YS45H26GT – encrypted 64bit code_\n\nUnpacking:\n\n\n-----\n\nThe unpacking algorithm is pretty simple – key_data contains values and data – list of\nindexes of the values in key_data. We process the list of indexes and read the corresponding\nvalues:\n```\ndef decode(data, key_data):\n  decoded = bytearray()\n  for i in range(0, len(data)):\n    val_index = data[i]\n    decoded.append(key_data[val_index])\n  return decoded\n\n```\nThis script decrypts dumped resources:\n\n[https://github.com/hasherezade/malware_analysis/blob/master/dyreza/dyreza_decoder.py](https://github.com/hasherezade/malware_analysis/blob/master/dyreza/dyreza_decoder.py)\n\nThe revealed content contains a shellcode to be injected and a a DLL with malicious\nfunctions (32 or 64 bit appropriately). The main sample chooses which one to unpack and\ndeploy, by checking if it is running via WOW64 (emulation for 32 bit on 64 bit machine) –\ncalling function IsWow64Process.\n\n\n-----\n\n## Malicious DLL (core)\n\nAt this stage, functionality of the malware becomes pretty clear. The DLL does not contain\nmuch obfuscation – it has clear strings and a typical import table.\n\nWe can see the strings that are used for communication with the C&C:\n\n\n-----\n\nBoth – 32 and 64 bit DLLs have analogical functionality. Only architecture-related elements\nand strings are different.\n\nThe agent identifies the system:\n\nand then – include this data in information sent to the C&C:\n\n\n-----\n\nSimilar procedure is present in the 64 bit version of the DLL, only the hardcoded string\n“_32bit” is substituted by “_64bit”:\n\nAlso, network settings are examined (to verify and inform the C&C whether the client can\nestablish back connection – command : AUTOBACKCONN)\n\n\n-----\n\nIt targets following browsers:\n\nBelow – attempt to send stolen account credentials:\n\n\n-----\n\nIn addition to monitoring browsers, it also collects general information about the computer\n(it’s hardware, users, programs and services) – in form of a report:\n\n\n-----\n\nThe malware not only steal information and sniff user s browsing, but also tries to take a full\ncontrol over the system – executes various shell commands – system shutdown,etc. Some\nexamples below:\n\n_Trying to add a user with administrative privileges_\n\n_Shutdown system on command (AUTOKILLOS)_\n\n## C&Cs\n\n\n-----\n\nThis botnet is prepared with great care. Not only communication is encrypted, but also many\ncountermeasures have been taken in order to prevent detection.\n\nFirst of all, the address of the C&C is randomly picked from a hard-coded pool.This pool is\nstored in one of the resources of Dyreza DLL (AES encrypted). Below, we can see how it\ngets decrypted, during execution of the payload:\n\n(A script for decrypting list of C&Cs from dumped resources is available here:\n[https://github.com/hasherezade/malware_analysis/blob/master/dyreza/dyrezadll_decoder.py)](https://github.com/hasherezade/malware_analysis/blob/master/dyreza/dyrezadll_decoder.py)\n\nAlso, the certificate served by a particular C&C changes on each connection. The\ninfrastructure is built on the network of compromised WiFi routers (most often: AirOS,\n_MicroTik)._\n\nThe server receives encrypted connection on port 443 (standard HTTPS) or 4443 (in case if\nstandard HTTPS port of a particular router is occupied by a legitimate service).\n\n## Conclusion\n\nDyreza is an eclectic malware, developed by professionals. It is clear that they are constantly\nworking on a quality – each new version carries some new ideas and improvements, making\nanalysis harder.\n\n## Appendix\n\n\n-----\n\n[Very good Dyreza/Upatre tracker: https://techhelplist.com/maltlqr/ – by](https://techhelplist.com/maltlqr/)\n[@Techhelplistcom (list of C&Cs from the current sample:](https://twitter.com/Techhelplistcom)\n[https://techhelplist.com/maltlqr/reports/01oct-20oct-status.txt )](https://techhelplist.com/maltlqr/reports/01oct-20oct-status.txt)\n**Scripts used in this post:**\n[https://github.com/hasherezade/malware_analysis/tree/master/dyreza](https://github.com/hasherezade/malware_analysis/tree/master/dyreza)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-11-04 - A Technical Look At Dyreza.pdf"
    ],
    "report_names": [
        "2015-11-04 - A Technical Look At Dyreza.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535681,
    "ts_updated_at": 1743041142,
    "ts_creation_date": 1653705015,
    "ts_modification_date": 1653705015,
    "files": {
        "pdf": "https://archive.orkl.eu/8fcea963318f214f1b54d75b81b04ad7d7cf8305.pdf",
        "text": "https://archive.orkl.eu/8fcea963318f214f1b54d75b81b04ad7d7cf8305.txt",
        "img": "https://archive.orkl.eu/8fcea963318f214f1b54d75b81b04ad7d7cf8305.jpg"
    }
}