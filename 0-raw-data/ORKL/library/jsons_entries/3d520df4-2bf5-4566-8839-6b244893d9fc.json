{
    "id": "3d520df4-2bf5-4566-8839-6b244893d9fc",
    "created_at": "2022-10-25T16:48:16.687729Z",
    "updated_at": "2025-03-27T02:17:27.546013Z",
    "deleted_at": null,
    "sha1_hash": "07748a42d1e183e07a9d2c713ee8c9a69ca2c012",
    "title": "",
    "authors": "",
    "file_creation_date": "2019-10-16T13:59:57Z",
    "file_modification_date": "2019-10-16T14:04:38Z",
    "file_size": 4420026,
    "plain_text": "#### Security Report 10 2019\n\n\n# p0sT5n1F3r\n\n## Reverse Engineering of a breach\n\n#### Security Report 10 2019\n\n\n-----\n\n### SUMMARY\n\n#### 1. Introduction\n\n 2. First results\n\n 3. An important discovery\n\n\n-----\n\nThe case\n\nDuring a recent engagement our Incident Response Team had\nthe opportunity to analyze a very insidious backdoor implanted\nin an Apache web server. This allows sniffing HTTPS traffic\nwhen it is licitly decrypted by the web-server. What caught our\nattention was the fact that this component, while revealing many\nof the features of the Linux/Cdorked.A backdoor, may today be\nrecognized as 100% clean on Virus Total.\n\nIt is not every day that we find ourselves faced with cases\nlike this: we are definitely facing a complex artifact designed\n**exclusively for the Customer’s environment which, thanks**\nto extensive use of encryption, is not detected by any antimalware platform, not even the most advanced ones that have\nconquered the market in recent years with behavioral and / or\nmachine learning algorithms.\n\nApache backdoors are nothing new: unfortunately, those\nwho are victims of malware such as Linux/Cdorked.A should\nremember its features and how it interacted with the infamous\nBlackhole exploit kit. The use of external modules or plugins\nfor web-servers is a known persistence technique, used and\nabused over the years but still utilized today. Even last year, Palo\nAlto intelligence sources revealed that the OilRig group used\nthe RGDoor module as a backdoor for the IIS web-server in\nattacks in the Middle East.\n\n\n### 1.\n\n\n### Introduction\n\n##### The Yarix team analyzed a very insidious backdoor, recognized today as 100% clean: a complex artifact designed exclusively for the Customer’s environment.\n\n\n### 2. First results Static analysisLet’s start from the beginning: what is an Apache module? At\n\n##### The hooks exploited by high level it can be considered as a sort of library: additional\n\ncode used to extend native functionalities - in this case of the\n\n##### this module are offered\n\nWeb Server.\n\n##### natively by the Apache module. Today, in the standard package distributions, we find some\n\nalready installed by default, such as mod_ssl or mod_php. In\nthis specific case we found a module, mod_dir.so, which imitates\nin all respects the functionality of the standard one but adds\nothers, really insidious.\n\nThe framework provided by Apache provides the developer with\na series of hooks. These allow to run additional code during the\ndifferent states of execution of the process.\n\n\n-----\n\nIn particular, the hooks exploited by this module (img 1) are offered natively by the\nApache framework and therefore we can know what and how they should be used\n[(ref here).](https://httpd.apache.org/docs/2.4/developer/modguide.html)\n\n_Image 1_\n\n_Hooks used by the module_\n\n\n-----\n\n- ap_hook_child_init: place a hook that executes when a child process is spawned\n(commonly used for initializing modules after the server has forked).\n\n- ap_hook_post_config: place a hook that executes after configuration has been\nparsed, but before the server has forked.\n\n- ap_hook_insert_filter: place a hook that executes when the filter stack is being\nset up.\n\n- ap_hook_handler: place a hook that executes on handling requests.\n\n- ap_hook_log_transaction: place a hook that executes when the server is about to\nadd a log entry of the current request.\n\n- ap_hook_register_input_filter: place a hook that executes a custom function\nwhen input is required.\n\n- ap_hook_fixups: place a hook that executes right before content generation.\n\nBased on the description of these functions, we have an idea of how the module\nworks (img 2).\n\n_Image 2_\n\n_Request processing in Apache 2_\n_[Ref: Apache Tutor](http://www.apachetutor.org/dev/request)_\n\n\n_Data Axis_\n\n\n_Output_\n_Filters_\n\n\n_Accept_ _Content_ _Processing_\n_Logging_\n_Request_ _Generator_ _Axis_\n\n|Cont|ent|Col3|\n|---|---|---|\n|Gene|rato|r|\n\n\n_Metadata Processing_\n\n\n_Input_\n_Filters_\n\n\n-----\n\nAnalyzing the individual functions that are performed by these hooks we can try to\nunderstand what this module actually does.\n\nHOOK 1 | ap_hook_child_init\nThe first function performed is the one that is called by ap_hook_child_init.\nThanks to IDAPro’s capabilities it is possible to understand which functions of the\nstandard library are called.\n\nIt is therefore possible to get a high-level idea of the actions performed as soon as\nApache creates a child process to handle a request that arrives towards the server\nport 80 or 443 (img 3).\n\n_Image 3_\n_Module Initialization routine_\n\nDuring initialization the module attempts to create a mutex and, if it fails, generates an\nerror which is then logged by the _ap_log_error function.\nA sort of debug printf on an error_log.\n\nThe other function called apr_shm_baseaddr_get is more interesting and gets,\nthrough the RDI register, the base address of the shared memory segment.\nUnfortunately, at the moment we are not able to understand much more from static\nanalysis.\n\nHOOK 2 | ap_hook_post_config\nThe second hook ap_hook_post_config that we are going to analyze is executed\nimmediately before the father Apache process reduces its root privileges to\n**www-data. In fact these privileges serve to allocate portions of memory which will then**\nbe used during the operation of the module. It is possible to note the portion of code\nthat allocates a new memory pool (img 4).\n\n\n-----\n\n_Image 4_\n\n_Portion of code that allocates a memory pool_\n\nUntil now we found nothing really strange or malicious or interesting. The module\nbegins to show its capabilities in the functions called by the other hooks.\n\n**It is here that we meet for the first time the string that from now on will represent**\n**the name of our malware: p0sT5n1F3r=**\n\nOur attention is immediately struck by this string which is passed as an argument to\nthe function ap_register_input_filter. The official documentation shows that the\nprototype of this function is:\n\nap_register_input_filter\n(“filter name”, filter_function, AP_FTYPE_CONTENT)\n\nThe first parameter is the name of the filter, the second is the function performed by\nthe filter and the third is the type of filter. So we know that:\n\n- the module registers an input filter\n\n- the filter is called p0sT5n1F3r=\n\n- the filter, when invoked, executes the function sub_38C7\n\n- the filter acts on the content of the request and not on its headers\n\nBefore going into the details of how it works let’s try to get an overview of the other\nfunctions used by the module, so as to focus on what is really interesting. Reverse\nengineering in general is an activity that requires a lot, a lot of time and the risk of\ngetting lost in the technicalities of assembly language is very high.\n\n\n-----\n\nHOOK 3 | ap_hook_insert_filter\nLet’s take a look at the function ap_hook_insert_filter now. Its prototype is:\n\nap_hook_insert_filter(filter_insert, NULL, NULL, APR_HOOK_MIDDLE)\n\nThus, the inserted filter is given by the function passed as the first argument, ie the\nfunction sub_34AB. This function takes care of building the filter which will then be\nactivated inside the module and in fact the function ap_regexec is used, whose role is\nthat of “Match to NUL-terminated string against a pre-compiled regex” (img 5).\n\n_Image 5_\n\n_Role of the function ap_regexec_\n\n\n-----\n\nIt is clear that the regular expression passed to the function resides in the position of\nthe qword_209628 but it is clearly obtained at runtime, since in static analysis this\nlocation is empty.\n\nWhat did we understand until now?\nFrom the static analysis of these functions we were able to understand that the\nmodule:\n\n- is characterized by the string p0sT5n1F3r=\n- takes care of inserting an input filter within the task of processing requests\ncoming to the web-server\n- acts on the body of requests and not on headers\n- the filter is activated only if it meets the exact match of a string that is obtained at\nruntime.\n\n\n-----\n\n### 3. An important Continuing analysisThe approach we are following was useful to begin to\n\nunderstand how the module works because the code was\n\n### discovery\n\nnot obfuscated and none of the functions, custom or standard\nlibraries, were resolved at runtime.\n\nThis unfortunately is no longer true for the two other functions,\nthe most interesting, which are called by the ap_hook_handler\nhook and by ap_register_input_filter.\n\nIn the first case we are dealing with a clearly more complex\nfunction that makes extensive use of encrypted strings (img 6-7).\n\n_Image 6_\n\n_Function performed when the module is invoked_\n\n\n-----\n\n_Image 7_\n\n_Encrypted strings_\n\nIn the second case we find calls to functions dynamically resolved at runtime like this\none highlighted below: the CALL instruction is resolved at runtime by calling a memory\naddress placed in the RAX register (img 8).\n\n_Image 8_\n\n_Runtime resolution of the CALL instruction_\n\n\n-----\n\nBefore tackling the reversing of these two functions we decide to change approach.\nAnalyzing the encrypted strings we find one that we highlighted earlier, Dz27Dz27,\nwhich has an important feature (img 9).\n\n_Image 9_\n\n_Encrypted string_\n\nIt is located at a very precise address within the binary and is called several times\nwithin the previous two functions that we have decided not to analyze. For example,\nwe find two calls in the function sub_3D17 (img 10).\n\n_Image 10_\n\n_Functions that call the string_\n\nThey are two locations, loc_4471 and loc_4170, which use exactly the same data.\nVery interesting is also the fact that the dword_209464 is positioned exactly after\nthe string highlighted before, almost as if they were the declarations of two variables\nclosely related in some way. Curiosity obviously pushes us to check out what this\nfunction does (img 11).\n\n\n-----\n\n_Image 11_\n\n_The encryption function_\n\nIn this shape it does not tell us much. However, if we see the decompiled code (img 12).\n\n_Image 12_\n\n_Decompiled function code_\n\n\n-----\n\nThose who deal with malware reverse engineering and encryption algorithms will have\nunderstood that in cases like this - nine times out of ten - this is the RC4 encryption\nalgorithm. This is in fact the part of the algorithm known as KSA (Key Scheduling\n**Algorithm)** (img 13).\n\n_Image 13_\n\n_KSA (Key Scheduling Algorithm)_\n_[Source here](https://en.wikipedia.org/wiki/RC4)_\n\nThe key and its length are identified as arguments of the function. Once this new\ninformation is obtained, we are therefore able to trace where this algorithm is used to\nencrypt and decrypt data saved statically in the binary.\nWe find the first reference in this interesting function in which we were also able to\nidentify the second part of the RC4 algorithm, the one known as Pseudo-random\n**generation algorithm (PRGA)** (img 14).\n\n_Image 14_\n\n_Custom implementation of RC4 encryption_\n_[Source here](https://en.wikipedia.org/wiki/RC4)_\n\n\n-----\n\nHaving therefore the RC4 key and the length of the encrypted buffer we can proceed\nto decrypt the buffer. To do this we will use CyberChef (img 15).\n\n_Image 15_\n\n_CyberChef_\n_[Source here](http://icyberchef.com/)_\n\nThese evidences have been disruptive for the outcome of the incident response and\nresolution of the case. Analysing these strings we can surely proceed forward in the\nforensic activity of the machine and therefore obtain Indicators Of Compromise (IoC).\n\nAnother very important indication of how specifically the module was built for\n**the Customer’s environment is the presence of the string /Home/Acquisto. This**\ninformation fits exactly with what we have understood from the static analysis: the\nregular expression created during the initialization of the module would seem to look\nfor the match with this string which, incidentally, is exactly the URL that deals with\nfinalizing the monetary transaction where the user enters the data for payment.\n\nThe RC4 algorithm is used in many other functions within the module: each data is\nnever in clear text but always encrypted. However, having the encryption key we can\nproceed a little faster. In particular, a full-bodied buffer inside the track aroused the\ncuriosity of the reverse engineering team (fig.16).\n\n\n-----\n\n_Image 16_\n\n_Encrypted buffer_\n\nA buffer of around 12KB that we can decipher with the same methodology as before\n(img 17).\n\n_Image 17_\n\n_Decrypted buffer_\n\n\n-----\n\nAn html page, saved inside the module, showing a title mod_sniffer and an image\ncalled modIframe (img 18).\n\n_Image 18_\n\n_modIframe_\n\nApart from the nice subtitle the page shows some interesting information: there are in\nfact variables that are obviously resolved at runtime like the kernel version or uptime\nand others of which, at the moment, we do not know the meaning.\n\n**The module is still in the analysis phase.**\n\nWe share the hashes that identify it:\n\nMD5\n1720aca23d81e0aa6fa28096781294c3\n\nSHA-1\ndf454026aac01ad7e394c9f5c2bfdb12fea9a0e0\n\nSHA-256\n1c55ffee91e8d8d7a1b4a1290d92a58c4da0c509d5d8d2741cec7f4cf6a099bd\n\n\n-----\n\n###### Author\n\n#### Mario Ciccarelli\n###### Head of IR Team Yarix - Digital Security Division Var Group\n @Kartone\n\n Special thanks to\n\n#### Alessandro Amadori\n###### Solution Specialist - Digital Security Division Var Group\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.vargroup.it/wp-content/uploads/2019/10/ReverseEngineering_SecurityReport_EN_2019.10.16-2.pdf"
    ],
    "report_names": [
        "ReverseEngineering_SecurityReport_EN_2019.10.16-2.pdf"
    ],
    "threat_actors": [
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716496,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1571234397,
    "ts_modification_date": 1571234678,
    "files": {
        "pdf": "https://archive.orkl.eu/07748a42d1e183e07a9d2c713ee8c9a69ca2c012.pdf",
        "text": "https://archive.orkl.eu/07748a42d1e183e07a9d2c713ee8c9a69ca2c012.txt",
        "img": "https://archive.orkl.eu/07748a42d1e183e07a9d2c713ee8c9a69ca2c012.jpg"
    }
}