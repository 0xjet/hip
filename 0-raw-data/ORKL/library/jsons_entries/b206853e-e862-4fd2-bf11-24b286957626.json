{
    "id": "b206853e-e862-4fd2-bf11-24b286957626",
    "created_at": "2022-10-25T16:48:22.214044Z",
    "updated_at": "2025-03-27T02:09:54.217611Z",
    "deleted_at": null,
    "sha1_hash": "51b16ee4bb04d663a4c67e23e3d3bf816ae12207",
    "title": "The 'Madi' Infostealers - A Detailed Analysis",
    "authors": "Kaspersky",
    "file_creation_date": "2014-07-15T17:25:26Z",
    "file_modification_date": "2014-07-15T17:25:26Z",
    "file_size": 573293,
    "plain_text": "[On 17 July, we published a blog about Madi and the ongoing campaign used to infiltrate computer systems](http://www.securelist.com/en/blog/208193677/The_Madi_Campaign_Part_I)\n\nthroughout the Middle East that has targeted users in Iran, Israel, Afghanistan and other individuals\n\nscattered across the globe. Here is the follow up with a detailed analysis of the infostealer used in the\n\ncampaign.\n\n## Installation\n\nThe infostealer is installed by one of the various downloaders used in the attacks, which can be separated\n\ninto two categories:\n\nDownloaders using the social engineering techniques described in our first blog post (displaying\n\npictures, movies, documents etc.) to trick the user\n\nDownloaders that simply download and install the infostealer\n\nBoth types of downloaders copy themselves as \"UpdateOffice.exe\" into the \"Printhood\" directory, e.g.:\n\n\"C:Documents and Settings%USER%PrintHoodUpdateOffice.exe\" where they start executing.\n\nBoth the infostealer and downloaders create fake files with random names in their respective folders. The\n\ndownloaders also drop some files which assist the malware (see our first blog for details).\n\nOnly one file will be used by the infostealer: nam.dll. This file is created by the downloader in the\n\n\"Templates\" directory (e.g.: \"C:Documents and Settings%USER%Templatesnam.dll\") and contains a BOT\n\nprefix/build that will be used by the infostealer when connecting to the command and control server\n\n(C&C). In order to download and install the infostealer, the downloaders connect to the C&C server to\n\nrequest an HTM page.\n\nOlder variants use http://[C&C address]/ASLK/khaki/Abi/UUUU.htm, whereas more recent ones use\n\n\"http://[C&C address]/ASLK/asgari/mah/UeUeUeUe.htm\".\n\nThe HTM page is a copy of Google index, with a double BASE64 encoded executable embedded in the\n\npage:\n\n\n-----\n\nThe keyword \"tamamshodfile\" at the bottom will be explained in the 'Infostealer analysis' section below.\n\nThe downloaders simply parse the HTM file, and decode the Base64 payload twice and save the resulting\n\nPE file as \"iexplore.exe\" in the \"Templates\" directory. Once downloaded, the infostealer is executed.\n\n## Infostealer analysis: Iexplore.exe\n\nAll the versions of the infostealer have an Internet Explorer icon, and were written in Delphi.\n\nThe version used in this article, which appears to have been compiled on 10 June 2012, is packed using\n\nUPX 3.08.\n\nThe file is rather big: 415 KB packed, and 1.14 MB once unpacked.\n\nOne peculiarity of the infostealer used in the Madi campaign is the heavy use of Delphi Timers. There are\n\n52 of them as you can see on the screenshot below:\n\n.\n\nNumerous bugs were discovered during the analysis of the infostealer. Some of them won't be discussed\n\n\n-----\n\n### TForm4.FormCreate:\n\nUpon execution, the first activity of interest performed by the infostealer happens inside\n\nTForm4.FormCreate.\n\nIt starts with the setup of a keylogger. In order to do so, Madi infostealer uses the Windows function\n\n\"SetWindowsHookEx\" with the \"WH_KEYBOARD_LL\" Id_Hook.\n\nOnce the keylogger has been installed, the infostealer reads the \"nam.dll\" file (dropped by the\n\ndownloader) to get the BOT prefix and concatenates it with the computer name. Hereafter this will be\n\nreferred to as \"BOTID_TMP\". The final BOTID contains some numbers derived from the \"C:\" Volume\n\nSerial Number, as we will see later on.\n\nThe following timers are then disabled in this specific order:\n\nTimer1, Timer16, Timer18, Timer17, Timer20, Timer19, Timer24, Timer8, Timer30, Timer31, Timer33,\n\nTimer34, Timer36, Timer37, Timer38, Timer39, Timer40, Timer41, Timer44, Timer45, Timer46,\n\nTimer48, Timer49, Timer50.\n\nThe malware uses a lot of external files to receive commands, which is another indicator of poor\n\nprogramming skills. Those files are used to inform the malware about the infection status. In order to\n\navoid confusion, hereafter, when referring to a file, it is in the malware directory (\"Templates\" directory),\n\nunless stated otherwise.\n\nThe infostealer looks for the following files:\n\n\"fsdiskget.dll\": If found, it enables Timer 23 – otherwise, disables it.\n\n\"nrbindek.dll\" : If found, it enables Timer 28 – otherwise, disables it.\n\n\"specialfile.dll\": If found, it deletes it.\n\n\"filesend.xls\": Doesn't actually look for it; just tries to delete it.\n\n\"begirnagir.htp\" : If NOT found, it disables Timer3\n\n\"filebind.xls\": If found, it enables Timer29 – otherwise, disables it.\n\nNext, Timer14 and Timer13 are both disabled.\n\nThe Trojan looks for \"First dll\" which is created the first time the malware is executed\n\n\n-----\n\nIt creates first.dll with a hardcoded stream of bytes (not a real .dll, like the .dll mentioned above, as we will\n\nsee later on when we analyze the timers more closely).\n\nLike the downloaders, the infostealer also generates fake files with random names. Before returning from\n\nTForm4.FormCreate, 6 loops will be executed:\n\nXLS: 51 fake XLS files with random names (7 characters) are generated using a hardcoded stream of bytes.\n\nEXE: 51 fake EXE files with random names (6 characters) are generated using a hardcoded stream of\n\nbytes.\n\nDLL: 201 fake DLL files with random names (9 characters) are generated using a hardcoded stream of\n\nbytes.\n\nTXT: 51 fake TXT files with random names (4 characters) are generated using a hardcoded stream of\n\nbytes.\n\nXML: 51 fake XML files with random names (8 characters) are generated using a hardcoded stream of\n\nbytes.\n\nHTM: 51 fake HTM files with random names (8 characters) are generated using a hardcoded stream of\n\nbytes.\n\n### Keylogger analysis:\n\nAs mentioned before, the keylogger setup is done in the TForm4.FormCreate. It uses\n\n\"SetWindowsHookEx\" with the \"WH_KEYBOARD_LL\" Id_hook to intercept keystrokes.\n\nThe hook function is rather rudimentary. For instance, it uses the GetAsyncKeyState, with the\n\n\"VK_BACK\" to find out if the victim used backspace.\n\n\n-----\n\nFor each typed key, there is a handler to save which key was typed in the keylogger buffer\n\n\"poki65_pik_log\":\n\nIt comes as no real surprise that the keylogger is very basic and makes no use of any advanced\n\ntechnologies.\n\nThe malware uses 52 timers. Therefore, we will group them by actions, in order to make the overall\n\nanalysis easier to follow.\n\n## Command and control: Protocol\n\nWe are now going to cover all the timers responsible for contacting the C&C server and receiving\n\ncommands to execute on the infected machine, and all the various handlers used to execute actions\n\n\n-----\n\nNote: In many routines, Madi creates \".bat\" files in order to ping the C&C server to see if it is up or not and\n\nsaves the result in a special file. Each file has a different name. If these files are referenced, we will provide\n\nthe timer number responsible for its creation.\n\nThe server manager looks like this:\n\nThe GUI was probably rushed, but it serves its purpose. It can be used to create specific tasks for victims.\n\nSee Timer 12 to see how each command is handled by the infostealer.\n\n**Timer 1: Check-in**\n\nInterval: 25 seconds\n\nBefore receiving commands, the infostealer connects to the C&C to a special page. I call it the check-in\n\nroutine. Here is the description:\n\nTimer 1 gets the ApplicationName and concatenates it with \".pkklm\" (See Timer 15 description for details\n\non how this file is created). It tries to open that file, looking for the \"Reply From\" string (when the IP\n\nresponds to a ping). If it's not found, it disables Timer 1 and returns.\n\nIf present, the last part of the BOTID is generated using the \"C:\" Volume Serial Number.\n\nBasically, the API function GetVolumeInformationW is called to get the Volume Serial Number, which is\n\n\n-----\n\nhas been generated, the final URL that is visited is generated as follows:\n\nBOTID|COMPUTERNAME|VolumeSerialNumber/dastor/file.htm e.g.: abaanu5|MYCOMPUTER\n8712422C|6D8704FE/dastor/file.htm\n\nThe final URL is visited using Internet Explorer (IE) instrumentation. (e.g.:\n\nhttp://C&C/abaanu5MYCOMPUTER-8712422C6C7704EF/dastor/file.htm)\n\nOnce visited, it enables Timer 18, disables Timer 1 and returns.\n\nThis is the checking-in process, which can tell the attackers when a victim computer is ready to receive\n\ncommands.\n\nOnce the attackers have decided to send commands to the infected computer, a \"das.htm\" will be available\n\nin the \"/dastor/\" folder.\n\n**Timer 16: Visit commands page**\n\nInterval: 25 seconds\n\nTimer 1 gets the ApplicationName and concatenates it with \".pkxm\" (ping results from Timer 11). It tries\n\nto open that file, looking for the \"Reply From\" string (when the IP responds to a ping).\n\nIf it's not found, it disables Timer 16 and returns.\n\nThe Final BOTID is computed (see Timer 1 description) to build the URL that is visited in order to receive\n\ncommands. Before visiting that URL, the \"dast.xls\" file is deleted (see Timer 17 below).\n\nThe URL is visited using IE instrumentation. Timer 17 is enabled, and Timer 16 disabled.\n\n**Timer 17: Save the command page as \"dast.xls\"**\n\nInterval: 20 seconds\n\nNote: During the execution of the Madi infostealer, many instances of IE are running.\n\nTimer 17 will go through all the different instances of instrumented IE, looking for pages with \"dastor\" in\n\ntheir title. Once found, the content of the page (without the title) is saved as \"dast.xls\".\n\nIf nothing is found, it will go to next IE instance, and repeat the checks until no instances are left. If\n\nnothing is found, a clean-up routine is launched.\n\n\n-----\n\n(Internet Explorer) and sends a WM_Close Message using the PostMessageW function in order to\n\nclose the page. Among all those captions, it also looks for \" - 404 - File or directory not found\" and variants\n\nof 404 pages, if the page wasn't found.\n\nOnce the clean-up is completed, Timer 17 disables itself and returns. At this point, we have a local file with\n\nthe commands to execute on the infected machine.\n\n**Timer 12: Command dispatcher**\n\nThis timer is responsible for parsing the command file. In order to make the description a little easier to\n\nfollow, here is a sample command file:\n\nWhen executed, Timer 12 is disabled.\n\nThe infostealer Trojan then checks if the file \"dast.xls\" is present (created by Timer 17, see above).\n\nIf it's not present, Timer 12 is re-enabled and returns.\n\nThe next stage of the process opens \"dast.xls\" which searches for commands to execute (see the command\n\nfile above). Lots of commands can be sent simultaneously, meaning Timer 12 will not stop parsing when\n\none command is found. Here is the full logic of the parsing:\n\nPIK:\n\nIf the command file contains the word \"pik\", it checks if the status of Timer 3 is enabled. (Timer 3 is a\n\nwebmail, social network and IM screen capture routine.)\n\nIf not enabled, Timer 3 is enabled, and screen monitoring begins. Command parsing continues. If the\n\n\"pik\" command is not found, Timer3 is disabled.\n\nDESK:\n\nIf the command file contains the word \"desk\", it checks if the status of Timer 13 is enabled. (Timer 13 is a\n\nscreen capture routine.)\n\nIf not enabled, Timer 13 is enabled, and screen monitoring begins. Command parsing continues. If the\n\n\"desk\" command is not found, Timer13 is disabled.\n\n\n-----\n\nIf the command file contains the word sound, it checks if the status of Timer 14 is enabled. (Timer 14 is a\n\nsound recording routine.)\n\nIf not enabled, Timer 14 is enabled, and sound recording begins. Command parsing continues. If the\n\n\"sound\" command is not found, Timer14 is disabled.\n\nIf the command file contains the word \"newfi\", nothing happens. This is probably a leftover from older\n\ncode.\n\nUPDATE:\n\nIf the command file contains the word \"update\", it checks to see if it also contains a version number, which\n\nmust be different from current version (\"1.1.6\" in the analyzed sample). If neither of those two conditions\n\nare valid, it goes to the next command parsing. The checking routine is very simplistic and assumes that\n\nthe version number will be higher, not lower. It is therefore possible to downgrade the Trojan.\n\nIf the required update criteria are met, it will create \"Update.dll\". (Update.dll is made from a hardcoded\n\nstream of bytes and isn't a valid DLL.)\n\nThe Trojan now locates the \"STARTUP\" folder where a copy of the \"UpdateOffice.exe\" (Trojan\n\ndownloader) is found, and executes it using ShellExecute. (In the first part of the article, we explained how\n\nthe downloader downloads and installs the infostealer.)\n\nThe Trojan downloader is necessary in order for updates to occur. If the downloader has been deleted for\n\nsome reason, the update won't be performed.\n\nOnce executed, Timer 12 terminates its execution, as the infostealer executable (iexplore.exe) will be\n\noverwritten by the Trojan downloader with a newer version and executed.\n\nDELETE:\n\nIf the command file contains the word \"delete\", it will create \"delete.dll\", using exactly the same stream of\n\nbytes that is used in \"update.dll\".\n\nThe Trojan now locates the \"STARTUP\" folder where a copy of the \"UpdateOffice.exe\" downloader is\n\nlocated, and deletes it. Once deleted, it then proceeds to terminate itself.\n\nAt this point, upon the next reboot, the infection isn't restarted.\n\nNote: The infostealer doesn't restart by itself, allowing an automatic update every time the computer\n\nreboots.\n\n\n-----\n\nfolder. The full folder of the infostealer is still present, as is the malware.\n\nBIND: If neither \"update\" nor \"delete\" are found, Timer 12 checks if the command file contains the word\n\n\"bind\" and creates \"nrbindek.dll\" using exactly the same stream of bytes that is used in \"update.dll\".\n\nNothing else happens at this point. However, as we have seen in the Form creation, upon execution, the\n\nmalware checks whether \"nrbindek.dll\" is present.\n\nIf it is present, Timer 12 will enable Timer 28.\n\nIf \"bind\" isn't found, the parsing continues with the next command.\n\nDISKGO: If the command file contains the word \"diskgo\", it will create \"lbdiskgo.dll\", using exactly the\n\nsame stream of bytes that is used in \"update.dll\". Parsing continues with next command.\n\nNote: \"lbdiskgo.dll\" is checked by Timer 42 and Timer 43.\n\nDISKGET: If the command file contains the word \"diskget\", it will create \"fskdiskget.dll\", using exactly the\n\nsame stream of bytes that is used in \"update.dll\" and enable Timer 23.\n\nTimer 12 then checks whether \"specialfile.dll\" is present. If NOT, it will look for the file extensions\n\nincluded in the command that was received. The attackers select from a list of 27 extensions that are\n\nprovided by the C&C server, and which can be selected using a Remote Control Tool (see at the beginning\n\nof the Timer 12 description to view the extensions listed in the sample command file). Each file extension\n\nis separated by a special marker \"$.$\".\n\nTimer 12 searches for the \"$.$\" marker. If it's not present, the parsing stops there.\n\nIf the marker is present, it saves those extensions to the \"specialfile.dll\" and enables Timer 26.\n\nNote: Specialfile.dll is therefore used to tell the malware what file extensions to look for and Timer 26 will\n\nhandle diskget.\n\nAfterwards, or if specialfile.dll was already present, it will check whether the \"logfi.dll\" is present, and stop\n\nparsing commands if it is not.\n\nIf the file is present, it looks in the command buffer for the word \"file\" and exits the commands parsing if\n\nnot found.\n\nIf logfil.dll is present, it will search files on fixed hard drives and remote drives. The authors' poor\n\nprogramming skills are quite noticeable in this part of the code.\n\n\n-----\n\nServer Control tool, and that they made a duplicate entry in the hardcode list of files that need to be to\n\nlocated (htm is present twice).\n\nFile types searched:\n\n*.*txt/*.*jpg/*.*doc/*.*pdf/*.*bmp/*.*docx/*.*mdb/*.*xls/*.*csv/*.*html/*.*avi/\n\n*.*mp3/*.*wave/*.*htm/*.*rar/*.*zip/*.*htm\n\n(again?!)/*.*gif/*.*7z/*.*jar/*.*JPEG/*.*mp4/*.*3gp/\n\n*.*dat/*.*MPEG/*.*SWF/*.*WMV/*.*xml/*.*MHTML/\n\nTotal of 29 extensions, with one duplicate. 27 extensions are present in the Server Control tool and one\n\nthat is not (MHTML).\n\nIt saves the log file as \"logfi.dll\" for each hard drive and creates a backup as \"logfi.dll.BMH\". It will\n\noverwrite the logs for each iteration of the loop.\n\nIt only search files on remote and fixed drives, not on USB/external drives; that's for the logging part.\n\nOnce the Parsing is complete, Timer 12 re-enables itself and exits.\n\n### Monitoring\n\n**Timer 3: PIK handler – Webmail, social network and IM screen capture**\n\nInterval: 60 seconds.\n\nTimer 3 creates a \"begirnagir.htp\" file.\n\nIt then checks whether the user has been surfing or using the following applications and takes a screen\n\ncapture if found:\n\ngmail, hotmail, yahoo! mail, google+, msn messenger, blogger, massenger (?), profile,icq, paltalk, yahoo!\n\nmessenger for the web, skype, facebook.\n\nThe screen captures are saved as a JPG using the following name convention: mm-dd-yyyy-hhnnss. The\n\n\"Now\" and \"FormateDateTime\" functions are used.\n\n**Timer 13: DESK handler – Screen capture**\n\nInterval: 3 minutes\n\nNote: The GUI used to control the bot says 2 minutes but the code doesn't lie\n\n\n-----\n\nmm-dd-yyyy-hhnnss. The Now and FormateDateTime functions are used.\n\nThe files are in JPG format.\n\n**Timer 14: SOUND handler – Recording sound**\n\nThis timer is responsible for starting the audio recording using the mci* functions from winmm.dll.\n\nThe following commands are used: \"OPEN NEW TYPE WAVEAUDIO ALIAS mysound\", \"SET mysound\n\nTIME FORMAT MS BITSPERSAMPLE 8 CHANNELS 1 SAMPLESPERSEC 8000 BYTESPERSEC 8000\"\n\nand finally \"RECORD mysound\". Once the commands are sent, Timer 30 is enabled, and Timer 14 returns.\n\n**Timer 30: Started by Timer 14 (sound command handler)**\n\nInterval: 60 seconds\n\nThis timer does anything apart from start Timer 31 when it is time to save the recoded audio.\n\n**Timer 31: Started by Timer 30 (when it is time to save audio recordings)**\n\nWhen sufficient time has passed since the start of audio recording, Timer 31 disables Timer 30, stops the\n\nrecording by sending the following command: \"STOP mysound\".\n\nTo save audio files, it sends the \"SAVE mysound\" command. The files are saved using the following name\n\nconvention: mm-dd-yyyy-hhnnss. The \"Now\" and \"FormateDateTime\" functions are used.\n\nThe final file is saved as .wav.BMH.\n\nTimer 31 is then disabled, and Timer 14 (Sound handler) is re-nabled for the next audio recording.\n\n**Timer 32: Set up keylogger**\n\nInterval: 60 seconds\n\nEven though the keylogger setup is performed when the application starts, in the FormCreate routine\n\nTimer 32 sets up the keylogger every 60 seconds. The details of the keylogger have already been described\n\nearlier in this document.\n\n**Timer 2: Creation of keylogger logs**\n\nInterval: 10 seconds\n\n\n-----\n\npoki65.pik file is present. This file is the current ongoing keylogging file. If it s not present, it looks for\n\n\"solt.html\", which indicates whether the keylogger has created its first log yet.\n\nIf none of those files are present, it means it is the first time the keylogger has started logging.\n\nThe first log file is different from subsequent log files, as it contains more information. The Madi keylogger\n\nfiles use HTML tags and colors to make them easier to read.\n\nFor the first log, it executes \"cmd.exe /c ipconfig /allcompartments > ipconfig.txt\"\n\nIt waits 5 seconds and appends the content of \"ipconfig.txt\" to the HTML content that is created.\n\nThe computer name as well as the current user name is appended to the log, followed by the list of\n\navailable drives: Floppy Drive, Fixed Drive, Network Drive, CD-Rom Drive and RAM Disk.\n\nFinally, a full list of installed software, including security patches, is appended to the log file, as can be\n\nseen on the screenshot below:\n\nOnce this part is completed, it creates a file called \"solt.htm\" containing the word \"wertik\".\n\nIt will continue formatting the poki65 log file. At the very beginning you can see the \"Content-Language\"\n\nset to \"fa\", which is Persian.\n\n\n-----\n\nThis is how the keylogger logs are generated.\n\n**Timer 4: Insert time stamps and tags to display screen captures into keylogger logs.**\n\nInterval: 1 millisecond\n\nTimer 4 is responsible for inserting IMG tags inside the keylogger log. It is also responsible for adding the\n\ntime stamp taken from the C&C server (see Miscellaneous section, Timer 7 and 8).\n\n**Timer 6: Backup keylogger log for exfiltration**\n\nTimer 6 searches for the poki65.pik file - the current log session. If not found, it returns.\n\nIt then looks for the size of the log file. If it is lower than 15 KB, it will return. Only log files bigger than 15\n\nKB are exfiltrated. If the size criteria is met, they are copied using the following name convention: mm-dd\nyyyy-hhnnss.HTM. Timer 6 then deletes \"poki65.pik\" and returns.\n\nNote: A new log will be created by Timer 2 (solt.html tells the keylogger not to list drives, installed\n\nsoftware etc. again).\n\n### DATA STEALING\n\nData stealing is handled by several timers. Each type of stolen data is stored in a special folder in the\n\nserver. Files exfiltrated to the C&C servers are Base64 encoded.\n\nBIND:\n\n**Timer 28: Started during Form Creation (related to the BIND command)**\n\nNote: When the infostealer starts, Timer 28 is enabled if the file \"nrbindek.dll\" is present (created by the\n\nBIND command).\n\nTimer 28 searches for \"*.*exe\" files on all fixed hard drives. For each *EXE* file found that doesn't belong\n\nto the \"Windows\", \"Program Files\" or \"Program Files (x86)\" folders, an entry (full path to *EXE* file) is\n\n\n-----\n\nOnce the hard drives have been scanned, Timer28 returns.\n\nFilebind.xls therefore contains all the executables on the fixed hard drives, except from those in Windows\n\nand Program Files.\n\n**Timer 29: Started during Form Creation (related to the BIND command)**\n\nNote: The code of this timer is some of the worst that is used in the infostealer. The programming,\n\nobfuscated with Delphi, is very bad.\n\nTimer 28 generates a list of *EXE* files that don't belong to the \"Windows\", \"Program Files\" or \"Program\n\nFiles (x86)\" folders. For each entry of that file, Timer 29 will make a backup of the executables. The\n\n*.bind* extension is appended to their original name.\n\nMany files are used to monitor the exfiltration status of the executables.\n\nHowever, Timer 29 doesn't actually seem to exfiltrate anything, probably because of bugs.\n\n**Timer 9: Check for files ready to be uploaded**\n\nInterval: 5 seconds\n\nTimer 9 is disabled. If either Timer 19 or Timer 20 is enabled, it means there is already an active\n\nexfiltrating task. Timer 9 is enabled and it returns.\n\nOtherwise, Timer 9 searches for files *.*KILOP as well as *.htm.BMH* files in the malware directory.\n\nKILOP files are Base64 encoded versions of files to exfiltrate. If no file is found, Timer 9 is enabled and\n\nreturned.\n\nIf files are present, they are ready to be exfiltrated, and Timer 19 is enabled. Before returning, Timer 9 is\n\nenabled.\n\n**Timer 19: Check if IE instrumentation has been used to visit the upload page.**\n\nInterval: 25 seconds\n\nTimer 19 searches for a specific page title:\n\nIf the page title \"new title hastam - Microsoft Internet Explorer\" is found, Timer 19 returns.\n\n\"OKshodiha - Windows Internet Explorer\" means a file is ready to be uploaded – Timer 20 is enabled and\n\n\n-----\n\nIf none of those captions are found, Timer 19 starts IE_Instrumentation and visits the Sendfilejj.html\n\npage, enables Timer 20, then returns.\n\n**Timer 20: File upload**\n\nTimer 20 searches for *.*KILOP files, computes the BOTID (see Timer 1 for details), and fills the POST\n\nparameters. The \"S0\", \"S1\" and \"S2\" forms present in the Sendfilejj.html are \"filled\" and the file is\n\nuploaded using IE Instrumentation.\n\nT3, is the BOTID+Folder used for uploading (see below)\n\nT2 is the file name\n\nT1 is the Base64 encoded content of the file.\n\nTo compute T3, the following folder is appended to the BOTID (each victim has a root folder named after\n\nthe BOTID on the C&C).\n\n\"/Pi/\" for .jpg.BMH - Screen Captures\n\n\"Te/ for .htm.BMH - Keylogger logs\n\n\"/So/ for .wav.BMH - Audio Recordings\n\n\"/Fi/\" for important.file.BMH\n\n/Fi/CoolDisk/\" for .fildik.BMH (data stolen from removable drives)\n\nFiles are sent via the Sendfilejj.html page hosted on the C&C, which is a wrapper for the \"sik.php\" script\n\nused to receive exfiltrated data.\n\n**Timer 5: Base64 encoder for exfiltrated data**\n\nInterval: 1 millisecond\n\nWhen triggered, it disables Timer 5, searches for *.*BMH files (files that will be exfiltrated once Base64\n\nencoded) in the malware folder. When one file is found, it checks if the file is indeed on the disk and\n\naccessible. It Base64 encodes it and saves it as nameoffile.BMH.KILOP. The non encoded version (BMH)\n\n\n-----\n\nsmall, therefore it s almost instantaneous.\n\nNote: The resulting encoded files are those handled by Timer 20 described above. The process occurs as\n\nfollows: Timer 9 enables Timer 19, which enables Timer 20 to upload files generated by Timer 5.\n\n**Timer 21: Filesend.xls parser**\n\nFilesend.xls has a list of files to exfiltrate.\n\nUpon execution, Timer 21 is disabled. If \"filesend.xls\" is present, it is opened and read.\n\nAll the files to be exfiltrated are separated by the \"*\" character as in the example below:\n\n*C:Documents and Settings%USER%\n\nDesktoptoolsstealme.txt**C:Documents and Settings%USER%\n\nDesktoptoolsstealme2.txt*\n\nTimer 21 parses each entry, and will check whether the file exists. If it does, a copy of the file will be made\n\nin the malware directory with a .file.BMH extension. (In my example, we have: \"stealme.txt.file.BMH\".)\n\n**Timer 10: Tracking what was uploaded and cleaning IE instrumentation pages**\n\nWhen a file has been uploaded using Timer 20, a POST is made to the sik.php file, a page is returned\n\ncontaining the name of the uploaded file, as well as the hardcoded string \"Save Shode\" as you can see on\n\nthe screen capture below:\n\nTimer 10 is responsible for keeping track of some of the uploaded files. Exfiltrated files are added to the\n\n\"rafteha.zip\", which lists the files that have already been handled. The last file path to be handled is saved\n\nto the \"fileomade.xls\" file.\n\n**Timer 15: Check for \"filesend.xls\"**\n\nTimer 15 is disabled upon execution and \"filesend.xls\" is sought. If present, Timer 15 is enabled and it\n\nreturns.\n\n\n-----\n\nIf Timer 1 isn't enabled, Timer 15 checks the status of Timer 18. If it is enabled, Timer 15 re-enables itself\n\nand returns.\n\nIf \"filesend.xls\" isn't present and both Timer 1 and Timer 18 are disabled, it creates a \"pangtkp.bat\" file,\n\nwhich contain \"ping C&C_IP >C:DOCUME~1%USER%TEMPLA~1iexplore.exe.pkklm\".\n\nThat bat is executed, and both Timer 1 and 5 are enabled before returning.\n\nThere are other timers that are in some way or other related to exfiltration and data stealing, but they are\n\nall fairly similar. There is a lot of redundancy in the malware.\n\n**Timer 23: List all removable drives on the machine**\n\nTimer 23 lists all the removable drives on the machine, enables Timer 24, Timer 23 disables itself and\n\nreturns.\n\n**Timer 24: Search and copy files from removable drives**\n\nTimer 24 receives the list of removable drives computed by Timer 23, and searches all the files on the\n\ndevices.\n\nStolen files will be copied to the malware directory with fildik.BMH extensions, which will later be\n\nencoded as fildik.BMH.KILOP (Base64) and exfiltrated.\n\nThe list of processed files are stored inside raftehacool.zip.\n\n### Miscellaneous\n\nThe infostealer contains 52 timers. Some of them do not perform any important tasks. The authors\n\ndecided to ping the C&C server and save the results under specific file names. Those files are checked and\n\nparsed in order to find out if the C&C is up and if certain actions can be taken. This is pretty amateurish\n\nprogramming.\n\n**Timer 44: simple ping via pangtipo.bat**\n\nTimer 44 is disabled upon execution. Timer 44 checks whether Timer 45 is enabled and returns if it is.\n\n(Timer 44 is enabled prior to returning.) If Timer 45 is disabled, a \"pangtipo.bat\" file is created, which\n\ncontains \"ping C&C_IP >C:DOCUME~1%USER%TEMPLA~1iexplore.exe.pkxml\".\n\nThe bat file is executed, Timer 44 is enabled and Timer 44 returns.\n\n\n-----\n\nTimer 11 is disabled upon execution.If Timer 16 is already enabled, Timer 11 re-enables itself and returns.\n\nIf Timer 17 is already enabled, Timer 11 re-enables itself and returns.\n\nIf none of the timers are enabled, it creates the \"pangtip.bat\" file, which contains \"ping C&C_IP\n\n>C:DOCUME~1%USER%TEMPLA~1iexplore.exe.pkxm\" and executes it via ShellExecute.\n\nTimer 16 is enabled and returns.\n\nNote: Timers 1, 7, 11, 15, 44 and 48 generate these batch files under different names and the results are\n\nsaved under different names too.\n\n**Timer 7: Was \"timeip.php\" visited?**\n\nTimer 7 is disabled upon execution. Timer 7 checks whether the timeip.php page was visited. If not, it\n\nvisits the page using IE instrumentation, Timer 7 disables itself and enables Timer 8 (see description\n\nbelow).\n\nIt creates the \"pangip.bat\" file, which contain \"ping C&C_IP\". Results are saved as \"iexplore.exe.pkam\".\n\nNote: the file name used to save the output of the ping commands is based on the infostealer executable\n\nname, which is \"iexplore.exe\". If the executable is renamed, the log files will have different names.\n\n**Timer 8: Parse the results of the timeip.php visit**\n\nThe timeip.php script returns the current time and the IP address of the victim. The results of the visit\n\n(done with IE instrumentation in Timer 7) are saved into a buffer which is used during the keylogger log\n\ncreation (see Timer 4 description).\n\n**Timer 22: Ensure there is a backup copy of UpdateOffice (downloader)**\n\nNote: The downloader is the only malware that starts after Windows boots. It's therefore important to\n\nensure various backup copies are made.\n\nTimer 22 checks if \"UpdateOffice.exe\" is present in the infostealer directory (templates). It shouldn't be, as\n\nit is only present in the printhood directory. (See Downloader description at the beginning of the article.)\n\nSince it is not present, it calls a subroutine to get the path to the \"Printhood\" directory\n\n(GetSpecialFolderLocation with CSIDL_PRINTHOOD parameter). While concatenating the\n\n\"UpdateOffice.exe\" and the \"Printhood\" folder, the \"\" character is missing, and therefore, the routine is\n\nbugged. The returned string is: \"C:Documents and Settings%USER%PrintHoodUpdateOffice.exe\" instead\n\n\n-----\n\nIt then copies (or at least tries to, as the path is wrong) \"C:Documents and\n\nSettings%USER%PrintHoodUpdateOffice.exe\" as \"srAntiq.dll\" in the Templates folder.\n\nIf \"OfficeUpdate.exe\" isn't present in the \"printhood\", a copy is made from \"srAntiq.dll\".\n\nIt retrieves the path to the Startup Folder using the CSIDL_STARTUP: \"C:Documents and\n\nSettings%USER%Start MenuProgramsStartup\".\n\nTimer 22 checks whether \"OfficeUpdate.exe\" is present in that folder; if not, it will make a copy of\n\nsrAntiq.dll to the Startup folder and returns from Timer 22.\n\n**Timer 25: Check for \"fsdiskget.dll\"**\n\nTimer 25 checks if \"fsdiskget.dll\" is present in the malware directory; if not, it returns.\n\nIf the file is present, it enables Timer 23 (see the Data Stealing section for a description).\n\n**Timer 42: lbdiskgo.dll, soltanik.dll and res.exe checking**\n\nTimer 42 checks whether a flag (set by Timer 34 and cleared by Timer 33) is set to 0 and if lbdiskgo.dll,\n\nsoltanik.exe and res.exe are present. If they are, it enables Timer 33; otherwise, it returns.\n\n**Timer 43: lbdiskgo.dll / ladine.dll / res.exe checking**\n\nTimer 43 returns directly if neither \"lbdiskgo.dll\" or \"ladine.dll\" are present. If res.exe is present, it\n\nenables Timer 44 and Timer 48; otherwise, it returns.\n\n**Timer 45: Visit the ReReReRe.htm page**\n\nTimer 45 deletes pangtipo.bat, reads iexplore.pkxml to make sure the C&C replied. (Timer 1 and Timer 16\n\nprovides some more details on the use of such .bat files.)\n\nUses FindWindow to check whether IE Instrumentation has been used to visit the special ReReReRe.html\n\npage, which contains the following title: \"r!r!r!r!\".\n\nIt looks for different variants such as \"r!r!r!r! - Windows Internet Explorer\" or \"r!r!r!r! - Microsoft\n\nInternet Explorer\".\n\nIf one of them is found, it means the page was visited using IE instrumentation. It disables Timer 45 and\n\nreturns.\n\n\n-----\n\nenable Timer 46 (see below), disable Timer 45 and return.\n\n**Timer 46: Parse \"ReReReRe.htm\" (downloaded by Timer 45)**\n\nTimer 46 goes through all the different running instances of instrumented IE, looking at the title of each\n\nHTM page. The main interest here is \"r!r!r!r!\".\n\nThis page is the ReReReRe.htm file downloaded by Timer 45. Timer 46 looks for a special EOF (End Of\n\nFile) marker: \"tamamshodfile\". This marker is used by the infostealer to make sure the htm page was fully\n\ndownloaded.\n\nOnce the page has been confirmed as valid, it looks for the textarea id S1 which holds double Base64\n\nencoded PE Files.\n\nThe Base64 encoded data is saved as: ASLASLKK223.dll.\n\n**Timer 47: Double decoding of Base64 encoded payload from ReReReRe.htm**\n\n\n-----\n\nSince the payload file is double encoded, the decoding is performed in two steps:\n\nASLASLKK223.dll is decoded to ASLASLKK224.dll to get a single encoded Base64 file.\n\nASLASLKK224.dll is decoded to \"res.exe\" : Final PE file.\n\nRes.exe is a copy of the Resource Hacker utility. ASLASLKK224.dll is deleted. The use of Res.exe is\n\ndescribed in the analysis of Timer 39 below.\n\nOnce Timer 47 has finished enumerating all the IE instances, it will call a cleaning routine. It searches for\n\n\" - r!r!r!r! - Windows Internet Explorer\" and different variants described in Timer 45 and sends a\n\n\"WM_Close\" Message to IE Windows in order to close them.\n\nAmong all those captions, it also searches for \" - 404 - File or directory not found.\" and variants of 404\n\npages.\n\nOnce the cleaning is completed, Timer 47 disables itself and returns.\n\n**Timer 49: Visit the SeSeSeSe.htm page**\n\nTimer 49 is almost identical to Timer 45. The only difference is the page visited: SeSeSeSe.htm instead of\n\nReReReRe.htm\n\nSee the Timer 45 description for details.\n\n**Timer 50: Parse \"SeSeSeSe.htm\" (downloaded by Timer 49)**\n\nTimer 50 is almost identical to Timer 46. The only difference is the page parsed: SeSeSeSe.htm instead of\n\nReReReRe.htm and local file names. The double encoded payload is saved as \"ASLASLKK2231.dll\".\n\nSee the Timer 46 description for details.\n\n**Timer 51: Double decoding of Base64 encoded payload from SeSeSeSe.htm**\n\nNote: Timer 50 saves the payload as ASLASLKK2231.dll.\n\nSince the payload file is double encoded, the decoding is performed in two steps:\n\nASLASLKK2231.dll is decoded to ASLASLKK2241.dll to get a single encoded Base64 file.\n\nASLASLKK2241.dll is decoded to \"Ladine.dll\": final PE file.\n\nNote: At the time of writing, the SeSeSeSe.htm page had been removed from the C&C server.\n\n\n-----\n\nSSSS.htm . The embedded file is a template of a downloader executable (see Timers 35, 36, 37, 38 and 39\n\nfor further information).\n\nOnce Timer 51 has finished enumerating all the IE instances, it will call a cleaning routine. It searches for \"\n\n- s!s!s!s! - Windows Internet Explorer\" and different variants described in Timer 45, and sends a\n\n\"WM_Close\" Message to IE Windows in order to close them.\n\nAmong all those captions, it also searches for \" - 404 - File or directory not found.\" and variants of 404\n\npages.\n\nOnce the cleaning is completed, Timer 51 disables itself and returns.\n\n### BETA/NON-WORKING FEATURES: New executable generation\n\nThere are a few timers in the infostealer that are related to a missing file. I managed to find a copy of the\n\nmissing file from an older command and control server, in order to understand the intentions of the\n\nauthors.\n\nThe missing file is downloaded by Timer 50: SeSeSeSe.htm. It's not present on the current C&C servers.\n\nIf we were to replace the SeSeSeSe.htm with an old copy (originally SSSS.htm), Timer 51 would produce a\n\nfile called \"Ladine.dll\", which is a template executable of the Trojan downloader used to install the\n\ninfostealer.\n\n**Timer 52: Copy Ladine.dll to \"Soltanik.exe\"**\n\nTimer 52 makes a copy of \"Ladine.dll\" under the name \"soltanik.exe\", which is the template file.\n\n**Timer 35: Clean files from Timer 39**\n\nTimer 35 is disabled. A special BOTID is created by concatenating \"CoolDiskGo(\" with \"BOTID_TMP)\",\n\ne.g.: CoolDiskGo(MYCOMPUTER-8712422C6C7704EF)\n\nTimer 35 puts the C&C IP address in a global variable that will be used by Timer 38.\n\nTimer 35 tries to delete the following several files created by Timer 39: 1.txt, res.ini, res.log,\n\nIcon_1.ico,output.rc and server.exe.\n\nIt does several other things which are not relevant to what I describe here, so I've omitted any reference to\n\nthose actions.\n\n\n-----\n\n**Timer 36: Enable Timer 37 if 1.txt isn't found - logic/code bug**\n\nTimer 36 is disabled upon execution. If \"1.txt\" isn't present, Timer 37 is enabled. Otherwise, it calls a\n\nBase64 decoding function. 1.txt must be a valid Base64 encoded stream of bytes; otherwise, an exception\n\noccurs and Timer 36 returns.\n\n**Timer 37: Update resource for the template downloader: Soltanik.exe**\n\nTimer 37 is disabled upon execution. A structure exception handler is installed before reading 1.txt.\n\nIn the event of an exception the SEH handler will enable Timers 42, 34, 33, 35, and Timer 37 will return.\n\nTimer 37 expects 1.txt to be present and here is the logic bug. Timer 37 is only enabled when 1.txt isn't\n\npresent, by Timer 36. Let's ignore the reasons for its creation and continue analyzing the intentions of the\n\nauthors.\n\nTimer 37 calls the BeginUpdateResource (with the bDeleteExistingResources parameter set to 0), and\n\nstart updating the resources of the template executable (soltanik.exe) in RCDATA.\n\nA MAHDI entry is added, with the Base64 content from 1.txt. This works in exactly the same way as the\n\ndownloaders with social engineering features.\n\nTimer 38 is enabled, and Timer 37 returns.\n\nNote: At the end of Timer 37, Soltanik has been modified to have a new resource: MAHDI.\n\n**Timer 38: Update more resources from the template downloader (Soltanik.exe)**\n\nSeveral entries are added to RCDATA:\n\nShelikn : Special BotID generated by Timer 35\n\nSiteW: C&C IP address\n\nBind: Empty (according to analysis of the downloaders that use social engineering, it should be the\n\nextension of the embedded file dropped to social engineering victims. If MAHDI contains a Base64\n\nencoded picture, Bind should be set to .JPG).\n\nFilee: SCR\n\nRoze: 0\n\nOnce the resources have been updated, Timer 39 is enabled and Timer 38 returns.\n\n\n-----\n\nAt the end of Timer 38, soltanik.exe has been fully updated with new resources. Upon execution, Timer 39\n\ndisables itself and starts generating a special command line for the Resource Hacker tool that was created\n\nas \"Res.exe\" by Timer 47.\n\nThe command line is the following:\n\nThere is a bug in the routine. An executable name is missing right after \"-extract\".\n\nThe command line dumps the Main Icon to disk (Icon_1.ico) and creates a file called \"output.rc\".\n\nAt this point, it is impossible to know which file was meant to be used as the source of a new icon. For the\n\nsake of our analysis, let's pretend the bug doesn't exist and that a valid file name was provided.\n\nAfterwards, a second command line is passed to \"Res.exe\":\n\nThis final command line will generate Server.exe, a copy of soltanik.exe whose icon has been changed to\n\nthe one extracted in the previous command.\n\nServer.exe is now fully updated. Its resources are filled, and its icon changed. It's not clear why the authors\n\ndid this, but despite all the bugs it was possible to understand the overall aim of the routine: to create a\n\nServer.exe file from soltanik.exe with a new icon and added resources. What happens to Server.exe?\n\nNothing, this is a non-working feature. It appears Madi has the ability to generate new downloaders, at\n\nleast, in theory.\n\nThe 7 remaining timers won't be described as they are of little interest.\n\n## Conclusions\n\nIn this article we closely analyzed the infostealer used in the Madi campaign. The coding style and the\n\nusage of Delphi, together with the programming techniques indicate a rudimentary approach.\n\nMost of the data-stealing actions and communication with the C&C servers take place via external files,\n\nwhich is rather messy. Whoever coded it is probably still reading through the first chapters of their Delphi\n\nmanuals.\n\nThis is maybe why it is surprising to note its effectiveness, considering the data received from the\n\nsinkhole During the monitored period a little over 800 victims were connected to the servers All of them\n\n\n-----\n\nTo sum up, we can say the following:\n\nthe components of the Madi campaign are surprisingly unsophisticated\n\nno exploits or advanced 0-day techniques are used anywhere in the malware\n\ndespite that, the overall success of the campaign is surprisingly high\n\nnevertheless, we should remember that even low quality malware can steal data\n\nMadi was a low investment, high profit project\n\nits authors remain unknown\n\nWe will continue to monitor the Madi malware and update you on our findings in the future.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/h2rowevapfawgbkdpcinjgbci6iy71ml",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2012/2012.07.27.Madi_Campaign/The_Madi_Infostealers.pdf"
    ],
    "report_names": [
        "The_Madi_Infostealers"
    ],
    "threat_actors": [
        {
            "id": "b07fec96-80cd-4d92-aa52-a26a0b25b7c2",
            "created_at": "2022-10-25T16:07:23.826594Z",
            "updated_at": "2025-03-27T02:02:09.994638Z",
            "deleted_at": null,
            "main_name": "Madi",
            "aliases": [
                "Mahdi"
            ],
            "source_name": "ETDA:Madi",
            "tools": [
                "Madi"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "322a0ef1-136b-400e-89d0-0d62ee2bd319",
            "created_at": "2023-01-06T13:46:38.662109Z",
            "updated_at": "2025-03-27T02:00:02.885938Z",
            "deleted_at": null,
            "main_name": "Madi",
            "aliases": [],
            "source_name": "MISPGALAXY:Madi",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716502,
    "ts_updated_at": 1743041394,
    "ts_creation_date": 1405445126,
    "ts_modification_date": 1405445126,
    "files": {
        "pdf": "https://archive.orkl.eu/51b16ee4bb04d663a4c67e23e3d3bf816ae12207.pdf",
        "text": "https://archive.orkl.eu/51b16ee4bb04d663a4c67e23e3d3bf816ae12207.txt",
        "img": "https://archive.orkl.eu/51b16ee4bb04d663a4c67e23e3d3bf816ae12207.jpg"
    }
}