{
    "id": "a901bfa8-8b85-4c80-853d-9283b9107bae",
    "created_at": "2023-01-12T15:00:44.458368Z",
    "updated_at": "2025-03-27T02:17:27.533522Z",
    "deleted_at": null,
    "sha1_hash": "5c2e7ed0ca564c4183d54edfb5b885c055b2359c",
    "title": "2020-01-30 - New Iranian Campaign Tailored to US Companies Utilizes an Updated Toolset",
    "authors": "",
    "file_creation_date": "2022-05-28T15:16:50Z",
    "file_modification_date": "2022-05-28T15:16:50Z",
    "file_size": 1442519,
    "plain_text": "# New Iranian Campaign Tailored to US Companies Utilizes an Updated Toolset\n\n**[intezer.com/blog-new-iranian-campaign-tailored-to-us-companies-uses-updated-toolset/](https://intezer.com/blog-new-iranian-campaign-tailored-to-us-companies-uses-updated-toolset/)**\n\nJanuary 30, 2020\n\nWritten by [Paul Litvak and](https://www.intezer.com/author/paullitvak/) [Michael Kajiloti - 30 January 2020](https://www.intezer.com/author/mkajiloti/)\n\n### Get Free Account\n\nJoin Now\n\n## Introduction\n\nOur researchers Paul Litvak and Michael Kajilolti have discovered a new campaign\nconducted by APT34 employing an updated toolset. Based on uncovered phishing\ndocuments, we believe this Iranian actor is targeting Westat employees, or United States\norganizations hiring Westat services.\n\n[Westat is a United States-based company that “provides research services to agencies of](https://en.wikipedia.org/wiki/Westat)\nthe U.S. Government, as well as businesses, foundations, and state and local\ngovernments”. One example of the services Westat offers is a [survey for federal workers,](https://www.westat.com/project/surveying-federal-workers-ensure-engaged-workforce)\nwhich leads us to believe this attack may target Westat customers.\n\n\n-----\n\n**Official Westat response: Westat understands that in their effort to identify threats and**\nmalware, Intezer has identified a malicious file that uses the Westat name and logo. This file\nwas not created by, hosted by, or sent from Westat, and is likely the result of a bad actor\nstealing the Westat brand name and logo. Our cybersecurity team is working with Intezer\nand others to fully understand the nature of this report. We will continue to monitor the\nsituation and respond accordingly.”\n\n## APT34 Background\n\n[APT34 (also known as OilRig or Helix Kitten) is a cluster of Iranian government-backed](https://attack.mitre.org/groups/G0049/)\ncyber espionage activities that has been active since 2014. The group is known to target\nvarious international organizations, mainly in the Middle East. Among their targeted\nindustries are government agencies, financial services, energy and utilities,\ntelecommunications, and oil and gas.\n\n[More light was shed on this group in April 2019 as leaks emerged from a mysterious](https://www.zdnet.com/article/source-code-of-iranian-cyber-espionage-tools-leaked-on-telegram/)\nindividual with the pseudonym “Lab Dookhtegan”. This individual exposed data belonging to\nvictims of this group, together with source code of hacking tools and data about previous\nAPT34 operations; including IP addresses and domains where the group hosted web shells\nrelated to past operations.\n\nMost recently, [FireEye exposed a spear-phishing operation conducted by APT34, which](https://www.fireeye.com/blog/threat-research/2019/07/hard-pass-declining-apt34-invite-to-join-their-professional-network.html)\nenabled us to connect this operation to this Iranian actor due to similarities in the\ntechniques and tools employed in both campaigns.\n\n## Initial Vector\n\nIn late January 2020, we discovered a file named survey.xls that was designed to look like\nan employee satisfaction survey tailored to either Westat employees or Westat customers.\n\nAt first the spreadsheet appeared to be blank. Only once the victim enables macros, the\nsurvey is displayed to the user and the malicious VBA code begins to execute.\n\n\n-----\n\n_survey.xls_\n\nThe embedded VBA code unpacks a zip file into a temporary folder, extracts a “Client\nupdate.exe” executable file and installs it to “C:Users<User>valsClient update.exe”.\n\n“Client update.exe” is actually a highly modified version of the TONEDEAF malware, which\nwe named TONEDEAF 2.0. Finally, the crtt function creates a scheduled task\n“CheckUpdate” that runs the unpacked executable five minutes after being infected by it, as\nwell as on future log-ons.\n\n_Survey.xls VBA Code_\n\nBoth the extracted VBA code and the functionality of the code look similar to the one\nanalyzed in the FireEye report:\n\n\n-----\n\n_APT34 VBA Code from the FireEye Report_\n\nIn addition, we found a similar document labelled as “Employee satisfaction survey.xls”\ncontaining the same survey as the previous document.\n\n\n-----\n\n_Employee Satisfaction survey.xls_\n\nHowever, it’s important to highlight that the code page field of this document is Arabic as\ncan be seen when examining its file metadata, denoting the preferred language installed on\nthe document author’s version of Microsoft Excel:\n\n_Employee Satisfaction survey.xls Metadata_\n\n## TONEDEAF 2.0\n\n\n-----\n\nAt first glance, Client update.exe seems like a completely new backdoor malware.\nHowever, further examination reveals it’s most likely a highly modified version of the\npreviously seen TONEDEAF backdoor. TONEDEAF is a backdoor that communicates with\nits Command and Control server via HTTP in order to receive and execute commands. It\nwas mentioned in FireEye’s recent report about an ongoing APT34 operation, as one of the\ngroup’s custom tools. We have named the new variant TONEDEAF 2.0.\n\nTONEDEAF 2.0 is an advanced version of TONEDEAF, serving the same purpose as the\noriginal, but with a revamped C2 communication protocol and a substantially modified code\nbase. In contrast to the original TONEDEAF, TONEDEAF 2.0 contains solely arbitrary shell\nexecution capabilities, and doesn’t support any predefined commands. It’s also more\nstealthy and contains new tricks such as dynamic importing, string decoding, and a victim\ndeception method.\n\n### New Tricks\n\nUpon execution the backdoor checks whether it was executed with “…” as anargument,\nwhich is the way it’s configured to execute by the scheduled task, as part of the proper\ninfection chain.\n\nIn the case it’s executed without the correct argument, such as by launching it via a double\nclick, it will display a blank GUI Window to the user. This is most likely intended to serve as\na deception method, to make the malware appear like a legitimate (alibiet broken)\napplication titled “Bee”.\n\n_GUI Window Used for Deception_\n\nTONEDEAF 2.0 also attempts to be more stealthy than its predecessor by hiding many of\nthe interesting API imports it uses. The names of these APIs, and the DLLs that contain\nthem, are stored as encoded strings and are decoded and resolved on demand during\nruntime.\n\n\n-----\n\n_Decoding and Resolving API Functions_\n\n### C2 Communication\n\nThe backdoor uses HTTP for C2 communication, with a custom encoding and handshake\nmechanisms. Messages sent by the backdoor always contain the HTTP query parameter “?\n**ser=<6 digits>” as an identifier. The first three digits are the <server_id> and the last three**\nare the <client_id>. The backdoor will use one of the following two messages:\n\n**1. GET /dow?ser=<server_id><client_id> – request message, used to obtain commands**\nto execute from the server.\n\n**2. POST /upl?ser==<server_id><client_id> – reply to command message, used to send**\nthe executed command’s output to the server.\n\nBefore performing the first request, the malware will generate the <client_id> derived from\nthe environment variables %HOMEPATH% and %COMPUTERNAME% using a custom\nformula.\n\nIt will then send an initial GET message to the C2 using that ID.\n\n_C2 Request_\n\n\n-----\n\nOne odd element about the communication is the usage of a Windows Phone User-Agent\nvalue in the HTTP message.\n\nDuring our analysis the C2 was alive but continuously replied with a 403 Forbidden HTTP\nerror code to our requests. It’s possible that the C2 is filtering the targets since this\nbackdoor is part of a targeted operation and our client_id parameter does not match that of\none of the intended victims.\n\nShould the C2 accept the ID, it will reply with an encoded message that contains the\n**<server_id> and the command the backdoor needs to execute. The malware extracts the**\ncommand by looking for an HTTP div element in the response with a special class name.\n\n_Parsing of C2 Response_\n\nThe malware will then execute the command by prepending it with “cmd U c” and will send\nthe output of the command back to the C2 using the POST reply message (2).\n\n\n-----\n\nWhen entering the C2 via a browser, the site tries to imitate https://docs.microsoft.com/enus/, although it fails to display it properly due to a misconfiguration with the CSS, as can be\nseen in the console:\n\n_manygoodnews[.]com C2 webpage_\n\nWe have also observed that an SSL certificate has been recently generated that matches\nthe domain of the C2.\n\n\n-----\n\n_[SSL Certificate for the C2 Domain that was Issued One Month Ago](https://community.riskiq.com/search/certificate/sha1/86bfaced2e6568f9820b18a5600bfffada64c254)_\n\nThese findings might indicate that the attackers are in the process of transitioning into\nHTTPS for C2 communication, in an attempt to improve their OPSEC capabilities and avoid\ndetection.\n\n### Traces from the Original TONEDEAF\n\nWith all of the changes and new additions, there are still enough similarities that link\nTONEDEAF 2.0 to the original. While the code is mostly modified, the general flow and\nfunctionality are similar. The C2 communication is different but still has similarities to its\npredecessor, such as the usage of three digit identifiers for both the victim and the server.\nHowever, most notably there are several places in the code where the similarity is most\nclear. One such place is a function that exists in both variants, which oddly enough creates\na notification icon in the Windows status bar. The only notable changes are the usage of\ndynamic API resolution and the shortening of the notification message from “Updating” to\n**“up”.**\n\n\n-----\n\n_Specific Function Comparison_\n\nAnother instance is the code that sets the working directory of the program. It appears in\ndifferent stages for each variant, but is identical:\n\n_Similar Code Snippets_\n\n## VALUEVAULT 2.0\n\nWe were unable to download further modules, however, we believe this operation also\nincludes the usage of a VALUEVAULT implant. VALUEVAULT is a browser credential theft\ntool built in Golang, discovered by FireEye in the aforementioned APT34 operation analysis.\n\nWe found the survey.xls file uploaded to VirusTotal with a VALUEVAULT instance and a\nTONEDEAF 2.0 instance, uploaded from Lebanon by the same user, only a few minutes\napart. This may indicate that these malware were delivered together as part of the same\nattack.\n\n\n-----\n\nThis VALUEVAULT takes a more minimalistic approach than its predecessor. Many\nfunctionalities and strings were stripped from the new binary in order to lower its noise. Only\nChrome password dumping is now supported, although interestingly the use of the file\n“fsociety.dat” as a password data store under the “AppData\\Roaming” directory stayed the\nsame.\n\n_VALUEVAULT 2.0 Compilation Paths_\n\n_VALUEVAULT 1.0 Compilation Paths_\n\nFurthermore, VALUEVAULT 2.0 is a 64-bit binary as opposed to VALUEVAULT 1.0 which is\na 32-bit binary. These relatively minor changes were enough to create a fully undetected\nimplant.\n\n## Conclusion\n\nThe last APT34 operation was exposed only a few months ago by FireEye, and judging by\nour current findings we can confidently state that the group has since evolved its\noperations. The technical analysis of the new malware variants reveals this Iranian\ngovernment-backed group has invested substantial efforts into upgrading its toolset in an\nattempt to evade future detection.\n\nThe binary code from these new malware samples are now indexed in our Genetic Malware\n[Analysis platform, Intezer Analyze. We encourage you to use our free community edition to](https://analyze.intezer.com/#/analyze)\ndetect and classify threats that share code with APT34 malware.\n\n**IOCs**\nmanygoodnews[.]com\n\nc10cd1c78c180ba657e3921ee9421b9abd5b965c4cdfaa94a58e383b45bb72ca\n\n\n-----\n\n4c323bc11982b95266732c01645c39618550e68f25c34f6d3d79288eae7d4378\na897164e3547f0ce3aaa476b0364a200769e8c07ce825bcfdc43939dd1314bb1\n20b3d046ed617b7336156a64a0550d416afdd80a2c32ce332be6bbfd4829832c\nd61eecd7492dfa461344076a93fc2668dc28943724190faf3d9390f8403b6411\n\n**Paul Litvak**\nPaul is a malware analyst and reverse engineer at Intezer. He previously served as a\ndeveloper in the Israel Defense Force (IDF) Intelligence Corps for three years.\n\n**Michael Kajiloti**\nMichael is a security researcher turned product manager, who previously led the Intezer\nAnalyze product lifecycle. He has presented his malware research at conferences such as\nREcon and the Chaos Communications Congress (CCC).\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-30 - New Iranian Campaign Tailored to US Companies Utilizes an Updated Toolset.pdf"
    ],
    "report_names": [
        "2020-01-30 - New Iranian Campaign Tailored to US Companies Utilizes an Updated Toolset.pdf"
    ],
    "threat_actors": [
        {
            "id": "ce10c1bd-4467-45f9-af83-28fc88e35ca4",
            "created_at": "2022-10-25T15:50:23.458833Z",
            "updated_at": "2025-03-27T02:00:55.475188Z",
            "deleted_at": null,
            "main_name": "APT34",
            "aliases": null,
            "source_name": "MITRE:APT34",
            "tools": [
                "netstat",
                "Systeminfo",
                "PsExec",
                "SEASHARPEE",
                "Tasklist",
                "Mimikatz",
                "POWRUNER",
                "certutil"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3eebdb3f-f4e3-42e5-bb4d-f02a13328316",
            "created_at": "2024-05-01T02:03:08.014303Z",
            "updated_at": "2025-03-27T02:05:17.306592Z",
            "deleted_at": null,
            "main_name": "COBALT EDGEWATER",
            "aliases": [
                "Cold River ",
                "DNSpionage ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT EDGEWATER",
            "tools": [
                " DNSpionage",
                " Karkoff",
                " MailDropper",
                " SideTwist",
                " TWOTONE",
                "AgentDrable"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535644,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1653751010,
    "ts_modification_date": 1653751010,
    "files": {
        "pdf": "https://archive.orkl.eu/5c2e7ed0ca564c4183d54edfb5b885c055b2359c.pdf",
        "text": "https://archive.orkl.eu/5c2e7ed0ca564c4183d54edfb5b885c055b2359c.txt",
        "img": "https://archive.orkl.eu/5c2e7ed0ca564c4183d54edfb5b885c055b2359c.jpg"
    }
}