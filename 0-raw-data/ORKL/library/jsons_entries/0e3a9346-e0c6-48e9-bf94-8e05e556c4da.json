{
    "id": "0e3a9346-e0c6-48e9-bf94-8e05e556c4da",
    "created_at": "2023-01-12T15:04:20.137128Z",
    "updated_at": "2025-03-27T02:05:32.802329Z",
    "deleted_at": null,
    "sha1_hash": "9b811a20cc30d07458b1c2e614e4388d25ed5afa",
    "title": "2022-05-12 - Technical Analysis of Emerging, Sophisticated Pandora Ransomware Group",
    "authors": "",
    "file_creation_date": "2022-05-29T01:03:02Z",
    "file_modification_date": "2022-05-29T01:03:02Z",
    "file_size": 1784675,
    "plain_text": "# Technical Analysis of Emerging, Sophisticated Pandora Ransomware Group\n\n**[cloudsek.com/technical-analysis-of-emerging-sophisticated-pandora-ransomware-group/](https://cloudsek.com/technical-analysis-of-emerging-sophisticated-pandora-ransomware-group/)**\n\nAnandeshwar Unnikrishnan May 12, 2022\n\n2021 saw an outbreak of ransomware groups and attacks that affected every major industry\nacross the globe. This trend is expected to continue and even surpass the previous year’s\nnumbers by a significant margin in 2022.\n\nIn March 2022, researchers detected a new ransomware strain known as Pandora which\nleverages double extortion tactics to exfiltrate and encrypt large quantities of personal data.\nThe operators offer the decryption key once the victim pays the ransom demanded. Pandora\nransomware is a relatively new operation and hence its infection techniques are unknown.\n\nHowever, after infiltrating the target system, the ransomware appends the “.pandora” file\nextension to the encrypted files and leaves a ransom note “Restore_My_Files.txt” with\ninstructions on how to recover the data. Researchers believe that the Pandora ransomware\nis a rebranded version of Rook ransomware, which in turn is a spawn of the leaked Babuk\ncode. This article explores the technical analysis of the Pandora ransomware, its evasion\ntactics, the process of encryption, and more in detail.\n\n## Technical Analysis of Pandora\n\nThe analysis of Pandora’s binary file sample,\n```\n5b56c5d86347e164c6e571c86dbf5b1535eae6b979fede6ed66b01e79ea33b7b, indicates\n\n```\nthat it is a UPX (Ultimate Packer for eXecutables) packed binary file. UPX is an executable\nfile compressor used by threat actors to add a layer of obfuscation (creation of code that is\ndifficult for humans to understand) to their malware. The ransomware code runs from the\noriginal entry point after getting unpacked in the memory.\n\nRansomware code running from the entry point\nThe ransomware uses obfuscated strings and deobfuscates library names and internal\nfunctions at runtime. The library modules used by Pandora are dynamically loaded on a peruse basis via the following APIs:\n\n**LoadlibraryA**\n**GetProcAddress**\n**GetModuleHandleA**\n\n\n-----\n\nInitially, the ransomware creates a mutex (mutual exclusion object, which enables multiple\nprogram threads to take turns sharing the same resource) to make sure only one instance of\nthe malware is running on the system. The mutex string, “ThisIsMutexa”, gets deobfuscated\nin the memory. It checks for any existing mutex on the system via OpenMutexA, if not\npresent the malware creates a new one with the value “ThisIsMutexa” via CreateMutexA.\n\n## Anti-debug Mechanism\n\nThe malware implements anti-debug checks to hinder analysis.\n\nAnti Debug\n\nCheck\n\nThe code highlighted in the image above reads data at the offset 0x60 from segment\nregister GS. Windows stores the Thread Information Block (TIB) in FS [x86] and GS\n\n[x64] segment registers.\nThe TIB holds the Process Environment Block (PEB) at the offset 0x60. The\nmalware accesses PEB of the process via the GS register.\nLater the malware reads the data at the offset 0x2 in PEB (ds:[rsi+2]), which is the\n**BeingDebugged member in the PEB structure, and then compares the obtained value**\nwith 0. If the process is being debugged then BeingDebugged will have a non zero\nvalue. If the test fails, the malware goes into an infinite loop and does not proceed\nfurther.\n\n## Evasion Techniques\n\n Instrumentation Callback Bypass\n\n\n-----\n\nThe security endpoints (especially ETWTi) of a device use the instrumentation callback\nprocess to check for behavioral anomalies and detect novel malware on the system.\nPandora ransomware bypasses such a callback mechanism via\n```\nntsetinformationprocess, which changes the process information.\n\n```\nntsetinformationprocess is invoked with `ProcessInstrumentationCallback as a`\npart of ProcessInformationClass.\n\nntsetinfromationprocess being invoked\n\nThe third argument in the above image is a 10-byte long structure associated with the\nprovided ProcessInstrumentationCallback information class.\n\nThe third\n\nargument (10-byte long structure)\n\nThe members and associated values in the structure are as follows:\n\nVersion=0 (0 for x64, 1 for x86)\nReserved=0\nCallback=0\n\nIf the process created for the malware is hooked by security services via callback member,\ninvoking the ntsetinformationprocess in a way mentioned above with callback set to 0, it\nhelps the malware bypass such hooks.\n\n## Event Tracing Bypass\n\nEvent Tracing for Windows (ETW) is a powerful tracing facility built into the operating system,\nto monitor various activities of both userland and kernel land applications running on the\nsystem. This feature has become a vital instrument to endpoint security solutions to detect\nanomalous behavior in running programs. As a result, malware developers have started\nintegrating functionalities in their malware to neutralize the tracing capability. One such\nvector is patching ETW related functions defined in ntdll.dll in the memory.\n\nThe ransomware dynamically loads ntdll.dll into the memory and deobfuscates the\nstring “ EtwEventWrite ”.\n\n\n-----\n\nDeobfuscation of “EtwEventWrite”\n\nThe address of the EtwEventWrite function is obtained using GetProcAddress API.\nGetting the function address is a very important step in patching, to bypass the ETW\nfeature.\nBefore the malware commences patching, the memory protections on the region of\ncommitted pages, where EtwEventWrite resides in virtual address space, need to be\nchanged, which is done via VirtualProtectEx API.\nThe memory region of pages where the first instruction of EtwEventWrite resides is\nchanged to PAGE_EXECUTE_READWRITE to be patched.\n\nArguments passed to\n\nVirtualProtectEx\n\nThe WriteProcessMemory API is used to write one byte at the beginning of the\nEtwEventWrite function. The second argument points to the beginning of\nEtwEventWrite, and the third argument is the one byte long payload that gets written at\nthe address of EtwEventWrite.\n\nThe data passed to\n\nWriteProcessMemory\n\nThe one byte payload is 0xC3, which is the opcode for the instruction “ret”. This makes\nEtwEventWrite to simply return back to the caller function, without executing its logic to\nlog an event when EtwEventWrite is invoked by other applications.\n\nOne byte payload – 0xC3\n\nAfter patching, the memory protection of EtwEventWrite is reverted back to the initial\npermission of PAGE_EXECUTE_READ via VirtualProtectEx.\n\n\n-----\n\nMemory protection of\n\nEtwEventwrite\n\n## Pre-encryption Phase\n\nBefore the encryption begins, the malicious software changes the shutdown parameters for\nthe system via SetProcessShutdownParameters API. This function sets a shutdown order\nfor the calling process relative to the other processes in the system. Here, the malware\ninvokes the API with zero value so that the ransomware program is the last to shut down by\nthe Operating System.\n\nData passed to SetProcessShutdownParameters\n\nAfter setting these shutdown parameters, the malware empties the recycle bin via\n**SHEmptyRecyclebinA API.**\n\nThe ransomware raises the priority of the running process to the highest possible priority\nwhich is REALTIME_PRIORITY_CLASS via SetPriorityClass API. The second argument is\nthe “dwPriorityClass” parameter which has a value of 0x100.\n\nData passed to SetPriorityClass\n\nFinally, the volume shadow copies are deleted by executing a string of commands via\n**ShellExecuteA. It uses vssadmin to perform the task of deleting the shadow files.**\n\nDeleting shadow\n\nfiles using vssadmin\n\n## Encryption Phase: Threading Model\n\nThe main thread of malware creates two new threads that are responsible for the encryption\nof user data.\n\n\n-----\n\nCreation\n\nof two new threads\nThe following APIs are used to create the threads:\n\n**CreateThread**\n**SetThreadAffinityMask**\n**ResumeThread**\n\nThe threads are created with dwCreationFlags set to CREATE_SUSPENDED, later the\nexecution of threads is resumed via ResumeThread.\n\nThe main thread starts to enumerate the drives present on the system via the following APIs:\n\n**GetDriveTypeW**\n**FindFirstVolumeW**\n**GetVolumePathNamesForVolumeNameW**\n**SetVolumeMountPointW**\n**FindNextVolumeW**\n**GetLogicalDrives**\n\nPandora utilizes Windows I/O Completion Ports to efficiently speed up the encryption\nprocess. Following APIs are used to orchestrate the search and locking of the user data:\n\n**CreateIoCompletionPort**\n**PostQueuedCompletionStatus**\n**GetQueuedCompletionPort**\n\nInitially, the main thread of the malware creates an input/ output (I/O) completion port via\nCreateIoCompletionPort API.\n\nData passed to\n\nCreateIoCompletionPort\n\nThe fourth argument is “NumberOfConcurrentThreads”. In our case, two threads are\nallowed to concurrently process I/O completion packets for the I/O completion port.\n\n\n-----\n\nAfter the creation of the I/O port, a queue is created internally, to which threads can\npush the completion status.\nThe two threads created previously will be accessing I/O ports to perform file\nenumeration and encryption on the infected system.\n\nIn general, ransomware in the wild has adopted a model to optimize the encryption process.\nThe goal here is to efficiently utilize the power of multicore processors to concurrently\nperform file enumeration and encryption. A group of worker threads would fetch the file paths\nand post them in the queue via PostQueuedCompletionStatus, and another thread can\nretrieve the posted files (paths) for encryption via GetQueuedCompletionStatus.\n\nOptimization of the encryption process\nPandora uses the RSA 4096 algorithm for encryption, the public key is embedded within the\nmalware.\n\n\n-----\n\nPublic key\n\nembedded in the malware\nAs a prior step to the encryption process, the malware accesses directories in the network\ndrives and dumps the ransom note (Restore_My_Files.txt). The ransom note is created\nusing the following three APIs:\n\n**CreateFileW**\n**WriteFileW**\n**CloseHandle**\n\nContents\n\nof the ransom note\n\n## Encryption Process\n\nThe process explained in this section is executed by worker threads highlighted in the image\nbelow. These threads can concurrently enumerate and encrypt data via the Windows I/O\ncompletion port.\n\n\n-----\n\nWorker\n\nThreads\n\nAfter dumping the ransom note, the malware uses `FindFirstFileW to open a handle`\nto the files on the disk.\nThe retrieved handle is checked against a set of directory names and file extensions.\nThe following directories are excluded from getting locked:\n\n**AppData** **Opera Software**\n\n**Boot** **Mozilla**\n\n**Windows.old** **Mozilla Firefox**\n\n**Tor Browser** **ProgramData**\n\n**Internet Explorer** **Program Files**\n\n**Google** **Program Files (x86)**\n\n**Opera** **#recycle**\n\nThe following files are excluded from getting encrypted:\n\n**Autorun.inf** **bootmgfw.efi**\n\n**boot.ini** **desktop.ini**\n\n**bootfont.bin** **iconcache.db**\n\n**bootsect.bak** **ntldr**\n\n**bootmgr** **Ntuser.dat**\n\n**bootmgr.efi** **Restore_My_Files.txt**\n\nAnd the following extensions are excluded from getting locked:\n\n**.hta** **.cur**\n\n**.exe** **.drv**\n\n\n-----\n\n**.dll** **.hlp**\n\n**.cpl** **.icl**\n\n**.ini** **.icns**\n\n**.cab** **.ico**\n\n**.idx** **.sys**\n\n**.spl** **.ocx**\n\n**.pandora**\n\nAfter performing exclusion checks, the absolute path of the file that passed the check is\ncomputed and then the thread calls for PostQueuedCompletionStatus to submit the\npath to the I/O queue previously created via CreateIoCompletionPort.\nRight after the PostQueuedCompletionStatus call, the same worker thread can resume\nfetching the absolute path of the next file via FindNextFileW API.\nAnother worker thread can now call GetQueuedCompletionStatus to retrieve the\nabsolute path of the target file to start encrypting the files.\nNext, the file attribute is changed via SetFileAttributesW API to\n**FILE_ATTRIBUTE_NORMAL and then the file is fetched for encryption via the**\nfollowing APIs:\n\n**CreateFileW**\n**GetFileSizeEx**\n**ReadFile**\n**SetFilePointerEx**\nAfter setting up the file pointer to the target data, the encryption begins by loading the\npublic key in the memory, and the encrypted data is written to the file via WriteFile API.\nLater the file is renamed via MoveFileExW API to add “.pandora” extension to the\nencrypted file.\n\nRenamed file with the “.pandora” extension\n\n## Registry Keys\n\n\n-----\n\nHKCU registry key\nPandora ransomware writes two values, Private and Public, under the HKCU/ Software\nregistry key. The public value has the public key used by the ransomware to encrypt the user\nfiles, while the private value has the protected private key stored for decryption. The\ndecryptor tool that the victim receives after paying the ransom uses this information stored in\nthe registry to decrypt the locked files.\n\n## Indicators of Compromise\n\n**Binary**\n\n**5b56c5d86347e164c6e571c86dbf5b1535eae6b979fede6ed66b01e79ea33b7b**\n\n**Registry**\n\n**HKCU\\Software\\Private**\n\n**HKCU\\Software\\Public**\n\n**Dropped Files**\n\n**Restore_My_Files.txt**\n\nAuthor Details\n\n[Anandeshwar Unnikrishnan](https://cloudsek.com/author/anadeshwar-unnikrishnan/)\nThreat Intelligence Researcher, [CloudSEK](https://cloudsek.com/)\n\n\n-----\n\nAnandeshwar is a Threat Intelligence Researcher at CloudSEK. He is a strong advocate of\noffensive cybersecurity. He is fuelled by his passion for cyber threats in a global context. He\ndedicates much of his time on Try Hack Me/ Hack The Box/ Offensive Security Playground.\nHe believes that “a strong mind starts with a strong body.” When he is not gymming, he finds\ntime to nurture his passion for teaching. He also likes to travel and experience new cultures.\n\n[Aastha Mittal](https://cloudsek.com/author/aastha-mittal/)\nTotal Posts: 0\nSorry! The Author has not filled his profile.\n×\n\n[Anandeshwar Unnikrishnan](https://cloudsek.com/author/anadeshwar-unnikrishnan/)\nThreat Intelligence Researcher, [CloudSEK](https://cloudsek.com/)\nAnandeshwar is a Threat Intelligence Researcher at CloudSEK. He is a strong advocate of\noffensive cybersecurity. He is fuelled by his passion for cyber threats in a global context. He\ndedicates much of his time on Try Hack Me/ Hack The Box/ Offensive Security Playground.\nHe believes that “a strong mind starts with a strong body.” When he is not gymming, he finds\ntime to nurture his passion for teaching. He also likes to travel and experience new cultures.\n\nLatest Posts\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-12 - Technical Analysis of Emerging, Sophisticated Pandora Ransomware Group.pdf"
    ],
    "report_names": [
        "2022-05-12 - Technical Analysis of Emerging, Sophisticated Pandora Ransomware Group.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535860,
    "ts_updated_at": 1743041132,
    "ts_creation_date": 1653786182,
    "ts_modification_date": 1653786182,
    "files": {
        "pdf": "https://archive.orkl.eu/9b811a20cc30d07458b1c2e614e4388d25ed5afa.pdf",
        "text": "https://archive.orkl.eu/9b811a20cc30d07458b1c2e614e4388d25ed5afa.txt",
        "img": "https://archive.orkl.eu/9b811a20cc30d07458b1c2e614e4388d25ed5afa.jpg"
    }
}