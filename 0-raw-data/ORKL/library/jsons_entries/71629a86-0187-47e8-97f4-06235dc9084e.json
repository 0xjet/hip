{
    "id": "71629a86-0187-47e8-97f4-06235dc9084e",
    "created_at": "2023-01-12T15:00:14.532114Z",
    "updated_at": "2025-03-27T02:15:45.259177Z",
    "deleted_at": null,
    "sha1_hash": "26bdb6296878e8406cc599e90b76f3ddfb991dc6",
    "title": "2020-03-25 - How the Iranian Cyber Security Agency Detects Emissary Panda Malware",
    "authors": "",
    "file_creation_date": "2022-05-27T23:08:32Z",
    "file_modification_date": "2022-05-27T23:08:32Z",
    "file_size": 254488,
    "plain_text": "# How the Iranian Cyber Security Agency Detects Emissary Panda Malware\n\n**[team-cymru.com/2020/03/25/how-the-iranian-cyber-security-agency-detects-emissary-panda-malware/](https://team-cymru.com/2020/03/25/how-the-iranian-cyber-security-agency-detects-emissary-panda-malware/)**\n\nS2 Research Team View all posts by S2 Research Team March 25, 2020\n\n[View all posts](https://team-cymru.com/resources/blog/)\n[Other threat intelligence groups have previously publicised that the Chinese-attributed threat group,](https://unit42.paloaltonetworks.com/emissary-panda-attacks-middle-east-government-sharepoint-servers/)\nEmissary Panda (aka APT27, TG-3390, BRONZE UNION, _Iron Tiger and LuckyMouse), have been_\ntargeting various sectors in the Middle East, including government organisations.\n\nOn 15 December 2019, Iran’s Minister of Communications and Information Technology, Mohammad\n[Javad Azari-Jahromi, announced that Iranian authorities had detected foreign spying malware on](https://twitter.com/azarijahromi/status/1206071513222467585)\ntheir government servers which they attributed to the “well-known APT27” (Figure 1).\n\n**Figure 1: Announcement about APT27 by Iran’s**\n\n**Minister of Communications and Information Technology**\nWe decided to take a look at our data in an attempt to identify any malware indicators of this\ncompromise.\n\nAlthough Emissary Panda are known to utilise a wide-array of tools, they are most often associated\nwith HyperBro, an in-memory RAT. Therefore, we decided to start by searching for any previously\nunobserved samples of this malware we have within our datasets. HyperBro malware is installed on\na system via three components:\n\nA legitimate executable used to side-load\nA malicious DLL used to decrypt and load\nA third file as a DLL (the malicious payload)\n\nWe also know from previous analysis that HyperBro creates various unique artefacts on a victim\nsystem, including:\n\n1. A registry key that contains configuration information that the malware relies on to function.\n2. A service created by the malware which is used to install itself on a victim system.\n3. A process mutex created by HyperBro to ensure that only one instance of the malware is\n\nrunning at any time.\n\n### 1 – REGISTRY\n\n\n-----\n\n**HyperBro stores configuration data in a registry key. The path of this registry key is dynamically**\ngenerated based on information collected on the victim system.\n\n**HyperBro queries the registry**\nkey HKEY_LOCAL_MACHINE\\HARDWARE\\DESCRIPTION\\System\\CentralProcessor\\0 for the\nvalue of Identifier(Figure 2).\n\n**Figure 2: Example value of Identifier**\nThe example in Figure 3 has the value Intel64 Family 6 Model 62 Stepping 4. That value is\nsubsequently used by HyperBro to create a registry key in the HKEY_CLASSES_ROOT. In this\nexample, the created key would be HKEY_CLASSES_ROOT\\Intel64 Family 6 Model 62 Stepping 4ll37389743nxshkhjhgee.\n\n\n-----\n\nThe appended value –ll37389743nxshkhjhgee is a part of the malware s embedded configuration\nand may change over time.\n\n### 2 – SERVICE\n\n**HyperBro installs itself to run as a service by injecting itself into a spawned svchost.exe process.**\nThe HyperBro process will be an orphaned (no parent process) svchost.exe process.\n\n### 3 – MUTEX\n\n**HyperBro creates a process mutex in order to ensure that only one instance of the malware is**\nrunning at any given time. The name of the process mutex is created by collecting the name of the\nuser currently logged onto the compromised system and appending a hard-coded string. Samples\nanalysed to-date have used the string Defender. For example, if the current system profile has a\nusername “Joe”, HyperBro will create a mutex with the name JoeDefender.\n\n**IRANIAN GOVERNMENT DETECTION AND REMOVAL TOOLS**\n\n[When searching for HyperBro samples via the Malware Add-on for Augury, our data analyst’s portal,](https://www.team-cymru.com/augury.html)\none particular sample stood out to us (SHA1: f7979ded11e695448c24a7a8efc1ea2649f9196c)\n(Figure 3):\n\n\n-----\n\nFigure 3: Sample of interest that created a process mutex associated with HyperBro\nWe conducted some further analysis on this sample, and while it created a process mutex\nassociated with HyperBro (PhilDefender), the functionality was vastly different from what we\nexpected. In fact, the version information of the sample suggested that this was not HyperBro at all\n(Figure 4):\n\n\n-----\n\n**Figure 4: Version information from sample of**\n\n**interest**\nAFTA are the Iranian Cyber Security Agency. A screenshot from our malware sandbox showed the\nfollowing image (Figure 5):\n\n**Figure 5: Screenshot**\n\n**from malware sandbox**\nThe logo on the right is for AFTA. Further searches within open source associated the other logo\nwith BitBaan, an Iranian malware analysis laboratory. BitBaan even [tweeted about their APT27](https://twitter.com/BitBaanLab/status/1211601603519754240)\nremediation tools on 30 December 2019.\n\nBitBaan may be a contractor for the Iranian government and this software was developed to share\nwith government agencies and contractors.\n\nUnpacking the sample provided us with strings – specifically contact details for AFTA –  which we\nused to identify an archive that was submitted to VirusTotal from an Iranian IP address, with the\nfilename AFTA-APT27-Detector.rar (SHA1: e38ab5339aef4fe8b2587e178fc38879dbc34209).\n\n\n-----\n\nThe archive contains tools and documentation for detecting and removing HyperBro malware on\nboth single workstations and a Windows domain, including the aforementioned sample that we\npreviously identified. Each set of tools has its own directory.\n\nThe tools and documentation for the “stand-alone” deployment (i.e. tools to be used on a single\nworkstation) are in a folder named Stand-alone_APT27_afta; the contents of this folder are shown\nbelow:\n\n**Filename** AFTA-APT27-Detector.exe\n\n**SHA1** f69ab51268efc334616dfe49c6ee8e3808a0674f\n\n**Description** HyperBro detection tool\n\n**Filename** AFTA-APT27-Removal.exe\n\n**SHA1** f7979ded11e695448c24a7a8efc1ea2649f9196c\n\n**Description** HyperBro removal tool\n\n**Filename** APT27-Help.pdf\n\n**SHA1** 6cf2dfc970033889883e61977ac7ca49e2bceba2\n\n**Description** Technical documentation on using the detection and removal tools\n\nThe tools and documentation for deployment to hosts connected to a Windows domain are in a\nfolder named Domain_APT27_afta; the contents of this folder are shown below:\n\n**Filename** AFTA-APT27-Detector.exe\n\n**SHA1** ee1360de2aec10db6e49b55202bbe280ae40d5b4\n\n**Description** HyperBro detection and removal tool.\n\n**Filename** APT-27_Detector.pdf\n\n**SHA1** 9bfb4b4d6c9c1afb5ccea5fee2c97d8f2aa847e2\n\n**Description** Technical documentation on using the detection and removal tools.\n\n\n-----\n\n**Filename** detector3.bat\n\n**SHA1** 4d8479e8fbc59c10a66abf989051f5b6e41bf8b7\n\n**Description** Batch script that will run detection/removal utility and store logs.\n\n**Filename** summarize-x86.exe\n\n**SHA1** e88b5f201f20e6024095c4dca4170d851f7d9cfe\n\n**Description** Tool that will create summary analysis of all log files generated by AFTA-APT27Detector.exe\n\nThe documentation describes creating a network share for storing the tools that all workstations can\naccess. Users are then directed to use the batch script (detector3.bat) as a scheduled task on all\nworkstations connected to the domain. Logs generated by the batch script are stored on the\npreviously-created network share. The tool summarize-x86.exe will create a summary of the log files\ncreated by workstations that can be reviewed by network incident responders.\n\nThe AFTA detection software (AFTA-APT27-Detector.exe) checks for the existence of the three\nindicators of compromise previously detailed in this blog (registry, service, mutex). When checking\nfor the HyperBro service, the detection utility scans running processes and attempts to identify an\norphaned svchost.exeprocess, and if successful will store the name of the DLL file linked to run\nusing that process. The stored name of the DLL file is then used in the removal process (see\nbelow).\n\nThe removal utility (AFTA-APT27-Removal.exe) will attempt to remove HyperBro (and its artefacts)\nfrom an infected host in the following order:\n\n1. The registry key containing the configuration data.\n2. The service installed by HyperBro, in order to prevent the malware from running again.\n3. The svchost.exe process is then terminated.\n4. The executable, DLL and payload are deleted from disk.\n\nWhile the discovery of these tools does not confirm the full extent of the compromise of Iranian\nGovernment systems by Emissary Panda, their existence alone indicates that the compromise was\nsignificant enough that the Iranian Cyber Security Agency (in co-operation with BitBaan) needed to\ndevelop tools and documentation to distribute across multiple networks/Windows domains.\n\n## 3 replies on “How the Iranian Cyber Security Agency Detects Emissary Panda Malware”\n\n[…] Read more… […]\n\n\n-----\n\n[…] blog.team-cymru.com/2020/03/25/how-the-iranian-cyber-security-agency-detects-emissarypanda-malware/ Other threat intelligence groups have previously publicised that the Chineseattributed threat group, Emissary Panda (aka APT27, TG-3390, BRONZE UNION, Iron Tiger and\nLuckyMouse), have been targeting various sectors in the Middle East, including government\norganisations. On 15 December 2019, Irans Minister of Communications and Information\nTechnology, Mohammad Javad Azari-Jahromi, announced that Iranian authorities had detected\nforeign spying malware on their government servers which they attributed to the well-known APT27\n\n[…]\n\n[…] Comment l’agence iranienne de cybersécurité détecte les logiciels malveillants d’APT … […]\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-03-25 - How the Iranian Cyber Security Agency Detects Emissary Panda Malware.pdf"
    ],
    "report_names": [
        "2020-03-25 - How the Iranian Cyber Security Agency Detects Emissary Panda Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "f3b19931-3751-4ece-a235-15b397951dc2",
            "created_at": "2022-10-25T16:07:23.889537Z",
            "updated_at": "2025-03-27T02:02:10.015565Z",
            "deleted_at": null,
            "main_name": "Nazar",
            "aliases": [
                "SIG37"
            ],
            "source_name": "ETDA:Nazar",
            "tools": [
                "Distribute.exe",
                "EYService",
                "GpUpdates.exe",
                "Microolap Packet Sniffer",
                "TCPDUMP for Windows"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e3492534-85a6-4c87-a754-5ae4a56d7c8c",
            "created_at": "2022-10-25T15:50:23.819113Z",
            "updated_at": "2025-03-27T02:00:55.552554Z",
            "deleted_at": null,
            "main_name": "Threat Group-3390",
            "aliases": [
                "Threat Group-3390",
                "Earth Smilodon",
                "TG-3390",
                "Emissary Panda",
                "BRONZE UNION",
                "APT27",
                "Iron Tiger",
                "LuckyMouse"
            ],
            "source_name": "MITRE:Threat Group-3390",
            "tools": [
                "Systeminfo",
                "gsecdump",
                "PlugX",
                "ASPXSpy",
                "Cobalt Strike",
                "Mimikatz",
                "Impacket",
                "gh0st RAT",
                "certutil",
                "China Chopper",
                "HTTPBrowser",
                "Tasklist",
                "netstat",
                "SysUpdate",
                "HyperBro",
                "ZxShell",
                "RCSession",
                "ipconfig",
                "Clambling",
                "pwdump",
                "NBTscan",
                "Pandora",
                "Windows Credential Editor"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2c980ea7-04c4-4193-8535-52f87e66a96e",
            "created_at": "2024-05-01T02:03:07.994126Z",
            "updated_at": "2025-03-27T02:05:17.293799Z",
            "deleted_at": null,
            "main_name": "BRONZE UNION",
            "aliases": [
                "Budworm ",
                "Emissary Panda ",
                "Iron Tiger ",
                "Lucky Mouse ",
                "TG-3390 ",
                "Temp.Hippo ",
                "APT27 "
            ],
            "source_name": "Secureworks:BRONZE UNION",
            "tools": [
                " ASPXSpy",
                " China Chopper",
                " Enfal",
                " Gh0st RAT",
                " HttpBrowser",
                " Hunter",
                " HyperBro",
                " OwaAuth",
                " PlugX",
                " PoisonIvy",
                " Sysupdate",
                " ZxShell",
                "9002"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "c63ab035-f9f2-4723-959b-97a7b98b5942",
            "created_at": "2023-01-06T13:46:38.298354Z",
            "updated_at": "2025-03-27T02:00:02.798255Z",
            "deleted_at": null,
            "main_name": "APT27",
            "aliases": [
                "TG-3390",
                "EMISSARY PANDA",
                "TEMP.Hippo",
                "Budworm",
                "Group 35",
                "BRONZE UNION",
                "Lucky Mouse",
                "Iron Taurus",
                "GreedyTaotie",
                "Red Phoenix",
                "ZipToken",
                "Iron Tiger",
                "G0027",
                "Earth Smilodon"
            ],
            "source_name": "MISPGALAXY:APT27",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5c13338b-eaed-429a-9437-f5015aa98276",
            "created_at": "2022-10-25T16:07:23.582715Z",
            "updated_at": "2025-03-27T02:02:09.875151Z",
            "deleted_at": null,
            "main_name": "Emissary Panda",
            "aliases": [
                "APT 27",
                "ATK 15",
                "Bronze Union",
                "Budworm",
                "Earth Smilodon",
                "Emissary Panda",
                "Group 35",
                "Iron Taurus",
                "Iron Tiger",
                "LuckyMouse",
                "Operation DRBControl",
                "Operation Iron Tiger",
                "Operation PZChao",
                "Operation SpoiledLegacy",
                "Operation StealthyTrident",
                "Red Phoenix",
                "TEMP.Hippo",
                "TG-3390",
                "ZipToken"
            ],
            "source_name": "ETDA:Emissary Panda",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Agent.dhwf",
                "AngryRebel",
                "Antak",
                "CHINACHOPPER",
                "China Chopper",
                "Destroy RAT",
                "DestroyRAT",
                "FOCUSFJORD",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HTTPBrowser",
                "HTran",
                "HUC Packet Transmit Tool",
                "HighShell",
                "HttpBrowser RAT",
                "HttpDump",
                "HyperBro",
                "HyperSSL",
                "HyperShell",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "Nishang",
                "OwaAuth",
                "PCRat",
                "PlugX",
                "ProcDump",
                "PsExec",
                "RedDelta",
                "SEASHARPEE",
                "Sensocode",
                "SinoChopper",
                "Sogu",
                "SysUpdate",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Token Control",
                "TokenControl",
                "TwoFace",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Xamtrav",
                "ZXShell",
                "gsecdump",
                "luckyowa"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535614,
    "ts_updated_at": 1743041745,
    "ts_creation_date": 1653692912,
    "ts_modification_date": 1653692912,
    "files": {
        "pdf": "https://archive.orkl.eu/26bdb6296878e8406cc599e90b76f3ddfb991dc6.pdf",
        "text": "https://archive.orkl.eu/26bdb6296878e8406cc599e90b76f3ddfb991dc6.txt",
        "img": "https://archive.orkl.eu/26bdb6296878e8406cc599e90b76f3ddfb991dc6.jpg"
    }
}