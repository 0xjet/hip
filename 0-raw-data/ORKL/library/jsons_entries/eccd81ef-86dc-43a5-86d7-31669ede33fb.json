{
    "id": "eccd81ef-86dc-43a5-86d7-31669ede33fb",
    "created_at": "2023-01-12T14:59:18.913049Z",
    "updated_at": "2025-03-27T02:09:29.543811Z",
    "deleted_at": null,
    "sha1_hash": "e7016045697f09a5161b57e99fe450781c819756",
    "title": "2022-07-06 - Brand-New HavanaCrypt Ransomware Poses as Google Software Update App, Uses Microsoft Hosting Service IP Address as C&C Server",
    "authors": "",
    "file_creation_date": "2022-07-18T18:09:15Z",
    "file_modification_date": "2022-07-18T18:09:15Z",
    "file_size": 6808863,
    "plain_text": "# Brand-New HavanaCrypt Ransomware Poses as Google Software Update App, Uses Microsoft Hosting Service IP Address as C&C Server\n\n**[trendmicro.com/en_us/research/22/g/brand-new-havanacrypt-ransomware-poses-as-google-software-update.html](https://www.trendmicro.com/en_us/research/22/g/brand-new-havanacrypt-ransomware-poses-as-google-software-update.html)**\n\nJuly 6, 2022\n\nWe recently found a new ransomware family, which we have dubbed as HavanaCrypt, that disguises itself as a Google Software Update\napplication and uses a Microsoft web hosting service IP address as its command-and-control server to circumvent detection.\n\nBy: Nathaniel Morales, Monte de Jesus, Ivan Nicole Chavez, Bren Matthew Ebriega, Joshua Paul Ignacio\nJuly 06, 2022\nRead time: ( words)\n\n[Ransomware is not at all novel, but it continues to be one of the top cyberthreats in the world today. In fact, according to data from Trend](https://www.trendmicro.com/vinfo/us/security/definition/ransomware)\n[Micro™ Smart Protection Network™, we detected and blocked more than 4.4 million ransomware threats across email, URL, and file layers in](https://www.trendmicro.com/vinfo/us/security/news/ransomware-by-the-numbers/lockbit-conti-and-blackcat-lead-pack-amid-rise-in-active-raas-and-extortion-groups-ransomware-in-q1-2022)\nthe first quarter of 2022 — a 37% increase in overall ransomware threats from the fourth quarter of 2021.\n\nRansomware’s pervasiveness is rooted in its being evolutionary: It employs ever-changing tactics and schemes to deceive unwitting victims\nand successfully infiltrate environments. For example, this year, there have been reports of ransomware being distributed as fake Windows\n10, [Google Chrome, and Microsoft Exchange updates to fool potential victims into downloading malicious files.](https://tech.co/news/fake-chrome-microsoft-edge-update-ransomware)\n\nRecently, we found a brand-new ransomware family that employs a similar scheme: It disguises itself as a Google Software Update\napplication and uses a Microsoft web hosting service IP address as its command-and-control (C&C) server to circumvent detection. Our\n[investigation also shows that this ransomware uses the QueueUserWorkItem function, a .NET System.Threading namespace method that](https://docs.microsoft.com/en-us/dotnet/api/system.threading.threadpool.queueuserworkitem?view=net-6.0#system-threading-threadpool-queueuserworkitem(system-threading-waitcallback))\n[queues a method for execution, and the modules of KeePass Password Safe, an open-source password manager, during its file encryption](https://keepass.info/)\nroutine.\n\nIn this blog entry, we provide an in-depth technical analysis of the infection techniques of this new ransomware family, which we have dubbed\nHavanaCrypt.\n\n## Arrival\n\nHavanaCrypt arrives as a fake Google Software Update application.\n\nFigure 1. The file description of the binary file of HavanaCrypt\n\n[This malware is a .NET-compiled application and is protected by Obfuscar, an open-source .NET obfuscator used to help secure codes in a](https://github.com/obfuscar/obfuscar)\n.NET assembly.\n\n\n-----\n\nFigure 2. The properties of the binary file of HavanaCrypt as shown in the Detect It Easy tool, a program used to determine file types\nThe malware also has multiple anti-virtualization techniques that help it avoid dynamic analysis when executed in a virtual machine. To\n[analyze the sample and generate the deobfuscated code, we used tools such as de4dot and](https://github.com/de4dot/de4dot) [DeObfuscar.](https://github.com/DarkObb/DeObfuscar-Static)\n\nFigure 3. An obfuscated HavanaCrypt ransomware code sample\n\n\n-----\n\nFigure 4. A deobfuscated HavanaCrypt ransomware code sample\nUpon execution, HavanaCrypt hides its window by using the ShowWindow function with parameter 0 (SW_HIDE).\n\nFigure 5. The\n\nShowWindow function as it is used by HavanaCrypt\nHavanaCrypt then checks the AutoRun registry to see whether the “GoogleUpdate” registry is present. If the registry is not present, the\nmalware continues with its malicious routine.\n\n\n-----\n\nFigure 6. The function containing the parameters used by\n\nHavanaCrypt in checking the registry key\nIt then proceeds with its anti-virtualization routine, where it terminates itself if the system is found running in a virtual machine environment.\n\n## Antivirtualization\n\nHavanaCrypt has four stages of checking whether the infected machine is running in a virtualized environment.\n\nFigure 7. The function used by HavanaCrypt to implement its antivirtualization mechanism.\n\n\n-----\n\nFigure 8. The\n\n\nentire antivirtualization routine of HavanaCrypt\n[First, it checks for services used by virtual machines such as VMWare Tools and](https://docs.vmware.com/en/VMware-Tools/12.0.0/com.vmware.vsphere.vmwaretools.doc/GUID-28C39A00-743B-4222-B697-6632E94A8E72.html) [vmmouse.](https://docs.oracle.com/cd/E88353_01/html/E37851/vmmouse-4.html)\n\n\n-----\n\nFigure 9. The services being checked\n\n\nby HavanaCrypt\nSecond, it checks for the usual files that are related to virtual machine applications.\n\n\n-----\n\nFigure 10. The virtual machine files being checked by HavanaCrypt\n\nThird, it checks for file names used by virtual machines for their executables.\n\nFigure 11. The virtual machine\n\nexecutables being checked by HavanaCrypt\nLast, it checks the machine’s MAC address and compares it to organizationally unique identifier (OUI) prefixes that are typically used by virtual\nmachines.\n\n\n-----\n\nFigure 12. The OUI prefixes being checked\n\nby HavanaCrypt\n\nRange or prefix Product\n\n00:05:69 VMware ESX and VMware GSX Server\n\n00:0C:29 Standalone VMware vSphere, VMware Workstation, and VMware Horizon\n\n00:1C:14 VMWare\n\n00:50:56 VMware vSphere, VMware Workstation, and VMware ESX Server\n\n08:00:27 Oracle VirtualBox 5.2\n\nTable 1. Virtual machines’ OUI ranges or prefixes\n\nAfter verifying that the victim machine is not running in a virtual machine, HavanaCrypt downloads a file named “2.txt” from\n20[.]227[.]128[.]33,a Microsoft web hosting service IP address,and saves it as a batch (.bat) file with a file name containing between 20 and 25\nrandom characters.\n\nFigure 13. The details of the Microsoft web hosting service IP address\n\n[(Image source: AbuseIPDB)](http://www.abuseipdb/)\n\nIt then proceeds to execute the batch file using cmd.exe with a “/c start” parameter. The batch file contains commands that are used to\nconfigure Windows Defender scan preferences to allow any detected threat in the “%Windows%” and “%User%” directories.\n\nFigure 14. The function that contains the downloading and execution of the batch file\n\n\n-----\n\nFigure 15. The Base64-encoded 2.txt file as seen on the Microsoft web hosting service IP address\n\nFigure 16. The decoded batch file downloaded from the Microsoft web hosting service IP address\nHavanaCrypt also terminates certain processes that are found running in the machine:\n\nagntsvc\naxlbridge\nccevtmgr\nccsetmgr\ncontoso1\nculserver\nculture\ndbeng50\ndbeng8\ndbsnmp\ndbsrv12\ndefwatch\nencsvc\nexcel\nfdlauncher\nfirefoxconfig\nhttpd\ninfopath\nisqlplussvc\nmsaccess\nmsdtc\nmsdtsrvr\nmsftesql\nmsmdsrv\nmspub\nmssql\nmssqlserver\nmydesktopqos\nmydesktopservice\nmysqld\nmysqld-nt\nmysqld-opt\n\n\n-----\n\nocautoupds\nocomm\nocssd\nonenote\noracle\noutlook\npowerpnt\nqbcfmonitorservice\nqbdbmgr\nqbidpservice\nqbupdate\nqbw32\nquickboooks.fcs\nragui\nrtvscan\nsavroam\nsqbcoreservice\nsqladhlp\nsqlagent\nsqlbrowser\nsqlserv\nsqlserveragent\nsqlservr\nsqlwriter\nsteam\nsupervise\nsynctime\ntbirdconfig\nthebat\nthebat64\nthunderbird\ntomcat6\nvds\nvisio\nvmware-converter\nvmware-usbarbitator64\nwinword\nword\nwordpad\nwrapper\nwxserver\nwxserverview\nxfssvccon\nzhudongfangyu\nzhundongfangyu\n\n\n-----\n\nFigure 17. The processes that HavanaCrypt terminates\nIt should be noted that this list includes processes that are part of database-related applications, such as Microsoft SQL Server and MySQL.\nDesktop apps such as Microsoft Office and Steam are also terminated.\n\nAfter it terminates all relevant processes, HavanaCrypt queries all available disk drives and proceeds to delete the shadow copies and resize\nthe maximum amount of storage space to 401 MB.\n\nFigure 18. HavanaCrypt deleting\n\nshadow copies and resizing the maximum storage space of available drives to 401 MB\nIt also checks for system restore instances via Windows Management Instrumentation (WMI) and proceeds to delete them by using\ntheSRRemoveRestorePoint function.\n\nFigure 19. HavanaCrypt deleting system restore instances via WMI\nIt then drops copies of itself in the %ProgramData% and %StartUp% folders in the form of executable (.exe) files with different file names\ncontaining between 10 and 15 random characters. Their attributes are then set to “Hidden” and “System File.”\n\n\n-----\n\nFigure 20. HavanaCrypt dropping copies of itself in the %ProgramData% and %StartUp% folders\n\nFigure 21. HavanaCrypt setting the dropped files as “Hidden” and “System File”\nHavanaCrypt also drops a file named “vallo.bat” onto %User Startup%, which contains functions that can disable the Task Manager.\n\nFigure 22. HavanaCrypt dropping vallo.bat onto %User Startup%\n\nFigure 23. The content of vallo.bat\n\n## Gathering of machine information\n\nHavanaCrypt uses the QueueUserWorkItem function to implement thread pooling for its other payloads and encryption threads. This function\nis used to execute a task when a thread pool becomes available.\n\n\n-----\n\nFigure 24. The QueueUserWorkItem function as it is used by HavanaCrypt\nIt also uses the DebuggerStepThrough attribute, which causes it to step through the code during debugging instead of stepping into it. This\nattribute must be removed before one can analyze the function inside.\n\nFigure 25. The\n\nDebuggerStepThrough attribute as it is used by HavanaCrypt\nBefore it proceeds with its encryption routine, HavanaCrypt gathers certain pieces of information and sends them to its C&C server,\n20[.]227[.]128[.]33/index.php. These are the unique identifier (UID) and the token and date.\n\n## UID\n\nThe UID contains the machine’s system fingerprint. HavanaCrypt gathers pieces of machine information and combines them, by appending\none to another, before converting the information into its SHA-256 hash in the format:\n\n[{Number of Cores}{ProcessorID}{Name}{SocketDesignation}] BIOS Information [{Manufacturer}{BIOS Name}{Version}] Baseboard\nInformation [{Name}]\n\n\n-----\n\nFigure 26. The function used by HavanaCrypt to gather machine information\n\nmachine information into a SHA-256 hash\nThe pieces of machine information that HavanaCrypt gathers include:\n\nThe number of processor cores\nThe processor ID\nThe processor name\nThe socket designation\nThe motherboard manufacturer\nThe motherboard name\nThe BIOS version\nThe product number\n\n## Token and date\n\n\nFigure 27. HavanaCrypt converting its gathered\n\n\nHavanaCrypt replaces the string “index.php” with “ham.php” to send a GETrequest to its C&C server (hxxp[:]//20[.]227[.]128[.]33/ham.php)\nusing “Havana/1.0” as the user agent.\n\n\n-----\n\nFigure 28. The function used by HavanaCrypt to send a GET request to its C&C server\n\nFigure 29. The response from 20[.]227[.]128[.]33/ham.php that we obtained via Fiddler, a web application debugging tool\nHavanaCrypt decodes the response from ham.php in Base64 and decrypts it via the AES decryption algorithm using these parameters:\n\nAes.key: d8045c7174c2649e96e68a01a5d77f7dec4846ebebb7ed04fa8b1325c14d84b0 (SHA-256 of “HOLAKiiaa##~~@#!2100”)\nAes.IV: consists of 16 sets of 00 bytes\n\nHavanaCrypt then stores the output in two different arrays with “–” as their delimiter. The first array is used as the token, while the second is\nused as the date.\n\nFigure 30. The initialization\n\nof parameters to be used by HavanaCrypt in AES decryption\n\n\n-----\n\nFigure 31.\n\nDecryption by HavanaCrypt via AES\nUsing [CyberChef, a web app that provides operations such as encoding and encryption, we replicated HavanaCrypt’s decryption routine using](https://gchq.github.io/CyberChef/)\nthe response from 20[.]227[.]128[.]33/ham.php:\n\nOutput: d388ed2139d0703b7c2a810b09e513652eb9402c92304addd34679e21a826537-1655449622\nToken: d388ed2139d0703b7c2a810b09e513652eb9402c92304addd34679e21a826537\nDate: 1655449622\n\nFigure 32. Our replication of HavanaCrypt’s decryption routine using the CyberChef app\nAfter gathering all the necessary machine information, HavanaCrypt sends it via a POSTrequest to hxxp://20[.]227[.]128[.]33/index.php using\n“Havana/1.0” as the user agent.\n\nFigure 33. HavanaCrypt’s POST request to hxxp[:]20[.]227[.]128[.]33/index[.]php that we obtained using Fiddler\nIf the request is successful, HavanaCrypt receives a response that contains the encryption key, the secret key, and other details.\n\n\n-----\n\nFigure 34. The response from hxxp[:]20[.]227[.]128[.]33/index[.]php that we obtained using Fiddler\nHavanaCrypt checks whether hava.info is already present in “%AppDataLocal%/Google/Google Software Update/1.0.0.0”. If it does not find\nthe file, it drops the hava.info file, which contains the RSA key generated by HavanaCrypt using the RSACryptoServiceProvider function.\n\nFigure 35. The contents of\n\nhava.info that we obtained using HIEW, a console hex editor\n\nFigure 36. HavanaCrypt’s generation of an RSA key using the RSACryptoServiceProvider function\n\n## Encryption routine\n\nWe have observed that HavanaCrypt uses KeePass Password Safe modules during its encryption routine. In particular, it uses the\nCryptoRandom function to generate random keys needed for encryption. The similarity between the function used by HavanaCrypt and the\n[KeePass Password Safe module from GitHub is evident.](https://github.com/aramrami/KeePass-2.41/blob/master/KeePassLib/Cryptography/CryptoRandom.cs)\n\n\n-----\n\nFigure 37. The functions\n\nused by HavanaCrypt in generating random bytes\n\nFigure 38. A snippet of KeePass Password Safe’s code from GitHub\n\nHavanaCrypt encrypts files and appends “.Havana” as a file name extension.\n\nFigure 39. HavanaCrypt’s encryption routine\nIt avoids encrypting files with certain extensions, including files that already have the appended “.Havana” extension.\n\n\n-----\n\nused by HavanaCrypt to avoid certain file name extensions\n\nextensions files of which HavanaCrypt avoids encrypting\nHavanaCrypt also avoids encrypting files found in certain directories.\n\n\nFigure 40. The function\n\nFigure 41. The file name\n\n\nFigure 42. The directories in which HavanaCrypt avoids encrypting files\n\nFigure 43. The function used by HavanaCrypt to avoid\n\n\ncertain directories\n\n\n-----\n\nFigure 44. Some files encrypted by HavanaCrypt\nDuring encryption, HavanaCrypt creates a text file called “foo.txt”, which logs all the directories containing the encrypted files.\n\nFigure 45. The foo.txt text file that contains logs of directories that contain encrypted\n\nfiles\n\n## Conclusion and Trend Micro solutions\n\nThe HavanaCrypt ransomware’s disguising itself as a Google Software Update application is meant to trick potential victims into executing the\nmalicious binary. The malware also implements many antivirtualization techniques by checking for processes, files, and services related to\nvirtual machine applications.\n\nIt is uncommon for ransomware to use a C&C server that is part of Microsoft web hosting services and is possibly used as a web hosting\nservice to avoid detection. Aside from its unusual C&C server, HavanaCrypt also uses KeePass Password Safe’s legitimate modules during its\nencryption phase.\n\nIt is highly possible that the ransomware’s author is planning to communicate via the Tor browser, because Tor’s is among the directories that\nit avoids encrypting files in. It should be noted that HavanaCrypt also encrypts the text file foo.txt and does not drop a ransom note. This might\nbe an indication that Ha anaCr pt is still in its de elopment phase Ne ertheless it is important to detect and block it before it e ol es f rther\n\n\n-----\n\nand does even more damage.\n\nOrganizations and users can benefit from having the following multilayered defense solutions that can detect ransomware threats before\noperators can launch their attacks:\n\nTrend Micro Vision One™ provides multilayered protection and behavior detection, which helps block questionable behavior and tools\nearly on, before the ransomware can do irreversible damage to the system.\nTrend Micro Apex One™ offers next-level automated threat detection and response against advanced concerns such as fileless threats\nand ransomware, ensuring the protection of endpoints.\n\n**_Additional insights by Nathaniel Gregory Ragasa_**\n\n## Indicators of compromise\n\n**Files**\n\nSHA-256 Detection name Description\n\nb37761715d5a2405a3fa75abccaf6bb15b7298673aaad91a158725be3c518a87 Ransom.MSIL.HAVANACRYPT.THFACBB Obfuscated\nHAVANACRYPT\nransomware\n\nbf58fe4f2c96061b8b01e0f077e0e891871ff22cf2bc4972adfa51b098abb8e0 Ransom.MSIL.HAVANACRYPT.THFACBB Deobfuscated\nHAVANACRYPT\nransomware\n\naa75211344aa7f86d7d0fad87868e36b33db1c46958b5aa8f26abefbad30ba17 Ransom.MSIL.HAVANACRYPT.THFBABB Deobfuscated\nHAVANACRYPT\nransomware\n\n**URLs**\n\nhttp://20[.]227[.]128[.]33/2.txt\n\nhttp://20[.]227[.]128[.]33/index.php\n\nhttp://20[.]227[.]128[.]33/ham.php\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-07-06 - Brand-New HavanaCrypt Ransomware Poses as Google Software Update App, Uses Microsoft Hosting Service IP Address as C&C Server.pdf"
    ],
    "report_names": [
        "2022-07-06 - Brand-New HavanaCrypt Ransomware Poses as Google Software Update App, Uses Microsoft Hosting Service IP Address as C&C Server.pdf"
    ],
    "threat_actors": [
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535558,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1658167755,
    "ts_modification_date": 1658167755,
    "files": {
        "pdf": "https://archive.orkl.eu/e7016045697f09a5161b57e99fe450781c819756.pdf",
        "text": "https://archive.orkl.eu/e7016045697f09a5161b57e99fe450781c819756.txt",
        "img": "https://archive.orkl.eu/e7016045697f09a5161b57e99fe450781c819756.jpg"
    }
}