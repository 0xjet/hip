{
    "id": "f8ceb8cd-0bba-40cc-8fc8-641bb05acc3d",
    "created_at": "2023-01-12T15:10:00.016898Z",
    "updated_at": "2025-03-27T02:06:02.585348Z",
    "deleted_at": null,
    "sha1_hash": "7a3dfe3d156aecbe3a36156b614f7fdb320dadca",
    "title": "2021-04-01 - Wireshark Tutorial- Decrypting RDP Traffic",
    "authors": "",
    "file_creation_date": "2022-05-28T17:43:45Z",
    "file_modification_date": "2022-05-28T17:43:45Z",
    "file_size": 7739382,
    "plain_text": "# Wireshark Tutorial: Decrypting RDP Traffic\n\n**unit42.paloaltonetworks.com/wireshark-tutorial-decrypting-rdp-traffic/**\n\nBrad Duncan, Vijay Prakash April 1, 2021\n\nBy [Brad Duncan and](https://unit42.paloaltonetworks.com/author/bduncan/) [Vijay Prakash](https://unit42.paloaltonetworks.com/author/vijay-prakash/)\n\nApril 1, 2021 at 6:00 AM\n\n[Category: Tutorial,](https://unit42.paloaltonetworks.com/category/tutorial/) [Unit 42](https://unit42.paloaltonetworks.com/category/unit-42/)\n\nTags: [RDP,](https://unit42.paloaltonetworks.com/tag/rdp/) [Windows,](https://unit42.paloaltonetworks.com/tag/windows/) [Wireshark,](https://unit42.paloaltonetworks.com/tag/wireshark/) [Wireshark Tutorial](https://unit42.paloaltonetworks.com/tag/wireshark-tutorial/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/wireshark-tutorial-decrypting-rdp-traffic/)\n\n## Executive Summary\n\nIn recent years, Remote Desktop Protocol (RDP) has been exploited by attackers to access unsecured servers and enterprise networks. Since\n2017, RDP has become a significant vector in malware attacks using ransomware. Security professionals have increasingly focused their\nattention on this protocol by writing signatures to detect RDP vulnerabilities and prevent attacks.\n\nAs a proprietary protocol from Microsoft, RDP supports several operating modes that encrypt network traffic. Unfortunately, this encryption\nmakes writing RDP signatures difficult because RDP content is hidden.\n\nFortunately, we can establish a test environment that provides a key file, and we can use that key to decrypt a packet capture (pcap) of the\nRDP traffic in Wireshark.\n\nThis blog demonstrates how to prepare the environment, obtain a decryption key and use it to decrypt RDP traffic.\n\n## Requirements\n\nThe following are necessary to get the most value from this tutorial:\n\nA virtual environment to run two Windows hosts like VirtualBox or VMware.\nAn understanding of how to set up and use RDP.\nAn RDP client. We use a host running Windows 10 Professional for this tutorial.\nAn RDP server. This can be another Windows host with RDP enabled, or it can be a non-Windows host running FreeRDP.\nA way to record the network traffic between these two hosts. This is most easily done within a virtual environment.\nWireshark version 3.0 or better.\nA basic knowledge of network traffic fundamentals.\n\n\n-----\n\n## Overall Process\n\nThe overall process follows seven general steps:\n\nStep 1: Set up a virtual environment with two hosts, one acting as an RDP client and one acting as an RDP server.\n\nStep 2: Remove forward secrecy ciphers from the RDP client.\n\nStep 3: Obtain the RDP server's private encryption key.\n\nStep 4: Capture RDP traffic between the RDP server and Windows client.\n\nStep 5: Open the pcap in Wireshark.\n\nStep 6: Load the key in Wireshark.\n\nStep 7: Examine RDP data.\n\n**Step 1: Set Up Virtual Environment**\n\n[The two most common virtual environments for this type of analysis are VirtualBox or VMware Workstation for Windows and Linux. VMWare](https://www.virtualbox.org/)\nFusion is used for macOS. VirtualBox is free, while VMware is a commercial product.\n\nThis tutorial does not cover setting up virtual machines (VMs) in a virtual environment. The basic structure of our lab used for this tutorial is\nshown below in Figure 1.\n\nFigure 1. Lab\n\nsetup used for this tutorial.\nOur lab environment contained two Windows 10 hosts. One of the hosts acted as an RDP client, and the other acted as an RDP server. We\nrecorded network traffic from an RDP session between these two hosts from the virtual LAN.\n\n**Step 2: Remove Forward Secrecy Ciphers From RDP Client**\n\n[Some encryption ciphers provide forward secrecy, which is also known as perfect forward secrecy. These types of ciphers create multiple](https://www.keycdn.com/blog/perfect-forward-secrecy)\nsession keys for an SSL/TLS connection. With forward secrecy, we cannot decrypt SSL/TLS traffic using a single private encryption key from\nthe RDP server. Therefore, we had to remove configuration options that support forward secrecy on the RDP client.\n\nFor this tutorial, our RDP client was a host running Windows 10 Pro. This host has a built-in RDP client.\n\nMicrosoft has published details on removing configuration options that support forward secrecy in the articles, “Manage Transport Layer\n[Security (TLS)” and “Prioritizing Schannel Cipher Suites.” Below is a step-by-step process that we used.](https://docs.microsoft.com/en-us/windows/win32/secauthn/prioritizing-schannel-cipher-suites)\n\nOpen the Group Policy Management Console gpedit.msc as an administrator as shown below in Figure 2.\n\n\n-----\n\nRunning the Group Policy Editor in Windows 10 Pro as an administrator.\nFrom the console, use the following menu path:\n\nComputer Configuration.\nAdministrative Templates.\nNetwork.\nSSL Configuration Settings.\n\nBelow, Figure 3 shows how to find SSL Configuration Settings.\n\nGetting to the SSL Configuration Settings.\nUnder SSL Configuration Settings, double-click the entry for SSL Cipher Suite Order as shown below in Figure 4.\n\n\nFigure 2.\n\nFigure 3.\n\n\n-----\n\nGetting to the SSL Cipher Suite Order.\nUnder the SSL Cipher Suite Order, click the Enabled option as shown below in Figure 5.\n\nEnabling the SSL Cipher Suite Order.\nNext, double-click the list of ciphers and select the entire list as shown below in Figure 6.\n\n\nFigure 4.\n\nFigure 5.\n\n\n-----\n\nFigure 6.\n\n\nSelecting the list of ciphers.\nOnce the list has been selected, copy it as shown below in Figure 7.\n\n\n-----\n\nFigure 7.\n\nCopying the list of ciphers.\nCopy this list of ciphers into a text editor such as Notepad. Remove any ciphers that support Elliptic Curve cryptography using Diffie-Hellman\nEphemeral (ECDHE) or Digital Signature Algorithm (ECDSA) encryption. These should be any entries with ECDHE and/or ECDSA in the\nname. In the example shown below in Figure 8, these ciphers were all located sequentially, so they were easy to delete from the text.\n\n\n-----\n\nFigure 8.\n\nDeleting entries for ECDHE and ECDSA.\nOur updated list of ciphers from Figure 8 is listed below in Table 1.\n\nTLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_S\n\n_Table 1. Updated list after removing forward secrecy ciphers._\n\nPaste the updated cipher list back into the SSL Cipher Suites Field, making sure to overwrite the original list. Click the Apply button, then click\nOK to close the window. You have now updated the list and can close the Group Policy Editor.\n\nAfter we accomplished this step, we had to obtain the RDP server’s private key.\n\n**Step 3: Obtain RDP Server's Private Key**\n\nFreeRDP is one option to use as an RDP server. You can get FreeRDP from [this GitHub repository, as well as](https://github.com/FreeRDP) [build instructions. Make sure to](https://github.com/FreeRDP/FreeRDP/wiki/Compilation)\nset the WITH_SERVER=ON flag when creating the server. Once the server is built, you must provide it with a private key, or use one that\ncomes with FreeRDP.\n\nFor our RDP server in this tutorial, we used another host running Windows 10 Pro. Then we extracted the private key from the host’s operating\nsystem.\n\nTo ensure our second Windows host acted as an RDP server, we enabled RDP. To enable RDP on a host running Windows 10 Pro, go to\nWindows Settings from the Start Menu, then select the System icon as shown below in Figure 9.\n\n\n-----\n\nFigure 9.\n\nGetting to the Windows System settings.\nUnder the system settings, select Remote Desktop and click the switch for Enable Remote Desktop as shown below in Figure 10.\n\nFigure 10.\n\nEnabling RDP in WIndows 10.\nAfter setting up our second Windows host as an RDP server, we extracted the private key from its operating system.\n\n[To extract the server key, we could either use either Jailbreak or Mimikatz. We chose Jailbreak.](https://www.varonis.com/blog/what-is-mimikatz/)\n\n[Jailbreak is a tool by iSECPartners that can export the server's RDP certificate. From the exported certificate, we could extract the private key.](https://github.com/iSECPartners/jailbreak)\n\n[To use Jailbreak, we downloaded the following Jailbreak binaires from this GitHub repository on our newly established RDP server:](https://github.com/iSECPartners/jailbreak/tree/master/binaries)\n\nEasyHook64.dll\n\n\n-----\n\nja b ea 6 e e\njailbreakhook64.dll\njbstore2_64.exe\n\nNote: The above files were used on a Windows 10 Pro 64-bit host downloaded on March 4, 2021. A screenshot of the GitHub page is shown\nbelow in Figure 11.\n\nFigure 11.\n\nGitHub page for Jailbreak binaries.\nAfter we downloaded the Jailbreak binaries, we opened a Command prompt with administrator privileges as shown below in Figure 12.\n\n\n-----\n\nFigure 12.\n\nOpening a command prompt as an administrator.\nIn the command prompt, we went to the directory with the downloaded Jailbreak binaries. We ran the following command from this directory:\n\njailbreak64.exe %WINDIR%\\system32\\mmc.exe %WINDIR%\\system32\\certlm.msc -64\n\nIf we were running a 32-bit version of Windows, we would use:\n\njailbreak32.exe %WINDIR%\\system32\\mmc.exe %WINDIR%\\system32\\certlm.msc -32\n\nSee Figure 13 below for an example of running the 64-bit command on our Windows host acting as the RDP server.\n\nFigure 13.\n\nRunning Jailbreak from the command prompt.\nThis command opened the certificate manager for our local machine. From the left column, we expanded Remote Desktop and went to the\n**_Certificates folder. This showed one certificate. If there had been more than one certificate, we would have selected the one with the most_**\nrecent expiration date. We right-clicked on the certificate, selected All Tasks then used Export as shown below in Figure 14.\n\n\n-----\n\nExporting the RDP certificate.\nWhen exporting the certificate, we made sure to select the option to export the private key as shown below in Figure 15.\n\nEnsuring the private key is exported with the certificate.\n\n\nFigure 14.\n\nFigure 15.\n\n\n-----\n\no ou ost, e cou d o y e po t t e ce t cate as a CS # ( ) e as s o be o gu e 6\n\nFigure 16.\n\nCould only export the certificate as a .pfx file.\nAs shown below in Figure 17, the certificate had to have a password. Fortunately, we had no complexity requirements, so we used a single\nletter as the password.\n\n\n-----\n\nFigure 17. The\n\n\nexport process required a password for the certificate.\nFinally, we exported our certificate with the private key as shown below in Figure 18.\n\n\n-----\n\nFigure 18.\n\nCompleting our certificate export.\nAs an alternative, we could have extracted the server’s certificate using Mimikatz instead of Jailbreak. The instructions for using Mimikatz to\n[get the RDP server certificate are listed on GitHub.](https://github.com/FreeRDP/FreeRDP/wiki/Mimikatz)\n\nSince our certificate was obtained using Jailbreak, we moved it to a Linux host and used OpenSSL to extract the key. First, we used the\nfollowing OpenSSL command to extract the key in PEM format:\n\nopenssl pkcs12 -in server_certificate.pfx -nocerts -out server_key.pem -nodes\n\nTo remove the passphrase form the key, we also used the following command:\n\nopenssl rsa -in server_key.pem -out server.key\n\nThis provided us with the RDP server’s private key as shown below in Figure 19.\n\n\n-----\n\nFigure 19.\n\nPrivate server key extracted from the certificate.\nBefore we could use the private server key, we needed to record an RDP session between our two Windows hosts and save it as a pcap.\n\n**Step 4: Capture RDP Traffic**\n\n[With our two Windows hosts in the same virtual environment, we could use a tool like dumpcap,](https://www.wireshark.org/docs/man-pages/dumpcap.html) [tcpdump or Wireshark itself to record network](https://www.tcpdump.org/)\ntraffic in the VLAN using promiscuous mode. Once the recording started, our WIndows client used RDP to log in to the other Windows host\nacting as an RDP server. The host name of the server was DESKTOP-USER1PC.\n\nFigure 20.\n\nUsing the Remote Desktop Connection tool to log into our RDP server.\nWhile the pcap was being recorded, we logged into DESKTOP-USER1PC and performed some basic tasks like opening documents and web\nbrowsing.\n\n\n-----\n\nFigure 21.\n\nPerforming some common desktop tasks through RDP.\nAfter a minute or so, we logged off RDP and stopped recording network traffic from our VLAN.\n\n**Step 5: Open the pcap in Wireshark**\n\nWe opened the pcap of our RDP session in Wireshark. When filtering on rdp in our Wireshark display filter, we saw no results because the\nRDP traffic was encrypted. Figure 22 shows the blank column display we saw when filtering for RDP in our pcap.\n\nFigure 22.\n\nFiltering for RDP information, but no results, due to encrypted RDP traffic.\nHowever, when we used our private server key to decrypt RDP traffic in Wireshark, the results looked much different.\n\n**Step 6: Load the Key in Wireshark**\n\nIn the pcaps we recorded, the RDP server DESKTOP-USER1PC was at IP address 10.3.4.138, and RDP traffic took place over TCP port\n3389. We needed this information to properly decrypt RDP traffic in Wireshark.\n\n\n-----\n\nes a, e used t e e e e ces do a d e pa ded t e **_otoco s sect o_** as s o be o gu e 3\n\nFigure 23.\n\nGetting to the Protocols section of Wireshark’s preferences menu.\nWith Wireshark 3.x, use the TLS entry. If you are using Wireshark 2.x, use the SSL entry. For this section, there should be a button to edit the\n**_RSA keys list. We clicked the button and added the IP address of the RDP server, the RDP port (3389) and the location of the private key file._**\nOur example is shown below in Figure 24.\n\nFigure 24. Go\n\nto the TLS section and add the private key to the RSA keys list.\nAfter Wireshark was set up to decrypt RDP traffic, we had much better results when reviewing the pcap.\n\n**Step 7: Examine RDP Data**\n\nAfter our key was loaded, our column display was no longer blank when filtering for RDP. We had several results as shown below in Figure 25.\n\n\n-----\n\nFigure 25.\n\nViewing the same RDP activity after the private key was loaded in Wireshark.\nFor security professionals who write signatures to find RDP vulnerabilities and attacks, the type of information revealed above in Figure 25 is\ncritical to their work.\n\n## Conclusion\n\nThis blog reviewed how to establish an environment to decrypt traffic from an RDP session. This is easiest to do in a virtual LAN with two hosts\nrunning Windows 10 Professional. After ensuring the client did not use any forward secrecy ciphers, we extracted the private key from our\nWindows host acting as the RDP server. Then we easily recorded a pcap of network traffic. After the session finished, we were able to decrypt\nRDP traffic using the server’s private key.\n\nThis type of environment can help security professionals when writing signatures to detect RDP vulnerabilities and attacks.\n\nFor more help with Wireshark, see our previous tutorials:\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-04-01 - Wireshark Tutorial- Decrypting RDP Traffic.pdf"
    ],
    "report_names": [
        "2021-04-01 - Wireshark Tutorial- Decrypting RDP Traffic.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536200,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1653759825,
    "ts_modification_date": 1653759825,
    "files": {
        "pdf": "https://archive.orkl.eu/7a3dfe3d156aecbe3a36156b614f7fdb320dadca.pdf",
        "text": "https://archive.orkl.eu/7a3dfe3d156aecbe3a36156b614f7fdb320dadca.txt",
        "img": "https://archive.orkl.eu/7a3dfe3d156aecbe3a36156b614f7fdb320dadca.jpg"
    }
}