{
    "id": "251214e2-4037-4080-a14e-dc27e4a22fb0",
    "created_at": "2022-10-25T16:48:14.824586Z",
    "updated_at": "2025-03-27T02:15:35.662318Z",
    "deleted_at": null,
    "sha1_hash": "f5619efad193ae2a5147a1f26ab16ffe5d1a50c4",
    "title": "PowerPoint Presentation",
    "authors": "",
    "file_creation_date": "2017-12-07T15:08:34Z",
    "file_modification_date": "2017-12-07T15:08:34Z",
    "file_size": 1983530,
    "plain_text": "##### Lost in Transaction: Process Doppelgänging\n###### Tal Liberman Eugene Kogan\n\n\n-----\n\n#### About Us\n\n###### • @Tal_Liberman\n\n • Security Research Team Leader @ enSilo\n • Reverse Engineering, Research, Low Level Expert\n • Author on BreakingMalware\n • Eugene Kogan\n\n • Principal Development Lead @ enSilo\n • Former Tech Lead @ Imperva\n • Kernel Expert\n\n\n-----\n\n#### Overview\n\n###### • Brief history of evasion techniques\n • AV scanners\n • Transacted NTFS (TxF)\n • Evolution of Windows process loader\n • Doppelgänging execution flow ( + live demo)\n • “Mitigation in Redstone” - The Story of a BSOD\n\n\n-----\n\n#### Brief History of Evasion Techniques\n\n###### • Advanced Code Injections Overview\n\n • GhostWriting\n • AtomBombing\n • PowerLoader + PowerLoaderEx\n • PROPagate\n • …\n • Reflective Loading\n • Process Hollowing\n\n\n-----\n\nA paradox: Writing to another process without opening it nor actually writing to it\n\n###### • Injection method from over 10 years ago\n • Has never received much attention\n • Inject arbitrary code into explorer.exe without:\n\n • OpenProcess\n • WriteProcessMemory\n • CreateRemoteThread\n\n\n-----\n\nA paradox: Writing to another process without opening it nor actually writing to it\n\n###### • Find 2 patterns in NTDLL\n\n • Move pattern\n\n • mov [REG1], REG2      ; mov [eax], ebx\n • ret\n • Jmp pattern\n\n • jmp 0x0 ;(eb fe)\n\n • Write-What-Where(What, Where)\n\n • SetThreadContext(…):\n\n • EIP=Move pattern\n • ESP=NewStack\n • REG1=Where\n • REG2=What\n\n\n-----\n\nA paradox: Writing to another process without opening it nor actually writing to it\n\n###### • Using write-what-where:\n\n • Write shellcode to stack\n • Write VirtualProtect parameters to stack\n • Using SetThreadContext:\n\n • Call VirtualProtect\n • Call shellcode\n\n\n-----\n\n#### AtomBombing\n\n###### • Injection technique we published in October 2016\n • Exploits the global atom table and APCs\n • Used in the wild by Dridex\n\n\n-----\n\n#### AtomBombing – Write-What-Where\n\n###### • GlobalAddAtom\n\n • NtQueueApcThread(…, GlobalGetAtomNameW, …)\n • Copy code to RW memory in target process\n • Copy ROP chain to target process\n\n • ROP chain\n\n • ZwAllocateVirtualMemory(…, RWX, …);\n • memcpy(RWX, RW, …);\n • Shellcode()\n • Initiate ROP chain\n\n • NtQueueApcThread(…, NtSetContextThread, …)\n\n\n-----\n\n#### Process Hollowing\n\n###### • CreateProcess(“svchost.exe”, …, CREATE_SUSPENDED, …);\n • NtUnmapViewOfSection(…);\n • VirtualAllocEx(…);\n • For each section:\n\n • WriteProcessMemory(..., EVIL_EXE, …);\n • Relocate Image*\n • Set base address in PEB*\n • SetThreadContext(…);\n • ResumeThread(…);\n\n\n-----\n\n#### Process Hollowing\n\n###### • CreateProcess(“svchost.exe”, …, CREATE_SUSPENDED, …);\n • NtUnmapViewOfSection(…);\n • VirtualAllocEx(…);\n\n PEB\n\n • For each section:\n\n • WriteProcessMemory(..., EVIL_EXE, …);\n • Relocate Image* svchost.exe\n • Set base address in PEB*\n .data RW\n\n • SetThreadContext(…);\n\n .text RX\n\n • ResumeThread(…);\n EAX - Entry point\n\n\n-----\n\n#### Process Hollowing\n\n###### • CreateProcess(“svchost.exe”, …, CREATE_SUSPENDED, …);\n • NtUnmapViewOfSection(…);\n • VirtualAllocEx(…);\n\n PEB\n\n • For each section:\n\n • WriteProcessMemory(..., EVIL_EXE, …);\n • Relocate Image* hollowed\n • Set base address in PEB*\n • SetThreadContext(…);\n • ResumeThread(…);\n EAX - Entry point\n\n\n-----\n\n#### Process Hollowing\n\n###### • CreateProcess(“svchost.exe”, …, CREATE_SUSPENDED, …);\n • NtUnmapViewOfSection(…);\n • VirtualAllocEx(…);\n\n PEB\n\n • For each section:\n\n • WriteProcessMemory(..., EVIL_EXE, …);\n • Relocate Image* evil.exe\n • Set base address in PEB*\n • SetThreadContext(…);\n • ResumeThread(…);\n EAX - Entry point\n\n\n-----\n\n#### Process Hollowing\n\n###### • CreateProcess(“svchost.exe”, …, CREATE_SUSPENDED, …);\n • NtUnmapViewOfSection(…);\n • VirtualAllocEx(…);\n\n PEB\n\n • For each section:\n\n • WriteProcessMemory(..., EVIL_EXE, …);\n • Relocate Image* evil.exe\n • Set base address in PEB* .data RW\n • SetThreadContext(…);\n • ResumeThread(…);\n EAX - Entry point\n\n\n-----\n\n#### Process Hollowing\n\n###### • CreateProcess(“svchost.exe”, …, CREATE_SUSPENDED, …);\n • NtUnmapViewOfSection(…);\n • VirtualAllocEx(…);\n\n PEB\n\n • For each section:\n\n • WriteProcessMemory(..., EVIL_EXE, …);\n • Relocate Image* evil.exe\n • Set base address in PEB* .data RW\n • SetThreadContext(…);\n .text RX\n\n • ResumeThread(…);\n EAX - Entry point\n\n\n-----\n\n#### Process Hollowing\n\n###### • CreateProcess(“svchost.exe”, …, CREATE_SUSPENDED, …);\n • NtUnmapViewOfSection(…);\n • VirtualAllocEx(…);\n\n PEB\n\n • For each section:\n\n • WriteProcessMemory(..., EVIL_EXE, …);\n • Relocate Image* evil.exe\n • Set base address in PEB* .data RW\n • SetThreadContext(…);\n .text RX\n\n • ResumeThread(…);\n EAX - Entry point\n\n\n-----\n\n#### Process Hollowing\n\n###### • CreateProcess(“svchost.exe”, …, CREATE_SUSPENDED, …);\n • NtUnmapViewOfSection(…);\n • VirtualAllocEx(…);\n\n PEB\n\n • For each section:\n\n • WriteProcessMemory(..., EVIL_EXE, …);\n • Relocate Image* evil.exe\n • Set base address in PEB* .data RW\n • SetThreadContext(…);\n .text RX\n\n • ResumeThread(…);\n EAX - Entry point\n\n\n-----\n\n#### Process Hollowing\n\n###### • CreateProcess(“svchost.exe”, …, CREATE_SUSPENDED, …);\n • NtUnmapViewOfSection(…);\n • VirtualAllocEx(…);\n\n PEB\n\n • For each section:\n\n • WriteProcessMemory(..., EVIL_EXE, …);\n • Relocate Image* evil.exe\n • Set base address in PEB* .data RW\n • SetThreadContext(…);\n .text RX\n EAX - Entry point\n\n • ResumeThread(…);\n\n\n-----\n\n#### Process Hollowing\n\n###### • CreateProcess(“svchost.exe”, …, CREATE_SUSPENDED, …);\n • NtUnmapViewOfSection(…);\n • VirtualAllocEx(…);\n\n PEB\n\n • For each section:\n\n • WriteProcessMemory(..., EVIL_EXE, …);\n • Relocate Image* evil.exe\n • Set base address in PEB* .data RW\n • SetThreadContext(…);\n .text RX\n EAX - Entry point\n\n • ResumeThread(…);\n\n\n-----\n\n#### Process Hollowing - Issues\n\n###### • The most trivial implementations create an image that is entirely RWX\n\n • Easy to detect in numerous ways\n • Unmap and VirtualAllocEx/NtAllocateVirtualMemory() with correct protection\n\n • Unmapping of main module is highly suspicious\n • ETHREAD.Win32StartAddress  VadType != VadImageMap\n • Overwrite original executable without unmapping\n\n • _MMPFN.u4.PrototypePte == 0 (0 means private/not shared, should be 1 - shared)\n • If not paged – cause page in\n • In forensics PTE.u.Soft.PageFileHigh != 0\n • Unmap and remap as non image\n\n • Vad.Flags.VadType != VadImageMap\n • Unmap and remap as image\n\n • ETHREAD.Win32StartAddress != Image.AddressOfEntryPoint\n • EPROCESS.ImageFilePointer != VAD(ETHREAD.Win32StartAddress).Subsection.ControlArea.FilePointer *\n\n • On Win < 10 – EPROCESS.SectionObject\n\n\n-----\n\n#### Quick Recap\n\n###### • Process hollowing – not so great anymore\n • Rest of techniques\n\n • Missing file mapping\n • Suspicious\n • We need something new\n • Wouldn’t it be cool if we could create a fileless mapped file?\n • But AVs scan files\n\n • We need to understand how scanners work\n\n\n-----\n\n## Anti-Viruses - Real Time Scan\n\n\n-----\n\n#### AV Scanners – Scan on execute\n\n###### File execution timeline\n 1 2 3\n\n Open file Create section Mem map Execute\n\n • Where to intercept?\n 1. Minifilter File open/create 2. Minifilter IRP_MJ_ACQUIRE_FOR_SECTION_SYNCHRONIZATION 3. Process create notify routine (executables only)\n\n\n-----\n\n#### AV Scanners – Challenges\n\n###### • How to open the file for scanning?\n\n • From User mode / Kernel\n • By File name/ FileId / using existing file object\n • Rescan on each change is not practical\n • Scan file before the execution\n\n • File content be altered before execution begins\n\n\n-----\n\n#### AV Scanners – Examples\n\n## Anti-Viruses - Examples\n\n\n-----\n\n|Intercept|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n||||||\n||||||\n||||||\n\n\n#### AV Scanners - Examples\n\n###### Intercept\n\n Open file Create section Mem map Execute\n\n • Block during file open (partial stack)\n```\n     AV Blocks here\n     FLTMGR!FltpPerformPostCallbacks+0x2a5\n     nt!ObOpenObjectByNameEx+0x1dd\n     nt!IoCreateFileEx+0x115\n     nt!NtCreateUserProcess+0x431\n     -------------------- Kernel mode ----------------\n     ntdll!NtCreateUserProcess+0x14\n\n```\n\n-----\n\n#### AV Scanners - Examples\n\n###### • Scan intercepted file while blocked (partial stack)\n```\n     nt!ObpLookupObjectName+0x8b2\n     nt!ObOpenObjectByNameEx+0x1dd\n     FLTMGR!FltCreateFile+0x8d\n     AV minifilter code here\n     FLTMGR!FltpDispatch+0xe9\n     nt!IopXxxControlFile+0xd9c\n     nt!NtDeviceIoControlFile+0x56\n     nt!KiSystemServiceCopyEnd+0x13\n\n```\n\n-----\n\n|Col1|Intercept|Col3|Col4|Col5|\n|---|---|---|---|---|\n||||||\n||||||\n||||||\n\n\n#### AV Scanners - Examples\n\n###### Intercept\n\n Open file Create section Mem map Execute\n\n • Block during ACQUIRE_FOR_SECTION_SYNC…\n```\n     AV Blocks here\n     FLTMGR!FltpPerformPreCallbacks+0x2ea\n     nt!FsRtlAcquireToCreateMappedSection+0x4e\n     nt!FsRtlCreateSectionForDataScan+0xa6\n     FLTMGR!FltCreateSectionForDataScan+0xec\n     WdFilter!MpCreateSection+0x138\n\n```\n\n-----\n\n#### ACQUIRE_FOR_SECTION_SYNC\n\n###### • Flags are misleading –\n\n • SEC_IMAGE unavailable\n • Possible to pass PAGE_READONLY\n Data Or Executable?\n\n\n-----\n\n|Col1|Col2|Col3|Intercept|Col5|\n|---|---|---|---|---|\n||||||\n||||||\n||||||\n\n\n#### AV Scanners - Examples\n\n###### Intercept\n\n Open file Create section Mem map Execute\n\n • Block during process creation partial stack\n```\n     AV Blocks here\n     nt!PspCallProcessNotifyRoutines+0x1cf\n     nt!PspInsertThread+0x5ea\n     nt!NtCreateUserProcess+0x8be\n     -------------------- Kernel mode ----------------\n     ntdll!NtCreateUserProcess+0x14\n     KERNEL32!CreateProcessWStub+0x53\n\n```\n\n-----\n\n#### AV Scanners – Process Notification\n\n###### • PsSetCreateProcessNotifyRoutineEx available Windows Vista SP1+\n\n • Can be achieved in other ways – SSDT (XP remember?)\n • Available only for main executable\n\n • Not useful for DLL loading\n • Blind to process hollowing\n\n\n-----\n\n#### AV Scanners – Summary\n\n###### • It is not an easy job to create an AV\n • Performance vs coverage tradeoff\n\n • How often files are opened and sections are mapped\n • Variety of operating systems and file systems\n\n • From XP to Win 10\n • Different CPUs 32 bit and 64 bit\n • FAT, NTFS, Network\n • Not complicated enough?\n\n\n-----\n\n#### NTFS Transactions\n\n### Transactional NTFS\n\n\n-----\n\n#### NTFS Transactions - Facts\n\n###### • A.K.A. TxF\n • Introduced in Windows Vista\n • Implemented in NTFS driver (Kernel)\n\n • For local disks\n • Microsoft proposed use cases: Files update or DTC\n • Simplifies handling of a rollback after multiple file changes\n\n • For example during installation process\n\n\n-----\n\n#### NTFS Transactions - Facts\n\n###### • Taken from Storage Developer conference – 2009:\n\n • TxF accounts for ~30% of NTFS driver size on AMD64\n • MSDN lists 19 new Win32 *Transacted() APIs\n • 22 file I/O APIs whose behavior is affected by TxF\n • Deprecated on arrival\n • Still used today (almost 11 years later)\n\n\n-----\n\n#### NTFS Transactions – API examples\n\n###### • Application explicitly uses transactions\n • CreateTransaction()\n • CommitTransaction() , RollbackTransaction()\n • CreateFileTransacted(), DeleteFileTransacted(),\n RemoveDirectoryTransacted(), MoveFileTransacted()\n • Most functions that work with handles should work with transactions\n\n\n-----\n\n#### NTFS Transactions – Usage Example\n\n###### • hTransaction = CreateTransaction(NULL, NULL, 0, 0, 0, 0, NULL);\n • hFile = CreateFileTransacted(FILE_NAME, hTransaction);\n • WriteFile(hFile);\n • CloseHandle(hFile);\n • CommitTransaction(hTransaction);\n • CloseHandle(hTransaction);\n\n\n-----\n\n#### Quick Recap\n\n### What we have so far?AV scanners\n\n###### TxFHistoryWhat’s next?\n\n\n-----\n\n#### Quick Recap\n\n###### • Naturally, transactions make life hard for AV vendors\n • We want to create a process from transacted file\n • However process creation does not support transacted files directly\n • We need dive into process creation on Windows to find a way to do it\n\n\n-----\n\n#### Windows Process Loader Evolution\n\n###### • Comparing kernel32!CreateProcessW between XP and 10 gives the\n impression that MS completely changed how processes are created\n • A deeper examination shows that Microsoft simply moved most of\n the code from kernel32 to ntoskrnl (and somehow the function in kernel32 became longer)\n • Logically the steps remain mostly the same, at least for our purposes\n\n\n-----\n\n#### Process Loader Evolution – XP\n\n\n-----\n\n#### Process Loader Evolution – XP\n\n###### • CreateProcessW\n\n • CreateProcessInternalW\n\n • NtOpenFile – Open image file\n • NtCreateSection – Create section from opened image file\n • NtCreateProcessEx – Create process from section\n\n • PspCreateProcess – Actually create the process\n Kernel\n\n • ObCreateObject – Create the EPROCESS object\n • Add process to list of processes\n • BasePushProcessParameters – Copy process parameters\n\n • RtlCreateProcessParameters – Create process parameters\n • NtAllocateVirtualMemory – Allocate memory for process parameters\n • NtWriteVirtualMemory – Copy process parameters to allocated memory\n • NtWriteVirtualMemory – Write address to PEB.ProcessParameters\n • RtlDestroyProcessParameters – Destroy process parameters\n • BaseCreateStack – Create Stack for process\n • NtCreateThread – Create main thread\n • NtResumeThread – Resume main thread\n\n\n-----\n\n#### Process Loader Evolution – 10\n\n\n-----\n\n#### Process Loader Evolution – 10\n\n###### • CreateProcessW\n\n • CreateProcessInternalW\n\n • BasepCreateProcessParameters - Create process parameters\n\n • RtlCreateProcessParametersEx - Create process parameters\n • NtCreateUserProcess - Create process from file\n\n • PspBuildCreateProcessContext – Build create process context\n • IoCreateFileEx – Open image file\n • MmCreateSpecialImageSection – Create section from image file\n • PspCaptureProcessParams – Copy process parameters from user mode\n • PspAllocateProcess - Create process from section\n\n • ObCreateObject – Create EPROCESS object\n • MmCreatePeb – Create PEB for process\n • PspSetupUserProcessAddressSpace – Allocate and copy process\n Kernel • KeStackAttachProcess – Attach to process memory\n\n • ZwAllocateVirtualMemory – Allocate memory for process parameters\n • PspCopyAndFixupParameters – Copy process parameters to process\n\n • Memcpy\n • Set PEB.ProcessParameters\n • KiUnstackDetachProcess – Detach from process memory\n • PspAllocateThread – Create thread\n • PspInsetProcess – Insert process to list of processes\n • PspInsertThread – Insert thread to list of threads\n\n\n-----\n\n#### Windows Process Loader Evolution\n\n###### • NtCreateUserProcess used instead of NtCreateProcessEx\n • NtCreateProcessEx receives a handle to a section\n • NtCreateUserProcess receives a file path\n • NtCreateProcessEx still available – used in creation of minimal\n processes (nt!PsCreateMinimalProcess)\n • All the supporting user-mode code is not available post XP\n\n • We need to implement it ourselves\n\n\n-----\n\n#### Doppelgänging - Motivation\n\n###### • Load and execute arbitrary code\n • In context of legitimate process\n • None of the suspicious process hollowing API calls\n\n • NtUnmapViewOfSection\n • VirtualProtectEx\n • SetThreadContext\n • AV will not scan at all / AV will scan “clean” files only\n • Will not be discovered by advanced forensics tools\n\n\n-----\n\n#### Doppelgänging - Overview\n\n###### • We break Doppelgänging into 4 steps:\n\n • Transact – Overwrite legitimate executable with a malicious one\n • Load – Load malicious executable\n • Rollback – Rollback to original executable\n • Animate – Bring the Doppelgänger to life\n\n\n-----\n\n#### Doppelgänging - Transact\n\n###### • Create a transaction\n\n • hTransaction = CreateTransaction(…);\n • Open a “clean” file transacted\n\n • hTransactedFile = CreateFileTransacted(“svchost.exe”, GENERIC_WRITE | GENERIC_READ, …, hTransaction, …)\n • Overwrite the file with malicious code\n\n • WriteFile(hTransactedFile, MALICIOUS_EXE_BUFFER, …);\n\n\n-----\n\n#### Doppelgänging - Transact\n\n###### • Create a transaction\n\n • hTransaction = CreateTransaction(…);\n • Open a “clean” file transacted\n\n • hTransactedFile = CreateFileTransacted(“svchost.exe”, GENERIC_WRITE | GENERIC_READ, …, hTransaction, …)\n • Overwrite the file with malicious code\n\n • WriteFile(hTransactedFile, MALICIOUS_EXE_BUFFER, …);\n\n\n-----\n\n#### Doppelgänging - Transact\n\n###### • Create a transaction\n\n • hTransaction = CreateTransaction(…);\n • Open a “clean” file transacted\n\n • hTransactedFile = CreateFileTransacted(“svchost.exe”,\n File\n GENERIC_WRITE | GENERIC_READ, …, hTransaction, …)\n • Overwrite the file with malicious code\n\n • WriteFile(hTransactedFile, MALICIOUS_EXE_BUFFER, …); svchost.exe\n\n\n-----\n\n#### Doppelgänging - Transact\n\n###### • Create a transaction\n\n • hTransaction = CreateTransaction(…);\n • Open a “clean” file transacted\n\n • hTransactedFile = CreateFileTransacted(“svchost.exe”,\n File\n GENERIC_WRITE | GENERIC_READ, …, hTransaction, …)\n • Overwrite the file with malicious code\n\n • WriteFile(hTransactedFile, MALICIOUS_EXE_BUFFER, …); svchost.exe\n\n\n-----\n\n#### Doppelgänging - Load\n\n###### • Create a section from the transacted file\n\n • NtCreateSection(&hSection, …, PAGE_READONLY, SEC_IMAGE, hTransactedFile);\n • The created section will point to our malicious executable\n\n File\n\n svchost.exe\n\n\n-----\n\n#### Doppelgänging - Load\n\n###### • Create a section from the transacted file\n\n • NtCreateSection(&hSection, …, PAGE_READONLY, SEC_IMAGE, hTransactedFile);\n • The created section will point to our malicious executable\n\n Section File\n\n svchost.exe svchost.exe\n\n\n-----\n\n#### Doppelgänging - Rollback\n\n###### • Rollback the transaction\n\n • RollbackTransaction(hTransaction);\n • Effectively removes our changes from the file system\n\n Section File\n\n svchost.exe svchost.exe\n\n\n-----\n\n#### Doppelgänging - Rollback\n\n###### • Rollback the transaction\n\n • RollbackTransaction(hTransaction);\n • Effectively removes our changes from the file system\n\n Section File\n\n svchost.exe svchost.exe\n\n\n-----\n\n#### Doppelgänging - Animate\n\n###### • Create process and thread objects\n\n • NtCreateProcessEx(&hProcess, …, hSection, …);\n • NtCreateThreadEx(&hThread, …, hProcess, MALICIOUS_EXE_ENTRYPOINT, …);\n\n Section File\n\n svchost.exe svchost.exe\n\n\n-----\n\n#### Doppelgänging - Animate\n\n###### • Create process and thread objects\n\n • NtCreateProcessEx(&hProcess, …, hSection, …);\n • NtCreateThreadEx(&hThread, …, hProcess, MALICIOUS_EXE_ENTRYPOINT, …);\n\n Process\n\n Section File\n\n svchost.exe svchost.exe\n\n\n-----\n\n#### Doppelgänging - Animate\n\n###### • Create process and thread objects\n\n • NtCreateProcessEx(&hProcess, …, hSection, …);\n • NtCreateThreadEx(&hThread, …, hProcess, MALICIOUS_EXE_ENTRYPOINT, …);\n • Create process parameters\n\n • RtlCreateProcessParametersEx(&ProcessParams, ...);\n • Copy parameters to the newly created process’s address space\n\n • VirtualAllocEx(hProcess, &RemoteProcessParams, …, PAGE_READWRITE);\n • WriteProcessMemory(hProcess, RemoteProcessParams, ProcessParams, …);\n • WriteProcessMemory(hProcess, RemotePeb.ProcessParameters, &RemoteProcessParams, …);\n • Start execution of the doppelgänged process\n\n • NtResumeThread(hThread, …);\n\n\n-----\n\n#### Doppelgänging in Action\n\n# DEMO\n\n\n-----\n\n#### The story of a BSOD\n\n###### • Everything worked well on Windows 7\n • First run on Windows 10 – BSOD\n • Reported by James Forshaw*\n • Null pointer dereference\n\n *https://bugs.chromium.org/p/project-zero/issues/detail?id=852\n\n\n-----\n\n#### The story of a BSOD\n\n###### • How to get over it?\n\n • PsCreateMinimalProcess\n • MS was nice enough to fix it for this talk ;)\n\n\n-----\n\n|Product|Tested OS|Result|\n|---|---|---|\n|Windows Defender|Windows 10|Bypass|\n|AVG Internet Security|Windows 10|Bypass|\n|Bitdefender|Windows 10|Bypass|\n|ESET NOD 32|Windows 10|Bypass|\n|Qihoo 360|Windows 10|Bypass|\n|Symantec Endpoint Protection|Windows 7 SP1|Bypass|\n|McAfee VSE 8.8 Patch 6|Windows 7 SP1|Bypass|\n|Kaspersky Endpoint Security 10|Windows 7 SP1|Bypass|\n|Kaspersky Antivirus 18|Windows 7 SP1|Bypass|\n|Symantec Endpoint Protection 14|Windows 7 SP1|Bypass|\n|Panda|Windows 8.1|Bypass|\n\n\n#### Affected Products\n\n###### Product Tested OS Result\n\n Windows Defender Windows 10 Bypass\n\n AVG Internet Security Windows 10 Bypass\n\n Bitdefender Windows 10 Bypass\n\n ESET NOD 32 Windows 10 Bypass\n\n Qihoo 360 Windows 10 Bypass\n\n Symantec Endpoint Protection Windows 7 SP1 Bypass\n\n McAfee VSE 8.8 Patch 6 Windows 7 SP1 Bypass\n\n Kaspersky Endpoint Security 10 Windows 7 SP1 Bypass\n\n Kaspersky Antivirus 18 Windows 7 SP1 Bypass\n\n Symantec Endpoint Protection 14 Windows 7 SP1 Bypass\n\n Panda Windows 8.1 Bypass\n\n\n-----\n\n#### Detection / Prevention\n\n###### • Realtime\n\n • Scan using file object available in create process notification routine (Vista+)\n\n • On error, block\n • What to do about DLLs?\n • Scan all sections, even data sections – performance issue to consider\n • Forensics\n\n • WriteAccess == TRUE for the FILE_OBJECT associated with process\n • EPROCESS. ImageFilePointer is NULL (Win 10)\n\n\n-----\n\n#### Summary\n\n###### • Process will look legitimate\n • Uses Windows loader (no need for a custom one)\n • Mapped correctly to an image file on disk, just like any legit process\n • No “unmapped code” which is usually detected by modern solutions\n • Can also be leveraged to load DLLs\n • Fileless\n • Even advanced forensics tools such as Volatility will not detect it\n • Works on all Windows versions since Vista\n • Bypasses all tested security products\n\n\n-----\n\n#### Special Thanks\n\n###### • Omri Misgav – Security Researcher @ enSilo\n • @UdiYavo – CTO @ enSilo\n • This research wouldn’t be possible without you\n\n\n-----\n\n##### Questions? Thank you\n###### Tal Liberman Eugene Kogan http://breakingmalware.com\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://www.blackhat.com/docs/eu-17/materials/eu-17-Liberman-Lost-In-Transaction-Process-Doppelganging.pdf"
    ],
    "report_names": [
        "eu-17-Liberman-Lost-In-Transaction-Process-Doppelganging.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2f07a03f-eb1f-47c8-a8e9-a1a00f2ec253",
            "created_at": "2022-10-25T16:07:24.277669Z",
            "updated_at": "2025-03-27T02:02:10.157972Z",
            "deleted_at": null,
            "main_name": "TA428",
            "aliases": [
                "Operation LagTime IT",
                "Operation StealthyTrident",
                "ThunderCats"
            ],
            "source_name": "ETDA:TA428",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Agent.dhwf",
                "Albaniiutas",
                "BlueTraveller",
                "Chymine",
                "Cotx RAT",
                "CoughingDown",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Gen:Trojan.Heur.PT",
                "Kaba",
                "Korplug",
                "LuckyBack",
                "PhantomNet",
                "PlugX",
                "Poison Ivy",
                "RedDelta",
                "RoyalRoad",
                "SManager",
                "SPIVY",
                "Sogu",
                "TIGERPLUG",
                "TManger",
                "TVT",
                "Thoper",
                "Xamtrav",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716494,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1512659314,
    "ts_modification_date": 1512659314,
    "files": {
        "pdf": "https://archive.orkl.eu/f5619efad193ae2a5147a1f26ab16ffe5d1a50c4.pdf",
        "text": "https://archive.orkl.eu/f5619efad193ae2a5147a1f26ab16ffe5d1a50c4.txt",
        "img": "https://archive.orkl.eu/f5619efad193ae2a5147a1f26ab16ffe5d1a50c4.jpg"
    }
}