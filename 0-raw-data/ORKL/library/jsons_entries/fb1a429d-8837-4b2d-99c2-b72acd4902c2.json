{
    "id": "fb1a429d-8837-4b2d-99c2-b72acd4902c2",
    "created_at": "2023-01-12T15:06:25.062149Z",
    "updated_at": "2025-03-27T02:08:41.284605Z",
    "deleted_at": null,
    "sha1_hash": "7520d49ad89cf84c465e03e8beaca14bc6f46a6f",
    "title": "2021-09-26 - Insights into Ransomware Spread Using Exchange 1-Day Vulnerabilities 1-2",
    "authors": "",
    "file_creation_date": "2022-05-28T03:33:50Z",
    "file_modification_date": "2022-05-28T03:33:50Z",
    "file_size": 908633,
    "plain_text": "# Insights into Ransomware Spread Using Exchange 1-Day Vulnerabilities 1-2\n\n**[nsfocusglobal.com/insights-into-ransomware-spread-using-exchange-1-day-vulnerabilities-1-2/](https://nsfocusglobal.com/insights-into-ransomware-spread-using-exchange-1-day-vulnerabilities-1-2/)**\n\nSeptember 26, 2021\n\nSeptember 26, 2021 | Jie Ji\n\n## Event Overview\n\nRecently, NSFOCUS CERT discovered a slew of security incidents that exploited security\nvulnerabilities (ProxyShell) in Microsoft Exchange. Also, NSFOCUS found that the new\nLockFile ransomware group LockFile took advantage of these ProxyShell and PetitPotam\nvulnerabilities to target enterprise domain environments, finally encrypting quite a few hosts\nfrom enterprises for ransom.\n\nIn April, a security researcher reported multiple Exchange Server vulnerabilities to Microsoft,\nthree of which were fixed in Microsoft’s April and May security updates and two were\ndisclosed until the release of July security updates. Vulnerability details are as follows:\n\nMicrosoft Exchange Server Remote Code Execution Vulnerability (CVE-2021-34473): This\nvulnerability arises due to the lack of proper validation of access privileges for URIs. An\nunauthenticated attacker could leverage this issue to access restricted internal APIs via a\nknown API.\n\nOfficial security bulletin: https://msrc.microsoft.com/update-guide/vulnerability/CVE-202134473\n\n\n-----\n\nMicrosoft Exchange Privilege Escalation Vulnerability (CVE-2021-34523): As Microsoft\nExchange Server does not properly validate an access token before executing the Exchange\nPowerShell command, an attacker could execute arbitrary code in the restricted environment\nvia a crafted identity.\n\nOfficial security bulletin: https://msrc.microsoft.com/update-guide/vulnerability/CVE-202134523\n\nMicrosoft Exchange Server Security Feature Bypass Vulnerability (CVE-2021-31207):\nCertain Microsoft Exchange PowerShell command APIs do not restrict the file path and suffix\nwhen writing files, allowing attackers to write arbitrary files.\n\nOfficial security bulletin: https://msrc.microsoft.com/update-guide/vulnerability/CVE-202131207\n\nWindows LSA Spoofing Vulnerability (CVE-2021-36942): An attacker could exploit EFSRPC\n(Encrypting File System Remote Protocol) to launch an NTLM relay attack dubbed\nPetitPotam, to escalate their system privileges.\n\nOfficial security bulletin: https://msrc.microsoft.com/update-guide/vulnerability/CVE-202136942\n\nCurrently, exploits of the preceding vulnerabilities have been made publicly available and\nweaponized. Attackers could exploit a combination of these vulnerabilities to cause remote\ncode execution on an affected Exchange server to gain the highest system privileges of the\ntarget host. Recently, attack activities rage on, and affected users should take precautions as\nsoon as possible.\n\n## Timeline\n\nApril, 2021: A security researcher reported multiple Microsoft Exchange Server vulnerabilities\nto Microsoft.\n\nApril–May, 2021: Microsoft released security updates to fix ProxyShell vulnerabilities.\n\nJuly 14, 2021: Microsoft’s July security updates feature security bulletins for CVE-202134473 and CVE-2021-31207 vulnerabilities.\n\nJuly 19, 2021: A French researcher found a vulnerability (PetitPotam) that could lead to a\nrelay attack through the exploitation of EFSRPC in Windows systems and released PoC\ncode.\n\nJuly 24, 2021: Microsoft released the security bulletin ADV210003 to warn of an NTLM relay\nattack (no patch available) due to the lack of the Active Directory Certificate Service (AD\nCS).\n\n\n-----\n\nAugust 6, 2021: A Taiwan security researcher announced Exchange vulnerability details at\nBlackHat USA 2021 and dubbed the vulnerabilities ProxyShell.\n\nAugust 11, 2021: Microsoft’s August security updates feature patches to fix the NTLM relay\nattack vulnerability (PetitPotam) assigned CVE-2021-36942.\n\nAugust 20, 2021: The exploit of ProxyShell vulnerabilities was made publicly available on\nmultiple platforms like GitHub and Reddit. Also, the exploit of these vulnerabilities was also\nupdated in the well-known Metasploit framework.\n\nAugust 23, 2021: Hacking groups behind viruses, like the ransomware LockFile, exploited\nProxyShell and PetitPotam vulnerabilities to launch attacks in the wild at frequent intervals.\nAugust 25, 2021: Microsoft’s Exchange team posted a security warning on the blog to urge\nusers to apply related patches to fix vulnerabilities as soon as possible.\n\n## Analysis of the Kill Chain of the LockFile Ransomware Group\n\n**WebShell Planted in ProxyShell**\n\nMicrosoft Exchange Server’s improper path verification, coupled with path obfuscation, could\nlead to SSRF. In this way, attackers could access PowerShell endpoints and pack malicious\nemail information into external files through a remote PowerShell session. By writing such\ninformation to files, attackers could cause getshell. By default, WebShell is written to\nC:\\inetpub\\wwwroot\\aspnet_client\\.\n\n\n-----\n\nFirst, Microsoft Exchange Server lacks proper verification of a PowerShell endpoint s\n/Autodiscover/Autodiscover.json path requested by the Autodiscover backend. By triggering\nthe URL request formatting of the ExplicitLogon function, an attacker could exploit this issue\nto directly access arbitrary restricted backend APIs via a combination of a crafted URL and\ncookies. The CVE-2021-34473 vulnerability is exploited during the process. The vulnerable\ncore code is as follows:\n\nFinally, the following malicious request is crafted:\n\nVia a malicious URL, the attacker could obtain LDAP DN information of an account with\ndesired privileges and then locate the system storage of the victim account.\n\nAfter obtaining the storage position of the victim account, the attacker further exploits this\nSSRF vulnerability to invoke the EMSMDB email transmission interface of Exchange MAPI.\nAs Exchange’s web application runs with SYSTEM privileges, MAPI is invoked with SYSTEM\nprivileges, instead of privileges of the victim account. In this case, an error is reported to\nindicate that the attacker uses different privileges before and after MAPI invocation. Besides,\nthe victim account SID is disclosed in this error message.\n\n\n-----\n\nA malicious request is as follows:\n\nError information is as follows:\n\nThe attacker could use both the SID of the victim account and the fixed SID of a privilege\ngroup on Windows to craft a session token for Windows authentication. This token is\nsupposed to be crafted by the frontend reverse proxy server and transmitted to the backend\nvia an HTTP request header. Due to improper verification, if the HTTP header for sending\nthe token does not exist, the attacker could try to parse the URL parameter and manipulate\nthe URL during SSRF to obtain the Exchange Remote PowerShell Management Session\nprivilege on the Exchange server. The vulnerability exploited in the process is CVE-202134523. The core vulnerable code is as follows:\n\nAfter the Exchange Remote PowerShell Management Session privilege is obtained,\ncommands other than Exchange PowerShell Cmdlet cannot be executed because this\nsession belongs to a restricted PowerShell environment The FilePath parameter which\n\n\n-----\n\nspecifies the path to save the file exported via the New-MailboxExportRequest command (for\nexport backup of the individual mailbox), has no restriction on the file path, file name, and file\nextension name. This allows attackers to write arbitrary files. During the process, the\nvulnerability CVE-2021-31207 is used. The used shell command is as follows:\n\nBy exploiting the preceding SSRF vulnerability, the attacker invokes the corresponding\nExchange API endpoint to store the encrypted WebShell file that contains malicious code in\nthe Drafts folder in the victim’s mailbox or send the file to the victim’s mailbox. This ensures\nthat WebShell information can be restored during secondary encryption of the WebShell file\nthat is exported from the victim’s mailbox for backup. In this way, the attacker can write\nWebShell. WebShell information is encrypted with permutative encoding that Microsoft uses\nto encrypt PST files, to make sure that characters can be encrypted and decrypted after\nbeing parsed by a replacement algorithm.\n\nMost of the captured samples are the following encrypted one-line backdoor:\n\n\n-----\n\n**Cobalt Strike Planted Through DLL Hijacking**\n\nThe attacker executes the wget command in PowerShell to download attack toolkits for\nsubsequent use and frequently changes server ports and uses random file names (like\n[http://x.x.x.x:45261/5rFxNBwH6ol0Q9z1sAaIZ) to prevent samples from being captured by](http://x.x.x.x:45261/5rFxNBwH6ol0Q9z1sAaIZ)\nresearchers. Currently, server IP addresses known to be used by attackers include\n209.14.0.234, 45.91.83.176, 183.226.73.185, and 178.63.226.197. The attacker first uses\nEfsPotato.exe in the toolkit for local privilege escalation, and then runs the Cobalt Strike\nloader active_desktop_launcher.exe with highest system privileges. The privilege escalation\ntool EfsPotato exploits the CVE-2021-36942 vulnerability which is also known as PetitPotam.\nThe attacker leverages EFSRPC to launch NTLM relay attacks to escalate local privileges or\nprivileges in the AD domain.\n\nactive_desktop_launcher is the legitimate KuGou launcher which provides valid digital\nsignatures to load active_desktop_render.dll for malicious code execution.\n\n\n-----\n\nThe launcher invokes two functions, SetDesktopMonitorHook and\nClearDesktopMonitorHook, both of which reside in active_desktop_render.dll.\nSetDesktopMonitorHook performs the following steps:\n\n1. Try to open desktop.ini in the current directory. If this file does not exist, exit the program.\n\n2. Create a new thread, open desktop.ini in this thread, and map the file to the memory.\n\n3. Read file contents through memory mapping, perform XOR decryption on file contents,\nand execute them as shellcode.\n\n\n-----\n\nClearDesktopMonitorHook reads files for string comparison and exits the process, without\nproviding other actual functions. The C&C address of the Cobalt Strike trojan in the captured\nsample is sc.microsofts.net/messages/DALBNSf26.\n\n**Group Policy in the AD Domain for Bulk Script Dispatch**\n\nThe attacker copies the ransomware-related tool to the NETLOGON shared directory on the\ndomain controller. The absolute path of the directory is C:\\Windows\\Sysvol\\Sysvol\\\n\n[DomainName]\\Scripts so that hosts in the domain can access related tools via the UNC path\n[\\\\server\\netlogon. Create a group policy object (GPO) for script execution in the Group](http://10.10.0.46/file://server/netlogon)\n**Policy Management window on the domain controller, and then link it and dispatch it to**\nhosts in the domain.\n\nAnalyzing the captured script file autologin.bat, we find that the attacker first copies the\nransomware file autoupdate.exe in the NETLOGON shared directory and KDU kernel\nprogram tools (including autologin.exe, autologin.dll, and autologin.sys) to the local directory\nC:\\Windows\\Temp. Then, the attacker uses the KDU tool to obtain system kernel privileges\nto terminate the antivirus process before finally executing the ransomware file.\n\n\n-----\n\nTo be continued.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-26 - Insights into Ransomware Spread Using Exchange 1-Day Vulnerabilities 1-2.pdf"
    ],
    "report_names": [
        "2021-09-26 - Insights into Ransomware Spread Using Exchange 1-Day Vulnerabilities 1-2.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535985,
    "ts_updated_at": 1743041321,
    "ts_creation_date": 1653708830,
    "ts_modification_date": 1653708830,
    "files": {
        "pdf": "https://archive.orkl.eu/7520d49ad89cf84c465e03e8beaca14bc6f46a6f.pdf",
        "text": "https://archive.orkl.eu/7520d49ad89cf84c465e03e8beaca14bc6f46a6f.txt",
        "img": "https://archive.orkl.eu/7520d49ad89cf84c465e03e8beaca14bc6f46a6f.jpg"
    }
}