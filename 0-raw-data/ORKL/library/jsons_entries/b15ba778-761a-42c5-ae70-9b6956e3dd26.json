{
    "id": "b15ba778-761a-42c5-ae70-9b6956e3dd26",
    "created_at": "2023-01-12T15:05:58.259568Z",
    "updated_at": "2025-03-27T02:16:20.725654Z",
    "deleted_at": null,
    "sha1_hash": "e50cd4c996c6cd7bb4a47dc7f7a86e3cb8c15837",
    "title": "2019-07-21 - Emissary Panda DLL Backdoor",
    "authors": "",
    "file_creation_date": "2022-05-28T17:33:02Z",
    "file_modification_date": "2022-05-28T17:33:02Z",
    "file_size": 1410135,
    "plain_text": "# Emissary Panda DLL Backdoor\n\n**norfolkinfosec.com/emissary-panda-dll-backdoor/**\n\nnorfolk July 21, 2019\n\nLast month’s post on this blog examined a backdoor previously thought to be associated with\nEmissary Panda (APT27). Recent reporting has instead shown that the HTTP listener\nexamined is likely affiliated with Turla. That post has been updated with the corresponding\ncorrections.\n\n[This post is a granular examination of a payload alluded to in a Palo Alto report that is tied to](https://unit42.paloaltonetworks.com/emissary-panda-attacks-middle-east-government-sharepoint-servers/)\nEmissary Panda with much higher confidence. While the payload wasn’t available for\n[analysis in that report, VirusTotal pivoting at the time produced the matching file.](https://twitter.com/KevinPerlow/status/1133941247536697345)\n\nFilename: PYTHON33.hlp\n\nMD5: 19c46d01685c463f21ef200e81cb1cf1\n\nSHA1: ac4a264a76ba22e21876f7233cbdbe3e89b6fe9d\n\nSHA256: 3e21e7ea119a7d461c3e47f50164451f73d5237f24208432f50e025e1760d428\n\nThis file is expected to be part of a DLL side-loading chain that involves a component of the\nlegitimate Sublime text editor (plugin_host.exe, also available on VirusTotal:\nf0b05f101da059a6666ad579a035d7b6) and a malicious DLL that this file will sideload:\n\nFilename: PYTHON33.dll\n\nMD5: bc1305a6ca71d8bdb3961bfd4e2b3565\n\nSHA1: f189d63bae50fc7c6194395b2389f9c2a453312e\n\nSHA256: 2dde8881cd9b43633d69dfa60f23713d7375913845ac3fe9b4d8a618660c4528\n\nPreparation\n\nIf all three of these files are placed in the same folder with the correct filenames,\nplugin_host.exe will sideload PYTHON33.dll, which will decrypt and decompress the\nPYTHON33.hlp file into a DLL. The workflow for this is similar to (but not identical to)\nprevious reporting from NCC group regarding an earlier version of this malware. This post\nwill thus not go into detail regarding this process, but makes the following recommendation\nfor analyzing these components:\n\n1) Patch the PYTHON33.hlp file (which is a block of shellcode) by prepending an infinite loop\n(EB FE) to the file via a hex editor\n\n2) Run plugin_host.exe normally (i.e. not in a debugger). This will sideload the DLL and load\nthe shellcode, but will hold it in an infinite loop without executing any commands\n\n\n-----\n\n3) Attach a debugger (e.g. x96dbg) to this running process and step through until the\npayload is decoded in memory, as you would any other shellcode samples. In this case, a\ngood breakpoint to set is would be at the entry to “CommandLineToArgvW”\n\nThe breakpoint in step 3 wouldn’t be obvious during the initial examination of this file, but this\nblog mentions it here as a shortcut to facilitate analysis of this file. The DLL can also be\ndumped at this stage for concurrent static analysis in IDA.\n\nPayload\n\nThe Palo Alto report mentions similarities between the loading and decrypting process for\nthis file and the loading and decrypting process for a file previously analyzed (but not\n[provided) by NCC Group. NCC Group provided a high-level overview of that payload’s](https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2018/may/emissary-panda-a-potential-new-malicious-tool/)\ncapabilities. This overview serves as a framework for “what we might be looking for;”\nspecifically, NCC group mentions the following:\n\n– An execution workflow determined by the number of specified parameters\n– Process injection into svchost\n– A series of keys written to the registry in a unique way\n– A basic persistence mechanism (HKCU runkey) + service creation\n\nThis offers a big head-start for analysis. First, the malware calls GetCommandLineW\nfollowed by CommandLineToArgvW. [Per MSDN documentation, this second call “parses a](https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-commandlinetoargvw)\nUnicode command line string and returns an array of pointers to the command line\narguments.” The “number of pointers in this array is indicated by pNumArgs.” The screenshot\nbelow shows these two API calls at the top, followed by a comparison between pNumArgs\n(decreased by 1, for the case statement) and the value “3:”\n\n\n-----\n\n**Comparison for number of**\n\n**command line arguments**\nIf EAX is greater than 3, (i.e. if there are more than three command line arguments), the\nmalware will jump to the default case rather than cases 0-4, will return to the calling function,\nand will terminate without taking any action. If EAX is less than or equal to 3, it will jump into\none of the available cases:\n\n\n-----\n\n**Case structure**\n\nAs always, right click and open the image in a new tab to enlarge. Additional labeling has\nbeen added, including string labeling that would be visible during dynamic analysis in a\ndebugger. At this stage, we can begin exploring the cases.\n\nCase 0\n\nA good way to explore these cases to take a snapshot just prior to the EAX comparison, and\nthen set EAX to the value of the case to be examined. In Case 0, the malware:\n\n– Moves a string representing the location of the currently running executable\n(plugin_host.exe) to EAX\n\n– Moves a string containing “C:\\\\ProgramData\\\\plugin_host\\\\pluginhost.exe” to ECX\n\n– Pushes these two values to the stack\n\n– Uses wsicmp to compare these two values\n\n– Jumps to an “ExitProcess” call if these two values do not match\n\nIf these two values do match, the malware will move to a function call referenced in several\nlocations, labelled in the above IDA screenshot as the CreateFileCheck_Inject_Calls. As\nthis label would suggest, there are two primary subcomponents of this call, labelled below as\n**CreateFileCheck and Process_Injection_Workflow.**\n\n\n-----\n\n**Subroutine to launch the file**\n\n**check and process injection workflows**\nThe CreateFileCheck subroutine will use the PathFileExistsW and CreateFileW APIs to\ncheck if the malware can open C:\\\\ProgramData\\\\plugin_host\\\\PYTHON33.hlp:\n\n\n-----\n\n**Checking if PYTHON33.hlp is at the correct location**\n\nThe next function, not pictured here due to space constraints, will take the following actions:\n\n– Locate and spawn a suspended copy of svchost.exe\n\n– Allocate an executable section of memory\n\n– Write PYTHON33.hlp to this section of memory\n\n– Create and resume a thread at this location\n\nThis is a common workflow for process injection. The parent process will then terminate.\nThus, Case 0 can be summarized in the following way:\n\n– Ensure that plugin_host.exe is running from the correct directory\n\n– Ensure that PYTHON33.hlp is inside of this directory\n\n– Create a suspended svchost.exe process\n\n\n-----\n\n– Re-write a copy of the payload into this process\n– Terminate\n\nCase 1\n\nCase 1 can be thought of as Case 0 with added contingencies. Case 1 begins with the same\nstring comparison, ensuring that the malware is running from the\n“C:\\\\ProgramData\\\\plugin_host\\\\” directory. If this comparison is successful, the malware will\nrun the same check for PYTHON33.hlp and process injection routines described in Case 0,\nfollowed by the “core functionality” routine (described later).\n\nUnlike Case 0, if the file is not running from the correct subdirectory in ProgramData, the\nmalware does not terminate; instead, it performs what is labelled as the “MoveFile_Routine”\nin the IDA case picture. This workflow:\n\n– Moves the necessary components for the malware to run into the\nProgramData\\\\plugin_host\\\\ directory\n– Executes plugin_host.exe using WMI\n\nCase 1 represents a more flexible workflow for starting the malware for the first time.\n\n\n-----\n\n**WMI Execution Workflow**\n\nCase 2\n\nCase 2 contains three parts, in the following order:\n\n– A new call not yet analyzed\n\n– The same CreateFile check and ProcessInjection calls\n\n– The “core functionality” call discussed in Case 3\n\nThe new call is actually fairly simple. This function performs a permissions check, and takes\none of two branches depending on the permissions available:\n\n\n-----\n\n**Branch to registry**\n\n**workflow (left) or service workflow (right)**\nWith sufficient privileges, the malware will create a new service named\n_plugin_hostvr874u5Pn pointing at the plugin_host.exe executable with a start type of “2”_\n(autoload):\n\n\n-----\n\n**Service Creation**\nOtherwise, the malware will create a registry entry under the HKCU CurrentVersion\\Run key\nnamed plugin_hostvr874u5Pn pointing to plugin_host.exe with a parameter of –1. The\nfunction then returns and the injection and core routines are executed.\n\n\n-----\n\n**Registry Key Creation**\n\nCase 3\n\n[Case 3 contains a single function, referenced above and by NCC Group’s writeup on an](https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2018/may/emissary-panda-a-potential-new-malicious-tool/)\nearlier version of this malware as the “core functionality” routine. This routine contains the\ncode used for process injection, but more importantly is used to:\n\n– Write encrypted configuration values to the Windows Registry\n\n– Perform a workflow for C2 communication\n\nmissary panda unit42\n\n\n-----\n\nThe workflow for this is shown below, and tracks closely with the previous NCC group\nreporting:\n\n**Workflow for writing config values to the registry**\n\n\n-----\n\n**Writing config value to registry**\nFollowing this, the malware enters its C2 routine. The malware uses the PolarSSL library to\ndo this, and communicates with 138.68.154[.]133:443.\n\n**Concluding Thoughts**\n\nHaving looked at each of the cases within the malware, we can compare this sample to the\npreviously reported one, even though that file was never provided.\n\n– The previous reporting described self-termination and WMI execution for Case 0. The WMI\nfunctionality appears to have moved to Case 1, and Case 0 now supports process injection.\n\n– Case 1 now supports moving the files to the appropriate locations if they are not present,\nexecuting these files via WMI, or performing process injection. Previously, the file moving\nroutines were in Case 0.\n\n– Case 2 appears to be largely unchanged.\n\n– Case 3 appears to be largely unchanged.\n\n– There is no “Case 4,” although the malware will treat any number of parameters greater\nthan 3 as a signal to head to the “default case.”\n\n– The referenced debugging strings do not appear in this sample.\n\n\n-----\n\nNCC group previously assessed that the malware might be undergoing active development.\nGiven these findings from a sample a year later, it appears that was the case. There are\nminor upgrades, cases rearranged, and possibly one case removed. Still, based on the\nhigher-level descriptions in that report and how closely they track with this more granular\nanalysis, it would appear that this is the same malware family (with modifications).\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-07-21 - Emissary Panda DLL Backdoor.pdf"
    ],
    "report_names": [
        "2019-07-21 - Emissary Panda DLL Backdoor.pdf"
    ],
    "threat_actors": [
        {
            "id": "e3492534-85a6-4c87-a754-5ae4a56d7c8c",
            "created_at": "2022-10-25T15:50:23.819113Z",
            "updated_at": "2025-03-27T02:00:55.552554Z",
            "deleted_at": null,
            "main_name": "Threat Group-3390",
            "aliases": [
                "Threat Group-3390",
                "Earth Smilodon",
                "TG-3390",
                "Emissary Panda",
                "BRONZE UNION",
                "APT27",
                "Iron Tiger",
                "LuckyMouse"
            ],
            "source_name": "MITRE:Threat Group-3390",
            "tools": [
                "Systeminfo",
                "gsecdump",
                "PlugX",
                "ASPXSpy",
                "Cobalt Strike",
                "Mimikatz",
                "Impacket",
                "gh0st RAT",
                "certutil",
                "China Chopper",
                "HTTPBrowser",
                "Tasklist",
                "netstat",
                "SysUpdate",
                "HyperBro",
                "ZxShell",
                "RCSession",
                "ipconfig",
                "Clambling",
                "pwdump",
                "NBTscan",
                "Pandora",
                "Windows Credential Editor"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2c980ea7-04c4-4193-8535-52f87e66a96e",
            "created_at": "2024-05-01T02:03:07.994126Z",
            "updated_at": "2025-03-27T02:05:17.293799Z",
            "deleted_at": null,
            "main_name": "BRONZE UNION",
            "aliases": [
                "Budworm ",
                "Emissary Panda ",
                "Iron Tiger ",
                "Lucky Mouse ",
                "TG-3390 ",
                "Temp.Hippo ",
                "APT27 "
            ],
            "source_name": "Secureworks:BRONZE UNION",
            "tools": [
                " ASPXSpy",
                " China Chopper",
                " Enfal",
                " Gh0st RAT",
                " HttpBrowser",
                " Hunter",
                " HyperBro",
                " OwaAuth",
                " PlugX",
                " PoisonIvy",
                " Sysupdate",
                " ZxShell",
                "9002"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "c63ab035-f9f2-4723-959b-97a7b98b5942",
            "created_at": "2023-01-06T13:46:38.298354Z",
            "updated_at": "2025-03-27T02:00:02.798255Z",
            "deleted_at": null,
            "main_name": "APT27",
            "aliases": [
                "TG-3390",
                "EMISSARY PANDA",
                "TEMP.Hippo",
                "Budworm",
                "Group 35",
                "BRONZE UNION",
                "Lucky Mouse",
                "Iron Taurus",
                "GreedyTaotie",
                "Red Phoenix",
                "ZipToken",
                "Iron Tiger",
                "G0027",
                "Earth Smilodon"
            ],
            "source_name": "MISPGALAXY:APT27",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5c13338b-eaed-429a-9437-f5015aa98276",
            "created_at": "2022-10-25T16:07:23.582715Z",
            "updated_at": "2025-03-27T02:02:09.875151Z",
            "deleted_at": null,
            "main_name": "Emissary Panda",
            "aliases": [
                "APT 27",
                "ATK 15",
                "Bronze Union",
                "Budworm",
                "Earth Smilodon",
                "Emissary Panda",
                "Group 35",
                "Iron Taurus",
                "Iron Tiger",
                "LuckyMouse",
                "Operation DRBControl",
                "Operation Iron Tiger",
                "Operation PZChao",
                "Operation SpoiledLegacy",
                "Operation StealthyTrident",
                "Red Phoenix",
                "TEMP.Hippo",
                "TG-3390",
                "ZipToken"
            ],
            "source_name": "ETDA:Emissary Panda",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Agent.dhwf",
                "AngryRebel",
                "Antak",
                "CHINACHOPPER",
                "China Chopper",
                "Destroy RAT",
                "DestroyRAT",
                "FOCUSFJORD",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HTTPBrowser",
                "HTran",
                "HUC Packet Transmit Tool",
                "HighShell",
                "HttpBrowser RAT",
                "HttpDump",
                "HyperBro",
                "HyperSSL",
                "HyperShell",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "Nishang",
                "OwaAuth",
                "PCRat",
                "PlugX",
                "ProcDump",
                "PsExec",
                "RedDelta",
                "SEASHARPEE",
                "Sensocode",
                "SinoChopper",
                "Sogu",
                "SysUpdate",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Token Control",
                "TokenControl",
                "TwoFace",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Xamtrav",
                "ZXShell",
                "gsecdump",
                "luckyowa"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535958,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1653759182,
    "ts_modification_date": 1653759182,
    "files": {
        "pdf": "https://archive.orkl.eu/e50cd4c996c6cd7bb4a47dc7f7a86e3cb8c15837.pdf",
        "text": "https://archive.orkl.eu/e50cd4c996c6cd7bb4a47dc7f7a86e3cb8c15837.txt",
        "img": "https://archive.orkl.eu/e50cd4c996c6cd7bb4a47dc7f7a86e3cb8c15837.jpg"
    }
}