{
    "id": "c50a8e77-29a1-4416-bca7-d99e7137ee90",
    "created_at": "2022-10-25T16:48:16.83865Z",
    "updated_at": "2025-03-27T02:10:20.618867Z",
    "deleted_at": null,
    "sha1_hash": "06d0aec6c9a8aa4ef0a72f17d82006471f34d427",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-06-08T07:02:44Z",
    "file_modification_date": "2021-06-08T07:02:44Z",
    "file_size": 1634259,
    "plain_text": "# SharpPanda: Chinese APT Group Targets Southeast Asian Government With Previously Unknown Backdoor\n\n**[research.checkpoint.com/2021/chinese-apt-group-targets-southeast-asian-government-with-previously-unknown-backdoor](https://research.checkpoint.com/2021/chinese-apt-group-targets-southeast-asian-government-with-previously-unknown-backdoor/)**\n\n\nJune 3, 2021\n\n\n-----\n\nJune 3, 2021\n\n## Introduction\n\nCheck Point Research identified an ongoing surveillance operation targeting a Southeast Asian government. The attackers use spearphishing to gain initial access and leverage old Microsoft Office vulnerabilities together with the chain of in-memory loaders to attempt\nand install a previously unknown backdoor on victim’s machines.\n\nOur investigation shows the operation was carried out by what we believe is a Chinese APT group that has been testing and refining the\ntools in its arsenal for at least 3 years.\n\n[While some initial artifacts of this attack have already been analyzed by VinCSS, in this report we will reveal the full infection chain used](https://blog.vincss.net/2021/05/re022-phan-1-phan-tich-nhanh-mau-ma-doc-gia-mao-cong-van-cua-uy-ban-kiem-tra-tw-VietNam.html)\nin this attack and provide a full analysis of the TTPs used throughout this campaign as well as the new tools uncovered during the\nresearch. We will also explore the evolution of the actor’s tools since they have been first seen in the wild.\n\n## Infection Chain\n\nThe investigation starts from the campaign of malicious DOCX documents that are sent to different employees of a government entity in\nSoutheast Asia. In some cases, the emails are spoofed to look like they were from other government-related entities. The attachments to\nthese emails are weaponized copies of legitimate looking official documents and use the remote template technique to pull the next stage\nfrom the attacker’s server.\n\n\n-----\n\n**Figure 1: Examples of lure documents sent to the victims**\n\nEach document downloads a template from a different URL but with a similar pattern, with the working folder containing names of\nbrands ( ipad, `surface,` `apple, etc.) to distinguish between each victim.`\n\n\n-----\n\n**Figure 2: External template URL**\n\n[The remote templates in all the cases are RTF files weaponized using a variant of a tool named RoyalRoad. This tool allows the attacker](https://nao-sec.org/2020/01/an-overhead-view-of-the-royal-road.html)\nto create customized documents with embedded objects that exploit the Equation Editor vulnerabilities of Microsoft Word. Despite the\nfact that these vulnerabilities are few years old, they are still used by multiple attack groups, and especially popular with Chinese APT\ngroups.\n\nThe initial documents and RTF files are just the very start of an elaborate multi-stage infection-chain we will analyze.\n\n**Figure 3: Full infection chain**\n\n\n-----\n\n## RoyalRoad RTF\n\nAs all RoyalRoad RTFs, the next stage RTF document contains encrypted payload and shellcode.\n\n**Figure 4: RTFobj output, exposing OLE objects information**\n\nTo decrypt the payload from the package, the attacker uses the RC4 algorithm with the key `123456, and the resulted DLL file is saved`\nas `5.t in the` `%Temp% folder. The shellcode is also responsible for the persistence mechanism – it creates the scheduled task named`\n```\nWindows Update that should run the exported function StartW from 5.t with rundll32.exe, once a day.\n\n```\nThe use of `StartW as exported function, is common with Cobalt Strike DLL’s. The use of such an export name might indicate that in`\nother cases, the same toolset is used to deliver Cobalt Strike instead of the payloads we describe below.\n\n## 5.t Downloader\n\nThe `5.t DLL’s original name is` `Download.dll . It starts with a common anti-sandboxing technique detecting the acceleration of code`\nexecution: it gets the local time before and after a Sleep function call and checks if the Sleep was skipped.\n\n\n-----\n\nThen the loader gathers data on the victim’s computer including hostname, OS name and version, system type (32/64 bit), user name,\nMAC addresses of the networking adapters. It also queries WMI for the anti-virus information.\n\nThe loader then encrypts the information using the RC4 with the key `123456 and base64 encodes it.`\n\nThe data is then sent via GET HTTP to:\n```\nhttps://<C&C IP>/<working_folder>/Main.php?Data=<encrypted_data> with the User-Agent Microsoft Internet\nExplorer and then the loader gets the response from\nhttps://<C&C IP>/<working_folder>/buy/<hostname>.html .\n\n```\nIf the threat actor finds the victim machine interesting, the response from the server contains the next stage executable in encrypted\nform, in the same way the data is sent to the C&C server.\n\nTo verify the integrity of the received message, the loader uses the FNV-1A64 hash algorithm to check if the prefix of the decrypted\nmessage is `A257, and also calculates the MD5 of the message to makes sure it’s the same one as specified at the start of the message.`\n\n**Figure 5: Start of the decrypted response**\n\nIn the end, the loader loads the decrypted DLL to memory, starts its execution from the `StartW export function and notifies the server`\nabout the result of the operation.\n\n## The Loader\n\nTo ensure only one instance of the loader is running, the loader first creates an event named `9DJ8;;L;'4299FDS12JS and proceeds`\nwith the execution if the event did not exist before.\n\n\n-----\n\nFor anti-analysis purposes, the loader functionality is implemented as a shellcode, which is stored encrypted inside the binary. The\nloader decrypts the shellcode by XORing it with the 32 byte key:\n```\n[0x8a, 0x4e, 0xd1, 0xbb, 0xc4, 0xcc, 0x75, 0x3a, 0x4b, 0x5f, 0xe1, 0x99, 0x3a, 0x4b, 0x5f, 0x61, 0xd1, 0xbb,\n0xc4, 0x50, 0xe4, 0x99, 0x3a, 0x4b, 0xe4, 0x99, 0xcc, 0x75, 0x3a, 0xe4, 0x90, 0x8a], then loads the needed libraries\n\n```\nand passes the execution to the shellcode itself.\n\n**Figure 6: List of loaded libraries used for by shellcode to dynamically resolve**\n**API functions**\n\nAnother anti-analysis technique observed being used by the shellcode inside the loader is\ndynamic API resolving using the known hash method. This way, the loader is able to not\nonly hide its main functionality but also avoid static detection of suspicious API calls by\ndynamically resolving them instead of using static imports.\n\nThe decrypted shellcode contains a configuration that is used to obtain and correctly run the next stage. It includes the C&C server IP\nand port, as well as some other values that we will discuss later.\n\n\n-----\n\n**Figure 7: Malware configuration**\n\nOnce initialized, the shellcode sends the `CONNECT HTTP/1.1 message to the IP:port from the configuration and follows up with`\nanother message containing the identifier (in our case `admin ) XORed with a hardcoded 48-byte key. The received message is`\ndecrypted in the same way and the shellcode checks if it starts with the magic number: `0x11d4 . If the server returns valid data, the`\nloader runs several checks on its PE headers, load the backdoor to memory and executes an exported function named `MainThread .`\n\nThe loader DLL also contains a PE executable in a resource named `TXT . The executable is named` `SurvExe based on the PDB path`\nleft by the attacker:\n```\nC:\\Users\\user\\Desktop\\0814-surexe\\x64\\SurvExe\\x64\\Release\\SurvExe.pdb .\n\n```\nThis executable is supposed to be responsible for copying the file passed to it as a parameter to the `TEMP directory with the name`\n```\nOEJFISDOFJDLK . However, the resource is not used and seems to have been left by the attacker from previous malware versions.\n\n## The Backdoor\n\n```\nAs we discussed before, at the final stage of the infection chain the malicious loader is supposed to download, decrypt and load a DLL\nfile into memory. In theory, this plug-in architecture might be used to download and install any other module in addition to the\nbackdoor we received.\n\nThe backdoor module appears to be a custom and unique malware with the internal name `VictoryDll_x86.dll .`\n\nThe backdoor capabilities include the ability to:\n\nDelete/Create/Rename/Read/Write Files and get files attributes\nGet processes and services information\nGet screenshots\nPipe Read/Write – run commands through cmd.exe\nCreate/Terminate Process\nGet TCP/UDP tables\nGet CDROM drives data\n\n\n-----\n\nGet registry keys info\nGet titles of all top-level windows\nGet victim’s computer information – computer name, user name, gateway address, adapter data, Windows version (major/minor\nversion and build number) and type of user\nShutdown PC\n\n## C&C Communication\n\nFor the C&C communication, the backdoor uses the same configuration as the one from the previous step, which contains server IP and\nport.\n\nFirst, it sends to the server “Start conversation” ( 0x540 ) message XORed with hard-coded 256-byte key.\n\n**Figure 8: “Start conversation” request sent by the backdoor**\n\nThe server, in turn, returns the “Get Victim Information” ( 0x541 ) message and the new 256-byte key that will be used for all the\nsubsequent communication.\n\n\n-----\n\n**Figure 9: Response from C&C server**\n\nAll the subsequent communication with the C&C server has the following format:\n\n[ Size ] followed by XORed [ TypeID ] and [ Data ] (with 256-byte key).\n\nThe full list of commands and different types of messages between the C&C and the backdoor is provided in Appendix A.\n\n## Some History\n\n\n-----\n\nSearching for files similar to the final backdoor in the wild, we encountered a set of files that were submitted to VirusTotal in 2018. The\nfiles were named by the author as `MClient and appear to be part of a project internally called` `SharpM, according to their PDB paths.`\nCompilation timestamps also show a similar timeframe between July 2017 and June 2018, and upon examination of the files, they were\nfound to be older test versions of our `VictoryDll backdoor and its loaders chain.`\n\nThe numerous similarities include:\n\nThe specific implementation of the main backdoor functionality is identical;\n\nThe `SurvExe resource in the loader is very similar to one of the` `MClient ’s methods using the same event name pattern. Also,`\n```\n   SurvExe seems to have inherited the masquerading technique from MClient – both were internally named svchost.exe .\n\n```\n\n-----\n\n**Figure 10: SurvExe module code compared to MClient’s code (right)**\n\nThe connection method has the same format. Moreover, `MClient ’s connection XOR key and` `VictoryDll ‘s initial XOR key are`\nthe same (in fact, `VictoryDll ‘s XOR key is the expansion of this key to 256 bytes):`\n\n\n-----\n\n**Figure 11: MClient’s XOR key compared to VictoryDLL’s XOR key (right)**\n```\n   MClient contained an additional DLL called AutoStartup_DLL, whose purpose was to create the scheduled task called\n   Windows Update – a functionality which in our campaign was delegated to the RTF exploit.\n\n## Same but Different\n\n```\nThe backdoor has also undergone some changes in the architecture, functionality and naming:\n\nDifferent export function names: in our backdoor, the exported function is named `MainThread while in all versions of the`\n```\n   MClient variant the export function was named GetCPUID .\n\n```\nSame configuration fields, but the different obfuscation used. In the later version, the configuration is a part of the encrypted\nshellcode inside the loader, whereas in `MClient the configuration is hardcoded in the backdoor XORed with the byte` `0x56 or,`\nin some test versions, not obfuscated at all.\n\n\n-----\n\n```\n   MClient has an additional persistence mechanism besides the scheduled task the VictoryDll has in its infection chain: in case\n\n```\nof low privileges, on Windows 10, or having Kaspersky installed on the victim’s computer, `MClient adds itself to`\n```\n   SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run registry with the name Intel USB3 Driver .\n   MClient versions from 2018 contain the code that bypasses UAC using exe. In VictoryDll this function doesn’t exist\n\n```\nanymore; instead of that, the code only tries to get the user’s privileges by attempting to open the file `C:\\Windows\\l and`\nchecking the result of this operation.\nThe `MClient version from January 2018 ( aa5458bdfefe2a97611bb0fd9cf155a06f88ef5d ) also contained a keylogger`\nfunctionality which has since been removed in the subsequent test versions and not present in `VictoryDll .`\n\nOverall, we can see that in these 3 years, most of the functionality of `MClient and` `AutoStartup_DLL was preserved and split`\nbetween multiple components – probably to complicate the analysis and decrease the detection rates at each stage. We may also assume\nthat there exist other modules based on the code from 2018 that might be installed by the attacker in the later stages of the attack.\n\n## Infrastructure\n\nFirst stage C&C servers are hosted by 2 different cloud services, located in Asia (Hong Kong and Malaysia). The backdoor C&C server,\n```\n107.148.165[.]151, is hosted on Zenlayer, a US-based provider which is widely used for C&C purposes by multiple threat actors.\n\n```\nThe threat actor operates the C&C servers in a limited daily window, making it harder to gain access to the advanced parts of the\ninfection chain. Specifically, it returned the next stage payloads only during 01:00 – 08:00 UTC on workdays.\n\nAt some point in the research, one of the attacker’s servers that served the loader component had directory listing enabled for a limited\ntime. In addition to that, the `Main.php file was served without processing and revealed a piece of PHP code whose purpose was to log`\nall the incoming requests with the date, IP address and decrypted data to `log.txt`\n\n**Figure 12: File listing on the server**\n\n\n-----\n\n**Figure 13: Fragment of the simple PHP code that logs the requests, found on the server**\n\n## Attribution\n\nWe attribute this cluster of activity to a Chinese threat group with medium to high confidence, based on the following artifacts and\nindicators:\n\n\n-----\n\nThe RoyalRoad RTF exploit building kit mentioned above, has been reported by numerous researchers as a tool of choice among\nChinese APT groups.\n\nThe C&C servers returned payloads only between 01:00 – 08:00 UTC, which we believe are the working hours in the attackers’\ncountry, therefore the range of possible origins of this attack is limited.\n\nThe C&C servers did not return any payload (even during working hours), specifically the period between May 1st and 5 – thisth\n[was when the Labor Day holidays in China took place.](https://publicholidays.cn/2021-dates/)\n\n[Some test versions of the backdoor contained internet connectivity check with www.baidu.com – a leading Chinese website.](https://www.baidu.com/)\n\nSome test versions of the backdoor from 2018 were uploaded to VirusTotal from China.\n\n**Figure 14: Submissions for test backdoors (f8088c15f9ea2a1e167d5fa24b65ec356939ba91 and**\n**7a38ae6df845def6f28a4826290f1726772b247e)**\n\nWhile we could identify overlaps in TTPs with multiple Chinese APT groups, we have been unable to attribute this set of activities to any\nknown group.\n\n## Conclusion\n\n\n-----\n\nWe unveiled the latest activity of what seems to be a long-running Chinese operation that managed to stay under the radar for more\nthan 3 years. In this campaign, the attackers utilized the set of Microsoft Office exploits and loaders with anti-analysis and antidebugging techniques to install a previously unknown backdoor.\n\nAnalyzing the backdoor’s code evolution since its first appearance in the wild showed how it transformed from a single executable to a\nmulti-stage attack, making it harder to detect and investigate.\n\n[Check Point Threat Emulation blocks this attack from the very first step.](https://www.checkpoint.com/infinity-vision/zero-day-protection/)\n\n## Appendix A: Backdoor Commands\n\n**Message Type** **Type ID** **Arguments** **Source**\n\n**Send victim’s information** 0x2 Info Victim\n\n**CDROM drives data** 0x4 – / Drives data Both\n\n**Get Files data** 0x5/0x6 Path / Files data Both\n\n**Create Process** 0x7 Command Line C&C server\n\n**Rename File** 0x8 Old filename, New filename C&C server\n\n**Delete File** 0x9 Filename C&C server\n\n\n-----\n\n**Read File** 0xa Filename, Offset / File’s content Both\n\n**Exit Pipe** 0xb – C&C server\n\n**Create Pipe** 0xc – C&C server\n\n**Write To Pipe** 0xd Buffer C&C server\n\n**Get Uninstalled software data** 0xe – / Software data Both\n\n**Get windows text** 0xf – / Windows text Both\n\n**Get active processes data** 0x10 – / Processes data Both\n\n**Terminate Process** 0x11 Process ID C&C server\n\n**Get screenshot** 0x12/0x13 – / Screenshot temp file Both\n\n**Get services data** 0x14 – / Services data Both\n\n**Get TCP/UDP tables** 0x15 – / Tables data Both\n\n**Get registry key data** 0x16 Registry path / Reg data Both\n\n\n-----\n\n**Shutdown** 0x17 – C&C server\n\n**Exit process** 0x18 – C&C server\n\n**Restart current process** 0x19 – C&C server\n\n**Write to file** 0x4C7 Filename, Buffer C&C server\n\n**Start Connection** 0x540 Zero Byte Victim\n\n**Get victim’s information/Update XOR key** 0x541 New XOR key / Victim’s info Both\n\n**None** 0x120E – C&C server\n\n**Ack** 0x129D3 Name (‘admin’ in our case) Victim\n\n## Appendix B: Indicators of Compromise\n\n**Documents**\n```\n278c4fc89f8e921bc6c7d015e3445a1cc6319a66\n42be0232970d5274c5278de77d172b7594ff6755\nf9d958c537b097d45b4fca83048567a52bb597bf\nfefec06620f2ef48f24b2106a246813c1b5258f4\n548bbf4b79eb5a173741e43aa4ba17b92be8ed3a\n417e4274771a9614d49493157761c12e54060588\n\n```\n\n-----\n\n**Executables**\n```\n03a57262a2f3563cf0faef5cde5656da437d58ce 5.t\n388b7130700dcc45a052b8cd447d1eb76c9c2c54 5.t\n176a0468dd70abe199483f1af287e5c5e2179b8c 5.t\n01e1913b1471e7a1d332bfc8b1e54b88350cb8ad loader\n8bad3d47b2fc53dc6f9e48debac9533937c32609 ServExe (x64)\n0a588f02e60de547969d000968a458dcdc341312 VictoryDll\n\n```\n**C&C servers**\n```\n45.91.225[.]139\n107.148.165[.]151\n45.121.146[.]88\n\n```\n**Old backdoor versions**\n\n**MClient:**\n```\naa5458bdfefe2a97611bb0fd9cf155a06f88ef5d\n4da26e656ef5554fac83d1e02105fad0d1bd7979\nf8088c15f9ea2a1e167d5fa24b65ec356939ba91\n0726e56885478357de3dce13efff40bfba53ddc2\n7855a30e933e2b5c3db3661075c065af2e40b94e\n696a4df81337e7ecd0ea01ae92d8af3d13855c12\nabaaab07985add1771da0c086553fef3974cf742\n7a38ae6df845def6f28a4826290f1726772b247e\n\n```\n**Autostart_DLL:**\n```\ne16b08947cc772edf36d97403276b14a5ac966d0\nc81ba6c37bc5c9b2cacf0dc53b3105329e6c2ecc\na96dfbad7d02b7c0e4a0244df30e11f6f6370dde\n6f5315f9dd0db860c18018a961f7929bec642918\n\n## Appendix C: MITRE ATT&CK Matrix\n\n```\n\n-----\n\n**Tactic** **Technique** **Technique Name**\n\nInitial Access T1566.001 Phishing: Spearphishing Attachment\n\nExecution T1204.002 User Execution: Malicious File\n\nT1203 Exploitation for Client Execution\n\nT1059.003 Execution Command and Scripting Interpreter: Windows Command Shell\n\nPersistence T1053 Scheduled Task/Job\n\nDefense Evasion T1027 Obfuscated Files or Information\n\nT1221 Template Injection\n\nDiscovery T1082 System Information Discovery\n\nT1518 Software Discovery\n\nT1057 Process Discovery\n\nT1012 Query Registry\n\nT1007 System Service discovery\n\n\n-----\n\nT1081 File and Directory Discovery\n\nT1010 Application Window Discovery\n\nCollection T1113 Screen Capture\n\nT1005 Data from Local System\n\nCommand and Control T1132 Data Encoding\n\nT1104 Multi-Stage Channels\n\nT1071.001 Application Layer Protocol: Web Protocols\n\nT1573.001 Encrypted Channel: Symmetric Cryptography\n\nExfiltration T1041 Exfiltration Over C2 Channel\n\nImpact T1529 System Shutdown/Reboot\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2021/2021.06.03.SharpPanda_APT/SharpPanda_%20Chinese%20APT%20Group%20Targets%20Southeast%20Asian%20Government%20With%20Previously%20Unknown%20Backdoor%20-%20Check%20Point%20Research.pdf"
    ],
    "report_names": [
        "SharpPanda_ Chinese APT Group Targets Southeast Asian Government With Previously Unknown Backdoor - Check Point Research"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "8a3bd03a-f69b-455b-b88b-3842a3528bfd",
            "created_at": "2022-10-25T16:07:24.178007Z",
            "updated_at": "2025-03-27T02:02:10.132529Z",
            "deleted_at": null,
            "main_name": "SharpPanda",
            "aliases": [
                "Sharp Dragon",
                "SharpPanda"
            ],
            "source_name": "ETDA:SharpPanda",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Agentemis",
                "Cobalt Strike",
                "CobaltStrike",
                "RoyalRoad",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e7ef34b6-e7b6-46f3-8dd8-2708c1659cd6",
            "created_at": "2023-11-08T02:00:07.107758Z",
            "updated_at": "2025-03-27T02:00:03.182575Z",
            "deleted_at": null,
            "main_name": "SharpPanda",
            "aliases": [],
            "source_name": "MISPGALAXY:SharpPanda",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716496,
    "ts_updated_at": 1743041420,
    "ts_creation_date": 1623135764,
    "ts_modification_date": 1623135764,
    "files": {
        "pdf": "https://archive.orkl.eu/06d0aec6c9a8aa4ef0a72f17d82006471f34d427.pdf",
        "text": "https://archive.orkl.eu/06d0aec6c9a8aa4ef0a72f17d82006471f34d427.txt",
        "img": "https://archive.orkl.eu/06d0aec6c9a8aa4ef0a72f17d82006471f34d427.jpg"
    }
}