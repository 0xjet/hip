{
    "id": "f1f55101-5028-47af-9e5a-7cee63958473",
    "created_at": "2022-10-25T16:48:14.232142Z",
    "updated_at": "2025-03-27T02:06:04.117486Z",
    "deleted_at": null,
    "sha1_hash": "7cb839427c1ed6c815f18b2677b905128b34e09c",
    "title": "Spear Phishing Techniques Used in Attacks Targeting the Mongolian Government",
    "authors": "FireEye",
    "file_creation_date": "2017-02-23T14:02:03Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 609256,
    "plain_text": "# Mongolian Government\n\n**fireeye.com/blog/threat-research/2017/02/spear_phishing_techn.html**\n\n## Introduction\n\nFireEye recently observed a sophisticated campaign targeting individuals within the Mongolian government.\nTargeted individuals that enabled macros in a malicious Microsoft Word document may have been infected with\n[Poison Ivy, a popular remote access tool (RAT) that has been used for nearly a decade for key logging, screen and](https://www.fireeye.com/content/dam/fireeye-www/global/en/current-threats/pdfs/rpt-poison-ivy.pdf)\nvideo capture, file transfers, password theft, system administration, traffic relaying, and more. The threat actors\nbehind this attack demonstrated some interesting techniques, including:\n\n1. **Customized evasion based on victim profile – The campaign used a publicly available technique to evade**\n\nAppLocker application whitelisting applied to the targeted systems.\n\n2. **Fileless execution and persistence – In targeted campaigns, threat actors often attempt to avoid writing an**\n\nexecutable to the disk to avoid detection and forensic examination. The campaign we observed used four\nstages of PowerShell scripts without writing the the payloads to individual files.\n\n3. **Decoy documents – This campaign used PowerShell to download benign documents from the Internet and**\n\nlaunch them in a separate Microsoft Word instance to minimize user suspicion of malicious activity.\n\n## Attack Cycle\n\nThe threat actors used social engineering to convince users to run an embedded macro in a Microsoft Word\ndocument that launched a malicious PowerShell payload.\n\nThe threat actors used two publicly available techniques, an AppLocker whitelisting bypass and a script to inject\nshellcode into the userinit.exe process. The malicious payload was spread across multiple PowerShell scripts,\nmaking its execution difficult to trace. Rather than being written to disk as individual script files, the PowerShell\npayloads were stored in the registry.\n\nFigure 1 shows the stages of the payload execution from the malicious macro.\n\n\n-----\n\nFigure 1: Stages of payload execution used in this attack\n\n## Social Engineering and Macro-PowerShell Level 1 Usage\n\nTargets of the campaign received Microsoft Word documents via email that claimed to contain instructions for\nlogging into webmail or information regarding a state law proposal.\n\nWhen a targeted user opens the malicious document, they are presented with the messages shown in Figure 2,\nasking them to enable macros.\n\n\n-----\n\nFigure 2: Lure suggesting the user to enable Macros to see content\n\n## Bypassing Application Whitelisting Script Protections (AppLocker)\n\nMicrosoft application whitelisting solution AppLocker prevents unknown executables from running on a system. In\n[April 2016, a security researcher demonstrated a way to bypass this using regsvr32.exe, a legitimate Microsoft](https://github.com/subTee/SCTPersistence/blob/master/Backdoor.sct)\nexecutable permitted to execute in many AppLocker policies. The regsvr32.exe executable can be used to download\na Windows Script Component file (SCT file) by passing the URL of the SCT file as an argument. This technique\nbypasses AppLocker restrictions and permits the execution of code within the SCT file.\n\nWe observed implementation of this bypass in the macro code to invoke regsvr32.exe, along with a URL passed to\nit which was hosting a malicious SCT file, as seen in Figure 3.\n\n\n-----\n\nFigure 3: Command after de-obfuscation to bypass AppLocker via regsv32.exe\n\nFigure 4 shows the entire command line parameter used to bypass AppLocker.\n\nFigure 4: Command line parameter used to bypass AppLocker\n\nWe found that the malicious SCT file invokes WScript to launch PowerShell in hidden mode with an encoded\ncommand, as seen in Figure 5.\n\nFigure 5: Content of SCT file containing code to launch encoded PowerShell\n\n## Decoding SCT: Decoy launch and Stage Two PowerShell\n\nAfter decoding the PowerShell command, we observed another layer of PowerShell instructions, which served two\npurposes:\n\n1.   There was code to download a decoy document from the Internet and open it in a second winword.exe process\nusing the Start-Process cmdlet. When the victim enables macros, they will see the decoy document shown in Figure\n6. This document contains the content described in the spear phishing email.\n\n\n-----\n\nFigure 6: Decoy downloaded and launched on the victim’s screen\n\n2.   After launching the decoy document in the second winword.exe process, the PowerShell script downloads and\nruns another PowerShell script named f0921.ps1 as shown in Figure 7.\n\nFigure 7: PowerShell to download and run decoy decoy document and third-stage payload\n\n## Third Stage PowerShell Persistence\n\nThe third stage PowerShell script configures an encoded PowerShell command persistently as base64 string in the\nHKCU: \\Console\\FontSecurity registry key. Figure 8 shows a portion of the PowerShell commands for writing this\nvalue to the registry.\n\n\n-----\n\nFigure 8: Code to set registry with encoded PowerShell script\n\nFigure 9 shows the registry value containing encoded PowerShell code set on the victims’ system.\n\nFigure 9: Registry value containing encoded PowerShell script\n\nFigure 10 shows that using Start-Process, PowerShell decodes this registry and runs the malicious code.\n\nFigure 10: Code to decode and run malicious content from registry\n\nThe third stage PowerShell script also configures another registry value named\nHKCU\\CurrentVersion\\Run\\SecurityUpdate to launch the encoded PowerShell payload stored in the HKCU:\n\\Console\\FontSecurity key. Figure 11 shows the code for these actions. This will execute the PowerShell payload\nwhen the user logs in to the system.\n\n\n-----\n\n## Fourth Stage PowerShell Inject-LocalShellCode\n\nThe HKCU\\Console\\FontSecurity registry contains the fourth stage PowerShell script, shown decoded in Figure 12.\n[This script borrows from the publicly available Inject-LocalShellCode PowerShell script from PowerSploit to inject](https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-Shellcode.ps1)\nshellcode.\n\nFigure 12: Code to inject shellcode\n\n## Shellcode Analysis\n\nThe shellcode has a custom XOR based decryption loop that uses a single byte key (0xD4), as seen in Figure 13.\n\n\n-----\n\nFigure 13: Decryption loop and call to decrypted shellcode\n\nAfter the shellcode is decrypted and run, it injects a Poison Ivy backdoor into the userinit.exe as shown in Figure 14.\n\n\n-----\n\nFigure 14: Code injection in userinit.exe and attempt to access Poison Ivy related DAT files\n\nIn the decrypted shellcode, we also observed content and configuration related to Poison Ivy. Correlating these\nbytes to the standard configuration of Poison Ivy, we can observe the following:\n\nActive setup – StubPath\n\nEncryption/Decryption key - version2013\n\nMutex name - 20160509\n\nThe Poison Ivy configuration dump is shown in Figure 15.\n\n\n-----\n\nFigure 15: Poison Ivy configuration dump\n\n## Conclusion\n\nAlthough Poison Ivy has been a proven threat for some time, the delivery mechanism for this backdoor uses recent\npublicly available techniques that differ from previously observed campaigns. Through the use of PowerShell and\npublicly available security control bypasses and scripts, most steps in the attack are performed exclusively in\nmemory and leave few forensic artifacts on a compromised host.\n\nFireEye HX Exploit Guard is a behavior-based solution that is not affected by the tricks used here. It detects and\nblocks this threat at the initial level of the attack cycle when the malicious macro attempts to invoke the first stage\nPowerShell payload. HX also contains generic detections for the registry persistence, AppLocker bypasses and\nsubsequent stages of PowerShell abuse used in this attack.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/sgzri8xt5l6gaodokuvvfjt7emzu0z4o"
    ],
    "report_names": [
        "Fireeye_SpearPhishing-Targeting-Mongolian-Government(02-22-2017)"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716494,
    "ts_updated_at": 1743041164,
    "ts_creation_date": 1487858523,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/7cb839427c1ed6c815f18b2677b905128b34e09c.pdf",
        "text": "https://archive.orkl.eu/7cb839427c1ed6c815f18b2677b905128b34e09c.txt",
        "img": "https://archive.orkl.eu/7cb839427c1ed6c815f18b2677b905128b34e09c.jpg"
    }
}