{
    "id": "87acf6e2-e525-4df0-800a-f3c7bbc6bf42",
    "created_at": "2023-05-06T02:08:30.994088Z",
    "updated_at": "2025-03-27T02:05:25.578552Z",
    "deleted_at": null,
    "sha1_hash": "8227a54e01f300769a5287c38bc27cb10971549f",
    "title": "2023-03-31 - 3CX Supply Chain Attack Campaign Campaign Analysis",
    "authors": "",
    "file_creation_date": "2023-05-05T01:44:27Z",
    "file_modification_date": "2023-05-05T01:44:27Z",
    "file_size": 3053959,
    "plain_text": "# 3CX supply chain attack analysis\n\n**[zscaler.com/security-research/3CX-supply-chain-attack-analysis-march-2023](https://www.zscaler.com/security-research/3CX-supply-chain-attack-analysis-march-2023)**\n\n[On March 29th 2023, CrowdStrike published a blog outlining a supply chain attack](https://www.crowdstrike.com/blog/crowdstrike-detects-and-prevents-active-intrusion-campaign-targeting-3cxdesktopapp-customers/)\nleveraging the 3CXDesktopApp - a softphone application from 3CX. The ThreatLabz Team\nimmediately started hunting for IoCs on the Zscaler Cloud.\n\nWe observed infections dating back to February 2023 for both the Windows as well as the\nMacOS variant of the Trojanized 3CXDesktopApp installers.\n\n_Fig.1 - Infections dating back to February 2023 in Zscaler Cloud_\n\nIn this case the Threat Actors targeted various industry verticals such as:\n\nTechnology\nServices\nManufacturing and more\n\nFurther let’s analyze the Infection Chain for the 3CX Supply Chain Attack:\n\n## Infection Chain:\n\n_Fig.2 - Infection Chain_\n\n\n-----\n\nThe Infection chain begins with the software update routine where the 3CXDesktopApp\ncalls the “Update.exe --update <3cx_update_url>” from its bundle to fetch the updates. This\nthen downloads the valid signed Malicious 3CX MSI installer and the Affected 3CX MAC\nApplication as required in the form of an update package on the victim's machine as shown\nin the screenshot below.\n\n_Fig.3 - Requests to 3CX domain to download the Affected 3CX MSI installer v18.12.416 &_\n_3CX Mac App v18.12.416 as an Update Package_\n\nIn this blog, we will take a look at the affected valid signed 3CX MSI Installer version\n18.12.416 named “3CXDesktopApp-18.12.416.msi” which is signed on March 13, 2023.\n\n_Fig.4 - Signed 3CX MSI Installer_\n\n\n-----\n\nUpon execution the 3CX MSI installer extracts multiple files in the\n“AppData\\Local\\Programs\\3CXDesktopApp” and then executes the valid signed\n**3CXDesktopApp.exe as shown below in the screenshot.**\n\n_Fig.5 - Execution of 3CXDesktopApp_\n\nFurther the 3CXDesktopApp.exe side loads the Backdoored signed DLL named “ffmpeg.dll”\nas based on the DLL search order mechanism if the DLL is present in the applications\ndirectory the DLL is loaded from there as shown in the screenshot.\n\n\n-----\n\n_Fig.6 - 3CXDesktopApp sideloads the Backdoored “ffmpeg.dll”_\n\nBased on reports, the ffmpeg.dll was backdoored by the Threat Actors via manipulating the\nsource code leading to the Supply Chain Attack. Once loaded into the virtual memory, the\nmalicious “ffmpeg.dll” is commissioned to load the d3dcompiler_47.dll which contains the\nencrypted second stage payload. Initially the main function creates an event called\n\"AVMonitorRefreshEvent\" and checks if it already exists. If it does, it exits.\n\n_Fig.7 - Main function of ffmpeg.dll_\n\n\n-----\n\nAfter that it checks the current path in order to load the d3dcompiler_47.dll into memory and\nfurther loads the DLL into memory and checks if the DLL loaded correctly by comparing the\nstarting byte of DLL.\n\n_Fig.8 - Load d3dcompiler_47.dll and check for starting byte of DLL_\n\nIn this case the d3dcompiler_47.dll consisting of the RC4 encrypted shellcode and\nembedded DLL is valid signed by the Microsoft Digital certificate as shown in the\nscreenshot below.\n\n_Fig.9 - Microsoft signed d3dcompiler_47.dll_\n\n\n-----\n\nFurther in the infection chain, the ffmpeg.dll looks for the specific hex byte (FE ED FA CE)\nin the loaded d3dcompiler_47.dllwhich contains a second stage encrypted payload.\n\n_Fig.10 - Look for specific hex byte (FE ED FA CE) in loaded d3dcompiler_47.dll_\n\nAfter it locates the specific hex in loaded d3dcompiler_47.dll, it uses the RC4 decryption\nwith the key “3jB(2bsG#@c7” to decrypt the second stage payload which is a shellcode\nwith embedded DLL. The shellcode is responsible for calling the export function\n**“DllGetClassObject” of the second stage DLL to execute and download further stage**\npayload.\n\n\n-----\n\n_Fig.11 - Decryption of second stage payload_\n\n\n-----\n\n_Fig.12 - Decrypted second stage payload_\n\nThe Stage-2 DLL further downloads the Icon file from the following Github repository as\nshown below. We observed in some cases that the second stage decrypted DLL would\nsleep for more than 7 days before communicating with the C2 server.\n\n_Fig.13 - Second Stage payload downloads icon files from GitHub Repository_\n\nThe github repository consists of multiple icon files as shown below. These icons are been\ndownloaded by the Stage-2 DLL.\n\n\n-----\n\n_Fig.14 - Github Repository hosting multiple icon files._\n\nFurther the Stage-2 DLL reads the icon file and parses the encrypted string present at the\nend of the downloaded icon file and passes it to the ico_decryption() function.\n\n_Fig.15 - Parsing of the Encrypted string in the ICON File_\n\nThe encrypted string from the icon file is base64 decoded and then passed to a decryption\nroutine as shown below in the screenshot.The decrypted string in this case is the C2 URL:\n**https[:]//glcloudservice[.]com/v1/console**\n\n\n-----\n\n_Fig.16 - Decryption of C2 URL from the encrypted string parsed via the ICON File_\n\nFurther the malware performs HTTPS requests to the C2 URL as shown in the screenshot\nbelow from the Zscaler Cloud.\n\n_Fig.17 - HTTPS Requests to the C2 URL seen in the Zscaler Cloud_\n\nAt the time of analysis the C2 Domains were down. The expected response would be in\nJSON format consisting of encrypted data which is then decrypted by the decryption routine\nbefore the final payload is executed on the infected machine.\n\nBased on the [blog published by Sentinel One, the final payload delivered on the target](https://www.sentinelone.com/blog/smoothoperator-ongoing-campaign-trojanizes-3cx-software-in-software-supply-chain-attack/)\nmachines in the supply chain attack was an Infostealer with capabilities such as collecting\nsystem information and browser information such as saved credentials from the Brave,\n\n\n-----\n\nChrome, Edge, and Firefox\n\n## Affected 3CX Versions:\n\nFollowing are the affected versions [announced by 3CX:](https://www.3cx.com/blog/news/desktopapp-security-alert/)\n\nAffected 3CX Electron Windows App Versions:\n\n18.12.416\n18.12.407\n\nAffected Electron Mac App versions:\n\n18.11.1213\n18.12.402\n18.12.407\n18.12.416\n\n## IoCs:\n\n**File Name** **Md5**\n\n3CXDesktopApp-18.12.416.msi 0eeb1c0133eb4d571178b2d9d14ce3e9\n\n3CXDesktopApp.exe 704db9184700481a56e5100fb56496ce\n\nffmpeg.dll cb01ff4809638410a531400a66376fa3\n\nd3dcompiler_47.dll 82187ad3f0c6c225e2fba0c867280cc9\n\n## C2 Domains:\n\nakamaicontainer[.]com\n\nakamaitechcloudservices[.]com\n\nazuredeploystore[.]com\n\n\n-----\n\nazureonlinecloud[.]com\n\nazureonlinestorage[.]com\n\ndunamistrd[.]com\n\nglcloudservice[.]com\n\njournalide[.]org\n\nmsedgepackageinfo[.]com\n\nmsstorageazure[.]com\n\nmsstorageboxes[.]com\n\nofficeaddons[.]com\n\nofficestoragebox[.]com\n\npbxcloudeservices[.]com\n\npbxphonenetwork[.]com\n\npbxsources[.]com\n\nqwepoi123098[.]com\n\nsbmsa[.]wiki\n\nsourceslabs[.]com\n\nvisualstudiofactory[.]com\n\nzacharryblogs[.]com\n\n\n-----\n\nmsedgeupdate[.]net\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-03-31 - 3CX Supply Chain Attack Campaign Campaign Analysis.pdf"
    ],
    "report_names": [
        "2023-03-31 - 3CX Supply Chain Attack Campaign Campaign Analysis.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1683338910,
    "ts_updated_at": 1743041125,
    "ts_creation_date": 1683251067,
    "ts_modification_date": 1683251067,
    "files": {
        "pdf": "https://archive.orkl.eu/8227a54e01f300769a5287c38bc27cb10971549f.pdf",
        "text": "https://archive.orkl.eu/8227a54e01f300769a5287c38bc27cb10971549f.txt",
        "img": "https://archive.orkl.eu/8227a54e01f300769a5287c38bc27cb10971549f.jpg"
    }
}