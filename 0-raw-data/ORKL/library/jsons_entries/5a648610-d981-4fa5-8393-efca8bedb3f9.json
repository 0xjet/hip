{
    "id": "5a648610-d981-4fa5-8393-efca8bedb3f9",
    "created_at": "2024-06-27T02:03:25.507066Z",
    "updated_at": "2025-03-27T02:05:29.4004Z",
    "deleted_at": null,
    "sha1_hash": "f80f177f30225e253af35811874266fada886ecf",
    "title": "",
    "authors": "",
    "file_creation_date": "0001-01-01T00:00:00Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 347065,
    "plain_text": "# 悪意のある OneNote\n\n サンプルのペイロードの傾向\n\n## 概要\n\n本稿は、攻撃者らが Microsoft OneNote\n\n[ファイルを悪用するさいに使う埋め込みペイロードの種類について取り上げます。私たちが WildFire から得た約 6,000 件の悪質な](https://www.paloaltonetworks.jp/products/secure-the-network/wildfire)\n\nOneNote\n\nサンプルを分析したところ、これらのサンプルにはフィッシングに似たテーマが存在することが明らかになりました。これらのサ\n\nンプルでは、攻撃者らが、1 つ以上の画像を使ってユーザーに OneNote\n\nファイルをクリックまたは操作させようとします。その後、そうしたやり取りが埋め込まれた悪意のあるペイロードを実行します\n\n。\n\n[Office ではマクロがデフォルトで無効になっていますので、攻撃者らはほかの Microsoft](https://learn.microsoft.com/ja-jp/deployoffice/security/internet-macros-blocked)\n\n製品を使って悪意のあるペイロードを埋め込むようになってきました。この結果、悪意のある OneNote\n\nファイルの人気が高まっています。OneNote のデスクトップ アプリは Windows では Office 2019 および Microsoft 365\n\nにデフォルトで含まれています。このため、誰かがうっかり OneNote ファイルを開くと、悪意のある OneNote\n\nファイルが読み込まれてしまうおそれがあります。\n\n私たちは、攻撃者らが OneNote 内にテキストベースの悪意のあるスクリプトやバイナリー\n\nファイルを自由に埋め込めることを確認しました。これにより、従来のドキュメント内マクロに比べた柔軟性が高まります。\n\nパロアルトネットワークスのお客さまは、以下の製品を通じて、上記の脅威からより強力に保護されています。\n\n### WildFire を含むクラウド配信セキュリティサービスを有効にした次世代ファイアウォール\n\n WildFire を含むクラウド配信セキュリティ サービスを有効にした Prisma Access デバイス\n\n\n-----\n\n### Cortex XDR および Cortex XSIAM\n\n エージェントは多層保護のアプローチにより、エクスプロイト後のアクティビティからの保\n\n 護に役立ちます。\n\n Unit 42 のインシデント レスポンス チーム\n\n も、侵害を受けた場合の支援や、お客さまのリスク低減のための事前サイバーセキュリティ\n\n 準備状況評価を行っています。\n\n#### 関連する Unit 42\n\n Microsoft, Phishing\n\n のトピック\n\n## 背景\n\nMicrosoft OneNote は Microsoft Office スイートに含まれるデジタル ノートブックのアプリケーションです。OneNote\n\nファイルにはメモを取るほかにもさまざまな種類の情報を保存することができます。\n\nMicrosoft OneNote\n\nには外部ファイルを埋め込むこともでき、ビデオや画像、さらにはスクリプトや実行可能ファイルなどのファイルも格納できます\n\n[。ただし、Microsoft は特定の拡張子を持つ埋め込みオブジェクトのブロックを開始しています。](https://learn.microsoft.com/ja-jp/deployoffice/security/onenote-extension-block#extensions-that-are-considered-dangerous)\n\nこのブロックの対象となるのは、Windows の Microsoft 365 上で実行されている OneNote\n\nファイル内にあると危険と見なされる拡張子です。\n\nそれでも、攻撃者が悪意のあるペイロードを埋め込んで、オブジェクトを埋め込み機能を悪用することはよくあります。悪意のあ\n\nる OneNote サンプルは通常、画像やボタンを含む正当なノートのふりをします。\n\n攻撃者らは画像でユーザーの注意を引き、それと知らずにボタンをクリックして悪意のあるペイロードを起動するのを待っていま\n\nす。ユーザーが正規ノート作成アプリケーションに寄せる信頼を逆手にとれることから、この手法はペイロード配信によく使われ\n\nています。\n\n図 1〜3 は、さまざまな種類の埋め込み画像やボタンをもつ 3 種類の悪意のある OneNote\n\nサンプルを示しています。偽のボタンの上にマウス オーバーすると、OneNote\n\nファイルに埋め込まれたペイロードの場所や種類を確認できます。\n\n|関連する Unit 42 のトピック|Microsoft, Phishing|\n|---|---|\n\n\n-----\n\n図 1 では、悪意のある OneNote サンプルが被害者に対し 保護されたドキュメントを表示するには [View]\n\nボタンをクリックしてください」と要求しています。クリックすると悪意のある VBScript ファイルが実行されます。\n\n### 画像 1 は、内容の一部をモザイクで処理してある Microsoft OneNote ページのスクリーンショットです。Image not found or type unknown 図 1. 悪意のある VBS が埋め込まれた OneNote サンプル\n\n同様に、図 2 と図 3 も偽のボタンを含む悪意のある OneNote ドキュメントを示したものです。それぞれ、埋め込まれた EXE\n\nペイロードや Office 97-2003 ペイロードを被害者が実行するように仕向けています。\n\n### 画像 2 は Microsoft OneNote のスクリーンショットです。青色の「CLICK TO VIEW DOCUMENT (クリックImage not found or type unknown 図 2. 悪意のある EXE ファイルが埋め込まれた OneNote サンプル\n\n 画像 3 は、内容の一部をモザイクで処理してある Microsoft OneNote ページのスクリーンショットです。Image not found or type unknown 図 3. 悪意のある Office 97-2003 ファイルが埋め込まれた OneNote サンプル\n\n## 方法論\n\n前述のように、攻撃者は主に OneNote\n\nファイルを悪意のあるペイロードの配信に悪用します。これを行うにあたり、彼らは次のような特定のペイロードの種類をいくつ\n\nか埋め込む傾向があります。\n\n### JavaScript\n\n VBScript\n\n PowerShell\n\n HTML アプリケーション (HTA)\n\nファイルの種類こそ異なりますが、これらのペイロードは多くの場合、似たような振る舞いを呈し、似たような悪意のある目標の\n\n[達成を狙っています。ただし、攻撃の全体像や感染チェーンについてはすでに悪意のある OneNote 添付ファイル](https://www.paloaltonetworks.com/blog/security-operations/the-adventures-of-malicious-onenote-attachments-in-cortex-xdr-land/)\n\nについての記事で取り上げているので、ここで詳しくは触れません。\n\n悪意のある OneNote ファイルであることを示す明らかな兆候は、埋め込みオブジェクトの存在です。無害な OneNote\n\nファイルにも埋め込みオブジェクトが含まれる場合はありますが、悪意のある OneNote\n\nファイルの場合、ほぼ必ずといってよいほど埋め込みオブジェクトが含まれています。\n\n\n-----\n\n[Microsoft によると、OneNote に埋め込まれたファイルは、特定のグロ](https://learn.microsoft.com/ja-jp/openspecs/office_file_formats/ms-one/73d22548-a613-4350-8c23-07d15576be50) バル 意識別子 (GUID) タグで始まります。\n```\n   {BDE316E7-2665-4511-A4C4-8D4D0B7A9EAC}\n\n```\nこの GUID は、FileDataStoreObject オブジェクトの存在を示しています。この GUID\n\nの後ろには、埋め込まれたファイルのサイズが続きます。\n\n実際の埋め込みファイルは、前述の GUID タグの 20\n\nバイト後から始まり、定義されたサイズと同じ長さを持ちます。その例を下の図 4 に示します。\n\n### 1 つめの赤い四角形は埋め込みオブジェクトの GUID タグを表しています。\n\n 2 つめの赤い四角形は、埋め込まれたオブジェクトのサイズを示しています。\n\n 3 つめの赤い四角形は、実際の埋め込みオブジェクトを表しています。\n\n 画像 4 は、OneNote ファイルに埋め込まれたオブジェクトです。3 つの異なる領域を赤でかこって強調表Image not found or type unknown 図 4. OneNote ファイル内の埋め込みオブジェクトの識別\n\n## ペイロードの種類と平均サイズの分布\n\n図 5 に示すように、攻撃者は主に次の 7 種類のファイルを OneNote ペイロードに使います。\n\n### PowerShell\n\n VBScript\n\n Batch\n\n HTA\n\n Office 97-2003\n\n EXE\n\n JavaScript (このファイルタイプが最もよく使われる)\n\n 画像 5 は、悪意のあるファイル内のペイロードの種類を示す円グラフです。最も多いのは JavaScript で 4Image not found or type unknown 図 5. 悪意のある OneNote ファイルに埋め込まれたペイロードの種類の分布\n\n\n-----\n\n図 6 に示すように、私たちは各ペイロ ドの種類のサイズも抽出して記録しました。\n\n### 図 6 は、ペイロードの種類の分布をサイズ別に示した棒グラフです。EXE のサイズが 1,000 KB を超えておImage not found or type unknown 図 6. 悪意のある OneNote\n\n サンプル内で見つかったペイロードの平均サイズ。ペイロードの種類別にグループ\n\n 化したもの\n\nEXE や Office 97-2003 などの大きなバイナリー埋め込みペイロードの方が高機能ですが、OneNote\n\nサンプルの全体サイズが大きくなることから、攻撃者にはあまり使われない傾向があります (図 5 参照)。攻撃者は、ファイル\n\nサイズ全体が小さいことを好む傾向があります。マルウェアのサイズが小さいほど電子メールの添付ファイルなどの一般的なマル\n\nウェア配信メカニズムに組み込みやすくなりますし、疑われにくくもなるためです。\n\n上の図 6 に示すように、埋め込まれた悪意のある EXE ファイルと Office 97-2003\n\nファイルのペイロードは大きくなる傾向があり、埋め込まれた悪意のある HTA ファイルと JavaScript\n\nファイルは小さくなる傾向があります。\n\n## 悪意のある OneNote サンプルでの画像の存在\n\n悪意のある OneNote\n\nルアーを作成する攻撃者は、ボタンのように見える画像を使って、ユーザーをだまして有害なペイロードを起動させます。私たち\n\nは悪意のある OneNote サンプルごとにペイロードの種類別に画像数をマッピングし、画像数の中央値を計算しました。\n\nデータセット内の 6,000 個のサンプルを分析したところ、悪意のある OneNote サンプルのうち 3 つを除くすべて (99.9%)\n\nに、少なくとも 1 つの画像が含まれていることがわかりました。ほぼすべてのサンプルに少なくとも 1\n\nつの画像が含まれているということで、OneNote\n\nのサンプルは主にフィッシングの手段として使われているという仮説を確認できます。\n\n図 7 は、ペイロードの種類ごとの画像数の中央値が 2\n\nであることを示しています。たとえば攻撃者は、偽のボタンに加えて偽の「安全な」ドキュメント\n\nバナーなどの目をひく画像を使い、フィッシング キャンペーンの信憑性を高めることができます (図 3 など)。\n\n### 画像 7 は、さまざまなペイロードの種類ごとの画像数の中央値を示す棒グラフです。JavaScript、PowerImage not found or type unknown 図 7. OneNote\n\n マルウェアに埋め込まれたさまざまなペイロードの種類の画像数の中央値をペイロ\n\n\n-----\n\n### ドの種類別にグル プ化したもの\n\n上のグラフは、悪意のある OneNote サンプルのペイロードには通常 2 ～ 3\n\n枚の画像が含まれていて、一部はドキュメントの信憑性を高める用途に、一部は偽ボタンとして使われていることを示しています\n\n。\n\n## 埋め込まれた EXE ペイロードの分析\n\n[私たちはこれまでの研究で PowerShell や HTA など、より一般的で人気のあるペイロードの種類を含む OneNote](https://www.paloaltonetworks.com/blog/security-operations/the-adventures-of-malicious-onenote-attachments-in-cortex-xdr-land/)\n\nサンプルを調査してきましたが、EXE のペイロードにはあまり注目を払っていませんでした。そこで本セクションでは、EXE\n\nのペイロードが埋め込まれた OneNote サンプルを分析したいと思います。\n\n以下のペイロードは、次の SHA256 ハッシュを持つ OneNote サンプルから抽出されたものです。\n```\n   d48bcca19522af9e11d5ce8890fe0b8daa01f93c95e6a338528892e152a4f63c\n\n```\nこのペイロード自体は次の SHA256 ハッシュを持っています。\n```\n   92d057720eab41e9c6bb684e834da632ff3d79b1d42e027e761d21967291ca50\n\n```\n[図 8 は、この EXE ペイロードを IDA Pro](https://hex-rays.com/ida-pro/)\n\nで分析した結果を示したものです。この中にはいくつかのコードブロックが見つかりました。これは多くの場合、ここで相手にし\n\n[ているのがシェルコードであることを示します。](https://www.sentinelone.com/blog/malicious-input-how-hackers-use-shellcode/)\n\n[私たちの仮説は、プロセス環境ブロック (PEB) と右回転 (ROR) 命令を指し示す GS:60](https://learn.microsoft.com/ja-jp/windows/win32/api/winternl/ns-winternl-peb)\n\nの存在によって確認されました。これは、このマルウェアが関数に動的アドレス解決を使い、関数識別にハッシュを使っているこ\n\nとを示しています。\n\n### 画像 8 は、 EXE ペイロードを逆アセンブラーの IDA Pro で開いた図です。赤い四角形は、アーキテクチャImage not found or type unknown 図 8. EXE ペイロードを IDA で開いたところ\n\nこのシェルコードの目的を理解し、動的にロードしていたライブラリーを識別するため、私たちは x64dbg\n\nデバッガーでこれを開きました。次に、ループ内で loc_140004021\n\nという関数ブロックを繰り返し呼び出している関数にブレークポイントを設定します (図 9)。\n\n### 画像 9 は、動的にロードされた関数を強調表示しているスクリーンショットです。青い矢印が灰色でハイImage not found or type unknown\n\n\n-----\n\n### 図 9. 動的にロ ドされた関数を識別するためにブレ クポイントを設定したところ\n\nこれにより、WSAStringToAddressA 関数 (図 10 参照) と WSASocketW 関数 (図 11 参照)\n\nを組み合わせて、このシェルコードがネットワーク ソケットを確立し、データ送受信を試みていることが明らかになります。\n\n### 画像 10 は、RSI レジスターで強調表示された記録された関数 WSAStringToAddressA のスクリーンショッImage not found or type unknown 図 10. RSI レジスターに関数名 WSAStringToAddressA が記録されている\n\n 画像 11 は、RSI レジスターで強調表示された、記録された関数 WSASpclertW のスクリーンショットですImage not found or type unknown 図 11. RSI レジスターに関数名 WSASpclertW が記録されている\n\n攻撃者のマシンへの接続に最もよく使われる種類のシェルコードはリバース TCP シェルです。そこで私たちは、ws2_32.dll\n\n内にブレークポイントを設定して (図 12 参照)、connect\n\n関数が呼び出されるかどうかを判断することにしました。もしそうなら、この関数に渡される引数を抽出できます。これらの引数\n\nには、ペイロードが接続を試みる IP アドレスやポート番号が含まれることがよくあります。\n\n### 画像 12 は、ws2_32.dll のブレークポイントのスクリーンショットです。左ペインの行が灰色でハイライImage not found or type unknown 図 12. ws2_32.dllの関数 connect にブレークポイントを設定\n\n予想した通り、このシェルコードは connect 関数の呼び出しで停止しました。RDX レジスターの値をダンプすると、\n\n`sockaddr_in` [構造体の内容を識別できました (図 13)。](https://learn.microsoft.com/ja-jp/windows/win32/api/ws2def/ns-ws2def-sockaddr_in)\n\n### 画像 13 は sockaddr_in の内容のスクリーンショットです。スクリーンショットの左下には赤い四角のハImage not found or type unknown 図 13. sockaddr_in 構造体の内容をダンプしたところ\n\n次に私たちは、Python スクリプトを書き、上記で特定した sockaddr_in 構造体の内容をアンパックしました (図 14)。\n\n### 画像 14 は、sockaddr_in の内容をアンパックする Python コードのスクリーンショットです。 Image not found or type unknown 図 14. sockaddr_in 構造体の内容を解凍する Python スクリプト\n\n上記の Python スクリプトを実行すると、図 15 に示した出力が得られます。ここからは、攻撃者がポート番号 4444 でローカル\n\nマシン (攻撃者がコントロールしているマシンの可能性あり) に接続していることがわかります。\n\n### 画像 15 は、IP アドレスとポート (画像の 2 行目と 3 行目) を含む Python スクリプトの実行結果のスクリーImage not found or type unknown\n\n\n-----\n\n### 図 15. このペイロ ドが接続している IP\n\n アドレスとポート\n\n## 結論\n\n私たちは、攻撃ベクトルとしての OneNote\n\nは、当初考えていたよりも汎用性が高いという結論に達しました。スクリプトベースのダウンローダーに加え、実行可能形式のペ\n\nイロードを含めることもできますし、ほかの多くのファイル タイプと同様にラテラルムーブにも使えます。\n\nOneNote ファイル内に悪意のあるペイロードを埋め込む場合、攻撃者は主に JavaScript、PowerShell、Batch、VBScript\n\nを利用しますが、実行可能ファイルや Office 97-2003 ファイルなどのバイナリー ペイロードを目的達成に使うこともあります。\n\nこうした攻撃からユーザーを保護するため、組織側は OneNote\n\nファイル内に埋め込まれた危険な拡張子を持つペイロードのブロックを検討してもよいでしょう。さらに言うなら、クリックする\n\n前にボタンや画像を上にマウスオーバーしてみて、OneNote ファイルに埋め込まれたペイロード\n\nファイル名や拡張子を確認し、リスクを抑えることをユーザーの皆さんにはお勧めします。\n\nパロアルトネットワークスのお客さまは、以下の製品を通じて、上記の脅威からより強力に保護されています。\n\n### WildFire を含むクラウド配信セキュリティサービスを有効にした次世代ファイアウォール\n\n WildFire を含むクラウド配信セキュリティ サービスを有効にした Prisma Access デバイス\n\n Cortex XDR および Cortex XSIAM\n\n エージェントは多層保護のアプローチにより、エクスプロイト後のアクティビティからの保\n\n 護に役立ちます。\n\n Unit 42 のインシデント レスポンス チーム\n\n も、侵害を受けた場合の支援や、お客さまのリスク低減のための事前サイバーセキュリティ\n\n 準備状況評価を行っています。\n\n## IoC (侵害指標)\n\n以下は、本校の調査中に発見された OneNote ファイルとペイロードのファイル ハッシュを含む Github\n\nリポジトリへのリンクです。\n\n\n-----\n\n### 悪意のある OneNote ファイルとペイロ ドの 11,226 個の SHA256 ハッシュ GitHub\n\n OneNote ファイルの SHA256 ハッシュとペイロードの SHA256 ハッシュの対応 – GitHub\n\n## 追加リソース\n\n### The Adventures of Malicious OneNote Attachments in Cortex XDR Land –\n\n パロアルトネットワークス Unit 42\n\n Microsoft OneNote File Format – Microsoft\n\n\n-----",
    "language": "JA",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2024/2024.05.16_Payload_Trends_in_Malicious_OneNote_Samples/payloads-in-malicious-onenote-samples-jp.pdf"
    ],
    "report_names": [
        "payloads-in-malicious-onenote-samples-jp"
    ],
    "threat_actors": [],
    "ts_created_at": 1719453805,
    "ts_updated_at": 1743041129,
    "ts_creation_date": 0,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/f80f177f30225e253af35811874266fada886ecf.pdf",
        "text": "https://archive.orkl.eu/f80f177f30225e253af35811874266fada886ecf.txt",
        "img": "https://archive.orkl.eu/f80f177f30225e253af35811874266fada886ecf.jpg"
    }
}