{
    "id": "d6b3d3fe-6505-4961-b675-60677815267e",
    "created_at": "2022-10-27T08:36:14.865201Z",
    "updated_at": "2025-03-27T02:15:46.099629Z",
    "deleted_at": null,
    "sha1_hash": "23aca78ded4aa6027b28102f7ee6d85349e1c02b",
    "title": "",
    "authors": "",
    "file_creation_date": "0001-01-01T00:00:00Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 19700539,
    "plain_text": "## Bvp47\n\n#### Technical Details Report II\n\n\n-----\n\n# Table of Contents\n\n**1. Executive Summary**\n\n**2. Attack Scene Restoration of suctionchar_agent**\n\nAttack Scene\n\nScene Restoration\n\n**3. Technical Details of suctionchar_agent**\n\nFile Information\n\nSample Correlation\n\nTechnical Analysis\n\n**4. Technical Details of dewdrop version 3.x**\n\nInitialization of BPF Covert Communication Process\n\nData Processing of BPF Covert Communication\n\nSample Correlation\n\n**5. Technical Details of Bvp47_loader**\n\nCharacter Encryption Function\n\nPayload-Related Encryption Methods\n\nPayload Decryption Process\n\nInitialization and Kernel Module Loading of Bvp Engine\n\nA Bypass Method for Self-Deletion\n\nHash-Based API Function Call\n\nA Part of Shellcode\n\n**6. Conclusion**\n\n**7. Reference**\n\n\n1\n\n2\n\n2\n\n3\n\n7\n\n7\n\n8\n\n9\n\n18\n\n18\n\n21\n\n24\n\n26\n\n27\n\n31\n\n36\n\n43\n\n52\n\n52\n\n56\n\n58\n\n59\n\n\n-----\n\n### 1. Executive Summary\n\nIn report \" Bvp47 – A Top-tier Backdoor of US NSA Equation Group \" (Reference 1), Bvp47 is like a huge\nshell or compressed package, containing a total of 18 fragments. Pangu Labs gives attribution analysis\nand description of some technical details, such as BPF covert tunneling. However, there are still some\nother modules worth in-depth analysis. Those modules can either perform functions together as part of\nBvp47 or be used independently.\n\nIn a forensic to Solaris system of one critical infrastructure in 2015, Pangu Lab extracted another sample,\nwhich survived independently on the Solaris platform and seemed to be closely related to Bvp47. After\nanalyzing the leaked information, we confirmed that the content of the sample file was same to Suctionchar_Agent which was leaked from The Shadow Brokers. When executed with dewdrops, incision and\nother modules, it can easily steal password of target system, when user is executing commands like ssh,\npasswd, sudo. The file stored stolen passwords in target system also requires private key of RSA algorithm\nfor decryption.\n\nThe process of tracking Bvp47 is more like exploring a puzzle under fog. This report will further illustrate\nparts of working method and execution logic of Bvp47, a top-tier backdoor platform, through analysis of\nSuctionchar_Agent, Dewdrop, and Bvp47_loader.\n\n\n-----\n\n### 2. Attack Scene Restoration of   suctionchar_agent\n\n##### Attack Scene\n\nAfter repeated attempts and tracking of the execution process, Pangu Lab roughly restored attack scene\nof suctionchar_agent combining with other components, as shown in following figure:\n\n1. The sum module running in the kernel layer will assist suctionchar_agent to steal account passwords\nfrom processes such as PASSWD, TELNET, and SU;\n\n2. The stolen credentials will be synchronized to suctionchar_agent running on Ring3;\n\n3. suctionchar_agent will save the stolen credentials to hidden directory of \"/var/tmp/.xxxxxxxx\";\n\n4. Attacker remotely sends trigger packet, that runs ish callback, to the BPF filter at the kernel layer;\n\n5. The BPF filter captures the featured packet and transmits it to dewdrop in Ring3;\n\n6. Dewdrop decrypts the data packet to obtain the ish callback command, and forwards it to incision\nprogram;\n\n\n-----\n\n7. The incision program actively executes callback command to contact C&C server, and the attacker uses\nish to obtain the password file;\n\n8. The attacker decrypts the password file with RSA private key and then obtains stolen passwords\n\n##### Scene Restoration\n\n1. Run the tipoff command-line program. The list of command options is as follow:\n\n\n-----\n\n2. The summary of key options is as follow:\n\n**Option Category**\n\nTrigger Protocol\n\nTCP Flags\n\nFirewall Bypass\n\nApplication Protocol\n\nBackdoor Feature 1\n\nBackdoor Feature 2\n\nConfigurations of Multiple Protocols\n\n3. Support obtaining remote shell in UDP protocol\n\n|Option Category Trigger Protocol TCP Flags Firewall Bypass Application Protocol Backdoor Feature 1 Backdoor Feature 2 Configurations of Multiple Protocols|Feature Support TCP、UDP、ICMP syn、fin、ack、rst、push、urg PIX or others；Bypass firewall and ACL by default Protocols like SMTP、SIP、DNS Execute file remotely View in remote shell Configure flags of SMTP、DNS、TCP|\n|---|---|\n\n\n-----\n\n4. The UDP packet is as follow:\n\n5. Hidden processes and files can be listed in the obtained shell\n\n\n-----\n\n6. The encrypted files in the \"/var/tmp/\" directory are as follows\n\n7. Use suctionchar_decode to decrypt the encrypted files in the \"/var/tmp/\" directory:\n\n\n-----\n\n### 3. Technical Details   of suctionchar_agent\n\n##### File Information\n\nIn on-site environment, we extracted one program in Solaris Sparc architecture. After comparing it with the\nleaked Shadow Brokers data, we confirmed the connection. The file related information is as follows:\n\n###### Sample Information Summary：\n\n Filename unknown\n\n MD5 a633c1ce5a4730dafa8623a62927791f\n\n File Size (bytes) 47,144\n\n The Shadow Brokers Package Name suctionchar_agents.tar.bz2\n\n Original File Name suctionchar_agent__v__3.3.7.9_sparc-sun-solaris2.9\n\n Steal passwords from SSH, TELNET, FTP, PASSWD,\n Feature\n SU、RSH、LOGIN、CSH\n\n CPU Architecture SPARC\n\n Hidden Path 2 /var/tmp/.xxxxxxxxxxxx\n\nThe CPU adaptation architecture of the sample obtained at the on-site environment is SPARC. Through\ncorrelation and attribution analysis, we found that the sample is one of the files leaked by The Shadow Brokers, namely suctionchar_agent__v__3.3.7.9_sparc-sun-solaris2.9. However, good decompiler targeting\nSPARC architecture is not available currently. Since there are homologous binary programs suitable for\nmultiple platforms in the leaked file package, we refer one sample with the same function of the x86 architecture for analysis. The specific file information of the x86 architecture is as follows:\n\n|Sample Information Summary：|Col2|\n|---|---|\n|Filename|unknown|\n|MD5|a633c1ce5a4730dafa8623a62927791f|\n|File Size (bytes)|47,144|\n|The Shadow Brokers Package Name|suctionchar_agents.tar.bz2|\n|Original File Name|suctionchar_agent__v__3.3.7.9_sparc-sun-solaris2.9|\n|Feature|Steal passwords from SSH, TELNET, FTP, PASSWD, SU、RSH、LOGIN、CSH|\n|CPU Architecture|SPARC|\n|Hidden Path 2|/var/tmp/.xxxxxxxxxxxx|\n\n\n-----\n\n###### Sample Information Summary：\n\n Filename suctionchar_agent__v__2.0.28.2_x86-linux-centos-5.1\n\n MD5 4a5b7a9c5d41dbe61c669ed4cf2975e5\n\n File Size (bytes) 31,649\n\n The Shadow Brokers Package Name suctionchar_agents.tar.bz2\n\n Original File Name suctionchar_agent__v__2.0.28.2_x86-linux-centos-5.1\n\n Steal passwords from SSH, TELNET, FTP, PASSWD,\n Feature\n SU、RSH、LOGIN、CSH\n\n CPU Architecture X86\n\n Bvp47 Corresponding Slice 0x0E\n\n Hidden Path 2 /var/tmp/.xxxxxxxxxxxx\n\n##### Sample Correlation\n\nAccording to the obtained sample \"suctionchar\", the corresponding original file was found in the file\nleaked by The Shadow Brokers as \"linux/bin/suctionchar_agents.tar.bz2/suctionchar_agent__v__3.3.7.9\n\n_sparc-sun-solaris2.9\". The compressed package also includes multiple versions of suctionchar files for\nserveral platforms, dating back to 2007:\n\n|Sample Information Summary：|Col2|\n|---|---|\n|Filename|suctionchar_agent__v__2.0.28.2_x86-linux-centos-5.1|\n|MD5|4a5b7a9c5d41dbe61c669ed4cf2975e5|\n|File Size (bytes)|31,649|\n|The Shadow Brokers Package Name|suctionchar_agents.tar.bz2|\n|Original File Name|suctionchar_agent__v__2.0.28.2_x86-linux-centos-5.1|\n|Feature|Steal passwords from SSH, TELNET, FTP, PASSWD, SU、RSH、LOGIN、CSH|\n|CPU Architecture|X86|\n|Bvp47 Corresponding Slice|0x0E|\n|Hidden Path 2|/var/tmp/.xxxxxxxxxxxx|\n\n\n-----\n\n##### Technical Analysis\n\n###### String Decryption\n\nAs shown in the figure below, string encryption is also the 0x47 function encryption described in Bvp47:\n\n\n-----\n\nThe list of decrypted strings is as follow:\n\nThe relevant decryption script is as follow:\n\n\n-----\n\n###### Function Module Design\n\nThe file \"Linux\\etc\\opscript.txt\" has a description of suctionchar’s function. It steals account and password\nin programs such as SSH, TELNET, FTP, PASSWD, SU, RSH, LOGIN, and CSH. The suctionchar_agent\nprogram is just an application layer agent, which communicates with the associated kernel module to\nobtain the required information and encrypts it and writes it to a file. The kernel module sum file (not included in The Shadow Brokers Leaks) can be loaded by the modload program. After the kernel module is successfully loaded, the dropped files will be deleted to prevent the content from being restored:\n\n\n-----\n\nThe suctionchar_agent file has a default configuration, and also support external configuration file. The file\nformats mainly are XML format of version 3.x and above and the earlier conf format.\n\nXML format of versions above 3.x (\"Linux\\bin\\suctionchar_configure.xml\"):\n\n\n-----\n\n“Linux\\doc\\old\\etc\\suctionchar.sample.filter.conf” ：\n\nsuctionchar_configure will generate the \"dc9cb44a723d0e75201d933159834173\" file, which is used by\nthe agent:\n\n\n-----\n\n###### Thread of Collecting Password\n\nIn the suctionchar_agent, there is a separate thread that communicates with the kernel module sum to\nobtain the account password and write it to the /var/tmp/ folder, that is, inside the sub_8049EF0 function:\n\n\n-----\n\nCallback function sub_8049A00:\n\n###### File Path Generation Algorithm for Saving Password\n\nThe generation algorithm of the hidden file \"/var/tmp/.e33ff11cb8e3b4ff/a0b973925e397d9acd80e85e2ea\n\na6e60/d5373a146ff9f200a2376054dde25677\" is described in the function get_hidden_path_0804BDF0:\n\n\n-----\n\nThe restored code is roughly as follows:\n\n\n-----\n\n###### Private Key of suctionchar_decode\n\nAs described in the scene, the file \"/var/tmp/.e33ff11cb8e3b4ff/a0b973925e397d9acd80e85e2eaa6e60/d\n\n5373a146ff9f200a2376054dde25677\" can be decrypted by the \"linux\\bin\\suctionchar_decode\" program,\nand the encryption algorithm needs to use the RSA private key to decrypt the RC6 symmetric key. file. Like\nthe private key in Dewdrops, this RSA private key can also support the association between the backdoor\nand The Shadow Brokers leaked data package.\n\n\n-----\n\n### 4. Technical Details of dewdrop   version 3.x\n\nThe Dewdrop module undertakes the most important hidden backdoor function, that is, the BPF filtering\nfunction. This chapter mainly discusses the implementation process corresponding to the BPF engine\ncommunication.\n\n##### Initialization of BPF Covert Communication Process\n\n1. The initialization of BPF covert backdoor starts from function _554a7941;\n\n2. sec_bpf_init returns the structure of bpf_program\n\n\n-----\n\n3. The specific values of the stru_8008300 structure are as follows\n\n4. The structures of bpf_program and bpf_insn are as follows\n\n\n-----\n\n5. The code disassembled by bpf is as follows\n\n\n-----\n\n6. The pseudo code of actual runtime BPF is as follow. The payload data that matches this rule will be\ncaptured and sent to next process;\n\n##### Data Processing of BPF Covert Communication\n\nAfter matching the capture rules of BPF, the packet will be sent to next process.\n\n1. In the function sec_f_9b510b03, dewdrop uses the select model to process the corresponding data\npackets;\n\n\n-----\n\n2. sec_f_6a42f4c9_allinone executes the pseudo code as follows\n\n\n-----\n\n3. The decryption of the payload packet starts in sec_decode_packet, which involves a deformed RSA\ndecryption algorithm.\n\n\n-----\n\n##### Data Format and Encryption Algorithm of BPF Covert Communication\n\n1. The payload packet format of the dewrops v3 is as follow:\n\n2. The payload packet process for dewdrop in tipoff is as follow\n\n\n-----\n\n3. RSA data encryption in the payload packet\n\n\n-----\n\n### 5. Technical Details of   Bvp47_loader\n\nThe entry function diagram of the loader module is as follows, which involves following operations:\n\n1. Check if the runtime environment is normal;\n\n2. Read the payload at the end of the file;\n\n3. Map and verify the payload;\n\n4. Decrypt the payload, if necessary;\n\n5. Decompress the payload, if necessary;\n\n6. Load the kernel module;\n\n7. Call notification to hide the ELF file header of the kernel module;\n\n8. Fork executes the dewrops module backdoor;\n\n9. Fork executes the backdoor of the suctionschar_agent module;\n\n\n-----\n\n##### Character Encryption Function\n\nIn the sample analysis, the first thing need to deal with is a series of string encryption functions, a total of 8.\n\n1. XOR 0x47 function type 1:\n\n2. XOR 0x47 function type 2:\n\n\n-----\n\n3. Variable order encryption function:\n\n4. XOR 0x47 function type 3:\n\n\n-----\n\n5. XOR 0x47 type 4:\n\n6. XOR 0x47\n\n\n-----\n\n7. Encryption function\n\n8. XOR 0x47 function type 5\n\n\n-----\n\n##### Payload-Related Encryption Methods\n\nThere are five main decryption methods for the payload to be loaded.\n\n**Method 1**\n\n\n-----\n\n**Method 2**\n\n\n-----\n\n**Method 3**\n\n\n-----\n\n**Method 4**\n\n\n-----\n\n**Method 5**\n\n\n-----\n\n##### Payload Decryption Process\n\nAs shown in the main process of the main function, the payload parsing process is a relatively complex loop\nbody process, and it is accompanied by many encryption confrontations.\n\nMap and Load:\n\n\n-----\n\nParsing Process:\n\n\n-----\n\nThe decompression process involved:\n\nlinux_gzip function:\n\n\n-----\n\nlinux_gzip_inflate_fixed function:\n\nlinux_gzip_inflate_dynamic function:\n\n\n-----\n\nlinux_gzip_inflate_codes function:\n\nlinux_gzip_fill_buf function:\n\n\n-----\n\nlinux_gzip_huft_build function:\n\nThe abstracted pseudo code in C language code is as follows (not fully covered):\n\nThe known payload file formats are as follows:\n\n\n-----\n\nIn the running process, the sample will directly try to load the so-type file during the above Decode\ncallback process:\n\nAfter trying to load, it will try to patch the plt of the ELF file format:\n\n\n-----\n\n##### Initialization and Kernel Module Loading of Bvp Engine\n\nThe decryption and loading of the kernel module will also be executed in the main process, which will go\n\nthrough following steps:\n\n1. Decrypt the payload package;\n\n2. Initialize the Bvp engine and adapt to the corresponding kernel version structure;\n\n3. Start trying to load the ko module, which is mainly used for hiding processes, files, networks, etc.;\n\nDetails are as follows:\n\n1. Try to decrypt the ko payload;\n\n\n-----\n\n2. Bvp overall processing function;\n\nThe corresponding pseudo code:\n\n\n-----\n\n3. Initialization function serial_bvp of Bvp engine\n\n\n-----\n\nThe corresponding pseudo code:\n\n\n-----\n\n4. serial_bvp process\n\n\n-----\n\n5. Load the first module qmr\n\n\n-----\n\n6. Verify the distribution:\n\n7. This release corresponds to the version in TSB:\n\n\n-----\n\n8. Check 2:\n\n\n-----\n\n9. Parameter verification 1 when the kernel module is loaded:\n\n10. Parameter verification 2 when kernel module 2 is loaded:\n\n\n-----\n\n11. Finally start loading the kernel modules:\n\n##### A Bypass Method for Self-Deletion\n\nThere are two calls to the unlink function in the main function. During the actual debugging process, the\nprocess can be violently modified to bypass the self-deletion of unlink:\n\n##### Hash-Based API Function Call\n\nDuring the running process of Bvp47, a API function lookup table based on Hash value will be made.\n\n\n-----\n\n1. The Hash table looks like following;\n\n\n-----\n\n2. Attempt to initialize in the sub_804C2E0 function\n\n3. Further initialization in serial_bind_0x7bbf2c88_ function\n\n\n-----\n\nPseudo C code:\n\n\n-----\n\n##### A Part of Shellcode\n\nThere are some incomplete encrypted ELF files in the loader module. After decryption, there are several\ncodes in the form of shellcode.\n\n1. The corresponding ELF header format is defined as follows\n\n2. Several pieces of shellcode in the middle will jump to each other\n\n\n-----\n\n3. A total of 6 pieces of shellcode\n\n\n-----\n\n### 6. Conclusion\n\nAlthough the function implementation of the Suctionchar_Agent module is relatively simple, combining\nBvp47_loader and Dewdrop, we can conclude that Bvp47 has a good architectural capability in design,\nand attackers can flexibly combine other functional modules to achieve attack targets and reduce exposed\nsurface of malicious code as much as possible. Although the NSA-sourced attack activities are highly\nsecretive, through the analysis of forensic materials within the scope of our own data and the in-depth\nmining of open source data, we still hope to complete our puzzle and get a glimpse of the operation methods of the top international hacker teams.\n\n\n-----\n\n### 7. Reference\n\n###### 1. Bvp47 – A Top-tier Backdoor of US NSA Equation Group\n\n https://www.pangulab.cn/post/the_bvp47_a_top-tier_backdoor_of_us_nsa_equation_group/\n\n 2. The Shadow Brokers: x0rz-EQGRP\n\n https://github.com/x0rz/EQGRP/blob/master/Linux/up/suctionchar_agents.tar.bz2\n\n 3. jtcriswell/bpfa\n\n https://github.com/jtcriswell/bpfa\n\n 4. bpf-asm-explained\n\n https://github.com/Igalia/pflua/blob/master/doc/technical/bpf-asm-explained.md\n\n 5. cloudflare/bpftools\n\n https://github.com/cloudflare/bpftools\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.pangulab.cn/files/The_Bvp47_a_top-tier_backdoor_of_us_nsa_equation_group_ii.en.pdf"
    ],
    "report_names": [
        "The_Bvp47_a_top-tier_backdoor_of_us_nsa_equation_group_ii.en.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d4f7cf97-9c98-409c-8b95-b80d14c576a5",
            "created_at": "2022-10-25T16:07:24.561104Z",
            "updated_at": "2025-03-27T02:02:10.281202Z",
            "deleted_at": null,
            "main_name": "Shadow Brokers",
            "aliases": [],
            "source_name": "ETDA:Shadow Brokers",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "08623296-52be-4977-8622-50efda44e9cc",
            "created_at": "2023-01-06T13:46:38.549387Z",
            "updated_at": "2025-03-27T02:00:02.859535Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "Tilded Team",
                "EQGRP",
                "G0020"
            ],
            "source_name": "MISPGALAXY:Equation Group",
            "tools": [
                "EquationLaser",
                "EquationDrug",
                "DoubleFantasy",
                "TripleFantasy",
                "GrayFish"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "171b85f2-8f6f-46c0-92e0-c591f61ea167",
            "created_at": "2023-01-06T13:46:38.830188Z",
            "updated_at": "2025-03-27T02:00:02.929729Z",
            "deleted_at": null,
            "main_name": "The Shadow Brokers",
            "aliases": [
                "Shadow Brokers",
                "ShadowBrokers",
                "The ShadowBrokers",
                "TSB"
            ],
            "source_name": "MISPGALAXY:The Shadow Brokers",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2d9fbbd7-e4c3-40e5-b751-27af27c8610b",
            "created_at": "2024-05-01T02:03:08.144214Z",
            "updated_at": "2025-03-27T02:05:17.419705Z",
            "deleted_at": null,
            "main_name": "PLATINUM COLONY",
            "aliases": [
                "Equation Group "
            ],
            "source_name": "Secureworks:PLATINUM COLONY",
            "tools": [
                " EquationDrug",
                " EquationLaser",
                " Fanny",
                " GrayFish",
                " TripleFantasy",
                "DoubleFantasy"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "e0fed6e6-a593-4041-80ef-694261825937",
            "created_at": "2022-10-25T16:07:23.593572Z",
            "updated_at": "2025-03-27T02:02:09.879892Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "APT-C-40",
                "Platinum Colony",
                "Tilded Team"
            ],
            "source_name": "ETDA:Equation Group",
            "tools": [
                "Bvp47",
                "DEMENTIAWHEEL",
                "DOUBLEFANTASY",
                "DanderSpritz",
                "DarkPulsar",
                "DoubleFantasy",
                "DoubleFeature",
                "DoublePulsar",
                "Duqu",
                "EQUATIONDRUG",
                "EQUATIONLASER",
                "EQUESTRE",
                "Flamer",
                "GRAYFISH",
                "GROK",
                "OddJob",
                "Plexor",
                "Prax",
                "Regin",
                "Skywiper",
                "TRIPLEFANTASY",
                "Tilded",
                "UNITEDRAKE",
                "WarriorPride",
                "sKyWIper"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666859774,
    "ts_updated_at": 1743041746,
    "ts_creation_date": 0,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/23aca78ded4aa6027b28102f7ee6d85349e1c02b.pdf",
        "text": "https://archive.orkl.eu/23aca78ded4aa6027b28102f7ee6d85349e1c02b.txt",
        "img": "https://archive.orkl.eu/23aca78ded4aa6027b28102f7ee6d85349e1c02b.jpg"
    }
}