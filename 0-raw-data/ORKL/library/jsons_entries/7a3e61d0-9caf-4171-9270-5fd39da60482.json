{
    "id": "7a3e61d0-9caf-4171-9270-5fd39da60482",
    "created_at": "2023-01-12T15:07:38.859062Z",
    "updated_at": "2025-03-27T02:06:06.152111Z",
    "deleted_at": null,
    "sha1_hash": "b9543d367592ae4b0889799f4b496b2fce99d9ed",
    "title": "2021-07-07 - Diving Deeper Into the Kaseya VSA Attack- REvil Returns and Other Hackers Are Riding Their Coattails",
    "authors": "",
    "file_creation_date": "2022-05-28T15:54:36Z",
    "file_modification_date": "2022-05-28T15:54:36Z",
    "file_size": 1536219,
    "plain_text": "# Diving Deeper Into the Kaseya VSA Attack: REvil Returns and Other Hackers Are Riding Their Coattails\n\n**trustwave.com/en-us/resources/blogs/spiderlabs-blog/diving-deeper-into-the-kaseya-vsa-attack-revil-returns-and-other-hackers-**\nare-riding-their-coattails/\n\nOn, July 2nd, a massive ransomware attack was launched against roughly 60 managed services\nproviders (MSPs) by criminals associated with the REvil ransomware-as-a-service (RaaS) group.\n\nThe attack leveraged the on-premises servers deployed by IT Management Software vendor\nKaseya. It was initially thought that Kaseya might have been compromised themselves as a root\ncause -- similar to the compromises associated with SolarWinds software in December of 2020.\nInstead, the attackers found and leveraged an unpatched zero-day vulnerability in Kaseya's VSA\nsoftware. At the time of this blog, 1,500 downstream customers of these MSPs have been infected\nwith ransomware.\n\n[This vulnerability has been issued CVE-2021-30116 and was discovered and reported to Kaseya by](https://csirt.divd.nl/2021/07/04/Kaseya-Case-Update-2/)\na researcher for the Dutch Institute for Vulnerability Disclosure (DIVD). A patch was being actively\nworked on by Kaseya according to the DIVD, but not finalized prior to REvil discovering and\nexploiting the issue. At this point, it is still not clear what the actual issue is or how the exploit may\nwork, although initial reports suggest a potential authentication bypass. A patch has not been\nreleased, and Kaseya is recommending that customers with on-premises VSA Servers take them\noffline until a patch is issued. The REvil group initially demanded $70 million USD to reveal a\nuniversal decryptor for all affected victims but has since lowered the demand to $50 million.\n\n\n-----\n\nIn the past, the REvil group has also exfiltrated data either for sale or to pressure a victim even more\ninto paying the ransom. This appears to be the case with this campaign as well, as we've seen REvil\ncall out many customers bragging on their Darknet hosted \"Happy Blog\" about the amount of data\nthey have in their possession.\n\nFigure 1: Victim A showing a list of data types REvil has access to and drive mappings as proof\n\nFigure 2: Victim B with a description of the company and links to proof of compromise\n\n\n-----\n\nFigure 3: Victim C with 4TB of compromised files and a screenshot as proof of access\n\nFigure 4: Victim D with screenshot as proof of access showing data going back to 1994\n\n## Malware Analysis\n\nOver the course of the weekend, our SpiderLabs Malware Analysis team received a malware\nsubmission from our Global Threat Operations group. They were investigating a piece of DLL file\nthey found on one of our customer's critical servers hit by a ransomware attack. This server was\nrunning Kaseya VSA. The file is a digitally signed DLL with a file named mpsvc.dll\n\n\n-----\n\nFigure 5: Digitial signature on mpsvc.dll\n\nUpon initial investigation, the DLL is the payload itself - REvil Ransomware. So we thought to step\nback a little bit and investigate how this DLL got loaded. This pointed us to an ongoing discussion\non [Reddit. It turns out that this library was side-loaded by a legitimate Microsoft executable](https://www.reddit.com/r/msp/comments/ocggbv/crticial_ransomware_incident_in_progress/)\n(MsMpEng.exe).\n\nMsMpEng.exe is benign and part of the Microsoft Antimalware service. An older version was used by\nthe attackers. As you can see in the screenshot below, it shows the properties of this Microsoft\nexecutable and digital signature details.\n\n\n-----\n\nFigure 6: MsMpEng.exe details\n\n\n-----\n\nWhen MsMpEng.exe runs, it picks up the attacker s mpsvc.dll and loads an exported function from\nthe malicious library called ServiceCrtMain(). This function unpacks and loads the ransomware into\nthe memory and executes it.\n\nStepping back, MsMpEng.exe and mpsvc.dll were both installed in the infected system by a dropper\nnamed Agent.exe.\n\n(Virustotal\ndetection: https://www.virustotal.com/gui/file/d55f983c994caa160ec63a59f6b4250fe67fb3e8c43a388\naec60a4a6978e9f1e/detection)\n\n**\"Agent.exe\" dropper contains two binaries - MsMpEng.exe and mpsvc.dll embedded in its body**\n(particularly in the resources section), which when executed, writes (with system privilege) both files\ninto C:\\Windows. Agent.exe then executes MsMpEng.exe that eventually loaded the malicious\n\"mpsvc.dll\" file.\n\n**\"Agent.exe\" was initially dropped as a Base64 encoded file – named as \"Agent.crt\" to the**\npath C:\\kworking. This .crt file was deployed through a malicious update by exploiting Kaseya VSA\nservers, and it eventually sent out this update to the Kaseya VSA Agents running on managed\ndevices. Once the malicious update is deployed to the devices, Kaseya VSA Agents will run a\nPowerShell command to decode the .crt file and then execute it.\n\nFor the initial vector, [Huntress' blog reported that the attacker used an authentication bypass in the](https://www.huntress.com/blog/rapid-response-kaseya-vsa-mass-msp-ransomware-incident)\nweb interface of the Kaseya VSA server to gain an authenticated session. They then uploaded the\npayload and execute a command via SQL injection to deploy the malicious updates\n\nTo visualize, this is how post-exploitation execution flows:\n\n\n-----\n\nFigure 7: Post-exploitation attack flow\n\n## The Ransomware Payload\n\nThe payload was found to be REvil ransomware version 2. We have managed to decode the\n[ransomware configuration. A decoded copy can be found here. The configuration file itself is](https://github.com/SpiderLabs/REvil_config/blob/main/Kaseya_revil_config.txt)\nembedded in the ransomware encoded in RC4 with the\nkey mXT1QFyEUbrxc4cbP84jbN5wrHeqmFXt\n\n\n-----\n\nFigure 8: The REvil configuration file embedded and encoded with RC4\n\nBased in the configuration, It avoids encrypting files from this list of directory:\n\n\"program files\",\n\"appdata\",\n\"mozilla\",\n\"$windows.~ws\",\n\"application data\",\n\"$windows.~bt\",\n\"google\",\n\"$recycle.bin\",\n\"windows.old\",\n\"programdata\",\n\"system volume information\",\n\"program files (x86)\",\n\"boot\",\n\"tor browser\",\n\"windows\",\n\"intel\",\n\"perflogs\",\n\"msocache\"\n\nIt also avoids encrypting system files:\n\n\"ntldr\",\n\"thumbs.db\",\n\"bootsect.bak\",\n\"autorun.inf\",\n\"ntuser.dat.log\",\n\"boot.ini\",\n\n\"iconcache db\"\n\n\n-----\n\nbootfont.bin,\n\"ntuser.dat\",\n\"ntuser.ini\",\n\"desktop.ini\"\n\nIt avoids encrypting any file extension from this list:\n\n\"ps1\",\n\"ldf\",\n\"lock\",\n\"theme\",\n\"msi\",\n\"sys\",\n\"wpx\",\n\"cpl\",\n\"adv\",\n\"msc\",\n\"scr\",\n\"bat\",\n\"key\",\n\"ico\",\n\"dll\",\n\"hta\",\n\"deskthemepack\",\n\"nomedia\",\n\"msu\",\n\"rtp\",\n\"msp\",\n\"idx\",\n\"ani\",\n\"386\",\n\"diagcfg\",\n\"bin\",\n\"mod\",\n\"ics\",\n\"com\",\n\"hlp\",\n\"spl\",\n\"nls\",\n\"cab\",\n\"exe\",\n\"diagpkg\",\n\"icl\",\n\"ocx\",\n\"rom\",\n\"prf\",\n\"themepack\",\n\n\n-----\n\nmsstyles,\n\"lnk\",\n\"icns\",\n\"mpa\",\n\"drv\",\n\"cur\",\n\"diagcab\",\n\"cmd\",\n\"shs\"\n\nIt terminates running processes if the name is in this list:\n\n\"encsvc\",\n\"powerpnt\",\n\"ocssd\",\n\"steam\",\n\"isqlplussvc\",\n\"outlook\",\n\"sql\",\n\"ocomm\",\n\"agntsvc\",\n\"mspub\",\n\"onenote\",\n\"winword\",\n\"thebat\",\n\"excel\",\n\"mydesktopqos\",\n\"ocautoupds\",\n\"thunderbird\",\n\"synctime\",\n\"infopath\",\n\"mydesktopservice\",\n\"firefox\",\n\"oracle\",\n\"sqbcoreservice\",\n\"dbeng50\",\n\"tbirdconfig\",\n\"msaccess\",\n\"visio\",\n\"dbsnmp\",\n\"wordpad\",\n\"xfssvccon\"\n\nIt also stops the following services if they are running:\n\n\n-----\n\nveeam,\n\"memtas\",\n\"sql\",\n\"backup\",\n\"vss\",\n\"sophos\",\n\"svc$\",\n\"mepocs\"\n\nThe configuration also includes the following fields:\n\n**Field** **Value** **Description**\n\npk 9/AgyLvWEviWbvuayR2k0Q140e9LZJ5hwrmto/zCyFM= attacker's\nRSA public\nkey – this\npublic key is\nused to\nencrypt the\nsession\nprivate key\nused to\nencrypt the\nfiles.\n\npid $2a$12$prOX/4eKl8zrpGSC5lnHPecevs5NOckOUW5r3s4JJYDnZZSghvBkq campaign\nidentifier\n\ndbg false used during\ndevelopment\nstage of this\nransomware\nfor\ndebugging\npurposes\n\nwfld backup folder to\nwipe out\n\nwipe true wipe out\nfolders\nspecified in\nwfld key – in\nthis instance\n\"backup\"\nfolder\n\n\n-----\n\nnname {EXT}-readme.txt filename\nformat of the\nransomware\nnote\ndropped in\neach folder\nwhere files\nare\nencrypted\n\nexp false run privilege\nescalation\nexploit\n\n\nimg QQBsAGwAIABvAGYAIAB5AG8AdQByACAAZgB {TRUNCATED, TOO\nLONG}\n\n\nbase64\nencoded text\nof the\nransomware\nmessage set\nin the\ndesktop\nbackground\n\n\narn false create\npersistence\n\nrdmcnt 0 max number\nof ransom\nnotes per\ndrive\n\nThe ransom note is also included in the configuration:\n\nFigure 9: The ransom letter\n\nWhere:\n{EXT} - a random extension name of the encrypted file\n{UID} - value is taken from the infected system's volume serial number and CPUID. It is used by the\nattacker to identify the victim\n\n\n-----\n\n{KEY} - base64 encoded data of the encrypted stat data. Stat data consists of the infected host\ninformation including CPU architecture, system default language, host's workgroup name, hostname,\nand operating system\n\nThere is also a list of over 1,200 controller domains that the ransomware supposedly connects to,\nhowever, connection to these domains was disabled in the configuration file. You can find the full list\nin [the decoded configuration file here.](https://github.com/SpiderLabs/REvil_config/blob/main/Kaseya_revil_config.txt)\n\nFigure 10: list of over 1200 C2 domains\n\nIn addition to the configuration, the ransomware also avoids systems that have default languages\nfrom what was the USSR region. This includes:\n\nRussian (Russia)\nUkrainian (Ukraine)\nBelarusian (Belarus)\nTajik (Cyrillic, Tajikistan)\nArmenian (Armenia)\nAzerbaijani (Latin, Azerbaijan)\nGeorgian (Georgia)\nKazakh (Kazakhstan)\nKyrgyz (Kyrgyzstan)\nTurkmen (Turkmenistan)\nUzbek (Latin, Uzbekistan)\nTatar (Russia)\nRomanian (Moldova)\nRussian (Moldova)\nAzerbaijani (Cyrillic, Azerbaijan)\nUzbek (Cyrillic, Uzbekistan)\nSyriac (Syria)\n\n\n-----\n\nArabic (Syria)\n\n## The Vultures Circle: Spammers Riding REvil Coattails\n\nPerhaps not surprisingly, spammers have been quick to jump on this issue as a lure in their\nmalicious emails. Today, we encountered spams claiming that Microsoft issued an update which can\nprovide protection against the Kaseya's vulnerability. Below is an example.\n\nFigure 11: Phishing Email piggybacking on the REvil attack\n\nBoth a malicious link and attachment are contained in the spams. A spoofed link to Kaseya's\n[webpage https://www.kaseya.com/potential-attack-on-kaseya-vsa/, where the updates about CVE-](https://www.kaseya.com/potential-attack-on-kaseya-vsa/)\n2021-30116 are posted, is contained in the email body. Clicking this link will lead to an executable\nfile being downloaded from hxxp://45[.]153[.]241[.]113/download/pload[.]exe. The downloaded\nexecutable file and the executable attached to the spams are the same file - CobaltStrike malware.\n\n## Payload\n\nThe executable file loads a Cobalt Strike launcher that unpacks and executes a Cobalt Strike\nbeacon.dll in memory and creates an encrypted tunnel between the infected host and the\n[adversaries. Cobalt Strike is a post-exploitation tool that is used for legitimate purposes by network](https://www.cobaltstrike.com/)\npenetration testers. However, cybercriminals also utilize this tool for malicious purposes to\nexfiltrate data from compromised hosts, move laterally within the host's network, and also to act as a\nbackdoor.\n\nExtracting the configuration of this Cobalt Strike beacon agent reveals the command and control\nserver, port, the attacker's public key to encrypt exfiltrated data and communications, user-agent,\nPOST URI, among other things, as shown below.\n\n\n-----\n\n```\n{\n  \"BeaconType\": [\n    \"HTTP\"\n  ],\n  \"Port\": 80,\n  \"SleepTime\": 60000,\n  \"MaxGetSize\": 1048576,\n  \"Jitter\": 0,\n  \"MaxDNS\": \"Not Found\",\n  \"PublicKey\": \"MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCHFcV/jTWIWbMLGsg/xD-truncated\n  \"PublicKey_MD5\": \"0ce7b6482c1f24e42f2935f5026d338d\",\n  \"C2Server\": \"31.42.177.52,/dpixel\",\n  \"UserAgent\": \"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64;\nTrident/5.0; MANM; MANM)\",\n  \"HttpPostUri\": \"/submit.php\",\n  \"Malleable_C2_Instructions\": [],\n  \"HttpGet_Metadata\": {\n    \"ConstHeaders\": [],\n    \"ConstParams\": [],\n    \"Metadata\": [\n      \"base64\",\n      \"header \\\"Cookie\\\"\"\n    ],\n    \"SessionId\": [],\n    \"Output\": []\n  },\n  \"HttpPost_Metadata\": {\n    \"ConstHeaders\": [\n      \"Content-Type: application/octet-stream\"\n    ],\n    \"ConstParams\": [],\n    \"Metadata\": [],\n    \"SessionId\": [\n      \"parameter \\\"id\\\"\"\n    ],\n    \"Output\": [\n      \"print\"\n    ]\n  },\n  \"SpawnTo\": \"AAAAAAAAAAAAAAAAAAAAAA==\",\n  \"PipeName\": \"Not Found\",\n  \"DNS_Idle\": \"Not Found\",\n  \"DNS_Sleep\": \"Not Found\",\n  \"SSH_Host\": \"Not Found\",\n  \"SSH_Port\": \"Not Found\",\n  \"SSH_Username\": \"Not Found\",\n  \"SSH_Password_Plaintext\": \"Not Found\",\n  \"SSH_Password_Pubkey\": \"Not Found\",\n  \"SSH_Banner\": \"\",\n  \"HttpGet_Verb\": \"GET\",\n  \"HttpPost_Verb\": \"POST\",\n  \"HttpPostChunk\": 0,\n  \"Spawnto_x86\": \"%windir%\\\\syswow64\\\\rundll32.exe\",\n  \"Spawnto_x64\": \"%windir%\\\\sysnative\\\\rundll32.exe\",\n  \"CryptoScheme\": 0,\n  \"Proxy_Config\": \"Not Found\",\n  \"Proxy_User\": \"Not Found\",\n  \"Proxy_Password\": \"Not Found\",\n  \"Proxy_Behavior\": \"Use IE settings\",\n  \"Watermark\": 1359593325,\n\n```\n\n-----\n\n```\n  bStageCleanup : False,\n  \"bCFGCaution\": \"False\",\n  \"KillDate\": 0,\n  \"bProcInject_StartRWX\": \"True\",\n  \"bProcInject_UseRWX\": \"True\",\n  \"bProcInject_MinAllocSize\": 0,\n  \"ProcInject_PrependAppend_x86\": \"Empty\",\n  \"ProcInject_PrependAppend_x64\": \"Empty\",\n  \"ProcInject_Execute\": [\n    \"CreateThread\",\n    \"SetThreadContext\",\n    \"CreateRemoteThread\",\n    \"RtlCreateUserThread\"\n  ],\n  \"ProcInject_AllocationMethod\": \"VirtualAllocEx\",\n  \"ProcInject_Stub\": \"DOL1VETkeTUWta/pZ76SVQ==\",\n  \"bUsesCookies\": \"True\",\n  \"HostHeader\": \"\",\n  \"smbFrameHeader\":\n\"AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n  \"tcpFrameHeader\":\n\"AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n  \"headersToRemove\": \"Not Found\",\n  \"DNS_Beaconing\": \"Not Found\",\n  \"DNS_get_TypeA\": \"Not Found\",\n  \"DNS_get_TypeAAAA\": \"Not Found\",\n  \"DNS_get_TypeTXT\": \"Not Found\",\n  \"DNS_put_metadata\": \"Not Found\",\n  \"DNS_put_output\": \"Not Found\",\n  \"DNS_resolver\": \"Not Found\",\n  \"DNS_strategy\": \"Not Found\",\n  \"DNS_strategy_rotate_seconds\": \"Not Found\",\n  \"DNS_strategy_fail_x\": \"Not Found\",\n  \"DNS_strategy_fail_seconds\": \"Not Found\"\n}\n\n```\nAdversaries are very opportunistic, often after headliner events like this, we see spam campaigns\nthat ride on a premise of such events. So the usual message applies, keep cautious of email,\nespecially unsolicited ones, and think twice before opening attachments.\n\n## Final Words\n\nThe notoriety and increasing threat posed by ransomware attacks have been impossible to prevent.\nWe recommend having a good backup solution, and this is crucial and of utmost importance\nnowadays. Also, implementing a good patch management program could help add an additional\nlayer of security. These previous Trustwave blogs provide more advice on how to be prepared for\nransomware attacks.\n\n[Trustwave Managed IDS is deploying signatures to detect this campaign. Trustwave MailMarshal](https://www.trustwave.com/en-us/services/technology/intrusion-detection-and-prevention/)\nhas detections in place for the Kaseya-themed scam email. Additionally Trustwave Security Testing\nServices are deploying checks for Kaseya VSA and customers should be able to scan and detect\nVSA instances once the check is available. Thanks also to Diana Lopera and Karl Sigler for their\nhelp and research in developing this post.\n\n\n-----\n\n## IOCs\n\n**IOCs for REvil / Kaseya:**\n\n**_File:_**\n\nSHA256: d55f983c994caa160ec63a59f6b4250fe67fb3e8c43a388aec60a4a6978e9f1e\n\nagent.exe\n\n**IOCs for Spam Campaign:**\n\n**_File:_**\n\nSHA1: 7B6621202AC7795E89891B7BD65E769BA6C267C5\n\nSecurityUpdates.exe\n\n**_Network:_**\n\nhxxp://45[.]153[.]241[.]113/download/pload[.]exe\n\nhxxp://31[.]42[.]177[.]52/dpixel\n\nhxxp://31[.]42[.]177[.]52/submit.php\n\n## References and Further Reading\n\nTrustwave Customer Response:\n\nhttps://www.trustwave.com/en-us/resources/blogs/trustwave-blog/kaseya-vsa-zero-day-ransomwareattack/\n\nPrior Analysis Trustwave Analysis of REvil:\n\n[https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/undressing-the-revil/](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/undressing-the-revil/)\n\nAnalysis of REvil 2.2:\n\n[https://intel471.com/blog/changes-in-revil-ransomware-version-2-2](https://intel471.com/blog/changes-in-revil-ransomware-version-2-2)\n\nFurther Analysis of REvil:\n\n[https://blog.amossys.fr/sodinokibi-malware-analysis.html](https://blog.amossys.fr/sodinokibi-malware-analysis.html)\n\nKaseya VSA Detection ToolKaseya VSA Detection Tool:\n\n[https://kaseya.app.box.com/s/0ysvgss7w48nxh8k1xt7fqhbcjxhas40](https://kaseya.app.box.com/s/0ysvgss7w48nxh8k1xt7fqhbcjxhas40)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-07 - Diving Deeper Into the Kaseya VSA Attack- REvil Returns and Other Hackers Are Riding Their Coattails.pdf"
    ],
    "report_names": [
        "2021-07-07 - Diving Deeper Into the Kaseya VSA Attack- REvil Returns and Other Hackers Are Riding Their Coattails.pdf"
    ],
    "threat_actors": [
        {
            "id": "f809bfcb-b200-4988-80a8-be78ef6a52ef",
            "created_at": "2023-01-06T13:46:39.186988Z",
            "updated_at": "2025-03-27T02:00:03.016358Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "Adept Libra"
            ],
            "source_name": "MISPGALAXY:TeamTNT",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c3ca592f-0669-49bd-ab5c-310007ab2fb4",
            "created_at": "2022-10-25T15:50:23.334495Z",
            "updated_at": "2025-03-27T02:00:55.445098Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "TeamTNT"
            ],
            "source_name": "MITRE:TeamTNT",
            "tools": [
                "Peirates",
                "MimiPenguin",
                "LaZagne",
                "Hildegard"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536058,
    "ts_updated_at": 1743041166,
    "ts_creation_date": 1653753276,
    "ts_modification_date": 1653753276,
    "files": {
        "pdf": "https://archive.orkl.eu/b9543d367592ae4b0889799f4b496b2fce99d9ed.pdf",
        "text": "https://archive.orkl.eu/b9543d367592ae4b0889799f4b496b2fce99d9ed.txt",
        "img": "https://archive.orkl.eu/b9543d367592ae4b0889799f4b496b2fce99d9ed.jpg"
    }
}