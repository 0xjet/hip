{
    "id": "d52ad930-4c49-4dba-8719-2f7f7d73d64b",
    "created_at": "2023-01-12T15:06:50.511681Z",
    "updated_at": "2025-03-27T02:16:34.846486Z",
    "deleted_at": null,
    "sha1_hash": "f8e6ffd447848e0e75311383d6c39df5fd453fe0",
    "title": "2021-03-10 - Monitoring the Software Supply Chain with Azure Sentinel",
    "authors": "",
    "file_creation_date": "2022-05-27T21:59:07Z",
    "file_modification_date": "2022-05-27T21:59:07Z",
    "file_size": 738121,
    "plain_text": "# Monitoring the Software Supply Chain with Azure Sentinel\n\n**techcommunity.microsoft.com/t5/azure-sentinel/monitoring-the-software-supply-chain-with-azure-sentinel/ba-**\np/2176463\n\nMarch 10, 2021\n\nMar 10 2021 08:30 AM\n\nThe recent [NOBELIUM](https://www.microsoft.com/security/blog/2021/03/04/goldmax-goldfinder-sibot-analyzing-nobelium-malware/) [incident has brought the issue of supply chain security into sharp](https://aka.ms/solorigate)\nfocus, particularly that of the software supply chain. In this blog we will look at why it is\nimportant for organizations to monitor their software development, build, and release process\nto help secure their own internal software supply chains as well as the those of wider\nindustry.\n\nWhilst this blog looks specifically at the NOBELIUM related activity as one example, it goes\nfar beyond this activity to look at other monitoring opportunities in Continuous\nIntegration/Continuous Deployment (CI/CD) solutions.\n\nThis blog uses Microsoft’s security monitoring solution Azure Sentinel, and Microsoft’s cloud\nCI/CD solution Azure DevOps as the focus point, however the monitoring principles and\napproaches could also be applied to other technology stacks.\n\nCovered in this blog:\n\nRecent history of Software Supply Chain Attacks\n\n\n-----\n\nImportance of Monitoring and Data Collection requirements\nHow to Monitor via Azure Sentinel for NOBELIUM Activity and Beyond\n\n### The Recent History of Software Supply Chain Attacks\n\nWhilst the NOBELIUM incident was the latest high profile software supply chain attack, it is\nfar from the first such attack; [NotPetya and](https://www.microsoft.com/security/blog/2017/06/27/new-ransomware-old-techniques-petya-adds-worm-capabilities/?cn=cmV0d2VldA%3D%3D?source=mmpc) [CCleaner attacks were both high profile software](https://blog.avast.com/update-to-the-ccleaner-5.33.6162-security-incident)\nsupply chain attack examples. These supply chain attacks have seen threat actors target a\ndifferent part of the software development and release process, for different outcomes.\n\n[For the NOBELIUM incident, we know from the report from CrowdStrike that attackers](https://www.crowdstrike.com/blog/sunspot-malware-technical-analysis/?s=09)\nused sophisticated malware to silently inject malicious code into files before building\nthem, and then covering its tracks.\nIn the case of NotPetya, it is suspected that attackers compromised a vulnerable server\nused to distribute the software and replaced the legitimate code with their compromised\nversion.\nWith CCleaner, the exact compromise process is not known but the reporting provided\nby Avast shows that attackers compromised several machines including a build server.\n[Microsoft has previously detected threat actors compromising software packages used](https://www.microsoft.com/security/blog/2018/07/26/attack-inception-compromised-supply-chain-within-a-supply-chain-poses-new-risks/#:~:text=A%20new%20software%20supply%20chain%20attack%20unearthed%20by,installer%20the%20unsuspecting%20carrier%20of%20a%20malicious%20payload.)\nby other software developers to insert malicious code into the final software packages.\n\nThe range of attacks here shows that it is important that all organizations conducting\nsoftware development invest time and effort into securing their build and release processes.\n\n### The Importance of Monitoring\n\nMonitoring and response are critical elements of any security program. When it comes to\nsoftware development, build, and release processes monitoring is especially important.\n\nThe list of previous attacks targeting these processes show that many processes include\nopportunities for attackers, and the fast-paced, collaborative, and innovative nature of\nsoftware development can mean that maintaining comprehensive preventative controls is\ninfeasible. Thankfully for defenders, the data provided by most software development, build,\nand release processes presents multiple threat detection opportunities, and organizations\nshould ensure that effective monitoring is conducted for as many of these opportunities as\npossible in order to detect and respond to threats that might target the process.\n\n## How to Monitor with Azure Sentinel\n\nMicrosoft Azure Sentinel is Microsoft’s scalable, cloud-native, security information event\nmanagement (SIEM) and security orchestration automated response (SOAR) solution. Azure\nSentinel allows organizations to easily collect data at cloud scale across all users, devices,\n\n\n-----\n\nservices and locations. This makes it an ideal platform for collecting auditing data from a\nwide range of software development, build, and release processes whether it be on-premises\nbuild agents or a cloud hosted CI/CD solution.\n\nOnce data is collected into Azure Sentinel it's possible to conduct advanced investigations\ninto the data, as well as set up proactive detections for future activity. By leveraging this\ncapability organizations can identify threats targeting their software development, build, and\nrelease process as well as act proactively to identify future threats, allowing them to secure\ntheir internal software supply chains as well as protect consumers further down the supply\nchain.\n\nIn the following sections we will look first at the monitoring opportunities available for the\nspecific threat of NOBELIUM before then moving to look at other monitoring opportunities in\nCI/CD solutions, focusing on Azure DevOps. Each section will address how to collect the\nrequired data, and how to hunt for activity and establish proactive monitoring for future\nthreats.\n\n## Monitoring Opportunities for NOBELIUM Activity\n\nDue to the reporting of several parties involved in the response to the NOBELIUM attack\nincluding FireEye, CrowdStrike, and SolarWinds we have insight into how the attackers\noperated, including at the software build compromise level. Details of the SolarWinds\n[software compromise SUNSPOT malware can be found in the CrowdStrike report but a](https://www.crowdstrike.com/blog/sunspot-malware-technical-analysis/?s=09)\nsummary of the actions taken by the actor include:\n\n1. Deploy malware on build server, set mutexes and log files locally.\n2. Monitor for the build process to start and, when run, check the command line\n\narguments passed to it indicate the building of targeted software packages.\n3. If targeted software is being built, create a backup of the legitimate code files on disk\n\nand replace the target code files with malicious code files.\n4. Once build is complete, replace malicious code files with legitimate code from the\n\nbackups created.\n\nThese details allow for the identification of two key monitoring opportunities:\n\n1. Detect the initial deployment of malware onto build servers.\n2. Modification of source code files during build process execution.\n\n**Data collection with Microsoft Defender for Endpoint**\n\nBefore defining precise monitoring logic, you must collect relevant data on which to apply\nlogic to.\n\n\n-----\n\nOne way of getting the data required to enable both opportunities is to deploy Microsoft\nDefender for Endpoint (MDE) to build servers. Not only will this provide in build detections for\nthe known SUNSPOT malware it will also provide telemetry to Azure Sentinel that can be\nused to hunt for malware artifacts as well as the modification of source code files.\n\nFor more information on how to connect MDE to Azure Sentinel, see the Azure Sentinel\ndocumentation.\n\n**Data collection with Windows Event Logs**\n\nFor organizations without MDE, it's still possible to enable the second of our two detection\nopportunities using Windows Event Logs.\n\nFor this opportunity, you must collect events from:\n\n**Build servers relating to process creation, to detect when a build process is started**\n**File modification events, to detect when code files are modified**\n\nIn Windows Event Logs, these are represented by:\n\n**Event ID** **[4688: A new process has been created](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688)**\n**Event ID** **[4663 An attempt was made to access an object](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4663)**\n\n**Enabling 4688 Event Collection**\n\nTo enable the Audit Process Creation policy to generate 4688 events, edit the following\ngroup policy:\n\n**Computer Configuration > Policies > Windows Settings > Security Settings >**\n**Advanced Audit Configuration > Detailed Tracking > Audit Process Creation**\n\n\n-----\n\n**Enabling 4663 Event Collection**\n\nTo enable Audit Object Access policy to generate 4663 events, edit the following group\npolicy:\n\n**Computer Configuration > Policies > Windows Settings > Security Settings > Local**\n**Policies > Audit Policy > Audit object access**\n\n**Setting security access control lists on collection objects**\n\n\n-----\n\n[Once enabled, it is also necessary to set a security access control list (SACL) on the specific](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-lists?redirectedfrom=MSDN)\nobjects to collect these events.\n\nDue to the volume of events generated by this policy, we recommend that these SACLs only\nbe applied to a very limited subset of folders. SACLs specifically applied to files are removed\nwhen the file is deleted, so we recommend that:\n\nThese SACLs be applied at the lowest level of folder that isn’t going to be regularly\nmodified as part of the build process\nInheritance be set to ensure SACLs are applied to all files created under these\nfolders[i]\n\nFor this build compromise scenario, SACLs should ideally be enabled for folders that contain\nsource files being built. Security teams will need to work with development teams to identify\nwhere these files are stored on build servers.\n\nOnce identified, auditing of them can be enabled by selecting the relevant folder properties,\nselecting the Security tab, and clicking Advanced.\n\nIn the window that opens:\n\n1. Select the Auditing tab, and add an audit policy.\n2. Select Principal and set this to Everyone, and then select the Full control permission\n\nbox.\n3. Finally ensure that Applies to is set to the appropriate scope for the code files being\n\nmonitored[ii].\n\n\n-----\n\nIn addition to generating the events on build servers, you must also ensure that the events\nare being collected by Azure Sentinel to allow for querying and detection of them.\n\n**Detections**\n\nOnce the required data has been collected organizations can establish detections to detect\nfuture (or historical) activity like the NOBELIUM build process compromise.\n\nThe Microsoft Threat Intelligence Center (MSTIC) has created a detection query for Azure\nSentinel to look for the pattern of code files being modified when a build process is run within\nthe Windows Event Logs discussed above. This detection logic was chosen to allow for the\npotential detection of other threat actors attempting to perform any similar attack, rather than\njust a detection of the specific SUNSPOT malware.\n\nThe query below contains several customizable elements to help defenders reduce false\npositive rates, these have been configured by default for a generic environment where\nC++/C# development is being conducted. The customizable elements are as follows:\n\n**timeframe – how often (and far back) to run the detection.**\n**time_window – how close together should build process creation and code file**\nmodification occur for a detection to be raised.\n**build_processes – a list of process names associated with build processes.**\n**allow_list - a list of processes that are known to modify code files and should be**\nexcluded for detections.\n\n\n-----\n\nYou can also edit the types of source code files to look for. By default, the query is configured\nfor .cp and .ccp files.\n\nTo proactively identify future threats, we recommend that organizations run the following\nquery against historical datasets, as well as enable it in Azure Sentinel as an Analytics rule:\n```\n// How far back to look for events from\nlet timeframe = 1d;\n// How close together build events and file modifications should occur to alert (make\nthis smaller to reduce FPs)\nlet time_window = 5m;\n// Edit this to include build processes used\nlet build_processes = dynamic([\"MSBuild.exe\", \"dontnet.exe\", \"VBCSCompiler.exe\"]);\n// Include any processes that you want to allow to edit files during/around the build\nprocess\nlet allow_list = dynamic([\"\"]);\nSecurityEvent\n| where TimeGenerated > ago(timeframe)\n// Look for build process starts\n| where EventID == 4688\n| where Process has_any (build_processes)\n| summarize by BuildParentProcess=ParentProcessName, BuildProcess=Process,\nBuildAccount = Account, Computer, BuildCommand=CommandLine, timekey=\nbin(TimeGenerated, time_window), BuildProcessTime=TimeGenerated\n| join kind=inner(\nSecurityEvent\n| where TimeGenerated > ago(timeframe)\n// Look for file modifications to code file\n| where EventID == 4663\n| where Process !in (allow_list)\n// Look for code files, edit this to include file extensions used in build.\n| where ObjectName endswith \".cs\" or ObjectName endswith \".cpp\"\n// 0x6 and 0x4 for file append, 0x100 for file replacements\n| where AccessMask == \"0x6\" or AccessMask == \"0x4\" or AccessMask == \"0X100\"\n| summarize by FileEditParentProcess=ParentProcessName, FileEditAccount = Account,\nComputer, FileEdited=ObjectName, FileEditProcess=ProcessName, timekey=\nbin(TimeGenerated, time_window), FileEditTime=TimeGenerated)\n// join where build processes and file modifications seen at same time on same host\non timekey, Computer\n// Limit to only where the file edit happens after the build process starts\n| where BuildProcessTime <= FileEditTime\n| summarize make_set(FileEdited), make_set(FileEditProcess),\nmake_set(FileEditAccount) by timekey, Computer, BuildParentProcess, BuildProcess\n\n```\nIf you have Microsoft Defender for Endpoint (MDE) in your build servers you can also use the\nfollowing Azure Sentinel query that uses MDE telemetry in place of Windows Event logs:\n\n\n-----\n\n```\n// How far back to look for events from\nlet timeframe = 1d;\n// How close together build events and file modifications should occur to alert (make\nthis smaller to reduce FPs)\nlet time_window = 5m;\n// Edit this to include build processes used\nlet build_processes = dynamic([\"MSBuild.exe\", \"dontnet.exe\", \"VBCSCompiler.exe\"]);\n// Include any processes that you want to allow to edit files during/around the build\nprocess\nlet allow_list = dynamic([]);\nDeviceProcessEvents\n| where TimeGenerated > ago(timeframe)\n// Look for build process starts\n| where FileName has_any (build_processes)\n| summarize by BuildParentProcess=InitiatingProcessFileName, BuildProcess=FileName,\nBuildAccount = AccountName, DeviceName, BuildCommand=ProcessCommandLine, timekey=\nbin(TimeGenerated, time_window), BuildProcessTime=TimeGenerated\n| join kind=inner(\nDeviceFileEvents\n| where TimeGenerated > ago(timeframe)\n| where InitiatingProcessFileName !in (allow_list)\n| where ActionType == \"FileCreated\" or ActionType == \"FileModified\"\n// Look for code files, edit this to include file extensions used in build.\n| where FileName endswith \".cs\" or FileName endswith \".cpp\"\n| summarize by FileEditParentProcess=InitiatingProcessParentFileName, FileEditAccount\n= InitiatingProcessAccountName, DeviceName, FileEdited=FileName,\nFileEditProcess=InitiatingProcessFileName, timekey= bin(TimeGenerated, time_window),\nFileEditTime=TimeGenerated)\n// join where build processes and file modifications seen at same time on same host\non timekey, DeviceName\n// Limit to only where the file edit happens after the build process starts\n| where BuildProcessTime <= FileEditTime\n| summarize make_set(FileEdited), make_set(FileEditProcess),\nmake_set(FileEditAccount) by timekey, DeviceName, BuildParentProcess, BuildProcess\n\n```\nYou can also use MDE telemetry to look for specific IOCs related to the SUNSPOT malware\nwith the following Azure Sentinel queries:\n```\nlet SUNSPOT_Hashes =\ndynamic([\"c45c9bda8db1d470f1fd0dcc346dc449839eb5ce9a948c70369230af0b3ef168\",\n\"0819db19be479122c1d48743e644070a8dc9a1c852df9a8c0dc2343e904da389\"]);\nunion isfuzzy=true(\nDeviceEvents\n| where InitiatingProcessSHA256 in (SUNSPOT_Hashes)),\n(DeviceImageLoadEvents\n| where InitiatingProcessSHA256 in (SUNSPOT_Hashes))\nunion isfuzzy=true\n(DeviceFileEvents\n| where FolderPath endswith \"vmware-vmdmp.log\"),\n(SecurityEvent\n| where EventID == 4663\n| where ObjectName endswith \"vmware-vmdmp.log\")\n\n```\n\n-----\n\n## Other Monitoring Opportunities for Build Process Threats\n\nIn the last section we explored the monitoring opportunities related to the NOBELIUM build\nprocess compromise. However, as detailed in the opening of this blog, NOBELIUM is not the\nonly attack targeting software development, build, and release processes.\n\nAs such, organizations need to have monitoring in place for a broader scope of activity than\njust that represented by NOBELIUM. In this section we focus on other monitoring\nopportunities that exist in CI/CD solutions, using Azure DevOps as an example and again\nusing Azure Sentinel as the monitoring solution.\n\nThe same monitoring opportunities can be applied to other CI/CD solutions and implemented\nusing other monitoring technologies. By sharing details via this blog, Microsoft hopes to help\nthe largest number of organizations possible, whether they are Azure Sentinel customers or\nnot.\n\n### Azure DevOps\n\n[Azure DevOps and specifically Azure Pipelines provide software development, build, and](https://azure.microsoft.com/en-us/solutions/devops/#products)\ndeployment services in the cloud. An attacker looking to compromise a build process of an\norganization who use these services is going to have to interact with the service. Due to\nAzure DevOps auditing capabilities any such interaction is going to provide defenders with\nopportunities to monitor for and detect any suspicious behavior.\n\nAs with nearly all cloud services, identity is the primary security boundary for Azure DevOps\n[services. MSTIC has provided multiple detections and](https://github.com/Azure/Azure-Sentinel/tree/master/Detections/SigninLogs) [hunting queries for cloud identity](https://github.com/Azure/Azure-Sentinel/tree/master/Hunting%20Queries/SigninLogs)\nactivity. Defenders should leverage these to identify suspicious identity events relating to\nthese services. Additionally, Azure DevOps provides granular logging related to user activity\nwhich should be collected and monitored.\n\n**Collecting Azure DevOps Audit Logs with Azure Sentinel**\n\nAzure DevOps audit logs are accessible via the Azure DevOps portal by logging in, selecting\n**Organization** **settings > Auditing[iii].**\n\n\n-----\n\nSecurity teams using Azure Sentinel should also ingest these logs into Azure Sentinel so that\nthe logs can be correlated with other data, and so that Azure Sentinel’s security analytics\ncapabilities can be applied to the logs. You can ingest these logs into Azure Sentinel via an\naudit stream.\n\nGo to Azure Dev Ops > Organization Settings > Auditing > Streams > New stream >\n**Azure Monitor Logs**\n\n\n-----\n\nYou will then be prompted to provide a Workspace ID, and Shared Key. These should be\nthe Workspace ID and Access Key of your Azure Sentinel Instance.\n\nThese can be found by going to Azure Sentinel > Settings > Workplace settings > Agents\n**Management.**\n\nOnce configured, Azure DevOps audit logs will appear in your Azure Sentinel Workspace\nunder the AzureDevOpsAuditing table.\n\nMore details on configuring Azure DevOps Auditing streams can be found in the Azure\nDevOps documentation.\n\n### Monitoring and Hunting in Azure DevOps Audit Logs\n\n\n-----\n\nThe [Azure DevOps Audit Log is a rich data source that provides significant details about](https://docs.microsoft.com/en-us/azure/devops/organizations/audit/azure-devops-auditing?view=azure-devops&tabs=preview-page)\nmost[iv] actions users can take. Below are details of some of the key fields to understand\nwhen threat hunting in this data.\n\n**Field Name** **Description**\n\n**ActorUPN** The UPN of the user performing the action (or Object Id if a Service\nPrincipal).\n\n**ActorDisplayName** The friendly display name of the user performing the action.\n\n\n**Authentication**\n**Mechanism**\n\n\nHow the user authenticated to Azure DevOps – commonly seen\nare SessionToken, Oauth, and PAT (Personal Access Token). This\ncan be useful for hunting for administrative actions conducted via\nan authentication method not commonly seen.\n\n\n**ScopeDisplayName** The scope an operation was applied to. This shows the name of\nthe object scoped, and the type of object. E.g. ‘name (type)’\n\n**ProjectName** The name of the [Azure DevOps project the action was applied to.](https://docs.microsoft.com/en-us/azure/devops/user-guide/plan-your-azure-devops-org-structure?bc=%2Fazure%2Fdevops%2Fget-started%2Fbreadcrumb%2Ftoc.json&toc=%2Fazure%2Fdevops%2Fget-started%2Ftoc.json&view=azure-devops#what-is-a-project)\n\n**IpAddress** Client IP of the user performing the action.\n\n**UserAgent** The UserAgent string of the user performing the action.\n\n**Area** The high level type of action performed, these generally correlate\nto the core features of Azure DevOps.\n\n**OperationName** The specific Operation carried out. Format is\nAreaName.ActionName. e.g. Policy.PolicyConfigModified\n\n**Details** String description of the Operations details.\n\n**Data** Dynamic data object containing specific details of the operation,\nthe structure depends on the Operation.\n\n\n-----\n\n**Category** High level category of the Operations, e.g. Modify, Create, Delete\n\nThis data source provides a wide range of monitoring opportunities and MSTIC has\ncollaborated with teams across Azure to develop Azure Sentinel detections and hunting\nqueries using this data, for potential software build compromise activity.\n\nUnlike with the NOBELIUM monitoring opportunities, where each opportunity was an\nelement in a single attack, the following queries each represent a separate, individual\nmonitoring opportunity that defenders can leverage to detect potentially malicious activity.\n\nAn attack may be detected at one or more of these opportunities depending on its nature.\nFor each opportunity we present a short summary of each opportunity, its significance for\n[defenders and its position in an attack based on Mitre ATT&CK.](https://attack.mitre.org/)\n\n### Detections\n\nThese queries are designed to be more accurate indicators of malicious activity than Hunting\nQueries. Whilst False Positives (FPs) are possible, the rates should be significantly smaller\nthan with Hunting Queries and therefore the output of these can be considered more reliable\nindicators of malicious attacker activity.\n\n### Detection Name Description\n\n\n**New PA, PCA, or**\n**[PCAS added to Azure](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AzureDevOpsAuditing/NewPAPCAPCASaddedtoADO.yaml)**\n**DevOps**\n\n**Build Agents Added of**\n**[new OS Type or New](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AzureDevOpsAuditing/NewAgentAddedToPoolbyNewUserorofNewOS.yaml)**\n**User**\n\n**ADO Agent Pool**\n**Created and Deleted**\n\n**External Upstream**\n**[Source Added to](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AzureDevOpsAuditing/ExternalUpstreamSourceAddedtoAzureDevOpsFeed.yaml)**\n**Azure DevOps Feed**\n\n**Build Pipeline Created**\n**[and Deleted in One](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AzureDevOpsAuditing/AzDOPipelineCreatedDeletedOneDay.yaml)**\n**Day**\n\n\nDetects new privileged users being added to Azure DevOps.\n\nDetects anomalous types of build agents being added to a pool.\n\nLooks for a new Agent Pool being created and then deleted\nwithin 7 days of creation\n\nDetects new external package sources being added to Azure\nDevOps\n\nDetects an Azure Pipeline being created and then deleted\nwithin the same day.\n\n\n-----\n\n**[Audit Stream Disabled](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AzureDevOpsAuditing/ADOAuditStreamDisabled.yaml)** Detects the Azure DevOps Audit Log connection to Azure\nSentinel being disabled.\n\n\n**Pipeline Modified by**\n**[User who hasn’t](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AzureDevOpsAuditing/ADOPipelineModifiedbyNewUser.yaml)**\n**modified it before**\n\n**Variable Group**\n**Modified by New User**\n\n\nDetects an Azure Pipeline being modified by a user account\nthat hasn’t previous modified that pipeline.\n\nDetects a Variable Group in Azure DevOps being modified by a\nuser who has not previously modified variable groups.\n\n\n**[New Extension Added](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AzureDevOpsAuditing/ADONewExtensionAdded.yaml)** Detects new extensions being added to Azure DevOps where\nthey are not from an allowed list of publishers.\n\n\n**Pipeline Retention**\n**[Settings Reduced to](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AzureDevOpsAuditing/ADORetentionReducedto0.yaml)**\n**Zero.**\n\n**PAT used with**\n**browser**\n\n\nDetects a key retention setting on a pipeline element (runs and\nartifacts) being reduced to zero.\n\nDetects Azure DevOps activity that authenticates with a\nPersonal Access Token (PAT) but has a UserAgent that\nindicates and interactive browser session.\n\n\n**New PA, PCA, or PCAS added to Azure DevOps**\n\n**ATT&CK Technique:** **[T1078.004](https://attack.mitre.org/techniques/T1078/004/)**\n\n**Description: In order for an attacker to be able to interact with any CI/CD solution they will**\nneed to gain elevated permissions. In Azure DevOps these permissions take the form of a\nsmall number of key administrative permissions. If the principle of least privilege is applied\nthe number of users granted these permissions should be small. Note that permissions can\nalso be granted via\n\nThis query gets details of accounts added to these roles and joins it with a summary of the\noperations conducted by that user immediately after being granted these permissions in\norder to provide analysts with context.\n\n**Query:**\n\nSpoiler\n\n\n-----\n\n```\nAzureDevOpsAuditing\n| where OperationName =~ \"Group.UpdateGroupMembership.Add\"\n| where Details has_any (\"Project Administrators\", \"Project Collection\nAdministrators\", \"Project Collection Service Accounts\", \"Build Administrator\")\n| project-reorder TimeGenerated, Details, ActorUPN, IpAddress, UserAgent,\nAuthenticationMechanism, ScopeDisplayName\n| extend timekey = bin(TimeGenerated, 1h)\n| extend ActorUserId = tostring(Data.MemberId)\n| project timekey, ActorUserId, AddingUser=ActorUPN, TimeAdded=TimeGenerated,\nPermissionGrantDetails = Details\n| join (AzureDevOpsAuditing\n| extend timekey = bin(TimeGenerated, 1h)) on timekey, ActorUserId\n| summarize ActionsWhenAdded = make_set(OperationName) by ActorUPN, AddingUser,\nTimeAdded, PermissionGrantDetails\n\n```\n**Build Agents Added of new OS Type or New User**\n\n**ATT&CK Technique:** **[T1053](https://attack.mitre.org/techniques/T1053/)**\n\n**Description: As seen with threata actors such as NOBELIUM, attackers can look to subvert**\na build process by controlling build servers. Azure DevOps uses agent pools to execute\npipeline tasks. An attacker could insert compromised agents that they control into the pools\nin order to execute malicious code. This query looks for users adding agents to pools they\nhave not added agents to in the last 30 days or adding agents to a pool of an OS that has\nnot been added to that pool in the last 30 days. This detection has potential for false\npositives so has a configurable allow list to allow for certain users to be excluded from the\nlogic.\n\n**Query:**\n\nSpoiler\n\n\n-----\n\n```\nlet lookback 14d;\nlet timeframe = 1d;\n// exclude allowed users from query such as the ADO service\nlet allowed_users = dynamic([\"Azure DevOps Service\"]);\nunion\n// Look for agents being added to a pool of a OS type not seen with that pool before\n(AzureDevOpsAuditing\n| where TimeGenerated > ago(lookback) and TimeGenerated < ago(timeframe)\n| where OperationName =~ \"Library.AgentAdded\"\n| where ActorUPN !in (allowed_users)\n| extend AgentPoolName = tostring(Data.AgentPoolName)\n| extend OsDescription = tostring(Data.OsDescription)\n| where isnotempty(OsDescription)\n| extend OsDescription = tostring(split(OsDescription, \"#\", 0)[0])\n| project AgentPoolName, OsDescription\n| join kind=rightanti (AzureDevOpsAuditing\n| where TimeGenerated > ago(timeframe)\n| where OperationName == \"Library.AgentAdded\"\n| extend AgentPoolName = tostring(Data.AgentPoolName)\n| extend OsDescription = tostring(Data.OsDescription)\n| where isnotempty(OsDescription)\n| extend OsDescription = tostring(split(OsDescription, \"#\", 0)[0])) on AgentPoolName,\nOsDescription),\n// Look for users addeing agents to a pool that they have not added agents to before.\n(AzureDevOpsAuditing\n| where TimeGenerated > ago(lookback) and TimeGenerated < ago(timeframe)\n| extend AgentPoolName = tostring(Data.AgentPoolName)\n| where ActorUPN !in (allowed_users)\n| project AgentPoolName, ActorUPN\n| join kind=rightanti (AzureDevOpsAuditing\n| where TimeGenerated > ago(timeframe)\n| where OperationName == \"Library.AgentAdded\"\n| where ActorUPN !in (allowed_users)\n| extend AgentPoolName = tostring(Data.AgentPoolName)\n) on AgentPoolName, ActorUPN)\n| extend AgentName = tostring(Data.AgentName)\n| extend OsDescription = tostring(Data.OsDescription)\n| extend SystemDetails = Data.SystemCapabilities\n| project-reorder TimeGenerated, OperationName, ScopeDisplayName, AgentPoolName,\nAgentName, ActorUPN, IpAddress, UserAgent, OsDescription, SystemDetails, Data\n\n```\n**ADO Agent Pool Created and Deleted.**\n\n**ATT&CK Technique:** **[T1578](https://attack.mitre.org/techniques/T1578/)**\n\n**Description: As well as adding build agents to an existing pool to execute malicious activity**\nwithin a pipeline an attacker could create a completely new agent pool and use this for\nexecution. Azure DevOps allows for the creation of agent pools with Azure hosted\ninfrastructure or self-hosted infrastructure. Given the additional customizability of self-hosted\nagents this detection focuses on the creation of new self-hosted pools. To further reduce\n\n\n-----\n\nfalse positive rates the detection looks for pools created and deleted quickly (within 7 days\nby default), as an attacker is likely to remove a malicious pool once used to reduce/remove\nevidence of their activity.\n\n**Query:**\n\nSpoiler\n```\nlet lookback = 14d;\nlet timewindow = 7d;\nAzureDevOpsAuditing\n| where TimeGenerated > ago(lookback)\n| where OperationName =~ \"Library.AgentPoolCreated\"\n| extend AgentCloudId = tostring(Data.AgentCloudId)\n| extend PoolType = iif(isnotempty(AgentCloudId), \"Azure VMs\", \"Self Hosted\")\n// Comment this line out to include cloud pools as well\n| where PoolType =~ \"Self Hosted\"\n| extend AgentPoolName = tostring(Data.AgentPoolName)\n| extend AgentPoolId = tostring(Data.AgentPoolId)\n| extend IsHosted = tostring(Data.IsHosted)\n| extend IsLegacy = tostring(Data.IsLegacy)\n| extend timekey = bin(TimeGenerated, timewindow)\n// Join only with pools deleted in the same window\n| join (AzureDevOpsAuditing\n| where TimeGenerated > ago(lookback)\n| where OperationName =~ \"Library.AgentPoolDeleted\"\n| extend AgentPoolName = tostring(Data.AgentPoolName)\n| extend AgentPoolId = tostring(Data.AgentPoolId)\n| extend timekey = bin(TimeGenerated, timewindow)) on AgentPoolId, timekey\n| project-reorder TimeGenerated, ActorUPN, UserAgent, IpAddress,\nAuthenticationMechanism, OperationName, AgentPoolName, IsHosted, IsLegacy, Data\n\n```\n**External Upstream Source Added to Azure DevOps Feed**\n\n**ATT&CK Technique:** **[T1199](https://attack.mitre.org/techniques/T1199/)**\n\n**Description: Build pipelines often take dependencies from other pipelines or other feeds as**\npart of the process. An attacker could compromise the build process by introducing a\ncompromised upstream item. The detection looks for new external sources added to an\nAzure DevOps feed that may detect the addition of a malicious source. An allow list can be\ncustomized to explicitly allow known good sources.\n\nReference: https://www.microsoft.com/security/blog/2018/07/26/attack-inceptioncompromised-supply-chain-within-....\n\n**Query:**\n\nSpoiler\n\n\n-----\n\n```\n// Add any known allowed sources and source locations to the filter below (the NuGet\nGallery has been added here as an example).\nlet allowed_sources = dynamic([\"NuGet Gallery\"]);\nlet allowed_locations = dynamic([\"https://api.nuget.org/v3/index.json\"]);\nAzureDevOpsAuditing\n     // Look for feeds created or modified at either the organization or project\nlevel\n     | where OperationName matches regex \"Artifacts.Feed.(Org|Project).Modify\"\n     | where Details has \"UpstreamSources, added\"\n     | extend FeedName = tostring(Data.FeedName)\n     | extend FeedId = tostring(Data.FeedId)\n     | extend UpstreamsAdded = Data.UpstreamsAdded\n     // As multiple feeds may be added expand these out\n     | mv-expand UpstreamsAdded\n     // Only focus on external feeds\n     | where UpstreamsAdded.UpstreamSourceType !~ \"internal\"\n     | extend SourceLocation = tostring(UpstreamsAdded.Location)\n     | extend SourceName = tostring(UpstreamsAdded.Name)\n     // Exclude sources and locations in the allow list\n     | where SourceLocation !in (allowed_locations) and SourceName !in\n(allowed_sources)\n     | extend SourceProtocol = tostring(UpstreamsAdded.Protocol)\n     | extend SourceStatus = tostring(UpstreamsAdded.Status)\n     | project-reorder TimeGenerated, OperationName, ScopeDisplayName,\nProjectName, FeedName, SourceName, SourceLocation, SourceProtocol, ActorUPN,\nUserAgent, IpAddress\n\n```\n**Build Pipeline Created and Deleted in One Day**\n\n**ATT&CK Technique:** **[T1072](https://attack.mitre.org/techniques/T1072/)**\n\n**Description: An attacker with access to a CI/CD solution could create a pipeline to inject**\nartifacts used by other pipelines, or to create a malicious software build that looks legitimate\nby using a pipeline that incorporates legitimate elements. An attacker would also likely want\nto cover their tracks once conducting such activity. This query looks for Azure DevOps\nPipelines created and deleted within the same day; this is unlikely to be legitimate user\nactivity in most cases.\n\n**Query:**\n\nSpoiler\n\n\n-----\n\n```\nlet timeframe 14d;\n// Get Release Pipeline Creation Events and group by day\nAzureDevOpsAuditing\n| where TimeGenerated > ago(timeframe)\n| where OperationName =~ \"Release.ReleasePipelineCreated\"\n// Group by day\n| extend timekey = bin(TimeGenerated, 1d)\n| extend PipelineId = tostring(Data.PipelineId)\n| extend PipelineName = tostring(Data.PipelineName)\n// Rename some columns to make output clearer\n| project-rename TimeCreated = TimeGenerated, CreatingUser = ActorUPN,\nCreatingUserAgent = UserAgent, CreatingIP = IpAddress\n// Join with Release Pipeline Deletions where Pipeline ID is the same and deletion\noccurred on same day as creation\n| join (AzureDevOpsAuditing\n| where TimeGenerated > ago(timeframe)\n| where OperationName =~ \"Release.ReleasePipelineDeleted\"\n// Group by day\n| extend timekey = bin(TimeGenerated, 1d)\n| extend PipelineId = tostring(Data.PipelineId)\n| extend PipelineName = tostring(Data.PipelineName)\n// Rename some things to make the output clearer\n| project-rename TimeDeleted = TimeGenerated, DeletingUser = ActorUPN,\nDeletingUserAgent = UserAgent, DeletingIP = IpAddress) on PipelineId, timekey\n| project TimeCreated, TimeDeleted, PipelineName, PipelineId, CreatingUser,\nCreatingIP, CreatingUserAgent, DeletingUser, DeletingIP, DeletingUserAgent,\nScopeDisplayName, ProjectName, Data, OperationName, OperationName1\n\n### Audit Stream Disabled\n\n```\n**ATT&CK Technique:** **[T1562.008](https://attack.mitre.org/techniques/T1562/008/)**\n\n**Description: Azure DevOps allows for audit logs to be streamed to external storage**\nsolutions such as SIEM solutions. An attacker looking to hide malicious Azure DevOps\nactivity from defenders may look to disable data streams before conducting activity and then\nre-enabling the data stream after (so as not to raise data threshold-based alarms). Looking\nfor disabled audit streams can identify this activity, and due to the nature of the action it is\nunlikely to have a high false positive rate.\n\n**Query:**\n\nSpoiler\n```\nAzureDevOpsAuditing\n| where OperationName =~ \"AuditLog.StreamDisabledByUser\"\n| extend StreamType = tostring(Data.ConsumerType)\n| project-reorder TimeGenerated, Details, ActorUPN, IpAddress, UserAgent, StreamType\n\n### Pipeline Modified by User who hasn’t modified it before.\n\n```\n**ATT&CK Technique:** **[T1584.006,](https://attack.mitre.org/techniques/T1584/006/)** **[T1578](https://attack.mitre.org/techniques/T1578/)**\n\n\n-----\n\n**Description: There are several potential pipeline steps that could be modified by an attacker**\nto inject malicious code into the build cycle. A likely attacker path is the modification to an\nexisting pipeline that they have access to. This detection looks for users modifying a pipeline\nwhen they have not previously been observed modifying or creating that pipeline before. This\n[query also joins events with data to Azure AD Identity Protection (AAD IdP) in order to show](https://docs.microsoft.com/azure/active-directory/identity-protection/overview-identity-protection)\nif the user conducting the action has any associated AAD IdP alerts, you can also choose to\nfilter this detection to only alert when the user also has AAD IdP alerts associated with them.\n\n**Query:**\n\nSpoiler\n```\n// Set the lookback to determine if user has created pipelines before\nlet timeback = 14d;\n// Set the period for detections\nlet timeframe = 1d;\n// Get a list of previous Release Pipeline creators to exclude\nlet releaseusers = AzureDevOpsAuditing\n| where TimeGenerated > ago(timeback) and TimeGenerated < ago(timeframe)\n| where OperationName in (\"Release.ReleasePipelineCreated\",\n\"Release.ReleasePipelineModified\")\n// We want to look for users performing actions in specic projects so we creat this\nuserscope object to match on\n| extend UserScope = strcat(ActorUserId, \"-\", ProjectName)\n| summarize by UserScope;\n// Get Release Pipeline creations by new users\nAzureDevOpsAuditing\n| where TimeGenerated > ago(timeframe)\n| where OperationName =~ \"Release.ReleasePipelineModified\"\n| extend UserScope = strcat(ActorUserId, \"-\", ProjectName)\n| where UserScope !in (releaseusers)\n| extend ActorUPN = tolower(ActorUPN)\n| project-away Id, ActivityId, ActorCUID, ScopeId, ProjectId, TenantId, SourceSystem,\nUserScope\n// See if any of these users have Azure AD alerts associated with them in the same\ntimeframe\n| join kind = leftouter (\nSecurityAlert\n| where TimeGenerated > ago(timeframe)\n| where ProviderName == \"IPC\"\n| extend AadUserId = tostring(parse_json(Entities)[0].AadUserId)\n| summarize Alerts=count() by AadUserId) on $left.ActorUserId == $right.AadUserId\n| extend Alerts = iif(isnotempty(Alerts), Alerts, 0)\n// Uncomment the line below to only show results where the user as AADIdP alerts\n//| where Alerts > 0\n\n```\n**Variable Group Modified by New User.**\n\n**ATT&CK Technique:** **[T1578](https://attack.mitre.org/techniques/T1578/)**\n\n\n-----\n\n**Description: Variables can be configured and used at any stage of the build process in**\nAzure DevOps to inject values. An attacker with the required permissions could modify or\nadd to these variables to conduct malicious activity such as changing paths or remote\nendpoints called during the build. As variables are often changed by users just detecting\nthese changes would have a high false positive rate. This detection looks for modifications to\nvariable groups where that user has not been observed modifying them before.\n\n**Query:**\n\nSpoiler\n```\nlet lookback = 14d;\nlet timeframe = 1d;\nlet historical_data =\nAzureDevOpsAuditing\n| where TimeGenerated > ago(lookback) and TimeGenerated < ago(timeframe)\n| where OperationName =~ \"Library.VariableGroupModified\"\n| extend variables = Data.Variables\n| extend VariableGroupName = tostring(Data.VariableGroupName)\n| extend VariableGroupId = tostring(Data.VariableGroupId)\n| extend UserKey = strcat(VariableGroupId, \"-\", ActorUserId)\n| project UserKey;\nAzureDevOpsAuditing\n| where TimeGenerated > ago(timeframe)\n| where OperationName =~ \"Library.VariableGroupModified\"\n| extend variables = Data.Variables\n| extend VariableGroupName = tostring(Data.VariableGroupName)\n| extend VariableGroupId = tostring(Data.VariableGroupId)\n| extend UserKey = strcat(VariableGroupId, \"-\", ActorUserId)\n| where UserKey !in (historical_data)\n| project-away UserKey\n| project-reorder TimeGenerated, VariableGroupName, ActorUPN, IpAddress, UserAgent\n\n```\n**New Extension Added.**\n\n**ATT&CK Technique:** **[T1505](https://attack.mitre.org/techniques/T1505/)**\n\n**Description: Extensions added additional features to Azure DevOps. An attacker could use**\na malicious extension to conduct malicious activity. This query looks for new extensions that\nare not from a configurable list of approved publishers.\n\n**Query:**\n\nSpoiler\n\n\n-----\n\n```\nlet allowed_publishers dynamic([]);\nAzureDevOpsAuditing\n| where OperationName =~ \"Extension.Installed\"\n| extend ExtensionName = tostring(Data.ExtensionName)\n| extend PublisherName = tostring(Data.PublisherName)\n| where PublisherName !in (allowed_publishers)\n| project-reorder TimeGenerated, OperationName, ExtensionName, PublisherName,\nActorUPN, IpAddress, UserAgent, ScopeDisplayName, ScopeType, Data\n\n```\n**Pipeline Retention Settings Reduced to Zero.**\n\n**ATT&CK Technique:** **[T1564](https://attack.mitre.org/techniques/T1564/)**\n\n**Description: AzureDevOps retains items such as run records and produced artifacts for a**\nconfigurable amount of time. An attacker looking to reduce the footprint left by their malicious\nactivity may look to reduce the retention time for artifacts and runs to 0.\n\n**Query:**\n\nSpoiler\n```\nAzureDevOpsAuditing\n| where OperationName =~ \"Pipelines.PipelineRetentionSettingChanged\"\n| where Data.SettingName in (\"PurgeArtifacts\", \"PurgeRuns\")\n| where Data.NewValue == 0\n| project-reorder TimeGenerated, OperationName, ActorUPN, IpAddress, UserAgent, Data\n\n```\n**PAT used with browser.**\n\n**ATT&CK Technique:** [T1564](https://attack.mitre.org/techniques/T1564/)\n\n**Description: Personal Access Tokens (PATs) are used as an alternate password to**\nauthenticate into Azure DevOps. PATs are intended for programmatic access for use in code\nor applications. Given this they can be prone to attacker theft if not adequately secured. This\nquery looks for the use of a PAT in authentication which is from a User Agent containing a\nrendering engine, indicating a browser. This should not be normal activity and could be an\nindicator of an attacker using a stolen PAT.\n\n**Query:**\n\nSpoiler\n```\nAzureDevOpsAuditing\n| where AuthenticationMechanism startswith \"PAT\"\n// Look for useragents that include a rendering engine\n| where UserAgent has_any (\"Gecko\", \"WebKit\", \"Presto\", \"Trident\", \"EdgeHTML\",\n\"Blink\")\n\n### Hunting Queries\n\n```\n\n-----\n\nThese are queries that are designed to look for abnormal activity that may not necessarily be\nmalicious but could be an indicator of attacker activity and therefore deserves further\ninvestigation. These queries could have a significant (FP) rate and should be used as a\nstarting point for further analysis and hunting.\n\n\n### Hunting Query Name\n\n**Release Pipeline**\n**[Created in Project](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/AzureDevOpsAuditing/ADOReleasePipelineCreated.yaml)**\n**by New User**\n\n**New Package Feed**\n**Created**\n\n**Build Check**\n**Removed**\n\n**New Release**\n**Approver**\n\n**New Agent Pool**\n**Created**\n\n**PAT used with new**\n**operation**\n\n**Build Deleted After**\n**Pipeline**\n**Modification**\n\n**Variable Added**\n**and Removed**\n\n\n### Description\n\nHunts for users creating a pipeline who has not created one before.\n\nHunts for the creation of new package feeds of any kind.\n\nHunts for users removing a build check from within a pipeline.\n\nHunts for users approving a release when they have not previously\napproved any releases.\n\nHunts for the creation of new Agent Pools of any kind.\n\nHunts for a Personal Access Token (PAT) being used for\nauthentication with an Azure DevOps operation where a PAT has\nnot being used to authenticate before.\n\nHunts for a Build in Azure DevOps being deleted shortly after a\npipeline associated with the build has been modified.\n\nHunts for a build variable being created and then deleted within a\nshort space of time.\n\n\n### Release Pipeline Created in Project by New User\n\n**ATT&CK Technique:** [T1053](https://attack.mitre.org/techniques/T1053/)\n\n**Description: An attacker could look to create a new poisoned pipeline in a CI/CD solution**\nand attach a build process to it. This hunting query looks for new Azure DevOps pipelines\nbeing created in projects where the creating user has not been seen creating a pipeline\n\n\n-----\n\nbefore. This query could have a significant false positive rate and records should be triaged\nto determine if a user creating a pipeline is authorized and expected.\n\n**Query:**\n\nSpoiler\n```\n// Set the lookback to determine if user has created pipelines before\nlet timeback = 30d;\n// Set the period for detections\nlet timeframe = 1d;\n// Get a list of previous Release Pipeline creators to exclude\nlet releaseusers = AzureDevOpsAuditing\n| where TimeGenerated > ago(timeback) and TimeGenerated < ago(timeframe)\n| where OperationName =~ \"Release.ReleasePipelineCreated\"\n// We want to look for users performing actions in specific organizations so we creat\nthis userscope object to match on\n| extend UserScope = strcat(ActorUPN, \"-\", ProjectName)\n| summarize by UserScope;\n// Get Release Pipeline creations by new users\nAzureDevOpsAuditing\n| where TimeGenerated > ago(timeframe)\n| where OperationName =~ \"Release.ReleasePipelineCreated\"\n| extend UserScope = strcat(ActorUPN, \"-\", ProjectName)\n| where UserScope !in (releaseusers)\n| extend ActorUPN = tolower(ActorUPN)\n| project-away Id, ActivityId, ActorCUID, ScopeId, ProjectId, TenantId, SourceSystem,\nUserScope\n// See if any of these users have Azure AD alerts associated with them in the same\ntimeframe\n| join kind = leftouter (\nSecurityAlert\n| where TimeGenerated > ago(timeframe)\n| where ProviderName == \"IPC\"\n| extend AadUserId = tostring(parse_json(Entities)[0].AadUserId)\n| summarize Alerts=count() by AadUserId) on $left.ActorUserId == $right.AadUserId\n| project-reorder TimeGenerated, ProjectName, Details, ActorUPN, IpAddress,\nUserAgent, Alerts\n\n### New Package Feed Created.\n\n```\n**ATT&CK Technique:** [T1195](https://attack.mitre.org/techniques/T1195/)\n\n**Description: An attacker could look to introduce upstream compromised software packages**\nby creating a new package feed within Azure DevOps. This query looks for new Feeds and\nincludes details on any Azure AD Identity Protection alerts related to the user account\ncreating the feed to assist in triage.\n\n**Query:**\n\nSpoiler\n\n\n-----\n\n```\nlet timeframe 30d;\nlet alert_threshold = 0;\nAzureDevOpsAuditing\n| where TimeGenerated > ago(timeframe)\n| where OperationName matches regex \"Artifacts.Feed.(Org|Project).Create\"\n| extend FeedName = tostring(Data.FeedName)\n| extend FeedId = tostring(Data.FeedId)\n| join kind = leftouter (\nSecurityAlert\n| where TimeGenerated > ago(timeframe)\n| where ProviderName == \"IPC\"\n| extend AadUserId = tostring(parse_json(Entities)[0].AadUserId)\n| summarize Alerts=count() by AadUserId) on $left.ActorUserId == $right.AadUserId\n| extend Alerts = iif(isempty(Alerts), 0, Alerts)\n| project-reorder TimeGenerated, Details, ActorUPN, IpAddress, UserAgent\n\n### Build Check Removed.\n\n```\n**ATT&CK Technique:** [T1578](https://attack.mitre.org/techniques/T1578/)\n\n**Description: Build checks can be built into a pipeline in order to control the release**\nprocess, these can include things such as the successful passing of certain steps, or an\nexplicit user approval. An attacker who has altered a build process may look to remove a\ncheck in order to ensure a compromised build is released. This hunting query simply looks\nfor all check removal events, these should be relatively uncommon. In the output, Type\nshows the type of Check that was deleted.\n\n**Query:**\n\nSpoiler\n```\nAzureDevOpsAuditing\n| where OperationName =~ \"CheckConfiguration.Deleted\"\n| extend ResourceName = tostring(Data.ResourceName)\n| extend Type = tostring(Data.Type)\n| project-reorder TimeGenerated, OperationName, ResourceName, Type, ActorUPN,\nIpAddress, UserAgent\n\n### New Release Approver.\n\n```\n**ATT&CK Technique:** [T1078](https://attack.mitre.org/techniques/T1078/)\n\n**Description: Releases in Azure Pipelines often require a user authorization to perform the**\nrelease. An attacker that has compromised a build may look to self-approve a release using\na compromised account to avoid user focus on that release. This query looks for release\napprovers in pipelines where they have not approved a release in the last 30 days. This\nquery can have a significant false positive rate so it is best suited as a hunting query rather\nthan a detection.\n\n**Query:**\n\n\n-----\n\nSpoiler\n```\nlet lookback = 30d;\nlet timeframe = 1d;\nAzureDevOpsAuditing\n| where TimeGenerated > ago(lookback) and TimeGenerated < ago(timeframe)\n| where OperationName in (\"Release.ApprovalCompleted\", \"Release.ApprovalsCompleted\")\n| extend PipelineName = tostring(Data.PipelineName)\n| extend ApprovalType = tostring(Data.ApprovalType)\n| extend StageName = tostring(Data.StageName)\n| extend ReleaseName = tostring(Data.ReleaseName)\n| summarize by PipelineName, ActorUPN, ApprovalType\n| join kind=rightanti (\nAzureDevOpsAuditing\n| where TimeGenerated > ago(timeframe)\n| where OperationName in (\"Release.ApprovalCompleted\", \"Release.ApprovalsCompleted\")\n| extend PipelineName = tostring(Data.PipelineName)\n| extend ApprovalType = tostring(Data.ApprovalType)\n| extend StageName = tostring(Data.StageName)\n| extend ReleaseName = tostring(Data.ReleaseName)) on ActorUPN\n| project-reorder TimeGenerated, PipelineName, ActorUPN, ApprovalType, StageName,\nReleaseName, IpAddress, UserAgent, AuthenticationMechanism\n\n### New Agent Pool Created.\n\n```\n**ATT&CK Technique:** [T1578](https://attack.mitre.org/techniques/T1578/)\n\n**Description: Agent Pools provide a valuable resource to build processes. Creating and**\nusing a compromised agent pool in a pipeline could allow an attacker to compromise a build\nprocess. The creation of an agent pool on its own is not malicious, it is an event that is likely\nto occur rarely which makes it effective for manual hunting through manual validation of\ncreation events.\n\n**Query:**\n\nSpoiler\n```\nAzureDevOpsAuditing\n| where OperationName =~ \"Library.AgentPoolCreated\"\n| extend AgentPoolName = tostring(Data.AgentPoolName)\n| extend AgentPoolId = tostring(Data.AgentPoolId)\n| extend IsHosted = tostring(Data.IsHosted)\n| extend IsLegacy = tostring(Data.IsLegacy)\n| project-reorder TimeGenerated, ActorUPN, UserAgent, IpAddress,\nAuthenticationMechanism, OperationName\n\n### PAT used with new operation.\n\n```\n**ATT&CK Technique:** [T1578](https://attack.mitre.org/techniques/T1578/)\n\n\n-----\n\n**Description: PATs are typically used for repeated, programmatic tasks. This query looks for**\nPATs based authentication being used with an Operation not previously associated with PAT\nbased authentication. This could indicate an attacker using a stolen PAT to perform malicious\nactions.\n\n**Query:**\n\nSpoiler\n```\nlet lookback = 30d;\nlet timeframe = 3d;\nlet PAT_Actions = AzureDevOpsAuditing\n| where TimeGenerated > ago(lookback) and TimeGenerated < ago(timeframe)\n| where AuthenticationMechanism startswith \"PAT\"\n| summarize by OperationName;\nAzureDevOpsAuditing\n| where TimeGenerated > ago(timeframe)\n| where AuthenticationMechanism startswith \"PAT\"\n| where OperationName !in (PAT_Actions)\n\n### Build Deleted After Pipeline Modification.\n\n```\n**ATT&CK Technique:** [T1053](https://attack.mitre.org/techniques/T1053/)\n\n**Description: An attacker altering pipelines may look to delete builds to reduce the footprint**\nthey leave on a system. This query looks for a build pipeline being deleted within 1 hour of a\npipeline being modified. This event may produce false positives but should not be so\ncommon that it can’t be effectively used as part of hunting.\n\n**Query:**\n\nSpoiler\n```\nAzureDevOpsAuditing\n| where OperationName =~ \"Release.ReleaseDeleted\"\n| extend PipelineId = tostring(Data.PipelineId)\n| extend PipelineName = tostring(Data.PipelineName)\n| extend timekey = bin(TimeGenerated, 1h)\n| join (AzureDevOpsAuditing\n| where OperationName =~ 'Release.ReleasePipelineModified'\n| extend PipelineId = tostring(Data.PipelineId)\n| extend PipelineName = tostring(Data.PipelineName)\n| extend timekey = bin(TimeGenerated, 1h)) on timekey, PipelineId, ActorUPN\n| where TimeGenerated1 < TimeGenerated\n| extend ReleaseName = tostring(Data.ReleaseName)\n| project-rename TimeModified = TimeGenerated1, TimeDeleted = TimeGenerated,\nModifyOperation = OperationName1, ModifyUser=ActorUPN1, ModifyIP=IpAddress1,\nModifyUA= UserAgent1, DeleteOperation=OperationName, DeleteUser=ActorUPN,\nDeleteIP=IpAddress, DeleteUA=UserAgent\n| project-reorder TimeModified, ProjectName, PipelineName, ModifyUser, ModifyIP,\nModifyUA, TimeDeleted, DeleteOperation, DeleteUser, DeleteIP, DeleteUA,ReleaseName\n\n```\n\n-----\n\n### Variable Added and Removed\n\n**ATT&CK Technique:** [T1564](https://attack.mitre.org/techniques/T1564/)\n\n**Description: Variables can be used at various stages of a pipeline to inject static variables.**\nDepending on the build process these variables could be added by an attacker to get a build\nprocess to conduct an unwanted action such as communicating with an attacker-controlled\nendpoint or injecting values into code. This query looks for variables that are added and then\ndeleted in a short space of time. This is not normally expected behavior and could be an\nindicator of attacker creating elements and then covering tracks. If this hunting query\nproduces only a small number of events in an environment it could be promoted to a\ndetection.\n\n**Query:**\n\nSpoiler\n```\nlet timeframe = 7d;\nAzureDevOpsAuditing\n| where TimeGenerated > ago(timeframe)\n| where OperationName =~ \"Library.VariableGroupModified\"\n| extend variables = Data.Variables\n| extend VariableGroupName = tostring(Data.VariableGroupName)\n| join (AzureDevOpsAuditing\n| where TimeGenerated > ago(timeframe)\n| where OperationName =~ \"Library.VariableGroupModified\"\n| extend variables = Data.Variables\n| extend VariableGroupName = tostring(Data.VariableGroupName)) on VariableGroupName\n| extend len = array_length(bag_keys(variables))\n| extend len1 = array_length(bag_keys(variables1))\n| where (TimeGenerated < TimeGenerated1 and len > len1) or (TimeGenerated1 >\nTimeGenerated and len1 < len)\n| project-away len, len1\n| extend VariablesRemoved = set_difference(bag_keys(variables), bag_keys(variables1))\n| project-rename TimeCreated=TimeGenerated, TimeDeleted = TimeGenerated1,\nCreatingUser = ActorUPN, DeletingUser = ActorUPN1, CreatingIP = IpAddress, DeletingIP\n= IpAddress1, CreatingUA = UserAgent, DeletingUA = UserAgent1\n| project-reorder VariableGroupName, TimeCreated, TimeDeleted, VariablesRemoved,\nCreatingUser, CreatingIP, CreatingUA, DeletingUser, DeletingIP, DeletingUA\n\n```\nThese Hunting and Detection queries provide opportunities to monitor for potentially\nmalicious behavior related to build processes in Azure DevOps. In addition to monitoring for\nsuspicious activity it is important to ensure that preventative security measures are applied to\nyour build pipelines. Best practice for securing Azure DevOps can be found at\n[docs.microsoft.com](https://docs.microsoft.com/en-us/azure/devops/organizations/security/quick-reference-index-security?view=azure-devops)\n\n## Summary\n\n\n-----\n\nThis blog has showcased how defenders can use monitoring to monitor their internal\nsoftware build process to protect their supply chain as well as protecting others further down\nthe supply chain. We have addressed how to monitor for NOBELIUM specific activity as well\nas wider monitoring opportunities using Azure DevOps as an example. Whilst many\nmonitoring opportunities have been presented here there are other monitoring opportunities\nin build systems that haven’t been addressed here including detecting attackers accessing\nsensitive information.\n\nThe queries detailed in this blog as well as many others covering additional scenarios are\n[available on the Azure Sentinel GitHub site under Detections and](https://github.com/Azure/Azure-Sentinel/tree/master/Detections/AzureDevOpsAuditing) [Hunting Queries.](https://github.com/Azure/Azure-Sentinel/tree/master/Hunting%20Queries/AzureDevOpsAuditing)\n\nMSTIC would like to thank the Azure DevOps security team and the Azure Red Team for\ntheir help and support in this work.\n\n[i] Ensure ‘Applied To:’ is set to ‘This folder, subfolder and files’\n\n[ii] Should you wish you can set the Type of collection to ‘All’ but this scenario only required\nthe collection of Success events.\n\n[iii] Only Project Collection Administrators have access to the auditing feature.\n\n[iv] But notably not all.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-10 - Monitoring the Software Supply Chain with Azure Sentinel.pdf"
    ],
    "report_names": [
        "2021-03-10 - Monitoring the Software Supply Chain with Azure Sentinel.pdf"
    ],
    "threat_actors": [
        {
            "id": "77b28afd-8187-4917-a453-1d5a279cb5e4",
            "created_at": "2022-10-25T15:50:23.768278Z",
            "updated_at": "2025-03-27T02:00:55.5423Z",
            "deleted_at": null,
            "main_name": "Inception",
            "aliases": [
                "Inception Framework",
                "Cloud Atlas"
            ],
            "source_name": "MITRE:Inception",
            "tools": [
                "PowerShower",
                "VBShower",
                "LaZagne"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "b43e5ea9-d8c8-4efa-b5bf-f1efb37174ba",
            "created_at": "2022-10-25T16:07:24.36191Z",
            "updated_at": "2025-03-27T02:02:10.1909Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "Dark Halo",
                "Nobelium",
                "SolarStorm",
                "StellarParticle",
                "UNC2452"
            ],
            "source_name": "ETDA:UNC2452",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "70872c3a-e788-4b55-a7d6-b2df52001ad0",
            "created_at": "2023-01-06T13:46:39.18401Z",
            "updated_at": "2025-03-27T02:00:03.01553Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "DarkHalo",
                "StellarParticle",
                "NOBELIUM",
                "Solar Phoenix",
                "Midnight Blizzard"
            ],
            "source_name": "MISPGALAXY:UNC2452",
            "tools": [
                "SNOWYAMBER",
                "HALFRIG",
                "QUARTERRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "faa4a29b-254a-45bd-b412-9a1cbddbd5e3",
            "created_at": "2022-10-25T16:07:23.80111Z",
            "updated_at": "2025-03-27T02:02:09.985067Z",
            "deleted_at": null,
            "main_name": "LookBack",
            "aliases": [
                "FlowingFrog",
                "LookBack",
                "LookingFrog",
                "TA410",
                "Witchetty"
            ],
            "source_name": "ETDA:LookBack",
            "tools": [
                "FlowCloud",
                "GUP Proxy Tool",
                "SodomMain",
                "SodomMain RAT",
                "SodomNormal"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "1d3f9dec-b033-48a5-8b1e-f67a29429e89",
            "created_at": "2022-10-25T15:50:23.739197Z",
            "updated_at": "2025-03-27T02:00:55.536417Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "UNC2452",
                "NOBELIUM",
                "StellarParticle",
                "Dark Halo"
            ],
            "source_name": "MITRE:UNC2452",
            "tools": [
                "Sibot",
                "Mimikatz",
                "Cobalt Strike",
                "AdFind",
                "GoldMax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "a241a1ca-2bc9-450b-a07b-aae747ee2710",
            "created_at": "2024-06-19T02:03:08.150052Z",
            "updated_at": "2025-03-27T02:05:17.409596Z",
            "deleted_at": null,
            "main_name": "IRON RITUAL",
            "aliases": [
                "Blue Dev 5 ",
                "BlueBravo ",
                "Cloaked Ursa ",
                "CozyLarch ",
                "Dark Halo ",
                "Midnight Blizzard ",
                "NOBELIUM ",
                "StellarParticle ",
                "UNC2452 ",
                "APT29"
            ],
            "source_name": "Secureworks:IRON RITUAL",
            "tools": [
                " Cobalt Strike",
                " EnvyScout",
                " GoldFinder",
                " GoldMax",
                " NativeZone",
                " RAINDROP",
                " SUNBURST",
                " Sibot",
                " TEARDROP",
                " VaporRage",
                "Brute Ratel C4"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "46b3c0fc-fa0c-4d63-a38a-b33a524561fb",
            "created_at": "2023-01-06T13:46:38.393409Z",
            "updated_at": "2025-03-27T02:00:02.822155Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "The Dukes",
                "Minidionis",
                "Grizzly Steppe",
                "G0016",
                "Blue Kitsune",
                "BlueBravo",
                "SeaDuke",
                "Cloaked Ursa",
                "YTTRIUM",
                "ATK7",
                "Nobelium",
                "UAC-0029",
                "Group 100",
                "COZY BEAR",
                "IRON HEMLOCK",
                "TA421",
                "ITG11"
            ],
            "source_name": "MISPGALAXY:APT29",
            "tools": [
                "QUARTERRIG",
                "SNOWYAMBER",
                "HALFRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f27790ff-4ee0-40a5-9c84-2b523a9d3270",
            "created_at": "2022-10-25T16:07:23.341684Z",
            "updated_at": "2025-03-27T02:02:09.74554Z",
            "deleted_at": null,
            "main_name": "APT 29",
            "aliases": [
                "APT 29",
                "ATK 7",
                "Blue Dev 5",
                "BlueBravo",
                "Cloaked Ursa",
                "CloudLook",
                "Cozy Bear",
                "Dark Halo",
                "Earth Koshchei",
                "Grizzly Steppe",
                "Group 100",
                "ITG11",
                "Iron Hemlock",
                "Iron Ritual",
                "Midnight Blizzard",
                "Minidionis",
                "Nobelium",
                "NobleBaron",
                "Operation Ghost",
                "Operation Office monkeys",
                "Operation StellarParticle",
                "SilverFish",
                "Solar Phoenix",
                "SolarStorm",
                "StellarParticle",
                "TEMP.Monkeys",
                "The Dukes",
                "UNC2452",
                "UNC3524",
                "Yttrium"
            ],
            "source_name": "ETDA:APT 29",
            "tools": [
                "7-Zip",
                "ATI-Agent",
                "AdFind",
                "Agentemis",
                "AtNow",
                "BEATDROP",
                "BotgenStudios",
                "CEELOADER",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobalt Strike",
                "CobaltStrike",
                "CosmicDuke",
                "Cozer",
                "CozyBear",
                "CozyCar",
                "CozyDuke",
                "Danfuan",
                "EnvyScout",
                "EuroAPT",
                "FatDuke",
                "FoggyWeb",
                "GeminiDuke",
                "Geppei",
                "GoldFinder",
                "GoldMax",
                "GraphDrop",
                "GraphicalNeutrino",
                "GraphicalProton",
                "HAMMERTOSS",
                "HammerDuke",
                "LOLBAS",
                "LOLBins",
                "LiteDuke",
                "Living off the Land",
                "MagicWeb",
                "Mimikatz",
                "MiniDionis",
                "MiniDuke",
                "NemesisGemina",
                "NetDuke",
                "OnionDuke",
                "POSHSPY",
                "PinchDuke",
                "PolyglotDuke",
                "PowerDuke",
                "QUIETEXIT",
                "ROOTSAW",
                "RegDuke",
                "Rubeus",
                "SNOWYAMBER",
                "SPICYBEAT",
                "SUNSHUTTLE",
                "SeaDaddy",
                "SeaDask",
                "SeaDesk",
                "SeaDuke",
                "Sharp-SMBExec",
                "SharpView",
                "Sibot",
                "Solorigate",
                "SoreFang",
                "TinyBaron",
                "WINELOADER",
                "WellMail",
                "WellMess",
                "cobeacon",
                "elf.wellmess",
                "reGeorg",
                "tDiscoverer"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536010,
    "ts_updated_at": 1743041794,
    "ts_creation_date": 1653688747,
    "ts_modification_date": 1653688747,
    "files": {
        "pdf": "https://archive.orkl.eu/f8e6ffd447848e0e75311383d6c39df5fd453fe0.pdf",
        "text": "https://archive.orkl.eu/f8e6ffd447848e0e75311383d6c39df5fd453fe0.txt",
        "img": "https://archive.orkl.eu/f8e6ffd447848e0e75311383d6c39df5fd453fe0.jpg"
    }
}