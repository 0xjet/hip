{
    "id": "4374158d-aef9-4e74-9184-c364906970d9",
    "created_at": "2023-01-12T15:09:05.64604Z",
    "updated_at": "2025-03-27T02:15:37.937004Z",
    "deleted_at": null,
    "sha1_hash": "8808ad676a768f55ddc2cdd7f3c7dbd13e6606b0",
    "title": "2020-05-20 - Operation TA505- how we analyzed new tools from the creators of the Dridex trojan, Locky ransomware, and Neutrino botnet",
    "authors": "",
    "file_creation_date": "2022-05-28T03:15:31Z",
    "file_modification_date": "2022-05-28T03:15:31Z",
    "file_size": 540967,
    "plain_text": "# Operation TA505: how we analyzed new tools from the creators of the Dridex trojan, Locky ransomware, and Neutrino botnet\n\n**[ptsecurity.com/ww-en/analytics/pt-esc-threat-intelligence/operation-ta505/](https://www.ptsecurity.com/ww-en/analytics/pt-esc-threat-intelligence/operation-ta505/)**\n\nPositive Technologies\n\nPublished on 20 May 2020\n\nDistribution of TA505\n\nattacks in 2019\n\n\n-----\n\nThe Threat Intelligence team at the Positive Technologies Expert Security Center has been\nkeeping a close eye on the TA505 cybercrime group for the last six months. The malefactors\nare drawn towards finance, with targets scattered in dozens of countries on multiple\ncontinents.\n\n## What is TA505 famous for?\n\n[The cybergang has been quite prolific since 2014: their arsenal includes the Dridex banking](https://www.proofpoint.com/us/threat-insight/post/threat-actor-profile-ta505-dridex-globeimposter)\ntrojan, Neutrino botnet, as well as Locky, Jaff, GlobeImposter, and other ransomware.\n\nThe group's attacks have been detected all around the world, from North America to Central\nAsia.\n\nDespite being mainly motivated by profit, in the past six months they have also attacked\nresearch institutes, energy companies, healthcare institutions, airlines, and even government\nagencies.\n\nTA505 attacks by sector, 2019\nBelow is an example of a phishing message containing malware developed by the group.\nJudging by the email address, the attack targeted the British Foreign Office.\n\n\n-----\n\nThe group has been using the FlawedAmmyy remote access tool since spring 2018 and the\nnew ServHelper backdoor since the end of 2018. TA505 is among the few groups that can\nboast of continuous activity over a long timeframe. Moreover, each new wave of attacks\nshows interesting changes in the group's tools.\n\nTA505 detections by month, 2019\nSuch a high clip of attacks cannot stay invisible: our colleagues at companies including\n[Proofpoint,](https://www.proofpoint.com/us/threat-insight/post/ta505-shifts-times) [Trend Micro, and](https://blog.trendmicro.com/trendlabs-security-intelligence/shifting-tactics-breaking-down-ta505-groups-use-of-html-rats-and-other-techniques-in-latest-campaigns/) [Yoroi have already reported on the techniques and malicious](https://blog.yoroi.company/research/ta505-is-expanding-its-operations/)\nsoftware used by TA505. However, many intriguing issues still remain unaddressed:\n\nThe PE packer unique to the group\nA version of the ServHelper backdoor that, instead of custom-developed functionality,\nrelies on NetsupportManager remote control software\n\n\n-----\n\nNetwork infrastructure: registrars and hosting providers, including overlap with\ninfrastructure of the Buhtrap group\nOther malware used by the group not covered previously\n\nThis is the first article of a series about the TA505 group.\n\n## Part 1. In the beginning was the packer\n\nIn mid-June 2019, we saw new variants of FlawedAmmy malware loaders with significant\nchanges from previous versions. For example, the visual representation of code in\nhexadecimal was different. This pattern became a common theme in several samples that\nwe analyzed.\n\nASCII code representation\n\nQuick analysis showed that we were looking at an unknown packer of executable files. Later\nwe found that this packer was used not only for the loaders in question, but for other TA505\nmalware, including payload. We decided to explore the unpacking logic in order to be able to\nautomatically extract the contents.\n\n## Layer 1. Tricky XOR\n\nThe key portion of the unpacker is preceded by a large number of junk instructions. Malware\ndevelopers often use this technique to evade antivirus emulators. The interesting part starts\nwhen 0xD20 of buffer memory is allocated using the WinAPI function VirtualAllocEx. Memory\nis allocated with PAGE_EXECUTE_READWRITE rights, which allow writing and executing\ncode.\n\n\n-----\n\nStart of the non-junk part of the\n\nunpacker\nThe data section of the file contains an array. The contents of the array are decoded and the\nresult is written to the allocated memory. Here is the decoding process:\n\nInterpret 4 bytes as integer.\nSubtract the order number of the byte in the sequence.\nPerform XOR with a set constant.\nPerform a circular shift to the left by 7 positions.\nPerform XOR with set constant again.\n\nFirst-layer decoding\n\nWe'll call the algorithm SUB-XOR-ROL7-XOR when referring to it later.\n\nDecoding is followed by sequential initialization of variables. This can be represented as\ndeclaring a C struct in the following format:\n```\n    struct ZOZ {\n      HMODULE hkernel32;\n      void *aEncodedBlob;\n      unsigned int nEncodedBlobSize;\n      unsigned int nBlobMagic;\n      unsigned int nBlobSize;\n    };\n\n```\nin which:\n\n_hkernel32 describes the library kernel32.dll._\n_aEncodedBlob is a pointer to the encoded block of data we were talking about when_\nnoting the visual similarity of the samples.\n\n\n-----\n\nEncoded data block\n\n_nEncodedBlobSize is the 4-byte size of the encoded data block._\n_nBlobMagic is a 4-byte constant ahead of the data block, to which we will return later_\non.\n_nBlobSize is the 4-byte size of the decoded data block._\n\nWe called the struct ZOZ (or \"505\" in l33t speak).\n\nPopulating ZOZ\n\nCode execution jumps to the decoded buffer (removing any doubt that the now-decoded data\nconsists of executable code) and a pointer to the populated struct is passed in a function\nargument:\n\nCalling the decoded code, with the ZOZ\n\nstruct passed as an argument\n\n\n-----\n\nDecoded and\n\ndisassembled code portion\n\n## Layer 2. Less is more\n\nOnce the portion of code is decoded and run, it starts gathering addresses of the WinAPI\nfunctions GetProcAddress, VirtualQuery, VirtualAlloc, VirtualProtect, VirtualFree, and\nLoadLibraryA. These functions are often used with shellcodes, in order to groom memory to\nrun the payload.\n\nWhen everything is ready, the encoded data block is passed and then \"slimmed down.\" The\nfirst two of each five bytes are discarded and the remaining three are kept:\n\nReduction of the encoded data block\n\nThen starts the decoding, which we have called SUB-XOR-ROL7-XOR. To perform XOR, the\nnBlobMagic value passed in ZOZ is used as a constant.\n\nReuse of the SUB-XORROL7-XOR algorithm\nAfter that, the resulting array is passed to a function in which more complicated\ntransformations take place. Judging by the characteristic constant values, we can easily\n[identify a popular FSG (Fast Small Good) PE packer. Curiously enough, the original FSG](https://opensource.apple.com/source/SpamAssassin/SpamAssassin-124.3/clamav/libclamav/fsg.c)\n\n\n-----\n\npacker version compresses PE by sections, whereas in our case the algorithm works with\nthe PE as-is.\n\nFSG packer implementation\n\nAt this stage, the memory contains the unpacked PE file ready for further analysis. The\nremaining part of the shellcode will overwrite the original PE in the address space with the\nunpacked version and will then run it correctly. Interestingly, during modification of the\nmodule entry point, there are manipulations involving PEB structures. We do not know why\nthe attackers decided to forward the kernel32 descriptor from the first-layer logic instead of\ngetting it with the help of the same PEB structures.\n\nEntry point for the loaded module is\n\noverwritten in PEB\n\n## Conclusion\n\nThe payload is unpacked as follows:\n\nDecode shellcode with SUB-XOR-ROL7-XOR.\nPopulate the ZOZ struct and call the shellcode.\nSlim payload (five to three).\nDecode payload with SUB-XOR-ROL7-XOR.\nDecompress with FSG packer.\n\n\n-----\n\nAs the malware evolved, so did its logic: the SUB-XOR-ROL7-XOR circular shift (in our\ncase, by seven positions) has been changed to five and nine positions and an x64 packer\nversion was released, among other changes. The cybergang's \"calling card\" packer is an\nexcellent start to a series of upcoming tales about TA505 tools and techniques.\n\nIn future articles, we will discuss how the group's tools have changed during recent attacks\nand how its participants have interacted with other cybergroups. We will also explore\nmalware samples not covered before.\n\nAuthors: Alexey Vishnyakov and Stanislav Rakovsky, Positive Technologies\n\n## IOCs\n\nb635c11efdf4dc2119fa002f73a9df7b (packed FlawedAmmyy loader)\n\n71b183a44f755ca170fc2e29b05b64d5 (unpacked FlawedAmmyy loader)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-20 - Operation TA505- how we analyzed new tools from the creators of the Dridex trojan, Locky ransomware, and Neutrino botnet.pdf"
    ],
    "report_names": [
        "2020-05-20 - Operation TA505- how we analyzed new tools from the creators of the Dridex trojan, Locky ransomware, and Neutrino botnet.pdf"
    ],
    "threat_actors": [
        {
            "id": "3b046db2-f60e-49ae-8e16-0cf82a4be6fb",
            "created_at": "2022-10-25T16:07:23.427162Z",
            "updated_at": "2025-03-27T02:02:09.79482Z",
            "deleted_at": null,
            "main_name": "Buhtrap",
            "aliases": [
                "Buhtrap",
                "Operation TwoBee",
                "Ratopak Spider",
                "UAC-0008"
            ],
            "source_name": "ETDA:Buhtrap",
            "tools": [
                "AmmyyRAT",
                "Buhtrap",
                "CottonCastle",
                "FlawedAmmyy",
                "NSIS",
                "Niteris EK",
                "Nullsoft Scriptable Install System",
                "Ratopak"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "01d569b1-f089-4a8f-8396-85078b93da26",
            "created_at": "2023-01-06T13:46:38.411615Z",
            "updated_at": "2025-03-27T02:00:02.826863Z",
            "deleted_at": null,
            "main_name": "BuhTrap",
            "aliases": [],
            "source_name": "MISPGALAXY:BuhTrap",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "99cb4e5b-8071-4f9e-aa1d-45bfbb6197e3",
            "created_at": "2023-01-06T13:46:38.860754Z",
            "updated_at": "2025-03-27T02:00:02.937438Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "SectorJ04 Group",
                "Dudear",
                "G0092",
                "ATK103",
                "Hive0065",
                "Spandex Tempest",
                "GRACEFUL SPIDER",
                "GOLD TAHOE",
                "CHIMBORAZO",
                "SectorJ04"
            ],
            "source_name": "MISPGALAXY:TA505",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5e6b31a6-80e3-4e7d-8b0a-d94897ce9b59",
            "created_at": "2024-06-19T02:03:08.128175Z",
            "updated_at": "2025-03-27T02:05:17.400394Z",
            "deleted_at": null,
            "main_name": "GOLD TAHOE",
            "aliases": [
                "SectorJ04 ",
                "Spandex Tempest ",
                "TA505 ",
                "FIN11 "
            ],
            "source_name": "Secureworks:GOLD TAHOE",
            "tools": [
                " Cobalt Strike",
                " FlawedAmmy",
                " Get2",
                " GraceWire",
                " Malichus",
                " SDBbot",
                " ServHelper",
                " TrueBot",
                "Clop"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75d4d6a9-b5d1-4087-a7a0-e4a9587c45f4",
            "created_at": "2022-10-25T15:50:23.5188Z",
            "updated_at": "2025-03-27T02:00:55.489882Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "TA505",
                "Hive0065",
                "Spandex Tempest",
                "CHIMBORAZO"
            ],
            "source_name": "MITRE:TA505",
            "tools": [
                "AdFind",
                "Azorult",
                "FlawedAmmyy",
                "Mimikatz",
                "Dridex",
                "TrickBot",
                "Get2",
                "FlawedGrace",
                "Cobalt Strike",
                "ServHelper",
                "Amadey",
                "SDBbot",
                "PowerSploit"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e447d393-c259-46e2-9932-19be2ba67149",
            "created_at": "2022-10-25T16:07:24.28282Z",
            "updated_at": "2025-03-27T02:02:10.159466Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "ATK 103",
                "Chimborazo",
                "Gold Evergreen",
                "Gold Tahoe",
                "Graceful Spider",
                "Hive0065",
                "Operation Tovar",
                "Operation Trident Breach",
                "SectorJ04",
                "Spandex Tempest",
                "TA505",
                "TEMP.Warlock"
            ],
            "source_name": "ETDA:TA505",
            "tools": [
                "Amadey",
                "AmmyyRAT",
                "AndroMut",
                "Azer",
                "Bart",
                "Bugat v5",
                "CryptFile2",
                "CryptoLocker",
                "CryptoMix",
                "CryptoShield",
                "Dridex",
                "Dudear",
                "EmailStealer",
                "FRIENDSPEAK",
                "Fake Globe",
                "Fareit",
                "FlawedAmmyy",
                "FlawedGrace",
                "FlowerPippi",
                "GOZ",
                "GameOver Zeus",
                "GazGolder",
                "Gelup",
                "Get2",
                "GetandGo",
                "GlobeImposter",
                "Gorhax",
                "GraceWire",
                "Gussdoor",
                "Jaff",
                "Kasidet",
                "Kegotip",
                "Kneber",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Locky",
                "MINEBRIDGE",
                "MINEBRIDGE RAT",
                "MirrorBlast",
                "Neutrino Bot",
                "Neutrino Exploit Kit",
                "P2P Zeus",
                "Peer-to-Peer Zeus",
                "Philadelphia",
                "Philadephia Ransom",
                "Pony Loader",
                "Rakhni",
                "ReflectiveGnome",
                "Remote Manipulator System",
                "RockLoader",
                "RuRAT",
                "SDBbot",
                "ServHelper",
                "Shifu",
                "Siplog",
                "TeslaGun",
                "TiniMet",
                "TinyMet",
                "Trojan.Zbot",
                "Wsnpoem",
                "Zbot",
                "Zeta",
                "ZeuS",
                "Zeus"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536145,
    "ts_updated_at": 1743041737,
    "ts_creation_date": 1653707731,
    "ts_modification_date": 1653707731,
    "files": {
        "pdf": "https://archive.orkl.eu/8808ad676a768f55ddc2cdd7f3c7dbd13e6606b0.pdf",
        "text": "https://archive.orkl.eu/8808ad676a768f55ddc2cdd7f3c7dbd13e6606b0.txt",
        "img": "https://archive.orkl.eu/8808ad676a768f55ddc2cdd7f3c7dbd13e6606b0.jpg"
    }
}