{
    "id": "2fb20e66-005f-4c9e-836d-3094ce61d91e",
    "created_at": "2023-01-12T15:09:55.099822Z",
    "updated_at": "2025-03-27T02:15:26.182155Z",
    "deleted_at": null,
    "sha1_hash": "36b135006dcfa8282c55373d277f9c19585d94e7",
    "title": "2022-07-18 - A Deep Dive Into ALPHV-BlackCat Ransomware",
    "authors": "",
    "file_creation_date": "2022-08-18T03:22:13Z",
    "file_modification_date": "2022-08-18T03:22:13Z",
    "file_size": 23930740,
    "plain_text": "# A Deep Dive Into ALPHV/BlackCat Ransomware\n\n**[securityscorecard.com/research/deep-dive-into-alphv-blackcat-ransomware](https://securityscorecard.com/research/deep-dive-into-alphv-blackcat-ransomware)**\n\nSkip to main content\n\n[Support](https://support.securityscorecard.com/hc/en-us)\n[Login](https://platform.securityscorecard.io/#/start)\n[Contact](https://securityscorecard.com/company/contact-us)\n[Blog](https://securityscorecard.com/blog)\n[Languages](https://securityscorecard.com/research/deep-dive-into-alphv-blackcat-ransomware)\n\n[English](https://securityscorecard.com/)\n[Français](https://securityscorecard.com/fr)\n[日本語](https://securityscorecard.com/jp)\n[Request a Demo](https://securityscorecard.com/request-a-demo)\n\nInterested in reading the report later? Download it.\n\n[Download Now](https://securityscorecard.pathfactory.com/cybersecurity/blackcatransomware_w)\n**Prepared by: Vlad Pasca, Senior Malware & Threat Analyst**\n\n## Executive summary\n\nALPHV/BlackCat is the first widely known ransomware written in Rust. The malware must\nrun with an access token consisting of a 32-byte value (--access-token parameter), and other\nparameters can be specified. The ransomware comes with an encrypted configuration that\n\n\n-----\n\ncontains a list of services/processes to be stopped, a list of whitelisted directories/files/file\nextensions, and a list of stolen credentials from the victim environment. It deletes all Volume\nShadow Copies, performs privilege escalation using the CMSTPLUA COM interface, and\nenables “remote to local” and “remote to remote” symbolic links on the victim’s machine.\n\nThe files are encrypted using the AES algorithm, with the AES key being encrypted using the\nRSA public key contained in the configuration. The extension of the encrypted files is\nchanged to uhwuvzu by the malware.\n\n## Analysis and findings\n\nSHA256: 847fb7609f53ed334d5affbb07256c21cb5e6f68b1cc14004f5502d714d2a456\n\nThe malware can run with one of the following parameters:\n\n**Figure 1**\n\nWhether the ransomware is running with no parameters or with an invalid access token, an\nerror message is displayed:\n\n**Figure 2**\n\nBy performing the dynamic analysis, we’ve found that the access token must be a 32-byte\nvalue that is not unique.\n\nThe binary registers a new top-level exception handler via a function call to\nSetUnhandledExceptionFilter:\n\n\n-----\n\n**Figure 3**\n\nThe AddVectoredExceptionHandler API is utilized to register a vectored exception handler:\n\n**Figure 4**\n\nThe executable retrieves the command-line string for the process using the\nGetCommandLineW function:\n\n**Figure 5**\n\nBlackCat opens the \"SOFTWARE\\Microsoft\\Cryptography\" registry key by calling the\nRegOpenKeyExW routine (0x80000002 = HKEY_LOCAL_MACHINE, 0x20019 =\n**KEY_READ):**\n\n**Figure 6**\n\nThe binary extracts the MachineGUID value from the registry:\n\n**Figure 7**\n\nThe malicious process searches for cmd.exe in the current directory and then in the\nSystem32 directory via a function call to CreateFileW (0x7 = FILE_SHARE_DELETE |\n**FILE_SHARE_WRITE | FILE_SHARE_READ, 0x3 = OPEN_EXISTING, 0x2000000 =**\n**FILE_FLAG_BACKUP_SEMANTICS):**\n\n\n-----\n\n**Figure 8**\n\nThe executable generates 16 random bytes by calling the BCryptGenRandom API (0x2 =\n**BCRYPT_USE_SYSTEM_PREFERRED_RNG):**\n\n**Figure 9**\n\nA named pipe whose name contains the current process ID and random bytes generated\nabove is created using CreateNamedPipeW (0x40080001 = FILE_FLAG_OVERLAPPED |\n**FILE_FLAG_FIRST_PIPE_INSTANCE | PIPE_ACCESS_INBOUND, 0x8 =**\n**PIPE_REJECT_REMOTE_CLIENTS):**\n\n**Figure 10**\n\nThe process opens the named pipe for writing using the CreateFileW routine (0x40000000 =\n**GENERIC_WRITE, 0x3 = OPEN_EXISTING):**\n\n**Figure 11**\n\n\n-----\n\nThe ransomware creates a read and a write named pipe, respectively.\n\nThe wmic process is used to extract the UUID (0x08000400 = CREATE_NO_WINDOW |\n**CREATE_UNICODE_ENVIRONMENT):**\n\n**Figure 12**\n\nThe CreateEventW API is utilized to create two unnamed event objects:\n\n**Figure 13**\n\nThe binary waits until the event objects are in the signaled state by calling\nWaitForMultipleObjects:\n\n**Figure 14**\n\nThe output of the above process is read from the named pipe using the ReadFile routine:\n\n**Figure 15**\n\nThe malware creates multiple threads by calling the CreateThread function (0x00010000 =\n**STACK_SIZE_PARAM_IS_A_RESERVATION):**\n\n\n-----\n\n**Figure 16**\n\nThe content of the ransom note and the text that will appear on the Desktop Wallpaper are\ndecrypted by the ransomware:\n\n**Figure 17**\n\n**Figure 18**\n\nThe malicious binary obtains information about the current system via a function call to\nGetSystemInfo:\n\n**Figure 19**\n\nThere is a call to SHTestTokenMembership that verifies whether the user token is a member\nof the Administrators group in the built-in domain (0x220 = DOMAIN_ALIAS_RID_ADMINS):\n\n**Figure 20**\n\nThe process opens the access token associated with the current process (0x80000000 =\n**GENERIC_READ):**\n\n\n-----\n\n**Figure 21**\n\nBlackCat extracts a TOKEN_GROUPS structure containing the group accounts associated\nwith the above token using the NtQueryInformationToken function (0x2 = TokenGroups):\n\n**Figure 22**\n\nThe OpenProcess API is utilized to open a local process object (0x438 =\n**PROCESS_QUERY_INFORMATION | PROCESS_VM_WRITE | PROCESS_VM_READ |**\n**PROCESS_VM_OPERATION):**\n\n**Figure 23**\n\nThe malicious binary retrieves a pointer to a PEB structure using the\nZwQueryInformationProcess routine (0x0 = ProcessBasicInformation):\n\n**Figure 24**\n\nThe executable retrieves a pointer to a PEB_LDR_DATA structure containing information\nabout the loaded modules in the process and then to the head of a doubly linked list that\ncontains the loaded modules:\n\n**Figure 25**\n\n\n-----\n\n**Figure 26**\n\nThe path of the image file for the current process is retrieved using ReadProcessMemory:\n\n**Figure 27**\n\n## Privilege escalation via UAC bypass using CMSTPLUA COM interface\n\nThe ransomware initializes the COM library for use by the current thread via a call to\nCoInitializeEx (0x2 = COINIT_APARTMENTTHREADED):\n\n**Figure 28**\n\nBlackCat ransomware uses the auto-elevated CMSTPLUA interface {3E5FC7F9-9A51-4367**9063-A120244FBEC7} in order to escalate privileges:**\n\n**Figure 29**\n\nThe initial executable is spawned with administrative privileges:\n\n\n-----\n\n**Figure 30**\n\nThe LookupPrivilegeValueW routine is utilized to retrieve the locally unique identifier that\nrepresents the following privileges:\n\nSeIncreaseQuotaPrivilege SeSecurityPrivilege SeTakeOwnershipPrivilege\n\nSeLoadDriverPrivilege SeSystemProfilePrivilege SeSystemtimePrivilege\n\nSeProfileSingleProcessPrivilege SeIncreaseBasePriorityPrivilege\n\nSeCreatePagefilePrivilege SeBackupPrivilege SeRestorePrivilege\n\nSeShutdownPrivilege SeDebugPrivilege SeSystemEnvironmentPrivilege\n\nSeChangeNotifyPrivilege SeRemoteShutdownPrivilege SeUndockPrivilege\n\nSeManageVolumePrivilege SeImpersonatePrivilege SeCreateGlobalPrivilege\n\nSeIncreaseWorkingSetPrivilege SeTimeZonePrivilege\n\nSeCreateSymbolicLinkPrivilege SeDelegateSessionUserImpersonatePrivilege\n\n**Figure 31**\n\nAll the above privileges are enabled in the access token using AdjustTokenPrivileges:\n\n**Figure 32**\n\nThe binary creates the following processes that enable “remote to local” and “remote to\nremote” symbolic links on the local machine:\n\n\n-----\n\n**Figure 33**\n\n**Figure 34**\n\nThe malware tries to stop the Internet Information service (IIS) using IISReset.exe:\n\n**Figure 35**\n\nThe ransomware deletes all volume shadow copies using the vssadmin.exe utility:\n\n\n-----\n\n**Figure 36**\n\nThere is also a second process that is responsible for deleting all volume shadow copies with\nwmic:\n\n**Figure 37**\n\nInterestingly, the malware runs the following command that is incomplete and returns an\nerror:\n\n**Figure 38**\n\n**Figure 39**\n\nThe binary disables Automatic Repair using the bcdedit tool:\n\n\n-----\n\n**Figure 40**\n\nThe ransomware tries to clear all event logs, however, the command is incorrect and returns\nan error, as highlighted below:\n\n**Figure 41**\n\n**Figure 42**\n\n## Killing targeted services\n\nThe binary opens the service control manager database via a function call to\nOpenSCManagerW (0xF003F = SC_MANAGER_ALL_ACCESS):\n\n**Figure 43**\n\nThe process obtains a list of active services using EnumServicesStatusExW (0x30 =\n**SERVICE_WIN32, 0x1 = SERVICE_ACTIVE):**\n\n\n-----\n\n**Figure 44**\n\nThe malware targets the list of services from the kill_services element in the BlackCat\nconfiguration.\n\nA targeted service is opened by calling the OpenServiceW routine (0x2c = SERVICE_STOP |\n**SERVICE_ENUMERATE_DEPENDENTS | SERVICE_QUERY_STATUS):**\n\n**Figure 45**\n\nEnumDependentServicesW is utilized to retrieve the active services that depend on the\ntargeted service (0x1 = SERVICE_ACTIVE):\n\n**Figure 46**\n\nBlackCat stops the targeted service using the ControlService function (0x1 =\n**SERVICE_CONTROL_STOP):**\n\n**Figure 47**\n\n## Killing targeted processes\n\nThe executable takes a snapshot of all processes and threads in the system (0xF =\n**TH32CS SNAPALL):**\n\n\n-----\n\n**Figure 48**\n\nThe processes are enumerated using the Process32FirstW and Process32NextW APIs:\n\n**Figure 49**\n\n**Figure 50**\n\nThe malware targets the list of processes from the kill_processes element in the BlackCat\nconfiguration.\n\nIt opens a targeted process using OpenProcess (0x1 = PROCESS_TERMINATE):\n\n**Figure 51**\n\nThe ransomware terminates the targeted process by calling the TerminateProcess API:\n\n**Figure 52**\n\nThe binary spawns multiple child processes by adding the “--child” parameter to the\ncommand line (see figure 53). The new processes run in the security context of credentials\nthat were specified in the credentials entry from the BlackCat configuration.\n\n\n-----\n\n**Figure 53**\n\nThe number of network requests the Server Service can make is set to the maximum by\nmodifying\n“HKLM\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters\\MaxMpxCt”\nRegistry value:\n\n**Figure 54**\n\nThe malicious process obtains the ARP table using the arp command, as shown below:\n\n**Figure 55**\n\n\n-----\n\nThe net use command is utilized to connect to the local computer using different credentials\nstored in the BlackCat configuration:\n\n**Figure 56**\n\nThe malware retrieves the currently available disk drives by calling the GetLogicalDrives\nroutine:\n\n**Figure 57**\n\nThe GetDriveTypeW API is utilized to obtain the drive type:\n\n**Figure 58**\n\nThe ransomware starts scanning the volumes on the local machine using FindFirstVolumeW:\n\n**Figure 59**\n\nThe list of drive letters and mounted folder paths for the above volume is extracted by the\nmalware:\n\n**Figure 60**\n\n\n-----\n\nThe volume s enumeration continues by calling the FindNextVolumeW function:\n\n**Figure 61**\n\nAll unmounted volumes are mounted via a function call to SetVolumeMountPointW:\n\n**Figure 62**\n\nBlackCat traverses the file system using the FindFirstFileW and FindNextFileW APIs:\n\n**Figure 63**\n\n**Figure 64**\n\nThe BlackCat configuration is stored in JSON form and is decrypted at runtime. It contains:\n\nthe extension appended to the encrypted files\n\nRSA public key that is used to encrypt the AES encryption key\n\nransom note name and content\n\nstolen credentials specific to the victim’s environment\n\nencryption cipher: AES\n\nlist of services and processes to be killed\n\nlist of folders, files, and extensions to be skipped\n\nboolean values that indicate network discovery, lateral movement, setting the Desktop\nWallpaper, killing VMware ESXi virtual machines, removing VMware ESXi virtual\nmachine snapshots, excluding VMware ESXi virtual machines from termination\n\n\n-----\n\n**Figure 65**\n\n## Files encryption\n\nThe CreateFileW API is used to open a targeted file (0xC0000000 = GENERIC_READ |\n**GENERIC_WRITE, 0x7 = FILE_SHARE_DELETE | FILE_SHARE_WRITE |**\n**FILE_SHARE_READ, 0x3 = OPEN_EXISTING):**\n\n**Figure 66**\n\nThe ransom note is created in every traversed directory (0x40000000 = GENERIC_WRITE,\n0x7 = FILE_SHARE_DELETE | FILE_SHARE_WRITE | FILE_SHARE_READ, 0x2 =\n**CREATE_ALWAYS):**\n\n**Figure 67**\n\nThe ransom note is populated using the WriteFile routine:\n\n\n-----\n\n**Figure 68**\n\n**Figure 69**\n\nThe file’s extension is changed using the MoveFileExW function. The renamed file is opened\nusing CreateFileW (0x7 = FILE_SHARE_DELETE | FILE_SHARE_WRITE |\n**FILE_SHARE_READ, 0x3 = OPEN_EXISTING, 0x02000000 =**\n**FILE_FLAG_BACKUP_SEMANTICS):**\n\n**Figure 70**\n\nInterestingly, BlackCat creates intermediary files called “checkpoints-<encrypted file name>”\nduring the encryption process:\n\n**Figure 71**\n\n\n-----\n\nThe malware generates 16 random bytes that will be used to derive the AES key:\n\n**Figure 72**\n\nThe ransomware moves the file pointer to the beginning of the file by calling the\nSetFilePointerEx API (0x0 = FILE_BEGIN):\n\n**Figure 73**\n\nThe process reads 4 bytes from the beginning of the file using ReadFile:\n\n**Figure 74**\n\nA JSON form containing the encryption cipher (AES), the AES key used to encrypt the file,\nthe data, and the chunk size, is constructed in the process memory:\n\n**Figure 75**\n\nThe binary generates 0x50 (80) random bytes that are used to border the JSON form. The\nresulting buffer has a size of 256 bytes and is rotated using instructions such as pshuflw:\n\n**Figure 76**\n\n\n-----\n\n**Figure 77**\n\nA 4-byte border \"19 47 B2 CE\" that separates the encrypted file content from the encrypted\nAES key is written to the file:\n\n**Figure 78**\n\nThe buffer that contains the AES key presented in figure 77 is encrypted with the RSA public\nkey from the BlackCat configuration. The result is written to the file using WriteFile:\n\n**Figure 79**\n\nThe size of encrypted key (0x100) is written to the file:\n\n**Figure 80**\n\nThe file content is read by using the ReadFile function:\n\n\n-----\n\n**Figure 81**\n\nThe file content is encrypted using the AES-128 algorithm. The malware uses the aesenc\nand aesenclast instructions for this purpose:\n\n**Figure 82**\n\n**Figure 83**\n\nThe encrypted file content is written back to the file using WriteFile:\n\n**Figure 84**\n\nAn example of an encrypted file is displayed below:\n\n\n-----\n\n**Figure 85**\n\nThe ransomware creates a PNG image called “RECOVER-uhwuvzu-FILES.txt.png”:\n\n**Figure 86**\n\n**Figure 87**\n\n\n-----\n\nThe Desktop wallpaper is changed to the above image by calling the\nSystemParametersInfoW API (0x14 = SPI_SETDESKWALLPAPER, 0x3 =\n**SPIF_UPDATEINIFILE | SPIF_SENDCHANGE):**\n\n**Figure 88**\n\n## Running with the --verbose parameter\n\nThe ransomware writes multiple actions to the command line output:\n\n**Figure 89**\n\n## Running with the --extra-verbose --ui parameters\n\nThe malware presents the relevant information in the following window:\n\n**Figure 90**\n\n## Indicators of Compromise\n\n**Pipe**\n\n\\\\.\\pipe\\__rust_anonymous_pipe1__.<Process ID>.<Random number>\n\n**BlackCat Ransom Note**\n\nRECOVER-uhwuvzu-FILES.txt\n\n\n-----\n\n**Files created**\n\ncheckpoints-<Filename>.uhwuvzu\n\nRECOVER-uhwuvzu-FILES.txt.png\n\n**Processes spawned**\n\ncmd.exe /c \"wmic csproduct get UUID\"\n\ncmd.exe /c \"fsutil behavior set SymlinkEvaluation R2L:1”\n\ncmd.exe /c “fsutil behavior set SymlinkEvaluation R2R:1”\n\ncmd.exe /c “iisreset.exe /stop”\n\ncmd.exe /c “vssadmin.exe Delete Shadows /all /quiet”\n\ncmd.exe /c “wmic.exe Shadowcopy Delete”\n\ncmd.exe /c “bcdedit /set {default}”\n\ncmd.exe /c “bcdedit /set {default} recoveryenabled No”\n\ncmd.exe /c for /F \"tokens=*\" %1 in ('wevtutil.exe el') DO wevtutil.exe cl %1\n\ncmd.exe /c “reg add\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters\n/v MaxMpxCt /d 65535 /t REG_DWORD /f”\n\ncmd.exe /c “arp -a”\n\nALPHV/BlackCat is the first widely known ransomware written in Rust. The malware must\nrun with an access token consisting of a 32-byte value (--access-token parameter), and other\nparameters can be specified. The ransomware comes with an encrypted configuration that\ncontains a list of services/processes to be stopped, a list of whitelisted directories/files/file\nextensions, and a list of stolen credentials from the victim environment. It deletes all Volume\nShadow Copies, performs privilege escalation using the CMSTPLUA COM interface, and\nenables “remote to local” and “remote to remote” symbolic links on the victim’s machine.\n\nThe files are encrypted using the AES algorithm, with the AES key being encrypted using the\nRSA public key contained in the configuration. The extension of the encrypted files is\nchanged to uhwuvzu by the malware.\n\n\n-----\n\n[Download Now](https://securityscorecard.pathfactory.com/cybersecurity/blackcatransomware_w)\n\nJoin us in making the world a safer place.\n\n[Free Account Sign Up](https://securityscorecard.com/free-account)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-07-18 - A Deep Dive Into ALPHV-BlackCat Ransomware.pdf"
    ],
    "report_names": [
        "2022-07-18 - A Deep Dive Into ALPHV-BlackCat Ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "6e23ce43-e1ab-46e3-9f80-76fccf77682b",
            "created_at": "2022-10-25T16:07:23.303713Z",
            "updated_at": "2025-03-27T02:02:09.727245Z",
            "deleted_at": null,
            "main_name": "ALPHV",
            "aliases": [
                "ALPHV",
                "ALPHVM",
                "BlackCat Gang",
                "UNC4466"
            ],
            "source_name": "ETDA:ALPHV",
            "tools": [
                "ALPHV",
                "ALPHVM",
                "BlackCat",
                "GO Simple Tunnel",
                "GOST",
                "Impacket",
                "LaZagne",
                "MEGAsync",
                "Mimikatz",
                "Munchkin",
                "Noberus",
                "PsExec",
                "Remcom",
                "RemoteCommandExecution",
                "WebBrowserPassView"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536195,
    "ts_updated_at": 1743041726,
    "ts_creation_date": 1660792933,
    "ts_modification_date": 1660792933,
    "files": {
        "pdf": "https://archive.orkl.eu/36b135006dcfa8282c55373d277f9c19585d94e7.pdf",
        "text": "https://archive.orkl.eu/36b135006dcfa8282c55373d277f9c19585d94e7.txt",
        "img": "https://archive.orkl.eu/36b135006dcfa8282c55373d277f9c19585d94e7.jpg"
    }
}