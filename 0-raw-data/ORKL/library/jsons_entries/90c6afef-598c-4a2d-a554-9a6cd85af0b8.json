{
    "id": "90c6afef-598c-4a2d-a554-9a6cd85af0b8",
    "created_at": "2023-01-12T15:07:06.448824Z",
    "updated_at": "2025-03-27T02:05:31.79007Z",
    "deleted_at": null,
    "sha1_hash": "8e11f812f30d70b8548c38f91e76557f3048b15b",
    "title": "2022-03-02 - Digging into HermeticWiper",
    "authors": "",
    "file_creation_date": "2022-05-28T03:51:23Z",
    "file_modification_date": "2022-05-28T03:51:23Z",
    "file_size": 567761,
    "plain_text": "# Digging into HermeticWiper\n\n**[trellix.com/en-us/about/newsroom/stories/threat-labs/digging-into-hermeticwiper.html](https://www.trellix.com/en-us/about/newsroom/stories/threat-labs/digging-into-hermeticwiper.html)**\n\n## Stories\n\nThe latest cybersecurity trends, best practices,\n\nsecurity vulnerabilities, and more\n\nBy [Max Kersten · March 2, 2022](https://www.trellix.com/en-us/about/newsroom/stories/contributors/max-kersten.html)\n\n_A special thanks to_ _[Marc Elias for his help during my analysis. Additionally, I’d like to commend](https://www.trellix.com/en-us/about/newsroom/stories/contributors/marc-elias.html)_\n_all researchers who have publicly shared their initial findings to help incident response teams; I_\n_hope this deep dive contributes to a further understanding of the malware’s inner workings._\n\nOn the 23rd of February 2022, the HermeticWiper malware was first observed in Ukraine. The\nmalware aims to destroy the boot sectors of any (removable) disk on the infected machine, with\nthe help of a benign partition manager driver. This blog is split up in three main sections: a deep\ntechnical dive into the HermeticWiper sample’s inner workings, a comparison with the recent\nWhisperGate wiper, and a brief word about attribution.\n\n## Technical analysis\n\nThe complete technical analysis is summarised in the flowchart below. Each aspect will be\nexplained in detail, with accompanying segments of code to further clarify the malware’s inner\nworkings.\n\n\n-----\n\nThe analysed sample’s hashes can be found in the table below.\n\nSHA-1 61b25d11392172e587d8da3045812a66c3385451\n\nSHA-256 1bc44eef75779e3ca1eefb8ff5a64807dbc942b1e4a2672d77b9f6928d292591\n\nMD-5 3f4a16b29f2f0532b7ce3e7656799125\n\n## Benign software and certificates\n\nEven though there are multiple stages, the malware starts out as a single signed executable.\nThe certificate which was used to sign the malware originates from Hermetica Digital Ltd, a\nCyprus based company who seems to be another victim in this ordeal, as the company’s owner\n[denies any involvement, per Reuters. The usage of certificates in malware is not new, and solely](https://www.reuters.com/world/europe/cyprus-games-writer-denies-links-malware-found-before-russian-invasion-2022-02-24/)\nserves to mask the file’s malicious intent.\n\n## Start-up checks and privileges\n\nThe first check within the wiper, is the verification of the number of command-line arguments.\nLater on, a sleep is called for a given number of seconds. If a valid integer is provided as a\ncommand-line argument, that value is used. Otherwise, a hardcoded value is used.\n\nTo avoid execution in an analysis environment, the malware verifies if its name starts with a “c”.\nWhen downloading malware from sample sharing sites, the file name is often equal to the hash\nof the file using a common algorithm, such as MD-5, SHA-1, or SHA-256. The (lack of)\ncapitalisation of the character is irrelevant, as the call to CharLowerW ensures the comparison is\nmade using a lower-case “c”, as can be seen in the screenshot below.\n\n|SHA-1|61b25d11392172e587d8da3045812a66c3385451|\n|---|---|\n|SHA-256|1bc44eef75779e3ca1eefb8ff5a64807dbc942b1e4a2672d77b9f6928d292591|\n|MD-5|3f4a16b29f2f0532b7ce3e7656799125|\n\n\n-----\n\nThe numeric value of this character, stored in EAX, is used to calculate the offset on the stack to\nplace the missing wide characters to complete the “SeShutdownPrivilege” wide string. The two\nmov-instructions in the image place the missing wide characters at the calculated offset. The\nimage below shows the original wide string.\n\nNote how “wnPr” are missing in the middle of the wide string. Once the four wide characters are\ninserted, the string is completed, as can be seen below.\n\nUp next is the check for both the above-mentioned privilege, as well as “SeBackupPrivilege”.\nThe two privileges are then requested using AdjustTokenPrivileges. Regardless of the request’s\nsuccess, the malware’s execution continues. The difference the privileges make will be clear\nlater on.\n\n## Loading the benign driver\n\nThe malware then calls a function to drop and load the afore-mentioned benign driver, originally\n[created by EaseUS for its partition manager, and signed by CHENGDU YIWO Tech](https://www.easeus.com/contact.htm)\nDevelopment Co. Ltd., the creator of said software. Note that the driver is benign and misused\nby the malware.\n\nThe driver is embedded (compressed using the MSLZ format) into the wiper’s resources, where\nit contains four versions, pending on the victim’s operating system and CPU bit-ness. The driver\nversions are for Windows XP, both 32-bits and 64-bits, and for any later Windows version, also\nin both 32-bit and 64-bit. The image below shows the corresponding code.\n\n\n-----\n\nThe wiper first checks the Windows version, which is later used to load the corresponding\ncompressed driver from its resources. The malware then disables the creation of memory\ndumps when the system crashes. It does this by setting the registry key at\n“HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\CrashControl\\CrashDumpEnabled”\nto 0, as can be screen in the screenshot below.\n\nThe respective compressed driver is then loaded from the resources, and written to\n“C:\\WINDOWS\\system32\\drivers\\[XX]dr”, where “[XX]” are two randomly generated lower case\ncharacters from the Latin alphabet, ranging “a” through “z”, as can be seen in the image below.\n\n\n-----\n\nThe compressed file is then read from the disk, decompressed, and written to disk using the\nsame file name, with “.sys” added to it.\n\nNext, the wiper attempts to acquires the “SeLoadDriverPrivilege” privilege. If this permission is\nnot granted, the malware terminates itself. An attempt is then made to get a handle to the\nbenign driver, which is accessible via “\\\\.\\EPMNTDRV\\” with a given unsigned integer. If this is\npossible, there is no need to repeat the driver loading procedure. The snippet below shows the\nrelevant code.\n\nIf the driver cannot be accessed, meaning the above failed, it is then loaded. If the service state\nis disabled, the wiper will check up to four times if the service is running, with a one second\nsleep in-between to allow the service to start. The image below shows the corresponding code.\n\n\n-----\n\nUpon the successful creation of the service, the compressed driver is removed from the disk,\ntogether with the service’s corresponding registry key, and its values. The screenshot below\nshows the service’s values in the registry. Note that the service’s name, which is equal to the\ndriver’s name, is “zddr” in the analysis.\n\n\n-----\n\n## Disabling Windows internals\n\nFollowing up on that, the Volume Shadow Copy service (abbreviated as “vss”) is stopped. This\nservice creates incremental back-ups over time, and is often disabled by ransomware for the\nsame reason as the wiper disables it: discontinuing the internal back-up system of Windows.\nThe relevant code can be found in the excerpt below.\n\nThe wiper then recursively overwrites files located at “C:\\System Volume Information”, after\nwhich attempts to forcefully and instantly shut the system down via a thread, which first sleeps\nfor a given number of seconds. Note that the “SeShutdownPrivilege” is required to call the\nshutdown function. This privilege is only obtained if the first character of the malware’s file name\nis a “c”, regardless of the casing, as explained in the start of the technical analysis. The\nscreenshot below shows the corresponding code.\n\n\n-----\n\nFurther changes to the registry are then made, where “ShowCompColor” and “ShowInfoTip”\n(both located at\n“HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced”)\nare set to zero, for each user. These registry keys define if compressed NTFS files should be\ndisplayed in colour, and if tooltips should be shown for folder and desktop items, respectively.\nThe screenshot below shows the corresponding code.\n\n\n-----\n\n## Wiping data\n\nThe malware then checks if the machine where it is executing on, is a Domain Controller. The\nfolder “C:\\Windows\\SYSVOL”, which only exists on Domain Controllers and contains the\npolicies, is checked for its existence, and if it is a folder. The excerpt below shows the check.\n\nIf this is true, a three-minute wait is entered, allowing the threaded overwriting of the boot\nsectors of any attached removable or fixed medium, as can be seen in the image below.\n\nThe data which is used to overwrite the boot sector is random data, which is generated via\nWindows Cryptography API calls, unless an error occurs. If an error occurs, the data is\noverwritten with zeroes. The image below contains an excerpt of the random data generation\nfunction.\n\n\n-----\n\nOnce the three-minute wait is over, the malware shuts itself down. As such, further details within\nthe technical analysis section are only for machines that are not a Domain Controller.\n\nThe wiper then iterates over the first 100 attached drives, and overwrites the boot sector of each\nattached removable or fixed medium.\n\nThe malware then recursively overwrites specific files in “C:\\Documents and Settings” and\n“C:\\Windows\\System32\\winevt\\Logs”. The goal here is to wipe data and minimise the amount of\nusable forensic artifacts.\n\n## Yet another wiper?\n\nThere is more to these two campaigns than their shared destructive nature. Needless to say,\nwipers have been used in various forms, and they are here to stay. Some infamous examples\nare, in no apparent order: WannaCry, NotPetya, Shamoon, and WhisperGate. Note that even\nthough some of the mentioned samples are classified as ransomware, but the way they were\nused made them wipers instead.\n\nThe WhisperGate campaign targeted the boot record of the affected device, much like the\nHermetic wiper does, albeit less thorough. The Hermetic wiper goes over the first hundred\nphysical drives and ruins the boot record if it fits the predefined criteria, as mentioned above.\n\nAdditionally, the usage of a legitimate driver to wipe data differs wildly from the WhisperGate\ncampaign. Whether the driver is used as an attempt to fly under the radar of security products or\nsimply a preference of the wiper’s creator, it’s an effective way to achieve the actor’s goals.\n\nA major difference between the two, is the quality of the code. Whereas WhisperGate’s boot\nrecord replacement was shoddy at best, the Hermetic wiper’s code base shows an in-depth\nunderstanding of volume formats and their handling. Even though there’s a noticeable difference\nin code quality, it is clear that both campaigns have had a disastrous effect on all systems they\nwere executed on.\n\n## Victimology and Attribution\n\nThe majority of the reported victims (both publicly and in our telemetry) are located in Ukraine,\ndating back to the 23rd of February 2022. Some victims have also been observed in other\ncountries, but due to the limited amount, those are likely foreign office for Ukrainian companies.\n\nPer our telemetry, there is an overlap of Ukrainian victims who were victim in both WhisperGate\nand this campaign. The sectors of the victims seem to align with the military strategic goals of an\naggressor: disruption in the communication of an opponent in war time.\n\n\n-----\n\nGiven the fact that the sample s code is newly created, there is no overlap with other samples\nthat have been found in other malware families. One can argue that the malware campaign’s\ntiming, just before Russia’s invasion into Ukraine, is more than a coincidence. Based on the\ndestructive nature of the malware campaign, while also taking the campaign’s timing into\naccount, we attribute this campaign with medium confidence to a pro-Russian actor.\n\n## Conclusion\n\nWiper campaigns have been used in the past and have proven to be effective. The usage of\nbenign software for a malicious purpose, often referred to as dual-use, is common and widely\nadopted. Dual-use software can be found in the form of living-of-the-land binaries, or selfcontained benign files. The HermeticWiper does the latter with the embedded driver, as the boot\nsector altering actions are performed by a benign driver, in-line with the expected behaviour of\nsaid program.\n\nIt comes as no surprise that the digital domain is actively used during war times, given the everincreasing digitalisation of the world around us, as the pandemic has clearly shown. The proRussian targeting of the victims, along with the timing, shows the direct impact the digital\ndomain has in our lives.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-02 - Digging into HermeticWiper.pdf"
    ],
    "report_names": [
        "2022-03-02 - Digging into HermeticWiper.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536026,
    "ts_updated_at": 1743041131,
    "ts_creation_date": 1653709883,
    "ts_modification_date": 1653709883,
    "files": {
        "pdf": "https://archive.orkl.eu/8e11f812f30d70b8548c38f91e76557f3048b15b.pdf",
        "text": "https://archive.orkl.eu/8e11f812f30d70b8548c38f91e76557f3048b15b.txt",
        "img": "https://archive.orkl.eu/8e11f812f30d70b8548c38f91e76557f3048b15b.jpg"
    }
}