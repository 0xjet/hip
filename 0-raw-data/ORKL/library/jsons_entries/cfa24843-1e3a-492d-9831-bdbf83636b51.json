{
    "id": "cfa24843-1e3a-492d-9831-bdbf83636b51",
    "created_at": "2023-01-12T15:07:19.689259Z",
    "updated_at": "2025-03-27T02:16:25.581577Z",
    "deleted_at": null,
    "sha1_hash": "854a24bfcc90c8bf98353612c4aa0aef29a7326f",
    "title": "2021-11-11 - OSX.CDDS a sophisticated watering hole campaign drops a new macOS implant!",
    "authors": "",
    "file_creation_date": "2022-05-29T01:24:09Z",
    "file_modification_date": "2022-05-29T01:24:09Z",
    "file_size": 2774145,
    "plain_text": "# Objective-See's Blog\n\n**objective-see.com/blog/blog_0x69.html**\n\nOSX.CDDS (OSX.MacMa)\n\na sophisticated watering hole campaign drops a new macOS implant!\n\nby: Patrick Wardle / November 11, 2021\n\nüìù üëæ Want to play along?\n[I‚Äôve uploaded an OSX.CDDS sample (password: infect3d).](https://objective-see.com/downloads/malware/CDDS.zip)\n\n...please don‚Äôt infect yourself!\n\nÔøΩ Updates:\n\n[Anti-Virus engines are now detecting this threat.](https://www.virustotal.com/gui/file/f0b12413c9d291e3b9edd1ed1496af7712184a63c066e1d5b2bb528376d66ebc)\n\nAs Google referred to the attack as \"MacMa\", some refer to this malware as\nOSX.MacMa.\n\n[Trend Micro Researchers such as @phretor and](https://twitter.com/phretor) [@evanslify noted that (contrary to](https://twitter.com/evanslify)\ninitial reporting), the malware does not in fact leverage Data Distribution Service (DDS).\n\n[See also \"Google Caught Hackers Using a Mac Zero-Day Against Hong Kong Users\".](https://www.vice.com/en/article/93bw8y/google-caught-hackers-using-a-mac-zero-day-against-hong-kong-users)\n\n## Background\n\nToday, Google‚Äôs Threat Analysis Group (TAG), published an intriguing report titled,\n[‚ÄúAnalyzing a watering hole campaign using macOS exploits.‚Äù](https://blog.google/threat-analysis-group/analyzing-watering-hole-campaign-using-macos-exploits/)\n\nIn this report, they detailed a highly targeted attack that leveraged both iOS and macOS\nexploits in order to remotely infect Apple users. As they were not able to recover the full iOS\nexploit chain, the write-up focused almost fully on the macOS version of the attack which\nleveraged:\n\nA webkit ‚Äún-day‚Äù RCE (patched as CVE-2021-1789 in January)\n\nAn XNU 0-day local privilege escalation (now patched as CVE-2021-30869).\n\nAccording to Google this exploit was, ‚Äúwas presented by Pangu Lab in a public talk at\n_zer0con21 in April 2021 and Mobile Security Conference (MOSEC) in July 2021‚Äù_\n\n\n-----\n\nWhile Google s blog provided a thorough overview of the macOS exploit chain, it did not dig\ntoo much into the persistent macOS implant that would be installed upon successfully\nexploited systems. However they did note:\n\n‚ÄúNotable features for this backdoor include:\n\n_victim device fingerprinting_\n_screen capture_\n_file download/upload_\n_executing terminal commands_\n_audio recording_\n_keylogging‚Äù_\n\nMoreover, they were kind enough to provided hashes of the implant ü§ó And, as these has\nalso been uploaded to VirusTotal, we can grab them for analysis.\n\nIn this blog post, we‚Äôll briefly analyze this implant, `OSX.CDDS ‚Ä¶an implant that currently`\nremains undetected by all of the anti-virus engines on VirusTotal.\n\n## Triage\n\nGoogle‚Äôs report provided two hashes for `OSX.CDDS that would be remotely installed on`\nexploited systems:\n```\n   cf5edcff4053e29cb236d3ed1fe06ca93ae6f64f26e25117d68ee130b9bc60c8\n\n```\ncf5e... on VirusTotal\n\n\n-----\n\n```\n   f0b12413c9d291e3b9edd1ed1496af7712184a63c066e1d5b2bb528376d66ebc\n\n```\nf0b1... on VirusTotal\n\nThe first item, `cf5e..., they noted was the 2021 version of the implant, while the second`\nitem, `f0b1..., was from 2019. Note that both are currently undetected on VirusTotal.`\n\nThe 2019 sample, is a disk image named `install_flash_player_osx.dmg . If we mount`\nit, we find application named `SafariFlashActivity :`\n\nContents of install_flash_player_osx.dmg\nIf we examine its code-signing information, we see its been signed adhoc:\n\n\n-----\n\n```\n% codesign dvv /Volumes/SafariFlashActivity/SafariFlashActivity.app \nExecutable=/Volumes/SafariFlashActivity/\n      SafariFlashActivity.app/Contents/MacOS/SafariFlashActivity\nIdentifier=xxxxxx.preexcl-project\nFormat=app bundle with Mach-O thin (x86_64)\nCodeDirectory v=20100 size=615 flags=0x2(adhoc) hashes=14+3 location=embedded\nSignature=adhoc\nInfo.plist=not bound\nTeamIdentifier=not set\nSealed Resources=none\nInternal requirements count=0 size=12\n\n```\nTaking a peek at it‚Äôs `Info.plist files reveals key-value pairs such as:`\n```\n   LSMinimumSystemVersion : 10.7\n   CFBundleExecutable : SafariFlashActivity\n   CFBundleIdentifier : xxxxx.SafariFlashActivity\n   NSHumanReadableCopyright : Copyright ¬© 2018Âπ¥ xxxxx. All rights\n   reserved.\n\n```\n(Note the Chinese character Âπ¥ translate to ‚Äúyear‚Äù).\n\nAs Google‚Äôs report noted that this was an older (2019) sample of the implant, we won‚Äôt dig\ninto it too much more, instead we‚Äôll focus on the 2021 sample.\n\nStill let‚Äôs note a few facts about the older sample. First, it contains various executable\ncomponents in it `/Resources section:`\n\n\n-----\n\nAdditional executable components\nThe last item, `/Resources/SafariFlashActivityinstall is a simple bash script:`\n```\n% cat Resources/SafariFlashActivityinstall\n#!/bin/bash\nuser=$(whoami)\ndname=`dirname \"$0\"`\ncd \"$dname\"\n./client \"$user\"\nhome_dir=\"$(echo ~)\"\nlaunch_dir=\"$home_dir/Library/LaunchAgents\"\nlaunchctl unload \"$launch_dir/com.UserAgent.va.plist\"\nlaunchctl load \"$launch_dir/com.UserAgent.va.plist\"\n\n```\nIts main goal is to execute the `client binary (with the name of the currently logged in`\nuser), and the unload, then load a launch agent named `com.UserAgent.va.plist .`\n\nWe can observe the invocation of the `SafariFlashActivityinstall script via a process`\nmonitor:\n\n\n-----\n\n```\n# ProcessMonitor.app/Contents/MacOS/ProcessMonitor pretty\n...\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\" : {\n  \"name\" : \"bash\",\n  \"path\" : \"/bin/bash\",\n  \"arguments\" : [\n   \"sh\",\n   \"-c\",\n   \"\\\"/Volumes/SafariFlashActivity/SafariFlashActivity.app\n     /Contents/Resources/SafariFlashActivityinstall\\\"\"\n  ]\n }\n}\n\n```\n‚Ä¶as well as the launch of the `client binary:`\n```\n# ProcessMonitor.app/Contents/MacOS/ProcessMonitor -pretty\n...\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\" : {\n  \"name\" : \"client\",\n  \"path\" : \"/Volumes/SafariFlashActivity/SafariFlashActivity.app\n        /Contents/Resources/client\",\n  \"arguments\" : [\n   \"./client\",\n   \"user\"\n  ]\n }\n}\n\n```\nThe malware also creates a directory named `Tools in the` `~/Library/Preferences/`\ndirectory, and saves several (embedded) custom tools into this directory, including:\n```\n   arch (SHA-1 c4511ad16564eabb2c179d2e36f3f1e59a3f1346 )\n\n```\nThis binary invokes a function, aptly named `captureScreen, to perform a screen`\ncapture, via Apple‚Äôs Core Graphic APIs (e.g. `CGWindowListCreateImageFromArray ).`\nIt appears to then save it out to user-specified file.\n\n\n-----\n\n```\n   at (SHA-1 77a86a6b26a6d0f15f0cb40df62c88249ba80773 )\n\n```\nThis binary performs a simple survey, then writes it out to `stdout . For example, when`\nrun in a virtual machine, it produces the following:\n```\n   % ./at \n   uuid=564D028C-69EF-7793-5BD9-8CC893CB8C8D\n   userName=user\n   version=Version 10.15.6 (Build 19G2021)\n   equipmentType=VMware7,1\n   mac=00:0c:29:cb:8c:8d\n   ip=\n   diskFreeSpace=11251048448/42605699072\n   availableMemory=2098040832/2147483648\n   cpu_info=Intel(R) Core(TM) i7-8559U CPU @ 2.70GHz\n\n```\nBack to the `client binary, it then installs a persistent implant as a Launch Agent:`\n```\n 1<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n 2<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" ...>\n 3<plist version=\"1.0\">\n 4<dict>\n 5 <key>Label</key>\n 6 <string>com.UserAgent.va</string>\n 7 <key>LimitLoadToSessionType</key>\n 8 <string>Aqua</string>\n 9 <key>ProgramArguments</key>\n10 <array>\n11   <string>/Users/user/Library/Preferences/UserAgent/lib/UserAgent</string>\n12   <string>-runMode</string>\n13   <string>ifneeded</string>\n14 </array>\n15 <key>RunAtLoad</key>\n16 <true/>\n17 <key>StartInterval</key>\n18 <integer>600</integer>\n19 <key>ThrottleInterval</key>\n20 <integer>2</integer>\n21 <key>WorkingDirectory</key>\n22 <string>/Users/user/Library/Preferences/UserAgent/lib</string>\n23</dict>\n24</plist>\n\n```\nAs the `RunAtLoad key is set to` `true the specified binary,`\n```\n/Users/user/Library/Preferences/UserAgent/lib/UserAgent will be persistently\n\n```\nexecuted by macOS each time the user logs in.\n\nThe UserAgent binary was originally submitted to VirusTotal on `2019-12-01`.\n‚Ä¶and if we analyze the submission meta-data, we can see it was originally submitted to\nVirusTotal by a user, via one of my Objective-See tools (which integrate with VirusTotal)! How\nfreaking cool!? ü§©\n\n\n-----\n\nFinally, let s note that if (when) the `SafariFlashActivity application is executed, it will`\nsimply display an error to the user:\n\n...upon install .\nThis is notable for two reasons:\n\n1. Based on the use of the Chinese language, this shows the malware is geared towards\n\nChinese users.\n\n2. Along with the fact that the malware is packaged up in an easily runnable application\n\n(masquerading as Flash), this indicates that this version of the malware is designed to\nbe deployed via socially engineering methods. This is different from the 2021 version\nmentioned by Google that was deployed via (remote) exploitation.\n\nThis really isn‚Äôt too surprising. Sophisticated APT groups often split out their implants\nfrom their exploits. Besides allowing multiple people (or even teams) to focus on areas\nof expertise (e.g. writing remote macOS exploits), this also allows the two to be\ndecoupled ‚Ä¶meaning, the implant can be deployed in a variety of ways (social\nengineering, exploitation, etc. etc.).\n\n## 2021\n\nNow on to the 2021 version, ( cf5e... ). This binary seems to directly comparable the\n```\nclient (recall that was found in the /Resources of the application, and launched via the\nSafariFlashActivityinstall bash script when the application was launched).\n\n```\nIn Google‚Äôs report, they note that this binary ( cf5e... ) was downloaded and executed up\nsuccessful exploitation. For purposes of analysis we can simply run it directly from the\nTerminal.\n\nDuring this results in actions similar to those performed by the (older) `client binary`\nincluding:\n\n\n-----\n\nThe creation of a directory named `Tools in the` `~/Library/Preferences/`\ndirectory, into which it drops several custom tools (named `arch,` `at, etc.).`\n\nThe persistence of Launch Agent (or likely daemon is running as root) via the\n```\n   com.UserAgent.va.plist .\n\n```\nAs the `RunAtLoad key is set to` `true the specified binary,`\n```\n   /Users/user/Library/Preferences/UserAgent/lib/UserAgent will be\n\n```\npersistently executed by macOS each time the user logs in.\n\nOf note this, version of the malware drops a new tool named `kAgent ( SHA-1 :`\n```\nD811E97461741E93813EECD8E5349772B1C0B001 ) into the\n~/Library/Preferences/Tools directory.\n\n```\nA quick triage of this binary reveals it‚Äôs a simple keylogger that leverages Core Graphics\nEvent Taps to intercept user keystrokes:\n```\n 1int sub_1000028f0(int arg0) {\n 2  \n 3  runLoop = CFRunLoopGetCurrent();\n 4  runLoopSource = CFMachPortCreateRunLoopSource(kCFAllocatorDefault, *g_eventTap,\n0x0);\n 5  \n 6  CFRunLoopAddSource(*runLoop, runLoopSource, kCFRunLoopCommonModes);\n 7  CGEventTapEnable(*g_eventTap, 0x1);\n 8\n 9  CFRunLoopRun();\n10  \n11  return 0x0;\n12}\n\n```\nIn Google‚Äôs report they noted that, ‚ÄúIt uses a publish- subscribe model via a Data Distribution\n_Service (DDS) framework for communicating with the C2‚Äù_\n\nAs the malware is compiled with a myriad or error and logging message, we can confirm this,\nbut also see exactly what capabilities it supports.\n\nSpecifically we can extract strings in the format `<number>CDDS, as these appear to show`\nthe requests the implant supports:\n\n‚Äú24CDDSScreenCaptureRequest‚Äù\n‚Äú28CDDSAutoScreenCaptureRequest‚Äù\n‚Äú21CDDSScreenCaptureInfo‚Äù\n‚Äú33CDDSScreenCaptureParameterRequest‚Äù\n‚Äú19CDDSFileInfoRequest‚Äù\n‚Äú12CDDSFileInfo‚Äù\n‚Äú18CDDSDirInfoRequest‚Äù\n‚Äú11CDDSDirInfo‚Äù\n‚Äú17CDDSZipDirRequest‚Äù\n\n\n-----\n\n21CDDSZipDirRequestInfo\n‚Äú22CDDSExecuteFileRequest‚Äù\n‚Äú19CDDSTerminalConnect‚Äù\n‚Äú22CDDSTerminalDisConnect‚Äù\n‚Äú17CDDSTerminalInput‚Äù\n‚Äú18CDDSTerminalOutput‚Äù\n‚Äú20CDDSUninstallRequest‚Äù\n‚Äú20CDDSClearDataRequest‚Äù\n‚Äú10CDDSCmdAck‚Äù\n‚Äú18CDDSReqMacBaseInfo‚Äù\n‚Äú15CDDSMacBaseInfo‚Äù\n‚Äú18CDDSReqMacFileList‚Äù\n‚Äú15CDDSMacFileList‚Äù\n‚Äú20CDDSMacFileListReply‚Äù\n‚Äú20CDDSReqMacSearchFile‚Äù\n‚Äú17CDDSMacSearchFile‚Äù\n‚Äú22CDDSMacSearchFileReply‚Äù\n‚Äú21CDDSStopMacSearchFile‚Äù\n‚Äú20CDDSReqMacDeleteFile‚Äù\n‚Äú20CDDSReqMacFileSystem‚Äù\n‚Äú17CDDSBaseInfoReply‚Äù\n‚Äú14CDDSReqMacTree‚Äù\n‚Äú13CDDSDriveInfo‚Äù\n\n‚Ä¶based off these tasking strings, it‚Äôs clear to see the implant supports a myriad of features!\n\nThis is also why this malware is named OSX.CDDS!\n```\nOSX.CDDS .vs Objective-See\n\n```\nWhenever a new piece of malware is uncovered I like to see how Objective-See‚Äôs free opensource tools stack up.\n\nGood news (and no really no surprise) they are able to detect and thus thwart this new\nthreat, even with no a priori knowledge of it! üòç\n\nLet‚Äôs look at how!\n\nFirst, [BlockBlock detects OSX.CDDS‚Äô attempt at persistence ‚Ä¶specifically when it executes](https://objective-see.com/products/blockblock.html)\n```\ncp to create a launch item:\n\n```\n\n-----\n\nBlockBlock alert\n[LuLu, our free, open-source firewall detects when the implant first attempts to beacon out to](https://objective-see.com/products/lulu.html)\nits command and control server to check-in and ask for tasking:\n\nLuLu alert\n[And if you‚Äôre worried that you are already infected? KnockKnock can uncover the malware‚Äôs](https://objective-see.com/products/knockknock.html)\npersistence (after the fact):\n\n\n-----\n\nKnockKnock detection\n\n## Conclusions\n\nIt‚Äôs not everyday we come across a brand new fully-featured macOS implant to analyze. ü§ó\n\nToday, we triaged OSX.CDDS, an implant (whose latest version) Google detected being\nremotely deployed via n-day and 0-day exploits.\n\n## üíï Support Me:\n\n[Love these blog posts? You can support them via my Patreon page!](https://www.patreon.com/bePatron?c=701171)\n\nThis website uses cookies to improve your experience.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-11 - OSX.CDDS a sophisticated watering hole campaign drops a new macOS implant!.pdf"
    ],
    "report_names": [
        "2021-11-11 - OSX.CDDS a sophisticated watering hole campaign drops a new macOS implant!.pdf"
    ],
    "threat_actors": [
        {
            "id": "52d5d8b3-ab13-4fc4-8d5f-068f788e4f2b",
            "created_at": "2022-10-25T16:07:24.503878Z",
            "updated_at": "2025-03-27T02:02:10.261742Z",
            "deleted_at": null,
            "main_name": "Lapsus$",
            "aliases": [
                "DEV-0537",
                "Strawberry Tempest"
            ],
            "source_name": "ETDA:Lapsus$",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "be5097b2-a70f-490f-8c06-250773692fae",
            "created_at": "2022-10-27T08:27:13.22631Z",
            "updated_at": "2025-03-27T02:00:55.534879Z",
            "deleted_at": null,
            "main_name": "LAPSUS$",
            "aliases": [
                "LAPSUS$",
                "DEV-0537",
                "Strawberry Tempest"
            ],
            "source_name": "MITRE:LAPSUS$",
            "tools": [
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d4b9608d-af69-43bc-a08a-38167ac6306a",
            "created_at": "2023-01-06T13:46:39.335061Z",
            "updated_at": "2025-03-27T02:00:03.053961Z",
            "deleted_at": null,
            "main_name": "LAPSUS",
            "aliases": [
                "LAPSUS$",
                "DEV-0537",
                "SLIPPY SPIDER",
                "Strawberry Tempest"
            ],
            "source_name": "MISPGALAXY:LAPSUS",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536039,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1653787449,
    "ts_modification_date": 1653787449,
    "files": {
        "pdf": "https://archive.orkl.eu/854a24bfcc90c8bf98353612c4aa0aef29a7326f.pdf",
        "text": "https://archive.orkl.eu/854a24bfcc90c8bf98353612c4aa0aef29a7326f.txt",
        "img": "https://archive.orkl.eu/854a24bfcc90c8bf98353612c4aa0aef29a7326f.jpg"
    }
}