{
    "id": "eaadf938-6963-4898-b34b-c5eaaf502f83",
    "created_at": "2023-01-12T15:08:03.433596Z",
    "updated_at": "2025-03-27T02:05:57.611203Z",
    "deleted_at": null,
    "sha1_hash": "d0bfbc099e9e09e8bfdd16022be42fba90e0fa97",
    "title": "2017-10-10 - ATMii- a small but effective ATM robber",
    "authors": "",
    "file_creation_date": "2022-05-29T10:52:39Z",
    "file_modification_date": "2022-05-29T10:52:39Z",
    "file_size": 347704,
    "plain_text": "# ATMii: a small but effective ATM robber\n\n**[securelist.com/atmii-a-small-but-effective-atm-robber/82707/](https://securelist.com/atmii-a-small-but-effective-atm-robber/82707/)**\n\nAuthors\n\n[Konstantin Zykov](https://securelist.com/author/konstantinzykov/)\n\nWhile some [criminals](https://www.schneier.com/blog/archives/2006/03/blowing_up_atm.html) [blow up ATMs to steal cash, others use less destructive methods, such](http://www.mirror.co.uk/news/uk-news/atm-gang-who-stole-120000-9494804)\nas infecting the ATM with malware and then stealing the money. We [have written about](https://usa.kaspersky.com/about/press-releases/2016_atm-is-a-new-skimmer-crooks-bring-atms-on-their-side) this\nphenomenon [extensively in the past and today we can add another family of malware to the](https://securelist.com/malware-and-non-malware-ways-for-atm-jackpotting-extended-cut/74533/)\nlist – Backdoor.Win32.ATMii.\n\nATMii was first brought to our attention in April 2017, when a partner from the financial\nindustry shared some samples with us. The malware turned out to be fairly straightforward,\nconsisting of only two modules: an injector module (exe.exe,\n3fddbf20b41e335b6b1615536b8e1292) and the module to be injected (dll.dll,\ndc42ed8e1de55185c9240f33863a6aa4). To use this malware, criminals need direct access\nto the target ATM, either over the network or physically (e.g. over USB). ATMii, if it is\nsuccessful, allows criminals to dispense all the cash from the ATM.\n\n\n-----\n\n## exe.exe – an injector and control module\n\nThe injector is an unprotected command line application, written in Visual C with a\ncompilation timestamp: Fri Nov 01 14:33:23 2013 UTC. Since this compilation timestamp is\nfrom 4 years ago – and we do not think this threat could have gone unnoticed for 4 years –\nwe believe it is a fake timestamp. What’s also interesting is the OS that is supported by the\nmalware: One more recent than Windows XP. We can see this in the image below, where the\nfirst argument for the OpenProcess() function is 0x1FFFFu.\n\n_OpenProcess call with the PROCESS_ALL_ACCESS constant_\n\nIt is the PROCESS_ALL_ACCESS constant, but this constant value differs in older Windows\nversions such as Windows XP (see the picture below). This is interesting because most\nATMs still run on Windows XP, which is thus [not supported by the malware.](https://social.msdn.microsoft.com/Forums/windowsdesktop/en-US/eeb93be6-872c-4028-b0ae-cd873e089825/openprocess-error-in-windows-xp?forum=vclanguage)\n\n_A list of PROCESS_ALL_ACCESS values per Windows version_\n\nThe injector, which targets the atmapp.exe (proprietary ATM software) process, is fairly\npoorly written, since it depends on several parameters. If none are given, the application\ncatches an exception. The parameters are pretty self-explanatory:\n\n**param** **short description**\n\n\n-----\n\n_/load_ Tries to inject dll.dll into atmapp.exe process\n\n_/cmd_ Creates/Updates C:\\ATM\\c.ini file to pass commands and params to infected\nlibrary\n\n_/unload_ Tries to unload injected library from atmapp.exe process, while restoring its\nstate.\n\n### /load param\n\n_<exe.exe> /load_\n\nThe application searches for a process with the name atmapp.exe and injects code into it\nthat loads the “dll.dll” library (which has to be in the same folder as the exe.exe file). After it\nhas been loaded it calls the DLLmain function.\n\n### /unload param\n\n_<exe.exe> /unload_\n\nAs the name already suggests, it is the opposite of the /load parameter; it unloads the\ninjected module and restores the process to its original state.\n\n### /cmd param\n\n_<exe.exe> /cmd [cmd] [params]_\n\nThe application creates/updates C:\\ATM\\c.ini which is used by the injected DLL to read\ncommands. The file is updated each time the .exe is run with the /cmd param.\n\n_Contents of c.ini after execution of “exe.exe /cmd info”_\n\nThe executable understands the following set of commands:\n\n**command** **description**\n\n_scan_ Scans for the CASH_UNIT XFS service\n\n_disp_ Stands for “dispense”. The injected module should dispense “amount” cash of\n“currency” (amount and currency are used as parameters)\n\ninfo Gets info about ATM cash cassettes, all the returned data goes to the log file.\n\n\n-----\n\ndie Injected module removes C:\\ATM\\c.ini file\n\n## dll.dll injecting module\n\nAfter injection and execution of the DllMain function, the dll.dll library loads msxfs.dll and\nreplaces the WFSGetInfo function with a special wrap function, named mWFSGetInfo.\n\nAt the time of the first call to the fake WFSGetInfo function, C:\\ATM\\c.ini is ignored and the\nlibrary tries to find the ATM’s CASH_UNIT service id and stores the result, basically in the\nsame way as the scan command does. If the CASH_UNIT service is not found, dll.dll won’t\nfunction. However, if successful, all further calls go to the mWFSGetInfo function, which\nperforms the additional logic (reading, parsing and executing the commands from the\n_C:\\ATM\\c.ini file)._\n\n_Contents of C:\\ATM\\c.ini after execution of “exe.exe /cmd disp RUB 6000”_\n\nBelow is an output of the strings program uncovering some interesting log messages and the\nfunction names to be imported. The proprietary MSXFS.DLL library and its functions used in\nthe ATMii malware are marked with red boxes.\n\n\n-----\n\n### “scan” command\n\n[Because of the architecture of XFS, which is divided into services, the injected library first](https://en.wikipedia.org/wiki/CEN/XFS)\nneeds to find the dispense service. This command must be successfully called, because the\n_disp and info commands depend on the service id retrieved by scan. Scan is automatically_\ncalled after the dll has been injected into atmapp.exe.\n\nAfter collecting the WFS_INF_CDM_STATUS data, additional data gets added to the\n_tlogs.log. An example can be found below:_\n\n…\n\n(387):cmd_scan() Searching valid service\n(358):FindValidService() Checking device index=0\n\n\n-----\n\n(70):CheckServiceForValid() ————————————————\n(72):CheckServiceForValid() Waiting for lock\n(76):CheckServiceForValid() Device was locked\n(86):CheckServiceForValid() WFSGetInfo Success 0\n(182):CheckServiceForValid() Done-> szDevice: WFS_CDM_DEVONLINE, szDispenser:\nWFS_CDM_DISPOK, szIntermediateStacker: WFS_CDM_ISEMPTY, szSafeDoor:\nWFS_CDM_DOORCLOSED\n(195):CheckServiceForValid() Unlocking device\n(390):cmd_scan() Service found 0\n…\n\n_Part of a tlogs.log possible log after successfully executed “scan” command_\n\n### “info” command\n\nBefore the criminals can dispense cash, they first need to know the exact contents of the\ndifferent cassettes. For this, they use the info command which provides exhaustive\ninformation on all cassettes and their contents. The list of used XFS API functions is the\nsame as with the scan command, but this time WFSGetInfo is called with the\nWFS_INF_CDM_CASH_UNIT_INFO (303) constant passed as a param.\n\nBelow is an example of the data in log file returned by the info command.\n\n…\n\n(502):ExecuteCmd() Executing cmd\n\n(506):ExecuteCmd() CMD = info\n\n(402):cmd_info() ! hFoundGlobalService = 0\n\n(213):GetDeviceInformation() ————————————————\n\n(220):GetDeviceInformation() Device locked 0\n\n(337):GetDeviceInformation() Module: C:\\program files\\dtatmw\\bin\\atmapp\\atmapp.exe\n\nCash Unit # 1, name=SOMENAME\n\nType: 3\n\nStatus: HIGH\n\nCurrency ID: 0x52-0x55-0x42\n\nNote Value: 5000\n\nNotes Count: 3000\n\nNotes Initial Count: 3000\n\nNotes Minimum Count: 10\n\nNotes Maximum Count: 0\n\n…\n\n_Example5 Part of a tlogs.log possible log after successfully executed “info” command_\n\n### “disp” command\n\n\n-----\n\nThe dispense command is followed by two additional params in the command file: currency\nand amount. Currency must contain one of the three-letter currency codes of notes kept in\n[the CASH_UNIT_INFO structure (currency codes are described in ISO_4217 e.g. RUB,](https://en.wikipedia.org/wiki/ISO_4217)\nEUR). The amount code holds the amount of cash to dispense and this value must be a\nmultiple of ten.\n\n### “die” command\n\nDoes nothing except deleting C:\\ATM\\c.ini command file.\n\n## Conclusion\n\nATMii is yet another example of how criminals can use legitimate proprietary libraries and a\nsmall piece of code to dispense money from an ATM. Some appropriate countermeasures\nagainst such attacks are default-deny policies and device control. The first measure prevents\ncriminals from running their own code on the ATM’s internal PC, while the second measure\nwill prevent them from connecting new devices, such as USB sticks.\n\n[ATM](https://securelist.com/tag/atm/)\n[Backdoor](https://securelist.com/tag/backdoor/)\n[Financial malware](https://securelist.com/tag/financial-malware/)\n[Malware Technologies](https://securelist.com/tag/malware-technologies/)\n\nAuthors\n\n[Konstantin Zykov](https://securelist.com/author/konstantinzykov/)\n\nATMii: a small but effective ATM robber\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-10-10 - ATMii- a small but effective ATM robber.pdf"
    ],
    "report_names": [
        "2017-10-10 - ATMii- a small but effective ATM robber.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536083,
    "ts_updated_at": 1743041157,
    "ts_creation_date": 1653821559,
    "ts_modification_date": 1653821559,
    "files": {
        "pdf": "https://archive.orkl.eu/d0bfbc099e9e09e8bfdd16022be42fba90e0fa97.pdf",
        "text": "https://archive.orkl.eu/d0bfbc099e9e09e8bfdd16022be42fba90e0fa97.txt",
        "img": "https://archive.orkl.eu/d0bfbc099e9e09e8bfdd16022be42fba90e0fa97.jpg"
    }
}