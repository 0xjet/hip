{
    "id": "df92f34f-cfee-4fba-bceb-b66eed2fc3d8",
    "created_at": "2023-01-12T15:01:41.294503Z",
    "updated_at": "2025-03-27T02:15:24.613117Z",
    "deleted_at": null,
    "sha1_hash": "027c32910553d540f09fdb560a454e8ad5ab8893",
    "title": "2022-03-31 - Threat Thursday- Malicious Macros Still Causing Chaos",
    "authors": "",
    "file_creation_date": "2022-05-28T23:24:13Z",
    "file_modification_date": "2022-05-28T23:24:13Z",
    "file_size": 1419191,
    "plain_text": "# Threat Thursday: Malicious Macros Still Causing Chaos\n\n**[blogs.blackberry.com/en/2022/03/threat-thursday-malicious-macros](https://blogs.blackberry.com/en/2022/03/threat-thursday-malicious-macros)**\n\nThe BlackBerry Research & Intelligence Team\n\nDocuments and spreadsheets may seem like innocuous, fancified text files. But with the\npresence of macros, they have the capability within them to cause great pain.\n\n[Malicious macros are a tool used by well-known threat actors such as APT28 and Muddy](https://blogs.blackberry.com/en/2019/08/inside-the-apt28-dll-backdoor-blitz)\nWater to gain entry to target systems, yet they have been around and causing trouble for\ndecades. And while Microsoft® Office has recently [made some changes to its default](https://techcommunity.microsoft.com/t5/microsoft-365-blog/helping-users-stay-safe-blocking-internet-macros-by-default-in/ba-p/3071805)\nbehavior, blocking several common macro threat vectors, certain Windows Startup\ntechniques commonly used by cyber criminals have yet to be addressed.\n\nThese startup techniques abuse built-in features of Office in a way that lets adversaries\nestablish persistence on a victim’s system. Because the macros will infect other files that\nthe victim uses after the initial file is opened, this can make the malicious code hard to\npurge.\n\n### Operating System\n\n\n-----\n\n### Risk & Impact\n\n What are VBA Macros?\n\nVisual Basic for Application (VBA) is a scripting language for use within Microsoft Office\ndocuments. It allows you to include code that does everything you can normally do on your\ncomputer. Most casual users might think of Office as “just” for making simple documents\nand spreadsheets, but it's actually an incredibly powerful, potentially operating systemagnostic format that makes doing things behind the scenes very \"user-friendly\" (for better or\nfor worse).\n\nIt might help if you think of an Office file as a file system, rather than just a single file. You\ncan rename a .DOCX file to .ZIP and unpack it like you would a regular ZIP file. And within\nthat structure, you can embed things like scripts, images, PDF files and even EXE files, all\nof which can be weaponized by bad actors.\n\n### Technical Analysis\n\nAdversaries will always prefer to achieve persistence on a victim’s machine over having to\nre-infect it, as repeated deployment of malware is less efficient and more likely to get them\ncaught by defenders.\n\nToday we will be looking at two methods that are specific to Microsoft Office macros:\n\nOffice Test (MITRE ATT&CK - [T1137.002)](https://attack.mitre.org/techniques/T1137/002/)\n\nOffice Template Macros (MITRE ATT&CK - [T1137.001)](https://attack.mitre.org/techniques/T1137/001/)\n\n### Office Test\n\nOffice Test is a simple registry key that can be abused to load arbitrary DLLs whenever an\nOffice application is started. These keys are not installed by default, and are believed to be\nloaded as part of a Microsoft internal automation and testing suite.\n\n\n-----\n\nWriting to either of the following two registry keys will allow a DLL at the path value\nspecified to be loaded during the startup of all Office products, every time the applications\nare opened, without any security warnings or any user authorizations required.\n\nHKEY_CURRENT_USER\\Software\\Microsoft\\Office test\\Special\\Perf\nHKEY_LOCAL_MACHINE\\Software\\Microsoft\\Office test\\Special\\Perf\n\n### Office Template Macros\n\nOffice Template Macros are a startup technique that is much more familiar and prevalent.\nThis tactic leverages the fact that every Office document is based on a template file, even\nbrand-new, “blank” files, such as the empty page you see when you open a new Word\ndocument.\n\nA huge number of virus families have used this tactic over the years, with a few notable\nexamples. The [Concept virus was the first macro virus. It tampered with Microsoft® Word’s](http://virus.wikidot.com/concept)\n[global template file, which was named “Normal.dot” at the time. The Laroux virus came](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Virus:X97M/Laroux)\nsoon after, bringing the technique to Excel® spreadsheets on Windows® machines.\n\nFor many years, macro viruses were all but extinct, after Microsoft disabled macros by\ndefault on all documents in the early 2000s. However, this feature was turned off by many\ncompanies that used in-house (that is to say, useful and benign) macros. Threat actors\n[soon wised up to the fact that they could simply ask victims to click the “enable” button that](https://www.virusbulletin.com/blog/2014/11/macro-malware-rise-again/)\nwas right there on the notification message from Microsoft, allowing their creations to\nexecute. Before long, this tactic had once again reached its former glory and was employed\nby a multitude of threat actors.\n\nWe still see customers being hit by threats from before the “macro extinction,” such as Divi.\nAnd newer threats that have only been around for a couple years, such as Modfek, are still\ncausing significant pain.\n\n### Templates and Startup Functionality\n\nThe Office template attack consists of an attacker placing a malicious, macro-enabled\ndocument in the folder that the Office product uses to store its templates. Placing it here will\ncause this base document and its macros to be loaded every time the program is opened.\n\nFor Word, this location is:\n\n**%AppData%\\Roaming\\Microsoft\\Templates\\Normal.dotm**\n\nFor Excel, this location is:\n\n**%AppData%\\Roaming\\Microsoft\\Excel\\XLSTART\\$NAME$.XLSB**\n\n\n-----\n\nThe name must be specifically Normal.dotm in recent versions of Word. However, in the\nExcel folder, the name of the file is irrelevant, though the default in recent versions of Excel\nis “Personal.xlsb”.\n\n_Figure 1 - Simple proof of concept macro to open Calculator, as a benign example of code_\n_execution_\n\nNow that the template file is infected, any notebook that is opened will execute this VBA\ncode.\n\nSome macro viruses, like Modfek, take this a step further and will write macros to any\nsubsequent files that are opened. This allows a persistence mechanism to move back and\nforth, so that it will continue to persist even if the template is cleaned out.\n\n\n-----\n\n_Figure 2 - The macro runs without the security ribbon_\n\nThis execution happens without any macro warning or necessary authorization by the\nvictim. This occurs without settings needing to be changed in the macro policy.\n\n\n-----\n\n_Figure 3 - The behavior has overridden the defined Macro Settings_\n\nMany macro viruses use their code to check if the Startup folder is infected, and if not, to\nadd its code to the template.\n\nSeveral aspects of the Office Startup directory are [configurable through registry keys in the](http://www.hexacorn.com/blog/2016/11/24/beyond-good-ol-run-key-part-51)\nfollowing location.\n\n**HKCU\\Software\\Microsoft\\Office\\<version>\\Common\\General\\**\n\nThe “Xlstart” key controls the template location for Excel (shown in Figure 4 with the value\nchanged to TEMP), and the “Startup” key controls the template location for Word files.\n\n_Figure 4 - Registry keys for configuring startup folders_\n\n### Conclusion\n\n\n-----\n\n[Microsoft will soon begin natively blocking macros on files sourced from the Internet, with a](https://techcommunity.microsoft.com/t5/microsoft-365-blog/helping-users-stay-safe-blocking-internet-macros-by-default-in/ba-p/3071805)\nstronger warning that makes it harder to re-enable this functionality. While this could reduce\nthe impact of some of the attack features, macros in startup documents still have the ability\nto bypass the security policy set by users. It is unclear when or whether this will be fixed by\nMicrosoft.\n\nA few of the changes in the upcoming update to macro functionality seem to prioritize\nusability over the security of this policy. For example, saving files (even from the Internet) to\nany [Trusted Location will make Office ignore this policy, and it will open the files with VBA](https://docs.microsoft.com/en-us/DeployOffice/security/internet-macros-blocked#additional-information)\nenabled.\n\n[Microsoft does not plan to roll this out to most users until Summer 2022, and fixes for Office](https://docs.microsoft.com/en-us/DeployOffice/security/internet-macros-blocked#versions-of-office-affected-by-this-change)\nversions LTSC 2021, 2019, 2016, and 2013 have not yet been revealed.\n\nThe question also remains why all macros are being disabled rather than just removing\n“Auto” functions, as these tend to be the top choice for malicious activity in Office files.\n\nUntil this is sorted, there are several other mitigation tactics you can take.\n\n### Mitigation\n\nRegistry key permissions should be in line with least privilege for their respective users,\nwhich can include creation and lockdown of non-default option keys. Furthermore,\nmonitoring of value changes to unusual keys should create potential events. These same\nprotections should be enacted on the modification of template files themselves, as\nappropriate to the organization.\n\nA number of Microsoft Attack Surface Reduction rules can be used to limit different\nfunctionalities of Office, including:\n\nOffice apps launching child processes\nOffice apps/macros creating executable content\nOffice apps injecting code into other processes\nWin32 imports from Office macro code – block Win32 API calls from Office\n\n[CylanceOPTICS® provides the following XDR rule to combat these threats:](https://www.blackberry.com/us/en/products/unified-endpoint-security/blackberry-optics)\n\noffice_application_startup_mitre\n\n### BlackBerry Assistance\n\nIf you’re battling this malware or a similar threat, you’ve come to the right place, regardless\nof your existing BlackBerry relationship.\n\n\n-----\n\n[The BlackBerry Incident Response team is made up of world-class consultants dedicated to](https://www.blackberry.com/us/en/services/incident-response)\nhandling response and containment services for a wide range of incidents, including\nransomware and Advanced Persistent Threat (APT) cases.\n\nWe have a global consulting team standing by to assist you, providing around-the-clock\nsupport where required, as well as local assistance. Please contact us\nhere: https://www.blackberry.com/us/en/forms/cylance/handraiser/emergency-incidentresponse-containment\n\n## About The BlackBerry Research & Intelligence Team\n\nThe BlackBerry Research & Intelligence team examines emerging and persistent threats,\nproviding intelligence analysis for the benefit of defenders and the organizations they serve.\n\nBack\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-31 - Threat Thursday- Malicious Macros Still Causing Chaos.pdf"
    ],
    "report_names": [
        "2022-03-31 - Threat Thursday- Malicious Macros Still Causing Chaos.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "2ed8d590-defa-4873-b2de-b75c9b30931e",
            "created_at": "2023-01-06T13:46:38.730137Z",
            "updated_at": "2025-03-27T02:00:02.903261Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "Boggy Serpens",
                "Mango Sandstorm",
                "TEMP.Zagros",
                "Static Kitten",
                "G0069",
                "TA450",
                "Earth Vetala",
                "Seedworm",
                "COBALT ULSTER",
                "ATK51"
            ],
            "source_name": "MISPGALAXY:MuddyWater",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "02e1c2df-8abd-49b1-91d1-61bc733cf96b",
            "created_at": "2022-10-25T15:50:23.308924Z",
            "updated_at": "2025-03-27T02:00:55.437268Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "MuddyWater",
                "Earth Vetala",
                "Static Kitten",
                "Seedworm",
                "TEMP.Zagros",
                "Mango Sandstorm",
                "TA450"
            ],
            "source_name": "MITRE:MuddyWater",
            "tools": [
                "STARWHALE",
                "POWERSTATS",
                "Out1",
                "PowerSploit",
                "Small Sieve",
                "Mori",
                "Mimikatz",
                "LaZagne",
                "PowGoop",
                "CrackMapExec",
                "ConnectWise",
                "SHARPSTATS",
                "RemoteUtilities",
                "Koadic"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3c430d71-ab2b-4588-820a-42dd6cfc39fb",
            "created_at": "2022-10-25T16:07:23.880522Z",
            "updated_at": "2025-03-27T02:02:10.010443Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "ATK 51",
                "Boggy Serpens",
                "Cobalt Ulster",
                "ITG17",
                "Mango Sandstorm",
                "MuddyWater",
                "Operation BlackWater",
                "Operation Earth Vetala",
                "Operation Quicksand",
                "Seedworm",
                "Static Kitten",
                "T-APT-14",
                "TA450",
                "TEMP.Zagros",
                "Yellow Nix"
            ],
            "source_name": "ETDA:MuddyWater",
            "tools": [
                "Agentemis",
                "BugSleep",
                "CLOUDSTATS",
                "ChromeCookiesView",
                "Cobalt Strike",
                "CobaltStrike",
                "CrackMapExec",
                "DELPHSTATS",
                "EmPyre",
                "EmpireProject",
                "FruityC2",
                "Koadic",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "MZCookiesView",
                "Meterpreter",
                "Mimikatz",
                "MuddyC2Go",
                "MuddyRot",
                "Mudwater",
                "POWERSTATS",
                "PRB-Backdoor",
                "PhonyC2",
                "PowGoop",
                "PowerShell Empire",
                "PowerSploit",
                "Powermud",
                "QUADAGENT",
                "SHARPSTATS",
                "SSF",
                "Secure Socket Funneling",
                "Shootback",
                "Smbmap",
                "Valyria",
                "chrome-passwords",
                "cobeacon",
                "prb_backdoor"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535701,
    "ts_updated_at": 1743041724,
    "ts_creation_date": 1653780253,
    "ts_modification_date": 1653780253,
    "files": {
        "pdf": "https://archive.orkl.eu/027c32910553d540f09fdb560a454e8ad5ab8893.pdf",
        "text": "https://archive.orkl.eu/027c32910553d540f09fdb560a454e8ad5ab8893.txt",
        "img": "https://archive.orkl.eu/027c32910553d540f09fdb560a454e8ad5ab8893.jpg"
    }
}