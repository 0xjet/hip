{
    "id": "c7c77afc-fb15-4142-bfc1-3cf66bfd5fff",
    "created_at": "2023-01-12T14:59:38.843767Z",
    "updated_at": "2025-03-27T02:17:27.596656Z",
    "deleted_at": null,
    "sha1_hash": "f66c59ca3da1be1203ab5dd0257e9de40e5a7d9e",
    "title": "2017-11-08 - OilRig Deploys “ALMA Communicator” – DNS Tunneling Trojan",
    "authors": "",
    "file_creation_date": "2022-05-28T00:34:27Z",
    "file_modification_date": "2022-05-28T00:34:27Z",
    "file_size": 725947,
    "plain_text": "# OilRig Deploys “ALMA Communicator” – DNS Tunneling Trojan\n\n**[researchcenter.paloaltonetworks.com/2017/11/unit42-oilrig-deploys-alma-communicator-dns-tunneling-trojan/](https://researchcenter.paloaltonetworks.com/2017/11/unit42-oilrig-deploys-alma-communicator-dns-tunneling-trojan/)**\n\nRobert Falcone November 8, 2017\n\nBy [Robert Falcone](https://unit42.paloaltonetworks.com/author/robertfalcone/)\n\nNovember 8, 2017 at 1:00 PM\n\n[Category: Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [ALMA Communicator,](https://unit42.paloaltonetworks.com/tag/alma-communicator/) [Clayside,](https://unit42.paloaltonetworks.com/tag/clayside/) [Mimikatz,](https://unit42.paloaltonetworks.com/tag/mimikatz/) [OilRig,](https://unit42.paloaltonetworks.com/tag/oilrig/) [OilRig attacks](https://unit42.paloaltonetworks.com/tag/oilrig-attacks/)\n\n[Unit 42 has been closely tracking the OilRig threat group since](https://blog.paloaltonetworks.com/tag/oilrig/) [May 2016. One technique](https://blog.paloaltonetworks.com/2016/05/the-oilrig-campaign-attacks-on-saudi-arabian-organizations-deliver-helminth-backdoor/)\n[we’ve been tracking with this threat group is their use of the Clayslide delivery document as](https://blog.paloaltonetworks.com/tag/clayside/)\nattachments to spear-phishing emails in attacks since May 2016. In our April 2017 posting\n[OilRig Actors Provide a Glimpse into Development and Testing Efforts we showed how we](https://blog.paloaltonetworks.com/2017/04/unit42-oilrig-actors-provide-glimpse-development-testing-efforts/)\nobserved the OilRig threat group developing and refining these Clayside delivery documents.\n\nRecently, we observed a new version of the Clayslide delivery document used to install a\nnew custom Trojan whose developer calls it “ALMA Communicator”. The delivery document\nalso saved the post-exploitation credential harvesting tool known as Mimikatz, which we\nbelieve the threat actors will use to gather account credentials from the compromised\nsystem. While we do not have detailed telemetry, we have reason to believe this attack\ntargeted an individual at a public utilities company in the Middle East.\n\n\n-----\n\nNew Clayslide Delivery Document\nThe most recent build of Clayslide operates in a similar way to its predecessors, as it initially\ndisplays an \"Incompatible\" worksheet that states that the Excel file was created with a newer\nversion of Excel and the user needs to \"Enable Content\" to view the document. If the user\nclicks \"Enable Content\", a malicious macro will run that begins by displaying a hidden\nworksheet that contains decoy contents, as seen in the following:\n\nWhile the decoy is displayed to the victim, the malicious macro accesses data from specific\ncells in the \"Incompatible\" worksheet that it concatenates to create an .HTA file, which it then\nsaves to %PUBLIC%\\tmp.hta and opens with the mshta.exe application. The .HTA file\ncontains HTML that will run a VBScript that finally installs the malicious payload for this\nattack.\n\nThe payload installation process begins with the .HTA file creating a folder named\n%PUBLIC%\\{5468973-4973-50726F6A656374-414C4D412E-2}, to which it writes three files\nwith the following names:\n\nSystemSyncs.exe\nm6.e\ncfg\n\nThe .HTA file contains two encoded executables that it will decode and write to m6.e and\nSystemSyncs.exe. The .HTA file contains a base64 encoded configuration that it decodes\nand saves to the cfg file, which the Trojan will use to obtain the C2 domain that it will use to\ncommunicate with the threat actor. The C2 domain saved to the cfg file in this attack is\nprosalar[.]com.\n\nThe SystemSyncs.exe file (SHA256:\n2fc7810a316863a5a5076bf3078ac6fad246bc8773a5fb835e0993609e5bb62e) is a custom\nTrojan created by the OilRig group called “ALMA Communicator”, which we will describe in\n\n\n-----\n\ndetail in the next section.\nThe \"m6.e\" file dropped by the .HTA file is a variant of Mimikatz (SHA256:\n2d6f06d8ee0da16d2335f26eb18cd1f620c4db3e880efa6a5999eff53b12415c) tool. We have\nseen the OilRig threat group using Mimikatz for credential gathering during its postexploitation activities, however, this is the first time we have observed the threat group\ndelivering Mimikatz during the delivery phase of the attack. We believe the Clayslide delivery\ndocument dropped this additional tool based on the limitations of ALMA Communicator’s C2\nchannel, which we will describe later in this report.\nThe VBScript in the .HTA file executes the SystemSyncs.exe payload and achieves\npersistent execution by creating a scheduled task. Unlike past Clayslide documents that\ncreate a scheduled task via the schtask application via the command prompt, the VBScript\nprogrammatically creates the task using the Schedule.Service object. The scheduled task\ncreated, as seen in Figure 1, shows that the payload will be executed every two minutes with\nthe command line argument \"Lock\".\n\n_Figure 1 Scheduled task created by Clayslide to execute the ALMA Communicator payload_\n\nALMA Communicator Trojan\n\nThe ALMA Communicator Trojan is a backdoor Trojan that uses DNS tunneling exclusively to\nreceive commands from the adversary and to exfiltrate data. This Trojan specifically reads in\na configuration from the cfg file that was initially created by the Clayslide delivery document.\nALMA does not have an internal configuration, so the Trojan does not function without the\ncfg file created by the delivery document.\n\nAfter reading in its configuration, the Trojan creates two folders for staging, named Download\nand Upload. ALMA uses the Download folder to save batch files provided by the C2 server,\nwhich it will eventually run. ALMA uses the Upload folder to store the output of the executed\nbatch files, which it will eventually exfiltrate to the C2 server.\n\nALMA Communicator uses DNS tunneling as its C2 communication channel using a specific\nprotocol that uses specially crafted subdomains to transmit data to the C2 server and specific\nIPv4 addresses to transmit data from the C2 to the Trojan. The transmission of information\nfrom the Trojan to the C2 server occurs through DNS requests to resolve specially crafted\nsubdomains on the configured C2 domain.\n\n\n-----\n\nTo build these specially crafted subdomains, the Trojan generates a random four-digit\nnumber and concatenates a hardcoded string of ID. The Trojan then appends a unique\nidentifier for the compromised system to this string. To generate this unique identifier, the\nTrojan starts by obtaining the system’s ProductId from the registry, specifically at\nSOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\ProductId. If it cannot find this registry\nkey, it will use the hardcoded value 00000-00000-00000-00000. It then obtains the username\nand concatenates an underscore followed by the product id string. The Trojan takes the MD5\nhash of this string and uses it as the basis for the unique identifier for the compromised\nsystem. It then appends the hardcoded -0-2D-2D string to finish the construction of the\nsubdomain used to beacon the C2 server. Figure 2 shows the structure of the domains that\nALMA communicator will send to the C2 server to receive data.\n\n_Figure 2 Domain used by ALMA communicator to receive data from the C2 server_\n\nTo provide a better explanation of the unique identifier generated by ALMA communication,\nlet’s consider a test system with the username and product id create the string\nAdministrator_00000-00000-00000-00000, which results in an MD5 hash of\n35ead98470edf86a1c5a1c5fb2f14e02. The Trojan will generate the unique identifier string\n3d7f11b4 by taking the first, fifth, ninth, thirteenth, seventeenth, twenty first, twenty fifth and\ntwenty ninth characters from the MD5 hash and concatenating them together, as seen in\nFigure 3.\n\n_Figure 3 How ALMA Communicator generates the unique identifier for the compromised_\n_system_\n\n\n-----\n\nThe C2 server will reply to the beacon DNS requests with IPv4 addresses within A records.\nThe Trojan will parse these requests for two specific IP addresses, one to mark the\nbeginning and one to mark the end of the transmission of data from the C2 to the Trojan. The\ntwo specific IP addresses to mark the start and end of the data are:\nStart - 36.37.94.33 ($%^!)\nEnd - 33.33.94.94 (!!^^)\nThe C2 will respond to DNS queries between these two responses with IP addresses that\nthe Trojan will treat as binary data. During our analysis, we observed the following data being\nsent from the C2 server to our analysis system, with $%^! and !!^^ representing the start and\nstop markers for the data:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n$%^!_DnsInit.bat@echo off & chcp 65001\\r\\necho\n%userdomain%\\\\%username% 2>&1 & echo %computername% 2>&1 & echo\n________________________________Task__________________________________\n& schtasks /query /FO List /TN \"Google_{50726F6A656374414C4D41-48747470}\" /V | findstr /b /n /c:\"Repeat: Every:\" 2>&1\n& schtasks /query /FO List /TN \"Micro_{50726F6A656374414C4D41-446E73-2}\" /V | findstr /b /n /c:\"Repeat: Every:\" 2>&1 & echo\n______________________________________________________________________\n!!^^\n\n\nBased on the data sent back from the C2, the Trojan will create a file named _DnsInit.bat\nwith commands seen in the data. The Trojan stores the batch file in the Download folder. The\nTrojan will then enumerate this folder and create a cmd.exe process with the path to the\nbatch script as a command line argument. The Trojan will add to the command line argument\nthe string \" > \" followed by the batch script's filename with the .txt.Prc file extension to write\nthe output of the command to a text file in the Upload folder. Before running the process, the\nfollowing string to the end command line argument to delete the batch script upon execution:\n\\r\\nDEL /f /q \\\"%~0\\\"|exit\nThe Trojan will then attempt to send the newly created file in the Upload folder that contains\nthe result of running the command. The DNS requests used to send this data has four fields\nthat are split up using a hyphen, which are:\n\n1. Random four-digit number followed by static \"ID\" string and the 10 character unique\n\nsystem identifier\n2. Number of DNS queries needed to send entire data stream\n3. Maximum of 20 characters for 10 hexadecimal bytes of data to transmit\n4. String of characters for hexadecimal bytes for filename transmitted\n\nTo better visualize the structure of a DNS query used to send data, the following is shows the\ndomain name that the Trojan will build to send data to its C2 server:\n\n[random 4 digits]ID[unique identifier]-[number of DNS queries needed]-[string of hexadecimal\nbytes for sent data]-[string of hexadecimal bytes for filename being sent].prosalar[.]com\nFor example, figure 4 is the first DNS query issued after our testing system ran the\n\n\n-----\n\n_DnsInit.bat script provided by the C2 server mentioned above. As you can see, each DNS\nrequest can only send 10 bytes of data at a time, requiring 29 outbound requests to transmit\nthe 289 bytes of output that was generated by the batch script.\n\n_Figure 4 Subdomain that ALMA Communicator attempts to resolve to transmit data to its C2_\n_server_\n\nAs you can surmise, ALMA Communicator’s C2 channel is rather limited when it comes to\ndata transfer. If an actor wished to use ALMA communicator to exfiltrate large files, it would\nresult in a very large number of outbound DNS requests, as each outbound request can only\nsend 10 bytes at a time. Even more limiting is the data transmission from the C2 server to\nthe Trojan, which can only send 4 bytes per DNS request, as each IPv4 address is treated as\ndata. We believe this is the reason why the Clayslide delivery document saved the Mimikatz\ntool to the system instead of having the actor download the tool to the system after a\nsuccessful compromise. Based on the 4-byte per DNS request limitation, the ALMA\nCommunicator would generate 189,568 DNS requests (not including the start and stop\nrequests) to transmit the 758,272 byte Mimikatz tool to the system, which may be detected\nby security systems or personnel.\n\nConclusion\nThe OilRig threat group continues to use their Clayslide delivery document in their attack\ncampaigns. The current variant of Clayslide also suggests that this group continues to\ndevelop these delivery documents with new installation techniques to evade detection. This\nthreat group also continues to add new payloads to their toolset as well, with ALMA\nCommunicator being the most recent addition. Lastly, it appears that OilRig still prefers using\nDNS tunneling for its C2 channel of choice, as ALMA Communicator, Helminth and\nISMAgent all use this technique for C2 communications.\nPalo Alto Networks customers are protected by the following:\n\nWildFire identifies ClaySlide delivery documents and ALMA Communicator samples as\nmalicious\nTraps blocks the ALMA Communicator Trojan via Local Analysis and blocks the\nClayslide delivery document based on “Suspicious macro detected”\n\nIndicators of Compromise\nf37b1bbf5a07759f10e0298b861b354cee13f325bc76fbddfaacd1ea7505e111 (Clayslide)\n\n\n-----\n\n2fc7810a316863a5a5076bf3078ac6fad246bc8773a5fb835e0993609e5bb62e (ALMA\nCommunicator)\n2d6f06d8ee0da16d2335f26eb18cd1f620c4db3e880efa6a5999eff53b12415c (Mimikatz)\nprosalar[.]com\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-11-08 - OilRig Deploys “ALMA Communicator” – DNS Tunneling Trojan.pdf"
    ],
    "report_names": [
        "2017-11-08 - OilRig Deploys “ALMA Communicator” – DNS Tunneling Trojan.pdf"
    ],
    "threat_actors": [
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535578,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1653698067,
    "ts_modification_date": 1653698067,
    "files": {
        "pdf": "https://archive.orkl.eu/f66c59ca3da1be1203ab5dd0257e9de40e5a7d9e.pdf",
        "text": "https://archive.orkl.eu/f66c59ca3da1be1203ab5dd0257e9de40e5a7d9e.txt",
        "img": "https://archive.orkl.eu/f66c59ca3da1be1203ab5dd0257e9de40e5a7d9e.jpg"
    }
}