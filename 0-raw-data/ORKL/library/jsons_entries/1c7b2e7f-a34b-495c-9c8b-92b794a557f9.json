{
    "id": "1c7b2e7f-a34b-495c-9c8b-92b794a557f9",
    "created_at": "2023-01-12T15:09:23.942202Z",
    "updated_at": "2025-03-27T02:09:30.473569Z",
    "deleted_at": null,
    "sha1_hash": "b4a8bc0a0a75b10a62d633bb8093dd0ed2d708d5",
    "title": "2022-04-27 - Detecting Ransomware’s Stealthy Boot Configuration Edits",
    "authors": "",
    "file_creation_date": "2022-05-28T19:26:52Z",
    "file_modification_date": "2022-05-28T19:26:52Z",
    "file_size": 710630,
    "plain_text": "# Detecting Ransomware’s Stealthy Boot Configuration Edits\n\n**[binarydefense.com/detecting-ransomwares-stealthy-boot-configuration-edits/](https://www.binarydefense.com/detecting-ransomwares-stealthy-boot-configuration-edits/)**\n\nApril 27, 2022\n\n[Written By: Binary Defense Threat Researcher @shade_vx](https://twitter.com/shade_vx)\n\nThis blog post focuses on threat hunting methods and detections for a commonly observed\ntechnique used by Ransomware-as-a-Service (RaaS) operators. Such threat actors have\noften been observed altering boot loader configurations using the built-in Windows tool\nbcdedit.exe (Boot Configuration Data Edit) in order to:\n\nModify Boot Status Policies\nDisable Recovery Mode\nEnable Safe Mode\n\nThe hypothesis that we are using to develop these hunting queries is that threat actors (such\nas Snatch and REvil) don’t necessarily have to use bcdedit to modify boot loader\nconfigurations but could implement code that directly modifies the Windows registry keys that\ndetermine those configurations. Last year, the researcher am0nsec released proof of\nconcept code demonstrating how to do exactly this on Windows 10 systems. We wanted to\nbe sure that we were able to not only detect such activity, but also on Windows 7, 8.1, and 11\nsystems where the relevant registry key is stored under a different Globally Unique Identifier\n(GUID).\n\n\n-----\n\nOur research is building upon prior work by the Specter Ops researcher Michael Barclay,\n[who published an in-depth blog about hunting for such activity on Windows 10. The](https://posts.specterops.io/capability-abstraction-case-study-detecting-malicious-boot-configuration-modifications-1852e2098a65)\nbcdedit.exe commands that attackers use to modify boot configuration are below. Please\nnote that other utilities such as the Windows System Configuration Utility (msconfig.exe) can\nalso be used to modify the boot configuration data. However, alternatives will not be covered\nin this paper as they are not command line applications and thus cannot be used out of user\ninterface access.\n\n**Boot Status Policy**\n\nThe normal way to edit the boot status policy is to use bcdedit with these command line\narguments:\n\nbcdedit.exe /set {default} bootstatuspolicy ignoreallfailures\n\nThis will modify the “boot status policy” settings and force the system to boot normally, rather\nthan into the Windows Recovery Environment (Windows RE), if there is a failed shutdown,\nfailed boot, or other error during the startup process. Threat actors disable this in order to\nprevent system administrators from accessing the System Image Recovery feature in the\nWindows RE.\n\n**Recovery Mode**\n\nThe usual method for disabling recovery mode with bcdedit is like this:\n\nbcdedit.exe /set {default} recoveryenabled no\n\nThis command disables the Windows RE entirely. Changing the boot status policy with the\nprevious command will stop the boot loader from loading the recovery environment when\nthere are startup errors, but this setting will prevent system administrators from loading it\nmanually.\n\n**Safeboot**\n\nTo change the Safeboot options, bcdedit is used with these command line arguments:\n\nbcdedit.exe /set {default} safeboot minimal\n\nThis command changes the configuration which determines whether the system will boot into\nSafe Mode the next time it is restarted. The reason that this is being modified is not to\nprevent recovery so much as prevent detection, as not all Endpoint Detection and Response\n(EDR) solutions and Anti-Virus (AV) software will be running in Safe Mode. For example,\nWindows Defender does not run in Safe Mode. Therefore, any actions conducted by a threat\nactor (e.g., encryption of files) will not be monitored and consequently will most likely not be\nprevented.\n\n\n-----\n\nPrior research into these techniques mentioned that the registry keys storing these boot\nloader configuration items were Windows version specific, and only detailed detections that\nare valid for Windows 10. The way that we went about determining what those registry keys\nwere for other Windows versions was to simply set up VMs running Windows 7, 8.1, and 11\nrespectively, and to run the three aforementioned bcdedit.exe commands while doing a\ncapture with the Windows SysInternals tool Procmon. The logs generated by this tool are\nnotoriously noisy, but it was easy to filter down to the relevant logs by adding two filters, one\nexcluding any process not called bcdedit.exe, and the other excluding any operation that was\nnot RegSetValue.\n\nThe following queries were tested across multiple enterprise environments with zero false\npositives in a 60-day time frame. Modifications of these settings are rare enough that all of\nthese queries are suitable as detections surfaced to a SOC.\n\n## Detections\n\n Carbon Black\n\n**Windows 7:**\n\nregmod_name:(*BCD00000000\\Objects\\{8c07be1f-21bb-11e8-9c5dd181d62e5fbf}\\Elements\\250000e0* OR *BCD00000000\\Objects\\{8c07be1f-21bb-11e89c5d-d181d62e5fbf}\\Elements\\16000009* OR *BCD00000000\\Objects\\{8c07be1f-21bb11e8-9c5d-d181d62e5fbf}\\Elements\\25000080*)\n\n**Windows 8.1:**\n\nregmod_name:(*BCD00000000\\Objects\\{303a1187-f04f-11e7-ae97d7affdbdc5e9}\\Elements\\250000e0* OR *BCD00000000\\Objects\\{303a1187-f04f-11e7-ae97d7affdbdc5e9}\\Elements\\16000009* OR *BCD00000000\\Objects\\{303a1187-f04f-11e7-ae97d7affdbdc5e9}\\Elements\\25000080*)\n\n**Windows 10:**\n\nregmod_name:(*BCD00000000\\\\Objects\\\\\\{9f83643f\\-4a91\\–11e9\\–9501\\b252ac81e352\\}\\\\Elements\\\\250000E0* OR *BCD00000000\\\\Objects\\\\\\{9f83643f\\-4a91\\–\n11e9\\–9501\\-b252ac81e352\\}\\\\Elements\\\\250000E0* OR *BCD00000000\\\\Objects\\\\\\\n{9f83643f\\-4a91\\–11e9\\–9501\\-b252ac81e352\\}\\\\Elements\\\\16000009*)\n\n**Windows 11:**\n\nregmod_name:(*BCD00000000\\Objects\\{ea075dc0-83af-11ec-999482f1525d1096}\\Elements\\250000e0* OR *BCD00000000\\Objects\\{ea075dc0-83af-11ec9994-82f1525d1096}\\Elements\\16000009* OR *BCD00000000\\Objects\\{ea075dc0-83af\n\n-----\n\n11ec-9994-82f1525d1096}\\Elements\\25000080 )\n\n## CrowdStrike\n\n**Windows 7:**\n\n(event_simpleName=AsepValueUpdate OR event_simpleName=SuspiciousRegAsepUpdate\nOR event_simpleName=RegistryOperationDetectInfo) AND\n(RegObjectName=”*BCD00000000\\Objects\\{8c07be1f-21bb-11e8-9c5dd181d62e5fbf}\\Elements\\250000e0*” OR RegObjectName=”*BCD00000000\\Objects\\\n{8c07be1f-21bb-11e8-9c5d-d181d62e5fbf}\\Elements\\16000009*” OR\nRegObjectName=”*BCD00000000\\Objects\\{8c07be1f-21bb-11e8-9c5dd181d62e5fbf}\\Elements\\25000080*”)\n\n**Windows 8.1:**\n\nevent_simpleName=AsepValueUpdate OR event_simpleName=SuspiciousRegAsepUpdate\nOR event_simpleName=RegistryOperationDetectInfo) AND\n(RegObjectName=”*BCD00000000\\Objects\\{303a1187-f04f-11e7-ae97d7affdbdc5e9}\\Elements\\250000e0*” OR RegObjectName=”*BCD00000000\\Objects\\\n{303a1187-f04f-11e7-ae97-d7affdbdc5e9}\\Elements\\16000009*” OR\nRegObjectName=”*BCD00000000\\Objects\\{303a1187-f04f-11e7-ae97d7affdbdc5e9}\\Elements\\25000080*”)\n\n**Windows 10:**\n\nevent_simpleName=AsepValueUpdate OR event_simpleName=SuspiciousRegAsepUpdate\nOR event_simpleName=RegistryOperationDetectInfo) AND\n(RegObjectName=”*BCD00000000\\\\Objects\\\\{9f83643f-4a91–11e9–9501b252ac81e352}\\\\Elements\\\\25000080*” OR RegObjectName=”*BCD00000000\\\\Objects\\\\\n{9f83643f-4a91–11e9–9501-b252ac81e352}\\\\Elements\\\\250000E0*” OR\nRegObjectName=”*BCD00000000\\\\Objects\\\\{9f83643f-4a91–11e9–9501b252ac81e352}\\\\Elements\\\\16000009*”)\n\n**Windows 11:**\n\nevent_simpleName=AsepValueUpdate OR event_simpleName=SuspiciousRegAsepUpdate\nOR event_simpleName=RegistryOperationDetectInfo) AND\n(RegObjectName=”*BCD00000000\\Objects\\{ea075dc0-83af-11ec-999482f1525d1096}\\Elements\\250000e0*” OR RegObjectName=”*BCD00000000\\Objects\\\n{ea075dc0-83af-11ec-9994-82f1525d1096}\\Elements\\16000009*” OR\nRegObjectName=”*BCD00000000\\Objects\\{ea075dc0-83af-11ec-999482f1525d1096}\\Elements\\25000080*”)\n\n\n-----\n\n## Microsoft Sentinel and Defender for Endpoint\n\n**Windows 7:**\n\nDeviceRegistryEvents\n| where TimeGenerated > ago(90d)\nwhere ActionType == “RegistryValueSet”\n| where RegistryKey has_any (@”BCD00000000\\Objects\\{8c07be1f-21bb-11e8-9c5dd181d62e5fbf}\\Elements\\250000e0″, @”BCD00000000\\Objects\\{8c07be1f-21bb-11e8-9c5dd181d62e5fbf}\\Elements\\16000009″, @”BCD00000000\\Objects\\{8c07be1f-21bb-11e8-9c5dd181d62e5fbf}\\Elements\\25000080″)\n\n**Windows 8.1:**\n\nDeviceRegistryEvents\n| where TimeGenerated > ago(90d)\n| where ActionType == “RegistryValueSet”\n| where RegistryKey has_any (@”BCD00000000\\Objects\\{303a1187-f04f-11e7-ae97d7affdbdc5e9}\\Elements\\250000e0″, @”BCD00000000\\Objects\\{303a1187-f04f-11e7-ae97d7affdbdc5e9}\\Elements\\16000009″, @”BCD00000000\\Objects\\{303a1187-f04f-11e7-ae97d7affdbdc5e9}\\Elements\\25000080″)\n\n**Windows 10:**\n\nDeviceRegistryEvents\n| where TimeGenerated > ago(90d)\n| where ActionType == “RegistryValueSet”\n| where RegistryKey has_any (@”BCD00000000\\Objects\\{9f83643f-4a91–11e9–9501b252ac81e352}\\Elements\\25000080″, @”BCD00000000\\Objects\\{9f83643f-4a91–11e9–\n9501-b252ac81e352}\\Elements\\250000E0″, @”BCD00000000\\Objects\\{9f83643f-4a91–\n11e9–9501-b252ac81e352}\\Elements\\16000009″)\n\n**Windows 11:**\n\nDeviceRegistryEvents\n| where TimeGenerated > ago(90d)\n| where ActionType == “RegistryValueSet”\n| where RegistryKey has_any (@”BCD00000000\\Objects\\{ea075dc0-83af-11ec-999482f1525d1096}\\Elements\\250000e0″, @”BCD00000000\\Objects\\{ea075dc0-83af-11ec-999482f1525d1096}\\Elements\\16000009″, @”BCD00000000\\Objects\\{ea075dc0-83af-11ec-999482f1525d1096}\\Elements\\25000080″)\n\n## SentinelOne\n\n**Windows 7:**\n\n\n-----\n\nEventType = Registry Value Modified and RegistryKeyPath In Contains Anycase\n(“BCD00000000\\Objects\\{8c07be1f-21bb-11e8-9c5d-d181d62e5fbf}\\Elements\\250000e0”,\n“BCD00000000\\Objects\\{8c07be1f-21bb-11e8-9c5d-d181d62e5fbf}\\Elements\\16000009”,\n“BCD00000000\\Objects\\{8c07be1f-21bb-11e8-9c5d-d181d62e5fbf}\\Elements\\25000080”)\n\n**Windows 8.1: {303a1187-f04f-11e7-ae97-d7affdbdc5e9}**\n\nEventType = “Registry Value Modified” and RegistryKeyPath In Contains Anycase\n(“BCD00000000\\Objects\\{303a1187-f04f-11e7-ae97-d7affdbdc5e9}\\Elements\\250000e0”,\n“BCD00000000\\Objects\\{303a1187-f04f-11e7-ae97-d7affdbdc5e9}\\Elements\\16000009”,\n“BCD00000000\\Objects\\{303a1187-f04f-11e7-ae97-d7affdbdc5e9}\\Elements\\25000080”)\n\n**Windows 10:**\n\nEventType = “Registry Value Modified” and RegistryKeyPath In Contains Anycase\n(“BCD00000000\\Objects\\{9f83643f-4a91–11e9–9501-b252ac81e352}\\Elements\\25000080”,\n“BCD00000000\\Objects\\{9f83643f-4a91–11e9–9501-b252ac81e352}\\Elements\\250000E0”,\n“BCD00000000\\Objects\\{9f83643f-4a91–11e9–9501-b252ac81e352}\\Elements\\16000009”)\n\n**Windows 11: {ea075dc0-83af-11ec-9994-82f1525d1096}**\n\nEventType = “Registry Value Modified” and RegistryKeyPath In Contains Anycase\n(“BCD00000000\\Objects\\{ea075dc0-83af-11ec-9994-82f1525d1096}\\Elements\\250000e0”,\n“BCD00000000\\Objects\\{ea075dc0-83af-11ec-9994-82f1525d1096}\\Elements\\16000009”,\n“BCD00000000\\Objects\\{ea075dc0-83af-11ec-9994-82f1525d1096}\\Elements\\25000080”)\n\n## References\n\nhttps://posts.specterops.io/capability-abstraction-case-study-detecting-malicious-bootconfiguration-modifications-1852e2098a65\n\nhttps://github.com/vxunderground/VXUGPapers/tree/6b5741ca4b1df25dcd453581954b92e083c054b8/Win64.VirTool.BCDEdit\n\n[https://github.com/am0nsec/vx](https://github.com/am0nsec/vx)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-27 - Detecting Ransomware’s Stealthy Boot Configuration Edits.pdf"
    ],
    "report_names": [
        "2022-04-27 - Detecting Ransomware’s Stealthy Boot Configuration Edits.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536163,
    "ts_updated_at": 1743041370,
    "ts_creation_date": 1653766012,
    "ts_modification_date": 1653766012,
    "files": {
        "pdf": "https://archive.orkl.eu/b4a8bc0a0a75b10a62d633bb8093dd0ed2d708d5.pdf",
        "text": "https://archive.orkl.eu/b4a8bc0a0a75b10a62d633bb8093dd0ed2d708d5.txt",
        "img": "https://archive.orkl.eu/b4a8bc0a0a75b10a62d633bb8093dd0ed2d708d5.jpg"
    }
}