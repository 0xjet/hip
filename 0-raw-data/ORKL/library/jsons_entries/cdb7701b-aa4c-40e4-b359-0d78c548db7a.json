{
    "id": "cdb7701b-aa4c-40e4-b359-0d78c548db7a",
    "created_at": "2023-01-12T15:08:36.357902Z",
    "updated_at": "2025-03-27T02:05:50.931636Z",
    "deleted_at": null,
    "sha1_hash": "e368f0efd8f51a09b8dcac19a37386114d036f7a",
    "title": "2021-06-01 - Dissecting a RAT. Analysis of the Command-line AndroRAT.",
    "authors": "",
    "file_creation_date": "2022-05-27T21:07:28Z",
    "file_modification_date": "2022-05-27T21:07:28Z",
    "file_size": 1745390,
    "plain_text": "# Dissecting a RAT. Analysis of the Command-line AndroRAT.\n\n**[stratosphereips.org/blog/2021/5/6/dissecting-a-rat-analysis-of-the-command-line-androrat](https://www.stratosphereips.org/blog/2021/5/6/dissecting-a-rat-analysis-of-the-command-line-androrat)**\n\nKamila Babayeva June 1, 2021\n\n**_This blog post was authored by Kamila Babayeva (@_kamifai_) and Sebastian Garcia_**\n**_(@eldracote)._**\n\n_The RAT analysis research is part of the Civilsphere Project_\n_[(https://www.civilsphereproject.org/), which aims to protect the civil society at risk by](https://www.civilsphereproject.org/)_\n_understanding how the attacks work and how we can stop them. Check the webpage for_\n_more information._\n\nThis is the seventh blog of a series analyzing the network traffic of Android RATs from our\n[Android Mischief Dataset [more information here], a dataset of network traffic from Android](https://www.stratosphereips.org/android-mischief-dataset)\nphones infected with Remote Access Trojans (RAT). In this blog post we provide the\n[analysis of the network traffic of the RAT08-command-line-AndroRAT [download here]. The](https://mcfp.felk.cvut.cz/publicDatasets/Android-Mischief-Dataset/AndroidMischiefDataset_v2/RAT08_cli_AndroRAT.zip)\n[previous blogs analyzed Android Tester RAT,](https://www.stratosphereips.org/blog/2020/12/14/ngwqj0h060yv40w1afp51fg7wo9ijy-pzlhk) [DroidJak RAT,](https://www.stratosphereips.org/blog/2021/1/22/analysis-of-droidjack-v44-rat-network-traffic) [AndroRAT RAT,](https://www.stratosphereips.org/blog/2021/3/29/dissecting-a-rat-analysis-of-the-androrat) [SpyMax RAT,](https://www.stratosphereips.org/blog/2021/2/26/dissecting-a-rat-analysis-of-the-spymax)\n[AhMyth RAT and HawkShaw RAT.](https://www.stratosphereips.org/blog/2021/5/6/dissecting-a-rat-analysis-of-the-ahmyth)\n\n## Execution Setup\n\nThe goal of each of our RAT experiments is to use the software ourselves and to execute\nevery possible action while capturing all the traffic and storing all the logs. So these RAT\ncaptures are functional and were used in real attacks.\n\nDespite its name “Command line AndroRAT”, this RAT has no clear relationship with the\nRAT called “AndroRAT”. The Command line AndroRAT is a software package that contains\nthe controller software and builder software to build an APK. It was executed on a Windows\n7 guest virtual machine with Ubuntu 20.04 as a host. The Android Application Package\n(APK) built by the RAT builder was installed in the Android virtual emulator called\nGenymotion using Android version 8.\n\nWhile performing different actions on the RAT controller (e.g. upload a file, get GPS\nlocation, monitor files, etc.), we captured the network traffic on the Android virtual emulator.\n\nThe details about the network traffic capture are:\n\nThe controller IP address: 147.32.83.157\n\nThe phone IP address: 147.32.83.245\n\n\n-----\n\nUTC time of the infection in the capture: 2020-12-05 11:46:43 UTС\n\n## RAT Details\n\nThis Command-line AndroRAT software was the first one in our dataset that did not have an\ngraphical user interface. Instead, it uses a command line interface to control the target’s\ndevice. Figure 1 shows the welcome message in the command line while waiting for the\ninfected device to connect.This Command-line AndroRAT software was the first one in our\ndataset that did not have an graphical user interface. Instead, it uses a command line\ninterface to control the target’s device. Figure 1 shows the welcome message in the\ncommand line while waiting for the infected device to connect.\n\n**_Figure 1. Welcome message in the Command-line AndroRAT interface. The message is_**\nshown until the infected phone is connected.\n\n## Infection and Initial Communication\n\nThis research started with the execution of the RAT in our virtual phone. Once the APK was\ninstalled in the phone, it directly tried to establish a TCP connection with the command and\ncontrol (C&C) server. The phone used the IP address and the port of the controller that we\nspecified in the APK (Figure 2). In particular, the IP address of the controller was\n147.32.83.157 and the port was 1337/TCP. The controller IP address 147.32.83.157 is the\nIP address of a Windows 7 virtual machine in our lab computer, meaning that the IP\naddress is not connected to any indicator of compromise (IoC).\n\n\n-----\n\n**_Figure 2. The controller IP and port specified during compilation can be seen in the code_**\ninside the APK installed in the victim’s device. The phone uses the controller IP\n147.32.83.157 and the port 1337 to establish a TCP connection.\n\nThe phone initializes a 3-way TCP handshake to establish the connection between the\nphone and the C&C. Figure 3 shows these initial packets. The connection was successfully\nestablished without any reconnections, but with a retransmission packet. The lack of\nreconnections can be because both controller and victim were in the same network.\n\n**_Figure 3. A 3-way TCP handshake between the controller (147.32.83.157) and the phone_**\n(147.32.83.245). The connection was initialized by the phone and there is one\nretransmission packet.\n\nAfter the phone got infected and the connection between the phone and the controller was\nestablished, the phone sent a welcome message together with the phone model “Samsung2”, as shown in Figure 4. The code from the malicious APK that sends the welcome\nmessage to the controller is shown in Figure 5.\n\n0000  48 65 6c 6c 6f 20 74 68 65 72 65 2c 20 77 65 6c  Hello there, wel\n\n0010  63 6f 6d 65 20 74 6f 20 72 65 76 65 72 73 65 20  come to reverse\n\n0020  73 68 65 6c 6c 20 6f 66 20 53 61 6d 73 75 6e 67  shell of Samsung\n\n0030  2d 32 0a                     -2.\n\n**_Figure 4. The welcome message with the model of the phone sent from the infected phone_**\nto the controller after a successful infection. Notice the English language\n\n**_Figure 5. Code from the malicious APK that sends the welcome message to the C&C._**\n\nAfter sending a welcome message, the phone waits for the C&C command. While waiting\nfor the C&C command, there was no heartbeat performed between the phone and the\ncontroller.\n\n\n-----\n\nThe phone then received its first executed C&C command device info that aims to retrieve\nthe details about the phone’s hardware, system, settings, etc. Figure 6 shows the data field\nof the packet with the command ‘device info’. The C&C command is sent in the plain text,\nwithout any structure.\n\n0000  64 65 76 69 63 65 49 6e 66 6f 0a         deviceInfo.\n\n**_Figure 6. The data field of the packet with the C&C command ‘device info’ that aims to_**\nretrieve the details about the infected device. The data is in the plain text without any\nstructure.\n\nThe phone answers to the command ‘device info’ with device details composed of\nManufacturer, Version/Release, Product, Model, Brand, Device and Host. The data field of\nthis packet is displayed in Figure 7. It is important to notice that the answer from the phone\ndoes not follow any structure, the data is sent in the plain text.\n```\n-------------------------------------------Manufacturer: unknown\nVersion/Release: 8.1.0\nProduct: vbox86p\nModel: Samsung-2\nBrand: Android\nDevice: vbox86p\nHost: 49cfa9ee5067\n-------------------------------------------\n```\n**_Figure 7. The data field of the packet with the phone’s answer to the C&C command_**\n‘device info’. The data is sent in the plain without any structure. It may seem that the\ncontroller is separating these values by searching for the words “Manufacturer:”,\n“Version/Release”, etc.\n\nThe request and answer to the C&C command ‘device info’ are shown in the command line\ninterface of the C&C, as shown in Figure 8.\n\n\n-----\n\n**_Figure 8. The command line interface of the C&C with the executed command ‘Device Info’_**\nand the phone’s reply. The characters “[36m” and similar seem to be related to a bug in the\nassignment of colors to the interface.\n\n## Example of C&C Commands\n\nThrough the whole communication, the controller sends the C&C commands inplaintext, the\nphone answers these commands in plaintext as well. When the controller or the victim\nsends a big amount of data, e.g. photo, video, audio, text files., it defines the end of data by\nadding a string ‘END123\\n’ at the end.\n\nAs an example we can analyze the exchange of packets between the C&C and the victim\nduring the C&C command ‘getSMS’. This command aims to retrieve the messages sent and\nreceived by the targeted device. The data of the packet with the ’getSMS’ command is\ndisplayed in Figure 9. As before, the data is sent in plaintext and does not follow any\nstructure. As a reply to this command, the phone sends two packets: the first packet\nconfirms the execution of the C&C command (Figure 10), the second packet sends the\nactual data (Figure 11).\n```\n0000  67 65 74 53 4d 53 20 69 6e 62 6f 78 0a    getSMS inbox.\n\n```\n**_Figure 9. The data field of the packet sent by the controller with C&C command ‘getSMS’_**\nthat aims to retrieve the message inbox inside the targeted phone.\n```\n0000  72 65 61 64 53 4d 53 20 69 6e 62 6f 78 0a   readSMS inbox.\n\n```\n**_Figure 10. The data field of the packet sent by the victim phone with the text ‘readSMS’ as_**\na confirmation answer to the command “getSMS”.\n\n\n-----\n\n```\n#0\nNumber : 333333\nPerson : null\nDate : Sun Jun 13 13:18:52 EST 52877\nBody : Hey! i am thwoing a party at my house next week! wanna join?\n#1\nNumber : 928934\nPerson : null\nDate : Sun Jun 13 04:14:21 EST 52877\nBody : Hello! How are you and your child? Are you back from vacation already?\nEND123\n\n```\n**_Figure 11. The data field of the phone reply to the command ‘getSMS’. The messages are_**\nsent in the plaintext. In order to define the end of the data, it puts the ‘END123\\n’ string at\nthe end of the data. The fields seem to be separated, again, by searching for keywords\nsuch as “Number”, “Person”, etc.\n\nThere are a total of 18 commands that the RAT software can perform on the targeted\ndevice. The complete list is shown in Figure 12.\n```\ndeviceInfo          --> returns basic info of the device\ncamList            --> returns cameraID \ntakepic [cameraID]      --> Takes picture from camera\nstartVideo [cameraID]     --> starts recording the video\nstopVideo          --> stop recording the video and return the video\nfile\nstartAudio         --> starts recording the audio\nstopAudio          --> stop recording the audio\ngetSMS [inbox|sent]      --> returns inbox sms or sent sms in a file \ngetCallLogs          --> returns call logs in a file\nshell           --> starts a interactive shell of the device\nvibrate [number_of_times]  --> vibrate the device number of time\ngetLocation         --> return the current location of the device\ngetIP             --> returns the ip of the device\ngetSimDetails        --> returns the details of all sim of the device\nclear            --> clears the screen\ngetClipData          --> return the current saved text from the\nclipboard\ngetMACAddress         --> returns the mac address of the device\nexit             --> exit the interpreter\n\n```\n**_Figure 12. The complete list of 18 commands that can be used from the controller. It is a_**\nprint of the help function in the C&C interface.\n\n## End of communication\n\n\n-----\n\nAfter the C&C sends the command exit (Figure 13), the connection between the phone\nand the controller should have been closed. However, in our experiment, after the\nconnection was closed (Figure 14), the phone attempts to reconnect to the C&C several\ntimes with an interval of 3 seconds (Figure 15), showing a buggy implementation of the exit\nfunction in the APK, or showing that the controller may no longer be active but giving the\nvictims the opportunity to reconnect if necessary.\n```\n0000  65 78 69 74 0a exit.\n\n```\n**_Figure 13. The C&C command ‘exit’ that aims to close the connection between the phone_**\nand the controller.\n\n**_Figure 14. Successful 4-way handshake TCP termination between the controller and the_**\ntargeted phone after the C&C command ‘exit’.\n\n**_Figure 15. After the phone received the ‘exit’ C&C command, it still tries to reconnect with_**\nthe controller. However, the controller already closed the socket after the ‘exit’ C&C\ncommand.\n\nThe complete communication between the phone and the controller in the experiment\nhappened in one flow. According to Wireshark-Statistics-Conversations (Figure 16), the\nconnection between the phone and the controller is considered to be the longest\n(approximately 16 minutes) in the traffic. However, based on previous RATs analysis in the\nAndroid Mischief dataset, connections to services such as Facebook, Instagram, etc. might\nbe longer than the 16 minutes of this malicious connection. Due to the victim reconnecting\nto the C&C several times after the connection was closed, Wireshark displays a number of\nflows to the C&C with a really short duration (Figure 17).\n\n\n-----\n\n**_Figure 16. TOP connections from Wireshark-Statistics-Conversations sorted by the flow_**\nduration. The connection between the victim and C&C is the longest.\n\n**_FIgure 17. Wireshark displays reconnections to the C&C as the flows of really short_**\nduration.\n\n## Conclusion\n\nIn this blog we have analyzed the network traffic from a phone infected with a unique\ncommand line AndroRAT. Due to the RAT simple communication protocol, we were able to\ndecode its connection. The command line androRAT does not seem to be complex in its\ncommunication, however, it is quite sophisticated in its work. It is not interrupting throughout\nthe whole communication compared to other RATs in the dataset.\n\nTo summarize, the details found in the network traffic of this RAT are:\n\nThe C&C sends the packets in plaintext without any structure.\n\nThe infected phone sends the packets in plaintext without any structure.\n\nThe communication between the C&C and the phone is done in one flow of long\nduration (approximately 16 minutes).\n\nEven though the connection between the controller and the phone was closed, the\nphone tries to reconnect every 3 seconds.\n\nThere is no heartbeat in the traffic between the phone and the controller.\n\n## Biographies\n\n\n-----\n\nKAMILA BABAYEVA\n\nSebastian Garcia is a malware researcher and security teacher with experience in applied\nmachine learning on network traffic. He founded the Stratosphere Lab, aiming to do\nimpactful security research to help others using machine learning. He believes that free\nsoftware and machine learning tools can help better protect users from abuse of our digital\nrights. He researches on machine learning for security, honeypots, malware traffic\ndetection, social networks security detection, distributed scanning (dnmap), keystroke\ndynamics, fake news, Bluetooth analysis, privacy protection, intruder detection, and\nmicrophone detection with SDR (Salamandra). He co-founded the MatesLab hackspace in\nArgentina and co-founded the Independent Fund for Women in Tech. @eldracote.\nhttps://www.researchgate.net/profile/Sebastian_Garcia6\n\nKamila Babayeva is a 20 years old and third-year bachelor student in the Computer\nScience and Electrical Engineering program at the Czech Technical University in Prague.\nShe is a researcher in the Civilsphere project, a project dedicated to protecting civil\norganizations and individuals from targeted attacks. Her research focuses on helping\npeople and protecting their digital rights by developing free software based on machine\nlearning. Initially, she worked as a junior Malware Reverser. Currently, Kamila leads the\ndevelopment of the Stratosphere Linux Intrusion Prevent System (Slips), which is used to\nprotect the civil society in the Civilsphere lab.\n\n\n-----\n\nSEBASTIAN GARCIA\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-01 - Dissecting a RAT. Analysis of the Command-line AndroRAT..pdf"
    ],
    "report_names": [
        "2021-06-01 - Dissecting a RAT. Analysis of the Command-line AndroRAT..pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536116,
    "ts_updated_at": 1743041150,
    "ts_creation_date": 1653685648,
    "ts_modification_date": 1653685648,
    "files": {
        "pdf": "https://archive.orkl.eu/e368f0efd8f51a09b8dcac19a37386114d036f7a.pdf",
        "text": "https://archive.orkl.eu/e368f0efd8f51a09b8dcac19a37386114d036f7a.txt",
        "img": "https://archive.orkl.eu/e368f0efd8f51a09b8dcac19a37386114d036f7a.jpg"
    }
}