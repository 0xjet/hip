{
    "id": "21a967d8-2dc9-4f6a-94ff-dda31ee813cc",
    "created_at": "2023-01-12T15:07:19.600069Z",
    "updated_at": "2025-03-27T02:15:37.950416Z",
    "deleted_at": null,
    "sha1_hash": "f0b43060edd8a02bfd5b103ffa426b56e0764974",
    "title": "2021-11-12 - A multi-stage PowerShell based attack targets Kazakhstan",
    "authors": "",
    "file_creation_date": "2022-05-28T03:32:53Z",
    "file_modification_date": "2022-05-28T03:32:53Z",
    "file_size": 1766073,
    "plain_text": "# A multi-stage PowerShell based attack targets Kazakhstan\n\n**[blog.malwarebytes.com/threat-intelligence/2021/11/a-multi-stage-powershell-based-attack-targets-kazakhstan/](https://blog.malwarebytes.com/threat-intelligence/2021/11/a-multi-stage-powershell-based-attack-targets-kazakhstan/)**\n\nThreat Intelligence Team November 12, 2021\n\n_This blog post was authored by Hossein Jazi._\n\nOn November 10 we identified a multi-stage PowerShell attack using a document lure\nimpersonating the Kazakh Ministry of Health Care, leading us to believe it\ntargets Kazakhstan.\n\nA threat actor under the user name of DangerSklif (perhaps in reference to Moscow’s\nemergency hospital) created a GitHub account and uploaded the first part of the attack on\nNovember 8.\n\nIn this blog we will review the different steps the attacker took to fly under the radar with the\nintent on deploying Cobalt Strike onto its victims.\n\n## Overview\n\nThe attack started by distributing a RAR archive named “Уведомление.rar” (“Notice.rar”).\nThe archive file contains a lnk file with the same name pretending to be a PDF document\nfrom “Ministry of Health Care, Republic of Kazakhstan”. Upon opening the lnk file, a PDF file\n\n\n-----\n\nwill be shown to confuse victims while in the background multiple stages of this attack are\nbeing executed. The decoy document is an amendment for a Covid 19 policy that has been\nissued by the Chef State Sanitary of the Republic of Kazakhstan.\n\n\n-----\n\n-----\n\n## Attack process\n\nThe following figure shows the overall process of this attack. The attack started by executing\nthe lnk file that calls PowerShell to perform several techniques such as privilege escalation\nand persistency through an autorun registry key. We will provide the detailed analysis in the\nnext section.\n\nFigure 2: Attack Process\nAll stages of this attack have been hosted in one Github repository named GoogleUpdate.\nThis repository was created on November 8th by a user\nnamed DangerSklif. The DangerSklif user was created on GitHub on November 1st.\n\nFigure 3: GitHub repository\n\n## Analysis\n\n\n-----\n\nThe embedded lnk file is obfuscated and after de-obfuscation we can see that it\nused cmd.exe to call PowerShell to download and execute the first stage of the attack from\nthe Github account (lib7.ps1).\n\nFigure 4: lnk file\nThe lib7.ps1 downloads the decoy PDF file from the same Github account and stores it in\nthe Downloads directory. In the next step it opens the decoy PDF to confuse the user while it\nperforms the rest of process in the background, which includes getting the OS version and\ndownloading the next stage based on the OS version.\n\nFigure 5: lib7.ps1\nIf the OS version is 7 or 8, it downloads and executes lib30.ps1 and if the OS version is 10 it\ndownloads and executes lib207.ps1. The reason the actor is checking the OS version is\nbecause it is trying to execute the right privilege escalation method. These techniques\n\n\n-----\n\n[previously used by TA505 in their campaign to drop SrvHelper.](https://www.ptsecurity.com/ww-en/analytics/pt-esc-threat-intelligence/operation-ta505-part2/)\n\nUsing the SilentCleanup task in the Task Scheduler to bypass UAC in Windows 10:\nAttacker used Lib207.ps1 to bypass UAC in Windows 10. The PowerShell commands\nused to perform the bypass are XOR encrypted using 0x58 key.\n\nFigure 6: Lib207\nAfter decrypting the commands, we can see the process of UAC bypass which includes\ncreating a SilentCleanup task in the Task Scheduler that calls PowerShell to execute the\ncreated vbs file with higher privilege.\n\nFigure 7: Lib207 after decryption\n\nUsing the sysprep.exe system utility and DLL side-loading to bypass UAC in Windows\n7 and 8: Lib30.ps1 is used to execute this bypass. Simliar to lib207.ps1 this PowerShell\nscript is also XOR encrypted but using different key (0x02).\n\nFigure 8: Lib30\nFigure 9 shows PowerShell commands after decryption. The process starts by creating a\nbatch file (cmd.bat) in the “Windows/Temp” directory. In the next step, a cab archive file is\ncreated containing a DLL (CRYPTBASE.dll for Windows 7 or shcore.dll for Windows 8. Then\n\n\n-----\n\nthis cab file is extracted into the C:\\Windows\\System32\\Sysprep directory using wusa.exe.\n\nAt the end, the sysprep.exe system utility launches which side loads the CRYPTBASE.dll for\nWindows 7 or shcore.dll for Windows 8. This DLL executes the created cmd.bat file which\nleads to executing it with a high privilege.\n\nFigure 9: Lib30 after decryption\nAfter bypassing UAC, in all OS versions the next stage payload is downloaded and executed\n(lib106.ps1).\n\nThis stage performs the following actions:\n\nCreates a vbs file (cu.vbs) in ProgramFiles directory and makes this multi-stage attack\npersistence by adding this vbs file\nto HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run registry key.\nMakes vbs file hidden using “Attrib.exe +h” command.\nDownloads and executes the final stage (updater.ps1) using PowerShell.\n\n\n-----\n\nFigure 10: lib106.ps1\nThe final stage (updater.ps1) is executing Cobalt Strike in PowerShell context. In fact this\nPowerShell script is PowerShell variant of Cobalt Strike.\n\nFigure 11: updater.ps1\nThe Cobalt Strike ShellCode is base64 encoded and XOR encrypted using 35 key. After\ndecoding and decrypting the ShellCode it allocates it into memory using VirtualAlloc and\nfinally execute it by calling Invoke function.\n\n\n-----\n\nFigure 12: Updater.ps1 after de-obfuscation\n\n## Kazakhstan in the news\n\nKazakhstan has been in the news recently for taking over China in the cryptomining industry,\n[depleting its own electric resources. The energy-rich country is a very important ally for](https://www.reuters.com/business/energy/crypto-boom-strains-kazakhstans-coal-powered-energy-grid-2021-11-10/)\nRussia in particular with lucrative joint oil and gas ventures.\n\nOther than their GitHub profile, we do not have much information on the threat actor or their\nexact intention with this attack. However, monitoring and espionage are a likely motive.\n\nMalwarebytes users were protected thanks to the Anti-Exploit layer of our product.\n\n\n-----\n\n## IOCs\n\nУведомление.pdf.lnk:\n\n574a33ee07e434042bdd1f59fc89120cb7147a1e20b1b3d39465cd6949ba7d99\n\nУведомление.rar:\n\nd0f3c838bb6805c8a360e7b1f28724e73e7504f52147bbbb06551f91f0df3edb\n\nUpdater.ps1:\n\n08f096134ac92655220d9ad7137e35d3b3c559359c238e034ec7b4f33a246d61\n\nlib106.ps1:\n\n81631df5d27761384a99c1f85760ea7fe47acc49ef81003707bb8c4cbf6af4be\n\nlib2.ps1:\n\n912434caec48694b4c53a7f83db5f0b44b84ea79be57d460d83f21181ef1acbb\n\nlib207.ps1:\n\n893f6cac7bc1a1c3ee72d5f3e6994e902b5af044f401082146a486a0057697e5\n\nlib30.ps1:\n\n11d6b0b76d057ac9db775d9a1bb14da2ed9acef325060d0452627d9391be4ea2\n\nlib63.ps1:\n\n8f974d8d0741fd1ec9496857d7aabbe0d3ba4d2e52cc311c76c28396edae9eb9\n\nlib64.ps1:\n\n301194613cbc11430d67acf7702fd15ec40ee0f9be348cf8a33915809b65bc5e\n\n\n-----\n\nlib7.ps1:\n026fcb13e9a4ea6c1eab73c892118a96731b868a1269f348a14a5087713dd9e5\nlib706.ps1:\n36aba78e63825ab47c1421f71ca02422c86c774ba525959f42b8e565a808a7d4\nC2:\n188.165.148.241\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-12 - A multi-stage PowerShell based attack targets Kazakhstan.pdf"
    ],
    "report_names": [
        "2021-11-12 - A multi-stage PowerShell based attack targets Kazakhstan.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "99cb4e5b-8071-4f9e-aa1d-45bfbb6197e3",
            "created_at": "2023-01-06T13:46:38.860754Z",
            "updated_at": "2025-03-27T02:00:02.937438Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "SectorJ04 Group",
                "Dudear",
                "G0092",
                "ATK103",
                "Hive0065",
                "Spandex Tempest",
                "GRACEFUL SPIDER",
                "GOLD TAHOE",
                "CHIMBORAZO",
                "SectorJ04"
            ],
            "source_name": "MISPGALAXY:TA505",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5e6b31a6-80e3-4e7d-8b0a-d94897ce9b59",
            "created_at": "2024-06-19T02:03:08.128175Z",
            "updated_at": "2025-03-27T02:05:17.400394Z",
            "deleted_at": null,
            "main_name": "GOLD TAHOE",
            "aliases": [
                "SectorJ04 ",
                "Spandex Tempest ",
                "TA505 ",
                "FIN11 "
            ],
            "source_name": "Secureworks:GOLD TAHOE",
            "tools": [
                " Cobalt Strike",
                " FlawedAmmy",
                " Get2",
                " GraceWire",
                " Malichus",
                " SDBbot",
                " ServHelper",
                " TrueBot",
                "Clop"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75d4d6a9-b5d1-4087-a7a0-e4a9587c45f4",
            "created_at": "2022-10-25T15:50:23.5188Z",
            "updated_at": "2025-03-27T02:00:55.489882Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "TA505",
                "Hive0065",
                "Spandex Tempest",
                "CHIMBORAZO"
            ],
            "source_name": "MITRE:TA505",
            "tools": [
                "AdFind",
                "Azorult",
                "FlawedAmmyy",
                "Mimikatz",
                "Dridex",
                "TrickBot",
                "Get2",
                "FlawedGrace",
                "Cobalt Strike",
                "ServHelper",
                "Amadey",
                "SDBbot",
                "PowerSploit"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e447d393-c259-46e2-9932-19be2ba67149",
            "created_at": "2022-10-25T16:07:24.28282Z",
            "updated_at": "2025-03-27T02:02:10.159466Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "ATK 103",
                "Chimborazo",
                "Gold Evergreen",
                "Gold Tahoe",
                "Graceful Spider",
                "Hive0065",
                "Operation Tovar",
                "Operation Trident Breach",
                "SectorJ04",
                "Spandex Tempest",
                "TA505",
                "TEMP.Warlock"
            ],
            "source_name": "ETDA:TA505",
            "tools": [
                "Amadey",
                "AmmyyRAT",
                "AndroMut",
                "Azer",
                "Bart",
                "Bugat v5",
                "CryptFile2",
                "CryptoLocker",
                "CryptoMix",
                "CryptoShield",
                "Dridex",
                "Dudear",
                "EmailStealer",
                "FRIENDSPEAK",
                "Fake Globe",
                "Fareit",
                "FlawedAmmyy",
                "FlawedGrace",
                "FlowerPippi",
                "GOZ",
                "GameOver Zeus",
                "GazGolder",
                "Gelup",
                "Get2",
                "GetandGo",
                "GlobeImposter",
                "Gorhax",
                "GraceWire",
                "Gussdoor",
                "Jaff",
                "Kasidet",
                "Kegotip",
                "Kneber",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Locky",
                "MINEBRIDGE",
                "MINEBRIDGE RAT",
                "MirrorBlast",
                "Neutrino Bot",
                "Neutrino Exploit Kit",
                "P2P Zeus",
                "Peer-to-Peer Zeus",
                "Philadelphia",
                "Philadephia Ransom",
                "Pony Loader",
                "Rakhni",
                "ReflectiveGnome",
                "Remote Manipulator System",
                "RockLoader",
                "RuRAT",
                "SDBbot",
                "ServHelper",
                "Shifu",
                "Siplog",
                "TeslaGun",
                "TiniMet",
                "TinyMet",
                "Trojan.Zbot",
                "Wsnpoem",
                "Zbot",
                "Zeta",
                "ZeuS",
                "Zeus"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536039,
    "ts_updated_at": 1743041737,
    "ts_creation_date": 1653708773,
    "ts_modification_date": 1653708773,
    "files": {
        "pdf": "https://archive.orkl.eu/f0b43060edd8a02bfd5b103ffa426b56e0764974.pdf",
        "text": "https://archive.orkl.eu/f0b43060edd8a02bfd5b103ffa426b56e0764974.txt",
        "img": "https://archive.orkl.eu/f0b43060edd8a02bfd5b103ffa426b56e0764974.jpg"
    }
}