{
    "id": "4e4c1caf-dda8-4ae6-9028-fdca77484827",
    "created_at": "2023-01-12T15:02:08.889181Z",
    "updated_at": "2025-03-27T02:06:13.013245Z",
    "deleted_at": null,
    "sha1_hash": "ae2cdf96ad12b2ee5cc6ba4ee1d32f1829752348",
    "title": "2022-01-10 - Detecting Malware Script Loaders using Remcos- Threat Research Release December 2021",
    "authors": "",
    "file_creation_date": "2022-05-28T23:19:58Z",
    "file_modification_date": "2022-05-28T23:19:58Z",
    "file_size": 2725613,
    "plain_text": "# Detecting Malware Script Loaders using Remcos: Threat Research Release December 2021\n\n**splunk.com/en_us/blog/security/detecting-malware-script-loaders-using-remcos-threat-research-release-december-**\n2021.html\n\nJanuary 10, 2022\n\nSECURITY\n\nBy [Splunk Threat Research Team January 10,](https://www.splunk.com/en_us/blog/author/secmrkt-research.html)\n\n2022\nNowadays, malware used to have several stages before it fully compromised the targeted host\nor machine. The very well-known initial stager is the “phishing email” that contains a malicious\nmacro code or malicious URL link that will download either the actual loader or the next stager\nto download the actual payload.\n\nThis particular sample makes the detection and analysis of the adversary behavior more\nchallenging. The most prevalent loaders seen in the wild are window scripting languages,\nJScript (.js), and VBScript (.vbs). These scripts are easy to obfuscate and encrypt in order to\nbypass detection and preventative controls, therefore many adversaries use this methodology.\nIn this blog, Splunk Threat Research (STRT) will discuss a Remcos loader that utilizes\n[DynamicWrapperX (dynwrapx.dll) to execute shellcode and inject Remcos RAT into the target](http://dynwrapx.script-coding.com/dwx/pages/dynwrapx.php?lang=en)\nprocess. Ultimately STRT covers what [Splunk Security Content detections find behaviors and](https://research.splunk.com/)\nTTPs that apply to the DynamicWrapperX Loader.\n\n\n-----\n\n-----\n\n## The Initial Downloader\n\nThis Remcos sample loader starts with a simple VBScript that attempts to download the second\nVBScript from [paste.ee. The script on](https://paste.ee/) [paste.ee is the main loader of Remcos. Below is the](https://paste.ee/)\nscreenshot of the initial downloader script. STRT has witnessed the script stay online up to a\nfew weeks between major campaign changes. Paste.ee offers multiple options to automatically\n[take down code between hours up to a year. The full VBScript loader may be found here.](https://gist.github.com/MHaggis/316400bd7c9f1ed6940ed04ea16556be)\n\n\n-----\n\n## The VBScript Main Remcos Loader\n\n### Detection Evasion\n\nSTRT found the script loader interesting in how it tries to evade inspection by preventative\ncontrols by embedding a large amount of normal script code and comments at the beginning\nand end of the loader. For example, the screenshot below shows its code in lines 120-150\n[pertains to Microsoft “pubprn.vbs”, a script designed to publish printers within active directory](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc753116(v=ws.11))\ndomain services. Skimming over the code quickly gives it away that shellcode is embedded\ninside.\n\n### Preparation of Payload\n\nNow that the loader has downloaded the next stage from paste.ee, this VBScript will prepare\nseveral payloads and eventually load the actual Remcos malicious software. First, it will decode\nthe actual Remcos RAT, then extract the dynwrapx.dll (used to load the shellcode), and finally\nthe shellcode. It will also initialize the file path of (c:\\windows\\winhlp32.exe) which is the target\nprocess to inject Remcos RAT.\n\n\n-----\n\nBelow is a screenshot of each payload decoded:\n\n\n-----\n\n### VBScript Execution in x64 Bit\n\nThis script also has a function to check what OS architecture type the infected host has using\n[WMI (Windows Management Instrumentation - T1047) if it is an x64 host, it will run the VBScript](https://attack.mitre.org/techniques/T1047/)\nusing the following command format “wscript /b /e:vbscript <vbscript filename>” like what is\n\n\n-----\n\n[shown in the screenshot below. Also you can find the raw attack data sysmon.log for this](https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1059.005/vbs_wscript/sysmon.log)\ntechnique.\n\n### The Shellcode - Process Injection\n\nThe decoded shellcode uses pre-computed API hashes to dynamically resolve its API import in\norder to inject the Remcos malware into a targeted process on the host. The screenshot below\nshows the last WriteProcessMemory API and the ResumeThread API calls get used to write\nand subsequently execute the Remcos RAT in the target process where it injects its code.\n\n\n-----\n\n### DynamicWrapperX - ShellCode Execution\n\nTo execute the shellcode for Remcos via process injection, it first decodes and drops\n“dynwrapx.dll” in the %temp% folder and loads/installs it using Regsvr32 install silent parameter\n(“regsvr32 /I /S”). This DLL will give the VBScript access to the “DynamicWrapperX'' Object to\nload 2 more windows DLL modules named user32.dll and kernel32.dll to allocate memory and\nexecute the shellcode.\n\nUsing VirtualAlloc API call, it will allocate a region of memory for the Remcos malware and\nshellcode. This memory address will be passed as an argument in CallWindowProcW API to\nload the shellcode to inject Remcos RAT to the target process, which is WinHlp32.exe. The\nscreenshot below shows the code of this technique.\n\n\n-----\n\n### Where is Remcos Going?\n\nUsing VirusTotal behavior to analyze this sample further STRT searched for a pattern of\nbehavior that spawned winhlp32.exe and used regsvr32.exe to load dynwrapx.dll. STRT crafted\nthis VirusTotal behavior query:\n```\nbehavior:\"\\\"%windir%\\\\System32\\\\regsvr32.exe\\\" /I /S \\\"%TEMP%\\\\dynwrapx.dll\\\"\"\nbehavior:\"\\\"%windir%\\\\winhlp32.exe\\\"\"\n\n```\nThis uncovered an interesting pattern that began 9/12/2021 from Argentina which matched the\nsame behavior as our original sample. Each upload contained a different section of the final\nsample (reviewed above). STRT speculates the adversary was testing their code against\nantivirus engines. After the first few “testing” uploads occurred, it was followed up with actual\nactive campaigns with complete Remcos loaders.\n\n\n-----\n\nThe pattern of behavior we queried for looks like this in VTI \n\n-----\n\n-----\n\n[Following using winhlp32.exe, STRT noticed it shifted to using installutil.exe. With installutil.exe,](https://app.any.run/tasks/df0baf9f-8baf-4c32-a452-16562ecb19be/)\nthe pattern is very similar. The biggest difference STRT noticed was, during the VBScript\nexecution, unlike winhlp32.exe, installutil.exe did not load dynwrapx.dll.\n\nVirusTotal behavior query:\n```\nbehavior:\"\\\"%windir%\\\\System32\\\\regsvr32.exe\\\" /I /S \\\"%TEMP%\\\\dynwrapx.dll\\\"\"\nbehavior:\"\\\\installutil.exe\\\"\"\n\n```\n\n-----\n\nSTRT, generated a few additional queries that helped us to holistically look for other samples,\nthese provided insight into further behaviors, but also the visibility into how much interaction\nand changes go into each campaign.\n```\nbehaviour_processes:\"\\\"%windir%\\\\SYSWOW64\\\\WSCRIPT.EXE\\\" //b //e:vbscript\n\\\"%SAMPLEPATH%\\\"\"\ncontent:\n{5365742044796e577261704f626a203d204372656174654f626a656374282244796e616d6963577261707065\n\n### VT Correlation Graph of Remcos:\n\n```\n[The following VT Correlation Graph shows us the affected countries by this Remcos campaign,](https://www.virustotal.com/graph/embed/g8e2e40d1a7b9401facdae7330d44f4178b95305dd74b4b70b44933389ba06cf2)\nthe number of C2 servers connections it made to download other malware or its components.\nEven some interesting infection chain vectors like dropping .lnk file and downloading\ncomponents from its C2.\n\n\n-----\n\n## Remcos Analytic Story\n\n[The update on the analytic story introduced 21 new and 5 modified detections. In this section,](https://research.splunk.com/stories/remcos/)\nwe describe some of these analytics.\n\n### Suspicious Process DNS Query Known Abuse Web Services\n\nDetects a suspicious process making a DNS query via known abuse text paste web services, or\nVoIP, instant messaging, and digital distribution platform to use to download external files. This\ntechnique is abused by adversaries, malware actors, and red teams to download a malicious\n\n\n-----\n\nfile on the target host. This is a good TTP indicator for possible initial access techniques. A user\nwill experience false positives if the following instant messaging is allowed or common\napplications like telegram, discord are allowed in the corporate network.\n```\n`sysmon` EventCode=22 QueryName IN (\"*pastebin*\", \"*discord*\", \"*telegram*\", \"*t.me*\")\nprocess_name IN (\"cmd.exe\", \"*powershell*\", \"pwsh.exe\", \"wscript.exe\", \"cscript.exe\")\n| stats count min(_time) as firstTime max(_time) as lastTime by Image QueryName\nQueryStatus process_name QueryResults Computer\n| `security_content_ctime(firstTime)` \n| `security_content_ctime(lastTime)`\n\n### Loading Of Dynwrapx Module\n\n```\nDynamicWrapperX is an ActiveX component that can be used in a VBScript to call Windows\nAPI functions, but it requires the dynwrapx.dll to be installed and registered. With that,\nregistering or loading dynwrapx.dll to a host is highly suspicious. In most instances when it is\nmaliciously used the best way to triage is to review parallel processes and pivot on the\nprocess_guid. Review the registry for any suspicious modifications meant to load dynwrapx.dll.\nIdentify any suspicious module loads of dynwrapx.dll. This detection will return and identify the\nprocesses that invoke vbs/wscript/cscript.\n\n\n-----\n\n```\n`sysmon` EventCode=7 (ImageLoaded = \"*\\\\dynwrapx.dll\" OR OriginalFileName =\n\"dynwrapx.dll\" OR Product = \"DynamicWrapperX\") \n| stats count min(_time) as firstTime max(_time) as lastTime \nby Image ImageLoaded OriginalFileName Product process_name Computer EventCode Signed\nProcessId \n| `security_content_ctime(firstTime)`\n| `security_content_ctime(lastTime)`\n\n### System Info Gathering Using Dxdiag Application\n\n```\nDetects a suspicious dxdiag.exe process command-line execution. Dxdiag is used to collect the\nsystem info of the target host. This technique was seen used by Remcos RATS, various actors,\nand other malware to collect information as part of the recon or collection phase of an attack.\nThis behavior should be rarely seen in a corporate network, but this command line can be used\nby a network administrator to audit host machine specifications. Thus in some rare cases, this\ndetection will contain false positives in its results. To triage further, analyze what commands\n[were passed after it pipes out the result to a file for further processing. Examples of anyrun](https://any.run/report/923483a20bfa8c7734ff5cd5f1d2ebb4a029efe6af2365cd4730a0955e038ccd/8ed5b7fd-498c-4468-9e84-e3a62517492e)\nremcos analysis that shows its behavior before and after this technique was executed.\n```\n| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)\n as lastTime from datamodel=Endpoint.Processes where `process_dxdiag` AND\nProcesses process\n\n```\n\n-----\n\n```\n    /t  by Processes.dest Processes.user Processes.parent_process_name\nProcesses.parent_process\n Processes.process_name Processes.process Processes.process_id\nProcesses.parent_process_id\n | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` |\n`security_content_ctime(lastTime)`\n\n### Possible Browser Pass View Parameter\n\n```\nDetects a suspicious process that contains command-line parameters related to a web browser\ncredential dumper. This technique is used by Remcos RAT malware where it uses the Nirsoft\nwebbrowserpassview.exe application to dump web browser credentials. Remcos use the\n\"/stext\" command line to dump the credential in text format. This Hunting query is a good\nindicator of hosts suffering from possible Remcos RAT infection. Since the hunting query is\nbased on the parameter command and the possible path where it will save the text credential\ninformation, It may catch normal tools that are using the same command and behavior.\n```\n| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)\n as lastTime from datamodel=Endpoint.Processes where Processes.process IN (\"*/stext*\",\n\"*/shtml *\", \"*/LoadPasswordsIE*\", \"*/LoadPasswordsFirefox*\",\n\"*/LoadPasswordsChrome*\",\"*/LoadPasswordsOpera*\", \"*/LoadPasswordsSafari*\",\n\"*/UseOperaPasswordFile*\", \"*/OperaPasswordFile*\",\"*/stab*\", \"*/scomma*\", \"*/stabular*\",\n\"*/shtml*\", \"*/sverhtml*\", \"*/sxml*\", \"*/skeepass*\") AND Processes.process IN\n(\"*\\\\temp\\\\*\", \"*\\\\users\\\\public\\\\*\", \"*\\\\programdata\\\\*\")\nby Processes.dest Processes.user Processes.parent_process_name Processes.parent_process\nProcesses.process_name Processes.process Processes.process_id\nProcesses.parent_process_id Processes.original_file_name\n| `drop_dm_object_name(Processes)`\n| `security_content_ctime(firstTime)`\n\n```\n\n-----\n\n```\n| security_content_ctime(lastTime) \n\n```\n\n**Name** **Technique**\n**ID**\n\n\n**Tactic** **Description**\n\n\nSuspicious\nProcess DNS\n[Query Known](https://research.splunk.com/endpoint/suspicious_process_dns_query_known_abuse_web_services/)\nAbuse Web\nServices\n\nLoading Of\nDynwrapx Module\n\nWscript Or Cscript\n[Suspicious Child](https://research.splunk.com/endpoint/wscript_or_cscript_suspicious_child_process/)\nProcess\n\nWinhlp32\n[Spawning a](https://research.splunk.com/endpoint/winhlp32_spawning_a_process/)\nProcess\n\n\n[T1059.005](https://attack.mitre.org/techniques/T1059/005/) Execution Detects a suspicious process having a\nDNS query on known abuse text paste\nweb services, or VoIP, instant\nmessaging, and digital distribution\nplatform to download some files.\n\n\n[T1055.001](https://attack.mitre.org/techniques/T1055/001/) Defense\nEvasion,\nPrivilege\nEscalation\n\n[T1055](https://attack.mitre.org/techniques/T1055/) Defense\nEvasion,\nPrivilege\nEscalation\n\n[T1055](https://attack.mitre.org/techniques/T1055/) Defense\nEvasion,\nPrivilege\nEscalation\n\n\nDetects loading of dynwrapx.dll in a\nprocess\n\nDetects suspicious child process of\nwscript and cscript process.\n\nDetects winhlp32 spawning another\nprocess\n\n\n-----\n\nProcess Writing\nDynamicWrapperX\n\nVbscript Execution\nUsing Wscript App\n\nJscript Execution\nUsing Cscript App\n\nRegsvr32 Silent\n[and Install Param](https://research.splunk.com/endpoint/regsvr32_silent_and_install_param_dll_loading/)\nDll Loading\n\nRegsvr32 with\n[Known Silent](https://research.splunk.com/endpoint/regsvr32_with_known_silent_switch_cmdline/)\nSwitch Cmdline\n\nSystem Info\n[Gathering Using](https://research.splunk.com/endpoint/system_info_gathering_using_dxdiag_application/)\nDxdiag Application\n\nPossible Browser\n[Pass View](https://research.splunk.com/endpoint/possible_browser_pass_view_parameter/)\nParameter\n\n## Hashes\n\n\n[T1559.001](https://attack.mitre.org/techniques/T1559/001/) Execution Detects dropping of dynwrapx.dll to use\nDynamicWrapperX which is an ActiveX\ncomponent that can be used in a script\n\nto call Windows API functions.\n\n[T1059.005](https://attack.mitre.org/techniques/T1059/005/) Execution Detects execution of vbscript using\nwscript.exe.\n\n[T1059.007](https://attack.mitre.org/techniques/T1059/007/) Execution Detects execution of jscript using\ncscript.exe.\n\n\n[T1218.010](https://attack.mitre.org/techniques/T1218/010/) Defense\nEvasion\n\n[T1218.010](https://attack.mitre.org/techniques/T1218/010/) Defense\nEvasion\n\n\nDetects install silent parameter of\nregsvr32.exe\n\nDetects silent switch of regsvr32.exe.\n\n\n[T1592](https://attack.mitre.org/techniques/T1592/) Reconnaissance Detects dxdiag process for possible\nsystem info collection parameter /t\n\n\n[T1555.003](https://attack.mitre.org/techniques/T1555/003/) Credential\nAccess\n\n\nDetects possible web browser\ncredential dumper process\n\n\n**Filename** **Hashes - sha256**\n\ninvoice.vbs cb77b93150cb0f7fe65ce8a7e2a5781e727419451355a7736db84109fa215a89\n\nremcos.dll ff169ae934b92a2dfe78f4793c60256d4f36992a0e1218ed6b6d59b3809ed210\n\ndynwrapx.dll 4ef3a6703abc6b2b8e2cac3031c1e5b86fe8b377fde92737349ee52bd2604379\n\nshellcode c344723295279aaaf2a4220a77d74db903985264cf3adfba5015f9f31f0dddec\n\n\n-----\n\nStage1.vbs\n(download\nstage2 in\npastebin)\n\n\ncb77b93150cb0f7fe65ce8a7e2a5781e727419451355a7736db84109fa215a89\n\n\n## Automating with SOAR Playbooks\n\nThe following community Splunk SOAR playbooks mentioned below can be used in conjunction\nwith some of the previously described analytics:\n\n**Name** **Description**\n\n\nMalware\n[Hunt And](https://research.splunk.com/playbooks/malware_hunt_and_contain/)\nContain\n\nEmail\nNotification\nfor\nMalware\n\nBlock\nIndicators\n\n\nThis playbook hunts for malware across managed endpoints, disables affected\nusers, shuts down their devices, and blocks files by their hash from further\nexecution via Carbon Black.\n\nThis playbook tries to determine if a file is malware and whether or not the file is\npresent on any managed machines. VirusTotal \"file reputation\" and PANW\nWildFire \"detonate file\" are used to determine if a file is malware, and\nCarbonBlack Response \"hunt file\" is used to search managed machines for the\nfile. The results of these investigations are summarized in an email to the\nincident response team.\n\nThis playbook retrieves IP addresses, domains, and file hashes, blocks them on\nvarious services, and adds them to specific blocklists as custom lists\n\n\n## Why Should You Care?\n\nThis blog shows how vbscript and jscript are leveraged by all sorts of offensive actors including\n[penetration testing](https://twitter.com/strandjs/status/1363942354374127620) [consultants,](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/active-directory-password-spraying) [cybercrime](https://us-cert.cisa.gov/ncas/alerts/TA18-086A) [actors, and](https://www.cyber.gov.au/acsc/view-all-content/advisories/2019-130-password-spray-attacks-detection-and-mitigation-strategies) [cyber](https://us-cert.cisa.gov/ncas/alerts/aa21-116a) [espionage](https://us-cert.cisa.gov/ncas/alerts/TA18-086A) [actors in process](https://us-cert.cisa.gov/ncas/alerts/AA20126A)\ninjection and shellcode execution. Unlike binary malware loaders, malware loader scripts are\nvery flexible in terms of updates, encryption and also code obfuscation to bypass detections.\n[According to unit42’s 2020 article, Script base malware is one of the new attacker trends and it](https://unit42.paloaltonetworks.com/script-based-malware/)\nkeeps on evolving and improving as part of the malware tooling ecosystem. Cyber Defenders\nneed to design and deploy effective monitoring capabilities that allow them to detect and\nrespond to: suspicious script execution, process injection and suspicious use of text paste web\nservice in their corporate or server networks.\n\n### Learn More\n\n\n-----\n\n[You can find the latest content about security analytic stories on research.splunk.com. For a full](https://research.splunk.com/)\nlist of security content, check out the [release notes on](https://docs.splunk.com/Documentation/ESSOC/3.21.0/RN/Enhancements) [Splunk Docs.](https://docs.splunk.com/Documentation/ESSOC)\n\n[3.32.0](https://github.com/splunk/security_content/releases/tag/v3.32.0)\n\n### Feedback\n\nAny feedback or requests? Feel free to put in an issue on Github and we’ll follow up.\nAlternatively, join us on the [Slack channel #security-research. Follow these instructions If you](https://splunk-usergroups.slack.com/)\nneed an invitation to our Splunk user groups on Slack.\n\n### Contributors\n\nWe would like to thank the following for their contributions to this post.\n\nTeoderick Contreras\nMichael Haag\nJose Hernandez\n[Lou Stella](http://10.10.0.46/mailto:lstella@splunk.com)\n\nPosted by\n\n**[Splunk Threat Research Team](https://www.splunk.com/en_us/blog/author/secmrkt-research.html)**\n\nThe Splunk Threat Research Team is an active part of a customer’s overall defense strategy by\nenhancing Splunk security offerings with verified research and security content such as use\ncases, detection searches, and playbooks. We help security teams around the globe strengthen\noperations by providing tactical guidance and insights to detect, investigate and respond\nagainst the latest threats. The Splunk Threat Research Team focuses on understanding how\nthreats actors and vulnerabilities work and the team replicates attacks which are stored as\n\n\n-----\n\n[datasets in the Attack Data repository.](https://github.com/splunk/attack_data/)\n\nOur goal is to provide security teams with research they can leverage in their day to day\noperations and to become the industry standard for SIEM detections. We are a team of\nindustry-recognized experts who are encouraged to improve the security industry by sharing\nour work with the community via conference talks, open-sourcing projects, and writing white\npapers or blogs. You will also find us presenting our research at conferences such as Defcon,\nBlackhat, RSA, and many more.\n\n[Read more Splunk Security Content.](https://github.com/splunk/security_content)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-10 - Detecting Malware Script Loaders using Remcos- Threat Research Release December 2021.pdf"
    ],
    "report_names": [
        "2022-01-10 - Detecting Malware Script Loaders using Remcos- Threat Research Release December 2021.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535728,
    "ts_updated_at": 1743041173,
    "ts_creation_date": 1653779998,
    "ts_modification_date": 1653779998,
    "files": {
        "pdf": "https://archive.orkl.eu/ae2cdf96ad12b2ee5cc6ba4ee1d32f1829752348.pdf",
        "text": "https://archive.orkl.eu/ae2cdf96ad12b2ee5cc6ba4ee1d32f1829752348.txt",
        "img": "https://archive.orkl.eu/ae2cdf96ad12b2ee5cc6ba4ee1d32f1829752348.jpg"
    }
}