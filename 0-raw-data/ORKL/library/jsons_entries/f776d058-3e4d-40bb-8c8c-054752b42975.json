{
    "id": "f776d058-3e4d-40bb-8c8c-054752b42975",
    "created_at": "2023-01-12T15:05:13.685391Z",
    "updated_at": "2025-03-27T02:13:43.655875Z",
    "deleted_at": null,
    "sha1_hash": "a3bf7eee22384cba4e5e0c86a29c2cfd0552759c",
    "title": "2022-02-17 - Looking over the nation-state actors’ shoulders- Even they have a difficult day sometimes",
    "authors": "",
    "file_creation_date": "2022-05-27T21:28:06Z",
    "file_modification_date": "2022-05-27T21:28:06Z",
    "file_size": 2320154,
    "plain_text": "# Looking over the nation-state actors’ shoulders: Even they have a difficult day sometimes\n\n**[trellix.com/en-gb/about/newsroom/stories/threat-labs/looking-over-the-nation-state-actors-shoulders.html](https://www.trellix.com/en-gb/about/newsroom/stories/threat-labs/looking-over-the-nation-state-actors-shoulders.html)**\n\nBy [Christiaan Beek and Marc Elias · Febraury 17, 2022](https://www.trellix.com/en-gb/about/newsroom/stories/contributors/christiaan-beek.html)\n\n**Have you ever been curious about how nation-state actors operate and what their day-to-day**\n**work looks like?**\nThis blog reveals some of these details observed based on our Advanced Threat Research team’s\nanalysis of [Operation Graphite, a multi-stage espionage campaign targeting high-ranking government](https://www.trellix.com/en-gb/about/newsroom/stories/threat-labs/prime-ministers-office-compromised.html)\nofficials overseeing national security policy and individuals in the defense industry in Western Asia.\n\n[In summary, Trellix’s Advanced Threat Research team recently exposed what appears to be a nation-](https://www.trellix.com/en-gb/about/newsroom/stories/threat-labs/prime-ministers-office-compromised.html)\nstate operator using Microsoft’s OneDrive as a Command and Control (C2) server as a first interaction\nwith its victims. When the results of the initial attack passed the test, more stages were installed ending\nwith an Empire Agent interacting with the threat-actor's Empire server. When investigating incidents,\nthe timestamps of actions, files are important indicators in the investigation. The timestamps of the\nactor’s activity were based on the forensic artifacts discovered at both victims’ sites and from the\nEmpire’s servers the actors used in the campaign. Thanks to the partnerships between the public\nsector and us a private company, we were able to exchange data and information that was beneficial\nfor the parties involved into this investigation.\n\nAs a reminder we highlight the timeline of events below:\n\n\n-----\n\n**Figure 1. Timeline of the campaign**\n\nFrom our timeline, we observed the registration of one of the C2 domains in June 2021. Later, the actor\nis uses OneDrive to drag, and sync encrypted command files with its victims. Using a OneDrive as a\nC2 server is a simple but effective defensive evasion tactic.\n\nLet us be honest, how many companies are not using it and synchronisation traffic is happening every\nsecond in the network? It is a wonderful way for an attacker to hide his C2 traffic, and it is a novel way\nof interacting fast with your victims. But what if you accidentally dragged the wrong folder to the server?\n\n## Блин!\n\nThis is exactly what happened... One of the files that was accidently synchronised, contained the setup\nprocess of the C2 server:\n\n**Figure 2. Setup script for C2 server**\n\nIn the screenshot, where we have redacted a few parts, we observe the steps and commands taken on\nthe server to install the Empire software and setup routing and the payloads.\n\nThe domain-name and URL (Uniform Resource Locator) paths, combined with the observed payload\nnames in our research match exactly.\n\nWhen the C2 was abandoned, the actors might have been in a hurry and did not clean up the disk.\nThanks to our partnership, we were able to investigate the Empire server logs that helped identify\nvictims, but, moreover, gave a sneak-peek into how the threat actors operated once they had access to\ntheir victim’s computers. We will share some of our findings and where needed we redacted for the\nsake of privacy the data.\n\n## Testing the infrastructure\n\n\n-----\n\nBefore the first victim, the actors infected a virtual machine with an Empire agent on the September\n15th in 2021 to test the connectivity to the C2 and execute a few reconnaissance commands. We will\ntake you through that day:\n\n**Figure 3.**\n\n**Attacker testing the waters**\nWe observe in this first part the attacker checking if the machine is still reachable using the Empire\nAgent and next reconnaissance commands are sent to discover the hostname, IP-address, the user\naccount logged in at the time of asking and finally confirming that the network connection with the C2\nserver is established.\n\nLater, on the 21st of September 2021, the threat actors tested the full infection chain by infecting\nanother virtual machine. The commands issued to the machine are the following:\n\n\n-----\n\n**Figure 4.**\n\n**Attacker listing network settings**\nThe attacker is verifying for any scheduled tasks that are running on the infected machine and\ncontinues to verify the settings and ability of network connectivity. To test if the computer can reach the\nInternet, a ping command towards Google’s DNS (Domain Name System) (8.8.8.8) is executed.\n\nOn the 29th of September 2021, to double check the infection chain was working they infected another\nvirtual machine. Both infection dates of the testing virtual machines match the ones we mentioned in\nthe Timeline of the operation in our previous research.\n\nIn the image below, we show the commands executed in this new testing machine:\n\n**Figure 5.**\n\n**Attacker testing persistence**\n\n\n-----\n\nFirst, the attacker checks the architecture of the machine, which in this case is 64 bits, and uploads an\nDLL (Dynamic Link Library) Empire agent corresponding to the architecture of the system. Next, it\nmoves the payload to the directory “C:\\ProgramData” and establishes persistence in the system\noverriding the CLSID (Class Identifier) “{D9144DCD-E998-4ECA-AB6A-DCD83CCBA16D}” with the\npath to Empire agent file. This technique is known as COM (Component Object Model) Hijacking and\nwas discussed in the previously report of the campaign.\n\n## Start of the campaign\n\nWe started identifying victims in the logs on the 6th of October 2021, the same day the attackers\nlaunched the attack, and the Excel documents were uploaded to Virus Total. We identified several\ndifferent infected systems all of them from the same organization.\n\nOnce the attacker got access to the victims’ machines, he uploaded the DLL Empire agent and\nexecuted the exact same commands we have seen in the previous testing machine to establish\npersistence as if he were following the APT (Advanced Persistent Threat) operators’ manual.\n\nAfter executing the commands to establish persistence, the actors started executing commands to\ngather information about the context, the machine, and the username of the victim. First, they queried\nthe current path the Empire agent is executing, they listed the directory “C:\\Program Data” to check if\nthe Empire agent was properly moved, through the systeminfo command they got the statistics and\ntechnical information of the infected machine, they obtained the current user and finally they listed all\nthe software installed.\n\n**Figure 6.**\n\n**Reconnaissance commands on victims’ machines**\n\nContinuing in the reconnaissance stage of the attack, the operators gathered more information about\nthe users in the Administrators group, the domain information about the current user, the list of shares\navailable in the machine, the current active processes executing in the machine. The adversaries\nspend quite time in the Discovery phase to gain knowledge about the system and the internal network\nto understand how they can escalate privileges and move laterally to fulfil their objective of informationgathering.\n\n\n-----\n\n**Figure 7. User**\n\n**reconnaissance commands**\nAfter the user reconnaissance and discovery phase, the adversaries elevated privileges from the\ncurrent user to SYSTEM. We do not have full visibility on how the process was completed, but we\nassess with medium confidence they used a custom tool mimicking or abusing the ThinPrint software\ninstaller. The assessment is based on that after the upload and execution of the tools, a new Empire\nagent on the same machine with SYSTEM privileges does the “check-in” task into the Empire server.\n\n**Figure 8.**\n\n**Privilege escalation commands**\nFrom this point on, the attacker(s) are using several commands to gain more information about the\nsystem, which software is installed, add a user account for persistence and dump the LSASS (Local\nSecurity Authority Subsystem Service) memory, and identifying the antivirus vendor installed. Dumping\n\n\n-----\n\nthe LSASSS, with the use of Minidump is used for getting credentials out of that dump that might assist\nin more lateral movement through the victims’ network. In the below picture, we highlight some of these\ninteresting commands:\n\n**Figure 9.**\n\n**Examples of lateral movement**\nOnce all is clear to the attacker, we observed the attacker harvesting for data and documents with\ntopics of interest. Since we identified the machine(s) used by the attacker(s), the attacker verified if the\nupload were successful and by frequent directory listings executed on the systems, the progress of the\ndownload of this information could be observed. A lot of the information the threat actor was interested\nin was related to diplomatic and political oriented content. For example, documentation around the\nEuropean Union meetings and other notes of diplomatic meetings.\n\n**Figure 10.**\n\n**Examples of lateral movement**\nAfter all the information was gathered, the actors uploaded a tool that by the command line they used\nto execute resembles to a VNC remote access software. After executing the file, they started testing\ntheir connection to other critical machines inside the victim infrastructure to check if they can reach and\n\n\n-----\n\nremotely control them.\n\n**Figure 11.**\n\n**Possible VNC tool**\nWhen the actor finished operating with the tools in the victims’ systems, he started to clean some of the\ntools used:\n\n**Figure 12. Deleting**\n\n**the files**\nWhen you are in digital forensics, your heart will start to jump up and down, since deleting files is great,\nbut if they are not overwritten, using file-carving of deleted files gives an opportunity to recover those\nfiles.\n\n## Conclusion\n\nThis blog gave an overview of the operational details inside the campaign we unveiled the past month\nwhere a Prime Minister’s Office was compromised in Western Asia by a Russian threat actor. The\nthreat actor was extremely interested in information on the current political landscape. With high\nconfidence, we observed the actor gathering information about the relationships established between\nthese victims and the European Union and other diplomatic relationships were of interest. A clear\nexample of an intelligence operation that assisted in gaining insights into the political landscape.\n\n\n-----\n\nAs we already said in the previous blog, the actors behind this campaign are very advanced as they\nspent months setting up the infrastructure, creating the lure documents with the embedded exploit, and\ntesting all the components before launching the attack. Even though the actors are very advanced,\nnonetheless they are still human, therefore they make mistakes as we have seen in this blog.\n\nFollowing the trail of breadcrumbs left by the threat actors, we gathered valuable intel on how the\noperators operate on a compromised network allowing us to observe the tactics, techniques, and\nprocedures in a complex espionage campaign.\n\n## MITRE ATT&CK\n\n**ATT&CK**\n**ID** **Tactics** **Name** **Observable**\n\n\nT1560 Collection Archive\nCollected\nData\n\nT1005 Collection Data from\nLocal\nSystem\n\nT1114.001 Collection Email\nCollection:\nLocal Email\nCollection\n\n\nT1003.001 Credential\nAccess\n\nT1003.002 Credential\nAccess\n\nT1562.001 Defense\nEvasion\n\nT1562.010 Defense\nEvasion\n\nT1070.004 Defense\nEvasion\n\n\nOS\nCredential\nDumping:\nLSASS\nMemory\n\nOS\nCredential\nDumping:\nSecurity\nAccount\nManager\n\nImpair\nDefenses:\nDisable or\nModify Tools\n\nImpair\nDefenses:\nDowngrade\nAttack\n\nIndicator\nRemoval on\nHost: File\nDeletion\n\n\nAdd-Type -Assembly\n\nSystem.IO.Compression.FileSystem\n\n[IO.Compression.ZipFile]::CreateFromDirectory([folderPath],\n\n[zipFilePath])\n\ndir c:\\users\\USERX\\desktop\n\nreg query HKEY_USERS\\S-1-5-21\n***\\software\\microsoft\\office\\16.0\\Outlook\n\nrundll32\n\nC:\\windows\\system32\\comsvcs.dll,MiniDump 788\n\nc:\\temp\\dmlsdif\\dmlsdif5.bin full\n\nreg save hklm\\system c:\\windows\\temp\\tmpsystl /y\n\nreg save hklm\\security c:\\windows\\temp\\tmpsectl /y\n\nreg save hklm\\sam c:\\windows\\temp\\tmpsmstl /y\n\ndel ThinPrint.dll\n\ndel ThinPrintInst.exe\n\n\n-----\n\nT1112 Defense\nEvasion\n\nT1078.003 Defense\nEvasion,\nInitial\nAccess,\nPersistence,\nPrivilege\nEscalation\n\n\nModify\nRegistry\n\nValid\nAccounts:\nLocal\nAccounts\n\n\nT1087.002 Discovery Account\nDiscovery:\nDomain\nAccount\n\nT1087.003 Discovery Account\nDiscovery:\nEmail\nAccount\n\nT1087.001 Discovery Account\nDiscovery:\nLocal\nAccount\n\nT1057 Discovery Process\nDiscovery\n\nT1069 Discovery Permission\nGroups\nDiscovery\n\nT1012 Discovery Query\nRegistry\n\nT1518 Discovery Software\nDiscovery\n\nT1518.001 Discovery Software\nDiscovery:\nSecurity\nSoftware\nDiscovery\n\nT1082 Discovery System\nInformation\nDiscovery\n\nT1016 Discovery System\nNetwork\nConfiguration\nDiscovery\n\n\nreg add HKCU\\Software\\Classes\\CLSID\\{D9144DCD\nE998-4ECA-AB6A-DCD83CCBA16D}\\InProcServer32\n\nnet user /add user1 XXXXX\n\ncmd /c query user net user /domain XXXX\n\nreg query HKEY_USERS\\S-1-5-21\n***\\software\\microsoft\\office\\16.0\\Outlook\\Profiles\n\n\\Outlook\n\nnet localgroup\n\nnet localgroup Administrators\n\ntasklist\n\ntasklist | findstr /i lsas\n\nnet localgroup Administrators\n\nreg query HKCU\\\\Software\\\\Classes\\\\CLSID\\\\\n\nreg query HKCU\\Software\\\n\nGet-WmiObject -Namespace root/SecurityCenter2 \nClass AntiVirusProduct | format-list\n\nsysteminfo\n\nnet statistics workstation\n\nipconfig\n\nipconfig /all\n\n\n-----\n\nT1016.001 Discovery System\nNetwork\nConfiguration\nDiscovery:\nInternet\nConnection\nDiscovery\n\nT1049 Discovery System\nNetwork\nConnections\nDiscovery\n\nT1033 Discovery System\nOwner/User\nDiscovery\n\nT1135 Discovery Network\nShare\nDiscovery\n\nT1007 Discovery System\nService\nDiscovery\n\nT1041 Exfiltration Exfiltration\nOver C2\nChannel\n\n\nT1570 Lateral\nMovement\n\n\nLateral Tool\nTransfer\n\n\nT1098 Persistence Account\nManipulation\n\nT1136.001 Persistence Create\nAccount:\nLocal\nAccount\n\nT1546.015 Persistence Event\nTriggered\nExecution:\nComponent\nObject Model\nHijacking\n\n\nping 8.8.8.8\n\nnetstat\n\nnetstat -n\n\nwhoami /all\n\ncmd /c query user\n\nnet share\n\ndownload c:\\users\\USERX\\desktop\\mail.docx\n\nnet user /add user1 XXXXX\n\nnet user /add user1 XXXXX\n\nCLSID: D9144DCD-E998-4ECA-AB6A-DCD83CCBA16D\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-17 - Looking over the nation-state actors’ shoulders- Even they have a difficult day sometimes.pdf"
    ],
    "report_names": [
        "2022-02-17 - Looking over the nation-state actors’ shoulders- Even they have a difficult day sometimes.pdf"
    ],
    "threat_actors": [
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535913,
    "ts_updated_at": 1743041623,
    "ts_creation_date": 1653686886,
    "ts_modification_date": 1653686886,
    "files": {
        "pdf": "https://archive.orkl.eu/a3bf7eee22384cba4e5e0c86a29c2cfd0552759c.pdf",
        "text": "https://archive.orkl.eu/a3bf7eee22384cba4e5e0c86a29c2cfd0552759c.txt",
        "img": "https://archive.orkl.eu/a3bf7eee22384cba4e5e0c86a29c2cfd0552759c.jpg"
    }
}