{
    "id": "c4daba8d-b835-4153-94ba-315a668f62a0",
    "created_at": "2023-01-12T15:09:53.887512Z",
    "updated_at": "2025-03-27T02:17:27.520822Z",
    "deleted_at": null,
    "sha1_hash": "9ee880fbd53f4980ec162b229692d3fb3adac1c8",
    "title": "2016-05-26 - The OilRig Campaign- Attacks on Saudi Arabian Organizations Deliver Helminth Backdoor",
    "authors": "",
    "file_creation_date": "2022-05-06T09:03:32Z",
    "file_modification_date": "2022-05-06T09:03:32Z",
    "file_size": 714648,
    "plain_text": "# BE2 extraordinary plugins, Siemens targeting, dev fails\n\n**[securelist.com/be2-extraordinary-plugins-siemens-targeting-dev-fails/68838](https://securelist.com/be2-extraordinary-plugins-siemens-targeting-dev-fails/68838/)**\n\nOur [November post introducing our BlackEnergy2 (BE2) research described new findings on](https://securelist.com/be2-custom-plugins-router-abuse-and-target-profiles/67353/)\nthe group’s activity. We presented both details on their plugins and significant findings about\nsome of their targets and victims. In this post, let’s examine several additional plugins more\nclosely, targeting details around BE2 Siemens exploitation, and some of their unusual coding\nfailures.\n\nWe previously introduced an unknown set of plugins and functionality for the linux platform,\nsix in total. For the windows platform, we collected 17 plugins. The last post noted the\ndifficulty in collecting on this group. We finish descriptions for our set in this post.\n\n## Extraordinary Functionality\n\nLet’s first examine some of the newest and most surprising Windows plugins. It’s interesting\nthat all of these plugins use a custom “FindByHash” function to evade detection schemes and\nto slow analysis…\n\n### The “Destroy” plugin, dstr\n\n**Name** dstr.dll\n\n**MD5** 8a0a9166cd1bc665d965575d32dfa972\n\n\n-----\n\n**Type** Win32 DLL\n\n**Size** 26,474 bytes\n\n**CompiledOn** 2014.06.17 08:42:43\n\nThe most troubling plugin in the list is the “dstr” plugin. It is a Windows-only plugin. It was\nused to overwrite data by the BE2 actor, destroying data stored on hard drives by overwriting\nfile contents. While its use may be intended to cover their tracks, it is heavy handed to use\nthis type of tool to cover one’s tracks in a network. Most likely it is a tool of sabotage, much\nlike the Destover wiper seen on Sony Pictures Entertainment’s networks. However, it’s\ninteresting that the BE2 developers created wiper code different from the Destover and\nShamoon wiper malware we saw in the Saudi Aramco and SPE attacks. Instead of re-using\nthe commercial EldoS RawDisk drivers in their malware, the BE2 developers wrote their own\nlow-level disk and file destruction routines. It’s also a much more chilling deployment of\nwipers – instead of a poorly defended media studio, it was delivered to ICS environments.\n\nIn order to overwrite stored data on all Windows versions, the dstr plugin supports both\nuser-mode and kernel-mode wiper functionality, which is somewhat surprising. The\ncomponent maintains both an embedded win32 library and win64 driver modules for its\nkernel mode functionality. They are rc4 encrypted.\n\n**User-mode functionality**\n\nThe plugin identifies device id’s for the system’s HDD and creates a handle to the system’s\nphysical drive, with “GENERIC_READ or GENERIC_WRITE” access. Several calls to\nDeviceIoControl collects data on the physical location of the volume, and the size and\nproperties of this disk. It uses DeviceIoControl with the\nIOCTL_DISK_GET_DRIVE_GEOMETRY control code in order to retrieve Bytes Per Sector\nvalue. dstr then wipes out all open handles to the disk by dismounting it with the\nFSCTL_DISMOUNT_VOLUME control code.\n\n\n-----\n\nThis routine prepares the system for overwrite and ensures no conflicts for plugin file I/O.\nThen it makes multiple WriteFile calls to write a zeroed out buffer to disk.\n\nThe dstr plugin maintains code for unlocking and deleting the BE2 driver from disk,\nfurthering the group’s goal of keeping their traces hidden from researchers. And notice the\nFindByHash set of calls above, this sfc_os call disables Windows File Protection for a minute\nwhile an application can delete or modify the locked file. So this plugin and its call can\nproceed and delete the driver.\n\nThe plugin looks over all the services in the %system32%\\drivers folder and checks the write\npermission. If access is provided, it unlocks the file, rewrites the embedded driver under the\nexisting driver name and launches it.\n\n**Drivers and kernel mode functionality**\n\nDecrypted 32-bit driver\n\n**Name** driver.sys\n\n**MD5** c4426555b1f04ea7f2e71cf18b0e5b6c\n\n**Type** Win32 driver\n\n**Size** 5,120 bytes\n\n**CompiledOn** 2014.06.10 13:12:22 GMT\n\n\n-----\n\nDecrypted 64-bit driver\n\n**Name** driver.sys\n\n**MD5** 2cde6f8423e5c01da27316a9d1fe8510\n\n**Type** Win64 driver\n\n**Size** 9,136 bytes\n\n**CompiledOn** 2014.06.10 13:12:04 GMT\n\nThe 32-bit and 64-bit drivers are identical and compiled from the same source code. These\nsmall Windows drivers are supposed to support FAT32 and NTFS file systems, and contain\ntwo large code implementation mistakes. In spite of these flaws, it is clear that the author’s\ngoal was to parse a file system and then write random data across files.\n\n### Extraordinary Fails\n\nThese coding fails are unique to this dstr plugin, suggesting a development team effort\nbehind the plugin set code.\n\n**Fail #1: The authors reversed the routines for FAT32 and NTFS data wiping when checking**\nthe presence of the “FAT32” string in the first 1024-bytes of the system drive.\n\n**Fail #2: In the FAT32 routine the Root**\nDirectory Sector Number is calculated\nand is dealt as the absolute offset inside\nthe file rather than next multiplying this\nnumber by the bytes per sector\n\nIn comparison, there is no such mistake in the NTFS routine and the calculation of the MFT\noffset is implemented properly:\n\n\n-----\n\n### Goal – File Content Corruption\n\nApart from that, it is interesting that the authors implement NTFS wiping in an unusual way\nwith strange logic compared to FAT32 ‘straightforward’ wiping. The plugin accomplishes\nchecks for FILE records and at first skips them. Then under certain conditions it rewrites\nnon-FILE record sectors with random buffer which probably corresponds to some file\ncontents and proceeds looping. Then it ends up rewriting the first sectors of MFT and MFT\nmirror.\n\n### grc, plus.google.com replacement communications plugin\n\n**Name** grc.dll\n\n**MD5** ee735c244a22b4308ea5d36afee026ab\n\n**Type** Win32 DLL\n\n**Size** 15,873 bytes\n\n**CompiledOn** 2013.09.25 07:19:31\n\n\n-----\n\nThis plugin creates a backup communications channel to yet another legitimate service. Most\nlikely this backup channel is used to cloak outbound communications on monitored\nnetworks. We have seen APT using everything from Twitter to Google Docs to hide\ncommunications in plain sight, and this time the abused service is Google Plus.\n\nThis plugin implements the standard Windows HTTP services to interact with Google Plus\nover https, seeking to find a png file.\n\nThe plugin is provided with a specific Google Plus id to connect with, and uses the OLE\nstream Windows structured storage API along with the GDI+ bitmap functions to handle and\nparse this png file. This png file content is actually encrypted data containing the new BE\nconfiguration file just as it was obtained using ‘normal’ C&C communication. It is encrypted\nwith RC4, just like the embedded dstr drivers. But unlike to the ‘typical’ RC4 BE decryption\nscheme that uses RC4 once, here it uses RC4 three times: once with hardcoded key found in\nthe grc binary, the second time using the key extracted from the previous decrypted result,\nand the third time using the ‘id’ machine’s identifier that is normally served as the encryption\nkey during the C&C communication.\n\n### Universal serial bus data collection plugin, usb\n\n**Name** usb.dll\n\n**MD5** 0d4de21a2140f0ca3670e406c4a3b6a9\n\n**Type** Win32 DLL\n\n**Size** 34,816 bytes\n\n**CompiledOn** 2014.03.21 07:02:48\n\n\n-----\n\nThe usb plugin collects all available information on connected USB drives, and writes out all\nof these details to a text file, packs it, provides to the main BlackEnergy code, which\ncommunicates to a c2.\n\nIt uses multiple api calls to collect information on multiple types of connected usb storage\ndevices. It enumerates all usb storage devices connected to the system and retrieves data\nfrom all, including SCSI mass storage devices. And, most interestingly, it may be the first\nimplementation of BadUSB-related techniques in APT re-purposed COTS malware that we\nhave seen in the wild.\n\nThe code queries scsi devices directly and sends them two types of SCSI commands. The first\ncommand with the opcode 0x1A which corresponds to MODE SENSE may result just in the\nlogging of the failed call (‘SendSCSICommand return false’ message).\n\nThe second type of SCSI command remains mysterious. It uses undefined opcode 0xf0 and\nthere is no direct evidence of its purpose as it is stated to be vendor specific. This mysterious\nopcode is referenced around the same time frame of the plugin development in BadUSB\noffensive research\n[http://algorithmics.bu.edu/twiki/bin/view/EC521/SectionA1/Group5FinalReport. Here, it is](http://algorithmics.bu.edu/twiki/bin/view/EC521/SectionA1/Group5FinalReport)\nnoticed in the USB traffic generated by an SMI controller tool. To be specific, there are two\ncalls with the opcode 0xf0 in the code, each passed its own parameters. One of the\nparameters, 0x2A, is mentioned in the paper to return the string containing the firmware\nversion, NAND flash ID, and controller part number. But this returned information is not\nlogged anywhere.\n\nAlso the code loops to retrieve detailed physical data about every attached storage device:\n\n\n-----\n\nnumber of cylinders\nmedia type (floppy, fixed hard drive, removable media, etc)\nnumber of tracks per cylinder\nsectors per track\nnumber of bytes per sector\nphysical disk size in bytes\nDevice Instance ID\n\n### Motherboard and firmware data collection plugin, bios\n\n**Name** bs.dll\n\n**MD5** 4747376b00a5dd2a787ba4e926f901f4\n\n**Type** Win32 DLL\n\n**Size** 210,432 bytes\n\n**CompiledOn** 2014.07.29 00:40:53\n\nThe bios plugin gathers low level host system information:\n\nBIOS\nmotherboard\nprocessor\nOS\n\nIt uses several techniques to gather this information:\n\nWMI\nCPUID\nwin32 api\n\n\n-----\n\nAs a Windows Management Instrumentation (WMI) client application, it initializes COM and\nconnects to the \\\\root\\cimv2 namespace to use the IWbemServices pointer and make WMI\nrequests. The code executes wql queries (“wql” is “sql for wmi”, a subset of sql) to gather\nvictim host details, like the query “SELECT Description, Manufacturer, Name, ProcessorId\nFROM Win32_Processor”. Here are several queries from the BlackEnergy2 plugin code:\n\nSELECT Description, Manufacturer, Name, ProcessorId FROM Win32_Processor\nSELECT Product, Manufacturer, Version FROM Win32_BaseBoard\nSELECT Name, OSArchitecture, Version, BuildNumber FROM\nWin32_OperatingSystem\nSELECT SerialNumber, Description, Manufacturer, SMBIOSBIOSVersion FROM\nWin32_BIOS\n\nThese wql calls provide the attacker with the data like the lines below:\n\nDescription=Intel64 Family 6 Model 60 Stepping 3\nManufacturer=GenuineIntel\nName=Intel(R) Core(TM) i7-4710MQ CPU @ 2.50GHz\nProcessorId=1FEAFBCF000116A9\n\nProduct=7MPXM1\nManufacturer=AsusTek\nVersion=??\n\nName=Microsoft Windows 8.1 Pro\nOSArchitecture=64-bit\nVersion=6.3.9600\nBuildNumber=9600\n\nSerialNumber=7DTLG45\nDescription=A12\nManufacturer=AsusTek\nSMBIOSBIOSVersion=A12\n\nThis selectivity is fairly usual. And the plugin does not modify its own behavior based the\ncollected values. What can we infer about the selection of only these values, as they are only\nbeing collected and sent back to the attackers? Here are some possibilities:\n\nthe attackers want to evade sandbox and honeypot/decoy environments, and use this\ncollected data to id the host system.\n\n\n-----\n\nthe attackers have prior knowledge of the environment they are attempting to\npenetrate, down to the equipment make. Or, they have an idea of the types of hardware\nthey would expect or want to see. In ICS and SCADA environments, these details could\nbe very valuable for an attacker setting up shop. These details could aid in establishing\npersistence, evaluating true resource capacity and capabilities, tracking down the\nsource of the equipment, or aiding further lateral movement\nthe attackers know nothing about the network they are penetrating. They are collecting\nthis information to better understand where this plugin really is running in the victim\nenvironment and planning their next moves\n\nWhen using standard win32 api, the application implements calls to retrieve information on\nsystem locales. Oddly, there is special handling for one nordic locale in this particular plugin,\n“Norwegian-Nynorsk”.\n\nThe CPU data collection functionality first calls the Intel cpuid instruction directly. It also\ndirectly handles multi-cpu systems and each of their feature sets. This SMP support is hard\ncoded into the plugin.\n\n### Additional BE2 Siemens Exploitation Details\n\nTargeting details for BE2 actor events are interesting. When focusing on research sites and\nenergy engineering facilities, the group remotely exploited Siemens’ Simatic WinCC systems.\nIn these events, the attackers attempted to force the ccprojectmgr.exe process to download\nand execute a specific BlackEnergy2 payload. Let’s examine a couple of example targets here.\nBased on the different delays for return, the attacks were possibly not automated.\n\n**Target A:**\n\nThe first exploit attempt ksn recorded was March 2014. The attackers returned with a second\nfailed attempt to exploit that same research system on April 2014, approximately 30 days, 2\nhours later.\n\n**Target B:**\n\nThe BE2 actor then attacked a new target system in May 2014 and failed, and returned with\nan exploit attempt on that same system in July 2014.\n\nSo it looks like there may be a timing cycle to their visits, but the volumes here are too low to\nbe significant.\n\nIn all four of these attempts on two different targets, the attackers tried to download their\npayload from hxxp://94.185.85(dot)122/favicon.ico. The payload changed slightly from\nMarch 2014 to the very end of July 2014, presenting the following md5(s). All of these\ndroppers are BE2 malware, modify an existing kernel driver service like “ACPIEC” and start\n\n\n-----\n\nit to load the BE2 kernel module. Note that the attackers planned on re-using the same c2 for\nthe first target, but changed the callback c2 for the second target. None of these components\nare signed:\n\n**fda6f18cf72e479570e8205b0103a0d3** → drops df84ff928709401c8ad44f322ec91392,\ndriver, debug string:”xxxxxxxx.pdb”. C2: 144.76.119.48 (DE, Hetzner Online AG, AS24940)\n\n**fe6295c647e40f8481a16a14c1dfb222** → drops 39835e790f8d9421d0a6279398bb76dc,\ndriver, debug string:”xxxxxxxx.pdb”. C2: 144.76.119.48 (DE, Hetzner Online AG, AS24940)\n\n**ac1a265be63be7122b94c63aabcc9a66** → drops b973daa1510b6d8e4adea3fb7af05870,\ndriver. C2: 95.143.193.131 (SE, Internetport Sweden AB, AS49770)\n\n**8e42fd3f9d5aac43d69ca740feb38f97 → drops f4b9eb3ddcab6fd5d88d188bc682d21d,**\ndriver. C2: 46.165.222.6 (DE, Leaseweb Germany GmbH, AS16265)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/ICS SCADA/GreyEnergy and BlackEnergy/BE2 extraordinary plugins, Siemens targeting, dev fails.pdf"
    ],
    "report_names": [
        "BE2 extraordinary plugins, Siemens targeting, dev fails.pdf"
    ],
    "threat_actors": [
        {
            "id": "4d9cdc7f-72d6-4e17-89d8-f6323bfcaebb",
            "created_at": "2023-01-06T13:46:38.82716Z",
            "updated_at": "2025-03-27T02:00:02.928984Z",
            "deleted_at": null,
            "main_name": "GreyEnergy",
            "aliases": [],
            "source_name": "MISPGALAXY:GreyEnergy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b3e954e8-8bbb-46f3-84de-d6f12dc7e1a6",
            "created_at": "2022-10-25T15:50:23.339976Z",
            "updated_at": "2025-03-27T02:00:55.446795Z",
            "deleted_at": null,
            "main_name": "Sandworm Team",
            "aliases": [
                "Sandworm Team",
                "ELECTRUM",
                "Telebots",
                "IRON VIKING",
                "BlackEnergy (Group)",
                "Quedagh",
                "Voodoo Bear",
                "IRIDIUM",
                "Seashell Blizzard",
                "FROZENBARENTS",
                "APT44"
            ],
            "source_name": "MITRE:Sandworm Team",
            "tools": [
                "Bad Rabbit",
                "Mimikatz",
                "Exaramel for Linux",
                "Exaramel for Windows",
                "GreyEnergy",
                "PsExec",
                "Prestige",
                "P.A.S. Webshell",
                "VPNFilter",
                "Cyclops Blink",
                "SDelete",
                "AcidRain",
                "Industroyer",
                "Industroyer2",
                "BlackEnergy",
                "Cobalt Strike",
                "NotPetya",
                "KillDisk",
                "PoshC2",
                "Impacket",
                "Invoke-PSImage",
                "Olympic Destroyer"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536193,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1651827812,
    "ts_modification_date": 1651827812,
    "files": {
        "pdf": "https://archive.orkl.eu/9ee880fbd53f4980ec162b229692d3fb3adac1c8.pdf",
        "text": "https://archive.orkl.eu/9ee880fbd53f4980ec162b229692d3fb3adac1c8.txt",
        "img": "https://archive.orkl.eu/9ee880fbd53f4980ec162b229692d3fb3adac1c8.jpg"
    }
}