{
    "id": "024a794d-544a-41a4-9c0d-be8ff5f27e6d",
    "created_at": "2023-01-12T15:00:07.360499Z",
    "updated_at": "2025-03-27T02:09:30.021127Z",
    "deleted_at": null,
    "sha1_hash": "9238566b418dd74f2ac4ec6f98add24bfc3a79bf",
    "title": "2021-07-05 - Tracking Cobalt Strike- A Trend Micro Vision One Investigation",
    "authors": "",
    "file_creation_date": "2022-05-27T22:09:20Z",
    "file_modification_date": "2022-05-27T22:09:20Z",
    "file_size": 2318494,
    "plain_text": "# Tracking Cobalt Strike: A Trend Micro Vision One Investigation\n\n**[trendmicro.com/en_us/research/21/g/tracking_cobalt_strike_a_vision_one_investigation.html](https://www.trendmicro.com/en_us/research/21/g/tracking_cobalt_strike_a_vision_one_investigation.html)**\n\n\nJuly 5, 2021\n\n\n-----\n\nFigure 1. The mapped-out activity of Cobalt Strike in the affected environment\nIn late May, Trend Micro Managed XDR alerted a customer to a noteworthy Vision One alert\non one of their endpoints. What followed was a deeper investigation that involved searching\nfor other similarly infected endpoints and the confirmation of a Cobalt Strike detection.\n\nThis blog will cover the tactics and steps we took during this investigation. The alert from one\nendpoint led to the collection of further evidence and clues that pointed to other infected\nendpoints, eventually revealing the root of the attack.\n\nCobalt Strike is a well-known beacon or post-exploitation tool that has been linked to\n[ransomware families like Ryuk,](https://www.trendmicro.com/vinfo/tmr/?/us/security/news/cybercrime-and-digital-threats/the-state-of-ransomware-2020-s-catch-22) [DoppelPaymer, and](https://www.trendmicro.com/en_us/research/21/a/an-overview-of-the-doppelpaymer-ransomware.html) [Povlsomware. The Cobalt Strike variant](https://www.trendmicro.com/en_us/research/21/c/povlsomware-ransomware-features-cobalt-strike-compatibility.html)\nused here follows its typical characteristics. However, this report focuses on the process of\n\n\n-----\n\nuncovering its tracks in order to fully contain and remove the malware.\n\nAn overview of the investigation\n\nWe first uncovered several detections related to Cobalt Strike, accompanied by a machine\nlearning detection later verified as IcedID. In such cases, the initial detections usually point to\n[something big: the distribution of ransomware. In fact, we published a report on a similar](https://www.trendmicro.com/en_us/research/21/c/vision-one-tracking-conti-ransomware.html)\ncase wherein we used Cobalt Strike to track a Conti ransomware campaign.\n\nBefore we delve into the details we want to detail the process we followed in this\ninvestigation. It involved several interconnected steps that occurred simultaneously and\nrepeatedly throughout the process. These steps are mainly:\n\nCreating an indicators of compromise (IOCs) list and observe for tactics, techniques,\nand procedures (TTPs) to check in the environment, which will be improved in the next\nitems\nChecking the context of the generated alerts\nExamining the execution profile of the files related to the detection\nCollecting additional logs from the endpoint to correlate events\nChecking detections that occurred around the time range of the alerts\n\nThese steps allowed us to retrace the actions taken by the variant from a single endpoint and\nrevealing the full extent and its origins. Figure 1 maps out the Cobalt Strike activity that we\ntracked; it also indicates where we started, at Endpoint-1.\n\nIt is important to note that we already provided the affected customer our initial response\nvery early into the investigation, allowing them to start taking steps to contain the threat as\nwe worked to fully reveal its extent.\n\nInitial detections, IOCs, and observed TTPs\n\nAs we had mentioned earlier, our investigation started when we noticed suspicious activity in\none endpoint. For the purpose of this discussion we shall label this endpoint as Endpoint-1,\nsince this is where we encountered the first hints of an attack. We began our investigation\nfrom this endpoint to uncover the real entry point.\n\n**Endpoint-1**\n\nChecking the alerts of Endpoint-1 revealed several important findings that sparked the\ninvestigation:\n\nAdFind.exe was downloaded in the Users\\Public directory\nA Cobalt Strike detection occurred, as seen in Figure 1\nMobsync.exe executed information gathering commands\n\n\n-----\n\nFigure 2. Vision One’s interface showing the early indicators of Cobalt Strike\nFirst let us narrow our focus on the suspicious process, mobsync.exe. Vision One’s\nProgressive RCA allowed us to pinpoint a possible infection vector that lead to its execution.\nThe process chain for Endpoint-1 started with a user executing a file named excel.exe, which\nthen created a rundll32.exe. The rundll32.exe loaded a file named iroto.tio, leading to the\nexecution of the aforementioned mobsync.exe, which is a legitimate MS tool hijacked via\nprocess hollowing.\n\nFigure 3. The file excel.exe shown as the source of the malware as shown in Vision One\n\n\n-----\n\nProgressive RCA gave us the choice to expand the nodes to find additional indicators that\nmight be useful to the investigation. In this case, we were interested in excel.exe, or the\nsource; and mobsync.exe,which seemed like the final payload at that point.\n\nFigure 4. The file excel.exe accessing two URLs taken from Vision One\nLet us first turn our attention to the excel.exe, which we saw accessing two suspicious URLs\ndharamdiwan[.]com and lenoirramosjr[.]com before proceeding to drop iroto.tio (not shown in\nthe Figure 3) and loading the dropped file via rundll32.exe.\n\nVision One’s Observed Attack Techniques (OAT) also showed the techniques used via\nexcel.exe and its child processes, one of which is “MS Office Application Command\nExecution Via DDE.” Digging deeper in the Vision One console, we identified analysis57909253.xlsx as the malicious XLS file that utilized DDE.\n\n\n-----\n\nFigure 5. Events related to mobsync.exe\nGoing back to mobsync.exe revealed several other events, as shown in Figure 5. We\nsummarize the activities done by this injected tool.\n\nIt attempts a connection to the following IP addresses:\n\n222[.]153[.]124[.]130\n109[.]106[.]69[.]138\n75[.]118[.]1[.]141\n92[.]59[.]35[.]196\n104[.]98[.]42[.]5\n204[.]16[.]247[.]35 (madesecuritybusiness[.]com)\n\nIt also executed discovery/internal reconnaissance commands and spawned additional\nmobsync.exe processes, as shown in Table 1.\n\n\nDate and\nTime\n(UTC)\n\n5/26/2021\n0:41\n\n5/26/2021\n0:41\n\n\nProcess\n\nwhoami /all\n\ncmd /c set\n\n\n-----\n\n5/26/2021\n0:41\n\n5/26/2021\n0:41\n\n5/26/2021\n0:41\n\n5/26/2021\n0:42\n\n5/26/2021\n0:42\n\n5/26/2021\n0:42\n\n5/26/2021\n0:42\n\n5/26/2021\n0:42\n\n5/26/2021\n1:50\n\n5/26/2021\n1:50\n\n5/26/2021\n1:58\n\n5/26/2021\n1:58\n\n\narp -a\n\nipconfig /all\n\nnet view /all\n\nnslookup -querytype=ALL -timeout=10 _ldap._tcp.dc._msdcs.\n\n[WORKGROUP]\n\nnet share\n\nroute print\n\nnetstat -nao\n\nnet localgroup\n\nC:\\WINDOWS\\SysWOW64\\mobsync.exe\n\nC:\\WINDOWS\\system32\\ping.exe -t 127.0.0.1\n\nC:\\WINDOWS\\SysWOW64\\mobsync.exe\n\nesentutl.exe /r V01 /l”C:\\Users\\[Endpoint-1User]\\AppData\\Local\\Microsoft\\Windows\\WebCache” /s”C:\\Users\\\n\n[ENDPOINT-1-USER]\\AppData\\Local\\Microsoft\\Windows\\WebCache”\n/d”C:\\Users\\[ENDPOINT-1USER]\\AppData\\Local\\Microsoft\\Windows\\WebCache”\n\n\n-----\n\n5/26/2021\n5:33\n\n5/26/2021\n5:33\n\n\nC:\\WINDOWS\\SysWOW64\\mobsync.exe\n\nC:\\WINDOWS\\system32\\cmd.exe /C ping [ENDPOINT-4]\n\n\nTable 1. A list of the commands executed by mobsync.exe\n\nWe also identified Bloodhound and ADfind.exe hacking tools deployed in Endpoint-1. These\ntools can be used to extract information from the Active Directory.\n\n\nDate and\nTime\n(UTC)\n\n5/26/2021\n5:00\n\n5/26/2021\n5:04\n\n\nProcess\n\nC:\\WINDOWS\\system32\\cmd.exe /C del 20210526145501_BloodHound.zip\nYmNhMTJiMzAtYTgxZi00ZWRmLWE2ZjctZTc3MDFiZGM2ODBj.bin\n\nC:\\WINDOWS\\system32\\cmd.exe /C AdFind.exe -f objectcategory=computer\n-csv name cn OperatingSystem dNSHostName > [REDACTED].csv\n\n\nTable 2. Bloodhound and ADfind.exe in the logs of Endpoint-1\n\nWith Vision One and the Trend Micro Investigation Toolkit (TMIK), we were able to identify\npotential Pass-the-Hash (PtH) attacks that extracts the password hash from the memory and\nthen simply passes it through for authentication. If there are recent logins of high privilege\naccounts in the machine, then the password hash of these logins can be extracted by\nattackers to perform lateral movement to other networked systems. The event logs also\nshowed a related entry for the PtH technique stating, “Found 4624 event logs with seclogo\nas process for ENDPOINT-1-USER.”\n\nFigure 6. Detection of the Pass-the-Hash technique\n\n\n-----\n\nAside from Endpoint-1, we also found several other endpoints where we identified Cobalt\nStrike detections. We specify another two here as they already contain the evidence, such as\na list of IOCs and observed TTPs, that we needed to pinpoint “Patient Zero,” or the first\nmachine to be infected by the malware.\n\n**Endpoint-2**\n\nWe will label another endpoint as Endpoint-2. Endpoint-2 is a machine that Vision One also\nalerted to have shown Cobalt Strike detection.\n\nFigure 7. Detection for Cobalt Strike in Endpoint-2\nVision One’s Execution Profile for the file shows ntoskrnl.exe executing 49c4b8e.exe. This\nsequence of processes in the execution profile implies that the file was transferred via SMB,\nevidence of lateral movement which was stopped due to the detection.\n\nHunting IOCs and TTPs\n\n\n-----\n\nWith all the findings from Endpoint-1 and Endpoint-2, we were able to observe for TTPs and\ncreate an IOC list that we can search across all the machines reporting to Vision One. This\nsearch was based on the following indicators:\n\nFilename and hashes of the detected files\nSuspicious behavior, such as excel.exe spawning rundll32.exe or mobsync.exe\nspawning cmd.exe\nPossible command and control (C&C) connections\nCompromised accounts used for lateral movement and are transferred files via SMB\nDetections that occurred around the time the alert occurred (commonly used time\nrange is Last 7 days)\n\nSearching the IOCs in the Vision One search app revealed several other machines related to\nthis case, as shown in Figure 1. An example of such a machine is one that we labeled\nEndpoint-3.\n\nSimilar to Endpoint-1, there were malware detections in the machine, where it blocked the\nexecution of excel.exe that spawned rundll32.exe. There was also a machine learning\ndetection related to the file iroto.tio. Finally, inspecting Workbench alerts showed an entry for\nCobalt Strike.\n\n\n-----\n\nFigure 8. Detection of Cobalt Strike in\n\nEndpoint-3\nInvestigating Endpoint-3’s execution profile showed that the excel.exe process connected to\nthe same suspicious domains that we mentioned earlier. It also created the file iroto.tio.\n\n\n-----\n\nFigure 9. Enpoint-3’s execution profile showing excel.exe’s activities\nWith a list of IOCs and TTPs we were able to look for other infected machines or endpoints\nand were also then capable of narrowing down Patient Zero.\n\nLocating Patient Zero\n\nSince we know for sure that the threat started with an execution of excel.exe and the .xls file\nit opened, it is logical to assume that the attack started from an email attachment, which was\nthe case here. The Vision One, Managed XDR team was able to eventually track down the\nentry point of this attack: a socially engineered spear phishing email sent to an internal user.\n\n\n-----\n\nFigure 10. Socially engineered spear phishing email\nThe threat actor made the email seem as if they were replying to an email the targeted user\nhad sent them, thus making it appear as if they already had an existing conversation thread.\nThey also used a forged sender email address so that the targeted user would think that the\nemail came from a legitimate sender. The email contained a link to download a malicious\narchive file with the name of the targeted user.\n\n\n-----\n\nFigure 11. Vision One results showing the malicious email being forwarded to another user or\nmachine\n\nFigure 12.\n\nThe message of the forwarded malicious email\nThrough Vision One, we were able see that a few minutes after receiving the email, the\ntargeted user forwarded the malicious email to another internal user. These results from\nVision One (Figure 11) matched with the email that Managed XDR had acquired (Figure 12),\nthus proving that the machine was Patient Zero and rounding out our investigation.\n\nResponding to the threat\n\n\n-----\n\nThe overall goal of the investigation was to get a full scope of the Cobalt Strike infection. This\ninvolved identifying the IOCs we can use to search for all the machines that were infected, as\nwell as stopping the spread at the root.\n\nAll throughout the process we had been reporting to the affected customer, especially after\nthe discovery of each of the affected endpoints. This is to quickly contain the spread of the\nmalware variant. The response to this threat included the following, in no particular order:\n\nIsolation of affected endpoints as the investigation was being conducted\nDisabling/resetting the passwords of the user accounts that were used for lateral\nmovement\nCollecting related artifacts to the threat and doing further analysis, which were also\nsubmitted for detection to improve coverage\nBlocking of domain/IP addresses related to the C&C of the threat\nFurther monitoring of the environment to ensure that there’s no suspicious activity\ngoing on\n\nMany of these steps were done simultaneous to the investigation, so as not to risk possible\nconsequences and prevent the spread of the malware to other machines.\n\nConclusion and recommendations\n\nThe result of the investigation demonstrated the importance of a multi-layered security\napproach in protecting the environment. This is crucial so that in case one layer of protection\nfails another is present to keep the environment safe or at least limit the impact of an attack.\n\nPrioritizing detections and combining different techniques can help in catching the threat and\ninitiating a quick response. As this case reflects, preliminary security events should be taken\nseriously as they usually are the precursor to something bigger, such as breaches and\nransomware attacks.\n\n[The investigation also highlights the incident response process for handling breaches and](https://www.trendmicro.com/vinfo/tmr/?/us/security/news/managed-detection-and-response/cyberattacks-from-the-frontlines-incident-response-playbook-for-beginners)\nmalicious activities. It emphasizes how threat response does not end upon the detection of a\nthreat; an investigation is key to understanding a threat and preventing them from occurring\nagain. Using acquired knowledge from previous attacks and boosting user awareness of\ncommon threats can improve the overall security posture of any environment.\n\nMITRE mapping\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-05 - Tracking Cobalt Strike- A Trend Micro Vision One Investigation.pdf"
    ],
    "report_names": [
        "2021-07-05 - Tracking Cobalt Strike- A Trend Micro Vision One Investigation.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535607,
    "ts_updated_at": 1743041370,
    "ts_creation_date": 1653689360,
    "ts_modification_date": 1653689360,
    "files": {
        "pdf": "https://archive.orkl.eu/9238566b418dd74f2ac4ec6f98add24bfc3a79bf.pdf",
        "text": "https://archive.orkl.eu/9238566b418dd74f2ac4ec6f98add24bfc3a79bf.txt",
        "img": "https://archive.orkl.eu/9238566b418dd74f2ac4ec6f98add24bfc3a79bf.jpg"
    }
}