{
    "id": "5380f0a5-c0cd-4a41-8fe0-c4e9e2c73aa3",
    "created_at": "2023-01-12T15:05:38.959017Z",
    "updated_at": "2025-03-27T02:05:20.845412Z",
    "deleted_at": null,
    "sha1_hash": "64fad4ec2cc52e812980ce24d8fc078cf22188ae",
    "title": "2020-05-14 - Netwalker Ransomware- [API Call Obfuscation (using Structure) and Evading Memory Forensic]",
    "authors": "",
    "file_creation_date": "2022-05-28T21:50:58Z",
    "file_modification_date": "2022-05-28T21:50:58Z",
    "file_size": 1636580,
    "plain_text": "# Netwalker Ransomware: [API Call Obfuscation (using Structure) and Evading Memory Forensic]\n\n**[tccontre.blogspot.com/2020/05/netwalker-ransomware-api-call.html](https://tccontre.blogspot.com/2020/05/netwalker-ransomware-api-call.html)**\n\nToday I just want to share some interesting obfuscation and anti memory forensic techniques\nI've learned from Netwalker Ransomware that makes its code more time consuming and\nhard to analyze. This also include the first part which is a obfuscated powershell that will\nserve as the loader of the malware.\n\n## Stage 1: Obfuscated Powershell:\n\nThis netwalker ransomware variant start with 3 stages as follows:\n\n1st Layer : base 64 encoded powershell\n\n2nd Layer: (after decoding the base64) is an encrypted array of bytes using xor command\nwith decryption key of 0xc4, that will be run in scriptblock command.\n\n3rd Layer : (after the decrypted 2nd layer) is a 2 sets of hex bytes array which is the x86 and\n64 version of Netwalker binary files that will be injected in a process by a C# code that will be\nloaded and compile using powershell.\n\n\n-----\n\nfigure 1: the 3 layered powershell script\n\n\n-----\n\nfigure 2: the C# loader written in powershell using Add-Type\n\n## Stage 2: No MZ Header Binaries\n\nas far as we saw in the last stage of the powershell, it will inject the ransomware (x86 or x64\nbinaries) to the explorer.exe process. The interesting part is after I decode those hex byte\narray, I notice that there are no MZ header to the binary file that are one technique to evade\nmemory forensic tools or some quick check for injected executable to a process.\n\n\n-----\n\nfigure 3: NO MZ Header Files\n\n## Stage 3: Obfuscated API Call Using Structure\n\nThis Netwalker Ransomware has no import table. It will dynamically harvest its needed API\nusing some hashing algorithm search to all export table of all needed DLL modules to\nexecutes its malicious code then save it to a structure object. Below is the screenshot how\nthe raw Hexray view of the import harvesting before and after resolving the API hash and the\nstructure Array using Idapython.\n\n\n-----\n\nfigure 4: API harvesting Function\n\n\n-----\n\nThe Hashing Algorithm is really looks complicated base on its graph but actually it is just a\nloop of xor and rotate bit operation with specific keys.\n\nfigure 5: Hashing algorithm\n\nBut the Obfuscation does not ends here. As we remember that it place the resolved API\naddress into a structure object. Then this structure was initialized to a another variable by a\nfunction then do the access the member of the structure out of that which make the analysis\nmore confusing.\n\n\n-----\n\nfigure 6: Declare multiple Structure as a obfuscation\n\nThanks for IDA Python for helping me in creating a structure out of harvested API it needs to\nmake the static analysis more easily.\n\n\n-----\n\nfigure 7: Add Structure\n\n### Lesson Learn:\n\nI learned that the there are so many way to obfuscate code from analysis and even the data\nstructure can be used to make the analysis little bit confusing during analysis like what I\nexperience. :)\n\n\n-----\n\n### IOC:\n\n[https://app.any.run/tasks/6bb00be0-cd0a-4d9a-a1ea-72cd275ded0e/](https://app.any.run/tasks/6bb00be0-cd0a-4d9a-a1ea-72cd275ded0e/)\n\n**Powershell:**\n\nfilename: powershell.ps1\n\nmd5: 5bec43ea21e95a68abafa8c7f99d1e6c\n\nsha1: 22df933f2b33f3f4ffee22b51b4f8fa0268bb327\n\nsha256: b7c7fa9b74aacf331871a9e5438678bce46002618fa106429225161d94e22e44\n\n**x64 Netwalker Ransomware:**\n\nfilename: x64.bin\n\nmd5: bc96c744bd66ddfaa79d467b757b8628\n\nsha1: a379f9e04708d773a2dec897166780b026f4c4ea\n\nsha256: 2c245db9fb9b2c6e84832662dda3dfff3c6b21128d9fec115f5b989fb090841d\n\n**x86 Netwalker Ransomware:**\n\nfilename: x86_raw.bin\n\nmd5: de61b852cadac6afe307652b187ca5df\n\nsha1: fa02c1d394bc150d8a62d3f991d0fdc042ee9724\n\nsha256: e8c5c0b70d45a5dc80d678ed7102abf9882efb9cbc2cff20f171d60d5205051d\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-14 - Netwalker Ransomware- [API Call Obfuscation (using Structure) and Evading Memory Forensic].pdf"
    ],
    "report_names": [
        "2020-05-14 - Netwalker Ransomware- [API Call Obfuscation (using Structure) and Evading Memory Forensic].pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535938,
    "ts_updated_at": 1743041120,
    "ts_creation_date": 1653774658,
    "ts_modification_date": 1653774658,
    "files": {
        "pdf": "https://archive.orkl.eu/64fad4ec2cc52e812980ce24d8fc078cf22188ae.pdf",
        "text": "https://archive.orkl.eu/64fad4ec2cc52e812980ce24d8fc078cf22188ae.txt",
        "img": "https://archive.orkl.eu/64fad4ec2cc52e812980ce24d8fc078cf22188ae.jpg"
    }
}