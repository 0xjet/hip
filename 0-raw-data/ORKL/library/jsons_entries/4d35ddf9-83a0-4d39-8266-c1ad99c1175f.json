{
    "id": "4d35ddf9-83a0-4d39-8266-c1ad99c1175f",
    "created_at": "2023-01-12T15:01:05.209638Z",
    "updated_at": "2025-03-27T02:05:40.361614Z",
    "deleted_at": null,
    "sha1_hash": "3698f9471de8ff1dbe26b58bef9d9db16dbfe8c4",
    "title": "2016-07-01 - How I Cracked a Keylogger and Ended Up in Someone's Inbox",
    "authors": "",
    "file_creation_date": "2022-05-28T15:54:20Z",
    "file_modification_date": "2022-05-28T15:54:20Z",
    "file_size": 1947901,
    "plain_text": "# How I Cracked a Keylogger and Ended Up in Someone's Inbox\n\n**[trustwave.com/Resources/SpiderLabs-Blog/How-I-Cracked-a-Keylogger-and-Ended-Up-in-Someone-s-Inbox/](https://www.trustwave.com/Resources/SpiderLabs-Blog/How-I-Cracked-a-Keylogger-and-Ended-Up-in-Someone-s-Inbox/)**\n\nIt all started from a spam campaign. Figure 1 shows a campaign we picked up recently from\nour spam traps with a suspicious document file attachment. Notice how poor the English is;\nthis shall serve as a sign of warning to the email recipients.\n\n\n-----\n\nFigure 1: Spam Sample\n\nThe attachment uses the \".doc\" file extension but is actually an RTF (rich text file) file\nformat. The file contains a specially crafted RTF stack overflow exploit. This was\ndetermined to be the CVE-2010-3333 that exploits the Microsoft Word RTF parser in\nhandling the \"pFragments\" shape property. This vulnerability had been patched more than\nhalf a decade ago.\n\n\n-----\n\nFigure 2. Obfuscated shellcode in a specially crafted RTF file\n\nAs you can see in Figure 2, the exploit and the shellcode were obfuscated to avoid antivirus\ndetection. After extracting, cleaning up and decoding the exploit, I figured out that the\nshellcode would download and execute a file from the domain volafile[.]io\n\n\n-----\n\nFigure 3. Shellcode HEX dump\n\n**THE PAYLOAD**\n\nFigure 4. The downloaded executable file\n\nThe downloaded file is a Microsoft .NET Win32 executable. A quick hex dump preview of\nthe file gave a very interesting clue that I am dealing with a HawkEye keylogger build.\n\nFigure 5. Hawkeye Keylogger string in the malware body\n\nAnd with a little bit of Google-Fu, the string pointed me to a website which develops this\nkeylogger. In the website, they've listed all of its \"awesome features\".\n\nFigure 6. HawkEye Keylogger Features\n\n\n-----\n\nIn my quick dynamic analysis, the keylogger drops a copy of itself to the Application Data\n(%appdata%) folder and uses the filename WindowsUpdate.exe. It sets an autorun registry\nto facilitate persistency in the Windows system even after reboot.\n\nFigure 7. Keylogger's Installation routine\n\nIt also drops the following files in the infected system:\n\n%Temp%\\Sysinfo.txt – the dropped malware executable path\n%Appdata%\\pid.txt – the malware process ID\n%Appdata%\\pidloc.txt – the malware process executable location\n\nI then observed network activity from the keylogger process that tries to obtain the infected\nsystem's external IP address from checkip.dyndns.com. This legitimate website is\ncommonly used by malware to determine the IP address of the infected system.\n\nFigure 8. Get infected machine's IP address packet capture\n\nAfter a short while, SMTP network activity was observed where the system information of\nthe infected system was sent to the attacker's email address.\n\n\n-----\n\nFigure 9. Email sent by the keylogger to the attacker's email address that contains the\nsystem information\n\nThe information may include:\n\nCPU Name (computer name)\nLocal Date and Time\nInstalled Language\nOS Installed\nPlatform\nOS Version\nMemory installed\n.Net Framework Installed\nSystem Privileges\nDefault Browser\nInstalled Firewall\nInternal IP Address\nExternal IP Address\nRecovered Email settings and passwords\nRecovered Browser and FTP passwords\n\nAs previously mentioned, the keylogger was compiled with Microsoft .NET. So the next\nthing I did is to decompile the executable. I used an open-source .NET Decompiler called\n[ILSpy to accomplish this task.](https://github.com/icsharpcode/ILSpy)\n\n\n-----\n\nFigure 10. Hawkeye keylogger decompiled source code\n\nI took a closer look in the decompiled source code and compared it to its list of \"Awesome\nFeatures\". I can confirm that its claim is 100% legit. I found the following features in its code\nlike:\n\nKeylogging.\n\nFigure 11. Keylogging routine\n\nA clipboard stealer/logger.\n\n\n-----\n\nFigure 12. Clipboard logging routine\n\nA browser, FTP, and Mail Client password stealer. It also attempts to steal password\nmanager credentials and Windows keys.\n\nFigure 13.\n\nA worm-like USB infection routine that will allow the keylogger to spread to other Windows\nmachine.\n\n\n-----\n\nFigure 14. USB infection routine\n\nIt may also target the users of online gaming platform Steam. It deletes the configuration\ndata and login data files so that the user will be forced to login again. This is an opportunity\nfor the keylogger to steal the user's Steam credentials.\n\nFigure 15. Steam deletion routine\n\n\n-----\n\nThe stolen information including the desktop screenshot are sent to either to the attacker s\nemail address or FTP server depending on how the keylogger was configured.\n\nFigure 16. Email sending routine\n\nThe attacker may also configure the keylogger to upload the stolen information through a\nHTTP tunnel to a PHP host, but the code seems to be voided.\n\nFigure 17.\n\nThe most interesting part I've found in the decompiled code however is a C# constructor\nnamed Form1(). This is where the keylogger configuration was stored. But to secure the\nattacker's email and FTP credentials, these data were encrypted using Rijndael algorithm\nand Base64.\n\n\n-----\n\nFigure 18. The keylogger configuration\n\nAs you may know, those encrypted data are not always secure, especially if the decryption\nroutine is in the decompiled source code!\n\nFigure 19. The keylogger calls the Decrypt method\n\nThe image below is the \"Decrypt\" method where it accepts two string parameters: the\n_encryptedBytes and the secretKey. The secret key happens to be a hardcoded string_\n**_HawkSpySoftwares_**\n\n\n-----\n\nFigure 20. The decryption routine\n\nAs mentioned, the keylogger uses the Rijndael algorithm and the secret key is salted with\nthe Unicode string \"099u787978786\", also hardcoded.\n\nFigure 21. The keylogger uses Rijndael algorithm\n\nOut of curiosity, I copied the decryption part of the code, modified it accordingly and\ncompiled it in MS Visual Studio, and of course the decryption was successful. (sorry, I need\nto blur the credentials :))\n\n\n-----\n\nFigure 22. The decrypted email and FTP credentials\n\nThey appear to be email accounts on compromised systems. The emails sent to this inbox\nare rerouted automatically to the attacker's Gmail account.\n\nFigure 23. Emails are rerouted to the attacker's own email address\n\n**CONCLUSION**\n\nPerhaps the attacker knows that the HawkEye keylogger can be easily cracked, and to\nprotect their own email credentials, they've hijacked a compromised email account as the\ninitial receiver that eventually forward emails to the attacker's own email address.\n\n\n-----\n\nWe have reported the compromised email accounts to their rightful owners, in order for\nthem to change their passwords and remove the attacker's email address from their reroute\nmessage settings.\n\nSince this was written, we received similar spam messages with RTF attachments but this\ntime containing the CVE-2012-0158 exploit. The payload is the same keylogger but they\nhave used different email credentials.\n\nThe two vulnerabilties used in these attacks are old, but still widely used in email attacks.\nAs usual, it is advisable to update your systems with the latest patches, to protect you from\nthese old exploits used by cybercriminals. Trustwave Secure Email Gateway's AMAX\n(Advanced Malware and Exploit Detection) was able to detect these attached RTF exploit in\nthe email gateway.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-07-01 - How I Cracked a Keylogger and Ended Up in Someone's Inbox.pdf"
    ],
    "report_names": [
        "2016-07-01 - How I Cracked a Keylogger and Ended Up in Someone's Inbox.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535665,
    "ts_updated_at": 1743041140,
    "ts_creation_date": 1653753260,
    "ts_modification_date": 1653753260,
    "files": {
        "pdf": "https://archive.orkl.eu/3698f9471de8ff1dbe26b58bef9d9db16dbfe8c4.pdf",
        "text": "https://archive.orkl.eu/3698f9471de8ff1dbe26b58bef9d9db16dbfe8c4.txt",
        "img": "https://archive.orkl.eu/3698f9471de8ff1dbe26b58bef9d9db16dbfe8c4.jpg"
    }
}