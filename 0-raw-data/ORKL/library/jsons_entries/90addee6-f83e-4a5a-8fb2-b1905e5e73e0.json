{
    "id": "90addee6-f83e-4a5a-8fb2-b1905e5e73e0",
    "created_at": "2022-10-25T16:48:19.127737Z",
    "updated_at": "2025-03-27T02:05:37.592082Z",
    "deleted_at": null,
    "sha1_hash": "1199aef590d01265442e28cf5727240f2f37ae25",
    "title": "",
    "authors": "",
    "file_creation_date": "2015-07-03T23:25:04Z",
    "file_modification_date": "2015-07-03T23:25:04Z",
    "file_size": 882759,
    "plain_text": "# 2015 2015\n\nInsight in to advances of adversary tactics, techniques and procedures\nthrough analysis of an attack against an organisation in the Asia Pacific\nregion.\n\n|Col1|June 28 2015 2015|\n|---|---|\n\n\n## June 28\n\n# 2015 2015\n\n\nD r a g o n T h r e a t L a b s H o n g K o n g Author: Dan\n\n\n-----\n\n### Contents\n\nIntroduction ........................................................................................................................................ 2\n\nPhishing with a hook and LINE ............................................................................................................ 2\n\nMocelpa .............................................................................................................................................. 4\n\nDetection & mitigation ..................................................................................................................... 10\n\nAppendix ........................................................................................................................................... 12\n\nContact .............................................................................................................................................. 13\n\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 1\n\n\n-----\n\n#### Introduction\nThe summer months dawn on us the financial year comes to a close. It is in the run up to this time\nthat most organisations see an increase in targeted attack activity.\n\nWe begin by reading news of an attack against the Taiwanese Government. Whilst we would prefer\nto disassociate ourselves with APT attacks against Governments our interest was piqued by a\nparticular blog written by our friends over at TrendMicro[1]. There were several things that struck us\nas both interesting and concerning about the details; a threat actor known to operate in South East\nAsia is now using secure sockets layer (“SSL”) encryption in their malware. SSL is typically used to\nencrypt data between the client and the server, thus making the content unreadable by any systems\nsitting between the two end points, and significantly raising the cost of defence. Without the use of\nSSL interception traditional IDS/IPS systems will cease to detect compromised systems. For large\norganisations the cost of this can run from the hundreds of thousands in to the millions of dollars.\nFor smaller organisations this single expense easily can run over the yearly security budget. Whilst a\nsmall, fun loving, not-for-profit group of misfits such as ourselves are not concerned with financial\ncosts we are concerned with an adversary’s change in behaviour, especially the use of encryption have Snowden’s actions[2] really affected the entire world?\n\n#### Phishing with a hook and LINE\nAs most spearphishing stories begin, Mary receives an email from John, except the email isn’t really\nfrom John, it’s from somebody pretending to be John in an attempt to gain Mary’s trust so that she’ll\nopen an email attachment that contains malware.\n\n1 The blog posting has unfortunately since been removed\n2 Snowden’s actions: we don’t care what effect he had - he’s still a prick. Welcome to Hong Kong \n\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 2\n\n\n-----\n\nIn this case ‘Mary’ is an employee of the Taiwanese Government and ‘John’ is supposedly a coworker also working for the Government. Based on the format of the email addresses it appears\nthat the attacker has some working knowledge of their target organisation but the body of the email\ndoes not give away further ‘guilty knowledge’ and simply asks the user to open the attachment to\ninstall LINE, a popular instant messaging program used in millions of people in Taiwan.\nThe malware is very simply contained within a zip file. The zip file does not have a password.\nFortunately in this case it seems that this email was noticed as suspicious by the recipient and they\nuploaded it to a popular anti-virus website.\n\nThis method of delivering malware isn’t uncommon in Asia. Due to a lack of general awareness in IT\nsecurity many users fall victim to such attacks be it APT or common crimeware. It is of course good\npractice to block all executable files in email attachment (.exe, .bat, .cmd, .scr, .jar etc.). Whilst this\nmethod isn’t the most sophisticated don’t let it fool you – it proves to be very effective.\n\nA further look into the email headers shows us that the email did not come from a co-worker; it in\nfact came from somebody outside of the organisation.\n\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 3\n\n\n-----\n\nMany organisations worldwide complain of spearphishes coming from HiNet IP ranges and\nbrandishing the DreamMail X-mailer. Unfortunately this combination of characteristics is very\ncommon in Asia and thus does not always make a good heuristic detection rule.\n\n#### Mocelpa\nUpon first look we notice that the executable file contained with the zip archive is fairly small being\n[just 11 Kilobytes in size. Up until recently Mocelpa had a very low detection rate, being detected by](https://malwr.com/analysis/ZWEwYWM3YjM1MzNmNDg1MWE0MGM3YjQ2MjQ3YjMzOTY/)\njust 1 out of 57 anti-virus engines tested against.\n\nThe first characteristic we notice is the lack of bootstrap mechanism. Should the user logout,\nshutdown or reboot the malware will not survive. This is interesting behaviour and suggests that the\nmalware author is confident in Mocelpa’s stability.\n\nTo begin with I will describe the network functions, since my main interest in this malware stems\nfrom the use of SSL. An initial glance at network traffic produced by Mocelpa reveals something\ninteresting and surprising: an SSL handshake followed by quite blatant non-SSL traffic.\n\nDelving into the disassembly behind the malware we can see that this SSL handshake is clearly faked\nand generated using hardcoded values within the malware.\n\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 4\n\n\n-----\n\nIn this situation it would appear that the author has simply copy & pasted values from a packet\ncapture and in doing so they have revealed what is most likely the exact time and date that the\npacket was generated.\n\nInterestingly there is one identifiable string in the data: www.apple.com. I think we have just\ndiscovered why this malware is called Mocelpa: ApleCom <> Mocelpa. This suggests that the\nindividual who named the malware knew that the connection data was hardcoded and not actually\nencrypted. Those of you who are familiar with IDS/IPS and network detection will know that this\nbehaviour makes a highly reliable signature. In all Mocelpa samples we analysed (see appendix for\nMD5’s) this string remained the same.\n\nNow that we know the traffic data is hardcoded let’s take a look at what follows the ‘SSL’ handsake.\n\nFirstly, Mocelpa grabs the MAC address of the machine and runs it through an encoding routine. The\nencoding performed simply increases each number/character in the MAC address by 1. This value is\nthen modified, by inserting hardcoded hexadecimal values at the beginning and end of the string.\n\nBefore connecting to the command and control server Mocelpa looks up the proxy server that is\nconfigured in Internet Explorer. This can be found in the registry under\n_“HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings” in the_\n_“ProxyServer” key. It appears that at least one of the samples we analysed (see appendix) has a bug[3]_\nand will fail to connect to the command and control server unless the system is configured to use a\nproxy server. Failure to connect to the command and control server results in the malware sleeping\nfor 5 minutes before trying again.\n\n3 Thanks to Tillmann Werner for pointing this out\n\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 5\n\n\n-----\n\nUpon connecting to the command and control server several exchanges of information take place.\nDuring the initial ‘SSL’ connection (described above) certain responses are expected from the\ncommand and control server. These responses are only validated by length and in fact can contain\nany data; the first response should be 3162 bytes in length and the second 59 bytes.\n\nThe encoded MAC address is also sent to the command and control server. It is likely that the\nattacker’s use this value to identify unique victims. Once the connection has been established\ncommand and control can take place.\n\nThe command and control functionality is very simple, however the structure is not. From this very\nhigh-level view we can see that this is not as easy as a simple IF, NOT, THEN structure.\n\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 6\n\n\n-----\n\nUltimately this breaks to commands and sub-commands, denoted by a specific packet structure.\n\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 7\n\n\n-----\n\nThe functionality can be broken down into the following groups:\n\n  - **0x3: Execute command**\n\n`o` Uses cmd.exe to execute a command, logs the output and sends it back to the c2\n\nserver\n\n  - **0x0A: File operations**\n\n`o` Sub-options:\n\n         - **0x0B: Create a file (filename specified by in the data packet) in the user’s**\ntemporary directory\n\n         - **0x0C: Write data (specified in the data packet) to the currently open file**\n\n         - **0x0D: Open the file that was created/written to, perform an MD5 hash on**\nthe contents and compare it to the attacker specified MD5 (contained within\nthe data packet)\n\nThe structure behind the protocol is fairly simple and involves packet data being passed through a\ndecoding routine before being processed. For example, a decoded packet executing C2 command\n0x0A, sub-command 0x0D looks like the following:\n\nThe data decoding routine begins by taking a series hardcoded values and appending it to the\nbeginning of the data, it then proceeds to run an XOR operation against each byte of the packet in\nreverse order, for example:\n\nClearly at this stage we can see that this implant does not use SSL.\nServer-side protocol analysis has unfortunately been thwarted by a lack of response from the\ncommand and control servers so the examples are above are just that: examples. In any case we are\n\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 8\n\n\n-----\n\nconfident in saying that responses from live command and control servers are unlikely to be fully\nstatic and thus creating a reliable IDS signature or detection heuristic would be challenging at best.\n\nDuring the process of analysing the malware samples we created a fully functioning command and\ncontrol server module. After careful consideration we have decided not to release the code for this.\n\nUltimately Mocelpa is a simple downloader with basic functionality. Given the seemingly\nunnecessary amount of complexity involved and the obscure method of verifying file download\nsuccess we would be quick to assume that this was written by an inexperienced programmer, but\nthere are in fact a number of reasons why such methods were used in the development of this\nimplant. Taking into consideration things like reverse engineering, network detection devices, antivirus and human ‘hunter’ teams it does not take much thought to theorise why the codebase and\nfunctionality are somewhat creative.\n\nStill, through this extra code it does not make Mocelpa less detectable – in fact quite the opposite.\n\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 9\n\n\n-----\n\n#### Detection & mitigation\nThis implant can be detected at both disk and network level. In order to help organisations protect\nthemselves we have created a number of network IDS rules and disk-scan rules that can be used\nwith Snort and Yara. Rules are provided in a best-effort basis and we cannot vouch for their\nefficiency in your environment.\n\n**Mocelpa YARA disk signature**\n```\nrule apt_win_mocelpa {\nmeta:\n   author = \"@int0x00\"\n   description = \"APT malware; Mocelpa, downloader.\"\nstrings:\n   $mz = {4D 5A}\n   $ssl_hello = {16 03 01 00 6B 01 00 00 67 03 01 54 B4 C9 7B 4F\nCF BC 5A 01 EC 4A 73 C8 6D BB C0 86 9F 7B A9 08 6A 60 37 05 81 97 1A\nC8 9F 45 E5 00 00 18 00 2F 00 35 00 05 00 0A C0 13 C0 14 C0 09 C0 0A\n00 32 00 38 00 13 00 04 01 00 00 26 00 00 00 12 00 10 00 00 0D 77 77\n77 2E 61 70 70 6C 65 2E 63 6F 6D 00 0A 00 06 00 04 00 17 00 18 00 0B\n00 02 01 00}\ncondition:\n   ($mz at 0) and ($ssl_hello)\n}\n\n```\n**Mocelpa SNORT network beaconing**\n```\nalert tcp $HOME_NET any -> $EXTERNAL_NET 443 (msg:\"APT MALWARE –\nMocelpa beacon\"; flow:established,to_server; content:\"| 16 03 01 00\n6B 01 00 00 67 03 01 54 B4 C9 7B 4F CF BC 5A 01 EC 4A 73 C8 6D BB C0\n86 9F 7B A9 08 6A 60 37 05 81 97 1A C8 9F 45 E5 00 00 18 00 2F 00 35\n00 05 00 0A C0 13 C0 14 C0 09 C0 0A 00 32 00 38 00 13 00 04 01 00 00\n26 00 00 00 12 00 10 00 00 0D 77 77 77 2E 61 70 70 6C 65 2E 63 6F 6D\n00 0A 00 06 00 04 00 17 00 18 00 0B 00 02 01 00|\"; classtype:trojanactivty; sid:YOUR_SID; rev:14062015)\n\n```\n**Mocelpa SNORT C2 server IP** **#1**\n```\nalert ip $HOME_NET any <> 213.179.57.178 any (msg:\"APT MALWARE –\nMocelpa C2 address\"; classtype:trojan-activity; sid:YOUR_SID; rev:\n14062015;)\n\n```\n**Mocelpa SNORT C2 server IP** **#2**\n```\nalert ip $HOME_NET any <> 128.91.34.188 any (msg:\" APT MALWARE –\nMocelpa C2 address\"; classtype:trojan-activity; sid:YOUR_SID; rev:\n14062015;)\n\n```\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 10\n\n\n-----\n\n**Mocelpa SNORT C2 server IP** **#3**\n```\nalert ip $HOME_NET any <> 200.87.48.4 any (msg:\"APT MALWARE –\nMocelpa C2 address\"; classtype:trojan-activity; sid:YOUR_SID; rev:\n14062015;)\n\n```\n**Mocelpa SNORT C2 server IP** **#4**\n```\nalert ip $HOME_NET any <> 128.91.34.175 any (msg:\"APT MALWARE –\nMocelpa C2 address\"; classtype:trojan-activity; sid:YOUR_SID; rev:\n14062015;)\n\n```\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 11\n\n\n-----\n\n#### Appendix\nThe following artefacts were found during the investigation\n\n**MD5s** **Network artefacts**\n6e4e030fbd2ee786e1b6b758d5897316 `213.179.57.178`\n27f5b6e326e512a7b47e1cd41493ee55[4] `128.91.34.188`\n```\n                     128.91.34.175\n```\n548884eabebef0081dd3af9f81159754\n```\n                     200.87.48.4 \n```\n05bc4a9b603c1aa319d799c8fba7a42a\ncdf0e90b0a859ef94be367fdd1dd98c6\n\n4 “Broken”; will not connect to the internet unless a system proxy is configured\n\n|6e4e030fbd2ee786e1b6b758d5897316 27f5b6e326e512a7b47e1cd41493ee554 548884eabebef0081dd3af9f81159754 05bc4a9b603c1aa319d799c8fba7a42a cdf0e90b0a859ef94be367fdd1dd98c6|213.179.57.178 128.91.34.188 128.91.34.175 200.87.48.4|\n|---|---|\n\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 12\n\n\n-----\n\n#### Contact\nFor all questions relating to the publication or specifics in this document please contact us via one of\nthe following methods:\n\n[Twitter: @dragonthreatlab](https://twitter.com/DragonThreatLab)\n[Website: http://dragonthreat.blogspot.hk](http://dragonthreat.blogspot.hk/)\n[Email: dragonthreatlabs@gmail.com](mailto:dragonthreatlabs@gmail.com)\n\nKind regards,\n\nDan (@int0x00)\nDragon Threat Labs\n\n\nD r a g o n T h r e a t L a b s H o n g K o n g Page 13\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2015/2015.06.28.APT_on_Taiwan/DTL-06282015-01.pdf"
    ],
    "report_names": [
        "DTL-06282015-01"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716499,
    "ts_updated_at": 1743041137,
    "ts_creation_date": 1435965904,
    "ts_modification_date": 1435965904,
    "files": {
        "pdf": "https://archive.orkl.eu/1199aef590d01265442e28cf5727240f2f37ae25.pdf",
        "text": "https://archive.orkl.eu/1199aef590d01265442e28cf5727240f2f37ae25.txt",
        "img": "https://archive.orkl.eu/1199aef590d01265442e28cf5727240f2f37ae25.jpg"
    }
}