{
    "id": "6be7f7b7-4c24-4a3f-b3ad-93edacb4230a",
    "created_at": "2023-01-12T15:09:18.925686Z",
    "updated_at": "2025-03-27T02:05:33.834549Z",
    "deleted_at": null,
    "sha1_hash": "52daa13f2106a6ea6f96256ddd55eb6b921cfc5b",
    "title": "2017-09-15 - Deep Analysis of New Poison Ivy-PlugX Variant - Part II",
    "authors": "",
    "file_creation_date": "2022-05-29T10:40:53Z",
    "file_modification_date": "2022-05-29T10:40:53Z",
    "file_size": 606176,
    "plain_text": "# Deep Analysis of New Poison Ivy/PlugX Variant - Part II\n\n**[blog.fortinet.com/2017/09/15/deep-analysis-of-new-poison-ivy-plugx-variant-part-ii](https://blog.fortinet.com/2017/09/15/deep-analysis-of-new-poison-ivy-plugx-variant-part-ii)**\n\nSeptember 15, 2017\n\nThreat Research\n\nBy [Xiaopeng Zhang | September 15, 2017](https://blog.fortinet.com/blog/search?author=Xiaopeng+Zhang)\n\n## Background\n\n[This is the second part of the FortiGuard Labs analysis of the new Poison Ivy variant, or](https://fortiguard.com/)\nPlugX, which was an integrated part of Poison Ivy’s code. In the [first part of this analysis we](http://blog.fortinet.com/2017/08/23/deep-analysis-of-new-poison-ivy-variant)\nintroduced how this malware was installed onto victim’s systems, the techniques it used to\nperform anti-analysis, how it obtained the C&C server’s IP&Port from the PasteBin website,\nand how it communicated with its C&C server.\n\nWhat we didn’t talk much about in that first blog was the control-commands that are used by\nthis malware, partly because only a few of those commands were used during our analysis.\nHowever, as you may know, RAT malware usually has many control-commands so that\nattackers can effectively remotely control a victim’s machine.\n\n\n-----\n\nSo, after our initial analysis, we monitored the C&C servers and captured their packets.\nFortunately, we were able to successfully collect enough attacks and packets so that we\ncould obverse and document its behavior. In this analysis, I’m going to focus on the controlcommands used by the C&C server as it attempts to penetrate the victim’s network by\nexploiting vulnerabilities.\n\nAlthough the C&C servers have now been shut down, we found a way to decrypt the\ncommunication data from the captured packets in order to analyze its behavior.\n\n[As per my analysis, this variant of Poison Ivy eventually launches the MS17-010 (Eternal](https://technet.microsoft.com/en-us/library/security/ms17-010.aspx)\nBlue) attack against the machines located inside the victim’s LAN. Let’s now take a look at\nhow it performs this exploit.\n\n## Manage multiple modules\n\nBefore going on, however, we have to talk about how the decrypted modules are managed.\nFrom Part I we know that there are six modules in the svchost.exe program, which are\nconnected by a doubly linked list. There is a module node in each of modules, as well as in\nsvchost.exe. The module node is added into the doubly linked list when its module code is\ninitialized. The header of the doubly linked list is in a global variable located in svchost.exe’s\nmemory space (qword_2345D0 with base address 0x220000 in my case). Below is a\nmodule node’s structure, along with some corrections to the one shown in the Part I of this\nanalysis.\n\n\n-----\n\nThe first module (which was injected into svchost.exe when svchost.exe started) is executed\nin svchost.exe, and was the first one added into the doubly linked list. I call it the host\nmodule.\n\nI named these module1, module2, etc. according to the order in which they are added into\nthe doubly linked list, The six modules are decrypted by the host module.\n\nFigure 1 shows a view of the module node of the host (svchost.exe) in memory.\n\n_Figure 1. View of the host module node in memory_\n\nThe host module node’s address is 0x334A20. The previous node’s address is 0x165068,\nand the next one is 0x51F280. The host module’s index is 0, and its module base address is\n0x220000. Finally, the function table’s address is 0x334A60. Module index is important\nbecause it is also a part of the Control-Commands. We will talk more about this later.\n\nSeveral functions in the host module are used to manage this doubly linked list. To manage\nthe doubly linked list between these different modules, the author of the malware designed a\nnamed sharing memory (by calling API CreateFilemappingA) where the addresses of the\nmanager functions are saved. So whenever it wants to manage the doubly linked list, it only\nneeds to access all these functions from the sharing memory. BTW, the name of this sharing\nmemory is created by calculating two current process IDs (by calling API\n_GetCurrentProcessID, i.e. svchost.exe PID)._\n\n\n-----\n\nIn Figure 2, you can see how the named sharing memory is created, and where the manager\nfunctions are saved in the sharing memory. The functions in [rax+8] and [rax+18] are called\nfrequently during handling C&C commands. [rax+18] is the function that gets the module\nnode from the doubly linked list using the module index, and sets module flag. [rax+8] is\nused to restore the module flag.\n\n\n-----\n\n_Figure 2. Code snippet of adding management functions into the named sharing memory_\n\nHere is the modules’ information in my test environment:\n\n## Control-Command Packet Structure\n\nIn order to easily understand the C&C packets, I will explain the packet structure here. As I\nexplained in the first blog, the packet payload is encrypted. Through analyzing its decryption\nfunction, I was able to write a python function to decrypt the data. This is the same function\nthat the host module used to decrypt those six modules, as well as the C&C server IP&Port\nfrom the PasteBin website, but different decryption keys are used.\n\nPython decryption function:\n\nThe decrypted packet consists of two parts. The first 14H bytes are the header, and the data\nstarts at offset 14H. The packet structure looks like this:\n\n[In the first blog I introduced commands “030001” and “030003”. Please refer here for more](http://blog.fortinet.com/2017/08/23/deep-analysis-of-new-poison-ivy-variant)\ndetails. By the way, the malware uses big-endian byte order to save its data. The control\ncommand is a Dword value, whose high 16 bits are the module index, and the low 16 bits is\n\n\n-----\n\na kind of code branch switch. Once the malware gets the command it retrieves the module\nnode from the doubly linked list by matching the module index. It then calls the functions of\nthat module to handle this command data.\n\n_Figure 3. All packets from C&C server are dispatched from here_\n\nFigure 3 shows the code snippet used for dispatching the C&C packets to the correct module\nfor processing. After “call sub_193370” we got the decrypted C&C server packet in\n\n[rbp+arg_8]. “call sub_191C44” is used to get the management functions in rax from the\nnamed sharing memory. “call qword ptr [rax+18h]” is used to call one management function\nto get the module node from the doubly linked list using the module index in rcx i.e. high 16\nbits of command. “call qword ptr [r8]” calls the first function of the function table to process\nthe received packet.\n\nFrom the above analysis you should now be able to clearly see the entire process of how the\nmalware processes the C&C server’s packets.\n\n## Installing the “00000025” module\n\nIn my captured traffic, I was able to see many control commands. They include “00030001”,\n“00030002”, “00030003”, “00030004”, “00000003”, “00000001”, “00250000”, etc.\n\n\n-----\n\nSo let s now take a look at what the 00000003 command is used for. Figure 4 shows the\noriginal received packet and the decrypted data.\n\n_Figure 4. “00000003” command data_\n\nFrom the command “00000003” details we know that this packet is going to be passed to the\nhost module (its index is 0), and then be processed by the first function in the function table\nand the “0003” branch.\n\nIt gets the sub-command (“00000025”) as the module index to look for in that doubly linked\nlist. So far, no module’s index is 0x25. It then replies to the C&C server with sub-command\n“00000040”. If the 0x25 module node exists, the sub-command is “00000000”.\n\nThe C&C server then sends back command “00000001” with a new module attached. Below\nis part data of this packet after decryption, where you can see that the sub-command is\n“00000025”. In code branch “0001” it decompresses the received module, then gets its code\ninitialized, and finally adds it into the doubly linked list. This module’s index is 0x25, so I call it\nModule25.\n\n\n-----\n\nIt later sends command “00000001” with sub-command “00000000” to the C&C server to let\nit know that the 0x25 module was installed successfully. This module will be used to\npenetrate the victim’s network.\n\nBTW, this module’s information in my test machine is:\n\n## Penetrating the victim’s LAN using EternalBlue\n\nI’m sure that the C&C server sent commands to get the victim’s network configuration (my\nlocal IP, Gateway, DNS server), though I did not catch them.\n\nFigure 5 is the screenshot of the network configuration of my test machine.\n\n\n-----\n\n_Figure 5. Network information_\n\nThe C&C server controls the malware to scan the victim’s network segment, including local\nIP, Gateway, and DNS server. For example, because my DNS server is 172.30.1.105 it’s\ngoing to scan the 172.30.1.105/24 network segment.\n\nThe C&C server sends the “00000025” command with the destination IP and Port for further\nattack. By decrypting “00000025” packets we are able to see its data, shown below.\n\nFrom this data it is easy to see that there are IP addresses from three local machines. The\nsub-command “000001BD” refers to port 445.\n\nModule25 processes this packet, pulls the IP and port information from the packet, and then\nmakes a connection to it. If any error occurs, it sends the status to the C&C server.\n\nOnce successfully connected to the destination machine, the malware then serves as a\nmiddleman that keeps transferring the two sockets’ data between the C&C server and the\ndestination machine (like man-in-the-middle does). In module3 we also see its debug output\nstrings “SoTransfer(%p<=>%p)...\\r\\n” and “SoTransfer(%p<=>%p) quit!\\r\\n”. Figure 6 and 7\nshow the attack view in Wireshark.\n\n\n-----\n\n_Figure 6. EternalBlue attack packets_\n\n_Figure 7. EternalBlue attack packet payload_\n\n\n-----\n\nModule25 makes the connection to the destination IP and then calls module3 s function to\nperform the transfer work by calling the recv() and send() functions. In module3 function\n_sub_1935A8 it creates two threads to do that. One thread receives data from the C&C_\nsocket and sends it to the destination machine, and another one receives data from the\ndestination machine and forwards it to the C&C server. Figure 8 shows the code snippet for\nwhat I explained about the two threads.\n\n_Figure 8. Two threads to transfer packets_\n\n## Conclusion\n\nBased on our analysis, this new Poison Ivy variant takes advantage of the EternalBlue\nexploit to spread. Once one system is infected by this variant, other systems on the same\nnetwork are likely to be infected by the compromised system.\n\n## Solution\n\nUsers should apply Microsoft’s patch for [MS17-010.](https://technet.microsoft.com/en-us/library/security/ms17-010.aspx)\n\nFortinet IPS signature MS.SMB.Server.SMB1.Trans2.Secondary.Handling.Code.Execution\nwas released in March 2017 to protect our customers against the EternalBlue attack.\n\n_[Sign up for weekly Fortinet FortiGuard Labs Threat Intelligence Briefs and stay on top of the](http://ftnt.net/2iT7Mcp%C2%A0)_\n_newest emerging threats._\n\n## Related Posts\n\n\n-----\n\nCopyright © 2022 Fortinet, Inc. All Rights Reserved\n\n[Terms of ServicesPrivacy Policy](https://www.fortinet.com/corporate/about-us/legal.html)\n| Cookie Settings\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-09-15 - Deep Analysis of New Poison Ivy-PlugX Variant - Part II.pdf"
    ],
    "report_names": [
        "2017-09-15 - Deep Analysis of New Poison Ivy-PlugX Variant - Part II.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536158,
    "ts_updated_at": 1743041133,
    "ts_creation_date": 1653820853,
    "ts_modification_date": 1653820853,
    "files": {
        "pdf": "https://archive.orkl.eu/52daa13f2106a6ea6f96256ddd55eb6b921cfc5b.pdf",
        "text": "https://archive.orkl.eu/52daa13f2106a6ea6f96256ddd55eb6b921cfc5b.txt",
        "img": "https://archive.orkl.eu/52daa13f2106a6ea6f96256ddd55eb6b921cfc5b.jpg"
    }
}