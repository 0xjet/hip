{
    "id": "bdcda660-0199-411c-bc44-57c3acea5549",
    "created_at": "2023-05-06T02:09:07.247846Z",
    "updated_at": "2025-03-27T02:05:35.529705Z",
    "deleted_at": null,
    "sha1_hash": "5f0535a9c57987d4f33b76c6ed7e13ef57d6db8b",
    "title": "2023-04-06 - Neutralizing Tofsee Spambot – Part 3 - Network-based kill switch",
    "authors": "",
    "file_creation_date": "2023-05-05T01:55:33Z",
    "file_modification_date": "2023-05-05T01:55:33Z",
    "file_size": 411825,
    "plain_text": "# Neutralizing Tofsee Spambot – Part 3 | Network-based kill switch\n\n**[spamhaus.com/resource-center/neutralizing-tofsee-spambot-part-3-network-based-kill-switch/](https://www.spamhaus.com/resource-center/neutralizing-tofsee-spambot-part-3-network-based-kill-switch/)**\n\nApril 6, 2023\n\nHere's the final post in our three-part series on how to protect against Tofsee malware. This\nblog post concentrates on using a network kill switch - causing an out-of-bounds read error,\nleading to Tofsee crashing.\n\n## Playing catch-up?\n\nIf you missed the first two posts in this series, they focus on malware vaccines. These are\nproactive measures helping prevent malware infections by patching vulnerabilities in the\nsystem or blocking known attack vectors. Malware vaccines are not dissimilar to medical\nvaccines that provide the body immunity to a particular disease.\n\n[The first malware vaccine revealed by our researchers, concentrated on the binary file and](http://www.spamhaus.com/resource-center/neutralizing-tofsee-spambot-part-1-binary-file-vaccine)\n[the second one centered around the InMemoryConfig store.](http://www.spamhaus.com/resource-center/neutralizing-tofsee-spambot-part-2-inmemoryconfig-store-vaccine)\n\n## What is a malware kill switch?\n\nA malware kill switch is a feature that some malware authors include in their code that\nenables them to shut down the malware or prevent it from causing harm under certain\ncircumstances, such as if the malware is spreading too quickly, causing damage to critical\nsystems, or should their operations be tracked or compromised.\n\nA good example is the case of the WannaCry ransomware attack in 2017\n\n[https://www.bbc.co.uk/news/technology-41753022]; a researcher discovered a kill switch\nthat the cybercriminal had built into the malware. By registering a specific domain name, the\nresearcher could trigger the kill switch and stop the malware from spreading further.\n\n## What is a network-based kill switch?\n\nIn some cases, security researchers or organizations can develop a network-based kill\nswitch for a specific malware threat. This reactive measure allows security experts to\nremotely disable or shut down malware infections, allowing them to neutralize the threat\nquickly and effectively if it is detected.\n\nWhile using a network-based malware kill switch can be an effective way to limit the damage\ncaused by malware, it is key to note that it may not be a foolproof solution. Malware can\nevolve rapidly, and attackers may be able to find ways to work around a kill switch or develop\n\n\n-----\n\nnew malware that is not vulnerable to it. Therefore, it is essential to use a variety of security\nmeasures, such as anti-malware software, firewalls, and regular security updates, to protect\nagainst malware infections.\n\n## How can a network kill switch be implemented for Tofsee?\n\nOne way to render Tofsee useless and kill it without access to the remote infected machine is\nto locate a bug in its binary code and crash the malware.\n\nThe first part of this process is to get our data parsed by Tofsee, and to do this, we need to\nfollow its protocol specification.\n\n## Tofsee’s protocol specification\n\nCommunication is bi-directional and encrypted using a custom algorithm that requires two\nstate keys. These state keys are specific to each SocketConnection in Tofsee and are\nmodified based on each Transmission Control Protocol (TCP) data transfer between the\nbotnet command and control server (C&C) and the infected bot. This is known as rolling key\nencryption.\n\n**_Encryption Algorithm_**\n\nTofsee has a complex way of communicating with a C&C – it sends various structures to\n“latch” the connection with the C&C server. To keep this blog post as short and sweet as\npossible, we will only reference the relevant ones required as an attack vector to crash the\nbinary.\n\nOne is operation number 2 (OP2) the receive resource command.\n\nTofsee packets are encapsulated in a header packet defined below:\n\n\n-----\n\n**_Encapsulated packet for OP2_**\n\n## Taking advantage of this vulnerability\n\nWe can exploit this lack of a cross-check, i.e., in the code of the CRC32 hash function, where\nthe length of data is not bound-checked, we can craft a packet with a size greater than the\nbuffer, causing an out-of-bounds read error, leading to a crash.\n\nWhen the CRC32 hash function is called to calculate the hash of the packet’s data, it\ncontinues reading and processing data from memory beyond the allocated buffer size,\npotentially crashing Tofsee. This function is present when an InmemoryConfig Struct is\nparsed and populated so that the resource received is stored in the memory.\n\n\n-----\n\n**_No length verification checks_**\n\nFor a 4-byte integer, we have the freedom of corrupting the len variable in the range of 0x000xFFFFFFFF. This high-range value in the ResourceStructure packet would look something\nlike this (complete with the manipulated len field):\n\nThis data is parsed by update_config_resource and eventually fed to the CRC32 hash\ncalculation routine. Due to the manipulated value of len, an out-of-bound read exception is\ncreated, ultimately resulting in the binary crashing.\n\n\n-----\n\n## Final words\n\nBoth the vaccines discussed in this series and the kill switch are essential tools for protecting\ncomputer systems from the ever-evolving threat of the Tofsee malware.\n\nWhile a malware vaccine can help to prevent infections, and a malware kill switch can help to\nminimize the damage caused by an ongoing attack, as we’ve previously discussed, neither\ntool is foolproof, and you should always use them in conjunction with other security\nmeasures.\n\nHappy coding.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-04-06 - Neutralizing Tofsee Spambot – Part 3 - Network-based kill switch.pdf"
    ],
    "report_names": [
        "2023-04-06 - Neutralizing Tofsee Spambot – Part 3 - Network-based kill switch.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1683338947,
    "ts_updated_at": 1743041135,
    "ts_creation_date": 1683251733,
    "ts_modification_date": 1683251733,
    "files": {
        "pdf": "https://archive.orkl.eu/5f0535a9c57987d4f33b76c6ed7e13ef57d6db8b.pdf",
        "text": "https://archive.orkl.eu/5f0535a9c57987d4f33b76c6ed7e13ef57d6db8b.txt",
        "img": "https://archive.orkl.eu/5f0535a9c57987d4f33b76c6ed7e13ef57d6db8b.jpg"
    }
}