{
    "id": "a36df521-4457-4698-9ed5-1c01fa88e72e",
    "created_at": "2023-01-12T15:01:53.635232Z",
    "updated_at": "2025-03-27T02:17:23.457267Z",
    "deleted_at": null,
    "sha1_hash": "e7fd734d93bee04c9239aa52243ae6d271af3be7",
    "title": "2022-03-15 - Anti-UPX Unpacking Technique",
    "authors": "",
    "file_creation_date": "2022-05-28T23:45:21Z",
    "file_modification_date": "2022-05-28T23:45:21Z",
    "file_size": 464589,
    "plain_text": "# JPCERT Coordination Center official Blog\n\n**blogs.jpcert.or.jp/en/2022/03/anti_upx_unpack.html**\n\n朝長 [秀誠 (Shusei Tomonaga)](https://blogs.jpcert.or.jp/en/shu_tom/)\n\nMarch 15, 2022\n\n## Anti-UPX Unpacking Technique\n\n[IoT](https://blogs.jpcert.or.jp/en/tags/iot/)\n\n[Email](http://10.10.0.46/mailto:?subject=Anti-UPX%20Unpacking%20Technique&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fen%2F2022%2F03%2Fanti_upx_unpack.html)\n\nMalware targeting Windows OS (PE format) has a variety of obfuscation and packing\ntechniques in place so that they complicate the code analysis processes. On the other hand,\nthere are only a few types of packing techniques for Linux-targeting malware (ELF format),\nand it is mainly UPX-based. This blog article explains the details of Anti-UPX Unpacking\ntechnique, which is often applied to Linux-targeting malware.\n\n### Malware with Anti-UPX Unpacking Technique\n\nThe most well-known malware using Anti-UPX Unpacking technique is Mirai and its variants,\nwhich target IoT devices. Figure 1 shows the headers of UPX-packed binary and Mirai. The\nnormal UPX packing uses “UPX!” as a magic number, while Mirai assigns a different value to\neach sample.\n\nFigure 1: UPX-packed binary (left) and Mirai header (right)\nUPX-packed binary contains the following information in the header. Normally, only “l_magic”\nis altered, but “p_filesize” and “p_blocksize” are also zero-padded in some samples.\n\n\n-----\n\n```\nstruct l_info    // 12 byte trailer in header for loader (offset 116)\n{\n  uint32_t l_checksum;\n  uint32_t l_magic;  // magic number = \"UPX!\"\n  uint16_t l_lsize;\n  uint8_t l_version;\n  uint8_t l_format;\n};\nstruct p_info    // 12-byte packed program header follows stub loader\n{\n  uint32_t p_progid;\n  uint32_t p_filesize;\n  uint32_t p_blocksize;\n};\n\n```\nBesides Mirai, there are many other types of malware using this technique, including\nBoSSaBot (seen around 2014), as well as some coin miners and SBIDIOT malware, more\nrecently. This is also applied to some types of malware which were used by Lazarus group.\nFigure 2 shows a part of ELF-VSingle’s code, which is associated with the group. The magic\nnumber is replaced with “MEMS”.\n\nFigure 2: ELF_VSingle header\n\n### Unpacking Anti-UPX Unpacking binary\n\nBinary based on Anti-UPX Unpacking technique cannot be unpacked using the normal upx\ncommand. However, it is actually easy to unpack it. In most cases, the only change made to\nsuch binary is its magic number “UPX!”. You can unpack it with upx command by changing\n\n\n-----\n\nthis value back to UPX! . Figure 3 shows the process of changing the magic number in\norder to unpack it using upx command.\n\n\n-----\n\nFigure 3: Example of unpacking binary\n\n\n-----\n\nWe have created a tool that enables unpacking binary with Anti-UPX Unpacking techniques.\nThis tool is intended for this purpose only, and it may not work otherwise.\n\n**JPCERTCC/upx-mod - GitHub** https://github.com/JPCERTCC/upx-mod/releases/tag/v4.00beta\n\nFigure 4: Sample use of upx_mod command\n\n### Detect Anti-UPX Unpacking Technique\n\nBinary packed with this technique can be identified manually, just by looking at the code. In\norder to avoid oversight, we recommend Yara-based automatic detection like below. This rule\ndoes not detect binary packed with normal UPX.\n\n\n-----\n\n```\nrule upx_antiunpack_elf32 {\n   meta:\n    description = \"Anti-UPX Unpacking technique to magic renamed for ELF32\"\n    author = \"JPCERT/CC Incident Response Group\"\n   condition:\n    uint32(0) == 0x464C457F and\n    uint8(4) == 1 and\n    (\n     (\n      for any magic in (uint32(filesize - 0x24)) : (magic == uint32(uint16(0x2C)\n* uint16(0x2A) + uint16(0x28) + 4)) and\n      not for any magic in (0x21585055, 0) : (magic == uint32(uint16(0x2C) *\nuint16(0x2A) + uint16(0x28) + 4))\n     )\n     or\n     (\n      for any magic in (uint32(filesize - 0x24)) : (magic ==\nuint32(uint16be(0x2C) * uint16be(0x2A) + uint16be(0x28) + 4)) and\n      not for any magic in (0x21585055, 0) : (magic == uint32(uint16be(0x2C) *\nuint16be(0x2A) + uint16be(0x28) + 4))\n     )\n    )\n}\nrule upx_antiunpack_elf64 {\n   meta:\n    description = \"Anti-UPX Unpacking technique to magic renamed for ELF64\"\n    author = \"JPCERT/CC Incident Response Group\"\n   condition:\n    uint32(0) == 0x464C457F and\n    uint8(4) == 2 and\n    (\n     (\n      for any magic in (uint32(filesize - 0x24)) : (magic == uint32(uint16(0x36)\n* uint16(0x38) + uint16(0x34) + 4)) and\n      not for any magic in (0x21585055, 0) : (magic == uint32(uint16(0x36) *\nuint16(0x38) + uint16(0x34) + 4))\n     )\n     or\n     (\n      for any magic in (uint32(filesize - 0x24)) : (magic ==\nuint32(uint16be(0x36) * uint16be(0x38) + uint16be(0x34) + 4)) and\n      not for any magic in (0x21585055, 0) : (magic == uint32(uint16be(0x36) *\nuint16be(0x38) + uint16be(0x34) + 4))\n     )\n    )\n}\n\n### In closing\n\n```\n\n-----\n\nMany attack groups use malware based on Anti-UPX Unpacking technique. It is easy to\nunpack such malware, but you may waste your time in unpacking process unless you notice\nthis feature beforehand. When you analyse packed ELF binary, we recommend checking first\nwhether it uses Anti-UPX Unpacking technique.\n\nShusei Tomonaga\n(Translated by Yukako Uchida)\n\n[Email](http://10.10.0.46/mailto:?subject=Anti-UPX%20Unpacking%20Technique&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fen%2F2022%2F03%2Fanti_upx_unpack.html)\n\nAuthor\n\n朝長 [秀誠 (Shusei Tomonaga)](https://blogs.jpcert.or.jp/en/shu_tom/)\n\nSince December 2012, he has been engaged in malware analysis and forensics\ninvestigation, and is especially involved in analyzing incidents of targeted attacks. Prior to\njoining JPCERT/CC, he was engaged in security monitoring and analysis operations at a\nforeign-affiliated IT vendor. He presented at CODE BLUE, BsidesLV, BlackHat USA Arsenal,\nBotconf, PacSec and FIRST Conference. JSAC organizer.\n\nWas this page helpful?\n\n0 people found this content helpful.\n\nIf you wish to make comments or ask questions, please use this form.\n\nThis form is for comments and inquiries. For any questions regarding specific commercial\nproducts, please contact the vendor.\n\nplease change the setting of your browser to set JavaScript valid. Thank you!\n\n[Back](https://blogs.jpcert.or.jp/en/2022/02/tsubame_overflow_2021-10-12.html)\n[Top](https://blogs.jpcert.or.jp/en/)\n[Next](https://blogs.jpcert.or.jp/en/2022/03/jsac2022report1.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-15 - Anti-UPX Unpacking Technique.pdf"
    ],
    "report_names": [
        "2022-03-15 - Anti-UPX Unpacking Technique.pdf"
    ],
    "threat_actors": [
        {
            "id": "26a04131-2b8c-4e5d-8f38-5c58b86f5e7f",
            "created_at": "2022-10-25T15:50:23.579601Z",
            "updated_at": "2025-03-27T02:00:55.50292Z",
            "deleted_at": null,
            "main_name": "TA551",
            "aliases": [
                "TA551",
                "GOLD CABIN",
                "Shathak"
            ],
            "source_name": "MITRE:TA551",
            "tools": [
                "QakBot",
                "IcedID",
                "Valak",
                "Ursnif"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "04e34cab-3ee4-4f06-a6f6-5cdd7eccfd68",
            "created_at": "2022-10-25T16:07:24.578896Z",
            "updated_at": "2025-03-27T02:02:10.286803Z",
            "deleted_at": null,
            "main_name": "TA551",
            "aliases": [
                "Gold Cabin",
                "Monster Libra",
                "Shathak",
                "TA551"
            ],
            "source_name": "ETDA:TA551",
            "tools": [
                "BokBot",
                "CRM",
                "Gozi",
                "Gozi CRM",
                "IceID",
                "IcedID",
                "Papras",
                "Snifula",
                "Ursnif",
                "Valak",
                "Valek"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "90f216f2-4897-46fc-bb76-3acae9d112ca",
            "created_at": "2023-01-06T13:46:39.248936Z",
            "updated_at": "2025-03-27T02:00:03.031127Z",
            "deleted_at": null,
            "main_name": "GOLD CABIN",
            "aliases": [
                "Shakthak",
                "TA551",
                "ATK236",
                "G0127",
                "Monster Libra"
            ],
            "source_name": "MISPGALAXY:GOLD CABIN",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "32a223a8-3c79-4146-87c5-8557d38662ae",
            "created_at": "2022-10-25T15:50:23.703698Z",
            "updated_at": "2025-03-27T02:00:55.528031Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Lazarus Group",
                "Labyrinth Chollima",
                "HIDDEN COBRA",
                "Guardians of Peace",
                "NICKEL ACADEMY",
                "Diamond Sleet"
            ],
            "source_name": "MITRE:Lazarus Group",
            "tools": [
                "RawDisk",
                "Proxysvc",
                "BADCALL",
                "FALLCHILL",
                "WannaCry",
                "HOPLIGHT",
                "TYPEFRAME",
                "Dtrack",
                "HotCroissant",
                "HARDRAIN",
                "Dacls",
                "KEYMARBLE",
                "TAINTEDSCRIBE",
                "AuditCred",
                "netsh",
                "ECCENTRICBANDWAGON",
                "AppleJeus",
                "BLINDINGCAN",
                "ThreatNeedle",
                "Volgmer",
                "Cryptoistic",
                "RATANKBA",
                "Bankshot",
                "Torisma",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "8bc1a044-a23b-4904-903c-13f463605cb3",
            "created_at": "2024-05-01T02:03:08.136237Z",
            "updated_at": "2025-03-27T02:05:17.415795Z",
            "deleted_at": null,
            "main_name": "NICKEL GLADSTONE",
            "aliases": [
                "Bluenoroff ",
                "CTG-6459 ",
                "Citrine Sleet ",
                "HIDDEN COBRA ",
                "Lazarus Group",
                "Sapphire Sleet ",
                "Stardust Chollima ",
                "APT38 "
            ],
            "source_name": "Secureworks:NICKEL GLADSTONE",
            "tools": [
                " Bankshot",
                " CATCH22",
                " CCGC_Proxy",
                " Cur1Agent",
                " Ratankba",
                " Server_TrafficForwarder",
                " Wcry",
                "AlphaNC"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a2b92056-9378-4749-926b-7e10c4500dac",
            "created_at": "2023-01-06T13:46:38.430595Z",
            "updated_at": "2025-03-27T02:00:02.831633Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Operation DarkSeoul",
                "APT38",
                "ATK117",
                "DEV-1222",
                "G0032",
                "APT 38",
                "Stardust Chollima",
                "APT-C-26",
                "ATK3",
                "Diamond Sleet",
                "Hidden Cobra",
                "Unit 121",
                "Subgroup: Bluenoroff",
                "NICKEL GLADSTONE",
                "DEV-0139",
                "Andariel",
                "Operation Troy",
                "COVELLITE",
                "TA404",
                "Lazarus group",
                "Dark Seoul",
                "G0082",
                "NewRomanic Cyber Army Team",
                "Bluenoroff",
                "Appleworm",
                "Nickel Academy",
                "COPERNICIUM",
                "Hastati Group",
                "Bureau 121",
                "Operation AppleJeus",
                "Whois Hacking Team",
                "Citrine Sleet",
                "Sapphire Sleet",
                "Group 77",
                "Labyrinth Chollima",
                "Operation GhostSecret",
                "BeagleBoyz"
            ],
            "source_name": "MISPGALAXY:Lazarus Group",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f32df445-9fb4-4234-99e0-3561f6498e4e",
            "created_at": "2022-10-25T16:07:23.756373Z",
            "updated_at": "2025-03-27T02:02:09.966155Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "APT-C-26",
                "ATK 3",
                "Appleworm",
                "Citrine Sleet",
                "DEV-0139",
                "Diamond Sleet",
                "Gleaming Pisces",
                "Gods Apostles",
                "Gods Disciples",
                "Group 77",
                "Guardians of Peace",
                "Hastati Group",
                "Hidden Cobra",
                "ITG03",
                "Jade Sleet",
                "Labyrinth Chollima",
                "Lazarus Group",
                "NewRomanic Cyber Army Team",
                "Operation 99",
                "Operation AppleJeus",
                "Operation AppleJeus sequel",
                "Operation Blockbuster: Breach of Sony Pictures Entertainment",
                "Operation CryptoCore",
                "Operation Dream Job",
                "Operation Dream Magic",
                "Operation Flame",
                "Operation GhostSecret",
                "Operation In(ter)caption",
                "Operation LolZarus",
                "Operation Marstech Mayhem",
                "Operation No Pineapple!",
                "Operation North Star",
                "Operation Phantom Circuit",
                "Operation Sharpshooter",
                "Operation Ten Days of Rain / DarkSeoul",
                "Operation Troy",
                "SectorA01",
                "Slow Pisces",
                "TA404",
                "TraderTraitor",
                "UNC2970",
                "UNC4034",
                "UNC4736",
                "UNC4899",
                "UNC577",
                "Whois Hacking Team"
            ],
            "source_name": "ETDA:Lazarus Group",
            "tools": [
                "3CX Backdoor",
                "3Rat Client",
                "3proxy",
                "AIRDRY",
                "ARTFULPIE",
                "ATMDtrack",
                "AlphaNC",
                "Alreay",
                "Andaratm",
                "AngryRebel",
                "AppleJeus",
                "Aryan",
                "AuditCred",
                "BADCALL",
                "BISTROMATH",
                "BLINDINGCAN",
                "BTC Changer",
                "BUFFETLINE",
                "BanSwift",
                "Bankshot",
                "Bitrep",
                "Bitsran",
                "BlindToad",
                "Bookcode",
                "BootWreck",
                "BottomLoader",
                "Brambul",
                "BravoNC",
                "Breut",
                "COLDCAT",
                "COPPERHEDGE",
                "CROWDEDFLOUNDER",
                "Castov",
                "CheeseTray",
                "CleanToad",
                "ClientTraficForwarder",
                "CollectionRAT",
                "Concealment Troy",
                "Contopee",
                "CookieTime",
                "Cyruslish",
                "DAVESHELL",
                "DBLL Dropper",
                "DLRAT",
                "DRATzarus",
                "DRATzarus RAT",
                "Dacls",
                "Dacls RAT",
                "DarkComet",
                "DarkKomet",
                "DeltaCharlie",
                "DeltaNC",
                "Dembr",
                "Destover",
                "DoublePulsar",
                "Dozer",
                "Dtrack",
                "Duuzer",
                "DyePack",
                "ECCENTRICBANDWAGON",
                "ELECTRICFISH",
                "Escad",
                "EternalBlue",
                "FALLCHILL",
                "FYNLOS",
                "FallChill RAT",
                "Farfli",
                "Fimlis",
                "FoggyBrass",
                "FudModule",
                "Fynloski",
                "Gh0st RAT",
                "Ghost RAT",
                "Gopuram",
                "HARDRAIN",
                "HIDDEN COBRA RAT/Worm",
                "HLOADER",
                "HOOKSHOT",
                "HOPLIGHT",
                "HOTCROISSANT",
                "HOTWAX",
                "HTTP Troy",
                "Hawup",
                "Hawup RAT",
                "Hermes",
                "HotCroissant",
                "HotelAlfa",
                "Hotwax",
                "HtDnDownLoader",
                "Http Dr0pper",
                "ICONICSTEALER",
                "Joanap",
                "Jokra",
                "KANDYKORN",
                "KEYMARBLE",
                "Kaos",
                "KillDisk",
                "KillMBR",
                "Koredos",
                "Krademok",
                "LIGHTSHIFT",
                "LIGHTSHOW",
                "LOLBAS",
                "LOLBins",
                "Lazarus",
                "LightlessCan",
                "Living off the Land",
                "MATA",
                "MBRkiller",
                "MagicRAT",
                "Manuscrypt",
                "Mimail",
                "Mimikatz",
                "Moudour",
                "Mydoom",
                "Mydoor",
                "Mytob",
                "NACHOCHEESE",
                "NachoCheese",
                "NestEgg",
                "NickelLoader",
                "NineRAT",
                "Novarg",
                "NukeSped",
                "OpBlockBuster",
                "PCRat",
                "PEBBLEDASH",
                "PLANKWALK",
                "POOLRAT",
                "PSLogger",
                "PhanDoor",
                "Plink",
                "PondRAT",
                "PowerBrace",
                "PowerRatankba",
                "PowerShell RAT",
                "PowerSpritz",
                "PowerTask",
                "Preft",
                "ProcDump",
                "Proxysvc",
                "PuTTY Link",
                "QUICKRIDE",
                "QUICKRIDE.POWER",
                "Quickcafe",
                "QuiteRAT",
                "R-C1",
                "ROptimizer",
                "Ratabanka",
                "RatabankaPOS",
                "Ratankba",
                "RatankbaPOS",
                "RawDisk",
                "RedShawl",
                "Rifdoor",
                "Rising Sun",
                "Romeo-CoreOne",
                "RomeoAlfa",
                "RomeoBravo",
                "RomeoCharlie",
                "RomeoCore",
                "RomeoDelta",
                "RomeoEcho",
                "RomeoFoxtrot",
                "RomeoGolf",
                "RomeoHotel",
                "RomeoMike",
                "RomeoNovember",
                "RomeoWhiskey",
                "Romeos",
                "RustBucket",
                "SHADYCAT",
                "SHARPKNOT",
                "SIGFLIP",
                "SIMPLESEA",
                "SLICKSHOES",
                "SORRYBRUTE",
                "SUDDENICON",
                "SUGARLOADER",
                "SheepRAT",
                "SierraAlfa",
                "SierraBravo",
                "SierraCharlie",
                "SierraJuliett-MikeOne",
                "SierraJuliett-MikeTwo",
                "SimpleTea",
                "SimplexTea",
                "SmallTiger",
                "Stunnel",
                "TAINTEDSCRIBE",
                "TAXHAUL",
                "TFlower",
                "TOUCHKEY",
                "TOUCHMOVE",
                "TOUCHSHIFT",
                "TOUCHSHOT",
                "TWOPENCE",
                "TYPEFRAME",
                "Tdrop",
                "Tdrop2",
                "ThreatNeedle",
                "Tiger RAT",
                "TigerRAT",
                "Trojan Manuscript",
                "Troy",
                "TroyRAT",
                "VEILEDSIGNAL",
                "VHD",
                "VHD Ransomware",
                "VIVACIOUSGIFT",
                "VSingle",
                "ValeforBeta",
                "Volgmer",
                "Vyveva",
                "W1_RAT",
                "Wana Decrypt0r",
                "WanaCry",
                "WanaCrypt",
                "WanaCrypt0r",
                "WannaCry",
                "WannaCrypt",
                "WannaCryptor",
                "WbBot",
                "Wcry",
                "Win32/KillDisk.NBB",
                "Win32/KillDisk.NBC",
                "Win32/KillDisk.NBD",
                "Win32/KillDisk.NBH",
                "Win32/KillDisk.NBI",
                "WinorDLL64",
                "Winsec",
                "WolfRAT",
                "Wormhole",
                "YamaBot",
                "Yort",
                "ZetaNile",
                "concealment_troy",
                "http_troy",
                "httpdr0pper",
                "httpdropper",
                "klovbot",
                "sRDI"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535713,
    "ts_updated_at": 1743041843,
    "ts_creation_date": 1653781521,
    "ts_modification_date": 1653781521,
    "files": {
        "pdf": "https://archive.orkl.eu/e7fd734d93bee04c9239aa52243ae6d271af3be7.pdf",
        "text": "https://archive.orkl.eu/e7fd734d93bee04c9239aa52243ae6d271af3be7.txt",
        "img": "https://archive.orkl.eu/e7fd734d93bee04c9239aa52243ae6d271af3be7.jpg"
    }
}