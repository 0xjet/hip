{
    "id": "65e58ae9-b132-4386-a43b-c3e0fe857c4e",
    "created_at": "2023-01-12T15:04:58.253431Z",
    "updated_at": "2025-03-27T02:05:43.771943Z",
    "deleted_at": null,
    "sha1_hash": "e3dea4f24b2d94e0625d2af627caaf5ec66addae",
    "title": "2022-02-26 - The hidden C2- Lampion trojan release 212 is on the rise and using a C2 server for two years",
    "authors": "",
    "file_creation_date": "2022-05-28T21:48:53Z",
    "file_modification_date": "2022-05-28T21:48:53Z",
    "file_size": 3704692,
    "plain_text": "# The hidden C2: Lampion trojan release 212 is on the rise and using a C2 server for two years\n\n**[seguranca-informatica.pt/the-hidden-c2-lampion-trojan-release-212-is-on-the-rise-and-using-a-c2-server-for-two-years](https://seguranca-informatica.pt/the-hidden-c2-lampion-trojan-release-212-is-on-the-rise-and-using-a-c2-server-for-two-years)**\n\nFebruary 26, 2022\n\n**The hidden C2: Lampion trojan release 212 is on the rise and using a C2 server for two**\n**years.**\nLampion trojan is one of the most active banking trojans impacting Portuguese Internet end\nusers since 2019. This piece of malware is known for the usage of the Portuguese\nGovernment Finance & Tax (Autoridade Tributária e Aduaneira) email templates to lure\nvictims to install the malicious loader (a VBS file). However, fake templates of banking\norganizations in Portugal have been used by criminals to disseminate the threat in the wild,\nas observed in Figure 1 below with a malicious PDF (151724540334 Pedidos.pdf).\n\n**_Figure 1: Emails templates are delivering malicious PDFs impersonating banking_**\n_organizations in Portugal to spread Lampion trojan._\n\n[The malware TTP and their capabilities remain the same observed in 2019, but the trojan](https://seguranca-informatica.pt/targeting-portugal-a-new-trojan-lampion-has-spread-using-template-emails-from-the-portuguese-government-finance-tax/#.YhpNzejP0Q8)\nloader – the VBS files – propagated along with the new campaign has significant differences.\nAlso, the C2 server is the same noticed on the past campaigns since 2020, suggesting, thus,\n\n\n-----\n\nthat criminals are using the same server geolocated in Russia for two years to orchestrate all\nthe malicious operations.\n\n## FUD capabilities of the Lampions’ VBS loader\n\n**Filename: Comprovativo de pagamento_2866-XRNM_15-02-2022 06-43-54_28.vbs**\n\n**MD5: 2e295f9e683296d8d6b627a88ea34583**\n\nAs expected, the Lampions’ VBS loader has been changed in the last years, and its modus\n_[operandi is similar to other Brazilian trojans, such as Maxtrilha,](https://seguranca-informatica.pt/the-new-maxtrilha-trojan-is-being-disseminated-and-targeting-several-banks/#.YhpTNOjP0Q8)_ **[URSA,](https://seguranca-informatica.pt/threat-analysis-the-emergent-ursa-trojan-impacts-many-countries-using-a-sophisticated-loader/)** **[Grandoreiro, and so](https://seguranca-informatica.pt/the-updated-grandoreiro-malware-equipped-with-latenbot-c2-features-in-q2-2020-now-extended-to-portuguese-banks/#.YhpTU-jP0Q9)**\non. In detail, criminals are enlarging the file size around 56 MB of junk to bypass its detection\nin contrast to the samples from 2019 with just 13.20 KB.\n\n**_Figure 2: Lampions’ VBS loader file enlarge technique to bypass its detection._**\n\nThe VBS file contains a lot of junk sequences, and after some rounds of code cleaning and\ndeobfuscation, 31.7 MB of useless lines of code were removed.\n\n\n-----\n\n**_Figure 3: Lampions’ VBS loader size before and after removing the junk sequences._**\n\nThe final file after the cleaning process has around 24.7 MB, and it is responsible for creating\nother files, including:\n\na 2nd VBS file with a random name (2nd_stage_vbs) that will download the Lampions’\nfinal stage – two DLLs from AWS S3 buckets\nother VBS file that will execute the previous file by using a scheduled task also created\nby the 1st VBS loader.\n\n\n-----\n\nThe next figure presents the structure of the Lampions VBS loader after the cleaning and\ndeobfuscation process.\n\n\n-----\n\n**_Figure 4: Lampion’s VBS loader after some rounds of deobfuscation._**\n\nAs mentioned, the 1st stage (Comprovativo de pagamento_2866-XRNM_15-02-2022 06**_43-54_28.vbs) creates a new VBS file (2nd_stage_vbs) inside the %AppData%\\Local\\Temp_**\nfolder with a random name (sznyetzkkg.vbs). Also, another VBS (jghfszcekwr.vbs) is\ncreated with code responsible for executing the previous VBS file (sznyetzkkg.vbs) via a\nscheduled task.\n\nA scheduled task is created with the service description and author Administrator user\nassociated. This scheduled task will execute the second VBS file jghfszcekwr.vbsthat\ncontains instructions to finally run the sznyetzkkg.vbs file (the 2nd VBS stage).\n\n**_Figure 5: Creation of the 2nd VBS file and the auxiliary VBS file. Also, the scheduled task_**\n_responsible for creating the auxiliary VBS file is shown_\n\n\n-----\n\nAfter running the initial VBS file, the two additional VBS files are finally prepared to be\ntriggered. That task is then performed by the scheduled task as presented in Figure 6. The\nsource code of the jghfszcekwr.vbs file is quite simple and just executes the 2nd VBS file\n(sznyetzkkg.vbs). We believe this is just a procedure to make hard the malware analysis as\nwell as difficult its detection – something we confirmed during the analysis, as the AVs don’t\ndetect properly those files during the malware infection chain.\n\n**_Figure 6: Schedule task (1) responsible for executing an auxiliary VBS (2) file which in turn_**\n_runs the second VBS stage._\n\nAfter that, the VBS file dubbed sznyetzkkg.vbs is executed. All the steps highlighted in\nFigure 7 are typically known from the last Lampions campaigns. This VBS file is quite similar\nto their predecessors, and it performs some tasks:\n\nDeletes all the files from the startup folder with the following extension: lnk, vbs, cmd,\n**_exe, bat and js._**\nDecrypts the URLs containing the final stage of Lampion trojan.\nCreates a .cmd file into the Windows startup folder to maintain persistence.\n\n\n-----\n\n**_Figure 7: Source-code of the 2nd VBS file and the encrypted URLs that will download the_**\n_last stage of the Lampion trojan banker._\n\nFrom this point, the modus operandi and TTP are the same observed since 2019. The clear\n[sign is the same algorithm used in 2019 to decrypt the hardcoded strings with the malicious](https://github.com/sirpedrotavares/SI-LAB-malware/blob/master/decryption-strings-lampion.vbs)\n[URLs was used. The script can be downloaded from GitHub here.](https://github.com/sirpedrotavares/SI-LAB-malware/blob/master/decryption-strings-lampion.vbs)\n\n\n-----\n\n**_Figure 8: Lampion trojan VBS decryptor._**\n\nAfter running the script, we obtained the malicious URLs that download the next stage of\nLampion trojan. Once again, the AWS S3 buckets were the criminals’ choice, as observed in\nthe last releases of this malware.\n```\nencrypted: \"O{'^Yj7jRf:i_0<%r%#c=o{f=[Rhbi:e6dUWDb3isjRkt\\U\\0ik$zit)i$?kYi`#\\\n[DWcifjR#e(n$$WxcwW2pPe;dqWomFi3$ZYDeZc8%TiTeNflhYW>j][5ivj+[B$*pX_Dfl'\"\ndecrypted: https://mypersonalstuffs.s3.us-east-2.amazonaws.com/soprateste.zip\nencrypted: \"eg1^xj5jZf}iP0a%r%\n<cZo[fU[(h&i8e9dZWmb%ijjOkz\\M\\+iz$Tiv)E$Qkxiq#M[bW<iDjO#4(A$kWfc2WJp`epdoWgm$i.$;Yqecc\ns#F*R-\"\ndecrypted: https://mypersonalstuffs.s3.us-east-2.amazonaws.com/P-17-4\n\n```\nThe first DLL (the trojan loader) is a point of interest in this analysis. This file was also\nenlarged with lots of random BMP images inside – a well-known technique that is being\n**used by Latin American gangs in their malware. This is a clear sign of cooperation**\nbetween the several groups.\n\nThe P-17-4 DLL is then renamed when downloaded and injected into the memory via the\nDLL injection technique. The EAT function “mJ8Lf9v0GZnptOVNB2I” is triggered to start the\nDLL loader.\n\n\n-----\n\n```\nC:\\Windows\\System32\\rundll32.dll\\ %AppData%\\Local\\Temp\\rand_folder\\random_name.dll \nmJ8Lf9v0GZnptOVNB2I\n\n```\n**_Figure 9: Lampion DLLs – release 212 (February 2022)._**\n\nThe main goal of the DLL loader is just to unzip the 2nd DLL called “soprateste.zip” which is\nprotected with a hardcoded password. All the process from this point is the same as the last\narticles we have published, namely:\n\n## Details of the Lampion release 212\n\nThe single task of the first DLL is just to unzip the 2nd one with a hardcoded password. As\nusual, the DLL inside soprateste.zip carries a message in Chinese for researchers:\n\n**_Figure 10: Message hardcoded inside the soprateste.zip DLL (the Lampion itself) and part of_**\n_the unzip process._\n\n\n-----\n\nAs usual, the trojan maintains intact its EAT since 2019. The call **DoThisBicht is invoked**\nfrom the DLL loader, and the malware starts its malicious activity. Figure 11 below shows the\ncomparison of the EAT between the different versions from 2019 to 2022, and no differences\nwere noticed.\n\n**_Figure 11: Export Address Table (EAT) from the DLL inside the soprateste.zip file (the_**\n_Lampion trojan itself)._\n\nThe target brands are the same observed in the past campaigns, with the focus on Brazilian\nand Portuguese banking organizations.\n\n\n-----\n\n```\n0x5106a0c (28): banco montepio\n0x5106a38 (16): montepio\n0x5106a6c (26): millenniumbcp\n0x5106aa8 (18): Santander\n0x5106ac8 (14): BPI Net\n0x5106ae4 (18): Banco BPI\n0x5106b18 (24): Caixadirecta\n0x5106b40 (42): Caixadirecta Empresas\n0x5106b8c (20): NOVO BANCO\n0x5106bc4 (14): EuroBic\n0x5106bfa (16): Credito Agricola\n0x5106c24 (20): Login Page\n0x5106c48 (22): CA Empresas\n0x5106c80 (18): Bankinter\n0x5106cb4 (20): ActivoBank\n0x5107118 (36): itauaplicativo.exe\n0x5109568 (14): TravaBB\n0x5109586 (32): Banco do Brasil\n0x51095b4 (16): Traazure\n0x51095d6 (32): Caixa Economica\n0x5109604 (20): Travsantos\n0x510962a (20): Santander\n0x510964c (14): Travsic\n0x510966a (14): Sicred\n0x5109688 (14): Travite\n0x51096c0 (18): Travdesco\n0x51096e2 (18): Bradesco\n0x5109704 (22): BANRITRAVAR\n0x510972a (18): Banrisul\n0x510974c (20): TravaBitco\n0x5109772 (32): Mercado Bitcoin\n0x51097a0 (14): Travcit\n0x51097be (18): Citibank\n0x51097e0 (18): Travorigs\n0x5109802 (30): Banco Original\n0x5109830 (18): SICTRAVAR\n0x5109852 (14): Sicoob\n\n```\nWhen started, the trojan collects information about the opened processes on the target\nmachine. If the title of the pages matches the hardcoded strings presented above, then it\nstarts the malicious overlay process that presents fake messages and windows\nimpersonating the target bank to lure the victims.\n\n\n-----\n\n**_Figure 12:_** _[Lampion overlay screens (courtesy of MllenniumBCP – Portugal).](https://ind.millenniumbcp.pt/pt/Particulares/seguranca/Pages/avisos2019/aviso-2309.aspx)_\n\n\n-----\n\n**_Figure 13: Part of the hardcoded messages present on the Delphi forms that are exhibited_**\n_during the trojan execution._\n\n\n-----\n\nAs mentioned, Lampion is using the same C2 server geolocated in Russia at least for two\nyears. Figure 14 compares the Lampion release 207 – from 2020 – and the new release 212\n– February 2022. As presented, the server “5.188.9.28” has been used at least since 2020\nby the criminals’ gang in order to orchestrate all the operations.\n\n**_Figure 14: Lampion is using the same C2 server observed in 2020 and gelocated in Russia._**\n\nInterestingly, the C2 server – a Windows machine – has the Microsoft RPC Endpoint Mapper\nservice exposed, which allows mapping some of the services running on the machine,\nassociated pipes, hostname, etc.\n\nThrough this information, it was possible to obtain the hostname of the remote machine:\n**\\WIN-344VU98D3RU.**\n\nAfter a quick search, the hostname seems to have already been associated with other\nmalicious groups operating different types of malware, such as the bazaar (see the article\n[here), and also LockBit 2.0 ransomware (take a look here).](https://www.lemagit.fr/actualites/252510802/Ransomware-comment-la-franchise-LockBit-20-gonfle-artificiellement-ses-chiffres)\n\n\n-----\n\n**_Figure 15: IoCs related to the hostname used by Lampions C2 server (\\WIN-_**\n**_344VU98D3RU)._**\n\nAlthough it is not possible to confirm whether this is a hostname associated with other Cloud\nmachines and used by legitimate systems, it was possible to identify that there are machines\nspread all over the world with the same hostname, and in some situations, only a few\nmachines available per country.\n\nIn total, 81.503 machines were identified, with around 45k in The Netherlands, 25k in Russia,\n2.5k Turkey, 2K Ukraine, 1.5k in US, etc.\n\n\n-----\n\nThe complete list of hosts can be found below.\n\n\n-----\n\n## Final Thoughts\n\nMalware is one of the major cyber weapons to destroy a business, market reputation, and\neven infect a wide number of users for the most malicious purposes. The next list presents\nsome tips on how you can prevent a malware infection. It is not a complete list, it is just a few\nsteps to protect yourself and your devices.\n\nKeep software updated\nTake several minutes to look at the new email and not just a few seconds. Analyze it\ncarefully\nBeware of fake tech support, emails related to bank transactions, invoices, COVID19,\neverything you think be strange\nKeep Internet activity relevant\nLog out at the end of the day\nOnly access secured and trusted sites; not only websites with a green lock. Criminals\nare using free CAs to created valid HTTPS certificates.\nKeep your operating system up to date\nMake sure you are using an antivírus\nBeware of malvertising\n\n\n-----\n\n## Take-home message Be proactive and start taking malware protection seriously!\n\n Lampion – Mitre Att&ck Matrix\n\n Indicators of Compromise (IOCs)\n```\nhttps://mypersonalstuffs.s3.us-east-2.amazonaws.com/soprateste.zip\n  submited on => https://feed.seguranca-informatica.pt/0xsi_f33d_id.php?id=6039\nhttps://mypersonalstuffs.s3.us-east-2.amazonaws.com/P-17-4\n  submited on => https://feed.seguranca-informatica.pt/0xsi_f33d_id.php?id=6038\n--Strings-DoThisBicht\nPayloads and DLLs:\n1st VBS: 2e295f9e683296d8d6b627a88ea34583\n2nd VBS: e7f6a46dd9d4713a877c6447d8e6a299\nauxiliary VBS to be executed via schedule task: 6d931b30ec52e1ae53ac001659b0629e\nP-17-4: 88a4a76cfd1eacf76bc08257b5781ad3\nsoprateste.zip: f0e8d127009ba8af6c4bb89676614792\nlampion DLL: 7438fd78083152cd199ba162dffe7939\n--C2-5.188.9.28\n  submited on => https://feed.seguranca-informatica.pt/0xsi_f33d_id.php?id=6102\n\n```\n\n-----\n\n## Online Sandbox\n\n[https://www.joesandbox.com/analysis/575060/0/html](https://www.joesandbox.com/analysis/575060/0/html)\n\n[Pedro Tavares](https://seguranca-informatica.pt/author/pipocaz/)\n**[Pedro Tavares is a professional in the field of information security working as an Ethical](https://www.linkedin.com/in/sirpedrotavares/)**\nHacker/Pentester, Malware Researcher and also a Security Evangelist. He is also a founding\nmember at CSIRT.UBI and Editor-in-Chief of the security computer blog segurancainformatica.pt.\n\nIn recent years he has invested in the field of information security, exploring and analyzing a\nwide range of topics, such as pentesting (Kali Linux), malware, exploitation, hacking, IoT and\nsecurity in Active Directory networks. He is also Freelance Writer (Infosec. Resources\n[Institute and Cyber Defense Magazine) and developer of the 0xSI_f33d – a feed that](https://feed.seguranca-informatica.pt/)\ncompiles phishing and malware campaigns targeting Portuguese citizens.\n\n[Read more here.](https://seguranca-informatica.pt/contacto/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-26 - The hidden C2- Lampion trojan release 212 is on the rise and using a C2 server for two years.pdf"
    ],
    "report_names": [
        "2022-02-26 - The hidden C2- Lampion trojan release 212 is on the rise and using a C2 server for two years.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535898,
    "ts_updated_at": 1743041143,
    "ts_creation_date": 1653774533,
    "ts_modification_date": 1653774533,
    "files": {
        "pdf": "https://archive.orkl.eu/e3dea4f24b2d94e0625d2af627caaf5ec66addae.pdf",
        "text": "https://archive.orkl.eu/e3dea4f24b2d94e0625d2af627caaf5ec66addae.txt",
        "img": "https://archive.orkl.eu/e3dea4f24b2d94e0625d2af627caaf5ec66addae.jpg"
    }
}