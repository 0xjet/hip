{
    "id": "d23b675a-b149-4cd7-b976-6894aa6d3df4",
    "created_at": "2023-01-12T15:02:25.973568Z",
    "updated_at": "2025-03-27T02:05:57.769852Z",
    "deleted_at": null,
    "sha1_hash": "a85af00645c90ef9df6cab450df8ebea63ae957f",
    "title": "2020-07-13 - TrickBot's new API-Hammering explained",
    "authors": "",
    "file_creation_date": "2022-05-28T19:18:47Z",
    "file_modification_date": "2022-05-28T19:18:47Z",
    "file_size": 776509,
    "plain_text": "# TrickBot's new API-Hammering explained\n\n**joesecurity.org/blog/498839998833561473**\n\nAs usual, at Joe Security, we keep a close eye on evasive malware. Some days ago we\ndetected an interesting sample, MD5: b32d28ebab62e99cd2d46aca8b2ffb81. It turned out to\nbe a new TrickBot sample using API hammering to bypass analysis. In this blog post, we will\noutline the evasion and explain how it works.\n\n[The full analysis report of the TrickBot variant is available here.](https://www.joesandbox.com/analysis/244612/0/html)\n\n## Two Stage API Hammering\n\nRight after the entry point, the sample tries to load taskmgr.exe as a DLL:\n\nThis is likely a trick to bypass emulators that do not check if a given DLL exists if\nLoadLibraryEx is called. Next, it performs a massive printf loop - the first stage. Since before\nthe loop FreeConsole has been called all printf calls do basically nothing:\n\n\n-----\n\n[This code has been directly copied from the documentation of printf:](https://www.codingunit.com/printf-format-specifiers-format-conversions-and-formatted-output)\n\n\n-----\n\nSo what is the purpose of those numerous printf loops? Well, sandboxes are designed to log\nall behavior including the 1.8M calls. As a result, the massive amount of calls delay the\nexecution process and overload the sandbox with junk data. As a result, the final payload is\nnever called.\n\nThis behavior is called API Hammering. API Hammering is not a new technique, we have\n[already seen it several years ago e.g. in the Nymaim Loader. Joe Sandbox detects the API](https://www.joesecurity.org/blog/3660886847485093803)\nhammering successfully and rates it as malicious:\n\nRight after the printf flood, the sample performs another loop to delay execution by creating\nand writing to a temporary file - the second stage. In between it performs random sleeps:\n\n\n-----\n\nAgain, the purpose is to overload the sandbox and delay the execution. This time however\nthe all calls are valid.\n\n## WERMGR\n\nFinally, when this loop is passed, the sample starts and injects TrickBot (by using directly Nt*\nAPIs) into legit wermgr.exe - the process responsible for Windows error handling and\nreporting:\n\n\n-----\n\nIt s noticeable that a 32bit sample is able to inject successfully into 64bit wermgr.exe on a\nWindows 64bit.\n\nIn wermgr.exe TrickBot fully unpacks itself:\n\nThis enables Joe Sandbox to successfully detect TrickBot and extract full configurations:\n\n\n-----\n\n## Conclusion\n\nIn contrast to many other evasions, API Hammering is one of the more interesting\ntechniques since it directly exploits the design of a sandbox. No matter what technology your\nfavorite sandbox uses it has to handle API Hammering correctly\n\n\n-----\n\nYou are interested to get a list of other evasive malware analyses? Check out these other\nblogs:\n\n[New Sandbox Evasions spot in VBS samples](https://www.joesecurity.org/blog/745788703303246608)\n[Analyzing Azorult's Anti-Analysis Tricks with Joe Sandbox Hypervisor](https://www.joesecurity.org/blog/9048980422564630717)\n[Fighting Country Aware Microsoft Office Macro Droppers with VBA Instrumentation](https://www.joesecurity.org/blog/5351089351831994293)\n[Malicious Documents: The Evolution of country-aware VBA Macros](https://www.joesecurity.org/blog/5125095978168980460)\n\nor [this extensive list of evasive samples.](https://www.joesecurity.org/joe-sandbox-reports-evasive)\n\n[Interested in Joe Sandbox? Register for free at Joe Sandbox Cloud Basic or](https://www.joesandbox.com/) [contact us for](https://www.joesecurity.org/contact)\nan in-depth technical demo!\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-07-13 - TrickBot's new API-Hammering explained.pdf"
    ],
    "report_names": [
        "2020-07-13 - TrickBot's new API-Hammering explained.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535745,
    "ts_updated_at": 1743041157,
    "ts_creation_date": 1653765527,
    "ts_modification_date": 1653765527,
    "files": {
        "pdf": "https://archive.orkl.eu/a85af00645c90ef9df6cab450df8ebea63ae957f.pdf",
        "text": "https://archive.orkl.eu/a85af00645c90ef9df6cab450df8ebea63ae957f.txt",
        "img": "https://archive.orkl.eu/a85af00645c90ef9df6cab450df8ebea63ae957f.jpg"
    }
}