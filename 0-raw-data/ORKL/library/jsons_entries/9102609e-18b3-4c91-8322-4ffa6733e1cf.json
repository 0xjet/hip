{
    "id": "9102609e-18b3-4c91-8322-4ffa6733e1cf",
    "created_at": "2023-05-06T02:08:53.863334Z",
    "updated_at": "2025-03-27T02:16:01.176165Z",
    "deleted_at": null,
    "sha1_hash": "a641c377ea16e3d85ac833e85a5edd2e84ff900b",
    "title": "2015-02-20 - The DGAs of Necurs",
    "authors": "",
    "file_creation_date": "2023-05-05T02:07:32Z",
    "file_modification_date": "2023-05-05T02:07:32Z",
    "file_size": 1086492,
    "plain_text": "# The DGAs of Necurs\n\n**bin.re/blog/the-dgas-of-necurs/**\n\nNecurs is a malware that opens a backdoor on infected systems, see NECURS: The\nMalware That Breaks Your Security. A broad analysis of the malware can be found in the\nthree part series [The Curse of Necurs by Peter Ferrie.](https://www.virusbtn.com/virusbulletin/archive/2014/04/vb201404-Necurs)\n\nThis post focuses exclusively on the network traffic of Necurs, in particular the used domains.\nNecurs features three different sets of hostnames that serve different purposes. Although all\nthree sets reek of domain generation algorithm (DGA), only the first and last set are actually\ngenerated algorithmically. The following example traffic shows the different stages of the\ncallback attempts with number 3, 4 and 6 marking the three malicious domains batches:\n\n\n-----\n\n```\n1.  13:09:39.635819000 facebook.com\n\n  +- 13:09:39.638039000 0.pool.ntp.org\n\n2.--|  13:09:39.998526000 1.pool.ntp.org\n\n  +- 13:09:40.020627000 2.pool.ntp.org\n\n  +- 13:09:40.027471000 sxotmrxwhddr.com\n\n  |  13:09:40.028494000 btysiiquuc.com\n\n3.--|  13:09:40.032591000 kfncxvayakmb.com\n\n  +- 13:09:40.033539000 vmslcvvocseu.com\n\n  +- 13:09:40.688199000 qcmbartuop.bit\n\n  |  13:09:41.699491000 qcmbartuop.bit\n\n4.--|  13:09:42.716128000 qcmbartuop.bit\n\n  |  (... 16 times total)\n\n  +- 13:16:32.364351000 qcmbartuop.bit\n\n5.---- 13:16:49.187559000 facebook.com\n\n  +- 13:16:49.516477000 boymlujtgp.nu\n\n  |  13:16:49.520651000 ybynentfsjvmsgtktcoog.im\n\n  |  13:16:49.527701000 oiijxplrnmvgskxwaye.ru\n\n6.--|  13:16:49.529669000 imgirmyddbsniuh.pw\n\n  |  13:16:49.834913000 ultrttvbvjaanrj.jp\n\n  |  (... 2048 total)\n\n  +- 13:18:03.607552000 porgtemsbycy.ki\n\n```\nThe following list gives a brief summary of the source and purpose of the domains. See the\nrespective section for an in-depth analysis of the three DGA sets.\n\n1. Necurs starts by checking internet connectivity by resolving facebook.com or\n\n_microsoft.com._\n2. The malware then contacts three NTP pools to get the accurate date and time.\n3. Next, four DGA domains are generated by the first dga with top level domain .com.\n\nThe domains are unpredictable and can therefore not be sinkholed or used to identify\nNecurs samples when taken in isolation. The purpose of the domains is to detect\nsimulated internet in lab environments\n4. If the lab detection test passes, Necurs will try sixteen domains from a hard-coded list\n\nof pseudo-DGA domains, see second dga. Necurs will reuse domains if the list\ncontains less than 16 domains. The analysed sample, for example, only has one hardcoded domain which will therefore be repeated 16 times. Necurs sleeps between 1 and\n20 seconds after each failed connection attempt, which mounts up to about 5 minutes\nbefore the malware moves on to the next stage. The hard-coded domains are probably\nthe main C&C domains.\n5. Another connectivity check to facebook.com or microsoft.com is made before Necurs\n\nresorts to the last DGA.\n\n\n-----\n\n6. The **third dga finally checks up to 2048 different domains. One special feature is the**\n\nlarge list of 43 different top level domains, some of which are quite exotic. The DGA is\ntime-dependent — the domains change every four days. The DGA is probably a\nbackup in case the set of hard-coded domains no longer work.\n\n## The First DGA\n\n### Connectivity Checks\n\nNecurs makes a connectivity check to either facebook.com or microsoft.com before the first\nset of DGA domains are tested:\n\n\n-----\n\nThe routine random_int(0,1) returns 0 or 1 (the implementation of random_int is discussed\nbelow). The malware aborts the callback attempt if it can’t resolve and contact the domain of\nFacebook or Microsoft as the case may be.\n\n### DGA Caller\n\nNecurs then launches four threads that attempt to resolve domains generated by the first\nDGA:\n\nThere is no delay between creating the threads, the four DNS queries happen at around the\nsame time.\n\n### The Heart of the First DGA\n\nLet’s see how the domains are generated by dga1:\n\n\n-----\n\n-----\n\nThis very simple algorithm first randomly determines the length of the second level domain to\nbe between 10 and 15 characters. It then builds the domain by picking uniformly at random\nfrom all lowercase letters and appending the hard-coded top level domain .com. The DGA\nconcludes with querying the resulting domain; the resolved IP, if there is any, is appended to\nthe array dga1_ips.\n\n\n-----\n\n### Pseudorandom Number Generator\n\nThe connectivity check, as well as dga1, use random_int to generate random integers. The\ndisassembly of this routine is:\n\nThis is just a mapping of the return value of random_mwc to the desired range:\n\n\n-----\n\n```\nfunction random_int(lower, upper)\n\n  if lower > upper then\n\n    return 0\n\n  else\n\n    return lower + random_mwc % (upper - lower + 1)\n\n```\nThe routine random_mwc is an almost standard implementation of a lag-3 multiply-with-carry\npseudorandom number generator invented by George Marsaglia:\n\nThe only difference is the addition of an rdtsc summand, which will add the current time\nstamp counter to all generated numbers (not just the initial seed). The initial seed values and\ninitial carry are:\n```\n0040F048 rng3      dq 77465321\n\n0040F04C c        dd   13579\n\n0040F050 rng2      dd 362436069  \n\n0040F054 rng1      dd 123456789 \n\n\n```\n[The choice of these values is pretty common. Necurs never changed these values in its long](https://github.com/afgaungoo/Facebull/blob/master/Import/Import/Initialise%20Network.cpp)\n[existence according to the aforementioned article “the curse of Necurs”. This is the PRNG](https://www.virusbtn.com/virusbulletin/archive/2014/04/vb201404-Necurs)\n```\nrandom mwc in pseudo-code is:\n\n```\n\n-----\n\n```\nb 2 (32)\n\na = 916905990\n\n// Initial seeds and carry\n\nrng1 = 123456789\n\nrng2 = 362436069\n\nrng3 = 77465321\n\nc = 13579\n\nfunction random_mwc()\n\n  t = a*rng1 + rdtsc() + c\n\n  rng1 = rng2;\n\n  rng2 = rng3;\n\n  rng3 = t;\n\n  c = (t // b) % b\n\n  return v1;\n\n```\nThe addition of rdtsc makes this random number generator, and therefore also the first\ndomain generation algorithm, virtually impossible to predict.\n\n### Comparison with Facebook’s or Microsoft’s IP\n\nAlthough the domains of dga1 are unusable as callback targets, they still serve a purpose: If\none of the DGA IPs matches the one of Facebook or Microsoft (resolved during connectivity\nchecking), Necurs will abort the callback attempt:\n\nThe excessively long named routine ip_of_mic_or_fac_equal_to_dga1_ips compares the\nIP of Microsoft or Facebook to the IPs of dga1 stored in array dga1_ips:\n\n\n-----\n\nI suspect that Necurs tries to detect simulated internet services this way. Simulated Internet\nwill typically return the same IP for all requested domains. The 4 DGA domains, however, are\nunpredictable and therefore non-existent. And even if the victim’s ISP uses DNS hijacking,\nthe returned IPs will not match Facebook’s or Microsoft’s IP.\n\n### Summary\n\nThe first DGA of Necurs generates four .com domains of 10 to 15 lower case letters. It tries\nto resolve all four domains in parallel. The modified MWC-PRNG makes the domains\nunusable as callback targets; instead they are probably used to detect simulated internet\nconnections in a lab environment.\n\n## The Second DGA\n\n\n-----\n\nNecurs will continue without break with the second set of DGA domains in case the lab\ndetection passed. The second set of DGA-like domains, for example qcmbartuop.bit, are not\ngenerated algorithmically but hard-coded. The following loop fetches 16 of those hard-coded\ndomains and tries to contact them:\n\n\n-----\n\n-----\n\nNecurs sleeps 1 to 20 seconds after each failed attempt, which sums up to a average total\nsleep time of about 5 minutes for all 16 attempts.\n\nThe relevant snippet of get_hard-coded_domain is:\n\nThis returns the hard-coded domains one after another, starting over with the first domain if\nnecessary.\n\nFrom what I could gather from other reports, the hard-coded domains seem to mostly use\n[the special .bit pseudo top level domain served by the namecoin project. The domains are](http://en.wikipedia.org/wiki/.bit)\nprobably Necurs` main C&C targets.\n\n## The Third DGA\n\nIf the second set of domains also fails to produce a working C&C server, Necurs tries one\nlast set of domains.\n\n### Sequence Numbers\n\nThe third DGA starts by creating an array of 2048 sequence numbers 0 to 2047; these\nsequence numbers are then randomly permutated:\n\n\n-----\n\nThe permutation routine randomizes the sequence numbers in place with the following\nalgorithm:\n```\nn = A.length\n\nfor i = 1 to n\n\n  swap A[i] with A[Random(1,n)]\n\n```\n\n-----\n\nAlthough this randomizes the sequence numbers, it does not do it uniformly. A better\nimplementation would call Random(i,n) instead of Random(1,n), see for instance exercise\n[5.3-3 on page 129 of “Introduction to Algorithms”, 3rd edition. Nevertheless, the sequence](http://www.amazon.com/Introduction-Algorithms-3rd-Thomas-Cormen/dp/0262033844/ref=sr_1_1?s=books&ie=UTF8&qid=1424430552&sr=1-1&keywords=introduction+to+algorithms+third+edition)\nnumbers are still random and unpredictable because of the call to random_mwc which\nincludes the current tick count see section above.\n\n### DGA Caller\n\nAfter the sequence numbers have been randomized, Necurs starts up 16 threads, each with\n128 of the sequence numbers (referenced by ecx, indexed by edi):\n\nEach thread will call the routine to generates the domains for all 128 sequence numbers it\ngot assigned to (unless a callback is successful beforehand):\n\n\n-----\n\n### The DGA\n\nAt the heart of the third DGA we find this long, but easy to understand algorithm:\n\n\n-----\n\n-----\n\n-----\n\nThe first call to the routine fetches a hard-coded magic number from a rather complicated\nlinked list and saves it as magic_number. For my sample, the hard-coded seed was 9.\n\nNecurs then determines a length between 7 and 21 letters with multiple calls to\n```\npseudo_random, using the current date, the sequence number and the magic number as\n\n```\nseeds. This will lead to a new set of domains every four days:\n```\n  n = pseudo_random(date.year)\n\n  n = pseudo_random(n + date.month + 43690)\n\n  n = pseudo_random(n + (date.day>>2))\n\n  n = pseudo_random(n + sequence_nr)\n\n  n = pseudo_random(n + magic_nr)\n\n  domain_length = mod64(n, 15) + 7\n\n\n```\nNext, Necurs picks the characters of the second level domain from from ‘a’ to ‘y’ (‘z’ is\n[unreachable like for Ramnit):](https://bin.re/blog/the-dga-of-ramnit/)\n```\n  domain = \"\"\n\n  for i in range(domain_length):\n\n    n = pseudo_random(n+i)\n\n    ch = mod64(n, 25) + ord('a')\n\n    domain += chr(ch)\n\n    n += 0xABBEDF\n\n    n = pseudo_random(n)\n\n\n```\nFinally, one of 43 top level domains is chosen to finish the domain name:\n\n\n-----\n\n```\n  tlds [ tj, in, jp, tw, ac, cm, la, mn, so, sh, sc, nu, nf, mu,\n\n  'ms','mx','ki','im','cx','cc','tv','bz','me','eu','de','ru','co','su','pw',\n\n  'kz','sx','us','ug','ir','to','ga','com','net','org','biz','xxx','pro','bit']\n\n  tld = tlds[mod64(n, 43)]\n\n  domain += '.' + tld\n\n  return domain\n\n```\nAll picks are randomized with calls to pseudo_random which is:\n\n\n-----\n\nThis routine calculates:\n```\n  def pseudo_random(value):\n\n    loops = (value & 0x7F) + 21\n\n    for index in range(loops):\n\n      value += ((value*7) ^ (value << 15)) + 8*index - (value >> 5)\n\n      value &= ((1 << 64) - 1)\n\n    return value\n\n\n### Summary\n\n```\nThe third DGA, including the random number generator, boils down to this routine:\n\n\n-----\n\n```\nimport argparse\n\nfrom datetime import datetime\n\ndef generate_necurs_domain(sequence_nr, magic_nr, date):\n\n  def pseudo_random(value):\n\n    loops = (value & 0x7F) + 21\n\n    for index in range(loops):\n\n      value += ((value*7) ^ (value << 15)) + 8*index - (value >> 5)\n\n      value &= ((1 << 64) - 1)\n\n    return value\n\n  def mod64(nr1, nr2):\n\n    return nr1 % nr2\n\n  n = pseudo_random(date.year)\n\n  n = pseudo_random(n + date.month + 43690)\n\n  n = pseudo_random(n + (date.day>>2))\n\n  n = pseudo_random(n + sequence_nr)\n\n  n = pseudo_random(n + magic_nr)\n\n  domain_length = mod64(n, 15) + 7\n\n  domain = \"\"\n\n  for i in range(domain_length):\n\n    n = pseudo_random(n+i)\n\n    ch = mod64(n, 25) + ord('a')\n\n    domain += chr(ch)\n\n    n += 0xABBEDF\n\n    n = pseudo_random(n)\n\n  tlds = ['tj','in','jp','tw','ac','cm','la','mn','so','sh','sc','nu','nf','mu',\n\n  'ms','mx','ki','im','cx','cc','tv','bz','me','eu','de','ru','co','su','pw',\n\n  'kz','sx','us','ug','ir','to','ga','com','net','org','biz','xxx','pro','bit']\n\n  tld = tlds[mod64(n, 43)]\n\n  domain += '.' + tld\n\n  return domain\n\nif __name__==\"__main__\":\n\n  parser = argparse.ArgumentParser()\n\n  parser.add_argument(\"-d\", \"--date\", help=\"as YYYY-mm-dd\")\n\n  args = parser.parse_args()\n\n  date_str = args.date\n\n  if date_str:\n\n    date = datetime.strptime(date_str, \"%Y-%m-%d\")\n\n  else:\n\n    date = datetime.now()\n\n  for sequence_nr in range(2048):\n\n    print(generate_necurs_domain(sequence_nr, 9, date))\n\n```\nThe characteristics of this DGA are:\n\n\n-----\n\n**property** **value**\n\nseed magic number and current date (changing domains every four\ndays)\n\ndomains per seed 2048\n\nsequence randomized (unpredictable, albeit not uniformly random)\n\n\nwait time between\ndomains\n\n\nnone, 16 parallel threads\n\n\ntop level domain 43 different tld, picked randomly\n\nsecond level characters lower case letters except ‘z’\n\n\nsecond level domain\nlength\n\n\n7 to 21 letters\n\n\nThe DGA likely serves as a fallback in case the hard-coded domains fail.\n\n## Archived Comments\n\n**_Note: I removed the Disqus integration in an effort to cut down on bloat. The following_**\n_comments were retrieved with the export functionality of Disqus. If you have comments,_\n_please reach out to me by Twitter or email._\n\nAnon Feb 25, 2015 14:50:36 UTC\nExcellent clear analysis. Thanks for the code at the end too, it makes finding evidence of\nNecurs much easier.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-02-20 - The DGAs of Necurs.pdf"
    ],
    "report_names": [
        "2015-02-20 - The DGAs of Necurs.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1683338933,
    "ts_updated_at": 1743041761,
    "ts_creation_date": 1683252452,
    "ts_modification_date": 1683252452,
    "files": {
        "pdf": "https://archive.orkl.eu/a641c377ea16e3d85ac833e85a5edd2e84ff900b.pdf",
        "text": "https://archive.orkl.eu/a641c377ea16e3d85ac833e85a5edd2e84ff900b.txt",
        "img": "https://archive.orkl.eu/a641c377ea16e3d85ac833e85a5edd2e84ff900b.jpg"
    }
}