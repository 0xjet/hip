{
    "id": "ef7ddc66-3492-4679-b383-460f9983d6b2",
    "created_at": "2023-05-06T02:09:02.608113Z",
    "updated_at": "2025-03-27T02:16:47.073563Z",
    "deleted_at": null,
    "sha1_hash": "1200b4c9c647d011daf63702e399272eb4a8e245",
    "title": "2022-11-18 - Earth Preta Spear-Phishing Governments Worldwide",
    "authors": "",
    "file_creation_date": "2023-05-05T02:03:33Z",
    "file_modification_date": "2023-05-05T02:03:33Z",
    "file_size": 3120370,
    "plain_text": "# Earth Preta Spear-Phishing Governments Worldwide\n\n**[trendmicro.com/en_us/research/22/k/earth-preta-spear-phishing-governments-worldwide.html](https://www.trendmicro.com/en_us/research/22/k/earth-preta-spear-phishing-governments-worldwide.html)**\n\nNovember 18, 2022\n\nAPT & Targeted Attacks\n\nWe break down the cyberespionage activities of advanced persistent threat (APT) group\nEarth Preta, observed in large-scale attack deployments that began in March. We also\nshow the infection routines of the malware families they use to infect multiple sectors\nworldwide: TONEINS, TONESHELL, and PUBLOAD.\n\nBy: Nick Dai, Vickie Su, Sunny Lu\nNovember 18, 2022\nRead time: ( words)\n\nWe have been monitoring a wave of spear-phishing attacks targeting the government,\nacademic, foundations, and research sectors around the world. Based on the lure\ndocuments we observed in the wild, this is a large-scale cyberespionage campaign that\nbegan around March. After months of tracking, the seemingly wide outbreak of targeted\nattacks includes but not limited to Myanmar, Australia, the Philippines, Japan and Taiwan.\nWe analyzed the malware families used in this campaign and attributed the incidents to a\nnotorious advanced persistent threat (APT) group called Earth Preta (also known as\nMustang Panda and Bronze President).\n\n\n-----\n\nFigure 1. Country distribution of Earth Preta attacks from May to October 2022\nIn our observation of the campaigns, we noted that, Earth Preta abused fake Google\naccounts to distribute the malware via spear-phishing emails, initially stored in an archive file\n(such as rar/zip/jar) and distributed through Google Drive links. Users are then lured into\ndownloading and triggering the malware to execute, TONEINS, TONESHELL, and\n[PUBLOAD. PUBLOAD has been previously reported, but we add new technical insights in](https://blog.talosintelligence.com/mustang-panda-targets-europe/)\nthis entry that tie it to TONEINS and TONESHELL, newly discovered malware families used\nby the group for its campaigns.\n\nIn addition, the actors leverage different techniques for evading detection and analysis, like\ncode obfuscation and custom exception handlers. We also found that the senders of the\nspear-phishing emails and the owners of Google Drive links are the same. Based on the\nsample documents that were used for luring the victims, we also believe that the attackers\nwere able to conduct research and, potentially, prior breaches on the target organizations\nthat allowed for familiarity, as indicated in the abbreviation of names from previously\ncompromised accounts.\n\nIn this blog entry, we discuss Earth Preta’s new campaign and its tactics, techniques, and\nprocedures (TTPs), including new installers and backdoors. Last, we share how security\npractitioners can track malware threats similar to those that we have identified.\n\nInitial compromise and targets\n\n\n-----\n\nBased on our monitoring of this threat, the decoy documents are written in Burmese, and\nthe contents are \"လျှို့ဝှက်ချက်\" (“Internal-only”). Most of the topics in the\ndocuments are controversial issues between countries and contain words like \"Secret\" or\n“Confidential.” These could indicate that the attackers are targeting Myanmar government\nentities as their first entry point. This could also mean that the attackers have already\ncompromised specific political entities prior to the attack, something that Talos Intelligence\nhad also previously noted.\n\nThe attackers use the stolen documents as decoys to trick the targeted organizations\nworking with Myanmar government offices into downloading and executing the malicious\nfiles. The victimology covers a broad range of organizations and verticals worldwide, with a\nhigher concentration in the Asia Pacific region. Apart from the government offices with\ncollaborative work in Myanmar, subsequent victims included the education and research\nindustries, among others. In addition to decoy topics covering ongoing international events\nconcerning specific organizations, the attackers also lure individuals with subject headings\npertaining to pornographic materials.\n\nFigure 2. Distribution of Earth Preta’s targeted industries\nAnalyzing the routines\n\n\n-----\n\nFigure 3. Earth Preta attack campaign routine from March to October 2022\nEarth Preta uses spear-phishing emails as its first step for intrusion. As aforementioned,\nsome of the emails’ subjects and contents discuss geopolitical topics, while others might\ncontain sensational subjects. We observed that all the emails we analyzed had the Google\nDrive links embedded in them, which points to how users might be tricked into downloading\nthe malicious archives. The file types of the archives include compressed files such as .rar,\n.zip, and .jar, to name a few. Upon accessing the links, we learned that the archives contain\nthe malware TONEINS, TONESHELL, and PUBLOAD malware families.\n\n\n-----\n\nFigure 4.\n\nEmail document sample of meeting minutes, likely stolen from a prior compromise\nSpear-phishing emails\n\nWe analyzed the contents of the emails and observed that a Google Drive link is used as a\nlure for victims. The email's subject might be empty or might have the same name as the\nmalicious archive. Rather than add the victims’ addresses to the email’s “To” header, the\n\n\n-----\n\nthreat actors used fake emails. Meanwhile, the real victims addresses were written in the\n\"CC\" header, likely to evade security analysis and slow down investigations. Using open[source intelligence (OSINT) tool GHunt to probe those Gmail addresses in the “To” section,](https://github.com/mxrch/GHunt)\nwe found these fake accounts with little information in them.\n\nMoreover, we observed that some of the senders might be compromised email accounts\nfrom a specific organization. Victims might be convinced that these mails were sent from\ntrusted partners, increasing the chances that recipients will select the malicious links.\n\nDecoy documents\n\nWe also found some decoy documents linked to the organizations related to or working with\nMyanmar government entities. The first decoy's file name is Assistance and\n_Recovery(china).exe, while another decoy .PDF document (“ပြည်ထောင်စုသမ္မတ_\n_မြန်မာနိုင်ငံတော်သံရုံး.pdf, meaning “Embassy of the Republic of Myanmar\") was observed_\nin a compressed file named Assistance and Recovery(china).rar. Allegedly, this is a\ndocument containing the ambassador’s report in rough meeting schedules between the\nembassies of Myanmar and China.\n\nAnother document is related to the Japan Society for the Promotion of Science (JSPS), an\ninitiative that provides researchers opportunities to conduct and undergo research\nexchanges in Japan. Notably, the documents in the compressed file attachment(EN).rar are\nmostly image files. The malicious DLL and the executable, which are used for the next layer\nof sideloading, are also included among them.\n\n\n-----\n\nFigure 5. Sample decoy documents relating to government meetings (left) and overseas\nresearch exchange (right)\nThere are also other decoy documents with diverse content themes, including regional affairs\nand pornography. However, when the victim opens the fake document file in this folder, no\ncorresponding content appears.\n\nArrival vectors\n\nWe observed at least three types of arrival vectors as the intrusions' entry points, including\nover 30 lure archives around the world distributed via Google Drive links, Dropbox links, or\nother IP addresses hosting the files. In most of the archives we collected, there are legitimate\nexecutables, as well as the sideloaded DLL. The names of the archives and the decoy\ndocuments vary in each case. In the following sections, we take some of them as examples\nand share the TTPs of each.\n\n**Type A: DLL sideloading**\n\nIn this case, there are three files in the archive: \"~,\" Increasingly confident US is baiting\n_China.exe, and libcef.dll. Notably, the names of the lure documents and executables can be_\ndifferent, as detailed in the next sections.\n\n\n-----\n\n**Filename** **Detection** **Description**\n\n\n_220509 - (Cabinet Meeting_\n_2022).zip_\n\n_Increasingly confident US is_\n_baiting China.exe_\n\n\n_~_ Lure\ndocument\n\nLegitimate\nexecutable for DLL\nsideloading\n\n\n_libcef.dll_ Trojan.Win32.PUBLOAD Malicious DLL\n\nTable 1. Files in the archive of Type A\n\n\n-----\n\nFigure 6. An example of a decoy document from the PUBLOAD archives\nInside the archive, the \"~\" file is a lure document. The executable Increasingly confident US\n_is baiting China.exe is a legitimate executable (originally named_\n_adobe_licensing_wf_helper.exe, which is the Adobe Licensing WF Helper). This executable_\nwill sideload the malicious libcef.dll and trigger the export function cef_api_hash.\n\nWhen executed for the first time, the executable tries to install the malware by copying the\n.exe file and moving libcef.dll (detected by Trend Micro as Trojan.Win32.PUBLOAD) to\n<%PUBLIC%> Both .exe and .dll files will be renamed\nC:\\Users\\Public\\Pictures\\adobe_wf.exe and C:\\Users\\Public\\Pictures\\libcef.dll, respectively.\nAdditionally, \"~\" is renamed as 05-09-2022.docx and dropped to the Desktop.\n\n\n-----\n\nFigure 7. Type A’s malicious routine\n**Type B: Shortcut links**\n\nThe malicious archive contains three files: New Word Document.lnk, putty.exe, and\n_CefBrowser.dll. In particular, the DLL and executable files are placed in multiple layers of_\nfolders named “_”.\n\n**Filename** **Detection** **Description**\n\n_Desktop.rar_ _New Word Document.lnk_ Installer\n\n__\\_\\_\\_\\_\\_\\putty.exe_ Legitimate\nexecutable for DLL\nsideloading\n\n__\\_\\_\\_\\_\\_\\CefBrowser.dll_ Backdoor.Win32.TONESHELL Malicious DLL\n\nTable 2. Files in the archive of Type B\n\nThe threat actor utilizes the .lnk file to install the malicious files by decompressing the archive\nfile with WinRAR. The full command line is as follows.\n\n%ComSpec% /c \"_\\_\\_\\_\\_\\_\\putty.exe||(forfiles /P %APPDATA%\\..\\..\\ /S /M Desktop.rar\n/C \"cmd /c (c:\\progra~1\\winrar\\winrar.exe x -inul -o+ @path||c:\\progra~2\\winrar\\winrar.exe x inul -o+ @path)&&_\\_\\_\\_\\_\\_\\putty.exe\")\"\n\n\n-----\n\n_Putty.exe is masquerading as a normal executable; its original file name is AppXUpdate.exe._\nWhen it is executed, it sideloads CefBrowser.dll and executes the main routine in its export\nfunction, CCefInterface::SubProcessMain. It also abuses schtasks for persistence.\n\nFigure 8. Type B's malicious routine\n**Type C: Fake file extensions**\n\nIn this case, China VS Taiwan.rar contains several files, including:\n\n**Filename** **Detection** **Description**\n\n_China VS Taiwan.rar_ _China VS Taiwan.exe_ First-stage\nlegitimate\nexecutable for\nDLL\nsideloading\n\n_libcef.dll_ Trojan.Win32.TONEINS First-stage\nmalware\n\n_~$20220817.docx_ Second-stage\nlegitimate\nexecutable for\nDLL sideloading\n\n_~$20220617(1).docx_ Backdoor.Win32.TONESHELL Second-stage\nmalware\n\n\n-----\n\n_15-8-2022.docx_ Decoy\ndocument\n\n\n_China VS_\n_Taiwan(1).docx_\n\nTable 3. Files in the archive of Type C\n\n\nDecoy\ndocument\n\n\n_libcef.dll (detected by Trend Micro as Trojan.Win32.TONEINS) is an installer for the next-_\nstage malware. It copies two files with names starting with \"~\", in this case,\n_~$20220817.docx and ~$20220617(1).docx to <%USERPROFILE%\\Pictures>. Both files_\nhave fake file extensions and masquerade as the temporary files generated while opening\nMicrosoft Office software.\n\nFigure 9. Type C’s malicious routine\n**Malware**\n\nIn this campaign, we identified the following malware used, namely PUBLOAD, TONEINS,\nand TONESHELL.\n\n**Trojan.Win32.PUBLOAD**\n\n\n-----\n\nPUBLOAD is a stager that can download the next-stage payload from its command-and[control (C&C) server. This malware was first disclosed by Cisco Talos in May 2022.](https://blog.talosintelligence.com/2022/05/mustang-panda-targets-europe.html)\n\nOnce the .dll is executed, it first checks if the same process is already running by calling\n[OpenEventA. According to the tweet posted by Barberousse, some noteworthy event names](https://twitter.com/barberousse_bin/status/1540063661431177216)\nare identified as usernames of other cybersecurity researchers on Twitter, such as\n[\"moto_sato\", \"xaacrazyman_armyCIAx,\" and \"JohnHammondTeam.\" It is important to note](https://twitter.com/58_158_177_102)\nthat these researchers have nothing to do with PUBLOAD but were simply and intentionally\nmentioned by the threat actors in the binaries.\n\nFigure 10. An example of the special\n\nevent name in PUBLOAD\n**Persistence**\n\nPUBLOAD creates a directory in <C:\\Users\\Public\\Libraries\\> and drops all the malware,\nincluding the malicious DLL and the legitimate executable, into the directory. It then tries to\nestablish persistence in one of the following ways:\n\n1.   Adding a registry run key\n\ncmd.exe /C reg add HKCU\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run /v\nGraphics /t REG_SZ /d \\\"Rundll32.exe SHELL32.DLL,ShellExec_RunDLL\n\\\"C:\\\\Users\\\\Public\\\\Libraries\\\\Graphics\\\\AdobeLicensing.exe\\\"\\\" /f\n\n2.   Creating a schedule task\n\nschtasks.exe /F /Create /TN Microsoft_Licensing /sc minute /MO 1 /TR\nC:\\\\Users\\\\Public\\\\Libraries\\\\Graphics\\\\AdobeLicensing.exe\n\n**Anti-Antivirus: API with callback**\n\n\n-----\n\nPUBLOAD malware decrypts the shellcode in AES algorithm in memory. The shellcode is\ninvoked by creating a thread or using different APIs. The APIs can accept an argument of a\ncallback function, working as an alternative to trigger the shellcode. We observed several\nleveraged APIs including GrayStringW, EnumDateFormatsA, and LineDDA, and can be\nconsidered as a technique to bypass antivirus monitoring and detection.\n\nFigure 11. An example of shellcode callback in PUBLOAD\n\n\n-----\n\nFigure 12. APIs that accept a callback function\n**C&C protocol**\n\nThe decrypted PUBLOAD shellcode collects the computer name and the username as the\npayload of the first beacon. The payload will then be encrypted with the predefined RC4\n(Rivest Cipher 4) key. As of this writing, all the stagers we have seen so far share the same\nkey.\n\nAfter the encryption, the stager uses a specific byte sequence as its packet’s header. It\nprepends the magic bytes \"17 03 03\" and the payload size before the encrypted data.\n\nFigure 13. The RC4 key used (top) and the packet body in PUBLOAD malware (bottom)\n\n**Name** **Offset** **Size** **Description**\n\n\n-----\n\nmagic 0x0 0X3 17 03 03\n\nsize 0x3 0x2 Payload size\n\npayload 0x5 [size] Payload\n\nTable 4. Request packet format in PUBLOAD\n\nThe stager also checks if the response packet has the same magic header, “17 03 03”. If so,\nthe downloaded payload in memory will be treated as a piece of shellcode and will be\nexecuted directly.\n\n**Noteworthy debug strings**\n\nIn early 2022, we found some samples of PUBLOAD embedded with debug strings. They are\nused to distract analysts from the main infection routines.\n\nFigure\n\n14. The distracting debug strings in PUBLOAD\nAfter US House Speaker Nancy Pelosi’s visit to Taiwan in August, we found an archive file\nnamed \"裴洛西訪台後民意匯總.rar\" (translated as “The public opinion summary of Pelosi's\nvisit to Taiwan”) in Traditional Chinese, but we could only get one of the malicious DLLs\ninside the archive file. Since the topic indicated in the file name itself is considered a\ncontroversial topic, it appears potentially catchy to the targeted recipient. The DLL turned out\nto be a PUBLOAD stager with several output debug strings.\n\n\n-----\n\n-----\n\nFigure 15. Debug strings in PUBLOAD\n**Trojan.Win32.TONEINS**\n\nTrojan.Win32.TONEINS is the installer for TONESHELL backdoors. The installer drops the\nTONESHELL malware to the %PUBLIC% folder and establishes the persistence for it.\nTONEINS malware usually comes in the lure archives, and in most cases, the name of the\nTONEINS DLL is libcef.dll. The malicious routine is triggered via calling its export function\n_cef_api_hash._\n\nThe TONEINS malware is obfuscated, likely to slow down malware analysis. It contains a lot\nof junk codes in its control flow and has plenty of useless XOR instructions as though to\nimply that these are used to decode strings. Upon checking, we found that these obfuscated\n[codes were reused from an open-source repository.](https://github.com/Tai7sy/vs-obfuscation)\n\nFigure 16. Code\n\nobfuscation in TONEINS\nThe installer establishes the persistence for TONESHELL backdoors by using the following\n_schtasks command:_\n\nschtasks /create /sc minute /mo 2 /tn \"ServiceHub.TestWindowStoreHost\" /tr\n\"C:\\Users\\Public\\Pictures\\ServiceHub.TestWindowStoreHost.exe\" /f\n\nBased on our observations, the file names for the dropped TONESHELL malware differ in\ncase, and so do the names of the scheduled tasks. After persistence is established,\nTONESHELL then copies the legitimate executable and the malicious DLL to the\n_%PUBLIC% folder, wherein both files have names that start with “~” in the lure archive. In_\nthis sample, ~$20220817.docx is a legitimate executable used for DLL sideloading, and\n_~$20220617(1).docx is the TONESHELL backdoor DLL to be installed._\n\n\n-----\n\nFigure 17. Files with fake file extensions\n**Backdoor.Win32.TONESHELL**\n\nThe TONESHELL malware is the main backdoor used in this campaign. It is a shellcode\nloader that loads and decodes the backdoor shellcode with a 32-byte key in memory. In the\nearlier version of TONESHELL, it has the capabilities from TONEINS malware, including\nestablishing persistence and installing backdoors. However, the more recent version of\nTONESHELL is a standalone backdoor without any installer capabilities (such as the file\n_~$Talk points.docx). It is also obfuscated in a similar fashion to TONEINS malware,_\nindicating that the actors continue to update the arsenal and separate the tools in order to\nbypass detection.\n\n**Anti-Analysis: Process name check**\n\nIn order to make sure that the TONESHELL is installed correctly,\nBackdoor.Win32.TONESHELL first checks if the process path matches the expected one. If\nso, the malicious code could be triggered by the custom exception handler.\n\nFigure 18. Process name check in TONESHELL\n**Anti-Analysis: Custom exception handler in C++**\n\nInterestingly, the adversary hides the actual code flow with the implementation of custom\nexception handlers. Different exception handlers will be invoked based on the result of the\nprocess name check, continuing the malicious routine by triggering the exception with the\ncall _CxxThrowException. After it is invoked, the C++ runtime will find the corresponding\nexception handler from the ThrowInfo structure all the way down to the CatchProc member in\nthe _msRttiDscr structure, which contains the real malicious codes. In this sample, the\nexception handler is located at the offset 0x10005300. This technique not only hides the\nexecution flow but also stops the execution of the analyst's debugger.\n\n\n-----\n\nFigure 19. Data workflow of exception handling in C++; the CatchProc member in the yellow\ncircle is the malicious exception handler to be invoked\n\nFigure 20. The main malicious routine in the exception handler\n**Anti-Analysis: ForegroundWindow check**\n\nLooking at more recent TONESHELL samples, we noticed that a new anti-sandbox\ntechnique is added compared to the earlier versions. The newer versions invoke the\nGetForegroundWindow API twice and check if there is any window switch. If the environment\nis a sandbox, both calls will get the same window handle because there is no human\ninteraction involved in most sandboxes, resulting in the foreground window not changing. In\naddition, as an anti-sandbox and delayed execution technique, the malicious routine can only\nbe triggered if the foreground window has already been switched for the fifth time.\n\nFigure\n\n21. GetForegroundWindow check in newer TONESHELL samples\n\n\n-----\n\nFigure 22. Malicious routine triggered on the fifth window switch\n**Shellcode decoding**\n\nAfter the malicious exception handler is triggered, it starts to decode the next-stage\nTONESHELL shellcode. To decode the shellcode, it first decodes a 32-byte key in XOR\noperations with 0x7D, and the key will then be used to decode the shellcode body.\n\nFigure 23. An\n\nexample of the 32-byte key (top) and the TONESHELL shellcode before decoding (middle)\nand after decoding (bottom)\n**Evolving variants**\n\nAfter our analysis and further threat hunting, we found several variants of TONESHELL\nshellcode:\n\n**First observed** **Variant** **Protocol** **C&C encryption** **Supported functions**\n\nMay 2022 A Raw TCP RC4 File upload\nFile download\nFile execution\nLateral movement\n\nJul 2022 B Raw TCP 32-byte XOR File upload\nLateral movement\n\nSep 2021 C HTTP RC4 File upload\nFile execution\n\nTable 5. Differences between TONESHELL variants\n\n**Variant A**\n\n\n-----\n\nTONESHELL supports up to 10 C&C servers by design, but in all the samples we\nencountered only one C&C server was used. Before connecting to the C&C server, it\ngenerates a victim ID (the variable unique_id) with the victim's volume serial and the\ncomputer name, or with a randomly generated GUID.\n\nFigure 24. Finding 10 C&C servers supported in TONESHELL\n\nFigure 25. The algorithm used to generate the victim’s ID in TONESHELL variant A\nIn the first beacon, it collects the following data from the victim's machine and sends them to\nthe C&C server:\n\n1. Current process ID\n2. Volume serial\n3. Username\n4. Computer name\n5. Product name\n6. Operating system bit\n7. Processes list\n\nTONESHELL communicates over raw TCP, with the request header and the response\nheader starting with the specific magic byte sequence \"17 03 03\". Based on our research,\nthis magic header is used in all TONESHELL TCP variants and the identified PUBLOAD\n\n\n-----\n\nmalware. The payload in the packet will be encrypted in RC4 algorithm. In this variant, its\nrequest packet format is as follows:\n\n**Name** **Offset** **Size** **Description**\n\nmagic 0x0 0x3 17 03 03\n\nsize 0x3 0x2 Payload size\n\ntype 0x5 0x1 Connection type, 0x0 or 0x1\n\nunique_id 0x6 0x4 Victim ID\n\npayload 0x10 [size] Payload\n\nTable 6. Request packet format in TONESHELL variant A\n\nFigure 26. Packet header check in\n\nTONESHELL (all TCP variants and stagers)\nThe backdoor supports various functions, including file upload, file download, file execution,\nand lateral movement. We also noticed that its internal strings are self-explanatory. In fact,\nthis malware is named TONESHELL after the typo found in its command \"TOnePipeShell\".\nThe following table shows all of its commands:\n\n**Code** **Internal string** **Additional description**\n\n0x1 - Reset OnePipeShell & TwoPipeShell\n\n0x7 - Reset OnePipeShell & TwoPipeShell\n\n0x3 - Unknown\n\n0x4 - Change sleep seconds\n\n0x1A Upload file\nbegin\n\n0x1B Upload file\nbegin\n\n0x1D Upload file\ncancel\n\n0x1C Upload file\nEndup\n\n0x10 Exec file\n\n\n-----\n\n0x21 Create\nTOnePipeShell\n\n0x22 OnePipeShell\nClose\n\n0x1E TwoPipeShell\nCreate\n\n0x1F TwoPipeShell\nWrite File\n\n0x20 TwoPipeShell\nClose\n\n0x18 Download\n\n0x19 CDownUpLoad\n\n\nOnePipeShell: one-way shell over one named pipe (meant for\ndata exchange on intranet)\n\nTwoPipeShell: two-way shell over two named pipes (meant for\ndata exchange on intranet)\n\n\n0x21 - Exit\n\nTable 7. Command codes in TONESHELL variant A\n\n**Variant B**\n\nTONESHELL variant B is slightly different from variant A wherein the victim ID is generated\nfrom the tick count, username, and computer name instead.\n\nFigure 27. Different\n\nalgorithm for the victim ID generation in TONESHELL variant B\nThe backdoor's protocol is also different. The payload in the packet is encoded with a\nrandom 32-byte key, and the key differs from packet to packet. The new key is generated\nwhenever a new request is made.\n\n**Name** **Offset** **Size** **Description**\n\nmagic 0x0 0x3 17 03 03\n\nsize 0x3 0x2 Payload size\n\n\n-----\n\nkey 0x5 0x20 32-byte XOR key\n\npayload 0x25 [size] Payload\n\nTable 8. Request packet format in TONESHELL variant B\n\nFigure\n\n28. In TONESHELL variant B, the payload will be encoded in XOR operations before a\nrequest is made.\nThe command codes in this variant are as follows:\n\n**Code** **Internal string** **Description**\n\n0x9 - Reset OnePipeShell\n\n0xA - Reset OnePipeShell\n\n0x3 - Unknown\n\n0x4 - Change sleep seconds\n\n0x4 Upload file begin\n\n0x5 Upload file write\n\n0x7 Upload file cancel\n\n0x6 Upload file Endup\n\n0x3 Create TOnePipeShell\n\nTable 9. Command codes in TONESHELL Variant B\n\n**Variant C**\n\nDuring our research, we hunted a dumped TONESHELL shellcode from VirusTotal (SHA256:\n521662079c1473adb59f2d7134c8c1d76841f2a0f9b9e6e181aa54df25715a09). Our analysis\nshowed it works similar to the two different variants, but the C&C protocol used is HTTP. It\n\n\n-----\n\nseems to be the earlier version of TONESHELL because the sample was uploaded in\nSeptember 2021, and uses the POST method for the first beacon. The following data is\ncollected from the victim's machine:\n\n1. Memory size\n2. Username\n3. Computer name\n4. Disk size\n5. Operating system bit\n6. Product name\n\nFigure 29.\n\nThe first HTTP beacon request in TONESHELL Variant C\nThe victim's ID (specified by the \"Guid\" header in the first beacon and later used in the\n\"Cookie\" header) is also generated from a random GUID. The body is also encrypted in RC4,\nand the command codes are much like Variant B as follows:\n\n**Code** **Internal string** **Additional description**\n\n0x2 - Reset OnePipeShell\n\n0x7 - Reset OnePipeShell\n\n0x3 - Unknown\n\n0x4 - Change sleep seconds\n\n0x1A Upload file begin\n\n0x1B Upload file write\n\n\n-----\n\n0x1D Upload file cancel\n\n0x1C Upload file Endup\n\n0x10 Exec file\n\nTable 10. Command codes in TONESHELL variant C\n\n## Threat hunting\n\nWe observed that several TONESHELL and TONEINS malware samples were uploaded to\nVirusTotal in recent months. With the help of these, we collected several Google Drive links,\nsuch as 770d5b60d8dc0f32941a6b530c9598df92a7ec76b60309aa8648f9b3a3f3cca5.\n\nFigure 30. Example of a Google Drive link, found in the wild, containing both TONESHELL\nand TONEINS\nUsually, we see such download links as the first arrival vectors. The Google Drive direct\ndownload link is represented in the format https[:]//drive.google.com/uc?\n_id=gdrive_file_id&export=download. The gdrive_file_id is a unique identifier for this specific_\nfile. We can switch to web viewer to check its file contents and its owner by modifying the\nURL: https[:]//drive.google.com/file/d/gdrive_file_id/view.\n\nIn the details panel, we can find the owner of this file, and by hovering on the icon we can get\nthe email address.\n\nFigure 31. The web viewer of Google Drive\n\n\n-----\n\nFigure 32. The file owner's\n\nname and email address\nWe can conduct further research with this specific email account. For example, after our\ninvestigation, we know that the actors abused the same email address to store the lure\narchives in Google Drive, as well as deliver the phishing email. If we hunt for this specific\nemail address in the monitoring logs, we might find more distributed malware.\n\n## Attribution\n\nThe observed TTPs in this campaign are similar to the campaign mentioned by\n[Secureworks. Both campaigns abused the .lnk files to trigger the malware. Compared to the](https://www.secureworks.com/blog/bronze-president-targets-government-officials)\nsaid report’s observations, the archive we found in this campaign share similar folder\nstructures.\n\nFigure 33. Similar folder structure of BRONZE PRESIDENT (left) and Earth Preta (right)\nBased on the same report, Bronze President was known to be leveraging APIs with a\ncallback function argument to invoke the shellcode like EnumThreadWindows. Similar\ntechniques are also used in PUBLOAD malware.\n\nIn addition, we also spotted a link between the two campaigns: One of the C&C servers\n(98[.]142[.]251[.]29) can be correlated to a shortcut file. This shortcut file appears in one lure\narchive “EU 31 session of the Commission on Crime Prevention and Criminal Justicest\n_United Nations on Drugs and Crime.rar” (SHA256:_\n09fc8bf9e2980ebec1977a8023e8a2940e6adb5004f48d07ad34b71ebf35b877), which the\n[Secureworks report also mentioned. We used the tool LECmd to parse the shortcut files](https://github.com/EricZimmerman/LECmd)\nwherein we found the specific C&C string inside the metadata of the .lnk file. It seems that\nthe actor used the C&C string as the folder name.\n\n\n-----\n\nFigure 34. Metadata of the .lnk file (SHA256:\na693b9f9ffc5f4900e094b1d1360f7e7b907c9c8680abfeace34e1a8e380f405)\n[Third, the infection chains mentioned by Cisco Talos also resemble what we have observed](https://blog.talosintelligence.com/2022/05/mustang-panda-targets-europe.html)\nrecently:\n\n1. Both use schtasks and registry run key for persistence.\n2. Both use benign executables for DLL sideloading.\n3. Both use malicious archives for arrival vectors.\n\nMost importantly, the stager mentioned in the report uses the same magic header (17 03 03)\nas TONESHELL does in the C&C communication protocol, thereby solidifying these malware\nfamilies’ link to Earth Preta.\n\n## Conclusion\n\nEarth Preta is a cyberespionage group known to develop their own loaders in combination\nwith existing tools like PlugX and Cobalt Strike for compromise. Recent research papers\nshow that it is constantly updating its toolsets and indicate that it is further expanding its\ncapabilities.\n\nBased on our analysis, once the group has infiltrated a targeted victim’s systems, the\nsensitive documents stolen can be abused as the entry vectors for the next wave of\nintrusions. This strategy largely broadens the affected scope in the region involved. For the\ngroup’s objectives, the targeted area appears to be the countries in Asia.\n\nAs part of organizational mitigation plans, we recommend implementing continuous phishing\nawareness trainings for partners and employees. We advise always checking the sender and\nthe subject twice before opening an email, especially with an unidentifiable sender or an\nunknown subject. We also recommend a multi-layered protection solution is recommended to\ndetect and block threats as far left to the malware infection chain as possible.\n\nMITRE ATT&CK\n\n\n-----\n\nMITRE ATT&CK table\n\n## Indicators of Compromise (IOCs)\n\n[The full list of IOCs can be found here.](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/22/k/earth-preta-spear-phishing-governments-worldwide/IOCs-earth-preta-spear-phishing-since-march.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-11-18 - Earth Preta Spear-Phishing Governments Worldwide.pdf"
    ],
    "report_names": [
        "2022-11-18 - Earth Preta Spear-Phishing Governments Worldwide.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1691c25f-1aa4-4168-8ce2-7aa8f23246e7",
            "created_at": "2024-06-04T02:03:07.724221Z",
            "updated_at": "2025-03-27T02:05:17.284601Z",
            "deleted_at": null,
            "main_name": "BRONZE PRESIDENT",
            "aliases": [
                "Mustang Panda ",
                "Red Lich ",
                "Temp.Hex ",
                "HoneyMyte "
            ],
            "source_name": "Secureworks:BRONZE PRESIDENT",
            "tools": [
                " Cobalt Strike",
                " ORat",
                " PlugX",
                " RCSession",
                "China Chopper"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b69037ec-2605-4de4-bb32-a20d780a8406",
            "created_at": "2023-01-06T13:46:38.790766Z",
            "updated_at": "2025-03-27T02:00:02.919758Z",
            "deleted_at": null,
            "main_name": "MUSTANG PANDA",
            "aliases": [
                "TEMP.HEX",
                "TA416",
                "TANTALUM",
                "Twill Typhoon",
                "Earth Preta",
                "Stately Taurus",
                "LuminousMoth",
                "Polaris",
                "BRONZE PRESIDENT",
                "HoneyMyte",
                "Red Lich"
            ],
            "source_name": "MISPGALAXY:MUSTANG PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9baa7519-772a-4862-b412-6f0463691b89",
            "created_at": "2022-10-25T15:50:23.354429Z",
            "updated_at": "2025-03-27T02:00:55.45162Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Mustang Panda",
                "TA416",
                "RedDelta",
                "BRONZE PRESIDENT"
            ],
            "source_name": "MITRE:Mustang Panda",
            "tools": [
                "Cobalt Strike",
                "RCSession",
                "NBTscan",
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "2ee03999-5432-4a65-a850-c543b4fefc3d",
            "created_at": "2022-10-25T16:07:23.882813Z",
            "updated_at": "2025-03-27T02:02:10.0116Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Bronze President",
                "Camaro Dragon",
                "Earth Preta",
                "HoneyMyte",
                "Mustang Panda",
                "Operation SMUGX",
                "Operation SmugX",
                "PKPLUG",
                "Red Lich",
                "Stately Taurus",
                "TEMP.Hex"
            ],
            "source_name": "ETDA:Mustang Panda",
            "tools": [
                "9002 RAT",
                "AdFind",
                "Agent.dhwf",
                "Agentemis",
                "CHINACHOPPER",
                "China Chopper",
                "Chymine",
                "ClaimLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "DCSync",
                "DOPLUGS",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Farseer",
                "Gen:Trojan.Heur.PT",
                "HOMEUNIX",
                "Hdump",
                "HenBox",
                "HidraQ",
                "Hodur",
                "Homux",
                "HopperTick",
                "Hydraq",
                "Impacket",
                "Kaba",
                "Korplug",
                "LadonGo",
                "MQsTTang",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "NBTscan",
                "NetSess",
                "Netview",
                "Orat",
                "POISONPLUG.SHADOW",
                "PUBLOAD",
                "PVE Find AD Users",
                "PlugX",
                "Poison Ivy",
                "PowerView",
                "QMAGENT",
                "RCSession",
                "RedDelta",
                "Roarur",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TONEINS",
                "TONESHELL",
                "TVT",
                "TeamViewer",
                "Thoper",
                "TinyNote",
                "WispRider",
                "WmiExec",
                "XShellGhost",
                "Xamtrav",
                "Zupdax",
                "cobeacon",
                "nbtscan",
                "nmap",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1683338942,
    "ts_updated_at": 1743041807,
    "ts_creation_date": 1683252213,
    "ts_modification_date": 1683252213,
    "files": {
        "pdf": "https://archive.orkl.eu/1200b4c9c647d011daf63702e399272eb4a8e245.pdf",
        "text": "https://archive.orkl.eu/1200b4c9c647d011daf63702e399272eb4a8e245.txt",
        "img": "https://archive.orkl.eu/1200b4c9c647d011daf63702e399272eb4a8e245.jpg"
    }
}