{
    "id": "f3376c6d-53cf-4081-91f7-be36d7edabce",
    "created_at": "2023-01-12T15:01:01.60423Z",
    "updated_at": "2025-03-27T02:05:19.34121Z",
    "deleted_at": null,
    "sha1_hash": "d650b54cff7d408d5e934b842a64eba28408197d",
    "title": "2022-01-04 - Leveraging the Power of KQL in Incident Response",
    "authors": "",
    "file_creation_date": "2022-05-27T23:12:38Z",
    "file_modification_date": "2022-05-27T23:12:38Z",
    "file_size": 499020,
    "plain_text": "# Leveraging the Power of KQL in Incident Response\n\n**techcommunity.microsoft.com/t5/security-compliance-and-identity/leveraging-the-power-of-kql-in-incident-**\nresponse/ba-p/3044795\n\nJanuary 4, 2022\n\nJan 04 2022 09:00 AM\n\nWhen your organization is faced with investigating a security incident, whether that’s\nsomething as simple as a phishing campaign or more complex like a determined human\nadversary, time is of the essence. Collecting and analyzing data are two critical things that\nneed to be performed to quickly get an understanding of the initial scope and impact of the\nincident. There are several variables around both collecting and analyzing data that can\naffect the speed at which you might be able to respond. While the method or process of\ncollecting data (or even the availability of relevant incident data) is unique to each\norganization, the analysis of that data is something that can be sped up to reduce the time it\ntakes to make tactical and strategic decisions.\n\nIn this blog, we’ll show you how the Microsoft Detection and Response Team (DART) uses\nthe Kusto Query Language (KQL) to quickly analyze data during incident response\ninvestigations.\n\n## Why KQL?\n\nKusto allows for [various ingestion methods and](https://docs.microsoft.com/en-us/azure/data-explorer/ingest-data-overview) [various data formats. Data can be structured](https://docs.microsoft.com/en-us/azure/data-explorer/ingestion-supported-formats)\n[to best suit your use case in a table using data mappings, and when use cases arise that call](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/management/mappings)\nfor additional data (e.g., third party logs) you can import on the fly via Azure Data Explorer\n\n\n-----\n\nusing [One-Click Ingestion. In order to query the data, we use and recommend Azure Data](https://docs.microsoft.com/en-us/azure/data-explorer/ingest-data-one-click)\nExplorer.\n\n### Data Sources\n\nWhen Microsoft DART is on the prowl for threat actors in customer environments, we\nleverage Microsoft Defender for Endpoint and Microsoft Defender for Identity as two primary\ndata sources. Of course, we do not limit our scope to just Microsoft security products. Every\norganization has its own third-party logs that are vital to the investigation, which typically\nincludes firewalls, VPNs, proxy logs, etc. We take all of this data and ingest it into a Kusto\ncluster and database to leverage KQL for fast and efficient analysis.\n\n### Analyzing data to scope the attack impact\n\nThe ultimate outcome of data analysis is to be able to make decisions based on what the\ndata is telling us. Specifically with incident response investigations, data analysis plays a vital\nrole in being able to scope the impact of the attack, identify new leads to hunt down, and\nprovide insight into how to contain the threat. Leaders within the organization need the\nresults of this analysis to quickly understand what they’re facing and to make decisions\nbased on factual data. In the all-too-common cases of a ransomware attack, you may be\nfaced with the decision to minimize the threat by shutting down network access. Do you have\nenough information to warrant a shutdown of the entire network or are only certain sites\naffected? Having analysis completed quickly can help in turn allow for faster decisionmaking.\n\nWhat used to take hours with reviewing logs in Excel or even SQL databases, can now be\ndone in seconds with KQL. This is possible in part due to the power of KQL which comes\nfrom native functions that help quickly parse and/or convert data to something more\nmeaningful to an analyst. Some example functionality this provides is being able to decode\nBase64 data, parse URLs, and even parse command line arguments. Additionally, for any\nparsing or working with data that requires a bit more complexity than native querying, KQL\ndoes have plug-ins that can extend its use by leveraging Python and R.\n\n## Built-in Functions useful for Incident Response\n\nNot unlike other large-data or database query languages, KQL allows you to:\n\nfilter your data (with ‘where’ clauses);\npresent your data (with either ‘project’ or ‘render’ clauses); and\naggregate your data (with ‘summarize’ clauses).\n\nThe real power of KQL, though, comes from its various native functions that can be used to\nparse or transform data on the fly, including (and certainly not limited to) :\n\n[base64 decode tostring()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/base64_decode_tostringfunction)\n\n\n-----\n\n[gzip_decompress_from_base64_string()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/gzip-base64-decompress)\n[ipv4_is_private()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/ipv4-is-privatefunction)\n[parse_command_line()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parse-command-line)\n[parse_json()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parsejsonfunction)\n[parse_path()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parsepathfunction)\n[parse_url()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parseurlfunction)\n[parse_urlquery()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parseurlqueryfunction)\n[parse_user_agent()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parse-useragentfunction)\n[parse_xml()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/parse-xmlfunction)\n[url_decode()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/urldecodefunction)\n[zlib_decompress_from_base64_string()](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/zlib-base64-decompress)\n\nThese functions are named in a self-explanatory way, but let’s look at a couple use cases\nthat we’ve run across.\n\n### Decoding a suspicious PowerShell command\n\n_Sample suspicious PowerShell command decoded via KQL._\n\nThe suspicious command referenced here contains a value that is Gzip compressed and\nBase64 encoded. Here we’re using the built-in function parse_command_line() and\ngzip_decompress_from_base64_string() to get the plaintext.\n\n### Parsing a file path using parse_path()\n\n_Sample of parse_path function usage and resulting output._\n\nNotice how in this example we’re able to use parse_path() which returns a dynamic object of\nthe various path components (Scheme, RootPath, DirectoryPath, etc) that can then be\nqueried using either bracket or dot notation.\n\n### Parsing a suspicious URL using parse_url()\n\n\n-----\n\n_Sample of parse_url function usage and resulting output._\n\nHere we use parse_url() in order to break down the URL into its various components. The\nresult is a dynamic object that (similar to parse_path() example above), can be queried via\nbracket or dot notation.\n\n### Custom Functions\n\nAlong with the previously mentioned built-in functions, custom functions can also be created.\nThis allows for the ability to write a query and save it for re-use without having to re-write the\nquery again. Some examples of these can be found on Github for Microsoft 365 Defender\nAdvanced Hunting.\n\nCustom functions go beyond only being able to surface artifacts of interest. Functions can\nadd context to an artifact. Take the example of a malicious file created on a system:\n\n_C:\\Windows\\temp\\evil.exe_\n\nA function can be created to identify what else may have occurred within a set timeframe\naround the creation of that file. Depending on the data that is collected, this can include other\nfile creations, modifications, event log entries, and more.\n\nThe custom function called EventsWithinTimeframe() accepts 3 parameters:\n\nFilepath – in this case, our example from earlier “C:\\Windows\\temp\\evil.exe”\nTimestamp type – for this example we’re focusing on the creation date\nWindow of time – using 3h to indicate 3-hour time window before or after the creation\ndate\n\nThe underlying query of the function takes the CreationDate of the artifact\n(C:\\Windows\\temp\\evil.exe) and returns all relevant events (event log entries, other file\ncreation events, etc.) that surround the creation time of the artifact +/- 3 hours. Of course, the\ndata you collect may be different and the underlying query will differentiate based on the\nschema of the data, however, the logic for this example is something that can be\nimplemented to suit your requirements.\n\n\n-----\n\nCustom functions are limited only by your imagination. These can be simple one-line queries\nthat help surface a particular artifact, a “utility” type function that converts data to a different\nformat, or a more advanced type query that can provide a full context around a given artifact.\nYou can even invoke functions within functions. Thanks to the power and flexibility of KQL\nthe possibilities are endless.\n\n### Joining and External Data\n\nJust like other query languages, KQL can perform a variety of joins. Kusto extends this\ncapability beyond the current database to cross-cluster joins and even allows for external\ndata sources to be queried and referenced. While joining is commonly done when enriching\nthe context of current artifacts of interest (e.g., to another database that contains information\nabout threat actor C2 infrastructure), let’s focus on the external data sources to show how\nthis can be leveraged during incident response engagements, as well.\n\n_Using externaldata() to reference SHA256 hashes_\n\n_Sample query using externaldata operator_\n\n[This example is taken from a query shared on Microsoft 365 Defender Hunting Queries that](https://github.com/microsoft/Microsoft-365-Defender-Hunting-Queries/blob/773ebb498e0aa897678be98c34ffa56359bf29d9/Initial%20access/Check%20for%20Maalware%20Baazar%20(abuse.ch)%20hashes%20in%20your%20mail%20flow.md)\nchecks for SHA256 hashes in an external feed against the SHA256 hashes from mail flow\ndata. What’s great about this is that there is minimal setup to get the external data made\nuseful for enriching the data being analyzed. You can work with a variety of file formats (CSV,\nJSON, TXT, etc.) and extract the data you need for working with it further.\n\n## Going even further with KQL\n\nBeyond the functions that are built-in which help during an incident response investigation,\nKQL allows for even more capability and flexibility by being able to extend its usage with\n[plugins. Incident responders will appreciate the R and](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/rplugin?pivots=azuredataexplorer) [Python plugins that Kusto offers to](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/pythonplugin?pivots=azuredataexplorer)\nwork with data beyond what is possible in native KQL today.\n\nBoth plugins allow for working with tabular input and will produce tabular output that can be\nworked with in any follow-on KQL. For the example below, we’ll be focusing on Python.\n\n### Recreating PowerShell Script from Event Logs\n\n\n-----\n\nIn certain cases, the only remaining artifact that gives the executed PowerShell comes from\nthe PowerShell Operational Event ID 4104 entries, otherwise known as script block logging.\nIn certain cases, the entirety of the PowerShell script is divided into multiple script blocks\nwhich must then be merged back together to view the full script. We’ll be using Python to\naccomplish this.\n\nLines 1 and 27 are the actual creation of the function. Lines 2 through 10 are used to query\nour collected data and prepare it for working with Python. Line 11 sets up the output column\n[for our Python script. Line 12 uses the evaluate operator in order to invoke the Python plugin.](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/evaluateoperator)\nLines 13 through 24 are the actual Python that we use to work with the data as a Pandas\ndataframe. Note that Pandas and numpy are imported by default and other supported Python\n[libraries can be imported as needed.](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/pythonplugin?pivots=azuredataexplorer#install-packages-for-the-python-plugin)\n\n## Conclusion\n\nKQL allows for speed and flexibility when working with large datasets during incident\nresponse engagements. The built-in functions that are used to parse various pieces of data\nallow for analysts to work with what matters to them, rather than spending additional time\ntrying to manually parse and process data. Custom functions provide users a method for\ntaking a query and turning it into a sharable and repeatable action. KQL is further leveraged\nby enabling users to use scripting languages, such as R and Python, as another way to work\nwith data. Combined, these attributes and functionality, make KQL a highly effective tool for\nincident responders.\n\n_[This blog and its contents are subject to the Microsoft Terms of Use. All code and scripts are](https://www.microsoft.com/en-us/legal/intellectualproperty/copyright)_\n_subject to the applicable terms on Microsoft’s GitHub Repository (e.g., the MIT License)._\n\nTags:\n[DaRT](https://techcommunity.microsoft.com/t5/tag/DaRT/tg-p/board-id/MicrosoftSecurityandCompliance)\n[KQL](https://techcommunity.microsoft.com/t5/tag/KQL/tg-p/board-id/MicrosoftSecurityandCompliance)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-04 - Leveraging the Power of KQL in Incident Response.pdf"
    ],
    "report_names": [
        "2022-01-04 - Leveraging the Power of KQL in Incident Response.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535661,
    "ts_updated_at": 1743041119,
    "ts_creation_date": 1653693158,
    "ts_modification_date": 1653693158,
    "files": {
        "pdf": "https://archive.orkl.eu/d650b54cff7d408d5e934b842a64eba28408197d.pdf",
        "text": "https://archive.orkl.eu/d650b54cff7d408d5e934b842a64eba28408197d.txt",
        "img": "https://archive.orkl.eu/d650b54cff7d408d5e934b842a64eba28408197d.jpg"
    }
}