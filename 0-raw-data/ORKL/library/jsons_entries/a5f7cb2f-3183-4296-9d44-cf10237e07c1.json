{
    "id": "a5f7cb2f-3183-4296-9d44-cf10237e07c1",
    "created_at": "2022-10-25T16:48:22.482486Z",
    "updated_at": "2025-03-27T02:05:41.614589Z",
    "deleted_at": null,
    "sha1_hash": "6eacd4eacbf06b45b4f041e63d77aaf7bec5d333",
    "title": "Network Security",
    "authors": "",
    "file_creation_date": "2009-07-20T16:51:59Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 1371321,
    "plain_text": "## Netscreen of the Dead\n#### Developing a Trojaned Firmware for Juniper Netscreen\n Appliances\n\n\n-----\n\n# Cast\n\n##### Graeme Neilson\n\n Security Consultant Aura Software Security\n\n graeme@aurasoftwaresecurity.co.nz\n\n\n-----\n\n# Trailer\n\n##### • What if a core network security device was compromised?\n\n – an attacker has exploited a vulnerability\n\n – malicious appliance supplier\n\n – malicious third party support\n\n – malicious employee\n\n • This is a POST EXPLOIT, SERIAL CONSOLE or MITM attack.\n\n • Goal is hidden root control of the appliance.\n\n – Discuss reversing and modifying the firmware code\n\n\n-----\n\n# Opening Scene\n\n##### Netscreens are manufactured by Juniper Inc\n • All in one Firewall, VPN, Router security appliance.\n • SME to Datacentre scale (NS5XP – NS5000).\n • Common Criteria and FIPS certified.\n • Run a closed source, real time OS called ScreenOS.\n • ScreenOS is supplied as a binary firmware 'blob'.\n\n NS5XT Model:\n • PowerPC 405 GP RISC processor 64MB Flash\n • Serial console, Telnet, SSH, HTTP/HTTPS admin interfaces\n\n\n-----\n\n# Attack\n\n##### Attacking firmware - two vectors of attack:\n\n • Live evisceration: debugging with remote GDB debugger over serial line\n\n • Feeding on the remains: dead listing / static binary analysis using disassembler and hex editor\n\n PowerPC architecture\n • fixed instruction size of 4 bytes\n • flat memory model\n • 32 GP registers, no explicit stack, link register\n\n\n-----\n\n#  Live Evisceration\n\n##### • Embedded Linux Development Kit has GDB compiled for PowerPC 405 processor\n\n • No source so create custom .gdbinit for PPC registers and 'stack' to provide 'SoftICE' like context on breaks.\n\n • Network connection to the Netscreen and run:\n\n set gdb enable\n\n • Connect remote gdb via serial console\n\n\n-----\n\n##### • Worked:\n\n – Memory dumps\n\n – Query memory\n addresses\n\n • Didn't work:\n\n – Breakpoints\n\n – Single stepping\n\n\n-----\n\n# Feeding on the\n Remains\n\n/--------------------------\\    -\n\n###### Compared many different versions of ScreenOS firmware.\n\n| HEADER |    -\n\n###### Revealed a 4 section structure\n\n|--------------------------|\n\n|             |    -\n\n###### Header:\n\n|--------------------------| **sig** **sysinfo**\n\n|      STUB      | **00000000: EE16BA81** **00110A12 00000020 02860000**\n\n|--------------------------| **00000010: 004E6016 15100050 29808000 C72C15F7**\n\n|             | **size** **checksum**\n\n|--------------------------|\n\n|     UNKNOWN     | size = compressed image size – 79 bytes\n\n|--------------------------| sysinfo = 00, platform, cpu, version\n\n|             |\n\n|--------------------------|    -\n\n###### Stub contains strings relating to LZMA compression\n\n|   COMPRESSED BINARY  | algorithm.\n\n|   UPDATE BLOB [BUB]  |\n\n\n-----\n\n# Bub\n\n##### • The header of the Bub appears to be a customised LZMA header.\n\n • Comparative analysis again of different Bub headers.\n\n • The standard LZMA header has 3 fields:\n\n options, dictionary_size, uncompressed_size\n\n • 'Bub' header has 3 fields:\n\n signature bytes, options, dictionary_size\n\n###### 00012BF0: 00000000 00000000 00000000 00000000\n\n 00012C00: 01440598 5D002000 00007705 92C63DFC\n\n\n-----\n\n# Bub Can Change\n\n.\n######   Uncompress Bub\n\n    -\n###### Cut out the Bub from firmware file.\n\n    -\n###### Insert an uncompressed_size field of value -1 == unknown size \n\n    -\n###### Modify the dictionary_size from 0x00200000 to 0x00008000\n\n    -\n###### Then we can decompress the Bub using freely available LZMA utilities\n\n Compress Bub\n\n    -\n###### Compress the binary with standard LZMA utilities.\n\n    -\n###### Modify the dictionary_size field from 0x00002000 to 0x00200000.\n\n    -\n###### Delete the uncompressed_size field of 8 bytes.\n\n    -\n###### Insert new Bub into firmware file replacing original compressed blob.\n\n\n-----\n\n# Night of the Living\n Netscreen\n\n       -\n##### Cut out the compressed Bub section of the image.\n\n       -\n##### Uncompress the Bub.\n\n       -\n##### Modify the resulting binary to add or change code and /\n or data.\n\n       -\n##### Re-compress the modified binary into a new Bub.\n\n       -\n##### Prepend the original firmware header to the modified Bub.\n\n       -\n##### Upload the modified firmware over serial = SUCCESS.\n\n       -\n\n\n-----\n\n# Autopsy\n\n##### • Uncompressed Bub is ~20Mb ScreenOS binary with a header.\n\n • Want to load into IDA but need a loading address so that references within the program point to the correct locations.\n\n • From header: program_entry = address – offset\n\n###### signature offset address\n\n 00000000: EE16BA81 00010110 00000020 00060000\n\n 00000010: 01440578 00000000 00000000 F8A2FA6F\n\n##### • Confirm with live debugging\n\n\n-----\n\n# Autopsy ii\n\n/--------------------------\\    -\n\n##### Use IDA scripts to find function prologs \n\n|     HEADER     |\n\n##### (0x9421F*) and mark as code.\n\n|--------------------------|\n\n                 -\n\n|    SCREENOS CODE   | Mark strings in data section for cross\n\n|--------------------------|\n\n##### references.\n\n|    SCREENOS DATA   |\n\n                 -\n##### Use error strings to identify functions and\n\n|--------------------------|\n\n|   BOOT LOADER CODE   | rename.\n\n|--------------------------|    -\n\n##### Search for str_cmp, file_read, file_write,\n\n|   BOOT LOADER DATA   | login etc.\n\n|--------------------------|\n\n                 -\n##### Build up a picture of the binary structure\n\n|     0xFFs      |\n\n|--------------------------| and functions.\n\n|   other stuff! |    -\n\n##### Need to cut out boot loader and\n\n\\--------------------------/\n\n##### disassemble separately with loading\n\n\n-----\n\n# Netscreen of the\n Dead\n\n##### • ScreenOS Trojaned Firmware required functionality:\n\n – Install/Upgrade: Load trojan firmware via serial, tftp and web\n\n – Maintain Access: Include a back door login mechanism\n\n – Payload: Execute arbitrary code injected into the image\n\n\n-----\n\n# First Bite\n\n##### Install / Upgrade\n • Checksum and size in header are checked when images loaded over the network via TFTP or Web\n\n###### 00000000: EE16BA81 00110A12 00000020 02860000\n\n 00000010: 004E6016 15100050 29808000 C72C15F7 checksum\n\n##### • Checksum is calculated, could reverse the algorithm... but on loading any bad checksum value is printed to the console.\n\n • If we modify the firmware to print out the correct checksum value we would have a 'checksum calculator' firmware which we load modified firmware against.\n\n\n-----\n\n# First Bite ii\n\n###### 008B60E4 lwz  %r4, 0x1C(%r31) # %r4 contains header checksum\n\n 008B60E8 cmpw %r3, %r4 # %r3 contains calculated checksum\n\n 008B60EC beq  loc_8B6110 # branch away if checksums matched\n\n #008B60EC mr  %r4,%r3  # print out calculated checksum\n\n 008B60F0 lis  %r3, aCksumXSizeD@h # \" cksum :%x size :%d\\n\"\n\n 008B60F4 addi %r3, %r3, aCksumXSizeD@l\n\n 008B60F8 lwz  %r5, 0x10(%r31)\n\n 008B60FC bl  Print_to_Console # %r4 is printed to console\n\n 008B6100 lis  %r3, aIncorrectFirmw@h # \"Incorrect firmware data,\n\n 008B6104 addi %r3, %r3, aIncorrectFirmw@l\n\n\n-----\n\n# One Bit{e}\n\n##### Maintain Access\n\n • Console, Telnet, Web and SSH all compare password hashes and use the same function.\n\n • SSH falls back to password if client does not supply a key unless password authentication has been disabled.\n\n • One bit patch provides login with any password if a valid username is supplied.\n\n\n-----\n\n# One Bit{e} ii\n\n###### 003F7F04  mr   %r4, %r27\n\n 003F7F08  mr   %r5, %r30\n\n 003F7F0C  bl   COMPARE_HASHES # does a string compare\n\n 003F7F10  cmpwi  %r3, 0        # equal if match\n\n #0x397F30 cmpwi  %r3, 1   # equal if they don't match\n\n 003F7F14  bne   loc_3F7F24 # login fails if not equal (branch) \n\n 003F7F18  li   %r0, 2\n\n 003F7F1C  stw   %r0, 0(%r29)\n\n\n-----\n\n# Infection\n\n##### Injecting code into the binary\n\n • ScreenOS code section contains a block of nulls\n\n • Proof of concept code injected into nulls\n\n Proof of Concept Code :: motd\n\n • Patch a branch in ScreenOS to call our code\n\n • Call ScreenOS functions from our code\n\n • Create new code and functionality\n\n\n-----\n\n# Infection ii\n\n###### stwu %sp, -0x20(%sp)\n\n mflr %r0  \n\n lis  %r3, string_msb_address\n\n addi %r3, %r3, string_lsb_address\n\n bl  Print_To_Console\n\n mtlr %r0\n\n addi %sp, 0x20\n\n bl  callee_function\n\n\n-----\n\n# Zombie Loader\n\n##### • All Juniper ScreenOS images signed.\n\n • Administrator can load a Juniper certificate to validate firmware\n\n • Certificate NOT installed by default.\n\n • Administrator can delete this certificate.\n\n • Check is done in the BOOT LOADER which we can modify to authenticate all images or only non-Juniper images\n\n\n-----\n\n# Zombie Loader ii\n\n###### 0000D68C  bl  sub_98B8\n\n 0000D690  cmpwi %r3, 0   # %r3 has result of image validation\n\n 0000D694  beq  loc_D6B0  # branch if passed\n\n #0000D694 b   loc_D6B0  # always branch, all images authenticated\n\n #0000D694 bne  loc_D6B0  # ...or only bogus images authenticated\n\n 0000D698  lis  %r3, aBogusImageNotA@h # Bogus image not authenticated\"\n\n 0000D69C  addi %r3, %r3, aBogusImageNotA@l\n\n 0000D6A0  crclr 4*cr1+eq\n\n 0000D6A4  bl  sub_C8D0\n\n 0000D6A8  li  %r31, -1\n\n 0000D6AC  b   loc_D6E0\n\n\n-----\n\n# Demo: ScreamOS\n\n\n-----\n\n# 28 Hacks Later\n\n##### • Hidden shadow configuration file\n\n – allowing all traffic from one IP through Netscreen\n\n – network traffic tap\n\n • Persistent infection via boot loader on ScreenOS upgrade. Patch boot loader and login mechanism.\n\n • Javascript code injection in web console...\n\n\n-----\n\n# Victim\n\n##### 04-07-08: Sent white-paper and firmware to Juniper recommending:\n\n • Install firmware authentication certificate at factory\n • Prevent certificate deletion\n • Encrypt firmware rather than using LZMA compression\n\n Juniper:\n\n 13-09-08: “This is expected”\n\n 28-10-08: “I saw you are presenting at RUXCON on Nov 30th. Cool.”\n\n 24-11-08:  Publish JTAC Bulletin PSN-2008-11-111\n “ScreenOS Firmware Image Authenticity Notification”\n\n\n-----\n\n# Victim ii\n\n##### “All Juniper ScreenOS Firewall Platforms are susceptible to circumstances in which a maliciously modified ScreenOS image\n can be installed.”\n\n Juniper recommend: – Install the imagekey.cer certificate\n\n – Utilize the “Manager-IP” feature to control which hosts (via their\n IP addresses) can manage your firewall.\n\n – Change the TCP port by which the device listens for\n\n\n-----\n\n# Remove the Brain\n\n##### • Install known firmware before deployment (Who is your Juniper vendor?)\n\n • Admin via SSH key authentication only (disable Telnet, HTTP and HTTPS)\n\n • Out of band management network\n\n • Limit number of administrators.\n\n • Strong passwords.\n\n\n-----\n\n# Roll the Credits\n\n#### Andy and Mark @ Aura Software Security\n\n George Romero\n\n Simon Pegg\n\n\n-----\n\n# Script by ScreenOS Dev\n\n### BOB: “Code should never reach here by design”\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://www.blackhat.com/presentations/bh-usa-09/NEILSON/BHUSA09-Neilson-NetscreenDead-SLIDES.pdf"
    ],
    "report_names": [
        "BHUSA09-Neilson-NetscreenDead-SLIDES.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716502,
    "ts_updated_at": 1743041141,
    "ts_creation_date": 1248108719,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/6eacd4eacbf06b45b4f041e63d77aaf7bec5d333.pdf",
        "text": "https://archive.orkl.eu/6eacd4eacbf06b45b4f041e63d77aaf7bec5d333.txt",
        "img": "https://archive.orkl.eu/6eacd4eacbf06b45b4f041e63d77aaf7bec5d333.jpg"
    }
}