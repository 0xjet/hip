{
    "id": "a1fddbcf-51ea-4091-b090-efb144aceb3a",
    "created_at": "2023-01-12T15:00:32.96314Z",
    "updated_at": "2025-03-27T02:10:54.434289Z",
    "deleted_at": null,
    "sha1_hash": "8523538d5bfa0d8036c55146e5afd8d8cd7fba49",
    "title": "2021-12-28 - Flagpro- The new malware used by BlackTech",
    "authors": "",
    "file_creation_date": "2022-05-28T02:19:10Z",
    "file_modification_date": "2022-05-28T02:19:10Z",
    "file_size": 314424,
    "plain_text": "# Flagpro: The new malware used by BlackTech\n\n**[insight-jp.nttsecurity.com/post/102hf3q/flagpro-the-new-malware-used-by-blacktech](https://insight-jp.nttsecurity.com/post/102hf3q/flagpro-the-new-malware-used-by-blacktech)**\n\nHiroki Hada\n\nThis article is a translation of the \"標的型攻撃グループBlackTechが使用するマルウェア\nFlagproについて\".\n\n--\n## Introduction\n\n\n-----\n\nBlackTech has been actively attacking, some attack cases against Japanese companies\nwere observed. BlackTech uses a new malware for these attack cases. We call it “Flagpro”.\nWe are sharing its overview, timeline and detailed analysis result in this article.\n\n## Attack overview\n\nFlagpro is used in the initial stage of attacks to investigate target’s environment, download a\nsecond stage malware and execute it. An attack case using Flagpro starts with a spear\nphishing e-mail. The message is adjusted to its target organization. It is disguised as an email communication with target’s business partner. This means the attackers probed deeper\ninto their target before attacking.\n\nThe attackers attach a password protected archived file (ZIP or RAR) to the email, and they\nwrite its password in the message. The archived file includes an xlsm format file and it\ncontains a malicious macro. If a user activates the macro, a malware will be dropped. They\nalso adjust the contents of the xlsm file to the target. Therefore, it is not easy to feel at odds\nwith the file sent by the attacker.\n\nAfter the macro is executed, it creates an EXE file in startup directory. This EXE file is\n“Flagpro”. In the most cases, this created EXE files are named “dwm.exe”. When the system\nlaunches next time, Flagpro, which was placed in startup directory as “dwm.exe”, will be\nexecuted.\n\nFlagpro communicates with a C&C server, and it receives commands to execute from the\nserver, or Flagpro downloads a second stage malware and then executes it. The attackers\ncheck the target’s environment whether it is suitable for running the second stage malware or\nnot. If they determine to attack the target, another malware sample will be downloaded and\nexecuted.\n\n## Timeline\n\nWe have observed attack cases using Flagpro against multiple companies (Defense, Media,\nCommunications) several times. In October 2020, a sample related to Flagpro was submitted\nto an online service. Therefore, Flagpro may have already been used for attacking cases at\nthat point.\n\n\n-----\n\n## Flagpro functions\n\nIn July 2021, our SOC observed new Flagpro using MFC(Microsoft Foundation Class) library\nfor its implementation. MFC library had not been used for old Flagpro. This Flagpro had\nclasses such as ”CV20_LoaderApp” and ”CV20_LoaderDlg”. We assume that the role of\nFlagpro is a downloader and the sample version was 2.0 from these class names.\n\nWe call this sample using MFC as “Flagpro v2.0” and old one as “Flagpro v1.0” in this article.\n\nFollowing list indicates Flagpro’s main functions:\n\nDownload and execute a tool\nExecute OS commands and send the results\nCollect and send Windows authentication information\n\nThese commands are implemented in a member function of CV20_LoaderApp class in\nFlagpro v2.0.\n\nOnce Flagpro is launched, it communicate with a C&C server and executes the received\ncommands as shown in the above list. After designated interval, it repeats this behavior.\n\nRegarding to downloading and executing a tool, Flagpro stores the downloaded file in file\npath “%Temp%\\~MY[0-9A-F].tmp” first. Then, Flagpro adds extension “.exe” to the name of\nstored file and executes the file.\n\nIn the implementation of Flagpro v1.0, if a dialog titled “Windows セキュリティ” is displayed\nwhen Flagpro accesses to an external site, Flagpro automatically clicks OK button to close\nthe dialog. This handling also works when the dialog is written Chinese and English. It can\nindicate the targets are Japan, Taiwan, and English-speaking countries. Flagpro v2.0 checks\nwhether both username and password are filled in a dialog as an additional feature before\nclicking the OK button\n\n\n-----\n\nFlagpro v2.0 has another new function. If a dialog title is Internet Explorer [7-11] (the\nnumber after “Internet Explorer” depends on what version the user users) when Flagpro\naccesses to an external site, Flagpro sends WM_CLOSE message to close the dialog.\n\nWe assume that these functions, which close a dialog automatically, are implemented to\nreduce a risk that a user detects an external connection by Flagpro.\n\nIn Flagpro v2.0, the same codes in below figure are repeatedly inserted to hide important as\na handy obfuscation technique:\n\n## Received commands\n\nThe received commands from a C&C server are encoded with Base64. Following format is\nthe decoded command about Flagpro v2.0:\n\nDownload Command field consists of two flags(Exec and Yes) and URL path like following:\n\nFirst string “Exec” is the action flag. If it is not included in both Download Command fields in\nthe command, Flagpro will not execute the main processes such as downloading, executing\nOS commands, collecting authentication information, and so on. Next string “Yes” is the\nexecution flag. If a Download Command field has “ExecYes”, Flagpro downloads and\nexecutes the file. If a command is “Exec/malware.html” like the above image, Flagpro only\ndownloads a file.\n\n\n-----\n\nTime Interval field means a number of waiting time for the next command. The unit is\nmillisecond.\n\nFollowing image is an actual example of the received commands:\n\n## Communications with C&C server\n\nConnection handlings to a C&C server about Flagpro v1.0 and v2.0 uses COM objects of\nInternet Explorer. Flagpro communicates with C&C server using HTTP.\n\nIn requesting commands, sending execution results of OS commands or collected\nauthentication information, Flagpro accesses a C&C server with specific URL paths and\nqueries. It encodes data with Base64 and sends to the C&C server. Following table shows\nrelations between Flagpro’s activities and the URL paths and queries.\n\n**Related activities** **URL paths and queries**\n\nRequest command /index.html\n\nSend result of OS command execution /index.htmld?flag=[Encoded Data]\n\nSend authentication information /index.htmld?flagpro=[Encoded Data]\n\nWhen Flagpro downloads a tool, there is no specific URL path because it uses the file name\non the server.\n\nFollowing image shows a traffic when Flagpro v2.0 connects to a C&C server:\n\n\n-----\n\nAs of July 2021, we do not know why, but we observed a response “Hello Boy!” from the\nC&C server, when we access to the arbitrary paths other than the URL paths shown in the\ntable above. Following image is an example of the response:\n\n## Detections\n\nTo detect attacks using Flagpro, it is effective to create and install custom signature both on\nnetwork and endpoint devices. For the network detection, Flagpro’s characteristic URL paths\nare useful such as index.htmld?flag=[Base64 string] and index.htmld?flagpro=[Base64\nstring].\n\nFor the endpoint detection, naming rules of temporary files that Flagpro create such as\n%TEMP%\\~MY[0-9A-F].tmp and %TEMP%\\~MY[0-9A-F].tmp.exe are effective. In addition,\nthe investigation commands after Flagpro establishes the connection with the C&C server\nlike following are also useful for detection. Following commands are a part of examples:\n\n## Conclusion\n\n\n-----\n\nWe have observed attack cases using Flagpro against Japan since October 2020. The\nattack techniques have not changed a lot, but BlackTech uses more evading techniques. For\nexample, they adjust decoy files and file names to their target and check carefully target’s\nenvironment. Recently, they have started using other new malwares called “SelfMake\nLoader” and “Spider RAT”. It means that they are actively developing new malwares.\nTherefore, you need to pay attention to the attacks from BlackTech.\n\n## IoC\n\n54e6ea47eb04634d3e87fd7787e2136ccfbcc80ade34f246a12cf93bab527f6b\ne197c583f57e6c560b576278233e3ab050e38aa9424a5d95b172de66f9cfe970\n655ca39beb2413803af099879401e6d634942a169d2f57eb30f96154a78b2ad5\n840ce62f92fc519cd1a33b62f4b9f92a962b7fb28c12d2f607dec0b520e6a4b2\nba27ae12e6f3c2c87fd2478072dfa2747d368a507c69cd90b653c9e707254a1d\n77680fb906476f0d84e15d5032f09108fdef8933bcad0b941c9f375fedd0b2c9\ne81255ff6e0ed937603748c1442ce9d6588decf6922537037cf3f1a7369a8876\n45[.]76.184.227\n45[.]32.23.140\n139[.]162.87.180\n107[.]191.61.40\n172[.]104.109.217\norg.misecure[.]com\nupdate.centosupdates[.]com\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-28 - Flagpro- The new malware used by BlackTech.pdf"
    ],
    "report_names": [
        "2021-12-28 - Flagpro- The new malware used by BlackTech.pdf"
    ],
    "threat_actors": [
        {
            "id": "2646f776-792a-4498-967b-ec0d3498fdf1",
            "created_at": "2022-10-25T15:50:23.475784Z",
            "updated_at": "2025-03-27T02:00:55.479958Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Palmerworm"
            ],
            "source_name": "MITRE:BlackTech",
            "tools": [
                "Kivars",
                "PsExec",
                "TSCookie",
                "Flagpro",
                "Waterbear"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d3a7123c-f519-49a0-a234-de24a1ef052a",
            "created_at": "2022-10-25T16:47:55.545211Z",
            "updated_at": "2025-03-27T02:05:17.254744Z",
            "deleted_at": null,
            "main_name": "BRONZE CANAL",
            "aliases": [
                "CTG-6177 ",
                "Circuit Panda ",
                "Palmerworm ",
                "Shrouded Crossbow ",
                "BlackTech"
            ],
            "source_name": "Secureworks:BRONZE CANAL",
            "tools": [
                " DRIGO",
                " Flagpro",
                " Gh0stTimes",
                " PLEAD",
                " Spiderpig",
                " Waterbear",
                "Bifrose"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75024aad-424b-449a-b286-352fe9226bcb",
            "created_at": "2023-01-06T13:46:38.962724Z",
            "updated_at": "2025-03-27T02:00:02.964002Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "CIRCUIT PANDA",
                "Temp.Overboard",
                "G0098",
                "Red Djinn",
                "HUAPI",
                "Palmerworm",
                "T-APT-03",
                "Manga Taurus",
                "Earth Hundun"
            ],
            "source_name": "MISPGALAXY:BlackTech",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "efa7c047-b61c-4598-96d5-e00d01dec96b",
            "created_at": "2022-10-25T16:07:23.404442Z",
            "updated_at": "2025-03-27T02:02:09.781478Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Circuit Panda",
                "Earth Hundun",
                "Manga Taurus",
                "Operation PLEAD",
                "Operation Shrouded Crossbow",
                "Operation Waterbear",
                "Palmerworm",
                "Radio Panda",
                "Red Djinn",
                "T-APT-03",
                "TEMP.Overboard"
            ],
            "source_name": "ETDA:BlackTech",
            "tools": [
                "BIFROST",
                "BUSYICE",
                "BendyBear",
                "Bluether",
                "CAPGELD",
                "DRIGO",
                "Deuterbear",
                "Flagpro",
                "GOODTIMES",
                "Gh0stTimes",
                "IconDown",
                "KIVARS",
                "LOLBAS",
                "LOLBins",
                "Linopid",
                "Living off the Land",
                "TSCookie",
                "Waterbear",
                "XBOW",
                "elf.bifrose"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535632,
    "ts_updated_at": 1743041454,
    "ts_creation_date": 1653704350,
    "ts_modification_date": 1653704350,
    "files": {
        "pdf": "https://archive.orkl.eu/8523538d5bfa0d8036c55146e5afd8d8cd7fba49.pdf",
        "text": "https://archive.orkl.eu/8523538d5bfa0d8036c55146e5afd8d8cd7fba49.txt",
        "img": "https://archive.orkl.eu/8523538d5bfa0d8036c55146e5afd8d8cd7fba49.jpg"
    }
}