{
    "id": "e23b5d37-c26f-414e-8539-238d4d19bd58",
    "created_at": "2023-01-12T15:00:28.164241Z",
    "updated_at": "2025-03-27T02:05:57.332221Z",
    "deleted_at": null,
    "sha1_hash": "816f134dbf138fef810fcdea5c9f9ee04923dd48",
    "title": "2021-02-12 - The Many Roads Leading To Agent Tesla",
    "authors": "",
    "file_creation_date": "2022-05-28T15:54:34Z",
    "file_modification_date": "2022-05-28T15:54:34Z",
    "file_size": 1931295,
    "plain_text": "# The Many Roads Leading To Agent Tesla\n\n**[trustwave.com/en-us/resources/blogs/spiderlabs-blog/the-many-roads-leading-to-agent-tesla/](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/the-many-roads-leading-to-agent-tesla/)**\n\n[Agent Tesla is a common Remote Access Trojan (RAT) discovered in 2014. This threat is](https://krebsonsecurity.com/2018/10/who-is-agent-tesla/)\ncapable of keylogging, screen capture, form-grabbing, and stealing credentials from a wide\nrange of FTP, VPN, browser, and email clients. The exfiltration method depends on what the\nattacker sets on the configuration.\n\nDuring the past months, we have found a resurgence of this malware being distributed via\nspam, as a payload of other threats, and as attachments to the malspams themselves. In this\nblog, we present three recent, yet quite different, spam campaigns leading to this threat. The\nfirst two campaigns deliver Agent Tesla via interesting downloader attachments whereas the\nthird one distributes Agent Tesla directly in the malspams. The Agent Tesla samples we\nobserved send the stolen information through SMTP and FTP.\n\n\n-----\n\n_Figure 1: The process flow of spam campaigns leading to Agent Tesla malware_\n\n## 1 CAMPAIGN: Through a PowerPoint Slide Show (PPSX) Loaderst\n\nThe malspams relating to the first campaign contain a PPSX attachment that exploits an old\n[vulnerability - CVE-2017-0199 which allows attackers to perform remote code execution using](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2017-0199)\nWindows Object Linking and Embedding (OLE).\n\n\n-----\n\n_Figure 2: The malspam containing a PPSX attachment with CVE-2017-0199_\n\nThe offending object inside the attachment AS_FedEx_AWB_00117980920AS.ppsx is\n_slide1.xml.rels. It contains a script moniker that, when triggered, executes a PowerShell_\ncommand.\n\n\n-----\n\n_Figure 3: The PowerShell command at object slide1.xml.rels_\n\nOnce the PowerPoint file is opened, it initializes the script moniker and runs the encoded\nPowerShell script. Decoding the PowerShell script reveals that it downloads an executable\nhosted at discordapp[.]com, saves it to the %appdata% folder as NPHBEK.exe, then executes\nit.\n\n_Figure 4: Decoded PowerShell command from Fig. 2_\n\nThe downloaded file %appdata%/NPHBEK.exe is the Agent Tesla malware. It exfiltrates data\nvia SMTP. The data includes the username, computer name, and other system information. In\naddition to that, stolen data will also be included in the email such as key captures, and stolen\ncredentials.\n\n_Attacker’s email address: b*****@wezbrd.xyz_\n\n_Password: Ma************di_\n\n_SMTP server: smtp.privateemail.com_\n\n\n-----\n\n_Figure 5: The system information sent to the attacker’s email address_\n\n## 2nd CAMPAIGN: Downloaded via a Compiled HTML (CHM) File\n\nA Compiled HTML (CHM) Help file contains a collection of HTML pages with an index\ncompressed into a binary format. This file format is mainly used for documentation and help\nguides. On rare occasions, this file format is also used by cybercriminals to distribute malware.\nThis second spam campaign has a CHM file contained inside an archive attachment, paving\nthe way to the distribution of Agent Tesla.\n\n_Figure 6: The malspam containing the CHM downloader and its display when launched_\n\n\n-----\n\nThe CHM attachment 70127_YK90054_Consulta_del_cliente.chm has one HTML object.\nWhen the CHM file is executed, the HTML object d5sd00.htm will be loaded by the Microsoft\nHelp Viewer (hh.exe). As the HTML Help window shown in Fig. 6 is displayed, the malicious\nbehavior of the CHM attachment starts to manifest in the background.\n\n_Figure 7: The PowerShell command triggered when CHM is executed_\n\nThe HTML d5sd00.htm contains a Javascript code that will deobfuscate then launch the\nPowerShell code also enclosed in the HTML file. The PowerShell then retrieves and processes\nthe obfuscated data at hxxp://egen[.]com[.]tr/7F[.]jpg which is again PowerShell code.\n\n_Figure 8: The data obtained from the URL shown in Fig. 8 and its deobfuscated code_\n\nThe second PowerShell code contains 2 binaries – the first is the waves.dll file which is\nobfuscated and the second is the GZip archive containing the Agent Tesla executable. When\nthis second-stage PowerShell runs, the binary waves.dll will inject the Agent Tesla malware into\nMSBuild.exe.\n\n\n-----\n\nIn this Agent Tesla sample, the exfiltrated data will be delivered via FTP.\n\n_Figure 9: The decrypted Agent Tesla config on the MSBuild.exe memory dump_\n\n## 3 CAMPAIGN: The “AstraZeneca” Agent Teslard\n\n[In the early days of the Coronavirus pandemic, we observed one of the malwares commonly](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/covid-19-malspam-activity-ramps-up/)\ndistributed via this theme was Agent Tesla. Recently, we have seen another spam campaign\ntaking advantage of the pandemic.\n\n_Figure 10: The malspam containing Agent Tesla and the file property of the executable_\n_attachment_\n\n\n-----\n\nAttached to the emails is a RAR or ZIP archive file containing an executable file. The\nexecutables we gathered from the malspams are .Net compiled around 700-900KB in size.\nStatically examining the executables, we noticed the file properties were associated with the\ncompany AstraZeneca, one of the Coronavirus vaccine makers.\n\n_Figure 11: The executable files obtained from the 3rd campaign_\n\nUsing the tool DNSpy, we observed that the .Net files shown in Fig. 11 were compiled on the\nsame day the malspams were distributed. As the executables have encrypted data in the next\nsection, we used the tool MegaDumper to extract the objects wrapped in them. The extracted\nobjects are .Net Agent Tesla malware of which some were compiled a month earlier.\n\n_Figure 12: The executable in Fig. 10 viewed in DNSpy_\n\n_Figure 13: The objects dumped, using the MegaDumper tool, from the executable shown in_\n_Fig.10_\n\nJust like in the first campaign, the data stolen from the infected system will be exfiltrated via\nSMTP.\n\n\n-----\n\n_Figure 14: The code snippet of the SMTP process performed by Agent Tesla_\n_NQAkXoqEDGGPBNdSxedbVXswADUBFbJCdBUnmtC.exe shown in Fig. 13_\n\n## IOC\n\nAttachments:\n\nAS_FedEx_AWB_00117980920AS.ppsx (31586 bytes)\n\nSHA1: 02DA2F8F23D468EF2DB4919566A0B43BDABCD656\n\n70127_YK90054_Consulta_del_cliente.chm (12117 bytes)\n\nSHA1: 7CD8B837D6222CCD48F69211D9FB466A8A90A6EC\n\nDownload URLs:\n\nhxxp://egen[.]com[.]tr/7F[.]jpg (879190 bytes)\n\nSHA1: 3605BA5E2ED894A89AA64740774FBA6A822E978F\n\nhxxps://cdn[.]discordapp[.]com/attachments/775445531627356172/793434227491733544/v4[.]exe\n(1969440 bytes)\n\nSHA1: CD9A58B7B81D9469D495CB4600A55F9E3BAAC33D\n\nAgent Tesla:\n\nQuotation Query for supply of selected list items. Ukraine chamber of commerce.exe (818688\nbytes)\n\nSHA1: C30DCD540F949691F17B302BFDD862D86A1D93E5\n\n\n-----\n\nApplication letter.exe (832512 bytes)\nCurriculum vitae.exe (832512 bytes)\nSHA1: BCB01820699431CF926E297E1C6966527CFE6F32\n\nRFQ.01.11.021.exe (830464 bytes)\nSHA1: D4CB60FE478B83DA7D483813DD43B32CCA1812C6\n\nPaymentcopy001#psf.exe (742912 byte)\nSHA1: C46AB15FAB1E57C251CFB979454693601CBE035C\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-02-12 - The Many Roads Leading To Agent Tesla.pdf"
    ],
    "report_names": [
        "2021-02-12 - The Many Roads Leading To Agent Tesla.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535628,
    "ts_updated_at": 1743041157,
    "ts_creation_date": 1653753274,
    "ts_modification_date": 1653753274,
    "files": {
        "pdf": "https://archive.orkl.eu/816f134dbf138fef810fcdea5c9f9ee04923dd48.pdf",
        "text": "https://archive.orkl.eu/816f134dbf138fef810fcdea5c9f9ee04923dd48.txt",
        "img": "https://archive.orkl.eu/816f134dbf138fef810fcdea5c9f9ee04923dd48.jpg"
    }
}