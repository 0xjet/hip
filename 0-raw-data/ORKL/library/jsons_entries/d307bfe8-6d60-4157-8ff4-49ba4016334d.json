{
    "id": "d307bfe8-6d60-4157-8ff4-49ba4016334d",
    "created_at": "2023-01-12T15:02:03.7908Z",
    "updated_at": "2025-03-27T02:05:51.747488Z",
    "deleted_at": null,
    "sha1_hash": "d76a38663a5b07c22335852e9fefa6abe185f008",
    "title": "2022-10-12 - Dissecting the new shellcode-based variant of GuLoader (CloudEyE)",
    "authors": "",
    "file_creation_date": "2022-10-23T13:16:19Z",
    "file_modification_date": "2022-10-23T13:16:19Z",
    "file_size": 1130367,
    "plain_text": "# Dissecting the new shellcode-based variant of GuLoader (CloudEyE)\n\n**[spamhaus.com/resource-center/dissecting-the-new-shellcode-based-variant-of-guloader-cloudeye/](https://www.spamhaus.com/resource-center/dissecting-the-new-shellcode-based-variant-of-guloader-cloudeye/)**\n\nOctober 12, 2022\n\nOne of the Spamhaus Project's malware specialists has been dissecting GuLoader,\nattempting to analyze this tricky malware. They have taken time out from reverse\nengineering and sandbox detonations to share their findings‚Ä¶\n\n## What is GuLoader?\n\nGuLoader, or as it is also known, CloudEye, is a small VB5/6 downloader malware. Typically,\nit downloads Remote Access Tools (RATs) and Stealers, such as Agent Tesla, Arkei/Vidar,\nFormbook, Lokibot, Netwire, and Remcos, often (but not always), from Google Drive.\n\n## What‚Äôs so special about GuLoader?\n\nGuLoader is notorious for its anti-virtual machine (anti-VM) tactics, i.e., thwarting any\nattempts for researchers to analyze it. In fact, it was so successful at evading analysis that,\nat one point, not even one of the most famous online sandboxes could detonate the malware\nsuccessfully.\n\n## Utilizing a packer to swerve detection\n\n\n-----\n\nGuLoader utilizes the Nullsoft Scriptable Install System (NSIS) packer to compress and\nencrypt its payload. The NSIS packer is a free, open-source tool commonly used to create\nWindows installers. However, it can also pack other types of files, such as executables. It is\nGuLoader‚Äôs use of the NSIS packer that makes it harder for antivirus programs to detect and\nremove the malware.\n\nWhen GuLoader packs its payload, it first compresses the file using the NSIS packer, then\nencrypts the compressed file with a custom encryption algorithm. The encrypted file is then\nembedded into the GuLoader executable. When GuLoader is run, it decrypts and unpacks\nthe payload, then executes it.\n\n## GuLoader employs a multitude of ‚Äúanti‚Äù strategies\n\nWe all know that virtualization is a common way to improve infrastructure efficiency and\nreduce costs across the IT industry. However, attackers can abuse it to evade detection and\nlaunch attacks. Here are some of the ways GuLoader evades detection:\n\n1. Checking for common VM tools: GuLoader checks for the presence of common VM\n\ntools such as VMware, VirtualBox, and QEMU. If any of these tools are detected,\nGuLoader will not execute.\n2. Checking for debuggers: GuLoader checks for the presence of debuggers such as\n\nOllyDbg and WinDbg. If a debugger is detected, GuLoader will not execute.\n3. Checking for sandboxes: GuLoader checks for the presence of sandboxes such as\n\nCuckoo Sandbox and Anubis. If a sandbox is detected, GuLoader will not execute.\n\nWe‚Äôve covered the basic overview; now brace yourselves as we get down and dirty looking\nunder the hood of GuLoader.\n\n## How does Guloader resolve an API?\n\nGuLoader uses a hashed technique to resolve an API call; it‚Äôs a modified version of djb2 ‚Äì\nsee the example below:\n\n\n-----\n\n## Binary code obfuscation techniques\n\nGuLoader uses these to make code more difficult to understand and reverse engineer. They\nwork by making the code appear random or meaningless, making it harder for humans to\nunderstand what it does.\n\n[One of the most common obfuscation techniques is ‚Äúopaque predicates‚Äú, which are Boolean](https://en.wikipedia.org/wiki/Opaque_predicate)\nexpressions that always return true or false values. However, the value is not known\nbeforehand, making it difficult to understand what it does. Opaque predicates are often used\nwith other obfuscation techniques, such as code permutation, to make the code even more\ndifficult to understand.\n\n## GuLoader uses vectored exceptional handler to change code flow\n\n\n-----\n\nOne interesting feature of GuLoader is how it manages to change the code flow during\nruntime. This is done using vectored exceptional handler (VEH), a software exception\nhandling mechanism. A VEH can be used to intercept and handle exceptions generated by\nthe operating system or running programs.\n\nThe operating system or program will generate an exception code when an exception\noccurs. The VEH then looks up the address of the exception handler associated with that\nexception code and calls it. GuLoader uses VEH to modify the extended instruction pointer\n(EIP) at an exception to point to the next legitimate instruction. Here‚Äôs the VEH setup:\n\nInitially, as the exception happens, _CONTEXTRECORD structure is checked for the\npresence of hardware registers, i.e., the x86 debug registers:\n\n\n-----\n\nThe EIP, where the exception happened, is compared against byte 0xcc, i.e., the software\nbreak point. This is a necessary condition for the exception to proceed and to generate the\nnext EIP.\n\nThe EIP is calculated relative to the place where the exception occurred:\n\n\n-----\n\nThe byte after the exception EIP is XORed with 0xcb, and the result is added to the current\nEIP to get the next location for execution. The instruction in between the exception EIP and\nthe calculated EIP is filled with junk instructions to confuse the disassembler, as illustrated\nbelow:\n\n## How to automate the extraction of indicators of compromise (IOCs) from GuLoader\n\n\n-----\n\nThe manual dissection of GuLoader payloads becomes a cumbersome and tedious process\ndue to the presence of all the various hardcore anti-VM, anti-analysis, and anti-debug\nmechanisms. Therefore, it is imperative to automate this extraction. To make the process\nsuccessful, we must first automate the dumping and then write a script to extract the\nparameters necessary to get the URL out of GuLoader.\n\nBut GuLoader presents us with a big hurdle, i.e., the anti-dumping protection. This is a\ntechnique used to prevent reverse engineering and analysis of the code. It works by\nencrypting or obfuscating the code, making it exceptionally difficult to read and understand.\n\nGuLoader encrypts the main binary code at any point in the calling of any system API, which\ninvariably makes the dumped code useless. The following two images depict ‚ÄúXORing the\ncode before the call‚Äù and ‚ÄúdeXORing after the API call‚Äù, respectively.\n\nA weakness you can exploit is the initial API call made by GuLoader, which is not wrapped in\nthe subroutine that does all the aforementioned ‚Äúanti ‚Äúchecks.\n\n\n-----\n\nTo exploit this weakness, you can set up a DLL hook after OEP is reached, as shown in the\ncode below:\n\n\n-----\n\nOnce the dump is successful, we have to locate the key. This process is reasonably\nstraightforward, as GuLoader encrypts the botnet command and controller (C&C) with the\nsame subroutine as the strings. Here‚Äôs the string decoding subroutine:\n\nThe interesting pattern to observe is how the parameters are supplied to the subroutine;\nbeing a subroutine with __stdcall calling conventions, the stack is cleaned by the called\nfunction, but only three parameters are pushed onto the stack.\n\nTracking back, we can observe that the key parameter is pushed using a direct call opcode.\nThat‚Äôs precisely the location of the XOR key to be used.\n\n\n-----\n\nOnce you have extracted the key, you can easily brute force for the presence of URLs in the\nmemory dump using the following code:\n\nThe output will be:\n\n_python Gu2Extract.py MemDump_\n\n_GuLoader c2 = b‚Äôhttp://192.3.245.147/2022.bin_\n\nEasy as that üòä!\n\nAs is evident from what we‚Äôve discussed, GuLoader is challenging to detect and remove and\ncan pose a severe threat to both individual users and organizations. There are several ways\nto protect against GuLoader, most of them are IT basics ‚Äì but sadly, the basics often get\nmissed:\n\nKeep your software up to date\nUsing a reliable antivirus solution\nTrain users to be careful when opening email attachments.\n\n## Further malware information\n\nTo see what malware families our researchers are currently observing in our botnet\n[command and controller (C&C) report, visit our Botnet Quarterly Update.](https://info.spamhaus.com/botnet-threat-updates)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-10-12 - Dissecting the new shellcode-based variant of GuLoader (CloudEyE).pdf"
    ],
    "report_names": [
        "2022-10-12 - Dissecting the new shellcode-based variant of GuLoader (CloudEyE).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535723,
    "ts_updated_at": 1743041151,
    "ts_creation_date": 1666530979,
    "ts_modification_date": 1666530979,
    "files": {
        "pdf": "https://archive.orkl.eu/d76a38663a5b07c22335852e9fefa6abe185f008.pdf",
        "text": "https://archive.orkl.eu/d76a38663a5b07c22335852e9fefa6abe185f008.txt",
        "img": "https://archive.orkl.eu/d76a38663a5b07c22335852e9fefa6abe185f008.jpg"
    }
}