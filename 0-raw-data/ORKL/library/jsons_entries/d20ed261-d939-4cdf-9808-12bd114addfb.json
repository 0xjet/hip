{
    "id": "d20ed261-d939-4cdf-9808-12bd114addfb",
    "created_at": "2023-01-12T15:05:55.027603Z",
    "updated_at": "2025-03-27T02:05:35.106816Z",
    "deleted_at": null,
    "sha1_hash": "0e29646c93b30632e86d9f19ee4f17704b3a3629",
    "title": "2021-01-28 - Emotet vs. Windows Attack Surface Reduction",
    "authors": "",
    "file_creation_date": "2022-05-29T01:27:31Z",
    "file_modification_date": "2022-05-29T01:27:31Z",
    "file_size": 255755,
    "plain_text": "# SANS ISC: InfoSec Handlers Diary Blog - SANS Internet Storm Center SANS Site Network Current Site SANS Internet Storm Center Other SANS Sites Help Graduate Degree Programs Security Training Security Certification Security Awareness Training Penetration Testing Industrial Control Systems Cyber Defense Foundations DFIR Software Security Government OnSite Training InfoSec Handlers Diary Blog\n\n**isc.sans.edu/diary/rss/27036**\n\n## Emotet vs. Windows Attack Surface Reduction\n\n**Published: 2021-01-28**\n\n**Last Updated: 2021-01-28 00:02:31 UTC**\n\n**by** [Daniel Wesemann (Version: 1)](https://isc.sans.edu/handler_list.html#daniel-wesemann)\n\n[0 comment(s)](https://isc.sans.edu/forums/diary/Emotet+vs+Windows+Attack+Surface+Reduction/27036/#comments)\nEmotet malware in the form of malicious Word documents continued to make the rounds\nover the past weeks, and the samples initially often had pretty poor anti-virus coverage\n[(Virustotal) .The encoding used by the maldoc is very similar to what Didier Stevens](https://www.virustotal.com/gui/file/81f2ba7fd695aeccb81089e2eef8feb88e6dd460a95bdffb4c43ec226e4ffbdc/detection)\n[analyzed in his recent diary, and the same method can be used to extract the mal-code from](https://isc.sans.edu/forums/diary/Maldoc+Analysis+With+CyberChef/26968/)\nthe current Emotet docs.\n\nWith the de-obfuscation reasonably straight forward, I proceeded to look into how the\nmalware crooks accomplish execution from within the Word doc, and in particular, why\nMicrosoft's \"Attack Surface Reduction Rules\" do not seem to help much.\n\nBut first, let's take a quick detour into what Attack Surface Reduction (ASR) promises to do\non modern Windows devices. ASR is a somewhat clunky set of additional protections in\nMicrosoft Defender Antivirus that can be turned on to log or intercept (block) some common\nattack scenarios. Microsoft's web site offers [meager documentation, including a marginally](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/overview-attack-surface-reduction)\n[helpful list of GUIDs that can be used to activate the feature.](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/attack-surface-reduction#attack-surface-reduction-rules)\n\nOne rule, \"Block all Office Applications from creating child processes\" (GUID D4F940AB401B-4EFC-AADC-AD5F3C50688A) is supposed to prevent a Word document from\nlaunching any other task. Therefore, when this rule is configured, we would expect that the\ncurrent Emotet and its execution chain of Word-Doc -> cmd.exe -> Powershell should not be\nsuccessful. But it is.\nCloser inspection of the Defender Event Log gives a hint \"why\":\n\n\n-----\n\nThe only ASR rule that we see firing when the Emotet Doc is being opened is the one with ID\nd1e49aac-8f56-4280-b9ba-993a6d77406c, corresponding to \"Block process creations\noriginating from PSExec and WMI commands\". Yes, the Emotet VBA Macro is using a WMI\n(windows management instrumentation) call to launch the subsequent attack code. For such\nWMI invocation via the Win32 Process class, the parent process of \"cmd\" ends up being\nWmiPrvSe.exe, which in turn is launched from \"svchost\". Therefore, \"cmd\" is not a child\nprocess of Word, and the ASR block rule to prevent child processes of Word consequently\ndoesn't trigger. Bah!\n\nIn corporate environments, remote management of user devices often uses tools like SCCM\nor Endpoint Manager, which in turn rely on WMI to function. Therefore, setting the ASR Rule\nfor WMI/PSExec to \"block\" will likely break device management, and cause a huge mess.\nChances are, the Emotet crooks were fully aware of this, and that's exactly why they chose\nthis particular execution method for their attack code.\n\nIf you have Microsoft ATP, you can also use a hunting rule like this to search for WMI\nprocess creation\nDeviceEvents\n\n| where ActionType == \"ProcessCreatedUsingWmiQuery\"\n\n| project Timestamp, DeviceName, ActionType, FileName, SHA1, FolderPath,\nInitiatingProcessCommandLine, ProcessCommandLine\n\n| sort by Timestamp desc\n\nYou might have to add a couple of exclusions to cover your management instrumentation or\nsoftware distribution tools, but with a bit of tuning, you should see any current Emotet-like\nWMI attempts in your environment. The ProcessCommandLine in these cases will be long\n\n\n-----\n\n(>600chars) and contain Base64 encoded Powershell, and the InitiatingProcess is Winword.\n\nIn the meantime, the probably best bet to protect your Windows users against Emotet and\nsimilar malware remains to quarantine password protected zips or Office documents with\nmacros on your email gateway, or to disable macros within Office outright if you can get\naway with it.\n\nMaybe, in a decade or three, Microsoft will get to the point where malware introduced via\nOffice documents really no longer is a concern and prevalent problem. Until then, I guess we\n[have to kinda hope that today's international raid by law enforcement against the Emotet](https://www.europol.europa.eu/newsroom/news/world%E2%80%99s-most-dangerous-malware-emotet-disrupted-through-global-action)\ngang really got the right guys, and got them good.\n[Keywords: Emotet](https://isc.sans.edu/tag.html?tag=Emotet) [WMI](https://isc.sans.edu/tag.html?tag=WMI) [word](https://isc.sans.edu/tag.html?tag=word)\n[0 comment(s)](https://isc.sans.edu/forums/diary/Emotet+vs+Windows+Attack+Surface+Reduction/27036/)\n\nJoin us at SANS! Attend [with Daniel Wesemann in starting](https://isc.sans.edu/diary/rss/27036)\n\nTop of page\n√ó\n\n[Diary Archives](https://isc.sans.edu/diaryarchive.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-28 - Emotet vs. Windows Attack Surface Reduction.pdf"
    ],
    "report_names": [
        "2021-01-28 - Emotet vs. Windows Attack Surface Reduction.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535955,
    "ts_updated_at": 1743041135,
    "ts_creation_date": 1653787651,
    "ts_modification_date": 1653787651,
    "files": {
        "pdf": "https://archive.orkl.eu/0e29646c93b30632e86d9f19ee4f17704b3a3629.pdf",
        "text": "https://archive.orkl.eu/0e29646c93b30632e86d9f19ee4f17704b3a3629.txt",
        "img": "https://archive.orkl.eu/0e29646c93b30632e86d9f19ee4f17704b3a3629.jpg"
    }
}