{
    "id": "be3bc85f-25b0-4ba5-b3d1-e1df156177d9",
    "created_at": "2023-01-12T15:06:14.88894Z",
    "updated_at": "2025-03-27T02:05:18.594829Z",
    "deleted_at": null,
    "sha1_hash": "59302e4e88db313ee632ea0f485c5b102debdbbc",
    "title": "2020-07-06 - New release of Lampion trojan spreads in Portugal with some improvements on the VBS downloader",
    "authors": "",
    "file_creation_date": "2022-05-28T21:47:32Z",
    "file_modification_date": "2022-05-28T21:47:32Z",
    "file_size": 4871819,
    "plain_text": "# New release of Lampion trojan spreads in Portugal with some improvements on the VBS downloader\n\n**seguranca-informatica.pt/new-release-of-lampion-trojan-spreads-in-portugal-with-some-improvements-on-the-vbs-**\ndownloader\n\nJuly 6, 2020\n\n**New release of Lampion trojan spreads in Portugal with some improvements on the**\n**VBS downloader.**\nA new release of the Lampion trojan banker was launched with fresh improvements in the\nway the malware loader – the initial VBS file – is operating. The recent wave has been noted\nin Portugal and is impacting clients of several Portuguese and Brazilian banking\norganizations and also some cryptocurrency platforms.\n\nSome details were observed during the malware analysis, namely:\n\nChanges in the VBS downloader – DLL injection executes the 1st stage.\nAnti-VM techniques were improved (probably native features of VM-Protector packer).\nChanges in how it communicates with the C2 server geolocated in Russia.\n\n[Lampion was first documented in December 2019, and it was distributed in Portugal via](https://seguranca-informatica.pt/targeting-portugal-a-new-trojan-lampion-has-spread-using-template-emails-from-the-portuguese-government-finance-tax/#.XwI-myhKguU)\nphishing emails using templates based on the Portuguese Government Finance & Tax.\n\nMore recently, in May 2020, [a new variant of Lampion was observed. Here, it was distributed](https://seguranca-informatica.pt/trojan-lampion-is-back-after-3-months)\nusing fake webpages, where the victim downloaded an MSI file, which then held the\nremaining Lampion infection chain.\n\nOur analysis of the phishing email of this new campaign detected at the end of June – July\n2020 showed that the template is very similar to the template distributed on May 8th, 2020. A\nfake template from SAPOTRANSFER was used with the message inside the email referring\nto any missing payment or invoice.\n\n\n-----\n\n**_Figure 1: The email template used in July 2020 is similar to the previous one used in May_**\n_2020._\n\nThese emails are sent towards the end of the month, simulating the payment of a service or\nbills – the ideal time to catch the most reckless victims.\n\n**_Figure 2: Files available after decompiling the ZIP file distributed via email._**\n\nLooking at the following images, the PDF file inside the ZIP file is just a decoy to distract the\nvictim. The text is written in Portuguese, and just the logo at the end of the document was\nchanged between May and July malware versions.\n\n\n-----\n\n**_Figure 3: PDF file and content delivered are similar, only the logo at the end of the document_**\n_was changed._\n\n[As previously stated [1], [2], the VBS file is one that, when executed, serves as a downloader](https://seguranca-informatica.pt/targeting-portugal-a-new-trojan-lampion-has-spread-using-template-emails-from-the-portuguese-government-finance-tax/#.XwI-myhKguU)\nfor the infection chain. Once executed, additional files are downloaded from Google Cloud,\nwhich are loaded into memory using a well-known technique called DLL injection.\n\nOnce again the code in the VBS file is obfuscated to make it difficult to analyze.\n\n\n-----\n\n**_Figure 4: VBS file – Lampion downloader – obfuscation layer._**\n\nIt is important to note that this new release brings some changes to Lampion’s documented\n_modus operandi. The next graph presents the various forms already documented the threat._\n\n\n-----\n\n**_Figure 5: Different ways of how Lampion has been distributed in-the-wild._**\n\nAs noted, malware is usually distributed with a simple email template, where the victim\ndownloads a ZIP file with a VBS downloader inside. However, in May 2020, criminals used a\nfake page to distribute an MSI file, which used the theme COVID-19 that impersonates the\nPortuguese government and which after being executed launched the VBS file\n\n\n-----\n\nThe infection chain, in both scenarios, starts through the VBS downloader file. This file is\nresponsible for downloading two files from online Clouds, such as AWS, Microsoft, SAPO,\nand more recently Google, creating, thus, persistence on the machines to execute the threat\nevery time machine starts.\n\nIn detail, an EXE file was downloaded, which when executed, injects into memory the\nsecond DLL inside the 0.zip file and protected by a password. This DLL has the trojan code\nprotected using the VM-Protector, a commercial packer.\n\nHowever, in this new release, two DLL files are distributed . VBS file leverages the\nWindows rundll32 library to inject the first DLL into memory (P-14-7.dll), and it is then\nresponsible for loading the second DLL into memory and starting, thus, the infection process.\n\n## Deofuscation and renaming VBS calls\n\nAfter a few rounds of deobfuscation and renaming calls, we have a clean version of the\nsource code to analyze in-depth.\n\n\n-----\n\n**_Figure 6: Deofuscated VBS file – Lampion trojan July 2020._**\n\nSome parts of the code are highlighted in Figure 6 and described below:\n\n1. Function to generate random strings is used to generate arbitrary folders and file\n\nnames.\n2. Random strings generation.\n3. Function used to decrypt strings.\n4. Delete *.LNK files from the Windows startup folder.\n5. Delete *.VBS files from the Windows startup folder.\n6. Create a random folder on %appdata% to host the downloaded files (P-14-7.dll and\n\n0.zip).\n7. Get classes for computer hardware and configuration.\n8. Google Cloud URLs obfuscated (URL1 and URL2).\n9. Download the 2nd stage from Google Cloud (0.zip).\n10. Download 1st stage – trojan loader – from Google Cloud (P-14-7.dll).\n\n11. Create .VBS file inside %appfolder% – persistence technique used by criminals.\n12. Generate the content of the .VBS file (decryption functions, DLL injector, and anti\nVM/sandbox).\n13. Create a folder inside the Windows startup folder.\n14. Crete .LNK file inside the Windows startup folder.\n15. Set up .LNK file to execute DLL injection via rundll32.\n16. Sleep and shutdown commands are two techniques for online sandbox evasion.\n\n\n-----\n\n17. Trojan starts.\n\nIn detail, the malware uses a .LNK file to inject the first stage P-14-7.dll into memory. Then,\nthe call YourGonnaPayMeToday is invoked as shown in Figure 7. This DLL is used as a\nloader for the final payload, a DLL inside 0.zip file, and it is injected into memory via DLL\ninjection. Both files are protected with the commercial packer – VM Protector.\n```\n--create LKN file- C:\\Users\\admin\\AppData\\Roaming\\Microsoft\\Windows\\Start\nMenu\\Programs\\Startup\\usynknwwbmj.lnk\n--------run-dll--------CommandLineArguments:\nC:\\Users\\admin\\AppData\\Roaming\\59684788644313\\eakyvqgqeovfzwxau27622472643851.dll\nYourGonnaPayMeToday\nWorkingDirectory: C:\\Users\\admin\\AppData\\Roaming\\Microsoft\\Windows\\Start\nMenu\\Programs\\Startup\\usynknwwbmj\nRelativePath: ..\\..\\..\\..\\..\\..\\..\\..\\..\\Windows\\system32\\rundll32.exe\nTargetFileDOSName: rundll32.exe\nHotKey: (none) RunWindow:\nNormal IconIndex: (none) \nTargetFileSize: 0\nFileAttributes: (none) \nFlags: IDList, RelativePath, WorkingDir, CommandArgs, Unicode\nFinal payload:\nrundll32.exe\nC:\\Users\\admin\\AppData\\Roaming\\59684788644313\\eakyvqgqeovfzwxau27622472643851.dll\nYourGonnaPayMeToday\n\n## VBS file – Decrypted strings\nEncrypted:\n4Ic^GjEj/fzie0[%2%yifjne$h4Wf]g[m$O]6eDeo]wbg[aWSf5_siR$[YDeKcv%HXJe.cEXT[Zj4WkXnhSWKd\nDecrypted: hxxps://storage.googleapis.]com/bombetabrancaevinho/0.]zip\nEncrypted: r?F^5jAj.fCiB0*%Z%%i<jTefhMWl]x[.$u]uefe\\]wb[[JW.fk_%iF$sY}ePc+%`X&e2c]X]\n[bjnW?X*h'WfdeY_WC[.lo_]db^WeT%eF(#g'=*o#o-Q$-Z8b/b-j\nDecrypted: hxxps://storage.googleapis.]com/bombetabrancaevinho/P-14-7.]dll\nEncrypted: k8NhIk;dUZLb$b/)0(5:\nDecrypted: rundll32 \nEncrypted: J.9Obeck[h6=nePd{d>WWFQWGoiC|[5Joe,Z<WDo=4\nDecrypted: YourGonnaPayMeToday\n\n```\nAs seen in Figure 5, the initial versions of Lampion were distributed in the form of the EXE.\nThis file was responsible for unpacking the DLL from the 0.zip file and injecting it into\nmemory.\n\n\n-----\n\nIn this version, two DLLs are distributed instead of an EXE and single DLL. The first (P-147.dll) is injected via DLL injection by the VBS file at the initial stage. For this, it invokes the\ncall YourGonnaPayMeToday from EAT.\n\n**_Figure 7: Call invoked to load the DLL in memory (YourGonnaPayMeToday) – 1st stage._**\n\nThis first file is called by the VBS script and loaded into memory via the DLL injection\ntechnique using rundll32.exe from Windows, a technique widely used by red teams and\npentesters when used Metasploit framework.\n```\nrundll32.exe\nC:\\Users\\admin\\AppData\\Roaming\\59684788644313\\eakyvqgqeovfzwxau27622472643851.dll\nYourGonnaPayMeToday\n\n```\n[As other trojan bankers from Latin America – Grandoreiro – criminals are using arbitrary](https://seguranca-informatica.pt/the-updated-grandoreiro-malware-equipped-with-latenbot-c2-features-in-q2-2020-now-extended-to-portuguese-banks/)\nBMP images to increase the size of binaries, thus avoiding signature detection and also\nmaking it difficult to analyze via online sandboxes – since some sandboxes have a limit per\nsize when uploading files.\n\nAlso, a new layer anti-VM was added to this new release as shown below.\n\n\n-----\n\n**_Figure 8: Lampion DLL file oversize and error message when malware detects it is running_**\n_inside a VM._\n\nAs observed in other Lampion versions, the 0.zip file is protected with a strong password,\nwhich is extracted from the loader P-14-7.dll (1st stage). After extracting the final DLL from\nthe ZIP file, 2nd_stage.dll, and executing it in memory via DLL injection, it executes the\ninfection process.\n\nThis final DLL is executed in memory by calling the “DoThisBicht” function (see below).\n\n\n-----\n\n**_Figure 9: Lampion 2nd stage executed in memory via DLL injection._**\n\n[Lampion’s operating mode is the same as those analyzed in previous publications [1], [2],](https://seguranca-informatica.pt/targeting-portugal-a-new-trojan-lampion-has-spread-using-template-emails-from-the-portuguese-government-finance-tax/#.XwI-myhKguU)\nnonetheless, the DLL was recently compiled and is accompanied by some changes, as the\naddresses of C2 have been changed and also the way it communicates with C2. This time it\nis not used to transfer information about the infected machine through an HTTP call with the\ndestination C2, but TCP sockets are used.\n\n**_Figure 10: Compilation time – Jun 21 16:39 – 2020._**\n\nThe target banking organizations are the same as observed in the past samples.\n\n\n-----\n\n**_Figure 11: Banking organizations found inside the malware are the same as document in the_**\n_past._\n\nDuring the malware execution, it collects keystrokes (keylogger features) and is in a constant\nloop identifying the focus windows that the user is visiting.\n\nWhen a focus operation is identified over the browser window, it matches the title of the\nwindow with the internal hardcoded strings. In this case, “montepio” matches the target\nstrings hardcoded inside the malware (the name of a Portuguese bank). From here, the\nmalware starts its communication with the command and control server geolocated in Rusia,\nand next presents the specific overlay windows.\n\n\n-----\n\n**_Figure 12: C2 communication after detecting access to a home banking portal._**\n\nThe process of browser-overlay is then initiated and some fake windows controlled by\ncriminals are shown.\n\n\n-----\n\n**_[Figure 13: Lampion overlay screens (courtesy of MllenniumBCP – Portugal).](https://ind.millenniumbcp.pt/pt/Particulares/seguranca/Pages/avisos2019/aviso-2309.aspx)_**\n\nThe socket communication is performed sending details about the infected computer,\nkeylogging activity, and so on.\n\n**_Figure 14: C2 traffic observed during the malware execution._**\n\nAs observed below, the C2 server is geolocated in Russia. Some ports can be observed via\nShodan. The malware executes a socket communication between victims and C2 on port\n9171.\n\n\n-----\n\n**_Figure 15: Lampion C2 server geolocation – July 2020._**\n\nIt should also be mentioned that during the process of sending information, the trojan\nexecutes several ICMP requests to a server located in Germany. This is a mechanism used\nby malware to detect if the victim’s computer is connected to the internet.\n\n\n-----\n\n**_Figure 16: ICMP ping is used to validate Internet connection to establish a communication_**\n_with C2._\n\nIn addition, it is interesting to note that criminals are using a blacklist of flagged IP\naddresses. Whenever the client performs an infection from one of these IP addresses, the\nmalware terminates the execution after receiving the order from C2 and the infected\ncomputer is restarted.\n```\nServer Mandou ====> |EXITEWINDOWS|\nCliente Desconectado!\n\n## Final Thoughts\n\n```\nMalware is one of the major cyber weapons to destroy a business, market reputation, and\neven infect a wide number of users. The next list presents some tips on how you can prevent\na malware infection. It is not a complete list, it just a few steps to protect yourself and your\ndevices.\n\nGet outdated software of your system\nGet email savvy; take several minutes looking at the new email and not a few seconds\nBeware of fake tech support, emails related do bank transactions, invoices, COVID19,\neverything you think be strange\nKeep Internet activity relevant\nLog out at the end of the day\nOnly access secured and trusted sites (not only websites with green lock – please\nthink you are doing, as many phishing campaigns are abusing of free CA to create\nvalid HTTPS certificates and to distribute malicious campaigns over it)\nKeep your operating system up to date\n\n\n-----\n\nMake sure you are using an antivírus\nBeware of malvertising\n\n## Take-home message\n Be proactive and start taking malware protection seriously!\n\n Indicators of Compromise (IOCs)\n```\nhxxps://storage.googleapis.]com/bombetabrancaevinho/P-14-7.]dll\nhxxps://storage.googleapis.]com/bombetabrancaevinho/0.]zip\n--Strings-YourGonnaPayMeToday\nDoThisBicht\nFinal payload: be703ee8d83c3eb95fd5a343fed3d2947d2b98955be3b6eb8dd4752be1047537\n--C2-5.188.9.28\n\n Online Sandbox\n\n```\n[VirusTotal](https://www.virustotal.com/gui/file-analysis/NzM1YTI1MWY5MjFiZTg0YTIwMzljYjJiNTg0NjdlNGU6MTU5MzcyMzAzNw==/detection)\n\n[Joesandbox](https://www.joesandbox.com/analysis/243202/0/html)\n\n[Pedro Tavares](https://seguranca-informatica.pt/author/pipocaz/)\n**[Pedro Tavares is a professional in the field of information security working as an Ethical](https://www.linkedin.com/in/sirpedrotavares/)**\nHacker/Pentester, Malware Researcher and also a Security Evangelist. He is also a founding\nmember at CSIRT.UBI and Editor-in-Chief of the security computer blog segurancainformatica.pt.\n\nIn recent years he has invested in the field of information security, exploring and analyzing a\nwide range of topics, such as pentesting (Kali Linux), malware, exploitation, hacking, IoT and\nsecurity in Active Directory networks. He is also Freelance Writer (Infosec. Resources\n[Institute and Cyber Defense Magazine) and developer of the 0xSI_f33d – a feed that](https://feed.seguranca-informatica.pt/)\ncompiles phishing and malware campaigns targeting Portuguese citizens.\n\n[Read more here.](https://seguranca-informatica.pt/contacto/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-07-06 - New release of Lampion trojan spreads in Portugal with some improvements on the VBS downloader.pdf"
    ],
    "report_names": [
        "2020-07-06 - New release of Lampion trojan spreads in Portugal with some improvements on the VBS downloader.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535974,
    "ts_updated_at": 1743041118,
    "ts_creation_date": 1653774452,
    "ts_modification_date": 1653774452,
    "files": {
        "pdf": "https://archive.orkl.eu/59302e4e88db313ee632ea0f485c5b102debdbbc.pdf",
        "text": "https://archive.orkl.eu/59302e4e88db313ee632ea0f485c5b102debdbbc.txt",
        "img": "https://archive.orkl.eu/59302e4e88db313ee632ea0f485c5b102debdbbc.jpg"
    }
}