{
    "id": "f8c07b19-3146-4c94-94c7-1eeb09c898d9",
    "created_at": "2023-01-12T15:07:29.141405Z",
    "updated_at": "2025-03-27T02:17:27.511319Z",
    "deleted_at": null,
    "sha1_hash": "9b9e22400ddcc86e85e6fca40b3c4abe3f83e218",
    "title": "2019-05-02 - APT34- Glimpse project",
    "authors": "",
    "file_creation_date": "2022-05-28T17:54:15Z",
    "file_modification_date": "2022-05-28T17:54:15Z",
    "file_size": 684446,
    "plain_text": "# APT34: Glimpse project\n\n**marcoramilli.com/2019/05/02/apt34-glimpse-project/**\n\nView all posts by marcoramilli May 2, 2019\n\n[The APT34 Glimpse project is maybe the most complete APT34 project known so far.](https://github.com/marcoramilli/APT34)\nIndeed we might observe a File based command and control (quite unusual solution)\nstructure, a VBS launcher, a PowerShell Payload and a covert channel over DNS engine.\nThis last feature is the most appreciated characteristics attributed to APT34. But let’s move\non and start a quick analysis on it.\n\n**Context:**\n\n[Since at least 2014, an Iranian threat group tracked by FireEye as APT34 has conducted](https://www.fireeye.com/blog/threat-research/2017/12/targeted-attack-in-middle-east-by-apt34.html)\nreconnaissance aligned with the strategic interests of Iran. The group conducts operations\nprimarily in the Middle East, targeting financial, government, energy, chemical,\ntelecommunications and other industries. Repeated targeting of Middle Eastern financial,\nenergy and government organisations leads FireEye to assess that those sectors are a\nprimary concern of APT34. The use of infrastructure tied to Iranian operations, timing and\nalignment with the national interests of Iran also lead FireEye to assess that APT34 acts on\n[behalf of the Iranian government. (Source: MISP Project).](https://github.com/MISP/misp-galaxy/blob/master/clusters/threat-actor.json)\n\nOn April 19 2019 researchers at Chronicle, a security company owned by Google’s parent\ncompany, Alphabet, have examined the leaked tools, exfiltrated the past week on a Telegram\nchannel, and confirmed that they are indeed the same ones used by the OilRig\nattackers. [OilRig has been connected to a number of intrusions at companies and](https://attack.mitre.org/groups/G0049/)\ngovernment agencies across the Middle East and Asia, including technology firms, telecom\n\n\n-----\n\ncompanies, and even gaming companies. Whoever is leaking the toolset also has been\ndumping information about the victims OilRig has targeted, as well as data identifying some\nof the servers the group uses in its attacks.\n\nAccording to [Duo, “OilRig delivered Trojans that use DNS tunneling for command and](https://duo.com/decipher/someone-is-leaking-an-iranian-hacking-group-s-arsenal)\n**control in attacks since at least May 2016. Since May 2016, the threat group has**\n**introduced new tools using different tunneling protocols to their tool set” Robert**\nFalcone of Palo Alto Networks’ Unit 42 research team wrote in an analysis of the group’s\nactivities.\n\nToday I’d like to focus my attention on the Glimpse project since, in my personal opinion, it\ncould be considered as the “stereotype” of APT34 (with the data we ‘ve got so far).\n\n**The Glimpse Project**\n\nThe [package comes with a README file having as a name “Read me.txt” (note the space).](https://github.com/marcoramilli/APT34)\nThe name per se is quite unusual and the content is a simple guide on how to set a nodejs\nserver and a Windows server who would run the “stand alone” .NET (>v4) application to\ncontrol infected machines. The infection start by propagating a .VBS script called\n“runner_.vbs” which is a simple runner of a most sophisticated powershell payload. The\nPowershell payload is a quite complex script acting several functions. The following image\nshows its “deobfuscated” main loop.\n\nGlimpse Infection Payload Main Loop\nThe payload loops waiting for instructions, once a command comes from C2 it starts to\nperform specific actions and it answers back to C2 by requesting crafted subdomains based\non variable `$aa_domain_bb . One of the most important functions the payload has`\nimplemented is to drop and execute additional toolsets. Indeed this payload is mainly a\ndelivery module with some additional controls entirely based on DNS covert channel.\n\n\n-----\n\nThe `$aa_domain_bb variable contains the main domain name for which the C2 acts as`\nauthoritative Domain Name Server. While no actions are coming from C2 the infected agent\nwould just periodically “ping” C2 by giving basic informations regarding the victim machines.\nFor example the function `aa_ping_response_bb would compose an encoded DNS`\nmessage ( `aa_text_response_bb ) which sends it own last IP address. At this stage we`\nmight appreciate two communication ways. The first communication channel comes from the\nsubdomain generation for example: `59071Md8200089EC36AC95T.www.example.com` while\na second communication channel comes from TXT DNS record such as: `control: 95 -`\n```\nackNo: 0 - aid: 59071d8289 - action: M >>> 59071Md8200089EC36AC95T . Both of\n\n```\nthem are implemented to carry different informations. One of the most important function is\nthe `aa_AdrGen_bb which is the communication manager. It implements the control layer in`\norder to send and to receive control informations such as: commands, bytes received, if the\nfile transfer has been close, and so on and so forth. The decoded actions are stored into the\nvariable `aa_act_bb and are the following ones:`\n\nCommand and Control. Env creation for new connected agents\n```\n   M . If the agent is already registered to C2 this command acts like a ping, it updates\n\n```\nbasic informations to the corresponding “agent” folder. If it’s the first time the agent\nconnects back to C2 it starts a registration section which enables, server side\n(command and control side) the building up of an dedicated folders and file\nenvironment. Please check the previous image: Command and Control. Env creation\nfor new connected agents.\n```\n   W . This is a TXT request to list the waiting commands (or, if you wish “kind of jobs”).\n\n```\nThe first command that is executed after the registration phase is the command tagged\nas 10100 having as a content: `\"whoami&ipconfig /all\"`\n```\n   D . Is actually what should be executed. It takes as input the tagged task and it\n\n```\nforwards to the requesting Agent the Base64 encoded content of the file.\n```\n   0 . It is not a TXT request. This request makes the authoritative DNS (the command\n\n```\nand control) answers to the agent the requested file in the waiting folder. Answering\nback an `A record having as data field a crafted ip (11.24.237.110) if no “actions”`\n(fileS) are in the waiting folder the C2 answers back an `A record value having as data`\nfield `\"24.125.\" + fileNameTmp.substring(0, 2) + \".\" +`\n```\n   fileNameTmp.substring(2, 5); and time to live a random number between 0 to\n\n```\n360.\n```\n   1 . It is not a TXT request. This request makes the authoritative DNS (the command\n\n```\nand control) answer back with the file content. It implements a multiple answering\nchain, according to RFC4408, to send files greater than 255 characters.\n\n\n-----\n\n```\n   2 . It is not a TXT request. This requests makes the authoritative DNS (the command\n\n```\nand control) to receive a file from the Agent. It implements a complex multi-part chain\nfor reconstructing partials coming from domain name requests. After sending all of the\ndata, the Agent will issue a final DNS query with “COCTabCOCT” in the data segment.\nThis query notifies the C2 server that the Trojan has finished sending the contents of\nthe file.\n\nCommand and Control: COCTabCOCT end of communication\nThe following image shows a running example of the infection chain run on a controlled\nvirtual environment.You might appreciate the communication layers over the requested\ndomains. For example the following requests would carry on data in subdomain, while the\nanswered IP gives a specific affermative/negative response.\n\n10100*9056*****************.33333210100A[.]example[.]com\n\nGlimpse running environment\nThe command and control is implemented by a standalone .NET application working through\nfiles. The backend, a nodeJS server, runs and offers Public API and and saves, requests to\nagents, and results from agents, directly into files named with “UID-IP” convention acting as\n\n\n-----\n\nagent ID. The panel reads those files and implements stats and actions. The following image\nshows the static configuration section in the C2 panel.\n\nCommand and Control Panel Hardcoded Settings\nThe Control Panel is mainly composed by two .NET Window components. `Main Windows`\nwhere the list of connected Agents is shown within additional informations such as: Agent ID,\nAgent IP, Agent Last Online Time and Attacker Comments. And `Control Window which is`\ncalled once the attacker clicks on the on a selected Agent. The event `onClick spawn the`\nfollowing code:\n```\ncontrolPanel = new controlPanel(agent.id, agent.ip, agent.lastActivity);\ncontrolPanel.Show();\n\n```\nAfter its initialisation phase the control panel enables the attacker to write or to upload a list\nof commands or a file within commands to agents. The following image shows the\n```\ncontroPanel function which takes commands from inputs “TextFields”, creates a new file\n\n```\ninto the `waiting folder within commands. The contents of such a folder will be dropped on`\nthe selected Agent and executed.\n\nCommand and\n\nControl, controlPanel insert_command function\n\n\n-----\n\nThe controlPanel offers many additional functionalities to better control single or group of\nAgents. By focusing on trying to give a project date we might observe the compiled time\nwhich happens to be 9/1/2018 at 5:13:02 AM for `newPanel-dbg.exe while it happens to`\nbe 9/8/2018 at 8:01:54 PM for the imported library called `ToggleSwitch.dll .`\n\nWith High probability we are facing a multi-modular attacking framework where on one side\nthe DNS communication channel delivers commands to the target Agents and on the other\nside many control panels could be developed and attached to the DNS communication\nsystem. It would be quite obvious if you look to that framework as a developer, thus the DNS\ncommunication channel uses files to store informations and to synchronise actions and\nagents, so that many C2 could be adapted to use it as a communication channel. We might\nthink that that many APT34 units would be able to reuse such a communication channel.\nAnother interesting observation might come from trying to date that framework. A powershell\nAgent as been leaked on PasteBin o August 2018 [(take a look here) by an anonymous user](https://pastebin.com/mqchzzj0)\nand seen, since today, from very few people (197 so far). The used command and control\nhas been compiled the month before (July 2018). The developing technologies (.NET,\nnodeJS) are very different and the implementation styles differ as well. DNS Communication\nchannel is developed in linear and more functional driven programming style, while the\nstandalone command and control is developed using a little bit more sophisticated object\noriented programming with a flavour of agent-oriented programming: the attacker considers\nthe object `agent as an independent agent working without direct control. The attacker`\nwrites files as the medium to address the Agent behaviour.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-05-02 - APT34- Glimpse project.pdf"
    ],
    "report_names": [
        "2019-05-02 - APT34- Glimpse project.pdf"
    ],
    "threat_actors": [
        {
            "id": "ce10c1bd-4467-45f9-af83-28fc88e35ca4",
            "created_at": "2022-10-25T15:50:23.458833Z",
            "updated_at": "2025-03-27T02:00:55.475188Z",
            "deleted_at": null,
            "main_name": "APT34",
            "aliases": null,
            "source_name": "MITRE:APT34",
            "tools": [
                "netstat",
                "Systeminfo",
                "PsExec",
                "SEASHARPEE",
                "Tasklist",
                "Mimikatz",
                "POWRUNER",
                "certutil"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3eebdb3f-f4e3-42e5-bb4d-f02a13328316",
            "created_at": "2024-05-01T02:03:08.014303Z",
            "updated_at": "2025-03-27T02:05:17.306592Z",
            "deleted_at": null,
            "main_name": "COBALT EDGEWATER",
            "aliases": [
                "Cold River ",
                "DNSpionage ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT EDGEWATER",
            "tools": [
                " DNSpionage",
                " Karkoff",
                " MailDropper",
                " SideTwist",
                " TWOTONE",
                "AgentDrable"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536049,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1653760455,
    "ts_modification_date": 1653760455,
    "files": {
        "pdf": "https://archive.orkl.eu/9b9e22400ddcc86e85e6fca40b3c4abe3f83e218.pdf",
        "text": "https://archive.orkl.eu/9b9e22400ddcc86e85e6fca40b3c4abe3f83e218.txt",
        "img": "https://archive.orkl.eu/9b9e22400ddcc86e85e6fca40b3c4abe3f83e218.jpg"
    }
}