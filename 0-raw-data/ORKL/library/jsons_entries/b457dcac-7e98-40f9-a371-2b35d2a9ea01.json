{
    "id": "b457dcac-7e98-40f9-a371-2b35d2a9ea01",
    "created_at": "2023-01-12T15:04:43.281556Z",
    "updated_at": "2025-03-27T02:05:51.810256Z",
    "deleted_at": null,
    "sha1_hash": "d5d888faea48d88435ca835ecb924f2ce3f4525e",
    "title": "2022-09-30 - A glimpse into the shadowy realm of a Chinese APT- detailed analysis of a ShadowPad intrusion",
    "authors": "",
    "file_creation_date": "2022-10-23T12:54:59Z",
    "file_modification_date": "2022-10-23T12:54:59Z",
    "file_size": 543561,
    "plain_text": "# A glimpse into the shadowy realm of a Chinese APT: detailed analysis of a ShadowPad intrusion\n\n**[research.nccgroup.com/2022/09/30/a-glimpse-into-the-shadowy-realm-of-a-chinese-apt-detailed-analysis-of-a-shadowpad-intrusion/](https://research.nccgroup.com/2022/09/30/a-glimpse-into-the-shadowy-realm-of-a-chinese-apt-detailed-analysis-of-a-shadowpad-intrusion/)**\n\nAuthors: William Backhouse [(@Will0x04), Michael Mullen (@DropTheBase64) and Nikolaos Pantazopoulos](https://twitter.com/Will0x04)\n\n## Summary\n\n tl;dr\n\n\nSeptember 30, 2022\n\n\nThis post explores some of the TTPs employed by a threat actor who was observed deploying ShadowPad during an incident response\nengagement.\n\nBelow provides a summary of findings which are presented in this blog post:\n\nInitial access via CVE-2022-29464.\nSuccessive backdoors installed – PoisonIvy, a previously undocumented backdoor and finally ShadowPad.\nEstablishing persistence via Windows Services to execute legitimate binaries which sideloads backdoors, including ShadowPad.\nUse of information gathering tools such as ADFind and PowerView.\nLateral movement leveraging RDP and ShadowPad.\nUse of 7zip for data collection.\nShadowPad used for Command and Control.\nExfiltration of data.\n\n## ShadowPad\n\nThis blog looks to build on the work of other security research done by SecureWorks and PwC with firsthand experience of TTPs used in a\nrecent incident where ShadowPad was deployed. ShadowPad is a modular remote access trojan (RAT) which is thought to be used almost\nexclusively by China-Based threat actors.\n\n## Attribution\n\nBased on the findings of our Incident Response investigation, NCC Group assesses with high confidence that the threat actor detailed in\nthis article was a China-based Advanced Persistent Threat (APT).\n\nThis is based on the following factors\n\n\n-----\n\nShadowPad Public reporting has previously indicated the distribution of ShadowPad is tightly controlled and is typically exclusive to\nChina-based threat actors for use during espionage campaigns.\nTTPs – Specific TTPs observed during the attack were found to match those previously observed by China-based threat actors, both\nwithin NCC Group incident response engagements and the wider security community.\nActivity pattern analysis – The threat actor was typically active during the hours of 01:00 – 09:00 (UTC) which matches the working\nhours of China\n\n## TTPs\n\n Initial Access\n\nA recent vulnerability in WSO2, CVE-2022-29464 [3], was the root cause of the incident. The actor, amongst other attackers, was able to\nexploit the vulnerability soon after it was published to create web shells on a server.\n\nThe actor leveraged a web shell to load a backdoor, in this case PoisonIvy. This was deployed via a malicious DLL and leveraged DLL\nSearch Order Hijacking, a tactic which was continuously leveraged throughout the attack.\n\n## Execution\n\nCertutil.exe was used via commands issued on web shells to install the PoisonIvy backdoor on patient zero.\n\nThe threat actor leveraged command prompt and PowerShell throughout the incident.\n\nAdditionally, several folders named _MEI<random digits> were observed within the Windows\\Temp folder. The digits in the folder name\nchange each time a binary is compiled. These folders are created on a host when a python executable is compiled. Within these folders\nwere the .pyd library files and DLL files. The created time for these folders matched the last modified time stamp of the complied binary\nwithin the shimcache.\n\n## Persistence\n\nRun Keys and Windows services were used throughout in order to ensure the backdoors deployed obtained persistence.\n\n## Defense Evasion\n\nThe threat actor undertook significant anti-forensic actions on ShadowPad related files to evade detection. This included timestomping the\nmalicious DLL and applying the NTFS attributes of hidden and system to the files. Legitimate but renamed Windows binaries were used to\nload the configuration file. The threat actor also leveraged a legitimate Windows DLL, `secur32.dll, as the name of the configuration file`\nfor the ShadowPad backdoor.\n\nAll indicators of compromise, aside from backdoor modules and loaders, were removed from the hosts by the threat actor.\n\n## Credential Access\n\nThe threat actor was observed collecting all web browser credentials from all hosts across the environment. It is unclear at this stage how\nthis was achieved with the evidence available.\n\n## Discovery\n\nA vast array of tooling was used to scan and enumerate the network as the actor negotiated their way through it, these included but were\nnot limited to the following:\n\nAdFind\nNbtScan\nPowerView\nPowerShell scripts to enumerate hosts on port 445\nTree.exe\n\n## Lateral Movement\n\nLateral movement was largely carried out using Windows services, particularly leveraging SMB pipes. The only interactive sessions\nobserved were onward RDP sessions to customer connected sites.\n\n## Collection\n\n\n-----\n\nIn addition to the automated collection of harvested credentials, the ShadowPad keylogger module was used in the attack, storing the\nkeystrokes in encrypted database files for exfiltration. The output of which was likely included in archive files created by the attacker, along\nwith the output of network scanning and reconnaissance.\n\n## Command and Control\n\nIn total, three separate command and control infrastructures were identified, all of which utilised DLL search order hijacking / DLL side\nloading. The initial payload was PoisonIvy, this was only observed on patient zero. The threat actor went on to deploy a previously\nundocumented backdoor once they gained an initial foothold in the network, this framework established persistence via a service called\nK7AVWScn, masquerading as an older anti-virus product. Finally, once a firm foothold was established within the network the threat actor\ndeployed ShadowPad. Notably, the ShadowPad module for the proxy feature was also observed during the attack to proxy C2\ncommunications via a less conspicuous server.\n\n## Exfiltration\n\nDue to the exfiltration capabilities of ShadowPad, it is highly likely to have been the method of exfiltration to steal data from the customer\nnetwork. This is further cemented by a small, yet noticeable spike in network traffic to threat actor controlled infrastructure.\n\n## Recommendations\n\nSearches for the documented IOCs should be conducted\nIf IOCs are identified a full incident response investigation should be conducted\n\n## ShadowPad Technical Analysis\n\nInitialisation phase\n\nUpon execution, the ShadowPad core module enters an initialisation phase at which it decrypts its configuration and determines which\nmode it runs. In summary, we identified the following modes:\n\n\n**Mode**\n**ID**\n\n\n**Description**\n\n\n3 Injects itself to a specified process (specified in the ShadowPad configuration) and adds persistence to the compromised host.\nIn addition, if the compromised user belongs to a group with a SID starting with S-1-5-80- then the specified target process\nuses the token of ‘lsass’.\n\n4 Injects itself to a specified process (specified in the ShadowPad configuration) and executes the core code in a new thread.  In\naddition, if the compromised user belongs to a group with a SID starting with S-1-5-80 then the specified target process uses\nthe token of ‘lsass’.\n\n5 Injects itself to a specified process (specified in the ShadowPad configuration).   In addition, if the compromised user belongs\nto a group with a SID starting with S-1-5-80 then the specified target process uses the token of ‘lsass’.\n\n16 Injects itself to a specified process (specified in the ShadowPad configuration) and creates/starts a new service (details are\nspecified in the ShadowPad configuration), which executes the core code.   In addition, if the compromised user belongs to a\ngroup with a SID starting with S-1-5-80 then the specified target process uses the token of ‘lsass’.\n\n_Table 1 – ShadowPad Modes_\n_ANALYST NOTE: The shellcode is decrypted using a combination of bitwise XOR operations._\n\nConfiguration storage and structure\n\nShadowPad comes with an embedded encrypted configuration, which it locates by scanning its own shellcode (core module) with the\nfollowing method (Python representation):\n\n\n-----\n\n```\n first_value = data[dword :dword+4]\n\n second_value = data[dword+4:dword+8]\n\n third_value = data[dword+8:dword+12]\n\n fourth_value = data[dword+12:dword+16]\n\n fifth_value = data[dword+16:dword+20]\n\n sixth_value = data[dword+20:dword+24]\n\n xor1 = int.from_bytes(second_value,'little') ^ 0x8C4832F1\n\n xor2 = int.from_bytes(fourth_value,'little') ^ 0xC3BF9669\n\n xor3 = int.from_bytes(sixth_value,'little') ^ 0x9C2891BA\n\n if xor1 == int.from_bytes(first_value,'little') and xor2 ==  int.from_bytes(third_value,'little') and xor3 ==\nint.from_bytes(fifth_value,'little'):\n\n   print(f\"found: {dword:02x}\")\n\n   encrypted = data[dword:]\n\n   break\n\n```\nAfter locating it successfully, it starts searching in it for a specified byte that represents the type of data (e.g., 0x02 represents an\nembedded module). In total, we have identified the following types:\n\n**ID** **Description**\n\n0x02 Embedded ShadowPad module.\n\n0x80 ShadowPad configuration. It should start with the DWORD value 0x9C9D22EC.\n\n0x90 XOR key used during the generation of unique names (e.g., registry key name)\n\n0x91 DLL loader file data.\n\n0x92 DLL loader file to load. File might have random appended data (Depends on the config’s flag at offset 0x326).\n\n0xA0 Loader’s filepath\n\n_Table 2 – Shadowpad Data Types_\nOnce one of the above bytes are located, ShadowPad reads the data (size is defined before the byte identifier) and appends the last\nDWORD value to the hardcoded byte array ‘1A9115B2D21384C6DA3C21FCCA5201A4’. Then it hashes (MD5) the constructed byte array\nand derives an AES-CBC 128bits key and decrypts the data.\n\nIn addition, ShadowPad stores, in an encrypted format, the following data in the registry with the registry key name being unique (based\non volume serial number of C:\\) for each compromised host:\n\n1. ShadowPad configuration (0x80) data.\n2. Proxy configuration. Includes proxy information that ShadowPad requires. These are the network communication protocol, domain/IP\n\nproxy and the proxy port.\n3. Downloaded modules.\n\nShadowPad Network Servers\n\nShadowPad starts two TCP/UDP servers at 0.0.0.0. The port(s) is/are specified in the ShadowPad configuration. These servers work as a\nproxy between other compromised hosts in the network.\n\nIn addition, ShadowPads starts a raw socket server, which receives data and does one of the following tasks (depending on the received\ndata):\n\n1. Updates and sets proxy configuration to SOCKS4 mode.\n2. Updates and sets proxy configuration to SOCKS5 mode.\n3. Updates and sets proxy configuration to HTTP mode.\n\nNetwork Communication\n\nShadowPad supports a variety of network protocols (supported by dedicated modules). For all of them, ShadowPad uses the same\nprocedure to store and encrypt network data. The procedure’s steps are:\n\n1. Compress the network data using the QuickLZ library module.\n2. Generates a random DWORD value, which is appended to the byte array         ‘1A9115B2D21384C6DA3C21FCCA5201A4’.\n\nThen, the constructed byte array is    hashed (MD5) and an AES-CBC 128bits key is derived (CryptDeriveKey).\n\n\n-----\n\n3. The data is then encrypted using the generated AES key. In addition, Shadowpad    encrypts the following data fields using bitwise\n\nXOR operations:\n\n1. Command/Module ID: Command/Module ID ^ ( 0x1FFFFF * Hashing_Key – 0x2C7BEECE )\n2. Data_Size: Data_Size ^ ( 0x1FFFFFF * 0x7FFFFF * ( 0x1FFFFF * Hashing_Key – 0x2C7BEECE ) – 0x536C9757 – 0x7C06303F )\n3. Command_Execution_State: Command_Execution_State ^ 0x7FFFFF * (0x1FFFFF * Hashing_Key – 0x2C7BEECE) – 0x536C9757\n\nAs a last step, ShadowPad encapsulates the above generated data into the following    structure:\n```\nstruct Network_Packet\n\n{\n DWORD Hashing_Key;\n\n DWORD Command_ID_Module_ID;\n\n DWORD Command_Execution_State; //Usually contains any error codes.\n\n DWORD Data_Size;\n\n byte data[Data_Size];\n\n};\n\n\n```\nIf any server responds, it should have the same format as above.\n\nNetwork Commands and Modules\n\nDuring our analysis, we managed to extract a variety of ShadowPad modules with most of them having their own set of network\ncommands. The table below summarises the identified commands of the modules, which we managed to recover.\n\n**Module** **Command ID** **Description**\n\nMain module 0xC49D0031 First command sent to the C2 if the commands fetcher function does not run in a\ndedicated thread.\n\nMain module 0xC49D0032 First command sent to the C2 if the commands fetcher function does run in a\ndedicated thread.\n\nMain module 0xC49D0033 Fingerprints the compromised host and sends the information to the C2.\n\nMain module 0xC49D0032 (Received) Executes the network command fetcher function in a thread.\n\nMain module 0xC49D0034 Sents an empty reply to the C2.\n\nMain module 0xC49D0037 Echoes the server’s reply.\n\nMain module 0xC49D0039 Sends number of times the Shadowpad files were detected to be deleted.\n\nMain module 0xC49D0016 Deletes Shadowpad registry keys.\n\nMain module 0xC49D0035 Enters sleep mode for 3 seconds in total.\n\nMain module 0xC49D0036 Enters sleep mode for 5 seconds in total.\n\nMain module 0xC49D0010 Retrieves Shadowpad execution information.\n\nMain module 0xC49D0012 Updates Shadowpad configuration (in registry).\n\nMain module 0xC49D0014 Deletes Shadowpad module from registry.\n\nMain module 0xC49D0015 Unloads a Shadowpad module.\n\nMain module 0xC49D0020 Retrieves Shadowpad current configuration (from registry).\n\nMain module 0xC49D0021 Updates the Shadowpad configuration in registry and (re)starts the TCP/UDP\nservers.\n\nMain module 0xC49D0022 Deletes Shadowpad registry entries and starts the TCP/UDP servers.\n\nMain module 0xC49D0050 Retrieves Shadowpad proxy configuration from registry.\n\nMain module 0xC49D0051 Updates Shadowpad proxy configuration.\n\nMain module 0xC49D0052 Updates Shadowpad proxy configuration by index.\n\nMain module 0xC49D0053 Sets Shadowpad proxy configuration bytes to 0\n\nMain module Any Module ID Loads and initialises the specified module ID.\n\nFiles manager module 0x67520006 File operations (copy,delete,move,rename).\n\n\n-----\n\nFiles manager module 0x67520007 Executes a file.\n\nFiles manager module 0x67520008 Uploads/Downloads file to/from C2.\n\nFiles manager module 0x6752000A Searches for a specified file.\n\nFiles manager module 0x6752000C Downloads a file from a specified URL.\n\nFiles manager module 0x67520005 Timestomp a file.\n\nFiles manager module 0x67520000 Get logical drives information.\n\nFiles manager module 0x67520001 Searches recursively for a file.\n\nFiles manager module 0x67520002 Checks if file/directory is writable.\n\nFiles manager module 0x67520003 Creates a directory.\n\nFiles manager module 0x67520004 Gets files list in a given directory\n\nTCP/UDP module 0x54BD0000 Loads TCP module and proxy data via it.\n\nTCP/UDP module 0x54BD0001 Proxies UDP network data.\n\nDesktop module 0x62D50000 Enumerates monitors.\n\nDesktop module 0x62D50001 Takes desktop screenshot.\n\nDesktop module 0x62D50002 Captures monitor screen.\n\nDesktop module 0x62D50010 Gets desktop module local database file path.\n\nDesktop module 0x62D50011 Reads and sends the contents of local database file to the C2.\n\nDesktop module 0x62D50012 Writes to local database file and starts a thread that constantly takes desktop\nscreenshots.\n\n\nProcesses manager\nmodule\n\nProcesses manager\nmodule\n\nNetwork Connections\nmodule\n\nNetwork Connections\nmodule\n\n\n0x70D0000 Gets processes list along with their information\n\n0x70D0001 Terminates a specified process\n\n0x6D0000 Gets TCP network table.\n\n0x6D0001 Gets UDP network table.\n\n\nPIPEs module 0x23220000 Reads/Writes data to PIPEs.\n\nPropagation module 0x2C120010 Get module’s configuration.\n\nPropagation module 0x2C120011 Transfer network data between C2 and PIPEs.\n\nPropagation module 0x2C120012 Constant transfer of network data between C2 and PIPEs.\n\nPropagation module 0x2C120013 Transfer network data between C2 and PIPEs.\n\nPropagation module 0x2C120014 Constant transfer of network data between C2 and PIPEs.\n\nPropagation module 0x2C120015 Transfer network data between C2 and PIPEs.\n\nPropagation module 0x2C120016 Constant transfer of network data between C2 and PIPEs.\n\nPropagation module 0x2C120017 Transfer network data between C2 and PIPEs.\n\nPropagation module 0x2C120018 Transfer network data between C2 and PIPEs.\n\nScheduled tasks module 0x71CD0000 Gets a list of the scheduled tasks.\n\nScheduled tasks module 0x71CD0001 Gets information of a specified scheduled task.\n\nWi-Fi stealer module 0xDC320000 Collects credentials/information of available Wi-Fi devices.\n\n\nNetwork discovery\nmodule\n\n\n0xF36A0000 Collects MAC addresses.\n\n\n-----\n\nNetwork discovery\nmodule\n\nNetwork discovery\nmodule\n\n\n0xF36A0001 Collects IP addresses information.\n\n0xF36A0003 Port scanning.\n\n\nConsole module 0x329A0000 Starts a console mode in the compromised host.\n\nKeylogger module 0x63CA0000 Reads the keylogger file and sends its content to the C2.\n\nKeylogger module 0x63CA0001 Deletes keylogger file.\n\n_Table 3 – Modules Network Commands_\nBelow are listed the available modules, which do not have network commands (Table 3).\n\n**Module ID** **Description**\n\nE8B5 QUICKLZ library module.\n\n7D82 Sockets connection module (supports SOCKS4, SOCKS5 and HTTP).\n\nC7BA TCP module.\n\n_Table 4 – Available modules without network commands_\nBelow are listed the modules that we identified after analysing the main module of ShadowPad but were not recovered.\n\n**Module ID** **Description**\n\n0x25B2 UDP network module.\n\n0x1FE2 HTTP network module.\n\n0x9C8A HTTPS network module.\n\n0x92CA ICMP network module\n\n0x64EA Unknown\n\n_Table 5 – Non-Recovered ShadowPad Modules_\nMisc\n\n1. ShadowPad uses a checksum method to compare certain values (e.g., if it runs under    certain access rights). This method has\n\nbeen implemented below in Python:\n```\nror = lambda val, r_bits, max_bits: \\\n\n((val & (2**max_bits-1)) >> r_bits%max_bits) | \\\n\n(val << (max_bits-(r_bits%max_bits)) & (2**max_bits-1))\n\nrounds = 0x80\n\ndata = b\"\"\n\noutput = 0xB69F4F21\n\nmax_bits = 32\n\ncounter = 0\n\nfor i in range( len(data) ):\n\n data_character = data[counter]\n\n if (data_character - 97)&0xff <= 0x19:\n\n data_character &= ~0x20&0xfffffff\n\n counter +=1\n\n output = (data_character + ror(output, 8,32)) ^ 0xF90393D1\n\n print ( hex( output ))\n\n```\nUnder certain modes, ShadowPad chooses to download and inject a payload from its    command-and-control server. ShadowPad\nparses its command-and-control server    domain/IP address and sends a HTTP request. The reply is expected to be a payload,\nwhich ShadowPad injects into another process.\n\n_ANALYST NOTE: In case the IP address/Domain includes the character ‘@’,_ _ShadowPad decrypts it with a custom_\n_algorithm._\n\n## Indicators of Compromise\n\n\n-----\n\nIOC Indicator\nType\n\nC:\\wso2is-4.6.0\\BVRPDiag.exe File\nPath\n\nC:\\wso2is-4.6.0\\BVRPDiag.tsi File\nPath\n\nC:\\wso2is-4.6.0\\BVRPDiag.dll File\nPath\n\nC:\\wso2is-4.6.0\\ModemMOH.dll File\nPath\n\nC:\\Windows\\System32\\spool\\drivers\\color\\K7AVWScn.dll File\nPath\n\nC:\\Windows\\System32\\spool\\drivers\\color\\K7AVWScn.doc File\nPath\n\nC:\\Windows\\System32\\spool\\drivers\\color\\K7AVWScn.exe File\nPath\n\nC:\\Windows\\System32\\spool\\drivers\\color\\secur32.dll File\nPath\n\nC:\\Windows\\System32\\spool\\drivers\\color\\secur32.dll.dat File\nPath\n\nC:\\Windows\\System32\\spool\\drivers\\color\\WindowsUpdate.exe File\nPath\n\nC:\\Windows\\Temp\\WinLog\\secur32.dll File\nPath\n\nC:\\Windows\\Temp\\WinLog\\secur32.dll.dat File\nPath\n\nC:\\Windows\\Temp\\WinLog\\WindowsEvents.exe File\nPath\n\nC:\\ProgramData\\7z.dll File\nPath\n\nC:\\ProgramData\\7z.exe File\nPath\n\nC:\\Users\\Public\\AdFind.exe File\nPath\n\nC:\\Users\\Public\\nbtscan.exe File\nPath\n\nC:\\Users\\Public\\start.bat File\nPath\n\n\nDescription\n\nLegitimate\nexecutable to\nsideload\nPoisonIvy\n\nPoisonIvy\n\nPreviously\nundocumented\nC2 framework\n\nUnknown file in\nthe same\nlocation as\nPosionIvy\n\nLegitimate\nexecutable to\nsideload\nPoisonIvy\n\nShadowPad\nDLL\n\nShadowPad\nEncrypted\nConfiguration\n\nLegitimate\nexecutable to\nsideload\nShadowPad\n\nShadowPad\nDLL\n\nShadowPad\nEncrypted\nConfiguration\n\nLegitimate\nexecutable to\nsideload\nShadowPad\n\nArchiving tool\n\nArchiving tool\n\nReconnaissance\ntooling\n\nReconnaissance\ntooling\n\nUnknown batch\nscript,\nsuspected to\nstart execution\nof mimikatz\n\n\n-----\n\nC:\\Users\\Public\\t\\64.exe File\nPath\n\nC:\\Users\\Public\\t\\7z.exe File\nPath\n\nC:\\Users\\public\\t\\browser.exe File\nPath\n\nC:\\Users\\Public\\t\\nircmd.exe File\nPath\n\nC:\\users\\public\\t\\test.bat File\nPath\n\nC:\\Users\\Public\\test.bat File\nPath\n\nC:\\Users\\Public\\test.exe File\nPath\n\nC:\\Users\\Public\\test\\Active Directory\\ntds.dit File\nPath\n\nC:\\Users\\Public\\test\\registry\\SECURITY File\nPath\n\nC:\\Users\\Public\\test\\registry\\SYSTEM File\nPath\n\nC:\\Users\\Public\\WebBrowserPassView.exe File\nPath\n\nC:\\Windows\\debug\\adprep\\P.bat File\nPath\n\nC:\\Windows\\system32\\spool\\drivers\\affair.exe File\nPath\n\nC:\\Windows\\System32\\spool\\drivers\\color\\SessionGopher.ps1 File\nPath\n\nC:\\windows\\system32\\spool\\drivers\\color\\tt.bat File\nPath\n\nC:\\Windows\\Temp\\best.exe File\nPath\n\nip445.ps1 File\nName\n\n\nUnknown\nexecutable,\nsuspected\nmimikatz\n\nArchiving tool\n\nUnknown\nattacker\nexecutable\n\nNirCmd is a\nsmall commandline utility that\nallows you to do\nsome useful\ntasks without\ndisplaying any\nuser interface.\n\nUnknown\nattacker batch\nscript\n\nUnknown\nattacker batch\nscript\n\nUnknown\nattacker\nexecutable\n\nStaging location\nfor NTDS dump\n\nStaging location\nfor registry\ndump\n\nStaging location\nfor registry\ndump\n\nNirSoft tool for\nrecovering\ncredentials from\nweb browsers.\n\nUnknown\nattacker batch\nscript\n\nUnknown\nattacker\nexecutable\n\nDecrypts saved\nsession\ninformation for\nremote access\ntools.\n\nUnknown\nattacker batch\nscript\n\nTree.exe\n\nUnknown\nPowerShell\nscript suspected\nto be related to\nnetwork\nreconnaissance\n\n\n-----\n\nip445.txt File\nName\n\nnbtscan.exe File\nName\n\nSOFTWARE: Classes\\CLSID\\*\\42BF3891 Registry\nKey\n\nSOFTWARE: Classes\\CLSID\\*\\45E6A5BE Registry\nKey\n\nSOFTWARE: Classes\\CLSID\\*\\840EE6F6 Registry\nKey\n\nSOFTWARE: Classes\\CLSID\\*\\9003BDD0 Registry\nKey\n\nSoftware:Classes\\CLSID\\*\\51E27247 Registry\nKey\n\nSoftware\\Microsoft\\*\\*\\009F24BCCEA54128C2344E03CEE577E12504DD569C8B48AB8B7EAD5249778643 Registry\nKey\n\nSoftware\\Microsoft\\*\\*\\5F336A90564002BE360DF63106AA7A7568829C6C084E793D6DC93A896C476204 Registry\nKey\n\nSoftware\\Microsoft\\*\\*\\FF98EFB4C7680726BF336CEC477777BB3BEB73C7BAA1A5A574C39E7F4E804585 Registry\nKey\n\nD1D0E39004FA8138E2F2C4157FA3B44B MD5\nHash\n\n54B419C2CAC1A08605936E016D460697 MD5\nHash\n\nB426C17B99F282C13593954568D86863 MD5\nHash\n\n7504DEA93DB3B8417F16145E8272BA08 MD5\nHash\n\nD99B22020490ECC6F0237EFB2C3DEF27 MD5\nHash\n\n1E6E936A0A862F18895BC7DD6F607EB4 MD5\nHash\n\nA6A19804248E9CC5D7DE5AEA86590C63 MD5\nHash\n\n4BFE4975CEAA15ED0031941A390FAB55 MD5\nHash\n\n87F9D1DE3E549469F918778BD637666D MD5\nHash\n\n8E9F8E8AB0BEF7838F2A5164CF7737E4 MD5\nHash\n\n## Mitre Att&ck\n\nTactic Technique ID Description\n\n\nSuspected\noutput file for\nip445.ps1\n\nAttacker tooling\n\nEncrypted\nShadowPad\nconfiguration\n\nEncrypted\nShadowPad\nconfiguration\n\nEncrypted\nShadowPad\nconfiguration\n\nEncrypted\nShadowPad\nconfiguration\n\nEncrypted\nShadowPad\nconfiguration\n\nEncrypted\nShadowPad\nmodule\n\nEncrypted\nShadowPad\nmodule\n\nEncrypted\nShadowPad\nmodule\n\nPoisenIvy DLL\n\nUndocumented\nbackdoor DLL\n\nUndocumented\nbackdoor\nrelated file\n\nShadowPad\nDLL\n\nShadowPad\nDLL\n\nShadowPad\nDLL\n\nShadowPad\nDLL\n\nShadowPad\nDLL\n\nShadowPad\nDLL\n\nShadowPad\nDLL\n\n\n-----\n\nInitial\nAccess\n\n\nExploit Public-Facing\nApplications\n\n\nExecution Command and\nScripting Interpreter:\nPowerShell\n\nExecution Command and\nScripting Interpreter:\nWindows Command\nShell\n\nExecution Command and\nScripting Interpreter:\nPython\n\nExecution Scheduled Task/Job:\nScheduled Task\n\nExecution Exploitation for Client\nExecution\n\nExecution Windows\nManagement\nInstrumentation\n(WMI)\n\nPersistence Boot or Logon\nAutostart Execution:\nRegistry Run Keys /\nStartup Folder\n\nPersistence Create or Modify\nSystem Process:\nWindows Service\n\n\nPrivilege\nEscalation\n\nDefence\nEvasion\n\nDefence\nEvasion\n\nDefence\nEvasion\n\nDefence\nEvasion\n\nDefence\nEvasion\n\nDefence\nEvasion\n\nDefence\nEvasion\n\nDefence\nEvasion\n\nDefence\nEvasion\n\n\nValid Accounts:\nDomain Accounts\n\nImpair Defenses:\nDowngrade Attack\n\nIndicator Removal on\nHost: File Deletion\n\nIndicator Removal on\nHost: Timestomp\n\n\nObfuscated Files or\nInformation\n\nMasquerading:\nRename System\nUtilities\n\nProcess Injection:\nProcess Hollowing\n\nHide Artefacts:\nHidden Files and\nDirectories\n\nHijack Execution\nFlow: DLL Search\nOrder Hijacking\n\n\nT1190 Initial access was gained via the threat actor exploiting CVE-2022-29464 to create a\nweb shell\n\nT1059:001 PowerShell based tools PowerView and SessionGopher were executed across the\nestate for reconnaissance and credential harvesting. Additionally, hands on keyboard\ncommands were identified as being executed to confirm which version of the\nmalware was present.\n\nT1059:003 A scheduled task used by the threat actor was used to launch a Windows Command\nShell. The purpose is not known.\n\nT1059:006 Several compiled python binaries were identified. It is likely the binaries related to the\ncreation of an FTP server.\n\nT1053 A scheduled task named “update” was observed and configured to execute a\ncommand prompt on multiple hosts throughout the environment. Upon successful\nexecution of the task the threat actor then deleted the task from the host\n\nT1203 The threat actor leveraged CVE-2022-29464 to deploy web shells and allow remote\ncommand execution on patient zero.\n\nT1047 WMI was used by the threat actor to carry out reconnaissance activity.\n\nT1547.001 A run key for the local administrator was created to execute the malicious backdoor.\n\nT1543.003 Two malicious services were deployed widely across the estate for persistence of the\nbackdoors. Both services execute a legitimate binary which is stored in the same\nlocation as a malicious DLL, when executed the legitimate binary would side load the\nmalicious DLL containing the backdoor.\n\nT1078.002 The threat actor was primarily using domain administrator credentials to move\nlaterally throughout the attack, allowing them to blend in with legitimate administrator\nactivity.\n\nT1562.010 The threat actor was observed utilising PowerShell downgrades, this is typically used\nby threat actors to avoid the script logging capabilities of PowerShell version 5+\n\nT1070.004 The threat actor routinely removed the majority of tooling deployed throughout the\nattack from hosts upon completion of their objectives.\n\nT1070.006 The threat actor timestomped all files relating to the backdoors including the\nlegitimate binary and the malicious DLL.\n\n\nModify Registry T1112 The modules for ShadowPad were stored within the registry in an encrypted format.\nThe keys for the stored data are generated depending on the volume serial number\nof the host.\n\n\nT1027 The ShadowPad configuration was stored within an encrypted registry hive. The\nkeylogger module of ShadowPad created an encrypted output file on the host.\n\nT1036.003 The threat actor leveraged a legitimate Windows DLL, secur32.dll, as the name of\nthe configuration file for the ShadowPad backdoor.\n\nT1055.012 Upon execution ShadowPad spawns a sacrificial process, which then utilises the\ntechnique of process hollowing to inject into the process.\n\nT1564.001 Several malicious files were identified as having the NTFS attribute of hidden.\n\nT1574.001 The backdoors leveraged DLL Search Order Hijacking.\n\n\n-----\n\nCredential\nAccess\n\nCredential\nAccess\n\nCredential\nAccess\n\nCredential\nAccess\n\nCredential\nAccess\n\nCredential\nAccess\n\n\nCredentials from\nPassword Stores:\nCredentials from\nWeb Browsers\n\nCredentials from\nPassword Stores:\nWindows Credential\nManager\n\nOS Credential\nDumping: LSASS\nMemory\n\nOS Credential\nDumping: NTDS\n\nUnsecured\nCredentials:\nCredentials in Files\n\nInput Capture:\nKeylogging\n\n\nT1555:003 The NirSoft tool WebBrowserPassView.exe was also identified as being executed by\nthe attacker.\n\nT1555.004 Credential harvesting which indicated credentials from Windows Credential Manager\nwere collected was identified on a domain controller.\n\nT1003.001 ProcDump.exe was leveraged on patient zero during the attack in order to dump\ncredentials stored in the process memory of Local Security Authority Subsystem\nService (LSASS).\n\nT1003.003 The NTDS.dit was dumped and exfiltrated from a domain controller for each domain.\n\nT1552.001 Several instances of passwords in plaintext files were observed on hosts where\nShadowPad was installed/\n\nT1056:001 ShadowPad instances had a Keylogger module installed.\n\nT1083 Tree.exe was used to enumerate files and directories on compromised hosts.\n\nT1135 A PowerShell script named ip445.ps1 was used throughout the attack to enumerate\nnetwork shares across the Windows estate.\n\nT016 AdFind.exe can extract subnet information from Active Directory.\n\nT1087.002 AdFind.exe can enumerate domain users.\n\nT1482 AdFind.exe can gather information about organizational units (OUs) and domain\ntrusts from Active Directory.\n\nT1069 AdFind.exe can enumerate domain groups.\n\nT1018 AdFind.exe has the ability to query Active Directory for computers.\n\nT1021.001 RDP was used by the threat actor to laterally move. It is unknown whether this was a\ndeliberate act to move estates or if the threat actor was attempting to move to\nanother domain.\n\nT1021.002 The Powerview module of Powersploit was used to enumerate all SMB shares\nacross the environment.\n\nT1021.006 WinRM was used by the actor during periods of network reconnaissance.\n\nT1021.003 Anti-virus alerts showed the threat actor as utilising WMI to laterally move to hosts\nacross the network.\n\nT1119 Large scale credential harvesting was conducted against remote hosts from a\ndomain controller.\n\nT1074.002 Credentials harvested by the threat actor were collected on a domain controller, prior\nto exfiltration.\n\nT1056.001 ShadowPad instances had a Keylogger module installed which allowed them to\ncapture the input of interactive sessions. The output was stored on disk in encrypted\ndatabase files.\n\n\nDiscovery File and Directory\nDiscovery\n\nDiscovery Network Share\nDiscovery\n\nDiscovery System Network\nConfiguration\nDiscovery\n\nDiscovery Account Discovery:\nDomain Account\n\nDiscovery Domain Trust\nDiscovery\n\nDiscovery Permission Groups\nDiscovery: Domain\nGroups\n\nDiscovery Remote System\nDiscovery\n\n\nLateral\nMovement\n\nLateral\nMovement\n\nLateral\nMovement\n\nLateral\nMovement\n\n\nRemote Services:\nRemote Desktop\nProtocol\n\nRemote Services:\nSMB/Windows\nAdmin Shares\n\nRemote Services:\nWindows Remote\nManagement\n\nRemote Services:\nDistributed\nComponent Object\nModel\n\n\nCollection Automated\nCollection\n\nCollection Data Staged:\nRemote Data\nStaging\n\nCollection Input Capture:\nKeylogging\n\n\n-----\n\nCollection Archive Collected\nData: Archive via\nUtility\n\n\nT1560.001 The actor was routinely observed archiving collected data via 7zip.\n\n\nCommand\nand Control\n\nCommand\nand Control\n\n\nEncrypted Channel T1573 ShadowPad configurations indicated Command and Control communications were\nsent via port 443.\n\nProxy: Internal Proxy T1090.001 ShadowPad instances had a Proxy module installed. It was identified that a proxy\nmodule was installed and was interacting via port 445.\n\n\nExfiltration Exfiltration Over C2\nChannel\n\n\nT1041 ShadowPad has the capability to exfiltrate data.\n\n\n\n[1] [https://www.secureworks.com/research/shadowpad-malware-analysis](https://www.secureworks.com/research/shadowpad-malware-analysis)\n\n[2] [https://www.pwc.co.uk/issues/cyber-security-services/research/chasing-shadows.html](https://www.pwc.co.uk/issues/cyber-security-services/research/chasing-shadows.html)\n\n[3] [https://nvd.nist.gov/vuln/detail/CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-09-30 - A glimpse into the shadowy realm of a Chinese APT- detailed analysis of a ShadowPad intrusion.pdf"
    ],
    "report_names": [
        "2022-09-30 - A glimpse into the shadowy realm of a Chinese APT- detailed analysis of a ShadowPad intrusion.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535883,
    "ts_updated_at": 1743041151,
    "ts_creation_date": 1666529699,
    "ts_modification_date": 1666529699,
    "files": {
        "pdf": "https://archive.orkl.eu/d5d888faea48d88435ca835ecb924f2ce3f4525e.pdf",
        "text": "https://archive.orkl.eu/d5d888faea48d88435ca835ecb924f2ce3f4525e.txt",
        "img": "https://archive.orkl.eu/d5d888faea48d88435ca835ecb924f2ce3f4525e.jpg"
    }
}