{
    "id": "6a99d2e4-d24a-4db4-a5ed-5678b9d1c8c1",
    "created_at": "2023-01-12T15:10:31.691662Z",
    "updated_at": "2025-03-27T02:08:00.088112Z",
    "deleted_at": null,
    "sha1_hash": "eed08cc1f06af768260610b309d5c9f49afbb998",
    "title": "2018-10-03 - New Betabot campaign under the microscope",
    "authors": "",
    "file_creation_date": "2022-05-27T23:09:56Z",
    "file_modification_date": "2022-05-27T23:09:56Z",
    "file_size": 2499715,
    "plain_text": "# New Betabot campaign under the microscope\n\n**cybereason.com/blog/betabot-banking-trojan-neurevt**\n\nWritten By\nCybereason Nocturnus\n\nOctober 3, 2018 | 6 minute read\n\n## Research by: Assaf Dahan\n\n[In the past few weeks, the Cybereason SOC has detected multiple Betabot (aka Neurevt)](https://www.virusbulletin.com/virusbulletin/2014/05/neurevt-botnet-new-generation)\ninfections in customer environments. Betabot is a sophisticated infostealer malware that’s\nevolved significantly since it first appeared in late 2012. The malware began as a banking\nTrojan and is now packed with features that allow its operators to practically take over a victim’s\nmachine and steal sensitive information.\n\n\n-----\n\nWant to start threat hunting like the pros?\n\nBetabot’s main features include:\n\n[Browsers Form Grabber](https://en.wikipedia.org/wiki/Form_grabbing)\nFTP and mail client stealer\nBanker module\nRunning DDOS attacks\nUSB infection module\nRobust Userland Rootkit (x86/x64)\nArbitrary command execution via shell\nThe ability to download additional malware\nPersistence\nCrypto-currency miner module (added 2017)\n\nBetabot exploits an 18-year-old vulnerability in the Equation Editor tool in Microsoft Office. The\nvulnerability has been around since 2000 when Equation Editor was added to Office. However,\n[it wasn’t discovered by researchers and patched by Microsoft until 2017.](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-11882)\n\nMost modern malware have self-defense features designed to bypass detection and thwart\nanalysis. These features include anti-debugging, anti-virtual machine/sandbox, antidisassembly and the ability to detect security products and analysis tools. It is not uncommon\nfor malware to take a more aggressive approach and disable or uninstall antivirus software.\nOther programs remove malware and bots that are already on a person’s machine, eliminating\nthe competition with heuristic approaches that would put many security products to shame.\n\n\n-----\n\nBetabot stands out because it implements all of these self-defense features and has an\nexhaustive blacklist of file and process names, product IDs, hashes and domains from major\nantivirus, security and virtualization companies.\n\nThis blog will use Cybereason telemetry data gathered from multiple customer endpoints to\nlook at the infection chain. We’ll also delve into Betabot’s self-defense mechanisms.\n\n## Infection Vector: CVE-2017-11882 Exploit-Weaponized Document\n\nThe Betabot infections seen in our telemetry originated from phishing campaigns that used\nsocial engineering to persuade users to download and open what appears to be a Word\ndocument that is attached to an email.\n\nThis screenshot shows the infection vector from Lotus Notes email client:\n\n\n-----\n\n**Purchase order#.doc** **details (SHA-1:** [566154dadb304019a8b035d883c9e32ca95cd64e)](https://www.virustotal.com/#/file/c3e802c8a2f286145c971617e2822a93178b9302acd3c249e8b72968e332bb0c/detection)\n\nExamining the document in a Hex editor, we can see that it is, in fact, an RTF file:\n\nUsing Didier Steven’s [rtfdump.py, we can see multiple entries with embedded objects:](https://github.com/DidierStevens/DidierStevensSuite/blob/master/rtfdump.py)\n\n\n-----\n\n**_Used command: rtfdump.py -f O [file]_**\n\nExample of a dumped and decoded entry, showing a batch script embedded in the document:\n\n**_Used command: rtfdump.py -s 7 -H [file]_**\n\n## Dropped Files\n\nDumping each entry results in the following files, which will be eventually dropped:\n\n**File** **Purpose** **SHA-1**\n\n\n%temp%\\dqfm.cmd Checks for\nprevious\ninfection and\nlaunches\nhondi.cmd\n\n%temp%\\gondi.doc Decoy Word\ndocument\n\n\n86B5058C89231C691655306E12E1E4640D23ED19\n\n33C3F3F4BA62017F5186343C0869B23AB72E081E\n\n\n-----\n\n%temp%\\hondi.cmd Deleting\ntraces by\ndeleting\nthe\nresiliency\nregistry\nentry\nKilling\nWord\nprocess\nDeploying\na decoy\ndocument\nStarting\nmondi.exe\n\n%temp%\\mondi.exe NSISbased\ndropper\nUnpacks\nmalware\npayload\nInjects\npayload to\nother\nrunning\nprocesses\n(predefined\nlist)\nCreates\npersistence\n\nIllustration of the observed infection chain:\n\n\n92F2515828C77056AE04696FD207783DFF8F778D\n\n[FE1B51FE46BDAD6EA051110AB0D1B788A54331E4](https://www.virustotal.com/#/file/634a93d42b6d2d7d302377aa8f1fb4b57ab923544836c83642c059826e9969d2/detection)\n\n\n-----\n\nContents\n\n\nof dqfm.cmd:\n\nContents of hondi.cmd\n\n\n-----\n\n## Exploit Behavioral Execution Tree\n\nThe Cybereason platform caught the exploit’s behavioral chain, as seen in these screenshots:\n\n1. Opening the weaponized RTF documents triggers the Equation Editor exploit (CVE-2017\n11882) and executes dqfm.cmd, which spawns hondi.cmd:\n\n\n-----\n\n1. Hondi.cmd will execute the following commands:\n\n**Delete traces of the original RTF document by enumerating all the Resiliency**\n**registry keys and deleting them:**\n\n_reg delete HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Office\\16.0\\Word\\Resiliency /f_\n\n**Gather information about the Most Recently Used (MRU) Office files for the decoy**\n**document:**\n\n_C:\\Windows\\system32\\cmd.exe /c REG QUERY_\n_\"HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Office\\11.0\\Word\\File MRU\" /v \"Item 1\"_\n\n**Kill Word Process (which executed the RTF document):**\n\n_Taskill.exe TASkKILL /F /IM winword.exe_\n\n**Execute Betabot dropper “mondi.exe”:**\n\n_C:\\Users\\[snip]\\AppData\\Local\\Temp\\mondi.eXe_\n\n**Open the decoy document:**\n\n_\"C:\\Program Files\\Microsoft Office\\Office12\\WINWORD.EXE\" /n /dde_\n\n## Betabot Dropper Analysis\n\n\n-----\n\n[The Mondi.exe binary is actually compressed by NSIS (Nullsoft Scriptable Install System), an](http://nsis.sourceforge.net/Main_Page)\nopen-source software used to create Windows Installers, as indicated by the “Nullsoft PiMP\n_stub” compiler signature:_\n\nThe installer will extract Betabot loader and the encrypted main payload:\n\n1. Performances.dll (Loader: SHA-1:\n\n22C35AEF70D708AA791AFC4FC8097C3C0B6DC0C1)\n2. Midiron.dat (Encrypted Betabot payload SHA-1:\n\nB7599AF48FC3124BE65856012A7C2DCB18BE579A)\n\n## Betabot’s Unpacking and Process Injection\n\nThe loader will unpack the payload and inject it into its own child process.\n\nThe injecting process raised the following behavioral suspicions:\n\nPerformances.dll loaded to mondi.exe:\n\n\n-----\n\nThe loader child process will then enumerate all the running processes in order to find injection\ncandidates. In many of the case Cybereason observed, the Betabot loader injected its code\ninto multiple running processes for persistence and maximized survival purposes. If an injected\nprocess is terminated, another process will kick in and spawn the loader as a child process.\n\nIn most cases, the main payload will first be injected into a second instance of Explorer.exe:\n\n**_Betabot code injected into a second instance of Explorer.exe_**\n\nHowever, in one of the incidents, we observed Betabot injecting itself into a McAfee process\ncalled “shtat.exe”:\n\n\n-----\n\nShtat.exe’s file details indicate that it’s a legitimate McAfee antivirus product :\n\n[(SHA-1:f384bb7564f26f37a48aadf714fccb5cbffe2dc6)](https://www.virustotal.com/#/file/49faa984e897beea63efa9e6c0ae6a2d5d692a4153ae33e454e6c6677c341ff0/details)\n\n## C2 Communication\n\nOnce injected, Betabot will attempt to communicate with its C2 servers. Prior to that, it will\ncheck Internet connectivity by sending requests to the following domains (the\n“check_connectivity” function was renamed by the blog’s author):\n\n\n-----\n\nOnce Internet connectivity is verified, Betabot will send requests to its C2 servers, as shown\nbelow:\n\nThe IP address “185.246.153[.]251” serves other malware, such as LokiBot.\n\n[http://cybercrime-tracker.net/index.php?search=185.22.152.146](http://cybercrime-tracker.net/index.php?search=185.22.152.146)\n\n## Observed Persistence\n\nBetabot utilizes several interesting persistence techniques. However, in the sample we\nanalyzed, it used a classic registry Autorun:\n\n\n-----\n\nIt dropped a renamed copy of the installer in Programdata under the name “Google Updater\n_2.0” and changed the directory’s and file’s permissions and ownership to prevent them from_\nbeing removed or tampered with. Once Betabot is executed, it make extensive usage of API\nhooking to hide the persistence from regedit, Sysinternal’s Autoruns and other monitoring\ntools.\n\nA secondary persistence mechanism that was implemented via Windows Task Scheduler was\nalso observed in some infections:\n\nThe code above will result in the following scheduled task command:\n\n_schtasks.exe' /CREATE /SC ONLOGON /TN 'Windows Update Check - [variable]' /TR_\n_'C:\\ProgramData\\[path_to_file]_\n\n## Betabot is Paranoid\n\nBetabot’s authors designed the malware to operate in paranoid mode. For example, it can\ndetect security products running on a victim’s machine, determine if it’s running in a research\nlab environment and identify and shut down other malware that’s on a machine. These selfdefense mechanisms are well advertised in hacking forums:\n\n\n-----\n\nLet’s explore some of these features:\n\n## Virtualization detection\n\nBetabot will attempt to determine if it is executed in a virtual environment by querying the\nregistry and looking for the names of virtual machine vendors such as VMware, VirtualBox and\nParallels, as well as searching for specific drivers vendor files:\n\nHARDWARE\\\\DESCRIPTION\\\\System\\\\BIOS [SystemManufacturer] - VMWARE\n\nHARDWARE\\\\DESCRIPTION\\\\System [SystemBiosVersion] - Virtual Box\n\n**Drivers list: vboxvideo.sys, vboxguest.sys, vmhgfs.sys, prl_boot.sys.**\n\n\n-----\n\nAnother trick used to determine if the environment is virtual is to obtain a handle to\n\\\\Device\\\\Harddisk0\\\\Partition and \\\\??\\\\PHYSICALDRIVE0. This is usually done to calculate\nthe size of the hard drive:\n\n## Sandbox Detection\n\nBetabot will check for the presence of Wine, which is often an indication of a sandbox\nenvironment:\n\nThen it will proceed to search for product IDs of common sandbox vendors in the\nWindows registry by enumerating “SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion”:\n\n\n-----\n\nProduct IDs of common sandbox vendors (Anubis, CWSandbox, Joe SandBox, GFI,\nKaspersky):\n\n76487-640-1457236-23837, 76487-337-8429955-22614, 76487-644-3177037-23510, 76497640-6308873-23835, 55274-640-2673064-23950, 76487-640-8834005-23195, 76487-6400716662-23535, 76487-644-8648466-23106, 00426-293-8170032-85146, 76487-3415883812-22420, 76487-OEM-0027453-63796\n\nIn addition, Betabot checks to see if the username matches any of the blacklisted common\nsandbox usernames, including “sandbox”, “sand box”, “malware”, “maltest” and “test user”.\n\n\n-----\n\nAdditional Sandbox DLL check will look for known DLLs:\n\nSbieDll.dll (Sandboxie), api_log.dll and dir_watch.dll (iDefense Labs):\n\n\n-----\n\n## Anti-debugging\n\nBetabot uses several techniques to ensure that it’s not being debugged and to prevent\ndebuggers from attaching to its process, such as:\n\n[Calling ZwQueryInformationProcess /](https://docs.microsoft.com/en-us/windows/desktop/procthread/zwqueryinformationprocess) [NtQueryInformationProcess with](https://docs.microsoft.com/en-us/windows/desktop/api/winternl/nf-winternl-ntqueryinformationprocess)\n[ProcessDebugPort flag (0x07):](https://docs.microsoft.com/en-us/windows/desktop/procthread/zwqueryinformationprocess)\n\n[Instead of using the obvious IsDebuggerPresent API, Betabot will use the segment register to](https://msdn.microsoft.com/en-us/library/windows/desktop/ms680345(v=vs.85).aspx)\nquery the PEB structure (Process Environment Block) by calling “fs:[30h]” and then looking for\nthe BeingDebugged flag (0x02).\n\n\n-----\n\nPreventing debuggers to attach to the Betabot process by patching NTDLL.DLL s\n[DbgBreakPoint, by replacing the INT3 interrupt instruction (0x0CC) with NOP (0x90):](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wdm/nf-wdm-dbgbreakpoint)\n\nDetection of antivirus vendors\n\nBetabot will attempt to detect (and in some cases disable or remove) 30 different security\nproducts by looking for process names, specific files, folders, registry keys and services. Those\nproducts and vendors are:\n\nAhnlab v3 Lite, ArcaVir, Avast!, AVG, Avira, BitDefender (on minimal configuration), BKAV,\nBullGuard, Emsisoft Anti-Malware, ESET NOD32 / Smart Security, F-PROT, F-Secure IS,\nGData IS, Ikarus AV, K7 AntiVirus, Kaspersky AV/IS (older versions only), Lavasoft Adaware\nAV, MalwareBytes Anti-Malware, McAfee, Microsoft Security Essentials, Norman AntiVirus,\nNorton AntiVirus (Vista+ only), Outpost Firewall Pro, Panda AV/IS, Panda Cloud AV (free\nversion), PC Tools AntiVirus, Rising AV/IS, Sophos Endpoint AntiVirus, Total Defense, Trend\nMicro, Vipre,Webroot SecureAnywhere AV, Windows Defender, ZoneAlarm IS\n\nExample of one of the functions that checks for the presence of antivirus vendors.\n\n\n-----\n\nExample of Betabot’s detection of Trend Micro artifacts on an infected host:\n\nExample of Betabot’s detection of IBM’s Trusteer artifacts:\n\n### Network antivirus checks (DNS blocking)\n\nBetabot will attempt to block DNS requests to the following security vendors to prevent updates\nand other Web-related features that the products rely on:\n\n\n-----\n\nEliminating competition (BotKiller)\n\nIn addition to it’s AVKiller module, Betabot will attempt to detect other bots and malware on the\ninfected host by looking for common malware persistence patterns and other heuristic features.\nFor example, Betabot will enumerate registry autorun keys in to look for suspicious-looking\npersistence indicators that are common in malware:\n\nEnumerating Autorun keys:\n\nChecking for script-based fileless malware persistence pattern:\n\n## Measures to Prevent Betabot Infections\n\n\n-----\n\nHere are some best practices to minimize the risk of infection:\n\n1. Avoid clicking links and downloading or opening attachments from unknown senders.\n\n2. Look for misspellings, typos and other suspicious content in emails and attachments and\nreport any abnormalities to IT or information security.\n\n3. Keep your software up-to-date and install Microsoft security patches, especially\n\n[https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-11882](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-11882)\n\n4. Consider disabling the Equation Editor feature in Microsoft Office by editing the following\nregistry entries:\n\n[HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Office\\Common\\COM Compatibility\\\n{0002CE02-0000-0000-C000-000000000046}]\n\n\"Compatibility Flags\"=dword:00000400\n\n[HKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\Office\\Common\\COM\nCompatibility\\{0002CE02-0000-0000-C000-000000000046}]\n\n\"Compatibility Flags\"=dword:00000400\n\nWant to prevent these kinds of attacks?\n\n## IOCs\n\n### Hashes\n\nB4EEF8F14871FB3891C864602AEE75FE2513064A\n\nCD46BD187F35EA782309B373866DEA1B6311FAD9\n\nCA7E8C9AA7F63133BC37958A6AA3A59CFD014465\n\nE23BED29C6D64AD80504331A9E87EB8C8ED59B8A\n\nC61C5E61C6B80878245E2837DF949318A5831D85\n\n48F2C9DC9FA41BAD9D1EA6C01DA034110AA9D4A0\n\nFE1B51FE46BDAD6EA051110AB0D1B788A54331E4\n\nF241F55480D54590D37C64916BC7B595DA7571A0\n\n6B19C85B6A28C2EDCC1784CD3465F6AA665107C3\n\n\n-----\n\n4FF2175B663750BA0CE9433A85069BA5FD6B78EC\n\n7DA2408369F566BA9DB80DF857E6BFE818BEF525\n\nF1DD50ED248D6EEA5620D59F15A39FB9E7226F27\n\n8C15081B1615144F69A4B1784B43BBB84A79D13B\n\nA45CF65FC4E4D7BC64CBC7CFB02367316881BE87\n\n081D11E4FDECD0CA70E6EF57156C06454EBA02C2\n\n11D04C2AFCA86718D2C8856301D5D55F73B7A344\n\n22C35AEF70D708AA791AFC4FC8097C3C0B6DC0C1\n\n25499BE38A3430DB8AEBA091D051EAC2A7C08133\n\n566154DADB304019A8B035D883C9E32CA95CD64E\n\n5DB5EB3CB52C5503B98DB4883366D52AC8B2FD13\n\n792ECBC513246315306D81464D2A5714B3CD6E34\n\n8212450A90AF9061B1DDE92ED79290225DF022CE\n\n86B5058C89231C691655306E12E1E4640D23ED19\n\n92F2515828C77056AE04696FD207783DFF8F778D\n\n9A2B31B5B9BC99CBA49D64B3EBDDDC7F027FEADD\n\nB7599AF48FC3124BE65856012A7C2DCB18BE579A\n\nFE1B51FE46BDAD6EA051110AB0D1B788A54331E4\n\n\n-----\n\nAbout the Author\n\n**Cybereason Nocturnus**\n\nThe Cybereason Nocturnus Team has brought the world’s brightest minds from the military,\ngovernment intelligence, and enterprise security to uncover emerging threats across the globe.\nThey specialize in analyzing new attack methodologies, reverse-engineering malware, and\nexposing unknown system vulnerabilities. The Cybereason Nocturnus Team was the first to\nrelease a vaccination for the 2017 NotPetya and Bad Rabbit cyberattacks.\n\n[All Posts by Cybereason Nocturnus](https://www.cybereason.com/blog/authors/cybereason-nocturnus)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-10-03 - New Betabot campaign under the microscope.pdf"
    ],
    "report_names": [
        "2018-10-03 - New Betabot campaign under the microscope.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536231,
    "ts_updated_at": 1743041280,
    "ts_creation_date": 1653692996,
    "ts_modification_date": 1653692996,
    "files": {
        "pdf": "https://archive.orkl.eu/eed08cc1f06af768260610b309d5c9f49afbb998.pdf",
        "text": "https://archive.orkl.eu/eed08cc1f06af768260610b309d5c9f49afbb998.txt",
        "img": "https://archive.orkl.eu/eed08cc1f06af768260610b309d5c9f49afbb998.jpg"
    }
}