{
    "id": "7bff20e1-3191-40ae-9785-a3d7936326c1",
    "created_at": "2023-01-12T14:59:04.777454Z",
    "updated_at": "2025-03-27T02:09:18.463408Z",
    "deleted_at": null,
    "sha1_hash": "5465babffc0dfe0e91808ef7c7a4c184aa8eacb7",
    "title": "2020-11-20 - The Locking Egregor",
    "authors": "",
    "file_creation_date": "2022-05-28T19:38:10Z",
    "file_modification_date": "2022-05-28T19:38:10Z",
    "file_size": 2002057,
    "plain_text": "# The Locking Egregor\n\n**group-ib.com/blog/egregor**\n\n20.11.2020\n\nAnalysis of TTPs employed by Egregor operators\n\nOleg Skulkin\n\nSenior DFIR Analyst at Group-IB\n\n\n-----\n\nRoman Rezvukhin\n\nDeputy head of the DFIR lab at Group-IB\n\nSemyon Rogachev\n\nMalware Analyst at Group-IB\n\nRegardless of a cybersecurity role in your organization, whether you are a SOC analyst,\nthreat hunter, or CISO, the more you know about the threat landscape relevant to your\nbusiness and region the better you can protect your assets. But when it comes to\nransomware, any big organization can be a target, and you should always be on guard.\nEspecially, given that the major cybercrime trend of 2020 is Big Game Hunting.\n\nMore and more players join the game, disrupting more and more businesses all around the\nworld. Ransomware itself, as well as attackers' TTPs become increasingly complex, making\ndetection and analysis really tough. One of such ransomware families, that came into the\ngame quite recently, but already managed to «lock» quite outstanding victims, such as\nCrytek and Barnes & Noble - is Egregor.\n\nRecently Group-IB DFIR team observed Egregor ransomware operators actively using\n**[Qakbot (aka Qbot) to gain initial access, just like it was with Prolock not long ago. The](https://www.group-ib.com/blog/prolock_evolution)**\nclose similarities in TTPs with earlier ProLock campaigns indicate that Qakbot operators\nhave likely abandoned ProLock for Egregor.\n\n\n-----\n\nEgregor has been actively distributed since September 2020. In less than 3 months Egregor\noperators have managed to successfully hit 69 companies around the world with 32 targets\nin the US, 7 victims in France and Italy each, 6 in Germany, and 4 in the UK. Other victims\nhappened to be from the APAC, Middle East, and Latin America. Egregor's favorite sectors\nare Manufacturing (28.9% of victims) and Retail (14.5%).\n\nEgregor victims\n\nGiven the increased activity of Egregor operators and the gang's focus on big firms, we\ndecided to release this \"emergency\" blog post to help cybersecurity teams identify and hunt\nfor this threat actor. This blog will dive you into recent Qakbot campaigns, TTPs employed by\nthe threat actors during their Big Game Hunting operations, and in-depth analysis of Egregor\nransomware.\n\n**Recent Qakbot campaigns**\n\nIn September 2020, Emotet switched back to distributing Trickbot, so Qakbot operators had\nto distribute their trojan without its help. To deliver the trojan, Qakbot operators used\nmalicious Microsoft Excel documents impersonating DocuSign-encrypted spreadsheets, and\nstill prefer to use so-called \"Email Thread Hijacking\" technique.\n\n\n-----\n\nDocuSign decoy\n\n**Post-Exploitation**\n\nDuring our incident response engagements, we saw almost identical techniques to those we\nsaw in attacks involving ProLock ransomware. Once initial access is gained, the threat actors\nused AdFind to collect Active Directory information.\n\nAlso we've seen the same script to enable comfortable lateral movement - \"rdp.bat\". It was\nused by the threat actors to modify registry and firewall rules to enable connections via\nRemote Desktop Protocol.\n\nTo compromise the whole network infrastructure, the threat actor used Cobalt Strike – an\nextremely popular post-exploitation tool we've seen in almost 70% of incidents involving Big\nGame Hunting operations this year.\n\nIn some cases, the threat actors also distributed Qakbot through the network via PsExec,\njust like in cases with Prolock we observed in the past, they use a file named \"md.exe\" – that\nis the Qakbot binary.\n\nIn addition, they used Rclone for data exfiltration – the same masquerading technique was\nused, they renamed its binary to svchost.exe and placed it to C:\\Windows.\n\nParts of exfiltrated data are published on Egregor's Data Leak Site (DLS) to prove they not\nonly locked the victim's network, but also stolen sensitive information:\n\n\n-----\n\n_Egregor's \"Hall of shame\"_\n\nIf the victim refuses to pay, the threat actors publish the whole set of exfiltrated data:\n\n_The whole set of data exfiltrated from Crytek_\n\nRansomware deployment\n\nThe threat actors used multiple techniques for ransomware deployment, in some cases even\nin a single attack, including abusing Background Intelligent Transfer Service (BITS), WMI\ncommand-line (WMIC) utility and PowerShell remote sessions. It's interesting that the\nPowerShell script contains comments in Russian:\n\n\n-----\n\n_A part of PowerShell script used to deploy Egregor ransomware_\n\nRansomware analysis\n\nWe analyzed a sample of Egregor ransomware, which was obtained during one of our\nincident response engagements. Egregor is delivered as a DLL, and should be launched via\nrundll32 executable with the similar command line:\n\nrundll32.exe C:\\Windows\\q.dll,DllRegisterServer -password –-mode\n\nAfter calling the function DllRegisterServer, the next stage will be decoded, decrypted and\nexecuted. This stage is protected using ChaCha8 stream cipher (the key and the nonce are\nstored inside the file) and Base64 encoding:\n\n\n-----\n\nThe next stage is also used as an encryption layer for the final payload, which could be\ndecrypted only if the correct password is provided as an argument. This password is used as\nthe key for\n\nHMAC-SHA256, and the input data for HMAC-SHA256 is hardcoded within the program.\nAfter that, 10000 iterations of HMAC-SHA256 are used along with XOR operation to create a\nkey for Rabbit stream cipher, which will be used to decrypt the final payload:\n\n\n-----\n\nThe final payload is highly obfuscated with junk instructions and a lot of jump and call\nobfuscation is used. We noticed that Egregor obfuscation is very similar to the obfuscation\nused in another ransomware - Sekhmet). The string obfuscation is likewise similar to\nSekhmet and even the keys for decrypting the same strings are the identical.\n\nWe noticed that the sequence of language checks is very similar to Sekhmet and Maze\nransomware.\n\nThe main purpose of the Egregor (unsurprisingly) is to encrypt files. Files are encrypted\nusing ChaCha8 stream cipher among with RSA-2048 asymmetric algorithm – the same\nscheme was used in Sekhmet and Maze ransomware (key and nonce for ChaCha8 are\ngenerated randomly for each encrypted file):\n\nChaCha8 key and nonce generation in Egregor and Sekhmet\n\n\n-----\n\nChaCha8 key and nonce generation in Maze\n\nChaCha8 key and nonce is encrypted and added to the beginning of the encrypted file.\n\nLocal RSA-2048 keypair is generated for each infected computer; the local private key is\nencrypted by the public master key and then added to the \"technical block\" at the end of the\nransom note (this block also contains the number of encrypted files, information about\nworkstation and domain).\n\nTo check if it is able to encrypt file in specific directory, Egregor will try to create a shortcut in\nthis directory (the name of the shortcut is equal to victim ID, which is generated based on\nhardware configuration of the computer). The shortcut is created with the option\nFILE_FLAG_DELETE_ON_CLOSE, which allows to automatically deleting this shortcut after\nthe handle is closed.\n\nAfter all, the ransom note named RECOVER-FILES.txt will be created in each directory with\nencrypted files. Here is a template extracted from an Egregor sample:\n\n\n-----\n\nEgregor ransom note template\n\nThe largest ransom demand we observed was more than 4 000 000 $ in BTC.\n\nConclusion\n\n\n-----\n\nTactics, techniques and procedures observed are very similar to those seen in the past\nQakbot's Big Game Hunting operations. At the same time, we see that these methods are\nstill very effective and allow threat actors to compromise quite big companies successfully.\nIt's important to note, that the fact many Maze partners started to move to Egregor will most\nlikely result in the shift in TTPs, so defenders should focus on known methods associated\nwith Maze affiliates.\n\n**General Recommendations**\n\n1\n\nIf you've detected Qakbot infection in your network, make sure you handle it properly, and\nthere's no evidence of lateral movement.\n\n2\n\nMake sure your security controls are able to detect and block Cobalt Strike usage.\n\n3\n\nFocus on suspicious RDP connections as well as BITS, wmic and PowerShell abuse.\n\n4\n\nDevelop threat hunting capability for your team, so you can reduce attacker's dwell time, and\nprevent successful ransomware deployment.\n\n5\n\n[Make sure your team has updated cyber threat intelligence information to detect and prevent](https://www.group-ib.com/intelligence.html)\nhuman-operated ransomware attacks.\n6\n\nLearn what techniques and methods Threat Hunters use today through Group-IB's Cyber\nEducation courses\n7\n\n[Download the white paper \"Egregor ransomware: The legacy of Maze lives on\" for more](https://www.group-ib.com/whitepapers/egregor-ransomware.html)\nTTPs, detection and threat hunting tips\n\n\n-----\n\nShare\n\nReceive insights on the latest cybercrime trends\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-20 - The Locking Egregor.pdf"
    ],
    "report_names": [
        "2020-11-20 - The Locking Egregor.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535544,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653766690,
    "ts_modification_date": 1653766690,
    "files": {
        "pdf": "https://archive.orkl.eu/5465babffc0dfe0e91808ef7c7a4c184aa8eacb7.pdf",
        "text": "https://archive.orkl.eu/5465babffc0dfe0e91808ef7c7a4c184aa8eacb7.txt",
        "img": "https://archive.orkl.eu/5465babffc0dfe0e91808ef7c7a4c184aa8eacb7.jpg"
    }
}