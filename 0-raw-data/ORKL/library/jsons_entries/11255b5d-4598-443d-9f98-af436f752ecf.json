{
    "id": "11255b5d-4598-443d-9f98-af436f752ecf",
    "created_at": "2023-01-12T15:04:40.905652Z",
    "updated_at": "2025-03-27T02:05:56.268751Z",
    "deleted_at": null,
    "sha1_hash": "244e5cdd368c1bfd4a82cf105d992b2db4fdd84c",
    "title": "2021-11-17 - ProxyNoShell- A Change in Tactics Exploiting ProxyShell Vulnerabilities",
    "authors": "",
    "file_creation_date": "2022-05-28T01:54:36Z",
    "file_modification_date": "2022-05-28T01:54:36Z",
    "file_size": 325687,
    "plain_text": "# ProxyNoShell: A Change in Tactics Exploiting ProxyShell Vulnerabilities\n\n**[mandiant.com/resources/change-tactics-proxyshell-vulnerabilities](https://www.mandiant.com/resources/change-tactics-proxyshell-vulnerabilities)**\n\n## Breadcrumb\n\nBlog\n\nJoshua Goddard\n\nNov 17, 2021\n\n5 mins read\n\nVulnerabilities\n\nThreat Research\n\nTTPs\n\n\n-----\n\n[In September 2021, Mandiant published a blog post from the](https://www.mandiant.com/resources/pst-want-shell-proxyshell-exploiting-microsoft-exchange-servers) [Mandiant Managed Defense team about](https://www.mandiant.com/advantage/managed-defense)\nwidespread exploitation of three vulnerabilities in on-premises Microsoft Exchange Servers which\nwere collectively referred to as ProxyShell. Despite disclosure occurring in April 2021 and patches\nbeing released in April and May 2021, Mandiant’s Incident Response team has continued to respond\nto compromises originating from exploitation of these vulnerabilities as recently as November 2021\nand estimates that up to 30,000 internet-facing vulnerable servers still exist.\n\n[CVE-2021-34473 - Microsoft Exchange Server Remote Code Execution Vulnerability](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34473)\n[CVE-2021-34523 - Microsoft Exchange Server Elevation of Privilege Vulnerability](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34523)\n[CVE-2021-31207 - Microsoft Exchange Server Security Feature Bypass Vulnerability](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-31207)\n\nIn several recent Incident Response engagements, Mandiant has observed threat actors exploiting\nthe vulnerabilities in different ways than previously reported. Most notably, the writing of web shells via\nexport of exchange certificate requests instead of mailbox exports, and exploitation of the first two\nvulnerabilities in the exploit chain only to achieve remote PowerShell and create new mailboxes,\nassign them privileged access to other mailboxes, then access them via Outlook Web Access (OWA).\nMandiant is reporting these changes in tactics since the detection and response guidance previously\nissued focused exclusively on web shells originating from mailbox export.\n\n## Attack Paths with ProxyShell Vulnerabilities\n\nUpon successful exploitation of the second stage of the ProxyShell vulnerability chain, a threat actor\n[can execute any Microsoft Exchange PowerShell cmdlet via remote PowerShell within the context of a](https://docs.microsoft.com/en-us/powershell/module/exchange/?view=exchange-ps)\ntarget user where remote PowerShell is enabled, most notably those with administrative permissions.\n[Remote PowerShell is enabled for users by default in Microsoft Exchange.](https://docs.microsoft.com/en-us/powershell/exchange/control-remote-powershell-access-to-exchange-servers?view=exchange-ps)\n\nAt this second stage of exploitation, Mandiant has observed threat actors taking one of three attack\npaths leading to either a web shell or access to mailboxes, although any of the available Exchange\nPowerShell cmdlet’s may be executed, providing threat actors with full Exchange administrative\ncapabilities. Figure 1 provides an overview of these paths.\n\nFigure 1:\n\nAttack paths\nMandiant has observed multiple actions on objectives originating from these attack paths, including\nthe browsing of email items and deployment of post-exploitation tooling and ransomware.\n\n### New-MailboxExportRequest to Write a Web Shell\n\nThe widely reported attack path to achieve a web shell is the creation of an item in a target mailbox\nvia Exchange Web Servers (EWS), which Mandiant has observed being a draft email item with an\nencoded attachment, and subsequent exporting of that item via the New-MailboxExportRequest\n\n\n-----\n\ncmdlet (after assigning mailbox import/export permissions). The writing of the mailbox item with the\nspecially crafted attachment results in a functional web shell due to the attachment being decoded\n[upon export to the PST file format. This path was demonstrated in the presentation and article by](https://www.zerodayinitiative.com/blog/2021/8/17/from-pwn2own-2021-a-new-attack-surface-on-microsoft-exchange-proxyshell)\nOrange Tsai (@orange_8361) from the DEVCORE Research Team, who discovered and disclosed\nthe exploit chain publicly. Mandiant has observed this path being exploited since August 2021. Refer\nto Mandiant’s [previous blog post for further details on this path.](https://www.mandiant.com/resources/pst-want-shell-proxyshell-exploiting-microsoft-exchange-servers)\n\n### New-ExchangeCertificate to Write a Web Shell\n\nSince September 2021, Mandiant has observed threat actors using the New-ExchangeCertificate\ncmdlet to save web shell code within a certificate request via the system certificate store. The web\nshell code is provided to the ‘SubjectName’ parameter and is saved to disk at a path specified by the\n‘RequestFile’ parameter. Web shells written by this means have been observed on disk with a\ncertificate request extension (.aspx.req). Figure 2 provides an example of the cmdlet executed to\nachieve this.\n\nFigure 2:\n\nNew-ExchangeCertificate cmdlet to write a web shell\nMandiant has identified previous evidence of compromise by searching for web shell code within the\nsystem certificate store in the Windows registry (Figure 3), which had persisted after PowerShell logs\nhad rolled over.\n\nFigure 3:\n\nRegistry key for certificate requests in the certificate store\n\n### Creation of New Mailboxes and Assigning of Permissions to Access Other Mailboxes\n\nSince August 2021, Mandiant has observed threat actors creating new mailboxes via the NewMailbox cmdlet then assigning privileged roles via the Add-RoleGroupMember cmdlet, or explicitly\nassigning full access permissions to other mailboxes with the Add-MailboxPermission cmdlet. In some\ncases, Mandiant has also observed threat actors hiding these newly created mailboxes from\nExchange address lists via execution of the Set-Mailbox cmdlet, with the parameter\n‘HiddenFromAddressListsEnabled’ set to True.\n\nMandiant has observed actor-controlled mailboxes being used to access other mailboxes via Outlook\nWeb Access (OWA). With the mailbox credentials to new mailboxes being set by the actor, they can\nalso access via other means configured within the environment too, such as through an email client,\nhowever Mandiant has not directly observed access by this means.\n\nIn configurations where Exchange split permissions (Active Directory split permissions model) are not\nconfigured, Mandiant has observed the New-Mailbox cmdlet creating user objects within Active\nDirectory. Where this occurs, threat actors may be able to authenticate with the wider domain or\nservices which use domain authentication, for example corporate VPN’s, file sharing platforms,\nsoftware development platforms, or knowledge management applications. Mandiant has not directly\nobserved access by this means.\n\n\n-----\n\n## Monitoring and Investigating\n\nMandiant recommends monitoring or investigating for compromise on presently or previously\nvulnerable Exchange servers.\n\nThe monitoring and investigation points in Mandiant’s [previous blog post still apply, including](https://www.mandiant.com/resources/pst-want-shell-proxyshell-exploiting-microsoft-exchange-servers)\ninvestigating remote creation of items in mailboxes for exploit by New-MailboxExportRequest, and\nremote unauthenticated PowerShell for all other attack paths.\n\nUpdates to monitoring and investigation based on the observations in this post are as follows:\n\nNew-ExchangeCertificate to write a web shell\n\nExecution of the New-ExchangeCertificate PowerShell cmdlet where ‘RequestFile’\ncontains a web file extension (.ASPX), or ‘SubjectName’ contains web shell code,\nindicating an attempt to drop a web shell via a new certificate request\nIdentification of files with the extension ‘.ASPX.REQ’, indicating a certificate request file\nsaved as an ASPX\nIdentification of web shell code within the decoded system certificate store Blob values on\nExchange servers\n(HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\SystemCertificates\\REQUEST\\Certificates\\\n<Certificate Thumbprint/ID>\\Blob)\nCreation of new mailboxes and assigning of permissions to access other mailboxes\n\nExecution of the New-Mailbox PowerShell cmdlet not linked to legitimate administrative\nactivity, or originating from remote unauthenticated PowerShell\nIdentification of unauthorized accounts assigned ‘Organization Management’ or\n‘Application Impersonation’ roles, or assigned ‘Full Access’ to other mailboxes\nIdentification of unauthorized accounts hidden from the Exchange address lists\nIdentification of unauthorized access via OWA or other means of email access\n\n## Prevention and Remediation\n\nThe prevention and remediation guidance from Mandiant’s previous blog post still applies, including\nmost crucially applying patches for the vulnerabilities.\n\nWhere unauthorized accounts or web shells are identified, Mandiant recommends a full investigation\nto identify threat actor access in the environment both on the Exchange infrastructure and within the\nwider domains.\n\n## Acknowledgements\n\nAdrian Sanchez Hernandez, Ashely Zaya, Govand Sinjari, Mathew Potaczek, Nick Richard, Yash\nGupta\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-17 - ProxyNoShell- A Change in Tactics Exploiting ProxyShell Vulnerabilities.pdf"
    ],
    "report_names": [
        "2021-11-17 - ProxyNoShell- A Change in Tactics Exploiting ProxyShell Vulnerabilities.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535880,
    "ts_updated_at": 1743041156,
    "ts_creation_date": 1653702876,
    "ts_modification_date": 1653702876,
    "files": {
        "pdf": "https://archive.orkl.eu/244e5cdd368c1bfd4a82cf105d992b2db4fdd84c.pdf",
        "text": "https://archive.orkl.eu/244e5cdd368c1bfd4a82cf105d992b2db4fdd84c.txt",
        "img": "https://archive.orkl.eu/244e5cdd368c1bfd4a82cf105d992b2db4fdd84c.jpg"
    }
}