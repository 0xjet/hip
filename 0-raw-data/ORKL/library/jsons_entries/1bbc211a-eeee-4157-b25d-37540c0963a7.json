{
    "id": "1bbc211a-eeee-4157-b25d-37540c0963a7",
    "created_at": "2023-01-12T15:05:48.151144Z",
    "updated_at": "2025-03-27T02:05:18.624089Z",
    "deleted_at": null,
    "sha1_hash": "df243cfbd6dd3a36fec84799b555f55206b437ce",
    "title": "2021-11-16 - Excel 4 macro code obfuscation",
    "authors": "",
    "file_creation_date": "2022-05-28T05:13:08Z",
    "file_modification_date": "2022-05-28T05:13:08Z",
    "file_size": 5599235,
    "plain_text": "# Excel 4 macro code obfuscation\n\n**[pcsxcetrasupport3.wordpress.com/2021/11/16/excel-4-macro-code-obfuscation/](https://pcsxcetrasupport3.wordpress.com/2021/11/16/excel-4-macro-code-obfuscation/)**\n\nView all posts by pcsxcetrasupport3 → November 16, 2021\n\n[This sample comes from a Twitter thread located Here by Frost @fr0s7_ and appears to be](https://twitter.com/fr0s7_/status/1458481326294769674)\n“BazarLoader”\n\nSince this is a Xlsb file I usually just open it up in my Office 2010 Pro sandbox and then\nconvert to Xlsm and unzip it so I can just view as xml.\n\nThe first thing I always do is take a quick look with a hex editor looking for anything of\ninterest.\n\n\n-----\n\nAs we can see from the first 2 bytes we have a PK or zip file format.\n\nOnce we “UnZip” the file and navigate to the xl folder we can verify this is a binary file and it\nalso contains a Excel 4 macro folder named “macrosheets”.\n\n\n-----\n\nIf we look at the SharedStrings.bin file we can see that strings are in a Unicode format and\nnot that easy to see where they split up at.\n\n\n-----\n\nLooking at sheet1.bin in the macrosheets folder we can see it is not human readable.\n\nThis is the point where I usually convert the file.\n\n\n-----\n\nHere we can see we still have a “PK” file but you can clearly see the data is presented a little\ndifferently.\n\n\n-----\n\nOnce we unzip and navigate to the xl folder here it now looks a little different.\n\nAnd now if we look at the SharedStrings.xml file it is a little different.\n\nBy the counts there are 34 indexed shared strings. Each appears to be randomly generated\nstrings.\n\n\n-----\n\nI wrote a tool to aid in extracting and indexing the shared string from the xml file.\n\nWhen I first parsed the shared strings I ended up with 0-37 index values instead of 0-33.\n\nTurns out the tool stumbled on a rare random Char value I was using to split on.\n\nHere we see the xml version of the macro code. Like the shared strings it is hard to see thru\nall of the xml tags what is there so I wrote a parser for those too.\n\n\n-----\n\nThis tool is designed to extract values to aid in better viewing what is happening without all of\nthe xml tags. In this case some are left.\n\nHere we see what the values are.\n\n\n-----\n\nIf we look at the highlighted values in green we see that it is looking for the string in cell\n‘E11’ then we are taking the char at the index and taking so many chars. “MID(E11,12,1)” . In\nvbs the index start at 1 but in this the index starts at 0.\n\nSo now we know the first char code was converted to “S” and now we see the first extracted\nletter is “h” and the next to letter is “e” and then the next 2 are at the same index and is “l”.\n\nNow we have the word “Shell” extracted.\n\nThis would be a pain to do by hand, but now that we understand how it works what else is\navailable to extract this data.\n\n[The Answer is “XLMMacroDeobfuscator” located here .](https://github.com/DissectMalware/XLMMacroDeobfuscator)\n\n\n-----\n\nAs we can see here this tool does a great job of presenting us with the deobfuscated strings.\n\nThe version I’m using here is from October 3rd 2021 before it was updated several more\ntimes. The version number stayed the same so you need to verify by the install/ file date.\n\nUsing the latest version as of November 12th 2021 it only returned the eval result. Also\nnotice in the screen shot that showed the data it is a “Partial Evaluation” where in the\nupdated version it is a “Full Evaluation”.\n\nI have not looked at the byte format for the Macro sheet data but I have looked at the shared\nstrings in the binary format.\n\nDo to the lack of information that I can find on the file format let’s take a quick look at the\ndata in this file as shown below. Notice the patterns.\n\n\n-----\n\nIn the original sample I wrote an extraction tool for we can see how it is laid out slightly\ndifferent.\n\n\n-----\n\nAlthough the file in my original sample was labeled qut.xml it was not an xml file at all. So\nyou can not count on a file name or extension for searches.\n\n\n-----\n\nAnd here is what it looks like in the Hex editor.\n\n\n-----\n\nLets take a look at format for this sample then we will go back and look at the one from the\nbeginning.\n\n\n-----\n\nWe can see the first 3 bytes of the data appear to be a fixed Header value.\n\nThe next 4 bytes are the “Count”. If I understand correctly, it is the total times the string/chars\nare referenced.\n\nThe next 4 bytes are the “Unique Count”. These should be the total number of strings shown\nin the cells.\n\nNext it gets interesting.\n\nThe first byte is always 0x13 Next we have 1 or 2 bytes (Unknown). Perhaps it is a data type\n? It appears that it could be 1 or 2 bytes then a null byte depending on the string.\n\nNext we have the length of the string as displayed in the cell. It uses at least 2 bytes.\nSo the first is only 1 char then value is 0x0100 or in reverse order 0x0001.\n\nAfter that we have 2 null bytes. Then finally the Unicode bytes for the string.\n\nNow lets go back to our first file that we extracted from this sample.\n\n\n-----\n\nNotice how everything is aligned but the area in the red box.\n\n\n-----\n\nIf we look at the string under index 16 we see it is 531 characters long.\n\n531 = 0x0213 and our value in the data is 0x1302.\n\n\n-----\n\nNow everything lines up.\n\nHere we see the first byte 0X13 then 2 unknown bytes then a null byte then 2 bytes for the\nlength and then a double null and finally the start of out Unicode string values.\n\nSo in this sample we have extra 0x13 in a place that will break the tool.\n\nAt this point the tool will work on a few but will need a total rewrite based on this new\ninformation.\n\nThere have been plenty of samples that I have looked at where you did not even need to\nlook at the VBA or macro code. All you needed to do was extract the shared strings to get\nthe urls or paths used.\n\nThat is it for this one I hope you learned from this as much as I did.\n\nLinks:\n\n[Link to Twitter thread](https://twitter.com/fr0s7_/status/1458481326294769674)\n[Link to Sample on InQuest Labs](https://labs.inquest.net/dfi/sha256/5cd1c8b7425fcfd1d23acb3056262203b86174d87d6b8feb2087790694ea48b5)\n[Link to Sample on Iris-H](https://iris-h.services/pages/report/580fa6d458157bf2c0ad5c6d5165a1a9d83fe70c#metadata)\n\n[Link to XLMMacroDeobfuscator](https://github.com/DissectMalware/XLMMacroDeobfuscator)\n\n[Link to my tools on GitHub](https://github.com/PCsXcetra/ToolsForParsingExcelData)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-16 - Excel 4 macro code obfuscation.pdf"
    ],
    "report_names": [
        "2021-11-16 - Excel 4 macro code obfuscation.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535948,
    "ts_updated_at": 1743041118,
    "ts_creation_date": 1653714788,
    "ts_modification_date": 1653714788,
    "files": {
        "pdf": "https://archive.orkl.eu/df243cfbd6dd3a36fec84799b555f55206b437ce.pdf",
        "text": "https://archive.orkl.eu/df243cfbd6dd3a36fec84799b555f55206b437ce.txt",
        "img": "https://archive.orkl.eu/df243cfbd6dd3a36fec84799b555f55206b437ce.jpg"
    }
}