{
    "id": "a51dcf7f-83c5-456e-b642-6b32b12f5663",
    "created_at": "2023-06-05T02:07:48.465468Z",
    "updated_at": "2025-03-27T02:09:29.860427Z",
    "deleted_at": null,
    "sha1_hash": "ab5a7537e48f4ff9de4dfd040447836ccce9a909",
    "title": "2023-05-22 - BlackCat Ransomware Deploys New Signed Kernel Driver",
    "authors": "",
    "file_creation_date": "2023-06-04T12:55:01Z",
    "file_modification_date": "2023-06-04T12:55:01Z",
    "file_size": 1165266,
    "plain_text": "# BlackCat Ransomware Deploys New Signed Kernel Driver\n\n**[trendmicro.com/en_us/research/23/e/blackcat-ransomware-deploys-new-signed-kernel-driver.html](https://www.trendmicro.com/en_us/research/23/e/blackcat-ransomware-deploys-new-signed-kernel-driver.html)**\n\nFigure 1. Distribution of kernel-level threats\n\n## Executive Summary\n\n\nMay 22, 2023\n\n\n[In late December 2022, Mandiant,](https://www.mandiant.com/resources/blog/hunting-attestation-signed-malware) [Sophos and](https://news.sophos.com/en-us/2022/12/13/signed-driver-malware-moves-up-the-software-trust-chain/) [Sentinel One, via a coordinated disclosure,](https://www.sentinelone.com/labs/driving-through-defenses-targeted-attacks-leverage-signed-malicious-microsoft-drivers/)\nreported malicious kernel drivers being signed through several Microsoft hardware developer\naccounts (certified by Microsoft’s Windows Hardware Developer Program). These profiles\n[had been used in a number of cyberattacks that included ransomware-based incidents.](https://www.trendmicro.com/vinfo/ph/security/definition/Ransomware)\n[Microsoft subsequently revoked several Microsoft hardware developer accounts that were](https://msrc.microsoft.com/update-guide/vulnerability/ADV220005)\nabused in these attacks.\n\n[In this blog post, we will provide details on a BlackCat ransomware incident that occurred in](https://www.trendmicro.com/vinfo/us/security/news/ransomware-spotlight/ransomware-spotlight-blackcat/)\nFebruary 2023, where we observed a new capability, mainly used for the defense evasion\nphase, that overlaps with the earlier malicious drivers disclosed by the three vendors.\n[BlackCat affiliates have been known to use multiple techniques during the defense evasion](https://www.trendmicro.com/vinfo/us/security/news/ransomware-spotlight/ransomware-spotlight-blackcat)\nphase, impairing defenses by disabling and modifying tools or using techniques as safe\nmode boot.\n\n\n-----\n\nOur analysis sheds light on this new capability, which involves the use of a signed kernel\ndriver for evasion. We believe that this new kernel driver is an updated version that inherited\nthe main functionality from the samples disclosed in previous research. The driver was used\nwith a separate user client executable in an attempt to control, pause, and kill various\nprocesses on the target endpoints related to the security agents deployed on the protected\nmachines.\n\nMalicious actors use different approaches to sign their malicious kernel drivers: Typically by\nabusing Microsoft signing portals, using leaked and stolen certificates, or using underground\nservices. In our case, the attackers tried to deploy the old driver disclosed by Mandiant,\nwhich is signed through Microsoft (SHA256: b2f955b3e6107f831ebe67997f8586d4fe9f3e98).\nSince this driver has already been previously known and detected, the malicious actors\ndeployed another kernel driver signed by a stolen or leaked cross-signing certificate. Trend\nMicro continues to monitor the abuse of any signed drivers and the related tools, tactics, and\nprocedures (TTPs) associated with this attack surface.\n\n## The malicious signed kernel drivers\n\nThe February 2023 ransomware incident we observed proves that ransomware operators\nand their affiliates have a high level of interest in gaining privileged-level access for the\nransomware payloads they use in their attacks. They normally use ransomware families that\nincorporate low-level components to avoid detection from security products once the final\npayloads are dropped. By mapping the kill chains of these kernel-level threats, we found that\n[most kernel-related payloads are usually found during the defense evasion phase, as shown](https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/the-evolution-of-windows-kernel-threats)\nin Figure 1.\n\n\n-----\n\nFigure 2. Most kernel-related payloads are found during the defense evasion phase\nSome ransomware attacks try to comply with Microsoft code-signing requirements. This\ngives malicious actors the flexibility to compile kernel modules designed for very specific\ntasks (usually involving defense impairing and evasion) before dropping the actual payload.\nRansomware operators can do one of the following approaches:\n\n1. Use a code-signing certificate that was either leaked, stolen from a compromised\nenvironment, or purchased from an underground market.\n\n2. Obtain a new valid code-signing certificate by impersonating a legitimate entity and\nfollowing Microsoft’s process for getting the cross-signing certificate (back when Microsoft\nstill allowed cross signing for kernel-mode code), abusing Microsoft’s portal for issuing\nsigned kernel modules, and purchasing valid code-signing certificates and/or Extended\nValidation (EV) certificates that are tied to real identities from underground markets.\n\n\n-----\n\nFigure 3. Diagram showing how a threat actor complies with Microsoft code-signing\nrequirements\n\n## Analysis of a signed driver\n\nIn this section, we will examine a signed driver (ktgn.sys) used in the February BlackCat\nattacks. Figure 4 shows other examples of these new signed drivers and how they are being\nused as part of the BlackCat affiliate’s defense evasion routine.\n\n\n-----\n\nFigure 4. The dropped files by a BlackCat affiliate in the defense evasion phase\nThe User Agent tjr.exe, which is protected via a virtual machine, drops the kernel driver to\nthe user temporary directory C:\\%User%\\AppData\\Local\\Temp\\Ktgn.sys. It then installs the\ndropped driver with the name ktgn and the start value = System (to start when the system\nrestarts). From our analysis of what occurs when a user interfaces with this driver, we\nobserved that it only uses one of the exposed Device Input and Output Control (IOCTL) code\n— Kill Process, which is used to kill security agent processes installed on the system.\n\n\n-----\n\nMeanwhile the driver ktgn.sys, which is signed using a currently revoked valid digital\nsignature from “BopSoft” (which had also been previously used by other threat actors for\ncode signing) can successfully be loaded on a 64-bit Windows installation where signing\n[policies are enforced. The driver is obfuscated using Safengine Protector v2.4.0.0 tool, which](http://www.safengine.com/en-us/products/protector)\nrenders static analysis techniques unreliable. By loading the obfuscated driver and trying to\nbuild a user mode client to observe the exposed IOCTL interface, we can determine the\nfunction of each IOCTL code. Finally, we observed the same kernel driver being signed by\ndifferent code-signing certificates.\n\n\n**Valid**\n**usage**\n\n\n**Current**\n**status** **Issuer**\n\n\n**Driver variants (SHA256)**\n\n\n**Signer**\n**name**\n\n\n994e3f5dd082f5d82f9cc84108a60d359910ba79 BopSoft Code\nsigning\n\n\nThawte\n\nVeriSign\n\n\nf6793243ad20359d8be40d3accac168a15a327fb YI\nZENG\n\nTable 1. The driver variants with different signers\n\n\nCode\nsigning\n\n\nExplicitly\nrevoked\nby its\nissuer\n\nExplicitly\nrevoked\nby its\nissuer\n\n\nFigure 5. The packer used to obfuscate the binary\nSince it does not register an unload callback function, the driver can only be unloaded if the\nservice registry key is deleted or modified followed by a system restart.\n\n\n-----\n\nFigure 6. The service cannot be stopped by the service control manager\n\nFigure 7. The driver lacking an unload function\nA symbolic link with the name \\\\.\\keHeperDriverLink is created that allows the user mode\nclient to connect and communicate with it. Note that this link only allows for one connection\n— if more than one client tries to connect to it simultaneously, the system will crash.\n\n\n-----\n\nFigure 8. Checking if another user mode process is trying to connect to the driver\n\n## The exposed IOCTL Interface\n\nThis client supports ten different commands, with each command implementing a specific\nfunction that is executed from the kernel driver with the appropriate IOCTL interface\nexposed. Communication between the driver and the user mode client occurs using the\nIRP_MJ_DEVICIDE_CONROL handler via the following codes:\n\n**IOCTL Code** **Description**\n\n222088h Activate Driver\n\n22208Ch Deactivate Driver\n\n222094h Kill Process\n\n222184h Delete File\n\n222188h Force Delete File\n\n22218Ch Copy File\n\n222190h Force Copy File\n\n2221C8h Register Process/Thread Object notification\n\n2221C4h Unregister Process/Thread Object notification\n\n222264h Reboot the system\n\n\n-----\n\nTable 2. Each IOCTL code and their function\n\nBased on our analysis of the kernel driver, it seems to still be under development and testing\nsince it is not structured well and some of its functions currently cannot be used. The\nfollowing subsections provide details on the various IOCTL Interfaces.\n\n### IOCTL 222088h\n\nIOCTL 222088h must be called first to activate the driver before any other operation can be\nperformed. If this code is not called, the driver will not accept any operation and will return\nthe message STATUS_ACCESS_DENIED. The user mode client sends this activation byte\narray to the driver.\n\nThe activation is a simple byte comparison against a hard coded byte array with the size\n0x42 located in the driver. If the comparison passes, it will set a BOOLEAN flag, which will be\nchecked before any operation.\n\nFigure 9. Activation bytes from the running memory\n\nFigure 10. Replicating the activation bytes to test driver operations\n\n### IOCTL 22208Ch\n\nIOCTL 22208Ch is called after the user mode client finishes its operation to unset the flag\nthat was previously set in IOCTL Code 222088h. This will deactivate the driver and stop it\nfrom processing any new operation.\n\nThe client will need to pass the same byte array passed in IOCTL code 222088h for the\noperation to be successfully completed.\n\n### IOCTL 222094h\n\nIOCTL 222094h is used to kill any user mode process (even protected ones). Tt receives the\nProcess ID from the user agent then creates a kernel thread in the target process context.\nThe created kernel thread calls the ZwTerminateProcess API to terminate the target\nprocess.\n\n\n-----\n\nFigure 11. Checking if the driver is activated\n\nFigure 12. The IOCTL 222094h kill process.\n\n### IOCTL 222184h\n\nIOCTL 222184h is used to delete specific file paths (as shown in Figure 11).\n\nFigure 13. IOCTL 222184h deleting a file path\nIOCTL 222188h\n\nIOCTL 222188h is used to force delete files. To do this, the kernel driver does the following:\n\n1. It tries to open all processes on the system using brute-force methods (starting from\n\nPID=0x4 to PID= 0x27FFD)\n2. When it successfully opens a process, it tries to reference all handles inside the\n\nprocess, again using a brute-force method (starting from HANDLE=0x4 to HANDLE =\n0x27FFD)\n3. When it successfully references a handle, it uses the ObQueryNameString API to\n\nmap the handle to a name. When a match is found, the kernel driver closes the handle.\n\nThis operation will ensure that all references to the file will be closed and the operation can\nbe successfully completed without any errors stating that the file is being used by other\napplications.\n\nFigure 14. Brute force PID\n\n\n-----\n\nFigure 15. Brute force handles\n\n### IOCTL 22218Ch\n\nIOCTL 22218Ch is used to copy files.\n\nFigure 16. IOCTL 22218Ch being used to copy a file\n\n### IOCTL 222190h\n\nIOCTL 222190h is used to force copy files. The driver uses the same operation as the one\nused for force deletion (IOCTL Code: 222188h). It closes all references to the files from all\nprocesses using brute-force methods, then copies the file.\n\n### IOCTL 2221C4h and IOCTL 2221C8h\n\nBoth IOCTL 2221C4h and 2221C8h are used to register and unregister Process/Thread\nNotification callbacks. However, both paths are unreachable at the time of writing, which\nindicates that they are still under development or testing.\n\nFigure 17. Pseudocode for Register Object Notification\n\n\n-----\n\nFigure 18. Pseudocode for Unregister Object Notification\n\nFigure 19. Pseudocode for Object Notification Function\n\n### IOCTL 222264h\n\nIOCTL 222264h Is used to reboot the system by calling the HalReturnToFirmware API.\n\n## Conclusion\n\nMalicious actors that are actively seeking high-privilege access to the Windows operating\nsystem use techniques that attempt to combat the increased protection on users and\nprocesses via endpoint protection platform (EPP) and endpoint detection and response\n(EDR) technologies. Because of these added layers of protection, attackers tend to opt for\nthe path of least resistance to get their malicious code running via the kernel layer (or even\nlower levels). This is why we believe that such threats will not disappear from threat actors’\ntoolkits anytime soon.\n\nMalicious actors will continue to use rootkits to hide malicious code from security tools,\nimpair defenses, and fly under the radar for long periods. These rootkits will see heavy use\nfrom sophisticated groups that have both the skills to reverse engineer low-level system\ncomponents and the required resources to develop such tools. These malicious actors also\ntend to possess enough financial resources to either purchase rootkits from underground\nsources or to buy code-signing certificates to build a rootkit. This means that the main\ndanger involving these kinds of rootkits lie in their ability to hide complex targeted attacks\nthat will be used early in the kill chain, allowing an attacker to impair defenses before the\nactual payloads are launched in victim environments.\n\n## Recommendations and solutions\n\n\n-----\n\nCode signing certificates can often be abused by threat actors since they provide an\nadditional layer of obfuscation in their attacks. For organizations, compromised keys present\nnot only a security risk, but can also lead to a loss of reputation and trust in the original\nsigned software. Businesses should aim to protect their certificates by implementing best\npractices such as reducing access to private keys, which reduces the risk of unauthorized\naccess to the certificate. Employing strong passwords and other authentication methods for\nprivate keys can also help protect them from being stolen or compromised by malicious\nactors. Furthermore, using separate test signing certificates (for prerelease code used in test\nenvironments) minimizes the chances that the actual release signing certificates are abused\nin an attack.\n\nFor general ransomware attack protection, organizations can implement a systematic\nsecurity framework that allocates resources towards establishing a robust defense strategy.\nHere are some recommended guidelines:\n\nTake inventory of assets and data\nIdentify authorized and unauthorized devices and software\nAudit event and incident logs\nManage hardware and software configurations\nGrant admin privileges and access only when necessary\nMonitor network ports, protocols, and services\nEstablish a software allowlist for legitimate applications\nImplement data protection, backup, and recovery measures\nEnable multifactor authentication (MFA)\nDeploy the latest versions of security solutions across all layers of the system\nWatch for early signs of an attack\n\nBy adopting a multifaceted approach to securing potential entry points, such as endpoints,\nemails, webs, and networks, organizations can detect and protect against malicious\nelements and suspicious activities, thereby safeguarding themselves from ransomware\nattacks.\n\nA multilayered approach can help organizations guard possible entry points into their system\n(endpoint, email, web, and network). Security solutions can detect malicious components\nand suspicious behavior, which can help protect enterprises.\n\n## Indicators of Compromise\n\n[The indicators of compromise for this entry can be found here.](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/23/e/blackcat-ransomware-deploys-new-signed-kernel-driver/indicators-blackcat-ransomware-deploys-new-signed-kernel-driver.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-05-22 - BlackCat Ransomware Deploys New Signed Kernel Driver.pdf"
    ],
    "report_names": [
        "2023-05-22 - BlackCat Ransomware Deploys New Signed Kernel Driver.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1685930868,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1685883301,
    "ts_modification_date": 1685883301,
    "files": {
        "pdf": "https://archive.orkl.eu/ab5a7537e48f4ff9de4dfd040447836ccce9a909.pdf",
        "text": "https://archive.orkl.eu/ab5a7537e48f4ff9de4dfd040447836ccce9a909.txt",
        "img": "https://archive.orkl.eu/ab5a7537e48f4ff9de4dfd040447836ccce9a909.jpg"
    }
}