{
    "id": "094fc409-0570-4613-b050-f1a4a74d3cbe",
    "created_at": "2023-01-12T15:10:25.53926Z",
    "updated_at": "2025-03-27T02:06:02.1644Z",
    "deleted_at": null,
    "sha1_hash": "92952099d30f671f16a1caeed5a65c51d8d4e030",
    "title": "2022-01-14 - Multidex trick to unpack Android-BianLian",
    "authors": "",
    "file_creation_date": "2022-05-27T19:11:11Z",
    "file_modification_date": "2022-05-27T19:11:11Z",
    "file_size": 318708,
    "plain_text": "# Multidex trick to unpack Android/BianLian\n\n**[cryptax.medium.com/multidex-trick-to-unpack-android-bianlian-ed52eb791e56](https://cryptax.medium.com/multidex-trick-to-unpack-android-bianlian-ed52eb791e56)**\n\n@cryptax May 5, 2022\n\n[@cryptax](https://cryptax.medium.com/?source=post_page-----ed52eb791e56--------------------------------)\n\nJan 14\n\n\n5 min read\n\nThis article explains how to unpack sample sha256\n```\n5b9049c392eaf83b12b98419f14ece1b00042592b003a17e4e6f0fb466281368 which was\n\n```\nserved from http://videofullizlesite9356[.]site/ApiServices-Files92752/Down at the beginning\n[of January 2022 (see this tweet). The malware poses as a Video player and appears to be a](https://twitter.com/ReBensk/status/1478699273558528002?s=20)\n[member of the Bian Lian malware family (see former analysis 1 and](https://www.threatfabric.com/blogs/bianlian_from_rags_to_riches_the_malware_dropper_that_had_a_dream.html) [2). Although the](https://www.fortinet.com/blog/threat-research/new-wave-bianlian-malware)\nmalware has similarities with BankBot, I believe this precise sample is not a banker malware\n(it does not attempt to steal your banking credentials or steal from your bank account) but the\n**Bian Lian bot (bulk send of SMS, USSD calls etc).**\n\n_Update Jan 17, 2022. Let’s try and clarify. Bian Lian is a “generic” bot. It may be used to steal_\n_passwords of banking apps. Some current samples seem to be particularly interested in_\n_stealing credentials from turkish banks._\n\n_Kudos to @U039b with whom I began this reverse engineering, and @ReBensk, ._\n\n**Summary (spoiler?) for those who don’t want to read it all :)**\n\nThe malware does not use `DexClassLoader to unpack the payload DEX. Instead it`\nloads the payload as a secondary DEX through multidex support. The packer reimplements multidex support and mainly changes names & adds asset decryption.\n\nYou can use [my Java program to decrypt the asset and access the payload.](https://github.com/cryptax/misc-code/blob/master/UnpackJwi.java)\n\n## What makes this sample difficult to unpack\n\nThe most common packing mechanism consists in loading a hidden DEX with\n```\nDexClassLoader . The sample does not use DexClassLoader (nor PathClassLoader\n\n```\nor `InMemoryDexClassLoader ). Therefore, we cannot unpack by creating a hook on`\n```\nDexClassLoader that dumps its first file argument.\n\n```\n\n-----\n\nMany dynamic tools fail (let me know if you find one that works): [RMS times out while](https://github.com/m0bilesecurity/RMS-Runtime-Mobile-Security)\n[trying to launch the app, House fails, and](https://github.com/nccgroup/house) [Dexcalibur fails to load the malware’s project due](https://github.com/FrenchYeti/dexcalibur/issues/69)\nto a bug.\n\n**This malware uses another mechanism to side load its payload. I’ll discuss at the end**\n**of the article (section “So, how is the DEX loaded if not with DexClassLoader?”). But first,**\nlet’s unpack, because actually if your goal is to analyze the payload, you don’t really need to\nunderstand how it is loaded.\n\n## Detecting it is packed\n\nThe main activity is `com.pmmynubv.nommztx.MainActivity, which is not present in the`\nwrapping APK but in the contained payload.\n\nDroidLysis detects the sample is packed\n\n## Unpacking\n\nUnderstanding the packing mechanism takes a little bit of time, because all strings are\nobfuscated (fortunately JEB decrypts nearly all of them) and `DexClassLoader — typically`\nto load a DEX — is not used.\n\nThe flow is the following. The manifest references `com.brazzers.naughty.g as the`\napplication. Indeed, `g extends` `Application and can be seen as the main entry point of`\nthe app. One of the first methods to be called is the protected method\n```\nattachBaseContext .\n\n```\n\n-----\n\nThis is where the unpacking actually begins! For clarity, I renamed the method\n“install_multidex”. Its original name was of course obfuscated to “a”. It is a bit difficult to spot\nso much happens through this simple call…\nFrom `attachBaseContext, the malware calls a cascade of functions which (1) locate an`\nasset named `G9ugwFtlG1.jwi, (2) deflates it and (3) finally decrypts it using a home-made`\nalgorithm with hard coded key `GIUh9JHGUIGIUHGokfewrofij58YV6UhYUF7gjhgv .`\n\nThe strings `G9ugwFtlG1, .jwi, GIUh9JHGUIGIUHGokfewrofij58YV6UhYUF7gjhgv are`\nfound in a malware’s configuration class com.brazzers.naughty.h, but note they are all\nobfuscated.\n\nObfuscated bot configuration strings. De-obfuscation occurs through i.a()\nThe obfuscation is not complex: a XOR with a fixed character, nevertheless I was happy JEB\ndid the work automatically for me!\n\n\n-----\n\nIsn’t that nice? JEB automatically decrypts strings when a simple algorithm is used. JEB\ndoesn’t do all the work though, you still have to reverse engineer to understand the meaning:\nI manually renamed obfuscated name h.a to h.PAYLOAD_EXTENSION etc.\nIf you want to follow the calls:\n\n1. com.brazzers.naughty.g.attachBaseContext(Context)\n2. com.brazzers.naughty.a.a(Context)\n3. com.brazzers.naughty.a.a(Context, File, File…)\n4. com.brazzers.naughty.b.a(Context, String…)\n5. com.brazzers.naughty.b.c()\n6. com.brazzers.naughty.b.a(ZipFile, ZipEntry…)\n7. com.brazzers.naughty.k.a(String, InputStream, OutputStream)\n\nWe’ll see later the malware is actually following the normal flow for loading secondary\nDEXes, except the names are obfuscated.\n\n## Automating the unpacking\n\nI basically copied the malware’s unpacking code in `com.brazzers.naughty.k.a, did a`\nlittle adaptation, and finally worked out a Java program that automatically unpacks the\n[malware (get the code here). Run the program in the directory where](https://github.com/cryptax/misc-code/blob/master/UnpackJwi.java) `G9ugwFtIG1.jwi is`\navailable ( ./assets/7G8Uwty ), and it will unpack and create a `unpacked.zip which`\ncontains the payload DEX.\n\n\n-----\n\nStatic program to unpack the asset — java UnpackJwi\n```\n$ unzip -l unpacked.zip Archive: unpacked.zip Length   Date  Time  Name-------- ---------- -----  ----  906456 2022-01-14 11:05  classes.dex---------   \n-------  906456           1 file\n\n## So, how is the DEX loaded if not with DexClassLoader?\n\n```\nThe malware uses the multidex scheme to load the payload as secondary DEX. This\n[method has existed for a couple of years (e.g. Android/Rootnik using it in 2017), but I hadn’t](https://www.fortinet.com/blog/threat-research/deep-analysis-of-android-rootnik-malware-using-advanced-anti-debug-and-anti-hook-part-i-debugging-in-the-scope-of-native-layer)\nseen it for a while. In 2022, it seems we have a new packer in the wild which uses this\n[technique as the same packer is used here in a sample of Flubot.](https://www.f5.com/labs/articles/threat-intelligence/flubots-authors-employ-creative-and-sophisticated-techniques-to-achieve-their-goals-in-version-50-and-beyond)\n\nThe technique consists in re-writing the way applications load multiple DEX. The Android\n[code can be found here. The classes](https://android.googlesource.com/platform/frameworks/multidex/+/refs/heads/master/library/src/androidx/multidex) `MultiDex and` `MultiDexApplication are the core`\n[of the functionality. They implement support of APKs with multiple DEX. Everything begins in](https://developer.android.com/studio/build/multidex)\nindeed in `attachBaseContext of` `MultiDexApplication. The malware re-implements`\n```\nMultiDexApplication, MultiDex and MultiDexExtractor with little changes part\n\n```\ncode re-organization and obfuscated names:\n```\n   MultiDexApplication is found in com.brazzers.naughty.g\n   MultiDex is within in com.brazzers.naughty.a\n\n```\nand `MultiDexExtractor is` `com.brazzers.naughty.b`\n\nThe two main functional changes are :\n\n1. . The extracted DEX will be located in a directory named `hf8U6UUIwiqaGgo instead`\n\nof the standard `secondary-dexes name, the extracted suffix will be` `.weg instead of`\n```\n   .zip, and some other minor details like the lock file name is changed to\n   T9etIiaI.uw87 instead of MultiDex.lock . The goal is obviously to complicate\n\n```\nreverse engineering, but also to make the files less noticeable should they be spotted\nduring extraction on the device.\n2. . Compare the original code with the malware’s version below.\n\n\n-----\n\nOriginal code from (not malicious!)\n\nMalware’s version. The input is deflated and decrypted.\nThe next article will deal with the reverse engineering of the payload DEX.\n\n## More recent samples of January 14 (today)\n\nSome newer samples of that malicious video application have been released today: see\n[Twitter. I haven’t looked in all samples yet, but at least the first one,](https://twitter.com/malwrhunterteam/status/1481947346619584514?s=20w)\n01658_Video_Oynatıcı.apk (sha256:\n```\nd105764cd5383acacd463517691a0a7578847a8174664fc2c1da5efd8a30719d ) does not\n\n```\nuse the same packer. It uses the common `DexClassLoader method, actually the same`\n[packing mechanism as this sample. Watch for the unpacked payload in a file named](https://cryptax.medium.com/unpacking-an-android-malware-with-dexcalibur-and-jeb-59bdd905d4a7)\n```\nmaXclr.json .\ngeneric_x86_64:/data/data/com.friend.bronze/app_DynamicOptDex # lsmaXclr.json    \nmaXclr.json.prof\n\n```\nThe payload DEX ( maXclr.json ) is a Bian Lian sample.\n\n\n-----\n\n— the Crypto Girl\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-14 - Multidex trick to unpack Android-BianLian.pdf"
    ],
    "report_names": [
        "2022-01-14 - Multidex trick to unpack Android-BianLian.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536225,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1653678671,
    "ts_modification_date": 1653678671,
    "files": {
        "pdf": "https://archive.orkl.eu/92952099d30f671f16a1caeed5a65c51d8d4e030.pdf",
        "text": "https://archive.orkl.eu/92952099d30f671f16a1caeed5a65c51d8d4e030.txt",
        "img": "https://archive.orkl.eu/92952099d30f671f16a1caeed5a65c51d8d4e030.jpg"
    }
}