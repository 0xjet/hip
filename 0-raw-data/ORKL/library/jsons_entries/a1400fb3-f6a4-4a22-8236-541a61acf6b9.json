{
    "id": "a1400fb3-f6a4-4a22-8236-541a61acf6b9",
    "created_at": "2023-01-12T15:07:03.657291Z",
    "updated_at": "2025-03-27T02:05:54.706556Z",
    "deleted_at": null,
    "sha1_hash": "8e9f31e955d401983c550f374d38658fce0d4cc4",
    "title": "2019-09-12 - Ostap Deobfuscation script",
    "authors": "",
    "file_creation_date": "2022-05-28T02:44:02Z",
    "file_modification_date": "2022-05-28T02:44:02Z",
    "file_size": 148877,
    "plain_text": "# Malware-Analysis-Scripts/deobfuscate_ostap.py at master · cryptogramfan/Malware-Analysis-Scripts · GitHub\n\n**[github.com/cryptogramfan/Malware-Analysis-Scripts/blob/master/deobfuscate_ostap.py](https://github.com/cryptogramfan/Malware-Analysis-Scripts/blob/master/deobfuscate_ostap.py)**\n\ncryptogramfan\n\n#!/usr/bin/env python\n\n#\n\n# A script that deobfuscates Ostap JSE (JScript Encoded) downloaders. The script is\nbased\n\n# on Ostap samples analysed in August 2019, such as those delivering TrickBot. It will\ntry\n\n# to identify the indexes containing Unicode character codes and then deobfuscate the\nsample\n\n# using subtraction and addition.\n\n#\n\n# To use the script, supply a file as an argument or pipe it to stdin:\n\n#\n\n# $ python deobfuscate_ostap.py ostap.jse\n\n\n-----\n\n# $ cat ostap.jse | deobfuscate_ostap.py\n\n#\n\n# Author.....: Alex Holland (@cryptogramfan)\n\n# Date.......: 2019-08-29\n\n# Version....: 0.0.5\n\n# License....: CC BY 4.0\n\n# Reference_1: https://www.bromium.com/deobfuscating-ostap-trickbots-javascriptdownloader/\n\nimport os\n\nimport sys\n\nimport re\n\nindex_0 = \"\"\n\nindex_1 = \"\"\n\nindexes_raw = []\n\nindexes = []\n\nvalues_0 = []\n\nvalues_1 = []\n\n# Subtract index 0 values from index 1\n\ndef subtract_values_1():\n\ncharacters_sub = []\n\nservers = []\n\nurls = []\n\ntry:\n\nprint(\"[+] Trying deobfuscation by subtracting index %s elements from index %s\nelements...\" % (indexes[0], indexes[1]))\n\n\n-----\n\ncharcodes_sub = [i - j for i, j in zip(values_0, values_1)]\n\nexcept:\n\nprint(\"[!] Error subtracting index %s elements from index %s elements.\" % (indexes[0],\nindexes[1]))\n\nsubtract_values_2() # Try another subtraction instead\n\ntry:\n\nfor charcode_sub in charcodes_sub:\n\ncharacter_sub = chr(charcode_sub)\n\ncharacters_sub.append(character_sub)\n\ncharacters_sub = ''.join(characters_sub)\n\nexcept:\n\nprint(\"[!] Error converting character codes to characters.\")\n\nsubtract_values_2()\n\nmatch = re.search(\"Script\", characters_sub, re.IGNORECASE)\n\nif match:\n\nprint(\"[+] Deobfuscation using subtraction 1 was successful:\\n\")\n\nprint(characters_sub)\n\nmatch_url = re.search(\"http(s):\\/\\/.+(Drives|POST)\", characters_sub, re.IGNORECASE)\n\nif match_url:\n\nservers.append(match_url.group())\n\nfor server in servers:\n\nserver = re.sub(\"Drives.*$\", \"\", server, re.IGNORECASE)\n\nserver = re.sub(\"POST$\", \"\", server, re.IGNORECASE)\n\n\n-----\n\nurls.append(server)\n\nif urls:\n\nprint(\"\\n[+] Found URL(s):\\n\")\n\nprint(\", \".join(urls))\n\nexit(0)\n\nelse:\n\nprint(\"[!] Deobfuscation using subtraction 1 was unsuccessful.\")\n\nsubtract_values_2()\n\nreturn;\n\n# Subtract index 1 values from index 0 values\n\ndef subtract_values_2():\n\ncharacters_sub = []\n\nservers = []\n\nurls = []\n\ntry:\n\nprint(\"[+] Trying deobfuscation by subtracting index %s elements from index %s\nelements...\" % (indexes[1], indexes[0]))\n\ncharcodes_sub = [i - j for i, j in zip(values_1, values_0)]\n\nexcept:\n\nprint(\"[!] Error subtracting index %s elements from index %s elements.\" % (indexes[1],\nindexes[0]))\n\nadd_values() # Try addition instead\n\ntry:\n\nfor charcode_sub in charcodes_sub:\n\n\n-----\n\ncharacter_sub = chr(charcode_sub)\n\ncharacters_sub.append(character_sub)\n\ncharacters_sub = ''.join(characters_sub)\n\nexcept:\n\nprint(\"[!] Error converting character codes to characters.\")\n\nadd_values()\n\nmatch = re.search(\"Script\", characters_sub, re.IGNORECASE)\n\nif match:\n\nprint(\"[+] Deobfuscation using subtraction 2 was successful:\\n\")\n\nprint(characters_sub)\n\nmatch_url = re.search(\"http(s):\\/\\/.+(Drives|POST)\", characters_sub, re.IGNORECASE)\n\nif match_url:\n\nservers.append(match_url.group())\n\nfor server in servers:\n\nserver = re.sub(\"Drives.*$\", \"\", server, re.IGNORECASE)\n\nserver = re.sub(\"POST$\", \"\", server, re.IGNORECASE)\n\nurls.append(server)\n\nif urls:\n\nprint(\"\\n[+] Found URL(s):\\n\")\n\nprint(\", \".join(urls))\n\nexit(0)\n\nelse:\n\n\n-----\n\nprint(\"[!] Deobfuscation using subtraction 2 was unsuccessful.\")\n\nadd_values()\n\nreturn;\n\n# Add index 0 values to index 1 values\n\ndef add_values():\n\ncharacters_add = []\n\nservers = []\n\nurls = []\n\ntry:\n\nprint(\"[+] Trying deobfuscation by adding index %s elements to index %s elements...\" %\n(indexes[1], indexes[0]))\n\ncharcodes_add = [i + j for i, j in zip(values_1, values_0)]\n\nexcept:\n\nprint(\"[!] Error adding index %s elements to index %s elements. Exiting.\" % (indexes[1],\nindexes[0]))\n\nexit(0)\n\ntry:\n\nfor charcode_add in charcodes_add:\n\ncharacter_add = chr(charcode_add)\n\ncharacters_add.append(character_add)\n\ncharacters_add = ''.join(characters_add)\n\nexcept:\n\nprint(\"[!] Error converting character codes to characters. Exiting.\")\n\nexit(0)\n\n\n-----\n\nmatch = re.search(\"Script\", characters_add, re.IGNORECASE)\n\nif match:\n\nprint(\"[+] Deobfuscation using addition was successful:\\n\")\n\nprint(characters_add)\n\nmatch_url = re.search(\"http(s):\\/\\/.+(Drives|POST)\", characters_add, re.IGNORECASE)\n\nif match_url:\n\nservers.append(match_url.group())\n\nfor server in servers:\n\nserver = re.sub(\"Drives.*$\", \"\", server, re.IGNORECASE)\n\nserver = re.sub(\"POST$\", \"\", server, re.IGNORECASE)\n\nurls.append(server)\n\nif urls:\n\nprint(\"\\n[+] Found URL(s):\\n\")\n\nprint(\", \".join(urls))\n\nexit(0)\n\nelse:\n\nprint(\"[!] Deobfuscation using addition was unsuccessful. Exiting.\")\n\nexit(0)\n\nreturn;\n\nif len(sys.argv) > 1:\n\nfile = open(sys.argv[1], 'r')\n\nelse:\n\n\n-----\n\nfile = sys.stdin\n\nwhile 1:\n\ninput = file.read()\n\n# Find array indexes\n\ntry:\n\nprint(\"\\n[+] Analysing %s\" % os.path.basename(file.name))\n\ninput = input.decode('utf-8')\n\nexcept UnicodeError:\n\nprint(\"[!] File not UTF-8. Treating as UTF-16.\")\n\ninput = input.decode('utf-16')\n\ntry:\n\nindexes_raw = re.findall(\"\\[\\d+\\]=\\d+;\", input)\n\nexcept:\n\nprint(\"[!] Error finding array indexes. Exiting.\")\n\nexit(0)\n\nif not indexes_raw:\n\nprint(\"[!] Array indexes not found. Exiting.\")\n\nexit(0)\n\n# Put the index string into a list\n\ntry:\n\nfor index in indexes_raw:\n\nindex = re.sub(\"\\[\", \"\", index)\n\nindex = re.sub(\"\\]=\\d+;\", \"\", index)\n\n\n-----\n\nindexes.append(index)\n\n# Remove duplicates\n\nindexes = list(set(indexes))\n\nprint(\"[+] Found array indexes %s and %s.\" % (indexes[0], indexes[1]))\n\nexcept:\n\nprint(\"[!] Error processing array indexes. Exiting.\")\n\nexit(0)\n\ntry:\n\nelement_regex_0 = r\"\\[\" + indexes[0] + r\"\\]=\\d+;\"\n\nelement_regex_1 = r\"\\[\" + indexes[1] + r\"\\]=\\d+;\"\n\nexcept:\n\nprint(\"[!] Error creating regular expressions. Exiting.\")\n\nexit(0)\n\n# Find the values of index 0 elements\n\ntry:\n\nprint(\"[+] Searching for index %s elements...\" % indexes[0])\n\narray_0 = re.findall(element_regex_0, input)\n\nfor element in array_0:\n\nelement = re.sub(\"\\[\\d+\\]=\", \"\", element)\n\nelement = re.sub(\";\", \"\", element)\n\nvalues_0.append(element)\n\nexcept:\n\nprint(\"[!] Error finding index %s elements. Exiting.\" % indexes[0])\n\n\n-----\n\nexit(0)\n\nif not values_0:\n\nprint(\"[!] No index %s elements found. Exiting.\" % indexes[0])\n\nexit(0)\n\n# Convert index 0 elements to integer values\n\ntry:\n\nvalues_0 = map(int, values_0)\n\nexcept:\n\nprint(\"[!] Error converting index %s elements to integers. Exiting.\" % indexes[0])\n\nexit(0)\n\n# Find the values of index 1 elements\n\ntry:\n\nprint(\"[+] Searching for index %s elements...\" % indexes[1])\n\narray_1 = re.findall(element_regex_1, input)\n\nfor element in array_1:\n\nelement = re.sub(\"\\[\\d+\\]=\", \"\", element)\n\nelement = re.sub(\";\", \"\", element)\n\nvalues_1.append(element)\n\nexcept:\n\nprint(\"[!] Error finding index %s elements. Exiting.\" % indexes[1])\n\nexit(0)\n\nif not values_1:\n\nprint(\"[!] No index %s elements found. Exiting.\" % indexes[1])\n\n\n-----\n\nexit(0)\n\n# Convert index 1 elements to integer values\n\ntry:\n\nvalues_1 = map(int, values_1)\n\nexcept:\n\nprint(\"[!] Error converting index %s elements to integers. Exiting.\" % indexes[1])\n\nexit(0)\n\nsubtract_values_1()\n\nsubtract_values_2()\n\nadd_values()\n\nexit(0)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-09-12 - Ostap Deobfuscation script.pdf"
    ],
    "report_names": [
        "2019-09-12 - Ostap Deobfuscation script.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536023,
    "ts_updated_at": 1743041154,
    "ts_creation_date": 1653705842,
    "ts_modification_date": 1653705842,
    "files": {
        "pdf": "https://archive.orkl.eu/8e9f31e955d401983c550f374d38658fce0d4cc4.pdf",
        "text": "https://archive.orkl.eu/8e9f31e955d401983c550f374d38658fce0d4cc4.txt",
        "img": "https://archive.orkl.eu/8e9f31e955d401983c550f374d38658fce0d4cc4.jpg"
    }
}