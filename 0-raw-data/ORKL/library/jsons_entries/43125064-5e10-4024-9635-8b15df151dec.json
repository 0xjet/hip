{
    "id": "43125064-5e10-4024-9635-8b15df151dec",
    "created_at": "2023-01-12T15:01:58.299582Z",
    "updated_at": "2025-03-27T02:05:23.317892Z",
    "deleted_at": null,
    "sha1_hash": "726a96125e76e76a3b0f1a7aac59ab580be099d6",
    "title": "2019-05-10 - MegaCortex, deconstructed- mysteries mount as analysis continues",
    "authors": "",
    "file_creation_date": "2022-05-27T21:51:09Z",
    "file_modification_date": "2022-05-27T21:51:09Z",
    "file_size": 2576053,
    "plain_text": "# MegaCortex, deconstructed: mysteries mount as analysis continues\n\n**[news.sophos.com/en-us/2019/05/10/megacortex-deconstructed-mysteries-mount-as-analysis-continues/](https://news.sophos.com/en-us/2019/05/10/megacortex-deconstructed-mysteries-mount-as-analysis-continues/)**\n\nAndrew Brandt May 10, 2019\n\nIt’s been a week since we published our initial research on the ransomware calling itself\nMegaCortex. Our initial post was written over about a day and a half, as we started to\nobserve an early outbreak on May 1. We have a lot of new information to share today.\n\nWe know our last bulletin came out on a Friday afternoon (Pacific time in the US), which was\nlate in other parts of the world starting the weekend, but we felt that alerting everyone to this\ngrowing threat was important. Sorry, but we’re doing it again today, too.\n\nSince then, we’ve become aware of more attacks that have taken place and spoken to\npeople from more organizations that were targets for attack, and wanted to update you on\nwhat we’ve learned about the threat actor’s tools, techniques, and some of the quite\nperplexing small details whose sole purpose seems to be misdirection.\n\n## What’s in an IoC?\n\nWhen we published the initial report last week, at the 11th hour (closer to the 27th) we found\nout that one of the research team performed a hunt through our malware repository, and\nturned up some additional samples dating back a few months. Thinking we had discovered\nan early set of builds, and without checking into each file, we published the entire list of\nhashes to the story, intending to go back and make corrections if necessary.\n\nWe discovered quickly that we’d stumbled upon something weird.\n\n\n-----\n\nOur search was quite simple, in retrospect, though it usually yields interesting results: The\nquery looked for matches of a distinctive Common Name (CN) on the cryptographic\ncertificate that was used to sign one of the MegaCortex malware executables.\n\nWe found a handful of malware from a different family entirely: Rietspoof. But there was no\nother apparent connection between the Rietspoof and MegaCortex samples.\n\nFor one thing, the certificates for each of those families were issued by different certificate\nauthorities. For another, there was virtually no apparent code similarity between the two\nfamilies. So we later removed those IoCs from the post in favor of hashes we were confident\nwere accurate.\n\nIt looked like MegaCortex was paying homage.\n\nA\n\ncomparison of the MegaCortex cert and two of Rietspoof’s certs with the same Common\nName (CN). Note the different issuer CAs.\nIn both the cases of Rietspoof and MegaCortex, their signed binaries used one of several\ncertificates, and in both cases, one of the certificates had been revoked but the others had\nnot.\n\nWe’ve reached out to Thawte, and we’re happy to report that they have issued a revocation\nagainst the signing certificate used in the initial MegaCortex attacks.\n\n\n-----\n\nEither those are really tiny businesses or this building is using an Undetectable Extension\nCharm\nBut digging into the certificates has revealed another unanswered question. The address\nused by the certificate, a real street address in the London suburb of Romford, is linked to\nmore than 74,000 registered businesses in the UK. We’ve also seen evidence of that\naddress being used in signing certificates used to sign completely unrelated malware\nbinaries. From looking at Street View, it appears to be a residential apartment block. Just\nwhat the heck is going on in that building?\n\n\n-----\n\nAdditional MegaCortex samples from attack targets, and from malware sharing and analysis\nplatforms, continue to come in. We’ll continue to update our IoC list on the SophosLabs\nGithub.\n\n## Batch file attack orchestration\n\nOne target for attack who shared samples with us discovered that the attackers leveraged\nmultiple domain controllers in their environment to conduct the attack. That person found six\nbatch files, with filenames of just the numbers 1 through 6, on one of these compromised\nDCs. These batch files appear to have been used to orchestrate the attack phase that\ndelivered the malware executable (winnit.exe) and its “launcher” batch file (stop.bat) to the\nmachines under the relevant DC’s jurisdiction.\n\nThe batch files redundantly, using two different methods, attempt to (1) copy the ransomware\nexecutable and its launcher batch file to machines over the target’s LAN, and (2) execute the\nlauncher batch file using two different methods, WMI and PsExec. Each batch file is a long\nlist of the same command, targeting each machine one after another.\n\nThe batch files appear to run through the internal IP addresses of each targeted machine in\ndescending order but don’t include all possible IP addresses in the internal range. We still\ndon’t know how the attackers come up with a list of target IP addresses they build into the\nbatch scripts. (The rstwg file referenced in the sixth batch file is a copy of the legitimate\nWindows PxExec.exe binary, renamed and copied into the %temp% directory.)\n```\n1.bat: start copy stop.bat \\\\<target IP address>\\c$\\windows\\temp\\\n2.bat: start copy winnit.exe \\\\<target IP address>\\c$\\windows\\temp\\\n3.bat: start wmic /node:\"<target IP address>\" /user:\"<DOMAIN\\DC user account>\"\n/password:\"<DC admin password>\" process call create \"cmd.exe /c copy \\\\<a different\nDC's IP address>\\c$\\windows\\temp\\stop.bat c:\\windows\\temp\\\"\n4.bat: start wmic /node:\"<target IP address>\" /user:\"<DOMAIN\\DC user account>\"\n/password:\"<DC admin password>\" process call create \"cmd.exe /c copy \\\\<a different\nDC's IP address>\\c$\\windows\\temp\\winnit.exe c:\\windows\\temp\\\"\n5.bat: start wmic /node:\"<target IP address>\" /user:\"<DOMAIN\\DC user account>\"\n/password:\"<DC admin password>\" process call create \"cmd.exe /c\nc:\\windows\\temp\\stop.bat\"\n6.bat: start psexec.exe \\\\<target IP address> -u <DOMAIN\\DC user account> -p \"<DC\nadmin password>\" -d -h -r rstwg -s -accepteula -nobanner c:\\windows\\temp\\stop.bat\n\n## MegaCortex time-dependent execution\n\n```\nWe briefly struggled to execute our initial MegaCortex sample after getting it, and several of\nits supporting files, as well as logs from one of the targeted institutions. In each infection,\nMegaCortex binaries have been distributed from a Domain Controller machine on the\ninternal network. The threat actor(s) used stolen admin credentials to log in and then used\nWMI to push out and PsExec the payload to the entire (visible and online) network at once.\n\n\n-----\n\nThe malware is a package of at least two files, the stop.bat batch file, used to launch\nMegaCortex, and winnit.exe, the malware executable itself (so far, called winnit.exe), which\ndoes the encrypting. The batch file, when run, kills a lot of processes and services, many of\nwhich might prevent some or all file encryption from proceeding.\n\nThe last line of that batch file is a command line that executes the malware. The command\nuses a string of base64 as a sort of password to launch the file. Without using this string, the\nbinary quits.\n\n(Side note: We haven’t shared certain details that the attacker could use to identify which\ntarget(s) shared information with us.)\n\nBut there’s another problem running the malware: Each binary is time-dependent as well.\nThe malware will only run if both of these conditions are met: You have to (a) use the correct\npassword and (b) the clock on the target system must be within a 3-hour timeframe\nhardcoded into the malware binary itself.\n\n## Odd connection to a different malware family\n\nMany people inside SophosLabs, and from the security community at large, have\ncommented that the list of processes and services in the batch file is very close to, if not\nidentical to, a batch file used for the same purpose by the ransomware LockerGoga. It’s an\nintriguing connection to yet another malware family.\n\nIt’s not the only one. At least one of the C2 addresses that MegaCortex contacts has also\nbeen used as a C2 for LockerGoga, as well as several other malware.\n\nIn addition, our early analysis of the MegaCortex malware binaries reveals several\ndistinctive, uncommon internal characteristics or behavior quirks that were also exhibited by\nLockerGoga. For example:\n\nMost other ransomware will rename the encrypted version of a given file only after encrypting\nit, but both MegaCortex and LockerGoga rename the files first, before encrypting them. We\nsuspect this is a way to prevent the redundant executions of the malware from, redundantly,\nencrypting the same files twice.\n\nThe winnit.exe MegaCortex binary decrypts and drops an embedded DLL, which it uses to\nperform the encryption steps. Similar to the LockerGoga ransomware, winnit.exe acts as a\n‘parent’ process, and spawns a rundll32.exe process to load the dropped DLL as a ‘child’.\nThe child process performs the actual encryption of files, instructed by the winnit.exe parent,\nvia shared memory.\n\nThe binary and DLL share some of the same memory.\n\n\n-----\n\nAnalysis also shows evidence of another code library called boost in MegaCortex, used\nprimarily for interprocess communications; The same functions from the boost library are\nalso used in LockerGoga.\n\nAnd, for what it’s worth, the compiler used to build MegaCortex is version 14.x, the same as\nLockerGoga.\n\nNone of these alone is enough to draw a line between the two, especially since it seems\nthere isn’t a lot of subroutine parity between the two families. But it does muddy the water a\nbit and make one wonder. There are a lot of really odd, circumstantial coincidences here.\n\n## The bizarrely noisy infection process\n\nMegaCortex is not camera shy and does not attempt to conceal its presence. In fact, on a\nmachine that is being actively encrypted by the ransomware DLL component, someone who\nknows how to use a task manager will see hundreds of an instance of rundll32.exe running\nover and over again. (Corrected 15 May 2019: There’s only one rundll32.exe process. It exits\n_after encrypting ten files and spawns a new rundll32.exe to encrypt the next ten files. -ed.)_\n\nEach instance of rundll32.exe appears to be responsible for encrypting 10 of the target’s files\nThat’s because the malware seems to run a new instance of rundll32.exe for about every ten\nfiles it encrypts. It writes key blobs to a file with an eight-pseudorandom-letter filename and a\n.tsv suffix that the malware creates in the root of the C: drive.\n\n\n-----\n\nMegaCortex runs cipher.exe to wipe the hard drive’s free space after it has finished\nencrypting the files. This makes it harder to recover the deleted files using forensic tools.\nLike several other ransomware, MegaCortex invokes cipher.exe, another tipoff that\nsomething very wrong might be going on.\n\nHere’s a work-in-progress comparison of some of the filesystem changes different\nransomware families make.\n\nA comparison of ransomware behavioral characteristics, focused on filesystem. This graphic\nwas updated on 10 May 2019.\nConsidering how fastidiously targeted the malware seems to be, the threat actor launching it\ndoesn’t mind the shotgun approach once inside the network.\n\nThe result is an unintentional blast of warnings on the DC’s event logs about the failed WMI\nattempts when the threat actor redundantly launches the attack.\n\n\n-----\n\nA summary of the behavior of MegaCortex as observed in the sample highlighted above.\n(This graphic was updated on 10 May 2019)\n\n## What does an attack look like when it’s happening?\n\n[We produced a short video to illustrate what happens when the malware runs both with and](https://vimeo.com/335421332)\nwithout Sophos protection. Check it out!\n\n## IoCs\n\n[We will publish and update any IoCs on our Github page.](https://github.com/sophoslabs/IoCs/blob/master/Ransomware-MegaCortex)\n\n\n-----\n\n_Research for this report was contributed by SophosLabs and Sophos Support team_\n_members Doug Aamoth, Anand Ajjan, Sergio Bestulic, Faizul Fahim, Sean Kowalenko, Savio_\n_Lau, Mark Loman, Andrew Ludgate, Peter Mackenzie, Luca Nagy, Gabor Szappanos, Chee_\n_Hui. Tan, and Michael Wood. Thanks also to our colleagues at the Cyber Threat Alliance._\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-05-10 - MegaCortex, deconstructed- mysteries mount as analysis continues.pdf"
    ],
    "report_names": [
        "2019-05-10 - MegaCortex, deconstructed- mysteries mount as analysis continues.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535718,
    "ts_updated_at": 1743041123,
    "ts_creation_date": 1653688269,
    "ts_modification_date": 1653688269,
    "files": {
        "pdf": "https://archive.orkl.eu/726a96125e76e76a3b0f1a7aac59ab580be099d6.pdf",
        "text": "https://archive.orkl.eu/726a96125e76e76a3b0f1a7aac59ab580be099d6.txt",
        "img": "https://archive.orkl.eu/726a96125e76e76a3b0f1a7aac59ab580be099d6.jpg"
    }
}