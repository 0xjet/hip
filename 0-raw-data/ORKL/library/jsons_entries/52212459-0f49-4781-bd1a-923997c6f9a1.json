{
    "id": "52212459-0f49-4781-bd1a-923997c6f9a1",
    "created_at": "2023-01-12T15:09:55.190775Z",
    "updated_at": "2025-03-27T02:08:40.569135Z",
    "deleted_at": null,
    "sha1_hash": "1f25826dba9b97a53fd74fc7a1d6a7285bfb2b0b",
    "title": "2021-02-28 - Deobfuscating Emotet Macro Document and Powershell Command",
    "authors": "",
    "file_creation_date": "2022-05-28T16:54:14Z",
    "file_modification_date": "2022-05-28T16:54:14Z",
    "file_size": 1344730,
    "plain_text": "# Deobfuscating Emotet Macro Document and Powershell command\n\n**[notes.netbytesec.com/2021/02/deobfuscating-emotet-macro-and.html](https://notes.netbytesec.com/2021/02/deobfuscating-emotet-macro-and.html)**\n\nFareed\n\nNetbyteSEC malware analysis team has come across a Microsoft Word malicious document\ncontaining macro code. The suspicious email was received by our client before the news\nof global law enforcement took down the Emotet cyber criminals team.\n\n## 1.0 Malicious Document Technical Analysis\n\n**MD5 Hash** 809928addbff4e5f9b7d9f55e0ac88e9\n\n**Filename** file-20210122-QRN6275.doc\n\n**File type** Microsoft Word 97 - 2003 Document (.doc)\n\nUpon opening the malicious document file, a common phishing method uses to bait victims\nto click the “Enable Content” ribbon button display in Microsoft Word as shown in Figure 1.\nNormally, a document like this indicates there is macro content in the document. The\npurpose of lure to enable the content is to allow the execution of malicious macro code inside\nthe word document.\n\n\n-----\n\nFigure 1: Content of the lure document\nEnabling the content will execute the macro embedded in the lure document which will lead\nto malicious execution activities in the victim’s machine.\n\nA quick analysis using oledump script on the file disclose three macro content in the\ndocument sample reside in stream 7, 8, and 9 as follows.\n\nFigure 2: oledump result\n\nAnalyzing the content of stream 8 reveals the entry point of the macro which is\nthe document_open procedure was used to execute the macro code whenever the victim\nopens the malicious document and enables the content\n\nFigure 3: Content of steam 7 and 8 of Oledump\nIn the stream 8, once the document_open procedure being triggered, a function with a\nrandom character name “Iemid5ewh9fn44ue4d” will be called which then will execute its\ncode that resides in the stream 9. The VBA file for stream 9 containing 448 lines of macro\ncode uses for the malicious actions explained on the next section.\n\n## 1.1 Deobfuscating malicious macro\n\nThe VBA script containing 448 lines of obfuscated macro code. The macro code was being\nobfuscated to produce an anti-analysis to make analyst difficult to read and understand the\ncode. This technique is commonly used among cyber threat groups to make obfuscated their\n\n\n-----\n\ncode. In this section, the NetbyteSEC malware analysis team will explain the method for\ndeobfuscating the macro.\n\nFigure 4: Snippet of the VBA code\n\nAs a solution, debugging the macro code can help to trace each of the content of the variable\nand dive into the detail of the macro code.\n\nFirst, the code builds long obfuscated strings and append the strings to the variable name\n**_V6x19m6t_qhh. The encoded strings as follow:_**\n\nwx [ sh binx [ sh bmx [ sh bgmx [ sh btx [ sh bx [ sh bx [ sh bx [ sh bsx [ sh bx [ sh bx [ sh\nb:wx [ sh bx [ sh binx [ sh b3x [ sh b2x [ sh b_x [ sh bx [ sh bpx [ sh bx [ sh brox [ sh bx [ sh\nbcex [ sh bsx [ sh bsx [ sh bx [ sh b\n\nThe encoded strings then will be decoded and saved the clear text of the encoded strings in\nvariable G1i061417oxvyh_k as shown in Figure 5.\n\nFigure 5: G1i061417oxvyh_k value\n\nAt this point, the macro builds an encoded string and decodes the string to become\n**winmgmts:win32_process indicating the VBA script will be using something related to WMI**\nclasses for the next instruction.\n\n\n-----\n\nNext, the VBA script creating an object which is the winmgmts:win32_process, and sets it\nto variable F_yz9ots5y0q916g as shown in Figure 6 below.\n\nFigure 6: F_yz9ots5y0q916g value\nInspecting the local variable F_yz9ots5y0q916g will show that the variable has become the\n**SWbemObjectEx object which normally can be abused to execute a command line.**\n\nFigure 7: F_yz9ots5y0q916g became SWbemObjectEx\n\nThe macro code then builds another encoded string and append the strings to the variable\nname V6x19m6t_qhh again. The encoded string is a bit different from the previously\nencoded string. The encoded string built as follows:\n\nx [ sh bx [ sh bcx [ sh bmx [ sh bdx [ sh b x [ sh bcx [ sh bmx [ sh bdx [ sh b x [ sh b/x [ sh bcx\n\n[ sh b x [ sh bmx [ sh b^x [ sh bsx [ sh b^x [ sh bgx [ sh b x [ sh b%x [ sh bux [ sh bsx [ sh bex\n\n[ sh brx [ sh bnx [ sh bax [ sh bmx [ sh bex [ sh b%x [\n\nFigure 8: Decoding encoded strings\n\nNext, the encoded string will be decoded and save into variable G1i061417oxvyh_k shown in\nthe above Figure 8.\n\nInspecting the variable, the decoded strings are actually a cmd command line of msg and\nbase64 PowerShell line. To view the malicious command line, adding a MsgBox line to the\nvariable will display the full command line to our screen as shown in Figure 9.\n\n\n-----\n\nFigure 9: Malicious command line generated\n\nFinally, the macro will execute the command using winmgmts:win32_process explained\nbefore and exit the macro.\n\nFigure 10: Execute command\n\nThe command line will first run the command msg to send a message to a user. The figure\nbelow shows the message box that will be displayed to the victim once the Macro is\nexecuted.\n\nFigure 11: Msg command\n\n\n-----\n\nThe encoded PowerShell command will be explained in the next section.\n\n## 1.2 Deobfuscating encoded PowerShell command line\n\nRetrieving the encoded PowerShell command-line reveals that the executed command is\nactually a long-encoded line than it shows in the MsgBox shown in figure 9 in the previous\nsection.\n\nFigure 12: Powershell command\n\nDecoding the encrypted base64 strings will give this output as follows:\n\n\n-----\n\nFigure 13: Decoded Powershell base64 line\n\nAfter removing a lot of garbage characters and cleaning the code to more readable and\nunderstandable code, the result shows as follows:\n\nFigure 14: Clean code of the obfuscated Powershell\n\nIn summary of the above code, the PowerShell first creates a directory and subdirectory\nname %UserProfile%/Scnfrf7\\Pb6asvf. After that, the code assigns seven URL strings to\nvariable $URL which then will be used in the next block of code of for-each statement. The\nfor-each statement will get the element of the array in the variable $URL and download the\nDLL file. The file that being download will be saved as O66D.dll at the created directory\n**_%UserProfile%/Scnfrf7\\Pb6asvf. If the executable file has a length of more than value_**\n32360, the code will continue to execute the DLL using the rundll32 utility with the string\n“AnyString” as its first parameter. Vice versa, if it is lower than the value 32360 or the file not\navailable in the directory, the code will be break and exit.\n\n\n-----\n\n## 1.3 URL check\n\nNavigating and download the content of all URLs only brings to the error page. Thus,\nretrieving the DLL file is failed.\n\nFigure 15: Fiddler result\n\nChecking all the URLs we found in figure 14 with URLhaus Database shows that all the\nURLs were tagged as Emotet malware URL.\n\nMoreover, one of the samples that identically same macro code and PowerShell command\npattern were found in JoeSandbox public submission. The result of the JoeSandbox detects\nthe sample document as Emotet.\n\n\n-----\n\nFigure 16: https://www.joesandbox.com/analysis/343392/0/html\n\n## 2.0 IOCs\n\nThe following MD5 hashes are associated with this Emotet malware analysis:\n\n1. 809928addbff4e5f9b7d9f55e0ac88e9 - file-20210122-QRN6275.doc\n2. bde8abd3c29befafb3815d9b74785a3c - VBA file\n3. 1542602628751eb95eecd6c00ff5cee8 - O66D.dll\n\nThe following domain names are associated with this Emotet malware analysis:\n\n1. 213.82.114.106 (Mail Server)\n2. hxxp://www.pcsaha[.]com/wp-content/fG1tM/\n3. hxxp://rosvt[.]com/img/9h1Q/\n4. hxxp://skver[.]net/benjamin-moore-xha9o/t/\n5. hxxp://fultonandassociates[.]com/administrator/IUHeit/\n6. hxxp://zippywaytest.toppermaterial[.]com/wp-admin/wwbJ/\n7. hxxp://admin.toppermaterial[.]com/js/jGcwS/\n8. hxxp://notebook03[.]com/templates/G2Ay/\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-02-28 - Deobfuscating Emotet Macro Document and Powershell Command.pdf"
    ],
    "report_names": [
        "2021-02-28 - Deobfuscating Emotet Macro Document and Powershell Command.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536195,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1653756854,
    "ts_modification_date": 1653756854,
    "files": {
        "pdf": "https://archive.orkl.eu/1f25826dba9b97a53fd74fc7a1d6a7285bfb2b0b.pdf",
        "text": "https://archive.orkl.eu/1f25826dba9b97a53fd74fc7a1d6a7285bfb2b0b.txt",
        "img": "https://archive.orkl.eu/1f25826dba9b97a53fd74fc7a1d6a7285bfb2b0b.jpg"
    }
}