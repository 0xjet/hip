{
    "id": "f265620b-8ae0-4d2f-a160-c573667b63d5",
    "created_at": "2023-01-12T15:09:28.889081Z",
    "updated_at": "2025-03-27T02:06:02.906707Z",
    "deleted_at": null,
    "sha1_hash": "4746fa4e6c44ee60507d13dca7851e856308a138",
    "title": "Analysis of Antivirus Quarantine Files",
    "authors": "",
    "file_creation_date": "2021-01-27T08:41:45Z",
    "file_modification_date": "2021-01-27T10:55:53Z",
    "file_size": 176856,
    "plain_text": "# ERNW WHITEPAPER 71 ANALYSIS OF ANTI-VIRUS SOFTWARE QUARANTINE FILES\n\n\nVersion: 1.0\n\nDate: January 27, 2021\n\nClassification: Public\n\nAuthor(s): Florian Bausch\n\n\n## Florian Bausch\n\n\n#### Digitally signed by Florian Bausch Date: 2021.01.27 10:55:53 +01'00'\n\n\n-----\n\n### Table of Content\n\n1 Introduction 3\n\n1.1 Contribution . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3\n\n1.2 Related Work . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4\n\n1.3 Kaitai Struct . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 5\n\n2 Quarantine Analysis 6\n\n2.1 G Data . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6\n\n2.1.1 First section . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 7\n\n2.1.2 Second section . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 8\n\n2.1.3 Encryption algorithm and key . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 8\n\n2.1.4 Parser definition . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 8\n\n2.2 Sophos Antivirus . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 10\n\n2.2.1 SafeStore.db . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 11\n\n2.2.2 Encrypted files . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 13\n\n2.3 Kaspersky for Windows Server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 13\n\n2.3.1 quarantine.db . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 13\n\n2.3.2 Quarantine timestamp . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 14\n\n2.3.3 Encrypted files . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15\n\n2.4 Avira Antivirus . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15\n\n2.4.1 Parser definition . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16\n\n2.5 Malwarebytes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17\n\n2.6 Windows Defender . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19\n\n2.6.1 ResourceData files . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20\n\n2.6.2 Resources files . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 21\n\n2.6.3 Entries files . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 22\n\n2.7 Symantec Endpoint Protection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 27\n\n2.7.1 Quarantine file . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 27\n\n2.7.2 Metadata file . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31\n\n3 Summary & Conclusion 34\n\nA RC4 Helper Class in Python 35\n\nB References 36\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 2\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n### 1 Introduction\n\nAnti-virus software (AV software) is a type of computer software that tries to identify malicious software and to prevent\n\nit from running. Since anti-virus software may wrongfully identify harmless files as malicious (false positives), AV soft\nware makes use of quarantining files. If a file is put into quarantine by an AV software, the AV software removes the\n\noriginal suspected malicious file and stores a modified obfuscated version in another location. Obfuscation is achieved\n\nby encrypting the original file with more or less strong algorithms. However, the strength of the encryption algorithm\n\nis not important, since the encryption is only meant to transform executable files into a representation that cannot be\n\nexecuted by the computer. The encryption is usually symmetric because it is faster and more simple to handle than\n\nasymmetric encryption. To be able to restore files from quarantine, the AV software stores additional information be\nsides the encrypted malicious file. This information usually includes the original path, timestamps, checksums (for\n\nexample MD5, SHA1, SHA256), and the name and type of the suspected malware.\n\nQuarantine files of AV software can be useful sources of information during incident analyses. They preserve malicious\n\nfiles that may have been executed on the system, but also give hints when a computer got infected by malware. They may\n\neven include information about processes that created the malicious files. The challenge when trying to use quarantine\n\nfiles during incident analysis is that there is a big variety of AV software, each using a different proprietary undocumented\n\nform of storing the information.\n\nBased on these considerations, the quarantine files of different AV software were analyzed. The encryption and obfusca\ntion methods were documented (including encryption keys) and parsers created using Kaitai Struct[1]. Using the parsers\n\nand other documented information it is possible to create a unified tool that can automatically analyze quarantine files\n\nof different AV software, show the information, transform the information into Sleuth Kit’s body file format (Carrier,\n\n2009), look up more information from online services such as VirusTotal[2], and restore malicious files for further static\n\nor dynamic malware analysis.\n\n##### 1.1 Contribution\n\nThis whitepaper gives a detailed overview over structure, content, and encryption / obfuscation methods of anti-virus\n\nquarantine files. The file formats are described so that incident analysists can find useful information more easily.\n\nFurthermore, the Kaitai Struct parser definition files can be used to implement tools for automated analysis. The\n\n[results of this research work are also available on Github: https://github.com/ernw/quarantine-formats.[3]](https://github.com/ernw/quarantine-formats)\n\nThe examined quarantine files belong to the following anti-virus software:\n\n_[1 https://kaitai.io/](https://kaitai.io/)_\n_[2 https://virustotal.com/](https://virustotal.com/)_\n_[3 Licensed under Creative Commons CC BY-SA 4.0, https://creativecommons.org/licenses/by-sa/4.0/](https://creativecommons.org/licenses/by-sa/4.0/)_\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 3\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\nAvira\n\nWindows Defender\n\nMalwarebytes\n\nSymantec Endpoint Protection\n\nG Data\n\nSophos Antivirus\n\nKaspersky for Windows Server\n\nFor G Data, Sophos, and Kaspersky, this whitepaper is the first description of the file formats. For the other file formats,\n\nit is – to our knowledge – the first structured, detailed description.\n\n##### 1.2 Related Work\n\nThere are several resources on the Internet, e.g. blog posts, about different quarantine file formats that give a more or\n\nless detailed view on selected file formats.\n\nA tool that supports the decryption and deobfuscation of quarantine files of various AV software is DeXRAY (dexray.\n```\n    pl) by Adam Grant (Grant, 2019a). However, DeXRAY simply restores malicious files and does not analyze metadata.\n\n```\nFuthermore, there is no documentation on how the quarantine files are processed and why they are processed this\n\nway.\n\nA basic description of the Windows Defender file format was created by Jon Glass. However, it shows how to restore\n\nquarantined files without examining metadata and supporting files (Glass, 2015).\n\nThe blog post Recovering Malware from a Quarantine Folder by M. Gene Shantz (Shantz, 2016) gives hints about analyzing\n\nAvira Antivirus files without trying to understand the complete file format. The author shows how to manually extract a\n\nquarantined file, but ignores the additional metadata provided by the quarantine file.\n\nFor Symantec Endpoint Protection’s quarantine files there is a not actively developed program called VBNExtract (conix\nsecurity, 2014). It can also only extract files from quarantine without using additional metadata or understanding the\n\nwhole file structure. A more detailed analysis of this file format was performed and described by Brian Maloney (Mal\noney, 2018).\n\nAnother not actively developed program is a fork of the Cuckoo dynamic analysis framework. It contains a functionality\n\nto unquarantine files from different quarantine file formats (Sprengler, 2015). However, there is little documentation\n\nabout the supported file formats.\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 4\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n##### 1.3 Kaitai Struct\n\nKaitai Struct[4] is a YAML-based format to define parsers for arbitrary binary files in a generic description language.\n\nParser definitions can be compiled into program code – several programming languages are supported. This simplifies\n\ncreating and reading a parser definition and to use it in different projects. Furthermore, Kaitai Struct provides the Kaitai\n\nVisualizer tool. This tool allows to use the parser definition to interactively browse through a binary file parsed using\n\nthis definition.\n\nKaitai Struct comes with a built-in support for xor-processing files or parts of files. This method is often used as a simple\n\nencryption method for quarantine files. If another encryption method is used, the decryption routine – for example RC4\n\n– can be implemented in the required programming language and used in the parser definition. (See appendix A – RC4\n\n_Helper Class in Python, page 35 for an RC4 helper class in Python.)_\n\n_[4 https://kaitai.io/](https://kaitai.io/)_\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 5\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n### 2 Quarantine Analysis\n\nThe samples for the analysis were taken from real-life incident analysis cases and from especially generated quaran\ntine files. These generated files were created by installing an AV software inside of a Windows 7 virtual machine (VM)\n\nand adding the EICAR test file (EICAR, 2006), but also real malware samples. After detection by the AV software the\n\nquarantine directories of the AV were saved for analysis.\n\nThe selection of AV software in this document was influenced by the encountered AV software on analyzed systems\n\nduring real life incident cases.\n\nFor the three anti-virus software solutions by G Data (section 2.1), Sophos (section 2.2), and Kaspersky (section 2.3)\n\nno previous, related work could be found. Because of this, these sections contain a more detailed description on the\n\nresearch work. For the other software solutions Avira (section 2.4), Malwarebytes (section 2.5), Windows Defender\n\n(section 2.6), and Symantec (section 2.7) it was possible to use findings from other resources. Therefore, these sections\n\ncontain a less detailed description of the results.\n\n##### 2.1 G Data\n\nThe analysis of the G Data quarantine format started with two quarantine files from an incident analysis. The two\n\noriginal malware files were found on the system, too, which simplified the first steps of analysis. G Data quarantine files\n\nare located at /ProgramData/GData/AVK/Quarantine/ and their file names follow this pattern: ”<hostname>\n```\n    DDMMYYHHmmss[0-9A-F]{8}.q”. However, the hostname is not always included in the file names.\n\n```\nThe following listing shows as an example a quarantine file containing the EICAR test file. The file consists of three\n\nsections; the first two sections are easy to spot at first glance:\n\n1. A section starting with the magic bytes 0xca 0xfe 0xba 0xbe, followed by its length (0x54 in this case).\n\n2. A section starting with the magic bytes 0xba 0xad 0xf0 0x0d, followed by its length (0x9c in this case).\n\n3. In this example, the second section ends at 0x100. The remainder of the file has exactly the length of the quar\nantined EICAR test file (0x44 bytes).\n```\n       00000000: cafe babe 5400 0000 e864 787b 7094 5280 ....T....dx{p.R.\n       00000010: 49cd 626d 7b9f 794c 1178 72cf 1f40 2565 I.bm{.yL.xr..@%e\n       00000020: d076 b97b 3994 0dd1 e09d 279c c544 09b6 .v.{9.....'..D..\n       00000030: 5273 9b84 ca8d d276 1595 d60a 9bee 8c7d Rs.....v.......}\n       00000040: 35cf e5d1 562a ba46 8beb 5d86 5dcf 3bca 5...V*.F..].].;.\n       00000050: 902d bb48 8f84 2a40 0886 d6e6 baad f00d .-.H..*@........\n       00000060: 9c00 0000 e864 787b 7094 5280 07cd 62ed .....dx{p.R...b.\n       00000070: f32d c312 1078 72cf c0be da78 0f46 8896 .-...xr....x.F..\n       00000080: 1576 99d0 3242 156e fea6 b9b7 bb43 9769 .v..2B.n.....C.i\n\n```\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 6\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n```\n00000090: 886f 4177 7c95 ba0a baee ac7d e231 74fe .oAw|......}.1t.\n000000a0: 652a 9246 94eb 6086 3ecf 77ca a52d 9c48 e*.F..`.>.w..-.H\n000000b0: 8984 3c40 5386 a5e6 a0ad 4adb 4109 9891 ..<@S.....J.A...\n000000c0: b9ec dc76 a6bc 5c0b a676 6885 f615 0643 ...v..\\..vh....C\n000000d0: 4c36 bed4 0627 6bc3 5511 2ad4 3b28 9ba9 L6...'k.U.*.;(..\n000000e0: 0b3a 0cab 221f b076 dcd3 8e7e d220 a9ab .:..\"..v...~. ..\n000000f0: b8e7 49bb b4db e817 c156 e7b1 f372 c1ff ..I......V...r..\n00000100: b151 375a 20b1 12c1 1396 56b1 5c89 6427 .Q7Z .....V.\\.d'\n00000110: 2550 2291 c989 993b bc41 8d5f 3fdd 0f90 %P\"....;.A._?...\n\n```\n```\n00000120: e0b0 59c8 d00a 28f7 7337 c2c5 a9d9 dd20 ..Y...(.s7.....\n\n```\n```\n00000130: 35c7 ef59 d3ba e92e 49e2 cd98 756f ef62 5..Y....I...uo.b\n\n```\n```\n00000140: e3c0 74ac ..t.\n\n```\n\nNeither of the three sections of the file shows repetitive patterns, which led to the assumption that a stream cipher\n\ninstead of a simple xor key was used to encrypt the sections. However, the first two sections show a similar pattern in\n\nthe beginning (0xe8 0x64 ...), which led to the assumption that all three sections might have been encrypted using\n\nthe same algorithm and key.\n\nTo check this hypothesis, the third section of the two quarantine samples was xored with the original malware files\n\nfound on the system. Both resulting byte sequences were the same (except their length, since the malware files did not\n\nhave the same length).\n\nThe resulting byte sequence was xored with the first two sections of the malware samples. The results showed usable\n\ndata (see sections 2.1.1 and 2.1.2).\n\n###### 2.1.1 First section\n\nThe first section contains the Unix epoch when the file was quarantined (offset 0x0c in the following listing). The name\n\nof the detected malware starts at offset 0x14. It is encoded as a UTF-16LE string, starting with a BOM (Unicode, 2020),\n\nfollowed by the number of characters in the string (in this example 0x1d). The string is null-terminated.\n```\n       00000000: 0100 0000 0000 0000 0a00 0080 774c 455e ............wLE^\n       00000010: 0000 0000 fffe ff1d 4500 4900 4300 4100 ........E.I.C.A.\n       00000020: 5200 2d00 5400 6500 7300 7400 2d00 4600 R.-.T.e.s.t.-.F.\n       00000030: 6900 6c00 6500 2000 2800 6e00 6f00 7400 i.l.e. .(.n.o.t.\n       00000040: 2000 6100 2000 7600 6900 7200 7500 7300 .a. .v.i.r.u.s.\n\n```\n```\n00000050: 2900 0000 )...\n\n```\n\n_Listing 1: Decrypted first section of G Data quarantine file_\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 7\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n###### 2.1.2 Second section\n\nThe second section contains a string at offset 0x0c. In all examined samples this string was empty; therefore, its\n\nfunction remains unknown.\n\nAt offsets 0x18, 0x20, and 0x28 there are three Windows File Time timestamps (Microsoft, 2018).\n\nThe original file path of the detected malware starts at offset 0x38. Again, it is encoded as a null-terminated UTF-16LE\n\nstring with BOM and number of characters.\n\nAdditionally, the file size of the original malware file is encoded twice, at 0x08 and 0x34.\n```\n       00000000: 0100 0000 0000 0000 4400 0000 fffe ff00 ........D.......\n       00000010: 0100 0000 2000 0000 9a30 78ed 6fe2 d501 .... ....0x.o...\n       00000020: 80df 1ff2 6fe2 d501 9a30 78ed 6fe2 d501 ....o....0x.o...\n       00000030: 0000 0000 4400 0000 fffe ff2f 5c00 5c00 ....D....../\\.\\.\n       00000040: 3f00 5c00 4300 3a00 5c00 5500 7300 6500 ?.\\.C.:.\\.U.s.e.\n       00000050: 7200 7300 5c00 4900 4500 5500 7300 6500 r.s.\\.I.E.U.s.e.\n       00000060: 7200 5c00 4400 6500 7300 6b00 7400 6f00 r.\\.D.e.s.k.t.o.\n       00000070: 7000 5c00 6500 6900 6300 6100 7200 5c00 p.\\.e.i.c.a.r.\\.\n       00000080: 6500 6900 6300 6100 7200 2e00 6300 6f00 e.i.c.a.r...c.o.\n\n```\n```\n00000090: 6d00 2e00 7400 7800 7400 0000 m...t.x.t...\n\n```\n\n_Listing 2: Decrypted second section of G Data quarantine file_\n\n###### 2.1.3 Encryption algorithm and key\n\nG Data uses RC4 for the encryption of malware samples and the two metadata sections. The key is located in file\n```\n    AVKQt.dll at offset 0x8adb8, in the .rdata section. It has a length of 16 bytes. The value is:\n\n```\n```\n0xA7, 0xBF, 0x73, 0xA0, 0x9F, 0x03, 0xD3, 0x11, 0x85, 0x6F, 0x00, 0x80, 0xAD, 0xA9, 0x6E, 0x9B\n\n```\n\n_Listing 3: G Data RC4 key_\n\n###### 2.1.4 Parser definition\n\nCombining the previous findings, a Kaitai Struct parser definition file can be created:\n\n\n**meta:**\n\n\n**id: gdata**\n\n\n**file-extension: q**\n\n\n**endian: le**\n\n\n**title: G Data quarantine file parser**\n\n\n**license: CC-BY-SA-4.0**\n\n\n**ks-version: 0.9**\n\n\n**doc: |**\n\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 8\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n**Creator: Florian Bausch, ERNW Research GmbH, https://ernw-research.de**\n\n**License: CC-BY-SA-4.0 https://creativecommons.org/licenses/by-sa/4.0/**\n\n\n**seq:**\n\n```\n- id: magic1\n\n```\n\n**size: 4**\n\n\n**contents: [0xca, 0xfe, 0xba, 0xbe]**\n\n```\n- id: len_data1\n\n```\n\n**type: u4**\n\n```\n- id: data1\n\n```\n\n**size: len_data1**\n\n\n**type: encrypted_data1**\n\n\n**process: util.custom_arc4.custom_arc4(<RC4 key>)**\n\n```\n- id: magic2\n\n```\n\n**size: 4**\n\n\n**contents: [0xba, 0xad, 0xf0, 0x0d]**\n\n```\n- id: len_data2\n\n```\n\n**type: u4**\n\n```\n- id: data2\n\n```\n\n**size: len_data2**\n\n\n**type: encrypted_data2**\n\n\n**process: util.custom_arc4.custom_arc4(<RC4 key>)**\n\n```\n- id: mal_file\n\n```\n\n**size-eos: true**\n\n\n**process: util.custom_arc4.custom_arc4(<RC4 key>)**\n\n\n**types:**\n\n\n**encrypted_data1:**\n\n\n**seq:**\n\n```\n- id: unknown1\n\n```\n\n**size: 0x0c**\n\n```\n- id: quatime\n\n```\n\n**type: u4**\n\n```\n- id: unknown2\n\n```\n\n**size: 0x04**\n\n```\n- id: malwaretype\n\n```\n\n**type: utf16le**\n\n\n**encrypted_data2:**\n\n\n**seq:**\n\n```\n- id: unknown1\n\n```\n\n**size: 0x08**\n\n```\n- id: filesize\n\n```\n\n**type: u4**\n\n```\n- id: unknownstring1\n\n```\n\n**type: utf16le**\n\n```\n- id: unknown2\n\n```\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 9\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n**size: 0x08**\n\n```\n- id: time1\n\n```\n\n**type: winfiletime**\n\n```\n- id: time2\n\n```\n\n**type: winfiletime**\n\n```\n- id: time3\n\n```\n\n**type: winfiletime**\n\n```\n- id: unknown3\n\n```\n\n**size: 0x04**\n\n```\n- id: filesize2\n\n```\n\n**type: u4**\n\n```\n- id: path\n\n```\n\n**type: utf16le**\n\n\n**utf16le:**\n\n\n**seq:**\n\n```\n- id: bom\n\n```\n\n**size: 3**\n\n\n**contents: [0xFF, 0xFE, 0xFF]**\n\n```\n- id: number_of_chars\n\n```\n\n**type: u1**\n\n```\n- id: string_content\n\n```\n\n**type: str**\n\n\n**encoding: utf-16le**\n\n\n**size: number_of_chars * 2**\n\n\n**winfiletime:**\n\n\n**seq:**\n\n```\n- id: ts\n\n```\n\n**type: u8**\n\n\n**instances:**\n\n\n**unixts:**\n\n\n**value: (ts * 1e-07) - 11644473600**\n\n\n_Listing 4: Parser definition for G Data quarantine files_\n\n##### 2.2 Sophos Antivirus\n\nThe initial Sophos Antivirus samples were collected in an incident. In this case, the original malicious files could not be\n\nrecovered from the system. Further samples were created in a Windows 7 VM and the EICAR test file.\n\nSophos uses a database containing the metadata of quarantined files (found in different locations, but most likely under\n```\n    /ProgramData/Sophos Anti-Virus/Safestore/). The malicious files are encrypted and stored in separate\n\n```\nfiles next to the database.\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 10\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n###### 2.2.1 SafeStore.db\n\nThe metadata is stored in an encrypted SQLite 3 database. The file can be named SafeStore.db or Safestore.db\n\nand there can be more than one database per system. The encryption key is stored in the same directory and named\n\neither safestore_key.txt or SafeStore.pw. The database can be decrypted using sqlcipher.[5]\n\nThere are two files per quarantined file. One file is the encrypted malicious file, the other one the encrypted ACLs of that\n\nfile. The names of the files are stored in BlobTable.name. The table BlobTable stores other interesting data:\n```\n      originalchecksum: The SHA256 checksum of the uncompressed, unencrypted file.\n      size: The file size of the compressed, encrypted file.\n\n```\nMore interesting metadata can be found in table StringPropertyTable. This table can contain more or less infor\nmation, depending on the version of Sophos Antivirus. This table stores – depending on the value of type – several\n\ninformation about a quarantined file (referenced by objectid):\n\nType name: The original file name of the malicious file.\n\nType location: The directory of the original file.\n\nType threatname: The name of the detected malware.\n\nType filecreationtime: Windows File Time (Microsoft, 2018) of the creation of the original file.\n\nType filelastwritetime: Windows File Time (Microsoft, 2018) of the last write to the original file.\n\nThe table ThreatObjectTable contains the information when a file was moved to quarantine:\n```\n      datetime: The Unix timestamp when the file was quarantined.\n\n```\n2.2.1.1 SafeStore.db SQLite 3 database schema\n\n\n**CREATE TABLE \"BlobPropertyTable\" (**\n\n\n`\"blobpropertyid\"` **integer,**\n\n```\n\"type\" varchar NOT NULL,\n\n```\n\n`\"objectid\"` **integer NOT NULL,**\n\n`\"blobid\"` **integer NOT NULL,**\n\n\n**FOREIGN KEY(\"blobid\") REFERENCES \"BlobTable\"(\"blobid\"),**\n\n\n**FOREIGN KEY(\"objectid\") REFERENCES \"ThreatObjectTable\"(\"objectid\"),**\n\n\n**PRIMARY KEY(\"blobpropertyid\")**\n\n```\n);\n\n```\n\n**CREATE TABLE \"BlobTable\" (**\n\n\n`\"blobid\"` **integer,**\n\n```\n\"name\" varchar NOT NULL,\n\n```\n\n_[5 https://www.zetetic.net/sqlcipher/](https://www.zetetic.net/sqlcipher/)_\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 11\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n```\n\"size\" integer NOT NULL,\n\n```\n```\n\"originalchecksum\" varchar NOT NULL,\n\n```\n\n`\"storedchecksum\"` **varchar NOT NULL,**\n\n```\n\"blobversion\" varchar NOT NULL,\n\n```\n\n**PRIMARY KEY(\"blobid\")**\n\n```\n);\n\n```\n\n**CREATE TABLE \"MetaInfoTable\" (**\n\n```\n\"schema_vermajor\" integer NOT NULL,\n\"schema_verminor\" integer NOT NULL,\n\"schema_verpatch\" integer NOT NULL,\n\"min_safestore_vermajor\" integer NOT NULL,\n\"min_safestore_verminor\" integer NOT NULL,\n\"min_safestore_verpatch\" integer NOT NULL,\n\n```\n```\n\"file_encryption_salt\" varchar NOT NULL,\n\n```\n```\n\"file_encryption_test\" varchar NOT NULL\n\n```\n```\n);\n\n```\n\n**CREATE TABLE \"StringPropertyTable\" (**\n\n```\n\"stringpropertyid\" integer,\n\n```\n```\n\"type\" varchar NOT NULL,\n\n```\n```\n\"value\" varchar NOT NULL COLLATE nocase,\n\n```\n\n`\"objectid\"` **integer NOT NULL,**\n\n\n**FOREIGN KEY(\"objectid\") REFERENCES \"ThreatObjectTable\"(\"objectid\"),**\n\n\n**PRIMARY KEY(\"stringpropertyid\")**\n\n```\n);\n\n```\n\n**CREATE TABLE \"ThreatObjectTable\" (**\n\n\n`\"objectid\"` **integer,**\n\n```\n\"objectguid\" varchar NOT NULL,\n\"threatguid\" varchar NOT NULL,\n\n```\n```\n\"type\" varchar NOT NULL,\n\n```\n\n`\"datetime\"` **integer NOT NULL,**\n\n```\n\"safestoreversion\" varchar NOT NULL,\n\n```\n\n`\"status\"` **varchar NOT NULL,**\n\n\n**PRIMARY KEY(\"objectid\")**\n\n```\n);\n\n```\n\n**CREATE INDEX \"BlobPropertyTable_Index\" ON \"BlobPropertyTable\" (**\n\n\n`\"objectid\"` **asc,**\n\n\n`\"blobid\"` **asc**\n\n```\n);\n\n```\n\n**CREATE INDEX \"BlobTable_Index\" ON \"BlobTable\" (**\n\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 12\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n```\n\"originalchecksum\" asc\n\n```\n```\n);\n\n```\n\n**CREATE INDEX \"StringPropertyTable_Index\" ON \"StringPropertyTable\" (**\n\n\n`\"objectid\"` **asc**\n\n```\n);\n\n```\n\n**CREATE INDEX \"ThreatObjectTable_Index\" ON \"ThreatObjectTable\" (**\n\n\n`\"datetime\"` **asc**\n\n```\n);\n\n```\n\n_Listing 5: Sophos Antivirus SafeStore.db database schema_\n\n###### 2.2.2 Encrypted files\n\nThe encrypted files have file sizes that are different to the file sizes of the original malicious files. While larger samples\n\nshowed that the original files were larger than the quarantined files, the (small) EICAR test file was smaller than the\n\nmatching quarantine file. This led to the assumption that the files were compressed before encryption – for small files\n\nthe compression overhead actually increased the file size.\n\nIn a VM with Windows 7, Sophos Antivirus was installed and the restore functionality analyzed with a debugger. While\n\nthe encryption algorithm and key could not yet be identified, this analysis showed that the zlib compression library is\n\nused to compress the files before encryption. The magic bytes 0x78 0x9C found in memory show that the standard\n\ncompression level is used.\n\n##### 2.3 Kaspersky for Windows Server\n\nThe samples for Kaspersky for Windows Server came from an incident analysis. The original malicous files could also be\n\nfound on the system. The quarantine files are located at /ProgramData/Kaspersky Lab/Kaspersky Security\n```\n    for Windows Server/<version>/Quarantine/.\n\n```\nKaspersky for Windows Server uses a central database for metadata of quarantined files (quarantine.db). The\n\nmalicious files are stored separately (the name is a UUID).\n\nThe analysis was straightforward since the database was not encrypted and most column names are easily under\nstandable. The xor encryption key for the quarantine files could be found by xoring the original malicious file with the\n\nquarantine file.\n\n###### 2.3.1 quarantine.db\n\nThe metadata database is a SQLite 3 database called quarantine.db.\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 13\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n**CREATE TABLE objattrs (uuid text primary key,attrs int,rights blob,creation_time int,access_time int,**\n\n\n_�→_ `write_time int)`\n\n\n**CREATE TABLE objects (uuid text primary key,path text,name text,virname text,virtype int,level int,**\n\n\n_�→_ **time int,size int,status int,sent int,user text)**\n\n\n_Listing 6: Quarantine database schema of Kaspersky for Windows Server_\n\nColumns interesting for analyses are explained in the following.\n\nTable objects:\n```\n      uuid: The UUID of the threat. At the same time, it is the file name of the encrypted quarantine file holding the\n\n```\nmalicious file.\n```\n      path: Directory of original file.\n      name: Name of the original file.\n      virname: The name of the virus.\n      time: Timestamp of quarantine. This timestamp is in a proprietary format and stores the timestamp in the system’s\n\n```\nlocal time without storing timezone information. (See section 2.3.2.)\n```\n      size: The file size of the original file.\n      user: Probably the owner of the file.\n\n```\nTable objattrs:\n```\n      uuid: See above.\n      rights: Binary respresentation of the security descriptor of the original file.\n      creation_time: crtime (Windows File Time (Microsoft, 2018)).\n      access_time: atime (Windows File Time).\n      write_time: mtime (Windows File Time).\n\n###### 2.3.2 Quarantine timestamp\n\n```\nThe quarantine timestamp is stored as an integer in the database. The following list shows how to compute the different\n\ndata out of the timestamp and how many bits each datum takes in the integer:\n\n1. Years: 16 bits: (time >> 48) & 0xFFFF\n\n2. Months: 8 bits: (time >> 40) & 0xFF\n\n3. Days: 8 bits: (time >> 32) & 0xFF)\n\n4. Hours: 8 bits: (time >> 24) & 0xFF)\n\n5. Minutes: 8 bits: (time >> 16) & 0xFF)\n\n6. Seconds: 8 bits: (time >> 8) & 0xFF)\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 14\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n7. (Probably) unused: 8 bits: qtime & 0xFF\n\nThe date is the local date, which means that during analysis the timezone of the system has to be known to interpret\n\nthe timestamp correctly.\n\n###### 2.3.3 Encrypted files\n\nThe malicious files get encrypted using an eight-byte xor key:\n\n```\n0xe2 0x45 0x48 0xec 0x69 0x0e 0x5c 0xac\n\n```\n\n_Listing 7: Kaspersky for Windows Server xor key_\n\nThe encrypted quarantine files are stored in the same directory as the quarantine.db. They contain only the quar\nantined files and no other data.\n\n2.3.3.1 Parser definition\n\nThe Kaitai Struct parser definition is very simple since only one datum (the malicious file) is stored in the file:\n\n\n**meta:**\n\n\n**id: kasperskyserver**\n\n\n**endian: le**\n\n\n**title: Kaspersky for Windows Server quarantine file parser**\n\n\n**license: CC-BY-SA-4.0**\n\n\n**ks-version: 0.9**\n\n\n**doc: |**\n\n\n**Creator: Florian Bausch, ERNW Research GmbH, https://ernw-research.de**\n\n**License: CC-BY-SA-4.0 https://creativecommons.org/licenses/by-sa/4.0/**\n\n\n**seq:**\n\n```\n- id: mal_file\n\n```\n\n**process: xor([0xe2, 0x45, 0x48, 0xec, 0x69, 0x0e, 0x5c, 0xac])**\n\n\n**size-eos: true**\n\n\n_Listing 8: Parser definition for Kaspersky for Windows Server quarantine files_\n\n##### 2.4 Avira Antivirus\n\nAvira stores quarantined files under /ProgramData/Avira/Antivirus/INFECTED. The file extension is .qua.\n\nThe interesting information are (names refer to section 2.4.1):\n```\n      qua_time: The unix epoch when the file was quarantined.\n      mal_type: The name or type of the malware.\n\n```\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 15\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n```\n      filename: The original path of the quarantined file. Sometimes this field seems to hold a process name. Maybe\n\n```\nthis happens if a process is prevented from writing a malicious file.\n```\n      addl_info: Additional information, which is not always present.\n      mal_file: The file content of the quarantined file.\n\n```\nThe malicious file is stored obfuscated using a single-byte xor key. The key is 0xAA.\n\n###### 2.4.1 Parser definition\n\n\n**meta:**\n\n\n**id: qua**\n\n\n**file-extension: qua**\n\n\n**endian: le**\n\n\n**title: Avira Antivirus quarantine file parser**\n\n\n**license: CC-BY-SA-4.0**\n\n\n**ks-version: 0.9**\n\n\n**doc: |**\n\n\n**Creator: Florian Bausch, ERNW Research GmbH, https://ernw-research.de**\n\n**License: CC-BY-SA-4.0 https://creativecommons.org/licenses/by-sa/4.0/**\n\n\n**seq:**\n\n```\n- id: magic\n\n```\n\n**size: 16**\n\n\n**contents: [\"AntiVir Qua\", 0x00, 0x00, 0x00, 0x00, 0x00]**\n\n```\n- id: malicious_offset\n\n```\n\n**type: u4**\n\n```\n- id: len_filename\n\n```\n\n**type: u4**\n\n```\n- id: len_addl_info\n\n```\n\n**type: u4**\n\n```\n- id: unknown1\n\n```\n\n**size: 0x20**\n\n```\n- id: qua_time\n\n```\n\n**type: u4**\n\n```\n- id: unknown2\n\n```\n\n**size: 0x5c**\n\n```\n- id: mal_type\n\n```\n\n**type: str**\n\n\n**terminator: 0**\n\n\n**encoding: UTF-8**\n\n\n**size: 0x40**\n\n```\n- id: filename\n\n```\n\n**type: str**\n\n\n**encoding: UTF-16LE**\n\n\n**size: 'len_filename < 2 ? len_filename : len_filename - 2'**\n\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 16\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n```\n- id: padding1\n\n```\n\n**size: 2**\n\n\n**contents: [0x00, 0x00]**\n\n\n**if: 'len_filename >= 2'**\n\n```\n- id: addl_info\n\n```\n\n**type: str**\n\n\n**encoding: UTF-16LE**\n\n\n**size: 'len_addl_info < 2 ? len_addl_info : len_addl_info - 2'**\n\n```\n- id: padding2\n\n```\n\n**size: 2**\n\n\n**contents: [0x00, 0x00]**\n\n\n**if: 'len_addl_info >= 2'**\n\n```\n- id: mal_file\n\n```\n\n**process: xor(0xaa)**\n\n\n**size-eos: true**\n\n\n_Listing 9: Parser definition for Avira quarantine files_\n\n##### 2.5 Malwarebytes\n\nThe samples for Malwarebytes were created in a Windows 7 VM with a Malwarebytes installation. The EICAR test file\n\nand further malware samples were copied to the VM and quarantined by Malwarebytes.\n\nMalwarebytes creates two files per malicious file. One file contains the encrypted malicious file, the other file contains\n\nthe metadata. This metadata file is an encrypted JSON file. Both files are encrypted using the following string. This\n\nstring is hashed using MD5. The resulting hash is used to initialize the RC4 algorithm (Grant, 2019b, pp. l. 1644).\n\n```\nGo9r%8hhAl7Ari;vnQ8wwkmeostfETkzLEf5*+6u8MF.CbsYKbTt9w.cVJbJ+pzyvrsT\n\n```\n\n_Listing 10: Malwarebytes RC4 encryption key_\n\nThe file names consist of a UUID and a file extension that indicates whether it contains the malicious file or metadata:\n```\n  .quar: Malicious file, without any additional data\n  .data: Metadata file\n\n```\nA metadata file may look like this:\n\n```\n{\n\n```\n```\n\"componentsUpdatePackageVersion\" : \"1.0.613\",\n\n```\n```\n\"dbSDKUpdatePackageVersion\" : \"1.0.12023\",\n\n```\n```\n\"ruleID\" : 683363,\n\"ruleString\" : \"\",\n\n```\n```\n\"schemaVersion\" : 8,\n\n```\n```\n\"source\" : \"scan\",\n\n```\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 17\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n```\n\"sourceID\" : \"<UUID>\",\n\n```\n```\n\"sourcePath\" : \"<PATH>\",\n\n```\n```\n\"threatID\" : 3912,\n\n```\n```\n\"threatName\" : \"<TYPE OF MALWARE>\",\n\n```\n```\n\"trace\" : {\n\n```\n```\n\"cleanAction\" : \"quarantine\",\n\n```\n```\n\"cleanContext\" : {\n\n```\n```\n},\n\n```\n```\n\"cleanResult\" : \"successful\",\n\n```\n```\n\"cleanResultErrorCode\" : 0,\n\n```\n```\n\"cleanTime\" : \"2019-08-15T11:35:10Z\",\n\n```\n```\n\"objectID\" : \"<UUID WHICH IS ALSO PART OF FILE NAME>\",\n\n```\n```\n\"objectMD5\" : \"<MD5 HASH>\",\n\n```\n```\n\"objectPath\" : \"<ORIGINAL FILE PATH>\",\n\n```\n```\n\"objectSha256\" : \"<SHA256 HASH>\",\n\n```\n```\n\"objectType\" : \"file\",\n\n```\n```\n\"parentID\" : \"\",\n\n```\n```\n\"relationToParent\" : \"none\",\n\n```\n```\n\"suggestedAction\" : {\n\n```\n```\n\"chromeExtensionOther\" : false,\n\n```\n```\n\"chromeExtensionPreferences\" : false,\n\n```\n```\n\"chromeExtensionSecurePreferences\" : false,\n\n```\n```\n\"chromeExtensionSyncData\" : false,\n\n```\n```\n\"chromeUrlOther\" : false,\n\n```\n```\n\"chromeUrlSecurePreferences\" : false,\n\n```\n```\n\"chromeUrlSyncData\" : false,\n\n```\n```\n\"chromeUrlWebData\" : false,\n\n```\n```\n\"fileDelete\" : true,\n\n```\n```\n\"fileReplace\" : false,\n\n```\n```\n\"fileTxtReplace\" : false,\n\n```\n```\n\"folderDelete\" : false,\n\n```\n```\n\"isChromeObject\" : false,\n\n```\n```\n\"isDDS\" : false,\n\n```\n```\n\"isWMIEventConsumer\" : false,\n\n```\n```\n\"minimalWhiteListing\" : false,\n\n```\n```\n\"moduleUnload\" : false,\n\n```\n```\n\"noLinking\" : false,\n\n```\n```\n\"physicalSectorReplace\" : false,\n\n```\n```\n\"priorityHigh\" : false,\n\n```\n```\n\"priorityNormal\" : false,\n\"priorityUrgent\" : false,\n\n```\n```\n\"processUnload\" : false,\n\n```\n```\n\"regKeyDelete\" : false,\n\n```\n```\n\"regValueDelete\" : false,\n\n```\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 18\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n```\n\"regValueReplace\" : false,\n\"shortcutReplace\" : false,\n\n```\n```\n\"treatAsRootkit\" : false,\n\n```\n```\n\"useDDA\" : false\n\n```\n```\n}\n\n```\n```\n}\n\n```\n```\n}\n\n```\n\n_Listing 11: Sample JSON metadata file by Malwarebytes_\n\n##### 2.6 Windows Defender\n\nThe quarantine files of Windows Defender are located at:\n```\n    /ProgramData/Microsoft/Windows Defender/Quarantine\n\n```\nThere are three subdirectories holding different kinds of binary files:\n\n1. `ResourceData`\n\n2. `Resources`\n\n3. `Entries`\n\nThese files or parts of these files are encrypted using RC4 with the following key (Sprengler, 2015, line 186):\n\n0x1E, 0x87, 0x78, 0x1B, 0x8D, 0xBA, 0xA8, 0x44, 0xCE, 0x69, 0x70, 0x2C, 0x0C, 0x78, 0xB7, 0x86,\n\n0xA3, 0xF6, 0x23, 0xB7, 0x38, 0xF5, 0xED, 0xF9, 0xAF, 0x83, 0x53, 0x0F, 0xB3, 0xFC, 0x54, 0xFA,\n\n0xA2, 0x1E, 0xB9, 0xCF, 0x13, 0x31, 0xFD, 0x0F, 0x0D, 0xA9, 0x54, 0xF6, 0x87, 0xCB, 0x9E, 0x18,\n\n0x27, 0x96, 0x97, 0x90, 0x0E, 0x53, 0xFB, 0x31, 0x7C, 0x9C, 0xBC, 0xE4, 0x8E, 0x23, 0xD0, 0x53,\n\n0x71, 0xEC, 0xC1, 0x59, 0x51, 0xB8, 0xF3, 0x64, 0x9D, 0x7C, 0xA3, 0x3E, 0xD6, 0x8D, 0xC9, 0x04,\n\n0x7E, 0x82, 0xC9, 0xBA, 0xAD, 0x97, 0x99, 0xD0, 0xD4, 0x58, 0xCB, 0x84, 0x7C, 0xA9, 0xFF, 0xBE,\n\n0x3C, 0x8A, 0x77, 0x52, 0x33, 0x55, 0x7D, 0xDE, 0x13, 0xA8, 0xB1, 0x40, 0x87, 0xCC, 0x1B, 0xC8,\n\n0xF1, 0x0F, 0x6E, 0xCD, 0xD0, 0x83, 0xA9, 0x59, 0xCF, 0xF8, 0x4A, 0x9D, 0x1D, 0x50, 0x75, 0x5E,\n\n0x3E, 0x19, 0x18, 0x18, 0xAF, 0x23, 0xE2, 0x29, 0x35, 0x58, 0x76, 0x6D, 0x2C, 0x07, 0xE2, 0x57,\n\n0x12, 0xB2, 0xCA, 0x0B, 0x53, 0x5E, 0xD8, 0xF6, 0xC5, 0x6C, 0xE7, 0x3D, 0x24, 0xBD, 0xD0, 0x29,\n\n0x17, 0x71, 0x86, 0x1A, 0x54, 0xB4, 0xC2, 0x85, 0xA9, 0xA3, 0xDB, 0x7A, 0xCA, 0x6D, 0x22, 0x4A,\n\n0xEA, 0xCD, 0x62, 0x1D, 0xB9, 0xF2, 0xA2, 0x2E, 0xD1, 0xE9, 0xE1, 0x1D, 0x75, 0xBE, 0xD7, 0xDC,\n\n0x0E, 0xCB, 0x0A, 0x8E, 0x68, 0xA2, 0xFF, 0x12, 0x63, 0x40, 0x8D, 0xC8, 0x08, 0xDF, 0xFD, 0x16,\n\n0x4B, 0x11, 0x67, 0x74, 0xCD, 0x0B, 0x9B, 0x8D, 0x05, 0x41, 0x1E, 0xD6, 0x26, 0x2E, 0x42, 0x9B,\n\n0xA4, 0x95, 0x67, 0x6B, 0x83, 0x98, 0xDB, 0x2F, 0x35, 0xD3, 0xC1, 0xB9, 0xCE, 0xD5, 0x26, 0x36,\n\n0xF2, 0x76, 0x5E, 0x1A, 0x95, 0xCB, 0x7C, 0xA4, 0xC3, 0xDD, 0xAB, 0xDD, 0xBF, 0xF3, 0x82, 0x53\n\n\n_Listing 12: Windows Defender RC4 key_\n\nAll timestamps are uint8 integers in the Windows File Time format (Microsoft, 2018).\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 19\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n###### 2.6.1 ResourceData files\n\nResourceData files contain the actual quarantined files and the security descriptor describing the access permissions\n\nof the file.\n\nThe interesting information contained in this file is (names refer to section 2.6.1.1):\n```\n      binarysd: The binary security descriptor.\n      mal_file: The malicious file.\n\n```\n2.6.1.1 Parser definition\n\n\n**meta:**\n\n\n**id: windef_resource_data**\n\n\n**endian: le**\n\n\n**title: Windows Defender quarantine resourcedata file parser**\n\n\n**license: CC-BY-SA-4.0**\n\n\n**ks-version: 0.9**\n\n\n**doc: |**\n\n\n**Creator: Florian Bausch, ERNW Research GmbH, https://ernw-research.de**\n\n**License: CC-BY-SA-4.0 https://creativecommons.org/licenses/by-sa/4.0/**\n\n\n**seq:**\n\n```\n- id: encryptedfile\n\n```\n\n**type: rc4encrypted**\n\n\n**process: util.custom_arc4.custom_arc4(<RC4 key>)**\n\n\n**size-eos: true**\n\n\n**types:**\n\n\n**rc4encrypted:**\n\n\n**seq:**\n\n```\n- id: fixed\n\n```\n\n**contents: [0x03, 0, 0, 0, 0x02, 0, 0, 0]**\n\n\n**size: 8**\n\n```\n- id: length\n\n```\n\n**type: u4**\n\n```\n- id: padding\n\n```\n\n**size: 0x08**\n\n```\n- id: binarysd\n\n```\n\n**size: length**\n\n```\n- id: unknown1\n\n```\n\n**size: 0x08**\n\n```\n- id: len_malfile\n\n```\n\n**type: u8**\n\n```\n- id: unknown2\n\n```\n\n**size: 0x04**\n\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 20\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n```\n- id: mal_file\n\n```\n\n**size: len_malfile**\n\n\n_Listing 13: Parser definition for Windows Defender ResourceData files_\n\n###### 2.6.2 Resources files\n\nThe Resources files consist of three parts – each part encrypted individually using RC4. The first part is the header\n\ncontaining the length of the two data parts.\n\nThe first data part contains (names refer to section 2.6.2.1):\n```\n      file_id: Probably a SHA1 hashsum that also represents the file name of this Resources file and the matching\n\n```\nResourceData file.\n\nThe second data part contains:\n```\n      guid: A GUID that also represents the name of the Entries file that belongs to this Resources file.\n\n```\n2.6.2.1 Parser definition\n\n\n**meta:**\n\n\n**id: windef_resources**\n\n\n**endian: le**\n\n\n**title: Windows Defender quarantine resources file parser**\n\n\n**license: CC-BY-SA-4.0**\n\n\n**ks-version: 0.9**\n\n\n**doc: |**\n\n\n**Creator: Florian Bausch, ERNW Research GmbH, https://ernw-research.de**\n\n**License: CC-BY-SA-4.0 https://creativecommons.org/licenses/by-sa/4.0/**\n\n\n**seq:**\n\n```\n- id: header\n\n```\n\n**type: rc4encrypted_header**\n\n\n**size: 0x3C**\n\n\n**process: util.custom_arc4.custom_arc4(<RC4 key>)**\n\n```\n- id: data1\n\n```\n\n**size: header.len1**\n\n\n**type: encrypted_data1**\n\n\n**process: util.custom_arc4.custom_arc4(<RC4 key>)**\n\n```\n- id: data2\n\n```\n\n**size: header.len2**\n\n\n**type: encrypted_data2**\n\n\n**process: util.custom_arc4.custom_arc4(<RC4 key>)**\n\n\n**types:**\n\n\n**rc4encrypted_header:**\n\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 21\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n**seq:**\n\n```\n- id: magic\n\n```\n\n**size: 0x10**\n\n\n**contents: [0xdb, 0xe8, 0xc5, 0x01, 0x01, 0, 0x01, 0, 0, 0, 0, 0, 0, 0, 0, 0]**\n\n```\n- id: unknown1\n\n```\n\n**size: 0x18**\n\n```\n- id: len1\n\n```\n\n**type: u4**\n\n```\n- id: len2\n\n```\n\n**type: u4**\n\n```\n- id: unknown2\n\n```\n\n**size: 0x0C**\n\n\n**encrypted_data1:**\n\n\n**seq:**\n\n```\n- id: unknown3\n\n```\n\n**size: 0x08**\n\n```\n- id: file_id\n\n```\n\n**size: 20**\n\n```\n- id: unknown4\n\n```\n\n**size: 0x04**\n\n\n**encrypted_data2:**\n\n\n**seq:**\n\n```\n- id: guid\n\n```\n\n**type: guid**\n\n\n**guid:**\n\n\n**seq:**\n\n```\n- id: id1\n\n```\n\n**type: u4**\n\n```\n- id: id2\n\n```\n\n**type: u2**\n\n```\n- id: id3\n\n```\n\n**type: u2**\n\n```\n- id: id4\n\n```\n\n**size: 2**\n\n```\n- id: id5\n\n```\n\n**size: 6**\n\n\n_Listing 14: Parser definition for Windows Defender Resources files_\n\n###### 2.6.3 Entries files\n\nThe Entries files consist of three parts – each part encrypted individually using RC4. The first part is the header con\ntaining the length of the two data parts.\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 22\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\nThe first data part contains (names refer to section 2.6.3.1):\n```\n      guid: The GUID that is also the name of this Entries file.\n      time: First detection of this malware.\n      id11, id12, id13: The first three parts of the GUID above.\n      mal_type: The name and type of the detected malware.\n\n```\nThe second data part contains a list of entries. Each entry describing an occurrence of this specific malware:\n```\n      path: Location of the detected malicious file.\n      number_of_elements: Number of elements in the following list of properties of the malicious file.\n      typestr: Contained file in all samples.\n\n```\nList of elements: Each element contains the size and type of the encoded data and the actual data. Encoded data\n\ncan be GUIDs, timestamps, UTF-16LE strings, or integers (uint4, uint8).\n\n2.6.3.1 Parser definition\n\n\n**meta:**\n\n\n**id: windef_entries**\n\n\n**endian: le**\n\n\n**title: Windows Defender quarantine entries file parser**\n\n\n**license: CC-BY-SA-4.0**\n\n\n**ks-version: 0.9**\n\n\n**doc: |**\n\n\n**Creator: Florian Bausch, ERNW Research GmbH, https://ernw-research.de**\n\n**License: CC-BY-SA-4.0 https://creativecommons.org/licenses/by-sa/4.0/**\n\n\n**seq:**\n\n```\n- id: header\n\n```\n\n**type: rc4encrypted_header**\n\n\n**size: 0x3C**\n\n\n**process: util.custom_arc4.custom_arc4(<RC4 key>)**\n\n```\n- id: data1\n\n```\n\n**size: header.len1**\n\n\n**type: encrypted_data1**\n\n\n**process: util.custom_arc4.custom_arc4(<RC4 key>)**\n\n```\n- id: data2\n\n```\n\n**size: header.len2**\n\n\n**type: encrypted_data2**\n\n\n**process: util.custom_arc4.custom_arc4(<RC4 key>)**\n\n\n**types:**\n\n\n**rc4encrypted_header:**\n\n\n**seq:**\n\n```\n- id: magic\n\n```\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 23\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n**size: 0x10**\n\n\n**contents: [0xdb, 0xe8, 0xc5, 0x01, 0x01, 0, 0x01, 0, 0, 0, 0, 0, 0, 0, 0, 0]**\n\n```\n- id: unknown1\n\n```\n\n**size: 0x18**\n\n```\n- id: len1\n\n```\n\n**type: u4**\n\n```\n- id: len2\n\n```\n\n**type: u4**\n\n```\n- id: unknown2\n\n```\n\n**size: 0x0C**\n\n\n**encrypted_data1:**\n\n\n**seq:**\n\n```\n- id: guid\n\n```\n\n**type: guid**\n\n```\n- id: unknown3\n\n```\n\n**size: 0x10**\n\n```\n- id: time\n\n```\n\n**type: winfiletime**\n\n```\n- id: id11\n\n```\n\n**type: u4**\n\n```\n- id: id12\n\n```\n\n**type: u2**\n\n```\n- id: id13\n\n```\n\n**type: u2**\n\n```\n- id: number_of_strings\n\n```\n\n**type: u4**\n\n```\n- id: mal_type\n\n```\n\n**type: str**\n\n\n**encoding: UTF-8**\n\n\n**terminator: 0**\n\n\n**encrypted_data2:**\n\n\n**seq:**\n\n```\n- id: number_of_entries\n\n```\n\n**type: u4**\n\n```\n- id: offset\n\n```\n\n**type: u4**\n\n\n**repeat: expr**\n\n\n**repeat-expr: number_of_entries**\n\n\n**instances:**\n\n\n**entries:**\n\n\n**pos: offset[0]**\n\n\n**repeat: expr**\n\n\n**repeat-expr: number_of_entries**\n\n\n**type:**\n\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 24\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n**switch-on: _index != number_of_entries-1**\n\n\n**cases:**\n\n\n**true: entrys(_index)**\n\n\n**false: entrye**\n\n\n**types:**\n\n\n**entrys:**\n\n\n**params:**\n\n```\n- id: i\n\n```\n\n**type: u4**\n\n\n**seq:**\n\n```\n- id: entry\n\n```\n\n**size: _parent.offset[i + 1] - _parent.offset[i]**\n\n\n**type: entry**\n\n\n**entrye:**\n\n\n**seq:**\n\n```\n- id: entry\n\n```\n\n**type: entry**\n\n\n**entry:**\n\n\n**seq:**\n\n```\n- id: path\n\n```\n\n**type: null_terminated_utf16le**\n\n```\n- id: number_of_elements\n\n```\n\n**type: u2**\n\n```\n- id: typestr\n\n```\n\n**type: str**\n\n\n**encoding: UTF8**\n\n\n**terminator: 0x00**\n\n```\n- id: padding\n\n```\n\n**size: (4 - _io.pos) % 4**\n\n```\n- id: element\n\n```\n\n**type: listelement**\n\n\n**repeat: expr**\n\n\n**repeat-expr: number_of_elements**\n\n\n**null_terminated_utf16le:**\n\n\n**seq:**\n\n```\n- id: character\n\n```\n\n**type: u2**\n\n\n**repeat: until**\n\n\n**repeat-until: character[_index] == 0x0000**\n\n\n**listelement:**\n\n\n**seq:**\n\n```\n- id: length\n\n```\n\n**type: u2**\n\n```\n- id: elementsubtype\n\n```\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 25\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n**type: u1**\n\n```\n- id: elementtype\n\n```\n\n**type: u1**\n\n\n**enum: elementtypes**\n\n```\n- id: content\n\n```\n\n**size: length**\n\n\n**type:**\n\n\n**switch-on: elementtype**\n\n\n**cases:**\n\n\n**elementtypes::guid: guid**\n\n\n**elementtypes::winfiletime: winfiletime**\n\n\n**elementtypes::uint4: u4**\n\n\n**elementtypes::utf16: str_utf16le**\n\n\n**elementtypes::uint8: u8**\n\n```\n- id: padding\n\n```\n\n**size: (4 - _io.pos) % 4**\n\n\n**enums:**\n\n\n**elementtypes:**\n\n\n**0x20: utf16**\n\n**0x30: uint4**\n\n\n**0x40: guid**\n\n\n**0x50: uint8**\n\n\n**0x60: winfiletime**\n\n\n**str_utf16le:**\n\n\n**seq:**\n\n```\n- id: value\n\n```\n\n**type: str**\n\n\n**encoding: UTF-16LE**\n\n\n**size-eos: true**\n\n\n**guid:**\n\n\n**seq:**\n\n```\n- id: id1\n\n```\n\n**type: u4**\n\n```\n- id: id2\n\n```\n\n**type: u2**\n\n```\n- id: id3\n\n```\n\n**type: u2**\n\n```\n- id: id4\n\n```\n\n**size: 2**\n\n```\n- id: id5\n\n```\n\n**size: 6**\n\n\n**winfiletime:**\n\n\n**seq:**\n\n```\n- id: ts\n\n```\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 26\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n**type: u8**\n\n\n**instances:**\n\n\n**unixts:**\n\n\n**value: (ts * 1e-07) - 11644473600**\n\n\n_Listing 15: Parser definition for Windows Defender Entries files_\n\n##### 2.7 Symantec Endpoint Protection\n\nThe samples for Symantec Endpoint Protection were taken from an incident analysis. It was not possible to recover the\n\noriginal malware files from the affected system.\n\nSymantec stores quarantine data in two different files in the Quarantine directory. Per quarantined malware file,\n\nthere is a file that contains only metadata (<meta>.VBN, section 2.7.2) and a file that contains the quarantined file and\n\nmetadata (<meta>/<quarantine>.VBN, section 2.7.1). Both file names follow the schema [0-9A-F]{8}.VBN.\n\nThe Quarantine directory is located at:\n```\n    /ProgramData/Symantec/Symantec Endpoint Protection/CurrentVersion/Data/Quarantine\n\n###### 2.7.1 Quarantine file\n\n```\nThis file stores a lot of metadata – one datum that cannot be found here is the name of the detected malware –, some\n\nof it multiple times in different locations of the file. Because of this, only the most relevant information for analyses are\n\nhighlighted here (names refer to section 2.7.1.1):\n```\n      encrypted_offset: An offset to an encrypted payload of the file, which was 0x1290 in all samples.\n      filename: The file name of the original malicious file.\n      meta1: A CSV-string that contains the most important metadata of the file (Maloney, 2018, section ”Log Line”).\n      unixts1: A Unix timestamp which is a date in the future (relative to the quarantine file creation). Maybe this is\n\n```\nthe date when Symantec Endpoint Protection will permanently remove the quarantined file.\n```\n      timestamp[1-3]: Three Windows File Time (Microsoft, 2018) timestamps.\n      enc_data: The encrypted payload. This part is encrypted with a single-byte xor key (0x5A).\n\n```\nThe encrypted payload is divided into two parts (meta_entries and content_entries). Both parts contain a list of\n\nentries. An entry consists of an identifier, optionally a length field if data is encoded with variable length, and the actual\n\nencoded data:\n\nID 0x01: uint1. No length field.\n\nID 0x03: uint4. No length field.\n\nID 0x04: uint8. No length field. Is only used to store the file length of the quarantined file.\n\nID 0x06: uint4. No length field.\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 27\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\nID 0x08: Length is encoded as uint4. Contains an UTF-16LE string.\n\nID 0x09: Length is encoded as uint4. Contains a raw data stream, which itself can contain a list of entries, a\n\nchecksum, or chunks of the quarantined file.\n\nID 0x0a: uint1. No length field.\n\nWhile the meta_entries contain data like the location and the owner of the malware, the content_entries contain\n\nthe SHA1 checksum, the security descriptor and the actual malicious file content. The file content can be found by\n\nlooking for the entry with ID 0x04, which contains the file length – all following entries with ID 0x09 will contain\n\nchunks of the malware, xored with 0xFF. The maximum chunk size seems to be 0x1000 bytes.\n\n2.7.1.1 Parser definition\n\n\n**meta:**\n\n\n**id: vbn**\n\n\n**file-extension: vbn**\n\n\n**endian: le**\n\n\n**title: Symantec Endpoint Protection quarantine file parser**\n\n\n**license: CC-BY-SA-4.0**\n\n\n**ks-version: 0.9**\n\n\n**doc: |**\n\n\n**Creator: Florian Bausch, ERNW Research GmbH, https://ernw-research.de**\n\n**License: CC-BY-SA-4.0 https://creativecommons.org/licenses/by-sa/4.0/**\n\n\n**seq:**\n\n```\n- id: encrypted_offset\n\n```\n\n**type: u4**\n\n```\n- id: filename\n\n```\n\n**type: str**\n\n\n**encoding: utf-8**\n\n**terminator: 0x0**\n\n```\n- id: padding1\n\n```\n\n**size: 0x180 - _io.pos**\n\n```\n- id: padding2\n\n```\n\n**type: u4**\n\n```\n- id: meta1\n\n```\n\n**type: str**\n\n\n**encoding: utf-8**\n\n**terminator: 0x0**\n\n```\n- id: meta2\n\n```\n\n**type: str**\n\n\n**encoding: utf-8**\n\n**terminator: 0x0**\n\n```\n- id: padding3\n\n```\n\n**size: 0x980 - _io.pos**\n\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 28\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n```\n- id: padding4\n\n```\n\n**type: u4**\n\n```\n- id: unknown1\n\n```\n\n**type: u4**\n\n```\n- id: unixts1\n\n```\n\n**type: u4**\n\n```\n- id: timestamp1\n\n```\n\n**type: winfiletime**\n\n```\n- id: timestamp2\n\n```\n\n**type: winfiletime**\n\n```\n- id: timestamp3\n\n```\n\n**type: winfiletime**\n\n```\n- id: unknown2\n\n```\n\n**type: u4**\n\n```\n- id: padding5\n\n```\n\n**size: 0xb8c - _io.pos**\n\n```\n- id: threat_location\n\n```\n\n**type: str**\n\n\n**encoding: utf-8**\n\n**terminator: 0x0**\n\n```\n- id: padding6\n\n```\n\n**size: 0xbbc - _io.pos**\n\n```\n- id: unknown3\n\n```\n\n**type: u4**\n\n```\n- id: tmp_file_name\n\n```\n\n**type: str**\n\n\n**encoding: utf-8**\n\n**terminator: 0x0**\n\n```\n- id: padding7\n\n```\n\n**size: 0xd70 - _io.pos**\n\n```\n- id: unixts2\n\n```\n\n**type: u4**\n\n```\n- id: padding8\n\n```\n\n**size: encrypted_offset - _io.pos**\n\n```\n- id: enc_data\n\n```\n\n**type: encrypted_data**\n\n\n**size-eos: true**\n\n\n**process: xor(0x5a)**\n\n\n**types:**\n\n\n**encrypted_data:**\n\n\n**seq:**\n\n```\n- id: padding\n\n```\n\n**size: 8**\n\n\n**contents: [0, 0, 0, 0, 0, 0, 0, 0]**\n\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 29\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n```\n- id: meta_offset\n\n```\n\n**type: u8**\n\n```\n- id: meta_length\n\n```\n\n**type: u8**\n\n```\n- id: content_offset\n\n```\n\n**type: u8**\n\n```\n- id: content_length\n\n```\n\n**type: u8**\n\n\n**instances:**\n\n\n**meta_entries:**\n\n\n**pos: meta_offset**\n\n\n**size: meta_length**\n\n\n**type: list_of_entries**\n\n\n**content_entries:**\n\n\n**pos: content_offset**\n\n\n**size: content_length**\n\n\n**type: list_of_entries**\n\n\n**list_of_entries:**\n\n\n**seq:**\n\n```\n- id: entry\n\n```\n\n**type: entry**\n\n**repeat: eos**\n\n\n**entry:**\n\n\n**seq:**\n\n```\n- id: type_of_entry\n\n```\n\n**type: u1**\n\n```\n- id: content\n\n```\n\n**type:**\n\n\n**switch-on: type_of_entry**\n\n\n**cases:**\n\n\n**0x09: raw_content**\n\n\n**0x08: utf16le**\n\n\n**0x04: u8**\n\n**0x03: u4**\n\n**0x06: u4**\n\n**0x01: u1**\n\n**0x0a: u1**\n\n\n**raw_content:**\n\n\n**seq:**\n\n```\n- id: length\n\n```\n\n**type: u4**\n\n```\n- id: raw_content\n\n```\n\n**size: length**\n\n\n**utf16le:**\n\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 30\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n**seq:**\n\n```\n- id: length\n\n```\n\n**type: u4**\n\n```\n- id: string_content\n\n```\n\n**type: str**\n\n\n**encoding: utf-16le**\n\n\n**size: 'length > 2 ? length - 2 : length'**\n\n```\n- id: padding\n\n```\n\n**size: 2**\n\n\n**contents: [0x00, 0x00]**\n\n\n**if: 'length >= 2'**\n\n\n**winfiletime:**\n\n\n_# timestamp: timestamp * (1e-07) --> seconds_\n\n\n_# offset: 11644473600_\n\n\n**seq:**\n\n```\n- id: ts\n\n```\n\n**type: u8**\n\n\n**instances:**\n\n\n**unixts:**\n\n\n**value: (ts * 1e-07) - 11644473600**\n\n\n_Listing 16: Parser definition for Symantec Endpoint Protection quarantine files_\n\n###### 2.7.2 Metadata file\n\nThe metadata file has a structure quite similar to the quarantine file (section 2.7.1). It contains a lot of data, which is\n\nalready included in the quarantine file. It contains the name of the detected malware, which is not part of the quarantine\n\nfile. However, the payload is not encrypted. The following names refer to section 2.7.2.1:\n```\n      data_offset: The offset to the (not encrypted) payload, which was 0x1290 in all samples.\n      filename: The location of the malware.\n      meta1: A CSV-string that contains the most important metadata of the file (Maloney, 2018, section ”Log Line”).\n\n```\nThe malware name can be found here.\n```\n      data: The payload.\n\n```\nThe payload is a single list of entries which is similar to the entries in the meta_entries of the quarantine file.\n\n2.7.2.1 Parser definition\n\n\n**meta:**\n\n\n**id: vbnmeta**\n\n\n**file-extension: vbn**\n\n\n**endian: le**\n\n\n**title: Symantec Endpoint Protection quarantine metadata file parser**\n\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 31\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n**license: CC-BY-SA-4.0**\n\n\n**ks-version: 0.9**\n\n\n**doc: |**\n\n\n**Creator: Florian Bausch, ERNW Research GmbH, https://ernw-research.de**\n\n**License: CC-BY-SA-4.0 https://creativecommons.org/licenses/by-sa/4.0/**\n\n\n**seq:**\n\n```\n- id: data_offset\n\n```\n\n**type: u4**\n\n```\n- id: filename\n\n```\n\n**type: str**\n\n\n**encoding: utf-8**\n\n**terminator: 0x0**\n\n```\n- id: padding1\n\n```\n\n**size: 0x180 - _io.pos**\n\n```\n- id: padding2\n\n```\n\n**type: u4**\n\n```\n- id: meta1\n\n```\n\n**type: str**\n\n\n**encoding: utf-8**\n\n**terminator: 0x0**\n\n```\n- id: padding6\n\n```\n\n**size: data_offset - _io.pos**\n\n```\n- id: data\n\n```\n\n**type: data**\n\n\n**size-eos: true**\n\n\n**types:**\n\n\n**data:**\n\n\n**seq:**\n\n```\n- id: meta_entries\n\n```\n\n**size-eos: true**\n\n\n**type: list_of_entries**\n\n\n**list_of_entries:**\n\n\n**seq:**\n\n```\n- id: entry\n\n```\n\n**type: entry**\n\n**repeat: eos**\n\n\n**entry:**\n\n\n**seq:**\n\n```\n- id: type_of_entry\n\n```\n\n**type: u1**\n\n```\n- id: content\n\n```\n\n**type:**\n\n\n**switch-on: type_of_entry**\n\n\n**cases:**\n\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 32\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n**0x09: raw_content**\n\n\n**0x08: utf16le**\n\n\n**0x04: u8**\n\n**0x03: u4**\n\n**0x06: u4**\n\n**0x01: u1**\n\n**0x0a: u1**\n\n\n**raw_content:**\n\n\n**seq:**\n\n```\n- id: length\n\n```\n\n**type: u4**\n\n```\n- id: raw_content\n\n```\n\n**size: length**\n\n\n**utf16le:**\n\n\n**seq:**\n\n```\n- id: length\n\n```\n\n**type: u4**\n\n```\n- id: string_content\n\n```\n\n**type: str**\n\n\n**encoding: utf-16le**\n\n\n**size: 'length > 2 ? length - 2 : length'**\n\n```\n- id: padding\n\n```\n\n**size: 2**\n\n\n**contents: [0x00, 0x00]**\n\n\n**if: 'length >= 2'**\n\n\n**winfiletime:**\n\n\n_# timestamp: timestamp * (1e-07) --> seconds_\n\n\n_# offset: 11644473600_\n\n\n**seq:**\n\n```\n- id: ts\n\n```\n\n**type: u8**\n\n\n**instances:**\n\n\n**unixts:**\n\n\n**value: (ts * 1e-07) - 11644473600**\n\n\n_Listing 17: Parser definition for Symantec Endpoint Protection additional metadata files_\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 33\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n### 3 Summary & Conclusion\n\nThis whitepaper shows the structure of quarantine files of seven different anti-virus software solutions. The findings\n\n[are also documented at https://github.com/ernw/quarantine-formats/. Part of the findings are encryption keys and infor-](https://github.com/ernw/quarantine-formats/)\n\nmation what data needs to be decrypted. Furthermore, the location of timestamps, malware names, malware location\n\nand checksums is documented – this can be helpful during incident analyses to restore samples for malware analysis\n\nand identify infection timeframes.\n\nThe provided parser definition files can be used to create automated analysis tools for quarantine file analysis. Such a\n\ntool is not part of this whitepaper or the provided Github project, but can be subject of future work.\n\nWhile the creation of the documentation and parser definitions was performed with care, the limited number of samples,\n\nhowever, may have led to an incomplete understanding of the file formats. The purpose of several fields and parts of\n\ndifferent formats are still unknown and therefore named as unknown<X>.\n\nFuture incident analysis cases at ERNW Research GmbH will be used to validate and improve the findings. Additionally,\n\nthe encryption mechanism of the Sophos Antivirus quarantine files still needs to be understood. Furthermore, future\n\nwork will be required to analyze files of anti-virus software that was not yet part of the research work.\n\nParticipation in this project by providing samples or improving parser definitions and documentation is welcomed.\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 34\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n### A RC4 Helper Class in Python\n\n\n_#!/usr/bin/python3_\n\n\nclass CustomArc4(object):\n\n\ndef __init__( self, key):\n\n\nstate = [n for n in range(256)]\n\n\np = q = j = 0\n\n\nfor i in range(256):\n\n\nif len(key) > 0:\n\n\nj = ( j + state[ i ] + key[i % len(key)]) % 256\n\n\nelse:\n\n\nj = ( j + state[ i ]) % 256\n\n\nstate[ i ], state[ j ] = state[ j ], state[ i ]\n\n\nself .p = p\n\nself .q = q\n\n\nself .state = state\n\n\ndef _next_byte(self) :\n\n\nself .p = ( self .p + 1) % 256\n\n\nself .q = ( self .q + self .state[ self .p]) % 256\n\n\nself .state[ self .p], self .state[ self .q] =\\\n\n\nself .state[ self .q], self .state[ self .p]\n\n\nreturn self .state [( self .state[ self .p] + self .state[ self .q]) % 256]\n\n\ndef decode(self, plaintext ) :\n\n\nreturn bytearray([c ^ self ._next_byte() for c in plaintext ])\n\n\n_Listing 18: Helper class for RC4_\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 35\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----\n\n### B References\n\n[Carrier, B. (2009). Body file – SleuthKitWiki [https://wiki.sleuthkit.org/index.php?title=Body_file&oldid=400, accessed](https://wiki.sleuthkit.org/index.php?title=Body_file&oldid=400)\n\nApril 16th, 2020.].\n\n[conix-security. (2014). VBNExtract/extractVBN.c [https://github.com/conix-security/VBNExtract/blob/56793a3d9b860](https://github.com/conix-security/VBNExtract/blob/56793a3d9b860a374adb172528841f6dd68325d0/extractVBN.c)\n\n[a374adb172528841f6dd68325d0/extractVBN.c, accessed April 16th, 2020.]. Conix Security.](https://github.com/conix-security/VBNExtract/blob/56793a3d9b860a374adb172528841f6dd68325d0/extractVBN.c)\n\n[EICAR. (2006). EICAR – Intended Use [http://2016.eicar.org/86- 0- Intended- use.html, accessed April 16th, 2020.].](http://2016.eicar.org/86-0-Intended-use.html)\n\n_EICAR._\n\n[Glass, J. (2015). What happens when Windows Defender Quarantines Stuff... [http://jon.glass/blog/quarantines-junk/,](http://jon.glass/blog/quarantines-junk/)\n\naccessed April 16th, 2020.]. Half Full of Security.\n\n[Grant, A. (2019a). DeXRAY 2.17 update [http://www.hexacorn.com/blog/2019/11/09/dexray-2-17-update/, accessed](http://www.hexacorn.com/blog/2019/11/09/dexray-2-17-update/)\n\nApril 16th, 2020.]. Hexacorn.\n\n[Grant, A. (2019b). dexray.pl [http://hexacorn.com/d/DeXRAY.pl, accessed April 16th, 2020.]. Hexacorn.](http://hexacorn.com/d/DeXRAY.pl)\n\n[Maloney, B. (2018). Symantec Endpoint Protection VBN files [https://malwaremaloney.blogspot.com/2018/03/symante](https://malwaremaloney.blogspot.com/2018/03/symantec-endpoint-protection-vbn-files.html)\n\n[c-endpoint-protection-vbn-files.html, accessed May 17th, 2020.]. MALoney.](https://malwaremaloney.blogspot.com/2018/03/symantec-endpoint-protection-vbn-files.html)\n\n[Microsoft. (2018). File Times [https://docs.microsoft.com/en-us/windows/win32/sysinfo/file-times, accessed April](https://docs.microsoft.com/en-us/windows/win32/sysinfo/file-times)\n\n16th, 2020.]. Microsoft.\n\n[Shantz, MG. (2016). Recovering Malware from a Quarantine Folder [https://forensicdatasolutions.com/apps/blog/](https://forensicdatasolutions.com/apps/blog/show/44156381-recovering-malware-from-a-quarantine-folder)\n\n[show/44156381-recovering-malware-from-a-quarantine-folder, accessed April 16th, 2020.]. Forensic Data](https://forensicdatasolutions.com/apps/blog/show/44156381-recovering-malware-from-a-quarantine-folder)\n\n_Solutions._\n\n[Sprengler, B. (2015). quarantine.py [https://github.com/brad-sp/cuckoo-modified/blob/master/lib/cuckoo/common/](https://github.com/brad-sp/cuckoo-modified/blob/master/lib/cuckoo/common/quarantine.py)\n\n[quarantine.py, accessed April 16th, 2020.]. brad-sp.](https://github.com/brad-sp/cuckoo-modified/blob/master/lib/cuckoo/common/quarantine.py)\n\n[Unicode. (2020). FAQ - UTF-8, UTF-16, UTF-32 & BOM [https://www.unicode.org/faq/utf_bom.html, accessed May 15th,](https://www.unicode.org/faq/utf_bom.html)\n\n2020.]. Unicode.\n\nERNW Research GmbH [www.ernw-research.de](https://ernw-research.de) Page 36\n\nCarl-Bosch-Str. 4 [www.troopers.de](https://troopers.de)\n\n69115 Heidelberg [www.insinuator.net](https://insinuator.net)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/AV Tech/Analysis of Antivirus Quarantine Files.pdf"
    ],
    "report_names": [
        "Analysis of Antivirus Quarantine Files.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536168,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1611736905,
    "ts_modification_date": 1611744953,
    "files": {
        "pdf": "https://archive.orkl.eu/4746fa4e6c44ee60507d13dca7851e856308a138.pdf",
        "text": "https://archive.orkl.eu/4746fa4e6c44ee60507d13dca7851e856308a138.txt",
        "img": "https://archive.orkl.eu/4746fa4e6c44ee60507d13dca7851e856308a138.jpg"
    }
}