{
    "id": "6fed82f4-50d2-4e82-8c2a-8f7069687d30",
    "created_at": "2022-10-25T16:48:13.03117Z",
    "updated_at": "2025-03-27T02:06:09.02215Z",
    "deleted_at": null,
    "sha1_hash": "28f35f4b95e66030cf2a330bae394bbf8805b34f",
    "title": "Skeleton Key Malware Analysis",
    "authors": "Dell Secureworks",
    "file_creation_date": "2015-01-13T15:31:46Z",
    "file_modification_date": "2015-01-13T15:31:46Z",
    "file_size": 128938,
    "plain_text": "**Author: Dell SecureWorks Counter Threat Unit™ Threat Intelligence**\n\n**Date: 12 January 2015**\n\n**URL:** http://www.secureworks.com/cyber-threat-intelligence/threats/skeleton-key-malware\nanalysis/\n\n**Summary**\n\nDell SecureWorks Counter Threat Unit(TM) (CTU) researchers discovered malware that bypasses\n\nauthentication on Active Directory (AD) systems that implement single-factor (password only)\n\nauthentication. Threat actors can use a password of their choosing to authenticate as any user. This\n\nmalware was given the name \"Skeleton Key.\"\n\nCTU researchers discovered Skeleton Key on a client network that used single-factor authentication for\n\naccess to webmail and VPN, giving the threat actor unfettered access to remote access services. Skeleton\n\nKey is deployed as an in-memory patch on a victim's AD domain controllers to allow the threat actor to\n\nauthenticate as any user, while legitimate users can continue to authenticate as normal. Skeleton Key's\n\nauthentication bypass also allows threat actors with physical access to login and unlock systems that\n\nauthenticate users against the compromised AD domain controllers.\n\nThe only known Skeleton Key samples as of this publication lack persistence and must be redeployed\n\nwhen a domain controller is restarted. CTU researchers suspect that threat actors can only identify a\n\nrestart based on their inability to successfully authenticate using the bypass, as no other malware was\n\ndetected on the domain controllers. Between eight hours and eight days of a restart, threat actors used\n\nother remote access malware already deployed on the victim's network to redeploy Skeleton Key on the\n\ndomain controllers.\n\nSkeleton Key requires domain administrator credentials for deployment. CTU researchers have observed\n\nthreat actors deploying Skeleton Key using credentials stolen from critical servers, administrators'\n\nworkstations, and the targeted domain controllers.\n\n**Analysis**\n\nCTU researchers initially observed a Skeleton Key sample named ole64.dll on a compromised network\n\n(see Table 1).\n\n**Attribute** **Value or description**\n\nFilename ole64.dll\n\nMD5 bf45086e6334f647fda33576e2a05826\n\n|Attribute|Value or description|\n|---|---|\n|Filename|ole64.dll|\n\n\n-----\n\n|Compile time|2014-02-19 09:31:29|\n|---|---|\n|Deployed|As required (typically downloaded using malware and then deleted after use)|\n|File size|49664 bytes|\n|Sections|.text, .rdata, .data, .pdata, .rsrc, .reloc|\n|Exports|ii (installs the patch) uu (uninstalls the patch) DllEntryPoint (default DLL entry point)|\n\n\n_Table 1. Skeleton Key sample ole64.dll._\n\nWhen investigating ole64.dll, CTU researchers discovered an older variant named msuta64.dll on a \"jump\n\nhost\" in the victim's network (see Table 2). The jump host is any system previously compromised by the\n\nthreat actors' remote access malware. This variant includes additional debug statements, which allow the\n\nSkeleton Key developer to observe the memory addresses involved in the patching process.\n\n**Attribute** **Value or description**\n\nFilename msuta64.dll\n\nMD5 66da7ed621149975f6e643b4f9886cfd\n\nSHA1 ad61e8daeeba43e442514b177a1b41ad4b7c6727\n\nCompile time 2012-09-20 08:07:12\n\nDeployed 2013-09-29 07:58:16\n\nFile size 50688 bytes\n\nSections .text, .rdata, .data, .pdata, .rsrc, .reloc\n\ni (installs the patch)\n\nExports u (uninstalls the patch)\n\nDllEntryPoint (default DLL entry point)\n\n_Table 2. Skeleton Key sample msuta64.dll._\n\nThe threat actors used the following process to deploy Skeleton Key as a 64-bit DLL file:\n\n1. Upload the Skeleton Key DLL file to a staging directory on a jump host in the victim's network. CTU\n\nresearchers have observed three filenames associated with the Skeleton Key DLL file: ole64.dll,\n\nole.dll, and msuta64.dll. Windows systems include a legitimate ole32.dll file, but it is not related to\n\nthis malware.\n\n2. Attempt to access the administrative shares on the domain controllers using a list of stolen domain\n\nadministrator credentials.\n\n3. If the stolen credentials are no longer valid, use password theft tools to extract clear text domain\n\nadministrator passwords from one of the following locations, which suggest a familiarity with the\n\nvictim's environment:\n\n|Attribute|Value or description|\n|---|---|\n|Filename|msuta64.dll|\n|MD5|66da7ed621149975f6e643b4f9886cfd|\n|SHA1|ad61e8daeeba43e442514b177a1b41ad4b7c6727|\n|Compile time|2012-09-20 08:07:12|\n|Deployed|2013-09-29 07:58:16|\n|File size|50688 bytes|\n|Sections|.text, .rdata, .data, .pdata, .rsrc, .reloc|\n|Exports|i (installs the patch) u (uninstalls the patch) DllEntryPoint (default DLL entry point)|\n\n\n-----\n\ndomain administrators workstations\n\ntargeted domain controllers\n\n4. Use valid domain administrator credentials to copy the Skeleton Key DLL to\n\nC:\\WINDOWS\\system32\\ on the target domain controllers.\n\n[5. Use the PsExec utility to run the Skeleton Key DLL remotely on the target domain controllers using](http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx)\n\nthe rundll32 command. The threat actor's chosen password is formatted as an NTLM password hash\n\nrather than provided in clear text. After Skeleton Key is deployed, the threat actor can authenticate\n\nas any user using the threat actor's configured NTLM password hash:\n\npsexec -accepteula \\\\%TARGET-DC% rundll32 <DLL filename> ii <NTLM password hash>\n\n6. Delete the Skeleton Key DLL file from C:\\WINDOWS\\system32\\ on the targeted domain\n\ncontrollers.\n\n7. Delete the Skeleton Key DLL file from the staging directory on the jump host.\n\n8. Test for successful Skeleton Key deployment using \"net use\" commands with an AD account and the\n\npassword that corresponds to the configured NTLM hash.\n\nCTU researchers have observed a pattern for the injected password that suggests that the threat group has\n\ndeployed Skeleton Key in multiple organizations.\n\nThe use of PsExec can be detected within a Windows environment by alerting on the Windows events\n\ngenerated by the utility. The following Event IDs observed on the targeted domain controllers record the\n\nPsExec tool installing its service, starting the service, and stopping the service. These events are created\n\nevery time PsExec is used, so additional analysis of the events is required to determine if they are\n\nmalicious or legitimate:\n\nUnexpected PSEXESVC service install events (event ID 7045) on AD domain controllers:\n\nLog Name: System\n\nSource: Service Control Manager\n\nSummary: A service was installed in the system.\n\nService File Name: %SystemRoot%\\PSEXESVC.exe\n\nUnexpected PSEXESVC service start / stop events (event ID 7036) on AD domain controllers:\n\nLog Name: System\n\nSource: Service Control Manager\n\nSummary:\n\n\"The PSEXESVC service entered the running state.\"\n\n\"The PSEXESVC service entered the stopped state.\"\n\nWhen run, Skeleton Key performs the following tasks:\n\n\n-----\n\nwith 32-bit Windows versions or with Windows Server versions beginning with Windows Server\n\n2012 (6.2).\n\n6.1 (Windows 2008 R2)\n\n6.0 (Windows Server 2008)\n\n5.2 (Windows 2003 R2)\n\n2. Use the SeDebugPrivilege function to acquire the necessary administrator privileges to write to the\n\nLocal Security Authority Subsystem Service (LSASS) process. This process controls security\n\nfunctions for the AD domain, including user account authentication.\n\n3. Enumerate available processes to acquire a handle to the LSASS process.\n\n4. Obtain addresses for the authentication-related functions that will be patched:\n\nCDLocateCSystem — located in cryptdll.dll\n\nSamIRetrieveMultiplePrimaryCredentials — located in samsrv.dll\n\nSamIRetrievePrimaryCredentials — located in samsrv.dll\n\n5. Perform OS-specific adjustments using the global variable set during the compatibility check in Step\n\n1.\n\n6. Use the OpenProcess function to acquire a handle to the LSASS process.\n\n7. Reserve and allocate the required memory space to edit and patch the LSASS process's memory.\n\n8. Patch relevant functions based on the operating system:\n\nCDLocateCSystem (all compatible Windows versions)\n\nSamIRetrieveMultiplePrimaryCredentials (only Windows 2008 R2 (6.1))\n\nSamIRetrievePrimaryCredentials (all compatible Windows versions other than Windows\n\n2008 R2 (6.1))\n\nSkeleton Key performs the following steps to patch each function:\n\n1. Call the VirtualProtectEx function to change the memory protection to allow writing to the required\n\nmemory allocations (PAGE_EXECUTE_READWRITE, 0x40). This step allows the function's code\n\nto be updated in memory.\n\n2. Call the WriteProcessMemory function to change the address of the target function to point to the\n\npatched code. This change causes calls to the target function to use the patch instead.\n\n3. Restore the original memory protection by calling VirtualProtectEx with the original memory\n\nprotection flags. This step is likely to avoid suspicious writable and executable memory allocations.\n\nAfter patching, the threat actor can use the Skeleton Key password configured at the time of deployment\n\nto log in as any domain user. Legitimate users can still log in using their own passwords. This\n\nauthentication bypass applies to all services that use single-factor AD authentication, such as web mail\n\n\n-----\n\ncomputer by typing the injected password on the keyboard.\n\n**_Possible link to domain replication issues_**\n\nThe Skeleton Key malware does not transmit network traffic, making network-based detection ineffective.\n\nHowever, the malware has been implicated in domain replication issues that may indicate an infection.\n\nShortly after each deployment of the Skeleton Key malware observed by CTU researchers, domain\n\ncontrollers experienced replication issues that could not be explained or addressed by Microsoft support\n\nand eventually required a reboot to resolve. These reboots removed Skeleton Key's authentication bypass\n\nbecause the malware does not have a persistence mechanism. Figure 1 shows the timeline of these reboots\n\nand the threat actors' subsequent password theft, lateral expansion, and Skeleton Key deployment.\n\nRedeployments typically occurred within several hours to several days of the reboot.\n\n_Figure 1. Relationships of deployments and reboots observed by CTU researchers, April - July 2014._\n\n_(Source: Dell SecureWorks)_\n\n**Countermeasures**\n\nThe Skeleton Key malware bypasses authentication and does not generate network traffic. As a result,\n\nnetwork-based intrusion detection and intrusion prevention systems (IDS/IPS) will not detect this threat.\n\nHowever, CTU researchers wrote the YARA signatures in Appendix A to detect a Skeleton Key DLL and\n\nthe code it injects into the LSASS process's memory.\n\n**Threat indicators**\n\nThe threat indicators in Table 3 can be used to detect activity related to the Skeleton Key malware.\n\n**Indicator** **Type** **Context**\n\n66da7ed621149975f6e643b4f9886cfd MD5 hash Skeleton Key patch msuta64.dll\n\nad61e8daeeba43e442514b177a1b41ad4b7c6727 SHA1 hash Skeleton Key patch msuta64.dll\n\nbf45086e6334f647fda33576e2a05826 MD5 hash Skeleton Key patch ole64.dll\n\n083b1 0dd0 df 44f84 2 b d6 d92 SHA1 h h Sk l t K t h l 64 dll\n\n|Indicator|Type|Context|\n|---|---|---|\n|66da7ed621149975f6e643b4f9886cfd|MD5 hash|Skeleton Key patch msuta64.dll|\n|ad61e8daeeba43e442514b177a1b41ad4b7c6727|SHA1 hash|Skeleton Key patch msuta64.dll|\n|bf45086e6334f647fda33576e2a05826|MD5 hash|Skeleton Key patch ole64.dll|\n\n\n-----\n\n**Conclusion**\n\nThe CTU research team recommends that organizations implement the following protections to defend\n\nagainst the Skeleton Key malware:\n\nMulti-factor authentication for all remote access solutions, including VPNs and remote email,\n\nprevents threat actors from bypassing single-factor authentication or authenticating using stolen\n\nstatic credentials.\n\nA process creation audit trail on workstations and servers, including AD domain controllers, may\n\ndetect Skeleton Key deployments. Specifically, organizations should look for the following artifacts:\n\nUnexpected PsExec.exe processes and the use of the PsExec \"-accepteula\" command line\n\nargument\n\nUnexpected rundll32.exe processes\n\nProcess arguments that resemble NTLM hashes (32 characters long, containing digits 0-9 and\n\ncharacters A-F)\n\nMonitoring Windows Service Control Manager events on AD domain controllers may reveal\n\nunexpected service installation events (event ID 7045) and service start/stop events (event ID 7036)\n\nfor PsExec's PSEXESVC service.\n\n**Appendix A — YARA signatures**\n\nThe following YARA signatures detect the presence of Skeleton Key on a system, by scanning either a\n\nsuspicious file or a memory dump of Active Directory domain controllers suspected to contain Skeleton\n\nKey.\n\nrule skeleton_key_patcher\n\n{\n\nstrings:\n\n$target_process = \"lsass.exe\" wide\n\n$dll1 = \"cryptdll.dll\"\n\n$dll2 = \"samsrv.dll\"\n\n$name = \"HookDC.dll\"\n\n$patched1 = \"CDLocateCSystem\"\n\n$patched2 = \"SamIRetrievePrimaryCredentials\"\n\n\n-----\n\ncondition:\n\nall of them\n\n}\n\nrule skeleton_key_injected_code\n\n{\n\nstrings:\n\n$injected = { 33 C0 85 C9 0F 95 C0 48 8B 8C 24 40 01 00 00 48 33 CC E8\n\n4D 02 00\n\n00 48 81 C4 58 01 00 00 C3 }\n\n$patch_CDLocateCSystem = { 48 89 5C 24 08 48 89 74 24 10 57 48 83\n\nEC 20 48 8B FA\n\n8B F1 E8 ?? ?? ?? ?? 48 8B D7 8B CE 48 8B D8 FF 50 10 44 8B D8 85\n\nC0 0F 88 A5 00\n\n00 00 48 85 FF 0F 84 9C 00 00 00 83 FE 17 0F 85 93 00 00 00 48 8B\n\n07 48 85 C0 0F\n\n84 84 00 00 00 48 83 BB 48 01 00 00 00 75 73 48 89 83 48 01 00 00\n\n33 D2 }\n\n$patch_SamIRetrievePrimaryCredential = { 48 89 5C 24 08 48 89 6C 24\n\n10 48 89 74\n\n24 18 57 48 83 EC 20 49 8B F9 49 8B F0 48 8B DA 48 8B E9 48 85 D2\n\n74 2A 48 8B 42\n\n08 48 85 C0 74 21 66 83 3A 26 75 1B 66 83 38 4B 75 15 66 83 78 0E\n\n73 75 0E 66 83\n\n78 1E 4B 75 07 B8 A1 02 00 C0 EB 14 E8 ?? ?? ?? ?? 4C 8B CF 4C 8B\n\nC6 48 8B D3 48\n\n8B CD FF 50 18 48 8B 5C 24 30 48 8B 6C 24 38 48 8B 74 24 40 48 83\n\nC4 20 5F C3 }\n\n$patch_SamIRetrieveMultiplePrimaryCredential = { 48 89 5C 24 08 48\n\n89 6C 24 10\n\n\n-----\n\nC0 74 2B 49 8B\n\n40 08 48 85 C0 74 22 66 41 83 38 26 75 1B 66 83 38 4B 75 15 66 83\n\n78 0E 73 75 0E\n\n66 83 78 1E 4B 75 07 B8 A1 02 00 C0 EB 12 E8 ?? ?? ?? ?? 44 8B CF\n\n4C 8B C3 8B D6\n\n8B CD FF 50 20 48 8B 5C 24 30 48 8B 6C 24 38 48 8B 74 24 40 48 83\n\nC4 20 5F C3 }\n\ncondition:\n\nany of them\n\n}\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/elb9hgj4rvcajilnlh67kpgoskjqjra0",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2015/2015.01.12.skeleton-key-malware-analysis/Skeleton_Key_Analysis.pdf"
    ],
    "report_names": [
        "Skeleton_Key_Analysis"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716493,
    "ts_updated_at": 1743041169,
    "ts_creation_date": 1421163106,
    "ts_modification_date": 1421163106,
    "files": {
        "pdf": "https://archive.orkl.eu/28f35f4b95e66030cf2a330bae394bbf8805b34f.pdf",
        "text": "https://archive.orkl.eu/28f35f4b95e66030cf2a330bae394bbf8805b34f.txt",
        "img": "https://archive.orkl.eu/28f35f4b95e66030cf2a330bae394bbf8805b34f.jpg"
    }
}