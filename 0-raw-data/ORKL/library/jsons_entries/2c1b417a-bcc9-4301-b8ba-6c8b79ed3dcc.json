{
    "id": "2c1b417a-bcc9-4301-b8ba-6c8b79ed3dcc",
    "created_at": "2022-10-25T16:48:18.318549Z",
    "updated_at": "2025-03-27T02:07:59.998669Z",
    "deleted_at": null,
    "sha1_hash": "178576649a2a6f3b452a5f67edb73b8d8714c520",
    "title": "",
    "authors": "",
    "file_creation_date": "2022-05-10T19:08:35Z",
    "file_modification_date": "2022-07-26T14:06:25Z",
    "file_size": 1982419,
    "plain_text": "##### ICEAPPLE: A NOVEL INTERNET INFORMATION SERVICES (IIS) POST-EXPLOITATION FRAMEWORK\n\n# ICEAPPLE: A NOVEL INTERNET INFORMATION SERVICES (IIS) POST-EXPLOITATION FRAMEWORK\n\n### Understanding the threat to your IIS servers\n\n\n-----\n\n##### ICEAPPLE: A NOVEL INTERNET INFORMATION SERVICES (IIS) POST-EXPLOITATION FRAMEWORK\n\n## INTRODUCTION\n\nThe CrowdStrike Falcon OverWatch™ threat hunting team has uncovered a new and\nhighly sophisticated Internet Information Services (IIS) post-exploitation framework that\nCrowdStrike refers to as IceApple. OverWatch’s observations, explored in detail in this paper,\nsuggest that IceApple has been developed by an adversary with detailed knowledge of the\ninner workings of IIS.\n\nSince OverWatch's discovery of IceApple in late 2021, the framework has been observed in\nmultiple victim environments and in geographically distinct locations, with intrusions spanning\nthe technology, academic and government sectors. OverWatch’s investigations have identified\nat least 18 modules, each adding capabilities to the IceApple framework. OverWatch’s\nobservations suggest that this framework is still in active development.\n\nIceApple uses an in-memory-only framework that highlights the adversary’s priority of\nmaintaining a low forensic footprint on the infected host. This is typical of long-running\nobjectives aimed at intelligence collection and aligns with a targeted, state-sponsored mission.\nThough the observed targeted intrusions align with China-nexus, state-sponsored collection\nrequirements, CrowdStrike Intelligence has not attributed IceApple to a named threat actor as\nof April 2022.\n\nThis paper explores how OverWatch made its discovery, detailing both the threat hunting\nworkflows and tooling capabilities that helped uncover the exploitation framework and track its\nevolution.\n\nNext, this paper examines how the IceApple framework is being used in the wild, providing a\nhigh-level summary of its capabilities. It then provides a deep dive on the unique modules and\nhow they work.\n\nThe paper concludes with recommendations for defenders on mitigating risks to their IIS\nservers. The CrowdStrike Falcon® platform detects all currently known IceApple module loads,\nwhile OverWatch actively hunts new IceApple modules.\n\n## BACKGROUND INFORMATION\n\nInternet Information Services (IIS) is Microsoft’s extensible web server software. Its modular\narchitecture enables developers to build components that extend or replace existing server\nfunctionality. IIS components can be either native dynamic-link libraries (DLLs) typically written\nin C++, or managed modules written in C#.\n\n#### PERSISTENT IIS COMMAND EXECUTION\n\nAdversaries are known to leverage two primary techniques for achieving persistence\non compromised IIS servers: web shells[1] and malicious IIS components.[2] In OverWatch’s\n\n1 For more information, see the MITRE ATT&CK® entry, Server Software Component: Web Shell, at:\n[https://attack.mitre.org/techniques/T1505/003/](https://attack.mitre.org/techniques/T1505/003/)\n[2 For more information, see the MITRE ATT&CK entry, Server Software Component: IIS Components, at: https://attack.](https://attack.mitre.org/techniques/T1505/004/)\n\n\n-----\n\nexperience — regardless of which technique an adversary uses — the persistent component\ndeployed possesses capabilities to load additional functionality to help an adversary\nachieve their objectives. These additional functionalities are usually loaded reflectively via\nprecompiled .NET assemblies.[3]\n\n#### .NET ASSEMBLIES\n\n.NET assemblies form the cornerstone of Microsoft’s .NET framework — a cross-platform\nsoftware development framework. An assembly can function as either a standalone\napplication in the form of an EXE file or as a library for use in other applications as a DLL.\nApplications can dynamically load .NET assemblies at runtime from the Global Assembly\nCache (GAC),[4] from the local filesystem or from a byte array containing the full contents of\na compiled assembly.\n\n#### WHAT THIS MEANS FOR THREAT HUNTERS\n\nBecause .NET assemblies can be a powerful and potentially stealthy way for adversaries to\npursue their mission objectives, detections for reflective .NET assembly loads are actively\nbeing developed by OverWatch threat hunters. These detections successfully uncovered the\nIceApple post-exploitation framework being used in the wild.\n\n## HOW IS ICEAPPLE BEING USED?\n\nOverWatch observed different IceApple modules being deployed in customer environments,\nwhich varied depending on how far the compromise of an environment had progressed.\n\nWhen used shortly after an adversary gained initial access, IceApple was observed being\nrapidly deployed to multiple hosts to facilitate credential harvesting from local and remote\nhost registries, credential logging on OWA servers, reconnaissance, and data exfiltration.\nOverWatch then observed adversaries returning to networks daily to continue their activity.\n\nWhen used after an adversary had prolonged access to an environment, IceApple was\nobserved being deployed to assist with credential harvesting and basic local reconnaissance.\nOverWatch observed adversaries in these instances returning every 10 to 14 days, likely as a\nmeans of ensuring access was maintained.\n\n## HOW DID OVERWATCH DISCOVER ICEAPPLE?\n\n#### THE INITIAL TRIGGER\n\nIn late 2021, one of OverWatch’s in-development detections for reflective .NET assembly\nloads was triggered on a customer’s Microsoft Exchange OWA server. OverWatch initially\ndetected four .NET assemblies being reflectively loaded into the “MSExchangeOWAAppPool”\n\n[3 For more information, see the MITRE ATT&CK entry, Reflective Code Loading, at: https://attack.mitre.org/techniques/](https://attack.mitre.org/techniques/T1620/)\n[T1620/](https://attack.mitre.org/techniques/T1620/)\n[4 For more information on the Global Assembly Cache, see: https://docs.microsoft.com/en-us/dotnet/framework/app-](https://docs.microsoft.com/en-us/dotnet/framework/app-domains/gac)\n\n\n-----\n\napplication pool on two Microsoft Exchange servers with the following names:\n\n\u0007App_Web_6nj14khm, Version=0.0.0.0, Culture=neutral,\n\nPublicKeyToken=null\n\u0007App_Web_06y3iviz, Version=0.0.0.0, Culture=neutral,\n\nPublicKeyToken=null\n\u0007App_Web_sbp8l0mc, Version=0.0.0.0, Culture=neutral,\n\nPublicKeyToken=null\n\u0007App_Web_ic8e5fk4, Version=0.0.0.0, Culture=neutral,\n\nPublicKeyToken=null\n\nAt first glance, these assemblies appear to be expected IIS temporary files generated as\npart of the process of converting Active Server Page Extended (ASPX) source files into .NET\nassemblies for IIS to load.\n\nHowever, on closer analysis, OverWatch deemed the activity suspicious for three reasons:\n\n1. IIS does not reflectively load its generated temporary .NET assemblies from byte arrays.\n2. Microsoft Exchange does not reflectively load its .NET assemblies from byte arrays.\n3. \u0007The last eight characters of IIS temporary file names are randomly generated; however, the\n\nsame four .NET assembly names were seen on both hosts multiple times.\n\n_Figure 1. Temporary .NET assemblies generated by IIS and their randomly generated internal_\n_assembly’s name_\n\n#### DIGGING DEEPER\n\nOverWatch worked with the customer to turn on the Script-Based Execution\nMonitoring prevention policy setting to enable the CrowdStrike Falcon sensor to\nextract the content of reflectively loaded .NET assemblies across the customer’s endpoints,\nincreasing visibility.\n\nAfter making these changes, OverWatch’s reflectively loaded .NET assembly detection\ntriggered again for the same four .NET assemblies (referenced above) being loaded on the\noriginal hosts. With Script-Based Execution Monitoring enabled, OverWatch\nwas able to retrieve and analyze the contents of the .NET assemblies.\n\n#### LEVERAGING THE POWER OF THE FALCON PLATFORM\n\nAn analyst is only as good as their tools. Before diving into the contents of the loaded\nassemblies, it is important to look at what the Falcon sensor captures in regard to reflectively\nloaded .NET assemblies and how OverWatch uses this information to provide its customers\n\n\n-----\n\nThe Falcon sensor gives customers two key events for analyzing reflectively loaded .NET\nassemblies: ReflectiveDotnetModuleLoad, which provides the name of the .NET\nassembly loaded, and ScriptControlScanTelemetry,[5] which provides the bytes of the\n.NET assembly loaded.\n\nThe AssemblyName field from the ReflectiveDotnetModuleLoad event is very useful\nfor developing detections for common .NET tools that are downloaded from GitHub and\nthen compiled and used in an attack without changing the assembly’s name. For example,\nif two different adversaries download and compile Rubeus,[6] the resulting DLL’s hashes will\nbe different; however, their assembly names will still be Rubeus, Version=1.0.0.0,\nCulture=neutral, PublicKeyToken=null. Detections based on .NET assembly\nnames, much like detections based on hashes, are very brittle, as with minimal effort\n\nRubeus, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null\ncan become TotallyLegit, Version=1.3.3.7, Culture=neutral,\nPublicKeyToken=null and bypass detection.\n\nThe ScriptContentBytes field from the ScriptControlScanTelemetry event\ncontains the ASCII representation of the bytes being reflectively loaded. This ASCII string\nof hex data can be taken from Falcon Insight™ endpoint detection and response (EDR) and\neasily converted to the raw bytes of the .NET assembly, using open source tools like Cyber\nChef.[7] That converted data can then be loaded into a .NET decompiler, like dnSpy,[8] and further\nanalyzed.\n\n_Figure 2. Falcon Insight showing the IceApple Loader module being loaded_\n\n5 ScriptControlScanTelemetry events will only be generated if “Script-Based Execution Monitoring” is enabled in the\nFalcon UI.\n\n\n-----\n\nWhen developing detections for reflectively loaded .NET activity, OverWatch typically\nuses a combination of regular expressions on assembly names as well as the presence of\na reflective .NET load occurring under an application or IIS application pool that does not\ntypically perform this sort of operation. Analysis of ScriptContentBytes (payload\nbytes) is reserved for confirmation of maliciousness following the initial detection.\n\n## A CLOSER LOOK AT ICEAPPLE\n\nNext, let’s explore the 18 IceApple modules that OverWatch has observed to date. These\nmodules support a wide range of capabilities, including:\n\n\u0007Listing directories\n\u0007Writing data to a file\n\u0007Deleting files and directories\n\u0007Retrieving the configuration of installed network adapters\n\u0007Making HTTP requests with the hard-coded user agent Microsoft Office/16.0 (Windows\n\nNT 10.0; Microsoft Outlook 16.0.4551; Pro)\n\u0007Retrieving IIS server variables\n\u0007Dumping credentials stored in registry keys on the infected host or a remote host\n\u0007Executing queries against Active Directory\n\u0007“Normal” exfiltrating of files\n\u0007Special exfiltration of files — including large files and several files at a time — via\n\na separate HTTP listener\n\u0007Capturing OWA credentials\n\nREQUEST\n\nLoader\n\nLoader\n\nSerialized\n\ntasks\n\nMore tasks? Yes Deserialize task Process task\n\nNo\n\nCompressed, encrypted\n\nResult retriever Returned to adversary\n\nencoded task output\n\n_Figure 3. Tasking deserialization and processing flowchart_\n\n\n-----\n\n#### MODULE 1: APP_WEB_IC8E5FK4 — LOADER\n\n_Loader is the core of the IceApple framework and is the second most complex assembly_\ndetailed in this paper. OverWatch believes this assembly is loaded via a webshell, which\nreflectively loads Loader and calls its single function, C(). The C() function performs\nthe remainder of the functionality in this assembly.\n\n_Loader has several processes that it undertakes for each request._\n\n**Initialization**\n\n_Loader starts its execution by initializing several variables that are used in processing_\nrequests:\n\n_Figure 4. Hard-coded values — the variable names have been modified to reflect their purpose_\n\n\u0007keyName:The key name to use when storing and retrieving application-level variables\n\u0007prehooks:The key name for a secondary application-level storage location\n\n(OverWatch has not observed this value being used)\n\u0007typeName:The internal type name for all .NET assemblies to be reflectively loaded;\n\nthis is used to prevent Loader from having to try and determine the assembly type\ninformation at runtime\n\u0007aesKey:A Base64-encoded AES key used to decrypt tasking\n\u0007validationString:Used to validate inbound parameter names\n\nNext, Loader creates a key/value store containing all of the information needed by future\nmodules. This key/value store, which OverWatch renamed to config in Figure 5, is the\nonly parameter passed to any of the modules observed during our investigation.\n\n_Figure 5. Creation of a key/value store for processing modules_\n\nThe key/value store comprises:\n\n\u0007GS:Contains the global store, a key/value store for caching loaded modules for future\n\nuse\n\u0007PH:Contains the prehooks key/value store\n\u0007HC:Contains the current HTTP context for this request, which can be used to retrieve\n\na large amount of information about the request including header, parameters, cookies\n\n\n-----\n\n\u0007RS:Contains a list of byte arrays. All uses of this value suggest that modules use RS as a\n\nresult store for their output. As such, RS will be referred to as the result store. The result\nstore is cleared at the beginning of each request, meaning any results not retrieved at the\nend of the previous request will be lost.\n\n\u0007ED:The purpose of this value is unknown.\n\n\u0007AB:This value is populated with the decrypted parameters for a module prior to it being\n\ncalled.\n\n**Extract and Decrypt Tasking**\n\n_Loader loops over all parameters and performs several checks on their values, including_\nverifying that the value is longer than five characters and that the first five characters exist\nin the validationString variable discussed in the initialization section above. The\nvalue of all parameters that meet these criteria are appended together before moving onto\nthe next step.\n\n​\n\n_Figure 6. Documented parameter extraction code_\n\nWith the values of all parameters processed, Loader Base64-decodes then AESdecrypts (using the previously mentioned hard-coded AES key and the first 16 bytes of the\nBase64-decoded value as an initialization vector [IV]). Next, Loader Gzip-decompresses\nthe extracted parameters. This process results in a value that contains all tasking and\nparameters serialized with a custom algorithm, discussed next.\n\n\n​\n\n\n-----\n\nNo\n\n`encodedParams` Base64 decode AES decode\n\n_Figure 7. Parameter extraction and processing flowchart_\n\n**Deserialization and Execution**\n\nThe final stages that Loader completes are deserialization and execution of the serialized\ntasking. The serialized value can (and generally does) contain multiple tasks.\n\nThe serialization method used appears to be custom — albeit basic — and consists of a\nrepeated pattern of 4 bytes containing the length in bytes of the proceeding value. For\nexample, the following shows how the value “OverWatch” would be serialized:\n\n_Figure 8. Example serialization of the value “OverWatch”_\n\nUsing this method, Loader deserializes tasks with the following format:\n\n_Figure 9. Task format_\n\n\u0007keyName and tag are joined to form a unique key, which is used to cache loaded\n\nassemblies for additional requests.\n\u0007assemblyBytes contains raw bytes to be reflectively loaded via Assembly.\n\nLoad().\n\u0007assemblyParams contains a byte array, which is stored in the AB value of the config\n\nkey/value store. This value contains the parameters for the module being loaded and\ncould contain anything from a string to a byte array. Extracting of parameters from this\nvalue is performed by each module.\n\n\n-----\n\nAfter deserializing a task, Loader uses the values keyName and tag to see if the module\nneeded for this task is already loaded and stored in the GlobalStore.\nIf the assembly is not found, then Loader reflectively loads the raw bytes from\nassemblyBytes in the task and stores the resulting assembly in the GlobalStore for\nfuture use. Regardless of whether the assembly was found in the GlobalStore or newly\nloaded, Loader then executes the Equals() method of the target assembly, passing\nconfig as a parameter.\n\nOnce a task has been processed, Loader proceeds to deserialize and execute the next task\nuntil all tasks are complete.\n\nIt is worth noting that the only time Loader will produce an output is if an exception is\nthrown outside of a task. All outputs from tasks are processed and returned by the\nApp_Web_paeld9n9 Result Retriever module detailed in the Module 2 section.\n\n#### UNDERSTANDING THE MODULE STRUCTURE\n\nBefore discussing the rest of the modules observed by OverWatch, it is helpful to\nunderstand the structure and initialization common to all modules.\n\n_Figure 10. An example of a module’s initialization_\n\nAll modules observed consist of a class named C under a namespace of N; however, the\ntypeName field discussed in the Loader module suggests this could be easily changed.\n\nEach module overrides the Equals function of the Object class, with Object\nbeing the base .NET class all other classes are derived from. The Equals function takes\na single parameter of type Object (effectively allowing any value which subclasses\nObject to be passed in).\n\nThe use of the Equals function to execute code within a reflectively loaded .NET\nassembly is novel and allows Loader to call this function within any module without having to\nknow anything about the structure of the module, its internal functions or what parameters\nit takes.[9]\n\n9 For more information, see the relevant documentation at:\n\n\n-----\n\nThe passed-in parameter of type Object is first cast to a Hashtable to recover the\nconfig key/value store described above. Next, the value of RS (or the result\nstore) is extracted from config and converted to a List of byte arrays. The result store\nmay already contain results from a previously executed task.\n\nThe value of AB is extracted from config as a byte array. As mentioned, AB contains\nthe parameters for the current module and may have a different meaning for each module.\nIn this example, AB represents a UTF-8 encoded string that is delimited with a pipe (“|”)\ncharacter.\n\n#### MODULE 2: APP_WEB_PAELD9N9 — RESULT RETRIEVER\n\nThe Result Retriever module is responsible for the serialization, compression, encryption\nand transmission of the results of all other modules.\n\nResults are serialized using the method described in Loader before being Gzipcompressed, AES-encrypted and Base64-encoded. Results are then sent as a response to\nthe original tasking request, which suggests that Result Retriever is called as the final task\nfor each series of requests. Results are returned via one of three methods based on the\namount of data being returned.\n\n**Methods**\n\n**Method 1 — Cookie: Response data is sent as the value for a custom cookie, the name of**\nwhich is controlled by the adversary.\n\n**Method 2 — Header: Response data is sent as the value for a custom header, the name of**\nwhich is controlled by the adversary.\n\n**Method 3 — Body: Response data is sent in the body of the request, wrapped in an**\nadversary-specified template.\n\n**Parameters**\n\n_Result Retriever accepts a pipe-delimited string that is split into an array where each field_\nhas the following purpose:\n\n|Index 0|Purpose Base64-encoded AES key|\n|---|---|\n|1|HTTP response code to send with response|\n|2|A URL to redirect to if the HTTP response code is 3xx|\n|3|The maximum response size supported by Response Method 1|\n|4|The name of the cookie to send the response in for Response Method 1|\n|5|The maximum response size supported by Response Method 2|\n|6|The name of the header to send the response in for Response Method 2|\n|7|The body of the response to send when using Response Method 1 or 2|\n|8|The body of the response to send when using Response Method 3; must contain the value “{{{DATA}}}”, which will be replaced with the encoded response data to return|\n|9|A value to be prepended to the Base64-encoded results for all response methods|\n|10|A value to be appended to the Base64-encoded results for all response methods|\n\n\n-----\n\n#### MODULE 3: APP_WEB_06Y3IVIZ — A PREVIOUS VERSION OF MODULE 2\n\nOverWatch observed a previous version of the Result Retriever module with the assembly\nname App_Web_06y3iviz, which used hard-coded values rather than accepting the\nabove parameters.\n\nOf note, Method 1 responses were sent via a cookie named X-BackEndCookies with\nthe value As7 prepended to the value returned. In addition, the status code is always\n302 with a redirect header to the OWA login page. Method 2 is not present in the previous\nversion. Method 3 embeds the response in a fake stack trace and redirects to the OWA\nerror page.\n\n_Figure 11. Previous version of Result Retriever_\n\n\n-----\n\n#### MODULE 4: APP_WEB_YBRA1DR2 — DIRECTORY LISTER\n\nThe Directory Lister module lists information about a list of files and directories including:\n\n\u0007Creation time\n\u0007Last write time\n\u0007Name\n\u0007Size\n\n_Directory Lister differs from other IceApple modules in that it performs parameter extraction_\nin the Equals function before calling a second function named Run, which contains the\nmodule's functionality.\n\n**Parameters**\n\nAccepts a pipe-delimited list of files and directories to list.\n\n#### MODULE 5: APP_WEB_8MYTEDC8 — ANOTHER VERSION OF MODULE 4\n\nOverWatch observed an older version of Directory Lister with the assembly name\nApp_Web_8mytedc8 that uses the Equals function for both parameter extraction\nand module functionality. App_Web_8mytedc8 is functionally identical to Directory Lister.\n\n#### MODULE 6: APP_WEB_HP8VZZB4 — FILE WRITER\n\nThe File Writer module writes a byte array to a file.\n\n**Parameters**\n\nThe passed-in parameter contains a serialized filename followed by raw bytes to be written\nto the target file.\n\n**Index** **Purpose**\n\n**0** Filename\n\n**1** Bytes to write\n\n#### MODULE 7: APP_WEB_CFZLQTLR — FILE AND DIRECTORY DELETER\n\nThe File and Directory Deleter module deletes files and folders.\n\n**Parameters**\n\nA pipe-delimited string of paths to delete.\n\n#### MODULE 8: APP_WEB_67VHAQFF — IFCONFIG\n\nThe ifconfig module iterates over all network interfaces on the host and retrieves the\nfollowing information:\n\n\u0007Name\n\n|Index 0|Purpose Filename|\n|---|---|\n|1|Bytes to write|\n\n\n-----\n\n\u0007MAC address\n\u0007DNS suffix\n\u0007DNS servers\n\u0007Gateways\n\u0007IPv4 addresses\n\u0007Subnet masks\n\n#### MODULE 9: APP_WEB_S8X7GRB2 — HTTP GET\n\n_HTTP Get (internally named httpget based on error strings) allows the adversary_\nto make basic HTTP requests with no custom parameters or headers except for the\nhard-coded User Agent value of Microsoft Office/16.0 (Windows NT 10.0;\nMicrosoft Outlook 16.0.4551; Pro). After completing a request, HTTP Get\npulls information such as the response code, response headers and response content, and\nreconstructs the response as a string suitable for retrieval by the adversary.\n\n**Parameters**\n\nA single UTF8-encoded string containing the URL to request.\n\n#### MODULE 10: APP_WEB_F46V5OKG — SERVER VARIABLE DUMPER\n\nThe Server Variable Dumper module iterates over all server variables present for the current\nrequest and returns them to the adversary.\n\n#### MODULE 11: APP_WEB_6NJ14KHM — CREDENTIAL DUMPER\n\nThe Credential Dumper module allows the adversary to dump the contents of registry keys\nthat contain encrypted credentials, as well as the keying material required to decrypt them.\nThese keys can be dumped from a local or remote host.\n\nThe following keys contain encrypted password hashes as well as the keying material\nneeded to calculate the bootkey (i.e., decryption key) needed to decrypt these password\nhashes:\n\nHKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\JD\nHKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\Skew1\nHKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\GBG\nHKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\Data\nHKLM\\SAM\\SAM\\Domains\\Account\\F\nHKLM\\SAM\\SAM\\Domains\\Account\\Users\\*\\V\nHKLM\\SECURITY\\Cache\\*\n\nThe following keys are associated with Local Security Authority (LSA) secrets:\n\nHKLM\\SECURITY\\Policy\\PolEKList\\default\nHKLM\\SECURITY\\Policy\\Secrets\\*\\CurrVal\nHKLM\\SECURITY\\Policy\\Secrets\\*\\OldVal\n\nThe type of keys dumped are controlled by parameters 1-N.\n\n\n-----\n\n**Parameters**\n\n_Credential Dumper accepts a pipe-delimited string that is split into an array where each field_\nhas the following purpose:\n\n**Index** **Purpose**\n\n**0** Host to dump (localhost or a remote host name)\n\n**1-N** Strings from the following set: “secrets”, “cache”, “samaccount”\n\n#### MODULE 12: APP_WEB_AI57ZS2M — ANOTHER VERSION OF MODULE 11\n\nOverWatch observed another version of Credential Dumper with the assembly name\nApp_Web_ai57zs2m that has minor differences. App_Web_ai57zs2m does not\ninclude an Equals function, instead placing the logic in the assemblies’ constructor.\nWhile this assembly would still work with Loader, it could not be recalled from the Global\nStore as its Equals function has not been overwritten.\n\nThis version of the assembly also does not utilize the result retrieval method of other payloads\nobserved in this framework. Instead, results are Base64-encoded and wrapped in “junk”\n(unused) JavaScript and written to four locations under the Microsoft Exchange install location:\n\n\u0007\\ClientAccess\\Owa\\auth\\addrbook.cs\n\n\u0007\\ClientAccess\\Owa\\auth\\addrbook.js\n\n\u0007\\FrontEnd\\HttpProxy\\owa\\auth\\Current\\scripts\\premium\\\n\naddrbook.cs\n\n\u0007\\FrontEnd\\HttpProxy\\owa\\auth\\Current\\scripts\\premium\\\n\naddrbook.js\n\n#### MODULE 13: APP_WEB_SBP8L0MC — ACTIVE DIRECTORY QUERIER\n\nThe Active Directory Querier module provides an interface for an adversary to perform\nauthenticated requests against an Active Directory server.\n\n**Parameters**\n\n_Active Directory Querier accepts a byte array containing several strings serialized using the_\npreviously described method. The order and purpose of the serialized strings is set out below:\n\n**Index** **Purpose**\n\n**0** The Active Directory directory to open\n\n**1** Username\n\n**2** Password\n\n**3** Authentication type[10]\n\n**4** Search filter\n\n**5** Search scope[11]\n\n**6** A pipe-delimited list of properties to return\n\n[10  For more information, see the relevant documentation at: https://docs.microsoft.com/en-us/dotnet/api/system.](https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.authenticationtypes)\n[directoryservices.authenticationtypes](https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.authenticationtypes)\n[11 For more information see the relevant documentation at: https://docs microsoft com/en-us/dotnet/api/system](https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.searchscope)\n\n|Index 0|Purpose Host to dump (localhost or a remote host name)|\n|---|---|\n|1-N|Strings from the following set: “secrets”, “cache”, “samaccount”|\n\n|Index 0|Purpose The Active Directory directory to open|\n|---|---|\n|1|Username|\n|2|Password|\n|3|Authentication type10|\n|4|Search filter|\n|5|Search scope11|\n|6|A pipe-delimited list of properties to return|\n\n\n-----\n\n#### MODULE 14: APP_WEB_ZM5IVGUM — QUERY2FILE\n\nThe query2file module is another version of Active Directory Querier, which is functionally\nthe same as Module 13; however, query2file appears to have been slightly reworked to\nsupport long-running queries.\n\nWhen called, query2file creates a string called threadControlEnvPrefix with the\nformat LDAP_QUERY2FILE_{0}_ where {0} is replaced with the current time in UTC,\nformatted with the string yyMMddHHmmss. threadControlEnvPrefix is prepended to\nseveral environment variables used to control and check the status of running searches.\n\n_query2file starts a new thread that performs all other actions while the main thread returns_\nthe managed thread ID and the value of threadControlEnvPrefix via the previously\ndiscussed result retrieval means.\n\nIn addition to the seven parameters described, query2file accepts a file path to output\nresults, which can be either a regular file path or a special path beginning with memfs://,\nthe use of which will cause results to be stored in a memfs entry in the Global Store.\n\n#### MODULE 15: APP_WEB_NITM6AXL — FILE EXFILTRATOR\n\nThe File Exfiltrator module allows for a single file to be exfiltrated from the target host. The\noutput of this module consists of the target host’s hostname and the target file's contents,\nserialized using the previously discussed method.\n\n**Parameters**\n\nA single UTF8-encoded string containing the path of the file to exfiltrate.\n\n#### MODULE 16: APP_WEB_UGRFVUDI — MULTI FILE EXFILTRATOR\n\nThe Multi File Exfiltrator module allows for multiple files to be encrypted, compressed and\nexfiltrated. This module functions slightly differently than other modules. When run, Multi File\n_Exfiltrator creates a HttpListener, which allows it to handle requests to URLs matching an_\nadversary-specified pattern on the target server. All other usage of this module is triggered\nvia requests to this listener.\n\nWhen a new request is received, the registered handler first checks if the requested URL\nends with /stop. If it does, Multi File Exfiltrator stops the HttpListener, preventing further\nhandling of requests.\n\nNext, the module extracts all headers, request parameters and key value pairs defined\nin the request input. It sorts them alphabetically based on their key and identifies “valid”\nparameters by looking for the presence of the first five characters of each key’s associated\nvalue in the hardcoded string KAJdPY30h1e7jSKpcDUivBkZiGUAH3zL, much like\n_Loader’s parameter validation method._\n\nThese parameters are concatenated, Base64-decoded, Gzip-decompressed and\ndeserialized to recover the name of the file to exfiltrate. Finally, the contents of the target file\nare read, XOR’ed with the key 3hu5njdushydf7^ATSD&y3gbhyrbgyusag%^A&Dt,\nGzip-compressed and written back as an HTTP response.\n\n\n-----\n\n#### MODULE 17: APP_WEB_XW4CRB70 — IIS MODULE LISTER\n\n_IIS Module Lister and OWA Credential Logger (see Module 18 below)_ have always been\nobserved together. OverWatch suspects that IIS Module Lister is used to dump some values\nneeded to load OWA Credential Logger and to verify that OWA Credential Logger successfully\nregistered an event handler, which is described below.\n\n_IIS Module Lister uses reflection to gain access to several internal fields within the “System.Web”_\nassembly, through which it can extract the details of all registered IIS modules, including the\nevents within the IIS request processing pipeline they are registered to receive callbacks for.\n\n_Figure 12. An example of IIS Module Lister’s output_\n\nFinally, three numbers are output, which OverWatch believes are the three numbers OWA\n_Credential Logger takes as its parameters._\n\n_Figure 13. An example of the three numbers returned by IIS Module Lister_\n\n#### MODULE 18: APP_WEB_3OQT6248 — OWA CREDENTIAL LOGGER\n\nThe OWA Credential Logger module shows the depth of this adversary’s knowledge of IIS and\nis the most complex IceApple module observed by OverWatch to date. Its purpose is to look\nfor and log OWA credentials.\n\nThis module monitors for request handlers that are waiting to be used and preemptively injects\nan event handler into them. This allows the adversary to run some code whenever a request\nis accepted. When a request is received, OWA Credential Logger checks to see if it is an OWA\n\n\n-----\n\nauthentication request and if so, logs the credentials.\n\nWhen run, OWA Credential Logger starts a new processing thread before returning a\nsuccess message. The processing thread initially uses reflection to acquire two key\nreferences from System.Web.HttpApplicationFactory:\n\n\u0007_theApplicationFactory: A static variable used to hold the instance of\n\nHttpApplicationFactory, which manages the creation and deletion of all\nHttpApplication objects needed to handle requests under this IIS worker instance\n\n\u0007_freeList: A collection of HttpApplication objects that have been recycled and\n\nare ready for reuse\n\nWith the references acquired, the processing thread starts a loop that executes every\nthree seconds as long as the environment variable MODULESTEPS_OWALOGIN_THREAD_STOP\ndoes not exist. On each iteration of the loop, the HttpApplication values in _freeList\nare iterated over, and for each one, a new EventHandler is inserted for the adversary’s\ndesired event if one is not already present.[12]\n\nWhenever the registered event handler fires, it checks that:\n\n\u0007  The requested path is /owa/auth.owa.\n\n\u0007The username field is set.\n\n\u0007The password field is set.\n\nIf the three conditions above are met, then the values of username and password are\nwritten to C:\\\\Windows\\\\Temp\\\\TS_MSOL1.tmp.\n\n**Parameters**\n\n_OWA Credential Logger accepts a pipe-delimited string consisting of three numbers where_\neach number is used as an offset into an array acquired through reflection to determine if an\nevent handler should be added.\n\n12 For more information, see the relevant documentation at:\n\n\n-----\n\n## TIMELINE\n\nThe following timeline shows the build timestamps for each of the 18 modules discussed in\nthis paper. This shows the progression of the IceApple framework over the past year and\nsuggests that IceApple remains under active development.\n\n               - 05/19/2021 14:53:36 UTC App_Web_ic8e5fk4.dll - Loader\n\n\nJune 2021\n\n\nOctober 2021\n\n\nFebruary 2022\n\n\n\n- 06/14/2021 07:55:52 UTC App_Web_06y3iviz.dll - File Writer\n\n- 06/14/2021 07:56:22 UTC App_Web_hp8vzzb4.dll - Active Directory Querier\n\n- 06/14/2021 07:56:30 UTC App_Web_sbp8l0mc.dll - ifconfig\n\n- 06/14/2021 07:56:37 UTC App_Web_67vhaqff.dll - Result Retriever v1\n\n- 08/01/2021 08:04:41 UTC App_Web_xw4crb70.dll - OWA Credential Logger\n\n- 08/01/2021 09:11:18 UTC App_Web_3oqt6248.dll - IIS Module Lister\n\n- 09/27/2021 03:21:29 UTC App_Web_f46v5okg.dll - Server Variable Dumper\n\n- 10/01/2021 07:44:40 UTC App_Web_6nj14khm.dll - Credential Dumper\n\n- 10/10/2021 10:31:41 UTC App_Web_cfzlqtlr.dll - File and Directory Deleter\n\n- 10/12/2021 09:33:16 UTC App_Web_s8x7grb2.dll - HTTP Get\n\n- 10/17/2021 08:36:23 UTC App_Web_ugrfvudi.dll - Multi File Exfiltrator\n\n- 10/27/2021 04:41:39 UTC App_Web_zm5ivgum.dll - query2file\n\n- 02/10/2022 02:47:48 UTC App_Web_8mytedc8.dll - Directory Lister\n\n- 02/11/2022 09:08:00 UTC App_Web_paeld9n9.dll - Result Retriever v2\n\n- 02/18/2022 03:13:00 UTC App_Web_nitm6axl.dll - File Exfiltrator\n\n- 03/10/2022 08:31:21 UTC App_Web_ai57zs2m.dll - Credential Dumper v2\n\n- 04/22/2022 10:27:01 UTC App_Web_ybra1dr2.dll - Directory Lister v2\n\n\n_Figure 14. Timeline of IceApple module development_\n\n\n-----\n\n## THE BEST DEFENSE IS A GOOD DEFENSE\n\nAt its core, IceApple is a post-exploitation framework focused on increasing an adversary’s\nvisibility of a target through acquisition of credentials and exfiltration of data. None of the\nmodules observed by OverWatch provides exploitation or lateral movement capabilities.\nAs such, the best defense is to protect web applications from malicious access through\nsound processes to maintain good baseline security, effective technology to prevent known\nthreats, and proactive human-led hunting to identify unknown and emerging threats.\n\nOverWatch has only observed IceApple being loaded into application pools associated with\nMicrosoft Exchange; however, it is capable of running under any IIS web application.\nTherefore, ensuring all web applications are regularly and fully patched is critical to preventing\nIceApple from ending up in your environment. Technology is also an important part of the\nequation, and the Falcon platform detects all currently known IceApple module loads.\n\nFinally, threat hunting is a crucial piece of the defensive puzzle when it comes to novel and\nstealthy adversary tools like IceApple. Hunters draw on their extensive experience of what\n“normal” looks like in enterprise environments, knowledge of adversary behavior, and upto-the-minute threat intelligence to preempt possible threats. This feeds the development\nand testing of hypotheses that enhance the hunt and curtail adversary attempts to evade\ntechnology-based defenses.\n\n## CONCLUSION\n\nIceApple is a highly sophisticated IIS post-exploitation framework — however, it is by\nno means the only one. OverWatch regularly identifies new reflectively loaded .NET\nassemblies of various levels of sophistication, ranging from basic wrappers around\nWindows utilities such as WMI to highly modularized and well-engineered frameworks with\nmultiple levels of encryption protecting data in transit and between modules. While many of\nthe assemblies observed by OverWatch are only seen in a customer’s environment once\nand then never again, a few — such as IceApple — continue to be reused on target networks\nwhile showing signs that they are in active development.\n\n\n-----\n\n## INDICATORS OF COMPROMISE\n\n|SHA256 3514c8f0b6992a4b3746d874013789b8bd3e9ff4a44f0 0f5d076320e6a403136|Assembly Name App_Web_ic8e5fk4, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module Module 1: Loader|\n|---|---|---|\n|b6379b98f0993c652fd0c5907395123cfb14fa30818d3 153b7655def8329c4c1|App_Web_paeld9n9, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 2: Result Retriever|\n|517d08fdf b2889e11a86b7a011de385dc43623f80f6fdf4 3e55b683c08206228|App_Web_06y3iviz, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 3: Result Retriever Variant|\n|3e72696d5618f013cd8fd686c11f9778ac55ce1ca61f5dd 6c5b86b917495bde2|App_Web_8mytedc8, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 4: Directory Lister|\n|cf9b151e116ee1429d2fcd3553c90d98a73a4d769f97675 9e60d8113a7d8229c|App_Web_ybra1dr2, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 5: Directory Lister Variant|\n|648592597b561c775feb8909148b91bd2e8452ab3b2c1 e98ead2c4f9caf2e3ff|App_Web_hp8vzzb4, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 6: File Writer|\n|131c7d2ec3c7dba738466a586aca4bd80af540832b124 3ace184918db65ee7e5|App_Web_cfzlqtlr, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 7: File and Directory Deleter|\n|075a8456f3d74da6f830bcae39990f43e4aef63c0a69e a2f5a5e1eb8ba51b51e|App_Web_67vhaqf,f Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 8: ifconfig|\n|e199faf72661b7e822da2d02aec59227a2d413d02bd288 a3b26e5465d59fda5b|App_Web_s8x7grb2, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 9: HTTP Get|\n|c5ff6b1b201d6289ab718575d0175b322653b3fe92c4ba 046fc6e785f83404ed|App_Web_f46v5okg, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 10: Server Variable Dumper|\n|29fe8f7cdeb8b2a4c0d9e7410cd4cbe1873a22eada4a59 2b9df6f2ee6c335ff9|App_Web_6nj14khm, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 11: Credential Dumper|\n|189dfd287b0ff6b5161a89343fcde57f509dfa99f44277ad­ 6cfb9ccbdfbf436a|App_Web_ai57zs2m, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 12: Credential Dumper Variant|\n|9c36f62e2f347e709223f38450f8fcd075b­ 273f164219e6fc6db112fdb26db4d|App_Web_sbp8l0mc, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 13: Active Directory Querier|\n|2e45ad3689e9b13d40880b142925a4922e77c­ 769c9f2809e702d6a4f5485384a|App_Web_zm5ivgum, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 14: query2file|\n|91505feb5369978eecba4c92a07f0aaddbddda238e­ da207dd08e81a6839750e6|App_Web_nitm6axl, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 15: File Exfiltrator|\n|16cc7ab162aacb38cd0dbf3ad9a9ba836649e3fb7afdb­ 189c6d529dd0d9a2bc6|App_Web_ugrfvudi, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 16: Multi File Exfiltrator|\n|1629c7a876fb7c63a49a9d182d0c4b993cc3e­ 91d4e6c9a2d207a94c2ac810cdd|App_Web_xw4crb70, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null|Module 17: IIS Module Lister|\n\n\n-----\n\n## ABOUT CROWDSTRIKE\n\n[CrowdStrike, a global cybersecurity leader, has redefined modern security with the world’s most](https://www.crowdstrike.com/)\nadvanced cloud-native platform for protecting critical areas of enterprise risk — endpoints and cloud\nworkloads, identity and data.\n\nPowered by the CrowdStrike Security Cloud and world-class AI, the CrowdStrike Falcon® platform\nleverages real-time indicators of attack, threat intelligence, evolving adversary tradecraft and\nenriched telemetry from across the enterprise to deliver hyper-accurate detections, automated\nprotection and remediation, elite threat hunting and prioritized observability of vulnerabilities.\n\nPurpose-built in the cloud with a single lightweight-agent architecture, the Falcon platform delivers\nrapid and scalable deployment, superior protection and performance, reduced complexity and\nimmediate time-to-value.\n\nCrowdStrike: We stop breaches.\n\n[Learn more: https://www.crowdstrike.com/](https://www.crowdstrike.com/)\n\n[Follow us: Blog | Twitter | LinkedIn | Facebook | Instagram](https://www.crowdstrike.com/blog/)\n\n[Start a free trial today: https://www.crowdstrike.com/free-trial-guide/](https://www.crowdstrike.com/free-trial-guide/)\n\n© 2022 CrowdStrike, Inc. All rights reserved.\n\n\n#### Start Free Trial\n###### of Next-Gen AV\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        },
        {
            "id": "5910e58f-4bc9-4e4e-9dbb-887804094a01",
            "created_at": "2022-10-25T16:32:58.457399Z",
            "updated_at": "2022-10-25T16:32:58.457399Z",
            "deleted_at": null,
            "name": "OTX",
            "url": "https://otx.alienvault.com",
            "description": "Alienvault Open Threat Exchange (OTX)",
            "reports": null
        }
    ],
    "references": [
        "https://www.crowdstrike.com/wp-content/uploads/2022/05/crowdstrike-iceapple-a-novel-internet-information-services-post-exploitation-framework.pdf"
    ],
    "report_names": [
        "crowdstrike-iceapple-a-novel-internet-information-services-post-exploitation-framework.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716498,
    "ts_updated_at": 1743041279,
    "ts_creation_date": 1652209715,
    "ts_modification_date": 1658844385,
    "files": {
        "pdf": "https://archive.orkl.eu/178576649a2a6f3b452a5f67edb73b8d8714c520.pdf",
        "text": "https://archive.orkl.eu/178576649a2a6f3b452a5f67edb73b8d8714c520.txt",
        "img": "https://archive.orkl.eu/178576649a2a6f3b452a5f67edb73b8d8714c520.jpg"
    }
}