{
    "id": "60a48197-d32e-4cf6-a915-d3dc619d5a6a",
    "created_at": "2023-02-02T02:08:50.006796Z",
    "updated_at": "2025-03-27T02:15:17.358138Z",
    "deleted_at": null,
    "sha1_hash": "483c03ac19d7b87d99e023687c788bd59b5ddd7d",
    "title": "2023-01-04 - Pupy RAT hiding under WerFault’s cover",
    "authors": "",
    "file_creation_date": "2023-02-01T07:43:59Z",
    "file_modification_date": "2023-02-01T07:43:59Z",
    "file_size": 608170,
    "plain_text": "# Pupy RAT hiding under WerFault’s cover\n\n**[labs.k7computing.com/index.php/pupy-rat-hiding-under-werfaults-cover/](https://labs.k7computing.com/index.php/pupy-rat-hiding-under-werfaults-cover/)**\n\nBy Saikumaravel January 4, 2023\n\nWe at K7 Labs recently identified an interesting technique used by threat actors to execute\na Remote Admin Tool. We all know that WerFault.exe is used for the Windows Error\nReporting. This blog describes how threat actors use the legitimate WerFault.exe to\nexecute Pupy RAT on the victims’ machine.\n\nFigure 1: Execution flow\n\n## Analysis of Binary\n\n### Stage 1 – WerFault Execution\n\n\n-----\n\nRecently we came across an ISO image, recent inventory & our specialties.iso from a\ntwitter feed. The ISOcontains four files, a legitimate WerFault.exe,a malicious DLL named\nfaultrep.dll, a shortcut file named recent inventory & our specialties.lnkand a XLS file\nnamed File.xls. The shortcut file has the same name as the ISO image. When the victim\nopens that shortcut file, it uses scriptrunner.exe LOLBin via cmd to execute WerFault.exe\nfrom the ISO.\n\nFigure 2: ISO & shortcut file\n\n### Stage 2 – Pupy RAT loader\n\nOriginally, Faultrep.dll is the name of DLL used by WerFault.exe is, which is present in the\ndefault windows folder. When WerFault.exe starts executing, it uses DLL Side-Loading\ntechnique to load the Faultrep.dll from the ISO and it has a dummy export function\n**WerpInitiateCrashReporting similar to the original DLL.This malicious Faultrep.dll is**\ncompiled in C.\n\nThe DLL has a custom API resolving function with two arguments, DLL hash and Function\nhash.\n\n\n-----\n\nFigure 3:\n\nAPI Resolving\n[We noticed that this loader uses the same API resolving function as Guloader. The DLLs](https://www.crowdstrike.com/blog/guloader-malware-analysis/#:~:text=DJB2%20Hashes%20for%20Windows%20API%20Resolution)\nresolved were kernel32 and advapi32.\n\nAfter resolving the APIs, it starts to serve its purpose. Using the resolved function\n**CreateThread, it creates two threads. The first thread opens a lure excel sheet named**\n**file.xls from the ISO.**\n\nFigure 4: First thread opening Excel sheet\n\n\n-----\n\nWhile manually resolving the function, we found that one of the functions it resolved was\n**SystemFunction032 from the advapi32.dll. This function is undocumented in MSDN and**\n[on further searching we found the documentation on WineAPI. With that documentation,](https://source.winehq.org/WineAPI/SystemFunction032.html)\nwe understood that the function is used for RC4 encryption and accepts two arguments:\nkeyand data. On further analysis we found the RC4 decryption function which contains the\ndata and hard coded string as key.\n\nFigure 5: Second thread doing RC4 decryption\nThe data is pointed to the address of the overlay. So we dumped the encrypted overlay\ndata and using the key we further decrypted it. After decrypting the data, we confirmed that\nthe data is a PE file with the magic bytes.\n\nFigure 6: RC4 Decryption\nWe dumped the decrypted output data to a PE file. It was compiled with C & Python and\nfound that it is a Pupy RAT. This RAT is loaded into the memory and executed while\nWerFault.exe was executing in the front.\n\n\n-----\n\nFigure 7: Decrypted PE file\n\n### Stage 3 – Pupy RAT\n\n[Pupy RAT is an open-source cross platform Remote Admin Tool available in Github](https://github.com/n1nj4sec/pupy)\nAccording to the [sources, since 2013 it has possibly been used by APT33 and APT35 from](https://www.recordedfuture.com/pupyrat-malware-analysis)\nIran for cyber espionage operations like the one that was discovered in 2020 and targeted\na major European energy organisation.\n\nFigure 8: Pupy RAT Github\n\n\n-----\n\nIt was executed from memory and based on the analysis of ReflectiveLoader function, is\ncapable of executing any PE file in-memory, remotely. It tries to make a C2 connection in\nthe background when the victim believes WerFault is running. Since the C2 was down at\nthe time of analysis, RAT was unable to establish a connection for carrying out any further\nmalicious activity. With the XLS sheet in Chinese, we believe that the victim is from China.\n\nFigure 9:\n\nPupy RAT C2 connection\nWe at K7 Labs provide detection against latest threats and also for this newer variant of\nLoader. Users are advised to use a reliable security product such as “K7 Total Security”\nand keep it up-to-date so as to safeguard their devices.\n\n## IoCs\n\n**Filename** **Hash** **K7**\n**Detection**\n**Name**\n\n\n**Stage 1 – WerFault**\n**Execution**\n\nrecent inventory & our\nspecialties.iso\n\n**Stage 2 – Pupy RAT loader**\n\nfaultrep.dll\n\n**Stage 3 – Pupy RAT**\n\nDecrypted PupyRAT\n\n## C2\n\nhxxp[://103[.79[.76[.40/\n\n## References\n\n\nD069812AA63B631897498621DE353519 Trojan (\n0059ce2b1\n)\n\n42A5798608F196CE7376CE196F4452FE Trojan (\n0059ce2b1\n)\n\nF365A8BDFD9B39C4F8B9D99613818207 Trojan (\n0001140e1\n)\n\n\n[https://twitter.com/SBousseaden/status/1603425101528956935](https://twitter.com/SBousseaden/status/1603425101528956935)\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-01-04 - Pupy RAT hiding under WerFault’s cover.pdf"
    ],
    "report_names": [
        "2023-01-04 - Pupy RAT hiding under WerFault’s cover.pdf"
    ],
    "threat_actors": [
        {
            "id": "d8af157e-741b-4933-bb4a-b78490951d97",
            "created_at": "2023-01-06T13:46:38.748929Z",
            "updated_at": "2025-03-27T02:00:02.908256Z",
            "deleted_at": null,
            "main_name": "APT35",
            "aliases": [
                "Newscaster Team",
                "Magic Hound",
                "G0059",
                "Phosphorus",
                "Mint Sandstorm",
                "TunnelVision",
                "COBALT MIRAGE"
            ],
            "source_name": "MISPGALAXY:APT35",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b23e717c-0b27-47e0-b3c8-4defe6dd857f",
            "created_at": "2023-01-06T13:46:38.367369Z",
            "updated_at": "2025-03-27T02:00:02.815758Z",
            "deleted_at": null,
            "main_name": "APT33",
            "aliases": [
                "ATK35",
                "Peach Sandstorm",
                "TA451",
                "APT 33",
                "Elfin",
                "Refined Kitten",
                "MAGNALLIUM",
                "HOLMIUM",
                "COBALT TRINITY",
                "G0064"
            ],
            "source_name": "MISPGALAXY:APT33",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9fe49a5b-f3e6-4fbf-99a1-db15dad460c3",
            "created_at": "2024-05-01T02:03:08.045004Z",
            "updated_at": "2025-03-27T02:05:17.325038Z",
            "deleted_at": null,
            "main_name": "COBALT TRINITY",
            "aliases": [
                "Elfin ",
                "HOLMIUM ",
                "MAGNALIUM ",
                "Peach Sandstorm ",
                "Refined Kitten ",
                "TA451 ",
                "APT33 "
            ],
            "source_name": "Secureworks:COBALT TRINITY",
            "tools": [
                " Cadlotcorg",
                " Dello RAT",
                " Imminent Monitor",
                " KDALogger",
                " Koadic",
                " NanoCore",
                " NetWire",
                " POWERTON",
                " PoshC2",
                " Poylog",
                " PupyRAT",
                " Schoolbag",
                "AutoCore"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "08a3b64c-8e18-455d-af57-28dca63808c4",
            "created_at": "2024-05-01T02:03:08.027871Z",
            "updated_at": "2025-03-27T02:05:17.313679Z",
            "deleted_at": null,
            "main_name": "COBALT ILLUSION",
            "aliases": [
                "APT42 ",
                "Charming Kitten ",
                "CharmingCypress ",
                "ITG18 ",
                "Magic Hound ",
                "Mint Sandstorm sub-group ",
                "NewsBeef ",
                "Newscaster ",
                "PHOSPHORUS sub-group ",
                "TA453 ",
                "UNC788 ",
                "Yellow Garuda ",
                "APT35 "
            ],
            "source_name": "Secureworks:COBALT ILLUSION",
            "tools": [
                " MagicHound Toolset",
                " PupyRAT",
                "Browser Exploitation Framework (BeEF)"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "e3676dfe-3d40-4b3a-bfbd-4fc1f8c896f4",
            "created_at": "2022-10-25T15:50:23.808974Z",
            "updated_at": "2025-03-27T02:00:55.550912Z",
            "deleted_at": null,
            "main_name": "Magic Hound",
            "aliases": [
                "Magic Hound",
                "TA453",
                "COBALT ILLUSION",
                "Charming Kitten",
                "ITG18",
                "Phosphorus",
                "APT35",
                "Mint Sandstorm"
            ],
            "source_name": "MITRE:Magic Hound",
            "tools": [
                "Impacket",
                "CharmPower",
                "FRP",
                "Mimikatz",
                "Systeminfo",
                "ipconfig",
                "netsh",
                "PowerLess",
                "Pupy",
                "DownPaper",
                "PsExec",
                "Havij",
                "sqlmap"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e5ff825b-0456-4013-b90a-971b93def74a",
            "created_at": "2022-10-25T15:50:23.824058Z",
            "updated_at": "2025-03-27T02:00:55.553346Z",
            "deleted_at": null,
            "main_name": "APT33",
            "aliases": [
                "APT33",
                "HOLMIUM",
                "Elfin",
                "Peach Sandstorm"
            ],
            "source_name": "MITRE:APT33",
            "tools": [
                "PowerSploit",
                "AutoIt backdoor",
                "PoshC2",
                "Mimikatz",
                "NanoCore",
                "DEADWOOD",
                "StoneDrill",
                "POWERTON",
                "LaZagne",
                "TURNEDUP",
                "NETWIRE",
                "Pupy",
                "ftp",
                "Shamoon"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1675303730,
    "ts_updated_at": 1743041717,
    "ts_creation_date": 1675237439,
    "ts_modification_date": 1675237439,
    "files": {
        "pdf": "https://archive.orkl.eu/483c03ac19d7b87d99e023687c788bd59b5ddd7d.pdf",
        "text": "https://archive.orkl.eu/483c03ac19d7b87d99e023687c788bd59b5ddd7d.txt",
        "img": "https://archive.orkl.eu/483c03ac19d7b87d99e023687c788bd59b5ddd7d.jpg"
    }
}