{
    "id": "a2ce2ea3-1712-40c5-8cd6-2025b7f45705",
    "created_at": "2022-10-25T16:48:13.257771Z",
    "updated_at": "2025-03-27T02:16:20.682369Z",
    "deleted_at": null,
    "sha1_hash": "d06b05c9f20c34154b3134a02f9bdfcac5b570e9",
    "title": "Carbon Paper: Peering into Turla second stage backdoor",
    "authors": "ESET",
    "file_creation_date": "2018-02-04T20:31:54Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 305283,
    "plain_text": "# Carbon Paper: Peering into Turla’s second stage backdoor\n\n**[www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/](https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/)**\n\nBy ESET Research posted 30 Mar 2017 - 02:00PM March 30, 2017\n\nThe Turla espionage group has been targeting various institutions for many years. Recently,\nwe found several new versions of Carbon, a second stage backdoor in the Turla group arsenal.\nLast year, a technical analysis of this component was made by Swiss GovCERT.ch as part of\ntheir report detailing the attack that a defense firm owned by the Swiss government, RUAG,\nsuffered in the past.\n\nThis blog post highlights the technical innovations that we found in the latest versions of\nCarbon we have discovered.\n\nLooking at the different versions numbers of Carbon we have, it is clear that it is still under\nactive development. Through the internal versions embedded in the code, we see the new\nversions are pushed out regularly. The group is also known to change its tools once they are\nexposed. As such, we have seen that between two major versions, mutexes and file names\nare being changed.\n\n## Infection vectors\n\nThe Turla group is known to be painstaking and work in stages, first doing reconnaissance on\ntheir victims’ systems before deploying their most sophisticated tools such as Carbon.\n\n\n-----\n\nvisiting a previously compromised website, typically one that the user visits regularly — a\ntechnique known as a watering hole attack.\n\nAfter a successful attack, a first stage backdoor — such as Tavdig or Skipper — is installed on\nthe user machine. Once the reconnaissance phase is over, a second stage backdoor, like\nCarbon, is installed on key systems.\n\n## Technical analysis\n\nCarbon is a sophisticated backdoor used to steal sensitive information from targets of interest\nby the Turla group.\n\nThis malware shares some similarities with “Uroburos”, a rootkit used by the same group. The\nmost relevant resemblance is the communication framework. Indeed, both of them provide\ncommunication channels between different malware components. The communication objects\nare implemented in the same way, the structures and vtables look identical except that there\nare fewer communication channels provided in Carbon. Indeed, Carbon might be a “lite”\nversion of Uroburos (without kernel components and without exploits).\n\nFor Turla group to decide to install Carbon on a system, a (stage 1) recognition tool is usually\ndelivered first to the target: this tool collects several pieces of information about the victim’s\nmachine and its network (through Tavdig or Skipper for example). If the target is considered\ninteresting enough, it will receive more sophisticated malware (such as Carbon or Uroburos).\n\n## Global architecture\n\nThe Carbon framework consists of:\n\na dropper that installs the carbon components and its configuration file\na component that communicates with the C&C\nan orchestrator that handles the tasks, dispatches them to other computers on the\nnetwork and injects into a legitimate process the DLL that communicates with the C&C\na loader that executes the orchestrator\n\n### Carbon Dating\n\nThe orchestrator and the injected library have their own development branch.\n\nThanks to the compilation dates and the internal versions numbers hardcoded in the PE files,\nwe might have the following timeline:\n\n\n-----\n\nTable 1 – Carbon development timeline\n\n### Carbon files\n\nThe files from the Carbon framework can have different names depending on the version but\nthey all keep the same internal name (from the metadata) regardless of the version:\n\nthe dropper: “SERVICE.EXE”\nthe loader: “SERVICE.DLL” or “KmSvc.DLL”\nthe orchestrator: “MSIMGHLP.DLL”\nthe injected library: “MSXIML.DLL”\n\nEach of these files exist in 32bit and in 64bit versions.\n\n### Working directory\n\nSeveral files are created by Carbon to keep logs, tasks to execute and configuration that will\nmodify the malware’s behavior. The contents of the majority of these files are encrypted with\nthe CAST-128 algorithm .\n\nA base working directory will contain the files/folders related to Carbon. This directory is\nchosen randomly among the folders in %ProgramFiles% but excluding “WindowsApps”.\n\nThe filenames are hardcoded in the orchestrator. The same names are used in the 3.7x+\nbranch. Because the injected library accesses the same files as the orchestrator, it is another\neasy way to link a library version and an orchestrator.\n\n_Carbon 3.7x files tree view:_\n\n\n-----\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n\nclass= tok-go >\\%carbon_working_folder\\%  // base folder</span>\n\n<span class=\"tok-go\">├── 0208 // tasks results and logs files</span>\n\n<span class=\"tok-go\">│  ├── C_56743.NLS // contains list of files to send to the C&amp;C server,\nthis file is neither compressed nor encrypted</span>\n\n<span class=\"tok-go\">├── asmcerts.rs</span>\n\n<span class=\"tok-go\">├── getcerts.rs</span>\n\n<span class=\"tok-go\">├── miniport.dat // configuration file</span>\n\n<span class=\"tok-go\">├── msximl.dll  // injected library (x32)</span>\n\n<span class=\"tok-go\">├── Nls // contains tasks (commands to be executed or PE file) and their\nconfiguration files</span>\n\n<span class=\"tok-go\">│  ├── a67ncodc.ax // tasks to be executed by the orchestrator</span>\n\n<span class=\"tok-go\">│  ├── b9s3coff.ax // tasks to be executed by the injected library</span>\n\n<span class=\"tok-go\">├── System  // plugins folder</span>\n\n<span class=\"tok-go\">│  ├── bootmisc.sdi // not used</span>\n\n<span class=\"tok-go\">├── qavscr.dat  // error log</span>\n\n<span class=\"tok-go\">├── vndkrmn.dic  // log</span>\n\n<span class=\"tok-go\">└── ximarsh.dll  // injected library (x64)</span></code></span>\n\n\nSince version 3.80, all filenames have changed.\n\n_Carbon 3.8x files tree view:_\n\n\n-----\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n\nclass= tok-go >\\carbon_working_folder\\%  // base folder</span>\n\n<span class=\"tok-go\">├── 0409 // contains tasks (commands to be executed or PE file) and their\nconfiguration files</span>\n\n<span class=\"tok-go\">│  ├── cifrado.xml  // tasks to be executed by the injected library</span>\n\n<span class=\"tok-go\">│  ├── encodebase.inf // tasks to be executed by the orchestrator</span>\n\n<span class=\"tok-go\">├── 1033 // tasks results and logs files</span>\n\n<span class=\"tok-go\">│  ├── dsntype.gif // contains list of files to send to the C&amp;C server, this\nfile is neither compressed nor encrypted</span>\n\n<span class=\"tok-go\">├── en-US // plugins folder</span>\n\n<span class=\"tok-go\">│  ├── asmlang.jpg // not used</span>\n\n<span class=\"tok-go\">├── fsbootfail.dat // error log</span>\n\n<span class=\"tok-go\">├── mkfieldsec.dll // injected library (x32)</span>\n\n<span class=\"tok-go\">├── preinsta.jpg  // log</span>\n\n<span class=\"tok-go\">├── wkstrend.xml  // configuration file</span>\n\n<span class=\"tok-go\">├── xmlrts.png</span>\n\n<span class=\"tok-go\">└── zcerterror.png</span></code></span>\n\n\n#### File access\n\nIn the case of the majority of the files from the Carbon working folder, when one is accessed\nby the malware, the following steps are taken:\n\na specific mutex is used to ensure its exclusive access.\nthe file is decrypted (CAST-128)\nwhen the operations on the file are done, the file is reencrypted (CAST-128)\nthe mutex is released\n\n### Mutexes\n\nThe following mutexes are created by the orchestrator in Carbon 3.7x:\n\n“Global\\\\MSCTF.Shared.MUTEX.ZRX” (used to ensure exclusive access to\n“vndkrmn.dic”)\n“Global\\\\DBWindowsBase” (used to ensure exclusive access to “C_56743.NLS”)\n“Global\\\\IEFrame.LockDefaultBrowser” (used to ensure exclusive access to\n“b9s3coss.ax”)\n“Global\\\\WinSta0_DesktopSessionMut” (used to ensure exclusive access to\n“a67ncodc.ax”)\n“Global\\{5FA3BC02-920F-D42A-68BC-04F2A75BE158}” (used to ensure exclusive\n\n\n-----\n\n“miniport.dat”)\n“Global\\\\ShimSharedMemoryLock” (used to ensure exclusive access to “asmcerts.rs”)\n\nIn carbon 3.8x, the filenames and the mutex names have changed:\n\n“Global\\\\Stack.Trace.Multi.TOS” (used to ensure exclusive access to “preinsta.jpg”)\n“Global\\\\TrackFirleSystemIntegrity” (used to ensure exclusive access to “dsntype.gif”)\n“Global\\\\BitswapNormalOps” (used to ensure exclusive access to “cifrado.xml”)\n“Global\\\\VB_crypto_library_backend” (used to ensure exclusive access to\n“encodebase.inf”)\n“Global\\{E41B9AF4-B4E1-063B-7352-4AB6E8F355C7}” (used to ensure exclusive\naccess to new files created in “0409” folder)\n“Global\\\\Exchange.Properties.B” (used to ensure exclusive access to “wkstrend.xml”)\n“Global\\\\DatabaseTransSecurityLock” (used to ensure exclusive access to “xmlrts.png”)\n\nThese mutexes are also used in the injected dll to ensure that the orchestrator has been\nexecuted.\n\n### Configuration File\n\nThe configuration file affects the malware’s behavior. The file format is similar to “inf” files used\nby Windows. It contains among others:\n\nan “object_id” that is a unique uuid used to identify the victim, when the value is not set\nin the file, it is generated randomly by the malware\na list of processes into which code is injected (iproc)\nthe frequency and time for task execution / backup logs / connection to the C&C ([TIME])\nthe IP addresses of other computers on the network ([CW_LOCAL])\nthe C&C server addresses ([CW_INET])\nthe named pipes used to communicate with the injected library and with the other\ncomputers ([TRANSPORT])\n\nThis file might be updated later. Indeed, in the communication library, some cryptographic keys\nare used to encrypt/decrypt data and these keys are retrieved from a section [CRYPTO] in the\nconfiguration file that does not exist when the file is dropped from the loader resources.\n\n_Carbon 3.77 configuration file:_\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n\n<span style=\"font-family: 'courier new', courier, monospace;\"><code data-lang=\"console\"><span\nclass=\"tok-go\">[NAME]</span>\n\n<span class=\"tok-go\">object_id=</span>\n\n<span class=\"tok-go\">iproc =\niexplore.exe,outlook.exe,msimn.exe,firefox.exe,opera.exe,chrome.exe</span>\n\n<span class=\"tok-go\">ex = #,netscape.exe,mozilla.exe,adobeupdater.exe,chrome.exe</span>\n\n\n-----\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n22\n\n23\n\n24\n\n25\n\n26\n\n27\n\n28\n\n29\n\n30\n\n31\n\n32\n\n33\n\n34\n\n35\n\n36\n\n37\n\n38\n\n\n<span class=\"tok-go\">[TIME]</span>\n\n<span class=\"tok-go\">user_winmin = 1800000</span>\n\n<span class=\"tok-go\">user_winmax = 3600000</span>\n\n<span class=\"tok-go\">sys_winmin = 3600000</span>\n\n<span class=\"tok-go\">sys_winmax = 3700000</span>\n\n<span class=\"tok-go\">task_min = 20000</span>\n\n<span class=\"tok-go\">task_max = 30000</span>\n\n<span class=\"tok-go\">checkmin = 60000</span>\n\n<span class=\"tok-go\">checkmax = 70000</span>\n\n<span class=\"tok-go\">logmin = 60000</span>\n\n<span class=\"tok-go\">logmax = 120000</span>\n\n<span class=\"tok-go\">lastconnect=111</span>\n\n<span class=\"tok-go\">timestop=</span>\n\n<span class=\"tok-go\">active_con = 900000</span>\n\n<span class=\"tok-go\">time2task=3600000</span>\n\n<span class=\"tok-go\">[CW_LOCAL]</span>\n\n<span class=\"tok-go\">quantity = 0</span>\n\n<span class=\"tok-go\">[CW_INET]</span>\n\n<span class=\"tok-go\">quantity = 3</span>\n\n<span class=\"tok-go\">address1 = doctorshand.org:80:/wp-content/about/</span>\n\n<span class=\"tok-go\">address2 = www.lasac.eu:80:/credit_payment/url/</span>\n\n<span class=\"tok-go\">address3 = www.shoppingexpert.it:80:/wp-content/gallery/</span>\n\n<span class=\"tok-go\">[TRANSPORT]</span>\n\n<span class=\"tok-go\">system_pipe = comnap</span>\n\n<span class=\"tok-go\">spstatus = yes</span>\n\n<span class=\"tok-go\">adaptable = no</span>\n\n\n-----\n\n41\n\n42\n\n43\n\n44\n\n45\n\n46\n\n47\n\n48\n\n\n<span class=\"tok-go\">[DHCP]</span>\n\n<span class=\"tok-go\">server = 135</span>\n\n<span class=\"tok-go\">[LOG]</span>\n\n<span class=\"tok-go\">logperiod = 7200</span>\n\n<span class=\"tok-go\">[WORKDATA]</span>\n\n<span class=\"tok-go\">run_task=</span>\n\n<span class=\"tok-go\">run_task_system=</span></code></span>\n\n\n### Logfile\n\nThe Carbon framework includes a logfile that is used to log actions performed by the malware\nand information on the system that can be useful to the malware operator (for example if an\nanalysis tool such as WireShark is running on the machine).\n\nThe log’s format has not changed since Carbon 3.71:\n\nDate|Time|Object-Id|Source|Message\n\n_example_\n\n1 <span class=\"tok-go\">[LOG]</span>\n\n2 <span class=\"tok-go\">start=1</span>\n\n3 <span class=\"tok-go\">20/02/17|12:48:24|8hTdJtUBB57ieReZAOSgUYacts|s|OPER|New object ID\n\ngenerated '8hTdJtUBB57ieReZAOSgUYacts'|</span>\n\n4\n\n<span class=\"tok-go\">20/02/17|12:48:24|8hTdJtUBB57ieReZAOSgUYacts|s|ST|3/81|0|</span>\n\n5\n\n<span class=\"tok-go\">20/02/17|12:48:24|8hTdJtUBB57ieReZAOSgUYacts|s|START OK</span>\n\nThis file is periodically backed up and sent to the C&C.\n\n## Dropper\n\nThe dropper is the only executable that is not a DLL. It is the first PE file to be executed: it is\nused to extract the other components from its resources.\n\nThe PE files that are used to load the main components are extracted into the Windows\nsystem directory while the orchestrator, the library used to communicate with the C&C and the\n\nfi ti fil t t d i t th C b ki di t\n\n\n-----\n\nname is the volume serial disk number of the compromised machine and a value “root” is\ncreated with the chosen Carbon working directory.\n\n_Example:_\n\n1 <span class=\"tok-go\">[5049654F]</span>\n\n2 <span class=\"tok-go\">root=\"C:\\Program Files\\Windows Portable Devices\"</span>\n\n## Loader\n\nThis part of the component is used to load the orchestrator.\n\nA service that ensures Carbon’s persistency is created. Its name can either be “srservice”,\n“ipvpn” or “hkmsvc” depending of the operating system version running on the compromised\nmachine.\n\nThe Carbon working directory is retrieved by walking through the “%windir%\\inf” folder and\nlooking for the file that contains the Carbon base path.\n\nLast but not least, the function “ModuleStart” (in Carbon 3.71) or “ModStart” (since Carbon\n3.77) from the orchestrator (located in the Carbon base folder) is called.\n\n## Orchestrator\n\nThe orchestrator is the main component of the Carbon framework. It is mainly used to inject\ncode into a process that communicates legitimately over the Internet and to dispatch the tasks\nreceived from the injected library to other computers on the same network either through\nnamed pipes or TCP.\n\nSeven threads are created by the malware. It is easy to identify Carbon’s characteristics\nbecause each thread has a specific role:\n\n### Configuration fetching\n\nBecause the configuration file can be updated by the malware, some attributes like the C&C\nserver addresses are monitored every 10 minutes.\n\n### Check Carbon storage folder periodically\n\nThere is a storage folder located in the Carbon working directory. This folder contains some\nfiles downloaded from the C&C server (tasks that are either commands to be executed or PE\nfiles, and their configuration files).\n\nThis thread will run continuously and check every two hours whether there is still enough\n\n\n-----\n\nThe execution of the tasks in the context of the orchestrator process is very similar to the way\nin which it is performed in the communication library (cf Communication library / Tasks\nexecution).\n\nUnlike the communication library, it is the file “encodebase.inf” (for Carbon v3.8x) or\n“a67ncode.ax” that contains the list of the tasks to execute.\n\nEach line of this file is composed in the following way:\n\ntask_id | task_filepath | task_config_filepath | task_result_filepath | task_log_filepath |\n\n[execution_mode | username | password]\n\nThe five first fields are required, while the last three are optional. If the field “execution_mode”\nexists, its value will affect the way the task is executed:\n\n0 or 1: normal execution\n2: the task is executed in the security context of a specific user (credentials are provided\nthrough the username/password fields)\n3 or 4: the task is executed in the security context of the user represented by the\n“explorer.exe” token\n\n### P2P\n\nLike Uroburos/Snake, Carbon can dispatch tasks to other computers from the same network\nvia named pipe or TCP. It is useful to be able to dispatch and execute tasks on computers that\ndo not have Internet access.\n\n#### Communication channels\n\nUroburos used several types of communication transports than can be categorized as follows:\n\ntype 1: TCP\ntype 2: enc, np, reliable, frag, m2b, m2d\ntype 3: t2m\ntype 4: UDP, doms, domc\n\n\n-----\n\nCarbon uses a reduced number of communication channels:\n\ntype 1: TCP, b2m\ntype 2: np, frag, m2b\n\nThe data sent to peers are usually fragmented and transported either by TCP or via a named\npipe. If, for example, fragmented data are sent from a computer to another one by a named\npipe, an object “frag.np” is set up. In this case the mother class “frag” constructor will be called\nfollowed by a call to the constructor subclass “np”.\n\n\n-----\n\n#### How a task is forwarded to another computer\n\nSeveral steps are performed to send data from one computer to another:\n\na communication channel is created (frag.np or frag.tcp object) with a specific named\npipe / ip address\noptions are given to the object communication (for example : the fragment’s size,\ninformation about the peer etc.)\nconnection to the peer\nan authentication step is performed between the host and the peer:\n\nthere is a handshake process where the host is sending the “magic” value\n“A110EAD1EAF5FA11” and expects to receive “C001DA42DEAD2DA4” from the\npeer\na command “WHO” is sent to the peer where the host sends the victim uuid and\nexpects to receive the same uuid\nif the authentication was successful, the data are sent to the peer\n\nAll the communication between the host and the peer are encrypted with CAST-128\n\nNote that this P2P feature is also implemented in the communication DLL.\n\n### Plugins\n\nThis malware supports additional plugins to extend its functionalities.\n\nIn the configuration file, there is a section named “PLUGINS”. It might not exist when the\nconfiguration file is dropped from the loader resources but this file can be updated by the\nmalware. The section “PLUGINS” contains a line formed this way:\n\n%plugin_name%=%enabled%|%mode%[:%username%:%password%]|%file_path%\n\n%file_path% can be either the path to a PE file or to a file containing a command line to be\nexecuted. %enabled% is a string that is used to know if the plugin has to be executed. If it is\nthe case, that string value is “enabled”.\n\nThe attribute %mode% is used to control the context in which to execute the PE file/command\nline. It can be either:\n\n1 = execution with current user privilege in the current process context through\nCreateProcess().\n2 = execution as the user specified in the configuration (:%username%:%password%\nattributes), the token of this specific user is retrieved through the LogonUserAs()\nfunction.\n3 = execution in the security context of the user represented by the “explorer.exe” token\n(th t k f th “ l ” i d li t d d d th h th\n\n\n-----\n\n4 = similar than 3 but the environment variables for the user represented by the\n“explorer.exe” token are retrieved and passed to the function CreateProcessAsUser()\n\nIf it is a PE file:\n\nthe file is loaded into the malware process memory\nthe module is parsed to check if it is a DLL\nif the module is a DLL and exports a function “ModStart” (since Carbon 3.77) or\n“ModuleStart” (for older versions of Carbon), a new thread is created to execute this\nfunction.\nif the module is not a DLL but a valid PE, it is executed from the entry point.\n\n### Injection of the communication library into remote processes\n\nThe library that is used to communicate with the C&C server is injected into remote processes.\nIn order to know where to inject this DLL, the configuration file is parsed. The section “[NAME]”\ncontains a field “iproc” containing a list of processes that can legitimately communicate to\nInternet.\n\n_Example:_\n\n1 <span class=\"tok-go\">[NAME]</span>\n\n2 <span class=\"tok-go\">iproc =\n\niexplore.exe,outlook.exe,msimn.exe,firefox.exe,opera.exe,chrome.exe</span>\n\nFor each process on the list that is running on the system, if its parent process name is either\n“explorer.exe” or “ieuser.exe”, the DLL will be injected into this process.\n\nThe process injection is very classical:\n\nthe functions “CreateToolHelp32Snapshot / Module32FirstW / Module32NextW” are\nused to retrieve the base address of the module “kernel32.dll”\nthe module EAT is parsed to get the address of the function “LoadLibraryW”\nthe privilege “SeDebugPrivilege” is enabled for the current process\nmemory is allocated into the remote process and the library path is written into it\nNtCreateThreadEx or CreateRemoteThread (if the address of the first function cannot be\nretrieved) is called to execute LoadLibraryW to load the DLL into the memory of the\nremote process *\n\n## Communication library\n\nThe following analysis is based on the version 4.x of msximl. This component may have\nchanged in the latest versions.\n\n\n-----\n\nBesides the code in the Configuration fetching thread from the orchestrator (which is similar),\na field “sethttp1” is retrieved from the [TRANSPORT] section.\n\nIf this value is set, HTTP 1.1 will be used for future connections.\n\n### Tasks execution\n\nThe tasks are retrieved from the C&C server.\n\nThe tasks to be executed by the communication library are listed in the file “b9s3coff.ax” (for\nCarbon v3.7x) or “cifrado.xml” (for Carbon v3.8x).\n\nEach line of this file is composed in the following way:\n\ntask_id | task_filepath | task_config_filepath | task_result_filepath | task_log_filepath\n\nThe task file and its config are decrypted (CAST-128) and the task executed. There are some\noptions that are retrieved from the Carbon configuration file: “time2task” is used to set a\ntimeout for the task execution (1 hour by default) while “task_min” and “task_max” are used as\nto wait a random time between the execution of the tasks on the task list (the random time will\nbe set between “task_min” and “task_max”). These parameters come from the section [TIME].\n\nIf the task is a valid DLL file, it is loaded in the current process memory and a new thread is\ncreated to execute its “start” export. Otherwise, this is probably a command to execute. In this\ncase, the configuration file is parsed. Like the Carbon configuration file, the task configuration\nfile is formed as a windows “inf” file and should contain a section [CONFIG] with the following\nparameters:\n\n[CONFIG]\n\nNAME (“cmd.exe” by default)\nARG\nRESULT (“stdout” by default)\nCOMPRESSION (“yes” by default)\nDELETE (“no” by default)\n\nThe command with its arguments is executed through CreateProcess() function and the results\nare stored in the %task_result_filepath% file if the RESULT option is not set to “stdout”, while\nerror or additional info are added to the task logfile.\n\nIf the option RESULT is set to stdout:\n\nthe result task file is deleted and the task execution output is written to the log task file\nthe line “task_id | “1” | task_log_filepath | object_id” is added at the end of the file\n“C_56743.NLS” (Carbon 3.7x) or “dsntype.gif” (Carbon 3.8x)\n\nOtherwise:\n\n\n-----\n\ntask logfile\nthe line “task_id | “2” | task_log_filepath | task_result_filepath | object_id” is added at the\nend of the file “C_56743.NLS” (Carbon 3.7x) or “dsntype.gif” (Carbon 3.8x)\n\nIn both cases, the same line as written into “C_56743.NLS” is also written into the field\n“run_task” from the Carbon configuration file. It might be intended as a way for the malware\nauthors to know which is the last task executed when the configuration file is sent to the C&C\nserver (check “Configuration file backup”).\n\n### Log rotation\n\nThe logfile is backed up and sent to the C&C server periodically (by default this is done every\ntwo hours).\n\nLike the backup of the configuration file, this action is performed only during specific times of\nthe day.\nIndeed, the log rotation will be performed only when the current local time is in the range of\nwhat is defined in the configuration file.\n\nThe fields “wh_min” and “wh_max” are retrieved from the [TIME] section of the configuration\nfile (by default: 8 and 20). The thread will execute the code only if the current hour of the day is\nbetween %wh_min% and %wh_max%.\n\nIf there is a value for the attribute “timestop” from the [TIME] section (which looks like\n“wDay:wMonth:wYear:wHour:wMinute”), the thread will execute the code only after this\nspecific datetime.\n\nThe attributes “lastsend” and “logperiod” from the [LOG] section are used to specify a delay\ntime when to backup and send the log to the C&C server. (by default: every two hours).\n\nA temporary file with a random name prefixed by “~D” is created in the folder “208” (for Carbon\nv3.7x) or “1033” (for Carbon v3.8x). The logfile content is copied into this new file. It is then\ncompressed with Bzip2 and encrypted (CAST-128).\n\nA new line is added at the end of the file “C_56743.NLS” (for Carbon v3.7x) or “dsntype.gif”\n(for Carbon v3.8x):\n\n“10|1|%s|%s”\n\n1st field: an ID to identify the file as a logfile\n2nd field: 1 (file to be sent to the C&C server)\n3rd field: the temp file path\n4rd field: the victim uuid\n\nLast but not least, the attribute “lastsend” is updated with the current time and the original\nlogfile is deleted.\n\n\n-----\n\nThe code of this thread is used to retrieve new tasks from the C&C server, to send new files to\nthe server (the files listed in the file “C_56743.NLS” / “dsntype.gif”) and to send the new tasks\nto the orchestrator.\n\n#### First request\n\nA random C&C server address is chosen from the ones in the section “CW_INET”. If the port\nand HTTP resource path are not specified, the default is to use port 80 and\n“/javascript/view.php”.\n\nA user agent is set up in the following way:\n\nthe version of Internet Explorer is retrieved through the registry key:\n“HKLM\\Software\\Microsoft\\Internet Explorer\\Version” and is concatenated to the string\n“Mozilla/4.0 (compatible; MSIE %d.0; ”\n\nexample: “Mozilla/4.0 (compatible; MSIE 8.0.6001.18702.0;”\nconcatenate the previous string with the OS major/minor version values (through\nGetVersionExA())\n\n“Mozilla/4.0 (compatible; MSIE 8.0.6001.18702.0; Windows NT 5.1; Trident/4.0”\nenumerate the values key in\n“HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\5.0\\User\nAgent\\Post Platform” and concatenate each value to the previous string and then\nappend a closing paren.\n\nexample: “Mozilla/4.0 (compatible; MSIE 8.0.6001.18702.0; Windows NT 5.1;\nTrident/4.0; .NET CLR 2.0.50727; .NET CLR 3.0.30729; .NET CLR 3.5.30729;\n.NET4.0C; .NET4.0E; Media Center PC 6.0; SLCC2)\n\nThe field “trans_timemax” from the section [TIME] is retrieved. It is used to set the timeout for\ninternet requests (through InternetSetOption()). It has a value of 10 minutes by default.\n\nA first GET request is performed on the root page of the C&C web server to check that the\nhost is alive. If no packet capture is running on the system, a new request is done on the C&C\nserver to check if new tasks are available. A “PHPSESSID” cookie is added to the request with\nthe victim uuid as its value. A header “Referer” is added as well and set to the C&C server\nURL.\n\nThe malware is expecting to get an answer to the GET request similar to:\n\n<input name=”%name%” value=”%data_in_b64%”>\n\nIf the field “value” contains something, a new task is available.\n\n#### Send data to the server\n\n\n-----\n\nIf the file “C_56743.NLS” / “dsntype.gif” is not empty, it means there are data to be sent the\nC&C server. The file is parsed and the last line is retrieved. It contains details about the data to\nbe sent. A data blob is built and each of the following fields is encrypted with CAST-128:\n\nid | val | tmp_filesize | tmp_content | [OPTIONAL (if val == 2) tmp2_filesize |\ntmp2_content] | len_object_id | object_id\n\nid = the type of data to send to the C&C server, it can be:\n\n10: log backup\n11: configuration file\n20: a cryptographic key\notherwise: an id associated to a task, it can be the result of a task or an error\nlog in the case of task execution failure\nval = 1 if there is only one file to send, 2 if there are two files\nobject_id = the victim uuid\n\n\n-----\n\nis base64 encoded and sent to the C&C server through a POST request.\n\nOtherwise, another layer of encryption is used. In this case, the data blob is signed and a\nrandom 3DES key is used to encrypt it. Because the 3DES key is randomly generated and the\nserver needs it to decrypt the data, the key is encrypted with the server public key. The server\nkey is retrieved from the field “publicc” of the section [CRYPTO] from the configuration file.\n\nThis new blob (encrypted_key | signature_data | encrypted data) is encoded in base64 and\nsent to the C&C server through a POST request.\n\nIn order to avoid detection based on the data size sent in a request, the blob can be\nfragmented into several packets. An option in the configuration file (“post_frag” in the section\n\n[TRANSPORT]) defines whether the blob will be fragmented or sent in only one POST request.\n\nIf this option is set to “yes”, the blob is divided into several fragments of a specific size. This\nsize comes from another field in the configuration file: “post_frag_size”.\n\nAn additional header will be added to the request:\n\n“Content-Range: bytes %u-%u/%u; id=%u\\r\\n”, i, i+(fragment_size-1), data_size, task_id”\n\nIf the option http11 is set, a specific header is added as well:\n\n“Expect: 100-continue\\r\\n”\n\nFor each fragments sent, the fields “post_frag_size” and “pfslastset” from the config file\n(section [CW_INET_RESULTS]) are updated with the fragment size and the timestamp.\n\n#### Get new tasks\n\n\n-----\n\nNew tasks are retrieved from the C&C server by parsing the html page. The malware expects\nto find the html tag <input> in the page with a base64 encoded blob in its “value” attribute.\nOnce decoded, this blob contains:\n\nan encrypted block of 128 bytes that contains a structure “PUBLICKEYSTRUC” followed\nby a cryptographic key (probably a 3DES key)\nsignature data (128 bytes) to verify the integrity of the next block\na block of encrypted data that contains the task\n\nThe malware uses an RSA private key (retrieved from the field “keypair” from the section\n\n[CRYPTO] of the configuration file) to decrypt the first block and then uses the freshly\ndecrypted key to decrypt the third block. This block of data can be either:\n\na task to be executed\n\nthe data are decrypted and stored in few temporary files the task (a command or a\n\n\n-----\n\ncontains the task results and the logfile) are stored in the folder “0208” (or\nrespectively “0409” and “1033” for Carbon v3.8x)\ntask_id | task_filepath | task_config_filepath | task_result_filepath |\ntask_log_filepath\nthis line is appended to beginning of the file “b9s3coff.ax” (cifrado.xml on v3.8x)\na task to be executed by the orchestrator\n\nthe data are decrypted and stored in few temporary files (the task, its configuration\netc) in the “Nls” and “0208” folder (or “0409” and “1033” for Carbon v3.8x)\ndepending of the content of the data, one of these lines will be added to the\nbeginning of the file “a67ncode.ax” (encodebase.info on v3.8x)\n\ntask_id | task_filepath | task_config_filepath | task_result_filepath |\ntask_log_filepath\ntask_id | task_filepath | task_config_filepath | task_result_filepath |\ntask_log_filepath | execution_mode | username | password\ntask_id | task_filepath | task_config_filepath | task_result_filepath |\ntask_log_filepath | execution_mode\na new RSA server public key\n\nin this case, the configuration file is updated with the new key encoded in base64\n(field publicc)\ndata to be sent to an instance of Carbon running in another computer in the same\nnetwork\n\nthe data can contains a specific IP address and port, a named pipe or a named\npipe with a username and password.\n\n### Check Internet availability\n\nEach hour, the internet connection is checked. A first check is done by calling the function\nInternetAttemptConnect(). If it works, another test is done by sending HTTP GET requests to\nthe following websites:\n\nwww.google.com\nwww.yahoo.com\nwww.bing.com\nupdate.microsoft.com\nwindowsupdate.microsoft.com\nmicrosoft.com\n\nAn event is used to notify the other threads in case of the loss of Internet access.\n\n### Configuration file backup\n\nSimilar to the logfile, the configuration file is also periodically backed up and sent to the C&C\nserver. The thread executes the code in a specific range of time (between 8h and 20h by\n\n\n-----\n\nconfig file has been sent over a month ago, the config file is copied into a temporary file with a\nrandom name prefixed by “~D” in the folder “208” (for Carbon v3.7x) or “1033” (for Carbon\nv3.8x). This file is then encrypted with CAST-128 algorithm.\n\nTo notify the thread that communicates with the C&C server that a new file is ready to be sent\nto the server, the following line is appending to the file “C_56743.NLS” (for Carbon v3.7x) or\n“dsntype.gif” (for Carbon v3.8x):\n\n“11|1|%s|%s”\n\n1st field: an ID to identify the file as a config file\n2nd field: 1 (file to be sent to the C&C server)\n3rd field: the temp filepath\n4rd field: the victim uuid\n\nLast but not least, the attribute “configlastsend” is updated with the current time.\n\n## Additional Notes\n\n### Calling API functions\n\nThe base address of the modules of interest are retrieved by either parsing the PEB or (if the\nmodules are not loaded into the process memory) by loading the needed files from disk into\nmemory and parsing their headers to get their base addresses.\n\nOnce the base addresses are retrieved, the PEB is walked again and the field “LoadCount”\nfrom the structure LDR_DATA_TABLE_ENTRY is checked. This value is used as a reference\ncounter, to track the loading and unloading of a module.\n\nIf “LoadCount” is positive, the module EAT is parsed to get the needed function address.\n\n### Encryption\n\nThe module and function names are encrypted (at least since v3.77; it was not the case in\nv3.71) in a simple way, a logical shift of 1 bit being applied to each characters.\n\nThe processes’ names are encrypted as well by just XOR’ing each character with the key 0x55\n(for Carbon v3.7x at least since v3.77) and with the key 0x77 for Carbon v3.8x.\n\nWith only a few the exceptions, each file from the Carbon working directory is encrypted with\nthe CAST-128 algorithm in OFB mode. The same key and IV are used from the version 3.71\nuntil the version 3.81:\n\nkey = “\\x12\\x34\\x56\\x78\\x9A\\xBC\\xDE\\xF0\\xFE\\xFC\\xBA\\x98\\x76\\x54\\x32\\x10”\nIV = “\\x12\\x34\\x56\\x78\\x9A\\xBC\\xDE\\xF0”\n\n\n-----\n\ng & p,\nnone of the most common packet capture software is running on the system:\n\nTCPdump.exe\nwindump.exe\nethereal.exe\nwireshark.exe\nettercap.exe\nsnoop.exe\ndsniff.exe\n\nIf any of these processes are running, no communication will be done.\n\nCarbon IoCs are also available on ESET’s GitHub repository https://github.com/eset/malwareioc/tree/master/turla\n\n## Appendices\n\n### Yara rules\n\nimport “pe”\n\nrule generic_carbon\n{\nstrings:\n$s1 = “ModStart”\n$s2 = “ModuleStart”\n$t1 = “STOP|OK”\n$t2 = “STOP|KILL”\ncondition:\n(uint16(0) == 0x5a4d) and (1 of ($s*)) and (1 of ($t*))\n}\n\nrule carbon_metadata\n{\ncondition:\n(pe.version_info[“InternalName”] contains “SERVICE.EXE” or\npe.version_info[“InternalName”] contains “MSIMGHLP.DLL” or\npe.version_info[“InternalName”] contains “MSXIML.DLL”)\nand pe.version_info[“CompanyName”] contains “Microsoft Corporation”\n}\n\n### Carbon files decryptor/encryptor\n\n\n-----\n\nfrom Crypto.Cipher import CAST\nimport sys\nimport argparse\n\ndef main():\n\nparser = argparse.ArgumentParser(formatter_class=argparse.RawTextHelpFormatter)\nparser.add_argument(“-e”, “–encrypt”, help=”encrypt carbon file”, required=False)\nparser.add_argument(“-d”, “–decrypt”, help=”decrypt carbon file”, required=False)\n\ntry:\nargs = parser.parse_args()\nexcept IOError as e:\nparser.error(e)\nreturn 0\n\nif len(sys.argv) != 3:\nparser.print_help()\nreturn 0\n\nkey = “\\x12\\x34\\x56\\x78\\x9A\\xBC\\xDE\\xF0\\xFE\\xFC\\xBA\\x98\\x76\\x54\\x32\\x10”\niv = “\\x12\\x34\\x56\\x78\\x9A\\xBC\\xDE\\xF0”\n\ncipher = CAST.new(key, CAST.MODE_OFB, iv)\n\nif args.encrypt:\nplaintext = open(args.encrypt, “rb”).read()\nwhile len(plaintext) % 8 != 0:\nplaintext += “\\x00”\ndata = cipher.encrypt(plaintext)\nopen(args.encrypt + “_encrypted”, “wb”).write(data)\nelse:\nciphertext = open(args.decrypt, “rb”).read()\nwhile len(ciphertext) % 8 != 0:\nciphertext += “\\x00”\ndata = cipher.decrypt(ciphertext)\nopen(args.decrypt + “_decrypted”, “wb”).write(data)\n\nif __name__ == “__main__”:\nmain()\n\n[https://securelist.com/analysis/publications/65545/the-epic-turla-operation/](https://securelist.com/analysis/publications/65545/the-epic-turla-operation/)\n[https://blog.gdatasoftware.com/2015/01/23926-analysis-of-project-cobra](https://blog.gdatasoftware.com/2015/01/23926-analysis-of-project-cobra)\nhttps://www.melani.admin.ch/melani/en/home/dokumentation/reports/technical\n\n-----\n\n#### Table 3 – C&C server addresses (hacked websites used as 1st level of proxies\n\n**C&C server address**\n\nsoheylistore.ir:80:/modules/mod_feed/feed.php\n\ntazohor.com:80:/wp-includes/feed-rss-comments.php\n\njucheafrica.com:80:/wp-includes/class-wp-edit.php\n\n\n-----\n\ndoctorshand.org:80:/wp-content/about/\n\nwww.lasac.eu:80:/credit_payment/url/\n\n**Notes**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/vmzqwqfrmtdjemtdaei60jqu5qrouwrt"
    ],
    "report_names": [
        "ESET_Carbon-Paper-Peering-into-Turlas-second-stage-backdoor(03-30-2017)"
    ],
    "threat_actors": [
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716493,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1517776314,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/d06b05c9f20c34154b3134a02f9bdfcac5b570e9.pdf",
        "text": "https://archive.orkl.eu/d06b05c9f20c34154b3134a02f9bdfcac5b570e9.txt",
        "img": "https://archive.orkl.eu/d06b05c9f20c34154b3134a02f9bdfcac5b570e9.jpg"
    }
}