{
    "id": "5a0078a1-dbdd-43fe-b20e-99c8a48a490b",
    "created_at": "2022-10-25T16:48:23.035494Z",
    "updated_at": "2025-03-27T02:05:30.006474Z",
    "deleted_at": null,
    "sha1_hash": "15a0e44be3330d20b64852a04cad695dc699bd8c",
    "title": "Spear Phishing Techniques Used in Attacks Targeting the Mongolian Government « Threat Research Blog | FireEye Inc",
    "authors": "",
    "file_creation_date": "2017-02-28T14:33:34Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 833025,
    "plain_text": "**February 22, 2017 | by Ankit Anubhav, Dhanesh Kizhakkinan | Threat Research, Advanced Malware**\n\n**FireEye recently observed a sophisticated campaign targeting individuals within the Mongolian government.**\n**Targeted individuals that enabled macros in a malicious Microsoft Word document may have been infected**\n\n**[with Poison Ivy, a popular remote access tool (RAT) that has been used for nearly a decade for key logging,](https://www.fireeye.com/content/dam/fireeye-www/global/en/current-threats/pdfs/rpt-poison-ivy.pdf)**\n\n**screen and video capture, file transfers, password theft, system administration, traffic relaying, and more. The**\n\n**threat actors behind this attack demonstrated some interesting techniques, including:**\n\n**1.** **Customized evasion based on victim profile – The campaign used a publicly available technique to**\n\n**evade AppLocker application whitelisting applied to the targeted systems.**\n\n**2.** **Fileless execution and persistence – In targeted campaigns, threat actors often attempt to avoid writing**\n\n**an executable to the disk to avoid detection and forensic examination. The campaign we observed used**\n\n**four stages of PowerShell scripts without writing the the payloads to individual files.**\n\n**3.** **Decoy documents – This campaign used PowerShell to download benign documents from the Internet**\n\n**and launch them in a separate Microsoft Word instance to minimize user suspicion of malicious activity.**\n\n**The threat actors used social engineering to convince users to run an embedded macro in a Microsoft Word**\n\n**document that launched a malicious PowerShell payload.**\n\n**The threat actors used two publicly available techniques, an AppLocker whitelisting bypass and a script to**\n**inject shellcode into the userinit.exe process. The malicious payload was spread across multiple PowerShell**\n**scripts, making its execution difficult to trace. Rather than being written to disk as individual script files, the**\n**PowerShell payloads were stored in the registry.**\n\n**Figure 1 shows the stages of the payload execution from the malicious macro.**\n\n\n-----\n\n**Figure 1: Stages of payload execution used in this attack**\n\n**Targets of the campaign received Microsoft Word documents via email that claimed to contain instructions for**\n\n**logging into webmail or information regarding a state law proposal.**\n\n**When a targeted user opens the malicious document, they are presented with the messages shown in Figure**\n\n**2, asking them to enable macros.**\n\n\n-----\n\n**Figure 2: Lure suggesting the user to enable Macros to see content**\n\n**Microsoft application whitelisting solution AppLocker prevents unknown executables from running on a**\n**[system. In April 2016, a security researcher demonstrated a way to bypass this using regsvr32.exe, a](https://github.com/subTee/SCTPersistence/blob/master/Backdoor.sct)**\n\n**legitimate Microsoft executable permitted to execute in many AppLocker policies. The regsvr32.exe**\n**executable can be used to download a Windows Script Component file (SCT file) by passing the URL of the**\n**SCT file as an argument. This technique bypasses AppLocker restrictions and permits the execution of code**\n\n**within the SCT file.**\n\n**We observed implementation of this bypass in the macro code to invoke regsvr32.exe, along with a URL**\n**passed to it which was hosting a malicious SCT file, as seen in Figure 3.**\n\n\n-----\n\n**Figure 4: Command line parameter used to bypass AppLocker**\n\n**We found that the malicious SCT file invokes WScript to launch PowerShell in hidden mode with an encoded**\n\n**command, as seen in Figure 5.**\n\n**Figure 5: Content of SCT file containing code to launch encoded PowerShell**\n\n**After decoding the PowerShell command, we observed another layer of PowerShell instructions, which**\n**served two purposes:**\n\n**1.   There was code to download a decoy document from the Internet and open it in a second winword.exe**\n**process using the Start-Process cmdlet. When the victim enables macros, they will see the decoy document**\n**shown in Figure 6. This document contains the content described in the spear phishing email.**\n\n\n-----\n\n**Figure 6: Decoy downloaded and launched on the victim’s screen**\n\n**2.   After launching the decoy document in the second winword.exe process, the PowerShell script**\n**downloads and runs another PowerShell script named f0921.ps1 as shown in Figure 7.**\n\n**Figure 7: PowerShell to download and run decoy decoy document and third-stage payload**\n\n**The third stage PowerShell script configures an encoded PowerShell command persistently as base64 string**\n**in the HKCU: \\Console\\FontSecurity registry key. Figure 8 shows a portion of the PowerShell commands for**\n**writing this value to the registry.**\n\n**Figure 8: Code to set registry with encoded PowerShell script**\n\n\n-----\n\n**Figure 9: Registry value containing encoded PowerShell script**\n\n**Figure 10 shows that using Start-Process, PowerShell decodes this registry and runs the malicious code.**\n\n**Figure 10: Code to decode and run malicious content from registry**\n\n**The third stage PowerShell script also configures another registry value named**\n**HKCU\\CurrentVersion\\Run\\SecurityUpdate to launch the encoded PowerShell payload stored in the HKCU:**\n**\\Console\\FontSecurity key. Figure 11 shows the code for these actions. This will execute the PowerShell**\n**payload when the user logs in to the system.**\n\n**Figure 11: PowerShell registry persistence**\n\n**The HKCU\\Console\\FontSecurity registry contains the fourth stage PowerShell script, shown decoded in**\n**Figure 12. This script borrows from the publicly available Inject-LocalShellCode PowerShell script from**\n**[PowerSploit to inject shellcode.](https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-Shellcode.ps1)**\n\n\n-----\n\n**Figure 12: Code to inject shellcode**\n\n**The shellcode has a custom XOR based decryption loop that uses a single byte key (0xD4), as seen in Figure**\n**13.**\n\n\n-----\n\n**Figure 13: Decryption loop and call to decrypted shellcode**\n\n**After the shellcode is decrypted and run, it injects a Poison Ivy backdoor into the userinit.exe as shown in**\n**Figure 14.**\n\n\n-----\n\n**Figure 14: Code injection in userinit.exe and attempt to access Poison Ivy related DAT files**\n\n**In the decrypted shellcode, we also observed content and configuration related to Poison Ivy. Correlating**\n**these bytes to the standard configuration of Poison Ivy, we can observe the following:**\n\n**Active setup – StubPath**\n**Encryption/Decryption key - version2013**\n**Mutex name - 20160509**\n\n**The Poison Ivy configuration dump is shown in Figure 15.**\n\n\n-----\n\n**Although Poison Ivy has been a proven threat for some time, the delivery mechanism for this backdoor uses**\n**recent publicly available techniques that differ from previously observed campaigns. Through the use of**\n**PowerShell and publicly available security control bypasses and scripts, most steps in the attack are**\n**performed exclusively in memory and leave few forensic artifacts on a compromised host.**\n\n**FireEye HX Exploit Guard is a behavior-based solution that is not affected by the tricks used here. It detects**\n**and blocks this threat at the initial level of the attack cycle when the malicious macro attempts to invoke the**\n**first stage PowerShell payload. HX also contains generic detections for the registry persistence, AppLocker**\n\n**bypasses and subsequent stages of PowerShell abuse used in this attack.**\n\n**This entry was posted on Wed Feb 22 09:45:00 EST 2017 and filed under Advanced Malware, Ankit Anubhav**\n**, Blog, Dhanesh Kizhakkinan, Latest Blog Posts, Spear Phishing and Threat Research.**\n\n# First Name\n\n Last Name\n\n Email Address\n\n**Executive Perspective Blog**\n\n**Threat Research Blog**\n\n**Products and Services Blog**\n\n**SubscribeSubscribe**\n\n**Stay Connected**\n\n**[LinkedIn](https://www.linkedin.com/company/fireeye)**\n\n**[Twitter](https://twitter.com/fireeye)**\n\n**[Facebook](https://www.facebook.com/FireEye)**\n\n**[Google+](https://plus.google.com/+Fireeye/videos)**\n\n**[YouTube](https://www.youtube.com/user/FireEyeInc)**\n\n\n# First Name\n\n Last Name\n\n Email Address\n\n**Executive Perspective Blog**\n\n**Threat Research Blog**\n\n**Products and Services Blog**\n\n**SubscribeSubscribe**\n\n\n-----\n\n**[Glassdoor](https://www.glassdoor.com/Overview/Working-at-FireEye-EI_IE235161.11,18.htm)**\n\n**Contact Us**\n**+1 888-227-2721**\n\n**Company**\n\n**About FireEye**\n\n**Customer Stories**\n\n**Careers**\n\n**Partners**\n\n**[Investor Relations](http://investors.fireeye.com/)**\n\n**Supplier Documents**\n\n**News & Events**\n\n**Newsroom**\n\n**Press Releases**\n\n**Webinars**\n\n**Events**\n\n**Blogs**\n\n**[Communication Preferences](https://www2.fireeye.com/manage-your-preferences.html)**\n\n**Technical Support**\n\n**Incident?**\n\n**Report Security Issue**\n\n**Contact Support**\n\n**[Customer Portal](https://csportal.fireeye.com/secur/login_portal.jsp?orgId=00D3000000063LS&portalId=06030000000pSNE)**\n\n**[Communities](https://community.fireeye.com/welcome)**\n\n**[Documentation Portal](https://docs.fireeye.com)**\n\n**Cyber Threat Map**\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2017/2017.02.22.Spear_Phishing_Mongolian_Government/spear_phishing_techn.html.pdf"
    ],
    "report_names": [
        "spear_phishing_techn.html"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716503,
    "ts_updated_at": 1743041130,
    "ts_creation_date": 1488292414,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/15a0e44be3330d20b64852a04cad695dc699bd8c.pdf",
        "text": "https://archive.orkl.eu/15a0e44be3330d20b64852a04cad695dc699bd8c.txt",
        "img": "https://archive.orkl.eu/15a0e44be3330d20b64852a04cad695dc699bd8c.jpg"
    }
}