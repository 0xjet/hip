{
    "id": "8782723a-66c7-4951-9139-83184f684f1f",
    "created_at": "2023-01-12T15:04:51.926804Z",
    "updated_at": "2025-03-27T02:06:09.149281Z",
    "deleted_at": null,
    "sha1_hash": "aa0691d23ff8366ed63574d871949acb5e44149e",
    "title": "2017-02-28 - Dridex’s Cold War- Enter AtomBombing",
    "authors": "",
    "file_creation_date": "2022-05-27T21:26:34Z",
    "file_modification_date": "2022-05-27T21:26:34Z",
    "file_size": 1531108,
    "plain_text": "# Dridex's Cold War: Enter AtomBombing\n\n**[securityintelligence.com/dridexs-cold-war-enter-atombombing/](https://securityintelligence.com/dridexs-cold-war-enter-atombombing/)**\n\n[Advanced Threats February 28, 2017](https://securityintelligence.com/category/x-force/threats/)\n\n\nFebruary 28, 2017\n\n\n-----\n\nBy [Magal Baz co-authored by Or Safran 9 min read](https://securityintelligence.com/author/magal-baz/)\nIBM X-Force discovered that Dridex, one of the most nefarious banking Trojans active in the\nfinancial cybercrime arena, recently underwent a major version upgrade that is already active\nin online banking attacks in Europe.\n\nA few weeks ago, our cybercrime labs detected a new major version of the Dridex banking\nTrojan, Dridex v4. The updated code features a new and innovative injection method based\non a technique dubbed AtomBombing, which was first disclosed in October 2016 by security\nfirm [enSilo.](http://blog.ensilo.com/atombombing-a-code-injection-that-bypasses-current-security-solutions)\n\nDridex is the only banking Trojan we have encountered to use AtomBombing. This change is\nespecially significant when it involves Trojans believed to be operated by an organized\ncybercrime gang because it’s likely to result in other codes adopting the same method in the\nfuture.\n\nDridex’s developers also worked on a major upgrade to the malware’s configuration\nencryption. This upgrade includes implementing a modified naming algorithm, a robust but\neasy-to-spot persistence mechanism and a few additional enhancements.\n\nAccording to IBM Security detection, Dridex v4 is already out and active in campaigns that\nmostly target UK banks. Dridex attacks on online banking users in the UK are based on its\n[hVNC RAT capabilities and](https://securityintelligence.com/anatomy-of-an-hvnc-attack/) [redirection attack scheme, which appears to have replaced the](https://securityintelligence.com/dridex-launches-dyre-like-attacks-in-uk-intensifies-focus-on-business-accounts/)\nwebinjects method as Dridex’s top M.O.\n\n## A Major Version Is a Major Deal\n\n[Dridex’s code is based on that of the Bugat Trojan, which was first discovered in early 2010.](https://www.scmagazine.com/new-bugat-trojan-harvesting-banking-credentials/article/557370/)\nBugat has since evolved into a number of different variations, including Cridex and Feodo.\nThe Dridex form first appeared in 2014.\n\nWhen it comes to their development cycles, Dridex’s authors release minor versions quite\noften, and a major version much less frequently. The releases of the minor and major\nversions are easy to spot since Dridex’s developers clearly track their releases.\n\nDridex’s build numbers are found inside its configuration and in the binary’s code.\n\n_Figure 1: Dridex’s code version hard-coded into the binary._\n\nWhen it comes to major versions for Dridex, the most stable and resilient version to date has\nbeen v3, which was released in April 2015 and has been used in all known attack campaigns\nup until the v4 release.\n\nDridex v2 did not enjoy the same kind of longevity and was only active in early 2015. The\nfirst version released in late 2014 lasted only until the beginning of 2015\n\n\n-----\n\nThe release of a major version upgrade is a big deal for any software, and the same goes for\nmalware. The significance of this upgrade is that Dridex continues to evolve in sophistication,\ninvesting in further efforts to evade security and enhance its capabilities to enable financial\nfraud.\n\n[Read the white paper: How to outsmart Fraudsters with Cognitive Fraud Detection](https://www-01.ibm.com/marketing/iwm/dre/signup?source=mrs-form-9451&S_PKG=ov54550)\n\n## How ‘Bout That Code Injection?\n\nWhen it comes to malware detection, the injection of malicious code from one process into\nanother is one of the most popular events antivirus and other security solutions aim to\nmonitor and use as an indication of compromise.\n\nMost financial malware uses three steps to inject code: remote memory allocation, remote\nwriting of a payload into the allocated memory and, finally, remote execution of the payload.\nMalware commonly uses the CreateRemoteThread method to execute a payload or to call\nLoadLibrary, typically using the following application program interface (API) calls:\n\nVirtualAllocEx to allocate a buffer in the remote process with RWX permissions;\nWriteProcessMemory to copy the payload to the allocated buffer; and\nCreateRemoteThread to execute the payload.\n\nThe problem is that this is a very suspicious and obvious way to inject code. And since it’s\nlikely to raise red flags, malware authors would much rather use alternative methods.\n\n## Enter AtomBombing, but Only Halfway Through\n\n[In October 2016, enSilo researchers exposed a new code injection technique called](https://breakingmalware.com/injection-techniques/atombombing-brand-new-code-injection-for-windows/)\nAtomBombing, which allows the malware to inject code without making any of the\naforementioned API calls.\n\nRather, AtomBombing makes use of Windows’ atom tables and the native API\nNtQueueApcThread to copy a payload into a read-write (RW) memory space in the target\nprocess. It then uses NtSetContextThread to invoke a simple return-oriented programming\n(ROP) chain that allocates read/write/execute (RWX) memory, copies the payload into it and\nexecutes it. Finally, it restores the original context of the hijacked thread.\n\nIn our analysis of the new Dridex v4 release, we discovered that the malware’s authors have\ndevised their own injection method, using the first step of the AtomBombing technique. They\nuse the atom tables and NtQueueAPCThread to copy a payload and an import table into a\nRW memory space in the target process. But they only went halfway — they used the\nAtomBombing technique for the writing of the payload, then used a different method to\nachieve execution permissions, and for the execution itself.\n\n\n-----\n\nNonetheless, this is the first implementation of AtomBombing within the context of banking\nTrojans, probably designed to help Dridex avoid detection.\n\n### Getting the Payload to the Target Process\n\nThis stage is almost identical to what is described in the EnSilo blog, so we’ll explain it briefly\nhere and focus on what’s unique in Dridex’s implementation of this method.\n\nThroughout the injection flow, Dridex needs arbitrary code to be executed by a thread in a\ntargeted process. To do that, it uses Windows asynchronous procedure calls (APC) by\ncalling the NtQueueAPCThread API.\n\nThere’s a reason here for using the native API instead of opting for\nkernel32!QueueUserAPC. It allows three parameters to be passed to the APC routine being\ncalled instead of just one parameter allowed by kernel32!QueueUserAPC.\n\nDuring the flow of the malicious code injection, Dridex uses APC requests, for which it needs\nto find a thread in the target process that is in alertable state, meaning a thread that will\nactually execute APC calls in its queue.\n\nTo test whether a thread is alertable, Dridex creates an event and uses an APC request to\nget the thread to run NtSetEvent to it. It uses a loop to do that with several of the target\nprocess’s threads, then calls WaitForMultipleObjects to select the first thread to signal its\nevent.\n\n_Figure 2: The call to kernel32!CreateEventA._\n\n### Writing the Import Table\n\nNext, Dridex gets the injected process to run memset, again via the NtQueueAPCThread\n[API, to zero-out a RW memory space inside Ntdll’s address space. It then starts writing the](https://msdn.microsoft.com/en-us/library/aa939273%28v=winembedded.5%29.aspx)\nimport table to the allocated memory to be used later by the payload.\n\nThe writing is done by first putting the data of the import table into an atom table using a call\nto GlobalAddAtomW. Next, the malware uses the NtQueueAPCThread API to get the target\nthread to call GlobalGetAtomW, which retrieves the data and places it in the RW memory\nspace in Ntdll.\n\n_Figure 3: Copying the import table data (from injecting process)._\n\n_Figure 4: The import table being built at injected process._\n\n\n-----\n\n## Writing the Payload and Then AtomBombing Out\n\nAfter handling the import table, the payload is written to another RW address space using the\nsame technique, only this time writing large chunks of payload code at each call to\nGlobalGetAtomW.\n\n[At this point, the flow differs from the one described in the AtomBombing technique. To get](https://securityintelligence.com/news/windows-atom-tables-blow-security-researchers-say/)\nthe payload into an executable memory space, Dridex simply calls NtProtectVirtualMemory\nfrom the injecting process to change the memory where the payload is already written into\nRWX. It’s a simple fix and a small compromise for the sake of the overall technique,\ndesigned to avoid making suspicious API calls, which are usually monitored by security\nsoftware.\n\n### Executing the Payload\n\nAfter the preparation, the last stage is the execution of the payload. To avoid calling\nCreateRemoteThread, Dridex again uses APC. Using an APC call to the payload itself would\nbe very suspicious, however, and could be detected and stopped. Instead, it uses the same\nGlobalGetAtomW method to patch GlobalGetAtomA, hooking it to execute the payload.\n\nThis action, of course, requires another call to NtProtectVirtualMemory to make\nGlobalGetAtomA writable. Dridex then proceeds to use the Windows APC to call\nGlobalGetAtomA, which executes the payload.\n\n_Figure 5: Changing protection of first 7 bytes of GlobalGetAtomNameA to RWX (0X40)._\n\n_Figure 6: GlobalGetAtomNameA at injected process (permission changed and code patched_\n_to jump to payload)._\n\n## Additional Enhancements in Dridex v4\n\nBesides building out a new code injection method, Dridex v4 differs from the older versions\nin several other ways. Below are some of the enhancements made to the code in the new\nrelease.\n\n### A Modified Naming Algorithm\n\nDridex uses its own method to generate MD5 hashes using a string concatenation of the\nhostname, active user name, OS installation date and an added seed. These hashes are\nused for many purposes. They can be mutex names, event names, key names for\nconfigurations in the registry, RC4 keys and more.\n\n\n-----\n\nIn the new version, while the same variables are still being used to generate these hashes,\nthe sequence has changed to shuffle things around and prevent detection by automated\nchecks.\n\n### Enhanced Encryption for the Configuration\n\nDridex’s configurations contain many details about its targets and the attack types used in\neach case. Dridex also serves up its redirection scheme from the configuration, which makes\nit a file it aims to protect.\n\n[In v4, Dridex’s developers significantly upgraded the cryptographic protection for the](https://securityintelligence.com/living-in-the-past-business-encryption-needs-to-get-with-the-times-or-get-hacked/)\nconfiguration. Overall, Dridex continues to use the same multilayered approach it used in v3\nvariants, but it has changed and enhanced the encryption while still relying heavily on the\nRC4 cipher.\n\nThe unique binary format in which Dridex keeps its target list configurations, such as the\nURLs of targeted banks, has also received a cryptographic upgrade to keep targeted entities\nin the dark as much as possible.\n\n### Updated Persistence Mechanism\n\nUp until the recent v3 build, Dridex used a very specific, invisible persistence mechanism.\nThis method was called invisible because it was not present at all as long as the infected\nendpoint was up and running. Only before a shutdown of the operating system, Dridex’s\ndynamic link library (DLL) would get written to disk, and a registry value\n(HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run) was created to execute the\nmalicious DLL upon reboot.\n\nThe method was completely abandoned in v4, and Dridex now uses a DLL-hijacking\ntechnique instead. An executable is copied from system32 into a different directory and\nDridex’s DLL is placed in that same directory. The malicious DLL mimics a legitimate DLL\nthat’s loaded by the executable.\n\nAccording to Windows file path priority, the malicious DLL gets loaded instead of the original\none, which is located in system32. These setups are placed in system32 and %AppData%\nfolders and executed by registry run keys and scheduled tasks.\n\nX-Force research noted that this method was already observed in some of the last v3 builds\ndetected in the past few months, but v4 has fully adopted this robustness-over-stealth\napproach for its persistence mechanism.\n\n## Conclusion\n\nThe Dridex malware project continues to evolve, and 2017 is likely to be another year of\nchange for this Trojan.\n\n\n-----\n\nOver the long reign of Dridex v3, we have seen some significant changes implemented into\n[the malware’s operations, such as modified anti-research techniques,](https://securityintelligence.com/protected-api-calls-and-string-constants-looting-dridexs-candy-box/) [redirection attacks and](https://securityintelligence.com/dridex-launches-dyre-like-attacks-in-uk-intensifies-focus-on-business-accounts/)\nfraudulent M.O. changes. It is not surprising to see a new major version released from this\ngang’s developers.\n\nIn this release, we noted that special attention was given to dodging antivirus (AV) products\nand hindering research by adopting a series of enhanced anti-research and anti-AV\ncapabilities.\n\nThe changes to Dridex’s code injection method are among the most significant\nenhancements in v4. They allow Dridex to propagate in the infected endpoint with minimal\ncalls to marked API functions.\n\nThe adoption of a new injection technique shortly after its discovery demonstrates Dridex’s\nefforts to keep up with the times and the evolution of security controls. Although they relied\non a publicized method, Dridex’s developers created their own version of it, a choice that is\nconsistent with their usual preference to write proprietary code schemes for Dridex, as they\ndid for its binary configuration format, for example.\n\n## IOCs\n\nIn this research we analyzed Dridex sample MD5s 4599fca4b67c9c216c6dea42214fd1ce\nand 1e6c6123af04d972b61cd3cde5e0658e.\n\n[Dridex is featured in an X-Force Exchange collection, which is updated regularly. You can](https://www.ibm.com/us-en/marketplace/threat-intelligence-api)\n[view the collection and contribute to it here.](https://exchange.xforce.ibmcloud.com/collection/Dridex-Ongoing-Collection-e49edad121083d7986dc35009dbdeeae)\n\nIBM Security has a great deal of information on Dridex v4 and its attack schemes and can\nhelp banks and other targeted organizations learn more about this high-risk threat. To help\nstop threats like Dridex, banks and service providers can use adaptive solutions to detect\n[infections and protect customer endpoints when malware evolves or enhances its focus on](https://www.ibm.com/software/products/en/trusteer-rapport)\nthe organization’s locale.\n\nFighting evolving threats such as Dridex attacks can be made easier with the right malware\ndetection solutions. With protection layers designed to address the ever-changing threat\nlandscape, financial organizations can benefit from malware intelligence that provides realtime insight into fraudster techniques and capabilities.\n\nConsumers wishing to protect themselves from malware infections on endpoints and mobile\n[devices are invited to read our best practices page.](https://securityintelligence.com/mitigating-malware-modern-mobile-world/)\n\n[Read the white paper: How to outsmart Fraudsters with Cognitive Fraud Detection](https://www-01.ibm.com/marketing/iwm/dre/signup?source=mrs-form-9451&S_PKG=ov54550)\n\n[Magal Baz](https://securityintelligence.com/author/magal-baz/)\nMalware Researcher, IBM Trusteer\n\n\n-----\n\nMagal Baz is a malware researcher for IBM Security s Trusteer s group. He has been a\nmember of the Trusteer cybercrime labs for the past two years. Magal has...\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-02-28 - Dridex’s Cold War- Enter AtomBombing.pdf"
    ],
    "report_names": [
        "2017-02-28 - Dridex’s Cold War- Enter AtomBombing.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535891,
    "ts_updated_at": 1743041169,
    "ts_creation_date": 1653686794,
    "ts_modification_date": 1653686794,
    "files": {
        "pdf": "https://archive.orkl.eu/aa0691d23ff8366ed63574d871949acb5e44149e.pdf",
        "text": "https://archive.orkl.eu/aa0691d23ff8366ed63574d871949acb5e44149e.txt",
        "img": "https://archive.orkl.eu/aa0691d23ff8366ed63574d871949acb5e44149e.jpg"
    }
}