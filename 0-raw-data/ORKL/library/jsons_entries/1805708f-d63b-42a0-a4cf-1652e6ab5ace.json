{
    "id": "1805708f-d63b-42a0-a4cf-1652e6ab5ace",
    "created_at": "2023-01-12T15:04:02.946145Z",
    "updated_at": "2025-03-27T02:05:25.297579Z",
    "deleted_at": null,
    "sha1_hash": "650e3c52330416801ac7a9f8611d154bc32586e7",
    "title": "2021-03-08 - Investigating the Print Spooler EoP exploitation",
    "authors": "",
    "file_creation_date": "2022-05-28T01:54:18Z",
    "file_modification_date": "2022-05-28T01:54:18Z",
    "file_size": 1715778,
    "plain_text": "# Investigating the Print Spooler EoP exploitation\n\n**[techcommunity.microsoft.com/t5/microsoft-defender-for-endpoint/investigating-the-print-spooler-eop-exploitation/ba-p/2166463](https://techcommunity.microsoft.com/t5/microsoft-defender-for-endpoint/investigating-the-print-spooler-eop-exploitation/ba-p/2166463)**\n\nMarch 8, 2021\n\nWe are excited to share a short attack simulation to highlight how Microsoft Defender for Endpoint can\nalert analysts for every suspicious system event that’s related to an intrusion and how analysts can\nmitigate the attacker’s actions right from the alert page. We’ve chosen a relatively straightforward\nexploitation scenario which we believe still carries significant risk for organizations that have not been\nable to update their operating systems. In this scenario, we use the updated Microsoft Defender for\nEndpoint alert page, which has features to make the investigation experience better and more effective.\n\n[SafeBreach, one of our](https://safebreach.com/) [evaluation lab partners for breach and attack simulation solutions, discovered an](https://techcommunity.microsoft.com/t5/microsoft-defender-for-endpoint/microsoft-defender-atp-evaluation-lab-breach-amp-attack/ba-p/1406088)\n[elevation of privilege vulnerability in the Windows print spooler mechanism. This vulnerability, assigned](https://attack.mitre.org/tactics/TA0004/)\n[CVE-2020-1048[i], has already been patched. However, it remains an](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1048)\n\ninteresting case study because of the prevalence of the print spooler mechanism, and the vulnerability’s\ninvolvement in a widely covered high-profile attack in the past.\n\nThe actual exploitation details have already been discussed extensively in other blogs, but in summary,\nthis vulnerability allows an unprivileged user to modify a file that they should not have been able to\naccess, or to create a file in a folder they should not have write access to.\n\n\n-----\n\n_Figure 1. Attack phases of a sample attack using CVE-2020-1048_\n\nThe [print spooler is a Windows component that manages the printing process and runs with system](https://docs.microsoft.com/en-us/windows/win32/printdocs/print-spooler)\nprivileges. Specifically, it can write or modify files in the System32 folder. Since this is a common service\nthat comes preinstalled, any suspicious activity initiated by the spooler might be easily missed.\n\nUnprivileged users could easily add new printers in Windows. Every printer is then associated to a port.\nThe catch is that the printer port, instead of being an actual port, could instead be a path to a file. When\nthe port is a file path, the printer creates a file on the file system and prints content to it. Before the\nvulnerability was patched, this means that any user could print to folders they don’t have access to.\n\nMalicious actors can thus use this vulnerability to create a malicious DLL, for instance, print it to the\nsystem folder, and wait for the system to run it in a classic DLL hijacking attack. We will use this scenario\nin our simulation.\n\nMicrosoft Defender for Endpoint blocks, detects, and remediates the attack. This blog will cover the\nphases of the attack and how Defender for Endpoint correlates these to a single view of an incident,\nproviding the full context of the related alerts, impacted entities, and the investigation.\n\n\n-----\n\n_Figure 2. The incident page providing the full context of the attack_\n\n_Figure 3. Detailed alert story showing steps of the attack and affected assets_\n\n## Step 1: Add a new printer and a printer port\n\nLet’s say an attacker was able to determine that one of the devices in our fictional network has not yet\nbeen patched for CVE-2020-1048 and was able to log on to the device through an effective social\nengineering lure. The first phase of our exploitation scenario is for the attacker to add a new printer on\nthis device called MS Publisher Color Printer. It is then associated to a new printer port which points to\nour targeted system file c:\\windows\\system32\\wbem\\browcli.dll.\n\n\n-----\n\n_Figure 4. Printer and port creation_\n\n_Figure 5. device timeline event showing the printer port was added_\n\nIn the background, whenever a printer port is added, the spooler service adds a registry key containing\nthe value of the path the user pointed to and where they would like to insert content. Since Defender for\nEndpoint monitors registry operations, it will detect this action as a suspicious registry activity right off the\nbat. The analyst will see the following alert:\n\n_Figure 6. Alert flagging suspicious registry entry_\n\n## Step 2: Print content to a restricted file\n\n\n-----\n\nTypically, when a regular user creates a print job, the print job will be stored by the print spooler service\n(spoolsv.exe) to a dedicated folder, System32\\SPOOL\\Printers, as two files: the file, which contains the\ncontent to be printed, and the shadow job file (SHD), which contains the metadata of the print job,\nincluding the path of the printer port that was created. This same behavior is taken advantage of in this\nattack.\n\n_Figure 7. Print job creation_\n\nThe core of this vulnerability is that through adding a printer port that points to the SYSTEM folder and by\nrebooting the spooler service, the attacker gets to run its malicious file when the spooler reloads, running\nas SYSTEM, and \"prints\" to the folder specified in the printer port.\n\n[SafeBreach Labs created](https://safebreach.com/) [proof-of-concept code on GitHub to generate one such crafted SHD file.](https://github.com/SafeBreach-Labs/Spooler)\n\n_Figure 8. Sample SHD file_\n\nNow the attacker simply needs to wait for the print spooler to be initialized after a reboot. The print\nspooler then does its regular function of enumerating the SHD files folder so that it can process any\nremaining print jobs.\n\n_Figure 9. Print spooler enumerates unprocessed print jobs_\n\nIn our exploitation scenario, the attacker was able to write arbitrary data to the path of the printer port\nwhich the attacker should not have had write access to. Just by copying the crafted SHD and SPL files\nand waiting for the system to reboot, the attacker achieved an elevation of privilege.\n\n_Figure 10. Attacker copies crafted print jobs files which triggers the vulnerability._\n\n\n-----\n\nFortunately, analysts will be made aware that this step was performed on the system because Defender\nfor Endpoint will trigger and alert for the file creation of browcli.dll by the print spooler service.\n\n_Figure 11. Alerts flagging suspicious file creation_\n\n## Step 3: Perform DLL hijacking\n\nIn Windows environments, when an application or a service starts, it first loads several dependencies,\nalso known as DLLs, to function properly. If these dependencies don’t exist or are implemented in an\ninsecure way, attackers could load and execute their malicious DLL instead.\n\n[In our attack scenario, the elevation of privilege allows](https://attack.mitre.org/tactics/TA0004/) [code execution using DLL search order](https://attack.mitre.org/tactics/TA0002/)\nhijacking. The DLL actually contains a stager payload which reflectively (in-memory) loads a Meterpreter\nReverse TCP shellcode over a TCP socket.\n\nOnce Windows is restarted, the WMI service (which is running as NT AUTHORITY\\SYSTEM) will\nexecute the browcli.dll library from the C:\\Windows\\System32\\wbem folder, resulting in a reverse\nMeterpreter shell. This provides the attacker the ability to remotely steal information and propagate\nthroughout more computers in the network, among others. The service executes the DLL every time the\nsystem reboots, so the attacker can use the vulnerability to elevate privileges.\n\nIn this case, thanks to the Defender for Endpoint registry, file, and load image sensors, we produced\nstrong detection logic to identify suspicious behaviors indicating any attempt to exploit the vulnerability.\nAt this point, the analyst assigned to this set of alerts will see the following alert story:\n\n\n-----\n\n_Figure 12. Alerts flagging suspicious ‘Meterpreter’ payload in memory_\n\nPlease note that in this specific case we used an un-patched device, with the AV in passive-mode for the\npurpose of the simulation. If Defender AV was enabled, it would have blocked the malware before\nexecution.\n\n_Figure 13. malicious ‘Meterpreter’ activity blocked by Defender AV_\n\n## Seeing the attack story in one view\n\nOn top of the individual suspicious event detection, Defender for Endpoint provides an extensive attack\nstorytelling capability. The incident page is the first stop of the security analyst, where they can learn\nabout the scope of the attack, the related alerts, and the impacted entities across the organization,\ntogether with a full context of the investigation and remediation actions.\n\nDiving in the new alert page, the full story of the suspicious registry activity by the printer port (detected\nby the EDR) followed by the Meterpreter file creation and the file loading events (detected by the AV) will\nbe shown in the same detailed page, making the investigation more efficient and providing a better\nunderstanding of why the alerts were triggered—along with their impact.\n\n\n-----\n\n_Figure 14. Analyst’s first stop - the incident page_\n\n_Figure 15. Full alert story of each step of the attack_\n\n\n-----\n\nThis view of the correlation provides a full visualization of the attack goals and activities. The security\noperations team can clearly see that the alerts are related to the same sequence of events and thus can\nrespond with the full attack context in mind.\n\nThe analyst can then drill down into the DLL tile, which is the malicious binary in this scenario, and see\nall the relevant details and actions, within the context of the investigation. Likewise, each tile in the alert\nstory is expandable and shows more details in the side pane when clicked. Alert tiles are also actionable.\nBy clicking on the \"...\" icon, available actions will be provided directly from the process tree.\n\n_Figure 16. Available actions provided directly from the alert story_\n\nBy opening the automated investigation page, available both in the incident and the alert pages, the\nanalyst can get a better understanding of the actions that were taken on the device, which assets where\ninvolved, and get all the related evidence.\n\n_Figure 17. Alert details and actions_\n\n\n-----\n\n_Figure 18. Automated investigation remediates and quarantines the malicious file_\n\n[Searching for the vulnerability in Weaknesses page in Threat and Vulnerability Management will also](https://www.microsoft.com/en-us/security/business/threat-protection/threat-vulnerability-management)\nhelp to identify all the other devices that might be vulnerable to spooler EoP:\n\n_Figure 19. Exposed devices in weaknesses page_\n\nFurthermore, the details pane provides information about which MITRE ATT&CK technique was used in\neach step. These are incredibly useful in post-activity learning in incident response as it identifies which\ngaps exist in the current configuration of the network so the analyst can make recommendations to\nadmins to improve security to avoid or lessen the impact of the next attack.\n\n\n-----\n\n_Figure 20. MITRE ATT&CK techniques and alerts flagged for each attacker step_\n\nAs you have seen, using the SafeBreach attack simulations, Defender for Endpoint was able to detect\nthe attack across the different kill-chain stages, provide a full investigation experience across detection\nand protection, including all data needed and by that telling the full alert story. The security operations\nteam can explore all relevant details and take action on each related entity—without leaving the context\nof the alert investigation, designed to make the investigation experience efficient and easy.\n\n[To learn more about the new alert page, please read our documentation and](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/review-alerts) [blog post.](https://techcommunity.microsoft.com/t5/microsoft-defender-for-endpoint/say-hello-to-the-new-alert-page-in-microsoft-defender-atp/ba-p/1463673)\n\nIf you’re not yet taking advantage of Microsoft Defender for Endpoint’s industry leading security optics\n[and detection capabilities, we encourage you to sign up for a free trial today.](https://www.microsoft.com/en-us/microsoft-365/security/endpoint-defender?rtc=1?rtc=1)\n\n[Peleg Hadar SafeBreach Labs](https://www.linkedin.com/in/peleghd/)\n\n[Charles-Edouard Bettan &](https://www.linkedin.com/in/charles-edouard-bettan-3220a142/) [Yonit Glozshtein Microsoft Defender for Endpoint team](https://www.linkedin.com/in/yonit-glozshtein-724932107/)\n\n______________________________________________________________________________________\n\n[i] Microsoft released fixes to address fix bypasses to CVE-2020-1048. These were documented as CVE2020-1337 and CVE-2020-17001. While we are not discussing the details of those CVEs, the detection\nfor CVE-2020-1048 also detects attempts to exploit CVE-2020-1337 and CVE-2020-17001.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-08 - Investigating the Print Spooler EoP exploitation.pdf"
    ],
    "report_names": [
        "2021-03-08 - Investigating the Print Spooler EoP exploitation.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535842,
    "ts_updated_at": 1743041125,
    "ts_creation_date": 1653702858,
    "ts_modification_date": 1653702858,
    "files": {
        "pdf": "https://archive.orkl.eu/650e3c52330416801ac7a9f8611d154bc32586e7.pdf",
        "text": "https://archive.orkl.eu/650e3c52330416801ac7a9f8611d154bc32586e7.txt",
        "img": "https://archive.orkl.eu/650e3c52330416801ac7a9f8611d154bc32586e7.jpg"
    }
}