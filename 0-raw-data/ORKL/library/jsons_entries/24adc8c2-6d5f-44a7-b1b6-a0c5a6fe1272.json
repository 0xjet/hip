{
    "id": "24adc8c2-6d5f-44a7-b1b6-a0c5a6fe1272",
    "created_at": "2023-01-12T15:08:52.272053Z",
    "updated_at": "2025-03-27T02:16:01.160259Z",
    "deleted_at": null,
    "sha1_hash": "dc3f643e13fd70dc1d6b876daa7e04f0cda1f748",
    "title": "2020-01-24 - Hunting for Ransomware",
    "authors": "",
    "file_creation_date": "2022-05-28T19:32:29Z",
    "file_modification_date": "2022-05-28T19:32:29Z",
    "file_size": 2087211,
    "plain_text": "# Hunting for Ransomware\n\n**blog.reversinglabs.com/blog/hunting-for-ransomware**\n\n[Security Operations | January 24, 2020](https://blog.reversinglabs.com/blog/tag/security-operations)\n\n\n-----\n\nBlog Author\nRobert Simmons, Independent malware researcher and threat researcher at\n[ReversingLabs. Read More...](https://blog.reversinglabs.com/blog/author/robert-simmons)\n\n\n-----\n\n## November Update:\n\nHere’s your opportunity to hear directly from Rob Simmons, Threat Researcher involved in\n#Ryuk ransomware research.\n\nJoin us to learn:\n\nThe current state of Ransomware and how it is becoming more targeted\nHow to use the A1000 to hunt for threats using YARA\nHow to bring new visibility about file risks into your SOC process\nHow to apply this new intelligence on Ryuk to actively update your defenses\n\nRegister for our November 17 webinar here:\n\nhttps://reversinglabs.zoom.us/webinar/register/6215881027977/WN_X6tAd0NTeSRllyjtEQS0g\n\nMany ransomware families have changed their tactics and victim-targeting in recent years.\nRather than indiscriminate attacks against anyone they’re able to infect, they have moved to\na process called “big game hunting”. The motivation underlying this change of tactics is to\nincrease the potential payout by targeting an organization rather than an individual. The\nadversary performs extensive reconnaissance on the target to determine what they may be\nable to pay. Rather than small ransom demands in thousands of dollars, by targeting\nbusinesses, they are aiming for payouts in the hundreds of thousands to millions of dollars.\n\nOne malware family in particular, Ryuk [1], has been attributed to the GRIM SPIDER [2] threat\nactor group. According to malpedia.io, this group has been operating the Ryuk ransomware\n\n\n-----\n\nsince August of 2018 [ ]. In recent months, a staged attack dubbed triple threat [ ] has\nemerged with the initial access to the network achieved by the Emotet [5] malware family.\nOnce initial access is achieved, the next stage, TrickBot [6], delivered inside the target\norganization. TrickBot has capabilities to steal credentials and to move laterally within the\norganization’s network. The third stage of the attack is to execute Ryuk ransomware on as\nmany workstations and servers as possible via the lateral movement of TrickBot.\nTo hunt for and identify Ryuk samples, many YARA [7] rules search for strings that are hardcoded in the sample. However, this type of strings-based rule may be prone to false\npositives. An excellent conference talk that includes this topic given by Lauren Pierce at\nShmooCon 2017 should be watched for more information about this concept. [8] Rather than\nhunting for these hard-coded strings, one should be hunting for code patterns in the sample.\nRules of this type do more damage to the adversary’s intrusion set according to David\nBianco’s Pyramid of Pain. [9] More painful code changes are needed to avoid detection by\nthis paradigm of YARA rule. Here, we examine a single algorithm that Ryuk uses in the latest\n64bit variant to generate a random string. This string is part of the filename that Ryuk uses\nwhen dropping a copy of itself during the installation phase of intrusion.\n\nLooking at the execution of the Ryuk sample [10] in x64dbg, [11] we see that the first step\ntaken is to gather entropy from the tick count of the victim’s computer. In Figure 1, we see the\nlibrary function call to GetTickCount to gather this randomness.\n\n\n**Figure 1: Entropy Input From Tick Count**\n\nAccording to Microsoft’s documentation, GetTickCount returns “the number of milliseconds\nthat have elapsed since the system was started.” [12] The function called immediately after is\na C library function, srand. This function takes a seed value and initializes the random\nnumber generator. The srand and rand functions’ identities were detected using Ghidra’s [13]\nfunction signatures during its code analysis process.\n\n\nThe random number generator initialized by srand is subsequently used by rand function\ncalls to generate random data. The goal of generating this data is to produce a random\nstring. However, not all the bytes of randomness generated can be used in a filename, so a\nsubsequent function checks the output to verify that the generated byte is an alphabet\ncharacter and therefore valid for a filename. This function has been labelled as “isalpha” in\n\n\n-----\n\nFigure 2.\n\n**Figure 2: Repeat Until String is Alphabet Characters**\n\nIf the byte fails this test, execution jumps back to the rand function and a new random byte is\ngenerated. This loop continues until all the characters are alphabet characters, and the\ngenerated string is therefore usable as a filename.\n\nTo write an effective YARA rule for detecting this algorithm, first we examine the srand\nfunction and find a hexadecimal string that can be used to match the function. Figure 3\nshows the srand function in the debugger’s disassembler.\n\n**Figure 3: Disassembled srand Function**\n\nThe goal is to identify enough bytes from this function to differentiate it from other functions\nin the sample, but still allow enough wiggle room for slight changes due to the compiler.\n\n**$srand = { 40 53 48 83 ?? 20 8B ?? E8 [4] 89 }**\n\nThe hexadecimal string seen above identifies the srand function, but leaves room for the\ndestination registers to change and still match the function. [14] These wildcards are\nrepresented as “??”. The four byte jump “[4]” allows for the address of the “__acrt_getptd”\nfunction to change locations.\n\n\n-----\n\nNext we repeat the same process by examining the rand function in the debugger.\n\n**Figure 4: Disassembled rand Function**\n\nFor this function the following hexadecimal string identifies it and differentiates it from other\nsimilar functions in the sample.\n\n**$rand = { 48 83 ?? 28 E8 [4] 69 }**\n\nAgain, wildcards are used to allow for changes in destination registers as well as a four byte\njump that allows for the location of the called function to change.\n\nNext we analyze the “isalpha” function that is called to check if the random byte is an\nalphabet character. This function is not a library function. It is adversary written code and a\n\n\n-----\n\ncontrol flow graph of the function is seen in Figure 5.\n\n**Figure 5: Control Flow Graph of the isalpha Function**\n\nTo develop a signature that detects this function, we look more closely at the very first code\nblock.\n\n**Figure 6: First Code Block of isalpha Function**\n\nFollowing the same methodology to write a signature as above, destination registers except\nfor the opcode “movsxd” are replaced with wildcards. Then the location of the pointer from\nthe “mov” instruction is replaced with a four byte jump. The resulting hexadecimal string is as\nfollows:\n\n\n-----\n\n**$isalpha = { 40 53 48 83 EC ?? 48 63 D9 8B 05 [4] 85 C0 74 4E }**\n\nArmed with the locations of the three functions, we return to analyzing the code that is used\nto call them. This code can be split into two separate opcode signatures. This will allow for\nvariation in the code between these two code snippets thereby still identifying this adversary\ncode even if it changes slightly as the ransomware code is developed for new variants of\nRyuk.\n\n**Figure 7: First Set of Instructions as Seen in Debugger**\n\n**Figure 8: Second Set of Instructions as Seen in Debugger**\n\nBy following the process of allowing for variation in destination registers as well as the\nlocation of the called functions, the following two opcode signatures are developed:\n\n**$op1 = { E8 [4] 49 8B ?? E8 [4] ?? }**\n\n**$op2 = { 03 ?? 8B ?? E8 [4] 85 C0 74 ?? }**\n\nNow that we have signatures for the functions that are called as well as signatures for the\ncode that calls them, we tie these together by comparing the bytes found in the opcode that\ncalls the function with the location of the called function. This is done by using YARA\ncondition statements to calculate the locations. This first condition statement verifies that the\nfirst opcode calls the srand function:\n\n**uint32(@op1 + 1) + @op1 + 5 == @srand**\n\nThis condition verifies that the first opcode then calls the rand function:\n\n**uint32(@op1 + 9) + @op1 + 13 == @rand**\n\nAnd this condition verifies that the second opcode calls the isalpha function:\n\n**uint32(@op2 + 5) + @op2 + 9 == @isalpha**\n\n\n-----\n\nThe last instruction seen in Figure 8 is a jump that leads back to the rand function to\ngenerate a new byte of random data if the previous byte was not an alphabet character. The\nfollowing condition reflects this jump and allows for the landing address of the jump to\nchange based on differences at compile time or code changes between the two opcode\nsnippets.\n\n**@op2 + 5 + int8(@op2 + 12) == @op1**\n\nNow that we have a fully formed YARA rule, we can hunt for samples of Ryuk using the\nTitanium Platform that are related to the one that we started with. The complete YARA rule is\nprovided at the bottom.\n\n## Hunting for Ryuk\n\nBy loading the YARA rule into the ReversingLabs A1000’s threat hunting system, we\ndiscover that the rule is highly accurate and has matched nine other Ryuk 64bit samples that\nare all related to the sample that we started with.\n\n**Figure 9: YARA Hunting Results**\n\nLooking at each sample’s analysis results, we can additionally see that the ReversingLabs\nHash Algorithm [15] has associated these same files together as a cluster.\n\n\n-----\n\n**Figure 10: ReversingLabs Hash Algorithm Cluster**\n\nNext, we can see that the Titanum Platform has determined the threat name as\n“Win64.Trojan.Ryuk” for each of the identified samples via the cloud classification system.\n\n**Figure 11: Titanium Cloud Classification as Win64.Trojan.Ryuk**\n\nFinally, we can drill into the file’s indicators and see what has been extracted during analysis\nby ReversingLabs Titanium Platform. In Figure 12, we see some of the hallmarks of\nransomware: tampering with security products to disable them, disabling backups to prevent\ndata recovery, writing and deleting files during the encryption process, stopping services and\nprocesses so that more data can be encrypted, and usage of cmd.exe to run CLI commands.\n\n\n-----\n\n**Figure 12: Indicators Detected by Titanium Platform**\n\nAs we have seen, by starting with one sample, and analyzing its code, a YARA signature can\nbe developed to identify more related samples. Furthermore, by leveraging the Titanium\nPlatform, these related files can be confirmed as being related. If further analysis is\nwarranted, static features analysis in the A1000 allows the researcher to delve deeper into\nthe capabilities of the ransomware and its related samples from a particular campaign.\n\n## YARA Rule\n\n### Ryuk64\n\n\n-----\n\n**rule RepeatUntil_Alpha : Ryuk64**\n**{**\n**meta:**\n**author = \"Malware Utkonos\"**\n**date = \"2019-09-22\"**\n**exemplar = \"18faf22d7b96bfdb5fd806d4fe6fd9124b665b571d89cb53975bc3e23dd75ff1\"**\n**description = \"Repeat generation of random data until filename string is all alpha**\n**characters\"**\n**strings:**\n**$srand = { 40 53 48 83 ?? 20 8B ?? E8 [4] 89 }**\n**$rand = { 48 83 ?? 28 E8 [4] 69 }**\n**$isalpha = { 40 53 48 83 EC ?? 48 63 D9 8B 05 [4] 85 C0 74 4E }**\n**$op1 = { E8 [4] 49 8B ?? E8 [4] ?? }**\n**$op2 = { 03 ?? 8B ?? E8 [4] 85 C0 74 ?? }**\n**condition:**\n**WindowsPE and all of them and**\n**uint32(@op1 + 1) + @op1 + 5 == @srand and // call srand**\n**uint32(@op1 + 9) + @op1 + 13 == @rand and // call rand**\n**uint32(@op2 + 5) + @op2 + 9 == @isalpha and // call isalpha**\n**@op2 + 5 + int8(@op2 + 12) == @op1 // jump to rand call until all characters are alpha**\n**}**\n\n[1] [https://malpedia.caad.fkie.fraunhofer.de/details/win.ryuk](https://malpedia.caad.fkie.fraunhofer.de/details/win.ryuk)\n\n\n\n[2]\n\n[3] ibid.\n\n[4] https://searchsecurity.techtarget.com/news/252461071/Triple-threat-malware-campaign\ncombines-Emotet-TrickBot-and-Ryuk\n\n\n\n[5]\n\n[6] [https://malpedia.caad.fkie.fraunhofer.de/details/win.trickbot](https://malpedia.caad.fkie.fraunhofer.de/details/win.trickbot)\n\n[7]\n\n[8] [https://youtu.be/_BfLSRjHWo8?t=1252](https://youtu.be/_BfLSRjHWo8?t=1252)\n\n\n\n[9] [https://detect-respond.blogspot.com/2013/03/the-pyramid-of-pain.html](https://detect-respond.blogspot.com/2013/03/the-pyramid-of-pain.html)\n\n[10] 18faf22d7b96bfdb5fd806d4fe6fd9124b665b571d89cb53975bc3e23dd75ff1\n\n\n\n[11] [https://x64dbg.com/](https://x64dbg.com/)\n\n[12] [https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount](https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount)\n\n\n\n[13] [https://ghidra-sre.org/](https://ghidra-sre.org/)\n\n[14] [Thanks to Wesley Shields https://twitter.com/wxs for this critical signature technique.](https://twitter.com/wxs)\n\n\n-----\n\n[ ] [https://www.reversinglabs.com/technology/reversinglabs-hash-algorithm](https://www.reversinglabs.com/technology/reversinglabs-hash-algorithm)\n\n### MORE BLOG ARTICLES\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-24 - Hunting for Ransomware.pdf"
    ],
    "report_names": [
        "2020-01-24 - Hunting for Ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "8492b1a0-126f-4113-b8f7-101d28559629",
            "created_at": "2023-01-06T13:46:38.864213Z",
            "updated_at": "2025-03-27T02:00:02.938147Z",
            "deleted_at": null,
            "main_name": "GRIM SPIDER",
            "aliases": [
                "GOLD ULRICK"
            ],
            "source_name": "MISPGALAXY:GRIM SPIDER",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "63061658-5810-4f01-9620-7eada7e9ae2e",
            "created_at": "2022-10-25T15:50:23.752974Z",
            "updated_at": "2025-03-27T02:00:55.538582Z",
            "deleted_at": null,
            "main_name": "Wizard Spider",
            "aliases": [
                "Wizard Spider",
                "UNC1878",
                "TEMP.MixMaster",
                "Grim Spider",
                "FIN12",
                "GOLD BLACKBURN",
                "ITG23",
                "Periwinkle Tempest",
                "DEV-0193"
            ],
            "source_name": "MITRE:Wizard Spider",
            "tools": [
                "TrickBot",
                "AdFind",
                "BITSAdmin",
                "Bazar",
                "LaZagne",
                "Nltest",
                "GrimAgent",
                "Dyre",
                "Ryuk",
                "Conti",
                "Emotet",
                "Rubeus",
                "Mimikatz",
                "Diavol",
                "PsExec",
                "Cobalt Strike"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e6a21528-2999-4e2e-aaf4-8b6af14e17f3",
            "created_at": "2022-10-25T16:07:24.422115Z",
            "updated_at": "2025-03-27T02:02:10.216817Z",
            "deleted_at": null,
            "main_name": "Wizard Spider",
            "aliases": [
                "DEV-0193",
                "Gold Blackburn",
                "Gold Ulrick",
                "Grim Spider",
                "ITG23",
                "Operation BazaFlix",
                "Periwinkle Tempest",
                "TEMP.MixMaster",
                "Wizard Spider"
            ],
            "source_name": "ETDA:Wizard Spider",
            "tools": [
                "AdFind",
                "Agentemis",
                "Anchor_DNS",
                "BEERBOT",
                "BazarBackdoor",
                "BazarCall",
                "BazarLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "Conti",
                "Diavol",
                "Dyranges",
                "Dyre",
                "Dyreza",
                "Dyzap",
                "Gophe",
                "Invoke-SMBAutoBrute",
                "KEGTAP",
                "LaZagne",
                "LightBot",
                "PowerSploit",
                "PowerTrick",
                "PsExec",
                "Ryuk",
                "SessionGopher",
                "TSPY_TRICKLOAD",
                "Team9Backdoor",
                "The Trick",
                "TheTrick",
                "Totbrick",
                "TrickBot",
                "TrickLoader",
                "TrickMo",
                "Upatre",
                "bazaloader",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "53f39e5d-6d69-4402-b03c-ec2dbe045788",
            "created_at": "2024-06-19T02:03:08.132007Z",
            "updated_at": "2025-03-27T02:05:17.401832Z",
            "deleted_at": null,
            "main_name": "GOLD ULRICK",
            "aliases": [
                "UNC1878 ",
                "Grim Spider "
            ],
            "source_name": "Secureworks:GOLD ULRICK",
            "tools": [
                " Buer Loader",
                " Cobalt Strike",
                " Conti",
                " Diavol",
                " Powershell Empire",
                " Ryuk",
                " SystemBC",
                " Team9 (aka BazarLoader)",
                " TrickBot",
                "Bloodhound"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536132,
    "ts_updated_at": 1743041761,
    "ts_creation_date": 1653766349,
    "ts_modification_date": 1653766349,
    "files": {
        "pdf": "https://archive.orkl.eu/dc3f643e13fd70dc1d6b876daa7e04f0cda1f748.pdf",
        "text": "https://archive.orkl.eu/dc3f643e13fd70dc1d6b876daa7e04f0cda1f748.txt",
        "img": "https://archive.orkl.eu/dc3f643e13fd70dc1d6b876daa7e04f0cda1f748.jpg"
    }
}