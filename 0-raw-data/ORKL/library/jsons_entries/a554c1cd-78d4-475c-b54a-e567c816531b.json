{
    "id": "a554c1cd-78d4-475c-b54a-e567c816531b",
    "created_at": "2024-12-17T02:05:41.250449Z",
    "updated_at": "2025-03-27T02:16:13.981593Z",
    "deleted_at": null,
    "sha1_hash": "1a1e46218346ec29349456e34e7ced6da6ecc85e",
    "title": "",
    "authors": "",
    "file_creation_date": "2024-09-24T12:09:26Z",
    "file_modification_date": "2024-09-24T12:09:27Z",
    "file_size": 781645,
    "plain_text": "#### 2 - 4 October, 2024 / Dublin, Ireland\n\n# THE MASK HAS BEEN UNMASKED AGAIN\n\n## Georgy Kucherin & Marc Rivero López\n\n### Kaspersky, Russia & Spain\n\n#### georgy.kucherin@gmail.com mriverolopez@gmail.com\n\n www virusbulletin com\n\n\n-----\n\n**ABSTRACT**\n\nThe Mask (also known as Careto) is an advanced threat actor that has been operating since at least 2007. In the past, it was\nobserved to conduct cyber espionage campaigns that mainly targeted high-profile organizations. This actor’s attacks have\nalways been remarkable from the technical perspective, as they commonly involve use of zero-day exploits, bootkits, and\nmodular backdoors for different operating systems.\n\nOver the last decade, The Mask has been doing its best to avoid getting caught by researchers: since 2014 there has not been\nany information about the group. Nevertheless, in our recent research we have managed to uncover a number of new\ncampaigns by this threat actor – with the latest dated up to early 2024. In our paper we provide details about these campaigns,\nfocusing on how The Mask has been achieving initial access, lateral movement, malware execution and data exfiltration.\n\nSpecifically, we first describe how The Mask leveraged the MDaemon email server of one of the target organizations to\ngain an initial foothold inside it. We then detail how this threat actor used a previously unknown bug in a security solution\nto covertly spread malicious implants across machines. Afterwards, we discuss capabilities of the delivered implants, as\nwell as the stealth measures implemented inside them.\n\nThe Mask has always conducted cyber attacks with extreme caution. Despite this, members of this threat group have managed\nto make small but fatal mistakes during their recent operations. In the paper, we describe these errors, specifying how they\nhelped us not only detect the discussed malicious activities, but also perform attribution of the discovered campaigns.\n\nAt the end of the paper we present a comparison between The Mask’s historical and more recent attacks to demonstrate\nhow the group’s operations have evolved over the years.\n\n**INTRODUCTION**\n\nThe Mask is an APT group that has been observed performing highly sophisticated attacks that have mainly been targeting\ngovernment organizations, diplomatic entities, energy companies and research institutions. It has been known to use\nzero-day exploits, as well as unique, professionally coded implants for Windows, macOS and Linux.\n\nAttacks by this APT threat actor have been observed since 2007, up until 2013 [1]. Notably, no news about this threat group\nhas been released since that time. However, we have discovered two recent cluster of infections, which we attribute to The\nMask with medium to high confidence:\n\n - An infection at an organization in Latin America, carried out in 2019.\n\n - A successful attack against the same organization in Latin America, executed in 2022. Notably, the malware used in\nthese attacks, which we dubbed FakeHMP, was also observed deployed on the machine of an unidentified individual or\norganization as recently as January 2024.\n\nIn the following sections of this paper we provide information about these infections, first discussing the recent ones that\noccurred in 2022 and 2024, and then the historical ones, carried out in 2019.\n\n**MDAEMON SERVER INFECTION**\n\nWhile there is no data trace on how the machine in 2024 came to be infected, we did manage to find out how the\norganization located in Latin America was compromised back in 2022. Specifically, we have established that attackers\nmanaged to compromise the organization’s email server, which was running the MDaemon email software. While we have\nnot identified the exact method used to hack the server, we have established that the compromised server was used for\nmaintaining persistence within the organization’s network. As for the persistence method used, it is rather unique. It\ninvolves using MDaemon’s webmail component called WorldClient:\n\n_Figure 1: WorldClient webmail authentication panel._\n\n\n-----\n\nWorldClient allows loading extensions (which are similar to IIS extensions), which can handle HTTP requests coming from\nclients. These extensions are registered in the file C:\\MDaemon\\WorldClient\\WorldClient.ini. In order to register an\nextension, the relative URL controlled by the extension must be specified (in the parameter CgiBase), as well as the path\nto the extension DLL (in the parameter CgiFile). The extension DLLs are loaded by the WorldClient.exe process.\n\nIn order to establish persistence, the APT group has built its own malicious WorldClient extension and configured it by\nadding the entries for CgiBase6 (containing the relative URL /WorldClient/mailbox) and CgiFile6 (containing the\npath to the extension DLL, C:\\MDaemon\\WorldClient\\HTML\\MDMBoxSrch.dll). By doing this, adversaries became\nable to interact with the malicious extension by making HTTP requests to the URL https://<webmail server domain\n```\nname>/WorldClient/mailbox. It is also important to mention that, as the email server had an external IP address, any\n\n```\ncomputer connected to the internet could be used to interact with the malicious extension.\n\n_Figure 2: WorldClient webmail authentication panel (entries corresponding to the malicious extension are underlined)._\n\nIt should be noted that the described persistence method cannot be detected with common auto-start application detection\ntools such as Autoruns.\n\n**INSTALLED MALICIOUS EXTENSION**\n\nThe malicious WorldClient extension discovered on the organization’s email server exhibits three exports\n\n**Export name** **Export function activity**\n\n`GetExtensionVersion` Places the string Mailbox Search Module for MDaemon Messaging\n```\n                   Server, Version 21.0.0 inside the HSE_VERSION_INFO structure\n\n```\npassed in an argument.\n\n`TerminateExtension` Auxiliary function, performs memory cleanup.\n\n`HttpExtensionProc` Processes the HTTP requests that are handled by the extension.\n\nThe extension that processes POST requests sent to the URL https://<webmail server domain name>/\n```\nWorldClient/mailbox can serve two functions:\n\n```\n - Execute an attacker-supplied command. The ID of the command is specified in the QueryID URL parameter, while the\ncommand parameters are specified in the POST request body. In order to execute a command, the extension loads the\nlibrary located at C:\\MDaemon\\App\\MDUserQuery.dll and calls its runMBoxSrch export, passing it the URL\nparameters and the request body.\n\n - Update the MDUserQuery.dll library (described below) that is used for processing commands. The DLL body is\nprovided in the POST request body, while the DLL body size is specified in the CalStart URL parameter.\n\nAdditionally, the request’s Reload URL parameter is set to ‘Yes’.\n\n**THE COMMAND PROCESSING LIBRARY**\n\nAs mentioned above, the MDUserQuery.dll library has one export called runMBoxSrch, which processes commands\nsupplied by the attacker. It supports the following commands:\n\n|Export name|Export function activity|\n|---|---|\n|GetExtensionVersion|Places the string Mailbox Search Module for MDaemon Messaging Server, Version 21.0.0 inside the HSE_VERSION_INFO structure passed in an argument.|\n|TerminateExtension|Auxiliary function, performs memory cleanup.|\n|HttpExtensionProc|Processes the HTTP requests that are handled by the extension.|\n\n\n-----\n\n|Command ID|Command description|\n|---|---|\n|01|Lists DLL modules loaded into the WorldClient.exe process, running processes and installed services.|\n|02|Starts a process specified in the command arguments, redirecting its output to a pipe, waits for the process to finish and sends its output to the attacker.|\n|10|Writes a file on disk and timestomps it.|\n|11|Drops an executable specified in the command body to the path C:\\MDaemon\\WorldClient\\ Temp\\C3OB7RCITKJBI\\MDSync.exe and then launches it, redirecting its output to a pipe. After the process finishes, the command sends its output to the attacker and removes the executable file.|\n|12|Sends contents of a specified file.|\n|13|Removes a specified file.|\n|14|Performs timestomping on a specified file.|\n|15|Lists contents of a specified directory.|\n|16|Overwrite file contents without changing the file’s timestamps.|\n\n\nHaving installed the MDaemon backdoor, attackers used it to perform reconnaissance of the infected organization network\nand perform spreading to machines of interest inside it.\n\n**SPREADING VIA SCHEDULED TASKS**\n\nIn the infection case occurring in 2022, attackers were observed to perform spreading to other machines by using scheduled\ntasks. Over the course of doing that, attackers copied the following files to remote machines:\n\n**File name** **Path on remote machine** **Description**\n\n`hmpalert.sys` `C:\\Windows\\System32\\drivers\\` Legitimate driver of the HitmanPro Alert\n`hmpalert.sys` software.\n\n`hmpalert.dll` `C:\\Windows\\System32\\hmpalert.` A malicious DLL named exactly after a\n`dll` legitimate component of the HitmanPro Alert\nsoftware, containing an implant we dubbed\nFakeHMP.\n\n`~DFAE01202C5F0DBA42.cmd C:\\Windows\\` Malicious .bat file.\n```\n               Temp\\~DFAE01202C5F0DBA42.cmd\n\n```\n`Tpm-HASCertRetr.xml` `c:\\Windows\\Temp\\` Malicious .xml file, containing a description of\n`TpmHASCertRetr.xml` a scheduled task configured to launch the file\n```\n                                  ~DFAE01202C5F0DBA42.cmd.\n\n```\nFollowing that, attackers executed the following sequence of commands that:\n\n - Create a scheduled task with the description specified in the Tpm-HASCertRetr.xml file:\n```\n  schtasks /create /S \\\\<remote victim machine IP address> /U <remote machine username>\n  /P <remote machine user password> /tn \"Microsoft\\Windows\\WindowsColorSystem\\pm  HASCertRetr\" /XML \"C:Windows\\Temp\\Tpm-HASCertRetr.xml\");\n\n```\n - Launch the created scheduled task to execute the C:\\Windows\\Temp\\~DFAE01202C5F0DBA42.cmd script on the\nremote machine:\n```\n      schtasks /run /S \\\\<remote victim machine IP address> /U <remote machine\n      username> /P <remote machine user password> /tn \"Microsoft\\Windows\\\n      WindowsColorSystem\\pm-HASCertRetr\");\n\n```\n - Remove the created scheduled task after the execution of the .bat file is finished:\n```\n       schtasks /delete /S \\\\<remote victim machine IP address> /U <remote\n       machine username> /P <remote machine user password> /tn \"Microsoft\\\n       Windows\\WindowsColorSystem\\pm-HASCertRetr\" /F);\n\n```\nIn turn, the .bat file that is launched by the scheduled task contains the following lines:\n\n|File name|Path on remote machine|Description|\n|---|---|---|\n|hmpalert.sys|C:\\Windows\\System32\\drivers\\ hmpalert.sys|Legitimate driver of the HitmanPro Alert software.|\n|hmpalert.dll|C:\\Windows\\System32\\hmpalert. dll|A malicious DLL named exactly after a legitimate component of the HitmanPro Alert software, containing an implant we dubbed FakeHMP.|\n|~DFAE01202C5F0DBA42.cmd|C:\\Windows\\ Temp\\~DFAE01202C5F0DBA42.cmd|Malicious .bat file.|\n|Tpm-HASCertRetr.xml|c:\\Windows\\Temp\\ TpmHASCertRetr.xml|Malicious .xml file, containing a description of a scheduled task configured to launch the file ~DFAE01202C5F0DBA42.cmd.|\n\n\n-----\n\nThese commands add several entries to the registry key HKLM\\SYSTEM\\CurrentControlSet\\Services\\hmpalert,\ninstall the hmpalert.sys driver and configure it to be loaded on machine startup. As described below, this driver is abused to\nload the FakeHMP implant.\n\n**SPREADING VIA GOOGLE UPDATER**\n\nIn the 2024 infection case, we observed attackers configuring the FakeHMP implant in an alternative way. In order to\n\nachieve that, they placed a malicious DLL named goopdate.dll into the folder C:\\Program Files (x86)\\Google\\\n```\nUpdate. This folder contains the legitimate Google Updater executable configured to run regularly on the machine. By\n\n```\nplacing the malicious DLL inside this folder, attackers made it sideload on each regular launch of Google Updater. This\ntechnique is not novel and has previously been observed used by other threat actors, such as MuddyWater [2].\n\nAs for the installer itself, it performs the same actions as the previously described .bat file: it adds HitmanPro-related\nentries to the registry and creates the hmpalert service to launch the driver on startup.\n\n**THE FAKEHMP IMPLANT**\n\nThis implant was found on machines in both cases from 2022 and 2024, where it gets loaded on startup through\n```\nhmpalert.sys (SHA256 hash: 9733eb1802daf774cfe576179b1096b5861593d702c6c0226b75410b13dab6ae),\n\n```\na legitimate driver of the HitmanPro Alert security solution. One of its responsibilities is to load HitmanPro’s DLL\nlocated at C:\\Windows\\System32\\hmpalert.dll into every running process. However, the DLL-loading\nimplementation is flawed: the driver does not verify the DLL file’s legitimacy before loading. The threat actor decided\nto abuse this bug to leverage the legitimate security solution’s driver for its malicious persistence. By placing a\nmalicious DLL at C:\\Windows\\System32\\hmpalert.dll and installing the hmpalert.sys driver, the attackers made\nthe legitimate driver load the malicious DLL into every running process.\n\nWith this DLL loaded into every process, it performs malicious operations from three processes only. To decide whether it\nshould work this way from a given process, this DLL computes the SHA256 hash of its command line on startup,\ncomparing it with the three following values:\n\n**SHA256 hash** **Command line** **corresponding**\n**to the hash**\n```\n050bddfe5597632d7b9ec4ff1c49e8cd860ec25d077bee31f2ba3a0394b447f8 winlogon.exe\n096eae3dc85a866fccd68496d897af673af6d2455ef6a8d09d5f4ac2d84d9bd1 \"dwm.exe\"\na3930f657677999ef3b567bd40d527f2463fc29931eac43e134739f98a90b595 svchost.exe -k\n                                         NetworkService -p -s\n                                         CryptSvc\n\n```\nIf the command line hash does not match any of the three hashes above, the DLL unloads itself. Otherwise, it:\n\n - Decrypts its resource (type: RCDATA, ID: 300) with AES and decompresses it, thus obtaining a second-stage DLL\n\n - Reflectively loads the decrypted DLL and invokes its entry point function\n\n - Unloads itself.\n\nAs a result of these actions, FakeHMP gets loaded into three processes: winlogon.exe, dwm.exe and svchost.exe. It is\nimportant to note that traces of this implant cannot be spotted by examining the list of loaded modules, e.g. with tools like\n_Process Explorer. Additionally, the hmpalert.dll library cannot be spotted in the list of loaded modules, since it gets_\nunloaded immediately after launching the second-stage payload.\n\nThe instances of FakeHMP placed inside the three processes work simultaneously. They communicate with each other via a\nnamed pipe called \\\\.\\pipe\\9952763031, where the number may vary between samples.\n\n|SHA256 hash|Command line corresponding to the hash|\n|---|---|\n|050bddfe5597632d7b9ec4ff1c49e8cd860ec25d077bee31f2ba3a0394b447f8|winlogon.exe|\n|096eae3dc85a866fccd68496d897af673af6d2455ef6a8d09d5f4ac2d84d9bd1|\"dwm.exe\"|\n|a3930f657677999ef3b567bd40d527f2463fc29931eac43e134739f98a90b595|svchost.exe -k NetworkService -p -s CryptSvc|\n\n\n-----\n\nThe payload inside the winlogon.exe process is responsible for reading commands from the pipe and executing them. It\nsupports two types of commands:\n\n - Read a file from disk (the filename is specified in the command) and send its contents to the pipe.\n\n - Reflectively load a DLL (its body is specified in the command) and invoke its entry point function.\n\nThe payload hosted in dwm.exe logs keystrokes and takes screenshots. The keylogging method involves using the DirectX\nlibrary. Logged keystrokes are sent to the pipe. Screenshots are taken using the GDI API (in JPEG format) and also sent to\nthe pipe.\n\nThe data sent to the pipe from winlogon.exe and dwm.exe is processed by svchost.exe, which compresses data with\nthe RtlCompressBuffer function and then encrypts it with AES. The corresponding encryption key is embedded into the\npayload. It then uploads the encrypted data to the OneDrive cloud using a client ID and a refresh token embedded into the\nimplant.\n\nApart from this implant, we have observed additional components that complement the functionality of FakeHMP. Their\ndescriptions are provided in further sections of this paper.\n\n**MICROPHONE RECORDER**\n\nOn one of the machines infected with The Mask implants in 2022, we discovered a malicious DLL placed at C:\\Windows\\\n```\nninput.dll. This DLL is loaded by the explorer.exe process with each startup. A legitimate counterpart bearing the same\n\n```\nname is located at C:\\Windows\\System32\\ninput.dll, representing the Microsoft Pen and Touch Input component.\nHowever, if another DLL is present at the same path, the explorer.exe process loads it together with the original ninput.dll.\nAs a result of that, a malicious library gets loaded into explorer.exe.\n\nThis malicious DLL’s purpose is to record audio via the victim’s microphone. On startup, it reflectively reloads itself and\nthen hides the tray icon that is displayed whenever the microphone is active:\n\n_Figure 3: Microphone icon that is hidden._\n\nThe malicious library implements two methods of hiding the microphone icon:\n\n - On Windows 10, it retrieves the address of the Shell_NotifyIconW function (exported by shell32.dll) and places\nan EAT hook on this function. The hook checks whether the Shell_NotifyIconW function has been called for the\nmicrophone icon and returns 1 in this case. Otherwise, it calls the original Shell_NotifyIconW function.\n\n - On Windows 11, it patches contents of the OnMicCapabilityUsageChanged function (implemented inside\n```\n  C:\\Windows\\SystemApps\\MicrosoftWindows.Client.CBS_cw5n1h2txyewy\\ExplorerExtensions.dll) to\n\n```\nthe following instructions, which make the function always return 0:\n\n1. mov eax, 0\n\n2. ret\n\nHowever, unlike the Shell_NotifyIconW function, the OnMicCapabilityUsageChanged function is not exported\nfrom the ExplorerExtensions.dll library. In order to find the address of this function, the malicious library performs the\nfollowing steps:\n\n    - Downloads the PDB file that corresponds to the ExplorerExtensions.dll library from Microsoft’s public\nsymbol server (http://msdl.microsoft.com/download/symbols/)\n\n    - Parses the symbols inside the downloaded PDB file, looking for the address of the\n```\n    OnMicCapabilityUsageChanged function.\n\n```\nHaving hidden the microphone icon, the malicious library starts recording the microphone input using Windows Multimedia\nAPIs [3]. The recordings are converted to MP3 (using the LAME library) and uploaded to Dropbox using an application\nkey, secret and refresh token embedded into the library binary.\n\n**FILE STEALER**\n\nAnother additional component deployed in 2022 is a file stealer. Interestingly, the PDB path of this binary, D:\\GIT\\\n```\nBaymax\\x64\\Release\\Baymax.pdb, mentions Baymax, a superhero character from Marvel comic books. This\n\n```\nexecutable accepts eight command-line arguments:\n\n\n-----\n\n1. Remote computer address\n\n2. Remote computer username\n\n3. Username used for logon\n\n4. Password used for logon\n\n5. Domain name\n\n6. Path to a directory on the local machine\n\n7. _OneDrive client ID_\n\n8. _OneDrive refresh token._\n\nThis executable embeds an XOR encrypted list of files that need to be exfiltrated from a remote machine (its address is\nspecified in the first argument). It uses the username, password and domain name specified in arguments 3-5 to access the\nremote machine. The exfiltrated files are stored on the filesystem in a directory specified in argument 6 (in case arguments\n7 and 8 are empty strings) or uploaded to the OneDrive cloud storage (the client ID and refresh token required for\nuploading are provided in arguments 7 and 8).\n\nThe operators were observed to be interested in the following files:\n\n - Cookies, form history and login data for Edge, Chrome, Firefox and Opera\n\n - Cookies from Threema, WeChat and WhatsApp messengers\n\n - Organization’s confidential documents.\n\n**THE 2019 INFECTION OVERVIEW**\n\nThe attack carried out in 2019 was completely different from the one described above. It involved using two frameworks\n– dubbed Careto2 and Goreto. The compromise of the infected machine started with deployment of Careto2. The following\nfiles were deployed to the victim machine over the compromise process:\n\n - Framework loader (placed at %appdata%\\Media Center Programs\\cversions.2.db)\n\n - Framework installer (named ~dfae01202c5f0dba42.cmd)\n\n - Auxiliary registry file (placed at %temp%\\values.reg)\n\nTo install the Careto2 framework, the threat actor launched the ~dfae01202c5f0dba42.cmd file from taskeng.exe, a\nprocess used for launching scheduled tasks. Thus, it is possible that this batch file was started by a remotely created\nscheduled task, just like in the 2022 infection case. This .bat file sets up the Careto2 framework by importing the %temp%\\\n```\nvalues.reg registry file. By doing that, it writes the following values to the registry:\n\n```\n - The Careto2 framework configuration, to the UserState value of the HKCU\\SOFTWARE\\Microsoft\\Windows\\\n```\n  CurrentVersion\\Explorer key\n\n```\n - The path to the loader component of the framework (%appdata%\\Media Center Programs\\cversions.2.db), to\nthe default value of the HKCU\\CLSID\\{603d3801-bd81-11d0-a3a5-00c04fd706ec}\\InProcServer key.\n\nBy writing the latter registry value, the .bat file configures the Careto2 framework to persist on the machine via the COM\nhijacking technique. The hijacked CLSID represents an obsolete component of Windows called SharedTaskScheduler,\nwhich is invoked by the operating system on startup.\n\n**CARETO2 LOADER AND PLUGINS**\n\nOnce launched via COM hijacking, the loader starts operating inside the explorer.exe process. Upon startup, it verifies that\nit is not running inside processes belonging to Comodo Internet Security (cis.exe or CisTray.exe) and reloads itself,\nregistering in the list of loaded DLL modules as comcat.dll. It then sets up a mechanism allowing the malware to propagate\ninto all processes started by explorer.exe by hooking the NtCreateUserProcess function located inside the ntdll.dll library.\n\nAfterwards, the loader decrypts and launches plugins that perform the majority of malicious activities of the framework.\n\nThese plugins are stored in a virtual file system (VFS), located in the file %appdata%\\Media Center\n```\nPrograms\\C_12058.NLS. This file system is encrypted twice with Sosemanuk: the first encryption key is hard coded into\n\n```\nthe loader module, while the second one is generated from the system drive volume serial number and current user SID.\nThe decrypted VFS consists of multiple plugin entries. The following data is provided for each plugin:\n\n - Plugin ID, which is a 32-bit number.\n\n - List of processes in which the plugin should be loaded. Each entry in this list is a DJB2 hash of a process name.\n\n - List of plugin IDs that this plugin is dependent on. All plugins discovered during the research had no dependencies.\n\n - 32-bit and 64-bit plugin bodies.\n\n\n-----\n\nPlugin bodies are DLL files with stripped out MZ/PE headers – custom executable file headers are used instead of them.\nDuring the plugin launch process, the loader module transforms these custom headers into PE headers.\n\nWe have additionally discovered that the plugin IDs stored in this VFS are likely to be DJB2 hashes of DLL names. In the\nfollowing table describing plugins, we provide possible DLL names that could have been assigned by developers for each\nplugin. However, these names may be wrong, as the DJB2 hash is prone to collisions.\n\n**Plugin DLL** **Likely DLL name** **Plugin description**\n**name hash**\n\n`38568efd` `ConfigMgr.dll` Provides an RPC server used by other plugins to access and modify Careto2’s\nconfiguration parameters.\n\n`8f7629f1` `ConfigMgrProxy.dll` Provides an RPC client that facilitates access to the previously described RPC\nserver by exposing interfaces allowing to get, set and remove configuration\nvalues.\n\n`b6df77b6` `Storage.dll` Provides an RPC server used for storing stolen files. It places files pending\nupload to the C2 server in a virtual file system, located in a\nSosemanuk‑encrypted file stored under %TMP%\\~MW47YB.tmp.\n\n`d19c7b1a` `StorageProxy.dll` Provides an RPC client that facilitates access to the RPC server. Its interface\nallows files stored inside the virtual file system to be retrieved and modified.\n\n`05962fac` `Hook.dll` Provides an interface for hooking PE file imports.\n\n`8d82f0fa` `KeybFilter.dll` Provides keylogging capability implemented by placing hooks of GetMessage,\n```\n                   PeekMessage and DefWindowProc API functions using the interface of the\n\n```\nHook.dll plugin.\n\n`1c9f9885` `Kodak.dll` Captures screenshots, writing them as files named <time>_6013.jpg to the\nstorage VFS, using the RPC client plugin d19c7b1a (StorageProxy.dll).\n\n`5ca54969` `FileFilter.dll` Monitors file modifications in specified folders. It is able to log information\nabout these modifications and steal edited files.\n\n`82b79b83` `Comm.dll` Provides an interface used for uploading files into a OneDrive cloud storage. To\ndo that, it uses credentials stored with the configuration, interacting with the\ncloud storage using the OneDrive API.\n\n`861842db` `DllData.dll` This plugin works only from browser processes. It periodically retrieves files\nfrom the storage VFS and uploads them to an attacker-controlled OneDrive\nstorage using interfaces provided by d19c7b1a (StorageProxy.dll) and\n```\n                   82b79b83 (Comm.dll) plugins.\n\n```\n**THE GORETO TOOLSET**\n\nDuring our analysis, we found out that machines infected with the Careto2 spyware were additionally compromised with\nanother malicious toolset, coded in Golang. Thus, we named this toolset Goreto. It includes a set of implants that are\nindependent from each other, namely a backdoor, a keylogger and a screenshot taker. These three implants are designed to\nwork as a shared-process service named Svc Microsoft Service. However, instead of running implants as a service,\nthe attackers launched them via rundll32.exe (e.g. the backdoor was launched through the rundll32.exe\n```\n\"%windir%\\addins\\hlpsvc.dll\",ServiceWorkerThread\" command).\n\n```\nThis backdoor periodically (every 80-85 minutes) connects to a Google Drive storage with the help of a refresh token. It\ndownloads a configuration file and a command file from this storage. The configuration file carries the name <victim ID>_\n```\ncfg.bin, where the victim ID is the Base64-encoded MachineGuid value of the HKLM\\SOFTWARE\\Microsoft\\\nCryptography registry key. This file is additionally encrypted with AES-CFB, with the key 4e-<string>-rg being used.\n\n```\nThe decrypted configuration itself contains:\n\n - The minimum and maximum allowed wait periods between consecutive C2 server interactions\n\n - Configuration of modules launched before execution of commands received from the C2 server.\n\nThe following configuration parameters are available for these modules:\n\n - Execution context – either run as the user owning the explorer.exe process, or as SYSTEM\n\n - Module type – .exe or .dll (if the module type is .dll, the backdoor uses the rundll32.exe utility to launch it)\n\n - Module source – one of the following options is used:\n\n    - Download, decrypt, drop module file to disk and run downloaded module if it previously did not exist on disk\n\n    - Run module previously downloaded from disk\n\n|Plugin DLL name hash|Likely DLL name|Plugin description|\n|---|---|---|\n|38568efd|ConfigMgr.dll|Provides an RPC server used by other plugins to access and modify Careto2’s configuration parameters.|\n|8f7629f1|ConfigMgrProxy.dll|Provides an RPC client that facilitates access to the previously described RPC server by exposing interfaces allowing to get, set and remove configuration values.|\n|b6df77b6|Storage.dll|Provides an RPC server used for storing stolen files. It places files pending upload to the C2 server in a virtual file system, located in a Sosemanuk‑encrypted file stored under %TMP%\\~MW47YB.tmp.|\n|d19c7b1a|StorageProxy.dll|Provides an RPC client that facilitates access to the RPC server. Its interface allows files stored inside the virtual file system to be retrieved and modified.|\n|05962fac|Hook.dll|Provides an interface for hooking PE file imports.|\n|8d82f0fa|KeybFilter.dll|Provides keylogging capability implemented by placing hooks of GetMessage, PeekMessage and DefWindowProc API functions using the interface of the Hook.dll plugin.|\n|1c9f9885|Kodak.dll|Captures screenshots, writing them as files named <time>_6013.jpg to the storage VFS, using the RPC client plugin d19c7b1a (StorageProxy.dll).|\n|5ca54969|FileFilter.dll|Monitors file modifications in specified folders. It is able to log information about these modifications and steal edited files.|\n|82b79b83|Comm.dll|Provides an interface used for uploading files into a OneDrive cloud storage. To do that, it uses credentials stored with the configuration, interacting with the cloud storage using the OneDrive API.|\n|861842db|DllData.dll|This plugin works only from browser processes. It periodically retrieves files from the storage VFS and uploads them to an attacker-controlled OneDrive storage using interfaces provided by d19c7b1a (StorageProxy.dll) and 82b79b83 (Comm.dll) plugins.|\n\n\n-----\n\n    - Download, decrypt, drop module file to disk and run downloaded module even if it previously existed on disk\n(this action is used to update already downloaded modules).\n\nThe command file downloaded along with the previously described configuration file is also encrypted with AES-CFB. It\nspecifies actions that need to be executed by the backdoor. The following commands are supported:\n\n**Command name** **Description**\n\n`downloadandexec` Downloads a file from Google Drive, decrypts it, drops it to disk and executes it\n\n`Downloadfile` Downloads a file from Google Drive, decrypts it and drops it to disk\n\n`Uploadfile` Reads a specified file from disk, encrypts it and uploads it to Google Drive\n\n`Exec` Executes a specified shell command\n\nAs for the keylogger, it uses the go-hook open-source library that ‘provides low level keyboard and mouse hook for\nWindows’. It collects keystrokes, then encrypts and sends them to the Google Drive storage as a file named <victim\n```\nID><random string>.dat. The encryption key, as well as Google Drive credentials, are the same as in the backdoor\n\n```\nmodule.\n\nFinally, the discovered screenshot module periodically (with a random interval of 5-10 minutes) takes screenshots of all\nactive displays, which are encrypted and sent to Google Drive in a file named <victim ID><random string>.png.\n\nAgain, the encryption key and credentials are the same as in the backdoor.\n\n**ATTRIBUTION**\n\nDespite the fact that The Mask is a fairly sophisticated attacker, we have been able to spot several operational security\nmistakes in the group’s recent operations. In particular, the file names used in 2019 attacks resembled those used by The\nMask more than 10 years ago:\n\n**2007-2013 attack file names** **2019 attack file names**\n```\n          ~df01ac74d8be15ee01.tmp ~dfae01202c5f0dba42.cmd\n          c_27803.nls c_12058.nls\n\n```\nFurthermore, the names of plugins used in the 2007-2013 and 2019 attacks are remarkably similar:\n\n**2007-2013 attack module names** **2019 attack module names**\n```\n          FileFlt FileFilter\n          Storage Storage\n          Config ConfigMgr\n\n```\nIn addition, the campaigns conducted in the 2007-2013 and 2019 attacks overlap in terms of TTPs, mainly:\n\n - COM hijacking is used for persistence\n\n - The deployed malware attempts to conceal itself as a system module\n\n - The deployed malware has a modular architecture\n\n - The CreateProcess API function is used to propagate malware across running processes\n\n - Virtual file systems are used to store additional modules, as well as data to be exfiltrated to the C2 server\n\n - Two different frameworks are used during the attack (Careto and SGH in the 2007-2013 campaign, Careto2 and\nGoreto in the 2019 case).\n\nBased on these facts, it becomes possible to attribute the activities observed in 2019 to The Mask threat actor with medium\nto high confidence.\n\nAs for the campaigns observed in 2022 and 2024 that both involve use of the FakeHMP implant, we also attribute them to\nThe Mask with the same level of confidence, based on the following information:\n\n - The organization infected in 2022 is the same one that was previously infected with both Careto2 (in 2019) and Careto\n(in 2007-2013)\n\n - In both 2019 and 2022 cases, the same unique file name was used to deploy implants to infected machines:\n```\n  ~df01ac74d8be15ee01.tmp\n\n```\n - Cloud storages are used for data exfiltration in both 2019 and 2022/2024 cases\n\n - Deployed implants are propagated across all running processes (by hooking the CreateProcess API function in 2019\nand by using the HitmanPro Alert driver in 2022 and 2024).\n\n|Command name|Description|\n|---|---|\n|downloadandexec|Downloads a file from Google Drive, decrypts it, drops it to disk and executes it|\n|Downloadfile|Downloads a file from Google Drive, decrypts it and drops it to disk|\n|Uploadfile|Reads a specified file from disk, encrypts it and uploads it to Google Drive|\n|Exec|Executes a specified shell command|\n\n|2007-2013 attack file names|2019 attack file names|\n|---|---|\n|~df01ac74d8be15ee01.tmp|~dfae01202c5f0dba42.cmd|\n|c_27803.nls|c_12058.nls|\n\n|2007-2013 attack module names|2019 attack module names|\n|---|---|\n|FileFlt|FileFilter|\n|Storage|Storage|\n|Config|ConfigMgr|\n\n\n-----\n\n**CONCLUSION**\n\nOver the years, the Careto APT has been developing malware bearing a remarkably high level of complexity. As such, the\nnewly discovered implants used by this APT in 2019, 2022 and 2024 are, just like 10 years ago, complex multimodular\nframeworks, and the tactics and techniques exercised during their deployment are unique and sophisticated. An example of\nsuch a technique is persistence through MDaemon and HitmanPro Alert, and its presence indicates that The Mask implants\nare developed with professionalism.\n\nWhile the complexity of the recently discovered attacks remained the same as 10 years ago, there has been a significant\nchange in the architecture of the newly discovered malware. Normally, multimodular malware consists of a central\norchestrator module, as well as auxiliary plugins launched by the orchestrator. However, the FakeHMP implant developed\nby The Mask does not include an orchestrator module. In fact, each malicious component is started via a different\npersistence technique, and each launched module works completely independently of the others. This complicates the\nprocess of responding to a cybersecurity incident involving The Mask because disarming all malicious modules installed on\nthe system can become a challenging task – to some degree similar to finding a needle in a haystack.\n\n**REFERENCES**\n\n[1] [Kaspersky. The Careto/Mask APT: Frequently Asked Questions. 10February 2014. https://securelist.com/](https://securelist.com/thecaretomask-apt-frequently-asked-questions/58254/)\n[thecaretomask-apt-frequently-asked-questions/58254/.](https://securelist.com/thecaretomask-apt-frequently-asked-questions/58254/)\n\n[2] United States Cyber Command. Iranian intel cyber suite of malware uses open source tools. 12 January 2022.\n[https://www.cybercom.mil/Media/News/Article/2897570/iranian-intel-cyber-suite-of-malware-uses-open-](https://www.cybercom.mil/Media/News/Article/2897570/iranian-intel-cyber-suite-of-malware-uses-open-sourcetools/)\n[sourcetools/.](https://www.cybercom.mil/Media/News/Article/2897570/iranian-intel-cyber-suite-of-malware-uses-open-sourcetools/)\n\n[3] [Microsoft. Windows Multimedia. https://learn.microsoft.com/en-us/windows/win32/api/_multimedia/.](https://learn.microsoft.com/en-us/windows/win32/api/_multimedia/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.virusbulletin.com/uploads/pdf/conference/vb2024/papers/The-Mask-has-been-unmasked-again.pdf"
    ],
    "report_names": [
        "The-Mask-has-been-unmasked-again.pdf"
    ],
    "threat_actors": [
        {
            "id": "67bf0462-41a3-4da5-b876-187e9ef7c375",
            "created_at": "2022-10-25T16:07:23.44832Z",
            "updated_at": "2025-03-27T02:02:09.806007Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "Careto",
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "ETDA:Careto",
            "tools": [
                "Careto"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f5bf6853-3f6e-452c-a7b7-8f81c9a27476",
            "created_at": "2023-01-06T13:46:38.677391Z",
            "updated_at": "2025-03-27T02:00:02.889755Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "MISPGALAXY:Careto",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2ed8d590-defa-4873-b2de-b75c9b30931e",
            "created_at": "2023-01-06T13:46:38.730137Z",
            "updated_at": "2025-03-27T02:00:02.903261Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "Boggy Serpens",
                "Mango Sandstorm",
                "TEMP.Zagros",
                "Static Kitten",
                "G0069",
                "TA450",
                "Earth Vetala",
                "Seedworm",
                "COBALT ULSTER",
                "ATK51"
            ],
            "source_name": "MISPGALAXY:MuddyWater",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "31e69945-6c1e-40c3-ba8e-a77e81dd142a",
            "created_at": "2024-05-01T02:03:08.047377Z",
            "updated_at": "2025-03-27T02:05:17.326452Z",
            "deleted_at": null,
            "main_name": "COBALT ULSTER",
            "aliases": [
                "ENT-11 ",
                "ITG17 ",
                "MERCURY ",
                "Mango Sandstorm ",
                "MuddyWater ",
                "STAC 1171 ",
                "Seedworm ",
                "Static Kitten ",
                "TEMP.Zagros ",
                "UNC3313 ",
                "Yellow Nix ",
                "Earth Vetala "
            ],
            "source_name": "Secureworks:COBALT ULSTER",
            "tools": [
                " Canopy",
                " CrackMapExec",
                " CredNinja",
                " Empire",
                " FORELORD",
                " Koadic",
                " LaZagne",
                " Ligolo",
                " MKL64",
                " Metasploit",
                " Mimikatz",
                " MiniDump",
                " Mori",
                " MuddyC2Go",
                " MuddyC3",
                " PhonyC2",
                " Plink",
                " PowGoop",
                " PowerStats",
                " RemoteUtilities",
                " Revsocks",
                " ScreenConnect",
                " SimpleHelp",
                " Small Sieve",
                " Syncro",
                " Venom Proxy",
                " WMIExec",
                "AnyDesk"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "02e1c2df-8abd-49b1-91d1-61bc733cf96b",
            "created_at": "2022-10-25T15:50:23.308924Z",
            "updated_at": "2025-03-27T02:00:55.437268Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "MuddyWater",
                "Earth Vetala",
                "Static Kitten",
                "Seedworm",
                "TEMP.Zagros",
                "Mango Sandstorm",
                "TA450"
            ],
            "source_name": "MITRE:MuddyWater",
            "tools": [
                "STARWHALE",
                "POWERSTATS",
                "Out1",
                "PowerSploit",
                "Small Sieve",
                "Mori",
                "Mimikatz",
                "LaZagne",
                "PowGoop",
                "CrackMapExec",
                "ConnectWise",
                "SHARPSTATS",
                "RemoteUtilities",
                "Koadic"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3c430d71-ab2b-4588-820a-42dd6cfc39fb",
            "created_at": "2022-10-25T16:07:23.880522Z",
            "updated_at": "2025-03-27T02:02:10.010443Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "ATK 51",
                "Boggy Serpens",
                "Cobalt Ulster",
                "ITG17",
                "Mango Sandstorm",
                "MuddyWater",
                "Operation BlackWater",
                "Operation Earth Vetala",
                "Operation Quicksand",
                "Seedworm",
                "Static Kitten",
                "T-APT-14",
                "TA450",
                "TEMP.Zagros",
                "Yellow Nix"
            ],
            "source_name": "ETDA:MuddyWater",
            "tools": [
                "Agentemis",
                "BugSleep",
                "CLOUDSTATS",
                "ChromeCookiesView",
                "Cobalt Strike",
                "CobaltStrike",
                "CrackMapExec",
                "DELPHSTATS",
                "EmPyre",
                "EmpireProject",
                "FruityC2",
                "Koadic",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "MZCookiesView",
                "Meterpreter",
                "Mimikatz",
                "MuddyC2Go",
                "MuddyRot",
                "Mudwater",
                "POWERSTATS",
                "PRB-Backdoor",
                "PhonyC2",
                "PowGoop",
                "PowerShell Empire",
                "PowerSploit",
                "Powermud",
                "QUADAGENT",
                "SHARPSTATS",
                "SSF",
                "Secure Socket Funneling",
                "Shootback",
                "Smbmap",
                "Valyria",
                "chrome-passwords",
                "cobeacon",
                "prb_backdoor"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1734401141,
    "ts_updated_at": 1743041773,
    "ts_creation_date": 1727179766,
    "ts_modification_date": 1727179767,
    "files": {
        "pdf": "https://archive.orkl.eu/1a1e46218346ec29349456e34e7ced6da6ecc85e.pdf",
        "text": "https://archive.orkl.eu/1a1e46218346ec29349456e34e7ced6da6ecc85e.txt",
        "img": "https://archive.orkl.eu/1a1e46218346ec29349456e34e7ced6da6ecc85e.jpg"
    }
}