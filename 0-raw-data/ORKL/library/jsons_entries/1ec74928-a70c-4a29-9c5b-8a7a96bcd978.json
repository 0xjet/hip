{
    "id": "1ec74928-a70c-4a29-9c5b-8a7a96bcd978",
    "created_at": "2023-01-12T15:01:04.290388Z",
    "updated_at": "2025-03-27T02:06:06.399581Z",
    "deleted_at": null,
    "sha1_hash": "583e8c196ab2857233ef422cdd9e42d2e513afcc",
    "title": "2021-06-15 - A Defender's Perspective of SSL VPN Exploitation",
    "authors": "",
    "file_creation_date": "2022-05-28T00:25:19Z",
    "file_modification_date": "2022-05-28T00:25:19Z",
    "file_size": 1346936,
    "plain_text": "# A Defender's Perspective of SSL VPN Exploitation\n\n**[paraflare.com/a-defenders-perspective-of-ssl-vpn-exploitation/](https://paraflare.com/a-defenders-perspective-of-ssl-vpn-exploitation/)**\n\nDaniel Eden\n\n[Published by Daniel Eden | 15 June 2021](https://paraflare.com/authors/daniel-eden/)\n\n**Daniel Eden**\n\n_Director DFIR_\n\nJune 15, 2021\n\n10 min read.\n\n_The_ _[exploitation of Fortinet FortiOS vulnerabilities has been very topical of late. Over the](https://us-cert.cisa.gov/ncas/current-activity/2021/05/28/fbi-update-exploitation-fortinet-fortios-vulnerabilities)_\n_past 12 months, ParaFlare’s Incident Response team has assisted with the response,_\n_containment and remediation of several large-scale ransomware cases that involved_\n_unpatched Fortinet FortiGate firewalls._\n\n\n-----\n\nAs such, we have analysed several CVEs that have impacted Fortinet devices worldwide\nand have led to devastating attacks on networks from the perimeter device inwards. It is our\nassumption that the exploitation of CVE-2018-13379, an ‘Improper Limitation of a Pathname\nto a Restricted Directory (Path Traversal), was to blame.\n\nThe vulnerability assigned the reference CVE-2018-13379 allows an unauthenticated,\nremote actor to read sensitive files on the Fortinet device, including the usernames and\nplaintext passwords contained in the “sslvpn_websession” file. Therefore, enabling the threat\nactor to access the SSL VPN with legitimate user credentials. We believe this vulnerability\nwas most likely used by attackers to gain initial access in all recent cases investigated by\nParaFlare, where an unpatched Fortinet device was involved.\n\nDuring these response engagements, while ParaFlare were able to assess the likelihood of\n[the attacker utilising the exploits as disclosed by this blog post, the evidence has not been](https://devco.re/blog/2019/08/09/attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn/)\navailable to support these assumptions. This drove us to delve a little deeper into these\nvulnerabilities and determine whether there was any evidence that could be extracted from\nthe devices to support the hypothesis.\n\nConfirming or disproving assumptions regarding the root cause of an incident is important, as\nit allows you to make informed decisions during the response process and more effectively\nprioritise security requirements. Timing is critical when you are responding to security\nincidents, as they can substantially impact business operations. For this reason, there must\nbe a balance between the desire to achieve certainty in your root cause analysis, minimising\nsecurity risks, and enabling an organisation to recover as quickly as possible.\n\nThere are numerous vulnerabilities exploited by attackers to breach network defences,\nlaterally move within an environment, impersonate legitimate users, and ultimately,\nachieve their objective. Most often the objective has been financial gain through the\nextortion of victims who have had their critical data stolen and/or encrypted.\n\nThe most severe and maybe the most widely exploited Fortinet CVE, in our opinion, is CVE2018-13379. Why? Because it is so trivial to perform and from what ParaFlare have\nunderstood from our engagements and research, it is very difficult, if not almost impossible,\nto confirm this as the source of compromise. Let us go through this step by step, see what\nthis means for the network owner, attacker, and the response team.\n\n## The Attack\n\n\n-----\n\n## Step 1: External Reconnaissance \n\nFirstly, the attackers would launch a mass scan, looking for Fortinet SSL Web VPN portals\nexposed to the Internet. A simple approach is to script out the IANA netblock listings, take\nyour pick at which country you feel like targeting, and search for TCP/10443 (default Fortinet\nSSL Web VPN). Shodan also makes this a trivial exercise. The login screen for the Fortinet\nSSL VPN web portal has been demonstrated below.\n\n\n-----\n\n_Figure 1: Example FortiGate Web VPN SSL portal_\n\n## Step 2: Crafting the Malicious Request\n\nThe [CVE write-up tells us that “in Fortinet FortiOS 6.0.0 to 6.0.4, 5.6.3 to 5.6.7 and 5.4.6 to](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-13379)\n5.4.12 under SSL VPN web portal allows an unauthenticated attacker to download system\nfiles via special crafted HTTP resource requests”.\n\nThe aim of the game is to grab a specific “KEYFILE” from disk. This KEYFILE is a symlink2\nto a file called “sslvpn_websession” that lives in /dev/cmdb. What is this file and why does it\nexist? According to the limited internet research ParaFlare conducted on the purpose of this\nfile, it is not clear why the file is present in the first place, and as the fix to this vulnerability is\nto remove the file, we then assume it serves no critical purposes. However, what the file\ncontains is extremely sensitive information, you guessed it… cleartext Web SSL VPN\nauthenticated username and passwords.\n\nTo exploit this vulnerability, it is as easy as appending the FortiGate URL with the path shown\nin Figure 2 with a simple GET request. A path traversal attack (also known as directory\ntraversal) aims to access files and directories that are stored outside the web root folder. By\nmanipulating variables that reference files with “dot-dot-slash (../)” sequences and its\nvariations, or by using absolute file paths, it may be possible to access arbitrary files and\ndirectories .  3\n\n\n-----\n\n_Figure 2: Exploiting the snprintf function_\n\nThe attack essentially leverages a flaw in the snprintf function where an attacker can pass\ntheir own variables into the GET request. This allows for the valid URI to be overridden and\nfile contents to be shown. The extra “/”’s in the path denote the buffer size of the overwrite up\nto the file attribute:\n\nFor instance, to traverse to “/dev/cmdb” you will need an extra eight slashes (‘/’):\n\n```\n dev = 3, / = 1, cmdb = 4 (total of 8 bytes)\n\n```\n\nIf you want to grab any file, simply calculate the path offset length and append the required\nslashes.\n\n## Step 3: Execution\n\nMetasploit is an open-source framework that can be used to test and exploit vulnerabilities.\nWithin Metasploit there is a module that can be used to exploit CVE-2018-13379 extremely\neasily.\n\n\n-----\n\n_Figure 3: Running Metasploit against CVE-2018-13379_\nLet me break down what has been captured in Figure 3:\n\nThe target victim is 192.168.209.128 (a Fortinet 6.0.1 virtual appliance)\nThis Metasploit module confirms that the target is vulnerable to CVE-2018-13379\nThe credentials being used is user:test and password:test, which have been\nsuccessfully retrieved using this exploit module.\n\n## Step 4: Success\n\nNow using these credentials, assuming that multifactor authentication is not enabled (which\ninvariably, it is not), you can use those credentials to login into the SSL Web VPN\nportal. This is where things get interesting. Do you see anything here that looks enticing?\n\n_Figure 4: Successfully logged in_\nNow that you have successfully authenticated to the portal, you can decide to download\nFortiClient for continual ease of access, but also to blend in with other users. What should be\nnoted here, is that if Active Directory SSO is used to access the VPN server, then\nessentially Active Directory credentials are exposed, and which inevitably may\ninclude domain administrators.\n\nAdditionally, the “Your Bookmark” feature is a feature-rich ‘in browser’ RDP wrapper based\non the Apache Guacamole protocol. Effectively, all you need to do to make your life super\nsimple (and the attacker’s) is save your favourite server credentials (e g Domain\n\n\n-----\n\nAdmin) inside a bookmark. Then use the Fortinet Web SSL VPN via your browser to RDP\ndirectly into the machine of your choice. This is used quite widely amongst organisations to\nprovide third party access to systems, such as contractors or vendors.\n\n## Step 5: The Wrap Up\n\nAs an attacker, you have made it from the internet to the Domain Controller in a matter\nof four clicks; scan -> exploit -> login -> move laterally.\n\n## The Response\n\nNow that the attack was proven successful, how do we as responders work out what has\nhappened and if CVE-2018-13379 was indeed the point of compromise for the attack? This\nis where things get difficult.\n\nAs FortiGate’s are a security device, you can log events via syslog, FortiAnalyzer or\nFortiCloud, the latter of which sends the logs to a specified storage location. ParaFlare have\nassisted multiple clients in the analysis of the Fortinet logs, and unfortunately there are\napproximately zero logs in relation to the “migadmin” web application (Web SSL VPN portal).\nWhat we wanted to know was whether we were missing a configuration or potentially identify\nlogs hidden somewhere on the device to confirm our theory.\n\nTesting via a mock syslog server (python socket UDP/514 listener) whilst firing off the exploit\nresulted in no findings, even with all “Logging” configuration options enabled in the Fortinet\nAdministrator console. So clearly, it was not a configuration issue that we could easily\nchange to obtain the evidence we needed.\n\nAs some folks may remember, the Citrix NetScaler vulnerability CVE-2019-19781 was\n[exploited on-masse around 2019-2020. Performing forensics on virtual appliances brings up](https://support.citrix.com/article/CTX267027)\nmemories of ephemeral RAM disks and insanely locked down shells in the form of wrapped\ncommand line interfaces. Given this, some creative thinking was needed in order to try and\nfind these logs, if they even existed.\n\nHere are some other methods that were attempted to get some form of “patient zero”\nevidence in logs:\n\nMade sure all logging facilities were enabled in the Fortinet console\nCaptured memory of the Fortinet virtual appliance and keyword searched for “GET\n/remote”, “sslvpn_websession”. Some remnants were discovered in memory within\nApache web logs, however this did not identify a disk-based file or location. Further to\nthis, the remnants were sporadic and did not actually detail the exploit. My suspicion is\nthat the embedded Apache web server is writing access logs to the migadmin web\napplication in memory only.\nImage and ramdisk tarball analysis for signs of logging also produced no results.\n\n\n-----\n\nExplored the fnsysctl super admin command on the Fortinet console, attempting to\nread certain log files in /var/log. This looked promising until I quickly figured out that\nfnsysctl and a very limited console shell barely gives you any room to move. I\nattempted to profile the system layout, looking for directories or files of interest,\nhowever this fell short.\nExplored the migadmin web application for any directories that may have resembled\nlog file locations.\nExplored the idea of using the path traversal CVE to my advantage by arbitrarily\ngrabbing files from disk, specifically in /var/log. Whilst this works, there is no actual log\nfiles for me to grab that is of interest (apart from what is being sent to syslog already)\n\nPrevention of Successful CVE-2018-13379 Exploitation\n\nTo protect against this type of vulnerability, the theory of using the inbuilt FortiGate IPS/SSLdecryption modules and custom signatures to block the delivery of the crafted payload body\nwas investigated. This is a cumbersome exercise and requires heavy customization of\ninterfaces, VIPs, and signatures. Ultimately it would be much faster to patch the appliance.\nHowever, if you want to take this option, here are the steps to achieve it:\n\nTraffic flow remains on the single exposed FortiGate device, but with some crafty\nNAT’ing and VIP’s, you can effectively re-route the interface via your new IPS policy.\nTo caveat this, turning on IPS and SSL Inspection will *probably* incur CPU penalties,\nso please keep this in mind before implementing these measures in production.\n\nA more detailed breakdown of this process has been demonstrated below.\n\n1. For SSL-VPN settings, configure connection settings to listen on one of the internal\n\ninterfaces.\n2. Configure Static-NAT using Virtual IP to map the SSL-VPN gateway (IP/FQDN) to the\n\nIP address of internal interface selected in step 1.\n3. Create IPv4 Policy using this Virtual IP to allow traffic from external interface\n\n(configured with SSL-VPN gateway IP) to the new internal interface listening on port\nTCP/10443.\n4. Create custom IPS signature to match the desired pattern. Directory traversal pattern\n\nfor instance.\ne.g. F-SBID( --name “SSLVPN.IPS.Event”; --protocol tcp; --service HTTP; --flow\nfrom_server; --pcre “..\\x3b”;)\n5. Create new IPS Sensor using the IPS signature created in step 4 and configure the\n\naction as either Block or Monitor and enable logging.\n6. Add IPS sensor to new policy created in step 3.\n7. Any security events triggering this new IPS sensor will be logged and display the action\n\ntaken as either dropped or detected.\n\n\n-----\n\nGiven proper infrastructure architecture and design, placing the SSL Web VPN behind a\nWeb Application Firewall would be a critical measure to ensure protection against web-based\nattacks. The steps that were just provided are limited in their ability to truly defend against\nweb-based attacks; IPS is not designed to be that stop gap.\n\nEnabling multifactor authentication is also an important security control. Although it cannot\nprevent the exploit from happening, it would almost always prevent the attacker from utilising\nthe credentials that had been exposed.\n\n## Concluding Remarks\n\nTo wrap up, as defenders, what can we do to identify if a network was compromised with this\nCVE? We can only assume that CVE-2018-13379 was the culprit. Defenders can perform\nbehavioural analysis on the existing logs, such as inbound and outbound firewall analysis,\ngeolocation analysis and login time analysis, to name a few. This investigation will definitely\nhighlight abuse, misuse, or attacker movements, but it will not definitively present evidence\nto answer the age-old question of “how did they get in?”. This exploitation provides a classic\ndemonstration of it being easier for the attacker to gain access to a network rather than the\ndefender being able to protect it from such an attack.\n\n[[1][2][3] A symlink is a type of file in Linux that points to another filehttps://docs.fortinet.com/document/fortigate/6.2.0/cookbook/579694/ssl-vpn-web-mode-for-remote-userhttps://owasp.org/www-community/attacks/Path_Traversal](https://docs.fortinet.com/document/fortigate/6.2.0/cookbook/579694/ssl-vpn-web-mode-for-remote-user) or a folder\n\n[Have a comment? Join the conversation on LinkedIn](https://www.linkedin.com/company/paraflare)\n\n[Blog](https://paraflare.com/blog/blog/)\n[Technical research](https://paraflare.com/blog/technical-research/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-15 - A Defender's Perspective of SSL VPN Exploitation.pdf"
    ],
    "report_names": [
        "2021-06-15 - A Defender's Perspective of SSL VPN Exploitation.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535664,
    "ts_updated_at": 1743041166,
    "ts_creation_date": 1653697519,
    "ts_modification_date": 1653697519,
    "files": {
        "pdf": "https://archive.orkl.eu/583e8c196ab2857233ef422cdd9e42d2e513afcc.pdf",
        "text": "https://archive.orkl.eu/583e8c196ab2857233ef422cdd9e42d2e513afcc.txt",
        "img": "https://archive.orkl.eu/583e8c196ab2857233ef422cdd9e42d2e513afcc.jpg"
    }
}