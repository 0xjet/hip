{
    "id": "5b8c0d02-8e9e-42ab-b832-a1cee1db0869",
    "created_at": "2022-10-25T16:48:10.961472Z",
    "updated_at": "2025-03-27T02:05:50.177672Z",
    "deleted_at": null,
    "sha1_hash": "290a67462a2eaf75bef1a154709616e5e8accd29",
    "title": "CVE-2017-8759: Zero-Day Used in the Wild to Distribute FINSPY",
    "authors": "FireEye",
    "file_creation_date": "2017-10-08T18:19:52Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 396444,
    "plain_text": "# y y Wild to Distribute FINSPY\n\n**[fireeye.com /blog/threat-research/2017/09/zero-day-used-to-distribute-finspy.html](https://www.fireeye.com/blog/threat-research/2017/09/zero-day-used-to-distribute-finspy.html)**\n\n[FireEye recently detected a malicious Microsoft Office RTF document that leveraged CVE-2017-8759, a SOAP](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2017-8759)\n[WSDL parser code injection vulnerability. This vulnerability allows a malicious actor to inject arbitrary code during](https://msdn.microsoft.com/en-us/library/ms996486.aspx)\nthe parsing of SOAP WSDL definition contents. FireEye analyzed a Microsoft Word document where attackers used\nthe arbitrary code injection to download and execute a Visual Basic script that contained PowerShell commands.\n\nFireEye shared the details of the vulnerability with Microsoft and has been coordinating public disclosure timed with\n[the release of a patch to address the vulnerability and security guidance, which can be found here.](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2017-8759)\n\nFireEye email, endpoint and network products detected the malicious documents.\n\n## Vulnerability Used to Target Russian Speakers\n\nThe malicious document, “Проект.doc” (MD5: fe5c4d6bb78e170abf5cf3741868ea4c), might have been used to\ntarget a Russian speaker. Upon successful exploitation of CVE-2017-8759, the document downloads multiple\ncomponents (details follow), and eventually launches a FINSPY payload (MD5:\na7b990d5f57b244dd17e9a937a41e7f5).\n\n[FINSPY malware, also reported as FinFisher or WingBird, is available for purchase as part of a “lawful intercept”](http://download.microsoft.com/download/E/B/0/EB0F50CC-989C-4B66-B7F6-68CD3DC90DE3/Microsoft_Security_Intelligence_Report_Volume_21_English.pdf)\n[capability. Based on this and previous use of FINSPY, we assess with moderate confidence that this malicious](https://www.fireeye.com/blog/threat-research/2017/04/cve-2017-0199_useda.html)\ndocument was used by a nation-state to target a Russian-speaking entity for cyber espionage purposes. Additional\ndetections by FireEye’s Dynamic Threat Intelligence system indicates that related activity, though potentially for a\ndifferent client, might have occurred as early as July 2017.\n\n## CVE-2017-8759 WSDL Parser Code Injection\n\nA code injection vulnerability exists in the WSDL parser module within the PrintClientProxy method\n[(http://referencesource.microsoft.com/ - System.Runtime.Remoting/metadata/wsdlparser.cs,6111). The IsValidUrl](http://referencesource.microsoft.com/#System.Runtime.Remoting/metadata/wsdlparser.cs,6111)\ndoes not perform correct validation if provided data that contains a CRLF sequence. This allows an attacker to inject\nand execute arbitrary code. A portion of the vulnerable code is shown in Figure 1.\n\n\n-----\n\nFigure 1: Vulnerable WSDL Parser\n\nWhen multiple address definitions are provided in a SOAP response, the code inserts the\n“//base.ConfigureProxy(this.GetType(),” string after the first address, commenting out the remaining addresses.\nHowever, if a CRLF sequence is in the additional addresses, the code following the CRLF will not be commented\nout. Figure 2 shows that due to lack validation of CRLF, a System.Diagnostics.Process.Start method call is injected.\nThe generated code will be compiled by csc.exe of .NET framework, and loaded by the Office executables as a\nDLL.\n\n\n-----\n\n## The In-the-Wild Attacks\n\nThe attacks that FireEye observed in the wild leveraged a Rich Text Format (RTF) document, similar to the CVE2017-0199 documents we previously reported on. The malicious sampled contained an embedded SOAP monikers\nto facilitate exploitation (Figure 3).\n\nFigure 3: SOAP Moniker\n\nThe payload retrieves the malicious SOAP WSDL definition from an attacker-controlled server. The WSDL parser,\nimplemented in System.Runtime.Remoting.ni.dll of .NET framework, parses the content and generates a .cs source\ncode at the working directory. The csc.exe of .NET framework then compiles the generated source code into a\nlibrary, namely http[url path].dll. Microsoft Office then loads the library, completing the exploitation stage. Figure 4\nshows an example library loaded as a result of exploitation.\n\nFigure 4: DLL loaded\n\nUpon successful exploitation, the injected code creates a new process and leverages mshta.exe to retrieve a HTA\n\n\n-----\n\nextension and image/jpeg content-type, is actually an executable. Figure 5 shows the details of the PCAP of this\nmalware transfer.\n\nFigure 5: Live requests\n\nThe malware will be placed at %appdata%\\Microsoft\\Windows\\OfficeUpdte-KB[ 6 random numbers ].exe. Figure 6\nshows the process create chain under Process Monitor.\n\nFigure 6: Process Created Chain\n\n## The Malware\n\nThe “left.jpg” (md5: a7b990d5f57b244dd17e9a937a41e7f5) is a variant of FINSPY. It leverages heavily obfuscated\ncode that employs a built-in virtual machine – among other anti-analysis techniques – to make reversing more\ndifficult. As likely another unique anti-analysis technique, it parses its own full path and searches for the string\nrepresentation of its own MD5 hash. Many resources, such as analysis tools and sandboxes, rename files/samples\nto their MD5 hash in order to ensure unique filenames. This variant runs with a mutex of \"WininetStartupMutex0\".\n\n## Conclusion\n\nCVE-2017-8759 is the second zero-day vulnerability used to distribute FINSPY uncovered by FireEye in 2017.\nThese exposures demonstrate the significant resources available to “lawful intercept” companies and their\ncustomers. Furthermore, FINSPY has been sold to multiple clients, suggesting the vulnerability was being used\nagainst other targets\n\n\n-----\n\nthe zero day being used to distribute FINSPY in April 2017, CVE-2017-0199 was simultaneously being used by a\nfinancially motivated actor. If the actors behind FINSPY obtained this vulnerability from the same source used\npreviously, it is possible that source sold it to additional actors.\n\n## Acknowledgement\n\nThank you to Dhanesh Kizhakkinan, Joseph Reyes, FireEye Labs Team, FireEye FLARE Team and FireEye iSIGHT\nIntelligence for their contributions to this blog. We also thank everyone from the Microsoft Security Response Center\n(MSRC) who worked with us on this issue.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/mgz7lvnbg6bjhjognrlc7ovqdcqpbhgo"
    ],
    "report_names": [
        "FireEye_CVE-2017-8759-Used-Wild-Distribute-FINSPY(09-12-2017)"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716490,
    "ts_updated_at": 1743041150,
    "ts_creation_date": 1507486792,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/290a67462a2eaf75bef1a154709616e5e8accd29.pdf",
        "text": "https://archive.orkl.eu/290a67462a2eaf75bef1a154709616e5e8accd29.txt",
        "img": "https://archive.orkl.eu/290a67462a2eaf75bef1a154709616e5e8accd29.jpg"
    }
}