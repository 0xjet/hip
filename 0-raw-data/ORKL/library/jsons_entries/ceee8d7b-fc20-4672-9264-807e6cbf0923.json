{
    "id": "ceee8d7b-fc20-4672-9264-807e6cbf0923",
    "created_at": "2023-01-12T15:08:59.678049Z",
    "updated_at": "2025-03-27T02:16:47.129216Z",
    "deleted_at": null,
    "sha1_hash": "9882c079f3b91dfa143bd80a1133beb16491cdeb",
    "title": "2022-06-04 - [QuickNote] CobaltStrike SMB Beacon Analysis",
    "authors": "",
    "file_creation_date": "2022-06-09T10:27:55Z",
    "file_modification_date": "2022-06-09T10:27:55Z",
    "file_size": 862207,
    "plain_text": "# [QuickNote] CobaltStrike SMB Beacon Analysis\n\n**[kienmanowar.wordpress.com/2022/06/04/quicknote-cobaltstrike-smb-beacon-analysis-2/](https://kienmanowar.wordpress.com/2022/06/04/quicknote-cobaltstrike-smb-beacon-analysis-2/)**\n\n**1. Executive Summary**\n\n\nJune 4, 2022\n\n\nAt VinCSS, I recently wrote an analysis related to the samples of the Mustang Panda\n**[(PlugX) group. These samples are all uploaded from Vietnam. You can read the Vietnamese](https://blog.vincss.net/2022/05/re027-nhom-apt-mustang-panda-co-the-van-dang-tiep-tuc-hoat-dong-tan-cong-vao-cac-to-chuc-tai-Vietnam.html)**\nor [English blog post of this analysis.](https://blog.vincss.net/2022/05/re027-china-based-apt-mustang-panda-might-have-still-continued-their-attack-activities-against-organizations-in-Vietnam.html)\n\nHowever, in all the uploaded `log.dll files, there is one file that is not related to the`\n**Mustang Panda group’s attack technique, it is marked as the following picture:**\n\n**2. Analyze log.dll**\n\n[This file’s size is smaller than other files. The original name is](https://www.virustotal.com/gui/file/604b202cbe5e97c7c8a74a12e1f08e843c08ae08be34dc60b8518b9417c133a9/detection) `imageres.dll, it exports a`\nlot of functions have the same address, but the only one most notable is the `LogInit`\nfunction:\n\n\n-----\n\nAnalyze `LogInit ‘s code in IDA, I see it build path to the` `mpengindrv.db file:`\n\nNext, read the content of `mpengindrv.db into the allocated memory region and decrypt it`\nby using RC4 with the decryption key is “ A5A7F7E2B00C4A2B87FC0123F933EBD6 “. After\nsuccessful decryption, call the decrypted payload to execute:\n\n\n-----\n\n**3. Hunting and decrypting**\n\nTrying to hunt `mpengindrv.db file on VT, I found the only file uploaded from Vietnam and at`\nthe same time as the log.dll file above:\n\nUsing [CyberChef to decrypt file, we found that the file after decryption is a PE file, but we will](https://gchq.github.io/CyberChef/)\nsee that immediately after the `MZ` signature is the opcode of the call command ( 0xE8 ):\n\nSave the decrypted file to disk, perform disassembly first bytes, and see that there are two\ncalls as follows:\n\n\n-----\n\n[The above information reminds me of the ReflectiveLoader technique that I have analyzed in](https://github.com/stephenfewer/grinder/blob/master/node/source/logger/ReflectiveLoader.c)\n[this article. Static analysis the decrypted file, which is a Dll with the original name](https://blog.vincss.net/2020/03/re012-phan-tich-ma-doc-loi-dung-dich-COVID-19-de-phat-tan-gia-mao-chi-thi-cua-thu-tuong-Nguyen-Xuan-Phuc-phan2.html)\n```\nLotes.dll, exporting one function is ReflectiveLoader .\n\n```\nHowever, the unusual point is that, its Imports Table information is wrong, the names of\nsections are also confusing characters:\n\n\n-----\n\n**4. Analyze Lotes.dll**\n\nLoad the Dll file into IDA for analysis, the code in the `ReflectiveLoader` function is similar\nto the code [here, but it has been modified a bit related to processing import table . It first](https://github.com/stephenfewer/grinder/blob/master/node/source/logger/ReflectiveLoader.c)\nreads the `NumberOfSymbols` value from the `File Header and stores it in a variable. This`\nvariable will be used as the xor_key . Then, when processing the import table, it uses the\nobtained `xor_key value to decode the names of the dlls, as well as the names of the API`\nfunctions that the malicious code will use:\n\n\n-----\n\nBased on the above information, it is easy to recover the information of the Import Table:\n\n\n-----\n\nAfter completing the Loader process, it will call the entry point of the Dll file to execute:\n\nThe code at `DllEntryPoint` will call `DllMain, and then calls the function`\n```\nf_decrypt_and_parse_beacon_config . The reason I know this is a CobaltStrike Beacon\n\n```\nis because the `f_decrypt_and_parse_beacon_config` function will perform decode the\n\n\n-----\n\nconfig with a hard-coded value of `0x2e` (as xor_key). The value `0x2e` is used in Beacon\nversion 4.\n\nBased on this info, I used the script [1768.py by Mr. Didier Stevens to extract the](https://github.com/DidierStevens/DidierStevensSuite/blob/master/1768.py)\nconfiguration information of the CobaltStrike Beacon. The result shows that this is an SMB\nBeacon:\n\n\n-----\n\nEnd.\n\nm4n0w4r\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-04 - [QuickNote] CobaltStrike SMB Beacon Analysis.pdf"
    ],
    "report_names": [
        "2022-06-04 - [QuickNote] CobaltStrike SMB Beacon Analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1691c25f-1aa4-4168-8ce2-7aa8f23246e7",
            "created_at": "2024-06-04T02:03:07.724221Z",
            "updated_at": "2025-03-27T02:05:17.284601Z",
            "deleted_at": null,
            "main_name": "BRONZE PRESIDENT",
            "aliases": [
                "Mustang Panda ",
                "Red Lich ",
                "Temp.Hex ",
                "HoneyMyte "
            ],
            "source_name": "Secureworks:BRONZE PRESIDENT",
            "tools": [
                " Cobalt Strike",
                " ORat",
                " PlugX",
                " RCSession",
                "China Chopper"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b69037ec-2605-4de4-bb32-a20d780a8406",
            "created_at": "2023-01-06T13:46:38.790766Z",
            "updated_at": "2025-03-27T02:00:02.919758Z",
            "deleted_at": null,
            "main_name": "MUSTANG PANDA",
            "aliases": [
                "TEMP.HEX",
                "TA416",
                "TANTALUM",
                "Twill Typhoon",
                "Earth Preta",
                "Stately Taurus",
                "LuminousMoth",
                "Polaris",
                "BRONZE PRESIDENT",
                "HoneyMyte",
                "Red Lich"
            ],
            "source_name": "MISPGALAXY:MUSTANG PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9baa7519-772a-4862-b412-6f0463691b89",
            "created_at": "2022-10-25T15:50:23.354429Z",
            "updated_at": "2025-03-27T02:00:55.45162Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Mustang Panda",
                "TA416",
                "RedDelta",
                "BRONZE PRESIDENT"
            ],
            "source_name": "MITRE:Mustang Panda",
            "tools": [
                "Cobalt Strike",
                "RCSession",
                "NBTscan",
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2ee03999-5432-4a65-a850-c543b4fefc3d",
            "created_at": "2022-10-25T16:07:23.882813Z",
            "updated_at": "2025-03-27T02:02:10.0116Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Bronze President",
                "Camaro Dragon",
                "Earth Preta",
                "HoneyMyte",
                "Mustang Panda",
                "Operation SMUGX",
                "Operation SmugX",
                "PKPLUG",
                "Red Lich",
                "Stately Taurus",
                "TEMP.Hex"
            ],
            "source_name": "ETDA:Mustang Panda",
            "tools": [
                "9002 RAT",
                "AdFind",
                "Agent.dhwf",
                "Agentemis",
                "CHINACHOPPER",
                "China Chopper",
                "Chymine",
                "ClaimLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "DCSync",
                "DOPLUGS",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Farseer",
                "Gen:Trojan.Heur.PT",
                "HOMEUNIX",
                "Hdump",
                "HenBox",
                "HidraQ",
                "Hodur",
                "Homux",
                "HopperTick",
                "Hydraq",
                "Impacket",
                "Kaba",
                "Korplug",
                "LadonGo",
                "MQsTTang",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "NBTscan",
                "NetSess",
                "Netview",
                "Orat",
                "POISONPLUG.SHADOW",
                "PUBLOAD",
                "PVE Find AD Users",
                "PlugX",
                "Poison Ivy",
                "PowerView",
                "QMAGENT",
                "RCSession",
                "RedDelta",
                "Roarur",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TONEINS",
                "TONESHELL",
                "TVT",
                "TeamViewer",
                "Thoper",
                "TinyNote",
                "WispRider",
                "WmiExec",
                "XShellGhost",
                "Xamtrav",
                "Zupdax",
                "cobeacon",
                "nbtscan",
                "nmap",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536139,
    "ts_updated_at": 1743041807,
    "ts_creation_date": 1654770475,
    "ts_modification_date": 1654770475,
    "files": {
        "pdf": "https://archive.orkl.eu/9882c079f3b91dfa143bd80a1133beb16491cdeb.pdf",
        "text": "https://archive.orkl.eu/9882c079f3b91dfa143bd80a1133beb16491cdeb.txt",
        "img": "https://archive.orkl.eu/9882c079f3b91dfa143bd80a1133beb16491cdeb.jpg"
    }
}