{
    "id": "e1663420-6dc3-4d04-b09d-e66711fab0eb",
    "created_at": "2023-01-12T15:07:21.155544Z",
    "updated_at": "2025-03-27T02:17:27.730863Z",
    "deleted_at": null,
    "sha1_hash": "7283d141379e63fc1a50f7d6a13198991fef3a20",
    "title": "2018-09-14 - Tunneling Under the Sands",
    "authors": "",
    "file_creation_date": "2022-05-28T21:57:31Z",
    "file_modification_date": "2022-05-28T21:57:31Z",
    "file_size": 784483,
    "plain_text": "# Tunneling Under the Sands\n\n**netscout.com/blog/asert/tunneling-under-sands**\n\nby [ASERT Team on September 14th, 2018](https://www.netscout.com/blog/asert/asert-team)\n\n## Executive Summary\n\nASERT recently came across spear-phishing emails targeting the Office of the First Deputy Prime Minister of Bahrain. A similar\ncampaign uncovered by Palo Alto’s [Unit 42 found the activity distributing an updated variant of BONDUPDATER, a PowerShell-based](https://researchcenter.paloaltonetworks.com/2018/09/unit42-oilrig-uses-updated-bondupdater-target-middle-eastern-government/)\nTrojan, which they attribute to Iranian APT group OilRig (aka APT34). ASERT was able to uncover Command and Control (C2) traffic\ninstructing the script to run commands, including the C2 responses from the attacker’s server. NOTE: Netscout APS enterprise security\n_products detect and block all network IOCs noted in this report._\n\n## Key Findings\n\nBONDUPDATER, a PowerShell based Trojan, now obfuscates the data prior to exfiltration.\nData exfiltration occurs using inserted sub-domains for each communication to the attacker’s C2 server.\n\n## Analysis\n\n\n-----\n\nDuring the course of ASERT s investigation into the alleged Oilrig activity, we managed to capture live C2 communications, and\nreverse engineer the communication protocols the malware uses. For further details on the malware itself and how it behaves, we\n[recommend reading the blog that Unit42 security researchers published earlier in the week. The BONDUPDATER C2 communications](https://researchcenter.paloaltonetworks.com/2018/09/unit42-oilrig-uses-updated-bondupdater-target-middle-eastern-government/)\nutilize DNS queries for communication and data exfiltration. Specifically, BONDUPDATER uses DNS A records and DNS TXT records\nto relay the information.\n\n## Command Delivery\n\nBONDUPDATER makes use of the TXT data field to pass commands to the client. DNS TXT records are traditionally used to provide\nadditional information about the domain; however, it could be anything, provided it follows the standard. Here, the attacker abuses the\nfunctionality to deliver items like commands. The command format the attackers send in the TXT response field is: 5 characters > Data\n(Figure 1).\n\n_Figure 1: S0000 Command_\n\nThe script splits the command into two parts delimited by the > character. For example, to run a simple command on the victim\nmachine, the attacker would respond to three separate DNS TXT queries with the following responses:\n\n1. S000s>10100\n\n1. Create a file under the receivedbox folder called rcvd10100\n2. S0000>d2hvYW1pJmlwY29uZmlnIC9hbGw=\n\n1. Decode command to the right of >\n\n1. Replace('-', '+')\n2. Replace('_', '/')\n3. Base64 Decode\n3. E0000>0\n\n1. Write the decoded command to the file\n\n## Data Exfiltration\n\nNormal DNS A records are used to return an IP address for the given domain or subdomain. BONDUPDATER abuses DNS A records\nfor data exfiltration. We observed BONDUPDATER sending the output of a CLI command across multiple DNS A requests (Figure 2).\nThe data was stuffed into one of the subdomains. Using this method, the attacker may pull down any file provided they remain\nundetected for a prolonged period of time to successfully transfer the required data. Data exfiltration, using this method, takes time\nand generates a large number of requests that could be noticed by network IDS/IPS.\n\n_Figure 2. Exfiltrating Data_\n\nBONDUPDATER exfiltrates files by adding two more subdomains to the FQDN.\n\n### Data Subdomain\n\nThe first of the two inserted subdomains contains one of three possible entries:\n\n1. Data exfiltration header\n2. Data being exfiltrated\n3. Data exfiltration end marker\n\nThe following strings represent the same data exfiltration header presented here in two forms:\n\nUn-obfuscated: <redacted>. 10100*9056*****************.33333210100A[.]withyourface[.]com\nObfuscated:\n<redacted>.COCTab33333233332222222222222222210100A9056AAAAAAAAAAAAAAAAA.33333210100A[.]withyourface[.]com\n\n\n-----\n\nBONDUPDATER sends the data using the obfuscated form. The un obfuscated form was added for clarity. COCTab indicates this\nsubdomain is a data exfiltration header. The next 5 characters match the name received by the S000s command (above). The actors\nadd these characters to map the data being received to the command they issued. The script obfuscates all the data of this\nsubdomain except for the “COCTab” header. BONDUPDATER obfuscates the file content, sent to the attacker.\n\n<redacted>.EBB466767667256666772556776662FBFD932F3F64079E4F730B65239FE0.33333210100A[.]withyourface[.]com\n\nThe obfuscation technique is covered in the next section.  The final entry type, “COCTabCOCT”, denotes the end of the data\nsegment:\n\n<redacted>.COCTabCOCT.33333210100A[.]withyourface[.]com\n\n### Data Obfuscation Technique\n\nThe actor obfuscates the data by splitting each byte into two nibbles. The first nibble goes into one list and the second nibble goes into\nthe second list. Each list contains a max of 15 characters but may have less depending on the number of remaining bytes. The script\njoins the lists together end to end to create the subdomain (Figure 3).\n\n_Figure 3: Binary Scrambling_\n\nThe script below reorganizes the nibbles into their respective bytes (Figure 4).\n```\nimport binascii\ndata = 'EBB466767667256666772556776662FBFD932F3F64079E4F730B65239FE0'\nexfil_data = []\nfor x in range(int(len(data)/2)):\n  try:\n    exfil_data.append(binascii.unhexlify(data[x] + data[int(len(data)/2)+x]))\n  except:\n    exfil_data.append(data[x] + data[int(len(data)/2)+x])\nprint(''.join(exfil_data))\n\n```\n_Figure 4: Python2 snippet to reconstruct the data_\n\nThe above code snippet returns: Microsoft Windows [Version, which is part of the output when running the following command:\n\n\n-----\n\nwhoami&ipconfig /all\n\n### Command Identification Marker\n\nThe third level subdomain contains an identification marker as noted below:\n\n<redacted>.COCTabCOCT.33333210100A[.]withyourface[.]com\n\nThe value equals the command identifier specified by the S000s command (above). Similar to a campaign ID/name, it is likely the\nattackers use this marker to categorize and sort C2 communications. This subdomain also uses the same algorithm defined in Figure\n3.\n\n## Summary & Recommendations\n\nAPT actors continually revamp and develop new capabilities to add to their portfolio and BONDUPDATER is no exception. The custom\nDNS tunneling and obfuscation technique allows the attacker to circumvent some defense measures. From a defender’s perspective,\nASERT recommends that all DNS traffic be monitored for abnormal behavior such as abnormally long domain names. At a minimum,\ninspect DNS A records for “COCTab” which could be a sign of this specific infection. Practice good email hygiene and disable scripts\nfrom running in Office documents where possible. Enable PowerShell logging to monitor for suspicious behavior. Research into this\ngroup and specifically BONDUPDATER, reveals that the actor is continuously improving their toolset to maximize their chances of\nsuccess. Thus, layered controls are essential for detecting the threats of tomorrow.\n\n## IOCs\n\nwithyourface[.]com\n52b6e1ef0d079f4c2572705156365c06 - Word Document\n8c4fa86dcc2fd00933b70cbf239f0636 - PowerShell Script\n\nPosted In\n\nAdvanced Persistent Threats\nMalware\n\n## Subscribe\n\n_Sign up now to receive the latest notifications and updates from NETSCOUT's ASERT._\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-09-14 - Tunneling Under the Sands.pdf"
    ],
    "report_names": [
        "2018-09-14 - Tunneling Under the Sands.pdf"
    ],
    "threat_actors": [
        {
            "id": "ce10c1bd-4467-45f9-af83-28fc88e35ca4",
            "created_at": "2022-10-25T15:50:23.458833Z",
            "updated_at": "2025-03-27T02:00:55.475188Z",
            "deleted_at": null,
            "main_name": "APT34",
            "aliases": null,
            "source_name": "MITRE:APT34",
            "tools": [
                "netstat",
                "Systeminfo",
                "PsExec",
                "SEASHARPEE",
                "Tasklist",
                "Mimikatz",
                "POWRUNER",
                "certutil"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3eebdb3f-f4e3-42e5-bb4d-f02a13328316",
            "created_at": "2024-05-01T02:03:08.014303Z",
            "updated_at": "2025-03-27T02:05:17.306592Z",
            "deleted_at": null,
            "main_name": "COBALT EDGEWATER",
            "aliases": [
                "Cold River ",
                "DNSpionage ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT EDGEWATER",
            "tools": [
                " DNSpionage",
                " Karkoff",
                " MailDropper",
                " SideTwist",
                " TWOTONE",
                "AgentDrable"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536041,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1653775051,
    "ts_modification_date": 1653775051,
    "files": {
        "pdf": "https://archive.orkl.eu/7283d141379e63fc1a50f7d6a13198991fef3a20.pdf",
        "text": "https://archive.orkl.eu/7283d141379e63fc1a50f7d6a13198991fef3a20.txt",
        "img": "https://archive.orkl.eu/7283d141379e63fc1a50f7d6a13198991fef3a20.jpg"
    }
}