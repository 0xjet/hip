{
    "id": "7be3e32f-0110-4a40-8bd9-d82b61ecbdcb",
    "created_at": "2023-01-12T15:07:54.470888Z",
    "updated_at": "2025-03-27T02:05:28.112307Z",
    "deleted_at": null,
    "sha1_hash": "8337dd04be7729a9f44cfaeaae5968a464802b11",
    "title": "2018-05-07 - SynAck targeted ransomware uses the Doppelgänging technique",
    "authors": "",
    "file_creation_date": "2022-05-28T03:25:11Z",
    "file_modification_date": "2022-05-28T03:25:11Z",
    "file_size": 765587,
    "plain_text": "# SynAck targeted ransomware uses the Doppelgänging technique\n\n**[securelist.com/synack-targeted-ransomware-uses-the-doppelganging-technique/85431/](https://securelist.com/synack-targeted-ransomware-uses-the-doppelganging-technique/85431/)**\n\nAuthors\n\nAnton Ivanov\n\nFedor Sinitsyn\n\n[Orkhan Mamedov](https://securelist.com/author/orkhanmamedov/)\n\n[The Process Doppelgänging technique was first presented in December 2017 at the](https://www.blackhat.com/docs/eu-17/materials/eu-17-Liberman-Lost-In-Transaction-Process-Doppelganging.pdf)\nBlackHat conference. Since the presentation several threat actors have started using this\nsophisticated technique in an attempt to bypass modern security solutions.\n\n\n-----\n\nIn April 2018, we spotted the first ransomware employing this bypass technique – SynAck\nransomware. It should be noted that SynAck is not new – it has been known since at least\nSeptember 2017 – but a recently discovered sample caught our attention after it was found\nto be using Process Doppelgänging. Here we present the results of our investigation of this\nnew SynAck variant.\n\n## Anti-analysis and anti-detection techniques\n\n### Process Doppelgänging\n\nSynAck ransomware uses this technique in an attempt to bypass modern security solutions.\nThe main purpose of the technique is to use NTFS transactions to launch a malicious\nprocess from the transacted file so that the malicious process looks like a legitimate one.\n\n### Binary obfuscation\n\nTo complicate the malware analysts’ task, malware developers often use custom PE packers\nto protect the original code of the Trojan executable. Most packers of this type, however, are\neffortlessly unpacked to reveal the original unchanged Trojan PE file that’s suitable for\nanalysis.\n\nThis, however, is not the case with SynAck. The Trojan executable is not packed; instead, it\nis thoroughly obfuscated prior to compilation. As a result, the task of reverse engineering is\nconsiderably more complicated with SynAck than it is with other recent ransomware strains.\n\n\n-----\n\nThe control flow of the Trojan executable is convoluted. Most of the CALLs are indirect, and\nthe destination address is calculated by arithmetic operation from two DWORD constants.\n\nAll of the WinAPI function addresses are imported dynamically by parsing the exports of\nsystem DLLs and calculating a CRC32-based hash of the function name. This in itself is\nneither new nor particularly difficult to analyze. However, the developers of SynAck further\ncomplicated this approach by obscuring both the address of the procedure that retrieves the\nAPI function address, and the target hash value.\n\nLet’s illustrate in detail how SynAck calls WinAPI functions. Consider the following piece of\ndisassembly:\n\nThis code takes the DWORD located at 403b13, subtracts the constant 78f5ec4d, with the\nresult 403ad0, and calls the procedure at this address.\n\n\n-----\n\nThis procedure pushes two constants (N1 = ffffffff877bbca1 and N2 = 2f399204) onto the\nstack and passes the execution to the procedure at 403680 which will calculate the result of\nN1 xor N2 = a8422ea5.\n\nThis value is the hash of the API function name that SynAck wants to call. The procedure\n403680 will then find the address of this function by parsing the export tables of system\nDLLs, calculating the hash of each function name and comparing it to the value a8422ea5.\nWhen this API function address is found, SynAck will pass the execution to this address.\n\nNotice that instead of a simple CALL in the image above it uses the instructions PUSH +\nRET which is another attempt to complicate analysis. The developers of SynAck use different\ninstruction combinations instead of CALL when calling WinAPI functions:\n```\n   push reg\n   retn\n\n```\njmp reg\n\n```\nmov [rsp-var], reg\n\n```\n```\njmp qword ptr [rsp-var]\n\n```\n\n**Deobfuscation**\n\nTo counter these attempts by the malware developers, we created an IDAPython script that\nautomatically parses the code, extracts the addresses of all intermediate procedures,\nextracts the constants and calculates the hashes of the WinAPI functions that the malware\nwants to import.\n\nWe then calculated the hash values of the functions exported from Windows system DLLs\nand matched them against the values required by SynAck. The result was a list showing\nwhich hash value corresponds to which API function.\n\n\n-----\n\nOur script then uses this list to save comments in the IDA database to indicate which API is\ngoing to be called by the Trojan. Here is the code from the example above after\ndeobfuscation.\n\n### Language check\n\nAt an early stage of execution the Trojan performs a check to find out whether it has been\nlaunched on a PC from a certain list of countries. To do this, it lists all the keyboard layouts\ninstalled on the victim’s PC and checks against a list hardcoded into the malware body. If it\nfinds a match, SynAck sleeps for 300 seconds and then just calls ExitProcess to prevent\nencryption of files belonging to a victim from these countries.\n\n\n-----\n\n### Directory name validation\n\nShortly after the language check, which can be considered fairly common among modern\nransomware, SynAck performs a check on the directory where its executable is started from.\nIf there’s an attempt to launch it from an ‘incorrect’ directory, the Trojan won’t proceed and\nwill just exit instead. This measure has been added by the malware developers to counter\nautomatic sandbox analysis.\n\nAs with API imports, the Trojan doesn’t store the strings it wants to check; instead it stores\ntheir hashes – a tactic that hinders efforts to find the original strings.\n\nSynAck contains nine hashes; we have been able to brute-force two of them:\n\n```\n0x05f9053d == hash(\"output\")\n\n```\n```\n0x2cd2f8e2 == hash(\"plugins\")\n\n```\n\nIn the process we found a lot of collisions (gibberish strings that give the same hash value as\nthe meaningful ones).\n\n## Cryptographic scheme\n\n\n-----\n\nLike other ransomware, SynAck uses a combination of symmetric and asymmetric\n[encryption algorithms. At the core of the SynAck algorithm lies the hybrid ECIES scheme. It](https://en.wikipedia.org/wiki/Integrated_Encryption_Scheme)\nis composed of ‘building blocks’ which interact with each other: ENC (symmetric encryption\nalgorithm), KDF (key derivation function), and MAC (message authentication code). The\nECIES scheme can be implemented using different building blocks. To calculate a key for the\nsymmetric algorithm ENC, this scheme employs the ECDH protocol (Diffie-Hellman over a\nchosen elliptic curve).\n\nThe developers of this Trojan chose the following implementation:\n\nENC: XOR\n\nKDF: PBKDF2-SHA1 with one iteration\n\nMAC: HMAC-SHA1\n\nECDH curve: standard NIST elliptic curve secp192r1\n\n### ECIES-XOR-HMAC-SHA1\n\nThis is the function that implements the ECIES scheme in the SynAck sample.\n\nInput: plaintext, input_public_key\n\nOutput: ciphertext, ecies_public_key, MAC\n\n1. The Trojan generates a pair of asymmetric keys: ecies_private_key and\n\n**ecies_public_key;**\n2. Using the generated ecies_private_key and input_public_key the Trojan calculates\n\nthe shared secret according to the Diffie-Hellman protocol on an elliptic curve:\n\n```\necies_shared_secret = ECDH(ecies_private_key, input_public_key)\n\n```\n\n3. Using the PBKDF2-SHA1 function with one iteration, the Trojan derives two byte\n\narrays, key_enc and key_mac, from ecies_shared_secret. The size of key_enc is\nequal to the size of the plaintext;\n4. The plaintext is XORed byte to byte with the key_enc;\n5. The Trojan calculates the MAC (message authentication code) of the obtained\n\nciphertext using the algorithm HMAC-SHA1 with key_mac as the key.\n\n### Initialization\n\nAt the first step the Trojan generates a pair of private and public keys: the private key\n(session_private_key) is a 192-bit random number and the public key\n(session_public_key) is a point on the standard NIST elliptic curve secp192r1.\n\n\n-----\n\nThen the Trojan gathers some unique information such as computer and user names, OS\nversion info, unique infection ID, session private key and some random data and encrypts it\nusing a randomly generated 256-bit AES key. The encrypted data is saved as the\n**encrypted_unique_data buffer.**\n\nTo encrypt the AES key, the Trojan uses the ECIES-XOR-HMAC-SHA1 function (see\ndescription above; hereafter referred to as the ECIES function). SynAck passes the AES key\nas the plaintext parameter and the hardcoded cybercriminal’s master_public_key as\n_input_public_key. The field encrypted_aes_key contains the ciphertext returned by the_\nfunction, public_key_n is the ECIES public key and message_authentication_code is the\nMAC.\n\nAt the next step the Trojan forms the structure cipher_info.\n```\nstruct cipher_info\n{\nuint8_t encrypted_unique_data[240];\nuint8_t public_key_n[49];\nuint8_t encrypted_aes_key[44];\nuint8_t message_authentication_code[20];\n};\n\n```\nIt is shown in the image below.\n\nThis data is then encoded in base64 and written into the ransom note.\n\n\n-----\n\nAs we can see, the criminals ask the victim to include this encoded text in their message.\n\n### File encryption\n\nThe content of each file is encrypted by the AES-256-ECB algorithm with a randomly\ngenerated key. After encryption, the Trojan forms a structure containing information such as\nthe encryption label 0xA4EF5C91, the used AES key, encrypted chunk size and the original\nfile name. This information can be represented as a structure:\n```\nstruct encryption_info\n{\nuint32_t label = 0xA4EF5C91;\nuint8_t aes_key[32];\nuint32_t encrypted_chunk_size;\nuint32_t reserved;\nuint8_t original_name_buffer[522];\n};\n\n```\n\n-----\n\nThe Trojan then calls the ECIES function and passes the encryption_info structure as the\n_plaintext and the previously generated session_public_key as the input_public_key. The_\nresult returned by this function is saved into a structure which we dubbed\n_file_service_structure. The field encrypted_file_info contains the ciphertext returned by the_\nfunction, ecc_file_key_public is the ECIES public key and message_authentication_code is\nthe MAC.\n```\nstruct file_service_structure\n{\nuint8_t ecc_file_key_public[49];\nencryption_info encrypted_file_info;\nuint8_t message_authentication_code[20];\n};\n\n```\nThis structure is written to the end of the encrypted file. This results in an encrypted file\nhaving the following structure:\n```\nstruct encrypted_file\n{\nuint8_t encrypted_data[file_size - file_size % AES_BLOCK_SIZE];\nuint8_t original_trailer[file_size % AES_BLOCK_SIZE];\nuint64_t encryption_label = 0x65CE3D204A93A12F;\nuint32_t infection_id;\nuint32_t service_structure_size;\nfile_service_structure service_info;\n};\n\n```\nThe encrypted file structure is shown in the image below.\n\n\n-----\n\nAfter encryption the files will have randomly generated extensions.\n\n## Other features\n\n### Termination of processes and services\n\nPrior to file encryption, SynAck enumerates all running processes and all services and\nchecks the hashes of their names against two lists of hardcoded hash values (several\nhundred combined). If it finds a match, the Trojan will attempt to kill the process (using the\nTerminateProcess API function) or to stop the service (using ControlService with the\nparameter SERVICE_CONTROL_STOP).\n\nTo find out which processes it wants to terminate and which services to stop, we brute-forced\nthe hashes from the Trojan body. Below are some of the results.\n\n**Processes** **Services**\n\n**Hash** **Name** **Hash** **Name**\n\n0x9a130164 dns.exe 0x11216a38 vss\n\n0xf79b0775 lua.exe 0xe3f1f130 mysql\n\n0x6475ad3c mmc.exe 0xc82cea8d qbvss\n\n0xe107acf0 php.exe 0xebcd4079 sesvc\n\n0xf7f811c4 vds.exe 0xf3d0e358 vmvss\n\n0xcf96a066 lync.exe 0x31c3fbb6 wmsvc\n\n0x167f833f nssm.exe 0x716f1a42 w3svc\n\n\n-----\n\n0x255c7041 ssms.exe 0xa6332453 memtas\n\n0xbdcc75a9 w3wp.exe 0x82953a7a mepocs\n\n0x410de6a4 excel.exe\n\n0x9197b633 httpd.exe\n\n0x83ddb55a ilsvc.exe\n\n0xb27761ed javaw.exe\n\n0xfd8b9308 melsc.exe\n\n0xa105f60b memis.exe\n\n0x10e94bcc memta.exe\n\n0xb8de9e34 mepoc.exe\n\n0xeaa98593 monad.exe\n\n0x67181e9b mqsvc.exe\n\n0xd6863409 msoia.exe\n\n0x5fcab0fe named.exe\n\n0x7d171368 qbw32.exe\n\n0x7216db84 skype.exe\n\n0xd2f6ce06 steam.exe\n\n0x68906b65 store.exe\n\n0x6d6daa28 vksts.exe\n\n0x33cc148e vssvc.exe\n\n0x26731ae9 conime.exe\n\n0x76384ffe fdhost.exe\n\n0x8cc08bd7 mepopc.exe\n\n0x2e883bd5 metray.exe\n\n0xd1b5c8df mysqld.exe\n\n0xd2831c37 python.exe\n\n\n-----\n\n0xf7dc2e4e srvany.exe\n\n0x8a37ebfa tabtip.exe\n\nAs we can see, SynAck seeks to stop programs related to virtual machines, office\napplications, script interpreters, database applications, backup systems, gaming applications\nand so on. It might be doing this to grant itself access to valuable files that could have been\notherwise used by the running processes.\n\n### Clearing the event logs\n\nTo impede possible forensic analysis of an infected machine, SynAck clears the event logs\nstored by the system. To do so, it uses two approaches. For Windows versions prior to Vista,\nit enumerates the registry key SYSTEM\\CurrentControlSet\\Services\\EventLog and uses\nOpenEventLog/ClearEventLog API functions. For more modern Windows versions, it uses\nthe functions from EvtOpenChannelEnum/EvtNextChannelPath/EvtClearLog and from\nWevtapi.dll.\n\nSynAck is also capable of adding a custom text to the Windows logon screen. It does this by\nmodifying the LegalNoticeCaption and LegalNoticeText keys in the registry. As a result,\nbefore the user signs in to their account, Windows shows a message from the\ncybercriminals.\n\n## Attack statistics\n\n\n-----\n\nWe have currently only observed several attacks in the USA, Kuwait, Germany, and Iran.\nThis leads us to believe that this is targeted ransomware.\n\n## Detection verdicts\n\nTrojan-Ransom.Win32.Agent.abwa\n\nTrojan-Ransom.Win32.Agent.abwb\n\nPDM:Trojan.Win32.Generic\n\n## IoCs\n\n0x6F772EB660BC05FC26DF86C98CA49ABC\n0x911D5905CBE1DD462F171B7167CD15B9\n\n[Malware Descriptions](https://securelist.com/tag/malware-descriptions/)\n[Malware Technologies](https://securelist.com/tag/malware-technologies/)\n[Obfuscation](https://securelist.com/tag/obfuscation/)\n[Ransomware](https://securelist.com/tag/ransomware/)\n[Trojan](https://securelist.com/tag/trojan/)\n\nAuthors\n\nAnton Ivanov\n\nFedor Sinitsyn\n\n[Orkhan Mamedov](https://securelist.com/author/orkhanmamedov/)\n\nSynAck targeted ransomware uses the Doppelgänging technique\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-05-07 - SynAck targeted ransomware uses the Doppelgänging technique.pdf"
    ],
    "report_names": [
        "2018-05-07 - SynAck targeted ransomware uses the Doppelgänging technique.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536074,
    "ts_updated_at": 1743041128,
    "ts_creation_date": 1653708311,
    "ts_modification_date": 1653708311,
    "files": {
        "pdf": "https://archive.orkl.eu/8337dd04be7729a9f44cfaeaae5968a464802b11.pdf",
        "text": "https://archive.orkl.eu/8337dd04be7729a9f44cfaeaae5968a464802b11.txt",
        "img": "https://archive.orkl.eu/8337dd04be7729a9f44cfaeaae5968a464802b11.jpg"
    }
}