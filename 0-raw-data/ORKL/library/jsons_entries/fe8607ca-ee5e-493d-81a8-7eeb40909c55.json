{
    "id": "fe8607ca-ee5e-493d-81a8-7eeb40909c55",
    "created_at": "2023-01-12T15:00:03.896329Z",
    "updated_at": "2025-03-27T02:09:18.0542Z",
    "deleted_at": null,
    "sha1_hash": "5e24e3153c4e150c50e18840049cc6ca1494aadc",
    "title": "2022-10-03 - Bumblebee- increasing its capacity and evolving its TTPs",
    "authors": "",
    "file_creation_date": "2022-10-23T13:11:26Z",
    "file_modification_date": "2022-10-23T13:11:26Z",
    "file_size": 965403,
    "plain_text": "# Bumblebee: increasing its capacity and evolving its TTPs\n\n**[research.checkpoint.com/2022/bumblebee-increasing-its-capacity-and-evolving-its-ttps/](https://research.checkpoint.com/2022/bumblebee-increasing-its-capacity-and-evolving-its-ttps/)**\n\nOctober 3, 2022\n\nOctober 3, 2022\n**Research by: Marc Salinas Fernandez**\n\n## Background & Key Findings\n\nThe spring of 2022 saw a spike in activity of Bumblebee loader, a [recent threat that has](https://www.proofpoint.com/us/blog/threat-insight/bumblebee-is-still-transforming)\n[garnered a lot of attention due to its many links to several well-known malware families. In](https://securityintelligence.com/posts/from-ramnit-to-bumblebee-via-neverquest/)\nthis piece we outline the conclusions of our research into this piece of malware:\n\nBumblebee is in constant evolution, which is best demonstrated by the fact that the\nloader system has undergone a radical change twice in the range of a few days — first\nfrom the use of ISO format files to VHD format files containing a powershell script, then\nback again.\nChanges in the behavior of Bumblebee’s servers that occurred around June 2022\nindicate that the attackers may have shifted their focus from extensive testing of their\nmalware to reach as many victims as possible.\n\n\n-----\n\nAlthough the threat contains a field called `group_name, it may not be a good indicator`\nfor clustering-related activity: samples with different `group_name values have been`\nexhibiting similar behavior, which may indicate a single actor operating many\n```\n   group_names . The same is not true for encryption keys: different encryption keys\n\n```\ngenerally imply different behavior, as expected.\nBumblebee payloads vary greatly based on the type of victim. Infected standalone\ncomputers will likely be hit with banking trojans or infostealers, whereas organizational\nnetworks can expect to be hit with more advanced post-exploitation tools such as\nCobaltStrike.\n\n## Bumblebee Analysis\n\nThe Bumblebee loader usually comes in the form of a DLL-like binary packed with a custom\npacker. The method by which this DLL is delivered seems to be subject to change on the\nwhims of the threat’s adventurous developers: while the prevailing method is to embed the\npacked DLL directly inside another file (usually an ISO), during a short stint in June the\nmalware’s operators experimented with using VHD files that executed PowerShell\ndownloading and decrypting the packed DLL itself (packed with a very different packer), as\ndocumented by Deep Instinct. This trend seems to have died out and now the DLL can be\nfound directly embedded in the 1st-stage file again, whether an ISO or a VHD.\n\nOnce unpacked, Bumblebee will perform checks to avoid being executed in sandboxing or\nanalyst environments; most of the code responsible for this is open source, lifted directly\nfrom the [Al-Khaser project. If these checks pass, Bumblebee proceeds to load its](https://github.com/LordNoteworthy/al-khaser)\nconfiguration into memory. This is done by loading four pointers from its `.data section`\nwhich point to four different buffers in a contiguous encrypted configuration struct. The first of\nthese points to an 80-byte section that stores an RC4 ascii key (much shorter in all cases\nwe’ve observed). The other three pointers point to two 80-byte sections and a 1024-byte\nsection, all of which contain data that is then decrypted using the above-mentioned RC4 key.\n\nOnce decrypted, the first 80-byte buffer in most of the samples to date has simply contained\nthe number “444”; the malware makes no use of this number so its significance is not clear.\nThe second buffer contains an ASCII code which is called `group_name by the malware.`\nFinally, the 1024-byte block contains a list of command and control servers (most of them are\nusually fake).\n\n\n-----\n\nFigure 1: Bumblebee ciphered configuration\nBumblebee computes a machine-specific pseudorandom victim ID (internally named\n```\nclient_id ) via the usual method of concatenating some immutable machine parameters\n\n```\n(in this case, machine name and GUUID) and then calculating a hash of the result (in this\ncase, an MD5 digest).\n\nUsing this data and some other elements collected from the victim system, Bumblebee builds\na C&C check-in in JSON format, such as the one below:\n```\n{\n \"client_id\":\"3f4aa6d4e02790dea90186c5376c0064\",\n\n \"group_name\":\"1406r\",\n\n \"sys_version\":\"Microsoft Windows 10 pro \\\\nUser name: LUCAS-PC\\\\nDomain name:\nWORKGROUP\",\n\n \"client_version\":1\n\n}\n\n\n```\nThis string is encrypted using the same RC4 key used earlier for the configuration, and\nrepeatedly sent to its C2 server with random delays between 25 seconds and 3 minutes\nregardless of whether the server responds or it’s down. The response from the command\nand control server is also in JSON format and also encrypted with the same RC4 key (we\nappreciate this elegant design and encourage malware authors to aspire to this standard of\nlegibility). The content of the response itself naturally varies, and can be for example an\nempty response:\n```\n{\n\n \"response_status\":1,\n\n \"tasks\":null\n\n}\n\n\n```\nOr some payload to inject or execute:\n\n\n-----\n\n```\n{\n\n \"response_status\": 1,\n\n \"tasks\": [\n\n  {\n\n   \"task\": \"shi\",\n\n   \"task_id\": 5245,\n\n   \"task_data\":\n\"/EiD5PDowAAAAEFRQVBSUVZIMdJlSItSYEiLUhhIi1IgSItyUEgPt0pKTTHJSDHArDxhfAIsIEHByQ1BAcHi7\n\n   \"file_entry_point\": \"\"\n\n  }\n\n ]\n\n}\n\n```\nIn the case of receiving a payload, the structure of the response will contain a list of elements\nin the `tasks section of the json, each with a command and a payload. Each of the`\nelements will contain, among others, a `task field with the name of the command to be`\nexecuted, and a base64 encoded payload inside a section called `task_data .`\n\n## Botnet Behavior Analysis\n\nUntil early July we have observed a very curious behavior of the command and control\nservers. Once a `client_id was generated for an infected victim and sent to a command`\nand control server, that command and control server would stop accepting other different\n```\nclient_id codes from that same victim external IP. This means that if several computers\n\n```\nin an organization, accessing the internet with the same public IP were infected, the C2\nserver will only accept the first one infected. But several weeks ago this feature was abruptly\nturned off, drastically increasing the number of established connections to infected victims at\nthe expense of… whatever this feature was supposed to achieve (possibly it was indicative\nof a testing phase for the malware, which has now ended).\n\nThis behavior motivated us to pay special attention to the behavior of Bumblebee in different\nexecution environments. Notably, despite having a field called `group_name hardcoded in`\nevery sample, this value is sent in each request to the command and control server. Further,\nthe above-described “one `client_id per IP address” policy curiously seemed to apply`\nacross different `group_name s — but not across different RC4 encryption keys, which`\nseems to imply the use of several `group_name s by what is effectively the same botnet,`\npossibly to mark different campaigns or different sets of victims. As a result, grouping activity\nby encryption key seems to be a more coherent approach than grouping by `group_name .`\n\nThis hypothesis is further supported by the fact that we’ve observed several samples with the\nsame RC4 key and different `group_name acting identically and dropping the same threats`\nwithin a very close time range, while samples that differ in their used RC4 key exhibit\ncompletely different behavior.\n\n\n-----\n\nFigure 2: Different Bumblebee samples dropping the same payloads based on their RC4\nKeys\nThe fact that command and control servers with different IP addresses contacted by different\nsamples using the same RC4 key are returning the same payloads and blocking the same\n```\nclient_id for their victims also suggests that these IP addresses actually only act as\n\n```\nfronts for a main command and control server to which all Bumblebee connections are\nrelayed.\n\nAnother interesting element of the behavior of these botnets is how the toolset dropped by\nBumblebee into victim machines differs depending on the kind of target. To deploy a threat,\nof the 5 commands supported by bumblebee, 3 lead to code being downloaded from the C2\nserver and executed:\n```\n   DEX : deploys an executable to disk and runs it.\n   DIJ : Injects a library into a process and executes it.\n   SHI : injects and executes shellcode into a process.\n\n```\nAs part of our ongoing monitoring of various Bumblebee botnets, we have been monitoring\ndifferences in behavior based on factors such as type of network or geolocation. While the\nvictim’s geographical location didn’t seem to have any effect on the malware behavior, we\nobserved a very stark difference between the way Bumblebee behaves after infecting\nmachines that are part of a domain (a logical group of network that share the same Active\nDirectory server), as opposed to machines isolated from a company network that are\nconnected to a workgroup (a Microsoft term to denote a peer to peer local area network).\n\nIf the victim is connected to WORKGROUP, in most cases it receives the `DEX command`\n(Download and Execute), which causes it to drop and run a file from the disk. These\n[payloads are usually common stealers like Vidar Stealer, or banking trojans:](https://www.virustotal.com/gui/file/78456112caae4c00fa66e6f9c7474331a2befe795a75a7313d4e0770196a0b35/detection)\n\n\n-----\n\nFigure 3: Bumblebee C2 response with a DEX command containing a Base64 encoded\npayload\nOn the other hand, if the victim is connected to an AD domain, it generally receives DIJ\n(Download and Inject) or SHI (Download shellcode and Inject) commands.\n\nFigure 4: Bumblebee C2 response with a DIJ command containing a Base64 encoded\npayload\nIn these cases, the resulting threats have been payloads from more advanced postexploitation frameworks, such as CobaltStrike, Sliver or Meterpreter.\n\nIn these cases, it has also been observed that regardless of the IP of the command and\ncontrol server and the `group_name field, samples with the same RC4 key drop the same`\nCobalt Strike beacons with the same Team servers, which has proven to be a very useful\nmeans of relating different samples to each other as part of the same botnet.\n\nOne last interesting feature of the payloads dropped by Bumblebee is that both the binaries\ndownloaded using the DEX command and those downloaded with the DIJ command are in\nmany cases packaged using the same Bumblebee packer.\n\n## Conclusion\n\nAnalyzing the behavior of the command and control servers used by Bumblebee operators,\nwe have observed how they have tweaked the way their infection chains behave, sometimes\nin ways that served to drastically expand the number of active victims and volume of C2\ntraffic.\n\nFor the moment, behavior until the deployment of the 2nd-stage payload is very similar even\nacross different Bumblebee botnets, but further behavior starting with the choice of 2ndstage payload sharply diverges based on RC4 key used. This behavior can also serve to\ngroup activity into different clusters, on top of using the RC4 key itself.\n\nUnlike other threats that use third-party packers and off-the-crimeware-shelf antivirus\nevasion tools, Bumblebee uses its own packer both for the threat itself and for some of the\nsamples it deploys on victims’ computers, just like other advanced malware families such as\nTrickbot. While this allows Bumblebee operators greater flexibility in changing behavior and\nadding features, the use of unique custom tools also serves as a method to quickly identify\nBumblebee activity in the wild.\n\n\n-----\n\n_[Check Point s security products are designed to prevent any cyber attack and protect against](https://www.checkpoint.com/infinity/zero-day-protection/)_\n_threats such as described in this blog_\n\n## Yara Rule\n```\nrule malware_bumblebee_packed {\n\n  meta:\n\n    author = \"Marc Salinas @ CheckPoint Research\"\n\n    malware_family = \"BumbleBee\"\n\n    date = \"13/07/2022\"\n\n    description = \"Detects the packer used by bumblebee, the rule is based on the\ncode responsible for allocating memory for a critical structure in its logic.\"\n\n    dll_jul = \"6bc2ab410376c1587717b2293f2f3ce47cb341f4c527a729da28ce00adaaa8db\"\n\n    dll_jun = \"82aab01a3776e83695437f63dacda88a7e382af65af4af1306b5dbddbf34f9eb\"\n\n    dll_may = \"a5bcb48c0d29fbe956236107b074e66ffc61900bc5abfb127087bb1f4928615c\"\n\n    iso_jul = \"ca9da17b4b24bb5b24cc4274cc7040525092dffdaa5922f4a381e5e21ebf33aa\"\n\n    iso_jun = \"13c573cad2740d61e676440657b09033a5bec1e96aa1f404eed62ba819858d78\"\n\n    iso_may = \"b2c28cdc4468f65e6fe2f5ef3691fa682057ed51c4347ad6b9672a9e19b5565e\"\n\n    zip_jun = \"7024ec02c9670d02462764dcf99b9a66b29907eae5462edb7ae974fe2efeebad\"\n\n    zip_may = \"68ac44d1a9d77c25a97d2c443435459d757136f0d447bfe79027f7ef23a89fce\"\n\n  strings:\n\n    $heapalloc = { \n\n      48 8? EC [1-6]      // sub   rsp, 80h\n\n      FF 15 ?? ?? 0? 00 [0-5] // call  cs:GetProcessHeap\n\n      33 D2          // xor   edx, edx    ; dwFlags\n\n      4? [2-5]         // mov   rcx, rax    ; hHeap\n\n      4? ?? ??         // mov   r8d, ebx    ; dwBytes\n\n      FF 15 ?? ?? 0? 00    // call  cs:HeapAlloc\n\n      [8 - 11]         // (load params)\n\n      48 89 05 ?? ?? ?? 00   // mov   cs:HeapBufferPtr, rax\n\n      E8 ?? ?? ?? ??      // call  memset\n\n      4? 8B ?? ?? ?? ?? 00   // mov   r14, cs:HeapBufferPtr\n\n    } \n\n  condition:\n\n    $heapalloc\n\n}\n\n IOCs\n\n### Bumblebee samples\n\n```\nc70413851599bbcd9df3ce34cc356b66d10a5cbb2da97b488c1b68894c60ea69\n\n14f04302df7fa49d138c876705303d6991083fd84c59e8a618d6933d50905c61\n\n\n-----\n\n76e4742d9e7f4fd3a74a98c006dfdce23c2f9434e48809d62772acff169c3549\n\n024f8b16ee749c7bb0d76500ab22aa1418cd8256fb12dcbf18ab248acf45947e\n\n2691858396d4993749fec76ac34cf3cc3658ee3d4eaf9c748e2782cfc994849d\n\n6bc2ab410376c1587717b2293f2f3ce47cb341f4c527a729da28ce00adaaa8db\n\n083a4678c635f5d14ac5b6d15675d2b39f947bb9253be34d0ab0db18d3140f96\n\n21df56d1d4b0a6a54bae3aba7fe15d307bac0e3391625cef9b05dd749cf78c0c\n\n31005979dc726ed1ebfe05558f00c841912ca950dccdcdf73fd2ffbae1f2b97f\n\n2d67a6e6e7f95d3649d4740419f596981a149b500503cbc3fcbeb11684e55218\n\n3c0f67f71e427b24dc77b3dee60b08bfb19012634465115e1a2e7ee5bef16015\n\nca9da17b4b24bb5b24cc4274cc7040525092dffdaa5922f4a381e5e21ebf33aa\n\n82aab01a3776e83695437f63dacda88a7e382af65af4af1306b5dbddbf34f9eb\n\na5bcb48c0d29fbe956236107b074e66ffc61900bc5abfb127087bb1f4928615c\n\n07f277c527d707c6138aae2742939e8edc9f700e68c4f50fd3d17fe799641ea8\n\n68ac44d1a9d77c25a97d2c443435459d757136f0d447bfe79027f7ef23a89fce\n\n13c573cad2740d61e676440657b09033a5bec1e96aa1f404eed62ba819858d78\n\n7024ec02c9670d02462764dcf99b9a66b29907eae5462edb7ae974fe2efeebad\n\nee27cceac88199bf3546e8b187d77509519d6782a0e114fc9cfc11faa2d33cd1\n\nb2c28cdc4468f65e6fe2f5ef3691fa682057ed51c4347ad6b9672a9e19b5565e\n\n### Bumblebee C2 servers\n\n104.168.201.219 142.11.234.230 145.239.30.26\n\n145.239.135.155 145.239.28.110 146.19.173.202\n\n146.70.125.122 152.89.247.79 185.17.40.189\n\n185.62.58.175 205.185.122.143 205.185.123.137\n\n209.141.46.50 209.141.58.141 51.210.158.156\n\n51.68.144.94 51.68.145.54 51.68.146.186\n\n51.68.147.233 51.75.62.99 51.83.250.240\n\n\n-----\n\n51.83.251.245 51.83.253.131 51.83.253.244\n\n54.37.130.166 54.37.131.14 54.38.136.111\n\n54.38.136.187 54.38.138.94 54.38.139.20\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-10-03 - Bumblebee- increasing its capacity and evolving its TTPs.pdf"
    ],
    "report_names": [
        "2022-10-03 - Bumblebee- increasing its capacity and evolving its TTPs.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535603,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1666530686,
    "ts_modification_date": 1666530686,
    "files": {
        "pdf": "https://archive.orkl.eu/5e24e3153c4e150c50e18840049cc6ca1494aadc.pdf",
        "text": "https://archive.orkl.eu/5e24e3153c4e150c50e18840049cc6ca1494aadc.txt",
        "img": "https://archive.orkl.eu/5e24e3153c4e150c50e18840049cc6ca1494aadc.jpg"
    }
}