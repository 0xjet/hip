{
    "id": "410fb707-c99e-466f-bd72-0f23cc74da22",
    "created_at": "2024-11-13T13:20:51.73503Z",
    "updated_at": "2025-03-27T02:09:07.985145Z",
    "deleted_at": null,
    "sha1_hash": "9e7d0ed0ee13c063e15d90d82e7a08442c7220f8",
    "title": "",
    "authors": "",
    "file_creation_date": "2024-11-07T09:48:02Z",
    "file_modification_date": "2024-11-07T09:48:02Z",
    "file_size": 525196,
    "plain_text": "## Malware Analysis Report\n\n# Pygmy Goat\n\n###### TLP CLEAR\n\n Network Device Backdoor.\n\n**Version 3**\n\n**07[th] November 2024**\n\n© Crown Copyright 2024\n\n\n###### .\n\n\n-----\n\n### Pygmy Goat\n\n###### Network Device Backdoor.\n\n#### Executive summary \n\n  - Uses LD_PRELOAD to get loaded into /bin/sshd and hook its accept function.\n\n  - Listens on a raw socket for incoming ICMP packets to trigger a connect\n\nback, or uses the hooked accept function to search for a sequence of\nmagic bytes in SSH connections.\n\n  - Functionality includes remote shell, packet capture, cron tasks, and\n\ncreating a reverse SOCKS proxy server.\n\n#### Introduction \n\nPygmy Goat is a native x86-32 ELF shared object that was discovered on\n\nSophos XG firewall devices, providing backdoor access to the device.\n\nThe LD_PRELOAD environment variable is used to load the shared object into the\n```\nsshd (SSH daemon) binary.\n\n```\n  - Sample creates a raw ICMP socket to monitor for incoming packets,\n\nwhich contain an AES encrypted TCP callback IP and port for the sample\nto connect into for C2 functionality.\n\n  - Sample uses its LD_PRELOAD position to hook the socket accept function to\n\npeek at incoming traffic looking for a specific SSH protocol\n\nannouncement, and then reusing that connection as an alternative\nmeans for C2.\n\n  - Sample uses a hardcoded embedded CA certificate masquerading as\n\nFortinet to establish a TLS connection with the C2 and verify its peer.\n\n  - C2 commands enable the actor to establish a remote shell on the\n\ndevice, start a packet capture, create cron tasks, and create a reverse\nSOCKS proxy to send traffic to devices behind the firewall.\n\n\n-----\n\n#### Malware details\n\n**Metadata**\n\n|Filename|libsophos.so|\n|---|---|\n|Description|Malicious Shared Object loaded into /bin/sshd|\n|Size|1,759,412 bytes|\n|MD5|c71cd27efcdb8c44ab8c29d51f033a22|\n|SHA-1|71f70d61af00542b2e9ad64abd2dda7e437536ff|\n|SHA-256|6455de74ae15071fa98f18cdbc3148c967755e69df7dee747bc31d0387751162|\n\n|Filename|libsophos.so|\n|---|---|\n|Description|Earlier variant of libsophos.so, missing the reverse proxy functionality, and using VMProtect to obfuscate the binary|\n|Size|3,056,741 bytes|\n|MD5|3f28196675dc8cb20cf5b5f80ea29310|\n|SHA-1|7ace663c22b3e800fc17c1477d54b533f7002833|\n|SHA-256|823b079c75f4e6a5905d9eea9a60c62e1f0995bfc25764d1ba0407a5bd78c962|\n\n\n-----\n\n#### Functionality\n\n**Persistence**\nPygmy Goat expects to have been loaded into the /bin/sshd process using the\n```\nLD_PRELOAD environment variable, as evident by a hooked accept function, and\n\n```\nimmediate unset of the LD_PRELOAD environment variable when the binary is\nloaded. This suggests that the actor achieves persistence on the victim device\nthrough setting the LD_PRELOAD environment on boot, for example by modifying\na start-up script, with similar contents to:\n```\n    LD_PRELOAD=”libsophos.so” /bin/sshd\n\n```\nThis would ensure that the malicious libsophos.so file would be loaded into the\nnext executed ssh daemon at system start, with the ability to overload existing\nfunctions in the sshd binary.\n\n**Backdoor**\nThe Pygmy Goat libsophos.so binary has its INIT_ARRAY section populated\nwith a single entry pointing at a main_constructor function (named by the\n\nembedded debug symbols left inside the binary), which is guaranteed to\nexecute before the actual functionality of the sshd binary.\n\nThe main_constructor function forks so as not to block the loading of the\nlegitimate sshd process, and then immediately unsets the LD_PRELOAD\nenvironment variable for itself and all future child forks; although it is worth\nnoting the original parent sshd process would still have the LD_PRELOAD variable\nin its environment at this point.\n\nThe malware checks the uptime of the host system to ensure it has been up\nfor over 60 seconds, sleeping if not. It then attempts to acquire an exclusive\n\nlock on a single-instance pid file at ‘/var/run/sshd.pid’, to ensure it is the only\ninstance of the malware currently executing. The malware forks again to\nlaunch a crond daemon through a statically compiled embedded BusyBox 1.33.1\nto execute later cron tasks that the actor can deploy to the device through the\nmalware.\n\nFinally, the malware creates an ICMP raw socket to listen for all ICMP packets\nreceived by the device, as well as a Unix socket listening for connections to\n‘/tmp/.sshd.ipc’\n\n\n-----\n\nAs Pygmy Goat is loaded into the sshd process with LD_PRELOAD, any symbols\nexported by the libsophos.so shared object will replace the functions of any\nsymbols imported by /bin/sshd. Finding the intersection of the exports and\nimports of each reveals a single symbol; the accept function, effectively\nhooking any TCP connections made to the sshd daemon.\n\nOn being called, the hooked accept function uses dlsym to find and invoke the\n‘real’ accept function. The function then does a non-consuming, non-blocking\npeek at the first 0x17 bytes which it repeats every 100 milliseconds for three\nseconds until either 0x17 bytes are seen, the connection drops, or the time\n\nelapses. If 0x17 bytes are seen, they are compared against a hardcoded string\nof bytes:\n```\n    SSH-2.0-OpenSSH_5.3p1\\r\\n[1]\n\n```\nIf these bytes are seen, the malware detects a backdoor SSH connection,\nestablishing a connection to the /tmp/.sshd.ipc Unix socket created in the\n```\nmain_constructor function, which it uses to forward all data to and from the\n\n```\nbackdoor SSH connection.\n\nThe hooked accept function also unsets the LD_PRELOAD variable immediately\n\nwhen it is called.\n\n_Since the accept function is called in the parent sshd process which still had the_\n```\nLD_PRELOAD variable set, this hides the technique from casual forensics of the\n\n```\n_device as the environment variable is only set in the sshd process until the first_\n_time it accepts a TCP connection. That said, if the actor doesn’t attempt to_\n_connect to a Pygmy Goat victim after it first boots, or the actor uses the ICMP_\n_wake up method, the LD_PRELOAD variable will never be unset in the parent sshd_\n_process._\n\n1 Although this is a legitimate OpenSSH protocol version, it was released in 2009 and\n\npresumably deemed unlikely to appear naturally by the malware developers in 2024.\n\n\n-----\n\n**Commands**\nOnce a connection has been established with its C2, Pygmy Goat has a\nnumber of commands it can execute according to a command ID byte. Each\ncommand is detailed further in C2 Tasking.\n\n**Command**\n\n**Description**\n**ID**\n\n`0x01` Responds with the current date and time\n\n`0x02` Responds with system details\n\n`0x03` Spawns a /bin/sh shell\n\n`0x04` Spawns a /bin/csh shell\n\n`0x05` Spawns crontab to create new scheduled tasks\n\n`0x06` Starts a packet capture\n\n`0x07` Connects back to an EarthWorm Server (see EarthWorm Reverse Socks Proxy) to\ncreate a reverse SOCKS5 proxy\n\n#### Communications\n\nPygmy Goat has two mechanisms that the actor can use to establish a C2\nconnection to the backdoor on demand:\n\n  - Port knock via ICMP raw socket.\n\n  - Response to the hooked SSH accept.\n\n**ICMP Port Knock**\nOn receiving an ICMP packet of any type, Pygmy Goat will attempt to decrypt\nthe first 0x10 bytes in the ICMP Data section with a hardcoded IV and key, using\nAES-256-CBC with null padding:\n```\n   IV: 43 4a fc 1c 5d 9d 77 06 67 c1 c3 0e c1 37 47 bb\n   Key: 59 4b 6e 77 51 6a 6d 41 54 62 41 6e 52 6f 5a 6d \n      30 66 47 37 55 5a 57 62 32 59 55 78 55 51 50 77\n\n```\nOnce decrypted, the first four bytes are compared to a magic byte sequence\nto ensure the data is in fact a C2 control packet and not a legitimate ICMP\npacket:\n```\n    ef 12 68 45\n\n```\n|Command ID|Description|\n|---|---|\n|0x01|Responds with the current date and time|\n|0x02|Responds with system details|\n|0x03|Spawns a /bin/sh shell|\n|0x04|Spawns a /bin/csh shell|\n|0x05|Spawns crontab to create new scheduled tasks|\n|0x06|Starts a packet capture|\n|0x07|Connects back to an EarthWorm Server (see EarthWorm Reverse Socks Proxy) to create a reverse SOCKS5 proxy|\n\n\n-----\n\nThe next four bytes are treated as a big-endian IPv4 address, followed by two\nbytes of a big-endian TCP port number, with the remainder of the data being\nignored.\n\n_All example data in this report has been generated in a virtual environment_\n_using the Pygmy Goat sample, and as such is indicative, rather than being_\n_procured from any victim or actor data._\n\n**Encrypted ICMP packet**\n```\n00 00 cc a2 5a 9d 00 01 d7 00 9e 6c 17 c0 82 6b 95 f0 fa 5b 5b 4e\ndd 8a\n  Echo (ping) reply ICMP code ICMP checksum\n  ICMP identifier Sequence Number Encrypted Data\n\n```\n**Decrypted packet data**\n```\nef 12 68 45 c0 a8 06 01 1e 61 00 00 00 00 00 00\n  Magic validation IPv4 Address TCP port 7777\n     bytes 192.168.6.1\n                AES padding\n\n```\nOnce the C2 IPv4 address and TCP port have been extracted, Pygmy Goat\n\nestablishes a TLS connection with the server, verifying the certificate presented\nby the server against a Root CA certificate embedded inside the libsophos.so\nbinary (see TLS Root CA Certificate). This is somewhat noteworthy as it means\nthe actor can send the ICMP packets from a different device to the C2\nconnect-back server.\n\n_The Root CA Certificate claims to have been issued by FortiGate, Fortinet Ltd.,_\n_another network device vendor._\n\n|Encrypted ICMP packet|Col2|Col3|\n|---|---|---|\n|00 00 cc a2 5a 9d 00 01 d7 00 9e 6c 17 c0 82 6b 95 f0 fa 5b 5b 4e dd 8a|||\n|Echo (ping) reply|ICMP code|ICMP checksum|\n|ICMP identifier|Sequence Number|Encrypted Data|\n\n|Decrypted packet data|Col2|Col3|\n|---|---|---|\n|ef 12 68 45 c0 a8 06 01 1e 61 00 00 00 00 00 00|||\n|Magic validation bytes|IPv4 Address 192.168.6.1|TCP port 7777|\n|AES padding|||\n\n\n-----\n\n**SSH Accept Hook**\nOnce the hooked accept function has identified the SSH version magic bytes\nand delegated the connection over the Unix socket at ‘/tmp/.sshd.ipc’, Pygmy\nGoat continues to perform a fake SSH handshake with hardcoded data,\nreading a fixed number of bytes in response, although ignoring the contents:\n\n|Fake SSH Handshake (C2 -> Malware)|Col2|Col3|\n|---|---|---|\n|0x0000 0x0010|53 53 48 2d 32 2e 30 2d 4f 70 65 6e 53 53 48 5f 35 2e 33 70 31 0d 0a|SSH-2.0-OpenSSH_ 5.3p1..|\n|SSH Version Exchange (peeked at following initial accept)|||\n\n|Fake SSH Handshake (Malware -> C2)|Col2|Col3|\n|---|---|---|\n|0x0000|53 53 48 2d 32 2e 30 2d 44 38 70 6a 45 0d 0a|SSH-2.0-D8pjE..|\n|SSH Version Exchange|||\n\n|Fake SSH Handshake (Malware -> C2)|Col2|Col3|\n|---|---|---|\n|0x0000 0x0010 0x0020 0x0030 0x0040 0x0050 0x0060 0x0070 0x0080 0x0090 0x00a0 0x00b0 0x00c0 0x00d0 0x00e0 0x00f0 0x0100 0x0110 0x0120 0x0130 0x0140 0x0150 0x0160 0x0170 0x0180 0x0190 0x01a0 0x01b0|00 00 05 4c 0a 14 fd 8d cf 7b 16 6d de 60 6f f4 1c 19 89 c1 93 ee 00 00 00 80 63 75 72 76 65 32 35 35 31 39 2d 73 68 61 32 35 36 40 6c 69 62 73 73 68 2e 6f 72 67 2c 64 69 66 66 69 65 2d 68 65 6c 6c 6d 61 6e 2d 67 72 6f 75 70 2d 65 78 63 68 61 6e 67 65 2d 73 68 61 32 35 36 2c 64 69 66 66 69 65 2d 68 65 6c 6c 6d 61 6e 2d 67 72 6f 75 70 2d 65 78 63 68 61 6e 67 65 2d 73 68 61 31 2c 64 69 66 66 69 65 2d 68 65 6c 6c 6d 61 6e 2d 67 72 6f 75 70 31 34 2d 73 68 61 31 00 00 00 13 73 73 68 2d 72 73 61 2c 73 73 68 2d 65 64 32 35 35 31 39 00 00 00 bb 63 68 61 63 68 61 32 30 2d 70 6f 6c 79 31 33 30 35 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 61 65 73 31 32 38 2d 63 74 72 2c 61 65 73 31 39 32 2d 63 74 72 2c 61 65 73 32 35 36 2d 63 74 72 2c 61 72 63 66 6f 75 72 32 35 36 2c 61 72 63 66 6f 75 72 31 32 38 2c 61 65 73 31 32 38 2d 63 62 63 2c 33 64 65 73 2d 63 62 63 2c 62 6c 6f 77 66 69 73 68 2d 63 62 63 2c 63 61 73 74 31 32 38 2d 63 62 63 2c 61 65 73 31 39 32 2d 63 62 63 2c 61 65 73 32 35 36 2d 63 62 63 2c 61 72 63 66 6f 75 72 2c 72 69 6a 6e 64 61 65 6c 2d 63 62 63 40 6c 79 73 61 74 6f 72 2e 6c 69 75 2e 73 65 00 00 00 bb 63 68 61 63 68 61 32 30 2d 70 6f 6c 79 31 33 30 35 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 61 65 73 31 32 38 2d 63 74 72 2c 61 65 73 31 39 32 2d 63 74 72 2c 61 65 73 32 35 36 2d 63 74 72 2c 61 72 63 66 6f 75 72 32 35 36 2c 61 72|...L..ý.Ï{.mÞ`oô ...Á.î....curve2 5519-sha256@libs sh.org,diffie-he llman-group-exch ange-sha256,diff ie-hellman-group -exchange-sha1,d iffie-hellman-gr oup14-sha1....ss h-rsa,ssh-ed2551 9...»chacha20-po ly1305@openssh.c om,aes128-ctr,ae s192-ctr,aes256- ctr,arcfour256,a rcfour128,aes128 -cbc,3des-cbc,bl owfish-cbc,cast1 28-cbc,aes192-cb c,aes256-cbc,arc four,rijndael-cb c@lysator.liu.se ...»chacha20-pol y1305@openssh.co m,aes128-ctr,aes 192-ctr,aes256-c tr,arcfour256,ar|\n\n\n-----\n\n|0x01c0 0x01d0 0x01e0 0x01f0 0x0200 0x0210 0x0220 0x0230 0x0240 0x0250 0x0260 0x0270 0x0280 0x0290 0x02a0 0x02b0 0x02c0 0x02d0 0x02e0 0x02f0 0x0300 0x0310 0x0320 0x0330 0x0340 0x0350 0x0360 0x0370 0x0380 0x0390 0x03a0 0x03b0 0x03c0 0x03d0 0x03e0 0x03f0 0x0400 0x0410 0x0420 0x0430 0x0440 0x0450 0x0460 0x0470 0x0480 0x0490 0x04a0 0x04b0 0x04c0 0x04d0 0x04e0 0x04f0 0x0500|63 66 6f 75 72 31 32 38 2c 61 65 73 31 32 38 2d 63 62 63 2c 33 64 65 73 2d 63 62 63 2c 62 6c 6f 77 66 69 73 68 2d 63 62 63 2c 63 61 73 74 31 32 38 2d 63 62 63 2c 61 65 73 31 39 32 2d 63 62 63 2c 61 65 73 32 35 36 2d 63 62 63 2c 61 72 63 66 6f 75 72 2c 72 69 6a 6e 64 61 65 6c 2d 63 62 63 40 6c 79 73 61 74 6f 72 2e 6c 69 75 2e 73 65 00 00 01 68 75 6d 61 63 2d 36 34 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 75 6d 61 63 2d 31 32 38 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 73 68 61 32 2d 32 35 36 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 73 68 61 32 2d 35 31 32 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 73 68 61 31 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 75 6d 61 63 2d 36 34 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 75 6d 61 63 2d 31 32 38 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 73 68 61 32 2d 32 35 36 2c 68 6d 61 63 2d 73 68 61 32 2d 35 31 32 2c 68 6d 61 63 2d 73 68 61 31 2c 68 6d 61 63 2d 6d 64 35 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 72 69 70 65 6d 64 31 36 30 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 6d 64 35 2d 39 36 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 6d 64 35 2c 68 6d 61 63 2d 72 69 70 65 6d 64 31 36 30 2c 68 6d 61 63 2d 72 69 70 65 6d 64 31 36 30 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 6d 64 35 2d 39 36 00 00 01 68 75 6d 61 63 2d 36 34 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 75 6d 61 63 2d 31 32 38 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 73 68 61 32 2d 32 35 36 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 73 68 61 32 2d 35 31 32 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 73 68 61 31 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 75 6d 61 63 2d 36 34 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 75 6d 61 63 2d 31 32 38 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 73 68 61 32 2d 32 35 36 2c 68 6d 61 63 2d 73 68 61 32 2d 35 31 32 2c 68 6d 61 63 2d 73 68 61 31 2c 68 6d 61 63 2d 6d 64 35 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 72 69 70 65 6d 64 31 36 30 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 6d 64 35 2d 39 36 2d 65 74 6d 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 6d 64 35 2c 68 6d 61 63 2d 72 69 70 65 6d 64 31 36 30 2c 68 6d 61 63 2d 72 69 70 65 6d 64 31 36 30 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 2c 68 6d 61 63 2d 6d 64 35 2d 39 36 00 00 00 15 6e 6f 6e 65 2c|cfour128,aes128- cbc,3des-cbc,blo wfish-cbc,cast12 8-cbc,aes192-cbc ,aes256-cbc,arcf our,rijndael-cbc @lysator.liu.se. ..humac-64-etm@o penssh.com,umac- 128-etm@openssh. com,hmac-sha2-25 6-etm@openssh.co m,hmac-sha2-512- etm@openssh.com, hmac-sha1-etm@op enssh.com,umac-6 4@openssh.com,um ac-128@openssh.c om,hmac-sha2-256 ,hmac-sha2-512,h mac-sha1,hmac-md 5-etm@openssh.co m,hmac-ripemd160 -etm@openssh.com ,hmac-md5-96-etm @openssh.com,hma c-md5,hmac-ripem d160,hmac-ripemd 160@openssh.com, hmac-md5-96...hu mac-64-etm@opens sh.com,umac-128- etm@openssh.com, hmac-sha2-256-et m@openssh.com,hm ac-sha2-512-etm@ openssh.com,hmac -sha1-etm@openss h.com,umac-64@op enssh.com,umac-1 28@openssh.com,h mac-sha2-256,hma c-sha2-512,hmac- sha1,hmac-md5-et m@openssh.com,hm ac-ripemd160-etm @openssh.com,hma c-md5-96-etm@ope nssh.com,hmac-md 5,hmac-ripemd160 ,hmac-ripemd160@ openssh.com,hmac -md5-96....none,|\n|---|---|---|\n\n\n-----\n\n|0x0510 0x0520 0x0530 0x0540|7a 6c 69 62 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 00 00 00 15 6e 6f 6e 65 2c 7a 6c 69 62 40 6f 70 65 6e 73 73 68 2e 63 6f 6d 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00|zlib@openssh.com ....none,zlib@op enssh.com....... ................|\n|---|---|---|\n|SSH Key Exchange Init|||\n\n|Fake SSH Handshake (C2 -> Malware)|Col2|\n|---|---|\n|0x0000|?? * 0x490|\n|SSH Key Exchange Init (Contents ignored by Pygmy Goat)||\n\n|Fake SSH Handshake (C2 -> Malware)|Col2|\n|---|---|\n|0x0000|?? * 0x30|\n|SSH Key Exchange||\n\n```\n 0x0000 00 00 00 bc 08 1f 00 00 00 33 00 00 00 0b 73 73 ...¼.....3....ss\n 0x0010 68 2d 65 64 32 35 35 31 39 00 00 00 20 3d 5f 84 h-ed25519... =_.\n 0x0020 8d 6b d8 10 08 e4 91 22 7b 94 28 65 e0 e0 7a 76 .kØ..ä.\"{.(eààzv\n 0x0030 83 3d 74 de 60 bf b7 4b 39 21 1d 99 1e 00 00 00 .=tÞ`¿·K9!......\n 0x0040 20 52 91 ba 65 28 66 56 d4 cd 7d 06 c0 6d 06 e8  R.ºe(fVÔÍ}.Àm.è\n 0x0050 88 01 8f 3e 3a 9a 1f 3f 1c f4 84 e6 57 39 75 f8 ...>:..?.ô.æW9uø\n 0x0060 1b 00 00 00 53 00 00 00 0b 73 73 68 2d 65 64 32 ....S....ssh-ed2\n 0x0070 35 35 31 39 00 00 00 40 29 cc f0 cc 16 c5 46 6e 5519...@)ÌðÌ.ÅFn\n 0x0080 52 19 82 8e 86 65 42 8c 1f 1a d4 c3 a5 b1 cb fc R....eB...ÔÃ¥±Ëü\n 0x0090 c0 26 6c 31 3c 5c 90 3a 24 7d e4 d3 57 6d da 8e À&l1<\\.:$}äÓWmÚ.\n 0x00a0 cb f4 66 d1 cb 81 4f 63 fd 4a fa 06 e4 7e 4c a0 ËôfÑË.OcýJú.ä~L \n 0x00b0 95 91 bd cb 97 a4 b3 0f 00 00 00 00 00 00 00 00 ..½Ë.¤³.........\n 0x00c0 00 00 00 0c 0a 15 00 00 00 00 00 00 00 00 00 00 ................\n               SSH Key Exchange\n\n```\n**Fake SSH Handshake (C2 -> Malware)**\n```\n 0x0000 ?? * 0x10\n                SSH New Keys\n\n```\nAfter the fake SSH handshake is complete, Pygmy Goat continues to establish\na legitimate TLS handshake over the fake SSH TCP connection, following the\nsame path as with the ICMP connect-back.\n\n|Fake SSH Handshake (Malware -> C2)|Col2|Col3|\n|---|---|---|\n|0x0000 0x0010 0x0020 0x0030 0x0040 0x0050 0x0060 0x0070 0x0080 0x0090 0x00a0 0x00b0 0x00c0|00 00 00 bc 08 1f 00 00 00 33 00 00 00 0b 73 73 68 2d 65 64 32 35 35 31 39 00 00 00 20 3d 5f 84 8d 6b d8 10 08 e4 91 22 7b 94 28 65 e0 e0 7a 76 83 3d 74 de 60 bf b7 4b 39 21 1d 99 1e 00 00 00 20 52 91 ba 65 28 66 56 d4 cd 7d 06 c0 6d 06 e8 88 01 8f 3e 3a 9a 1f 3f 1c f4 84 e6 57 39 75 f8 1b 00 00 00 53 00 00 00 0b 73 73 68 2d 65 64 32 35 35 31 39 00 00 00 40 29 cc f0 cc 16 c5 46 6e 52 19 82 8e 86 65 42 8c 1f 1a d4 c3 a5 b1 cb fc c0 26 6c 31 3c 5c 90 3a 24 7d e4 d3 57 6d da 8e cb f4 66 d1 cb 81 4f 63 fd 4a fa 06 e4 7e 4c a0 95 91 bd cb 97 a4 b3 0f 00 00 00 00 00 00 00 00 00 00 00 0c 0a 15 00 00 00 00 00 00 00 00 00 00|...¼.....3....ss h-ed25519... =_. .kØ..ä.\"{.(eààzv .=tÞ`¿·K9!...... R.ºe(fVÔÍ}.Àm.è ...>:..?.ô.æW9uø ....S....ssh-ed2 5519...@)ÌðÌ.ÅFn R....eB...ÔÃ¥±Ëü À&l1<\\.:$}äÓWmÚ. ËôfÑË.OcýJú.ä~L ..½Ë.¤³......... ................|\n|SSH Key Exchange|||\n\n|Fake SSH Handshake (C2 -> Malware)|Col2|\n|---|---|\n|0x0000|?? * 0x10|\n|SSH New Keys||\n\n\n-----\n\n_This is somewhat odd as TLS handshakes are typically initiated by the TCP_\n_client, whereas in this case Pygmy Goat is the TCP server but establishes the_\n_TLS handshake as though it was the client; i.e, sending the Client Hello,_\n_followed by the TCP client sending the Server Hello._\n\n\n-----\n\n**C2 Tasking**\nRegardless of which mechanism was used to establish the TLS connection to\nthe C2 server, subsequent data sent from the server to Pygmy Goat follows the\nsame code path.\n\nData sent over the C2 TLS channel in either direction consists of a command\nbyte, an identifier byte, a subcommand byte, and a two-byte big-endian\nlength, followed by an optional LZO1X compressed data section. The identifier\nbyte is unused for simple request-response commands, and the value sent by\nthe server is simply echoed back in the response, however for long running\n\ncommands it is used to specify which instance of a previous command to\ninteract with, e.g, to stop a previously started packet capture. The first\ncommand packet received by Pygmy Goat following the TLS handshake is\nexpected to be another handshake containing a sequence of expected magic\nbytes:\n\n_All example command packets are with TLS stripped and the LZO1X data_\n_decompressed, to make the data legible. For small packets of data the LZO1X_\n_algorithm increases the length after ‘compression’ due to a header, hence the_\n\n_length being greater than the length of the uncompressed bytes in some_\n_cases. Unless otherwise stated as ‘LE’ (Little Endian), all numeric values are_\n_transmitted as Big Endian values._\n\n**Pygmy Goat Handshake (C2 -> Malware)**\n```\n 0x0000 63 00 01 00 0c 2c 62 45 42 33 3f 3d 6f c....,bEB3?=o\n Command (Handshake) Identifier Subcommand (Request)\n  Compressed Length Magic Bytes\n\n```\n**Pygmy Goat Handshake (Malware -> C2)**\n```\n 0x0000 63 00 01 00 00 c....\n Command (Handshake) Identifier Subcommand (Response)\n               Compressed Length\n\n```\nFollowing the handshake, Pygmy Goat will start processing subsequent\npackets as commands.\n\n|Pygmy Goat Handshake (C2 -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|63 00 01 00 0c 2c 62 45 42 33 3f 3d 6f|||c....,bEB3?=o|\n|Command (Handshake)||Identifier|Subcommand (Request)||\n|Compressed Length||Magic Bytes|||\n\n|Pygmy Goat Handshake (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|63 00 01 00 00|||c....|\n|Command (Handshake)||Identifier|Subcommand (Response)||\n|Compressed Length|||||\n\n\n-----\n\n_0x01 DateTime_\nPygmy Goat responds with the current date and time, formatted with the ctime\nC function.\n\n**DateTime request (C2 -> Malware)**\n```\n 0x0000 01 00 01 00 00 .....\n  Command (DateTime) Identifier Subcommand (Request)\n               Compressed Length\n\n```\n**DateTime response (Malware -> C2)**\n```\n 0x0000 01 00 06 00 23 54 75 65 20 4d 61 72 20 31 34 20  ....#Tue Mar 14 \n 0x0010 31 32 3a 33 37 3a 33 33 20 32 30 32 34 20 28 44 12:37:33 2024 (D\n 0x0020 41 54 45 29 ATE)\n  Command (DateTime) Identifier Subcommand (Response)\n  Compressed Length Formatted date time\n\n```\n_0x02 Details_\nPygmy Goat responds with the victim system details from the uname C function.\n\n|DateTime request (C2 -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|01 00 01 00 00|||.....|\n|Command (DateTime)||Identifier|Subcommand (Request)||\n|Compressed Length|||||\n\n|DateTime response (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000 0x0010 0x0020|01 00 06 00 23 54 75 65 20 4d 61 72 20 31 34 20 31 32 3a 33 37 3a 33 33 20 32 30 32 34 20 28 44 41 54 45 29|||....#Tue Mar 14 12:37:33 2024 (D ATE)|\n|Command (DateTime)||Identifier|Subcommand (Response)||\n|Compressed Length||Formatted date time|||\n\n|Details request (C2 -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|02 00 01 00 00|||.....|\n|Command (Details)||Identifier|Subcommand (Request)||\n|Compressed Length|||||\n\n|Details response (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000 0x0010 0x0020 0x0030 0x0040 0x0050 0x0060 0x0070 0x0080|02 00 06 00 8d 53 79 73 6e 61 6d 65 3a 20 20 4c 69 6e 75 78 0a 4e 6f 64 65 6e 61 6d 65 3a 20 75 62 75 6e 74 75 0a 52 65 6c 65 61 73 65 3a 20 20 34 2e 31 30 2e 30 2d 32 38 2d 67 65 6e 65 72 69 63 0a 56 65 72 73 69 6f 6e 3a 20 20 23 33 32 7e 31 36 2e 30 34 2e 32 2d 55 62 75 6e 74 75 20 53 4d 50 20 54 68 75 20 4a 75 6c 20 32 30 20 31 30 3a 31 39 3a 31 33 20 55 54 43 20 32 30 31 37 0a 4d 61 63 68 69 6e 65 3a 20 20 69 36 38 36|||.....Sysname: L inux.Nodename: u buntu.Release: 4.10.0-28-generi c.Version: #32~ 16.04.2-Ubuntu S MP Thu Jul 20 10 :19:13 UTC 2017. Machine: i686|\n|Command (Details)||Identifier|Subcommand (Response)||\n|Compressed Length||System Details|||\n\n\n-----\n\n_0x03 System Shell_\nPygmy Goat forks a new /bin/sh process using code copied from The Linux\n_Programming Interface[2], passing data to/from the socket to/from the shell_\nchild process. The identifier byte is used to support opening multiple shells at\nonce.\n\n**Shell start request (C2 -> Malware)**\n```\n 0x0000 03 7b 01 00 08 00 04 00 00 .{.......\n  Command (System Identifier (123) Subcommand (Start)\n     Shell)\n  Compressed Length Buffer window size (1024, LE)\n\n```\n**Shell start response (Malware -> C2)**\n```\n 0x0000 03 7b 02 00 00 .{...\n  Command (System Identifier Subcommand (Started)\n     Shell)\n               Compressed Length\n\n```\n**Shell output (Malware -> C2)**\n```\n 0x0000 03 7b 03 00 06 23 20 .{...#\n Command (System Shell) Identifier Subcommand (IO)\n  Compressed Length Shell output (‘# ’)\n\n```\n**Shell input (C2 -> Malware)**\n```\n 0x0000 03 7b 03 00 08 70 77 64 0a .{...pwd.\n  Command (System Identifier Subcommand (IO)\n     Shell)\n  Compressed Length Shell input (‘pwd\\n’)\n\n```\n2 https[:]//man7[.]org/tlpi/code/online/dist/pty/pty_fork.c.html\n\n|Shell start request (C2 -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|03 7b 01 00 08 00 04 00 00|||.{.......|\n|Command (System Shell)||Identifier (123)|Subcommand (Start)||\n|Compressed Length||Buffer window size (1024, LE)|||\n\n|Shell start response (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|03 7b 02 00 00|||.{...|\n|Command (System Shell)||Identifier|Subcommand (Started)||\n|Compressed Length|||||\n\n|Shell output (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|03 7b 03 00 06 23 20|||.{...#|\n|Command (System Shell)||Identifier|Subcommand (IO)||\n|Compressed Length||Shell output (‘# ’)|||\n\n|Shell input (C2 -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|03 7b 03 00 08 70 77 64 0a|||.{...pwd.|\n|Command (System Shell)||Identifier|Subcommand (IO)||\n|Compressed Length||Shell input (‘pwd\\n’)|||\n\n\n-----\n\n|Shell output (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000 0x0010 0x0020|03 7b 03 00 21 70 77 64 0d 0a 2f 68 6f 6d 65 2f 75 73 65 72 2f 6c 69 62 73 6f 70 68 6f 73 0d 0a 23 20|||.{...pwd../home/ user/libsophos.. #|\n|Command (System Shell)||Identifier|Subcommand (IO)||\n|Compressed Length||Shell output (‘pwd\\r\\n/home/user/libsophos\\r\\n# ’)|||\n\n|Shell stop request (C2 -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|03 7b 05 00 00|||.{...|\n|Command (System Shell)||Identifier|Subcommand (Stop)||\n|Compressed Length|||||\n\n|Shell stop response (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|03 7b 06 00 00|||.{...|\n|Command (System Shell)||Identifier|Subcommand (Stopped)||\n|Compressed Length|||||\n\n\n_0x04 CLI Shell_\nPygmy Goat forks a new /bin/csh process, and otherwise operates in the same\nmanner as the System Shell command including the command packets and\n\ncontrol flow, with the sole exception of the Command byte being 0x04 instead\nof 0x03; as such, example packets have not been included.\n\n\n-----\n\n_0x05 Crontab_\nPygmy Goat forks a new execution of crontab using the statically compiled\nembedded BusyBox instance, otherwise operating similarly to the previous two\ncommands. This provides the actor with an interactive instance of crontab,\nenabling them to create scheduled tasks on the victim device to execute\nwhen the actor isn’t actively interacting with the system.\n\n**Crontab CLI start request (C2 -> Malware)**\n```\n 0x0000 05 7b 01 00 08 00 04 00 00 00 00 00 00 2d 6c .{...........-l\n Command (Crontab CLI) Identifier Subcommand (Start)\n  Compressed Length Buffer window size Unused\n                  (LE)\n  Additional args to crontab (e.g, -l to list tasks, -e to edit\n                crontab file)\n\n```\n**Crontab CLI start response (Malware -> C2)**\n```\n 0x0000 05 7b 02 00 00 .{...\n Command (Crontab CLI) Identifier Subcommand (Started)\n               Compressed Length\n\n```\n**Crontab CLI output (Malware -> C2)**\n```\n 0x0000 05 7b 03 00 21 33 30 20 2a 20 2a 20 2a 20 2a 20 .{..!30 * * * * \n 0x0010 65 63 68 6f 20 70 77 6e 64 20 3e 20 2f 68 6f 6d echo pwnd > /hom\n 0x0020 65 2f 75 73 65 72 2f 70 77 6e 64 0d 0a e/user/pwnd..\n Command (Crontab CLI) Identifier Subcommand (IO)\n  Compressed Length CLI output\n\n```\n**Crontab CLI stopped (Malware -> C2)**\n```\n 0x0000 05 7b 06 00 00 .{...\n Command (Crontab CLI) Identifier Subcommand (Stopped)\n               Compressed Length\n\n```\nNote, the ‘Stopped’ message from the malware is sent automatically when the\nchild crontab process exits. In the above example, the C2 server sent the ‘-l’\nargument which causes crontab to list the current cron tasks and then exit;\nhence the ‘IO’ subcommand containing the standard output, followed by the\nStopped ‘subcommand’.\n\n|Crontab CLI start request (C2 -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|05 7b 01 00 08 00 04 00 00 00 00 00 00 2d 6c|||.{...........-l|\n|Command (Crontab CLI)||Identifier|Subcommand (Start)||\n|Compressed Length||Buffer window size (LE)|Unused||\n|Additional args to crontab (e.g, -l to list tasks, -e to edit crontab file)|||||\n\n|Crontab CLI start response (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|05 7b 02 00 00|||.{...|\n|Command (Crontab CLI)||Identifier|Subcommand (Started)||\n|Compressed Length|||||\n\n|Crontab CLI output (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000 0x0010 0x0020|05 7b 03 00 21 33 30 20 2a 20 2a 20 2a 20 2a 20 65 63 68 6f 20 70 77 6e 64 20 3e 20 2f 68 6f 6d 65 2f 75 73 65 72 2f 70 77 6e 64 0d 0a|||.{..!30 * * * * echo pwnd > /hom e/user/pwnd..|\n|Command (Crontab CLI)||Identifier|Subcommand (IO)||\n|Compressed Length||CLI output|||\n\n|Crontab CLI stopped (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|05 7b 06 00 00|||.{...|\n|Command (Crontab CLI)||Identifier|Subcommand (Stopped)||\n|Compressed Length|||||\n\n\n-----\n\n_0x06 Packet Capture_\nPygmy Goat uses the libpcap library to start capturing traffic on the specified\ninterface according to the specified filter string until a subsequent command\nis sent to tell it to stop.\n\n|Packet capture start request (C2 -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000 0x0010|06 7b 01 00 11 00 05 00 04 65 6e 73 33 33 69 63 6d 70|||.{.......ens33ic mp|\n|Command (Packet Capture)||Identifier|Subcommand (Start)||\n|Compressed Length||Interface name length|Filter string length||\n|Interface name||Filter string|||\n\n|Packet capture start response (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000 0x0010|06 7b 02 00 1c d4 c3 b2 a1 02 00 04 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00|||.{...ÔÃ²¡....... .............|\n|Command (Packet Capture)||Identifier|Subcommand (Started)||\n|Compressed Length||Capture metadata, including link type|||\n\n|Packet capture data (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|06 7b 03 00 5d bb 08 10 ... 67 68 69|||.{..]»...ghi|\n|Command (Packet Capture)||Identifier|Subcommand (Packet)||\n|Compressed Length||Single pcap frame|||\n\n|Packet capture stop request (C2 -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|06 7b 05 00 00|||.{...|\n|Command (System Shell)||Identifier|Subcommand (Stop)||\n|Compressed Length|||||\n\n|Packet capture response (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|06 7b 06 00 00|||.{...|\n|Command (System Shell)||Identifier|Subcommand (Stopped)||\n|Compressed Length|||||\n\n\n-----\n\n_0x07 EarthWorm Reverse Socks Proxy_\n\nPygmy Goat reads a new hostname/IP address and TCP port from the\ncompressed data, and then calls through to a copied version of the\nEarthWorm[3] source code, into the create_rssocks_server function[4], passing the\naddress, port, and hardcoded timeout of 10 seconds.\n\nEarthWorm is an open-source network tunnelling tool designed for offensive\ncapabilities, in particular offering a reverse SOCKS5 proxy server to enable\npenetration through firewalls. While EarthWorm isn’t directly malicious, it has\n\nbeen used by threat actors previously, as noted in reporting by Mandiant[5] and\nCrowdStrike[6]. The original developer has since taken down the source code\nfrom their github page, although it remains available in mirrored repositories[7].\n\n3 https[:]//rootkiter[.]com/EarthWorm/en/index.html\n\n4 https[:]//github[.]com/anhilo/xiaogongju/blob/master/rssocks_pro.c#L3\n\n5 https[:[//www.mandiant[.]com/resources/blog/pst-want-shell-proxyshell-exploiting\nmicrosoft-exchange-servers\n\n6 https[:]//www.crowdstrike[.]com/blog/overwatch-insights-reviewing-a-new-intrusion\ntargeting-mac-systems/\n\n7 https[:]//github[.]com/anhilo/xiaogongju/\n\n\n-----\n\n|Reverse proxy start request (C2 -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000 0x0010 0x0020 0x0030 0x0040 0x0050 0x0060 0x0070 0x0080 0x0090 0x00a0 0x00b0 0x00c0 0x00d0 0x00e0 0x00f0 0x0100|07 7b 01 00 27 65 78 61 6d 70 6c 65 2e 63 6f 6d 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 22 b8|||.{...example.com ................ ................ ................ ................ ................ ................ ................ ................ ................ ................ ................ ................ ................ ................ ................ ..... \"¸|\n|Command (Proxy)||Identifier|Subcommand (Start)||\n|Compressed Length||EarthWorm server address (256 bytes null padded)|EarthWorm server TCP port (8888)||\n\n|Reverse proxy start response (Malware -> C2)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|07 7b 02 00 00|||.{...|\n|Command (Proxy)||Identifier|Subcommand (Started)||\n|Compressed Length|||||\n\n\nIn a forked process, Pygmy Goat then establishes a new TCP connection to the\naddress and port contained in the start request data.\n\nWhilst the channel used to request that Pygmy Goat create a reverse SOCKS\nproxy is TLS-encrypted, the EarthWorm channel itself is not, and as such\n\nsubsequent packet examples are raw TCP.\n\n|EarthWorm Client Request (Malware -> EarthWorm Server)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|01 01 00 00 00 00|||......|\n|Type (Handshake)||Subtype (Request)|Pool Number||\n\n\n-----\n\n|EarthWorm Server Response (EarthWorm Server -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|01 02 00 00 00 00|||......|\n|Type (Handshake)||Subtype (Response)|Pool Number||\n\n|EarthWorm Assign Pool Number (EarthWorm Server -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|01 03 00 00 04 d2|||.....Ò|\n|Type (Handshake)||Subtype (Assign Pool Num)|Pool Number||\n\n\n_Pool numbers are used so a single EarthWorm server can distinguish between_\n_multiple clients._\n\nPygmy Goat then establishes a new TCP connection to the EarthWorm server,\nthis time using the Pool Number it’s just been assigned, to request a remote\ntunnel.\n\n**EarthWorm Request Remote Tunnel (Malware -> EarthWorm Server)**\n```\n 0x0000 01 04 00 00 04 d2 .....Ò\n  Type (Handshake) Subtype (Tunnel Pool Number\n                 Request)\n\n```\n**EarthWorm Remote Tunnel Created (EarthWorm Server -> Malware)**\n```\n 0x0000 01 05 00 00 04 d2 .....Ò\n  Type (Handshake) Subtype (Tunnel Pool Number\n                 Response)\n\n```\nAt this point the EarthWorm server creates a new locally listening port, which a\nSOCKS5 client can connect into. All raw data sent through the locally listening\nport is tunnelled directly through to Pygmy Goat, which behaves as a SOCKS5\nserver, enabling the actor to send SOCKS traffic from their local end, through\nthe firewall device and beyond.\n\nOf note with EarthWorm, regardless of which authentication methods the\nSOCKS5 client states it supports, the EarthWorm SOCKS5 server running in\nPygmy Goat will always choose ‘No Authentication’. EarthWorm also only\n\n|EarthWorm Request Remote Tunnel (Malware -> EarthWorm Server)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|01 04 00 00 04 d2|||.....Ò|\n|Type (Handshake)||Subtype (Tunnel Request)|Pool Number||\n\n|EarthWorm Remote Tunnel Created (EarthWorm Server -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|01 05 00 00 04 d2|||.....Ò|\n|Type (Handshake)||Subtype (Tunnel Response)|Pool Number||\n\n\n-----\n\nsupports the remote address being specified as IPv4, and finally, after\nestablishing the remote connection to the IPv4 address and port specified by\nthe SOCKS5 client, the server will respond stating that its local bind address\nand port is \\x41\\x41\\x41\\x41 and \\x41\\x41:\n\n|Proxied Curl Request, Client Greeting (Curl -> EW Server -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|05 02 00 02|||....|\n|SOCKS Version||Num Auth|No auth & User/Pass||\n\n|Proxied Curl Request, Server Choice (Malware -> EW Server -> Curl)|Col2|Col3|Col4|\n|---|---|---|---|\n|0x0000|05 00||..|\n|SOCKS Version||Auth choice (No auth)||\n\n|Proxied Curl Request, Client Connection Request (Curl -> EW Server -> Malware)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|05 01 00 01 c0 a8 06 01 1a 0a|||....À¨....|\n|SOCKS Version||Establish TCP Connect|Reserved||\n|Address Type (IPv4)||Packed IPv4 Address|TCP port||\n\n|Proxied Curl Request, Server Response (Malware -> EW Server -> Curl)|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|0x0000|05 00 00 01 41 41 41 41 41 41|||.....AAAAAA|\n|SOCKS Version||Request Granted|Reserved||\n|Address Type (IPv4)||Packed IPv4 Bind Address|TCP bind port||\n\n\n-----\n\n**Example Network Diagram**\nIn the below example, the actor uses the ICMP wakeup method to establish a\nTLS connection to the IP and port inside the encrypted ICMP packet data.\nPygmy Goat establishes a TCP & TLS connection to the C2 server, verifying the\nC2 server’s TLS certificate against the embedded CA cert. The C2 server\nperforms the Pygmy Goat handshake, followed by a task: to establish a reverse\nSOCKS5 EarthWorm connection with the IP and port inside the task data. After\nestablishing the reverse tunnel, a SOCKS5 client can connect into the\nEarthWorm server on a newly opened port to send tunnelled data which will\nultimately come out of the victim’s network interface.\n\nSOCKS5 Client\n\nVictim Wakeup Server C2 Server EarthWorm Server\n\n\nC2 Server EarthWorm Server\n\n\nEarthWorm assign Pool Number\n\n\nSOCKS5 Client\n\n\nVictim\n\n\n-----\n\n#### Conclusion\n\nWhile not containing any novel techniques, Pygmy Goat is quite sophisticated\nin how it enables the actor to interact with it on demand, while blending in with\nnormal network traffic. The code itself is clean, with short, well-structured\nfunctions aiding future extensibility, and errors are checked throughout,\nsuggesting it was written by a competent developer or developers.\n\nAlthough Pygmy Goat has so far only been seen on Sophos XG Firewalls,\ndesign choices suggest that it could be intended for use on an array of Linux\n\ndevices rather than specifically targeted. The malware has multiple methods\nof comms wake-up, as well as two separate remote shells, /bin/sh and\n```\n/bin/csh, which would likely be considered unnecessary effort if the malware\n\n```\nhad been developed for a specific device. Pygmy Goat does not rely on any\ndevice-specific external libraries and will run on a base Ubuntu distribution.\n\nIn particular, the embedded Root CA Certificate, which claims to have been\nissued by ‘FortiGate, Fortinet Ltd.’, as well as one of the IPC Unix sockets having\nthe filename ‘.fgmon_cli.ipc’, suggests that Pygmy Goat may have initially\nbeen intended to execute on FortiGate devices. Recent reporting from\n\nMandiant shows attacks on FortiGate devices, with CASTLETAP having similar\nTTPs to Pygmy Goat, such as an encrypted ICMP packet containing C2\ninformation being used to establish a reverse SSL connection[8].\n\n8 https[:]//www.mandiant[.]com/resources/blog/fortinet-malware-ecosystem\n\n\n-----\n\n#### Detection\n\n**Indicators of compromise**\n\n**Type** **Description**\n\nPath Copied malware path\n\nPath IPC Unix server socket\n\nPath IPC Unix client socket\n\nPath IPC Unix server socket from older sample\n\nPath Single instance pid file\n\nPath Single instance pid file from older sample\n\n**Rules and signatures**\n\n|Type|Description|Values|\n|---|---|---|\n|Path|Copied malware path|/lib/libsophos.so|\n|Path|IPC Unix server socket|/tmp/.sshd.ipc|\n|Path|IPC Unix client socket|/tmp/.fgmon_cli.ipc|\n|Path|IPC Unix server socket from older sample|/tmp/.goat.ipc|\n|Path|Single instance pid file|/var/run/sshdd.pid|\n|Path|Single instance pid file from older sample|/var/run/goat.pid|\n\n|Description|Pygmy Goat AES key built on the stack or in data|\n|---|---|\n|Precision|No false positives in VirusTotal retro hunt over the previous 12 months|\n|Rule type|YARA|\n|rule pygmy_goat_aes_key { meta: author = \"NCSC\" description = \"Pygmy Goat AES key built on the stack or in data\" date = \"2024-11-07\" hash1 = \"71f70d61af00542b2e9ad64abd2dda7e437536ff\" strings: $dword_1 = { 59 4b 6e 77 } $dword_2 = { 51 6a 6d 41 } $dword_3 = { 54 62 41 6e } $dword_4 = { 52 6f 5a 6d } $dword_5 = { 30 66 47 37 } $dword_6 = { 55 5a 57 62 } $dword_7 = { 32 59 55 78 } $dword_8 = { 55 51 50 77 } condition: (uint32(0) == 0x464c457f) and filesize < 5MB and all of them }||\n\n\n-----\n\n|Description|Pygmy Goat magic byte sequences used in C2 comms|\n|---|---|\n|Precision|No false positives in VirusTotal retro hunt over the previous 12 months|\n|Rule type|YARA|\n|rule pygmy_goat_magic_strings { meta: author = \"NCSC\" description = \"Pygmy Goat magic byte sequences used in C2 comms\" date = \"2024-10-22\" hash1 = \"71f70d61af00542b2e9ad64abd2dda7e437536ff\" strings: $c2_magic_handshake = \",bEB3?=o\" $fake_ssh_banner = \"SSH-2.0-D8pjE\" $fake_ed25519_key = { 29 cc f0 cc 16 c5 46 6e 52 19 82 8e 86 65 42 8c 1f 1a d4 c3 a5 b1 cb fc c0 26 6c 31 3c 5c 90 3a 24 7d e4 d3 57 6d da 8e cb f4 66 d1 cb 81 4f 63 fd 4a fa 06 e4 7e 4c a0 95 91 bd cb 97 a4 b3 0f } condition: (uint32(0) == 0x464c457f) and any of them }||\n\n\n-----\n\n|Description|EarthWorm pool num generation x86 assembly|\n|---|---|\n|Precision|Signature is looking for use of EarthWorm in an x86 ELF binary, which may include benign uses|\n|Rule type|YARA|\n|rule earthworm_id_generation_x86 { meta: author = \"NCSC\" description = \"EarthWorm pool num generation x86 assembly\" date = \"2024-10-22\" hash1 = \"71f70d61af00542b2e9ad64abd2dda7e437536ff\" strings: $chartoi = { 8b 45 ?? // MOV EAX,dword ptr [EBP + ??] c1 e0 07 // SHL EAX,0x7 89 c1 // MOV ECX,EAX 8b 55 ?? // MOV EDX,dword ptr [EBP + ??] 8b 45 ?? // MOV EAX,dword ptr [EBP + ??] 01 d0 // ADD EAX,EDX 0f b6 00 // MOVZX EAX,byte ptr [EAX] 0f be c0 // MOVSX EAX,AL 01 c8 // ADD EAX,ECX 89 45 ?? // MOV dword ptr [EBP + ??],EAX 83 6d ?? 01 // SUB dword ptr [EBP + ??],0x1 } condition: (uint32(0) == 0x464c457f) and all of them }||\n\n|Description|Pygmy Goat Fake SSH handshake|\n|---|---|\n|Precision|Unknown, presumed high due to fake SSH protocol version|\n|Rule type|Snort v2|\n|alert tcp any 22 -> any any (msg: \"Pygmy Goat Fake SSH handshake\"; content: \"SSH-2.0-D8pjE\"; offset: 0; depth: 13; classtype:trojan- activity;)||\n\n\n-----\n\n|Description|Pygmy Goat Fake SSH ed25519 key|\n|---|---|\n|Precision|Unknown, presumed high due to content length|\n|Rule type|Snort v2|\n|alert tcp any 22 -> any any (msg: \"Pygmy Goat Fake SSH ed25519 key\"; content: \"|29ccf0cc16c5466e5219828e8665428c1f1ad4c3a5b1cbfcc0266c313c5c903a 247de4d3576dda8ecbf466d1cb814f63fd4afa06e47e4ca09591bdcb97a4b30f|\" ; offset: 120; depth: 64; classtype:trojan-activity;)||\n\n\n-----\n\n#### MITRE ATT&CK®\n\nThis report has been compiled with respect to the MITRE ATT&CK® framework, a\nglobally accessible knowledge base of adversary tactics and techniques based\non real-world observations.\n\n|Tactic|ID|Technique|Procedure|\n|---|---|---|---|\n|Persistence|T1574.006|Dynamic Linker Hijacking|Pygmy Goat uses the LD_PRELOAD environment variable to inject into sshd|\n|Execution|T1059.004|Command and Scripting Interpreter: Unix Shell|Pygmy Goat can create a /bin/sh or /bin/csh remote shell|\n||T1053.003|Scheduled Task/Job: Cron|Pygmy Goat can create arbitrary cron tasks using crontab|\n||T1559|Inter-Process Communication|Pygmy Goat uses Unix sockets for inter- process communication between parent and forked child processes|\n|Discovery|T1040|Network Sniffing|Pygmy Goat can use libpcap to sniff network traffic according to a BPF filter and exfiltrate it to the C2|\n|Command and Control|T1205.001|Traffic Signaling: Port Knocking|Pygmy Goat listens on an ICMP raw socket for encrypted packets containing magic bytes and the C2 address to connect back to|\n||T1001.003|Data Obfuscation: Protocol Impersonation|Pygmy Goat responds to an SSH connection that sends magic bytes with a fake SSH handshake|\n||T1573.002|Encrypted Channel: Asymmetric Cryptography|Pygmy Goat encrypts C2 communications with TLS|\n||T1572|Protocol Tunneling|Pygmy Goat can create a reverse SOCKS5 proxy server to tunnel traffic through it|\n|Collection|T1560.002|Archive Collected Data: Archive via Library|Pygmy Goat compresses its C2 communications with LZO1X|\n|Exfiltration|T1041|Exfiltration Over C2 Channel|Pygmy Goat exfiltrates its result data over its C2 channel|\n\n\n-----\n\n#### Appendix\n\n**TLS Root CA Certificate**\n\n```\n-----BEGIN CERTIFICATE----MIIC3zCCAccCFB8e5bk6nwcaR66tdgFt7kh7iw19MA0GCSqGSIb3DQEBCwUAMCwx\nFjAUBgNVBAoMDUZvcnRpbmV0IEx0ZC4xEjAQBgNVBAMMCUZvcnRpR2F0ZTAeFw0y\nMTA4MzEwMTU0NDJaFw0zMTA4MjkwMTU0NDJaMCwxFjAUBgNVBAoMDUZvcnRpbmV0\nIEx0ZC4xEjAQBgNVBAMMCUZvcnRpR2F0ZTCCASIwDQYJKoZIhvcNAQEBBQADggEP\nADCCAQoCggEBAO0UTvHfYvBeIKqKYWV5xfoJW4hsHZbMHSWefuUiYSLDliBDWV8e\n4hBdi6krF8YGGRkKlHPZcfTHzJQmYwBG2mAjEWiIQm3Z0aD4wJjnF/B0VAYDTG29\nVqj+PFU5UsckGeWqTomKOFwutazXiUWicGjzTJErhVj26AgXUPiKO5VHBdHR/xqW\nxJ5ed4L0OOW4c/WYQjUReeiKw2iP3bAtrglXWInJexiWzA/FzsRTbwCUexGmXhwG\n65QsW5t4beDCBHMJN/uP6Q7kIqtDe3/JL8osT0UmGTEcQBx1mkc7Nb6dMgabHPoM\nNWbGLlxRKxb9+H0XGq+effuFMr9CUXb60PcCAwEAATANBgkqhkiG9w0BAQsFAAOC\nAQEAHiZ0DxXlTEykWJxKDcKXhv02TO4C6jhDotr1xYiXha9s+o83h/Q9SFnCL7mP\n1KKB/hRA6/CwXH/P9YUR0OnbPEsUJoQp3jbcXV5m/Xen/Zss+AIwCtLVy20ctPCn\nsvXbPp0lEf69fgByXmL1gB+03dk4QTsy96yrfIPCIXMn7Q3A5LZ2AMBSg/+YJ4xP\nIl+oGhm90WUbr4PgMS+DqTHuf+ghxxHTgbRtLdCvGLA8fu6CcM8rwGae48aE/+gU\nMaavuO9VUiW8eGdouyVZvGhutVpWWYABrslchLpZEF48pEFMk9ChLU9/17Qd1zgQ\nUg/Gkjn036B8ZfA3xdCpTd7ldA==\n-----END CERTIFICATE----\n```\n\n-----\n\n```\nX509 Certificate:\nVersion: 1\nSerial Number: 1f1ee5b93a9f071a47aead76016dee487b8b0d7d\nSignature Algorithm:\n  Algorithm ObjectId: 1.2.840.113549.1.1.11 sha256RSA\n  Algorithm Parameters:\n  05 00\nIssuer:\n  CN=FortiGate\n  O=Fortinet Ltd.\n Name Hash(sha1): b87a11fc647eed1aed3543237cb1540d99ead580\n Name Hash(md5): d45eadb1d50562927512b7f545a02b65\n NotBefore: 8/31/2021 1:54 AM\n NotAfter: 8/29/2031 1:54 AM\nSubject:\n  CN=FortiGate\n  O=Fortinet Ltd.\n Name Hash(sha1): b87a11fc647eed1aed3543237cb1540d99ead580\n Name Hash(md5): d45eadb1d50562927512b7f545a02b65\nPublic Key Algorithm:\n  Algorithm ObjectId: 1.2.840.113549.1.1.1 RSA (RSA_SIGN)\n  Algorithm Parameters:\n  05 00\nPublic Key Length: 2048 bits\nPublic Key: UnusedBits = 0\n  0000 30 82 01 0a 02 82 01 01 00 ed 14 4e f1 df 62 f0\n  0010 5e 20 aa 8a 61 65 79 c5 fa 09 5b 88 6c 1d 96 cc\n  0020 1d 25 9e 7e e5 22 61 22 c3 96 20 43 59 5f 1e e2\n  0030 10 5d 8b a9 2b 17 c6 06 19 19 0a 94 73 d9 71 f4\n  0040 c7 cc 94 26 63 00 46 da 60 23 11 68 88 42 6d d9\n  0050 d1 a0 f8 c0 98 e7 17 f0 74 54 06 03 4c 6d bd 56\n  0060 a8 fe 3c 55 39 52 c7 24 19 e5 aa 4e 89 8a 38 5c\n  0070 2e b5 ac d7 89 45 a2 70 68 f3 4c 91 2b 85 58 f6\n  0080 e8 08 17 50 f8 8a 3b 95 47 05 d1 d1 ff 1a 96 c4\n  0090 9e 5e 77 82 f4 38 e5 b8 73 f5 98 42 35 11 79 e8\n  00a0 8a c3 68 8f dd b0 2d ae 09 57 58 89 c9 7b 18 96\n  00b0 cc 0f c5 ce c4 53 6f 00 94 7b 11 a6 5e 1c 06 eb\n  00c0 94 2c 5b 9b 78 6d e0 c2 04 73 09 37 fb 8f e9 0e\n  00d0 e4 22 ab 43 7b 7f c9 2f ca 2c 4f 45 26 19 31 1c\n  00e0 40 1c 75 9a 47 3b 35 be 9d 32 06 9b 1c fa 0c 35\n  00f0 66 c6 2e 5c 51 2b 16 fd f8 7d 17 1a af 9e 7d fb\n  0100 85 32 bf 42 51 76 fa d0 f7 02 03 01 00 01\nCertificate Extensions: 0\nSignature Algorithm:\n  Algorithm ObjectId: 1.2.840.113549.1.1.11 sha256RSA\n  Algorithm Parameters:\n  05 00\nSignature: UnusedBits=0\n  0000 74 e5 de 4d a9 d0 c5 37 f0 65 7c a0 df f4 39 92\n  0010 c6 0f 52 10 38 d7 1d b4 d7 7f 4f 2d a1 d0 93 4c\n  0020 41 a4 3c 5e 10 59 ba 84 5c c9 ae 01 80 59 56 5a\n  0030 b5 6e 68 bc 59 25 bb 68 67 78 bc 25 52 55 ef b8\n  0040 af a6 31 14 e8 ff 84 c6 e3 9e 66 c0 2b cf 70 82\n  0050 ee 7e 3c b0 18 af d0 2d 6d b4 81 d3 11 c7 21 e8\n  0060 7f ee 31 a9 83 2f 31 e0 83 af 1b 65 d1 bd 19 1a\n  0070 a8 5f 22 4f 8c 27 98 ff 83 52 c0 00 76 b6 e4 c0\n  0080 0d ed 27 73 21 c2 83 7c ab ac f7 32 3b 41 38 d9\n\n```\n\n-----\n\n```\n  0090 dd b4 1f 80 f5 62 5e 72 00 7e bd fe 11 25 9d 3e\n  00a0 db f5 b2 a7 f0 b4 1c 6d cb d5 d2 0a 30 02 f8 2c\n  00b0 9b fd a7 77 fd 66 5e 5d dc 36 de 29 84 26 14 4b\n  00c0 3c db e9 d0 11 85 f5 cf 7f 5c b0 f0 eb 40 14 fe\n  00d0 81 a2 d4 8f b9 2f c2 59 48 3d f4 87 37 8f fa 6c\n  00e0 af 85 97 88 c5 f5 da a2 43 38 ea 02 ee 4c 36 fd\n  00f0 86 97 c2 0d 4a 9c 58 a4 4c 4c e5 15 0f 74 26 1e\nSignature matches Public Key\nRoot Certificate: Subject matches Issuer\nKey Id Hash(rfc-sha1): 241a37a7ac3e26d8d703a8058ffe100dd1150193\nKey Id Hash(sha1): d05ec61f560ec38990760bbb71339e09ebd3a4cc\nKey Id Hash(bcrypt-sha1): 1febcf83a6f6e2598a5288a0e57742d1fc6e7620\nKey Id Hash(bcrypt-sha256):\nefbb9150e66eff1492404ca6bfb219dd656c640814e27cfb3e757ff94fe6aa5a\nKey Id Hash(md5): eae7cc16a30ed5a98916f9f381a5bcb2\nKey Id Hash(sha256):\n8049bd8e86a6b5f382639b0739c78c5fd55780c72d3b5c9a6084e22981f9dc51\nKey Id Hash(pin-sha256): frcO5XKYZ/rwLDKF6EeMNz4MYTQrkNTwd1VPrxMDwSo=\nKey Id Hash(pin-sha256-hex):\n7eb70ee5729867faf02c3285e8478c373e0c61342b90d4f077554faf1303c12a\nCert Hash(md5): e1b9842e7e0b9cf722bcc7d08c768486\nCert Hash(sha1): 8d453ff52947af1842a0231d74ffbb6faacf6167\nCert Hash(sha256):\nf85280bd427aa2e9d714ea3bc11febf5a436cfc04fcbbe708c2592a88b6000a3\nSignature Hash:\nef0ae22901ab9ab07f3b6e1f80ee41cd21deee957e81d7a48fac2517ae5ce87e\n\n```\n\n-----\n\n##### Disclaimer\n\n\nThis report draws on information derived from NCSC and industry\nsources. Any NCSC findings and recommendations made have not been\nprovided with the intention of avoiding all risks and following the\nrecommendations will not remove all such risk. Ownership of information\nrisks remains with the relevant system owner at all times.\n\nThis information is exempt under the Freedom of Information Act 2000\n\n(FOIA) and may be exempt under other UK information legislation.\n\n[Refer any FOIA queries to ncscinfoleg@ncsc.gov.uk.](mailto:ncscinfoleg@ncsc.gov.uk)\n\nAll material is UK Crown Copyright ©\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.ncsc.gov.uk/static-assets/documents/malware-analysis-reports/pygmy-goat/ncsc-mar-pygmy-goat.pdf"
    ],
    "report_names": [
        "ncsc-mar-pygmy-goat.pdf"
    ],
    "threat_actors": [
        {
            "id": "eb3f4e4d-2573-494d-9739-1be5141cf7b2",
            "created_at": "2022-10-25T16:07:24.471018Z",
            "updated_at": "2025-03-27T02:02:10.24394Z",
            "deleted_at": null,
            "main_name": "Cron",
            "aliases": [],
            "source_name": "ETDA:Cron",
            "tools": [
                "Catelites",
                "Catelites Bot",
                "CronBot",
                "TinyZBot"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1731504051,
    "ts_updated_at": 1743041347,
    "ts_creation_date": 1730972882,
    "ts_modification_date": 1730972882,
    "files": {
        "pdf": "https://archive.orkl.eu/9e7d0ed0ee13c063e15d90d82e7a08442c7220f8.pdf",
        "text": "https://archive.orkl.eu/9e7d0ed0ee13c063e15d90d82e7a08442c7220f8.txt",
        "img": "https://archive.orkl.eu/9e7d0ed0ee13c063e15d90d82e7a08442c7220f8.jpg"
    }
}