{
    "id": "1228d0e2-598a-4442-8079-d126dde54f32",
    "created_at": "2023-04-05T02:09:50.606689Z",
    "updated_at": "2025-03-27T02:17:11.38564Z",
    "deleted_at": null,
    "sha1_hash": "7f6fe9cf13652da4881e35ea50f06a0bcbb0ed9d",
    "title": "2023-03-01 - BlackLotus UEFI bootkit- Myth confirmed",
    "authors": "",
    "file_creation_date": "2023-04-03T08:22:10Z",
    "file_modification_date": "2023-04-03T08:22:10Z",
    "file_size": 2230096,
    "plain_text": "# BlackLotus UEFI bootkit: Myth confirmed\n\n**welivesecurity.com/2023/03/01/blacklotus-uefi-bootkit-myth-confirmed/**\n\nThe first in-the-wild UEFI bootkit bypassing UEFI Secure Boot on fully updated UEFI systems is now a reality\n\n[Martin Smolár](https://www.welivesecurity.com/author/msmolar/)\n1 Mar 2023 - 11:30AM\n\nThe first in-the-wild UEFI bootkit bypassing UEFI Secure Boot on fully updated UEFI systems is now a reality\n\n\nMarch 1, 2023\n\n\nThe number of UEFI vulnerabilities discovered in recent years and the failures in patching them or revoking vulnerable binaries within a\nreasonable time window hasn’t gone unnoticed by threat actors. As a result, the first publicly known UEFI bootkit bypassing the essential\nplatform security feature – UEFI Secure Boot – is now a reality. In this blogpost we present the first public analysis of this UEFI bootkit, which\nis capable of running on even fully-up-to-date Windows 11 systems with UEFI Secure Boot enabled. Functionality of the bootkit and its\nindividual features leads us to believe that we are dealing with a bootkit known as BlackLotus, [the UEFI bootkit being sold on hacking forums](https://www.bleepingcomputer.com/news/security/malware-dev-claims-to-sell-new-blacklotus-windows-uefi-bootkit/)\nfor $5,000 since at least October 2022.\n\nUEFI bootkits are very powerful threats, having full control over the OS boot process and thus capable of disabling various OS security\nmechanisms and deploying their own kernel-mode or user-mode payloads in early OS startup stages. This allows them to operate very\nstealthily and with high privileges. So far, only a few have been discovered in the wild and publicly described (e.g., multiple malicious EFI\n[samples we discovered in 2020, or fully featured UEFI bootkits such as our discovery last year – the ESPecter bootkit – or the](https://www.welivesecurity.com/2021/10/05/uefi-threats-moving-esp-introducing-especter-bootkit/) [FinSpy bootkit](https://securelist.com/finspy-unseen-findings/104322/)\ndiscovered by researchers from Kaspersky).\n\n[UEFI bootkits may lose on stealthiness when compared to firmware implants – such as LoJax; the first in-the-wild UEFI firmware implant,](https://www.welivesecurity.com/2018/09/27/lojax-first-uefi-rootkit-found-wild-courtesy-sednit-group/)\ndiscovered by our team in 2018 – as bootkits are located on an easily accessible FAT32 disk partition. However, running as a bootloader\ngives them almost the same capabilities as firmware implants, but without having to overcome the multilevel SPI flash defenses, such as the\nBWE, BLE, and PRx protection bits, or the protections provided by hardware (like Intel Boot Guard). Sure, UEFI Secure Boot stands in the\nway of UEFI bootkits, but there are a non-negligible number of known vulnerabilities that allow bypassing this essential security mechanism.\nAnd the worst of this is that some of them are still easily exploitable on up-to-date systems even at the time of this writing – including the one\nexploited by BlackLotus.\n\nOur investigation started with a few hits on what turned out to be the BlackLotus user-mode component – an HTTP downloader – in our\ntelemetry late in 2022. After an initial assessment, code patterns found in the samples brought us to the discovery of six BlackLotus installers\n(both on VirusTotal and in our own telemetry). This allowed us to explore the whole execution chain and to realize that what we were dealing\nwith here is not just regular malware.\n\nFollowing are the key points about BlackLotus and a timeline summarizing the series of events related to it:\n\nIt’s capable of running on the latest, fully patched Windows 11 systems with UEFI Secure Boot enabled.\n[It exploits a more than one year old vulnerability (CVE-2022-21894) to bypass UEFI Secure Boot and set up persistence for the bootkit.](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-21894)\nThis is the first publicly known, in-the-wild abuse of this vulnerability.\nAlthough the vulnerability was fixed in Microsoft’s January 2022 update, its exploitation is still possible as the affected, validly signed\n[binaries have still not been added to the UEFI revocation list. BlackLotus takes advantage of this, bringing its own copies of legitimate –](https://uefi.org/revocationlistfile)\nbut vulnerable – binaries to the system in order to exploit the vulnerability.\nIt’s capable of disabling OS security mechanisms such as BitLocker, HVCI, and Windows Defender.\nOnce installed, the bootkit’s main goal is to deploy a kernel driver (which, among other things, protects the bootkit from removal), and an\nHTTP downloader responsible for communication with the C&C and capable of loading additional user-mode or kernel-mode payloads.\nBlackLotus has been advertised and sold on underground forums since at least October 6, 2022. In this blogpost, we present evidenceth\nthat the bootkit is real, and the advertisement is not merely a scam.\n\n\n-----\n\nte est g y, so e o t e ac otus sta e s e a e a a y ed do ot p oceed t boot t sta at o t e co p o sed ost uses\none of the following locales:\n\nRomanian (Moldova), ro-MD\nRussian (Moldova), ru-MD\nRussian (Russia), ru-RU\nUkrainian (Ukraine), uk-UA\nBelarusian (Belarus), be-BY\nArmenian (Armenia), hy-AM\nKazakh (Kazakhstan), kk-KZ\n\nThe timeline of individual events related to BlackLotus is shown in Figure 1.\n\n_Figure 1. Timeline of major events related to BlackLotus UEFI bootkit_\n\nAs already mentioned, the bootkit has been sold on underground forums since at least October 6, 2022. At this point, we have not been ableth\nto identify, from our telemetry, the exact distribution channel used to deploy the bootkit to victims. The low number of BlackLotus samples we\nhave been able to obtain, both from public sources and our telemetry, leads us to believe that not many threat actors have started using it yet.\nBut until the revocation of the vulnerable bootloaders that BlackLotus depends on happens, we are concerned that things will change rapidly\nshould this bootkit gets into the hands of the well-known crimeware groups, based on the bootkit’s easy deployment and crimeware groups’\ncapabilities for spreading malware using their botnets.\n\n## Is this really BlackLotus?\n\n[There are several articles or posts summarizing information about BlackLotus (here,](https://www.theregister.com/2022/10/13/blacklotus_malware_kaspersky/) [here and](https://www.linkedin.com/feed/update/urn:li:share:6986711231885713408/) [here and many more…), all based on the](https://www.bleepingcomputer.com/news/security/malware-dev-claims-to-sell-new-blacklotus-windows-uefi-bootkit/)\ninformation provided by the bootkit developer on underground hacking forums. So far, no one has confirmed or disproved these claims.\n\nHere is our summary of the claims from the available publications compared with what we discovered while reverse engineering the bootkit\nsamples:\n\n**BlackLotus’s advertisement on hacking forums claims that it features integrated Secure Boot bypass. Adding vulnerable**\n**drivers to the UEFI revocation list is currently impossible, as the vulnerability affects hundreds of bootloaders that are still**\n**used today. ✅**\n\nTrue: It exploits [CVE-2022-21894 in order to break Secure Boot and achieve persistence on UEFI-Secure-Boot-enabled systems.](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-21894)\n[Vulnerable drivers it uses are still not revoked in the latest dbx, at the time of writing.](https://uefi.org/revocationlistfile)\n**BlackLotus’s advertisement on hacking forums claims that the bootkit has built-in Ring0/Kernel protection against**\n**removal. ✅**\n\nTrue: Its kernel driver protects handles belonging to its files on the EFI System Partition (ESP) against closing. As an additional\nlayer of protection, these handles are continuously monitored and a Blue Screen Of Death (BSOD) triggered if any of these\nhandles are closed, as described in the Protecting bootkit files on the ESP from removal section.\n\n\n-----\n\n**ac** **otus s ad e t se** **e t o** **ac** **g o u** **s c a** **s t at t co** **es** **t** **a t** **tua** **ac** **e (a t** **), a t debug, a d code**\n**obfuscation features to block malware analysis attempts. ✅**\n\nTrue: It contains various anti-VM, anti-debug, and obfuscation techniques to make it harder to replicate or analyze. However, we\nare definitely not talking about any breakthrough or advanced anti-analysis techniques here, as they can be easily overcome with\nlittle effort.\n**BlackLotus’s advertisement on hacking forums claims that its purpose is to act as an HTTP downloader. ✅**\n\nTrue: Its final component acts as an HTTP downloader, as described in the HTTP downloader section\n**BlackLotus’s advertisement on hacking forums claims that the HTTP downloader runs under the SYSTEM account within a**\n**legitimate process. ✅**\n\nTrue: Its HTTP downloader runs within the winlogon.exe process context.\n**BlackLotus’s advertisement on hacking forums claims it is a tiny bootkit with an on-disk size of only 80 kB. ✅**\n\nTrue: Samples we were able to obtain really are around 80 kB.\n\nBased on these facts, we believe with high confidence that the bootkit we discovered in the wild is the BlackLotus UEFI bootkit.\n\n## Attack overview\n\nA simplified scheme of the BlackLotus compromise chain is shown in Figure 2. It consists of three main parts:\n\n1. It starts with the execution of an installer (step 1 in Figure 2), which is responsible for deploying the bootkit’s files to the EFI System\n\npartition, disabling HVCI and BitLocker, and then rebooting the machine.\n[2. After the first reboot, exploitation of CVE-2022-21894 and subsequent enrollment of the attackers’ Machine Owner Key (MOK) occurs,](https://edk2-docs.gitbook.io/understanding-the-uefi-secure-boot-chain/additional_secure_boot_chain_implementations/machine_owner_key_mok)\n\nto achieve persistence even on systems with UEFI Secure Boot enabled. The machine is then rebooted (steps 2–4 in Figure 2) again.\n3. In all subsequent boots, the self-signed UEFI bootkit is executed and deploys both its kernel driver and user-mode payload, the HTTP\n\ndownloader. Together, these components are able to download and execute additional user-mode and driver components from the C&C\nserver and protect the bootkit against removal (steps 5–9 in Figure 2).\n\n\n-----\n\n_Figure 2. BlackLotus simplified execution overview_\n\n## Interesting artifacts\n\nEven though we believe this is the BlackLotus UEFI bootkit, we did not find any reference to this name in the samples we analyzed. Instead,\n[the code is full of references to the Higurashi When They Cry anime series, for example in individual component names, such as](https://en.wikipedia.org/wiki/Higurashi_When_They_Cry)\nhigurashi_installer_uac_module.dll and higurashi_kernel.sys, and also in the self-signed certificate used to sign the bootkit binary (shown in\nFigure 3)\n\n\n-----\n\n_Figure 3. Self-signed certificate used by the BlackLotus bootkit_\n\nAdditionally, the code decrypts but never uses various strings containing messages from the BlackLotus author (as shown in Figure 4 – note,\nthat [hasherezade is a well-known researcher and author of various malware-analysis tools), or just some random quotes from various songs,](https://twitter.com/hasherezade)\ngames, or series.\n\n_Figure 4. Example of messages left in the code by the BlackLotus author_\n\n## Installation process\n\nWe start with analysis of the BlackLotus installers. The bootkit seems to be distributed in a form of installers that come in two versions –\noffline and online. The difference between these two is in the way they obtain legitimate (but vulnerable) Windows binaries, later used for\nbypassing Secure Boot.\n\nIn offline versions, Windows binaries are embedded in the installer\nIn online versions, Windows binaries are downloaded directly from the Microsoft symbol store. So far, we’ve seen the following Windows\nbinaries being abused by the BlackLotus bootkit:\n\nhttps://msdl.microsoft.com/download/symbols/bootmgfw.efi/7144BCD31C0000/bootmgfw.efi\nhttps://msdl.microsoft.com/download/symbols/bootmgr.efi/98B063A61BC000/bootmgr.efi\nhttps://msdl.microsoft.com/download/symbols/hvloader.efi/559F396411D000/hvloader.efi\n\nThe goal of the installer is clear – it’s responsible for disabling Windows security features such as BitLocker disk encryption and HVCI, and for\ndeployment of multiple files, including the malicious bootkit, to the ESP. Once finished, it reboots the compromised machine to let the dropped\nfiles do their job – to make sure the self-signed UEFI bootkit will be silently executed on every system start, regardless of UEFI Secure Boot\nprotection status.\n\n### Step 0 – Initialization and (potential) elevation\n\nWhen the installer is executed, it checks whether it has enough privileges (at least admin required) to deploy the rest of the files to the ESP\nand perform other actions requiring elevated process – like turning off HVCI or disabling BitLocker. If it’s not the case, it tries to elevate by\n[executing the installer again by using the UAC bypass method described in detail here: UAC bypass via Program Compatibility assistant.](https://github.com/hfiref0x/UACME/issues/111)\n\nWith the necessary privileges, it continues, checking the UEFI Secure Boot status by reading the value of the SecureBoot UEFI variable using\n[an available Windows API function, and determining the Windows version by directly accessing the KUSER_SHARED_DATA structure fields](https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/ntexapi_x/kuser_shared_data/index.htm)\nNtMajorVersion and NtMinorVersion in memory. It does so to decide whether or not bypassing UEFI Secure Boot is necessary to deploy the\n\n\n-----\n\nboot t o t e ct s syste (s ce Secu e oot suppo t as st added do s 8 a d g t ot be e ab ed o a y g e ac e)\n\nBefore proceeding to the next steps, it renames the legitimate Windows Boot Manager (bootmgfw.efi) binary located in the\nESP:\\EFI\\Microsoft\\Boot\\ directory to winload.efi. This renamed bootmgfw.efi backup is later used by the bootkit to launch the OS, or to\nrecover the original boot chain if the “uninstall” command is received from the C&C server – more in the _C&C communication section._\n\n### Step 1 – Deploying files\n\nIf UEFI Secure Boot is enabled, the installer proceeds with dropping multiple files into the ESP:/EFI/Microsoft/Boot/ and ESP:/system32/\ndirectories. While the former is a standard directory used by Windows, the latter is a custom folder created by the installer.\n\nA list of files dropped by the installer with a short explanation of the role of each file in the execution chain is provided in Table 1. We will\nexplain in detail how the execution chain works later; now just note that several legitimate Microsoft-signed files are dropped along with the\nmalicious ones.\n\n_Table 1. Files deployed by the BlackLotus installer on systems with UEFI Secure Boot enabled_\n\n**Folder** **Filename** **Description**\n\nESP:\\EFI\\Microsoft\\Boot grubx64.efi BlackLotus bootkit, malicious self-signed UEFI\napplication.\n\nbootload.efi Legitimate Microsoft-signed shim binary (temporary\nname, later replaces bootmgfw.efi after CVE-202221894 exploitation).\n\nbootmgfw.efi [Legitimate, but vulnerable (CVE-2022-21894)](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-21894)\nWindows Boot Manager binary, embedded in the\ninstaller or downloaded directly from the Microsoft\nSymbol Store.\n\nBCD Attackers’ custom [Boot Configuration Data (BCD)](https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/boot-options-in-windows)\nstore used in [CVE-2022-21894 exploitation chain.](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-21894)\n\nBCDR Backup of victim’s original BCD store.\n\nESP:\\system32 hvloader.efi [Legitimate, but vulnerable (CVE-2022-21894)](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-21894)\nWindows Hypervisor Loader binary, embedded inside\nan installer or downloaded directly from the Microsoft\nSymbol Store.\n\nbootmgr.efi [Legitimate, but vulnerable (CVE-2022-21894)](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-21894)\nWindows Boot Manager binary, embedded inside an\ninstaller or downloaded directly from the Microsoft\nSymbol Store.\n\nmcupdate_AuthenticAMD.dll Malicious self-signed native PE binary. This file is\nexecuted by the hvloader.efi after successful CVE2022-21894 exploitation (on systems using an AMD\nCPU).\n\nmcupdate_GenuineIntel.dll Malicious self-signed native PE binary. This file is\nexecuted by the hvloader.efi after successful CVE2022-21894 exploitation (on systems using an Intel\nCPU).\n\nBCD [Attackers’ custom BCD used in CVE-2022-21894](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-21894)\nexploitation chain.\n\nIn cases when the victim is running a Windows version not supporting UEFI Secure Boot, or in the case when it’s disabled, the deployment is\nquite straightforward. The only thing that is needed to deploy the malicious bootkit is to replace the existing Windows Boot Manager\n(bootmgfw.efi) binary in the ESP:\\EFI\\Microsoft\\Boot\\ directory, with the attackers’ own self-signed malicious UEFI application. Since UEFI\nSecure Boot is disabled (and thus no integrity verification is performed during the boot), exploitation is not necessary and the UEFI firmware\nsimply executes the malicious boot manager without causing any security violations.\n\n### Step 2 – Disabling Hypervisor-protected Code Integrity (HVCI)\n\nTo be able to run custom unsigned kernel code later, the installer has to make sure that [HVCI is disabled on the system. One of our ESET](https://learn.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-vbs)\n[colleagues wrote a very informative blogpost on this topic in 2022 (Signed kernel drivers – Unguarded gateway to Windows’ core):](https://www.welivesecurity.com/2022/01/11/signed-kernel-drivers-unguarded-gateway-windows-core/)\n\n_Virtualization-based security (VBS) offers several protection features with the most prominent one being Hypervisor-Protected Code Integrity_\n_(HVCI), which also comes as a standalone feature. HVCI enforces code integrity in the kernel and allows only signed code to be executed. It_\n_effectively prevents vulnerable drivers from being abused to execute unsigned kernel code or load malicious drivers (regardless of the_\n\n\n-----\n\n_e p o tat o_ _et od used) a d t see_ _s t at_ _a_ _a e abus g u e ab e d_ _e s to oad_ _a c ous code_ _as o e o t e_ _a_ _ot at o s_\n_behind Microsoft implementing this feature._\n\nAs shown in Figure 5, to disable this feature, the installer sets the Enabled registry value under the HypervisorEnforcedCodeIntegrity registry\nkey to zero.\n\n_Figure 5. Hex-Rays decompiled code of BlackLotus installer function responsible for disabling HVCI_\n\n### Step 3 – Disabling BitLocker\n\n[The next feature deactivated by the installer is BitLocker Drive Encryption. The reason for this is that BitLocker can be used in a combination](https://learn.microsoft.com/en-us/windows/security/information-protection/bitlocker/bitlocker-overview)\nwith [Trusted Platform Module (TPM) to ensure that various boot files and configurations, including Secure Boot, haven’t been tampered with](https://learn.microsoft.com/en-us/windows/security/information-protection/tpm/trusted-platform-module-overview)\nsince BitLocker drive encryption was configured on the system. Considering that the installer modifies the Windows boot chain on a\ncompromised machine, keeping BitLocker on for systems with TPM support would lead to a BitLocker recovery screen at the next bootup and\nwould tip the victim off that the system had been compromised.\n\nTo disable this protection, the BlackLotus installer:\n\nwalks through all volumes under the Root\\CIMV2\\Security\\MicrosoftVolumeEncryption WMI namespace and checks their protection\nstatus by calling the GetProtectionStatus method of the Win32_EncryptableVolume WMI class\nfor those protected by BitLocker, it calls the DisableKeyProtectors method with the DisableCount parameter set to zero, meaning that\nthe protection will be suspended until it is manually enabled\n\nWith the necessary protections disabled and all files deployed, the installer registers itself to be deleted during the next system restart and\nreboots the machine to proceed to the exploitation of CVE-2022-21894.\n\n## Bypassing Secure Boot and establishing persistence\n\nIn this part, we take a closer look at how BlackLotus achieves persistence on systems with UEFI Secure Boot enabled. As the execution\nchain we are about to describe is quite complex, we will first explain basic principles and then dig deeper into technical details.\n\nIn a nutshell, this process consists of two key steps:\n\n1. Exploiting CVE-2022-21894 to bypass the Secure Boot feature and install the bootkit. This allows arbitrary code execution in early boot\n\nphases, where the platform is still owned by firmware and UEFI Boot Services functions are still available. This allows attackers to do\nmany things that they should not be able to do on a machine with UEFI Secure Boot enabled without having physical access to it, such\nas modifying Boot-services-only NVRAM variables. And this is what attackers take advantage of to set up persistence for the bootkit in\nthe next step. More information about exploitation can be found in the Exploiting CVE-2022-21894 section.\n2. Setting persistence by writing its own MOK to the MokList, Boot-services-only NVRAM variable. By doing this, it can use a legitimate\n\nMicrosoft-signed shim for loading its self-signed (signed by the private key belonging to the key written to MokList) UEFI bootkit instead\nof exploiting the vulnerability on every boot. More about this in the _Bootkit persistence section._\n\nTo make the detailed analysis in the next two sections easier, we will follow the steps shown in the execution diagram, Figure 6.\n\n\n-----\n\n-----\n\n_Figure 6. Bypassing Secure Boot and setting up persistence using MOK_\n\n### Exploiting CVE-2022-21894\n\n[To bypass Secure Boot, BlackLotus uses the baton drop (CVE-2022-21894): Secure Boot Security Feature Bypass Vulnerability. Despite its](https://github.com/Wack0/CVE-2022-21894)\nhigh impact on system security, this vulnerability did not get as much public attention as it deserved. Although the vulnerability was fixed in\nMicrosoft’s January 2022 update, its exploitation is still possible because the affected binaries have still not been added to the UEFI\nrevocation list. As a result, attackers can bring their own copies of vulnerable binaries to their victims’ machines to exploit this vulnerability\nand bypass Secure Boot on up-to-date UEFI systems.\n\nMoreover, a Proof of Concept (PoC) exploit for this vulnerability has been publicly available since August 2022. Considering the date of the\nfirst BlackLotus VirusTotal submission (see Figure 1), the malware developer has likely just adapted the available PoC to their needs without\nany need of deep understanding of how this exploit works.\n\nLet’s start with a brief introduction to the vulnerability, mostly summarizing key points from the write-up published along with the PoC on\nGitHub:\n\nAffected Windows Boot Applications (such as bootmgr.efi, hvloader.efi, winload.efi…) allow removing a serialized Secure Boot policy\nfrom memory – before it gets loaded by the application – by using the truncatememory BCD boot option.\nThis allows attackers to use other dangerous BCD options like bootdebug, testsigning, or nointegritychecks, thus breaking Secure Boot.\nThere are various ways to exploit this vulnerability – three of them are published in the PoC repository.\nAs an example, one of the PoCs shows how it can be exploited to make the legitimate hvloader.efi load an arbitrary, self-signed\nmcupdate_<platform>.dll binary (where <platform> can be GenuineIntel or AuthenticAMD, based on the machine’s CPU.).\n\nNow, we continue with describing how BlackLotus exploits this vulnerability (numbers in the list below describe corresponding steps in Figure\n6):\n\n1. After the installer reboots the machine, the UEFI firmware proceeds with loading a first boot option. For Windows systems, the first boot\n\noption is by default bootmgfw.efi located in the ESP:/EFI/Microsoft/Boot folder on the ESP. This time, instead of executing the original\nvictim’s bootmgfw.efi (which was previously renamed winload.efi by the installer), the firmware executes the vulnerable one – deployed\nby the installer.\n2. After bootmgfw.efi is executed, it loads the BCD boot options, previously modified by the installer. Figure 7 shows a comparison of the\n\nlegitimate BCD and the modified one.\n3. As you can see in Figure 7 (path underlined with green), the legitimate Windows Boot Manager would normally load the Windows OS\n\nloader (\\WINDOWS\\system32\\winload.efi) as a default boot application. But this time, with the modified BCD, it continues with loading\nthe vulnerable ESP:\\system32\\bootmgr.efi, with the avoidlowmemory BCD element set to value 0x10000000 and the custom:22000023\nBCD element pointing to another attackers’ BCD stored in ESP:\\system32\\bcd. The explanation of using these elements can be found\n[in the published PoC:](https://github.com/Wack0/CVE-2022-21894)\n\n_The attacker needs to ensure the serialised Secure Boot Policy is allocated above a known physical address._\n\n_[…]_\n\n_The avoidlowmemory element can be used to ensure all allocations of physical memory are above a specified physical address._\n\n_• Since Windows 10, this element is disallowed if VBS is enabled, but as it is used during boot application initialisation, before the_\n_serialised Secure Boot policy is read from memory, loading bootmgr and specifying a custom BCD path (using bcdfilepath element aka_\n_custom:22000023) can be used to bypass this._\n\n\n-----\n\n_Figure 7. Legitimate BCD store (BEFORE) vs the one used by the BlackLotus installer (AFTER)_\n\n1. In the next step, the executed ESP:\\system32\\bootmgr.efi loads that additional BCD located in ESP:\\system32\\bcd. Parsed content of\n\nthis additional BCD is shown in Figure 8.\n\n_Figure 8. Second BCD dropped by the BlackLotus installer – used to exploit CVE-2022-21894_\n\n1. Because of options loaded from the BCD file shown in Figure 8, bootmgr.efi continues with loading another vulnerable Windows Boot\n\nApplication deployed by the installer – ESP:\\system32\\hvloader.efi – which is the Windows Hypervisor Loader. More importantly,\nadditional BCD options are specified in the same BCD file (see Figure 8):\n\n1. truncatememory with value set to 0x10000000\n2. nointegritychecks set to Yes\n3. and testsigning, also set to Yes\n\n\n-----\n\nd t s s e e t e ag c appe s s t e se a ed Secu e oot po cy s ou d be oaded p ys ca add esses abo e 0 0000000\n(because of avoidlowmemory used in previous steps), specifying the truncatememory element will effectively remove it – thus, break the\nSecure Boot and allow the use of dangerous BCD options like nointegritychecks or testsigning. By using these options, the attackers can\nmake the hvloader.efi execute their own, self-signed code.\n\n[1. To do this, the same trick as described in the PoC is used: during its execution, the legitimate hvloader.efi loads and executes the](https://github.com/Wack0/CVE-2022-21894)\n\nmcupdate_{GenuineIntel| AuthenticAMD}.dll native binary from the <device>:\\<SystemRoot>\\system32\\ directory. Commented HexRays decompiled code of the function from hvloader.efi responsible for loading this mcupdate*.dll binary is shown in Figure 9. Note that\nhvloader.efi would normally load this legitimate mcupdate*.dll binary from the <OS_partition>:\\Windows\\system32, but this time the\nmalicious attackers’ self-signed mcupdate*.dll is executed from a custom ESP directory previously created by the installer\n(ESP:\\system32). It’s caused by the BCD options device and systemroot used in the BCD from Figure 8 specifying the current device as\nboot – meaning the ESP – and also specifying SystemRoot to be the root (\\) directory on this device.\n\n_Figure 9. Hex-Rays decompilation of the BtLoadUpdateDll function from the legitimate hvloader.efi, responsible for loading mcupdate_*.dll_\n\n1. Now, as the attackers’ own self-signed mcupdate*.dll is loaded and executed, it continues with executing the final component in this\n\nchain – an embedded MokInstaller (UEFI Application) – see Figure 10 for details about how it’s done.\n\n\n-----\n\n_Figure 10. Hex-Rays decompiled code of the malicious self-signed mcupdate*.dll binary_\n\n### Bootkit persistence\n\nNow, the MokInstaller can proceed with setting up persistence by enrolling the attackers’ MOK into the NVRAM variable and setting up the\nlegitimate Microsoft-signed shim binary as a default bootloader. Before proceeding to details, a little theory about shim and MOK.\n\nshim is a first stage UEFI bootloader developed by Linux developers to make various Linux distributions work with UEFI Secure Boot. It’s a\nsimple application and its purpose is to load, verify, and execute another application – in case of Linux systems, it’s usually the GRUB\nbootloader. It works in a way that Microsoft signs only a shim, and the shim takes care of the rest – it can verify the integrity of a second-stage\nbootloader by using keys from db UEFI variable, and also embeds its own list of “allowed” or “revoked” keys or hashes to make sure that\ncomponents trusted by both – platform and shim developer (e.g. Canonical, RedHat, etc.,) – are allowed to be executed. In addition to these\nlists, shim also allows the use of an external keys database managed by the user, known as the MOK list. Figure 11 nicely illustrates how\nUEFI Secure Boot with MOK works.\n\nThis MOK database is stored in a Boot-only NVRAM variable named MokList. Without exploiting a vulnerability like the one described above,\nphysical access is required to modify it on a system with UEFI Secure Boot enabled (it’s available only during boot, before the OS loader calls\nthe UEFI Boot Services function ExitBootServices). However, by exploiting this vulnerability, attackers are able to bypass UEFI Secure Boot\nand execute their own self-signed code before a call to ExitBootServices, so they can easily enroll their own key (by modifying the MokList\nNVRAM variable) to make the shim execute any application – signed by that enrolled key – without causing a security violation.\n\n\n-----\n\n_[Figure 11. MOK boot process overview (image source)](https://web.archive.org/web/20201026161357/https:/www.suse.com/media/presentation/uefi_secure_boot_webinar.pdf)_\n\n1. Continuing with describing the flow from Figure 6 – step 8… The MokInstaller UEFI application continues with setting up persistence for\n\nthe BlackLotus UEFI bootkit and covering the tracks of exploitation by:\n\n1. Restoring the victim’s original BCD store from the backup created by the installer and replacing the efi with the legitimate\n\nMicrosoft-signed shim, previously dropped to the ESP:\\system32\\bootload.efi by the installer.\n2. Creating a MokList NVRAM variable containing the attackers’ self-signed public key certificate. Note that this variable is formatted\n\nin the same way as any other UEFI signature database variables (such as db or dbx) and it can consist of zero or more signature\nlists of type EFI_SIGNATURE_LIST – as defined in the UEFI Specification.\n3. Deleting all files involved in exploitation from the attackers‘ ESP:\\system32\\ folder.\n2. In the end, it reboots the machine to make the deployed shim execute the self-signed bootkit dropped to \\EFI\\Microsoft\\Boot\\grubx64.efi\n\nby the installer (grubx64.efi is usually the default second-stage bootloader executed by a shim on x86-64 systems).\n\nCode performing the actions described in the last two steps is shown in Figure 12.\n\n_Figure 12. Hex-Rays decompiled code – MokInstaller UEFI app setting up persistence for the BlackLotus bootkit_\n\n## BlackLotus UEFI bootkit\n\n\n-----\n\nO ce t e pe s ste ce s co gu ed, t e ac otus boot t s e ecuted o e e y syste sta t e boot t s goa s to dep oy a e e d e\nand a final user-mode component – the HTTP downloader. During its execution, it tries to disable additional Windows security features –\nVirtualization-Based Security (VBS) and Windows Defender – to raise the chance of successful deployment and stealthy operation. Before\njumping to the details about how that is done, let’s summarize the basics about the kernel driver and HTTP downloader:\n\nThe kernel driver is responsible for\n\nDeploying the next component of the chain – an HTTP downloader.\nKeeping the loader alive in case of termination.\nProtecting bootkit files from being removed from ESP.\nExecuting additional kernel payloads, if so instructed by the HTTP downloader.\nUninstalling the bootkit, if so instructed by the HTTP downloader.\nThe HTTP downloader is responsible for:\n\nCommunicating with its C&C.\nExecuting commands received from the C&C.\nDownloading and executing payloads received from the C&C (supports both kernel payloads and user-mode payloads).\n\nThe full execution flow (simplified), from the installer to HTTP downloader, is shown in Figure 13. We describe these individual steps in more\ndetail in the next section.\n\n\n-----\n\n_Figure 13. Diagram showing execution of the BlackLotus UEFI bootkit_\n\n## BlackLotus execution flow\n\nExecution steps are as follows (these steps are shown in Figure 13):\n\n1. As a first step, the UEFI firmware executes the default Windows boot option, which is the file usually stored in\n\n\\EFI\\Microsoft\\Boot\\bootmgfw.efi. As we described earlier (Bootkit persistence section, 8 .a), the MokInstaller binary replaced this file\nwith a legitimate signed shim.\n2. When the shim is executed, it reads the MokList NVRAM variable, and uses the certificate previously stored inside by the attackers to\n\nverify the second-stage bootloader – the self-signed BlackLotus UEFI bootkit located in \\EFI\\Microsoft\\Boot\\grubx64.efi.\n3. When verified, the shim executes the bootkit.\n[4. The bootkit starts with creating the Boot-only VbsPolicyDisable NVRAM variable. As described here, this variable is evaluated by the](https://www.bsi.bund.de/SharedDocs/Downloads/DE/BSI/Cyber-Sicherheit/SiSyPHus/Workpackage6_Virtual_Secure_Mode.pdf?__blob=publicationFile&v=1)\n\nWindows OS loader during boot and if defined, the core VBS features, such as HVCI and Credential Guard will not be initialized.\n\n\n-----\n\n5 t e o o g steps (5 a e), t e boot t co t ues t a co o patte used by U boot ts t te cepts t e e ecut o o\ncomponents included in the typical Windows boot flow, such as Windows Boot Manager, Windows OS loader, and Windows OS kernel,\nand hooks some of their functions in memory. As a bonus, it also attempts to disable Windows Defender by patching some of its drivers.\nAll this to achieve its payload’s execution in the early stages of the OS startup process and to avoid detection. The following functions\nare hooked or patched:\n\n1. ImgArchStartBootApplication in bootmgfw.efi or bootmgr.efi:\n\nThis function is commonly hooked by bootkits to catch the moment when the Windows OS loader (winload.efi) is loaded in the\nmemory but still hasn’t been executed – which is the right moment to perform more in-memory patching.\n2. BlImgAllocateImageBuffer in winload.efi:\n\nUsed to allocate an additional memory buffer for the malicious kernel driver.\n3. OslArchTransferToKernel in winload.efi:\n\nHooked to catch the moment when the OS kernel and some of the system drivers are already loaded in the memory, but still\nhaven’t been executed – which is a perfect moment to perform more in-memory patching. The drivers mentioned below are\npatched in this hook. The code from this hook responsible for finding appropriate drivers in memory is shown in Figure 14.\n4. WdBoot.sys and WdFilter.sys:\n\nBlackLotus patches the entry point of WdBoot.sys and WdFilter.sys – the Windows Defender ELAM driver and the Windows\nDefender file system filter driver, respectively – to return immediately.\n5. disk.sys:\n\nThe bootkit hooks the entry point of the disk.sys driver to execute the BlackLotus kernel driver in the early stages of system\ninitialization.\n\n_Figure 14. Hex-Rays decompiled code of OslArchTransferToKernel hook – patching Windows Defender drivers and searching for the disk.sys entry point_\n\n1. Next, when the OS kernel executes the disk.sys driver’s entry point, the installed hook jumps to the malicious kernel driver entry point.\n\nThe malicious code in turn restores the original disk.sys to allow the system to function properly and waits until the winlogon.exe\nprocess starts.\n2. When the malicious driver detects that the winlogon.exe process has started, it injects and executes the final user-mode component –\n\nthe HTTP downloader – into it.\n\n### Kernel driver\n\nThe kernel driver is responsible for four main tasks:\n\nInjecting the HTTP downloader into winlogon.exe and reinjecting it in case the thread terminated.\nP t ti b tkit fil d l d th ESP f b i d\n\n\n-----\n\nsa g t e use ode do s e e de p ocess s p g e e e\nCommunicating with the HTTP downloader and if necessary, performing any commands.\n\nLet’s look at them one by one.\n\n### HTTP downloader persistence\n\nThe kernel driver is responsible for deployment of the HTTP downloader. When the driver starts, it waits until the process named\nwinlogon.exe starts, before taking any other actions. Once the process has started, the driver decrypts the HTTP downloader binary, injects it\ninto winlogon.exe’s address space, and executes it in a new thread. Then, the driver keeps periodically checking whether the thread is still\nrunning, and repeats the injection if necessary. The HTTP downloader won’t be deployed if a kernel debugger is detected by the driver.\n\n### Protecting bootkit files on the ESP from removal\n\nTo protect the bootkit’s files located on the ESP, the kernel driver uses a simple trick. It opens all files it wants to protect, duplicates and saves\ntheir handles, and uses the ObSetHandleAttributes kernel function specifying the ProtectFromClose flag inside HandleFlags\n[(OBJECT_HANDLE_FLAG_INFORMATION) parameter to 1 – thus protecting the handles from being closed by any other processes. This](https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/ntobapi/object_handle_flag_information.htm)\nwill thwart any attempts to remove or modify the protected files. The following files are protected:\n\nESP:\\EFI\\Microsoft\\Boot\\winload.efi\nESP:\\EFI\\Microsoft\\Boot\\bootmgfw.efi\nESP:\\EFI\\Microsoft\\Boot\\grubx64.efi\n\nShould a user try to delete these protected files, something like what is shown in Figure 15 will occur.\n\n_Figure 15. An attempt to delete the files protected by BlackLotus driver_\n\nAs another layer of protection, in case the user or security software would be able to unset the protection flag and close the handles, the\nkernel driver continuously monitors them, and causes a BSOD by calling the KeBugCheck(INVALID_KERNEL_HANDLE) function if any of\nthe handles don’t exist anymore.\n\n### Disarming the main Windows Defender process\n\nThe kernel driver also tries to disarm the main Windows Defender process – MsMpEng.exe. It does so by removing all process’s token\nprivileges by setting the SE_PRIVILEGE_REMOVED attribute to each of them. As a result, the Defender process should not be able to do its\njob – such as scanning files – properly. However, as this functionality is poorly implemented, it can be made ineffective by restarting the\nMsMpEng.exe process.\n\n### Communication with the HTTP downloader\n\nThe kernel driver is capable of communicating with the HTTP downloader by using a named Event and Section. Names of the named objects\nused are generated based on the victim’s network adapter MAC address (ethernet). If a value of an octet is lower than 16, then 16 is added to\nit. The format of the generated objects names might vary in different samples. As an example, in one of the samples we analyzed, for the\nMAC address 00-1c-0b-cd-ef-34, the generated names would be:\n\n\\BaseNamedObjects\\101c1b: for the named section (only the first three octets of the MAC are used)\n\\BaseNamedObjects\\Z01c1b: for the named event – same as for the Section, but the first digit of the MAC address is replaced with Z\n\nIn case the HTTP downloader wants to pass some command to the kernel driver, it simply creates a named section, writes a command with\nassociated data inside, and waits for the command to be processed by the driver by creating a named event and waiting until the driver\ntriggers (or signals) it\n\n\n-----\n\ne d e suppo ts t e o o g se e p a ato y co a ds\n\nInstall kernel driver\nUninstall BlackLotus\n\nA careful reader might notice the BlackLotus weak point here – even though the bootkit protects its components against removal, the kernel\ndriver can be tricked to uninstall the bootkit completely by creating the abovementioned named objects and sending the uninstall command to\nit.\n\n## HTTP downloader\n\nThe final component is responsible for communication with a C&C server and execution of any C&C commands received from it. All payloads\nwe were able to discover contain three commands. These commands are very straightforward and as the section name suggests, it’s mostly\nabout downloading and executing additional payloads using various techniques.\n\n### C&C communication\n\nTo communicate with its C&C, the HTTP loader uses the HTTPS protocol. All information necessary for the communication is embedded\ndirectly in the downloader binary – including C&C domains and HTTP resource paths used. The default interval for communication with a\nC&C server is set to one minute, but can be changed based on the data from the C&C. Each communication session with a C&C starts with\nsending a beacon HTTP POST message to it. In samples we analyzed, the following HTTP resource paths can be specified in the HTTP\nPOST headers:\n\n/network/API/hpb_gate[.]php\n/API/hpb_gate[.]php\n/gate[.]php\n/hpb_gate[.]php\n\nThe beacon message data is prepended with a checkin= string, containing basic information about the compromised machine – including a\ncustom machine identifier (referred to as HWID), UEFI Secure Boot status, various hardware information, and a value that seems to be a\nBlackLotus build number. HWID is generated from the machine MAC address (ethernet) and a system volume serial number. The format of\nthe message before encryption is as seen in Figure 16\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n\n{\n\n\"HWID\":\"%s\",\n\n\"Session\":\"%lu\",\n\n\"Owner\":\"%s\",\n\n\"IP\":\"%s\",\n\n\"OS\":\"%s\",\n\n\"Edition\":\"%s\",\n\n\"CPU\":\"%s\",\n\n\"GPU\":\"%s\",\n\n\"RAM\":\"%lu\",\n\n\"Integrity\":\"%lu\",\n\n\"SecureBoot\":\"%i\",\n\n\"Build\":\"%lu\"\n\n}\n\n\n_Figure 16. Format of beacon message_\n\nBefore sending the message to the C&C, the data is first encrypted using an embedded RSA key, then URL-safe base64 encoded. During the\nanalysis, we found two different RSA keys being used in the samples. An example of such an HTTP beacon request is shown in Figure 17.\n\n\n-----\n\n_Figure 17. Example of a beacon HTTP POST message (generated by a sample from VirusTotal – the one with local IPs instead of real C&C addresses)_\n\nData received from the C&C as a response to the beacon message should start with the two-byte magic value HP; otherwise, the response is\nnot processed further. If the magic value is correct, the data following the magic value is decrypted using 256-bit AES in CBC mode with\nabovementioned HWID string used as the key.\n\nAfter decryption, the message is similar to the beacon, a JSON-formatted string, and specifies a command identifier (referred to as Type) and\nvarious additional parameters such as:\n\nC&C communication interval\nExecution method to use\nPayload filename\nPayload type based on file extension(.sys, .exe, or .dll supported)\nAuthentication token that is supposed to be used to request download of payload data\nAES key used for decrypting the payload data\n\nAll supported commands and their descriptions are listed in Table 2.\n\n_Table 2. C&C commands_\n\n**Command Type** **Command Description**\n\n1 Download and execute a kernel driver, DLL, or a regular executable\n\n2 Download a payload, uninstall the bootkit, and execute the payload – likely used to update the bootkit\n\n3 Uninstall the bootkit and exit\n\nIn these commands, the C&C can specify, whether the payload should first be dropped to disk before executing it, or be executed directly in\nmemory. In cases involving dropping the file to disk, the ProgramData folder on the OS volume is used as the destination folder and filename\nand extension are specified by the C&C server. In the case of executing files directly in memory, svchost.exe is used as an injection target.\nWhen the C&C sends a command requiring kernel driver cooperation, or an operator wants to execute code in kernel-mode, the mechanism\ndescribed in the Communication with the HTTP downloader section is used.\n\n## Anti-analysis tricks\n\nTo make detection and analysis of this piece of malware harder, its author tried to limit visibility of standard file artifacts, such as text strings,\nimports, or other unencrypted embedded data to a minimum. Below is a summary of the techniques used.\n\nString and data encryption\n\nAll strings used within the samples are encrypted using a simple cipher.\nAll embedded files are encrypted using 256-bit AES in CBC mode.\nEncryption keys for individual files can vary from sample to sample.\nIn addition to AES encryption, some files are also compressed using LZMS.\n\n\n-----\n\nu t e o y eso ut o\nIn all samples (when applicable), Windows APIs are always resolved exclusively during runtime and function hashes instead of\nfunction names are used to find the desired API function addresses in memory.\nIn some cases, a direct syscall instruction invocation is used to invoke the desired system function.\nNetwork communication\n\nCommunicates using HTTPS.\nAll messages sent to the C&C by the HTTP downloader are encrypted using an embedded RSA public key.\nAll messages sent from the C&C to the HTTP downloader are encrypted using a key derived from the victim’s machine\nenvironment or using an AES key provided by the C&C.\nAnti-debug and anti-VM tricks – if used, usually placed right at the beginning of the entry point. Only casual sandbox or debugger\ndetection tricks are used.\n\n## Mitigations and remediation\n\nFirst of all, of course, keeping your system and its security product up to date is a must – to raise a chance that a threat will be stopped\nright at the beginning, before it’s able to achieve pre-OS persistence.\nThen, the key step that needs to be taken to prevent usage of known vulnerable UEFI binaries for bypassing UEFI Secure Boot is their\nrevocation in the UEFI revocation database (dbx) – on a Windows systems, dbx updates should be distributed using Windows Updates.\nThe problem is that revocation of broadly used Windows UEFI binaries can lead to making thousands of outdated systems, recovery\nimages, or backups unbootable – and therefore, revocation often takes too long.\nNote that revocation of the Windows applications used by BlackLotus would prevent installation of the bootkit, but as the installer would\nreplace the victim’s bootloader with the revoked one, it could make the system unbootable. To recover in this case, an OS reinstall or\njust ESP recovery would resolve the issue.\nIf the revocation would happen after BlackLotus persistence is set, the bootkit would remain functional, as it uses a legitimate shim with\ncustom MOK key for persistence. In this case, the safest mitigation solution would be to reinstall Windows and remove the attackers’\nenrolled MOK key by using the mokutil utility (physical presence is required to perform this operation due to necessary user interaction\nwith the MOK Manager during the boot).\n\n## Takeaways\n\nMany critical vulnerabilities affecting security of UEFI systems have been discovered in the last few years. Unfortunately, due the complexity\nof the whole UEFI ecosystem and related supply-chain problems, many of these vulnerabilities have left many systems vulnerable even a\nlong time after the vulnerabilities have been fixed – or at least after we were told they were fixed. For a better image, here are some examples\nof the patch or revocation failures allowing UEFI Secure Boot bypasses just from the last year:\n\nFirst of all, of course, CVE-2022-21894 – the vulnerability exploited by BlackLotus. One year since the vulnerability was fixed,\nvulnerable UEFI binaries are still not revoked, allowing threats such as BlackLotus to stealthily operate on systems with UEFI Secure\nBoot enabled, thus providing victims a false sense of security.\nEarly in 2022, we disclosed several UEFI vulnerabilities that allow, among other things, disabling UEFI Secure Boot. Many devices\naffected are not supported by the OEM anymore, thus not fixed (even though these devices were not so old – like 3-5 years at the time\nof vulnerability disclosure). Read more in our blogpost: When “secure” isn’t secure at all: High‑impact UEFI vulnerabilities discovered in\nLenovo consumer laptops\n[Later in 2022, we discovered a few other UEFI vulnerabilities, whose exploitation would also allow attackers to disable UEFI Secure](https://twitter.com/ESETresearch/status/1590279782318878720)\n[Boot very easily. As pointed out by fellow researchers from Binarly, several devices listed in the advisory were left unpatched, or not](https://binarly.io/posts/Firmware_Patch_Deep_Dive_Lenovo_Patches_Fail_to_Fix_Underlying_Vulnerabilities)\npatched correctly, even few months after the advisory – leaving the devices vulnerable. Needless to say, similar to the previous case,\nsome devices will stay vulnerable forever, as they have reached their End-Of-Support date.\n\nIt was just a matter of time before someone would take advantage of these failures and create a UEFI bootkit capable of operating on\n[systems with UEFI Secure Boot enabled. As we suggested last year in our RSA presentation, all of this makes the move to the ESP more](https://www.rsaconference.com/Library/presentation/USA/2022/ESPecter%20First%20Real-World%20UEFI%20Bootkit%20Persisting%20on%20ESP)\nfeasible for attackers and a possible way forward for UEFI threats – the existence of BlackLotus confirms this.\n\n_ESET Research offers private APT intelligence reports and data feeds. For any inquiries about this service, visit the ESET Threat_\n_Intelligence page._\n\n## IoCs\n\n### Files\n\n**SHA-1** **Filename** **Detection** **Description**\n\n05846D5B1D37EE2D716140DE4F4F984CF1E631D1 N/A Win64/BlackLotus.A BlackLotus installer.\n\nA5A530A91100ED5F07A5D74698B15C646DD44E16 N/A Win64/BlackLotus.A BlackLotus installer.\n\nD82539BFC2CC7CB504BE74AC74DF696B13DB486A N/A Win64/BlackLotus.A BlackLotus installer.\n\n\n-----\n\n**SHA-1** **Filename** **Detection** **Description**\n\n16B12CEA54360AA42E1120E82C1E9BC0371CB635 N/A Win64/BlackLotus.A BlackLotus installer.\n\nDAE7E7C4EEC2AC0DC7963C44A5A4F47D930C5508 N/A Win64/BlackLotus.A BlackLotus installer.\n\n45701A83DEC1DC71A48268C9D6D205F31D9E7FFB N/A Win64/BlackLotus.A BlackLotus installer.\n\n2CE056AE323B0380B0E87225EA0AE087A33CD316 N/A EFI/BlackLotus.B BlackLotus UEFI bootkit.\n\n5A0074203ABD5DEB464BA0A79E14B7541A033216 N/A EFI/BlackLotus.B BlackLotus UEFI bootkit.\n\n5DC9CBD75ABD830E83641A0265BFFDDD2F602815 N/A EFI/BlackLotus.B BlackLotus UEFI bootkit.\n\n97AEC21042DF47D39AC212761729C6BE484D064D N/A EFI/BlackLotus.B BlackLotus UEFI bootkit.\n\nADCEEC18FF009BED635D168E0B116E72096F18D2 N/A EFI/BlackLotus.B BlackLotus UEFI bootkit.\n\nDBC064F757C69EC43517EFF496146B43CBA949D1 N/A EFI/BlackLotus.B BlackLotus UEFI bootkit.\n\n06AF3016ACCDB3DFE1C23657BF1BF91C13BAA757 N/A Win64/BlackLotus.B BlackLotus HTTP downloader.\n\n0C0E78BF97116E781DDE0E00A1CD0C29E68D623D N/A Win64/BlackLotus.B BlackLotus HTTP downloader.\n\n6D8CEE28DA8BCF25A4D232FEB0810452ACADA11D N/A Win64/BlackLotus.B BlackLotus HTTP downloader.\n\n74FF58FCE8F19083D16DF0109DC91D78C94342FA N/A Win64/BlackLotus.B BlackLotus HTTP downloader.\n\nACC74217CBE3F2E727A826B34BDE482DCAE15BE6 N/A Win64/BlackLotus.B BlackLotus HTTP downloader.\n\n111C4998F3264617A7A9D9BF662D4B1577445B20 N/A Win64/BlackLotus.B BlackLotus HTTP downloader.\n\n17FA047C1F979B180644906FE9265F21AF5B0509 N/A Win64/BlackLotus.C BlackLotus kernel driver.\n\n1F3799FED3CF43254FE30DCDFDB8DC02D82E662B N/A Win64/BlackLotus.C BlackLotus kernel driver.\n\n4B882748FAF2C6C360884C6812DD5BCBCE75EBFF N/A Win64/BlackLotus.C BlackLotus kernel driver.\n\n91F832F46E4C38ECC9335460D46F6F71352CFFED N/A Win64/BlackLotus.C BlackLotus kernel driver.\n\n994DC79255AEB662A672A1814280DE73D405617A N/A Win64/BlackLotus.C BlackLotus kernel driver.\n\nFFF4F28287677CAABC60C8AB36786C370226588D N/A Win64/BlackLotus.C BlackLotus kernel driver.\n\n71559C3E2F3950D4EE016F24CA54DA17D28B9D82 N/A EFI/BlackLotus.C BlackLotus Boot Configuration Data (BCD)\nstore dropped by BlackLotus installer.\n\nD6D3F3151B188A9DA62DEB95EA1D1ABEFF257914 N/A EFI/BlackLotus.C BlackLotus Boot Configuration Data (BCD)\nstore dropped by BlackLotus installer.\n\n547FAA2D64B85BF883955B723B07635C0A09326B N/A EFI/BlackLotus.A BlackLotus CVE-2022-21894 exploitation\npayload loader.\n\nD1BBAA3D408E944C70B3815471EED7FA9AEE6425 N/A EFI/BlackLotus.A BlackLotus CVE-2022-21894 exploitation\npayload loader.\n\n0E6DD7110C38464ECAA55EE4E2FA303ADA0EDEFB N/A EFI/BlackLotus.A BlackLotus CVE-2022-21894 exploitation\npayload – MokInstaller EFI app.\n\nD6BB89D8734B3E49725362DAE9A868AE681E8BD6 N/A EFI/BlackLotus.A BlackLotus CVE-2022-21894 exploitation\npayload – MokInstaller EFI app.\n\n164BB587109CFB20824303AD1609A65ABB36C3E9 N/A Win64/BlackLotus.D BlackLotus installer UAC bypass module.\n\n### Certificates\n\nSerial number 570B5D22B723B4A442CC6EEEBC2580E8\n\nThumbprint C8E6BF8B6FDA161BBFA5470BCC262B1BDC92A359\n\nSubject CN When They Cry CA\n\nSubject O N/A\n\nSubject L N/A\n\nSubject S N/A\n\n\n-----\n\nSubject C N/A\n\nValid from 2022-08-13 17:48:44\n\nValid to 2032-08-13 17:58:44\n\n### Network\n\n**IP** **Domain** **Hosting provider** **First seen** **Details**\n\nN/A xrepositoryx[.]name N/A 2022‑10‑17 BlackLotus C&C.\nhttps://xrepositoryx[.]name/network/API/hpb_gate.php\n\nN/A myrepositoryx[.]com N/A 2022‑10‑16 BlackLotus C&C.\n\nhttps://myrepositoryx[.]com/network/API/hpb_gate.php\n\n104.21.22[.]185 erdjknfweklsgwfmewfgref[.]com Cloudflare, Inc. 2022‑10‑06 BlackLotus C&C.\n\nhttps://erdjknfweklsgwfmewfgref[.]com/API/hpb_gate.ph\n\n164.90.172[.]211 harrysucksdick[.]com DigitalOcean, LLC 2022‑10‑09 BlackLotus C&C.\n\nhttps://harrysucksdick[.]com/API/hpb_gate.php\n\n\n185.145.245[.]123 heikickgn[.]com\n\nfrassirishiproc[.]com\n\n\nSIA VEESP 2022‑10‑12 BlackLotus C&C.\n\nhttps://heikickgn[.]com/API/hpb_gate.php\n\nhttps://frassirishiproc[.]com/API/hpb_gate.php\n\n\n185.150.24[.]114 myrepository[.]name SkyLink Data\nCenter BV\n\n190.147.189[.]122 egscorp[.]net Telmex Colombia\nS.A.\n\n## MITRE ATT&CK techniques\n\n_[This table was built using version 12 of the MITRE ATT&CK framework.](https://attack.mitre.org/resources/versions/)_\n\n\n2022‑10‑14 BlackLotus C&C.\n\nmyrepository[.]name/network/API/hpb_gate.php\n\n2022‑08‑24 BlackLotus C&C.\n\nhttps://egscorp[.]net/API/hpb_gate.php\n\n\n**Tactic** **ID** **Name** **Description**\n\n\nResource\nDevelpment\n\n\n[T1587.002](https://attack.mitre.org/versions/v12/techniques/T1587/002/) Develop Capabilities: Code Signing Certificates Some BlackLotus samples\nare signed with selfsigned certificate.\n\n\n[T1588.005](https://attack.mitre.org/versions/v12/techniques/T1588/005/) Obtain Capabilities:\nExploits\n\n\nBlackLotus used publicly known exploit to bypass UEFI Secure Boot.\n\n\nExecution [T1203](https://attack.mitre.org/versions/v12/techniques/T1203/) Exploitation for Client Execution BlackLotus installers can\nexploit CVE-2022-21894\nto achieve arbitrary code\nexecution on the systems\nwith UEFI Secure Boot\nenabled.\n\n\n[T1559](https://attack.mitre.org/versions/v12/techniques/T1559/) Inter-Process\nCommunication\n\n\nBlackLotus HTTP downloader uses named section to pass commands\nto the kernel-mode component.\n\n\n[T1106](https://attack.mitre.org/versions/v12/techniques/T1106/) Native API BlackLotus HTTP downloader uses various native Windows APIs to\nachieve code execution on the compromised machine.\n\n[T1129](https://attack.mitre.org/versions/v12/techniques/T1129/) Shared Modules BlackLotus HTTP downloader can load and execute DLLs received\nfrom the C&C server.\n\nPersistence [T1542.003](https://attack.mitre.org/versions/v12/techniques/T1542/003/) Pre-OS Boot: Bootkit BlackLotus bootkit is\ndeployed on the EFI\nSystem Partition and\nexecuted during the boot.\n\n\nPrivilege\nEscalation\n\n\n[T1548.002](https://attack.mitre.org/versions/v12/techniques/T1548/002/) Abuse Elevation Control Mechanism: Bypass User Account Control BlackLotus installer\nattempts to escalate\nprivileges by bypassing\nUser Account Control.\n\n\n[T1134.002](https://attack.mitre.org/versions/v12/techniques/T1134/002/) Access Token\nManipulation: Create\nProcess with Token\n\n\nBlackLotus HTTP downloader can use WTSQueryUserToken and\nCreateProcessAsUserW to execute downloaded payloads within a new\nprocess with local system privileges.\n\n\n-----\n\n**Tactic** **ID** **Name** **Description**\n\n\nDefense\nEvasion\n\n\n[T1622](https://attack.mitre.org/versions/v12/techniques/T1622/) Debugger Evasion BlackLotus components\nuse various techniques to\ndetect whether a kernelmode or user-mode\ndebugger is running on a\nvictim.\n\n\n[T1574](https://attack.mitre.org/versions/v12/techniques/T1574/) Hijack Execution Flow BlackLotus bootkit hijacks various components included in the early\nWindows boot process stages (Windows Boot Manager, Windows OS\nloader, Windows kernel and specific drivers) to avoid detection by\ndeactivating various Windows security features (VBS, Windows\nDefender) and stealthily execute its kernel-mode and user-mode\ncomponents\n\n[T1562](https://attack.mitre.org/versions/v12/techniques/T1562/) Impair Defenses BlackLotus components can disable BitLocker and Windows Defender\nto avoid detection.\n\n\n[T1070.004](https://attack.mitre.org/versions/v12/techniques/T1070/004/) Indicator Removal:\nFile Deletion\n\n[T1070.009](https://attack.mitre.org/versions/v12/techniques/T1070/009/) Indicator Removal:\nClear Persistence\n\n[T1036.005](https://attack.mitre.org/versions/v12/techniques/T1036/005/) Masquerading: Match\nLegitimate Name or\nLocation\n\n\nBlackLotus installer deletes itself after successfully deploying files to\nthe EFI System partition. Also after successful CVE-2022-21894\nexploitation, BlackLotus removes traces of exploitation by deleting all\nfiles included in exploitation chain from EFI System Partition.\n\nBlackLotus can uninstall itself by removing all bootkit files from the\nESP and restoring original victim’s Windows Boot Manager.\n\nBlackLotus attempts to hide its files deployed on the ESP by using\nlegitimate filenames, such as grubx64.efi (if UEFI Secure Boot is\nenabled on compromised machine) or bootmgfw.efi (if UEFI Secure\nBoot is disabled on compromised machine).\n\n\n[T1112](https://attack.mitre.org/versions/v12/techniques/T1112/) Modify Registry BlackLotus installer modifies Windows registry to disable Windows\nHVCI security feature.\n\n\n[T1027](https://attack.mitre.org/versions/v12/techniques/T1027/) Obfuscated Files or\nInformation\n\n[T1027.007](https://attack.mitre.org/versions/v12/techniques/T1027/007/) Obfuscated Files or\nInformation: Dynamic\nAPI Resolution\n\n[T1027.009](https://attack.mitre.org/versions/v12/techniques/T1027/009/) Obfuscated Files or\nInformation:\nEmbedded Payloads\n\n\nAlmost all embedded strings in BlackLotus components are encrypted\nusing a custom combined cipher and decrypted only when needed.\n\nBlackLotus components use dynamic API resolution while using API\nnames’ hashes instead of names.\n\nAlmost all embedded files in BlackLotus components are encrypted\nusing AES.\n\n\n[T1542.003](https://attack.mitre.org/versions/v12/techniques/T1542/003/) Pre-OS Boot: Bootkit BlackLotus bootkit is deployed on the EFI System Partition and\nexecuted during the early OS boot stages, and thus is capable of\ncontrolling the OS boot process and evading detection.\n\n\n[T1055.012](https://attack.mitre.org/versions/v12/techniques/T1055/012/) Process Injection:\nDynamic-link Library\nInjection\n\n[T1055.002](https://attack.mitre.org/versions/v12/techniques/T1055/002/) Process Injection:\nPortable Executable\nInjection\n\n\nBlackLotus HTTP downloader can inject a DLL into a newly created\nsvchost.exe process using process hollowing.\n\nBlackLotus driver injects the HTTP downloader portable executable\ninto a winlogon.exe process.\n\n\n[T1014](https://attack.mitre.org/versions/v12/techniques/T1014/) Rootkit BlackLotus kernel driver protects the bootkit files on the ESP from\nremoval.\n\n\n[T1497.001](https://attack.mitre.org/versions/v12/techniques/T1497/001/) Virtualization/Sandbox\nEvasion: System\nChecks\n\n\nBlackLotus employs various system checks including checking\nsandbox-specific registry values, to detect and avoid virtualization and\nanalysis environments.\n\n\nDiscovery [T1622](https://attack.mitre.org/versions/v12/techniques/T1622/) Debugger Evasion BlackLotus components\nuse various techniques to\ndetect whether a kernelmode or user-mode\ndebugger is running on a\nvictim.\n\n\n[T1082](https://attack.mitre.org/versions/v12/techniques/T1082/) System Information\nDiscovery\n\n[T1614](https://attack.mitre.org/versions/v12/techniques/T1614/) System Location\nDiscovery\n\n\nBlackLotus collects system information (IP, GPU, CPU, memory, OS\nversion) on a compromised host.\n\nBlackLotus can exit if one of the following system locales is identified\non the compromised host: ro-MD, ru-MD, ru-RU, uk-UA, be-BY, hy-AM,\nkk-KZ.\n\n\n-----\n\n**Tactic** **ID** **Name** **Description**\n\n\n[T1016](https://attack.mitre.org/versions/v12/techniques/T1016/) System Network\nConfiguration\nDiscovery\n\n[T1016.001](https://attack.mitre.org/versions/v12/techniques/T1016/001/) System Network\nConfiguration\nDiscovery: Internet\nConnection Discovery\n\n[T1497.001](https://attack.mitre.org/versions/v12/techniques/T1497/001/) Virtualization/Sandbox\nEvasion: System\nChecks\n\n\nBlackLotus HTTP downloader can determine the public IP of a\ncompromised host by requesting api.ipify[.]org service.\n\nBlackLotus HTTP downloader checks the internet connection by\nquerying Microsoft’s www.msftncsi[.]com/ncsi[.]txt\n\nBlackLotus employs various system checks including checking\nsandbox-specific registry values, to detect and avoid virtualization and\nanalysis environments.\n\n\nCommand\nand Control\n\n\n[T1071.001](https://attack.mitre.org/versions/v12/techniques/T1071/001/) Application Layer Protocol: Web Protocols BlackLotus uses HTTPS\nfor communication with its\nC&C.\n\n\n[T1132.001](https://attack.mitre.org/versions/v12/techniques/T1132/001/) Data Encoding:\nStandard Encoding\n\n[T1573.001](https://attack.mitre.org/versions/v12/techniques/T1573/001/) Encrypted Channel:\nSymmetric\nCryptography\n\n[T1573.002](https://attack.mitre.org/versions/v12/techniques/T1573/002/) Encrypted Channel:\nAsymmetric\nCryptography\n\n1 Mar 2023 - 11:30AM\n\n\nBlackLotus encodes encrypted data in C&C communication with URLsafe base64.\n\nBlackLotus uses 256-bit AES in CBC mode to decrypt messages\nreceived from its C&C.\n\nBlackLotus uses an embedded RSA public key to encrypt messages\nsent to C&C.\n\n\n### Sign up to receive an email update whenever a new article is published in our Ukraine Crisis – Digital Security Resource Center\n\n Newsletter\n\n Discussion\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-03-01 - BlackLotus UEFI bootkit- Myth confirmed.pdf"
    ],
    "report_names": [
        "2023-03-01 - BlackLotus UEFI bootkit- Myth confirmed.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d2516b8e-e74f-490d-8a15-43ad6763c7ab",
            "created_at": "2022-10-25T16:07:24.212584Z",
            "updated_at": "2025-03-27T02:02:10.141001Z",
            "deleted_at": null,
            "main_name": "Sofacy",
            "aliases": [
                "APT 28",
                "ATK 5",
                "Blue Athena",
                "BlueDelta",
                "FROZENLAKE",
                "Fancy Bear",
                "Fighting Ursa",
                "Forest Blizzard",
                "Grey-Cloud",
                "Grizzly Steppe",
                "Group 74",
                "GruesomeLarch",
                "ITG05",
                "Iron Twilight",
                "Operation DealersChoice",
                "Operation Dear Joohn",
                "Operation Komplex",
                "Operation Pawn Storm",
                "Operation Russian Doll",
                "Operation Steal-It",
                "Pawn Storm",
                "SIG40",
                "Sednit",
                "Snakemackerel",
                "Sofacy",
                "Strontium",
                "T-APT-12",
                "TA422",
                "TAG-0700",
                "TAG-110",
                "TG-4127",
                "Tsar Team",
                "UAC-0028",
                "UAC-0063"
            ],
            "source_name": "ETDA:Sofacy",
            "tools": [
                "ADVSTORESHELL",
                "AZZY",
                "Backdoor.SofacyX",
                "CHERRYSPY",
                "CORESHELL",
                "Carberp",
                "Computrace",
                "DealersChoice",
                "Delphacy",
                "Downdelph",
                "Downrage",
                "Drovorub",
                "EVILTOSS",
                "Foozer",
                "GAMEFISH",
                "GooseEgg",
                "Graphite",
                "HATVIBE",
                "HIDEDRV",
                "Headlace",
                "Impacket",
                "JHUHUGIT",
                "JKEYSKW",
                "Koadic",
                "Komplex",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LoJack",
                "LoJax",
                "MASEPIE",
                "Mimikatz",
                "NETUI",
                "Nimcy",
                "OCEANMAP",
                "OLDBAIT",
                "PocoDown",
                "PocoDownloader",
                "Popr-d30",
                "ProcDump",
                "PythocyDbg",
                "SMBExec",
                "SOURFACE",
                "SPLM",
                "STEELHOOK",
                "Sasfis",
                "Sedkit",
                "Sednit",
                "Sedreco",
                "Seduploader",
                "Shunnael",
                "SkinnyBoy",
                "Sofacy",
                "SofacyCarberp",
                "SpiderLabs Responder",
                "Trojan.Shunnael",
                "Trojan.Sofacy",
                "USB Stealer",
                "USBStealer",
                "VPNFilter",
                "Win32/USBStealer",
                "WinIDS",
                "Winexe",
                "X-Agent",
                "X-Tunnel",
                "XAPS",
                "XTunnel",
                "Xagent",
                "Zebrocy",
                "Zekapab",
                "carberplike",
                "certutil",
                "certutil.exe",
                "fysbis",
                "webhp"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1680660590,
    "ts_updated_at": 1743041831,
    "ts_creation_date": 1680510130,
    "ts_modification_date": 1680510130,
    "files": {
        "pdf": "https://archive.orkl.eu/7f6fe9cf13652da4881e35ea50f06a0bcbb0ed9d.pdf",
        "text": "https://archive.orkl.eu/7f6fe9cf13652da4881e35ea50f06a0bcbb0ed9d.txt",
        "img": "https://archive.orkl.eu/7f6fe9cf13652da4881e35ea50f06a0bcbb0ed9d.jpg"
    }
}