{
    "id": "c1023990-fbbb-4685-8f85-cff6212e97b9",
    "created_at": "2023-01-12T15:04:02.35865Z",
    "updated_at": "2025-03-27T02:05:28.816364Z",
    "deleted_at": null,
    "sha1_hash": "7ae46aa5569f0ba4ced02ea52d354aed371eb365",
    "title": "2017-05-07 - Loki-Bot- Come out, come out, wherever you are!",
    "authors": "",
    "file_creation_date": "2022-05-28T17:50:05Z",
    "file_modification_date": "2022-05-28T17:50:05Z",
    "file_size": 1113229,
    "plain_text": "# Loki-Bot: Come out, come out, wherever you are!\n\n**r3mrum.wordpress.com/2017/05/07/loki-bot-atrifacts/**\n\nView all posts by R3MRUM May 7, 2017\n\n## Intro\n\nI’m going to make my first post an easy one. I’m currently in the middle of writing up my\nGREM Gold paper, which focuses on the reverse engineering of a Loki-Bot v1.8 sample.\nThis post is going to focus on how Loki-Bot creates its mutex and the folders, files, and\nregistry keys that are created as a result.\n\nPer [PhishMe:](https://phishme.com/loki-bot-malware/)\n\nLoki Bot is a commodity malware sold on underground sites which is designed to steal\nprivate data from infected machines, and then submit that info to a command and\ncontrol host via HTTP POST. This private data includes stored passwords, login\ncredential information from Web browsers, and a variety of cryptocurrency wallets.\n\n## What is a Mutex?\n\nUnderstanding what a Mutex is can be a bit difficult to understand for those with little-to-no\n[programming background. I found it best described on the SANS DFIR Blog:](https://digital-forensics.sans.org/blog/2012/07/24/mutex-for-malware-discovery-and-iocs)\n\n\n-----\n\nPrograms use [mutex ( mutual exclusion ) objects as a locking mechanism to serialize](http://en.wikipedia.org/wiki/Mutual_exclusion)\naccess to a resource on the system.” … “Furthermore, malware might use a mutex to\navoid reinfecting the host. For instance, the specimen might attempt to open a handle\nto a mutex with a specific name. The specimen might exit if the mutex exists, because\nthe host is already infected.”\n\n## Creating the Mutex\n\nSo, based on the mutex description, Loki-Bot uses a mutex to ensure that multiple versions\nof Loki-Bot cant be running at the same time. In order for this to happen, both versions of\nLoki-Bot need to have the same logic for naming the mutex. What we are going to talk about\nnext is said logic.\n\n## Obtaining the Machine GUID\n\nFirst and foremost, know that Loki-Bot employs function hashing to thwart analysis. This is\nwhat you are seeing from 0x404A63 to 0x404A6C. Two important arguments passed to the\nfunction labeled getDLLFunctionFromIDXAndHash are Arg1 (DLL Index) and Arg2 (Function\nHash). In this instance, these values are set to 9 and ‘F4B4ACDC’. Without diving too deep\ninto this, know that the DLL Index of 9 equates to ADVAPI32 and the hash ‘F4B4ACDC’\ndecodes to [RegOpenKeyEx. At 0x404A81, we see the decoded function](https://msdn.microsoft.com/en-us/library/windows/desktop/ms724897(v=vs.85).aspx)\n[ADVAPI32.RegOpenKeyEx being called.](https://msdn.microsoft.com/en-us/library/windows/desktop/ms724897(v=vs.85).aspx)\n\nThis will open the registry path:\n\n“HKEY_LOCAL_MACHINE\\SORTWARE\\Microsoft\\Cryptograpy\\”\n\nBut it doesn’t actually read the value contained within the key it needs. For this to happen,\nADVAPI32’s [RegQueryValueEx function needs to be called.](https://msdn.microsoft.com/en-us/library/windows/desktop/ms724911(v=vs.85).aspx)\n\n\n-----\n\nAfter successful execution, the value stored in the memory address referenced in the pData\nargument (0x292388) now contains the value that was in the\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Cryptography\\MachineGuid registry key.\n\n[We can validate this by simply loading up RegEdit on the Windows host that is about to be](https://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/tools_regeditors.mspx?mfr=true)\ncompromised and navigating to the referenced registry key.\n\nThe Machine GUID is supposed to be a value that is unique for each system. This means\nthat your Machine GUID will be different from the Machine GUId depicted here; thus,\nyour mutex will be different from mine.\n\n## MD5 Hash Machine GUID\n\nOnce the Machine GUID is obtained from the registry, Loki-Bot obtains the MD5 hash of the\nMachine GUID by making calls to ADVAPI’s [CryptAcquireContext,](https://msdn.microsoft.com/en-us/library/windows/desktop/aa379886(v=vs.85).aspx) [CryptCreateHash,](https://msdn.microsoft.com/en-us/library/windows/desktop/aa379908(v=vs.85).aspx)\n[CryptHashData, and](https://msdn.microsoft.com/en-us/library/windows/desktop/aa380202(v=vs.85).aspx) [CryptGetHashParam.](https://msdn.microsoft.com/en-us/library/windows/desktop/aa379947(v=vs.85).aspx)\n\n\n-----\n\nAfter [CryptGetHashParam executes, the MD5 hash of the Machine GUID is returned.](https://msdn.microsoft.com/en-us/library/windows/desktop/aa379947(v=vs.85).aspx)\n\nThe MD5 hash of our Machine GUID appears to be\n“9BD0BA527DFA20AB1F4A05B8D0D4E04B“. There are a number of different ways that we\ncould validate this result but I find that it’s easiest using the linux command line.\n\n## Trim Hash & Create Mutex\n\n\n-----\n\nFinally, Loki-Bot trims the MD5 hash of the Machine GUID to 24-characters:\n“9BD0BA527DFA20AB1F4A05B8“.\n\nIt then passes this trimmed value to Kernel32’s [CreateMutexW function as the](https://msdn.microsoft.com/en-us/library/windows/desktop/ms682411(v=vs.85).aspx)\n_lpName attribute. If the function succeeds, it means that no other version of Loki-Bot is_\nrunning on the system at that time and execution continues on. If it fails, it means another\nversion of Loki-Bot is running, so Loki-Bot quietly exits.\n\n## Identify Folder/Files\n\nNow that we know the mutex, we can identify the folders and files that are related to LokiBot. As part of setting up persistence, Loki-Bot will create a hidden folder within your\n%APPDATA% path whose name set by the 8th thru 13th characters of the mutex.\n\nOnce the hidden folder “%APPDATA%\\27DFA2\\” has been created, Loki-Bot will store\nseveral different types of files within it; all with the same filename but with different\nextensions. The filename used for the different files is also extracted from the mutex.\n\nWith the filename known, we can then identify the following files:\n\n\n-----\n\n**%APPDATA%\\27DFA2\\20AB1F.exe – A copy of the malware that will execute every**\ntime the user account is logged into.\n**%APPDATA%\\27DFA2\\20AB1F.hdb – A database of hashes for data that has already**\nbeen exfiltrated to the C2 server.\n**%APPDATA%\\27DFA2\\20AB1F.lck – A lock file created when either decrypting**\nWindows Credentials or Keylogging to prevent resource conflicts.\n**%APPDATA%\\27DFA2\\20AB1F.kdb – A database of keylogger data that has yet to be**\nsent to the C2 server.\n\n## Identify Registry Key\n\nThe path for the specific persistence registry key used is encrypted within the binary using\n[Triple DES encryption, which is why static analysis wont yield much. Once decrypted, my](https://en.wikipedia.org/wiki/Triple_DES)\nsample returned the following registry path used for persistence:\n\n“HKEY_LOCAL_MACHINE\\ Software\\Microsoft\\Windows\\CurrentVersion\\Run\\”\n\nThe registry key within this path is then derived from the Mutex exactly how our\n%APPDATA% subfolder was:\n\n“HKEY_LOCAL_MACHINE\\ Software\\Microsoft\\Windows\\CurrentVersion\\Run\\27DFA2“\n\nThe value assigned to this key is the executable that is stored within the %APPDATA%\nsubfolder:\n\n“%APPDATA%\\27DFA2\\20AB1F.exe”\n\n## Conclusion\n\nThat pretty much covers all artifacts related to Loki-Bot that could be present on a\ncompromised system. First step is to identify your system’s Machine GUID. Once you do\nthat, MD5 hash and then trim that value. The result will help you identify all the different\nfolders, files, and registry keys associated with the malware.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-05-07 - Loki-Bot- Come out, come out, wherever you are!.pdf"
    ],
    "report_names": [
        "2017-05-07 - Loki-Bot- Come out, come out, wherever you are!.pdf"
    ],
    "threat_actors": [
        {
            "id": "2c7ecb0e-337c-478f-95d4-7dbe9ba44c39",
            "created_at": "2022-10-25T16:07:23.690871Z",
            "updated_at": "2025-03-27T02:02:09.921431Z",
            "deleted_at": null,
            "main_name": "Goblin Panda",
            "aliases": [
                "1937CN",
                "Conimes",
                "Cycldek",
                "Goblin Panda"
            ],
            "source_name": "ETDA:Goblin Panda",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Agent.dhwf",
                "BackDoor-FBZT!52D84425CDF2",
                "BlueCore",
                "BrowsingHistoryView",
                "ChromePass",
                "CoreLoader",
                "Custom HDoor",
                "Destroy RAT",
                "DestroyRAT",
                "DropPhone",
                "FoundCore",
                "HDoor",
                "HTTPTunnel",
                "JsonCookies",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "NBTscan",
                "NewCore RAT",
                "PlugX",
                "ProcDump",
                "PsExec",
                "QCRat",
                "RainyDay",
                "RedCore",
                "RedDelta",
                "RoyalRoad",
                "Sisfader",
                "Sisfader RAT",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Trojan.Win32.Staser.ytq",
                "USBCulprit",
                "Win32/Zegost.BW",
                "Xamtrav",
                "ZeGhost",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "7d553b83-a7b2-431f-9bc9-08da59f3c4ea",
            "created_at": "2023-01-06T13:46:39.444946Z",
            "updated_at": "2025-03-27T02:00:03.093712Z",
            "deleted_at": null,
            "main_name": "GOBLIN PANDA",
            "aliases": [
                "Conimes",
                "Cycldek"
            ],
            "source_name": "MISPGALAXY:GOBLIN PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535842,
    "ts_updated_at": 1743041128,
    "ts_creation_date": 1653760205,
    "ts_modification_date": 1653760205,
    "files": {
        "pdf": "https://archive.orkl.eu/7ae46aa5569f0ba4ced02ea52d354aed371eb365.pdf",
        "text": "https://archive.orkl.eu/7ae46aa5569f0ba4ced02ea52d354aed371eb365.txt",
        "img": "https://archive.orkl.eu/7ae46aa5569f0ba4ced02ea52d354aed371eb365.jpg"
    }
}