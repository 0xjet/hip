{
    "id": "4cb28114-5d3a-4d34-8832-9825ea1f8cbe",
    "created_at": "2023-01-12T15:00:24.009034Z",
    "updated_at": "2025-03-27T02:16:07.350784Z",
    "deleted_at": null,
    "sha1_hash": "ae1e098c2772c05e471b7529e1200b2938638c30",
    "title": "2020-12-07 - Rana Android Malware Your past catches up, sooner or later...",
    "authors": "",
    "file_creation_date": "2022-05-29T10:37:52Z",
    "file_modification_date": "2022-05-29T10:37:52Z",
    "file_size": 2019614,
    "plain_text": "# Rana Android Malware\n\n**blog.reversinglabs.com/blog/rana-android-malware**\n\n[Threat Research | December 7, 2020](https://blog.reversinglabs.com/blog/tag/threat-research)\n\nBlog Author\n[Karlo Zanki, Reverse Engineer at ReversingLabs. Read More...](https://blog.reversinglabs.com/blog/author/karlo-zanki)\n\n\n-----\n\n## Introduction\n\nOn September 17th, the U.S. Department of the Treasury’s Office of Foreign Assets Control\n[imposed sanctions on Iranian cyber threat group APT39, also known as Chafer, Cadelspy,](https://home.treasury.gov/news/press-releases/sm1127)\nRemexi, and ITG07. On the same day, the FBI released a [public threat analysis report](https://www.ic3.gov/Media/News/2020/200917-2.pdf)\ndescribing several tools used by Rana Corp, a front company backed by the Iranian Ministry\nof Intelligence and Security (MOIS) which is behind the malicious cyber activities conducted\nby the APT39 group.\n\nThe tools described in the aforementioned report are implemented using different\ntechnologies including VisualBasic and Autoit scripts, Android applications and the more\ncommon PE executables. According to the report, the focus of Rana’s cyber activities is\ntracking the movements of individuals whom the MOIS considers a threat. In today’s world,\nthe most valuable source of such information are smartphones. You carry a smartphone\nalmost the entire time, and, besides being the main tool for everyday communication,\nsmartphones also provide a large set of secondary functionalities, including visual and audio\nrecording and location services. Because of all these capabilities, gaining control over\nsomeone’s smartphone provides the malicious actor with a powerful espionage tool. For\nthese reasons, we decided to take a better look at the information and IOCs provided in the\nreferenced report to see if there is anything more to be found about this Android malware.\n\n## Related samples\n\n\n-----\n\nThe report provided one sample hash of the malware APK file, and a YARA rule which can\nbe used to search for additional samples. The first encountered problem was that the\nprovided YARA rule wasn’t triggered on the provided APK sample. It was triggered only on\nthe .dex file contained inside the APK. This means that the APK sample can pass\nundetected if its contents are not extracted.\n\nSo, we had to take a different approach to find additional samples. Luckily, the Titanium\nPlatform provides multiple ways to search for related samples based on metadata extracted\nfrom Android applications. The provided sample was signed with a self-signed certificate.\nSince searching for samples signed with the same certificate (based on the certificate\nthumbprint) didn’t give any results, a more generic search query was required.\n\n**Certificate details**\n\nLooking at the certificate details reveals that malicious actors didn’t even try to make the\ncertificate look the least bit legitimate. They decided to leave all the default values for the\nfields describing the certificate receiver. These certificate fields look specific enough and can\nbe used to detect related samples. We used a modified search query to find all Android APK\nfiles signed with a certificate issued to an organizational unit “Organisational Unit” in a\ncompany with the country “Country Code”.\n\n\n-----\n\n**Search based on certificate data**\n\nThis resulted in three new samples. Analyzing these samples with the Titanium Platform\nshowed that all of them had the same “com.android.providers.optimizer” package name\nas the sample provided in the report. We can assume that these are samples of the same\nmalware. Comparing the time when the samples were first seen in the ReversingLabs cloud\nwith the time of validation of the certificates used for signing the APK binaries can give us a\nclue about the evolution of the malware.\n\n**Time relations between malware samples**\n\n## Reversing the sample\n\nThe found samples are obviously older versions of malware, which were analyzed and\ncompared to the version described in the report. A brief static analysis shows that the older\nsamples require a more extensive list of permissions, and that they don’t include the\nlibOptimizer.so file which is, as described in the report, responsible for the generation of the\nAES key. Older versions also don’t include the tmp.tmp resource referenced by the\nmentioned libOptimizer.so file.\n\n\n-----\n\n**Permissions requested by the newer and the older version**\n\nFor a better understanding of the malware’s capabilities, the Dalvik bytecode inside\nclasses.dex file was converted to a corresponding .jar file with the open-source tool Dex2jar.\nThe contents of the .jar file were then decompiled to original Java source code with the Java\nDecompiler. As mentioned in the report where the same procedure was performed, the\ndecompiled output included around 200 classes and almost 600 methods, all with obfuscated\nnames. This obfuscation is performed at the moment when APK files are generated, and is\nmost often done using tools like ProGuard.\n\nWhen analyzing such a big number of generically named methods (method a, b, c…) some\ninteresting functionality can often remain undetected. Finding an older malware sample that\ndidn’t use obfuscation would make the analysis much easier. For some lucky reason, sample\n28fa9354be6ce503ee7c1f7615a26cdd99d7b801 was not obfuscated. This made the\n\n\n-----\n\nanalysis much simpler. The Java source code contained all the original class and method\n\nnames.\n\n**Unobfuscated class files**\n\nComparing source code of the obfuscated and unobfuscated samples shows that the\ncodebase is very similar. Most of the functionalities are identical, and can be easily\nunderstood when looking at unobfuscated code. Probably the best example are the\nobfuscated SMS command codes.\n\n\n-----\n\n**Comparison of obfuscated and unobfuscated commands**\n\nBesides the commands visible in the list, there are a few more quite interesting commands\nthat support the hypothesis that this malware is used for government surveillance purposes,\nand these were not explicitly mentioned in the report. The first one is the ability to take\ncamera photos at login success or failure. This can obviously be used to visually identify any\nperson who tries to use the mobile device. Another typical surveillance feature is highly\nconfigurable audio recording. Recording can be scheduled periodically, or at specific\nmoments, with a configurable recording duration. The malware also enables scheduling a\ndevice boot at some specific moment, ensuring malware activation even when someone\nturns off the phone.\n\nBesides these commands which are common for Android malware, there are a few not so\ncommon ones. The first one is the ability to add a custom WiFi access point and to force the\ndevice to connect to it. This feature was probably introduced to avoid possible detection due\n\n\n-----\n\nto unusual data traffic usage on the target s mobile account. The second one is the ability to\nautomatically answer calls from specific phone numbers. Such a feature can also be used for\naudio tapping, and is probably used when tapping needs to be started urgently and couldn’t\nbe previously scheduled.\n\nThe malware supports receiving commands sent by SMS. In that case, the malware\nintercepts the received SMS and, if it starts with a predefined command header, the malware\naborts further propagation of the SMS_RECEIVED Intent. This prevents the received SMS\nfrom ending up in the default SMS application. The predefined command header is usually\nset to \"opt -cmd\", but is configurable and can be set to different values.\n\n**Receiving commands using SMS messages**\n\nThere is one interesting functionality that isn’t present in the older versions, but is in the\nlatest, and hasn’t been explicitly mentioned in the FBI report. The latest version uses\naccessibility services to get contents of instant messaging applications.\n\n**Code related to monitoring IM applications**\n\n\n-----\n\nLooking at the monitored IM applications additionally proves that this malware is probably\nused for the surveillance of Iranian citizens. One of the monitored IM applications is a\npackage named “org.ir.talaeii”, which is described as “an unofficial Telegram client\ndeveloped in Iran”. The full list of monitored IM applications can be found in the following\ntable:\n\n**List of monitored IM applications**\n\nGenerally, most of the settings are configurable. The initial configuration is provided in the\ncgn.cn resource. Resource contents are encrypted with the AES algorithm. Unlike the latest\nversion which uses the libOptimizer.so file to generate the AES key, older versions use a\nhardcoded key provided inside the binary. It is constructed in the same way as described in\nthe report. The 96-byte base64 string “U3wzfSpoSkBrIys7…” is decoded to a 72-byte key\n\"S|3}*hJ@k#+;!b-F...\", and only the first 16-bytes of the decoded 72-byte key are then used\nfor AES decryption.\n\nWhen analyzing Android binaries, it is always good to take a detailed look at the resources\ncontained in the “res/raw/” folder. This is usually the place for application-specific binaries,\nand malware authors sometimes use it for the same purpose. Unlike the newer version, the\nolder ones have only three raw resources and don’t contain the tmp.tmp resource. The att.cn\nresource usually contains the plaintext “Test” string. The previously mentioned cgn.cn file\ncontains the AES encrypted configuration that includes configuration settings for malware\nfunctionalities, C2 domains, and another AES encryption key that is used to decrypt the last\nraw resource odr.od. This resource contains preconfigured commands that are to be\n\n\n-----\n\nscheduled for execution by the malware.\n\n**Resources contained in the “res/raw/” folder**\n\n## Threat actors\n\nEach malware sample contained a list of C2 domains embedded in their configuration file.\nHistorical domain registration data was searched for each of the extracted domains.\n\n**Resources contained in the “res/raw/” folder**\n\nComparing the domain registration dates with the certificate validation dates extracted from\nthe malicious samples shows that, in some cases, the domains were registered at the time\nwhen the samples were signed (created). In other cases, the domain was registered about a\nyear before the samples were signed. This suggests that the earlier versions of this malware\nreused the domains, and that it was active since the end of 2014. This further suggests that\nolder, and currently undetected, versions of this malware probably exist as well.\n\nLooking at the domain registrant data for the extracted domains reveals more connections to\nIran. [DomainBigData service was used to search WHOIS records for the](https://domainbigdata.com/)\n“whoisdomainpc.com” domain. The records show that this domain was registered by an\n\n\n-----\n\nIranian resident named [redacted.1] using the email address [redacted.1]domain@chmail.ir.\n\n**WHOIS data for whoisdomainpc.com**\n\nThe same person is associated with 7 more domains, including some of the already found\nones. Domains “facedomainpc.com” and “facedomaintv.com” are interesting since they\nfollow the same naming convention ending in *pc.com and *tv.com, and were also registered\non the same date as the domains used in the found malware samples. It is quite possible\nthat all of these domains were used, or were meant to be used, in some kind of a malicious\nactivity.\n\n\n-----\n\n**List of domain names registered by [redacted.1]**\n\nThe list of domains registered by the same email account reveals two more domains\nregistered by the same person. These newly discovered domains were registered 3 days\nbefore the already mentioned ones.\n\n**List of domain names registered by [redacted.1]domain@chmail.ir**\n\nThree more domains were related to the Iranian national, but a different email address was\nused for their registration. Domains “sadostad.com”, “irchemistry.net” and\n**“irchemistry.com” were registered using the [redacted.1]@gmail.com account.**\n\nThe [RiskIQ service was used to search for more email accounts related to the Iranian](https://community.riskiq.com/)\nnational. A very similar account was detected: [redacted.1]@ymail.com. It was also used to\nregister domain names similar to previous ones (sadostad.ir - sadostad.com). Two more,\nprobably related, accounts were also found, and they were used more recently to register\ntwo more domains. Even though no concrete proof can be given to reliably declare these\ndomains malicious, the aforementioned relations should be enough to keep you alert and\n\n\n-----\n\ntreat them as suspicious.\n\n**List of related domain names and email addresses**\n\n[Using one of the Iranian domain name registration services, selva.ir, both the registrant data](https://selva.ir/)\nfor the 100ostad.ir domain and address information of the registrant were found.\n\n**[redacted.1]’s potential addresses**\n\n\n-----\n\nThe second interesting person related to the domains fullplayersoftware.com and\n**“softwareplayertop.com” is [redacted.2] . The domains were registered using the**\n\n**[redacted.2]@gmail.com email account.**\n\n**[redacted.2]’s registration data**\n\n## Conclusion\n\nIt’s important to remember that there are many reasons that cause threat groups to turn their\nfocus to specific targets. Whether it’s political dissidents, opposition in countries under\nauthoritarian regimes, or corporations the threat actors goal is to make gains monetarily or\npolitically. When targeting individuals, threat actors often want to monitor their\ncommunication and movement. Mobile phones are most suitable for such goals because of\nthe computing power contained in your pocket, and the fact that most people carry them all\nthe time. Since the Android platform maintains the biggest part of the global smartphone\nmarket share, it follows that it is also the primary target of mobile malware.\n\nDevelopment environments used in the creation of Android applications are often\npreconfigured to perform obfuscation by default making malicious apps an easy target. Since\nmalware actors very often use the same tools as legitimate developers, malware analysts\nfrequently have to find ways to overcome the obfuscation barriers in order to study how a\nparticular malware works. Finding an older, unobfuscated, version of malware can be an\nexcellent workaround for this problem. Older versions are also very interesting because\nmalware authors often primarily focus on implementing the necessary functionalities before\ntrying to hide clues that can later be used to associate them to the malware.\n\nFortunately, older malware samples can be a real treasure in analysis. Therefore it is always\ngood to search for related samples first - finding an older one can be worth the effort, and\ncan make research much simpler. What we can take away from this analysis is the\nimportance of maintaining control over your device to reduce the risk of infection. On an\nindividual level this includes knowing which apps have access to microphones and sensitive\n\n\n-----\n\ninformation. If you are part of a government agency, or even a private corporation, it means\nhaving a solid BYOD policy, that includes application control, continually auditing the system\nsetting, and malware scanning.\n\nKeep in mind that any person-related data in this blog post should be taken with caution\nsince there is always a possibility that such information is forged or stolen.\n\n## IOC list\n\nThe following links contain the data extracted from the discovered samples related to the\nRana Android malware.\n\n[https://blog.reversinglabs.com/hubfs/Blog/rana_android_malware/IOC_SHA1_list.txt](https://blog.reversinglabs.com/hubfs/Blog/rana_android_malware/IOC_SHA1_list.txt)\n\n[https://blog.reversinglabs.com/hubfs/Blog/rana_android_malware/IOC_C2_list.txt](https://blog.reversinglabs.com/hubfs/Blog/rana_android_malware/IOC_C2_list.txt)\n\nhttps://blog.reversinglabs.com/hubfs/Blog/rana_android_malware/IOC_suspicious_domains.t\nxt\n\n## YARA rule\n\nrule Rana_Android_resources {\nstrings:\n$res1 = \"res/raw/cng.cn\" fullword wide ascii\n$res2 = \"res/raw/att.cn\" fullword wide ascii\n$res3 = \"res/raw/odr.od\" fullword wide ascii\ncondition:\nany of them /* any string in the rule */\n}\n\n### MORE BLOG ARTICLES\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-12-07 - Rana Android Malware Your past catches up, sooner or later....pdf"
    ],
    "report_names": [
        "2020-12-07 - Rana Android Malware Your past catches up, sooner or later....pdf"
    ],
    "threat_actors": [
        {
            "id": "bee22874-f90e-410b-93f3-a2f9b1c2e695",
            "created_at": "2022-10-25T16:07:23.45097Z",
            "updated_at": "2025-03-27T02:02:09.808919Z",
            "deleted_at": null,
            "main_name": "Chafer",
            "aliases": [
                "APT 39",
                "Cobalt Hickman",
                "ITG07",
                "Radio Serpens",
                "Remix Kitten",
                "TA454"
            ],
            "source_name": "ETDA:Chafer",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Antak",
                "CACHEMONEY",
                "EternalBlue",
                "HTTPTunnel",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "MechaFlounder",
                "Metasploit",
                "Mimikatz",
                "NBTscan",
                "NSSM",
                "Non-sucking Service Manager",
                "POWBAT",
                "Plink",
                "PuTTY Link",
                "Rana",
                "Remcom",
                "Remexi",
                "RemoteCommandExecution",
                "SafetyKatz",
                "UltraVNC",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "nbtscan",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "1b3a247f-6186-4482-8b92-c3fb2d767c7d",
            "created_at": "2023-01-06T13:46:38.883911Z",
            "updated_at": "2025-03-27T02:00:02.942724Z",
            "deleted_at": null,
            "main_name": "APT39",
            "aliases": [
                "COBALT HICKMAN",
                "G0087",
                "Radio Serpens",
                "TA454",
                "REMIX KITTEN"
            ],
            "source_name": "MISPGALAXY:APT39",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a761f2a6-26ba-47fd-89c3-6a74f847a3b2",
            "created_at": "2024-05-01T02:03:08.025289Z",
            "updated_at": "2025-03-27T02:05:17.312292Z",
            "deleted_at": null,
            "main_name": "COBALT HICKMAN",
            "aliases": [
                "Chafer ",
                "ITG07 ",
                "APT39 "
            ],
            "source_name": "Secureworks:COBALT HICKMAN",
            "tools": [
                " Mimikatz",
                " Remexi",
                " TREKX",
                "MechaFlounder"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "6b6155e4-94ec-4909-b908-550afe758ad6",
            "created_at": "2022-10-25T15:50:23.365074Z",
            "updated_at": "2025-03-27T02:00:55.455014Z",
            "deleted_at": null,
            "main_name": "APT39",
            "aliases": [
                "APT39",
                "ITG07",
                "Remix Kitten"
            ],
            "source_name": "MITRE:APT39",
            "tools": [
                "NBTscan",
                "MechaFlounder",
                "Remexi",
                "CrackMapExec",
                "pwdump",
                "Mimikatz",
                "Windows Credential Editor",
                "Cadelspy",
                "PsExec",
                "ASPXSpy",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535624,
    "ts_updated_at": 1743041767,
    "ts_creation_date": 1653820672,
    "ts_modification_date": 1653820672,
    "files": {
        "pdf": "https://archive.orkl.eu/ae1e098c2772c05e471b7529e1200b2938638c30.pdf",
        "text": "https://archive.orkl.eu/ae1e098c2772c05e471b7529e1200b2938638c30.txt",
        "img": "https://archive.orkl.eu/ae1e098c2772c05e471b7529e1200b2938638c30.jpg"
    }
}