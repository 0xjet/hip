{
    "id": "f9c2fcb5-8ece-4f60-b854-0b6ed2c8f2c6",
    "created_at": "2023-01-12T15:08:26.608268Z",
    "updated_at": "2025-03-27T02:09:29.808881Z",
    "deleted_at": null,
    "sha1_hash": "4bd49df3a5629ca866512ab0c851fe0c5e783a50",
    "title": "2021-09-21 - Scanning VirusTotal's firehose",
    "authors": "",
    "file_creation_date": "2022-05-28T23:16:11Z",
    "file_modification_date": "2022-05-28T23:16:11Z",
    "file_size": 632728,
    "plain_text": "# Scanning VirusTotal's firehose\n\n**skyblue.team/posts/scanning-virustotal-firehose/**\n\nSep 21, 2021 ¬∑ 584 words ¬∑ 3 minute read\n\nLet‚Äôs say one of your adversaries is known for using a given malware family, custom or offthe shelf. Even if the coverage is biased and limited, samples on VirusTotal (VT) are the lowhanging fruits that keep on giving.\n\nAt $WORK, we are lucky to have access to the [Virus Total feeds/file API. This API endpoint](https://developers.virustotal.com/reference#files-2)\nis the firehose of VirusTotal: it allows downloading each sample submitted to VT in pseudo[real-time. The feed is unfiltered (we are not talking about VT‚Äôs LiveHunt feature) so the](https://support.virustotal.com/hc/en-us/articles/360001315437-Livehunt)\nvolume is HUGE.\n\nWe set the crazy objective to extract and push IOC in real-time for a given malware\n**family submitted to VirusTotal. For this blog post, as an example, we will focus on Cobalt**\nStrike.\n\nThe steps are:\n\n1. Download each sample submitted\n2. Apply Yara rules matching the malware families we are interested in\n3. Automatically extract C2 configuration\n4. Disseminate IOC\n\nInitially, we used our on-premises infrastructure with 2-3 servers. Quickly, the operational\nmaintenance killed us:\n\nOur [Celery cluster was regularly KO.](https://github.com/celery/celery/)\nEverything had to be very carefully tuned (memory limits, batch size, timeout, retries),\nwe were constantly juggling with the balance between completeness, stability, and\nspeed.\nAdding an under-performing Yara rule could break the platform.\nIt was also not a good use of our computing resources as VT‚Äôs activity is not evenly\nspread across the day: our servers were under-used most of the day while overloaded\nduring the peaks.\n\n\n-----\n\n## Going Serverless üîó\n\nTaking a step back, it jumped out at us that this was a textbook example for a Serverless\narchitecture. It was easy to refactor our on-prem code into self-contained functions and glue\nthem together with [Amazon SQS:](https://aws.amazon.com/sqs/)\n\nThe platform has been running smoothly for 18 months, and from an operational point of\nview, we love it:\n\nThe scalability of the platform allowed us to not mind anymore about the performance\nof each rule: we can add our Yara rules quite freely instead of cherry-picking and\nevaluating carefully each addition.\nSQS handles the whole retry mechanism.\nAdding a new dissector is as easy as plugging a new Lambda function to the Amazon\nSimple Notification Service (SNS) topic.\nEverything is decoupled, it is easy to update one part without touching the rest.\nEach new release of libyara increases its performance and it is directly correlated to\nthe execution duration‚Äôs average.\n[Everything is instrumented, we learned to love the AWS Monitoring Console.](https://aws.amazon.com/console/)\n\n## Performance Stats üîó\n\nFor those who like numbers, here is a screenshot of the activity of the last 6 months:\n\n\n-----\n\nOn average:\n\nA batch of samples is scanned in less than 30s\nThere are always 45 Lambda functions running at any given time\n97% of the executions are successful\nWe send 150 samples per minute (before deduplication) to dissectors\n\n## CobaltStrike üîó\n\n[We are using CobaltStrikeParser from](https://github.com/Sentinel-One/CobaltStrikeParser) [Sentinel One to parse the beacons, then we are](https://www.sentinelone.com/)\nsending the JSON output to our Splunk instance.\n\nThere are two uses of this data:\n\nThreat Hunting: tracking some Threat Actors\nProactive protection: adding proactively the IOC to a watchlist in our scope\n\nFor Threat Hunting perspectives, we implement alerting for things like:\n\nSpecific watermark identifiers\nPatterns in the C2 domain\nNon-standard values for some fields\nUse of some options or specific malleable profile\n\nRegarding proactive Defense, there is currently no automatic pipeline to push the IOC into a\nWatchList/DenyList for one reason: it is not uncommon to see trolling BEACONs using\nlegitimate and ‚Äúassumed safe‚Äù domains. To mitigate that, we plan to have a kind of\nSlack/Mattermost bot that will make us approve each entry seamlessly.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-21 - Scanning VirusTotal's firehose.pdf"
    ],
    "report_names": [
        "2021-09-21 - Scanning VirusTotal's firehose.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536106,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1653779771,
    "ts_modification_date": 1653779771,
    "files": {
        "pdf": "https://archive.orkl.eu/4bd49df3a5629ca866512ab0c851fe0c5e783a50.pdf",
        "text": "https://archive.orkl.eu/4bd49df3a5629ca866512ab0c851fe0c5e783a50.txt",
        "img": "https://archive.orkl.eu/4bd49df3a5629ca866512ab0c851fe0c5e783a50.jpg"
    }
}