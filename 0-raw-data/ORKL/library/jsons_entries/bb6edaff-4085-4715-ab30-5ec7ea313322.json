{
    "id": "bb6edaff-4085-4715-ab30-5ec7ea313322",
    "created_at": "2023-01-12T15:08:44.016874Z",
    "updated_at": "2025-03-27T02:05:52.608684Z",
    "deleted_at": null,
    "sha1_hash": "6a49b2f0bc946d7344722d461f52fe8c41f81d5f",
    "title": "2021-10-27 - Code similarity analysis with r2diaphora",
    "authors": "",
    "file_creation_date": "2022-05-27T23:23:29Z",
    "file_modification_date": "2022-05-27T23:23:29Z",
    "file_size": 753331,
    "plain_text": "# Code similarity analysis with r2diaphora\n\n**[cybersecurity.att.com/blogs/labs-research/code-similarity-analysis-with-r2diaphora](https://cybersecurity.att.com/blogs/labs-research/code-similarity-analysis-with-r2diaphora)**\n\n[1. AT&T Cybersecurity](https://cybersecurity.att.com/)\n[2. Blog](https://cybersecurity.att.com/blogs)\n\nOctober 27, 2021 | [Fernando Dominguez](https://cybersecurity.att.com/blogs/author/fernando-dominguez)\n\n## Executive summary\n\n[Binary diffing, a technique for comparing binaries, can be a powerful tool to facilitate malware](https://medium.com/malware-buddy/reverse-engineering-tips-binary-diffing-17760bd89f39)\nanalysis and perform malware family attribution. This blog post describes how AT&T Alien\nLabs is leveraging binary diffing and code analysis to reduce reverse-engineering time and\ngenerate threat intelligence.\n\nUsing binary diffing for analysis is particularly effective in the IoT malware world, as most\nmalware threats are variants of open-source malware families produced by a wide range of\nthreat actors. Generating and maintaining static signatures for variations on IoT malware is\ntedious, as the assembly code often changes across variants and architectures and text\nstrings are subject to modification. For this reason, AT&T Alien Labs created a new opensource tool, r2diaphora, to port Diaphora as a plugin for Radare2, and included some use\ncases in this blog.\n\n## What is binary diffing?\n\n\n-----\n\nBinary diffing (or program diffing) is a process where two files are compared at instruction\nlevel, looking for differences in code. Threat actors can easily transform the assembly code\nfor a program without modifying its actual behaviour, so the typical “line-by-line” diffing is not\ngood enough when looking at malware - a more advanced approach is needed.\n\n[There are several binary diffing tools publicly available, such as Diaphora,](https://github.com/joxeankoret/diaphora) [BinDiff, and](https://www.zynamics.com/bindiff.html)\n[DarunGrim. Alien Labs is using Diaphora, as we believe it is the most advanced of all the](http://www.darungrim.org/)\navailable options. Furthermore, Diaphora has the added benefit of being open source,\nallowing Alien Labs to modify it for our needs.\n\n## How can binary diffing be employed to identify malware?\n\nDiaphora works by analyzing each function present in the binary and extracting a set of\nfeatures from each analyzed function. These features are later used to compare functions\nacross binaries and find matches. If instead of directly comparing features, we leverage them\nto build a database of malicious functions (indicators) for identification purposes, we can then\nbegin analyzing incoming binaries and try to find matches amongst their functions when\ncomparing to the indicator database.\n\nIf enough matches are found in the analyzed binaries, we can safely assume the analyzed\nsample is a malware sample. We can also note which malware family the functions belong to\nin the indicator database, thus obtaining family attribution for the analyzed samples.\n\n## Porting Diaphora to Radare2\n\nDiaphora works as an IDA Pro plugin. In order to work, it needs a valid IDA license and,\nconsequently, valid Hex-Rays licenses for each CPU architecture you may want to\ndecompile. As this cost of these licenses is quite high, Alien Labs looked for a cheaper\nalternative, so the community could leverage it.\n\n[As such, we decided to port the existing Diaphora to the Radare2 disassembly framework.](https://github.com/radareorg/radare2)\n[The ported version of Diaphora, named r2diaphora, is also open source and available here.](https://github.com/FernandoDoming/r2diaphora)\n\nRadare2 (r2) is an open-source disassembly framework that supports a very wide range of\nCPU architectures. It also bundles a capable decompiler and supports the Ghidra decompiler\nas a plugin. As such, r2 is well suited for our objective of porting Diaphora to an open-source\ndisassembler.\n\nAdditional changes made to the original Diaphora included swapping the SQLite3 databases\nfor MySQL. This change was performed for the malware attribution process described\npreviously, as more than one analyst would be writing to the indicator database. With\nmultiple analysts writing to the database, the SQLite database would need to be shared\n\n\n-----\n\nacross team members and allow parallel write/read operations. SQLite databases are not\nmade for this kind of usage, so the Alien Labs team swapped it for another database engine\nbetter designed for the task.\n\n## Installation\n\nAs r2diaphora uses Radare2 and MySQL they need to be set-up prior to its usage. Radare2\nshould be installed locally, while the MySQL server can be remote or local. Once the\nenvironment is set up you can install it with pip install r2diaphora. This pip package installs\nthree command line utilities: r2diaphora, r2diaphora-db and r2diaphora-bulk.\n\nr2diaphora: The main command line utility, analyzes and compares files.\nr2diaphora-db: Performs database management and configuration.\nr2diaphora-bulk: Analyzes binaries in batches.\n\nFurther usage options can be obtained with the -h / --help command line option in each of\nthem.\n\nOnce the pip package is successfully installed you can input your database credentials with\nr2diaphora-db config -u -p -hs . If you are using bash or a similar shell and do not want your\ndatabase password to be saved in the shell history, precede the command with a space.\n\nFinally, if you want to use the r2ghidra decompiler, install it with the r2pm -ci r2ghidra\ncommand, if it is not installed already.\n\n## Usage\n\nAs stated previously, r2ghidra lists all available options if executed with the -h flag. Currently,\nthey are the following:\n\nAs an example, we can execute r2diaphora on some test IoT samples. You can find file\nhashes in the Associated Indicators appendix.\n\n\n-----\n\nFirst test - comparing to Sakura (a Gafgyt variant) samples with the same architecture:\n\nr2diaphora 562b4c9a40f9c88ab84ac4ffd0deacd219595ab83ed23a458c5f492594a3a7ef\n770363f9fd334c3f3c4ba0e05a2a0d4701f56a629b09365dfe874b2a277f4416\n\nFigure 1. r2diaphora output for Sakura samples with the same architecture.\n\nObserve how r2diaphora could identify the similarities between the two files. The system\nmanaged to find 40 matches out of 56 possible (71%). Furthermore, the similarity ratios for\nthe matched functions are close to 1.0, indicating a very close resemblance in the matched\nfunctions. Additionally, the results point towards true positive matches since the matched\nfunctions have the same name and number of basic blocks.\n\nSecond test - comparing Sakura samples with different architectures:\n\nr2diaphora 17c62e0cf77dc4341809afceb1c8395d67ca75b2a2c020bddf39cca629222161\n6ce1739788b286cc539a9f24ef8c6488e11f42606189a7aa267742db90f7b18d\n\n\n-----\n\nFigure 2. r2diaphora output for Sakura samples with different architecture.\n\nIn this case, we see how the number of matches has decreased from the previous test. This\nwas expected as it is harder to match functions across different architectures. The similarity\nratios have also decreased as the assembly code differs in all the compared functions. Still,\nr2diaphora recognized many similarities between both samples and identified correct\nmatches across the compared files.\n\nThird test - comparing a Sakura sample to a Yakuza (another Gafgyt variant) sample, both\nsamples having different architectures:\n\n$ r2diaphora\nsakura/594a6b2c1e9beac3ad5f84458b71c1b7ec05ee0239808c9a63bc901040e413a3\nyakuza/91392f5dbbfd4ad142956983208a484b91ac5e84c4f9a9fcb530a9b085644c93\n\n\n-----\n\nFigure 3. r2diaphora output for Sakura and Yakuza samples with different architecture.\n\nIn this case, observe how the number of matches have decreased even further while the\nratios have been maintained mostly steady. This is due to the samples being different\nvariants that perform different modifications over the base Gafgyt source code.\n\nIt is also notable that the processCmd function has been able to be matched with a low ratio.\nprocessCmd is the function that parses the received commands from the Command &\nControl server. The low ratio in this match is due to the variants being able to handle different\ncommands, hence their implementation being different. However, the system was able to\nmatch it due to a common constant present in both functions.\n\n## Conclusion\n\nCode similarity analysis is a powerful tool that can be leveraged to identify and attribute\nmalware. While not flawless, program diffing can bypass many of the weaknesses of static\nsignatures and thus could be used in conjunction with traditional detection methods to build a\nmore robust detection pipeline.\n\n## Appendix\n\n### Associated Indicators (IOCs)\n\n\n-----\n\nTYPE INDICATOR DESCRIPTION\n\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\n```\n132948bef56cc5b4d0e435f33e26632264d27ce7d61eba85cf3830fdf7c\nb8056\n136dbd3cfa947f286b972af1e389b2a44138c0013aa8060d20c247b6bcf\ndd88c\n17c62e0cf77dc4341809afceb1c8395d67ca75b2a2c020bddf39cca6292\n22161\n19e0f329b5d8689b14d901b9b65c8d4fb28016360f45b3dfcec17e8340e\n6411e\n4cc11ffb3681ebced1f9d88e71b70a87e6d4498abca823245c118afead6\n7b6a5\n562b4c9a40f9c88ab84ac4ffd0deacd219595ab83ed23a458c5f492594a\n3a7ef\n594a6b2c1e9beac3ad5f84458b71c1b7ec05ee0239808c9a63bc901040e\n413a3\n5fec87479a8d2fa7f0ed7c8f6ba76eeea9e86c45123173d2230149a55dc\nd760d\n603d14671f97d12db879cc1c7cd6abfa278bf46431ac73aeb6b3a4c4c2b\n16b9f\n\n```\n\nSakura\nsample, Arch:\nARM, EABI4\n\nSakura\nsample, Arch:\nIntel 80386\n\nSakura\nsample, Arch:\nARM, EABI4\n\nSakura\nsample, Arch:\nMotorola m68k\n\nSakura\nsample, Arch:\nMIPS, MIPS-I\nversion 1\n\nSakura\nsample, Arch:\nARM, EABI4\n\nSakura\nsample, Arch:\nx86-64\n\nSakura\nsample, Arch:\nMIPS, MIPS-I\nversion 1\n\nSakura\nsample, Arch:\nx86-64\n\n\n-----\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\n```\n6b128a64a497eb123f03b77ef45e99e856282dc9620dc26ab38998627a8\nf3216\n6ce1739788b286cc539a9f24ef8c6488e11f42606189a7aa267742db90f\n7b18d\n770363f9fd334c3f3c4ba0e05a2a0d4701f56a629b09365dfe874b2a277\nf4416\n7c8ba5f88b1c4689a64652f0b8f5e3922e83f9f73c7e165f3213de27c5f\nb4d05\n8090c3a1a930849df42f7f796d42e0211344e709a5ac15c2b4aca8ca41d\ne2cd3\n94a279397b8c19ec7def169884a096d4f85ce0e21ff9df0be3ce264ef45\n65ea7\n96bb3e5209e083544ea6a78bc6fc4ebc456e135a786d747718d936af3b0\n63298\na079dfd60b55a7d74dd32d49a984bea43665b8b225beceae5b272944889\n217f6\nb6c2f02b1bed62a6b845d5f13d9003f5aa3f6d0da3e62fa48d982287245\n3de10\ncef15aa60dc2c09fe117e37e07399f0ef89dca9f930ce13ac1e29f8cf63\nd9a31\n\n```\n\nSakura\nsample, Arch:\nRenesas SH\n\nSakura\nsample, Arch:\nIntel 80386\n\nSakura\nsample, Arch:\nARM, version 1\n\nSakura\nsample, Arch:\nPowerPC\n\nSakura\nsample, Arch:\nIntel 80386\n\nSakura\nsample, Arch:\nx86-64\n\nSakura\nsample, Arch:\nARM, EABI4\n\nSakura\nsample, Arch:\nMIPS, MIPS-I\nversion 1\n\nSakura\nsample, Arch:\nRenesas SH\n\nSakura\nsample, Arch:\nMotorola m68k\n\n\n-----\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\nSHA256\n\n```\ne984334bbdd1179aadbde949f7c1b0fb02b6c18cb4a56d146150853b18a\ndfa79\n2858982408bf1664b622e830ad83b871749608a7533e94672153ff90caa\n658a9\n2b7262cae9e192fa7921f3ec02e0f924b32de3d418842fdad9a51603589\na54c7\n2faf7437c769abd92347d6f0a77f001523ec41c02d2bf12e3cebf5b9504\n57ba3\n4fc23e8409becb028997c2f0f2041e2dc853018b71e009e3d66f33876d5\nd4e99\n6554d5edb401e2def2ef9fbb82b591351d3c8261ce0a20c431470f1c68f\na3aea\n8005db9431013f094a2114046679ab971e62a8776639d6c2903fcc5d2fe\n8065c\n91392f5dbbfd4ad142956983208a484b91ac5e84c4f9a9fcb530a9b0856\n44c93\nb8aadb66183196868a9ff20bebd9c289fbfe2985fb409743bb0d0fea513\ne9caf\nd4f223fc5944bc06e12c675f0664509eeab527abc03cdd8c2fbd43947cc\n6cbab\n\n```\n\nSakura\nsample, Arch:\nMIPS, MIPS-I\nversion 1\n\nYakuza\nsample, Arch:\nARM, EABI4\n\nYakuza\nsample, Arch:\nIntel 80386\n\nYakuza\nsample, Arch:\nIntel 80386\n\nYakuza\nsample, Arch:\nRenesas SH\n\nYakuza\nsample, Arch:\nARM, version 1\n\nYakuza\nsample, Arch:\nx86-64\n\nYakuza\nsample, Arch:\nARM, version 1\n\nYakuza\nsample, Arch:\nARM, EABI4\n\nYakuza\nsample, Arch:\nARM, version 1\n\n\n-----\n\nSHA256\n```\n       f64b5f6dd7f222b7568bba9e05caa52f9e4186f9ba4856c8bf1274f4c77\n       c653c\n\n### Share this with others\n\n```\nTags: [alien labs,](https://cybersecurity.att.com/blogs/tag/alien+labs) [code analysis,](https://cybersecurity.att.com/blogs/tag/code+analysis) [r2diaphora](https://cybersecurity.att.com/blogs/tag/r2diaphora)\n\n\nYakuza\nsample, Arch:\nIntel 80386\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-10-27 - Code similarity analysis with r2diaphora.pdf"
    ],
    "report_names": [
        "2021-10-27 - Code similarity analysis with r2diaphora.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536124,
    "ts_updated_at": 1743041152,
    "ts_creation_date": 1653693809,
    "ts_modification_date": 1653693809,
    "files": {
        "pdf": "https://archive.orkl.eu/6a49b2f0bc946d7344722d461f52fe8c41f81d5f.pdf",
        "text": "https://archive.orkl.eu/6a49b2f0bc946d7344722d461f52fe8c41f81d5f.txt",
        "img": "https://archive.orkl.eu/6a49b2f0bc946d7344722d461f52fe8c41f81d5f.jpg"
    }
}