{
    "id": "4e4c6c57-4321-4205-ac49-b71b93b5a8e6",
    "created_at": "2022-10-25T16:48:21.070369Z",
    "updated_at": "2025-03-27T02:07:59.965292Z",
    "deleted_at": null,
    "sha1_hash": "4f33fcabf16fda51ae4e7eb435f55378a19e0e2d",
    "title": "",
    "authors": "",
    "file_creation_date": "2022-02-18T02:21:23Z",
    "file_modification_date": "2022-02-18T02:21:23Z",
    "file_size": 3761152,
    "plain_text": "## A Method for Decrypting Data Infected with Hive Ransomware\n\n#### Giyoon Kim[1][a], Soram Kim[1][a], Soojin Kang[1][a], and Jongsung Kim [∗a,b]\n\naDept. of Financial Information Security, Kookmin University,77 Jeongneung-Ro,\n_Seongbuk-Gu, Seoul, 02707, Korea_\nbDept. of Information Security, Cryptology, and Mathematics, Kookmin University,77\n_Jeongneung-Ro, Seongbuk-Gu, Seoul, 02707, Korea_\n\n\n#### February 18, 2022\n\n\n**Abstract**\nAmong the many types of malicious codes, ransomware poses a major threat. Ransomware encrypts data and demands a ransom in exchange for decryption. As data recovery is impossible if the encryption\nkey is not obtained, some companies suffer from considerable damage,\nsuch as the payment of huge amounts of money or the loss of important\ndata. In this paper, we analyzed Hive ransomware, which appeared in\nJune 2021. Hive ransomware has caused immense harm, leading the\nFBI to issue an alert about it. To minimize the damage caused by\nHive Ransomware and to help victims recover their files, we analyzed\nHive Ransomware and studied recovery methods. By analyzing the encryption process of Hive ransomware, we confirmed that vulnerabilities\nexist by using their own encryption algorithm. We have recovered the\nmaster key for generating the file encryption key partially, to enable\nthe decryption of data encrypted by Hive ransomware. We recovered\n95% of the master key without the attacker’s RSA private key and\ndecrypted the actual infected data. To the best of our knowledge, this\nis the first successful attempt at decrypting Hive ransomware. It is expected that our method can be used to reduce the damage caused by\nHive ransomware.\n\n### 1 Introduction\n\n\n∗Corresponding author\n1 These authors contributed equally to this work.\nEmail addresses : gi0412@kookmin.ac.kr (Giyoon Kim), kimsr2040@kookmin.ac.kr (Soram\nKim), szin31@kookmin.ac.kr (Soojin Kang), jskim@kookmin.ac.kr (Jongsung Kim)\n[URL: https://dfnc.kookmin.ac.kr](https://dfnc.kookmin.ac.kr)\n\n\n-----\n\n-----\n\n-----\n\n### 2 Related Work\n\nmain target of the ransomware [?]. Scaife et al. proposed an early warning\n\n\n-----\n\n-----\n\n### 3 Hive ransomware analysis\n\n#### 3.1 Encryption process\n\n**Generating a master key**\n\n**Encrypting the master key**\n\n\n-----\n\nsomware has administrator privileges, it is stored in C:\\\\; if not, it is stored\nin C:\\Users\\<User_name>\\AppData\\Local\\VirtualStore. The filename\nof the encrypted master key is base64url_encoded_string.key.hive. The en\n**Terminating specific processes and services**\n\n**Creating batch files**\n\n**Creating ransom notes**\neach directory with the file name HOW_TO_DECRYPT.txt. The ransom\n\n**Encrypting files**\nfiles, executables, and files stored in C:\\Users\\Windows via an encryption\nprocess with ten threads in parallel. However, C:\\Users\\Program File\n```\ns(x86), C:\\Users\\Program Files, and C:\\Users\\ProgramData paths\n\n```\n\n-----\n\nin C:\\Users\\Program Files(x86), C:\\Users\\Program Files, and C:\n```\n\\Users\\ProgramData are encrypted. If not, the files in C:\\Users\\Progr\nam Files(x86), C:\\Users\\Program Files, and the C:\\Users\\ProgramData\n\n```\npath are stored in C:\\Users\\<User_name>\\AppData\\Local\\VirtualStore\n\n**Destroying the master key**\n\n**Cleaning disk**\ningless data in C:\\\\ or C:\\Users\\<User_name>\\AppData\\Local\\VirtualSt\n```\nore until the hard disk is full.This makes it impossible to restore encrypted\n\n#### 3.2 File encryption process\n\n```\nHive ransomware generates a data encryption keystream (EKS) that\nappears random for each file, and encrypts the file by XORing EKS with\nthe file. However, EKS is created using two keystreams extracted from the\n\n**Extracting two keystreams from the master key**\n\n\n-----\n\n  - Keystream1 offset (SP1) : R1 % 0x900000\n\n  - Keystream2 offset (SP2) : R2 % 0x9FFC00\n\nin filename in the little-endian format after encoding with base64url. The file\nname is generated using the following rule: Original Filename.base64url(MD5(Encrypted_master_key)\n\n**Encrypting a file**\n\n  - Encrypted data[i]← Data[i] [�] Keystream1[i%0x100000] [�] Keystream2[i%0x400]\n\n  - EKS[i]← Keystream1[i] [�] Keystream2[i%0x400] (i← 0,1,· · ·,0xFFFFF)\n\n  - Encrypted data← Data[offset] [�] _EKS[offset%0x100000]_\n\na certain amount. The non-encrypted data block size (NBS) that the offset\n\n\n-----\n\n_T = (FS ≫_ 12)\n\n_T =_ [((][FS][≫]100[12)][×][30)]\n\n_T =_ [((][FS][≫]100[12)][×][20)] _NBS =_ _[FS][−]T[(]−[T]_ _[≪]1_ [12)]\n\n\n_T =_ [((][FS][≫]100[12)][×][10)]\n\n_T =_ [((][FS][≫]100[12)][×][5)]\n\n\n_T =_ [((][FS][≫]100[12)][×][1)] 2620≤\n\nblock (NBS bytes) appear alternately, as depicted in Fig. 6. However, in\n\n**Example of Hive ransomware infection**\n\nthen SP1 and SP2 become 0x667926 and 0x24f5b6. EKS is created with two\n\nBy the Table 3, NBS becomes 0x24f5b6, so 0x1000 bytes encryption and\n\nof ‘test.jpg’. According to the filename rule (base64url(MD5(Encrypted_master_key)∥R1∥R2)),\n\n\n-----\n\n### 4 Hive ransomware decryption methodology\n\nto generate an EKS, and EKS encrypts the data using XOR. EKS looks\nrandom, but the keystream to generate EKS is partially reused when en\nthe algorithm that generates EKS is also XOR; therefore, it becomes easy to\n\nthe original and the encrypted file we can obtain the EKS.\nIt is also possible to determine the EKS without the original unencrypted\n\n#### 4.1 Method for restoring the Hive ransomware master key\n\ncollecting as many as possible fragmented EKS satisfying at least one of\nthe two conditions. If either of the two conditions is satisfied, the EKS can\n\n - SP1← Keystream1 start offset (R1 % 0x900000)\n\n - SP2← Keystream2 start offset (R2 % 0x9FFC00)\n\n\n-----\n\n  - Keystream1← Encryption_key[SP1 : SP1+0x100000]\n\n  - Keystream2← Encryption_key[SP2 : SP2+0x400]\n\n  - EKS[i]← Keystream1[i] [�] Keystream2[i%0x400] (i← 0,1,· · ·,0xFFFFF)\n\n  - Encrypted data← Data[offset] [�] _EKS[offset%0x100000]_\n\nAs can be seen from the core encryption algorithm, the EKS is generated\n\nwith Keystream1. The EKS is generated as two keystreams, but these are\n\nof continuous EKS using the original file and the infected file is the same\n\nFigure 7: Process of the set separation of equations obtained from EKS\n\nis, if one EKS is used, a maximum value of 1,025 bytes of the master key\n\nfrom among 1,025 bytes to generate the EKS, the byte guessed by XOR\nis removed, and using this approach, we can generated the EKSs that are\n\n  - Keystream1[SP1 + 1] [�] Keystream2[SP2 + 1] = 0x80\n\n_⇐⇒_ Keystream1[SP1 + 1] = Keystream2[SP2 + 1] [�] 0x80\n\n  - Keystream1[SP1 + 0x401] [�] Keystream2[SP2 + 1] = 0x88\n\n_⇐⇒_ Keystream1[SP1 + 1] = Keystream2[SP2 + 1] [�] 0x88\n\n  - Keystream1[SP1 + 1] [�] Keystream1[SP1 + 0x401] = 0x08\n\n\n-----\n\nThe amount of data that can be guessed from one set of 1MiB EKS is\n1,025 bytes. Now consider the case of two sets. When generating an EKS by\n\ndent equations x1 � _y1 =0x80, x2_ � _y2 =0x88 are obtained through EKS._\nAnd suppose that the actual value was x1 =0xFF, y1 =0x7F, x2 =0x23, y2 =0xAB.\nIf we want to know the value of x1 � _x2, we have to know the correct y1_ � _y2_\nvalue. Failure to find the correct y1 � _y2 results in the equation becoming_\n\nthat cannot be generated from the EKS. When the correct equation is found,\nthe two sets are chained to form one large set. Finally, it takes (n − 1) × 256\n\n_n. As a result of our experiment, the number of independent sets n was 1_\nwhen a large number of EKS were collected. It was possible to recover a\n\nNext, consider the case in which the EKS is obtained from two encrypted\n\namong Keystreams for generating EKS1 and EKS2 (Fig. 9). This problem\n\nmore EKS obtained, the more the number of master key recovered at once\n\n\n-----\n\n**Algorithm 1 Calculation of the non-encrypted data block size**\n**Require: File_Size**\n**Ensure: non-encrypted data block size NBS**\n```\n FS ← File_Size\n NBS ← 0\n\n```\n**if FS ≤** `0x1000 then return NBS`\n**else if FS < 0x20000 then**\n```\n  R← FS ≫ 12\n\n```\n**else if FS < 0x100000 then**\n```\n  R← ((FS ≫ 12)*30)/100\n\n```\n**else if FS < 0xA00000 then**\n```\n  R← ((FS ≫ 12)*20)/100\n\n```\n**else if FS < 0x6400000 then**\n```\n  R← ((FS ≫ 12)*10)/100\n\n```\n**else if FS < 0x40000000 then**\n```\n  R← ((FS ≫ 12)*5)/100\n\n```\n**else**\n```\n  R← ((FS ≫ 12)*1)/100\n\n```\n**end if**\n**if R == 1 then return NBS**\n**end if**\n```\n NBS ← (FS-(R ≪ 12))/(R-1)\n\n```\n**return NBS**\n\n\n-----\n\n**Algorithm 2 Calculation of the start offsets of Keystream1 and Keystream2**\n**Require: Infected file name**\n**Ensure: Keystream offset SP1, SP2**\n```\n R ← base64urldecode(Filename)[16:]\n\n```\n`R1 ←` `byte to int64(R[:8])` _▷little endian_\n`R2 ←` `byte to int64(R[8:])` _▷little endian_\n```\n SP1 ← R1%0x900000\n SP2 ← R2%0x9FFC00\n\n```\n**Algorithm 3 Hive ransomware master key recovery**\n**Require: Infected files, Original files**\n**Ensure: Recovered Hive Ransomware master key**\n\n_▷Extract to equations using original file and infected file_\n**for IF, OF in (Infected files, Original files) do**\n\n`NBS ←` `calc_NBS(IF.size)` _▷Using algorithm 1_\n`SP1, SP2 ←` `calc_offset(IF.name)` _▷Using algorithm 2_\n```\n  iter ← IF.size/(0x1000+NBS)\n  offset=0\n  EQS ← set()\n\n```\n**for i ←** `0 · · · iter do`\n\n**if i==iter then**\n\n`offset ←` `final encryption block offset` _▷See_\n```\n Section 3\n\n```\n**end if**\n**for j ←** `0 · · · 0xFFF do`\n```\n     O1 ← offset%0x100000\n     O2 ← offset%0x1000\n     EQS.add(SP1+O1, SP2+O2, IF[offset][�] OF[offset])\n\n```\n_▷IF[offset][�]_ `OF[offset] == byte of EKS`\n```\n     offset+=1\n\n```\n**end for**\n```\n    offset+=NBS\n\n```\n**end for**\n**end for**\n\n_▷Extract equation end_\n```\n EK ← [None]×0xA00000\n\n```\n$\n`E` _←−_ `EQS`\n$\n`EK[E[0]]` _←−_ `{0· · · 255}`\n```\n EQS ← tuple(EQS)\n\n```\n\n-----\n\n**while Until the EQS size does not change do**\n\n**for EQ in EQS do**\n\n**if (EK[EQ[0]] == None) and (EK[EQ[1]] == None) then**\n\n**Continue**\n**else if (EK[EQ[0]] != None) and (EK[EQ[1]] == None) then**\n\n`EK[EQ[1]] = EK[EQ[0]]` [�] `EK[EQ[2]]`\n**else if (EK[EQ[0]] == None) and (EK[EQ[1]] != None) then**\n\n`EK[EQ[0]] = EK[EQ[1]]` [�] `EK[EQ[2]]`\n**else if (EK[EQ[0]] != None) and (EK[EQ[1]] != None) then**\n```\n     EQS.pop(EQ)\n\n```\n**end if**\n**end for**\n**end while**\n\n#### 4.2 Experiments\n\nfiles were less than 500KB. When we collected EKS from files larger than\n\ntimes, that is, the amount of EKS that can be collected, varies according to\nthe file size (cf. Table 3). The number of EKS that can be collected varies\ndepending on the NBS; the smaller the file size, the smaller the amount of\n_EKS that can be collected. Generally, the larger the file size, the larger the_\namount of EKS we can collected, but in some cases the amount of the EKS\n\n\n-----\n\n(± 5KB)\n\n(± 15KB)\n\n(± 5KB)\n\n(± 100KB)\n\n(± 100KB)\n\n(± 100KB)\n\nacquire EKS when using files larger than 0x280A000 bytes. Figure 10 shows\nthe available EKS by file size.\n\n\n-----\n\nof NBS, and found that more effective master key recovery was possible\n\nrecovered master key. We infected 50,000 files and collected EKS by using 50\nfiles of 40MB size. The master key was recovered through the collected EKS\n\nthe case of partial success, additional collection of EKS is possible and help\n\n\n-----\n\n### 5 Conclusions\n\n Acknowledgement\n\n References\n\n[[2] 2020 Vulnerability and Threat Trends Report, https://lp.skyboxs](https://lp.skyboxsecurity.com/WICD-2020-07-WW-VT-Trends_Asset.html)\n```\n  ecurity.com/WICD-2020-07-WW-VT-Trends_Asset.html, accessed:\n\n```\n\n-----\n\n[ransomware, https://www.zdnet.fr/actualites/hopital-de-dax-t](https://www.zdnet.fr/actualites/hopital-de-dax-totalement-bloque-twitter-ultime-recours-face-au-ransomware-39917771.htm)\n```\n  otalement-bloque-twitter-ultime-recours-face-au-ransomware\n  -39917771.htm, accessed: 20-Dec-2021.\n\n```\n[[5] UnitingCare Queensland hit by cyber attack, https://www.computer](https://www.computerweekly.com/news/252499835/UnitingCare-Queensland-hit-by-cyber-attack)\n```\n  weekly.com/news/252499835/UnitingCare-Queensland-hit-by-cy\n  ber-attack, accessed: 20-Dec-2021.\n\n```\n[[6] Health care giant Scripps Health hit by ransomware attack, https:](https://www.bleepingcomputer.com/news/security/health-care-giant-scripps-health-hit-by-ransomware-attack/)\n```\n  //www.bleepingcomputer.com/news/security/health-care-giant\n  -scripps-health-hit-by-ransomware-attack/, accessed: 20-Dec\n```\n[[7] Ireland’s Health Services hit with $20 million ransomware demand, ht](https://www.bleepingcomputer.com/news/security/irelands-health-services-hit-with-20-million-ransomware-demand/)\n```\n  tps://www.bleepingcomputer.com/news/security/irelands-heal\n  th-services-hit-with-20-million-ransomware-demand/, accessed:\n\n```\n[[8] Dutch supermarkets run out of cheese after ransomware attack, https:](https://www.bleepingcomputer.com/news/security/dutch-supermarkets-run-out-of-cheese-after-ransomware-attack/)\n```\n  //www.bleepingcomputer.com/news/security/dutch-supermark\n  ets-run-out-of-cheese-after-ransomware-attack/, accessed:\n  https://www.bleepingcomputer.com/news/security/jbs-paid-11\n  -million-to-revil-ransomware-225m-first-demanded/, accessed:\n\n```\n[[10] Colonial Pipeline paid $5 million ransom to hackers, https://www.cn](https://www.cnbc.com/2021/05/13/colonial-pipeline-paid-ransom-to-hackers-source-says.html)\n```\n  bc.com/2021/05/13/colonial-pipeline-paid-ransom-to-hackers\n  -source-says.html, accessed: 20-Dec-2021.\n\n```\n[[11] RANSOMWARE ACTION PLAN, https://www.homeaffairs.gov.](https://www.homeaffairs.gov.au/cyber-security-subsite/files/ransomware-action-plan.pdf)\n```\n  au/cyber-security-subsite/files/ransomware-action-plan.pdf,\n\n```\n[[12] Ransomware: How to prevent and recover (ITSAP.00.099), https://cy](https://cyber.gc.ca/en/guidance/ransomware-how-prevent-and-recover-itsap00099)\n```\n  ber.gc.ca/en/guidance/ransomware-how-prevent-and-recover-i\n  tsap00099, accessed: 20-Dec-2021.\n\n```\n[[13] Ransomware Awareness for Holidays and Weekends, https://us-cer](https://us-cert.cisa.gov/ncas/alerts/aa21-243a)\n```\n  t.cisa.gov/ncas/alerts/aa21-243a, accessed: 20-Dec-2021.\n\n```\n\n-----\n\n[[14] Indicators of Compromise Associated with Hive Ransomware, https:](https://www.documentcloud.org/documents/21049431-fbi-flash-hiveꠓransomware-iocs)\n```\n  //www.documentcloud.org/documents/21049431-fbi-flash-hiv\n  eêăŞransomware-iocs, accessed: 20-Dec-2021.\n\n```\n[months, https://www.bleepingcomputer.com/news/security/h](https://www.bleepingcomputer.com/news/security/hive-ransomware-enters-big-league-with-hundreds-breached-in-four-months/)\n```\n  ive-ransomware-enters-big-league-with-hundreds-breached-in\n  -four-months/, accessed: 20-Dec-2021.\n\n```\n[[16] New ransomware group Hive leaks Altus group sample files, https:](https://cybernews.com/news/new-ransomware-group-hive-leaks-altus-group-sample-files/)\n```\n  //cybernews.com/news/new-ransomware-group-hive-leaks-altus\n  -group-sample-files/, accessed: 20-Dec-2021.\n  https://www.bleepingcomputer.com/news/security/hive-ransom\n  ware-attacks-memorial-health-system-steals-patient-data/,\n\n```\n[[18] Hive ransomware group attacks Missouri health center, https://www.](https://www.healthcareitnews.com/news/hive-ransomware-group-attacks-missouri-health-center)\n```\n  healthcareitnews.com/news/hive-ransomware-group-attacks-mi\n  ssouri-health-center, accessed: 20-Dec-2021.\n\n```\n[[19] Macquarie Health Corporation hit by Windows Hive ransomware, http](https://itwire.com/security/macquarie-health-corporation-hit-by-windows-hive-ransomware.html)\n```\n  s://itwire.com/security/macquarie-health-corporation-hit-b\n  y-windows-hive-ransomware.html, accessed: 20-Dec-2021.\n\n```\n[[20] MediaMarkt hit by Hive ransomware, ransom now at 50 million, https:](https://news.securiwiser.com/mediamarkt-hit-by-hive-ransomware-ransom-now-at-50-million/)\n```\n  //news.securiwiser.com/mediamarkt-hit-by-hive-ransomware-r\n  ansom-now-at-50-million/, accessed: 20-Dec-2021.\n\n```\n[Model, RFC 3826 (Jun. 2004). doi:10.17487/RFC3826.](https://www.rfc-editor.org/info/rfc3826)\n[URL https://www.rfc-editor.org/info/rfc3826](https://www.rfc-editor.org/info/rfc3826)\n```\n                               doi:\n  10.17487/RFC8017.\n\n```\n[URL https://www.rfc-editor.org/info/rfc8017](https://www.rfc-editor.org/info/rfc8017)\n\n\n-----\n\n[33] A. Kharaz, S. Arshad, C. Mulliner, W. Robertson, E. Kirda, {UNVEIL}:\n\n_{USENIX} Security Symposium ({USENIX} Security 16), 2016, pp._\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://arxiv.org/pdf/2202.08477.pdf"
    ],
    "report_names": [
        "2202.08477.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716501,
    "ts_updated_at": 1743041279,
    "ts_creation_date": 1645150883,
    "ts_modification_date": 1645150883,
    "files": {
        "pdf": "https://archive.orkl.eu/4f33fcabf16fda51ae4e7eb435f55378a19e0e2d.pdf",
        "text": "https://archive.orkl.eu/4f33fcabf16fda51ae4e7eb435f55378a19e0e2d.txt",
        "img": "https://archive.orkl.eu/4f33fcabf16fda51ae4e7eb435f55378a19e0e2d.jpg"
    }
}