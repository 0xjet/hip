{
    "id": "aabf43d3-cba4-4dbf-bbc2-b4ef68d1f8de",
    "created_at": "2023-01-12T15:10:28.543624Z",
    "updated_at": "2025-03-27T02:05:22.551539Z",
    "deleted_at": null,
    "sha1_hash": "b78f96d4b346eadf372051e598ffe3427c145542",
    "title": "2017-12-19 - Let's Learn- Introducing New Trickbot LDAP -DomainGrabber- Module",
    "authors": "",
    "file_creation_date": "2022-05-28T04:12:28Z",
    "file_modification_date": "2022-05-28T04:12:28Z",
    "file_size": 389910,
    "plain_text": "# Let's Learn: Introducing New Trickbot LDAP \"DomainGrabber\" Module\n\n**[vkremez.com/2017/12/lets-learn-introducing-new-trickbot.html](http://www.vkremez.com/2017/12/lets-learn-introducing-new-trickbot.html)**\n\n**Goal: Reverse the latest Trickbot’s module called “DomainGabber,\" also known as**\n\"domainDll32,\" used for LDAP harvesting of domain controller configuration.\n\n**Source:**\n\n[domainDll32 (encoded) (cec42d8ef68aae0a5da8230db75d91fd)](https://www.virustotal.com/#/file/0e2d00a8b926f6a37c56f8f959b7f4b84d259b4bd2eaa49bc7af00c286a2704d/details)\n[domainDll32 (decoded) (1e2791877da02d49998dea79515a89ca)](https://www.virustotal.com/#/file/3e3d82ea4764b117b71119e7c2eecf46b7c2126617eafccdfc6e96e13da973b1/details)\n[Trickbot loader (b4d342dc89bc16a1acccd40204064830)](https://www.virustotal.com/en/file/91199f80c3aaeea9e0740baba70cf2eb9702394f41f9bb0611715f33d6576bc5/analysis/1513627309/)\n\n[looks like anew #trickbot . Don't know distribution method.](https://twitter.com/hashtag/trickbot?src=hash&ref_src=twsrc%5Etfw)\nhxxp://sumnercapital.com[.]au/ser1812.png not doing much in sandboxes.\n[https://t.co/hDrMFerQqU](https://t.co/hDrMFerQqU) [https://t.co/WUhfRXk5Xf](https://t.co/WUhfRXk5Xf) [https://t.co/6YGQ6L7dhn](https://t.co/6YGQ6L7dhn)\n[@VK_Intel](https://twitter.com/VK_Intel?ref_src=twsrc%5Etfw) [@James_inthe_box](https://twitter.com/James_inthe_box?ref_src=twsrc%5Etfw) [@malware_traffic](https://twitter.com/malware_traffic?ref_src=twsrc%5Etfw) [@iCyberFighter](https://twitter.com/iCyberFighter?ref_src=twsrc%5Etfw)\n[— My Online Security (@dvk01uk) December 18, 2017](https://twitter.com/dvk01uk/status/942852069127589888?ref_src=twsrc%5Etfw)\n\n**Background**\nWhile analyzing one of the latest Trickbot group tag “ser1812/tt0002” (version 1000105[1000106) loaders shared by @dvk01uk found an interesting a Trickbot module titled](https://twitter.com/dvk01uk)\n“domainDll” module. (Tip: the \"tt0002\" group tag is known as a \"Trick Test\" tag; it is\noftentimes deployed to update the existing config on the victim machine.)\nTrickbot \"DomainGrabber\" outline:\n\nI. Lightweight Directory Access Protocol (LDAP) query for domain controllers\n\nII. Connection to \"SYSVOL\" domain controller\n\nIII. Harvesting domain controller XML configuration\n\n\n-----\n\nAs usual, the decoded module contains four Trickbot exported functions:\nStart\nControl\nFreeBuffer\nRelease\nThe observed Trickbot main config module was as follows (version 1000106):\n<mcconf>\n<ver>1000106</ver>\n<gtag>tt0002</gtag>\n<servs>\n<srv>200.111.97[.]235:449</srv>\n<srv>177.250.126[.]51:449</srv>\n<srv>94.250.253[.]142:443</srv>\n<srv>82.146.48[.]44:443</srv>\n<srv>80.87.199[.]190:443</srv>\n<srv>82.146.49[.]135:443</srv>\n<srv>82.146.48[.]187:443</srv>\n<srv>37.46.133[.]10:443</srv>\n<srv>92.53.91[.]15:443</srv>\n<srv>188.120.243[.]242:443</srv>\n<srv>92.53.66[.]177:443</srv>\n\n\n-----\n\n<srv>92.53.78[.]228:443</srv>\n<srv>92.53.66[.]162:443</srv>\n<srv>82.146.48[.]243:443</srv>\n<srv>37.46.131[.]45:443</srv>\n<srv>78.24.218[.]168:443</srv>\n<srv>37.46.133[.]14:443</srv>\n<srv>62.109.17[.]228:443</srv>\n<srv>82.146.61[.]103:443</srv>\n<srv>82.146.61[.]140:443</srv>\n<srv>82.146.61[.]247:443</srv>\n<srv>92.63.96[.]24:443</srv>\n<srv>194.87.232[.]167:443</srv>\n<srv>185.158.114[.]164:443</srv>\n<srv>37.230.112[.]104:443</srv>\n<srv>194.87.103[.]83:443</srv>\n<srv>92.53.91[.]113:443</srv>\n<srv>37.230.113[.]100:443</srv>\n<srv>95.213.195[.]221:443</srv>\n<srv>37.230.113[.]118:443</srv>\n<srv>194.87.238[.]4:443</srv>\n<srv>194.87.98[.]166:443</srv>\n<srv>195.2.253[.]125:443</srv>\n<srv>94.250.248[.]168:443</srv>\n<srv>179.43.160[.]53:443</srv>\n<srv>37.46.133[.]251:443</srv>\n<srv>194.87.144[.]222:443</srv>\n</servs>\n<autorun>\n<module name=\"systeminfo\" ctl=\"GetSystemInfo\" />\n<module name=\"injectDll\" />\n</autorun>\n</mcconf>\n**Summary**\n\"domainDll32,\" compiled via 'GCC: (Rev1, Built by MSYS2 project) 7.2.0,' allows Trickbot\noperators to collect domain controller information once they are already on the compromised\nmachine. This module is internally called \"DomainGrabber\" and accepts command\n\"getdata\" in order to start harvest domain information. domainDll appears to be aimed at\nexploiting networks with unsecured domain controllers.\nMore specifically, this module targets \"SYSVOL\" for domain configuration information data.\nAccording to [Microsoft, \"SYSVOL is simply a folder which resides on each and every domain](https://social.technet.microsoft.com/wiki/contents/articles/24160.active-directory-back-to-basics-sysvol.aspx)\n_controller within the domain. It contains the domains public files that need to be accessed by_\n_clients and kept synchronised between domain controllers. The default location for the_\n\n\n-----\n\n_SYSVOL is C:\\Windows\\SYSVOL although it can be moved to another location during the_\n_promotion of a domain controller. It’s possible but not recommended to relocate the SYSVOL_\n_after_ _[DC promotion as there is potential for error. The SYSVOL folder can be accessed](http://social.technet.microsoft.com/wiki/contents/articles/16757.active-directory-glossary.aspx#DC)_\n_through its share \\\\domainname.com\\sysvol or the local share name on the_\n_server \\\\servername\\sysvol.\"_\n\nWhat is more, SYSVOL stores various logon scripts, group policy and domain configuration\nXML data that is synchronized among all domain controllers in the network. Essentially,\nTrickbot grabs credential and group policy information stored in SYSVOL as follows:\ngroups.xml\nservices.xml\nscheduledtasks.xml\ndatasources.xml\nprinters.xml\ndrives.xml\n\n[Sean Metcalf has an interesting write-up on how LDAP can be exploited for credential and](https://adsecurity.org/?p=2362)\ninformation harvesting highlighting this similar approach leveraged by the Trickbot gang.\n\nHave you scanned the SYSVOL share on your DCs for Group Policy Preference\npasswords recently?\n\n[Hint: attackers havehttps://t.co/wGiESxYnOx](https://t.co/wGiESxYnOx) [pic.twitter.com/xf8G2y8L0C](https://t.co/xf8G2y8L0C)\n[— Sean Metcalf (@PyroTek3) May 30, 2017](https://twitter.com/PyroTek3/status/869559165747945472?ref_src=twsrc%5Etfw)\n\nI. This Trickbot module was programmed leveraging Active Directory Service Interfaces\n(ADSI) APIs to query LDAP.\n\n\n-----\n\n**IIDFromString \"{001677D0-FD16-11CE-ABC4-02608C9E7553}**\nIID_IADsContainer is defined as 001677D0-FD16-11CE-ABC4-02608C9E7553\n**ads_open = ADsOpenObject(\"G\", 0, 0, 1u, &iid, &v11);**\nDsOpenObject function binds to an ADSI object using explicit user name and password\nstarting with the letter \"G\"\n**IIDFromString(L\"{00020404-0000-0000-C000-000000000046}\", &iid);**\nThe GUID associated with the IEnumVARIANT interface\n**IIDFromString(L\"{109BA8EC-92F0-11D0-A790-00C04FD8D5A8}\", &iid);**\n-IID_IDirectorySearch is defined as 109BA8EC-92F0-11D0-A790-00C04FD8D5A8\nThe module queries all domain controllers as follows:\n(&(objectCategory=computer)\n\n(userAccountControl:1.2.840.113556.1.4.803:=8192))\nII. Trickbot connects to domain controller and queries SYSVOL leveraging parsing the\naforementioned LDAP query.\n\n\n-----\n\nThe relevant pseudocoded C++ function is as follows:\nstr_func((int)&name, 260, \"%ls\", *(_DWORD *)(v6 + 8));\nv26 = gethostbyname(&name);\nif ( v26 )\n{\nv25 = (struct in_addr *)*v26->h_addr_list;\nv2 = inet_ntoa(*v25);\nMultiByteToWideChar(0, 1u, v2, -1, &WideCharStr, 32);\nv30 = DsRoleGetPrimaryDomainInformation(0, DsRolePrimaryDomainInfoBasic,\n&Buffer);\nif ( v30 )\nreturn v21;\nsnwprintf_s(&DstBuf, 260u, 260u, L\"\\\\\\\\%ls\\\\SYSVOL\\\\%ls\", &WideCharStr, *\n((_DWORD *)Buffer + 3));\nmemset(&Dst, 0, 0x20u);\nlpName = &DstBuf;\nv30 = WNetAddConnection2W((LPNETRESOURCEW)&Dst, 0, 0, 0);\nif ( !v30 )\n{\nfinder_files((int)&DstBuf);\nWNetCancelConnection2W(lpName, 0, 0);\nIII. Finally, Trickbot queries stored domain controller for sensitive XML configurations such as\nscheduledtasks.xml, datasources.xml printers.xml, and etc.\n\n\n-----\n\nSome of the mitigations against LDAP exploitation are well-documented in Metcalf's article\nlisted above. As a general rule of thumb, such configuration files should be secured from any\nunauthorized access in SYSVOL, and access to them should be monitored.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-12-19 - Let's Learn- Introducing New Trickbot LDAP -DomainGrabber- Module.pdf"
    ],
    "report_names": [
        "2017-12-19 - Let's Learn- Introducing New Trickbot LDAP -DomainGrabber- Module.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536228,
    "ts_updated_at": 1743041122,
    "ts_creation_date": 1653711148,
    "ts_modification_date": 1653711148,
    "files": {
        "pdf": "https://archive.orkl.eu/b78f96d4b346eadf372051e598ffe3427c145542.pdf",
        "text": "https://archive.orkl.eu/b78f96d4b346eadf372051e598ffe3427c145542.txt",
        "img": "https://archive.orkl.eu/b78f96d4b346eadf372051e598ffe3427c145542.jpg"
    }
}