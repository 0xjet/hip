{
    "id": "244d1664-3021-426d-a5f8-c2bca3995fe7",
    "created_at": "2023-01-12T14:59:49.331879Z",
    "updated_at": "2025-03-27T02:05:59.706035Z",
    "deleted_at": null,
    "sha1_hash": "3060d140927360bfca7489a8e41c3dd64c3c3467",
    "title": "2019-06-14 - Malware Tales- Sodinokibi",
    "authors": "",
    "file_creation_date": "2022-05-28T15:18:31Z",
    "file_modification_date": "2022-05-28T15:18:31Z",
    "file_size": 3047427,
    "plain_text": "# Malware Tales: Sodinokibi\n\n**certego.net/en/news/malware-tales-sodinokibi/**\n\n**Date:**\n14 June 2019\n\n**Tag:**\n[Malware,](https://www.certego.net/en/news/index/type:Tag/slug:malware/) [sodinokibi,](https://www.certego.net/en/news/index/type:Tag/slug:sodinokibi/) [gandcrab](https://www.certego.net/en/news/index/type:Tag/slug:gandcrab/)\n\nHi everyone! Today we are looking at a threat that appeared recently: a new ransomware\ncalled Sodinokibi.\n\n## Summary\n\n 1. The Threat\n\n[The first noteworthy appearance was at the end of April (Talos Research).](https://blog.talosintelligence.com/2019/04/sodinokibi-ransomware-exploits-weblogic.html)\n\nThen, at the start of this month, we gathered different reports of this threat being spread in\nItaly (eg: [JAMESWT_MHT's tweet), both via malspam and known server vulnerabilities.](https://twitter.com/JAMESWT_MHT/status/1135543914402725888)\n\nAlso, there was the announcement of the shutdown of the GandCrab Operation (Bleeping\nComputer), just some days earlier.\n\n\n-----\n\nCoincidence? We ll see.\n\nOur guess is that this new payload could be used as a replacement of GandCrab in the\nRAAS (Ransomware-as-a-service) panorama.\n\nTherefore, in order to protect our customers effectively, we went deep into the analysis of this\nransomware.\n\nMainly we analyzed two different samples:\n\nversion 1.01: md5: e713658b666ff04c9863ebecb458f174\nversion 1.00: md5: bf9359046c4f5c24de0a9de28bbabd14\n\n## 2. The Loader\n\nLike every malware who deserves respect, Sodinokibi is protected by a custom packer that\nis different for each sample.\n\nThe method used by the version 1.01 sample to reconstruct the original payload is called “PE\n**overwrite”.**\n\nTo perform this technique, the malicious software must allocate a new area inside its process\nmemory and fill it with the code that has the duty to overwrite the mapped image of the\noriginal file with the real malware payload. In this case, first the process allocates space in\nthe Heap via LocalAlloc, then it writes the “unpacking stub” code, it signs that space as\nexecutable with VirtualProtect and finally it redirects the execution flow to the new memory\nspace\n\nIn order to slow the analysis, the loader contains a lot of junk code that will be never\nexecuted.\n\n\n-----\n\nAlso, in the following image, we can see that it tries to hide some important strings from the\nstatic analysis like “ kernel32.dll”. It leverages “stack strings” plus the randomization of the\norder of the characters.\n\nAt this point, the unpacking stub resolves dynamically the functions that he needs like\n_VirtualAlloc. Then it performs the overwrite of the original image base with the new decrypted_\npayload.\n\n\n-----\n\nFinally, it transfers the execution to the OEP (Original Entry Point) of the unpacked\nSodinokibi payload.\n\n## 3. Mutex and Configuration\n\nOnce unpacked, the sample tries to create a mutex object. It calls CreateMutexW, then, if\nthere was an error, with RtlGetLastWin32Error it would extract the generated error. Indeed, if\nthe mutex already existed, the error would have been “0xB7” (\"ERROR_ALREADY_EXISTS\"\nref [docs). In that case a function is called that terminates the process.](https://docs.microsoft.com/en-us/windows/desktop/api/synchapi/nf-synchapi-createmutexa)\n\n\n-----\n\nWe found that the mutex name is different for each sample but following this pattern:\n“Global\\{UUID}”. Therefore it’s a method to detect the malware or to vaccinate the endpoint\n[(Zeltser blog) that is reliable only for a specific sample.](https://zeltser.com/malware-vaccination-infection-markers/)\n\nGoing forward, we found the configuration in an encrypted form in the section “ .zeacl” for\nv.1.01 or “.grrr” for v.1.00. Once extracted, we noticed that it’s a JSON file.\n\nThese are the keys found in the configuration.\n\n“pk” -> base64 encoded key used to encrypt files\n“pid” -> personal id of the actor\n“sub” -> another id, maybe related to the specific campaign\n“dbg” -> debug mode\n“fast” -> fast mode\n“wipe” -> enable wipe of specific directories\n“wht” -> whitelist dictionary\n\n“fld” -> keyword in whitelisted directories\n“fls” -> whitelisted filenames\n“ext” -> whitelisted file extensions\n“wfld” -> directories to wipe\n“prc” -> processes to kill before the encryption\n“dmn” -> domains to contact after encryption\n“net” -> check network resources\n“nbody” -> base64 encoded ransom note body\n“nname” -> ransom note file name\n“exp” -> unknown, expert mode?\n“img” -> base64 encoded message on desktop background\n\nIf you are interested in manually checking the configuration files we have extracted in the\nsamples we have analyzed, follow this link and download the archive (password:sodinokibi):\n[sodinokibi_config_files.zip](https://www.certego.net/upload/image/4/e/d/sodinokibi_config_files.zip)\n\n## 4. Machine information recovery\n\nAfterwards, Sodinokibi starts to gather information about the infected machine and builds\nanother JSON structure that stores in an encrypted form in the\n“HKEY LOCAL MACHINE\\SOFTWARE\\recfg\\stat” registry key\n\n\n-----\n\nKeys:\n\n“ver”: version (100 or 101)\n“pid”: previous config “pid”\n“sub”: previous config “sub”\n“pk”: previous config “pk”\n“uid”: user ID. It’s a 8 byte hexadecimal value generated with XOR encryption. First 4\nbytes are created from the processor name, while the others are created from the\nvolume serial number extracted with a “GetVolumeInformationW” API call.\n\n“sk”: secondary key, base64 encoded key generated at runtime\n“unm”: username\n“net” : hostname\n“grp”: windows domain\n\n\n-----\n\n“lng”: language\n\n“bro”: brother? Sodinokibi retrieves the keyboard language with\n_GetKeyboardLayoutList. Then it implements an algorithm that gives “True” as value for_\nthis key only if the nation code ends with a byte between 0x18 and 0x2c. It’s not odd\nthat inside this range there are the majority of the East-Europe language codes, like\nRussian, Cyrillic and Romanian. It’s a clear indication of the origin of the malware\nauthors.\n\n“os”: full OS name\n\n“bit”: Sodinokibi extracts this value from “GetNativeSystemInfo” then it compares with 9\nthat corresponds to the x64 architecture. Further processing will generate “40” if the\narchitecture is 64bit, “56” otherwise.\n\n\n-----\n\n“dsk”: base64 encoded value generated based on the drives found on the machine.\n“ext”: new in 1.01. The random extension used for encrypted files.\n\n## 5. Encryption preparation inspired by GandCrab\n\nAt this time, before performing the encryption, Sodinokibi replicates a behavior that is very\nsimilar to what GandCrab performs, suggesting that Sodinokibi authors learned from\nGandCrab ones or that they are strictly related.\n\nSodinokibi extracts the running processes with the combination of\n_CreateToolhelp32Snapshot, Process32First and Process32First and checks if they match the_\nnames in the configuration. In that case, those processes are killed. The reason is that these\nprograms could hold write access on files and therefore they could not allow the ransomware\nto encrypt them.\n\nThe list of the version 1.00 contains only the “mysql.exe” process, while the list of the version\n[1.01 is a lot longer and almost matches the ones used by GandCrab (source: Symantec).](https://www.symantec.com/security_response/earthlink_writeup.jsp?docid=2018-013106-5656-99)\n\n\n-----\n\nAfterwards, like his predecessor, Sodinokibi deletes the shadow copies with the leverage of\nthe “vssadmin” native utility. In addition, it uses “bcdedit” to disable windows error recovery\non reboot.\n\nAnother check done by the ransomware is for available network resources with\n_WNetOpenEnumW e WNetEnumResourceW with the aim to find other files to encrypt._\n\nLast operation before the encryption is to find all the directories with a name that matches\nthe configuration key “wfld” and to wipe them. In this case, the list contains only “backup”.\nSo, for example, Sodinokibi deletes Windows Defenders updates backups.\n\n## 6. Ransomware attack\n\nFinally (or not?) Sodinokibi starts to iterate over the available directories with FindFirstFile\nand FindNextFile.\n\nIt skips files and directories that match conditions on the whitelist configuration. The others\nare encrypted by the ransomware that adds the random generated key as extension to the\nname.\n\nIn each directory the malware also write the ransom note “{ext}.readme.txt” extracted from\nthe configuration and a lock file.\n\nThen it creates a file with a random name “{random}.bmp” in the %TEMP% which contains\nthe image that will be put as a background with the help of DrawTextW and FillRect\nfunctions.\n\n\n-----\n\n## 7. C2 Registration\n\nOnce the encryption is finished, Sodinokibi starts to iterate through a giant list of domains\nhardcoded in the configuration (about 1k). These domains are the same across the samples\nwe analyzed but they are ordered differently in order to mislead the analysis.\n\nAt a first glance, these domains seem legit and most of them are correctly registered.\n\nThis is not a classic DGA but the result is almost the same because the purpose is to hide\nthe real C&C Server used by cyber criminals.\n\nFor each domain listed, Sodinokibi generates a random URI. Then it uses the winhttp.dll\nlibrary functions to perform HTTPS POST requests with the created URLs.\n\nThe data sent with the POST request is an encrypted form of the JSON configuration saved\non the “HKEY_LOCAL_MACHINE\\SOFTWARE\\recfg\\stat” registry key and described on the\n“Machine information recovery” section. In this way, malicious actors can collect important\ninformation of the infected machine.\n\nThe following are examples of some of these URLs:\n\n[Looking at an analysis of this sample in a sandbox (AnyRun), we noticed that HTTPS](https://app.any.run/tasks/e2b0ee0f-ac20-497f-bc2d-c1293e155664/)\nrequests where not correctly listed. The malware can avoid traffic interception by proxies like\n_Fiddler or Mitmproxy that are used for manual or automatic analysis._\n\nHow? The second parameter of the WinHttpOpen function is 0 which corresponds to\n“WINHTTP_ACCESS_TYPE_DEFAULT_PROXY”: this means that the configured proxy is\nskipped and the HTTP connection won’t be logged. This trick could mislead the analysis if\nnot properly handled.\n\n\n-----\n\nI suggest to read the following blog post where it’s further explained how these URLs are\n[generated and why also this routine is inspired by GandCrab code: Tesorion analysis](https://www.tesorion.nl/aconnection-between-the-sodinokibi-and-gandcrab-ransomware-families/)\n\n## 8. Conclusion\n\n**Sodinokibi could be the heir of GandCrab. It’s still at version 1.01 so maybe it’s not mature**\nyet but is actively developed and updated\n\nMalicious actors have started to use Sodinokibi to generate profit, even in Italy.\n\nIt’s important to continuously monitor your own assets, both on a network and an endpoint\nlevel, to fight against these kind of threats.\n\n**Certego Threat Intelligence Team has been studying upcoming cyber threats for years in**\norder to provide the best protection to their customers.\n\n**IOC**\n```\nHKEY_LOCAL_MACHINE\\SOFTWARE\\recfg\\stat\nHKEY_LOCAL_MACHINE\\SOFTWARE\\recfg\\pk_key\ndecryptor[.]top\naplebzu47wgazapdqks6vrcv6zcnjppkbxbr6wketf56nf6aq2nmyoyd[.]onion\n\n```\n**About the author**\n\n**Matteo Lodi, Cyber Threat Intelligence Team Leader**\n\nTwitter: [https://twitter.com/matte_lodi](https://twitter.com/matte_lodi)\n\nLicense:\n\nThis work is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives\n4.0 International License.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-06-14 - Malware Tales- Sodinokibi.pdf"
    ],
    "report_names": [
        "2019-06-14 - Malware Tales- Sodinokibi.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535589,
    "ts_updated_at": 1743041159,
    "ts_creation_date": 1653751111,
    "ts_modification_date": 1653751111,
    "files": {
        "pdf": "https://archive.orkl.eu/3060d140927360bfca7489a8e41c3dd64c3c3467.pdf",
        "text": "https://archive.orkl.eu/3060d140927360bfca7489a8e41c3dd64c3c3467.txt",
        "img": "https://archive.orkl.eu/3060d140927360bfca7489a8e41c3dd64c3c3467.jpg"
    }
}