{
    "id": "1bd53d66-77df-4ee4-aa95-b9e55b642f31",
    "created_at": "2023-01-12T15:10:15.022489Z",
    "updated_at": "2025-03-27T02:05:32.144303Z",
    "deleted_at": null,
    "sha1_hash": "e397585c1fee0a8d6756a2434bd04f04d5afbf19",
    "title": "2015-11-17 - New Memory Scraping Technique in Cherry Picker PoS Malware",
    "authors": "",
    "file_creation_date": "2022-05-28T15:57:23Z",
    "file_modification_date": "2022-05-28T15:57:23Z",
    "file_size": 200608,
    "plain_text": "# New Memory Scraping Technique in Cherry Picker PoS Malware\n\n**[trustwave.com/Resources/SpiderLabs-Blog/New-Memory-Scraping-Technique-in-Cherry-Picker-PoS-Malware/](https://www.trustwave.com/Resources/SpiderLabs-Blog/New-Memory-Scraping-Technique-in-Cherry-Picker-PoS-Malware/)**\n\n**Introduction**\n\nWorking primarily with point of sale malware, we regularly see the telltale signs of scraping\nmemory for Card Holder Data (CHD). Open up the process, walk through the memory using\nVirtualQuery, check for numbers between 3 and 6â€¦ You know the drill, it's pretty much \"the\n[way it's done\". Yesterday we posted a blog about Cherry Picker malware. In my first pass](https://www.trustwave.com/Resources/SpiderLabs-Blog/Shining-the-Spotlight-on-Cherry-Picker-PoS-Malware/?page=1&year=0&month=0)\nthrough the malware, I found the credit card searching algorithm and glazed over the details\nwhile I finished the write up for the forensic team. At that point I realized that I did not see\nhow memory had been accessed. Following the function calls led me to a new technique for\nscraping memory using the Windows API QueryWorkingSet. Raising awareness of this\nmethod can help Antivirus companies and security researchers detect future threats that\nuse this new technique.\n\n**The API**\n\nThe calling function for the credit card scraping algorithm contained a couple of calls to an\nAPI call that I have not run across before in malware:\n\nBOOL WINAPI QueryWorkingSet(\n\n\n-----\n\n_In_ HANDLE hProcess,\n\n_Out_ PVOID pv,\n\n_In_ DWORD cb );\n\nAfter investigating this API, it became apparent that this was how the author was accessing\nmemory in the process. Here is a overview of the algorithm.\n\n**Cherry Picker Usage**\n\nSince Cherry Picker is a DLL that is loaded or injected into the target process, calling\nGetCurrentProcess retrieves a handle to the current process. This also works on other\nprocesses, but both the calling process and the foreign process need to be opened with the\ncorrect privileges. With the process handle, a call to QueryWorkingSet is made. This call will\nactually fail because we don't know how much space we need for the buffer, but even\nthough it fails it will still return the number of virtual pages that the process currently has.\nThis is the information we are after. Knowing the number of pages we have allows us to\ndeclare a buffer with the correct amount of space. With a large enough buffer, we can call\nQueryWorkingSet again to retrieve the information about the pages resident in memory.\nAfter translating the linear address into a virtual address, we can check the permissions on\nthe page, read them into a buffer, and scan them for CHD. When scanning for CHD, only\nread/write pages are relevant.\n\n\n-----\n\nThe image above shows a very simplified visualization of linear pages being mapped into\nthe process's virtual address space. The black boxes in the virtual memory represents\nunallocated space in the process. The QueryWorkingSet API will return the addresses in\nvirtual space for each physical page that is mapped into the process's virtual memory.\n\n**QueryWorkingSet vs. VirtualQuery**\n\nYou might ask yourself, what is the difference between using QueryWorkingSet and\nVirtualQuery to analyze memory. Both techniques will give you access to the same virtual\nmemory but in a different way. Microsoft's API documentation describes the working set as:\n\n\"The working set of a program is a collection of those pages in its virtual address space that\nhave been recently referenced. It includes both shared and private data\"\n\nEssentially, QueryWorkingSet is accessing virtual memory a page at a time, while\nVirtualQuery accesses memory across a variable range.\n\n**Wrap-up**\n\n\n-----\n\nIt is interesting to see a new technique being used by malware authors for this type of work.\nI was unable to find any other examples of this being used to scrape CHD from memory,\nalthough this technique associated with obtaining the information on some of the lesserknown panels in your average task manager program.\n\nI wrote a proof of concept program to aid understanding of the technique and demonstrate\nwhat the [code looks like. Interestingly, I found a more recently compiled version of Cherry](https://github.com/SpiderLabs/malware-analysis/blob/master/C/queryWorkingSet.c)\nPicker and discovered that the author had reverted to using VirtualQuery to process\nmemory. Not sure as to the reason, but I felt it was important to expose a technique that has\nbeen seen in the wild that I was unable to find anyone else discussing.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-11-17 - New Memory Scraping Technique in Cherry Picker PoS Malware.pdf"
    ],
    "report_names": [
        "2015-11-17 - New Memory Scraping Technique in Cherry Picker PoS Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "746214d4-5d48-4644-b763-8e9a9c549c04",
            "created_at": "2022-10-25T16:07:23.878029Z",
            "updated_at": "2025-03-27T02:02:10.006583Z",
            "deleted_at": null,
            "main_name": "MoneyTaker",
            "aliases": [],
            "source_name": "ETDA:MoneyTaker",
            "tools": [
                "Kronos",
                "Metasploit",
                "MoneyTaker",
                "Screenshotter"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e5364c16-eb97-467e-a8c2-a720269498c1",
            "created_at": "2023-01-06T13:46:38.733469Z",
            "updated_at": "2025-03-27T02:00:02.904201Z",
            "deleted_at": null,
            "main_name": "MoneyTaker",
            "aliases": [],
            "source_name": "MISPGALAXY:MoneyTaker",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536215,
    "ts_updated_at": 1743041132,
    "ts_creation_date": 1653753443,
    "ts_modification_date": 1653753443,
    "files": {
        "pdf": "https://archive.orkl.eu/e397585c1fee0a8d6756a2434bd04f04d5afbf19.pdf",
        "text": "https://archive.orkl.eu/e397585c1fee0a8d6756a2434bd04f04d5afbf19.txt",
        "img": "https://archive.orkl.eu/e397585c1fee0a8d6756a2434bd04f04d5afbf19.jpg"
    }
}