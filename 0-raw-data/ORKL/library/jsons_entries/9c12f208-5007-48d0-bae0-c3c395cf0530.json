{
    "id": "9c12f208-5007-48d0-bae0-c3c395cf0530",
    "created_at": "2023-01-12T15:02:03.004706Z",
    "updated_at": "2025-03-27T02:05:35.871858Z",
    "deleted_at": null,
    "sha1_hash": "adb228f638a24c50093ec4b391e16befef8fd2e5",
    "title": "2016-05-11 - Threat Actor Leverages Windows Zero-day Exploit in Payment Card Data Attacks",
    "authors": "",
    "file_creation_date": "2022-05-29T01:20:24Z",
    "file_modification_date": "2022-05-29T01:20:24Z",
    "file_size": 82400,
    "plain_text": "# Threat Actor Leverages Windows Zero-day Exploit in Payment Card Data Attacks\n\n**[fireeye.com/blog/threat-research/2016/05/windows-zero-day-payment-cards.html](https://www.fireeye.com/blog/threat-research/2016/05/windows-zero-day-payment-cards.html)**\n\n## Breadcrumb\n\nThreat Research\n\nDhanesh Kizhakkinan, Yu Wang, Dan Caselden, Erica Eng\n\nMay 11, 2016\n\n5 mins read\n\nZero Day Threats\n\n\n-----\n\nIn March 2016, a financially motivated threat actor launched several tailored spear phishing\ncampaigns primarily targeting the retail, restaurant, and hospitality industries. The emails\n[contained variations of Microsoft Word documents with](http://researchcenter.paloaltonetworks.com/2016/03/powersniff-malware-used-in-macro-based-attacks/) [embedded macros that, when](https://blogs.mcafee.com/mcafee-labs/macro-malware-associated-dridex-finds-new-ways-hide/)\nenabled, downloaded and executed a malicious downloader that we refer to as\nPUNCHBUGGY.\n\nPUNCHBUGGY is a dynamic-link library (DLL) downloader, existing in both 32-bit and 64-bit\nversions, that can obtain additional code over HTTPS. This downloader was used by the\nthreat actor to interact with compromised systems and move laterally across victim\nenvironments.\n\nFireEye identified more than 100 organizations in North America that fell victim to this\ncampaign. FireEye investigated a number of these breaches and observed that the threat\nactor had access to relatively sophisticated tools including a previously unknown elevation of\nprivilege (EoP) exploit and a previously unnamed point of sale (POS) memory scraping tool\nthat we refer to as PUNCHTRACK.\n\n**CVE-2016-0167 – Microsoft Windows Zero-Day Local Privilege Escalation**\n\nIn some victim environments, the threat actor exploited a previously unknown elevation of\nprivilege (EoP) vulnerability in Microsoft Windows to selectively gain SYSTEM privileges on a\nlimited number of compromised machines (Figure 1).\n\n\n-----\n\nCVE-2016-0167 Local privilege escalation exploit elevates to\nsystem\n\nFigure 1: CVE-2016-0167\n\nLocal privilege escalation exploit elevates to system\nWe coordinated with Microsoft, who patched CVE-2016-0167 on the April 12, 2016, Patch\n[Tuesday (MS16-039). Working together, we were able to observe limited, targeted use of this](https://technet.microsoft.com/en-us/library/security/ms16-039.aspx)\nparticular exploit dating back to March 8, 2016.\n\n**The Threat Actor**\n\nWe attribute the use of this EoP to a financially motivated threat actor. In the past year, not\nonly have we observed this group using similar infrastructure and tactics, techniques, and\nprocedures (TTPs), but they are also the only group we have observed to date who uses the\ndownloader PUNCHBUGGY and POS malware PUNCHTRACK. Designed to scrape both\nTrack 1 and Track 2 payment card data, PUNCHTRACK is loaded and executed by a highly\nobfuscated launcher and is never saved to disk.\n\nThis actor has conducted operations on a large scale and at a rapid pace, displaying a level\nof operational awareness and ability to adapt their operations on the fly. These abilities,\ncombined with targeted usage of an EoP exploit and the reconnaissance required to\nindividually tailor phishing emails to victims, potentially speaks to the threat actors’\noperational maturity and sophistication.\n\n**Exploitation Details**\n\nWin32k!xxxMNDestroyHandler Use-After-Free\n\n\n-----\n\nCVE-2016-0167 is a local elevation of privilege vulnerability in the win32k Windows Graphics\nsubsystem. An attacker who had already achieved remote code execution (RCE) could\nexploit this vulnerability to elevate privileges. In the attack from the wild, attackers first\nachieved RCE with malicious macros in documents attached to spear phishing emails. They\nthen downloaded and ran a CVE-2016-0167 exploit to run subsequent code as SYSTEM.\n\nCVE-2016-0167 is patched as of April 12, 2016, meaning the attacker’s EoP exploit will no\nlonger function on fully updated systems. Microsoft released an additional update (MS16062) on May 10, 2016, to further improve Windows against similar issues.\n\nVulnerability Setup\n\nFirst, the exploit calls CreateWindowEx() to create a main window. It sets the\nWNDCLASSEX.lpfnWndProc field to a function that we name WndProc. It installs an\napplication-defined hook (that we name MessageHandler) and an event hook (that we name\nEventHandler) using SetWindowsHookEx() and SetWinEventHook(), respectively.\n\nNext, it creates a timer with IDEvent 0x5678 in SetTimer(). When the timeout occurs,\nWndProc receives the WM_TIMER message and will invoke TrackPopupMenuEx() to display\na shortcut menu. EventHandler will capture the EVENT_SYSTEM_MENUPOPUPSTART\nevent from xxxTrackPopupMenuEx()and post a message to the kernel. In handling the\nmessage, the kernel eventually calls the vulnerable function xxxMNDestroyHandler(), which\ncalls the usermode callback MessageHandler. MessageHandler then causes a use-after-free\nscenario by calling DestroyWindow()\n\nHeap Control\n\nThe exploit uses SetSysColors() to perform heap Feng Shui which manipulates the layout of\nthe [heap by carefully making heap allocations. In the following snippet, one of the important](https://en.wikipedia.org/wiki/Heap_%28programming%29)\nfields is at address fffff900`c1aaac40, where fffff900`c06a0422 is a window kernel object’s\n(tagWND) base address plus 0x22:\n\n\n-----\n\n0day-1\n\n\nMemory Corruption\n\nThe USE operation occurs at HMAssignmentUnlock()+0x14 as shown below:\n\n\n-----\n\n0day-2\n\n\nSince RDX contains the base address of tagWND plus 0x22, this instruction will add 0xffffffff\nto the win32k!tagWND.state field, changing its value from 0x07004000 to 0x07003fff.\n0x07004000 indicates that the bServerSideWindowProc flag is unset. When the change\noccurs, it sets the bServerSideWindowProc flag as shown below.\n\n\n-----\n\n0day-3\n\n\nCode Execution\n\nIf a window is marked as server-side (bServerSideWindowPro is set), the lpfnWndProc\nfunction pointer will be trusted by default and this can be user-mode shellcode. The following\nbacktrace shows the kernel calling the exploit’s shellcode:\n\n\n-----\n\n0day-4\n\n\nThe shellcode then steals the System process token to elevate a child cmd.exe process.\n\n**Mitigation**\n\nFireEye products and services identify this activity as Exploit.doc.MVX, Malware.Binary.Doc,\nPUNCHBUGGY, Malware.Binary.exe, and PUNCHTRACK within the user interfaces.\n\nThe latest Windows updates address CVE-2016-0167, and fully protect systems from\nexploits targeting CVE-2016-0167.\n\nIn addition, effective mitigations exist to prevent social engineering attacks that utilize Office\nmacros. Individual users can disable Office macros in their settings and enterprise\nadministrators can enforce a Group Policy to control macro execution for all Office 2016\n\n\n-----\n\n[users. More details about Office macro attacks and mitigations are available here.](https://blogs.technet.microsoft.com/mmpc/2016/03/22/new-feature-in-office-2016-can-block-macros-and-help-prevent-infection/)\n\n**Acknowledgements**\n\nThank you to Elia Florio and the Secure@ staff of Microsoft, and Dimiter Andonov, Erye\nHernandez, Nick Richard, and Ryann Winters of FireEye for their collaboration on this issue.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-05-11 - Threat Actor Leverages Windows Zero-day Exploit in Payment Card Data Attacks.pdf"
    ],
    "report_names": [
        "2016-05-11 - Threat Actor Leverages Windows Zero-day Exploit in Payment Card Data Attacks.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535723,
    "ts_updated_at": 1743041135,
    "ts_creation_date": 1653787224,
    "ts_modification_date": 1653787224,
    "files": {
        "pdf": "https://archive.orkl.eu/adb228f638a24c50093ec4b391e16befef8fd2e5.pdf",
        "text": "https://archive.orkl.eu/adb228f638a24c50093ec4b391e16befef8fd2e5.txt",
        "img": "https://archive.orkl.eu/adb228f638a24c50093ec4b391e16befef8fd2e5.jpg"
    }
}