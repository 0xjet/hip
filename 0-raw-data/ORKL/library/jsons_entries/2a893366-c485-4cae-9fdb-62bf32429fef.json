{
    "id": "2a893366-c485-4cae-9fdb-62bf32429fef",
    "created_at": "2023-01-12T15:02:16.523995Z",
    "updated_at": "2025-03-27T02:05:18.010409Z",
    "deleted_at": null,
    "sha1_hash": "98c318f6523c1aeb27953aaa17bf8fc0edb3249f",
    "title": "2020-08-07 - Stadeo- Deobfuscating Stantinko and more",
    "authors": "",
    "file_creation_date": "2022-05-28T02:45:40Z",
    "file_modification_date": "2022-05-28T02:45:40Z",
    "file_size": 351541,
    "plain_text": "# Stadeo: Deobfuscating Stantinko and more\n\n**[welivesecurity.com/2020/08/07/stadeo-deobfuscating-stantinko-and-more/](https://www.welivesecurity.com/2020/08/07/stadeo-deobfuscating-stantinko-and-more/)**\n\nAugust 7, 2020\n\nWe introduce Stadeo – a set of scripts that can help fellow threat researchers and reverse\nengineers to deobfuscate the code of Stantinko and other malware\n\n[Vladislav Hrčka](https://www.welivesecurity.com/author/vhrcka/)\n7 Aug 2020 - 02:00PM\n\nWe introduce Stadeo – a set of scripts that can help fellow threat researchers and reverse\nengineers to deobfuscate the code of Stantinko and other malware\n\n[Stadeo is a set of tools primarily developed to facilitate analysis of Stantinko, which is a](https://www.welivesecurity.com/2017/07/20/stantinko-massive-adware-campaign-operating-covertly-since-2012/)\nbotnet performing click fraud, ad injection, social network fraud, password stealing attacks\n[and cryptomining.](https://www.welivesecurity.com/2019/11/26/stantinko-botnet-adds-cryptomining-criminal-activities/)\n\n\n-----\n\nStadeo was demonstrated for the first time at [Black Hat USA 2020 and subsequently](https://www.blackhat.com/us-20/arsenal/schedule/#stantinko-deobfuscation-arsenal-21025)\npublished for free use.\n\nThe scripts, written entirely in Python, deal with Stantinko’s unique control-flow-flattening\n[(CFF) and string obfuscation techniques described in our March 2020 blogpost.](https://www.welivesecurity.com/2020/03/19/stantinko-new-cryptominer-unique-obfuscation-techniques/)\nAdditionally, they can be utilized for other purposes: for example, we’ve already extended\nour approach to support deobfuscating the CFF featured in Emotet – a trojan that steals\nbanking credentials and that downloads additional payloads such as ransomware.\n\n[Our deobfuscation methods use IDA, which is a standard tool in the industry, and](https://www.hex-rays.com/products/ida/) [Miasm –](https://github.com/cea-sec/miasm)\nan open source framework providing us with various data-flow analyses, a symbolic\nexecution engine, a dynamic symbolic execution engine and the means to reassemble\nmodified functions.\n\n[You can find Stadeo at https://github.com/eset/stadeo.](https://github.com/eset/stadeo)\n\n## Usage examples\n\nTo work with Stadeo, we first need to set up a RPyC (Remote Python Call) server inside\nIDA, which allows us to access the IDA API from an arbitrary Python interpreter. You can\nuse [this script to open an RPyC server in IDA.](https://github.com/cea-sec/miasm/blob/master/example/ida/rpyc_ida.py)\n\nIn all the examples below, we set up an RPyC server listening on 10.1.40.164:4455 (4455\nbeing the default port), and then communicate with the server from a Python console.\n\nWe will use two Stadeo classes:\n\n**CFFStrategies for CFF deobfuscation**\n**StringRevealer for string deobfuscation**\n\nBoth classes can be initialized for both 32- and 64-bit architecture.\n\n### Deobfuscating a single function\n\nSHA-1 of the sample: 791ad58d9bb66ea08465aad4ea968656c81d0b8e\n\nThe code below deobfuscates the function at 0x1800158B0 with the parameter in the R9\nregister set to 0x567C and writes its deobfuscated version to the 0x18008D000 address.\n\nThe R9 parameter is a control variable for function-merging the CFF loop (merging variable)\n[and it has to be specified using Miasm expressions, which are documented here; note that](https://github.com/cea-sec/miasm/blob/master/doc/expression/expression.ipynb)\none has to use RSP_init/ESP_init instead of RSP/ESP to refer to the stack parameters.\nFor example, we would use ExprMem(ExprId(“ESP_init”, 32) + ExprInt(4, 32), 32) to target\nthe first stack parameter on 32-bit architecture.\n\n\n-----\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n\nfrom stadeo.cff.cff_strategies import CFFStrategies\n\nfrom miasm.expression.expression import ExprId, ExprInt\n\ncs = CFFStrategies(64)\n\ncs.solve_loop(0x1800158B0,\n\n0x18008D000,\n\ncontext={ExprId(\"R9\", 64): ExprInt(0x567c, 64)},\n\nip='10.1.40.164')\n\n_Figure 1 Call to the obfuscated function_\n\n\n-----\n\n_Figure 2. Obfuscated (left) and deobfuscated (right) CFG_\n\n### Processing reachable functions\n\nSHA-1 of the sample: e0087a763929dee998deebbcfa707273380f05ca\n\nThe following code recognizes only obfuscated functions reachable from 0x1002DC50 and\nsearches for candidates for merging variables. Successfully recognized and deobfuscated\nfunctions are starting at 0x10098000.\n\n\n-----\n\n1\n\n2\n\n3\n\n4\n\n5\n\n\nfrom stadeo.cff.cff_strategies import CFFStrategies\n\nstrat = CFFStrategies(32)\n\nres = strat.process_merging(0x1002DC50,\n\n0x10098000,\n\nip=\"10.1.40.164\")\n\n\n**Partial output:**\n\nskipping 0x1002dc50 with val None: 0xbadf00d\n\nmapping: 0x1001ffc0 -> 0x10098000 with val @32[ESP_init + 0x8]: 0x6cef\n\nskipping 0x100010f0 with val None: 0xbadf00d\n\nmapping: 0x1000f0c0 -> 0x100982b7 with val @32[ESP_init + 0x8]: 0x2012\n\nmapping: 0x1003f410 -> 0x10098c8a with val @32[ESP_init + 0x4]: 0x21a4\n\nmapping: 0x1003f410 -> 0x10098f3d with val @32[ESP_init + 0x4]: 0x772a\n\nskipping 0x1004ee79 (library func)\n\n…\n\nMapped functions were deobfuscated properly and skipped ones weren’t considered to be\nobfuscated. The format of the mapping lines in the output is:\n\nmapping: %obfuscated_function_address% -> %deobfuscated_function_address% with val\n%merging_variable%: % merging_variable_value%\n\nThe default value for merging_variable_value is 0x0BADF00D. The skipping lines follow\nthe same pattern, but there’s no deobfuscated_function_address. Library functions\nrecognized by IDA are just skipped without further processing.\n\n### Processing all functions\n\nSHA-1 of the sample: e575f01d3df0b38fc9dc7549e6e762936b9cc3c3\n\nWe use the following code only to deal with CFF featured in Emotet, whose CFF\n[implementation fits into the description of common control-flow flattening here.](https://www.welivesecurity.com/2020/03/19/stantinko-new-cryptominer-unique-obfuscation-techniques/)\n\nWe prefer this approach because the method CFFStrategies.process_all() does not attempt\nto recognize merging variables that are not present in Emotet and searches only for one\nCFF loop per function; hence it is more efficient.\n\nSuccessfully recognized and deobfuscated functions are sequentially written from\n**0x0040B000. Format of the output is the same as in the process_merging method used in**\nthe Processing reachable functions example, but naturally there won’t be any merging\nvariables\n\n\n-----\n\n1\n\n2\n\n3\n\n4\n\n\nfrom stadeo.cff.cff_strategies import CFFStrategies\n\nstrat = CFFStrategies(32)\n\nres = strat.process_all(0x0040b000,\n\nip=\"10.1.40.164\")\n\n\n**Partial output:**\n\nmapping: 0x00401020 -> 0x0040b000 with val None: 0xbadf00d\nskipping 0x00401670 with val None: 0xbadf00d\nmapping: 0x00401730 -> 0x0040b656 with val None: 0xbadf00d\n…\n\n\n-----\n\n_Figure 3. Example of obfuscated (left) and deobfuscated (right) function in Emotet_\n\n### Redirecting references to deobfuscated functions\n\nStadeo doesn’t automatically update references to functions after their deobfuscation. In the\nexample below, we demonstrate how to patch a function call in Figure 1 from the\n_Deobfuscating a single function example. The patched reference is shown in Figure 4._\n\nWe use the following code to patch calls, whose fourth parameter is 0x567C, to the\nobfuscated function at 0x1800158B0 with the deobfuscated one at 0x18008D000. Note that\none has to make sure that IDA has recognized parameters of the function correctly and\n[possibly fix them.](https://www.hex-rays.com/products/ida/support/idadoc/1361.shtml)\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n\nfrom stadeo.utils.xref_patcher import patch_xrefs\n\npatch_xrefs(0x1800158B0,\n\n0x18008D000,\n\n{3: 0x567c},\n\nip='10.1.40.164')\n\n_Figure 4. Patched reference_\n\n\n### Revealing obfuscated strings in a function\n\n\n-----\n\nThe function StringRevealer.process_funcs() reveals obfuscated strings in the specified\nfunction and returns a map of deobfuscated strings and their addresses.\n\nNote that control flow of the target function has to have been deobfuscated already.\n\nIn the example below, we deobfuscate the strings of the function at 0x100982B7, shown in\nFigure 5. The function itself was deobfuscated in the previous Processing reachable\n_functions example._\n\n\n1\n\n2\n\n3\n\n4\n\n\nfrom stadeo.string.string_revealer import StringRevealer\n\nsr = StringRevealer(32)\n\nstrings = sr.process_funcs([0x100982B7],\n\nip=\"10.1.40.164\")\n\n\n-----\n\n_Figure 5. Part of the function at 0x100982B7 which clearly assembles a string_\n\nContent of the strings variable after the execution is:\n\n1 {0x100982B7: {'SeLockMemoryPrivilege'}}\n\nWe hope that you find the Stadeo tools and this explanation of their use helpful. If you have\nany enquiries reach out to us at threatintel[at]eset.com or open an issue on\n[https://github.com/eset/stadeo.](https://github.com/eset/stadeo)\n\n7 Aug 2020 - 02:00PM\n\n\n-----\n\n### Sign up to receive an email update whenever a new article is published in our Ukraine Crisis – Digital Security Resource Center\n\n Newsletter\n\n Discussion\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-08-07 - Stadeo- Deobfuscating Stantinko and more.pdf"
    ],
    "report_names": [
        "2020-08-07 - Stadeo- Deobfuscating Stantinko and more.pdf"
    ],
    "threat_actors": [
        {
            "id": "f32df445-9fb4-4234-99e0-3561f6498e4e",
            "created_at": "2022-10-25T16:07:23.756373Z",
            "updated_at": "2025-03-27T02:02:09.966155Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "APT-C-26",
                "ATK 3",
                "Appleworm",
                "Citrine Sleet",
                "DEV-0139",
                "Diamond Sleet",
                "Gleaming Pisces",
                "Gods Apostles",
                "Gods Disciples",
                "Group 77",
                "Guardians of Peace",
                "Hastati Group",
                "Hidden Cobra",
                "ITG03",
                "Jade Sleet",
                "Labyrinth Chollima",
                "Lazarus Group",
                "NewRomanic Cyber Army Team",
                "Operation 99",
                "Operation AppleJeus",
                "Operation AppleJeus sequel",
                "Operation Blockbuster: Breach of Sony Pictures Entertainment",
                "Operation CryptoCore",
                "Operation Dream Job",
                "Operation Dream Magic",
                "Operation Flame",
                "Operation GhostSecret",
                "Operation In(ter)caption",
                "Operation LolZarus",
                "Operation Marstech Mayhem",
                "Operation No Pineapple!",
                "Operation North Star",
                "Operation Phantom Circuit",
                "Operation Sharpshooter",
                "Operation Ten Days of Rain / DarkSeoul",
                "Operation Troy",
                "SectorA01",
                "Slow Pisces",
                "TA404",
                "TraderTraitor",
                "UNC2970",
                "UNC4034",
                "UNC4736",
                "UNC4899",
                "UNC577",
                "Whois Hacking Team"
            ],
            "source_name": "ETDA:Lazarus Group",
            "tools": [
                "3CX Backdoor",
                "3Rat Client",
                "3proxy",
                "AIRDRY",
                "ARTFULPIE",
                "ATMDtrack",
                "AlphaNC",
                "Alreay",
                "Andaratm",
                "AngryRebel",
                "AppleJeus",
                "Aryan",
                "AuditCred",
                "BADCALL",
                "BISTROMATH",
                "BLINDINGCAN",
                "BTC Changer",
                "BUFFETLINE",
                "BanSwift",
                "Bankshot",
                "Bitrep",
                "Bitsran",
                "BlindToad",
                "Bookcode",
                "BootWreck",
                "BottomLoader",
                "Brambul",
                "BravoNC",
                "Breut",
                "COLDCAT",
                "COPPERHEDGE",
                "CROWDEDFLOUNDER",
                "Castov",
                "CheeseTray",
                "CleanToad",
                "ClientTraficForwarder",
                "CollectionRAT",
                "Concealment Troy",
                "Contopee",
                "CookieTime",
                "Cyruslish",
                "DAVESHELL",
                "DBLL Dropper",
                "DLRAT",
                "DRATzarus",
                "DRATzarus RAT",
                "Dacls",
                "Dacls RAT",
                "DarkComet",
                "DarkKomet",
                "DeltaCharlie",
                "DeltaNC",
                "Dembr",
                "Destover",
                "DoublePulsar",
                "Dozer",
                "Dtrack",
                "Duuzer",
                "DyePack",
                "ECCENTRICBANDWAGON",
                "ELECTRICFISH",
                "Escad",
                "EternalBlue",
                "FALLCHILL",
                "FYNLOS",
                "FallChill RAT",
                "Farfli",
                "Fimlis",
                "FoggyBrass",
                "FudModule",
                "Fynloski",
                "Gh0st RAT",
                "Ghost RAT",
                "Gopuram",
                "HARDRAIN",
                "HIDDEN COBRA RAT/Worm",
                "HLOADER",
                "HOOKSHOT",
                "HOPLIGHT",
                "HOTCROISSANT",
                "HOTWAX",
                "HTTP Troy",
                "Hawup",
                "Hawup RAT",
                "Hermes",
                "HotCroissant",
                "HotelAlfa",
                "Hotwax",
                "HtDnDownLoader",
                "Http Dr0pper",
                "ICONICSTEALER",
                "Joanap",
                "Jokra",
                "KANDYKORN",
                "KEYMARBLE",
                "Kaos",
                "KillDisk",
                "KillMBR",
                "Koredos",
                "Krademok",
                "LIGHTSHIFT",
                "LIGHTSHOW",
                "LOLBAS",
                "LOLBins",
                "Lazarus",
                "LightlessCan",
                "Living off the Land",
                "MATA",
                "MBRkiller",
                "MagicRAT",
                "Manuscrypt",
                "Mimail",
                "Mimikatz",
                "Moudour",
                "Mydoom",
                "Mydoor",
                "Mytob",
                "NACHOCHEESE",
                "NachoCheese",
                "NestEgg",
                "NickelLoader",
                "NineRAT",
                "Novarg",
                "NukeSped",
                "OpBlockBuster",
                "PCRat",
                "PEBBLEDASH",
                "PLANKWALK",
                "POOLRAT",
                "PSLogger",
                "PhanDoor",
                "Plink",
                "PondRAT",
                "PowerBrace",
                "PowerRatankba",
                "PowerShell RAT",
                "PowerSpritz",
                "PowerTask",
                "Preft",
                "ProcDump",
                "Proxysvc",
                "PuTTY Link",
                "QUICKRIDE",
                "QUICKRIDE.POWER",
                "Quickcafe",
                "QuiteRAT",
                "R-C1",
                "ROptimizer",
                "Ratabanka",
                "RatabankaPOS",
                "Ratankba",
                "RatankbaPOS",
                "RawDisk",
                "RedShawl",
                "Rifdoor",
                "Rising Sun",
                "Romeo-CoreOne",
                "RomeoAlfa",
                "RomeoBravo",
                "RomeoCharlie",
                "RomeoCore",
                "RomeoDelta",
                "RomeoEcho",
                "RomeoFoxtrot",
                "RomeoGolf",
                "RomeoHotel",
                "RomeoMike",
                "RomeoNovember",
                "RomeoWhiskey",
                "Romeos",
                "RustBucket",
                "SHADYCAT",
                "SHARPKNOT",
                "SIGFLIP",
                "SIMPLESEA",
                "SLICKSHOES",
                "SORRYBRUTE",
                "SUDDENICON",
                "SUGARLOADER",
                "SheepRAT",
                "SierraAlfa",
                "SierraBravo",
                "SierraCharlie",
                "SierraJuliett-MikeOne",
                "SierraJuliett-MikeTwo",
                "SimpleTea",
                "SimplexTea",
                "SmallTiger",
                "Stunnel",
                "TAINTEDSCRIBE",
                "TAXHAUL",
                "TFlower",
                "TOUCHKEY",
                "TOUCHMOVE",
                "TOUCHSHIFT",
                "TOUCHSHOT",
                "TWOPENCE",
                "TYPEFRAME",
                "Tdrop",
                "Tdrop2",
                "ThreatNeedle",
                "Tiger RAT",
                "TigerRAT",
                "Trojan Manuscript",
                "Troy",
                "TroyRAT",
                "VEILEDSIGNAL",
                "VHD",
                "VHD Ransomware",
                "VIVACIOUSGIFT",
                "VSingle",
                "ValeforBeta",
                "Volgmer",
                "Vyveva",
                "W1_RAT",
                "Wana Decrypt0r",
                "WanaCry",
                "WanaCrypt",
                "WanaCrypt0r",
                "WannaCry",
                "WannaCrypt",
                "WannaCryptor",
                "WbBot",
                "Wcry",
                "Win32/KillDisk.NBB",
                "Win32/KillDisk.NBC",
                "Win32/KillDisk.NBD",
                "Win32/KillDisk.NBH",
                "Win32/KillDisk.NBI",
                "WinorDLL64",
                "Winsec",
                "WolfRAT",
                "Wormhole",
                "YamaBot",
                "Yort",
                "ZetaNile",
                "concealment_troy",
                "http_troy",
                "httpdr0pper",
                "httpdropper",
                "klovbot",
                "sRDI"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535736,
    "ts_updated_at": 1743041118,
    "ts_creation_date": 1653705940,
    "ts_modification_date": 1653705940,
    "files": {
        "pdf": "https://archive.orkl.eu/98c318f6523c1aeb27953aaa17bf8fc0edb3249f.pdf",
        "text": "https://archive.orkl.eu/98c318f6523c1aeb27953aaa17bf8fc0edb3249f.txt",
        "img": "https://archive.orkl.eu/98c318f6523c1aeb27953aaa17bf8fc0edb3249f.jpg"
    }
}