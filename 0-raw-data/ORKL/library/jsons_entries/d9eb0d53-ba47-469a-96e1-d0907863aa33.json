{
    "id": "d9eb0d53-ba47-469a-96e1-d0907863aa33",
    "created_at": "2023-01-12T15:05:51.992524Z",
    "updated_at": "2025-03-27T02:17:27.695929Z",
    "deleted_at": null,
    "sha1_hash": "1c6bd1d0e911528da555b3bca05fc5049eb3b111",
    "title": "2019-09-18 - Chirp of the PoisonFrog",
    "authors": "",
    "file_creation_date": "2022-05-28T15:11:29Z",
    "file_modification_date": "2022-05-28T15:11:29Z",
    "file_size": 1111154,
    "plain_text": "# DNS Tunneling Series, Part 1: Chirp of the PoisonFrog\n\n**ironnet.com/blog/chirp-of-the-poisonfrog/**\n\n\n-----\n\nSep 18, 2019\n\nBy Jonathan Lepore\n\n_NOTE: This is part 1 of 3 of this DNS Tunneling series. Be sure to check out part 2 (\"A_\nglimpse into glimpse\") and [part 3 (\"The siren song of RogueRobin\").](https://ironnet.com/blog/dns-tunneling-series-part-3-the-siren-song-of-roguerobin)\n\n## Intro\n\n[DNS tunneling is an abuse of the DNS protocol that provides adversaries with a covert](https://medium.com/@galolbardes/learn-how-easy-is-to-bypass-firewalls-using-dns-tunneling-and-also-how-to-block-it-3ed652f4a000)\ncommunication channel. The prevalence of DNS traffic, coupled with the option of using the\nnative DNS architecture to avoid direct connections with malicious infrastructure, make DNS\ntunneling an attractive protocol for adversaries to abuse.\n\nIn order to better understand and detect the threat of DNS tunneling, the IronNet Threat\nResearch team analyzed several samples of malware that use DNS tunneling and the\nevasive tactics used by each specific malware. In this blog post, the IronNet Threat\n[Research team examines the PoisonFrog malware that is written in PowerShell and has](https://www.cyberscoop.com/powershell-attacks-cybercrime-ibm-xforce-report/)\n[been associated to OilRig/APT34.](https://unit42.paloaltonetworks.com/dns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling/)\n\n## Sample\n\n**Sample** **MD5 Hash**\n\n\n-----\n\nPoisonFrog (dUpdater.ps1) 477296cc6b85584f0706d2384f22b96e\n\n## Overview\n\nAt the most basic level,\n\nmalware that employs DNS tunneling needs to be able to both generate and receive crafted\nDNS queries and responses. These messages allow the malware to register with its\ncontroller, check for tasking, send and receive files, communicate results, and carry out other\ntasks. This method of command and control requires the attacker to have control over both\nthe malicious domain and an authoritative DNS server. The use of DNS communications\nwithin malware can vary. For example, some communications make direct connections to\ncontrollers while others opt to use recursion, allowing for a natural flow across the victim’s\nDNS infrastructure. PoisonFrog uses the latter; recursion enables the DNS communications\nto traverse the DNS architecture of the victim’s environment and avoids direct connections to\nthe controller. The diagram to our right is a contrived example of a recursive architecture.\n\n### PoisonFrog DNS Invocation and Resource Records\n\n\n-----\n\nPoisonFrog uses the .NET method [System.Net.Dns]::GetHostAddresses to issue command\nand control related DNS queries. These queries send data to their controllers through the\nuse of encoded subdomain labels in a DNS query. For PoisonFrog’s communications an “A”\nresource record query is used, however this presents various limitations. For instance,\nPoisonFrog’s receive functions are limited to the first three octets of a DNS A record. Since\nonly three bytes can be received at a time, transferring large amounts of data will result in a\nburst of many DNS queries over a short period of time. Transfering a single kilobyte of data\nin this mode would generate several hundred DNS queries.\n\nIt is interesting to note that the .NET method GetHostAddresses has the ability to return an\narray of IP addresses. PoisonFrog could have easily reduced the number of DNS replies\nneed to transfer data by providing several IP addresses in a single DNS response. Due to\nthe 512-byte limit on non-EDNS responses, the adversary need only ensure that responses\nare kept below this limit to prevent data truncation or the need to switch to TCP\ncommunications. For unknown reasons, the adversary did not take advantage of this more\nefficient method of data transfer in the version analyzed, opting to process only the first IP\naddress received.\n\nDespite DNS being a mechanism for covert command and control, it should be noted that\nmost sophisticated malware will have a backup plan. Should the malware be unable to\ncommunicate over DNS, PoisonFrog comes packaged with an HTTP-based version of itself\nwhich runs concurrently with the DNS tunneling PowerShell script. The IronNet Threat\nResearch team will examine PoisonFrog’s HTTP command and control in a future post.\n\n### Analysis of PoisonFrog DNS Tunneling\n\nThe core functionality of PoisonFrog DNS tunneling is to download or upload files and\nexecute PowerShell commands sent as tasking by the controller. It is worth noting the\nPoisonFrog installer contains a Powershell script (hUpdater.ps1) capable of limited command\nand control via HTTP. However, for the purpose of this post we will focus on the DNS\ntunneling capabilities.\n\nAt its core, PoisonFrog is a PowerShell script designed to be invoked every ten minutes by\nsetting itself up as a Windows task. Each time the script is invoked, it creates a DNS query to\nannounce its presence to its controller and checks to see if there are any tasks to be\nperformed. It then processes tasks and sends the results back to the controller. Additionally,\nit sets up several working directories which it uses for file-based operations. Examples of\nthese working directories are shown in the table below.\n\n\n-----\n\n### Communications with Controller\n\nPoisonFrog relies solely on DNS A records for communications. These communications are\nissued via calls to .NET class method [System.Net.Dns]::GetHostAddresses. To receive\ntasking, PoisonFrog generates DNS requests and interprets the received IP address\nresponses. Once tasking is received, it processes the tasks and sends the results back to its\ncontroller. This process is performed via more complex, specially-crafted DNS requests.\n\nTo build a DNS query properly, PoisonFrog first generates an agent ID used for building all\nfuture DNS requests. The generation procedure involves using the first ten characters of the\nstring “atag121234567890,” where UUID is obtained from a WMI query for\nWin32_ComputerSystemProduct’s UUID property, after removing dashes.\n\nA DNS request is built by calling a function with several parameters. The most important\nparameters are the action, the payload, an associated file name, and whether the malware is\nsending tasking results or receiving tasking. When calling the function to create a request for\ntasking, the payload and associated file names are empty. These parameters are populated\nonly when sending results back to the controller, a process which will be discussed later in\nthis article.\n\n### Checking For and Receiving Tasks\n\nFor requests to receive or check for tasking, PoisonFrog builds a query in the following\nformat:\n\n[control data][management data].[domain]\n\nHere, [control data] is the agent ID into which a one-character action and three-character\nrequest number are randomly inserted. The positions of these randomly-inserted values are\nsubsequently embedded in management data so the controller knows where to find them.\n\nNext, [management data] is built as follows:\n\n[1 to 7 random hex characters]A[index of request number][index of action]7\n\n\n-----\n\nThe characters A and 7 are hardcoded separators that indicate the zero-based indices\nwhere the request number and action can be found the control data.\n\nConsider an example DNS query of ata005g1128931B75FEC6A357.myleftheart[.]com where\nthe offset for the request number is 005 with a chosen random offset of 3 and an action of 1\nwith a chosen offset of 5. PoisonFrog first inserts the action at the chosen offset and then the\nrequest number. The table below illustrates how this process is completed:\n\nTo understand the entire DNS request generated by PoisonFrog to check for tasking,\nconsider the following example of ata000g1028931B75FEC6A357.myleftheart[.]com, which\nbreaks down as follows:\n\n\n-----\n\nAction values indicate in which mode the malware is operating and have the following\nmeanings:\n\nAfter checking for tasking, the controller will send the appropriate IP address in response.\nThe following table shows the various IP addresses that can be sent and their meanings. In\nthe table, the step value indicates the order in which these steps will occur to successfully\ntransfer tasking to PoisonFrog:\n\n\n-----\n\nOnce the tasking is saved to a file, PoisonFrog will exit its receive loop and begin to process\nthe tasking. The tasking is processed by examining the last character in the filename\nreceived in step 1 above () and performing the following operations:\n\n### Sending Task Results\n\nAfter processing the tasking, PoisonFrog transmits the results back to the controller by\nsending the controller DNS requests encoded with the exfiltrated data. PoisonFrog then\nbreaks up the data into smaller messages to be sent with payload chunks of up to a\nmaximum size of 60 bytes. The controller data is sent using the DNS request builder function\n\n\n-----\n\nfrom above, this time in send mode. The send mode DNS request now includes more fields\nfor this payload data and an associated file name, both of which are encoded using a\nfunction called “resolver” which marshals the data to be transmitted by rearranging the\nnibbles of each byte. The resolver function is explained in further detail below.\n\nOnce the payload has been resolver-encoded, PoisonFrog prepends the string “bWV0YT”\n(without quotes) to it to indicate the start of the transmission of tasking results. Next begins a\nloop of DNS requests, each containing a chunk of the payload until the contents have been\ncompletely transferred. To signal completion of the file transfer, PoisonFrog will issue a final\nDNS request containing a payload solely consisting of the string “bWV0YTZW5k” (without\nquotes). When transmitting tasking results to the controller, an action mode of “2” is used.\n\nThe table below shows an example of the complete exfiltration of a file containing the output\nof the ‘hostname’ command:\n\nUsing the example above, a more detailed breakdown of chunk #0 is provided below:\n\n\n-----\n\nFor each DNS request issued, the controller can respond with an IP address of\n11.24.237.110 (indicating the transmission should be cancelled) or an IP address of the\nformat 1.2.3.[X], where [X] is used to request sending the next chunk of data.\n\n### Resolver Function - Data Marshaling Strings/Byte Arrays\n\nPoisonFrog prepares its payload and filename data for transmission using a function called\nresolver. This function takes 30-bytes at a time and extracts the first nibble of each byte and\nconcatenates them together. Next, it concatenates the second nibble of each byte and\nappends that to the first string. This is repeated until the data is consumed. For example,\nconsider the string \"helloworld\" in the example below:\n\n\n-----\n\nThe original byte stream for this is:\n\nThe resulting byte stream is rearranged as follows:\n\n## Conclusion\n\n\n-----\n\nMalware communications today can use a number of web-based protocols to communicate\nwith C2 servers. While HTTP, TLS, and other protocol abuse may get more attention in the\nnews, our analysis of PoisonFrog shows how DNS Tunneling is still an effective means of\ncovert communications. While PoisonFrog is a fairly standard malware that does not\nleverage sophisticated scripting or specific vulnerabilities, it can still be highly effective in\nevading detection by firewalls, endpoints, proxies, or other signature-based or outlier-based\nnetwork controls since adversaries can easily change or rotate domains, IPs, and hardcoded\nvalues to a range of stable destinations that are not identified or categorized as malicious by\ndomain reputation or threat intel sources. Consistently detecting adaptive malware such as\nPoisonFrog, will require a behavioral analysis solution and that can identify underlying\nnetwork communication patterns.\n\n[In our next blog, we will examine the DNS Tunneling capability of Glimpse, which also has](https://ironnet.com/blog/a-glimpse-into-glimpse/)\nbeen linked to the OilRig/APT34 threat group.\n\n[Go to DNS Tunneling: part 2 (\"A glimpse into glimpse\").](https://ironnet.com/blog/a-glimpse-into-glimpse)\n\n_[Follow the IronNet Threat Research team @IronNetTR.](https://twitter.com/IronNetTR)_\n\nAbout Ironnet\n\nFounded in 2014 by GEN (Ret.) Keith Alexander, IronNet, Inc. (NYSE: IRNT) is a global\ncybersecurity leader that is transforming how organizations secure their networks by\ndelivering the first-ever Collective Defense platform operating at scale. Employing a number\nof former NSA cybersecurity operators with offensive and defensive cyber experience,\nIronNet integrates deep tradecraft knowledge into its industry-leading products to solve the\nmost challenging cyber problems facing the world today.\n\n[Back to IronNet Blog](https://www.ironnet.com/blog)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-09-18 - Chirp of the PoisonFrog.pdf"
    ],
    "report_names": [
        "2019-09-18 - Chirp of the PoisonFrog.pdf"
    ],
    "threat_actors": [
        {
            "id": "ce10c1bd-4467-45f9-af83-28fc88e35ca4",
            "created_at": "2022-10-25T15:50:23.458833Z",
            "updated_at": "2025-03-27T02:00:55.475188Z",
            "deleted_at": null,
            "main_name": "APT34",
            "aliases": null,
            "source_name": "MITRE:APT34",
            "tools": [
                "netstat",
                "Systeminfo",
                "PsExec",
                "SEASHARPEE",
                "Tasklist",
                "Mimikatz",
                "POWRUNER",
                "certutil"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3eebdb3f-f4e3-42e5-bb4d-f02a13328316",
            "created_at": "2024-05-01T02:03:08.014303Z",
            "updated_at": "2025-03-27T02:05:17.306592Z",
            "deleted_at": null,
            "main_name": "COBALT EDGEWATER",
            "aliases": [
                "Cold River ",
                "DNSpionage ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT EDGEWATER",
            "tools": [
                " DNSpionage",
                " Karkoff",
                " MailDropper",
                " SideTwist",
                " TWOTONE",
                "AgentDrable"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535951,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1653750689,
    "ts_modification_date": 1653750689,
    "files": {
        "pdf": "https://archive.orkl.eu/1c6bd1d0e911528da555b3bca05fc5049eb3b111.pdf",
        "text": "https://archive.orkl.eu/1c6bd1d0e911528da555b3bca05fc5049eb3b111.txt",
        "img": "https://archive.orkl.eu/1c6bd1d0e911528da555b3bca05fc5049eb3b111.jpg"
    }
}