{
    "id": "187ff753-6d44-4eea-8ca0-b3c95d22a383",
    "created_at": "2023-01-12T15:03:07.299596Z",
    "updated_at": "2025-03-27T02:05:26.338466Z",
    "deleted_at": null,
    "sha1_hash": "2d902c8080954465d4b3067e94cef1d6f58873c3",
    "title": "2021-12-30 - Technical Analysis of Khonsari Ransomware Campaign Exploiting the Log4Shell Vulnerability",
    "authors": "",
    "file_creation_date": "2022-05-29T16:22:47Z",
    "file_modification_date": "2022-05-29T16:22:47Z",
    "file_size": 2262233,
    "plain_text": "# Technical Analysis of Khonsari Ransomware Campaign Exploiting the Log4Shell Vulnerability\n\n**[cloudsek.com/technical-analysis-of-khonsari-ransomware-campaign-exploiting-the-log4shell-vulnerability/](https://cloudsek.com/technical-analysis-of-khonsari-ransomware-campaign-exploiting-the-log4shell-vulnerability/)**\n\nAnandeshwar Unnikrishnan December 30, 2021\n\nThe [Log4J vulnerability, which is being actively exploited in the wild, has led to a significant](https://cloudsek.com/threatintelligence/log4shell-multiple-critical-vulnerabilities-updated-advisory/)\nspike in ransomware attacks and has paved the way for more. Joining the list of low effort\nransomware groups that are adding the Log4shell vulnerability to their arsenal, we have the\nKhonsari ransomware, which is a skidware.\n\nThe Khonsari ransomware is written in C# .NET, with minimal code complexity in terms of\nfeatures and capabilities. Recently it has been observed that the group has started dropping\nOrcus RAT to gain initial entry, by exploiting Log4shell vulnerability, to execute loaders\nwritten in Java to deploy the RAT.\n\n## Modus Operandi of the Khonsari Campaign\n\nThe Khonsari group targets vulnerable Log4shell systems to drop multiple Java payloads\nthat act as secondary stagers for either ransomware code or Orcus RAT deployment. In this\nreport, we cover technical details of Khonsari campaigns in the wild.\n\n\n-----\n\nOverview of the Khonsari campaign\n\n## Analysis of Orcus Rat Dropper\n\nBy exploiting Log4shell vulnerability the Khonsari group executes the Java class\n_hxxp://3.145.115.94/Main.class to download a secondary payload._\nThe secondary payload is a dropper written in Java that detonates Orcus RAT, on the\ntarget system, to gain initial access .\n\n\n-----\n\nThe dropper detonates Orcus RAT\n\nThe payload Main.class, when executed, downloads a\n_hxxp://test.verble.rocks/dorflersaladreviews.jar file from an external resource controlled_\nby the attacker, as highlighted by the red box in the image below.\n\nExecution of the Main.class payload\n\nThe above Java code creates a file fengvp.peedee in the temporary directory of the\nuser and the contents of dorflersaladreviews.jar, retrieved from the URL, are written to\nthe file.\nLater as highlighted by the yellow box, in the above image, the .pedee file is executed\non the target system leading to execution of Orcus RAT.\n\n_dorflersaladreviews.jar (fengvp.peedee) is a Java dropper that deploys the infamous_\nOrcus RAT on the target system.\nThe Java Dropper package consists of 3 classes that perform various malicious\nfunctions on the system, including:\n\nRetrieving the Orcus RAT shellcode hosted on attacker infrastructure\nExecuting the shellcode using Win32 APIs\nUsing a custom encoding of strings to hinder analysis, since all of the strings\nused in the code are encoded.\nAs seen in the image below, the dropper then makes an HTTP connection to the URL\n_hxxp://test.verble.rocks/dorflersaladreviews.bin.encrypted that contains the Orcus RAT_\nshellcode.\n\n\n-----\n\nDropper makes an HTTP connection to the RAT URL\n\nThe following section of the dropper finally executes the shellcode on the system using\nvarious native Win32 APIs.\n\nDropper executing the shellcode\n\nThe process of shellcode execution involves:\n\nCreating a new process (console host) via Win32 API CreateProcess()\nAllocating a memory region, in the remote process, via Win32 API\nVirtualAllocEx()\nWriting the Orcus RAT shellcode, into remote process memory allocated\npreviously, via Win32 API WriteProcessMemory()\nFinally executing the shellcode by creating a thread via Win32 API\nCreateRemoteThread()\n\nSuccessful execution of Orcus RAT gives the attacker access to the target system.\nSubsequently, the attacker can deploy ransomware on the target system or laterally move\nacross the network to hunt down high-value targets such as Domain Controllers in the MS\nActive Directory environment.\n\n## Analysis of Khonsari Ransomware Code\n\nKhonsari ransomware is written in C# .NET with an x86 architecture.\nThe developer has obfuscated the code by changing class and object names to\nrandom strings as shown in the image below.\n5 classes are present in the code that perform various malicious activities on the target\nsystem.\n\nObfuscated Classes\n\n\n-----\n\nThroughout the code we see the use of encoded string values. This behaviour is\ninherent to a malware developer to enforce operational security by hiding important\nstring values through a custom encoding mechanism.\nCustom decoder can be found in the code as shown below, which is a simple rolling\nXOR encoding scheme. The below logic can be reproduced in any language by the\nanalyst to decode the strings used in the malware.\n\nString decoder logic\n\n### Initialization of Encryption Keys\n\nThe execution starts with initializing the class constructor of the class that has the main\nfunction defined in it.\nInside the constructor, the malware initialises the AES key and Initialisation Vector (IV),\nused for encryption of user data on the target system, as shown in the red box in the\nimage below.\nThe encoded strings are ransom note contents. The contents of the ransom note is\ngenerated and stored in a class field.\n\n### Generation of the Ransom Note\n\nAs highlighted in the yellow box in the image below, the PruZnHLM method is\nresponsible for encrypting the AES key and IV using the RSA cryptographic algorithm.\nIn essence, the malware uses the ransom note contents to store the critical data\nneeded for decryption of user data.\nIf the user deletes the ransom note then the data cannot be recovered. At this stage,\nthe ransomware only initializes variables with generated data.\n\n\n-----\n\nInitialization phase\n\nThe generated ransom note contains the AES key and IV encrypted with the RSA\nalgorithm. The Key and IV are very crucial elements in the decryption process. The\ndata cannot be recovered if the ransom note is deleted or modified.\n\nCryptographic process of the malware\n\n### Server Connection Check\n\nAfter the encryption process, the main() function of the program is executed. The first\ntask of this function is to get a remote text file from an external resource on the Internet\ncontrolled by the attacker.\nThe encoded string represents the following information:\nhxxp://3[.]145[.]115[.]94/zambos_caldo_de_p[.]txt\n\n\n-----\n\nBased on our analysis, this phase does not have any significant role in overall\nfunctionality of the ransomware. Our assumption is that it is used as a status check,\nsince no data can be seen flowing between the victim and server. However, when the\nmalware is not able to reach the server it stops executing. Indicating that this is used as\na control to detonate the malware.\n\nCalling Home\n\n### Directory Enumeration\n\nAfter the connection check, the malware immediately starts enumerating the directories\nof the target system.\nAs highlighted in the image below, the red box shows the malware performing a check\nto exclude the C:\\ drive, where the string is dynamically decoded by the XOR scheme.\nHowever, the remaining drives of the target system are added to a list to be encrypted\nlater. .\nAs highlighted by the yellow box in the image below, the malware adds user\n_Downloads (decoded string), along with Desktop directory, to target directories for_\nencryption.\n\n\n-----\n\nDirectory Enumeration\n\n### Encryption of Victim Files\n\nAfter the directory enumeration process, the malware starts the encryption process:\n\nDirectory traversal logic is implemented in the function bXUaefgt shown in enum-1a.\nThe code logic is simple; each directory added to the list by the malware is traversed to\nreturn an array containing the files.\n\n\n-----\n\nEnum-1a\n\n\nEnum-1a\n\nAs seen in Encr-1a, the contents of the directory are encrypted. The method\n_rVWZTCXX is responsible for implementing AES cryptography as shown in the image_\nEncr-1b.\nAfter encrypting the user data, the malware stores the encrypted contents in a new file\nwith the extension .khonsari (decoded string)as highlighted in the yellow box in Encr1a.\n\n\n-----\n\nEncr-1a\n\n\n-----\n\nEncb-1b\n\n\nEncr-1b\n\nWhile encrypting, the malware checks for the file extensions, as shown in the image\nbelow. And files with .khonsari, .ini, and ink are skipped from locking. It is interesting\nthat the ransomware encrypts .ink files because of the typo in the last check, where the\ndeveloper has used ink instead of .ink.\n\n\n-----\n\nFile extension check\n\n### Creation of the Ransom Note\n\nFinally, the ransomware code writes the ransom note into the user’s Desktop directory\nwith the file name HOW TO GET YOUR FILES BACK.TXT.\n\nRansom_note\n\nFollowing table summarises the contents of class fields HtqeFwaI and rbTApefo shown\nin the image Ransom_note_1a:\n\n**Class Field** **Data Value**\n\nHtqeFwaI C:\\Users\\<user_name>\\Desktop\\HOW TO GET YOUR FILES BACK.TXT\n\nrbTApefo RSA encrypted(AES key and IV) along with ransom note content\n\n## Indicators of Compromise (IOCs)\n\n2e3f685256e5f31b05fc9f9ca470f527d7fdae28fa3190c8eba179473e2078\n\nefbc218dfff5c4d9e4b1449380fd31a0380aee8cdfede1356ef20a986342b300\n\nhxxp://3.145.115.94/Main.class\n\nhxxp://3.145.115.94/zambos_caldo_de_p.txt\n\nhxxp://3.145.115.94/zambo/groenhuyzen.exe\n\n\n-----\n\nhxxp://test.verble.rocks/dorflersaladreviews.bin.encrypted\n\nhxxp://test.verble.rocks/dorflersaladreviews.jar\n\n3.145.115.94\n\n192.168.0.115\n\n209.197.3.8\n\n13.107.4.52\n\n23.216.147.76\n\nec2-3-145-115-94.us-east-2.compute.amazonaws.com\n\nAuthor Details\n\n[Anandeshwar Unnikrishnan](https://cloudsek.com/author/anadeshwar-unnikrishnan/)\nThreat Intelligence Researcher, [CloudSEK](https://cloudsek.com/)\nAnandeshwar is a Threat Intelligence Researcher at CloudSEK. He is a strong advocate of\noffensive cybersecurity. He is fuelled by his passion for cyber threats in a global context. He\ndedicates much of his time on Try Hack Me/ Hack The Box/ Offensive Security Playground.\nHe believes that “a strong mind starts with a strong body.” When he is not gymming, he finds\ntime to nurture his passion for teaching. He also likes to travel and experience new cultures.\n\n\n-----\n\n[Isha Tripathi](https://cloudsek.com/author/isha-tripathi/)\nTotal Posts: 0\nIsha is an engineer in the making, who also has an enthusiasm for everything ranging across\nscience, technology and literature. A jack of all trades and master of none, she enjoys\nlearning new skills and discussing world affairs.\n×\n\n[Anandeshwar Unnikrishnan](https://cloudsek.com/author/anadeshwar-unnikrishnan/)\nThreat Intelligence Researcher, [CloudSEK](https://cloudsek.com/)\nAnandeshwar is a Threat Intelligence Researcher at CloudSEK. He is a strong advocate of\noffensive cybersecurity. He is fuelled by his passion for cyber threats in a global context. He\ndedicates much of his time on Try Hack Me/ Hack The Box/ Offensive Security Playground.\nHe believes that “a strong mind starts with a strong body.” When he is not gymming, he finds\ntime to nurture his passion for teaching. He also likes to travel and experience new cultures.\n\nLatest Posts\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-30 - Technical Analysis of Khonsari Ransomware Campaign Exploiting the Log4Shell Vulnerability.pdf"
    ],
    "report_names": [
        "2021-12-30 - Technical Analysis of Khonsari Ransomware Campaign Exploiting the Log4Shell Vulnerability.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535787,
    "ts_updated_at": 1743041126,
    "ts_creation_date": 1653841367,
    "ts_modification_date": 1653841367,
    "files": {
        "pdf": "https://archive.orkl.eu/2d902c8080954465d4b3067e94cef1d6f58873c3.pdf",
        "text": "https://archive.orkl.eu/2d902c8080954465d4b3067e94cef1d6f58873c3.txt",
        "img": "https://archive.orkl.eu/2d902c8080954465d4b3067e94cef1d6f58873c3.jpg"
    }
}