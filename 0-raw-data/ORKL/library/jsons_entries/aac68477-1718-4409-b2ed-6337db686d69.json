{
    "id": "aac68477-1718-4409-b2ed-6337db686d69",
    "created_at": "2022-10-25T16:48:20.726236Z",
    "updated_at": "2025-03-27T02:05:53.682152Z",
    "deleted_at": null,
    "sha1_hash": "c6a687eb03b7fafeb57dfc0604732b26bbaf4c9a",
    "title": "",
    "authors": "",
    "file_creation_date": "2020-07-24T15:04:16Z",
    "file_modification_date": "2020-07-24T15:04:16Z",
    "file_size": 276085,
    "plain_text": "# Alert: Potential legacy risk from malware targeting QNAP NAS devices\n\n### Version 1.0\n\n 27July 2020\n\n © Crown Copyright 2020\n\n\n1 of 6\n\n\n-----\n\n## About this document\n\nThis report provides details of the malware Qsnatch (also known as ‘Derek’) from\nNCSC, CISA and industry partner analysis.\n\nIt includes indicators of compromise as well as detection and mitigation advice.\n\n## Disclaimer\n\nThis report draws on information derived from multiple sources. Any NCSC findings\nand recommendations made have not been provided with the intention of avoiding all\nrisks, and following the recommendations will not remove all such risk. Ownership of\ninformation risks remains with the relevant system owner at all times.\n\n2 of 6\n\n\n-----\n\n_This is a joint alert from the United Kingdom’s National Cyber Security Centre (NCSC)_\n_and the Cybersecurity and Infrastructure Security Agency (CISA) in the United States._\n\n## Introduction \n\nThe NCSC and CISA are investigating a strain of malware called QSnatch (also known\nas ‘Derek’), which attackers used in late 2019 to target Network Attached Storage\n(NAS) devices manufactured by the firm QNAP.\n\nAll QNAP NAS devices are potentially vulnerable to QSnatch malware if not updated\nwith the latest security fixes. The malware, documented in open-source reports,[1] has\ninfected thousands of devices worldwide with a particularly high number of infections\nin North America and Europe.[2] Further, once a device has been infected, attackers\ncan prevent administrators from successfully running firmware updates.\n\nThis alert summarises the findings of NCSC,CISA and industry partner analysis and\nprovides mitigation advice.\n\n## Details\n\n### Campaigns \n\nThe NCSC and CISA have identified two campaigns of activity for QSnatch malware.\nThe first campaign likely began in early 2014 and continued until mid-2017, while the\nsecond started in late 2018 and was still active in late 2019. The two campaigns are\ndistinguished by the initial payload used as well as some differences in capabilities.\nThis alert focuses on the second campaign as it is the most recent threat.\n\nIt is important to note that infrastructure used by the malicious cyber actors in both\ncampaigns is not currently active, but the threat remains to unpatched devices.\n\nAlthough the identities and objectives of the malicious cyber actors using QSnatch are\ncurrently unknown, the malware is relatively sophisticated, and the cyber actors\ndemonstrate an awareness of operational security.\n\n### Global distribution of infections \n\nAnalysis shows a significant number of infected devices. In mid-June 2020, there were\napproximately 62,000 infected devices worldwide; of these, approximately 3,900 were\nin the UK and 7,600 were in the US. Figure 1 below shows the location of these\ndevices in broad geographic terms.\n\n1 [https://www.zdnet.com/article/thousands-of-qnap-nas-devices-have-been-infected-with-the-qsnatch-](https://www.zdnet.com/article/thousands-of-qnap-nas-devices-have-been-infected-with-the-qsnatch-malware/)\n[malware/](https://www.zdnet.com/article/thousands-of-qnap-nas-devices-have-been-infected-with-the-qsnatch-malware/)\n2 Ibid\n\n3 of 6\n\n\n-----\n\n_Figure 1: Location QNAP NAS devices infected by QSnatch_\n\n### Delivery and exploitation\n\nThe infection vector has not been identified, but QSnatch appears to be injected into\nthe device firmware during the infection stage, with the malicious code subsequently\nrun within the device, compromising it. The attacker then uses a domain generation\nalgorithm (DGA) to establish a command and control (C2) channel that periodically\ngenerates multiple domain names for use in C2 communications, using the following\nHTTP GET request:\n```\nHTTP GET https://[generated-address]/qnap_firmware.xml?=t[timestamp][3]\n\n### Malware functionalities \n\n```\nAnalysis shows that QSnatch malware contains multiple functionalities, such as:\n\n  - **CGI password logger**\n```\n    o This installs a fake version of the device admin login page, logging\n\n```\nsuccessful authentications and passing them to the legitimate login\npage.\n\n  - **Credential scraper**\n\n  - **SSH backdoor**\n```\n    o This allows the cyber actor to execute arbitrary code on a device.\n\n```\n  - **Exfiltration**\n```\n    o When run, QSnatch steals a predetermined list of files, which includes\n\n```\nsystem configurations and log files. These are encrypted with the actor’s\npublic key and sent to their infrastructure over HTTPS.\n\n3 [https://www.kyberturvallisuuskeskus.fi/en/news/qsnatch-malware-designed-qnap-nas-devices](https://www.kyberturvallisuuskeskus.fi/en/news/qsnatch-malware-designed-qnap-nas-devices)\n\n4 of 6\n\n\n-----\n\n  - **Webshell functionality for remote access**\n\n### Persistence\n\nThe malware appears to gain persistence by preventing updates from installing on the\ninfected QNAP device. The attacker modifies the system host’s file, redirecting core\ndomain names used by the NAS to local out-of-date versions so updates can never\nbe installed.\n\n### Samples\n\nThe following tables provide hashes of related QSnatch samples found in open-source\nmalware repositories. File types fall into two buckets: (1) shell scripts (see table 1) and\n(2) shell script compiler (SHC)-compiled executable and linking format (ELF) shell\nscripts (see table 2). One notable point is that some samples intentionally patch the\ninfected QNAP for Samba remote code execution vulnerability CVE-2017-7494.\n\n_Table 1: QSnatch samples – shell scripts_\n\n**SH Samples (SHA256)**\n```\n09ab3031796bea1b8b79fcfd2b86dac8f38b1f95f0fce6bd2590361f6dcd6764\n3c38e7bb004b000bd90ad94446437096f46140292a138bfc9f7e44dc136bac8d\n8fd16e639f99cdaa7a2b730fc9af34a203c41fb353eaa250a536a09caf78253b\n473c5df2617cee5a1f73880c2d66ad9668eeb2e6c0c86a2e9e33757976391d1a\n55b5671876f463f2f75db423b188a1d478a466c5e68e6f9d4f340396f6558b9f\n9526ccdeb9bf7cfd9b34d290bdb49ab6a6acefc17bff0e85d9ebb46cca8b9dc2\n4b514278a3ad03f5efb9488f41585458c7d42d0028e48f6e45c944047f3a15e9\nfa3c2f8e3309ee67e7684abc6602eea0d1d18d5d799a266209ce594947269346\n18a4f2e7847a2c4e3c9a949cc610044bde319184ef1f4d23a8053e5087ab641b\n9791c5f567838f1705bd46e880e38e21e9f3400c353c2bf55a9fa9f130f3f077\na569332b52d484f40b910f2f0763b13c085c7d93dcdc7fea0aeb3a3e3366ba5d\na9364f3faffa71acb51b7035738cbd5e7438721b9d2be120e46b5fd3b23c6c18\n62426146b8fcaeaf6abb24d42543c6374b5f51e06c32206ccb9042350b832ea8\n5cb5dce0a1e03fc4d3ffc831e4a356bce80e928423b374fc80ee997e7c62d3f8\n5130282cdb4e371b5b9257e6c992fb7c11243b2511a6d4185eafc0faa0e0a3a6\n15892206207fdef1a60af17684ea18bcaa5434a1c7bdca55f460bb69abec0bdc\n3cb052a7da6cda9609c32b5bafa11b76c2bb0f74b61277fecf464d3c0baeac0e\n13f3ea4783a6c8d5ec0b0d342dcdd0de668694b9c1b533ce640ae4571fdbf63c\n\n```\n5 of 6\n\n\n-----\n\n_Table 2: QSNATCH samples - SHC-compiled ELF shell scripts_\n\n**SH Samples (SHA256)**\n```\n18a4f2e7847a2c4e3c9a949cc610044bde319184ef1f4d23a8053e5087ab641b\n3615f0019e9a64a78ccb57faa99380db0b36146ec62df768361bca2d9a5c27f2\n845759bb54b992a6abcbca4af9662e94794b8d7c87063387b05034ce779f7d52\n6e0f793025537edf285c5749b3fcd83a689db0f1c697abe70561399938380f89\n\n## Mitigation \n\n```\nAs stated above, once a device has been infected, attackers have been known to\nmake it impossible for administrators to successfully run the needed firmware updates.\nThis makes it extremely important for organisations to ensure their devices have not\nbeen previously compromised. **Organisations that are still running a vulnerable**\n**version must run a full factory reset on the device prior to completing the**\n**firmware upgrade to ensure the device is not left vulnerable.**\n\nThe usual checks to ensure that the latest updates are installed still apply. To\n**prevent reinfection, this recommendation also applies to devices previously**\n**infected with QSnatch but from which the malware has been removed.**\n\nTo prevent QSnatch malware infections, the NCSC and CISA strongly recommend\nthat organisations take the recommended measures in QNAP’s November 2019\nadvisory.[4]\n\nThe NCSC and CISA also recommend organisations consider the following\nmitigations:\n\n  - Verify that you purchased QNAP devices from reputable sources.\n\n  - Block external connections when the device is intended to be used strictly for\n\ninternal storage.\n\n4 [https://www.qnap.com/en/security-advisory/nas-201911-01](https://www.qnap.com/en/security-advisory/nas-201911-01)\n\n6 of 6\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.ncsc.gov.uk/files/NCSC%20CISA%20Alert%20-QNAP%20NAS%20Devices.pdf"
    ],
    "report_names": [
        "NCSC%20CISA%20Alert%20-QNAP%20NAS%20Devices.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716500,
    "ts_updated_at": 1743041153,
    "ts_creation_date": 1595603056,
    "ts_modification_date": 1595603056,
    "files": {
        "pdf": "https://archive.orkl.eu/c6a687eb03b7fafeb57dfc0604732b26bbaf4c9a.pdf",
        "text": "https://archive.orkl.eu/c6a687eb03b7fafeb57dfc0604732b26bbaf4c9a.txt",
        "img": "https://archive.orkl.eu/c6a687eb03b7fafeb57dfc0604732b26bbaf4c9a.jpg"
    }
}