{
    "id": "246dafc5-f84a-4301-990d-26ec150deb66",
    "created_at": "2023-01-12T15:00:22.776583Z",
    "updated_at": "2025-03-27T02:16:23.237191Z",
    "deleted_at": null,
    "sha1_hash": "c8486804c37b8f9be3c0259113ec47973306bb2c",
    "title": "2022-09-26 - The Anatomy of Wiper Malware, Part 3- Input-Output Controls",
    "authors": "",
    "file_creation_date": "2022-10-02T12:24:25Z",
    "file_modification_date": "2022-10-02T12:24:25Z",
    "file_size": 8045202,
    "plain_text": "# The Anatomy of Wiper Malware, Part 3: Input/Output Controls\n\n**crowdstrike.com/blog/the-anatomy-of-wiper-malware-part-3/**\n\nIoan Iacob - Iulian Madalin Ionita September 26, 2022\n\nIn [Part 1 of this four-part blog series examining wiper malware, the CrowdStrike Endpoint](https://www.crowdstrike.com/blog/the-anatomy-of-wiper-malware-part-1/)\nProtection Content Research Team introduced the topic of wipers, reviewed their recent history\nand presented common adversary techniques that leverage wipers to destroy system data. In Part\n2, the team dove into third-party drivers and how they may be used to destroy system data.\n\nIn Part 3, we cover various input/output controls (IOCTLs) in more detail and how they are used to\nachieve different goals — including acquiring information about infected machines and\nlocking/unlocking disk volumes, among others.\n\n## Input/Output Control (IOCTL) Primer\n\nThroughout our analysis, we encountered different uses of IOCTLs across samples. These are\nused to obtain information about volumes or disks, as well as to achieve other functionalities like\nlocking, unlocking, unmounting a volume, fragmentation of data on disk, and others.\n\nThe analyzed samples use the following IOCTLs:\n\n**IOCTLs** **IOCTL Constant Name** **Used By**\n\n\n-----\n\n0x00070000 [IOCTL_DISK_GET_DRIVE_GEOMETRY](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-ioctl_disk_get_drive_geometry) Petya wiper variant,\nDustman and ZeroCleare\n\n0x000700A0 [IOCTL_DISK_GET_DRIVE_GEOMETRY_EX](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-ioctl_disk_get_drive_geometry_ex) DriveSlayer, Dustman and\nZeroCleare, IsaacWiper\n\n0x00070048 [IOCTL_DISK_GET_PARTITION_INFO_EX](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-ioctl_disk_get_partition_info_ex) Shamoon 2, Petya wiper\nvariant\n\n0x00070050 [IOCTL_DISK_GET_DRIVE_LAYOUT_EX](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-ioctl_disk_get_drive_layout_ex) DriveSlayer\n\n0x0007405C [IOCTL_DISK_GET_LENGTH_INFO](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-ioctl_disk_get_length_info) StoneDrill, Dustman and\nZeroCleare\n\n0x0007C054 [IOCTL_DISK_SET_DRIVE_LAYOUT_EX](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-ioctl_disk_set_drive_layout_ex) CaddyWiper\n\n0x0007C100 [IOCTL_DISK_DELETE_DRIVE_LAYOUT](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-ioctl_disk_delete_drive_layout) SQLShred\n\n0x00090018 [FSCTL_LOCK_VOLUME](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_lock_volume) DriveSlayer, StoneDrill,\nIsaacWiper\n\n0x0009001C [FSCTL_UNLOCK_VOLUME](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_unlock_volume) IsaacWiper\n\n0x00090020 [FSCTL_DISMOUNT_VOLUME](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_dismount_volume) DriveSlayer, Petya wiper\nvariant, StoneDrill\n\n0x00090064 [FSCTL_GET_NTFS_VOLUME_DATA](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_get_ntfs_volume_data) DriveSlayer\n\n0x00090068 [FSCTL_GET_NTFS_FILE_RECORD](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_get_ntfs_file_record) DriveSlayer\n\n0x0009006F [FSCTL_GET_VOLUME_BITMAP](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_get_volume_bitmap) DriveSlayer\n\n0x00090073 [FSCTL_GET_RETRIEVAL_POINTERS](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_get_retrieval_pointers) DriveSlayer, Shamoon 2\n\n0x00090074 [FSCTL_MOVE_FILE](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_move_file) DriveSlayer\n\n0x000900A8 [FSCTL_GET_REPARSE_POINT](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_get_reparse_point) SQLShred\n\n0x000980C8 [FCSTL_SET_ZERO_DATA](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_set_zero_data) DoubleZero\n\n0x002D1080 [IOCTL_STORAGE_GET_DEVICE_NUMBER](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_get_device_number) DriveSlayer, IsaacWiper\n\n0x00560000 [IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS](https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-ioctl_volume_get_volume_disk_extents) DriveSlayer, Petya wiper\nvariant, SLQShred,\nDustman and ZeroCleare\n\nWhile the majority of the wiper families use a few IOCTLs, DriveSlayer makes use of an extensive\nlist of IOCTLs to achieve its goals. Some IO control codes are used to acquire information about\nthe disks of the infected machine like NTFS partition tables, move files, fingerprint the drive, etc.\n\n### Acquiring Information\n\n\n-----\n\nIn the example below, DriveSlayer is using the IOCTL_DISK_GET_DRIVE_LAYOUT_EX and\n**IOCTL_DISK_GET_DRIVE_GEOMETRY_EX IOCTLs to obtain information about the partitions**\nand geometry of a drive. This helps the wiper to determine the location of the MFTs and MBRs in\norder for them to be scheduled for wiping. Similar implementations can be found using the other\nIOCTLs in IsaacWiper, Petya wiper variant, Dustman or ZeroCleare.\n\nFigure 1. DriveSlayer acquires disk layout information via IOCTL_DISK_GET_DRIVE_LAYOUT_EX, followed by\n\nthe usage of the returned data to determine which disk sectors to overwrite\n\n\n-----\n\nDriveSlayer also uses IOCTL_STORAGE_GET_DEVICE_NUMBER to grab information such as\npartition number and device type, which is later used in the wiper process.\n\nFigure 2. Acquire various other info via the IOCTL_STORAGE_GET_DEVICE_NUMBER IOCTL\n\n### Volume Unmounting\n\nThe FSCTL_LOCK_VOLUME and FSCTL_DISMOUNT_VOLUME IOCTLs are used by\nDriveSlayer to lock and unmount a disk volume after the wiping routine has finished. In order to do\nso, DriveSlayer grabs a list of all the drive letters via GetLogicalDriveStrings, iterates through all\nof them, acquires a handle to each volume and sends two IOCTLs via DeviceIoControl API. A\nsimilar implementation is done by the Petya wiper variant and StoneDrill as well.\n\n\n-----\n\nFigure 3. Acquire list of drives via the GetLogicalDriveStrings API and send it to the callback function to lock and\n\ndismount\n\nThe usage of FSCTL_LOCK_VOLUME and FSCTL_DISMOUNT_VOLUME IO control codes can\nbe seen in the following function call.\n\n\n-----\n\nFigure 4. Usage of FSCTL_LOCK_VOLUME and FSCTL_DISMOUNT_VOLUME for locking and dismounting the\n\nvolume\n\n### Destroying All Disk Contents\n\nBesides the common approach of overwriting the MBR, SQLShred also calls the DeviceIoControl\nAPI with the IOCTL_DISK_DELETE_DRIVE_LAYOUT IO Control Code in order to make sure the\ndisk is formatted from sector 0x00.\n\n\n-----\n\nFigure 5. Usage of IOCTL_DISK_DELETE_DRIVE_LAYOUT that removes the boot signature from the master\n\nboot record, so that the disk will be formatted from sector zero to the end of the disk\n\n### Overwriting Disk Clusters\n\nThe FSCTL_GET_VOLUME_BITMAP IOCTL is used by DriveSlayer to acquire a bitmap\nrepresentation of the occupied clusters of a disk volume. The bitmap representation is returned as\na data structure that describes the allocation state of each cluster in the file system, where positive\nbits indicate if the cluster is in use. DriveSlayer will use this bitmap to overwrite occupied clusters\nwith randomly generated data.\n\nFigure 6. Grab bitmap representation of cluster usage via FSCTL_GET_VOLUME_BITMAP\n\n\n-----\n\n### Data Fragmentation\n\nDriveSlayer uses two IOCTLs to fragment the data on disk, thus making file recovery harder. In\norder to fragment the data, the wiper determines the location on disk of individual files by\nrequesting cluster information via the FSCTL_GET_RETRIEVAL_POINTERS IOCTL. The wiper\ncontinues by relocating virtual clusters using the FSCTL_MOVE_FILE IOCTL.\n\nFigure 7. Fragmentation of data by using the FSCTL_MOVE_FILE IOCTL\n\n### File Type Determination\n\nWhen getting information about files, besides GetFileAttributesW API, SQLShred wiper is also\nusing the FSCTL_GET_REPARSE_POINT IOCTL to retrieve the reparse point data associated\nwith the file or directory. In this case, the wiper is using it to check if the file is a symlink or the\ndirectory represents a mount point\n\n\n-----\n\nFigure 8. Obtaining the reparse point data associated with the file or directory by using\nFSCTL_GET_REPARSE_POINT IOCTL, followed by checks for symlinks or mount points\n\n### File Iteration\n\nWipers like DriveSlayer will attempt to determine existing files by parsing the MFT rather than\nwalking the directories and files recursively. The FSCTL_GET_NTFS_VOLUME_DATA IOCTL is\nused to obtain information about the specified NTFS volume, like volume serial number, number of\nsectors and clusters, free as well as reversed clusters and even the location of the MFT and its\nsize. All of this information is part of the NTFS_VOLUME_DATA_BUFFER structure that is sent as\nan argument to the DeviceIoControl API. Malware uses this IOCTL to determine the location of\nthe MFT and MFT-mirror in order to delete both of them by overwriting the raw sectors.\n\nFigure 9. Gather volume data via the FSCTL_GET_NTFS_VOLUME_DATA IOCTL\n\n\n-----\n\nThe FSCTL_GET_NTFS_FILE_RECORD IOCTL is used to enumerate files from a NTFS\nformatted drive. The information is returned inside the NTFS_FILE_RECORD_OUTPUT_BUFFER\nstructure that is sent as an argument to the DeviceIoControl API. Wipers like DriveSlayer use this\nIOCTL in order to determine the raw sectors associated with files and queue them for the wiping\nroutine.\n\nFigure 10. Retrieve file record information via the FSCTL_GET_NTFS_FILE_RECORD IOCTL\n\n## How the CrowdStrike Falcon Platform Offers Continuous Monitoring and Visibility\n\nThe CrowdStrike Falcon platform takes a layered approach to protect workloads. Using on-sensor®\n[and cloud-based machine learning, behavior-based detection using indicators of attack (IOAs), and](https://www.crowdstrike.com/cybersecurity-101/indicators-of-compromise/ioa-vs-ioc/)\nintelligence related to tactics, techniques and procedures (TTPs) employed by threat actors, the\nFalcon platform equips users with visibility, threat detection, automated protection and continuous\nmonitoring for any environment, reducing the time to detect and mitigate threats.\n\n\n-----\n\nFigure 11. Falcon UI screenshot showcasing how wipers are detected by the Falcon agent\n\nFigure 12. Falcon UI screenshot showcasing detection of Petya by the Falcon sensor\n\n## Summary\n\nWipers frequently use various IOCTL codes in order to enrich their capabilities. Input/Output\ncontrol codes can be used for various types of operations; they can help to enumerate files, locate\nthe Master File Table (MFT), determine location of files on the raw disk, unmount drivers, fragment\nfiles, etc. These codes can be sent directly to the volume or drive itself, and even to the third-party\ndrivers that we discussed in part 2.\n\n\n-----\n\nIn the next and final part of the wiper blog series, we will cover some less frequent techniques\nseen in wiper malware. The techniques are used to augment the existing destructive capabilities\ndescribed so far and were seen in some particular wiper families.\n\n## Hashes\n\n**Wiper name** **SHA256 hash value**\n\nApostle 6fb07a9855edc862e59145aed973de9d459a6f45f17a8e779b95d4c55502dcce\n\n19dbed996b1a814658bef433bad62b03e5c59c2bf2351b793d1a5d4a5216d27e\n\nCaddyWiper a294620543334a721a2ae8eaaf9680a0786f4b9a216d75b55cfd28f39e9430ea\n\nDestover e2ecec43da974db02f624ecadc94baf1d21fd1a5c4990c15863bb9929f781a0a\n\nDoubleZero 3b2e708eaa4744c76a633391cf2c983f4a098b46436525619e5ea44e105355fe\n\n30b3cbe8817ed75d8221059e4be35d5624bd6b5dc921d4991a7adc4c3eb5de4a\n\nDriveSlayer 0385eeab00e946a302b24a91dea4187c1210597b8e17cd9e2230450f5ece21da\n1bc44eef75779e3ca1eefb8ff5a64807dbc942b1e4a2672d77b9f6928d292591\n\na259e9b0acf375a8bef8dbc27a8a1996ee02a56889cba07ef58c49185ab033ec\n\nDustman f07b0c79a8c88a5760847226af277cf34ab5508394a58820db4db5a8d0340fc7\n\nIsaacWiper 13037b749aa4b1eda538fda26d6ac41c8f7b1d02d83f47b0d187dd645154e033\n7bcd4ec18fc4a56db30e0aaebd44e2988f98f7b5d8c14f6689f650b4f11e16c0\n\nIsraBye 5a209e40e0659b40d3d20899c00757fa33dc00ddcac38a3c8df004ab9051de0d\n\nKillDisk 8a81a1d0fae933862b51f63064069aa5af3854763f5edc29c997964de5e284e5\n\n1a09b182c63207aa6988b064ec0ee811c173724c33cf6dfe36437427a5c23446\n\n\nMeteor and\nComet/Stardust\n\n\n2aa6e42cb33ec3c132ffce425a92dfdb5e29d8ac112631aec068c8a78314d49b\n\nd71cc6337efb5cbbb400d57c8fdeb48d7af12a292fa87a55e8705d18b09f516e\n\n6709d332fbd5cde1d8e5b0373b6ff70c85fee73bd911ab3f1232bb5db9242dd4\n\n9b0f724459637cec5e9576c8332bca16abda6ac3fbbde6f7956bc3a97a423473\n\n\nOrdinypt ​085256b114079911b64f5826165f85a28a2a4ddc2ce0d935fa8545651ce5ab09\n\nPetya 0f732bc1ed57a052fecd19ad98428eb8cc42e6a53af86d465b004994342a2366\n\nfd67136d8138fb71c8e9677f75e8b02f6734d72f66b065fc609ae2b3180a1cbf\n\n4c1dc737915d76b7ce579abddaba74ead6fdb5b519a1ea45308b8c49b950655c\n\nShamoon e2ecec43da974db02f624ecadc94baf1d21fd1a5c4990c15863bb9929f781a0a\n\nc7fc1f9c2bed748b50a599ee2fa609eb7c9ddaeb9cd16633ba0d10cf66891d8a\n\n7dad0b3b3b7dd72490d3f56f0a0b1403844bb05ce2499ef98a28684fbccc07b4\n\n8e9681d9dbfb4c564c44e3315c8efb7f7d6919aa28fcf967750a03875e216c79\n\nf9d94c5de86aa170384f1e2e71d95ec373536899cb7985633d3ecfdb67af0f72\n\n4f02a9fcd2deb3936ede8ff009bd08662bdb1f365c0f4a78b3757a98c2f40400\n\nSQLShred/Agrius 18c92f23b646eb85d67a890296000212091f930b1fe9e92033f123be3581a90f\n\ne37bfad12d44a247ac99fdf30f5ac40a0448a097e36f3dbba532688b5678ad13\n\n\n-----\n\nStoneDrill 62aabce7a5741a9270cddac49cd1d715305c1d0505e620bbeaec6ff9b6fd0260\n\n2bab3716a1f19879ca2e6d98c518debb107e0ed8e1534241f7769193807aac83\n\nbf79622491dc5d572b4cfb7feced055120138df94ffd2b48ca629bb0a77514cc\n\n\nTokyo Olympic\nwiper\n\n\nfb80dab592c5b2a1dcaaf69981c6d4ee7dbf6c1f25247e2ab648d4d0dc115a97\n\nc58940e47f74769b425de431fd74357c8de0cf9f979d82d37cdcf42fcaaeac32\n\n\nWhisperGate a196c6b8ffcb97ffb276d04f354696e2391311db3841ae16c8c9f56f36a38e92\n\n44ffe353e01d6b894dc7ebe686791aa87fc9c7fd88535acc274f61c2cf74f5b8\n\ndcbbae5a1c61dbbbb7dcd6dc5dd1eb1169f5329958d38b58c3fd9384081c9b78\n\nZeroCleare becb74a8a71a324c78625aa589e77631633d0f15af1473dfe34eca06e7ec6b86\n\n**Additional Resources**\n\n_[Learn how the powerful CrowdStrike Falcon platform provides comprehensive protection](https://www.crowdstrike.com/endpoint-security-products/falcon-platform/)_\n_across your organization, workers and data, wherever they are located._\n_[Get a full-featured free trial of CrowdStrike Falcon Prevent™ and see for yourself how true](https://www.crowdstrike.com/resources/free-trials/try-falcon-prevent/)_\n_next-gen AV performs against today’s most sophisticated threats._\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-09-26 - The Anatomy of Wiper Malware, Part 3- Input-Output Controls.pdf"
    ],
    "report_names": [
        "2022-09-26 - The Anatomy of Wiper Malware, Part 3- Input-Output Controls.pdf"
    ],
    "threat_actors": [
        {
            "id": "21e01940-3851-417f-9e90-1a4a2da07033",
            "created_at": "2022-10-25T16:07:23.299369Z",
            "updated_at": "2025-03-27T02:02:09.725295Z",
            "deleted_at": null,
            "main_name": "Agrius",
            "aliases": [
                "AMERICIUM",
                "Agonizing Serpens",
                "BlackShadow",
                "DEV-0227",
                "Pink Sandstorm",
                "SharpBoys"
            ],
            "source_name": "ETDA:Agrius",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Agrius",
                "BFG Agonizer",
                "BFG Agonizer Wiper",
                "DEADWOOD",
                "DETBOSIT",
                "Detbosit",
                "IPsec Helper",
                "Moneybird",
                "MultiLayer Wiper",
                "PW",
                "PartialWasher",
                "PartialWasher Wiper",
                "SQLShred",
                "Sqlextractor"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "89c0c674-c35d-47a6-bd7c-1e6c1b6beacc",
            "created_at": "2024-05-01T02:03:08.042533Z",
            "updated_at": "2025-03-27T02:05:17.3236Z",
            "deleted_at": null,
            "main_name": "COBALT SHADOW",
            "aliases": [
                "AMERICIUM ",
                "Agrius",
                "BlackShadow",
                "DEV-0227 ",
                "Malek Team",
                "Pink Sandstorm ",
                "Agonizing Serpens "
            ],
            "source_name": "Secureworks:COBALT SHADOW",
            "tools": [
                " DEADWOOD",
                " Fantasy wiper",
                " Host2IP",
                " IPsec Helper",
                " Jennlog Loader",
                " MiniDump",
                " Moneybird ransomware",
                " PSexec",
                " Plink",
                " Sandals",
                " SecretsDump",
                " SoftPerfect Network Scanner",
                "Apostle"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "4023e661-f566-4b5b-a06f-9d370403f074",
            "created_at": "2024-02-02T02:00:04.064685Z",
            "updated_at": "2025-03-27T02:00:03.304692Z",
            "deleted_at": null,
            "main_name": "Pink Sandstorm",
            "aliases": [
                "Agonizing Serpens",
                "AMERICIUM",
                "BlackShadow",
                "DEV-0022",
                "Agrius"
            ],
            "source_name": "MISPGALAXY:Pink Sandstorm",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "7d982d5b-3428-483c-8804-c3ab774f1861",
            "created_at": "2024-11-01T02:00:52.70975Z",
            "updated_at": "2025-03-27T02:00:55.517246Z",
            "deleted_at": null,
            "main_name": "Agrius",
            "aliases": [
                "Agrius",
                "Pink Sandstorm",
                "AMERICIUM",
                "Agonizing Serpens",
                "BlackShadow"
            ],
            "source_name": "MITRE:Agrius",
            "tools": [
                "NBTscan",
                "Mimikatz",
                "IPsec Helper",
                "Moneybird",
                "MultiLayer Wiper",
                "DEADWOOD",
                "BFG Agonizer",
                "ASPXSpy"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535622,
    "ts_updated_at": 1743041783,
    "ts_creation_date": 1664713465,
    "ts_modification_date": 1664713465,
    "files": {
        "pdf": "https://archive.orkl.eu/c8486804c37b8f9be3c0259113ec47973306bb2c.pdf",
        "text": "https://archive.orkl.eu/c8486804c37b8f9be3c0259113ec47973306bb2c.txt",
        "img": "https://archive.orkl.eu/c8486804c37b8f9be3c0259113ec47973306bb2c.jpg"
    }
}