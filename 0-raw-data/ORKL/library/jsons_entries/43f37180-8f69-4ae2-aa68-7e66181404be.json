{
    "id": "43f37180-8f69-4ae2-aa68-7e66181404be",
    "created_at": "2023-01-12T15:01:46.871637Z",
    "updated_at": "2025-03-27T02:11:41.797708Z",
    "deleted_at": null,
    "sha1_hash": "090e260d5e758520cc90b0f5f177c349d384cba9",
    "title": "2021-09-24 - Hunting the LockBit Gang's Exfiltration Infrastructures",
    "authors": "",
    "file_creation_date": "2022-05-28T15:44:15Z",
    "file_modification_date": "2022-05-28T15:44:15Z",
    "file_size": 1373568,
    "plain_text": "# Hunting the LockBit Gang's Exfiltration Infrastructures\n\n**yoroi.company/research/hunting-the-lockbit-gangs-exfiltration-infrastructures/**\n\n09/24/2021\n\n## Introduction\n\n\nSeptember 24, 2021\n\n\nNowadays ransomware operators have consolidated the double extortion practice by mastering data exfiltration techniques. From time\nto time, we observed many threat actors approach the data theft in diverse ways, some prefeed to rely on legit services and tools such\nas RClone, FTP sites, and some through VPN channels, but others also with customized tools.\n\nAlso, during the last months the LockBit gang (TH-276) decided to develop and evolve a custom tool specialized in data exfiltration and\nused as a peculiar element to distinguish their criminal brand. In fact, the StealBit 2.0 tool is part of the toolset the gang offers to their crooks to\novercome the difficulties of massive data theft: an out-of-the-box tool ready to be used against the target company next to the LockBit 2.0\nencryption tool.\n\nFrom an intelligence perspective, understand the mechanisms and the infrastructure behind this tool is particularly valuable, especialy to early\ndetect animminent ransomware impact. For this reason, Yoroi Malware ZLAB dissected a recent version of StealBit, tracking down the\n[infrastructures abused by the infamous tool, configured there by the cyber criminals (Stealbit-Configuration-Decryptor available).](https://github.com/CERT-Yoroi-Malware-ZLab/Stealbit-Configuration-Decryptor)\n\n## Technical Analysis\n\nThe initial sample we have chosen to start our investigation has the following static information:\n\n**Hash** 3407f26b3d69f1dfce76782fee1256274cf92f744c65aa1ff2d3eaaaf61b0b1d\n\n**Threat** StealBit\n\n**Brief Description** Exfiltration utility adopted by lockbit gang during their cyber intrusions\n\n**Filesize** 52.7 KB\n\n**Ssdeep** 768:FXPkQ2Csnwhxvfhko88yb6cvXbhb7vJawOuArU1o/xnmGP:YLqvZko9ybpvrtvJa/uArU+5nNP\n\nTable 1: Static information about the sample\n\nAnalyzing the malicious component, we immediately noticed the lack of metadata in the PE fields. In fact, we obtained few data:\nthe bitness entry point the compiler timestamp and not much more than the DOS header Something huge is missing\n\n\n-----\n\nFigure 1: Static information about the sample\n\nIn fact, the \"imphash\" section is not available in the sample. Surprisingly, this is not an error of the tool. The import table of the\nsample is completely void, empty, no Windows API listed. At this point, we decided to deep inside the code to understand the internals of the\nsample.\n\n## Anti-Debug Techniques\n\nAnyway, the lack of system API does not prevent malware developers from protecting their code. So, one of\nthe first things the StealBit sample does just after the entry point is implementing a low-level anti-analysis technique.\n\nFigure 2: Simple Anti-Debug Routine\n\n[It is an anti-debug technique documented in many open source resources. The technique is based on the checking](https://anti-debug.checkpoint.com/techniques/debug-flags.html#manual-checks-ntglobalflag)\nof specific values in Process Environment Block (PEB), a data structure in the Windows\nNT operating systems used to contain information about the execution of a specific process. One of the flags contained inside the\nPEB is \"NtGlobalFlags”: this value is accessed through the following opcodes.\n```\nmov eax, fs:[30h] ; Load the PEB data structure \nmov eax, eax+68h ; Load the value of the “NtGlobalFlags” flag\n\n```\nCode snippet 1\n\nIf the value in the indicated flag is 0x70, it means that the process is debugged. In this case, the malware loops at the same instruction,\notherwise it goes with its malicious activities.\n\nThe Runtime Loading of APIs and Libraries\n\nAs previously stated, the malware has an empty import address table, so it needs to load the required libraries to perform its malicious\nactivities. Even when no IAT entry is present the operating system loads the three basic DLLs:\n\nFigure 3: Automatic import of the base Windows libraries\n\nTo load all the rest of the system API needed to exfiltrate data, StealBit hides the native DLL names to import into stack\nstrings. This means the name of the DLL to load is pushed into the running thread stack a char at a time, and then popped\nout to reconstruct the desired string, just like in the following piece of code:\n\n\n-----\n\nFigure 4: Example of stack-strings loading\n\nIn this case, the reconstructed string is \"ws2_32.dll\", a native library for internet communication. Instead, the stack-strings of the other libraries\nloaded by StealBit are the following:\n\nFigure 5: DLLs to load\n\nStack string obfuscation was extensively used across the sample, so we automatized the extraction process, and\nthe results are reported in Appendix 1.\n\n## Data Exfiltration\n\nWhen the Command and Control correctly responds to the malware, it starts its exfiltration routine, performed by using the HTTP\nmethod PUT and the implemented method is designed to be as fast as possible:\n\nFigure 6: Piece of the Exfiltration C2 Communication\n\nSo, we decided to deepen the communication routine and we isolated all the fields of the request. The principal fields of the request are the\nfollowing:\n\nPUT: HTTP PUT Method\n\n\n-----\n\ne as d cates t e e to put o t e se e\nHTTP classic headers\nDAV2 Constant Header: The body of the request starts with the DAV2 key\nThe Config ID: (which we’ll explain in the next paragraph)\nThe complete file name of the exfiltrated file\nThe content of the file in cleartext\n\nAn example of the construction of the malicious request is the following:\n\nFigure 7: HTTP PUT request construction\n\nDespite what LockBit gang advertises, their StealBit does not actually compress the file extracted by the system. In fact, the malware\nselectively uploads all the files reachable on the target machine except system files, registry hives, scripts and files matching specific\nextensions such as .cmd, .msi, .ocx, .cpl, .hta, .lnk, .exe, .dll, etc. .\n\nThe full list of file exclusions is available on Appendix 1.\n\n## Configuration Extraction \n\nOne of the most interesting points of malware was the static configuration protection mechanism in place. During the analysis we isolated the\npiece of code containing the routine adopted by the malicious developers to decrypt the StealBit configuration.\n\nFigure 8: Configuration decoding routine\n\n\n-----\n\ns p ece o code co ta s a eat a go t to dec ypt t e co gu at o o t e Stea t sa p e t eads a s a 8 byte ey to decode t e byte\nchuck starting from the offset 0x40E250 (see above). The loop ends when all 124 bytes are decoded. In the following picture we can see the\nbefore and the after of the configuration:\n\nFigure 9: Before and after of the decoding process\n\nThe configuration chunk is composed of two parts: the first one is a 5-characters ID, probably identifying the victim or the current\ncampaign, and the other chunk is a series of IP addresses to be contacted by the exfiltration tool. These remote IPs are the addresses of the\ninfrastructure used by the threat actor to exfiltrate the data from the targeted companies.\n\n## Hunting the Samples \n\nAt this point, we created a Yara rule (see \"Yara Rules\" section) matching the configuration decrypting routine and automated the decoding of\n[the static configurations of the StealBit samples in the wild using the Stealbit-Configuration-Decryptor. At the time of writing, we](https://github.com/CERT-Yoroi-Malware-ZLab/Stealbit-Configuration-Decryptor)\nwere spotted these samples:\n\n**Retrieved Hashes**\n\n2f18e61e3d9189f6ff5cc95252396bebaefe0d76596cc51cf0ade6a5156c6f66\n\n4db7eeed852946803c16373a085c1bb5f79b60d2122d6fc9a2703714cdd9dac0\n\n07a3dcb8d9b062fb480692fa33d12da05c21f544492cbaf9207956ac647ba9ae\n\n3407f26b3d69f1dfce76782fee1256274cf92f744c65aa1ff2d3eaaaf61b0b1d\n\nbd14872dd9fdead89fc074fdc5832caea4ceac02983ec41f814278130b3f943e\n\nced3de74196b2fac18e010d2e575335e2af320110d3fdaff09a33165edb43ca2\n\n107d9fce05ff8296d0417a5a830d180cd46aa120ced8360df3ebfd15cb550636\n\nTable 2: Retrieved hashes from Yara Hunting\n\nThese samples have a perfect code similarity with the original one and the only difference is properly the configuration chuck.\n\nFigure 10: Binary Diff analysis of two samples\n\nThe result of the static configuration extraction from this first in-the-wild StealBit sample set is reported in the following table.\n\n**Hash** **Compilation Time** **ID** **IPs**\n\n\n-----\n\n07a3dcb8d9b062fb480692fa33d12da05c21f544492cbaf9207956ac647ba9ae 2021-07-12\n04:58:17\n\n107d9fce05ff8296d0417a5a830d180cd46aa120ced8360df3ebfd15cb550636 2021-07-31\n07:09:59\n\n2f18e61e3d9189f6ff5cc95252396bebaefe0d76596cc51cf0ade6a5156c6f66 2021-07-31\n07:09:59\n\n3407f26b3d69f1dfce76782fee1256274cf92f744c65aa1ff2d3eaaaf61b0b1d 2021-07-31\n07:09:59\n\n4db7eeed852946803c16373a085c1bb5f79b60d2122d6fc9a2703714cdd9dac0 2021-07-12\n04:58:17\n\nbd14872dd9fdead89fc074fdc5832caea4ceac02983ec41f814278130b3f943e 2021-07-31\n07:09:59\n\nced3de74196b2fac18e010d2e575335e2af320110d3fdaff09a33165edb43ca2 2021-07-12\n04:58:17\n\nTable 3: Automatic configuration extraction from the hunted samples\n\n## The Exfiltration Infrastructure\n\n\n84AFC 93[.]190[.]143[[.]101 139[.]60[.]1\n\nJ29EV 93[.]190[.]139[.]223 168[.]100[.\n\nD26VN 174[.]138[.]62[.]35 93[.]190[.]14\n\nLCPA0 88[.]80[.]147[.]102 168[.]100[.]1\n\n4ATGY 139[.]60[.]160[.]200 193[.]38[.]2\n\nD26VN 174[.]138[.]62[.]35 93[.]190[.]14\n\n84AFC 93[.]190[.]143[.]101 139[.]60[.]1\n\n\nOnce extracted the remote IP address hard-coded into the static configurations of\nthe StealBit samples, we analyzed the exfiltration infrastructure from a threat intelligence point of view, tracking down past malicious activities\nrelated to those IPs. We noticed that some of them have been used in the past operation for other malicious purposes such as the\ndistribution of mobile malware, or phishing attempts to banks etc., by actors unrelated to the LockBit gang and ransomware practice in\ngeneral.\n\nThe connection between these different operations is still unclear and weak, in fact, different criminal\norganizations could have been accidentally chosen the same providers due to their potential lack of collaboration with western\nauthorities, but also - at least in the 168.100.11[.72 case - the same remote address was used to conduct phishing operations in Italy and\nransomware data exfiltration in adjacent same time spans.\n\n\nIP Count Whois\n(NetName and Country)\n\n139.60.160[.200 7 HOSTKEY-USA US\n\n\nFindings\n\n\n168.100.11[.72 2 BLNETWORKS-01 US Phishing to Italian banks between 12 – 24 Aug 2021\n\n174.138.62[.35 4 DIGITALOCEAN-174-138-0-0 US\n\n185.215.113[.39 1 SC-ELITETEAM-20201113 SC Distrubution of mobile banking malware in Feb21\n\n193.162.143[.218 5 FirstByte RU\n\n193.38.235[.234 7 VDSINA-NET RU RDP with machine name WIN-R84DEUE96RB and before WIN5ODCFIGQRP3 in Aug21\n\n\n45.227.255[.190 3 Okpay Investment Company PAOICO-LACNIC\n\n88.80.147[.102 1 BelCloud-net BG\n\n\nMongoDB scanning and exploitation in APR20\n\n\n93.190.143[.101 4 WORLDSTREAM NL Reported as Spam vector in 2020\n\n93.190.139[.223 1 WORLDSTREAM NL\n\nTable 4: Information about the infrastructure\n\n## Conclusion\n\nData exfiltration tools are getting more popular in the cyber-criminal ecosystem. LockBit gang leveraged this kind of tools to distinguish from\nother ransomware operators and attract malicious affiliates in their criminal business, and today LockBit is one of the most active\nand violent threat groups operating the double extortion practice. Securing company data is nowadays a huge challenge and the proliferation\nof massive data theft tools like StealBit are an emergent threat.\n\nTracking down the adversary infrastructure is a relevant effort, by we believe it is necessary to help the security community to fight and pursue\nsuch criminals and protect the Yoroi's customers from data extortion threats.\n\n\n-----\n\n## Indicators of Compromise\n\nHash:\n\n07a3dcb8d9b062fb480692fa33d12da05c21f544492cbaf9207956ac647ba9ae\n2f18e61e3d9189f6ff5cc95252396bebaefe0d76596cc51cf0ade6a5156c6f66\n3407f26b3d69f1dfce76782fee1256274cf92f744c65aa1ff2d3eaaaf61b0b1d\n4db7eeed852946803c16373a085c1bb5f79b60d2122d6fc9a2703714cdd9dac0\nbd14872dd9fdead89fc074fdc5832caea4ceac02983ec41f814278130b3f943e\nced3de74196b2fac18e010d2e575335e2af320110d3fdaff09a33165edb43ca2\n107d9fce05ff8296d0417a5a830d180cd46aa120ced8360df3ebfd15cb550636\nExfiltration:\n\n139.60.160[.200\n168.100.11[.72\n174.138.62[.35\n185.215.113[.39\n193.162.143[.218\n193.38.235[.234\n45.227.255[.190\n88.80.147[.102\n93.190.143[.101\n93.190.139[.223\n\n## Yara Rule\n```\nrule stealbit_decode { \nmeta: \n          description = \"Yara Rule for StealBit Configuration decryption\" \n          author = \"Yoroi Malware Zlab\" \n          last_updated = \"2021_09_01\" \n          tlp = \"white\" \n          category = \"informational\" \nstrings: \n$Offset = { ff 17 18 19 20 00 00 00 00 00 00 } \n$decode_Conf = { 8b c1 83 e0 0f 8a 8? ?? ?? ?? ?? 30 8? ?? ?? ?? ?? 41 83 f9 7c } \ncondition: \nall of them \n}\n\n Suricata Rule\nTLP:AMBER - accessible by Trusted Introducer CSIRT Network Members\n\n Appendix 1 - Extraction of Stack Strings\n\n```\n**Function**\n\n0x4036C0 0x4036C0 0x4036C0 0x4036C0 0x4036C0 0x4036C0 0x4036C0 0x4036C0 0x4036C0 0x4036C0 0x4036C0 0x4036C0 0x4036C0 0x4\n\n## Appendix 2 - Decoder\n\n[Stealbit-Configuration-Decryptor available on Yoroi Malware ZLAB public GitHub repository.](https://github.com/CERT-Yoroi-Malware-ZLab/Stealbit-Configuration-Decryptor)\n\n\n-----\n\n_s b op post_ _as aut o ed by_ _u g_ _a t e a d_ _uca_ _e a o_ _o o_ _a_ _a e_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-24 - Hunting the LockBit Gang's Exfiltration Infrastructures.pdf"
    ],
    "report_names": [
        "2021-09-24 - Hunting the LockBit Gang's Exfiltration Infrastructures.pdf"
    ],
    "threat_actors": [
        {
            "id": "0fc739cf-0b82-48bf-9f7d-398a200b59b5",
            "created_at": "2022-10-25T16:07:23.797925Z",
            "updated_at": "2025-03-27T02:02:09.983353Z",
            "deleted_at": null,
            "main_name": "LockBit Gang",
            "aliases": [
                "Bitwise Spider",
                "Operation Cronos"
            ],
            "source_name": "ETDA:LockBit Gang",
            "tools": [
                "3AM",
                "ABCD Ransomware",
                "CrackMapExec",
                "EmPyre",
                "EmpireProject",
                "LockBit",
                "LockBit Black",
                "Mimikatz",
                "PowerShell Empire",
                "PsExec",
                "Syrphid"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535706,
    "ts_updated_at": 1743041501,
    "ts_creation_date": 1653752655,
    "ts_modification_date": 1653752655,
    "files": {
        "pdf": "https://archive.orkl.eu/090e260d5e758520cc90b0f5f177c349d384cba9.pdf",
        "text": "https://archive.orkl.eu/090e260d5e758520cc90b0f5f177c349d384cba9.txt",
        "img": "https://archive.orkl.eu/090e260d5e758520cc90b0f5f177c349d384cba9.jpg"
    }
}