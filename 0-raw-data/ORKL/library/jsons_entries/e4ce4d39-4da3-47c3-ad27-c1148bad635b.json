{
    "id": "e4ce4d39-4da3-47c3-ad27-c1148bad635b",
    "created_at": "2023-01-12T15:08:38.924853Z",
    "updated_at": "2025-03-27T02:05:57.779926Z",
    "deleted_at": null,
    "sha1_hash": "68dccbbc36a0ed5c160a5ee9640420641824528d",
    "title": "2020-01-15 - MMD-0065-2020 - Linux-Mirai-Fbot's new encryption explained",
    "authors": "",
    "file_creation_date": "2022-05-29T01:00:44Z",
    "file_modification_date": "2022-05-29T01:00:44Z",
    "file_size": 1941223,
    "plain_text": "# MMD-0065-2020 - Linux/Mirai-Fbot's new encryption explained\n\n**[blog.malwaremustdie.org/2020/01/mmd-0065-2020-linuxmirai-fbot.html](https://blog.malwaremustdie.org/2020/01/mmd-0065-2020-linuxmirai-fbot.html)**\n\n## Prologue\n\n**_[For the most recent information of this threat please follow this ==>_** **_[link]](https://blog.malwaremustdie.org/2020/02/mmd-0065-2021-linuxmirai-fbot-re.html)_**\n\nI setup a local brand new ARM base router I bought online around this new year 2020 to\nreplace my old pots, and yesterday, it was soon pwned by malware and I had to reset it to\nthe factory mode to make it work again (never happened before). When the \"incident\"\noccurred, the affected router wasn't dead but it was close to a freeze state, allowing me to\noperate enough to collect artifacts, and when rebooted that poor little box just won't start\nagain. So for some reason the infection somehow ruined the router system.\n\nAs the summary for this case, in the router I found an infection trace of Mirai Linux malware\nvariant called \"FBOT\", an ARM v5 binary variant, and it is just another modified version of\noriginal Mirai malware (after a long list of other variants beforehand). The infection came\nfrom a malware spreader/scanner attack from \"another\" infected internet of things explained\nlater on.\n\nThere is an interesting new encryption logic on its configuration section in the binary,\nalongside with the usage of \"legendary\" Mirai table's encryption, so hopefully this write-ups\nwill be useful for others to dissect the threat. This may not be an easy reading one you and is\na rather technical post, but if you are in forensics or reverse engineering on embedded\nplatforms i.e. IoT or ICS security, you may like it, or, please bear with it. To make the post\nsmall and neat I won't go to further detail on router matter itself, and just go straight to the\nmalicious binary that caused the problem, Mirai, is also a malware with a well-known\nfunctionality by now. It would be helpful if you know how it works beforehand. So I'll focus to\nthe new decryption part of the artifact.\n\nI changed my analysis platform since SECCON 2019, I use \"Tsurugi Linux SECCON edition\",\na special built version by Giovanni, with hardened/tested by me, supported by the \"Trufae\"\nfor radare2's r2ghidra & r2dec pre-installing process during the SECCON 2019 time. It's a\nLinux distribution for binary & forensics analysis, Tsurugi is enriched with pre-compiled r2\nwith many architecture decompilers (i.e.: r2ghidra, r2dec and pdc), along with ton of useful\nopen source binary analysis, DFIR tools with the OSINT/investigator's mode switch. This OS\nshould suffice the analysis purpose. A new feature of r2ghidra (also r2dec) are used a lot.\n(The thank's list is in the Epilogue part).\n\nThe tool's version info:\n\n\n-----\n\n```\n:> !r2 v\nradare2 4.1.0-git 24455 @ linux-x86-64 git.4.0.0-235-g982be50\ncommit: 982be504999364c966d339c4c29f20da80128e14 build: 2019-12-17__10:29:05\n:> !uname -a\nLinux tsurugiseccon 5.4.2-050402-tsurugi #1 SMP Tue Dec 10 21:18:57 CET 2019 x86_64\nx86_64 x86_64 GNU/Linux\n:>\n\n```\n(click the image to check details..)\nOkay, let's write this, here we go..\n\n## The infection\n\nAfter successfully getting logs and cleaning them up, below is the timeline (in JST) that\ncontains the infection detail:\n\n\n-----\n\nWe can see one IP address 93(.)157(.)152(.)247 was gaining a user s login access, after\nchecking of infection condition and following by confirming previous infection binary instance,\nit downloaded and executed the \".t\" payload that was fetched from other IP\n**5(.)206(.)227(.)65 afterwards. Other interesting highlights from this infection are: It flushes all**\nthe rules in the \"filter\" table of iptables; Scanning (previous) infections; The usage of\nSATORI keyword during checking (which is actually not the original one since the original\nauthor has been arrested) and the downloading tool used is either the tftp or wget.\n```\nfbot-arm: ELF 32-bit LSB executable, ARM, version 1, statically linked, stripped\n3ea740687eee84832ecbdb202e8ed743 fbot-arm\n\n```\n[The compromised IoT that was infecting my device is this kind --> [link] a made-in-](https://epononu.en.ecplaza.net/products/ftth-8-pon-ports-gepon-olt_4027566)\nChina(PRC) \"GPON OLT\" device. It is important to know that they are vulnerable to this Mirai\nvariant's infection.\nDuring firstly detected, FBOT was running as per Mirai suppose to work, and from the\nCOMM serial connection (telnet & SSH wasn't accessible due to high load average) we can\nsee it runs like below list of file result:\n\nThe IP 5(.)206(.)227(.)65 is also functioned as this FBOT C2 server that looks \"out of\nservice\" during the above snapshot was taken.\n\nSo the binary that was executed was somehow deleted the itself. I can not recover it. An\ninteresting randomized process name is running on a memory area that is showing a\nsuccessful infection. So, being careful not to shutting down the load average 10 something\n[small system I dumped the binary from memory as per I explained in the R2CON2018 [link]](https://blog.malwaremustdie.org/p/new-video-of-this-talk-has-just-been.html)\n[and 2019.HACK.LU [link] presentations I did, then, I saved and renamed the binary into](https://blog.malwaremustdie.org/2019/10/more-about-my-2019hacklu-keynote-talk.html)\n\"fbot-arm\" for the further analysis purpose.\n\nThe memory maps is a good guidance for this matter, the rest of memory and user space are\nclean, note: you have to be very careful to not freezing the kernel or stopping the malware\nduring the process. I was lucky to install tools needed for hot forensics before the infection\n\n\n-----\n\noccurred.\n\n## The binary analysis\n\nThe dumped ARM binary can be seen in radare2 like this detail, which it looks a plain\nstripped ARM may came up as result from cross compilation.\n\nThe binary headers, entry points and sections don't show any strange things going on too, I\nthink we can deal with the binary contents right away..\n\n\n-----\n\n## The new encryption and the decryption\n\nWhen seeing Fbot binary's strings, I found it very interesting to see that there's a \"Satori\nbotnet's signature\", that was used for scanning vulnerable telnet by Satori botnets, that string\nis also written hard-coded in this FBOT binary:\n\nThe same string is also detected during the infection log too. this coincidence(?) is really a\n\"Deja Vu\" to logs seen in the Mirai Satori infection era within 2017-2018. But let's focus to the\nencryption strings instead.\n\nThere are two groups of encrypted configuration data (Mirai usually uses encrypted\nconfiguration data before being self-decrypted during the related execution process), but one\nof group of data looks like encrypted in a new different logic.\n\nThe first group of the data (the orange colored one) is in a form of encryption pattern that is\nnot commonly found in Mirai binaries before, which is the point of this post actually. And the\nblue-colored one is the data configuration that have been encrypted in pattern that is being\nused in table.c:table_init() of bot client, to then unlocking them for the further usage in\nmalicious process like telnet scanning (scanner_init), or the other functions in Mirai\n\n\n-----\n\noperation. The blue color part s encryption method is a known one, we can later see its\ndecrypted values too.\n\nThe first configuration (encrypted) data will be firstly loaded by table.c:add_entry() variant\nfunction of MIrai, but during the further process it is processed using a new different\ndecryption. Summarizing this method in a simpler words: that different decryption is a shuffle\nof alphabetical character set, based on a XOR'ed key that permutes its position.\n\nLet's access the .rodata section in address 0xf454 where the first group data-set is located.\nWhen you get there, after checking the caller reference, it will lead you to a function at\n0x9848 that's using those crypted values, see below:\n\n\n-----\n\nIf you go to the top of the function and see (address 0x984c and 0x9858) how two string-sets\nare loaded from addresses 0x10020 and 0x10062 to be passed into a function in 0x975C\nwith their length of 0x42 as secondary argument.\n\nThe two set loaded string-sets are saved in the ARM binary in this location:\n\n\n-----\n\nThere is a XOR key with value 0x59 applied to obfuscate the strings that was previously\nmentioned..\n\nBack to the function in 0x9848, the rest of the encrypted configuration data (the rest of\n\"orange\" ones) is parsed into function in 0x9780.\n\nFunction 0x9780 seems to be a modification of a table.c:add_entry() function in the original\nMirai code (or similar variants), the modified (or additional) part is a decoder logic of the\nparsed data. The parsed data will be translated against the character map formed after\nXOR'ed that is stored in the memory, to have its desired result.\n\n\n-----\n\nI hope the below loop graph is good enough to explain how the decoder works statically (I\nhave adjusted everything to fit into one image file).\n\nI think it would be better for you to see this first modified encryption config data process in\nthe way it is called from the Mirai's table_init() function reversed as per below:\n\nThis should be close enough to what adversary has coded.\n\nDynamically, the character mapping process used to translate the encrypted strings can also\nbe simulated in radare2 during on-memory analysis (it will be in the heap memory area\nsomewhere if you want to confirm it) as per below result:\n\n\n-----\n\nSo, additionally, static or dynamic reversing can produce same result. I always prefer the\nstatic one since I don't have to run any malware code just to crack its configuration.\n\nThe encoder table, in text! (enjoy!)\n```\n// The decoder is at [0x00009780], translated crypt into charmap below:\nMLSDFQWYXNCZRPOKGIUTABVHEJtfqomaechlynudwvjrxigkzsbp7890254163=@^$\nABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789./ \n```\n[I announced it yesterday in twitter [link], below is the decryption result:](https://twitter.com/malwaremustd1e/status/1217108607264669696)\n\nSince Mirai is coded in a way to make reverse engineering difficult, what you reverse in its\nbinary's code-flow is not what has actually had been coded in C, please noted this, in\nexample, In Mirai, the usage of global variables and the global structs, the #define or\n**#ifdef directives used, the method to unlock encryption process-used-variable values**\n**and then lock them all back afterwards, and many other tricks used and designed for the**\nsake of obstruction the reverse engineering. There is no shame in not reversing the overall\n\n\n-----\n\ncodes into original ones, especially what you get is embeded-platform system s binary like\nARM or MIPS or SH with way simpler assembly code. Reversers know this. Don't let this\ndiscourage you for not be proactive in reversing, but keep learning from it and learning it\nmore.\n\nBack to our binary, the timing on when the first and second encrypted configuration were\ndecrypted during malware execution process is different too. This is is the rough C flow of\nwhat this ARM binary process looks like during being executed, it's enough to explain my\npoint, which is, the timing when the first configuration was executed is when the process of\ninfection is happening, and the second configuration is used for the spreading/scanning\npurpose, which will be used afterward.\n\n(Warning! The function's namings above are self-made naming for my reversing purpose and\nnot the actual ones, I don't have ESP power to read the mind of the coder by reading his\nstripped binary, so please bear with differences etc..)\n\nThe static code above can be easily filled with its argument values with two ways, following\nthe registers or after you see how the malicious binary can be simulated its system calls,\nbelow is the snip code of what I did (the latter method) to show how this binary was executed\nas per flow above to reveal its values:\n\n\n-----\n\nNow we know for sure why I didn't get the file because it was self-deleted after running at the\nfirst time.\n\n## No. We are not done yet..\n\nAs you can see in the decrypted strings, it has mentioned \"pizza dongs helper\". And the C2\nfor this Mirai variant has been obviously shown during infection stage (the data is saved in\nthe configuration part that can be achieved by table.c at \"init\" process), it is on IP\n**5(.)206(.)227(.)65, if you do OSINT and seeking passive DNS data of the IP address, you will**\nsee some similar hostnames and domains to the wording used in the decryption data.\n\nBelow is the example of hostnames & domains linked to the C2 IP from a passive database:\n\nIt's same domain that also has been registered in multiple IP around the globe:\n\nWe keep on monitoring the spreader movement of this malware, these are several pickups of\nIoT devices log that is actively seeking for other vulnerable ARM devices. I sorted out in\ntimeline base. I hope the carriers that's having vulnerable devices on the list can pay\n\n\n-----\n\nattention to address this issue.\n\nThe IOC and STIX2 of this threat is in the posting process to usual portals.\n\nLastly, as additional, the alleged botnet coder/owner has just sent his compliment, which is\nrare, so I attached in this blog too:\n\n## Epilogue\n\nThis post is dedicated to wonderful people who fight tirelessly against IoT threat that keep on\naiming our devices until now, and also to people who try very hard to push new policy to\nhave us defend better for the threat. I hope this post helps you.\n\nThank you very much to r2ghidra, r2dec, r2 folks, tsurugi linux folks, MMD mates and friends,\nand all I can not mention in here, for supporting our effort in analyzing Linux malicious code\nall the time.\n\n[Edit] Thu Jan 23 2020, thank you Security Affairs for the [historical background and insights](https://securityaffairs.co/wordpress/96683/cyber-crime/linux-fbot-malware-analysis.html)\nof Mirai and Fbot.\n\n\n-----\n\n_This technical analysis and its contents is an original work and firstly published in the current_\n_MalwareMustDie Blog post (this site), the analysis and writing is made by @unixfreaxjp._\n\n[The research contents is bound to our legal disclaimer guide line in sharing of](https://blog.malwaremustdie.org/p/the-rule-to-share-malicious-codes-we.html)\nMalwareMustDie NPO research material.\n\nMalware Must Die!\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-15 - MMD-0065-2020 - Linux-Mirai-Fbot's new encryption explained.pdf"
    ],
    "report_names": [
        "2020-01-15 - MMD-0065-2020 - Linux-Mirai-Fbot's new encryption explained.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536118,
    "ts_updated_at": 1743041157,
    "ts_creation_date": 1653786044,
    "ts_modification_date": 1653786044,
    "files": {
        "pdf": "https://archive.orkl.eu/68dccbbc36a0ed5c160a5ee9640420641824528d.pdf",
        "text": "https://archive.orkl.eu/68dccbbc36a0ed5c160a5ee9640420641824528d.txt",
        "img": "https://archive.orkl.eu/68dccbbc36a0ed5c160a5ee9640420641824528d.jpg"
    }
}