{
    "id": "a0343b1b-c084-465f-85ea-01d1fd9ec769",
    "created_at": "2023-01-12T15:07:49.856834Z",
    "updated_at": "2025-03-27T02:16:37.222825Z",
    "deleted_at": null,
    "sha1_hash": "940e793532b99bcc3fac406c5c29332222bfa666",
    "title": "2021-01-06 - Retrohunting APT37- North Korean APT used VBA self decode technique to inject RokRat",
    "authors": "",
    "file_creation_date": "2022-05-28T03:32:36Z",
    "file_modification_date": "2022-05-28T03:32:36Z",
    "file_size": 3505474,
    "plain_text": "# Retrohunting APT37: North Korean APT used VBA self decode technique to inject RokRat\n\n**blog.malwarebytes.com/threat-analysis/2021/01/retrohunting-apt37-north-korean-apt-used-vba-self-decode-technique-**\nto-inject-rokrat/\n\nThreat Intelligence Team January 6, 2021\n\n_This post was authored by Hossein Jazi_\n\nOn December 7 2020 we identified a malicious document uploaded to Virus Total which was\npurporting to be a meeting request likely used to target the government of South Korea. The\nmeeting date mentioned in the document was 23 Jan 2020, which aligns with the document\ncompilation time of 27 Jan 2020, indicating that this attack took place almost a year ago.\n\nThe file contains an embedded macro that uses a VBA self decoding technique to decode\nitself within the memory spaces of Microsoft Office without writing to the disk. It then embeds\na variant of the RokRat into Notepad.\n\nBased on the injected payload, we believe that this sample is associated with APT37. This\nNorth Korean group is also known as ScarCruft, Reaper and Group123 and has been active\nsince at least 2012, primarily targeting victims in South Korea.\n\nIn the past, this APT has relied on Hangul Office documents (hwp files) to target victims, as\nit’s software that’s commonly used in South Korea. However, in this blog we describe an\ninteresting alternative method, delivered via self-decoding VBA Office files. To the best of our\nknowledge, this is a first for this APT group.\n\n\n-----\n\n## Document analysis\n\n[The actor used the VBA self-decoding concept in its macro that was first introduced in 2016.](https://blog.sevagas.com/IMG/pdf/my_vba_bot.pdf)\nA malicious macro is encoded within another that is then decoded and executed dynamically.\n\nFigure 1: Malicious document\nWe can consider this technique an unpacker stub, which is executed upon opening the\ndocument. This unpacker stub unpacks the malicious macro and writes it into the memory of\nMicrosoft Office without being written to disk. This can easily bypass several security\nmechanisms.\n\n\n-----\n\nFigure 2: Self decoding technique\nFigure 3 shows the macro used by this document. This macro starts by calling the “ljojijbjs”\nfunction, and based on the results will take different paths for execution.\n\nFigure 3: Encoded macro\nMicrosoft by default disables the dynamic execution of the macro, and if an attacker needs to\nexecute one dynamically—which is the case here—the threat actor needs to bypass the VB\nobject model (VBOM) by modifying its registry value.\n\nTo check if it can bypass the VBOM, it looks to see if the VBOM can be accessed or not. The\n_“ljojijbjs” function is used for this purpose and checks read access to the_\n_VBProject.VBComponent. If it triggers an exception, it means the VBOM needs to be_\nbypassed (IF clause). If there is no exception, it means the VBOM is already bypassed and\nVBA can extract its macro dynamically (Else clause).\n\n\n-----\n\nFigure 4: Check VB object model accessibility\n_“fngjksnhokdnfd” is called with one parameter to bypass VBOM. This function sets the VBOM_\nregistry key to one.\n\nFigure 5: Modifying VBOM registry key\nAfter bypassing VBOM, it calls another function which creates a Mutex in the victims’s\nmachine by calling CreateMutexA API call and names it “mutexname”. This has been used\nby the actor to make sure it infects the victim only once.\n\nFigure 6: Mutex\n\ncreation\nFinally, in order to perform the self-decoding process, it needs to open itself by creating a\nnew Application object and load the current document in it in invisible mode.\n\nFigure 7: Self open\n\nIf VBOM is already bypassed, The function Init is called and generates the malicious macro\ncontent in obfuscated format.\n\n\n-----\n\nFigure 8: Obfuscated macro\nIn the next step, this obfuscated macro is passed to “eviwbejfkaksd” to be de-obfuscated and\nthen executed into memory.\n\nFigure 9: De-obfuscator\nTo de-obfuscate the macro, two string arrays have been defined:\n\n_StringOriginal which contains an array of characters before de-obfuscation_\n_StringEncoded which contains an array of characters after de-obfuscation_\n\n\n-----\n\nA loop has been defined to de-obfuscate the macro. For each iteration it takes a character in\nthe obfuscated macro and looks for its index in StringEncoded. When it finds its index, it\nlooks for its equivalent index in StringOriginal, takes that character from it and adds it to the\nnew macro. As an example “gm* bf” as encoded macro will be decoded to “Option”.\n\nFigure 10: De-obfuscation loop\nFollowing this process gives us the final macro that will be executed in the memory space of\nMicrosoft Office. In order to execute this decoded macro, it creates a module and writes into\nit before calling its main function to execute the macro.\n\nThe main function defines a shellcode in hex format, and a target process which is\n_Notepad.exe. Then, based on the OS version, it creates a Notepad.exe process and_\nallocates memory within its address space using VirtualAlloc. It then writes the shellcode into\nthe allocated memory using WriteProcessMemory. At the end it calls CreateRemoteThread\nto execute the shellcode within the address space of Notepad.exe.\n\n\n-----\n\nFigure 11: De-obfuscated macro\n\n## Shellcode analysis (RokRat):\n\nThe shellcode injected into Notepad.exe downloads an encrypted payload from\n_http://bit[.]ly/2Np1enh which is redirected to a Google drive link._\n\n\n-----\n\nFigure 12: Download URL\nDownloaded payload is a variant of a cloud-based RAT known as RokRat which has been\n[used by this group since 2017. This sample compilation date is 29 Oct 2019. This RAT is](https://blog.talosintelligence.com/2017/04/introducing-rokrat.html)\nknown to steal data from a victim’s machine and send them to cloud services (Pcloud,\nDropbox, Box, Yandex).\n\nFigure 13: Encoded cloud services\n\nSimilar to its previous variants, it uses several anti-analysis techniques to make sure it is not\nrunning in an analysis environment Here are some of the checks:\n\n\n-----\n\nChecking the DLLs related to iDefense SysAnalyzer, Microsoft Debugging DLL and\nSandboxies\nCalling IsDebuggerPresent and GetTickCount to identify a debugger\nChecking VMWare related file\n\nFigure 14: Anti-analysis techniques\nThis RAT has the following capabilities:\n\nCapture ScreenShots\n\n\n-----\n\nFigure 15: Capture screenshots\n\nGather system info (Username, Computer name, BIOS)\n\n\n-----\n\nFigure\n\n\n16: Gather BIOS data\n\nData exfiltration to cloud services\n\n\n-----\n\n-----\n\nFigure 17: Data exfiltration\n\nStealing credentials\nFile and directory management\n\nFor more detailed analysis of this RAT you can refer to the reports from [NCC Group and](https://www.nccgroup.com/uk/about-us/newsroom-and-events/blogs/2018/november/rokrat-analysis/)\n[Cisco Talos.](https://blog.talosintelligence.com/2017/11/ROKRAT-Reloaded.html)\n\n## Conclusion\n\nThe primary initial infection vector used by APT37 is spear phishing, in which the actor sends\nan email to a target that is weaponized with a malicious document. The case we analyzed is\none of the few where they did not use Hwp files (Hangul Office) as their phish documents\nand instead used Microsoft Office documents weaponized with a self decode macro. That\ntechnique is a clever choice that can bypass several static detection mechanisms and hide\nthe main intent of a malicious document.\n\nThe final payload used by this threat actor is a known custom RAT (RokRat) that the group\nhas used in previous campaigns. In the past, RokRat has been injected into cmd.exe,\nwhereas here they chose Notepad.exe.\n\n\n-----\n\n## Indicators of Compromise\n\nMaldoc:\n\n3c59ad7c4426e8396369f084c35a2bd3f0caa3ba1d1a91794153507210a77c90\n\nRokRat:\n\n676AE680967410E0F245DF0B6163005D8799C84E2F8F87BAD6B5E30295554E08\n\nA42844FC9CB7F80CA49726B3589700FA47BDACF787202D0461C753E7C73CFD2A\n\n2A253C2AA1DB3F809C86F410E4BD21F680B7235D951567F24D614D8E4D041576\n\nC7CCD2AEE0BDDAF0E6C8F68EDBA14064E4A9948981231491A87A277E0047C0CB\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-06 - Retrohunting APT37- North Korean APT used VBA self decode technique to inject RokRat.pdf"
    ],
    "report_names": [
        "2021-01-06 - Retrohunting APT37- North Korean APT used VBA self decode technique to inject RokRat.pdf"
    ],
    "threat_actors": [
        {
            "id": "f809bfcb-b200-4988-80a8-be78ef6a52ef",
            "created_at": "2023-01-06T13:46:39.186988Z",
            "updated_at": "2025-03-27T02:00:03.016358Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "Adept Libra"
            ],
            "source_name": "MISPGALAXY:TeamTNT",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "bbe36874-34b7-4bfb-b38b-84a00b07042e",
            "created_at": "2022-10-25T15:50:23.375277Z",
            "updated_at": "2025-03-27T02:00:55.457787Z",
            "deleted_at": null,
            "main_name": "APT37",
            "aliases": [
                "APT37",
                "InkySquid",
                "ScarCruft",
                "Group123",
                "TEMP.Reaper",
                "Ricochet Chollima"
            ],
            "source_name": "MITRE:APT37",
            "tools": [
                "BLUELIGHT",
                "CORALDECK",
                "KARAE",
                "SLOWDRIFT",
                "ROKRAT",
                "SHUTTERSPEED",
                "POORAIM",
                "HAPPYWORK",
                "Final1stspy",
                "Cobalt Strike",
                "NavRAT",
                "DOGCALL",
                "WINERACK"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "552ff939-52c3-421b-b6c9-749cbc21a794",
            "created_at": "2023-01-06T13:46:38.742547Z",
            "updated_at": "2025-03-27T02:00:02.906537Z",
            "deleted_at": null,
            "main_name": "APT37",
            "aliases": [
                "ScarCruft",
                "Venus 121",
                "Moldy Pisces",
                "Group 123",
                "APT 37",
                "Group123",
                "Operation Daybreak",
                "Operation Erebus",
                "Red Eyes",
                "TA-RedAnt",
                "InkySquid",
                "Reaper Group",
                "Ricochet Chollima",
                "ATK4",
                "G0067"
            ],
            "source_name": "MISPGALAXY:APT37",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c3ca592f-0669-49bd-ab5c-310007ab2fb4",
            "created_at": "2022-10-25T15:50:23.334495Z",
            "updated_at": "2025-03-27T02:00:55.445098Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "TeamTNT"
            ],
            "source_name": "MITRE:TeamTNT",
            "tools": [
                "Peirates",
                "MimiPenguin",
                "LaZagne",
                "Hildegard"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f0bccc3d-ad77-49c4-8dfd-8a8a8d6fba26",
            "created_at": "2024-05-01T02:03:08.134022Z",
            "updated_at": "2025-03-27T02:05:17.415028Z",
            "deleted_at": null,
            "main_name": "NICKEL FOXCROFT",
            "aliases": [
                "Group 123 ",
                "Moldy Pisces ",
                "RICOCHET CHOLLIMA ",
                "Reaper ",
                "ScarCruft ",
                "APT37 "
            ],
            "source_name": "Secureworks:NICKEL FOXCROFT",
            "tools": [
                "ROKRAT"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "9b02c527-5077-489e-9a80-5d88947fddab",
            "created_at": "2022-10-25T16:07:24.103499Z",
            "updated_at": "2025-03-27T02:02:10.108504Z",
            "deleted_at": null,
            "main_name": "Reaper",
            "aliases": [
                "APT 37",
                "ATK 4",
                "Cerium",
                "Crooked Pisces",
                "Geumseong121",
                "Group 123",
                "ITG10",
                "InkySquid",
                "Moldy Pisces",
                "Opal Sleet",
                "Operation Are You Happy?",
                "Operation Battle Cruiser",
                "Operation Black Banner",
                "Operation Daybreak",
                "Operation Dragon messenger",
                "Operation Erebus",
                "Operation Evil New Year",
                "Operation Evil New Year 2018",
                "Operation Fractured Block",
                "Operation Fractured Statue",
                "Operation FreeMilk",
                "Operation Golden Bird",
                "Operation Golden Time",
                "Operation High Expert",
                "Operation Holiday Wiper",
                "Operation Korean Sword",
                "Operation North Korean Human Right",
                "Operation Onezero",
                "Operation Rocket Man",
                "Operation SHROUDED#SLEEP",
                "Operation STARK#MULE",
                "Operation STIFF#BIZON",
                "Operation Spy Cloud",
                "Operation Star Cruiser",
                "Osmium",
                "Red Eyes",
                "Ricochet Chollima",
                "Ruby Sleet",
                "ScarCruft",
                "TA-RedAnt",
                "TEMP.Reaper",
                "Venus 121"
            ],
            "source_name": "ETDA:Reaper",
            "tools": [
                "Agentemis",
                "BLUELIGHT",
                "Backdoor.APT.POORAIM",
                "CARROTBALL",
                "CARROTBAT",
                "CORALDECK",
                "Cobalt Strike",
                "CobaltStrike",
                "DOGCALL",
                "Erebus",
                "Exploit.APT.RICECURRY",
                "Final1stSpy",
                "Freenki Loader",
                "GELCAPSULE",
                "GOLDBACKDOOR",
                "GreezeBackdoor",
                "HAPPYWORK",
                "JinhoSpy",
                "KARAE",
                "KevDroid",
                "Konni",
                "MILKDROP",
                "N1stAgent",
                "NavRAT",
                "Nokki",
                "Oceansalt",
                "POORAIM",
                "PoohMilk",
                "PoohMilk Loader",
                "RICECURRY",
                "RUHAPPY",
                "RokRAT",
                "SHUTTERSPEED",
                "SLOWDRIFT",
                "SOUNDWAVE",
                "SYSCON",
                "Sanny",
                "ScarCruft",
                "StarCruft",
                "Syscon",
                "VeilShell",
                "WINERACK",
                "ZUMKONG",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536069,
    "ts_updated_at": 1743041797,
    "ts_creation_date": 1653708756,
    "ts_modification_date": 1653708756,
    "files": {
        "pdf": "https://archive.orkl.eu/940e793532b99bcc3fac406c5c29332222bfa666.pdf",
        "text": "https://archive.orkl.eu/940e793532b99bcc3fac406c5c29332222bfa666.txt",
        "img": "https://archive.orkl.eu/940e793532b99bcc3fac406c5c29332222bfa666.jpg"
    }
}