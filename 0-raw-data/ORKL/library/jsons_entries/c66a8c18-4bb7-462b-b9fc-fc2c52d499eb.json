{
    "id": "c66a8c18-4bb7-462b-b9fc-fc2c52d499eb",
    "created_at": "2023-01-12T15:09:49.49871Z",
    "updated_at": "2025-03-27T02:05:28.433728Z",
    "deleted_at": null,
    "sha1_hash": "6ff0a3ee898dd25fd8b9ef3aceb9891d088cb40e",
    "title": "2020-08-12 - Color by numbers- inside a Dharma ransomware-as-a-service attack",
    "authors": "",
    "file_creation_date": "2022-05-28T01:22:14Z",
    "file_modification_date": "2022-05-28T01:22:14Z",
    "file_size": 2518984,
    "plain_text": "# Color by numbers: inside a Dharma ransomware-as-a- service attack\n\n**[news.sophos.com/en-us/2020/08/12/color-by-numbers-inside-a-dharma-ransomware-as-a-service-attack/](https://news.sophos.com/en-us/2020/08/12/color-by-numbers-inside-a-dharma-ransomware-as-a-service-attack/)**\n\nSean Gallagher August 12, 2020\n\nDharma, a family of ransomware first spotted in 2016, continues to be a threat to many\norganizations—especially small and medium-sized businesses. Part of the reason for its\nlongevity is that its variants have become the basis for ransomware-as-a-service (RaaS)\noperations—the fast-food franchise of cybercrime. Three recent attacks documented by\nSophosLabs and Sophos MTR have revealed a toolset used by Dharma “affliliates” that\nexplains why attacks from so many different Dharma actors seem so identical, down to the\ntools and commands they use.\n\nWhile other, newer ransomware families have grabbed recent headlines with high-profile\nvictims and multi-million-dollar demands, Dharma has continued to be among the most\nprofitable. In part that’s because actors with access to the source code continue to innovate\naround delivering the ransomware as a packaged business for less-sophisticated criminal\noperators. The Dharma RaaS we’ve investigated is targeted at entry-level cyber-criminals,\nand provides a paint-by-the-numbers approach to penetrating victims’ networks and\nlaunching ransomware attacks.\n\nThe actors using this particular RaaS are equipped with a package of pre-built scripts and\n“grey hat” tools that requires relatively little skill to operate. The Dharma operations we’ve\ndocumented use a combination of internal Windows tools, legitimate third-party “freeware”\nsoftware, well-known security tools and publicly-available exploits, integrated together\n[through bespoke PowerShell, batch, and AutoIT scripts. This pre-packaged toolkit, combined](https://www.autoitscript.com/site/)\nwith back-end technical support, significantly extends the reach of the Dharma RaaS\n\n\n-----\n\noperators, allowing them to profit while their afililates do the hands-on-keyboard work of\nbreaching networks, dropping ransomware, and managing “customer service” with the\nvictims.\n\n### Ransomware economics\n\nDharma, formerly known as CrySis, has many variants, due to the sale and modification of\nits source code to multiple malware developers. Those transfers aren’t necessarily from the\nmalware’s original authors, either—in March, a collection of source code for one variant of\nDharma [was offered for sale on Russian-language crime forums for $2000 through an](https://nakedsecurity.sophos.com/2020/03/31/dharma-ransomware-source-code-on-sale-for-2000/)\nintermediary.\n\nA\n\nforum post from March 2020 offering the Dharma ransomware sourcecode for $2000.\n\n\n-----\n\nBecause of its availability, Dharma has become the center of a criminal ecosystem based on\na “syndication” business model. Dharma RaaS providers offer the technical expertise and\nsupport, operating the back-end systems that support ransomware attacks. “Affiliates” (often\nentry-level cybercriminals) pay for the use of the RaaS, and carry out the targeted attacks\nthemselves, using a standard toolkit. Other actors provide stolen credentials and other tools\non criminal forums that enable the Remote Desktop Protocol attacks that are the\npredominant means of initial compromise for Dharma actors. (RDP attacks are the root\n[cause of about 85 percent of Dharma attacks, based on statistics provided by Coveware.)](https://www.coveware.com/dharma-ransomware-payment)\n\nA\n\ndark web site selling RDP credentials, including some with administrative privileges. These\nmarketplaces in some cases allow buyers to verify the accounts work before they buy them.\nRansom demands from Dharma actors trend below those of the other major types of\ntargeted ransomware over the past year. In December of 2019, when the average\nransomware demand had surged to $191,000, the average Dharma ransom demand was\nonly $8,620. That’s in part due to the types of targets hit by Dharma (mostly small and\nmedium businesses), and in part because of the skills, experience and location of the\naffiliates running the attacks. In any case, Dharma operators make up for the lower ransom\ndemands with volume—Dharma remains one of the most profitable ransomware families,\naccording to Coveware.\n\nDharma uses a complicated two-stage decryption process that partitions the affiliate actors\nfrom the actual key retrieval process. Victims who contact the attackers are given a firststage tool that extracts information about the files that were encrypted into a text file. That\n\n\n-----\n\ntext file gets cut-and-pasted into email and is sent back to the affiliates—who then have to\nsubmit that data through a portal for the RaaS to obtain the actual keys. This keeps the\naffiliates dependent on the RaaS, and it keeps them paying for service.\n\nJust how well the decryption process works depends greatly on the expertise and the moods\nof the affiliates. Occasionally an actor will hold back some of the keys with additional\ndemands. And there’s constant “churn” among the front-end actors, as the “subscriptions” of\nsome to RaaS services expire and others with less experience take their place, resulting in\noccasional misfires.\n\n### The Dharma playbook\n\nMost Dharma operators don’t make significant changes to the source. But Dharma RaaS\noperators appear to package together a number of tools and best practices for their\n“affiliates” to use once they’ve gotten onto a victim’s network.\n\nThese tools aren’t completely automated, as every attack does not follow the same exact\nsteps. However, they do follow something amounting to step-by-step instructions, akin to a\ntelemarketer’s script, allowing some room for improvisation. And one of those tools is a\nmenu-driven PowerShell script that installs and launches the components required to spread\nransomware across the network.\n\nAfter getting an RDP connection, the attacker maps a directory containing the RaaS toolkit\non their local drive as a network drive accessible from the remote desktop. The contents of\nthis directory include a number of applications previously identified as potentially unwanted\napplications (such as the Mimikatz password extraction tool), customized hacking tools, and\nfreeware versions of a variety of legitimate system utilities. (A full list of the files is included\n[in the indicators of compromise file on SophosLabs’ GitHub page. )](https://github.com/sophoslabs/IoCs/blob/master/Ransomware-Dharma-RaaS.csv)\n\nThe kit also includes the Dharma ransomware executable, and a collection of PowerShell\nscripts, most of which we were unable to recover for analysis. However, we did recover a\nmaster script from console logs. Called toolbelt.ps1, the menu-driven console script\nautomates the use of the tools, allowing attackers to simply type in the number associated\nwith each pre-scripted element.\n\nWhen executed, it identifies itself in the console frame as “Toolbox,” and if executed with\nadministrative privileges, advises the user/attacker, “Have fun, bro!”\n\n\n-----\n\nThe startup screen for toolbelt.ps1\nThe “menu” selections in Toolbox aren’t displayed as a menu by the script as it executes,\nthough they are largely documented in the script itself. Tools are downloaded to the remote\ncomputer by the script as needed, executed, and in many cases deleted after use.\n\nThe menu commands we identified, by the numbers and symbols they are called by, were as\nfollows:\n\n**“Menu”**\n**entry** **Triggered function**\n\n+ Executes Start-Tor.ps1, a script that launches a Tor network connection.\n\n. Executes Email-Screenshot.ps1, which creates a screenshot from the remote\nsystem and sends to the email address (provided by the operator at a prompt in\nthe script).\n\n1 Runs LaPass.ps1, a “User changer” script. (We could not recover the script\nitself.)\n\n\n-----\n\n2 Starts lusrmgr.msc, the Windows local user management plug-in.\n\n3 Executes lubrute.ps1, a PowerShell script that attempts to get passwords to\nlocal user accounts through a brute force attack.\n\n4 Copies and launches Mimikatz password extraction tools, dumping results to a\ntext file.\n\n\n-----\n\n5 Executes Find-Pass.ps1, a PowerShell script. (We were unable to recover this\nscript for analysis.)\n\n6 Copies password viewers from a shared directory on the initially compromised\nmachine to %temp%, and then opens a File Explorer window on that directory.\n\n\n-----\n\n6\n\n\n-----\n\n7 [Copies and and executes the NirSoft Remote Desktop PassView password](https://www.nirsoft.net/utils/remote_desktop_password.html)\nviewer tool.\n\n8 Copies and executes LaZagne.exe, the Windows executable version of the\n[LaZagne password scraper.](https://github.com/AlessandroZ/LaZagne)\n\n\n-----\n\n9 Copies and executes Hash Suite Tools Free edition’s Hash Dump utility, and\nopens the website dropmefiles[.]com—potentially to exfiltrate the password\nhashes for remote matching attempts.\n\n10 Runs the script Delete-AVServices.ps1, which searches a list of malware\nprotection related Windows services and partial service names to search for and\nkill.\n\n\n-----\n\n11 Launches appwiz.cpl, the Add/Remove Programs Windows control panel.\n\n12 Copies and executes the PC Hunter system diagnostics tool.\n\n13 Copies, installs and executes ProcessHacker:\n\n\n-----\n\n-----\n\n14 Copies, installs and executes IOBit Unlocker, a utility for removing file locks that\nwould prevent deletion or encryption,\n\n\n-----\n\n-----\n\n15 [Copies and executes GMER, a “rootkit detector” used to reveal hidden](http://www.gmer.net/)\nprocesses.\n\n\n-----\n\n16 [Copies and executes a freeware version of Revo Uninstaller, a tool for](https://www.revouninstaller.com/revo-uninstaller-free-download/)\nuninstalling Windows software and cleaning up files left over from an uninstall.\n\n17 [Copies and executes IOBit Uninstaller, another software uninstaller tool.](https://www.iobit.com/en/advanceduninstaller.php)\n\n18 Executes a PowerShell script, “Disable-WinDefend.ps1 /t” .\n\n20 Executes a PowerShell script, “purgeMemory.ps1/” .\n\n21 Executes takeaway.exe, the payload package that drops the ransomware.\n\n22 Stops the winhost.exe process (the Dharma ransomware executable)\n\n23 Executes a PowerShell script, winhostok.ps1.\n\n\n-----\n\n25 Calls a function of the script called “Infect”, which deploys a file called\njavsecc.exe — called a “zombie” by the Dharma developers.\n\nMessage box from\n\njavsecc.exe\nUpon execution, a message box pops up (the window name translates as\n“Zombification”). The message reads:\n\n_This build is able to destroy the working files of the “zombie”. Continue, when_\n_build process is finished. Continue?_\n\nClicking “OK” executes an AutoIT process that:\n\nobtains the external IP address of the system it runs on by calling multiple\nremote services:\nLOCAL $AGETIPURL = [ “https://api.ipify.org”,\n“http://checkip.dyndns.org”, “http://www.myexternalip.com/raw”,\n“http://bot.whatismyipaddress.com” ]\ndownloads and installs a Tor network client (tor.exe) ;\nchecks install of Tor by pinging the local host address, then deletes\ntemporary files;\ncollects system information and user account data, and sends to a remote\n.onion (Tor) server.\nsleeps and waits for timer events.\n\n30 Executes a PowerShell script described as “Local Network Computer Listing”\nby the console output, called NetPC.ps1.\n\n31 Executes the PowerShell script NetSubPC.ps1, another network computer\nname browser.\n\n\n-----\n\n32 Launches mstsc.exe, the Remote Desktop Connection (RDP) client.\n\n33 Copies and starts ns2.exe, a known PUA. The executable can scan for network\nshares and local unmounted volumes.\n\n\n-----\n\n34 [Copies and starts Advanced IP Scanner (IPScan2.exe), a commercial](https://www.advanced-ip-scanner.com/)\nfreeware tool that can identify and access shared network folders, control other\ncomputers on the network via RDP and Radmin remote control software, and\nexecute remote shutdowns.\n\n40 Retrieves a list of computers from Active Directory by running NetADPC.ps1.\n\n41 Executes a PowerShell script named adbrute.ps1 (likely another Mimikatz\nscripted brute force attack on Active Directory accounts).\n\n42 Copies and executes a PowerShell script named 2sys.ps1.\n\n43 Launches the Windows Active Directory management snap-in (dsa.msc).\n\n44 Launches the Group Policy Management Console snapin (gpmc.msc).\n\n\n-----\n\n45 Runs “Mimi NL,” a more automated version of the Mimikatz password hacking\ntool. This tool appears to have been developed by the Dharma RaaS\ndevelopers.\n\n\n-----\n\n50 Opens the %TEMP% directory in a Windows file explorer window.\n\n50\n\n\n-----\n\n51 Launches Windows Task Manager.\n\n51\n\n\n-----\n\n52 Opens a PowerShell shell.\n\n52\n\n53 Opens a command shell.\n\n54 Runs rdclip.exe, the Remote Desktop shared clipboard.\n\n55 Reboots the computer.\n\n56 Copies and executes ClearLock.exe, a screen locker.\n\n\n-----\n\n-----\n\n57 Executes a PowerShell script called wallet.ps1.\n\n60 Copies and executes a batch script, addSupport.bat.\n\n61 Copies and executes a published proof-of-concept privilege escalation exploit\n(CVE-2018-8120) —either the 32-bit (x86.exe) or 64-bit (x64.exe) version.\n\n99 Starts toolbelt1.ps1 (which could be updated version of toolbelt).\n\n\n-----\n\n88 Enables WinRM remote management using the WS-Management protocol, This\nallows administrative commands to be sent to the computer via an HTTP\nrequest from any IP address.\n\n101 Copies and executes a program called SafeMode, launched with a batch script\ncalled AsAdmin.bat. (We did not recover these files for analysis.)\n\n155 [Copies and executes Registry Finder, a tool for editing Windows’ Registry.](https://registry-finder.com/)\n\n211 Copies and executes the Dharma payload package from the path mapped to\nthe attacker’s computer: $tsclient\\x\\1\\Takeaway.exe.\n\n212 Copies and executes the Dharma payload package from the path\n$tsclient\\x\\2\\Takeaway.exe.\n\n213 Copies and executes the Dharpayload package from the path\n$tsclient\\x\\3\\Takeaway.exe.\n\n214 Copies and executes payload package from the path\n$tsclient\\x\\4\\Takeaway.exe.\n\n\n-----\n\n222 Copies and executes javsec.exe, another automated Mimikatz password\ncracking tool built with AutoIT. The executable runs mimikatz.exe and a\ndisguised version of the NL Brute utility named postgresqlapi.exe (a network\nlogin brute force tool).\n\n223 Opens the directories $env\\temp\\$guid and\n$env\\appdata\\PostgreSQL\\API\\$guid (probably for temporary storage)\n\n224 Performs “cleanup” by deleting processes tor, torque, and PostGreSQLapi.exe,\nand clears the directories $envtemp\\$guid and\n$env\\appdata\\PostgreSQL\\API\\$guid.\n\n300 Unpacks and executes the contents of the package LBru4v4.zip\n\n401 Copies a directory called “WMIDomain” from the toolset share and executes a\nPowerShell script called GetHosts.ps1.\n\n600 Kills all processes except for PowerShell and unnamed windows.\n\n666 Executes a PowerShell command that writes a new script called “sample.ps1”\nfrom the contents of the Windows clipboard. That script is then executed in\nopens a command shell with the permissions of an account passed to the script\nwith an environmental variable and a password encoded into the command\nopening the PowerShell shell (2qaz!QAZ).\n```\n      {try {Add-Type -AssemblyName PresentationCore`\n      $clip = [Windows.Clipboard]::GetText()`\n      $clip | Out-File $destination\\sample.ps1}`\n      catch {RedAlert Failed to copy vicious code. Try 52, then right\n      click...}`\n      start $PsHome\\powershell.exe \" -NoProfile -ExecutionPolicy Bypass -File\n      $destination\\sample.ps1\" -Verb RunAs }`\n      - {start -FilePath cmd.exe -ArgumentList \"/c net user $env:USERNAME\n      2qaz!QAZ & pause\"}`\n\n```\nThe pasted code executes Takeaway.exe, the Dharma payload. If the code\ncreation fails, the script advises the attacker to use menu entry 52 to respawn\nPowerShell.\n\nThe order of the use of the toolbelt.ps1 script varies, but we have observed common patterns\namong Dharma attackers. In one typical attack, we saw the operators follow the following\nsteps:\n\nThe attacker launched the toolbelt script (toolbelt.ps1 -it 1)\n10: delete-avservices.ps1\n15: GMER (gamer.exe)\n13: installing and launching ProcessHacker\n\nexecuting processhacker-2.39-setup.exe\nexecuting processhacker.exe\n222: javsec.exe (Mimikatz /NL Brute wrapper)\n\n\n-----\n\n34: ipscan2.exe (Advanced IP Scanner)\n32: mstsc.exe\n21: takeaway.exe (ransomware package)\n\nexecutes winhost.exe (Dharma)\nexecutes purgememory.ps1\n33: ns2.exe (network scan)\n\n### Playing by the book\n\nWhile the toolbelt.ps1 script is somewhat self-documenting, it’s clear that the end users of\nthe script—the Dharma affiliates—are also operating from some other form of\ndocumentation. The “toolbelt” gives them all the access they need to move laterally across\nthe network, exploiting domain administrator level credentials that they either steal or create\nthrough elevated privileges, but it’s not clear how fully automated some of the steps of that\nprocess are. Those steps are likely detailed in a how-to document created by the Dharma\nRaaS operators.\n\nThe ease with which Dharma attackers are able to take these tools and effectively spread\nransomware on victims’ networks demonstrates the risks posed by both grey hat and\nlegitimate but potentially unwanted administrative tools. And it underlines the risks\nassociated with improperly secured RDP servers, the major vector for most targeted\nransomware attacks. Given that many of these attacks are made with stolen credentials\npurchased in forums, the Dharma attacks may be just one of many intrusions onto victims’\nnetworks.\n\nThe majority of these Dharma affiliate attacks can be blunted by ensuring RDP servers are\npatched and secured behind a VPN with multi-factor authentication. Organizations need to\nremain vigilant about credential theft through phishing, particularly as they adjust to having\nmore employees working remotely. And attention needs to be paid to access given to to\nservice providers and other third parties for business purposes.\n\nSophos detects the tools mentioned in this report as malware or PUAs. And data collected\nby Sophos MTR helps continuously improve detections of Dharma attacks. A full list of\nindicators of compromise, including detection names for the tools and malware mentioned in\n[this report, can be found on SophosLabs’ GitHub page here.](https://github.com/sophoslabs/IoCs/blob/master/Ransomware-Dharma-RaaS.csv)\n\n## SophosLabs would like to acknowledge the contributions of Anand Ajjan, Andrew O’Donnell and Gabor Szappanos of SophosLabs, and Syed Shahram Ahmed and Peter Mackenzie of the Sophos MTR Incident Response team to this report.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-08-12 - Color by numbers- inside a Dharma ransomware-as-a-service attack.pdf"
    ],
    "report_names": [
        "2020-08-12 - Color by numbers- inside a Dharma ransomware-as-a-service attack.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536189,
    "ts_updated_at": 1743041128,
    "ts_creation_date": 1653700934,
    "ts_modification_date": 1653700934,
    "files": {
        "pdf": "https://archive.orkl.eu/6ff0a3ee898dd25fd8b9ef3aceb9891d088cb40e.pdf",
        "text": "https://archive.orkl.eu/6ff0a3ee898dd25fd8b9ef3aceb9891d088cb40e.txt",
        "img": "https://archive.orkl.eu/6ff0a3ee898dd25fd8b9ef3aceb9891d088cb40e.jpg"
    }
}