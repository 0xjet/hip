{
    "id": "dca7641b-b895-4cd2-932a-13c95c0422c8",
    "created_at": "2023-01-12T15:10:34.959953Z",
    "updated_at": "2025-03-27T02:05:51.467482Z",
    "deleted_at": null,
    "sha1_hash": "3a2c15180c6f83b02ff4615bd259e4068e624779",
    "title": "2016-01-26 - URLZone Zones in on Japan",
    "authors": "",
    "file_creation_date": "2022-05-28T15:45:44Z",
    "file_modification_date": "2022-05-28T15:45:44Z",
    "file_size": 402939,
    "plain_text": "# URLZone Zones in on Japan\n\n**[fireeye.com/blog/threat-research/2016/01/urlzone_zones_inon.html](https://www.fireeye.com/blog/threat-research/2016/01/urlzone_zones_inon.html)**\n\nRecently we’ve seen an interesting trend from several crimeware families that were mainly\nactive in the European region, and have now expanded their activity to Japan. Rovnix is one\nsuch family, as recently reported by IBM X-Force.\n\nAt the same time, we’ve seen another spam campaign break out in Japan. The malware\nattempted to deliver another old banking trojan named URLZone (aka Shiotob/Bebloh),\n[which was initially discovered in 2009. URLZone is known to be very active in the European](https://www.virusbtn.com/virusbulletin/archive/2012/09/vb201209-URLZone)\nregion, especially Spain and Germany. Now we have noticed that the spam group is focusing\non Japan.\n\nThis blog describes a URLZone spam campaign targeting Japan in December 2015. We\ndiscuss its new persistence and evasion techniques, as well as its well-known password\nstealing method and command and control (CnC) communication.\n\n## Spam Campaign\n\nOn Dec. 16, 2015, and Dec. 21, 2015, we saw an extensive amount of URLZone spam\nemails being delivered to Japanese email users. Figure 1 represents the spikes of URLZone\nspam activity we detected during that time.\n\n\n-----\n\nFigure 1. Timeline of URLZone activities\n\nURLZone spam campaigns usually take place by targeting a specific region. The spam\nemails are crafted with the target region’s language, and are often sent using email account\ndomains belonging to the target region. This increases the chance of recipients opening the\nmalicious attachment, especially in non-English speaking regions, as the recipients are more\nfamiliar in exchanging emails in their native language.\n\nThe email subject and content were simple and generic. The subjects were written in English\nand Japanese with short Japanese sentences for the body, as shown in Figure 2.\n\n\n-----\n\nFigure 2. URLZone spam email samples\n\nMost of the spam emails were sent from freely available web email accounts in Japan. The\nmajority of the emails used the domains softbank.jp and yahoo.co.jp, which are the largest\nmobile carrier and web portal service in Japan respectively.\n\nAn attached ZIP archive containing URLZone binaries was given two extension names in\norder to disguise it as a DOC or JPG file and trick recipients into opening the malicious\nattachment. For example “scan01_doc_2015~jpeg.zip” extracts\n“scan01_doc_2015~jpeg.jpeg.exe”.\n\n## Malware Analysis\n\nURLZone is a banking trojan. It downloads a configuration file that contains information on\ntargeted financial institutions, and uses web injection techniques to steal a user’s banking\ncredentials. While the basic characteristics of URLZone samples in the campaign in Japan\n[remained the same as the previous analysis done by Arbor Networks, several new features](https://www.arbornetworks.com/blog/asert/an-update-on-the-urlzone-banker/)\nwere added to the latest URLZone sample.\n\n### Initial Infection Stage\n\nThe malware uses process hollowing (also known as process replacement) to mask its\nexecution. The malware tries to hollow explorer.exe or iexplorer.exe with a “_section” as\nadded command-line parameter to identify this process as spawned by the malware.\n\n\n-----\n\nThe process it hollows is initially started as suspended. It then modifies or writes its malicious\ncode to the entry point of the hollowed process. Once the necessary code is written, it will\nresume the suspended process, thus executing its malicious payload.\n\nNext, the malware does one of the following:\n\n1.   Continues to run the malicious routine in this hollowed process if the hollowed process\nis 64-bit or it has a window (this is for hollowed iexplore.exe).\n\n2.   Continues the malicious routine by injecting itself into the running explorer.exe on the\nsystem.\n\n### Stolen Information\n\n**System Survey**\n\nTo identify the victim system, the malware acquires the following details:\n\n-    Computer name\n\n-    OS major/minor version, as well as install date\n\n-    Hollowed process name version and time stamp\n\n-    IP address\n\n-    Keyboard layout\n\n[This is sent out in a beacon POST to the CnC server as described in Arbor’s report.](https://www.arbornetworks.com/blog/asert/an-update-on-the-urlzone-banker/)\n\n**Email Addresses**\n\nURLZone steals the email addresses stored in the Windows Address Book (WAB). It does so\nby querying both wab32.dll and WAB file name in the registry. It then uses this library to\nparse through the WAB file and save the information to a randomly generated value in a\nrandomly generated key /SOFTWARE/<random>/<random_value>.\n\n**Web/FTP/Email Information and Credentials**\n\nThe malware steals web and FTP information by injecting malicious code into commonly\nused programs for connectivity. It injects a specific malicious routine on each target program\nthat hooks a certain library used to send or receive network traffic. A continuous thread is\nrunning that constantly checks for the presence of these applications, and concurrently\ninjects a certain hooking function dependent of the process name. The hooking process is\ndescribed in depth here.\n\n-    iexplore.exe – WinInet hooking\n\n\n-----\n\n-    explorer.exe – WinInet hooking\n\n-    myie.exe – WinInet hooking\n\n-    firefox.exe. – WinInet hooking\n\n-    ftpte.exe – WinSock hooking\n\n-    coreftp.exe - WinSock hooking\n\n-    filezilla.exe - WinSock hooking\n\n-    TOTALCMD.EXE - WinSock hooking\n\n-    cftp.exe - WinSock hooking\n\n-    FTPVoyager.exe - WinSock hooking\n\n-    SmartFTP.exe - WinSock hooking\n\n-    WinSCP.exe - WinSock hooking\n\n-    chrome.exe – WinInet hooking\n\n-    opera.exe – WinInet hooking\n\nFor FTP/Email applications (that do WinSock hooking), it hooks 3 APIs from ws2_32.dll:\n\n-    ws2_32_send\n\n-    ws2_32_connect\n\n-    ws2_32_close\n\nIt monitors FTP/MAIL transactions through ws2_32_connect by checking for the string “FTP”\nand “MAIL” on the connect parameters. The FTP/MAIL server address and connection\nhandle is stolen from this hook. The ws2_32_send hook captures the authentication request\nby checking the strings “USER” and “PASS” to steal the user’s credentials.\n\nFor Web applications that use WinInet, it consists of API hooks used for monitoring HTTP/S\nsessions using the hooks shown in the appendix.\n\nThese hooks look for strings as specified in the malware’s configuration file, and these\nstrings target the data from financial institutions. If a match is found, the malware sends out\nthe information to its CnC server.\n\n### Command and Control\n\n\n-----\n\n[URLZone uses a Domain Generation Algorithm (DGA), as stated in other reports. The initial](http://www.johannesbader.ch/2015/01/the-dga-of-shiotob/)\nCnC URL starts of as a hard-coded encrypted string within the malware body. If the hard[coded URL doesn’t work, the malware then uses DGA to find the right one.](http://www.johannesbader.ch/2015/01/the-dga-of-shiotob/)\n\nThe malware checks for Internet connectivity by first connecting to google.com. It then\nproceeds to check, through SSLv3 handshake, whether the generated URL responds to its\ncertificate. It continuously does this until a valid URL is found.\n\nThe DGA takes in the previous URL as a seed to generate other domains.\n\n### Persistence Mechanism\n\nUnlike many other banking trojans, URLZone uses a clever persistence mechanism and\nclears its registry configuration only upon logoff, reboot, and shutdown.\n\n[It does this using a Window Procedure that monitors Window Messages for](https://msdn.microsoft.com/en-us/library/windows/desktop/aa376890(v=vs.85).aspx)\nWM_QUERYENDSESSION\n\nFigure 3 shows a subroutine of the Windows Procedure.\n\nThe persistence mechanism and registry clearing is done using the following method:\n\n1.   Malware creates a copy of itself unto %ProgramFiles% for Windows XP and\n%AppData% for Windows Vista and up with a randomly generated filename from a given list\nof strings. We’ll call this %dropfilepath%.\n\n2.   It registers a Window Procedure to monitor the window messages.\n\n3.   The Window Procedure checks the Windows Messages coming in the system and waits\nfor a Window Message WM_QUERYENDSESSION to execute its routine, as describe below\nin Figure 3.\n\nFigure 3. Monitoring system shutdowns\n\nIf the Window Procedure catches a WM_QUERYENDSESSION Window message it\nperforms the following actions:\n\n\n-----\n\na.  Delete the random registry key HKLM/SOFTWARE/<random>, which contains the stolen\nemail addresses and interprocess configuration of injected routines.\n\nb.  Create Startup registry on Software\\Microsoft\\Windows\\CurrentVersion\\Run and write its\ncorresponding registry value in either one of these methods:\n\ni.   Generate shortcut file (LNK file) pointing to %dropfilepath% and append\n“-autorun” to generated lnk file.\nii.   If %dropfilepath% doesn’t exist, continue to write a registry value with a –\n**autorun parameter.**\n\n-   Generate a random 20 character string with file extension .txt, and concatenate it with\nthe folder of %dropfilepath% and name this as %txtfilepath%. Write a copy of the malware\nbinary to %txtfilepath%, which is found on the running malware’s process heap or memory.\nCall MoveFileExA with the DELAY_UNTIL_REBOOT flag to copy the contents from\n%txtfilepath% to %dropfilepath%. Specifying the DELAY_UNTIL_REBOOT flag, the binary\ndelays this file’s move operation until the system reboots. This is likely done to prevent\nsecurity software from being suspicious. Figure 4 shows the corresponding MoveFileExA API\ncall.\n\nFigure 4. Delayed MoveFileExA API call to prevent antivirus detection\n\n### Random Filename Generation\n\nURLZone uses an interesting algorithm to generate random filenames. Unlike most banking\ntrojans, which generate random looking strings for dropped filenames, URLZone uses an\narray of strings to generate the filename of the dropped file. To add entropy to the random\n\n\n-----\n\nstring generation algorithm, it uses a subroutine that creates a random byte using the\nRDTSC instruction combined with other arithmetic operations.\n\nThe array of strings used to generate the filename is as follows:\n\nchar *filenames[] = [\"win\", \"video\", \"def\", \"mem\", \"dns\", \"user\", \"logon\", \"hlp\", \"mixer\", \"pack\",\n\"mon\", \"srv\", \"exec\", \"play\"]\n\nThe random string generation algorithm can be invoked in two ways:\n\n1.   rand(len_min, len_max, upper_offset_limit) -> to construct a random string from a given\nstring.\n2.   rand(upper_offset_limit) -> to get a random string from a given array.\n\nlen_min and len_max are the minimum and maximum lengths of the string to be returned.\nThe upper_offset_limit is the upper limit of the offset, which is generated randomly.\n\nThe above algorithms are used to generate the filename as follows:\n\n1.   Get a string randomly from the above array.\n2.   Construct a random string of length between 1 and 2 from the string:\n\"qwertyuiopasdfghjklzxcvbnm123945678\"\n3.   Calculate a flag randomly and check its value. If the value of the flag is 0, then it\nproceeds to concatenate the strings generated in step 1 and 2. If the value of flag is 1, then it\ngets one more string randomly from the array similar to step 1.\n\nBy putting all this together, we have the following two ways filenames can be generated\nbased on the value of the random flag:\n\n1.   If flag is 0, then concatenate strings in steps 1 and 2.\n2.   If flag is 1, then concatenate strings in steps 1, 2, and 3.\n\nThe reason for generating the filenames this way may be to evade heuristics of security\nproducts, which alert on dropped executable files with randomly generated names. The\nfilename generated using the above algorithm looks human readable and less suspicious.\n\n### Evasion Technique\n\nURLZone attempts to detect the use of VMware using the following method:\n\n1.   Resolve SetupDi APIs by pre-calculated string hash from setupapi.dll\n\n2.   Retrieve the device information using those APIs\n\n3.   Check if the device names acquired contain the string “vm”\n\n\n-----\n\nFigure 5. VMware sandbox detection\n\nAs shown in Figure 5, the malware partially collects two characters from\n“Software\\Microsoft\\Windows\\CurrentVersion\\Run” string to build up “vm” for comparison.\nSetupDi API enumerates all the names of the devices installed in the system, such as\n“vmware”, “svga ii”.\n\nAs soon as one of the device names starts with the string “vm” it will jump to a hooking\nfunction and soon terminates the thread, thus not allowing the malware to continue further\nwith is routine and CnC callback.\n\n## An Ongoing Campaign\n\nOn Jan. 19, 2016, and Jan. 20, 2016, we observed another round of URLZone spam\ntargeting Japan. The basic TTPs are unchanged, but the scale is larger than the spam\ncampaign we observed in December 2015.\n\n## Conclusion\n\nAlthough URLZone has been around for a while and primarily targets countries in Europe,\nwe still see it active and now shifting to Japan. It is likely that URLZone will further expand its\nactivity in Japan with improved localization and techniques. Email users should be cautious\nabout viewing emails coming from unknown senders.\n\n## Appendix\n\n\n-----\n\nURLZone sample hashes\n\n-   15896a44319d18f8486561b078146c30a0ce1cd7e6038f6d614324a39dfc6c28\n\n-   884fccbbfa5a5b96d2e308856b996ee20d9656d04505fb3cdf926270f5d11c28\n\nHooked APIs\n\n-   WinInet.HttpEndRequestA\n\n-   WinInet.HttpEndRequestW\n\n-   WinInet.HttpOpenRequestA\n\n-   WinInet.HttpOpenRequestW\n\n-   WinInet.HttpQueryInfoA\n\n-   WinInet.HttpQueryInfoW\n\n-   WinInet.HttpSendRequestA\n\n-   WinInet.HttpSendRequestExW\n\n-   WinInet.HttpSendRequestW\n\n-   WinInet.InternetCloseHandle\n\n-   WinInet.InternetQueryDataAvailable\n\n-   WinInet.InternetReadFile\n\n-   WinInet.InternetReadFileExA\n\n-   WinInet.InternetReadFileExW\n\n-   WinInet.InternetWriteFile\n\n-   nspr.PR_Read\n\n-   nspr.PR_Write\n\n-   nspr.PR_Close\n\n-   ws2_32.send\n\n-   ws2_32.connect\n\n-   ws2_32.closesocket\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-01-26 - URLZone Zones in on Japan.pdf"
    ],
    "report_names": [
        "2016-01-26 - URLZone Zones in on Japan.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536234,
    "ts_updated_at": 1743041151,
    "ts_creation_date": 1653752744,
    "ts_modification_date": 1653752744,
    "files": {
        "pdf": "https://archive.orkl.eu/3a2c15180c6f83b02ff4615bd259e4068e624779.pdf",
        "text": "https://archive.orkl.eu/3a2c15180c6f83b02ff4615bd259e4068e624779.txt",
        "img": "https://archive.orkl.eu/3a2c15180c6f83b02ff4615bd259e4068e624779.jpg"
    }
}