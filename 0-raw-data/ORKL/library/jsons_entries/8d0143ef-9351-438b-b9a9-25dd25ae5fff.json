{
    "id": "8d0143ef-9351-438b-b9a9-25dd25ae5fff",
    "created_at": "2023-01-12T15:09:16.158337Z",
    "updated_at": "2025-03-27T02:09:29.320995Z",
    "deleted_at": null,
    "sha1_hash": "11249633b3a07692ba9c7f1759cd4cfdabed8c6b",
    "title": "2021-11-19 - Squirrelwaffle Exploits ProxyShell and ProxyLogon to Hijack Email Chains",
    "authors": "",
    "file_creation_date": "2022-05-28T00:32:03Z",
    "file_modification_date": "2022-05-28T00:32:03Z",
    "file_size": 873540,
    "plain_text": "# Squirrelwaffle Exploits ProxyShell and ProxyLogon to Hijack Email Chains\n\n**[trendmicro.com/en_us/research/21/k/Squirrelwaffle-Exploits-ProxyShell-and-ProxyLogon-to-Hijack-Email-Chains.html](https://www.trendmicro.com/en_us/research/21/k/Squirrelwaffle-Exploits-ProxyShell-and-ProxyLogon-to-Hijack-Email-Chains.html)**\n\nNovember 19, 2021\n\nIn September, [Squirrelwaffle emerged as a new loader that is spread through spam](https://blog.talosintelligence.com/2021/10/squirrelwaffle-emerges.html)\ncampaigns. It is known for sending its malicious emails as replies to preexisting email chains,\na tactic that lowers a victim’s guard against malicious activities. To be able to pull this off, we\nbelieve it involved the use of a chain of both ProxyLogon and ProxyShell exploits.\n\nThe Trend Micro Incident Response team looked into several intrusions related to\nSquirrelwaffle, that happened in the Middle East. This led to a deeper investigation into the\ninitial access of these attacks. We wanted to see if the attacks involved the said exploits.\n\nThis comes from the fact that all of the intrusions we observed originated from on-premise\nMicrosoft Exchange Servers that appeared to be vulnerable to ProxyLogon and ProxyShell.\nIn this blog entry, we shed more light into these observed initial access techniques and the\nearly phases of Squirrelwaffle campaigns.\n\n**Microsoft Exchange infection**\n\n[We observed evidence of the exploits on the vulnerabilities CVE-2021-26855,](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26855) CVE-202134473, and [CVE-2021-34523 in the IIS Logs on three of the Exchange servers that were](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34523)\ncompromised in different intrusions. The same CVEs were used in ProxyLogon (CVE-2021\n\n-----\n\n26855) and ProxyShell (CVE-2021-34473 and CVE-2021-34523) intrusions.\n[Microsoft released a patch for ProxyLogon in March; those who have applied the May or](https://msrc-blog.microsoft.com/2021/03/05/microsoft-exchange-server-vulnerabilities-mitigations-march-2021/)\nJuly updates are protected from ProxyShell vulnerabilities.\n\n### CVE-2021-26855: the pre-authentication proxy vulnerability\n\nThis server-side request forgery (SSRF) vulnerability can allow a threat actor access by\nsending a specially crafted web request to an Exchange Server. The web request contains\nan XML payload directed at the Exchange Web Services (EWS) API endpoint.\n\nThe request bypasses authentication using specially crafted cookies and allows an\nunauthenticated threat actor to execute EWS requests encoded in the XML payload then\nultimately perform operations on victims’ mailboxes.\n\nFrom our analysis of the IIS log, we saw that the threat actor uses a [publicly available exploit](https://github.com/Jumbo-WJB/Exchange_SSRF)\nin its attack. This exploit gives a threat actor the ability to get users SID and emails. They can\neven search for and download a target’s emails. Figures 1 to 3 highlights evidence from IIS\nlogs and show the exploit code.\n\nFigure 1. Exploiting CVE-2021-26855, as seen in the IIS logs\nThe logs (Figure 2 to 3) also show that threat actor used the ProxyLogon vulnerability to get\nthis particular user’s SID and emails to use them to send malicious spam.\n\nFigure 2. The function responsible for getting the SID inside the exploit\n\nFigure 3. The user agent used in the attack\n\n### CVE-2021-34473: the pre-auth path confusion\n\n\n-----\n\nThis ProxyShell vulnerability abuses the URL normalization of the explicit Logon URL,\nwherein the logon email is removed from the URL if the suffix is\nautodiscover/autodiscover.json. This grants arbitrary backend URL the same access as the\nExchange machine account (NT AUTHORITY\\SYSTEM).\n\nFigure 4. Exploiting CVE-2021-34473\n\n### CVE-2021-34523: Exchange PowerShell backend elevation-of-privilege\n\nExchange has a PowerShell remoting feature that can be used to read and send emails. It\ncan’t be used by NT AUTHORITY\\SYSTEM as it does not have a mailbox. However, in\ncases where it is accessed directly via the previous vulnerability, the backend/PowerShell\ncan be provided with X-Rps-CAT query string parameter. The backen/PowerShell will be\ndeserialized and used to restore user identity. It can therefore be used to impersonate a local\nadministrator to run PowerShell commands.\n\nWith this, the attackers would be able to hijack legitimate email chains and send their\nmalicious spam as replies to the said chains.\n\nMalicious spam\n\nIn one of the observed intrusions, all the internal users in the affected network received,\nwhere the spam emails have been sent as legitimate replies to existing email threads. All of\nthe observed emails were written in English for this spam campaign in the Middle East. While\nother languages were used in different regions, most were written in English. More notably,\ntrue account names from the victim’s domain were used as sender and recipient, which\nraises the chance that a recipient will click the link and open the malicious Microsoft Excel\nspreadsheets.\n\nFigure 5. The malicious spam received by targets\nIn the same intrusion, we analyzed the email headers for the received malicious emails, the\nmail path was internal (between the three internal exchange servers’ mailboxes), indicating\nthat the emails did not originate from an external sender, open mail relay, or any message\n\n\n-----\n\ntransfer agent (MTA).\n\nFigure 6. Malicious spam via the MTA route\nDelivering the malicious spam using this technique to reach all the internal domain users will\ndecrease the possibility of detecting or stopping the attack, as the mail getaways will not be\nable to filter or quarantine any of these internal emails. The attacker also did not drop or use\ntools for lateral movement after gaining access to the vulnerable Exchange servers, so that\nno suspicious network activities will be detected. Additionally, no malware was executed on\nthe Exchange servers that will trigger any alerts before the malicious email is spread across\nthe environment.\n\n## The malicious Microsoft Excel file\n\nThe attacker exploited the Exchange servers to deliver internal mails. This was all done to\ncatch users off-guard, making them more likely to click the link and open the dropped\nMicrosoft Excel or Word file.\n\nBoth links used in the malicious emails (aayomsolutions[.]co[.]in/etiste/quasnam[]-4966787\nand aparnashealthfoundation[.]aayom.com/quasisuscipit/totamet[-]4966787 ) drop a ZIP file\nin the machine. The ZIP file contains, in this case, a malicious Microsoft Excel sheet that\ndownloads and executes a malicious DLL related to Qbot.\n\nFigure 7. Malicious Microsoft Excel document\nThese sheets contain malicious Excel 4.0 macros that is responsible for downloading and\nexecuting the malicious DLL.\n\n\n-----\n\nFigure 8. Excel 4.0 Macros\nThe spreadsheets download the DLL from hardcoded URLs which are hxxps:\n\n[//]iperdesk.com/JWqj8R2nt/be.html, hxxps:[//]arancal.com/HgLCgCS3m/be.html and hxxps:\n\n[//]grandthum.co.in/9Z6DH5h5g/be.html.\n\nThe DLL is dropped in C:\\Datop\\. Finally, the document executes the DLL using the following\ncommands:\n\nC:\\Windows\\System32\\regsvr32.exe\" C:\\Datop\\good.good\nC:\\Windows\\System32\\regsvr32.exe\" C:\\Datop\\good1.good\nC:\\Windows\\System32\\regsvr32.exe\" C:\\Datop\\good2.good\n\n\n-----\n\nFigure 9. Excel file infection chain\nOnce the DLL executes, it starts to inject the Microsoft process\n(c:\\windows\\system32\\mobsync.exe). Finally, communicating with the command-andcontrol (C&C) server (hxxp:[//]24.229.150.54:995[/]t4).\n\nFigure 10. DLL infection flow\n**Security recommendations**\n\n\n-----\n\nAs mentioned earlier, by exploiting ProxyLogon and ProxyShell attackers were able to\nbypass the usual checks that would have stopped the spread of malicious email. This\nhighlights how users plays an important part in the success or failure of an attack.\nSquirrelwaffle campaigns should make users wary of the different tactics used to mask\nmalicious emails and files. Emails that come from trusted contacts may not be enough of an\nindicator that whatever link or file included in the email is safe.\n\nIt is important to ensure that patches for Microsoft Exchange Server vulnerabilities,\nspecifically ProxyShell and ProxyLogon (CVE-2021-34473, CVE-2021-34523, and CVE[2021-31207) have already been applied. Microsoft reiterated, those who have applied their](https://techcommunity.microsoft.com/t5/exchange-team-blog/proxyshell-vulnerabilities-and-your-exchange-server/ba-p/2684705)\n[patch for ProxyLogon in March are not protected from ProxyShell vulnerabilities, and should](https://msrc-blog.microsoft.com/2021/03/05/microsoft-exchange-server-vulnerabilities-mitigations-march-2021/)\ninstall more recent (May or July) security updates.\n\nHere are other security best practices to consider:\n\nEnable virtual patching modules on all Exchange servers to provide critical level\nprotection for servers that have not yet been patched for these vulnerabilities.\nUse [endpoint detection and response (EDR) solutions in critical servers, as it provides](https://www.trendmicro.com/en_us/business/products/detection-response/edr-endpoint-sensor.html)\nvisibility to machine internals and detect any suspicious behavior running on servers.\nUse endpoint protection design for servers.\nApply sandbox technology on email, network, and web is very imported to detect\nsimilar URLs and samples.\n\n[Users can also opt to protect systems through managed detection and response (MDR),](https://www.trendmicro.com/en_us/business/products/user-protection/sps/endpoint/server-protect.html)\nwhich utilizes advanced artificial intelligence to correlate and prioritize threats, determining if\nthey are part of a larger attack. It can detect threats before they are executed, preventing\nfurther compromise.\n\n[The indicators of comromise (IOCs) can be found here.](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/21/k/squirrelwaffle-exploits-proxyshell-and-proxylogon-vulnerabilities-in-microsoft-exchange-to-hijack-email-chains/IOCs-squirrelwaffle-exploits-proxyshell-and-proxylogon-to-hijack-email-chains.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-19 - Squirrelwaffle Exploits ProxyShell and ProxyLogon to Hijack Email Chains.pdf"
    ],
    "report_names": [
        "2021-11-19 - Squirrelwaffle Exploits ProxyShell and ProxyLogon to Hijack Email Chains.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536156,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1653697923,
    "ts_modification_date": 1653697923,
    "files": {
        "pdf": "https://archive.orkl.eu/11249633b3a07692ba9c7f1759cd4cfdabed8c6b.pdf",
        "text": "https://archive.orkl.eu/11249633b3a07692ba9c7f1759cd4cfdabed8c6b.txt",
        "img": "https://archive.orkl.eu/11249633b3a07692ba9c7f1759cd4cfdabed8c6b.jpg"
    }
}