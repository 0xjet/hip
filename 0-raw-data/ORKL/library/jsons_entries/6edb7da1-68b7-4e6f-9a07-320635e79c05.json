{
    "id": "6edb7da1-68b7-4e6f-9a07-320635e79c05",
    "created_at": "2023-01-12T15:01:05.588673Z",
    "updated_at": "2025-03-27T02:05:44.645596Z",
    "deleted_at": null,
    "sha1_hash": "bf13db0001e76a3b1ee9c405687d2a9999c9e492",
    "title": "2021-01-03 - Babuk Ransomware",
    "authors": "",
    "file_creation_date": "2022-05-27T23:23:42Z",
    "file_modification_date": "2022-05-27T23:23:42Z",
    "file_size": 109582,
    "plain_text": "# Babuk Ransomware\n\n**[chuongdong.com/reverse engineering/2021/01/03/BabukRansomware/](http://chuongdong.com/reverse%20engineering/2021/01/03/BabukRansomware/)**\n\nChuong Dong January 3, 2021\n\n[Reverse Engineering · 03 Jan 2021](http://chuongdong.com/categories/#reverse%20engineering)\n\n## Overview\n\nThis is my report for the new Babuk Ransomware that recently appears at the beginning of 2021.\n\nSince this is the first detection of this malware in the wild, it’s not surprising that Babuk is not obsfuscated\nat all. Overall, it’s a pretty standard ransomware that utilizes some of the new techniques we see such as\nmulti-threading encryption as well as abusing the Windows Restart Manager similar to Conti and REvil.\n\nFor encrypting scheme, Babuk uses its own implementation of SHA256 hashing, ChaCha8 encryption,\nand Elliptic-curve Diffie–Hellman (ECDH) key generation and exchange algorithm to protect its keys and\nencrypt files. Like many ransomware that came before, it also has the ability to spread its encryption\nthrough enumerating the available network resources.\n\nalt text\n\n_Figure 1: RaidForums Babuk leak_\n\n## IOCS\n\nBabuk Ransomware comes in the form of a 32-bit .exe file.\n\n**MD5: e10713a4a5f635767dcd54d609bed977**\n\n**SHA256: 8203c2f00ecd3ae960cb3247a7d7bfb35e55c38939607c85dbdb5c92f0495fa9**\n\n**Sample:**\nhttps://bazaar.abuse.ch/sample/8203c2f00ecd3ae960cb3247a7d7bfb35e55c38939607c85dbdb5c92f0495fa9/\n\nalt text\n\n_Figure 2: VirusTotal result_\n\n## Ransom Note\n\nalt text\n\n_Figure 3: Babuk’s ransom note_\n\nalt text\n\n_Figure 4: Babuk’s Website_\n\n\n-----\n\n(Pretty unprofessional from the Babuk team since they did not remove the chat log between them and a\nvictim)\n\n## Code Analysis\n\n### Command-line Arguments\n\nBabuk can work with or without command line paramters. If no parameter is given, it’s restricted to only\nencrypting the local machines.\n\nalt text\n\n_Figure 5: Argument parsing_\n\nIf a parameter is given, it will process these arguments upon execution and behave accordingly.\n\n**CMD Args** **Functionality**\n\n-lanfirst Same as no parameter given, encrypting locally\n\n-lansecond Encrypting network shares after encrypting locally\n\n-nolan Same as no parameter given, encrypting locally\n\n### Terminating Services\n\nBabuk’s authors hard-coded a list of services to be closed before encryption.\n\nBefore terminating a service, Babuk will calls EnumDependentServicesA to retrieve the name and status\nof each service that depends on that specified service.\n\nIt will then call ControlService with the control code SERVICE_CONTROL_STOP to stop them before\nterminating the main service the same way.\n\nalt text\n\n_Figure 6: Terminating serivces_\n\nHere is the list of services to be closed.\n```\nvss, sql, svc$, memtas, mepocs, sophos, veeam, backup, GxVss, GxBlr, GxFWD, GxCVD, GxCIMgr,\nDefWatch, ccEvtMgr,\nccSetMgr, SavRoam, RTVscan, QBFCService, QBIDPService, Intuit.QuickBooks.FCS, QBCFMonitorService,\nYooBackup,\nYooIT, zhudongfangyu, sophos, stc_raw_agent, VSNAPVSS, VeeamTransportSvc, VeeamDeploymentService,\nVeeamNFSSvc,\nveeam, PDVFSService, BackupExecVSSProvider, BackupExecAgentAccelerator, BackupExecAgentBrowser,\nBackupExecDiveciMediaService, BackupExecJobEngine, BackupExecManagementService,\nBackupExecRPCService,\nAcrSch2Svc, AcronisAgent, CASAD2DWebSvc, CAARCUpdateSvc,\n\n### Terminating Running Processes\n\n```\nThe author also hard-coded a list of processes to be closed.\n\n\n-----\n\nUsing calls to CreateToolhelp32Snapshot, Process32FirstW, and Process32NextW to examine all of\nthe processes running on the system, Babuk can loop through and look for processes needed to be\nclosed. Upon finding any, it will call TerminateProcess to terminate it.\n\nalt text\n\n_Figure 7: Terminating processes_\n\nHere is the list of processes to be closed.\n```\nsql.exe, oracle.exe, ocssd.exe, dbsnmp.exe, synctime.exe, agntsvc.exe, isqlplussvc.exe, \nxfssvccon.exe, mydesktopservice.exe, ocautoupds.exe, encsvc.exe, firefox.exe, tbirdconfig.exe, \nmydesktopqos.exe, ocomm.exe, dbeng50.exe, sqbcoreservice.exe, excel.exe, infopath.exe,\nmsaccess.exe, \nmspub.exe, onenote.exe, outlook.exe, powerpnt.exe, steam.exe, thebat.exe, thunderbird.exe, \nvisio.exe, winword.exe, wordpad.exe, notepad.exe\n\n### Deleting Shadow Copies\n\n```\nBabuk attempts to delete shadow copies before and after encryption.\n\nFirst, it calls Wow64DisableWow64FsRedirection to disables file system redirection before calling\n**ShellExecuteW to execute this command**\n\n```\ncmd.exe /c vssadmin.exe delete shadows /all /quiet\n\n```\n\nAfter deleting the shadow copies, Babuk checks if the system is running under an 64-bit processor. If it is,\nthen Wow64RevertWow64FsRedirection is called to enable file system redirection again.\n\nalt text\n\n_Figure 8: Deleting Shadow Copies_\n\n### Encryption\n\n Key Generation\n\nFirst, Babuk uses RtlGenRandom to generate 4 random buffers. Two of which are used as ChaCha8\nkeys, and the other two are used as ChaCha8 nonces.\n\nalt text\n\n_Figure 9: Randomly generating ChaCha8 keys and nonce_\n\nNext, it will encrypt the second ChaCha8 key using the first key and nonce. After that, the first key is then\nencrypted using the encrypted second key and nonce.\n\nThis encrypted first key is treated as the Elliptic-curve Diffie–Hellman (ECDH) private key for the local\nmachine.\n\nalt text\n\n_Figure 10: Randomly generating ECDH private key_\n\n\n-----\n\nFrom here, Babuk generate a local ECDH public key from the private key using the code from this ECDH\nlibrary.\n\nThen, it generates a shared secret using the local private key and the author’s hard-coded public key.\n\nThis shared secret goes thorugh a SHA256 hashing algorithm to generate 2 ChaCha8 keys, which are\nused to encrypt files later.\n\nIn order to be able to decrypt files, Babuk stores the local public key in the file ecdh_pub_k.bin in the\n**APPDATA folder.**\n\nBecause of ECDH’s mechanism, the ransomware author can generate the shared secret using his own\nprivate key and the victim’s public key to decrypt files. This makes it impossible for the victim to decrypt on\ntheir own unless they can capture the randomly-generated private key in the malware before it finishes\nencryting.\n\nalt text\n\n_Figure 11: Generating ChaCha8 keys from ECDH shared secret_\n\n### Multithreading\n\nFrom a programmer’s point of view, Babuk’s approach to multithreading is pretty mediocre.\n\nFirst, it determines the number of threads to spawn by doubling the number of cores on the victim’s\nmachine and allocates an array to store all of the thread handles.\n\nalt text\n\n_Figure 12: Thread initialization_\n\nThe first problem with this approach has to do with thread’s concurrency in an OS. A huge amount of\nthreads can potentially be created for each process. However, in an ideal situation, it’s better to have one\nthread running per processor to avoid having threads competing with each other for the processor’s time\nand resource during encryption.\n\nHowever, that, by itself, is not that big of a problem if the author implemented a queue-like structure to\nprocess encrypting requests to utilize 100% of the victim processing power. Unfortunately, they decided to\nonly spawn one encrypting thread per existing drive.\n\nalt text\n\n_Figure 13: Launching encrypting threads_\n\nIn the case where the number of drives is less than the number of processors (which is highly likely),\nBabuk won’t spawn as many threads as possible to encrypt.\n\nSince each thread is responsible for an entire drive, this forces it to use the traditional recursive approach\nto traverse through its own folders, which results in a longer encryption time due to the huge workload.\n\nThe workload for each thread varies based on the size of the drive it’s encrypting, so the average\nencrypting time will just be approximately near the time it takes for one thread to encrypt the largest drive.\nThis is inefficient and really defeats the purpose of using multithreading to encrypt drives.\n\n\n-----\n\n### Folder Traversing\n\nAs discussed above, Babuk uses a recursion method to traverse and encrypt files. Using FindFirstFileW\nand FindNextFileW calls, it goes through each directory to look for files and sub-directories.\n\nWhen encountering a directory, it recursively calls the main_encrypt function again. However, Babuk only\ngoes down 16 directory layers deep, so it potentially does not encrypt every single folders in the drive to\nsave time.\n\nWhen encountering a file, it will check if the file name is How To Restore Your Files.txt or if the file\nextension is .__NIST_K571__ to avoid encrypting the ransom note or encrypted files.\n\nalt text\n\n_Figure 14: Traversing through folders_\n\n### Kill File Owner\n\nSimilar to Conti or REvil ransomware, Babuk utilizes the Windows Restart Manager to terminate any\nprocess that is using files. This ensures that nothing prevents it from opening and encrypting the files.\n\nThis is accomplished through the calls RmStartSession, RmRegisterResources, and RmGetList to get\na list of processes that are using the a specified file. If the process is not explorer.exe or a critical\nprocess, then Babuk will call TerminateProcess to kill it.\n\nalt text\n\n_Figure 15: Killing processes that are using files_\n\n### File Encryption\n\nBabuk’s file encryption is divided into 2 different types - small file encryption and large file encryption.\n\nFor small files that are les than 41943040 bytes or roughly 41 MB in size, the file is mapped entirely and\nencrypted with ChaCha8 two times.\n\nalt text\n\n_Figure 16: Small file encryption_\n\nWith large files, encryption is a bit different. To save time, the entire file is divided into three equally-large\nregions.\n\nFor each of these regions, only the first 10485760 bytes or 10 MB will be encrypted.\n\nalt text\n\n_Figure 17: Large file encryption_\n\nFor encryption, Babuk uses the two ChaCha8 keys generated from the ECDH shared secret’s SHA256\nhash as the encrypting keys and the first 12 bytes of the shared secret as nonce.\n\n### Remote File Encryption\n\n\n-----\n\nTo encrypt the remote drives from the victim machine, Babuk calls WNetGetConnectionW to retrieves the\nname of the network resources associated with those drives and pass them to the encrypting thread.\n\nalt text\n\n_Figure 18: Encrypting remote drives_\n\nIt also encrypts network shares on the machine’s LAN given the correct parameter.\n\nBabuk calls WNetOpenEnumW and WNetOpenEnumW to traverse through remote folders on the\nnetwork and encrypts file using the similar recursive method mentioned above.\n\nalt text\n\n_Figure 19: LAN Encryption_\n\n## Key Findings\n\nBabuk is a new ransomware that started at the beginning of this year. Despite the amateur coding\npractices used, its strong encryption scheme that utilizes Elliptic-curve Diffie–Hellman algorithm has\nproven effective in attacking a lot of companies so far.\n\nBecause the malware authors are using one private key for each Babuk sample, it’s clear that their main\ntarget is large corporations instead of normal computer users. So far, according to the website embedded\nin the ransom note as well as the leaks on Raidforums, they have sucessfully compromised 5 different\ncompanies in the world.\n\n## Message to newer victims\n\nI recently notice I’m getting a lot more traffic from Europe on this page, which I’m assuming newer victims\nare viewing this to better their understanding of the ransomware.\n\nThis blog post is really out of date because Babuk has evolved a lot, and the malware is drastically\ndifferent from what I talk about here.\n\nIf recent Babuk victims are interested in getting more information about the newer version of this\nransomware or require any assistance with analyzing any sample, feel free to reach out to me through my\nemail cdong49@gatech or Twitter!\n\n## YARA Rule\n\n\n-----\n\n```\n u e abu a so a e {\n     meta:\n          description = \"YARA rule for Babuk Ransomware\"\n          reference =\n\"http://chuongdong.com/reverse%20engineering/2021/01/03/BabukRansomware/\"\n          author = \"@cPeterr\"\n          date = \"2021-01-03\"\n          rule_version = \"v1\"\n          malware_type = \"ransomware\"\n          tlp = \"white\"\n     strings:\n          $lanstr1 = \"-lanfirst\"\n          $lanstr2 = \"-lansecond\"\n          $lanstr3 = \"-nolan\"\n          $str1 = \"BABUK LOCKER\"\n          $str2 = \".__NIST_K571__\" wide\n          $str3 = \"How To Restore Your Files.txt\" wide\n          $str4 = \"ecdh_pub_k.bin\" wide\n     condition:\n          all of ($str*) and all of ($lanstr*)\n}\n\n## References\n\n```\nhttps://twitter.com/Arkbird_SOLG/status/1345569395725242373\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-03 - Babuk Ransomware.pdf"
    ],
    "report_names": [
        "2021-01-03 - Babuk Ransomware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535665,
    "ts_updated_at": 1743041144,
    "ts_creation_date": 1653693822,
    "ts_modification_date": 1653693822,
    "files": {
        "pdf": "https://archive.orkl.eu/bf13db0001e76a3b1ee9c405687d2a9999c9e492.pdf",
        "text": "https://archive.orkl.eu/bf13db0001e76a3b1ee9c405687d2a9999c9e492.txt",
        "img": "https://archive.orkl.eu/bf13db0001e76a3b1ee9c405687d2a9999c9e492.jpg"
    }
}