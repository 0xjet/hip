{
    "id": "3b459c8a-7c82-4ff2-95ac-42cd6bf35f9e",
    "created_at": "2023-01-12T14:59:29.073939Z",
    "updated_at": "2025-03-27T02:17:11.36342Z",
    "deleted_at": null,
    "sha1_hash": "98f287e2167a0eefa40af151c6b49fef60448025",
    "title": "2017-02-14 - XAgentOSX- Sofacy’s XAgent macOS Tool",
    "authors": "",
    "file_creation_date": "2022-05-28T00:33:59Z",
    "file_modification_date": "2022-05-28T00:33:59Z",
    "file_size": 543675,
    "plain_text": "# XAgentOSX: Sofacy’s XAgent macOS Tool\n\n**[researchcenter.paloaltonetworks.com/2017/02/unit42-xagentosx-sofacys-xagent-macos-tool/](http://researchcenter.paloaltonetworks.com/2017/02/unit42-xagentosx-sofacys-xagent-macos-tool/)**\n\nRobert Falcone February 14, 2017\n\nBy [Robert Falcone](https://unit42.paloaltonetworks.com/author/robertfalcone/)\n\nFebruary 14, 2017 at 3:59 PM\n\n[Category: Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [macOS,](https://unit42.paloaltonetworks.com/tag/macos/) [Sofacy,](https://unit42.paloaltonetworks.com/tag/sofacy/) [XAgent,](https://unit42.paloaltonetworks.com/tag/xagent/) [XAgentOSX](https://unit42.paloaltonetworks.com/tag/xagentosx/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/unit42-xagentosx-sofacys-xagent-macos-tool/)\n\n[During our continued research on Sofacy’s Komplex Trojan, we have found a sample of a](https://blog.paloaltonetworks.com/2016/09/unit42-sofacys-komplex-os-x-trojan/)\nbackdoor Trojan that we believe the Sofacy group uses when targeting individuals running\nmacOS systems. The backdoor Trojan authors have called it XAgentOSX, which shares the\nname XAgent with one of Sofacy’s Windows-based Trojan and references Apple’s previous\nname for macOS, OS X. It appears the same actor developed both the Komplex and\nXAgentOSX tools, based on similarities within the following project paths found within the\ntools:\n\nKomplex: /Users/kazak/Desktop/Project/komplex\n\nXAgent OSX: /Users/kazak/Desktop/Project/XAgentOSX\n\nWe believe it is possible that Sofacy uses Komplex to download and install the XAgentOSX\ntool to use its expanded command set on the compromised system.\n\n\n-----\n\n## XAgent C2 Communications\n\nThe macOS variant of XAgent has ability to receive commands from threat actors via its\ncommand and control channel, but is also capable of logging key strokes via its keylogger\nfunctionality. XAgent uses HTTP requests to communicate with its C2 servers, which allows\nthe threat actor to interact with the compromised system. The Trojan uses HTTP POST\nrequests, as seen in Figure 1 to send data to the C2 server, and GET requests to receive\ncommands from the server, as seen in Figure 2. We are still analyzing this Trojan to\ndetermine the specific structure of the data sent between the Trojan and the C2 server;\nhowever, it does appear that the Trojan is using the RC4 algorithm to encrypt data sent to the\nC2 server within HTTP POST requests.\n\n_Figure 1 XAgent macOS HTTP POST request_\n\n_Figure 2 XAgent mscOS HTTP GET request_\n\nThe C2 URLs generated by XAgentOSX are very similar to those created by its Windowsbased counterpart. When generating the URL for the HTTP requests issued to the C2 server,\nthe Trojan chooses a random folder from the following to include within the URL path:\n\nwatch/?\n\nsearch/?\n\nfind/?\n\nresults/?\n\nopen/?\n\nsearch/?\n\nclose/?\n\nXAgent also will choose several parameters names from the following list when finishing the\nconstruction of the C2 URL:\n\n\n-----\n\nitwm=\ntext=\nfrom=.\nitwm=\nags=\noe=\naq=\nbtnG=\noprnd=\nitwm=\nutm=\nchannel=\n\nThe XAgent OSX Trojan generates a system specific value that it refers to as an \"agent_id\",\nwhich is a unique identifier for each compromised host. The value is derived using the\nIOService to access the IOPlatformUUID property, which is equivalent to the \"Hardware\nUUID\" listed in the system information application, as seen in the Figure 3 screenshot of our\nanalysis system. The Trojan uses the first four bytes of this hardware ID as a unique\nidentifier for the system, which in our case was \"0000\".\n\n_Figure 3 Hardware ID used by XAgent to uniquely identify compromised hosts_\n\nWhen generating the URLs within the HTTP POST and GET requests, XAgent sets one\nHTTP parameter using a specific data structure that contains this agent_id value. This\nparameter transmits the agent_id to the C2 server to obtain commands the actor wishes to\nexecute on the compromised system. The data structure used to transmit the agent_id to the\nC2 is as follows:\n\n\n-----\n\nstruct {\nDWORD random_value_for_key;\nCHAR[7] constant_value;\nDWORD agent_id;\n}\n\nThe constant value in the data structure is a 7 byte string that is hardcoded to\n\"\\x56\\x0E\\x9F\\xF0\\xEB\\x98\\x43\", followed by the agent_id value (\"0000\" in our case). The\nfirst DWORD in the data is a random value that the Trojan will use as an XOR key to encrypt\nthe constant value and the agent_id. For instance, the following 15 bytes were used to\ngenerate an HTTP parameter during our analysis:\n\nRandom Value Constant Value agent_id\n\n0F EE C8 83 56 0E 9F F0 EB 98 43 30 30 30 30\n\nThe resulting ciphertext is then encoded using XAgent's base64 encoding routine that starts\nby building the following encoding alphabet:\n\nABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_\n\nAs you can see, this is not the standard base64 alphabet, rather it is the \"URL and Filename\nsafe\" Base 64 Alphabet from RFC 4648, as the \"+\" in the standard alphabet is replaced with\n\"-\" and the \"/\" replaced with \"_\". It then uses the base64 encoding function with this alphabet\nto encode the data, which in the above case resulted in:\n\nD-7Ig1ngV3PkdouzP974\n\nThe Trojan then creates a string of 9 random symbols and appends the encoded ciphertext\nto this random string. For example, the following string would be included in one of the HTTP\nparameters sent to the C2 server:\n\neRmaVsr90D-7Ig1ngV3PkdouzP974\n\nIn this specific case, the actor made a mistake when configuring this XAgent sample with its\nC2 locations. The sample creates an array that contains the following strings for the Trojan to\nuse as C2 locations:\n\nhttp://23.227.196[.]215/\nhttp://apple-iclods[.]org/\nhttp://apple-checker[.]org/\nhttp://apple-uptoday[.]org/\nhttp://apple-search[.]info\n\n\n-----\n\nNotice the last one is missing the trailing /, which causes an issue when the Trojan\nattempts to use this string to build the remainder of the C2 URL, as the Trojan will append\nthe next string in the URL directly to this string. For instance, when using this string we\nobserved DNS queries for \"apple-search.infoclose\", as the string \"close\" was supposed to be\nthe next portion of the C2 URL.\n\n## Available Commands\n\nThe XAgent C2 server will provide commands for the Trojan to run on the compromised\nsystem within its response to inbound HTTP request. The XAgentOSX Trojan includes\nresponses to commands within HTML tags, which we believe allows the C2 server to format\nlogs for viewing.\n\nIn most cases, the responses sent to the C2 server are included between the \"<font size=4\ncolor=000066><pre>\" and \"</pre></font>\" HTML tags. We analyzed the command handler\nand found that it provided the necessary commands for a fully functional backdoor, as seen\nin Table 1. The command handler obtains a command identifier from the C2 server and adds\n0xFFFFFF9B to this value and then uses a switch statement to determine the appropriate\ncommand to execute. The switch statement checks for 19 cases, between 101 and\n[119. (Updated to correct command IDs, thanks @mykill!)](https://twitter.com/mykill)\n\n\n**Command**\n**ID**\n\n\n**Function** **Description**\n\n\n101 getInfoOSX Gathers username and OSX version and responds\nusing the encrypted form of the following string:\n\"Mac OS X - [OSX version] x64<br>\\nUser name \n[username]\"\n\n102 getProcessList Runs \"ps aux\" to obtain a list of running processes\n\n103 remoteShell Runs supplied command using \"/bin/sh\"\n\n104 getInstalledAPP Gets a list of installed applications by running the\ncommand \"ls -la /Applications\"\n\n105 showBackupIosFolder Checks to see if an IOS device was backed up to\nthe system by running the command \"ls -la\n~/Library/Application\\ Support/MobileSync/Backup/\"\n\n106 downloadFileFromPath Uploads a file from a specified path\n\n107 createFileInSystem Downloads a file, specifically provided within the\nC2 server's HTTP response\n\n108 execFile Executes a specified file on the system using the\nNSTask:launch method\n\n\n-----\n\n109 deletFileFromPath Deletes a specified file using the\nNSFileManager:removeFileAtPath method\n\n110 takeScreenShot Takes a screenshot using the\nCGGetActiveDisplayList, CGDisplayCreateImage,\nNSImage:initWithCGImage methods. Returns the\nscreenshot to the C2 via: <img\nsrc='data:image/jpeg;base64,[base64 of\nscreenshot]' width=800 height=500 /><br>\n\n111 startTakeScreenShot Creates a thread to take a screenshot at a set\ninterval (default: every 10 seconds). Uses the same\nmethod in \"takeScreenShot\" function\n\n112 stopTakeScreenShot Closes the thread created in the\n\"startTakeScreenShot\" function\n\n116 getFirefoxPassword Looks for folders with \"/Firefox/Profiles\" in the path\nand reads the contents of the \"logins.json\" file for\n\"hostname\", \"encryptedUsername\" and\n\"encryptedPassword\" entries. It also attempts to\nissue the following SQL query on the\n\"signons.sqlite\" file: \"SELECT hostname,\nencryptedUsername, encryptedPassword FROM\nmoz_logins WHERE timePasswordChanged/1000\nBETWEEN ? AND ?\"\n\n117 ftpUpload Uses FTPManager:uploadFile method and a\nsupplied server name, username and password.\n\n118 ftpStop Calls \"stopOperation\" method, but does not appear\nto stop FTP uploads.\n\n119 readFiles Obtains file information on a file or a folder, and\nsupports a \"*\" wildcard and recursive file list. The\ncode will gather the information and format the list\nusing the following HTML to create a table:\n<table>\n\n<tr><td>Type</td><td>Owner</td>\n<td>Permissions</td><td>Created</td>\n<td>Modificated</td><td>Size</td><td>Path</td>\n</tr>\n\n<tr><td>[fileType]</td><td>\n\n[fileOwnerAccountName]</td><td>[number\nfilePosixPermissions]</td><td>[fileCreationDate]\n</td><td>[fileModificationDate]</td><td>[fileSize]\n</td><td>[file path?]</td></tr>\n\n...\n\n</table>\n\n\n-----\n\n_Table 1 Commands available within XAgent OSX_\n\nThe ‘showBackupIosFolder’ command is rather interesting, as it allows the threat actors to\ndetermine if a compromised system was used to backup an IOS device, such as an iPhone\nor iPad. We believe this command is used to determine if a mobile device was backed up,\nand we speculate that the actors would use other commands within XAgent to exfiltrate\nthose files.\n\n## Keylogging Functionality\n\nXAgent also has a keylogger functionality that allows the threat actors to steal credentials as\nthe user types them. XAgent logs key strokes by calling the CGEventTapCreate function to\nset an event hook to call a callback function named _myCGEventTapCallBack when it\ndetects pressed keys. This callback function will call a function named\npressedKeyWithKeyCode, which is responsible for logging the keystrokes. The keylogger will\nmonitor for active application windows and write them to the log in the following format:\n\n<span class='keylog_process'>[Application Name]</span>\n\nThe keylogger will log a configurable amount of keystrokes (default 50) before sending the\nlog to the C2 server using the following format:\n\n<span class='keylog_user_keys'>[logged keystrokes]</span>\n\nThe keylogger can handle logging special keys, such as return and the function keys and will\nreport those within the log in the following format;\n\n<span class='keylog_spec_key'>[special character]</span>\n\n## Infrastructure\n\nThe XAgentOSX sample we analyzed was configured to use the following IP address and\ndomain names as its C2 servers:\n\n23.227.196[.]215\n\napple-iclods[.]org\n\napple-checker[.]org\n\napple-uptoday[.]org\n\napple-search[.]info\n\nWhen we analyzed this sample, the domain names that were used as backup C2 locations\nwere not registered; therefore, these domains did not provide any links to additional\ninfrastructure. We were also unable to find any additional infrastructure based on the primary\n[C2 location of 23.227.196[.]215. However, according to CrowdStrike, the nearby IP address](https://www.crowdstrike.com/blog/bears-midst-intrusion-democratic-national-committee/)\n23.227.196[.]217 hosted the C2 location for an XTunnel payload used by the Sofacy group in\n\n\n-----\n\nthe attack on the Democratic National Committee. While these IP addresses do not directly\noverlap, it does appear that the Sofacy group continues to use the same hosting services to\nhost their infrastructure.\n\n## Conclusion\n\nThe Sofacy group continues to bolster their toolset to carry out attack campaigns on multiple\nplatforms. In this case, the threat group uses the same name XAgent for this macOS-based\ntool as one of their Windows-based tools. Also, the macOS variant of this tool uses a similar\nnetwork communications method as its Windows counterpart, which suggests this group\ncontinues to use consolidated C2 services to control compromised hosts, as we saw during\n[our comparison of the Komplex and Seduploader (formerly referred to as Sofacy Carberp)](https://blog.paloaltonetworks.com/2016/09/unit42-sofacys-komplex-os-x-trojan/)\ntools. Also, while we lack attack telemetry, we were able to find a loose connection to the\nattack campaign that Sofacy waged on the Democratic National Committee based on hosting\ndata in both attacks.\n\nPalo Alto Networks customers are protected from XAgentOSX via:\n\nKnown samples are detected as malicious by WildFire\nAll known C2 locations are marked as malicious in PANDB\n[Users can use AutoFocus tag XAgent to track this threat](https://autofocus.paloaltonetworks.com/#/tag/Unit42.XAgent)\n\n## Indicators of Compromise\n\n**SHA256**\n\n2a854997a44f4ba7e307d408ea2d9c1d84dde035c5dab830689aa45c5b5746ea\n\n**Command and Control**\n\n23.227.196[.]215\n\napple-iclods[.]org\n\napple-checker[.]org\n\napple-uptoday[.]org\n\napple-search[.]info\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-02-14 - XAgentOSX- Sofacy’s XAgent macOS Tool.pdf"
    ],
    "report_names": [
        "2017-02-14 - XAgentOSX- Sofacy’s XAgent macOS Tool.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "2864e40a-f233-4618-ac61-b03760a41cbb",
            "created_at": "2023-12-01T02:02:34.272108Z",
            "updated_at": "2025-03-27T02:02:10.209072Z",
            "deleted_at": null,
            "main_name": "WildCard",
            "aliases": [],
            "source_name": "ETDA:WildCard",
            "tools": [
                "RustDown",
                "SysJoker"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "256a6a2d-e8a2-4497-b399-628a7fad4b3e",
            "created_at": "2023-11-30T02:00:07.299845Z",
            "updated_at": "2025-03-27T02:00:03.257794Z",
            "deleted_at": null,
            "main_name": "WildCard",
            "aliases": [],
            "source_name": "MISPGALAXY:WildCard",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d2516b8e-e74f-490d-8a15-43ad6763c7ab",
            "created_at": "2022-10-25T16:07:24.212584Z",
            "updated_at": "2025-03-27T02:02:10.141001Z",
            "deleted_at": null,
            "main_name": "Sofacy",
            "aliases": [
                "APT 28",
                "ATK 5",
                "Blue Athena",
                "BlueDelta",
                "FROZENLAKE",
                "Fancy Bear",
                "Fighting Ursa",
                "Forest Blizzard",
                "Grey-Cloud",
                "Grizzly Steppe",
                "Group 74",
                "GruesomeLarch",
                "ITG05",
                "Iron Twilight",
                "Operation DealersChoice",
                "Operation Dear Joohn",
                "Operation Komplex",
                "Operation Pawn Storm",
                "Operation Russian Doll",
                "Operation Steal-It",
                "Pawn Storm",
                "SIG40",
                "Sednit",
                "Snakemackerel",
                "Sofacy",
                "Strontium",
                "T-APT-12",
                "TA422",
                "TAG-0700",
                "TAG-110",
                "TG-4127",
                "Tsar Team",
                "UAC-0028",
                "UAC-0063"
            ],
            "source_name": "ETDA:Sofacy",
            "tools": [
                "ADVSTORESHELL",
                "AZZY",
                "Backdoor.SofacyX",
                "CHERRYSPY",
                "CORESHELL",
                "Carberp",
                "Computrace",
                "DealersChoice",
                "Delphacy",
                "Downdelph",
                "Downrage",
                "Drovorub",
                "EVILTOSS",
                "Foozer",
                "GAMEFISH",
                "GooseEgg",
                "Graphite",
                "HATVIBE",
                "HIDEDRV",
                "Headlace",
                "Impacket",
                "JHUHUGIT",
                "JKEYSKW",
                "Koadic",
                "Komplex",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LoJack",
                "LoJax",
                "MASEPIE",
                "Mimikatz",
                "NETUI",
                "Nimcy",
                "OCEANMAP",
                "OLDBAIT",
                "PocoDown",
                "PocoDownloader",
                "Popr-d30",
                "ProcDump",
                "PythocyDbg",
                "SMBExec",
                "SOURFACE",
                "SPLM",
                "STEELHOOK",
                "Sasfis",
                "Sedkit",
                "Sednit",
                "Sedreco",
                "Seduploader",
                "Shunnael",
                "SkinnyBoy",
                "Sofacy",
                "SofacyCarberp",
                "SpiderLabs Responder",
                "Trojan.Shunnael",
                "Trojan.Sofacy",
                "USB Stealer",
                "USBStealer",
                "VPNFilter",
                "Win32/USBStealer",
                "WinIDS",
                "Winexe",
                "X-Agent",
                "X-Tunnel",
                "XAPS",
                "XTunnel",
                "Xagent",
                "Zebrocy",
                "Zekapab",
                "carberplike",
                "certutil",
                "certutil.exe",
                "fysbis",
                "webhp"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535569,
    "ts_updated_at": 1743041831,
    "ts_creation_date": 1653698039,
    "ts_modification_date": 1653698039,
    "files": {
        "pdf": "https://archive.orkl.eu/98f287e2167a0eefa40af151c6b49fef60448025.pdf",
        "text": "https://archive.orkl.eu/98f287e2167a0eefa40af151c6b49fef60448025.txt",
        "img": "https://archive.orkl.eu/98f287e2167a0eefa40af151c6b49fef60448025.jpg"
    }
}