{
    "id": "4efdecaa-44e1-4969-921b-6b1e641d82c2",
    "created_at": "2023-01-12T15:07:47.822011Z",
    "updated_at": "2025-03-27T02:10:49.352954Z",
    "deleted_at": null,
    "sha1_hash": "1766d9268539ff4303bd21e3ba051dcc2a9e44e0",
    "title": "2022-05-17 - X-Cart Skimmer with DOM-based Obfuscation",
    "authors": "",
    "file_creation_date": "2022-05-28T19:33:22Z",
    "file_modification_date": "2022-05-28T19:33:22Z",
    "file_size": 3423223,
    "plain_text": "# Sucuri Blog\n\n**[blog.sucuri.net/2022/05/x-cart-skimmer-with-dom-based-obfuscation.html](https://blog.sucuri.net/2022/05/x-cart-skimmer-with-dom-based-obfuscation.html)**\n\nDenis Sinegubko May 17, 2022\n\n[Our lead security analyst Liam Smith recently worked on an infected X-Cart website and](https://twitter.com/liamsmith86)\nfound two interesting credit card stealers there — one skimmer located server-side, the other\nclient-side.\n\n[X-Cart’s e-commerce platform is not nearly as popular as Magento or WooCommerce and as](https://blog.sucuri.net/2022/04/wordpress-overtakes-magento-in-credit-card-skimmers.html)\na result we don’t see as many threat actors targeting it. While we do still regularly find\nskimmers on X-Cart sites, they are usually more customized and don’t look like typical\nMagecart malware.\n\n### Server-Side Credit Card Stealer\n\nThe server-side skimmer found in the compromised environment was very simple.\n\nIn the payment/payment_swoosh_cc.php file, hackers had added a single line of code that\nsaved the base64-encoded POST data with payment details into a file on disk.\n\nTo make it less suspicious, the file had a .jpg extension and was placed in a directory with\nimage files. To retrieve the stolen information, hackers simply needed to download their fake\nJPG file from time to time.\n\nInjected line of code that saves payment details into a fake image file\n\n\n-----\n\n### Client-Side Credit Card Stealer\n\nThe client side skimmer turned out to be much more interesting. The following obfuscated\nscript was found in the skin/common_files/check_cc_number_script.tpl file.\n\nInjected JavaScript skimmer\nThe first steps of deobfuscation were obvious. We applied the decodeURIComponent\nfunction and prettified the resulting JavaScript code.\n\n\n-----\n\nPrettified code after the first steps of deobfuscation\n\n### Anti-Debugging Trap\n\nThe resulting code was still obfuscated and didn’t reveal its functionality. It obviously\ncontained functions to decode itself, so we executed the script to reconstruct its meaningful\nrepresentation. At this step, we encountered the first obstacle. The script returned errors\ntelling us that certain variables were “undefined”.\n\n\n-----\n\nAfter the analysis, we figured out that the deobfuscation algorithm relied on the length of the\ncode of one of the wrapper functions. The use of decodeURIComponent along with the\nprettification of the code to improve readability had significantly changed the length of that\nfunction and broke the deobfuscation algorithm.\n\nWe regularly come across this “anti-debugging” approach in malware. It can normally be\ncircumnavigated by copying the original script and feeding its content to the function that\ncalculates its length. In this case, because of the additional layer of obfuscation, we used a\ndifferent approach. We wrote a brute force script that tried all possible numbers unless it\nfound the one that produced meaningful deobfuscation results.\n\n### Credit Card Stealer Functionality\n\nAfter we had successfully deobfuscated the script, all we needed to do was replace the\nencrypted values with their plain text versions and rename variables and function names to\nsee how exactly the malicious code worked.\n\nAs we anticipated, the script contained typical skimmer functionality. It looked for the input\nand select form elements and sent their values to a third-party server as lightly encoded\n(encodeURIComponent) GET parameters of an injected script. To make sure that only valid\npayment details are sent to the attacker, the malware checks the values to verify that at\nleast one of the “input” elements contains a valid credit card number using a publicly\navailable validation algorithm.\n\n### DOM-based Obfuscation of the Exfiltration Domain\n\nAt this stage, the only unknown left was the domain name of the exfiltration script that\nskimmer tried to inject.\n\nAfter our deobfuscation efforts, the relevant part of the code looked like this:\n\n\n-----\n\nCode that injects the exfiltration script\nAs you can see, the URL can only be determined when you actually run the code on the\ninfected page. The static analysis only reveals that the domain name begins with “meta” and\n[ends with “.com”. The rest depends entirely on the DOM (Document Object Model) structure](https://en.wikipedia.org/wiki/Document_Object_Model)\nof the page where the script is injected — namely, on the first two HTML tags on that page.\n\nIn our case, the infected site had pretty standard beginning for the HTML code:\n\nHTML code of the infected page\nNot surprising, the first two tags were html and head. To verify that we correctly identified\nthe tags, we injected the URL generating piece of code into the browser’s console:\n\n\n-----\n\nEvaluating exfiltration URL in the Web Developer Tools console\nThis simple trick confirmed our assumption and revealed the URL of the injected script:\n**hxxps ://metahtmlhead[.]com/folder/ip/zxc.php (Full disclosure: we already had this URL**\nafter the initial analysis of the traffic generated by the infected website).\n\n### Magento Credit Card Stealer\n\n[When this investigation was over, our researcher Ben Martin found a seemingly unrelated](https://twitter.com/_jamsec)\nskimmer in a database of a Magento 1.x site.\n\nJavaScript skimmer found on a Magento 1.x site\n\n\n-----\n\nHowever, after removing the first layer of obfuscation, we found the very familiar structure\nwith  ”split,toString,join,length,charCodeAt,fromCharCode” and a decoding function that\nrelies on the length of the initially encoded function.\n\nUsing the same brute force approach, we decoded it and found a similar skimmer code.\nHowever, this time the domain name obfuscation didn’t include any parts derived from the\nHTML DOM. The discovered exfiltration URL was: winsiott[.]com/folder/ip/stt.php . The\nURL structure domain/folder/ip/xxx.php fully matched the one found in the X-Cart skimmer.\n\n[PublicWWW shows a few more sites infected with variations of this skimmer (all with the](https://publicwww.com/websites/%22function%28s%2Cm%2Ce%29%7Bm%3Datob%28m%29.split%22/)\n**[winsiott[.]com/folder/ip/stt.php exfiltration URL). Sucuri SiteCheck detects them as](https://sitecheck.sucuri.net/)**\n“malware.magento_shoplift?199”.\n\nMalware.magento_shoplift?199 skimmer detected by SiteCheck\n\n### Malicious Domains\n\n\n-----\n\nThe metahtmlhead[.]com domain was registered over three months ago on February 7,\n**2022 using Registrar.eu (not a typical registrar for skimmers). It is hosted on a server with**\nthe IP address 162.241.222 .226 (UNIFIEDLAYER-AS-1, US), which has a history of being\nused by phishers.\n\nThe winsiott[.]com domain was registered on June 7, 2021. It is hosted on a server with the\nIP 83.242.96 .149 (AHOST-AS, RU).\n\n## Conclusion & Mitigation Steps\n\nEvery e-commerce site is a potential target for bad actors trying to steal payment details,\nregardless of whether they’re using an ultra-popular CMS or a custom built solution. Less\npopular platforms usually attract more targeted attacks where hackers may employ more\ncreative attack vectors and injected malware.\n\nWebsites that allow credit card transactions should take security very seriously — PCI\ncompliance is mandatory for anyone who operates an e-commerce website, and the\nimplication of a compromise affects not only the personal information and security of the\nsite’s users but also the website’s ability to accept credit card payments. Site owners may\neven incur fines or penalties from regulators if customers complain about fraudulent\ntransactions.\n\nOne of the most important things you can do to protect your website against credit card\n[stealing malware is to follow the requirements outlined in the PCI-DSS. If you’re looking for a](https://www.pcisecuritystandards.org/document_library?category=pcidss&document=pci_dss)\n[simple solution to meet the first requirement for PCI compliance, you can employ a Web](https://blog.sucuri.net/2016/05/pci-build-maintain-secure-network.html)\n[Application Firewall (WAF) like the Sucuri Firewall.](https://sucuri.net/website-firewall/free-trial/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-17 - X-Cart Skimmer with DOM-based Obfuscation.pdf"
    ],
    "report_names": [
        "2022-05-17 - X-Cart Skimmer with DOM-based Obfuscation.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "5a0483f5-09b3-4673-bb5a-56d41eaf91ed",
            "created_at": "2023-01-06T13:46:38.814104Z",
            "updated_at": "2025-03-27T02:00:02.925972Z",
            "deleted_at": null,
            "main_name": "MageCart",
            "aliases": [],
            "source_name": "MISPGALAXY:MageCart",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536067,
    "ts_updated_at": 1743041449,
    "ts_creation_date": 1653766402,
    "ts_modification_date": 1653766402,
    "files": {
        "pdf": "https://archive.orkl.eu/1766d9268539ff4303bd21e3ba051dcc2a9e44e0.pdf",
        "text": "https://archive.orkl.eu/1766d9268539ff4303bd21e3ba051dcc2a9e44e0.txt",
        "img": "https://archive.orkl.eu/1766d9268539ff4303bd21e3ba051dcc2a9e44e0.jpg"
    }
}