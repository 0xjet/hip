{
    "id": "61b0e77c-b587-492c-99e9-7ee145ebd9da",
    "created_at": "2023-01-12T15:01:03.265708Z",
    "updated_at": "2025-03-27T02:05:22.828426Z",
    "deleted_at": null,
    "sha1_hash": "a84ea1d8bb947fe9226b74ad66b071154c0dbd2f",
    "title": "2022-09-30 - Technical Analysis of MedusaLocker Ransomware",
    "authors": "",
    "file_creation_date": "2022-11-28T18:54:16Z",
    "file_modification_date": "2022-11-28T18:54:16Z",
    "file_size": 3321941,
    "plain_text": "# Technical Analysis of MedusaLocker Ransomware\n\n**cloudsek.com/technical-analysis-of-medusalocker-ransomware/**\n\nAnandeshwar Unnikrishnan September 30, 2022\n\nAuthor: Anandeshwar Unnikrishnan\n\nEditor: Bablu Kumar\n\nResearch indicates that while ransomware breach costs have declined slightly from USD 4.62 million to USD\n4.54 million in 2021, ransomware is still responsible for 11% of breaches. The most targeted sectors (about\n57%) are government, technology, healthcare, and academic institutions.\n\n\n-----\n\n**MedusaLocker is a ransomware family that appeared in September 2019 and was employed rapidly for**\nattacks on companies from all over the world. It was particularly aimed at hospitals and other organizations\nin the healthcare industry.\n\nThis technical report is inspired by the CISA Cybersecurity Advisory and provides an in-depth analysis of the\nmalware and its privilege escalation, anti-detection, network scanning, encryption techniques, etc.\n\n## Modus Operandi\n\nMedusaLocker predominantly relies on vulnerabilities in Remote Desktop Protocol (RDP) to access\nvictims’ networks.\nThe victim’s data is encrypted and a ransom note with communication instructions is placed in every\nfolder containing an encrypted file.\nVictims are provided with a specific Bitcoin wallet address for ransom.\nMedusa possibly operates as a Ransomware-as-a-Service (RaaS) model.\n\n## Technical Summary\n\nThe ransomware performs UAC bypass (privilege escalation) to run the malware with administrative\nrights.\nThe user data is locked using AES and the AES key is protected with RSA encryption.\nA scheduled task is created to run the locker every 15 minutes.\nThe ransomware enumerates and terminates specific processes running on the target system. Some\nservices are deleted to ensure smooth execution.\nA network reconnaissance can also be conducted via a ping scan to identify connected assets.\nThe ransomware can lock files both on local and connected systems.\n\n[Also read the detailed report on Increased Cyber Attacks on the Global Healthcare Sector](https://cloudsek.com/whitepapers_reports/increased-cyber-attacks-on-the-global-healthcare-sector/)\n\n## Technical Analysis\n\n### Stage I – Pre-Encryption Operations\n\nThe MedusaLocker initiates its execution by retrieving the locale information of the victim such as the region\nand language set by the user.\n\n**Mutex Creation**\n\nA mutex is created to ensure that multiple instances of malware are not running on the compromised\nsystem.\n\nProcess of\n\nmutex creation\nAfter the mutex check, the malware proceeds to check its privilege escalation by obtaining a process token\nof the malware and checking if the token is elevated via the “TokenElevation Class” passed to\n**advapi32.GetTokenInformation API. This way the malware can confirm if it is running with elevated**\nprivileges of an administrator shell.\n\n\n-----\n\n**Privilege Escalation**\n\nPreparing for privilege escalation\nIf the malware is not running with elevated privileges, it performs a UAC elevation bypass via the\n**CMSTPLUA COM interface. UAC (User Account Control) bypass mechanism is an overused and very**\ncommon vector seen in ransomware to gain access to the resources with high integrity level, thus obtaining\nadministrative privileges on the target system.\n\n[Also Read What Is Redeemer Ransomware and How Does It Spread: A Technical Analysis](https://cloudsek.com/what-is-redeemer-ransomware-and-how-does-it-spread-a-technical-analysis/)\n\nAfter elevating the process, the malware proceeds to disable two features, EnableLUA and\n**ConsentPromptBehaviorAdmin, responsible for notifying the user of any suspicious activity on the system**\nvia registry.\n\n\n-----\n\nDisabling the two features via registry\n**A new registry key “MDSLK” is created by the malware on the victim system. This is one of the clear**\n**indicators of MedusaLocker.**\n\nCreation\n\nof new registry key “MDSLK”\n\n### Cryptographic Initialization\n\nThe MedusaLocker uses AES and RSA in its locking operation. The Advanced Encryption Standard (AES)\nis a symmetric block cipher implemented to encrypt sensitive data. RSA is a public key cryptosystem used\nfor secure data transmission.\n\nThe user data is encrypted using AES and the AES key is protected by RSA encryption.\n\n_Initialization of cryptographic context for RSA by the malware_\n\n\n-----\n\n_Initialization of cryptographic context for AES by the malware_\n\n### Persistence\n\nMedusaLocker proceeds to copy the malware file to %APPDATA% of the user as svhost.exe. The AppData\nfolder contains custom settings and other information that system applications need for their operation. It is a\nhidden folder that includes application settings, files, and data unique to different applications, along with all\nthe data specific to the system user profile.\n\nThen, by abusing the COM TaskScheduler **class 0f87369f-a4e5-4cfc-bd3e-73e6154572dd, a scheduled**\njob is created on the target system that executes the malware, in every 15 minutes.\n\nCopying malware to the APPDATA folder and creating a scheduled job\nThe rclsid value helps in identifying the specific class targeted by the malware to achieve an objective. In\nthis case, the ID value 0f87369f-a4e5-4cfc-bd3e-73e6154572dd confirms that the malware is accessing the\ntask scheduler class implemented by C:\\Windows\\System32\\taskschd.dll.\n\nMalware targeting\n\nthe task scheduler class\n\n**Device and Volume Enumeration**\n\nA volume or logical drive is a single accessible storage area with a single file system, usually resident on a\nsingle partition of a hard disk. Before the encryption process, the MedusaLocker enumerates (enumeration\nexposes potential security flaws) the local volumes and attached shares on the target system. On further\ninvestigating the code, the following APIs were found to be used to perform the enumeration:\n\nGetLogicalDrives\nWNetGetConnectionW\nFindFirstVolumeW\nQueryDosDeviceW\nFindNextVolumeW\n\n\n-----\n\nThe malware targets the SystemReserved partition by mounting it via SetVolumeMountPointW. During the\nlocking phase, the data of the reserved partition gets encrypted to prevent data recovery.\n\nMalware targeting the SystemReserved partition\n\nAlso read [Technical Analysis of Code-Signed “Blister” Malware Campaign (Part 1)](https://cloudsek.com/technical-analysis-of-code-signed-blister-malware-campaign-part-1/)\n\n**Service and Process Termination**\n\nAfter volume enumeration and mounting the reserved partition, the MedusaLocker terminates a list of\nprocesses and deletes system services. The table below contains a list of services targeted by Medusa.\n\n**Services to be**\n**Terminated**\n\n**wrapper** **DefWatch** **ccEvtMgr** **ccSetMgr** **SavRoam**\n\n**sqlservr** **sqlagent** **sqladhlp** **Culserver** **RTVscan**\n\n**sqlbrowser** **SQLADHLP** **QBIDPService** **Intuit.QuickBooks.FCS** **QBCFMonitorService**\n\n**sqlwriter** **msmdsrv** **SQLADHLP** **tomcat6** **zhudongfangyu**\n\n\n**vmware-**\n**usbarbitator64**\n\n\n**vmware-**\n**converter** **dbsrv12** **dbeng8**\n\n\nThe malware opens each service in the list via the OpenServiceW API and monitors its state via\n**QueryServiceStatusEx. If the state of the service is SERVICE_STOP_PENDING then the malware sleeps**\ntill a new state change happens.\n\n\n-----\n\nLocker waits for a state change\nOnce a change in state occurs, Medusa retrieves and stops services (depending on the target service) by\nsending a SERVICE_CONTROL_STOP control signal.\n\nSending a SERVICE_CONTROL_STOP control signal\nAfter stopping the service, the malware deletes this service as well.\n\n\n-----\n\nLocker deletes services after stopping it\n\nThe locker retrieves a pointer to the structure that holds active processes on the system and walks through\nthe list via CreateToolhelp32Snapshot, Process32FirstW, and Process32NextW APIs. If a match is\nfound, the process is terminated via the TerminateProcess API.\n\nCode for terminating processes\n\nThe table below contains the list of running processes targeted by Medusa.\n\n**Running**\n**Processes**\n**Being**\n**Targeted**\n\n**wxServer.exe** **wxServerView** **sqlservr.exe** **sqlmangr.exe** **RAgui.exe**\n\n**supervise.exe** **Culture.exe** **RTVscan.exe** **Defwatch.exe** **sqlbrowser.exe**\n\n**winword.exe** **QBW32.exe** **QBDBMgr.exe** **qbupdate.exe** **QBCFMonitorService.exe**\n\n**axlbridge.exe** **QBIDPService.exe** **httpd.exe** **fdlauncher.exe** **MsDtSrvr.exe**\n\n\n-----\n\n**tomcat6.exe** **java.exe** **360se.exe** **360doctor.exe** **wdswfsafe.exe**\n\n**fdlauncher.exe** **fdhost.exe** **GDscan.exe** **ZhuDongFangYu.exe**\n\n**Recovery and Backup Removal**\n\nOnce all the processes and services have been enumerated, the malware proceeds to remove the backups\nand neutralizes the recovery mechanisms before encrypting data.\n\nPreparing for backups\n\nremoval and neutralizing recovery mechanisms\nTo execute the above string commands, a new process is created and the string is passed as a parameter.\n\nCreation of\n\na new process to execute the commands\nThe malware then proceeds to empty the recycle bin.\n\nMalware clearing the recycle bin\n\n### Network Scan\n\nThe MedusaLocker enables the EnableLinkedConnections feature in the registry to make the remote\nshares accessible from the elevated administrative process session. This feature plays an important role in a\nnetworked environment, especially when the user wants to access a network resource from an elevated\nprocess.\n\n\n-----\n\nLocker preparing to\n\nmake the remote shares accessible\nThe ransomware is capable of crafting ICMP packets and sending them across the network to scan for\nconnected instances and to enumerate attached shares.\n\nCode for implementing the ICMP scan to enumerate the connected hosts in the network.\n\nAlso read [Technical Analysis of Code-Signed “Blister” Malware Campaign (Part 2)](https://cloudsek.com/technical-analysis-of-code-signed-blister-malware-campaign-part-2/)\n\n\n-----\n\nAfter performing the scan, the MedusaLocker uses NetShareEnum API to gather information about the\nresources shared by the remote server in the network. This shows the malware’s capability to infect\n**resources connected to the compromised network.**\n\nCode for\n\ninfecting resources connected to the compromised network\n\n### Stage II – Encryption and Locking\n\nThe locker has separate control flows for locking user data on a local system and network-connected hosts.\nThe encryption routine (sub_5258E0) used in both cases is the same.\n\n\n-----\n\nMalware’s control flow for encryption and locking\nThe encryption routine is implemented as follows:\n\nThe ransomware creates a new file to save the encrypted data via CreateFileW API.\nThe sub_535840 performs the encryption and writes data into the newly created file.\nThe MoveFileExW API is used to rename the file and add “.marlock11” extension.\n\n\n-----\n\nCode\n\n\nfor the implementation of the encryption routine\n\n## Indicators of Compromise (IoCs)\n\n**Executable Hashes**\n\n**634d84758d8d922bbfb0ad3c904c38fc7989f11503877acf02ad5dad3775df7a**\n\n**c41926a4e667a38bd712cd8fff2c555c51d7f719a949c9be8c1f74232100444b**\n\n**98c9e56cba271bf7b32fc17d7966d067d9b549594f8dc60c941f93346e376c00**\n\n**8939141fb565c044895627bbeb522d840d24899dec53545e4a925012dbf83230**\n\n**ec2ec1c316045d5e2e43cc0f1df738e6367b520310a4b7a644717d3aebda43f4**\n\n**6c51f28a6ab35c91e789a4b1a05032c87a3f03006019ba4997dc092ad1c8a625**\n\n**cb12325d13acb03ad4f9977f426baf8b4688af04d4ffe23aa5f1bbd747a147c0**\n\n**fbe10da8d483a0db6686b1f03f18b00dbc60c69fb9a9f4a941764c2c3426367c**\n\n**f1c361bb3b649918bc5b3ad3fc5cbd1bbd7c585fbe2557410e267d161d3bb998**\n\n**465ab4311a7db9f0bc10921cf6a0da7a746c4023dd78fdcec1c253eee69e5b9d**\n\n**b15840fb0547fc774f371166adb89cd7a58647d4e379256a2f9806dd5a338627**\n\n**99a72b56725196298391f3d52b8536b018aa8b60d97c443161e912430079ed30**\n\n**19e31469f150f69bda363c8a3454113236620aa44155dbe845e7689522724b0b**\n\n\n-----\n\n**c79c6b680a2caa71b3ad052f60ce6da463eb576b8196bb3bbdccd003853769d4**\n\n**58a0db1ae0d7d8c5cb5db5e5a24fd1088b8029a4e51c02e7b77d400c17bcb39a**\n\n**66a13e8102f809e23e0ad0ba88ced5eecfa319797c9f709d090994a7143d858a**\n\n**a3fe92224060ec183a25296999c18d4f86149649f1a701ac91b04d73e8678495**\n\n**dbac4f2fffcb4e09aad772895647e8f161b1ac713592fe47c5e8207c85722f13**\n\nAuthor Details\n\n[Anandeshwar Unnikrishnan](https://cloudsek.com/author/anadeshwar-unnikrishnan/)\nThreat Intelligence Researcher, [CloudSEK](https://cloudsek.com/)\nAnandeshwar is a Threat Intelligence Researcher at CloudSEK. He is a strong advocate of offensive\ncybersecurity. He is fuelled by his passion for cyber threats in a global context. He dedicates much of his\ntime on Try Hack Me/ Hack The Box/ Offensive Security Playground. He believes that “a strong mind starts\nwith a strong body.” When he is not gymming, he finds time to nurture his passion for teaching. He also likes\nto travel and experience new cultures.\n\n[Bablu Kumar](https://cloudsek.com/author/bablu-kumar/)\nTotal Posts: 0\nBablu is a technology writer and an analyst with a strong focus on all things cybersecurity. At CloudSEK, he\nworks with the global threat intelligence team for deep research, analysis, and technical content\ndevelopment.\nExploring OSINT and web app security is his favourite pastime.\n\n×\n\n\n-----\n\n[Anandeshwar Unnikrishnan](https://cloudsek.com/author/anadeshwar-unnikrishnan/)\nThreat Intelligence Researcher, [CloudSEK](https://cloudsek.com/)\nAnandeshwar is a Threat Intelligence Researcher at CloudSEK. He is a strong advocate of offensive\ncybersecurity. He is fuelled by his passion for cyber threats in a global context. He dedicates much of his\ntime on Try Hack Me/ Hack The Box/ Offensive Security Playground. He believes that “a strong mind starts\nwith a strong body.” When he is not gymming, he finds time to nurture his passion for teaching. He also likes\nto travel and experience new cultures.\n\nLatest Posts\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-09-30 - Technical Analysis of MedusaLocker Ransomware.pdf"
    ],
    "report_names": [
        "2022-09-30 - Technical Analysis of MedusaLocker Ransomware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535663,
    "ts_updated_at": 1743041122,
    "ts_creation_date": 1669661656,
    "ts_modification_date": 1669661656,
    "files": {
        "pdf": "https://archive.orkl.eu/a84ea1d8bb947fe9226b74ad66b071154c0dbd2f.pdf",
        "text": "https://archive.orkl.eu/a84ea1d8bb947fe9226b74ad66b071154c0dbd2f.txt",
        "img": "https://archive.orkl.eu/a84ea1d8bb947fe9226b74ad66b071154c0dbd2f.jpg"
    }
}