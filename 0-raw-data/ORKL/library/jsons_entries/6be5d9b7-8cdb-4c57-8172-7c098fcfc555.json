{
    "id": "6be5d9b7-8cdb-4c57-8172-7c098fcfc555",
    "created_at": "2023-01-12T15:01:43.445537Z",
    "updated_at": "2025-03-27T02:06:11.865811Z",
    "deleted_at": null,
    "sha1_hash": "8d1725cdfd655c32f8c0fc5c7d2bbad9e2885242",
    "title": "2022-04-02 - Emotet Analysis Part 1- Unpacking",
    "authors": "",
    "file_creation_date": "2022-05-28T17:40:01Z",
    "file_modification_date": "2022-05-28T17:40:01Z",
    "file_size": 664609,
    "plain_text": "# Emotet Analysis Part 1: Unpacking\n\n**pl-v.github.io/plv/posts/Emotet-unpacking/**\n\nPlayer-V April 2, 2022\n\nPlayer-V on Apr 22022-04-02T15:26:00+08:00\n\nUpdated Apr 102022-04-10T22:41:15+08:00 3 min read\n\n## Introduction\n\n[That’s will be my first post in the blog, i will make a series of posts about Emotet.](https://www.malwarebytes.com/emotet)\n\n[Emotet is a Trojan that is primarily spread through spam emails (malspam), we’re going to](https://www.malwarebytes.com/emotet)\ndigg deep in the anlysis of this Trojan, the first part is about unpacking the malware then we\nwill try to analyse the different modules and techniques used by the malware to compromise\na machine, so fire up your virtual machine and let’s start.\n\n## Triage\n\nThe first thing i always do before opening a sample in `IDA or` `Xdbg is opening the binary`\nfirst in a hex editor, in my case i will use [CFF Explorer, so opening the sample in CFF](https://ntcore.com/?page_id=388)\nexplorer shows that we’re dealing with 32 bit binary.\n\n\n-----\n\nLet’s check import section, the malware use only one library which is `Kernel32 that’s the`\nfirst sign which indicate that we’re dealing with packed binary.\n\nTwo intersting API functions are used:\n\n[1. VirtualAlloc](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)\n[2. VirtualProtect](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect)\n\nThe [VirtualAlloc function allocate memory while the VirtualProtect function changes the](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)\nprotection on a region of committed pages in the virtual address space, most of time those\ntwo functions are used by malware during the unpacking process. To make sure that our\n[sample is packed Let’s open the binary on Die(Detect-It-Easy).](https://github.com/horsicq/Detect-It-Easy)\n\n\n-----\n\nThe status bar says that it’s 91% packed and `.text section has a high entropy, that’s a`\nstrong indication that the malware is packed and we should unpack it for further analysis.\n\n## IDA\n\nNow that we’re sure that our sample is packed, let’s open it in `IDA and try to find the`\nfunction which is responsible for unpacking.\n\nClick on `Imports to reveal all the functions used by the binary.`\n\nSearch for [VirtualAlloc and double click on it.](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)\n\n\n-----\n\n[VirtualAlloc function is used two times by the same function](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) `sub_1001AFF0, double click`\non `sub_1001AFF0 and scroll down we notice that the first function called after VirtualAlloc`\nis `sub_10022C40, so maybe we’ve found our unpacking function. to make sure let’s open`\nit on `Xdbg and figure out.`\n\n## Unpacking\n\nOpen your `X32dbg and paste and paste your sample to it.`\n\n[Place a breakpoint on VirtualAlloc and hit run.](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)\n```\nXdbg will keep running untill it hit the breakpoint, after click two times on Execute till\nrun .\n\n```\n\n-----\n\nCheck the `EAX register it contain the return adress address of the allocated memory by`\n[VirtualAlloc, right click on that value and click on](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) `Follow in Dump .`\n\n[As we said earlier that the function after VirtualAlloc is responsible for unpacking, step over](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)\nit and keep your eyes on the dump window at the bottom.\n\n\n-----\n\nAfter executing `sub_10022C40 function we can finally see our unpacked malware, dump it`\nand save it somewhere in your machine.\n\n\n-----\n\nRight click on dump windows and `Follow in memory map .`\n\n\n-----\n\nAnother right click on the address of the unpacked binary then `Dump memory to file .`\n\n\n-----\n\nNow that we have our sample unpacked and ready for analysis let’s open it in `X32dbg .`\n\nIt seems that our unpacked binary is missed and it should be fixed.\n\n## Fixing\n\nTo fix the unpacked binary there are several methods to do that, we will use `LordPE to`\nautomate the fixing, so all we should do is to open LordPe and click on options, then\nuncheck `Wipe Relocation and` `Rebuild ImportTable options, finally click on`\n\n\n-----\n\nDrag your unpacked sample to `LordPe and it will be fixed automatically.`\n\nFinally open your fixed binary in `X32dbg and notice that it’s more readble right now.`\n\n\n-----\n\n## Reference\n\n[1. New Emotet 11/2021 - Reverse Engineering VBA Obfuscation + Unpacking](https://www.reverse-engineer.net/view/courses/training/329541-new-emotet-11-2021-reverse-engineering-vba-obfuscation-unpacking-emotet)\n\n[2. How to Unpack Malware with x64dbg](https://www.varonis.com/blog/x64dbg-unpack-malware)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-02 - Emotet Analysis Part 1- Unpacking.pdf"
    ],
    "report_names": [
        "2022-04-02 - Emotet Analysis Part 1- Unpacking.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535703,
    "ts_updated_at": 1743041171,
    "ts_creation_date": 1653759601,
    "ts_modification_date": 1653759601,
    "files": {
        "pdf": "https://archive.orkl.eu/8d1725cdfd655c32f8c0fc5c7d2bbad9e2885242.pdf",
        "text": "https://archive.orkl.eu/8d1725cdfd655c32f8c0fc5c7d2bbad9e2885242.txt",
        "img": "https://archive.orkl.eu/8d1725cdfd655c32f8c0fc5c7d2bbad9e2885242.jpg"
    }
}