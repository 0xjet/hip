{
    "id": "8f74f9fe-8a4e-4ce5-91e5-7c13225c11a4",
    "created_at": "2023-01-12T15:07:19.154827Z",
    "updated_at": "2025-03-27T02:05:30.55509Z",
    "deleted_at": null,
    "sha1_hash": "3d8811e8f84a6e84ae2d34b85e1b68b7886a2b57",
    "title": "2020-01-23 - TrickBot Now Steals Windows Active Directory Credentials",
    "authors": "",
    "file_creation_date": "2022-05-27T01:59:28Z",
    "file_modification_date": "2022-05-27T01:59:28Z",
    "file_size": 543831,
    "plain_text": "# TrickBot Now Steals Windows Active Directory Credentials\n\n**[bleepingcomputer.com/news/security/trickbot-now-steals-windows-active-directory-credentials/](https://www.bleepingcomputer.com/news/security/trickbot-now-steals-windows-active-directory-credentials/)**\n\nLawrence Abrams\n\nBy\n[Lawrence Abrams](https://www.bleepingcomputer.com/author/lawrence-abrams/)\n\nJanuary 23, 2020\n04:07 PM\n1\n\nA new module for the TrickBot trojan has been discovered that targets the Active Directory\ndatabase stored on compromised Windows domain controllers.\n\nTrickBot is typically download and installed on a computer through other malware. This\nmost common [malware that installs TrickBot is Emotet, which is distributed through spam](https://www.bleepingcomputer.com/news/security/emotet-trojan-evolves-since-being-reawakend-here-is-what-we-know/)\nwith malicious Word document attachments.\n\nOnce TrickBot is installed, it will harvest various information from a compromised computer\nand will then attempt to spread laterally throughout a network to gather more data.\n\nTo perform this behavior, TrickBot will download various modules that perform specific\n[behavior such as stealing cookies, browser information, OpenSSH keys, and spreading to](https://www.bleepingcomputer.com/news/security/trickbot-trojan-now-has-a-separate-cookie-stealing-module/)\nother computers.\n\nAs part of the malware's continued evolution, a new TrickBot module called 'ADll' was\n[discovered by security researcher Sandor Nemes that executes a variety of Windows](https://twitter.com/sandornemes/status/1219501420774379520)\ncommands that allows the trojan to steal a Windows Active Directory database.\n\n## Dumping the Active Directory\n\n\n-----\n\nBefore we get to how TrickBot steals an Active Directory database to harvest login\ncredentials, we first need to give a bit of background about a special file called ntds.dit.\n\nWhen a server is promoted as a domain controller, the Active Directory database will be\ncreated and saved to the default C:\\Windows\\NTDS folder on the DC.\n\nInside this folder is a file called ntds.dit, which is a database that contains all Active\nDirectory services information such as users, passwords, groups, computers, etc.\n\nAs this information is sensitive, Windows encrypts the data using a BootKey stored in the\nSystem hive of the Registry. As the ntds.dit is always opened by the domain controller, it\nalso not possible to access it normally using standard file operations.\n\nTo be able to work with the ntds.dit database while it is open, Windows domain controllers\nhave a tool called ntdsutil that allows administrators to perform database maintenance.\n\n**ndtsutil command**\n[Using ntdsutil, administrators can perform the \"ifm\" (Install from Media) command to create](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732530(v%3Dws.11))\na dump of the Active Directory. This command is meant to be used to create installation\nmedia that can quickly set up new Domain controllers without having to wait for the Active\nDirectory to replicate.\n\nIf TrickBot is able to gain administrative access to a domain controller, it will abuse this\ncommand to create a copy of the domain's Active Directory database and steal it.\n\n## TrickBot steals the Active Directory\n\n\n-----\n\nTrickBot s new ADll module takes advantage of the Install from Media command to dump\nthe Active Directory database and various Registry hives to the %Temp% folder. These files\nare then compressed and sent back to the attackers.\n\nIn a conversation with BleepingComputer, Nemes explained that the ADll module will\ngenerate an 8 character ID based on the TrickBot client ID.\n\nThe module will then use this ID as the filename argument for the following executed\ncommands:\n```\nntdsutil \"ac in ntds\" \"ifm\" \"cr fu %TEMP%\\[generated-id]0.dat\" q q\nreg save HKLM\\SAM %TEMP%\\[generated-id]1.dat /y\nreg save HKLM\\SECURITY %TEMP%\\[generated-id]2.dat /y\nreg save HKLM\\SYSTEM %TEMP%\\[generated-id]3.dat /y\n\n```\nWhen executed, the commands will dump the Active Directory database as well as the\nSAM, Security, and SYSTEM hives.\n\nWhen done, Nemes says the module will check if the files exist, compress them, and then\nexfiltrate the files back to the attacker's servers.\n\nNow that the attackers have access to these files, they can decrypt the Active Directory\ndatabase and dump the usernames, password hashes, computer names, groups, and other\ndata.\n\nThis data can then be used to further spread laterally throughout the network and is\nespecially helpful for the actors behind the Ryuk Ransomware, which is typically the final\npayload for TrickBot infections.\n\n## Illustrating how this data helps attackers\n\nTo illustrate how the TrickBot module works and what data it can gather using,\nBleepingComputer set up a small Windows domain.\n\nOnce set up, we execute the first command of \" ntdsutil \"ac in ntds\" \"ifm\" \"cr fu\n```\n%TEMP%\\H00i0Z000.dat\" q q \", which dumps the Active Directory database to the\n\n```\n%TEMP%\\H00i0Z000.dat folder.\n\n\n-----\n\n**Dumping the Active Directory database**\nWe also executed the module's reg commands to save the SAM, Security, and SYSTEM\nhives to files.\n```\nreg save HKLM\\SAM %TEMP%\\H00i0Z001.dat /y\nreg save HKLM\\SECURITY %TEMP%\\H00i0Z002.dat /y\nreg save HKLM\\SYSTEM %TEMP%\\H00i0Z003.dat /y\n\n```\nWhen done, our %Temp% folder contained a folder containing the Active Directory\ndatabase and three dat files that are the saved Registry hives.\n\n**Saved data in %Temp% folder**\nInside the H00i0Z001.dat folder is the dumped ntds.dit database file.\n\n\n-----\n\n**The dumped Active Directory database**\nUsing the [DSInternals PowerShell modules we can easily extract the BootKey decryption](https://github.com/MichaelGrafnetter/DSInternals)\nkey from the System hive using the \" Get-Bootkey -SystemHivePath\n```\n'.\\H00i0Z003.dat '\" command.\n\n```\n**Extracting BootKey from SYSTEM hive**\nFinally, we execute the DSInternals command \" Get-ADDBAccount -All -DBPath\n```\n'C:\\Users\\sanje\\Desktop\\NTDS\\ntds.dit' -Bootkey [key] \" to decrypt the database\n\n```\nand view all of the accounts, including their NTML password hashes, as seen below.\n\n\n-----\n\n**Dumping user password hashes from the ntds.dit file**\nAttackers can then take these hashes and run them through cracking programs to\ndetermine the actual plain-text passwords for these users.\n\nThese account credentials can then be used by the attackers to compromise other devices\non the network.\n\n## Further information\n\nActive Directory exploitation is a serious subject and is important for domain administrators\nto become familiarized with it.\n\n[I recommend the \"Att&ckingActive Directory for fun and profit\" by](https://identityaccessdotmanagement.files.wordpress.com/2020/01/attcking-ad-for-fun-and-profit-1.pdf) [Huy Kha to learn about](https://twitter.com/DebugPrivilege)\ndifferent ways that attackers can access data stored in the Active Directory.\n\n[Head of SentinelLabs Vitali Kremez also has a very informative video on how Trickbot and](https://twitter.com/VK_Intel)\nRyuk exploit Active Directory services for their benefit.\n\n\n-----\n\nWatch Video At:\n\nhttps://youtu.be/u1XvMcwdvgI\n\n### Related Articles:\n\n[New ERMAC 2.0 Android malware steals accounts, wallets from 467 apps](https://www.bleepingcomputer.com/news/security/new-ermac-20-android-malware-steals-accounts-wallets-from-467-apps/)\n\n[Phishing websites now use chatbots to steal your credentials](https://www.bleepingcomputer.com/news/security/phishing-websites-now-use-chatbots-to-steal-your-credentials/)\n\n[Fake crypto sites lure wannabe thieves by spamming login credentials](https://www.bleepingcomputer.com/news/security/fake-crypto-sites-lure-wannabe-thieves-by-spamming-login-credentials/)\n\n[Microsoft fixes new PetitPotam Windows NTLM Relay attack vector](https://www.bleepingcomputer.com/news/security/microsoft-fixes-new-petitpotam-windows-ntlm-relay-attack-vector/)\n\n[Attackers hijack UK NHS email accounts to steal Microsoft logins](https://www.bleepingcomputer.com/news/security/attackers-hijack-uk-nhs-email-accounts-to-steal-microsoft-logins/)\n\n[Active Directory](https://www.bleepingcomputer.com/tag/active-directory/)\n[Credentials](https://www.bleepingcomputer.com/tag/credentials/)\n[Module](https://www.bleepingcomputer.com/tag/module/)\n[TrickBot](https://www.bleepingcomputer.com/tag/trickbot/)\n\n[Lawrence Abrams](https://www.bleepingcomputer.com/author/lawrence-abrams/)\n\nLawrence Abrams is the owner and Editor in Chief of BleepingComputer.com. Lawrence's\narea of expertise includes Windows, malware removal, and computer forensics. Lawrence\nAbrams is a co-author of the Winternals Defragmentation, Recovery, and Administration\nField Guide and the technical editor for Rootkits for Dummies.\n\n[Previous Article](https://www.bleepingcomputer.com/news/security/buchbinder-car-renter-exposes-info-of-over-3-million-customers/)\n[Next Article](https://www.bleepingcomputer.com/news/security/bipartisan-coalition-bill-introduced-to-reform-nsa-surveillance/)\n\n### Comments\n\n\n-----\n\n[simplemann - 2 years ago](https://www.bleepingcomputer.com/forums/u/1080567/simplemann/)\n\nIs Ntdsutil.exe used for any other function than special circumstances by Admins?\nWould a mitigation for this threat be as simple as renaming that file to something else,\nor would that break something?\n\nPost a Comment [Community Rules](https://www.bleepingcomputer.com/posting-guidelines/)\n\nYou need to login in order to post a comment\n\n[Not a member yet? Register Now](https://www.bleepingcomputer.com/forums/index.php?app=core&module=global&section=register)\n\n### You may also like:\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-23 - TrickBot Now Steals Windows Active Directory Credentials.pdf"
    ],
    "report_names": [
        "2020-01-23 - TrickBot Now Steals Windows Active Directory Credentials.pdf"
    ],
    "threat_actors": [
        {
            "id": "4d5f939b-aea9-4a0e-8bff-003079a261ea",
            "created_at": "2023-01-06T13:46:39.04841Z",
            "updated_at": "2025-03-27T02:00:02.985296Z",
            "deleted_at": null,
            "main_name": "APT41",
            "aliases": [
                "G0096",
                "Grayfly",
                "BARIUM",
                "BRONZE ATLAS",
                "BRONZE EXPORT",
                "Red Kelpie",
                "HOODOO",
                "Brass Typhoon",
                "TA415",
                "WICKED SPIDER",
                "WICKED PANDA",
                "G0044",
                "Earth Baku"
            ],
            "source_name": "MISPGALAXY:APT41",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e698860d-57e8-4780-b7c3-41e5a8314ec0",
            "created_at": "2022-10-25T15:50:23.287929Z",
            "updated_at": "2025-03-27T02:00:55.43005Z",
            "deleted_at": null,
            "main_name": "APT41",
            "aliases": [
                "APT41",
                "Wicked Panda",
                "Brass Typhoon",
                "BARIUM"
            ],
            "source_name": "MITRE:APT41",
            "tools": [
                "ASPXSpy",
                "BITSAdmin",
                "PlugX",
                "Impacket",
                "gh0st RAT",
                "netstat",
                "PowerSploit",
                "ZxShell",
                "KEYPLUG",
                "ipconfig",
                "sqlmap",
                "China Chopper",
                "ShadowPad",
                "MESSAGETAP",
                "Mimikatz",
                "certutil",
                "njRAT",
                "Cobalt Strike",
                "pwdump",
                "BLACKCOFFEE",
                "ROCKBOOT",
                "dsquery",
                "Winnti for Linux",
                "DUSTTRAP",
                "Derusbi",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536039,
    "ts_updated_at": 1743041130,
    "ts_creation_date": 1653616768,
    "ts_modification_date": 1653616768,
    "files": {
        "pdf": "https://archive.orkl.eu/3d8811e8f84a6e84ae2d34b85e1b68b7886a2b57.pdf",
        "text": "https://archive.orkl.eu/3d8811e8f84a6e84ae2d34b85e1b68b7886a2b57.txt",
        "img": "https://archive.orkl.eu/3d8811e8f84a6e84ae2d34b85e1b68b7886a2b57.jpg"
    }
}