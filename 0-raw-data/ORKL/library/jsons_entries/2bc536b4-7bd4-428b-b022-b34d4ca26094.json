{
    "id": "2bc536b4-7bd4-428b-b022-b34d4ca26094",
    "created_at": "2023-01-12T15:05:11.349319Z",
    "updated_at": "2025-03-27T02:15:13.839164Z",
    "deleted_at": null,
    "sha1_hash": "9be5bdfde99f83135a1693af82ee74376ef65f3f",
    "title": "2021-07-02 - The Brothers Grim - The reversing tale of GrimAgent malware used by Ryuk",
    "authors": "",
    "file_creation_date": "2022-05-28T17:44:48Z",
    "file_modification_date": "2022-05-28T17:44:48Z",
    "file_size": 6649192,
    "plain_text": "# The Brothers Grim\n\n**blog.group-ib.com/grimagent**\n\n02.07.2021\n\nThe reversing tale of GrimAgent\nmalware used by Ryuk\n\nAlbert Priego\n\nMalware Analyst at Group-IB\n\n\n-----\n\n**Executive summary**\n\nRansomware activity increased drastically over the past couple of years and became the\nface of cybercrime by 2021.\n\nAccording to the [\"Ransomware Uncovered 2020-2021\" report, the number of ransomware](https://www.group-ib.com/resources/threat-research/ransomware-2021.html?utm_source=blog_post&utm_campaign=grimagent&utm_medium=organic)\nattacks increased by more than 150% in 2020. The attacks grew in not only number but also\nscale and sophistication — the average ransom demand increased by more than twofold and\namounted to $170,000 in 2020. The norm is shifting toward the millions: the Colonial Pipeline\nallegedly paid USD 5 million to get its business back. The case propelled the question of\nransomware to the top of the political agenda.\n\nIn the meantime, 2021 continues to prove that no company is immune to the ransomware\nplague. Ransomware operators are not concerned about the industry so long as the victim\ncan pay the ransom. The prospect of quick profits motivates new players to join big game\nhunting. Ransomware operations show no signs of slowing down. The gangs evolve. They\nchange their tactics, defense evasion techniques, and procedures to ensure that their illicit\nbusiness thrives.\n\nGiven that ransomware attacks are conducted by humans, understanding the modus\noperandi and toolset used by attackers is essential for companies that want to avoid costly\ndowntimes. Ultimately, knowing how ransomware gangs operate and being able to thwart\ntheir attacks is more cost-effective than paying ransoms.\n\nOne of the underlying trends of 2021 to keep in mind is the use of commodity malware. The\ninfamous ransomware gang Ryuk, which is responsible for many high-profile cyber heists\n(including the attack on the Baltimore County Public Schools system) followed suit. The most\nrecent addition to their arsenal, which is yet to be explored, is the malware called\n**GrimAgent.**\n\nOur team did the first comprehensive analysis of the GrimAgent backdoor. It is intended\nmainly for reverse engineers, researchers and blue teams so that they can create and\nimplement rules that help monitor this cyber threat closely. Group-IB's Threat Intelligence\n**team has created Yara and Suricata rules as well as mapped GrimAgent's TTPs according**\nto the MITRE ATT&CK® matrix.\nYou are reading a condensed summary of the actual reverse engineering of GrimAgent.\nIf you feel up to reading the full text of the report \"The Brothers Grim: The reversing tale of\nGrimAgent malware used by Ryuk\" click here.\n_Approximate reading time: ∞_\n**Introduction**\n\nGrimAgent is a malware classified as a backdoor and that has been used as a prior stage to\nRyuk ransomware. The ransomware family appeared in 2018 and was mistakenly linked to\n\n\n-----\n\nNorth Korea. Later on, it was [attributed to two threat actors, FIN6 and Wizard Spider.](https://attack.mitre.org/software/S0446/)\n\nGiven the limited knowledge about the links between Ryuk and GrimAgent, we decided to\nresearch GrimAgent samples discovered in the wild and show how GrimAgent is connected\n**to Ryuk. The article analyzes the execution chain, TTPs, and the malware's relevant**\ncharacteristics.\n\n\n-----\n\nThe first known GrimAgent sample (SHA-256:\n_03ec9000b493c716e5aea4876a2fc5360c695b25d6f4cd24f60288c6a1c65ce5) was_\n**[uploaded to VirusTotal on August 9, 2020 at 19:20:54. It is noteworthy that an embedded](https://www.virustotal.com/gui/file/03ec9000b493c716e5aea4876a2fc5360c695b25d6f4cd24f60288c6a1c65ce5/details)**\n**binary into the initial malware was employed and had a timestamp of 2020-07-26, the**\ntimestamp could have been altered but the dates coincide with our hypothesis about the\nnew malware.\n\nFrom a functionality point of view the malware is a backdoor, but it behaves like a bot. We\nanalyzed a completely different custom network protocol where the infected computer would\nregister on the server side and provide a reconnaissance string of the client, after which it\nwould constantly make requests to the C&C server asking which are the next commands to\nbe executed. During our research we performed several tests with the aim to get the next\nstage payload. We infected several testing devices with different settings, but did not\nmanage to obtain any payloads. Based on our findings, it is likely that the actor implemented\ndifferent defense and delivery mechanisms to protect the integrity of its systems and ensure\nthat the operations are flawless — which is not uncommon and we have witnessed this in the\npast. This means that GrimAgent developers potentially implemented threat detection\nsystems capable of detecting sandboxes or bot requests in order to protect themselves from\nthings such as analysis, added filters based on geolocation and blacklists/whitelists. The\nextreme meticulousness shown by the actors behind the malware and their attention to detail\nwhen carrying out attacks is both relevant and remarkable.\n\nAccording to Group-IB's Threat Intelligence & Attribution system, Ryuk operators used\ndifferent commodity malware over time (including Emotet, TrickBot, Bazar, Buer, and\nSilentNight) to deploy ransomware. However, the big blows suffered by Trickbot and Emotet\ncould have prompted Ryuk operators to partner with GrimAgent. A detailed analysis of the\nlatest TTPs used by various ransomware strains is available in the Ransomware Uncovered\n2020/2021 report.\n\n**Connections to Ryuk**\n\nAnalyzing the GrimAgent Command and Control domain revealed an interesting URL. When\nmaking a request on the domain, the Command and Control server returns a content\ndesigned for victims of the Ryuk ransomware, in addition to revealing its location on the TOR\n\n\n-----\n\nnetwork.\n\nCommand and control landing page:\n\nFig. 1: C2 landing page\n\nCommand and control landing page source code:\n```\n< html > < body > < style > p:hover {\n  background: black;\n  color:white \n} < /style><script> = 'IDyIOJ4u'; =\n'http[:]//etnbhivw5fjqytbmvt2o6zle3avqn6rrugfc35kmcmedbbgqbxtknlqd[.]onion';\n</script > < p onclick = 'info()' style = 'font-weight:bold;font-size:127%;\ntop:0;left:0;border: 1px solid black;padding: 7px 29px;width:85px;' > &nbsp;\n&nbsp;\ncontact < /p><p style='position:absolute;bottom:0;right:1%;font-weight:bold;fontsize:171%'>&#98;&#97;&#108;&#97;&#110;&#99;&#101;&#32;&#111;&#102;&#32;&#115;&#104;&#9\n</p > < div style = 'font-size: 551%;fontweight:bold;width:51%;height:51%;overflow:auto;margin:auto;position:absolute;top:36%;l\n > &#82;\n&#121;\n&#117;\n&#107; < /div><script>function info(){alert('INSTRUCTION:\n1. Download tor browser.\n2. Open link through tor browser: ' + + '\n3. Fill the form, your password: '+ +'\nWe will contact you shortly.\nAlways send files for test decryption.');}; </script > < /body></html >\n\n```\n\n-----\n\nFig. 2: Ryuk Cpanel (TOR)\n\nThese findings show that the GrimAgent backdoor is being used as a part of Ryuk's\n**operations. We have not observed any selling or advertising related to GrimAgent on**\nunderground forums, nor any use of the malware in the infection chain of any other malware\nbesides Ryuk. Based on the above facts we believe that this malware is used by the same\nTA that uses Ruyk ransomware and does not use MaaS.\n\n**GrimAgent in a nutshell**\n\n**File Information**\n\n**Functionality**\n\nRetrieve information about the victim:\n\nIP and country code\nDomain\nVendor\nBuild version\nOS\nArch\nUsername\nPrivileges\n\nuser_id (computed to identify infected clients)\n\n\n-----\n\nAES key obtained from C2 to encrypt the communications\nExecute\nExecute shellcode (MZ launcher)\nDownload and execute\nUpdate\n\nExecute DLL (MZ launcher trampoline)\n\n**Encryption/decryption scheme**\n\nTwo decryption keys used to decrypt the strings (decrypted by the same algorithm).\n\n**Four keys are used:**\n\n1. Hardcoded server public RSA key: Used to encrypt the first request to the Command\n\nand Control server and register the infected client on the server side.\n\n2. Generated client RSA public and private keys: Both stored at the config file.\n\na. Public RSA key\ni. Used to compute the user_id in order to track and identify infected users.\nii. Sent to C2 on the first request along with client reconnaissance; used to encrypt\nthe AES key sent by C2.\n\n3. Used to compute the user_id in order to track and identify infected users.\n\nb. Private RSA key: Used to decrypt the AES key received.\n\n4. AES key: Used on command and control further communications (symmetric\n\nencryption).\n\n\n-----\n\nFig. 3: Execution flow diagram\n\n_*Command 6 has been added on new versions of the malware, check \"Dealing with newer_\n_GrimAgent versions\" section._\n\n**In-depth analysis**\n\nThis section details the malware's behavior. It covers the following points:\n\nBypassing anti-analysis mechanisms\n\nMalware execution\n\nNetwork protocol\n\n\n-----\n\n**Bypassing anti-analysis mechanisms**\n\n**Overlapping instruction obfuscation**\n\nOur investigation involved dealing with anti-analysis techniques, which complicated our task\nof analyzing the malware in addition to breaking the IDAPro Hex-Rays display view.\n\nBasically, the execution flow has been altered with the entire code region between the pusha\nand popa instructions, as well as the stack usage. This code region does not perform any\nrelevant actions while executing the binary, so we can NOP all these instructions.\n\nFig. 4: Anti-analysis technique at WinMain\n\nOnce done, we can set WinMain as a function and try to visualize the pseudocode as well as\nthe IDA graph mode.\n\n**String encryption**\n\nWhen executing the WinMain routine, the first step is to decrypt the key that will later be\nused to decrypt the sensitive strings needed to continue its execution. In order to decrypt the\nkey, the malware uses a function which may vary depending on the sample.\n\nThen, decrypt some basic strings to be able to execute their most basic actions and decrypt\nthe second key that will be used on the decryption of all the necessary strings for their\ncomplete and correct execution.\n\n\n-----\n\nIDA Python script\n\nSince, in most cases, it is better to automate than perform a task manually, we use IDA\nPython to ensure it is done quickly.\n\nIDAPro script:\nhttps://github.com/apriegob/GrimAgent/blob/main/IDAPro/IDAPro_string_decryptor.py\n\nThe \"decrypt_strings_func\" and \"decrypt_strings2_func\" values should be changed to the\nmemory location where they are placed. The value of key1 and key2 will be the buffers that\ncontain the keys used by the malware (which are easily obtained through the debugger).\n**Malware execution**\n\nThe execution of GrimAgent from can be divided into the following subsections.\n\nDecrypting strings and calculating indirect calls\npath_mutex_buffer\nMutex\nConfiguration file\nFirst launch of the malware\nHandling commands\nDealing with newer GrimAgent versions\n\n**Decrypting strings and calculating indirect calls**\n\nThis is the first step the malware must take because it needs to decrypt the sensitive and\nrelevant strings as well as calculate the indirect calls in order to continue with its normal\nexecution flow.\n\n_path_mutex_buffer (deprecated)_\n\nOne of the most relevant features of GrimAgent is that it uses the last 64 bytes of the binary\nfor two purposes:\n\n1. Compute mutex name\n2. Check path for store malware configuration\n\nThis means that after decrypting strings and calculating indirect calls, GrimAgent will read\nitself, and more specifically its last 64 bytes. Henceforth we will call this set of bytes\n\"path_mutex_buffer\".\n\n\n-----\n\nFig. 5: GrimAgent sections\n\n**Mutex**\n\nThe function that creates the mutex will iterate over the 64 bytes, checking if the value is\nalphanumeric and, if it is not, the function will try to transform it into an alphanumeric value.\n\nIf the name of the mutex created is not valid, it will create a mutex with the hardcoded name\n\"mymutex\". In case of an error, the execution will terminate.\n\n\n-----\n\nFig. 6: Computing Mutex\n\n**Configuration file**\n\nThe malware will check if it has a specific path hardcoded. The path corresponds to the\nbuffer that it read in its last 64 bytes (\"path_mutex_buffer\").\n\nCustom path syntax (deprecated):\n\nSHA256 [unicode(FilePath)] + SHA256 [unicode(Filename)] → length of SHA256 x 2 =\n64 (0x40) bytes\n\nTo do so, the malware will make recursive calls to check if the SHA256 of the different\n**writable paths and filenames matches with the buffer retrieved.**\n\nIn terms of writing its config, the malware has three possibilities:\n\n\n-----\n\n1. Custom Path → SHA256[unicode(Path)] + SHA256[unicode(FileName)]: The malware\n\nwill start from \"C:\\\" path, and it will call a function recursively (find_custompath) in which\nit will compute the SHA256 of the different directories to see if it matches with the first\n32 bytes of \"path_mutex_buffer\" and, if It does, it will try to find the filename by\nperforming the SHA256 of every filename in the matched directory by checking the\nnext 32 bytes.\n2. Hardcoded path 1 → C:\\Users\\Public\\config; used if unable to get the custom path.\n3. Hardcoded path 2 → C:\\Users\\Public\\reserve.sys\n\na. This path will be used when a custom path is matched with the character ' * ', for\nexample: \"C:\\Users\\*\"\nb. There is a string \"reserve.exe\" that will replace the last 3 characters from \"exe\" to\n\"sys\" during execution time.\n\nWith the config path defined, the malware checks if there is a valid config file:\n\n**If the config file is less than 0x32 bytes in size, it has no valid config. Otherwise,**\nthe config will be considered as valid and continue the execution to an infinite loop that\nwill perform C2 requests asking for new commands to execute.\n\nA valid configuration file will contain three different objects:\n\n1. Generated client public RSA key: to compute user_id and encrypt the AES key that\n\nthe C2 will send.\n2. Generated client private RSA key: to decrypt the AES key sent by C2.\n3. AES encrypted key received from C2: to encrypt/decrypt C2 communications.\n\n**First launch of the malware**\n\nWhen the malware is executed, the first step is to decrypt the strings and create a mutex\nbased on the last 64 bytes (path_mutex_buffer), but there are cases where GrimAgent\nbinaries have been compiled without these last bytes.\n\n_Unable to read its last 64 bytes_\n\nThis execution branch can only occur on malware first execution. If we enter this execution\nbranch, the malware will perform the following actions:\n\nRetrieve the writable path\nCompute the new path_mutex_buffer based writable path and filename\nCopy itself into the writable path\nAppend the new path_mutex_buffer at the end of the new copied binary\n\n\n-----\n\nSet persistence of the copied binary\n\nTask scheduler\nRegistry key\nExecute copied malware\nDelete old sample\n\nExits\n\n_Reconnaissance_\n\nAt this point, the malware will have been able to get its path to store its configuration file\nwhere it will store the keys necessary for its execution and communication with C2 as well as\nfor creating a mutex to avoid conflicts if it is executed several times.\n\nGrimAgent will then perform a system reconnaissance and collect device information.\nIt will collect the following fields:\n\nCountry code (api.myip.com)\nIP (api.myip.com)\nVendor\nDomain\nBuild Version\nOS\nArchitecture\nUsername\nPrivileges (A/U)\n\nA = Admin\n\nU = User\n\nTo retrieve fields such as the internet IP address and country code, which will append into\nthe reconnaissance string, the malware will use public resources. In our case, this means\nperforming a GET request to api.myip.\n\n_RSA key generation and user_id_\n\nGrimAgent calls a function in order to compute a user_identifer (used to identify the\ninfected user) and generates the client RSA public and private keys:\n\n1. Generates the client RSA public and private keys by using CryptGenKey.\n\n\n-----\n\n2. Retrieves the new generated client RSA public key in PEM format (with the\n\nheaders '-----BEGIN PUBLIC KEY-----' and '-----END PUBLIC KEY-----').\n3. Computes the hash for that key, which generates a random id to be included in the\n\nreconnaissance string (used as a user identifier): This user_id would be different for\nevery execution but, to be able to identify the infected user and not generate a random\nkey each time, the new key will be stored and used to compute the user_id when\nneeded.\n4. Retrieves the generated client RSA private key.\n\n5. Stores both public and private keys in the config file.\n\nThe next screenshot shows the finished string obtained by the malware with the value of\nuser_id added at the end.\n\nFig. 7 - Complete victim reconnaissance\n\n_NB: Country code and IP address values are invalid because we executed the malware in a_\n_controlled environment without internet access._\n\nExample of a reconnaissance string:\n\n_vendor=<vendor_id>&country=<country>&ip=<ip>&domain=<domain>&build_version=_\n_<build_version>&systemOS=<OS>&registry=<32/64>&username=<username>&privileges=_\n_<U/A>&id=<user_id>_\n\nNext, the malware sends this information along with the generated client public RSA\n**key to the Command and Control server and waits until the reply contains 'fr' or 'ar' as the**\nfirst characters in the reply. Only if the first characters received are 'fr' will the malware store\n\n\n-----\n\nthe reply as hex values. The reply from C2 will be a symmetric encryption key (AES)\n**that the malware will use from then on in order to interact with the Command and**\n**Control server.**\n\nThe malware will JMP to the 'exist_conf' location and proceed with the execution.\n\n**Handling commands**\n\nWe land in this section once the malware obtains a valid configuration and is about to enter\nan infinite loop where it will make requests for new commands to the Command and Control\nserver. For GrimAgent, the configuration file will be valid if it is ≥ 32 bytes.\n\n_Reading config: the AES Key_\n\nIn this case, the malware will decrypt and import the AES key received from the C2 which will\nbe in the config file. Then, the key will be used in order to encrypt and decrypt subsequent\ncommunications between the infected client and the C2.\n\n_Commands_\n\nGrimAgent will start an infinite loop (while 1) in order to request the next commands to\nexecute to the Command and Control server. The loop is made up of three points:\n\n1. C2 request and decryption\n2. Execute command\n\n3. Sleep [180-190] seconds and start again\n\nCommand table:\n\n_The commands and other malware features have been updated in newer versions of the_\n_malware, explained at Dealing with newer GrimAgent versions section._\n\nOn receiving the C2 reply, the malware parses the command and executes it.\n\nCommand 1: Execute\n\nAt this point, the malware uses the same logic for execution that we have already seen. It\ncreates a task with a random name and length 8. The task will be executed through the task\nscheduler with maximum privileges. Afterwards, the malware removes the task to avoid\nbeing detected.\n\n\n-----\n\nCommand 2: Execute shellcode (MZ launcher)\n\nWhen command '2' is received, the malware parses the shellcode received as an argument.\nThe malware checks for '\\\\' and 'x' bytes, which are common delimiters used in binary data.\n\nAfter parsing the shellcode, the malware calls the 'drop_and_execute_shellcode' function,\nwhich drops an executable MZ (embedded into initial binary) with the appended\n**shellcode into a writable directory that will act as a launcher of the received binary**\n**data. The embedded MZ contains the compiler stamp from July 2020. This point in time**\ncould be when the first version of GrimAgent appeared. Moreover, it contained another\nembedded MZ with the same behavior, but designed for 64b architecture systems. The 64b\nlauncher has nearly the same time stamp.\n\nFig. 8: MZ Shellcode/DLL launcher properties\n\nThe most interesting part of the new executable is how it executes the shellcode using\nsentinel bytes, with two possibilities:\n\n1. @@@@@@@ + shellcode\n\n2. @@@@@@d + DLL path + ':' + arguments (used at command 5)\n\nIn both cases, the malware parses the sentinel bytes and executes the shellcode/DLL.\n\n**The sentinel bytes are used to calculate where the shellcode is located and be able to**\n**execute the malicious code.**\n\nOnce dropped, this MZ launcher will be executed through task scheduler with a random\nname of 8 alphanumeric characters.\n\nBy executing this command, the malware will also try to privesc by executing the payload as\nthe highest privileges possible. It will then sleep for 195-205 seconds, after which the\nmalware will delete the newly created task.\n\n\n-----\n\nCommand 3: Download and Execute (Schtask)\n\nThis is the basic functionality found in many malware families. It is the common download\nand execute command functionality.\n\nIn order to receive the payload after the request of a new command, GrimAgent performs a\nrequest to obtain the payload to the specified URI received as an argument. The payload will\nbe dropped into a writable folder and executed through the task scheduler, as in command 1.\n\nCommand 4: Update\n\nWhen this command is received, the malware updates itself by dropping the new updated\nGrimAgent file into its current directory and appending padding bytes (this action will change\nthe file hash, used as a defensive mechanism) as well as the same path_mutex_buff at the\nend of the new binary. By appending these bytes, the malware creates the same mutex and\nchecks for the same custom path for the config file. When finished, it runs the new updated\nbinary (ShellExecuteW) and exits the process.\n\nFig. 9: Updated GrimAgent\n\nCommand 5: Execute DLL\n\n(MZ launcher trampoline) This command is very similar to command 2. The function is called\nwith three parameters:\n\n1. Payload size to be received by C2 on the next request\n\n2. DLL arguments\n\n\n-----\n\n3. Bool if the DLL is 32b or 64b\n\nAs in previous commands, the malware will receive the URI to download the payload and,\nonce executed, it will obtain a writable directory in order to be able to drop payloads. It will\nthen perform a GET request to the URI in order to download the DLL to be executed.\n\nNext, the malware will drop the DLL launcher (MZ) with the sentinel bytes \"@@@@@@d\"\nand append (at the next bytes) the path of the DLL to be executed + \":\" + arguments. The file\nextension of the DLL launcher will be \".exe\". On the other hand, it will also drop the DLL to\nbe executed (with the file extension .dll).\n\nSentinel bytes syntax:\n\nOnce everything has been prepared, the malware will execute the launcher through the task\nscheduler and this will act as a stepping stone for executing the DLL, sending the previously\nobtained arguments.\n\nFig. 10: DLL execution\n\nCommand 6: Download and Execute (ShellExecuteW)\n\nThis command obtains the payload by making a request to the URI (received as the\ncommand argument), drops it into the current directory and executes through a\nShellExecuteW call.\n\n_This command was found in the newer versions of the malware._\n\n\n-----\n\n**Dealing with newer versions of GrimAgent**\n\nWhile working on this article, we found some new GrimAgent samples in the wild with\n**variations from the version explained above.**\n\nAs a sample of the different changes detailed below, we have the hash SHA256 _D6EE553F52F20127301F737237B174EF6241EC9049AB22155DCE73144EF2354D, which_\npresents variations such as:\n\n**Hardcoded mutex name \"T10\": This malware version does not generate a mutex**\nname; instead, it creates one based on a hardcoded value.\n**Hardcoded config path \"\\Users\\Public\\microsoft.cfg\": As with the mutex, a path is no**\nlonger defined for the configuration; instead, it is hardcoded in the sample.\n**Copies itself into a hardcoded path and filename (\"\\Users\\Public\\svchost.exe\"), and**\nthen sets persistence through the registry Run key. The execution is done directly\nthrough the call ShellExecuteW <path> instead of schtask.\n**The function that searches writable directories by creating and writing a new file**\nwith a random integer inside has been removed.\n**Hardcoded payload path: Commands that used writable paths found now use a**\nhardcoded path \"\\Users\\Public\\system+<random>.exe\", for example command 3\n(download and execute) and command 5 (execute DLL).\n**Added command 6 (drop and execute into the current path): The file will be executed**\nthrough a ShellExecuteW call.\n**It does not contain path_mutex_buffer (last 64 bytes in the binary).**\n**Updated command 4: The screenshot below compares the command 4 (update) of**\nboth GrimAgent versions. On the left is the old one (already explained in the article)\nand on the right is the updated one, which appends '00' bytes in the last 64 bytes of the\nupdated binary and ignores whether or not it can read the last 64 bytes of the binary.\n\nFig. 11: Comparison of GrimAgent command 4 versions\n\nThe changes mean that the malware is being actively developed and it is highly likely that\nit will present even more different versions and changes over time. The fact that some forms\nof execution have been changed (such as the use of \"path_mutex_buffer\") does not mean\nthat a threat actor will never use the former malware version again, so we must remain\nattentive and follow any new updates closely.\n\n\n-----\n\n**Network protocol**\n\n**Base protocol**\n\nGrimAgents implements a custom network protocol in order to interact with the Command\nand Control server, and it follows the following syntax:\n\nMSG: The message to be sent.\nFlag: The value used to indicate what kind of connection needs to be made with the\nC2.\n\na: On requests for new commands. It makes a POST request to the Command\nand Control server.\nd: First request to the C2. It makes a POST request to the Command and Control\nserver to register the client on the server side.\n*r: It is used internally in the malware, although it is not added directly in the\nrequest to the C2. When the function responsible for contacting the Command\nand Control server is called with this flag, the malware will make a GET request\nto a URI in order to obtain (read) the payload (the next stage).\nPadding: Random generated values.\nPadding Size: The last two bytes are the decimal value of padding length - 3 (decimal\nformat).\n\nRandomization of connection fields\n\nTo establish a connection with the C2, GrimAgent randomizes some values as an evasive\nmechanism and tries to change request fields on the C2 request, such as User-Agent,\nreferer, content-length and language.\n\nAs an interesting detail, if you look at the languages that the malware tries to adopt in the\n'Accept-Language' field when connecting to the Command and Control server, it is possible\nthat there is a relationship with the group's current targets. If so, they would be the following:\n\nUnited Kingdom\nUnited States\nSpain\nFrance\n\n**Detection opportunities**\n\nWe have examined how GrimAgent behaves throughout its execution, when and what it\ndoes. We will now analyze the various opportunities to detect the malware. We can use the\nway in which it executes these actions to monitor the behavior in the different defense\n**mechanisms or match them using Sigma, Yara or Suricata rules.**\n\n**Detection opportunity 1: Persistence**\n\n\n-----\n\nOn the first run, the malware copies itself to another directory, runs while establishing\npersistence on itself, and deletes the old file. A common path the malware uses is\n_C:/Users/Public. GrimAgent carries out specific calls and they can be monitored to identify_\nrelated behaviors.\n\nCheck the IOC section for the full information about the commands used on the malware\npersistence.\n\n**Detection opportunity 2: Mutex (old malware version)**\n\nOne of GrimAgent's most characteristic factors is using the last 64 bytes of the binary to\ncompute the name of the mutex. The characteristic can be used to create a behavior rule\nand therefore predict what mutex name it will create in the system.\n\nAll we have to do is to recreate the algorithm used in your different solutions by taking the\nlast 64 bytes of the file and compute the possible mutex name. You can spot the algorithm\nused by the malware in the Mutex section\n\n**Detection opportunity 3: Network**\n\nThe first domain to contact is \"api.myip.com\" in order to obtain the country code and client IP\n[(http://ip-api.com/csv/?fields=query,countryCode) and then make the request to the C2 to](http://ip-api.com/csv/?fields=query)\nobtain the AES key. Once finished, it will make periodic requests to the C2 infrastructure to\nobtain the following commands and/or to get next stage payloads. We can take advantage of\nthe usage of the path \"/gate.php\" in conjunction with specific fields such as the referer\n(google.com, youtube.com, etc.) when contacting the C2.\n\n[Link to Suricata rule: https://github.com/apriegob/GrimAgent/blob/main/Ru...](https://github.com/apriegob/GrimAgent/blob/main/Rules/GrimAgent.rules)\n\n**Detection opportunity 4: Payload drop**\n\nWhile executing the malware commands related to executing shellcode and DLLs, it uses a\nbinary embedded in the initial malware. We can create detection rules for this binary and\nalert our defense teams if a match is found.\n\nThe following Yara rule was created to detect shellcode and DLL launchers (32b/64b)\nembedded in GrimAgent.\n\nLink to Yara rule: [https://github.com/apriegob/GrimAgent/blob/main/Ru...](https://github.com/apriegob/GrimAgent/blob/main/Rules/GrimAgent.yara)\n\n**Detection opportunity 5: Payload execution**\n\nAs we have shown throughout the article, to execute payloads GrimAgent uses both the\nShellExecute call and indirect execution through scheduled tasks. Given that it always uses\nthe same syntax on schtasks, we can try to match these actions. As it is suspicious behavior\n\n\n-----\n\nto create a scheduled task and try to execute it nearly at the same time as its creation, try to\nexecute it with maximum privileges and delete it.\n\n_Check the IOC section for the full information about the commands used on the payload_\n_execution._\n**Hunt or be hunted**\n\nWe have created various behaviors as well as static and network rules in order to be able to\nhunt and detect the GrimAgent malware family. The following screenshot shows Group-IB's\nThreat Hunting Framework (THF) and how the GrimAgent sample has been detonated and\ndetected.\n\nFig. 12 - Group-IB THF detecting GrimAgent malware\n\n**Conclusion**\n\nThere can be no doubt that we are facing a meticulous, careful and highly skilled adversary.\nMany have already fallen victim to Ryuk ransomware, which is known to target large\ncompanies, encrypt their content, and ask for large sums of money. When it comes to such\nthreats, all defensive measures are not enough and we believe that we must direct our IR\nteams and companies in intelligence-based environments. We must get ahead of the\nadversary before they carry out their attack.\n\nTo help the cyber community better detect the adversary, IOC and Rules sections are\nprovided below.\n\nI would like to give a special thank you to my father, who has always supported me and lent\nme a helping hand when I have needed him. Thank you, always.\n\nAlbert\n\n\n-----\n\n**MITRE ATT&CK**\n\n**Indicators of Compromise**\n\n**Task scheduler**\n\n\n-----\n\n/CREATE /SC ONSTART /TN [A-Za-z0-9]{4,9} /TR <path to file> /f\n/CREATE /SC ONSTART /TN [A-Za-z0-9]{4,9} /TR \"<path to file>\" /f /RL HIGHEST\n/CREATE /SC ONCE /ST hh:mm:ss /TN [A-Za-z0-9]{8} /TR \"<path to file>\" /f\n/CREATE /SC ONCE /ST hh:mm:ss /TN [A-Za-z0-9]{8} /TR \"'<path to file> /f /RL\nHIGHEST\n\n/DELETE /TN [A-Za-z0-9]{8} /f\n\n**File deletion**\n\ncmd /c timeout 10 & del <path to file>\n\n**Registry**\n\nREG ADD HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\" /V \"microsoft\nupdate\" /t REG_SZ /F /D \"SCHTASKS /run /tn [A-Za-z0-9]{8}\"\n\n**Directories and files**\n\nC:\\Users\\Public\\config\n\nC:\\Users\\Public\\reserve.sys\n\n**Command and Control server**\n\nmicrosoftupdate[.]top/gate.php\nmicrosoftsystemcloud[.]com/gate.php\nchaseltd[.]top/gate.php\n\n**Hashes**\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-02 - The Brothers Grim - The reversing tale of GrimAgent malware used by Ryuk.pdf"
    ],
    "report_names": [
        "2021-07-02 - The Brothers Grim - The reversing tale of GrimAgent malware used by Ryuk.pdf"
    ],
    "threat_actors": [
        {
            "id": "2646f776-792a-4498-967b-ec0d3498fdf1",
            "created_at": "2022-10-25T15:50:23.475784Z",
            "updated_at": "2025-03-27T02:00:55.479958Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Palmerworm"
            ],
            "source_name": "MITRE:BlackTech",
            "tools": [
                "Kivars",
                "PsExec",
                "TSCookie",
                "Flagpro",
                "Waterbear"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d3a7123c-f519-49a0-a234-de24a1ef052a",
            "created_at": "2022-10-25T16:47:55.545211Z",
            "updated_at": "2025-03-27T02:05:17.254744Z",
            "deleted_at": null,
            "main_name": "BRONZE CANAL",
            "aliases": [
                "CTG-6177 ",
                "Circuit Panda ",
                "Palmerworm ",
                "Shrouded Crossbow ",
                "BlackTech"
            ],
            "source_name": "Secureworks:BRONZE CANAL",
            "tools": [
                " DRIGO",
                " Flagpro",
                " Gh0stTimes",
                " PLEAD",
                " Spiderpig",
                " Waterbear",
                "Bifrose"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75024aad-424b-449a-b286-352fe9226bcb",
            "created_at": "2023-01-06T13:46:38.962724Z",
            "updated_at": "2025-03-27T02:00:02.964002Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "CIRCUIT PANDA",
                "Temp.Overboard",
                "G0098",
                "Red Djinn",
                "HUAPI",
                "Palmerworm",
                "T-APT-03",
                "Manga Taurus",
                "Earth Hundun"
            ],
            "source_name": "MISPGALAXY:BlackTech",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "63061658-5810-4f01-9620-7eada7e9ae2e",
            "created_at": "2022-10-25T15:50:23.752974Z",
            "updated_at": "2025-03-27T02:00:55.538582Z",
            "deleted_at": null,
            "main_name": "Wizard Spider",
            "aliases": [
                "Wizard Spider",
                "UNC1878",
                "TEMP.MixMaster",
                "Grim Spider",
                "FIN12",
                "GOLD BLACKBURN",
                "ITG23",
                "Periwinkle Tempest",
                "DEV-0193"
            ],
            "source_name": "MITRE:Wizard Spider",
            "tools": [
                "TrickBot",
                "AdFind",
                "BITSAdmin",
                "Bazar",
                "LaZagne",
                "Nltest",
                "GrimAgent",
                "Dyre",
                "Ryuk",
                "Conti",
                "Emotet",
                "Rubeus",
                "Mimikatz",
                "Diavol",
                "PsExec",
                "Cobalt Strike"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "efa7c047-b61c-4598-96d5-e00d01dec96b",
            "created_at": "2022-10-25T16:07:23.404442Z",
            "updated_at": "2025-03-27T02:02:09.781478Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Circuit Panda",
                "Earth Hundun",
                "Manga Taurus",
                "Operation PLEAD",
                "Operation Shrouded Crossbow",
                "Operation Waterbear",
                "Palmerworm",
                "Radio Panda",
                "Red Djinn",
                "T-APT-03",
                "TEMP.Overboard"
            ],
            "source_name": "ETDA:BlackTech",
            "tools": [
                "BIFROST",
                "BUSYICE",
                "BendyBear",
                "Bluether",
                "CAPGELD",
                "DRIGO",
                "Deuterbear",
                "Flagpro",
                "GOODTIMES",
                "Gh0stTimes",
                "IconDown",
                "KIVARS",
                "LOLBAS",
                "LOLBins",
                "Linopid",
                "Living off the Land",
                "TSCookie",
                "Waterbear",
                "XBOW",
                "elf.bifrose"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "ee3363a4-e807-4f95-97d8-b603c31b9de1",
            "created_at": "2023-01-06T13:46:38.485884Z",
            "updated_at": "2025-03-27T02:00:02.845851Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "Camouflage Tempest",
                "MageCart Group 6",
                "G0037",
                "TA4557",
                "SKELETON SPIDER",
                "ITG08",
                "White Giant",
                "GOLD FRANKLIN",
                "ATK88"
            ],
            "source_name": "MISPGALAXY:FIN6",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "12517c87-040a-4627-a3df-86ca95e5c13f",
            "created_at": "2022-10-25T16:07:23.61665Z",
            "updated_at": "2025-03-27T02:02:09.889471Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "ATK 88",
                "Camouflage Tempest",
                "FIN6",
                "Gold Franklin",
                "ITG08",
                "Skeleton Spider",
                "TAAL",
                "TAG-CR2",
                "White Giant"
            ],
            "source_name": "ETDA:FIN6",
            "tools": [
                "AbaddonPOS",
                "Agentemis",
                "AmmyyRAT",
                "Anchor_DNS",
                "BlackPOS",
                "CmdSQL",
                "Cobalt Strike",
                "CobaltStrike",
                "FlawedAmmyy",
                "FrameworkPOS",
                "Grateful POS",
                "JSPSPY",
                "Kaptoxa",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LockerGoga",
                "MMon",
                "Magecart",
                "Meterpreter",
                "Mimikatz",
                "More_eggs",
                "NeverQuest",
                "POSWDS",
                "Reedum",
                "Ryuk",
                "SCRAPMINT",
                "SONE",
                "SpicyOmelette",
                "StealerOne",
                "Taurus Loader Stealer Module",
                "Terra Loader",
                "TerraStealer",
                "Vawtrak",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "cobeacon",
                "grabnew"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f6f91e1c-9202-4497-bf22-9cd5ef477600",
            "created_at": "2023-01-06T13:46:38.86765Z",
            "updated_at": "2025-03-27T02:00:02.938998Z",
            "deleted_at": null,
            "main_name": "WIZARD SPIDER",
            "aliases": [
                "FIN12",
                "UNC2053",
                "Pistachio Tempest",
                "TEMP.MixMaster",
                "GOLD BLACKBURN",
                "Periwinkle Tempest",
                "DEV-0193",
                "Storm-0193",
                "Trickbot LLC",
                "DEV-0237"
            ],
            "source_name": "MISPGALAXY:WIZARD SPIDER",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e6a21528-2999-4e2e-aaf4-8b6af14e17f3",
            "created_at": "2022-10-25T16:07:24.422115Z",
            "updated_at": "2025-03-27T02:02:10.216817Z",
            "deleted_at": null,
            "main_name": "Wizard Spider",
            "aliases": [
                "DEV-0193",
                "Gold Blackburn",
                "Gold Ulrick",
                "Grim Spider",
                "ITG23",
                "Operation BazaFlix",
                "Periwinkle Tempest",
                "TEMP.MixMaster",
                "Wizard Spider"
            ],
            "source_name": "ETDA:Wizard Spider",
            "tools": [
                "AdFind",
                "Agentemis",
                "Anchor_DNS",
                "BEERBOT",
                "BazarBackdoor",
                "BazarCall",
                "BazarLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "Conti",
                "Diavol",
                "Dyranges",
                "Dyre",
                "Dyreza",
                "Dyzap",
                "Gophe",
                "Invoke-SMBAutoBrute",
                "KEGTAP",
                "LaZagne",
                "LightBot",
                "PowerSploit",
                "PowerTrick",
                "PsExec",
                "Ryuk",
                "SessionGopher",
                "TSPY_TRICKLOAD",
                "Team9Backdoor",
                "The Trick",
                "TheTrick",
                "Totbrick",
                "TrickBot",
                "TrickLoader",
                "TrickMo",
                "Upatre",
                "bazaloader",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b3acfb48-b04d-4d3d-88a8-836d7376fa2e",
            "created_at": "2024-06-19T02:03:08.052814Z",
            "updated_at": "2025-03-27T02:05:17.368029Z",
            "deleted_at": null,
            "main_name": "GOLD FRANKLIN",
            "aliases": [
                "ITG08 ",
                "MageCart Group 6 ",
                "Skeleton Spider ",
                "White Giant ",
                "FIN6 "
            ],
            "source_name": "Secureworks:GOLD FRANKLIN",
            "tools": [
                " Metasploit",
                " Meterpreter",
                " Mimikatz",
                " PowerSploit",
                " PowerUpSQL",
                " RemCom",
                "FrameWorkPOS"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "bc119938-a79c-4e5f-9d4d-dc96835dfe2e",
            "created_at": "2024-06-04T02:03:07.799286Z",
            "updated_at": "2025-03-27T02:05:17.337094Z",
            "deleted_at": null,
            "main_name": "GOLD BLACKBURN",
            "aliases": [
                "Periwinkle Tempest ",
                "Wizard Spider ",
                "ITG23 "
            ],
            "source_name": "Secureworks:GOLD BLACKBURN",
            "tools": [
                " Buer Loader",
                " Dyre",
                " Team9",
                " TrickBot",
                "BazarLoader"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "ea7bfe06-7c23-481d-b8ba-eafa6cda3bc9",
            "created_at": "2022-10-25T15:50:23.317961Z",
            "updated_at": "2025-03-27T02:00:55.440858Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "FIN6",
                "Magecart Group 6",
                "ITG08",
                "Skeleton Spider",
                "TAAL",
                "Camouflage Tempest"
            ],
            "source_name": "MITRE:FIN6",
            "tools": [
                "FlawedAmmyy",
                "GrimAgent",
                "FrameworkPOS",
                "More_eggs",
                "Cobalt Strike",
                "Windows Credential Editor",
                "AdFind",
                "PsExec",
                "LockerGoga",
                "Ryuk",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535911,
    "ts_updated_at": 1743041713,
    "ts_creation_date": 1653759888,
    "ts_modification_date": 1653759888,
    "files": {
        "pdf": "https://archive.orkl.eu/9be5bdfde99f83135a1693af82ee74376ef65f3f.pdf",
        "text": "https://archive.orkl.eu/9be5bdfde99f83135a1693af82ee74376ef65f3f.txt",
        "img": "https://archive.orkl.eu/9be5bdfde99f83135a1693af82ee74376ef65f3f.jpg"
    }
}