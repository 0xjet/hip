{
    "id": "4b76d818-eba4-4b43-88f7-77ad40d7a284",
    "created_at": "2023-01-12T15:03:10.372511Z",
    "updated_at": "2025-03-27T02:17:02.265954Z",
    "deleted_at": null,
    "sha1_hash": "f3bf0c397b65d9b96a79c68e4327ddbaf215bfee",
    "title": "2019-09-18 - Malware Used by BlackTech after Network Intrusion",
    "authors": "",
    "file_creation_date": "2022-05-28T23:44:30Z",
    "file_modification_date": "2022-05-28T23:44:30Z",
    "file_size": 316543,
    "plain_text": "# Malware Used by BlackTech after Network Intrusion\n\n**blogs.jpcert.or.jp/en/2019/09/tscookie-loader.html**\n\n朝長 [秀誠 (Shusei Tomonaga)](https://blogs.jpcert.or.jp/en/shu_tom/)\n\nSeptember 18, 2019\n\n[Tool](https://blogs.jpcert.or.jp/en/tags/tool/)\n[BlackTech](https://blogs.jpcert.or.jp/en/tags/blacktech/)\n\n[Email](http://10.10.0.46/mailto:?subject=Malware%20Used%20by%20BlackTech%20after%20Network%20Intrusion&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fen%2F2019%2F09%2Ftscookie-loader.html)\n\n[Previously, we explained about malware \"TSCookie\" and](https://blogs.jpcert.or.jp/en/2018/03/malware-tscooki-7aa0.html) [\"PLEAD\" which are used by an](https://blogs.jpcert.or.jp/en/2018/06/plead-downloader-used-by-blacktech.html)\nattack group BlackTech. Their activities have been continuously observed in Japan as of\nnow. We have been seeing that a new malware variant is being used after they successfully\nintruded into a target network. This article explains the details of the variant.\n\n### TSCookie used after intrusion\n\nThe malware consists of 2 files (TSCookie Loader and TSCookie) as in Figure 1.\n\nFigure 1: Overview of\n\nTSCookie Loader and TSCookie\n\n\n-----\n\nTSCookie Loader is either in EXE or DLL format, and it reads and executes specific files\nstored in the same folder or the following locations. (The folders may vary depending on the\nsample.)\n\nC:\\Windows\nC:\\ProgramData\\Microsoft\nC:\\Users\\Public\\Documents\nC:\\Program Files\\Internet Explorer\n\nIt reads files that match the following file names:\n\ndesktop.db\nFiles with name that match 7???. (wildcard)\nFiles with name that match 8???. (wildcard)\n\nFor example, files names such as KB78E7269.log and PM89E7267.xml have been\nconfirmed.\nTSCookie is RC4-encrypted and can be decoded by TSCookie Loader before being\nexecuted on the memory. TSCookie itself is a downloader and operates according to\nmodules downloaded from an external server. Some characteristics such as configuration\nand communication protocols differ between TSCookie and the variant.\nDetails of TSCookie behaviour is described in the following section.\n\n### TSCookie behaviour\n\nTSCookie supports multiple communication protocols (HTTP, HTTPS and custom protocol).\nThe protocol that each sample uses is described in its configuration. (Please see Appendix A\nfor the details of the configuration.)\n\nIf it is configured to use HTTP protocol, the following HTTP POST request is sent:\n```\nPOST /index?o=E7E168C4EC82E HTTP/1.1\nCache-Control: no-cache\nPragma: no-cache\nAccept: */*\nUser-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Win32)\nProxy-Connection: Keep-Alive\nContent-Length: [size]\nHost: [host name]\n[Data]\n\n```\nThere are several patterns of URL path, which are dynamically created with the following\nrandom strings and values. (Some of them are described with format specifiers. Other\npatterns also exist.)\n\n/news?%c=%X%X\n/index?%c=%X%X\n\n\n-----\n\n/?id=%X%X\n/Default.aspx?%c=%X%X\n/m%u.jsp?m=%d\n/N%u.jsp?m=%d\n\nSent data is RC4-encrypted. Please see Table B-1 and B-2 in Appendix B for the format of\nthe data.\nData downloaded by the HTTP POST request is RC4-encrypted by the 8-byte value\nconsisting of the RC4 key (Table A-1 in Appendix A) and another value in the received data\n(RC4 key as in Table B-3 in Appendix B). The downloaded data contains modules, and they\nare executed on the memory.\n\n### TSCookie decoding tool\n\nWe have developed a tool to decode TSCookie files and extract configuration. This is\navailable on GitHub for your use.\n\nJPCERTCC/aa-tools - GitHub\n\n[https://github.com/JPCERTCC/aa-tools/blob/master/tscookie_data_decode.py](https://github.com/JPCERTCC/aa-tools/blob/master/tscookie_data_decode.py)\n\n### In closing\n\nWe have received many reports about TSCookie infection. Please make sure that there is no\ninfection in your organisation, referring to the file names and communication protocols\ndescribed in this article. The hash value of the samples described in this article are listed in\nAppendix C.\n\nShusei Tomonaga\n\n(Translated by Yukako Uchida)\n\n**Appendix A: TSCookie Configuration**\n\nTable A: Configuration\n\nOffset Contents Remarks\n\n\n0x000 Destination server and port\nnumber\n\n\nMultiple hosts can be specified by listing with\na semicolon \";\"\n\n\n0x400 RC4 key Used for encryption\n\n0x404 Sleep times\n\n0x42C Mutex\n\n\n-----\n\n0x44C Communication mode - 1,2,3: HTTP protocol supporting\nauthentication proxy\n\n                      - 6,7,8: HTTPS protocol\n\n                       - 0: Custom protocol\n\n                      - 5: HTTP protocol\n\n0x454 HTTP connection keep\n\n0x458 ICMP recipient setting Receive information of the destination server\nby ICMP\n\n0x4D4 IP address to receive ICMP\ncommunication\n\n0x624 Process injection mode - 0: Launch\n\n                       - 1: Already running\n\n                      - 2: Launch offset 0x62C\n\n0x628 Process to be injected - 0: svchost.exe\n\n                         - 1: iexplorer.exe\n\n                        - 2: explorer.exe\n\n                       - 3: Default Browser\n\n                       - 4: Process in offset 0x62C\n\n0x62C Process name\n\n0x72C Proxy server\n\n0x76C Proxy port number\n\n0x770 Proxy username\n\n0x790 Proxy password\n\n0x7B0 Proxy mode - 1: Use configuration data\n\n                       - 0: Detect Proxy automatically\n\n0x7B4 Proxy authentication process AuthScheme\n\nSome samples may not inject processes.\n\n**Appendix B: Data exchanged by TSCookie**\n\nTable B-1: Format of sent data\n\nOffset Length Contents\n\n0x00 4 Number of received data (begins with 0xFFFFFFFF)\n\n0x04 4 Length of data sent\n\n\n-----\n\n0x08 4 Times of communication\n\n0x0C 4 Fixed value (Set to 0x5322 at the beginning, then to 0x5324 or 0x5325\nwhile receiving modules)\n\n0x1C 4 Random data (RC4 key)\n\n0x20 - Random data after first communication (See Table B-2 for first\ncommunication)\n\nUp to offset 0x1C, the contents are RC4-encrypted with the key in the configuration\nand random data.\n\nTable B-2: Data format of first communication after offset 0x20\n\nOffset Length Contents\n\n0x00 4 0x9A65001E\n\n0x04 4 Process ID\n\n0x08 4 0x5322\n\n0x0C 4 Random data\n\n0x10 4 Data size from offset 0x14\n\n0x14 - Random data (RC4 key)\n\nUp to offset 0x14, the contents are RC4-encrypted with the key in the configuration and\nrandom data.\n\nTable B-3: Format of received data\n\nOffset Length Contents\n\n0x00 4 Number of received data\n\n0x04 4 Length of received data\n\n0x0C 4 \n0x10 4 Whether the contents from offset 0x20 is encrypted\n\n0x1C 4 RC4 key\n\n0x20 - Module data\n\n\n-----\n\nUp to 0x1C, the contents are RC4-encrypted with the key contained in the configuration\nand another key in the received data.\n\n**Appendix C: SHA-256 value of the samples**\n\nTSCookie Loader\n\n072f24d2691fb3930628be91bc46cefb8bc3364d1d09d72ab0cb3863681cb107\nf49956f498042feb237c3e898f74a8e14500c27cda2746efca2d973a5390baa8\n3e12938df72380e4ae7a2dcb3322e563de3da102f5f32b26a29662ba594e73d1\n23ca1a3ca26ada00502bbd1abf4d42302343dafba32cbc0711847d52884ff8e1\n6ec56de53ef1ea66c81b3e48f9a9b3cf3dc8e3ebda1ec08bf95cc21228a4c7b3\nbd89b972de19c8ab2be0fb3e2aa44638a95e465e4b52920c94e6f59c25ce4693\nc5d7e5a12c8eab9c14f008c93d92e0070f84f358d39f28ac089ee917c652f5a8\n85536a139b9d44157aea2908a6a6e53e4ac19077355680b69edd8e84c70254bc\n0d00d12d71dd080d2861e9da89906a67bb822c64366b4c6b72a55bb8c26a4ea3\n81dfce847a9fd6a3a0080a927bbb740709bdcc099bfe1b0cfc99958f6ddeb52f\n48fdc29e7f47e5d38c88a89667ed85740628bf4f4ce95045019f7ebfeb4bbb5c\nd5909d06ddb394dea114052e9e174fa1e88324d805d153edb6076c53842fd2f2\n9e10a1abbff4d421eaee20040fb2a9270c4efb6d75ee6cd728b09bac1042bfa6\nae5528cc802c81946f2787c7e884656416acebc89466989eeca9379fa066ad96\n69b07aae04af6ca57d6066fdcbfeeb4c4849bfd2cd65b01c1e576f45b1c24d79\n784b331d30d46ee9e7a264ecb45e3a39d7cef135d189bf0e712e89935728c13f\n0eb9947a1ef4b810517f6cba175a321c4d69c3058d688bdd73492d54e7932c86\n\n[Email](http://10.10.0.46/mailto:?subject=Malware%20Used%20by%20BlackTech%20after%20Network%20Intrusion&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fen%2F2019%2F09%2Ftscookie-loader.html)\n\nAuthor\n\n朝長 [秀誠 (Shusei Tomonaga)](https://blogs.jpcert.or.jp/en/shu_tom/)\n\nSince December 2012, he has been engaged in malware analysis and forensics\ninvestigation, and is especially involved in analyzing incidents of targeted attacks. Prior to\njoining JPCERT/CC, he was engaged in security monitoring and analysis operations at a\nforeign-affiliated IT vendor. He presented at CODE BLUE, BsidesLV, BlackHat USA Arsenal,\nBotconf, PacSec and FIRST Conference. JSAC organizer.\n\nWas this page helpful?\n\n0 people found this content helpful.\n\n\n-----\n\nIf you wish to make comments or ask questions, please use this form.\n\nThis form is for comments and inquiries. For any questions regarding specific commercial\nproducts, please contact the vendor.\n\nplease change the setting of your browser to set JavaScript valid. Thank you!\n\n## Related articles\n\nAnalysis of HUI Loader\n\nAnti-UPX Unpacking Technique\n\nFAQ: Malware that Targets Mobile Devices and How to Protect Them\n\n\n-----\n\nMalware WinDealer used by LuoYu Attack Group\n\nMalware Gh0stTimes Used by BlackTech\n\n\n[Back](https://blogs.jpcert.or.jp/en/2019/08/malconfscan-with-cuckoo.html)\n[Top](https://blogs.jpcert.or.jp/en/)\n[Next](https://blogs.jpcert.or.jp/en/2019/10/apcert2019.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-09-18 - Malware Used by BlackTech after Network Intrusion.pdf"
    ],
    "report_names": [
        "2019-09-18 - Malware Used by BlackTech after Network Intrusion.pdf"
    ],
    "threat_actors": [
        {
            "id": "2646f776-792a-4498-967b-ec0d3498fdf1",
            "created_at": "2022-10-25T15:50:23.475784Z",
            "updated_at": "2025-03-27T02:00:55.479958Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Palmerworm"
            ],
            "source_name": "MITRE:BlackTech",
            "tools": [
                "Kivars",
                "PsExec",
                "TSCookie",
                "Flagpro",
                "Waterbear"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d3a7123c-f519-49a0-a234-de24a1ef052a",
            "created_at": "2022-10-25T16:47:55.545211Z",
            "updated_at": "2025-03-27T02:05:17.254744Z",
            "deleted_at": null,
            "main_name": "BRONZE CANAL",
            "aliases": [
                "CTG-6177 ",
                "Circuit Panda ",
                "Palmerworm ",
                "Shrouded Crossbow ",
                "BlackTech"
            ],
            "source_name": "Secureworks:BRONZE CANAL",
            "tools": [
                " DRIGO",
                " Flagpro",
                " Gh0stTimes",
                " PLEAD",
                " Spiderpig",
                " Waterbear",
                "Bifrose"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75024aad-424b-449a-b286-352fe9226bcb",
            "created_at": "2023-01-06T13:46:38.962724Z",
            "updated_at": "2025-03-27T02:00:02.964002Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "CIRCUIT PANDA",
                "Temp.Overboard",
                "G0098",
                "Red Djinn",
                "HUAPI",
                "Palmerworm",
                "T-APT-03",
                "Manga Taurus",
                "Earth Hundun"
            ],
            "source_name": "MISPGALAXY:BlackTech",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2864e40a-f233-4618-ac61-b03760a41cbb",
            "created_at": "2023-12-01T02:02:34.272108Z",
            "updated_at": "2025-03-27T02:02:10.209072Z",
            "deleted_at": null,
            "main_name": "WildCard",
            "aliases": [],
            "source_name": "ETDA:WildCard",
            "tools": [
                "RustDown",
                "SysJoker"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "efa7c047-b61c-4598-96d5-e00d01dec96b",
            "created_at": "2022-10-25T16:07:23.404442Z",
            "updated_at": "2025-03-27T02:02:09.781478Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Circuit Panda",
                "Earth Hundun",
                "Manga Taurus",
                "Operation PLEAD",
                "Operation Shrouded Crossbow",
                "Operation Waterbear",
                "Palmerworm",
                "Radio Panda",
                "Red Djinn",
                "T-APT-03",
                "TEMP.Overboard"
            ],
            "source_name": "ETDA:BlackTech",
            "tools": [
                "BIFROST",
                "BUSYICE",
                "BendyBear",
                "Bluether",
                "CAPGELD",
                "DRIGO",
                "Deuterbear",
                "Flagpro",
                "GOODTIMES",
                "Gh0stTimes",
                "IconDown",
                "KIVARS",
                "LOLBAS",
                "LOLBins",
                "Linopid",
                "Living off the Land",
                "TSCookie",
                "Waterbear",
                "XBOW",
                "elf.bifrose"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "256a6a2d-e8a2-4497-b399-628a7fad4b3e",
            "created_at": "2023-11-30T02:00:07.299845Z",
            "updated_at": "2025-03-27T02:00:03.257794Z",
            "deleted_at": null,
            "main_name": "WildCard",
            "aliases": [],
            "source_name": "MISPGALAXY:WildCard",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b72c2616-cc7c-4c47-a83d-6b7866b94746",
            "created_at": "2023-01-06T13:46:39.425297Z",
            "updated_at": "2025-03-27T02:00:03.08718Z",
            "deleted_at": null,
            "main_name": "Red Nue",
            "aliases": [
                "LuoYu"
            ],
            "source_name": "MISPGALAXY:Red Nue",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535790,
    "ts_updated_at": 1743041822,
    "ts_creation_date": 1653781470,
    "ts_modification_date": 1653781470,
    "files": {
        "pdf": "https://archive.orkl.eu/f3bf0c397b65d9b96a79c68e4327ddbaf215bfee.pdf",
        "text": "https://archive.orkl.eu/f3bf0c397b65d9b96a79c68e4327ddbaf215bfee.txt",
        "img": "https://archive.orkl.eu/f3bf0c397b65d9b96a79c68e4327ddbaf215bfee.jpg"
    }
}