{
    "id": "23e6ad90-de2d-48aa-b18a-1d2cec008b3e",
    "created_at": "2023-01-12T15:02:13.451393Z",
    "updated_at": "2025-03-27T02:05:41.659868Z",
    "deleted_at": null,
    "sha1_hash": "47cf7584f5762db2b2f7095b59c89d7dda3e4ae7",
    "title": "2020-09-04 - BitRAT pt. 2- Hidden Browser, SOCKS5 proxy, and UnknownProducts Unmasked",
    "authors": "",
    "file_creation_date": "2022-05-28T04:06:18Z",
    "file_modification_date": "2022-05-28T04:06:18Z",
    "file_size": 421688,
    "plain_text": "# BitRAT pt. 2: Hidden Browser, SOCKS5 proxy, and UnknownProducts Unmasked\n\n**[krabsonsecurity.com/2020/09/04/bitrat-pt-2-hidden-browser-socks5-proxy-and-unknownproducts-unmasked/](https://krabsonsecurity.com/2020/09/04/bitrat-pt-2-hidden-browser-socks5-proxy-and-unknownproducts-unmasked/)**\n\n[Posted on September 4, 2020](https://krabsonsecurity.com/2020/09/04/)\n[Pt. 1 of the BitRAT series.](https://krabsonsecurity.com/2020/08/22/bitrat-the-latest-in-copy-pasted-malware-by-incompetent-developers/)\n\nDuring my initial analysis, there were several features in BitRAT that I did not have the\nopportunity to fully analyze. As such, I thought another post is merited to explore these\nfunctionalities further. In addition to this, analysis of the binary revealed strong similarities\nand shared code with the Revcode malware. We could from this infer that BitRAT has a\nsignificant relationship to Revcode, whether it is the developers sharing code or the\ndevelopers being in fact the same person. The information leading to this assessment will\nbe explored in detail in the last section of the post.\n\n## Hidden Browser\n\nI did not explore the Hidden Browser feature in much detail initially, as I assumed it would\nmerely be an interface built on top of TinyNuke’s HVNC. However, this assumption was\nincorrect. The Hidden Browser (command 65-6E) is implemented separately and from\nscratch. The first command (0x65) calls the remote browser initializer (004B6A64), which is\na considerably large function due to the heavy use of STL, Boost, and string obfuscation.\nDue to this, screenshots will be combined and cut to fit in the article. First, it generates a\nrandom 16-character string, which it then uses to create a named desktop.\n\nThen, it tries to obtain the default installed browser by querying the file association for the\n“.html” extension.\n\n\n-----\n\nCurrently, only Chrome is supported and the function returns prematurely if another browser\nis set as the default .html handler. BitRAT then checks to see if Chrome is already running.\nIf this is the case, it creates a new browser profile in the temp directory, otherwise it uses\nthe default profile.\n\nIt then appends some parameters disabling certain chrome features as is typical of HVNC\nbrowsers, creates the process and saves the browser window’s handle.\n\n\n-----\n\nAfter this, the current thread enters a loop where it continuously screenshots the current\nbrowser and sends it back to the C2 server. The screenshot function makes use of BitBlt\nand GDI to take the screenshot, then convert it to a JPEG image and passes it back.\n\n\n-----\n\nParts of the image capturing code\n\nConversion to JPEG\n\nOverall, the hidden browser is essentially another fairly basic HVNC implementation. For\nthose not familiar with how HVNCs work, MalwareTech’s post is a fairly simple introduction\nthat should clear things up.\n\n\n-----\n\n## SOCKS5 Proxy\n\nFor interfacing with the tor service that is dropped to disk, BitRAT makes use of the\n[SOCKS5 library “socks5-cpp“. Interestingly, around 3 years ago a Steemit post was made](https://github.com/NuclearC/socks5-cpp)\n[describing how to use this specific library for sending traffic through Tor, this is presumably](https://steemit.com/tor/@scriptkid/tor-as-a-socks5-proxy-in-your-c-applications-with-socks5-cpp)\nwhere the idea was taken from.\n\n\n-----\n\n## UnknownProducts, BitRAT, and the link to Revcode\n\nA few days after I posted my initial article on BitRAT, @tildedennis noted that BitRAT is quite\nsimilar to the Revcode malware. Though I didn’t see it for a few days due to Twitter filtering\nout the notification, I was immediately interested for several reasons:\n\n1. I’ve dealt with Revcode before and have identified its author as Alex Yücel, notorious\n\nfor developing the Blackshades malware.\n2. I knew that at one point, Revcode had a C++ payload that used Boost; however, I\n\nhave not until now had a sample of this to look at and have only reverse-engineered\nthe VB variant of it. The usage of Boost was shortly removed after it was\nimplemented.\n3. UnknownProducts’ timezone is GMT+2, which matches Sweden. He previously\n\npretended to be Russian, however this is utterly unconvincing for various reasons.\n\nGiven this reliable indicator that the two are possibly linked, a comparison between a\nsample of Revcode’s Boost variant\n[(be535a8c325e4eec17bbc63d813f715d2c8af9fd23901135046fbc5c187aabb2) and BitRAT](https://app.any.run/tasks/c69f9dc3-8fb5-4d50-82d4-237a9d7c5ffc/)\nis in order. The sample was trivial to unpack, the packer stub was built on 18 Jan 2019\n05:29:34 UTC and the Revcode file inside was built on 20 Dec 2018 03:02:36 UTC.\n\n\n-----\n\n### RunPE\n\nWhat first caught my eye when reverse engineering BitRAT’s RunPE is how injection APIs\nare imported statically (refer to the previous post) and how a function parameter controls\nthe return value.\n\nWhile the rest of the RunPE was copy-pasted, I could not find any public RunPE\nimplementation that has such an option for the return value or even one that references\ndwProcessId. As such, I immediately searched for references to injection-relevant APIs\nwithin Revcode and immediately found a virtually identical function with the same method\nfor controlling the return value.\n\nThe rest of the code was virtually identical, with the only significant difference being that\nBitRAT encrypts the “NtUnmapViewOfSection” string.\n\n\n-----\n\nRunPE in BitRAT\n\nRunPE in Revcode\n\n### Keylogger\n\nBitRAT’s keylogger hook callback (4ABC8D) decodes key data into human-readable strings.\nFor example, the strings “{NUMPAD_2}”, “{NUMPAD_5}”, “{NUMPAD_7}”, “{F12}” are used\nto represent such keys. The same strings are used in Revcode. In fact, the entire keyboard\nhook function is identical.\n\n\n-----\n\nPart of BitRAT’s keylogger callback\n\nPart of Revcode’s keylogger callback\n\n### Service Manager function\n\nThe service manager shares identical strings such as “Boot Start,” “Win32 share process”,\n“The service is stopped,” “The service is in the process of being stopped.” While these\nstrings are likely widely used elsewhere, they are referenced in the same manner and order.\nFurthermore, a comparison of the control flow graph reveals that BitRAT’s service manager\nonly differs in complexity and length due to string encryption and SEH.\n\n\n-----\n\nThe flow graph of the service manager function. BitRAT is on the left, while Revcode is on the right.\n\n### Identical command handling mechanisms\n\nA significant amount of command names are similar between the two malware. Both\nabbreviates “process” as “prc”. Both do not abbreviate “webcam”. Furthermore, both\nBitRAT and Revcode set up a table of command strings and command IDs the same way.\nThe command string gets passed to a function that returns a DWORD pointer, which is\ndereferenced to set the command ID. The only difference between the two in the command\ntext and the lack of string encryption in Revcode.\n\nBitRAT’s command list initialization\n\n\n-----\n\nRevcode’s command list initialization\n\n### Audio recording\n\n[BitRAT and Revcode both use A. Riazi’s Voice Recording library for recording audio from](https://www.codeproject.com/Articles/10138/Voice-Recording-Playing-back-using-simple-classes)\nmachines infected by it. The only difference is that in BitRAT the debugging strings are\nstripped out while they are present inside Revcode.\n\nCVoiceRecording::Record in BitRAT\n\n\n-----\n\nCVoiceRecording::Record in Revcode\n\n### Other shared strings\n\nSome tag strings presumably for formatting data for communication are common between\nthe two.\n\nDecrypted BitRAT strings\n\n\n-----\n\nStrings from the Revcode binary\n\n## Conclusion\n\nGiven the findings above, it should be fairly evident that BitRAT is a successor to Revcode’s\nBoost payload. Sadly, UnknownProducts’ bid to remain unknown did not work out too well\ndue to the practice of code reuse. While it is possible that the relationship is based only on\ncode-sharing, the combination of the matching timezone makes this unlikely to be the case.\nRevcode dropped around March 2019, and in April 2019, UnknownProducts posted the\ninitial development thread for BitRAT. The product was finally released in June, suggesting\nthat Revcode’s Boost and non-Boost codebase were split into two, one for sales as\nRevcode and one for sales as BitRAT. This split was probably done to increase sales and\nmarket presence and to allow the aggressive marketing of illicit features such as HVNCs\nand remote browsers, which are meant exclusively for fraud.\n\nView Comments ...\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-09-04 - BitRAT pt. 2- Hidden Browser, SOCKS5 proxy, and UnknownProducts Unmasked.pdf"
    ],
    "report_names": [
        "2020-09-04 - BitRAT pt. 2- Hidden Browser, SOCKS5 proxy, and UnknownProducts Unmasked.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535733,
    "ts_updated_at": 1743041141,
    "ts_creation_date": 1653710778,
    "ts_modification_date": 1653710778,
    "files": {
        "pdf": "https://archive.orkl.eu/47cf7584f5762db2b2f7095b59c89d7dda3e4ae7.pdf",
        "text": "https://archive.orkl.eu/47cf7584f5762db2b2f7095b59c89d7dda3e4ae7.txt",
        "img": "https://archive.orkl.eu/47cf7584f5762db2b2f7095b59c89d7dda3e4ae7.jpg"
    }
}