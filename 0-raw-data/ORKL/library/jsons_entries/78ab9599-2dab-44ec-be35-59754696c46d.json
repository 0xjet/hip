{
    "id": "78ab9599-2dab-44ec-be35-59754696c46d",
    "created_at": "2023-01-12T15:09:39.124318Z",
    "updated_at": "2025-03-27T02:16:34.806699Z",
    "deleted_at": null,
    "sha1_hash": "d383908f64340f9171d0badc8debc81b712f06d1",
    "title": "2021-04-27 - Abusing Replication- Stealing AD FS Secrets Over the Network",
    "authors": "",
    "file_creation_date": "2022-05-27T21:32:26Z",
    "file_modification_date": "2022-05-27T21:32:26Z",
    "file_size": 94612,
    "plain_text": "# Abusing Replication: Stealing AD FS Secrets Over the Network\n\n**[fireeye.com/blog/threat-research/2021/04/abusing-replication-stealing-adfs-secrets-over-the-network.html](https://www.fireeye.com/blog/threat-research/2021/04/abusing-replication-stealing-adfs-secrets-over-the-network.html)**\n\nThreat Research\n\nDouglas Bienstock\n\nApr 27, 2021\n\n10 mins read\n\nThreat Research\n\nOrganizations are increasingly adopting cloud-based services such as Microsoft 365 to host\napplications and data. Sophisticated threat actors are catching on and Mandiant has\nobserved an increased focus on long-term persistent access to Microsoft 365 as one of their\nprimary objectives. The focus on developing novel and hard to detect methods to achieve\n\n\n-----\n\nthis goal was highlighted with the recent detection of UNC2452 and their access to Microsoft\n365. One of this group's key TTPs was to steal the Token Signing Certificate from an\norganization’s AD FS server to enable them to bypass MFA and access cloud services as\nany user, at any time. While defenders previously associated the defense of this certificate,\nand thus the entire ecosystem, with careful access control and detection efforts around the\nAD FS server and service account, this is no longer sufficient. In this blog post we will show\nhow a threat actor, with the right privilege, can extract the encrypted Token Signing\nCertificate from anywhere on the internal network. Once extracted, a threat actor can easily\ndecrypt it and begin accessing cloud services.\n\n**Active Directory Federation Services**\n\nActive Directory Federation Services (AD FS) is a feature for Windows Servers that enables\nfederated identity and access management. It is often used by organizations to provide\nsingle sign-on functionality to access enterprise applications such as Microsoft 365. In\ntechnical terms, AD FS functions as an Identity Provider (IdP) and Microsoft 365 is a\n**Service Provider (SP). We’ll use Microsoft 365 as an example going forward, but this**\ntechnique could apply to any service that is set up to trust AD FS. AD FS verifies a user’s\nidentity and issues assertions that describe the user. Microsoft 365 trusts AD FS to verify\nuser identities and provide it with assertions. To Microsoft 365, it doesn’t matter how AD FS\nperformed the verification, it just needs the assertions.\n\nIn the typical deployment (Figure 1), AD FS will verify a user’s identity using Active Directory.\nAt a minimum, an AD FS deployment consists of two servers in an enterprise’s on-premises\nnetwork: the primary AD FS server, and an AD FS Web Application Proxy (WAP). The proxy\nis placed in the DMZ and has no functionality besides proxying sign-on attempts from the\nInternet to the AD FS server. The primary AD FS server receives proxied requests, verifies a\nuser’s identity, and issues assertions that are packaged into SAML security tokens for the\nuser.\n\n\n-----\n\nTypical AD FS deployment (source: Microsoft)\n\n\n[Figure 1: Typical AD FS deployment (source: Microsoft)](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/best-practices-securing-ad-fs)\nThe [SAML token issued by AD FS proves a user’s identity to Microsoft 365 and can also be](https://tools.ietf.org/html/rfc7522)\nused to make authorization decisions. The SAML token is an XML document with two main\ncomponents:\n\n1. Assertions: Assertions are XML elements that describe the user’s identity. An\n\nassertion could be a user SID, group membership SIDs, or other elements like the\nuser’s department name. A single SAML token can have multiple assertions attached\nto it.\n2. Digital Signature: The assertions in the SAML token are digitally signed using a\n\npublic/private keypair that resides on the AD FS server. This is called the Token\nSigning Certificate.\n\n\n-----\n\n**The Token Signing Certificate is the bedrock of security in AD FS. Microsoft 365 uses**\nthe digital signature to validate that the SAML token is authentic, valid, and comes from an\nAD FS server that it trusts. To enable this verification, an administrator shares the public\ncomponent of the Token Signing Certificate with Microsoft 365. This is then used to\ncryptographically verify the digital signature in the SAML token and prove authenticity as well\nas integrity of the token. In other words, if a threat actor got hold of a Token Signing\nCertificate, they could generate arbitrary SAML tokens to access any federated application,\nas any user, and even bypass MFA.\n\n**Golden SAML**\n\nGolden SAML was coined in 2017 by CyberArk to describe the technique of forging SAML\n[tokens to access SPs given a valid Token Signing Certificate. At TROOPERS 19, I detailed](https://www.youtube.com/watch?v=5dj4vOqqGZw)\nhow a threat actor could extract the Token Signing Certificate from an AD FS server, as well\nas some mitigation strategies for defenders.\n\nIn a default AD FS configuration, the Token Signing Certificate is stored within a Windows\nInternal Database (WID) instance that is running on the AD FS server. WID is more or less\nMS SQL Express, except the database can only be accessed locally over a special named\npipe connection. In AD FS, the database is further locked down to only the AD FS service\naccount. The Token Signing Certificate is stored in an encrypted state in the\nIdentityServerPolicy.ServiceStateSummary table. Figure 2 contains a single row with a\ncolumn that stores all the settings that AD FS will need on service start as an XML\ndocument.\n\n<SigningToken>\n\n<IsChainIncluded>false</IsChainIncluded>\n\n<IsChainIncludedSpecified>false</IsChainIncludedSpecified>\n\n<FindValue>99FABAEE46A09CD9B34B9510AB10E2B0C0ACB99B</FindValue>\n\n<RawCertificate></RawCertificate>\n\n<EncryptedPfx></EncryptedPfx>\n\n<StoreNameValue>My</StoreNameValue>\n\n<StoreLocationValue>CurrentUser</StoreLocationValue>\n\n<X509FindTypeValue>FindByThumbprint</X509FindTypeValue>\n\n</SigningToken>\n\nFigure 2: Example Token Signing Certificate stored in the AD FS database\n\nThe Token Signing Certificate as it is stored in the AD FS database is encrypted using\nsymmetric key encryption. Windows uses a technology called Distributed Key Management\n(DKM) to store the secret value used to derive the symmetric key in an Active Directory\ncontainer. The AD FS service account can read the attributes of this container, derive the\nsymmetric key, and then decrypt the Token Signing Certificate.\n\n**AD FS Replication**\n\n\n-----\n\nAD FS also supports a farm configuration for high availability and load balancing in larger\nenterprise networks. The individual AD FS servers in a farm can be configured to use unique\nToken Signing Certificates; however, the default is to have the servers share the same Token\nSigning Certificate. In order to stay in sync with each other, the farm will have a primary\nnode and secondary nodes. The secondary nodes make use of a replication service to\nacquire configuration settings and certificates from the primary AD FS server. To facilitate\nthis, AD FS makes use of Windows Communication Foundation (WCF).\n\n[WCF is a framework that allows developers to build service-oriented applications. A WCF](https://docs.microsoft.com/en-us/dotnet/framework/wcf/whats-wcf)\napplication has two components: the service that will receive and process messages, and\nthe client that sends messages to a service and receives back responses. The AD FS\nservers run a WCF service that is called the Policy Store Transfer Service internally.\n\nTo send a message to this service, the client will connect to the URL http://<adfs server\nname>:80/adfs/services/policystoretransfer. Note that even though the channel is over HTTP,\nthe actual data being exchanged is encrypted during transit. It is also key to understand that\nalthough there is a single primary AD FS server, all nodes in an AD FS farm run this WCF\nservice and can be used for replication.\n\nUpon receipt of a message, the WCF service enforces an authorization check to ensure the\ncalling identity is permitted to receive the requested information. The permission check is\ndone by evaluating an authorization policy that is also stored in the\nIdentityServerPolicy.ServiceStateSummary table of the AD FS database. The policy permits\nidentities whose primary SID matches the AD FS Service account or to any identity that is\nmember of the AD FS server’s local administrators group. If the identity of the client passes\nthe authorization check, then the WCF service will send back a message containing the\nrequested information.\n\n<AuthorizationPolicy>\n@RuleName = “Permit Service Account”exists([Type ==\n“http://schemas.microsoft.com/ws/2008/06/identity/claims/\nprimarysid”, Value == “S-1-5-21-3508695881-2242692613\n-376241919-1107”]) => issue(Type = “http://schemas\n.microsoft.com/authorization/claims/permit”, Value = “\ntrue”);\n@RuleName = “Permit Local Administrators”exists([Type ==\n“http://schemas.microsoft.com/ws/2008/06/identity/claims/group\nsid”, Value == “S-1-5-32-544”])=> issue(Type = &quot\n;http://schemas.microsoft.com/authorization/claims/permit”, Value\n= “true”);\n</AuthorizationPolicy>\n\nFigure 3: Default Authorization Policy for AD FS server\n\n**Room for Abuse**\n\n\n-----\n\nA threat actor can abuse the Policy Store Transfer Service to acquire the encrypted Token\nSigning Certificate over the network, similar to the DCSync technique for Active Directory. It\nis important to note that the data is still encrypted and requires the DKM key stored in Active\nDirectory to decrypt. This technique, however, requires a significant change to how\ndefenders have secured AD FS servers and monitored them for theft of the Token Signing\nCertificate.\n\nFirst, previous techniques required code execution on an AD FS server to extract the data or\nat least an SMB connection to transfer the backing database files. With a strong defense in\ndepth program using secure credential management, EDR, and network segmentation, an\nenterprise can make it very difficult for a threat actor to access an AD FS server and the\nToken Signing Certificate. Abusing the AD FS Replication service, however, requires only\naccess to the AD FS server over the standard HTTP port. The default installation of AD FS\nwill even create a Windows Firewall rule to allow HTTP traffic from any system. Additionally,\na threat actor does not need the credentials for the AD FS service account and can instead\nuse any account that is a local administrator on an AD FS server. Lastly, there is no Event\nLog message that is recorded when a replication event occurs on an AD FS server.\nAltogether, this makes the technique both much easier to execute and much harder to\ndetect.\n\nThe authorization policy itself also presents an opportunity for abuse. Because the\nauthorization policy is stored as XML text in the configuration database, a threat actor with\nenough access could modify it to be more permissive. A threat actor could modify the\nAuthorization Policy to include a group SID such as domain users, S-1-5-21-X-513. Similarly,\nthey could add an ACE to the DKM key container in Active Directory. This would allow the\nthreat actor to easily obtain the Token Signing Certificate and decrypt it using any domain\nuser credentials. This would give them persistent ability to perform a Golden SAML attack\nwith only access to the network as a requirement.\n\nMandiant has not yet observed this technique used in the wild; however, it is trivial to write a\nPOC for and we are aware of one public tool that will soon support it. Figure 4 shows the\noutput of POC code written in .NET to extract the Token Signing Certificate from a remote\nAD FS server.\n\n\n-----\n\nPOC code output\n\n\nFigure 4: POC code output\n\n**Mitigations**\n\nThe best mitigation against this technique is to use the Windows Firewall to restrict access to\nport 80 TCP to only the AD FS servers in the farm. If an organization has only a single AD\nFS server, then port 80 TCP can be blocked completely. This block can be put in place\nbecause all traffic to and from AD FS servers and proxies for user authentication is over port\n443 TCP.\n\nTo limit inbound communications, modify the existing firewall rule that AD FS inserts on\ninstallation.\n\nSet-NetFirewallRule -DisplayName \"AD FS HTTP Services (TCP-In)\" -RemoteAddress\n<ADFS1 IP address>,<ADFS2 IP Address>\n\n\n-----\n\nIf no rule exists, the scriptlet in Figure 5 should be applied to all ADFS servers to create one.\n\nNew-NetFirewallRule -DisplayName \"Allow ADFS Servers TCP 80\" -Direction Inbound Action Allow -Protocol TCP -LocalPort 80 -RemoteAddress <ADFS1 IPAddress >,\n<ADFS2 IPAddress>\n\nFigure 5: Windows Firewall - Allow ADFS Server - TCP 80\n\nOrganizations that are monitoring the internal network can alert on HTTP POST requests to\nthe address that hosts the Policy Store Transfer service. If there is an AD FS farm, then the\nIP addresses of the AD FS servers will need to be whitelisted against the rule. Figure 6\nshows a sample Snort rule to detect this activity.\n\nalert tcp any any -> any 80 (msg:\"AD FS Replication\"; flow:established, to_server;\ncontent:\"POST\"; http_method; content:\"adfs/services/policystoretransfer\"; http_uri;\nthreshold:type limit,track by_src,count 1,seconds 3600; priority:3; sid:7000000; rev:1;)\n\nFigure 6: Sample snort rule\n\n**Acknowledgements**\n\nMandiant would like to acknowledge the great work of Dr. Nestori Syynimaa (@DrAzureAD).\nDr. Syynimaa independently thought to research the replication of configuration information\n[between AD FS servers and has published his findings on his blog. Mandiant would also like](https://o365blog.com/)\nto thank Microsoft for their collaboration on mitigations and detections for this technique.\nLastly, special thanks to Mike Burns of the Mandiant Security Transformation services team\nfor his feedback on mitigations and detections.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-04-27 - Abusing Replication- Stealing AD FS Secrets Over the Network.pdf"
    ],
    "report_names": [
        "2021-04-27 - Abusing Replication- Stealing AD FS Secrets Over the Network.pdf"
    ],
    "threat_actors": [
        {
            "id": "b43e5ea9-d8c8-4efa-b5bf-f1efb37174ba",
            "created_at": "2022-10-25T16:07:24.36191Z",
            "updated_at": "2025-03-27T02:02:10.1909Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "Dark Halo",
                "Nobelium",
                "SolarStorm",
                "StellarParticle",
                "UNC2452"
            ],
            "source_name": "ETDA:UNC2452",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "70872c3a-e788-4b55-a7d6-b2df52001ad0",
            "created_at": "2023-01-06T13:46:39.18401Z",
            "updated_at": "2025-03-27T02:00:03.01553Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "DarkHalo",
                "StellarParticle",
                "NOBELIUM",
                "Solar Phoenix",
                "Midnight Blizzard"
            ],
            "source_name": "MISPGALAXY:UNC2452",
            "tools": [
                "SNOWYAMBER",
                "HALFRIG",
                "QUARTERRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1d3f9dec-b033-48a5-8b1e-f67a29429e89",
            "created_at": "2022-10-25T15:50:23.739197Z",
            "updated_at": "2025-03-27T02:00:55.536417Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "UNC2452",
                "NOBELIUM",
                "StellarParticle",
                "Dark Halo"
            ],
            "source_name": "MITRE:UNC2452",
            "tools": [
                "Sibot",
                "Mimikatz",
                "Cobalt Strike",
                "AdFind",
                "GoldMax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "5b748f86-ac32-4715-be9f-6cf25ae48a4e",
            "created_at": "2024-06-04T02:03:07.956135Z",
            "updated_at": "2025-03-27T02:05:17.407352Z",
            "deleted_at": null,
            "main_name": "IRON HEMLOCK",
            "aliases": [
                "ATK7 ",
                "Blue Kitsune ",
                "Cozy Bear ",
                "The Dukes",
                "UNC2452 ",
                "YTTRIUM ",
                "APT29 "
            ],
            "source_name": "Secureworks:IRON HEMLOCK",
            "tools": [
                " CozyCar",
                " CozyDuke",
                " DiefenDuke",
                " FatDuke",
                " HAMMERTOSS",
                " LiteDuke",
                " MiniDuke",
                " OnionDuke",
                " PolyglotDuke",
                " RegDuke",
                " RegDuke Loader",
                " SeaDuke",
                " Sliver",
                "CosmicDuke"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a241a1ca-2bc9-450b-a07b-aae747ee2710",
            "created_at": "2024-06-19T02:03:08.150052Z",
            "updated_at": "2025-03-27T02:05:17.409596Z",
            "deleted_at": null,
            "main_name": "IRON RITUAL",
            "aliases": [
                "Blue Dev 5 ",
                "BlueBravo ",
                "Cloaked Ursa ",
                "CozyLarch ",
                "Dark Halo ",
                "Midnight Blizzard ",
                "NOBELIUM ",
                "StellarParticle ",
                "UNC2452 ",
                "APT29"
            ],
            "source_name": "Secureworks:IRON RITUAL",
            "tools": [
                " Cobalt Strike",
                " EnvyScout",
                " GoldFinder",
                " GoldMax",
                " NativeZone",
                " RAINDROP",
                " SUNBURST",
                " Sibot",
                " TEARDROP",
                " VaporRage",
                "Brute Ratel C4"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f27790ff-4ee0-40a5-9c84-2b523a9d3270",
            "created_at": "2022-10-25T16:07:23.341684Z",
            "updated_at": "2025-03-27T02:02:09.74554Z",
            "deleted_at": null,
            "main_name": "APT 29",
            "aliases": [
                "APT 29",
                "ATK 7",
                "Blue Dev 5",
                "BlueBravo",
                "Cloaked Ursa",
                "CloudLook",
                "Cozy Bear",
                "Dark Halo",
                "Earth Koshchei",
                "Grizzly Steppe",
                "Group 100",
                "ITG11",
                "Iron Hemlock",
                "Iron Ritual",
                "Midnight Blizzard",
                "Minidionis",
                "Nobelium",
                "NobleBaron",
                "Operation Ghost",
                "Operation Office monkeys",
                "Operation StellarParticle",
                "SilverFish",
                "Solar Phoenix",
                "SolarStorm",
                "StellarParticle",
                "TEMP.Monkeys",
                "The Dukes",
                "UNC2452",
                "UNC3524",
                "Yttrium"
            ],
            "source_name": "ETDA:APT 29",
            "tools": [
                "7-Zip",
                "ATI-Agent",
                "AdFind",
                "Agentemis",
                "AtNow",
                "BEATDROP",
                "BotgenStudios",
                "CEELOADER",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobalt Strike",
                "CobaltStrike",
                "CosmicDuke",
                "Cozer",
                "CozyBear",
                "CozyCar",
                "CozyDuke",
                "Danfuan",
                "EnvyScout",
                "EuroAPT",
                "FatDuke",
                "FoggyWeb",
                "GeminiDuke",
                "Geppei",
                "GoldFinder",
                "GoldMax",
                "GraphDrop",
                "GraphicalNeutrino",
                "GraphicalProton",
                "HAMMERTOSS",
                "HammerDuke",
                "LOLBAS",
                "LOLBins",
                "LiteDuke",
                "Living off the Land",
                "MagicWeb",
                "Mimikatz",
                "MiniDionis",
                "MiniDuke",
                "NemesisGemina",
                "NetDuke",
                "OnionDuke",
                "POSHSPY",
                "PinchDuke",
                "PolyglotDuke",
                "PowerDuke",
                "QUIETEXIT",
                "ROOTSAW",
                "RegDuke",
                "Rubeus",
                "SNOWYAMBER",
                "SPICYBEAT",
                "SUNSHUTTLE",
                "SeaDaddy",
                "SeaDask",
                "SeaDesk",
                "SeaDuke",
                "Sharp-SMBExec",
                "SharpView",
                "Sibot",
                "Solorigate",
                "SoreFang",
                "TinyBaron",
                "WINELOADER",
                "WellMail",
                "WellMess",
                "cobeacon",
                "elf.wellmess",
                "reGeorg",
                "tDiscoverer"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536179,
    "ts_updated_at": 1743041794,
    "ts_creation_date": 1653687146,
    "ts_modification_date": 1653687146,
    "files": {
        "pdf": "https://archive.orkl.eu/d383908f64340f9171d0badc8debc81b712f06d1.pdf",
        "text": "https://archive.orkl.eu/d383908f64340f9171d0badc8debc81b712f06d1.txt",
        "img": "https://archive.orkl.eu/d383908f64340f9171d0badc8debc81b712f06d1.jpg"
    }
}