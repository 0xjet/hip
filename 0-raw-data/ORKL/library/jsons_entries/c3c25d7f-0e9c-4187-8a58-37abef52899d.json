{
    "id": "c3c25d7f-0e9c-4187-8a58-37abef52899d",
    "created_at": "2023-01-12T14:59:02.611611Z",
    "updated_at": "2025-03-27T02:05:56.399566Z",
    "deleted_at": null,
    "sha1_hash": "b56b52c6633083b86d32aeebe4139c40b743fd8b",
    "title": "2016-02-02 - DMA Locker- New Ransomware, But No Reason To Panic",
    "authors": "",
    "file_creation_date": "2022-05-28T02:30:18Z",
    "file_modification_date": "2022-05-28T02:30:18Z",
    "file_size": 545974,
    "plain_text": "# DMA Locker: New Ransomware, But No Reason To Panic\n\n**[blog.malwarebytes.com/threat-analysis/2016/02/dma-locker-a-new-ransomware-but-no-reason-to-panic/](https://blog.malwarebytes.com/threat-analysis/2016/02/dma-locker-a-new-ransomware-but-no-reason-to-panic/)**\n\nhasherezade February 3, 2016\n\n[DMA Locker is another ransomware that appeared at the beginning of this year. For now it](https://www.malwarebytes.com/ransomware)\n[has been observed to be active only on a small scale (source) – but we just want to warn you](https://forum.4programmers.net/Hardware_Software/264028-dma_locker_-_zaszyfrowane_pliki)\nthat it exists.\n\n**[[UPDATE] READ ABOUT THE LATEST VERSION OF DMA LOCKER: 4.0](https://blog.malwarebytes.org/threat-analysis/2016/05/dma-locker-4-0-known-ransomware-preparing-for-a-massive-distribution/)**\n\n**UPDATE [4 Feb 2016]: I apologize to everyone misguided by my rush conclusions about the**\n[crypto. After further analysis and consultation with other analysts (special thanks to @fwosar](https://twitter.com/fwosar)\n[and @maciekkotowicz) I confirmed that in reality it is AES in ECB mode. Low entropy was](https://twitter.com/maciekkotowicz)\njust caused by the fact, that it encrypts separately 16 byte chunks, that are small enough to\ngive this effect. Authors of the malware told many lies in their ransom note, but this one was\ntrue, just my mistake. The only way to recover the key is to find the original sample with key\nincluded. My goal is always to provide best quality analysis – this time I failed, but I tried to\nfix it as soon as possible and not let the false information spreading.\n\n## Analyzed samples\n\n[d35344b1f48764ba083e51438121e6a9 – Polish version type 2 (from Jan 2016) <-](https://malwr.com/analysis/OTIwNGI5ZGM4NmMyNDRmYTg5M2QyMmY2ODgwMzQ3Yzc/)\nmain focus of this analysis\n[4190df2af81ece296c465e245fc0caea – English version type 2 (from Jan 2016)](https://malwr.com/analysis/YWZmMzY4OTk0N2E3NDNhZDkzMGE2ZGJlNDc1YWM3YmQ/)\n[6fbd3cdcafd6695c384a1119873786aa – Polish version type 1 (from Dec 2015)](https://www.virustotal.com/en/file/db1696106bb100a1fc10fadc9b93e17f80055604fa53fe3785b64efdabe0a254/analysis/)\n\n_[// Special thanks to malware hunters: @PhysicalDrive0,](https://twitter.com/PhysicalDrive0)_ _[@JAMESWT_MHT and](https://twitter.com/JAMESWT_MHT)_ _[@siri_urz](https://twitter.com/siri_urz)_\n_for their respective help in collecting the samples!_\n\n## Behavioral analysis\n\n\n-----\n\nWhen deployed, the ransomware moves itself into C:\\ProgramData (or C:\\Documents and\n**Settings\\All Users\\Dokumenty\\), renamed to fakturax.exe and drops another, modified**\ncopy: ntserver.exe. File faktura.exe is removed after execution. Depending on its version, it\nmay also drop some other files in the same location.\n\nSymptoms of this ransomware can be recognized by a red window popping up on the\nscreen. So far, it has been observed in two language versions – Polish or English. An\nexample of the English is below:\n\n\n-----\n\nEarlier version comes with a bit different GUI (also Polish or English variant):\n\nIn contrast to other ransomware that are offering a separate decrypter, DMA Locker comes\nwith a decrypting feature built-in. It is available from the GUI with ransom note. If the user\nenters a key (32 characters long) in the text field and clicks the button, the program switches\nto the decryption mode (using supplied key):\n\nThe program is not very stable and may crash during encryption. An older version has been\nobserved to sometimes crash after finishing encryption – but before displaying any info about\nwhat happened, which may be very confusing for the victim. What makes things worse is the\nfact that it does not change file extensions. So, in such a case the only visible symptom will\nbe that the attacked person cannot open some of his/her files.\n\nNewer versions also add keys to the autorun. One is to deploy a dropped copy of the\nprogram, and the other to display a ransom note in TXT format (via notepad). However, the\ncopy of the program (DMALOCK 41:55:16:13:51:76:67:99ntserver.exe) – is not always\ndropped successfully and then only the TXT note may be displayed.\n\n\n-----\n\n## Detection\n\nIt is detected by Malwarebytes Anti-Malware as Ransom.DMALocker:\n\n## Experiment\n\nIn the ransom note, the authors mention that the data is encrypted by AES and RSA. Let’s\nlook at the files.\n\nAfter the first look at encrypted content we can see repetitive patterns and entropy is\nrelatively low.\n\nLeft – raw bytes of original BMP, right – the same BMP encrypted by DMA Locker:\n\nLet’s compare some more files and see how they changed after being encrypted by DMA\nLocker.\n\n**Example 1 – HTML files:**\n\ncomparison of original files:\n\n\n-----\n\ncomparison of the same files encrypted:\n\n**Example 2 – PNG files:**\n\ncomparison of original files:\n\n\n-----\n\ncomparison of the same files encrypted:\n\nAs we can see, when the beginnings of original files are identical, the beginnings of\nencrypted outputs also are. But it seems that encryption is done in some chunks – possibly 8\nor 16 bytes at once. Look at the comparison of PNG files – from 0x10 they have been\nencrypted differently – although they both have zeros at positions 0x10, 0x11…\n\n## Inside\n\nThis ransomware is distributed without any packing and no defense against analysis has\nbeen observed. All the used strings and called API functions are in plain text. In fact, the\nmalware even “helps” the analyst by providing a lot of debug strings describing all it’s\nactivities (original + translation):\n\n\n-----\n\n```\n[+] Plik jest aktualnie zaszyfrowany, pomijanie.. //The file is already encrypted,\nskipping..\n[*] Rozmiar pliku = %I64d bajtow.. //File size = %I64d bytes..\n[+] Rozpoczeto szyfrowanie pliku: %s //Started encrypting the file: %s\n[+] Zakonczono szyfrowanie pliku: %s //Finished encrypting the file: %s\n[+] Rozpoczeto zapisywanie z pamieci do pliku: %s //Started dumping from memory to a\nfile: %s\n[+] Zakonczono zapisywanie z pamieci do pliku: %s //Finished dumping from memory to a\nfile: %s\n[*] Plik jest aktualnie odszyfrowany, pomijanie.. //The file is already decrypted,\nskipping..\n[+] Rozpoczeto deszyfrowanie pliku: %s //Started decrypting file: %s\n[+] Zakonczono deszyfrowanie pliku: %s //Finished decrypting file: %s\nAlokacja, error: %d //Allocation error: %d\nDMA Locker\nOtwieranie pliku: %d //Opening file: %d\n\n```\nThanks to the logs, finding important part of the code is trivial!\n\nAt the beginning of the execution a new thread is deployed – whose role is to check for the\npresence of following processes:\n\nrstrui.exe\nShadowExplorer.exe\nsesvc.exe\ncbengine.exe\n\nIf any of them is detected, malware tries to terminate it. Just after deploying this thread\nmalware logs (in Polish):\n“[+] Blocking processes of system recovery”\n\nInstead of a list of attacked extensions, this malware contains two blacklists. One for\ndirectories:\n\n\n-----\n\nand another for file extensions:\n\nFiles that contain in their path blacklisted substrings are skipped.\n\nMalware enumerates all the files – browsing first logical drives, after that network resources\n– trying to encrypt each and every file (except the blacklisted)\n\nA single flag decides whether the malware is in encryption or decryption mode:\n\n\n-----\n\nEncryption (as well as decryption) is deployed in a new thread:\n\n**Encryption key**\n\nThe encryption key is 32 byte long. In newer version of the malware it is hard-coded at the\nend of the original file, and then read. However, there is a twist.\n\nDuring execution, two copies of the original file are dropped: fakturax.exe and ntserver.exe\n– but only fakturax.exe contains the key – ntserver.exe have it cleaned. After reading the\nkey, fakturax.exe is removed and the key is lost along with it. That’s why, we can easily\n\n\n-----\n\nrecover the key if, by any means, we managed to persist the original copy of the malware\nsample (it is not a problem if we know the source of infection, i.e in case if the malware\narrived as an e-mail attachment).\n\nIn the examined variant of the malware (referred as the type 2, i.e\n[4190df2af81ece296c465e245fc0caea) – it was enough to find the key at the end of the](https://malwr.com/analysis/YWZmMzY4OTk0N2E3NDNhZDkzMGE2ZGJlNDc1YWM3YmQ/)\noriginal sample (*WARNING: this is not the original key of this sample. It has been used\n**_just to present how it works and where the real key can be found. Before trying to_**\n**_recover files, make sure that you made their backup, just in case if in some other_**\n**_editions the algorithm would be different.)_**\n\nand enter it to the text field:\n\nin order to get all the files back.\n\n**Encryption algorithm**\n\nAuthors claimed that they used AES and RSA. How it looks from the side of code?\n\nFile is encrypted chunk by chunk – single unit have 16 bytes (4 DWORDs). The key is 32\nbytes long, and is preprocessed before the encryption. Both elements – the preprocessed\nkey and a chunk of the input file – are copied to a buffer, that is supplied to the encrypting\nprocedure.\n\nBelow – a sample file: square.png processed by the encrypting function. Used key:\n“11111…”. (The copied chunk of the file has been selected on the picture)\n\n\n-----\n\nafter encryption (output marked gray):\n\noutput is then copied back to the original buffer, containing the full file. Every encrypted file\nhas a content prefixed by “ABCXYZ11” – a magic value, used by the ransomware to\nrecognize encrypted files (it has been introduced in the newer version). Below, we can see\nthe sample file after being dumped on the disk.\n\n\n-----\n\n16 byte long chunks of file are encrypted by AES in ECB mode.\n\n## Conclusion\n\nFirst of all, not all what malware authors tell is true. In this case the key was neither RSA\nencrypted, nor randomly generated – just stored in the original file.\n\nSecond – immediately removing the malware is not always the best solution – sometimes we\nmay need it to recover the data.\n\nIf you encountered a ransomware, it is better to try to gather information about it before\ntaking any steps. In case you cannot find any information, the best way is to make a topic on\nthe forum of your favorite vendor or contact some known analyst. We are in a constant\nsearch of samples of new threats, trying to describe and solve the problems.\n\nAnd remember: only some families are really nasty. Other, like i.e [LeChiffre have](https://blog.malwarebytes.org/intelligence/2016/01/lechiffre-a-manually-run-ransomware/)\nimplementation flaws allowing to recover files.\n\n## Appendix\n\nhttps://forum.4programmers.net/Hardware_Software/264028-dma_locker__zaszyfrowane_pliki – a thread on a Polish forum, created by a user infected by DMA Locker\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-02-02 - DMA Locker- New Ransomware, But No Reason To Panic.pdf"
    ],
    "report_names": [
        "2016-02-02 - DMA Locker- New Ransomware, But No Reason To Panic.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535542,
    "ts_updated_at": 1743041156,
    "ts_creation_date": 1653705018,
    "ts_modification_date": 1653705018,
    "files": {
        "pdf": "https://archive.orkl.eu/b56b52c6633083b86d32aeebe4139c40b743fd8b.pdf",
        "text": "https://archive.orkl.eu/b56b52c6633083b86d32aeebe4139c40b743fd8b.txt",
        "img": "https://archive.orkl.eu/b56b52c6633083b86d32aeebe4139c40b743fd8b.jpg"
    }
}