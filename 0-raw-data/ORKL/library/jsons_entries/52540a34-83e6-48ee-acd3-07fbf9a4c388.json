{
    "id": "52540a34-83e6-48ee-acd3-07fbf9a4c388",
    "created_at": "2023-01-12T14:59:57.491127Z",
    "updated_at": "2025-03-27T02:16:25.882928Z",
    "deleted_at": null,
    "sha1_hash": "3961821b8eb467d7bd3db15e949000734b4feee0",
    "title": "2021-03-06 - oleObject1.bin – OLe10nATive – shellcode",
    "authors": "",
    "file_creation_date": "2022-05-27T19:59:00Z",
    "file_modification_date": "2022-05-27T19:59:00Z",
    "file_size": 208420,
    "plain_text": "# oleObject1.bin – OLe10nATive – shellcode\n\n**[clickallthethings.wordpress.com/2021/03/06/oleobject1-bin-ole10native-shellcode/](https://clickallthethings.wordpress.com/2021/03/06/oleobject1-bin-ole10native-shellcode/)**\n\nView all posts by Jamie March 6, 2021\n\nI came across a GuLoader .xlsx document the other day. It didn’t have any VBA or XLM\nmacros, locked or hidden or protected sheets, or anything obvious like that. Instead, this is\nthe only thing I saw in oledump.\n\nIt was a bit odd. So let’s see what it takes to tear apart a document such as this. If you’d like\nto play along, here’s the specimen: **https://app.any.run/tasks/706a2ec9-c993-40e0-811a-**\n**b18358531b24**\n\nA special shout out to **[@ddash_ct! He helped point me in the right direction for extracting the](https://twitter.com/ddash_ct)**\nshellcode.\n\n## oleObject1.bin\n\nUpon unzipping the file, we can find oleobject1.bin inside the XL/EMBEDDINGS folder.\n\nIf you will recall, OLE stands for Object Linking and Embedding. Microsoft documents allow a\nuser to link or embed objects into a document. An object that is linked to a document will\nstore that data outside of the document. If you update the data outside of the document, the\nlink will update the data inside of your new document.\n\nAn embedded object becomes a part of the new file. It does not retain any sort of connection\nto the source file This is perfect way for attackers to hide or obfuscate code inside a\n\n\n-----\n\nmalicious document.\n\n## OLe10nATive stream\n\noledump.py showed that the oleObject1.bin contained a stream called OLe10nATive. These\nare the storage objects that correspond to the linked or embedded objects. That stream is\npresent when data from the embedded object in the container document in OLE1.0 is\nconverted to the OLE2.0 format.\n\nWe can extract this stream by using oledump to select object A1 and dump it to a file.\n\n## Looking for shellcode\n\nNow that we’ve extracted the stream, how are we going to find anything useful in here?\n\nThis is where the advice from @ddash_ct came in handy. He searched this stream output for\na hex string like E8 00 00 00 00 and was able to extract the shellcode from there.\n\nWhy is this the case? And why that pattern?\n\nShellcode cannot assume it will be executed in any particular memory location. It cannot use\nany hard-coded addresses for either its code or data. This means it must be position_independent. A hex string such as E8 00 00 00 00 can be an indicator of where position-_\nindependent code may start. While the example below is not from our sample, the opcode\nE8 00 00 00 00 is translated into the instruction call $+5. This is used to push the current\naddress in memory onto the stack. This can serve as a sort of anchor point for the rest of the\n\n\n-----\n\ncode execution. _This is just an_\n\n_example and is not from the ole10native stream in our sample._\nWe will not find the exact E8 00 00 00 00 pattern in our file. Instead, we can search for a\npattern like 00 00 and something interesting pops up at 0x00265D41.\n\nWhile we do see a similar pattern, there is a significant difference. The opcode E8 is making\na call and will be transferring control to location 0x000000AF. However, the location of AF is\n_relative to E8’s position in memory at run-time. It seems we may have an instance of_\nposition-independent code and it might be where some shellcode is hiding. Got that?\n\nAll this is to say that hex location 0x265D41 is a likely candidate for our purposes.\n\n## Extracting the shellcode\n\nFrom here on out, this will be a very similar process to getting shellcode from .rtf documents.\nWe can load up ole10native.bin in scDbg with a start offset of 0x265D41. We know we’re on\nthe right track because we can see the unhooked call to ExpandEnvironmentStringsW.\n\n\n-----\n\nEarlier blog posts showed that scDbg doesn t work very well with\n_ExpandEnvironmentStringsW. Instead, we can overwrite that with_\n_ExpandEnvironmentStringsA. To do so, we will need to unpack ole10native.bin. We do that_\nby checking the box in scDbg for “Create Dump” and re-launch ole10native.bin using the\nsame start offset of 0x265D41. scDbg will then save the dumped and unpacked file. In my\ncase, it was called OLE10N~1.unpack.\n\nOpen up the newly unpacked dump file and scroll to the bottom. You will see a variety of\ncommands in plaintext. Offset 0x002660D9 begins the command for\n_ExpandEnvironmentStringsW. Overwrite the appropriate location with an A and save the_\nchanges.\n\nBefore we toss this into scDbg again, we are going to need a new start offset. This can be\nfound at the beginning of this part of the shell code. Notice the pattern right before\nk.e.r.n.e.l.3.2. It also follows the E8 00 00 00 00 pattern.\n\nToss our unpacked and edited binary into scDbg and enter 0x00266080 as the start offset.\nAnd when we do, the shellcode commands are revealed.\n\n\n-----\n\nThanks for reading!\n\n**References**\nhttps://support.microsoft.com/en-us/office/linked-objects-and-embedded-objects-0bf81db28aa3-4148-be4a-c8b6e55e0d7c\nhttps://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-oleds/2677fcf2-ad484386-ba8f-b1b7baf4c02f\nhttps://www.forcepoint.com/blog/x-labs/assessing-risk-office-documents-part-2-hide-mycode-or-download-it\nPractical Malware Analysis (the book)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-06 - oleObject1.bin – OLe10nATive – shellcode.pdf"
    ],
    "report_names": [
        "2021-03-06 - oleObject1.bin – OLe10nATive – shellcode.pdf"
    ],
    "threat_actors": [
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535597,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1653681540,
    "ts_modification_date": 1653681540,
    "files": {
        "pdf": "https://archive.orkl.eu/3961821b8eb467d7bd3db15e949000734b4feee0.pdf",
        "text": "https://archive.orkl.eu/3961821b8eb467d7bd3db15e949000734b4feee0.txt",
        "img": "https://archive.orkl.eu/3961821b8eb467d7bd3db15e949000734b4feee0.jpg"
    }
}