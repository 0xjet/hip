{
    "id": "d9ae5524-3c6e-4d3d-855c-8d49c6d89c4b",
    "created_at": "2023-01-12T15:06:47.962423Z",
    "updated_at": "2025-03-27T02:15:35.630698Z",
    "deleted_at": null,
    "sha1_hash": "36ebda0c0b88cd84181e394f48bb0d57a83d938b",
    "title": "2020-12-01 - IceRat evades antivirus by running PHP on Java VM",
    "authors": "",
    "file_creation_date": "2022-05-28T02:22:01Z",
    "file_modification_date": "2022-05-28T02:22:01Z",
    "file_size": 2261545,
    "plain_text": "# IceRat evades antivirus by running PHP on Java VM\n\n**gdatasoftware.com/blog/icerat-evades-antivirus-by-using-jphp**\n\n12/01/2020\n\nG DATA Blog\nIceRat keeps low detections rates for weeks by using an unusual language implementation: JPHP. But there are\nmore reasons than the choice of the compiler. This article explores IceRat and explains a way to analyze JPHP\nmalware.\n\n## Discovery of IceRat\n\nUser [McMcbrad of the](https://malwaretips.com/members/mcmcbrad.89360/) [Malwaretips.com forums discovered the first IceRat samples[5][7]. The malware caught his](https://malwaretips.com/)\ninterest due to the low detection rates on VirusTotal for most related samples. At the time of discovery only 2 to 3\nengines showed a detection despite the samples being a month old.\n\nStatic analysis reveals that most components of IceRat are written in JPHP. This is a PHP implementation that runs\non the Java VM. This implementation uses .phb files instead of Java .class files -- a file type that, as I suspect, is not\ncommonly supported by antivirus products. So far I haven't heard or found any other malware that uses JPHP which\npartially explains the low detection rates on VirusTotal.\n\n\nThe name IceRat is based on the module name of an older sample[11] that McMcbrad found.\n\n## Decompiling JPHP\n\nThere don't seem to be any tools to decompile JPHP code yet. But JPHP has to produce Java Bytecode in order to\nrun in the Java VM. So decompilation to Java code is possible.\n\nUnpacking the executable[5] with 7zip reveals the following structure.\n\n\n-----\n\nAs I noticed after looking at several JPHP samples, the entrypoint for the main JPHP code is under\n**.system\\application.conf (see picture below). So for our klient.exe sample[5] the main code resides in**\n**app\\forms\\rqfdeqwf.phb.**\n\nThe .phb files contain the 0xCAFEBABE magic bytes for Java .class files somewhere down below. Removing the\nfirst part of the file excluding the magic bytes makes it possible to decompile these files into Java code with, e.g.,\nFernflower. The right side of the picture below shows how the file should look like after modification.\n\n\n-----\n\nThe decompiled code is still hard to read. As a first step I restored the strings. All of them are in an array called\n**$MEM. Replacing the array access $MEM[X] with the actual value in the array will improve readability of the code. I**\nachieved this with a python snippet.\n\nAs a second step I replaced methods like assign and concat with operators. E.g., this can be done using regex and\ncapture groups. See table below for replacements. The replacement for one operator must be done several times\nuntil all nested calls are replaced. The order must be preserved.\n\nAll analysed JPHP samples in this article can be decompiled to Java in the same fashion.\n\n**Find** **Replace**\n\nOperatorUtils\\.concat\\(([^,]+),([^\\)]+)\\) \\1 + \\2\n\n\\.assign\\(([^\\)]+)\\) = \\1\n\n\n-----\n\n**Find** **Replace**\n\nMemory\\.assignRight\\((.+),([^)]+)\\); \\2 = \\1\n\n\\.equal\\(([^\\)]+)\\) == \\1\n\n\\.notEqual\\(([^\\)]+)\\) != \\1\n\n\\.concat\\(([^\\)]+)\\) + \\1\n\nStringMemory\\.valueOf\\(([^)]+)\\) \\1\n\n\\.toImmutable\\(\\)\n\nStringFunctions\\.strtolower\\(([^\\)]+)\\) \\1\n\nLongMemory\\.valueOf\\(([^\\)]+)\\) \\1\n\nThere is still room for improvement but after the replacements the resulting code is readable without pain.\n\nCode of\n\nklient.exe[5] before deobfuscation\n\n\n-----\n\nCode of\n\nklient.exe[5] after deobfuscation\n\n## Infection chain and components\n\nIceRat consists of several small components instead of putting all functionality into one file. As a result most of these\nfiles may not attract any attention if their context is missing. E.g., a downloader is only malicious if the downloaded\nfile is malware. If information about the downloaded file is missing and cannot be inferred, there is no reason to\ndetect the downloader as malware.\n\n\nThe chain of infection and related files is in the graphic below. White boxes show non-malicious files. At least four of\nthese files are JPHP EXE files, namely cheats.exe[4], 1.exe[12], klient.exe[5] and klip.exe[7]. The main component of\nIceRat is klient.exe[5].\n\n\n-----\n\nInfection chain and components of IceRat\nAccording to McMcbrad the first IceRat sample came from a malicious document for which he didn't keep a hash or\nfile. The first part of the chain that I could find is Browes.exe[1] which may have been distributed as trojanized\nsoftware download for CryptoTab. Browes.exe is a selfextracting WinRAR archive that drops and executes the\nWindows Cabinet file 1.exe[2].\n\nThe Windows Cabinet file is also a dropper for two more files, namely a non-malicious setup[3] for CryptoTab\nsoftware, and a malware downloader named cheats.exe[4]. CryptoTab is a browser with mining features, but its\ninstallation is not silent. The affected user will see the browser setup window (see image below) which is why I\nassume CryptoTab is provided as a lure. To summarize: The infection chain starts with a downloader in a trojanized\ndropper in a dropper.\n\n\n-----\n\nThe JPHP file cheats.exe[4] has the project name droper (sic). It accesses IceRat's main server to download the\nbackdoor klient.exe[5]. It chooses randomly one of the following names from a list:\n\nSystem\nJawas\nWindowsShell\nexploler\nantiDrw\nantiSsl\nADB\nMicrosoft\nsystem\n\nThen it will write the file into the following locations:\n\n%APPDATA%\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\.<name>.exe\nc:\\Windows\\Temp\\.<name>.exe\nd:\\Windows\\Temp\\<name>.exe\n\nThis file, klient.exe, is the main component that will be controlled by the server.\n\n## Command and Control\n\nAlthough the name IceRat indicates a remote access trojan, the current malware is better described as a backdoor.\nFeatures for actual remote control, e.g., moving the mouse or typing the keyboard, are missing.\n\n\nThe command and control happens by periodically checking the contents of certain files on the malware server. E.g.\n**klient.exe[5] will check the content of the file hxxp://malina1306.zzz.com.ua/dow_stil.txt. If that file contains a line**\nthat matches the string <MAC>:<OS>:<RAM>:<processor>:<username> for the infected system (see image\nbelow), klient.exe will download the stealer[6] from hxxp://malina1306.zzz.com.ua/stel.exe and save it to\n**c:\\Windows\\Temp\\.Browser.exe.**\n\nSimilarly, a coinminer downloader[7] will be obtained if hxxp://malina1306.zzz.com.ua/dow_klip.txt has a\ncorresponding line for the infected system. It will be downloaded from hxxp://malina1306.zzz.com.ua/klip.exe to\n**c:\\Windows\\Temp\\.Chrome.exe.**\n\n\nThe file 1.exe[12] is downloaded from hxxp://malina1306.zzz.com.ua/1.exe or hxxp://bests.zzz.com.ua/1.exe and\nsaved under a randomly generated name by creating a random number between 10000 and 1000000. The resulting\nfile location is c:\\Windows\\Temp\\.<10000-1000000>.exe. This component communicates via Telegram to the\nmalware operator.\n\n\n-----\n\nTwo more files are referenced in klient.exe but don t exist anymore: hxxp://malina1306.zzz.com.ua/min.exe would be\ndownloaded to c:\\Windows\\Temp\\.Jawaw Se binar.exe. hxxp://malina1306.zzz.com.ua/klog.exe would be\ndownloaded to c:\\Windows\\Temp\\.Windows Push.exe. Based on the filenames one would assume that min.exe\nshould be the coinminer whereas klip.exe rather sounds like a clipbanker. But that was not provided by the server.\n**klog.exe might have been a keylogger.**\n\nListing\n\nof infected clients, format: <MAC>:<OS>:<RAM>:<processor>:<username>. The MAC address is obfuscated by us.\n\n## Stealer and coinminer\n\nUnlike other IceRat components the stealer[6] is written in Python 3 and was compiled with PyInstaller to an EXE file.\nIt steals credentials from the following browsers:\n\nFirefox\nYandex\nFilezilla\nChrome\nAmigo\nkometa\nOrbitum\nChromium\nK-Melon\n\nThe coinminer downloader obtains the configuration file MMMMMM.MMMM[8], the driver WinRing0x64.sys[10] by\nOpenLibSys.org, as well as the coinminer Winlogin.exe[9] from hxxp://malina1306.zzz.com.ua/p/. The configuration\nshows the user dimargo2003@gmail.com.\n\n\nAt the time of writing this article the stealer and the coinminer are well-detected with more than 40 detections on\nVirustotal. This is a remarkable contrast to the low detection rates of the JPHP components.\n\n\n-----\n\nDetection rate of Telegram communicator[12] (top) is much lower than the coinminer[9] (bottom), although the\ncoinminer was scanned 1.5 weeks ago\n\n## Hosting domain\n\nThe malware host and CnC server hxxp://malina1306.zzz(.)com.ua also provides a Russian website with two buttons\nand a text field. The field seems to require a username because the text is translated to \"Enter User\". The buttons\nsay \"Download miner (v1)\" and \"Download miner (v2)\".\n\n## Severity and targeted regions\n\n\n-----\n\nIceRat has gone unnoticed for longer than usual. I attribute this mainly to the choice of using JPHP as well as the\nfragmentation of the malware's features into many small files. \"Small\" does not mean the size of the files here. These\nare comparably large because they carry the JPHP runtime with them. \"Small\" rather refers to the amount of features\nthey have or capability of the code. If one file does only little on its own, it won't show malicious behaviour to an\nautomated analysis system. That way it stays undetected.\n\nThe log files that are used to communicate with the server contain more than 200 entries with different systems.\nMany usernames of the infected systems are kyrillic which indicates that mostly East European and Russian regions\nare affected.\n\nAntivirus engines may have to upgrade their engines to support .phb files as well as take a holistic approach for\nautomated analysis systems to detect fragmented malware.\n\n## Indicators of compromise\n\n**Description** **Filename** **SHA256**\n\n\n\n[1] PE SFX\ncontaining [2]\n\n[2] Windows\nCabinet file,\ncontaining [3]\n\n[4]\n\n[3] CryptoTab\nsetup file\n\n[4] Backdoor\ndownloader,\nJPHP\n\n[5] IceRat\nbackdoor,\nJPHP\n\n[6] Stealer,\nPython\n\n[7] Coinminer\ndownloader,\nJPHP\n\n[8] Miner\nconfig, JSON\nfile\n\n\nBrowes.exe 6a7cc0ab2cfaa9457f47d5e21ef41e56800b37d7e5bfe69b296545bff95fdf96\n\n1.exe 592c60435099477a2656784f28dd31523a91ebf9dd348827d9120a4b411ab6c9\n\nBrowserSetup.exe 3c63d911e4f911f2ba6f411e93ba850091aac9c6c4c962eee914358ac1ac8e0c\n\ncheats.exe 0161540edfceb643389a28ebe7d1092639596325e8f40defe52192ab999d3d36\n\nklient.exe cebee34d5f0292befca058537bf2320dd1492afa26fb9af471155c9332046320\n\nstel.exe fdff65ae03fab7bfd6f943833bf7aa16f6ada9219786995df9ef7127ab9aa93d\n\nklip.exe 06a10cf99cc7c2d2ebc3e41300404e8f5816eb31a869d22835ade3a381199c0b\n\nMMMMMM.MMMM c0a3b67b4056aeefd086edbe0c6ccb5fa7835505ef4ebe6220e5f914012e9e32\n\n\n\n[9] Coinminer Winlogin.exe e656c75017a557ad342dfa95d76e1b36b54a004825615f721a5dd51431899e90\n\n\n\n[10]\nWinRing0x64\ndriver\n\n[11] IceRat\nbackdoor,\nolder sample\n\n[12] Telegram\ncommunicator,\nJPHP\n\n\nWinRing.sys 11bd2c9f9e2397c9a16e0990e4ed2cf0679498fe0fd418a3dfdac60b5c160ee5\n\nIceRat.exe 29c63169ffc5dfacef9245c0f3afae987525f9b164a17133e51f598d3b75120d\n\n1.exe 8a3dd23d0d47114c06ace407b93a3403e33b8cb2e243a548f4c7158b4d340165\n\n\n-----\n\n**Karsten Hahn**\nMalware Analyst\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-12-01 - IceRat evades antivirus by running PHP on Java VM.pdf"
    ],
    "report_names": [
        "2020-12-01 - IceRat evades antivirus by running PHP on Java VM.pdf"
    ],
    "threat_actors": [
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536007,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1653704521,
    "ts_modification_date": 1653704521,
    "files": {
        "pdf": "https://archive.orkl.eu/36ebda0c0b88cd84181e394f48bb0d57a83d938b.pdf",
        "text": "https://archive.orkl.eu/36ebda0c0b88cd84181e394f48bb0d57a83d938b.txt",
        "img": "https://archive.orkl.eu/36ebda0c0b88cd84181e394f48bb0d57a83d938b.jpg"
    }
}