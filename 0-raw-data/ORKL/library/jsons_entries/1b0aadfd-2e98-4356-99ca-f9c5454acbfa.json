{
    "id": "1b0aadfd-2e98-4356-99ca-f9c5454acbfa",
    "created_at": "2023-01-12T14:58:56.888103Z",
    "updated_at": "2025-03-27T02:06:05.603072Z",
    "deleted_at": null,
    "sha1_hash": "3bf21e3b576d0ea4087e39f6b99c6584a18c4325",
    "title": "2018-11-05 - Let's Learn- In-Depth Reversing of Hancitor Dropper-Loader- 2016 vs 2018 Malware Progression",
    "authors": "",
    "file_creation_date": "2022-05-28T04:40:09Z",
    "file_modification_date": "2022-05-28T04:40:09Z",
    "file_size": 339374,
    "plain_text": "# Let's Learn: In-Depth Reversing of Hancitor Dropper/Loader: 2016 vs 2018 Malware Progression\n\n**[vkremez.com/2018/11/lets-learn-in-depth-reversing-of.html](https://www.vkremez.com/2018/11/lets-learn-in-depth-reversing-of.html)**\n\n## Goal: Analyze the latest Hancitor variant (build \"25xce10\") to determine dropper and downloader malware progression in time from 2016 to the latest version in 2018.\n Source:\n Original Packed Hancitor Loader 32-Bit (x86) (MD5: 0cabdc2d4b83cd8b210fd2bd15d54bdc)\n Unpacked Hancitor Dropper & Loader 32-Bit (x86) (MD5: fc7748f302a1566c27568e094873817a)\n\n Outline\n```\nI. Background\nII. Original Packed Hancitor Loader 32-Bit (x86)\nIII. Unpacked Hancitor Dropper & Loader 32-Bit (x86)\nA. Hancitor MainThreadProcessor\nB. Hancitor SystemInfo Generation\nC. Hancitor RC4 CryptDecrypt Routine\nIV. Yara Signature\n\n I. Background\n The group behind Hancitor distribution campaigns remains to be one of the more resourceful\n\n```\n\n-----\n\n## and sophisticated cybercrime loader-as-a-service group delivering various payloads - ranging from simple credential stealer malware to point-of-sale and banking malware variants (from Pony Stealer, EvilPony Stealer, AZORult Stealer to Neverquest Banker, Panda Banker, Gozi ISFB Banker, and Danabot Banker). One of the most interesting malware analysis revolves around source code-level analysis malware development progression in time. I highly recommend reading this article on Hancitor titled \"A Closer Look At Hancitor\" written by Nick Hoffman and Jeremy Humble. I will utilize the malware sample from this article to compare against one of the latest Hancitor variants (h/t to @malware_traffic for the latest sample). Additionally, I recommend reading @benkow_'s blog titled \"Hancitor Panel Overview\" to learn more about the Hancitor panel. II. Original Packed Hancitor Loader 32-Bit (x86) The Hancitor malspam email chain included the first-stage loader as a malicious Microsoft Word document requiring a victim to enable macros to view the fax message as if it is from a legitimate company HelloFax.\n\n III. Unpacked Hancitor Dropper & Loader 32-Bit (x86) By and large, while the group behind the malware is rather experienced and persistent, the Hancitor dropper remains to be a simple and unsophisticated dropper and loader type of malware that comes with little development from 2016. Some of the notable lack of development and adjustment includes its reliance on ANSI API calls as well as unsophisticated WriteProcessMemeory injection method, modified %TEMP% run method with joined function on CreateProcessA rather than as a separate function, absence of Winhost32.exe check logic and its derivative functions, additional error check on CreateProcessA and exception handling, improved parser function before\n\n\n-----\n\n## WriteProcessMemory injection, joined injection function, no deletion logic, different initial and entry function. The reviewed 2016 Hancitor dropper version contains 66 functions with the size of 20.00 KB (20480 bytes), while the latest 2018 Hancitor version consists of 51 functions with the size of 20.50 KB (20992 bytes). During pseudo source-code level analysis, it is revealed that the code contains 8 partial function matches (including perfect match, same MD index and constants, strongly connected components, and similar small pseudo-code), 34 unreliable function matches (including perfect match, same MD index and constants, strongly connected components, similar small pseudo-code, strongly connected components small- primes-product, and loop count). The notable differences include the absence of the connectivity check in the latest version. For example, the 2016 version contained tried to see if it can reach google.com as part of its logic. Moreover, the 2016 version did not contain the RC4 encryption with RtlDecompressBuffer API call to decode the next stage as opposed to the 2018 variant. The \"e\" command appears to be a new one relative to the 2016 version. A. Hancitor MainThreadProcessor In this case, I am looking into the Hancitor build \"25xce10\". The Hancitor malware receives multiple commands that it leverages for parsing and executing additional steps. The commands and their execution are separated by \":\", and the URLs, for example, are separated with \"|\" symbol.\n\n Hancitor has logic to parse the following commands:\n\n Command Description\n\n \"r\" Download and execute .DLL or .EXE\n\n \"l\" Download and execute .EXE in separate thread (arg=1)\n\n \"e\" Download and execute .EXE in separate thread (arg=0)\n\n \"b\" Download and inject code into svchost.exe\n\n \"d\" N/A (not implemented; used to delete itself in older version)\n\n \"c\" N/A (not implemented)\n\n\n-----\n\n## \"n\" N/A (not implemented)\n```\nThe full pseudo-coded Hancitor main command processor function is as follows:\n\n```\n\n-----\n\n```\n////////////////////////////////////////////////////////////////////////////////\n//////////// Hancitor MainThreadProcessor //////////////////////////////////////\n////////////////////////////////////////////////////////////////////////////////\nsigned int __cdecl HancitorMainCommandProcessor(int cmd, signed int *a2)\n{\n if ( *(_BYTE *)(a1 + 1) == ':' )\n {\n  switch ( *(_BYTE *)cmd )\n  {\n   case 'r': \n// \"r\" command -> download and execute .DLL or .EXE \n// if .DLL -> via rundll32.exe, $s,f1 in %TEMP% or if .EXE -> CreateProcessA\n*a2 = RtlDecompressBuffer_GetTemp_rundll32(cmd + 2);\n    return 1;\n   case 'l':\n// \"l\" command -> download and execute .EXE in separate thread (arg=1)\n// check for \"MZ\" header, call VirtualAlloc and/or dynamic API resolution\n    v3 = RtlDecompress_CreateThread(cmd + 2, 1);\n    goto LABEL_5;\n   case 'e':\n// \"e\" command -> download and execute .EXE in separate thread (arg=0)\n// check for \"MZ\" header, call VirtualAlloc and/or dynamic API resolution\n    v3 = RtlDecompress_CreateThread(cmd + 2, 0);\nLABEL_5:\n    *a2 = v3;\n    result = 1;\n    break;\n   case 'b':\n// \"b\" command -> download and inject code into svchost.exe\n// check for \"MZ\" header, call allocate memory and write code into the memory\n*a2 = RtlDecompressBuffer_Call_svchost_injection(cmd + 2);\n    result = 1;\n    break;\n   case 'n':\n// \"n\" command -> no processor for this command\n*a2 = 1;\n    result = 1;\n    break;\n   default:\n    goto LABEL_9;\n  }\n }\n else\n {\nLABEL_9:\n  result = 0;\n }\n\n```\n\n-----\n\n```\n return result;\n}\n\n## B. Hancitor SystemInfo Generation By and large, the Hancitor malware collects generic information regarding the host that includes various information filled into the formatted collector string:\n GUID=%I64u&BUILD=%s&INFO=%s&IP=%s&TYPE=1&WIN=%d.%d(x32|64)\n The shortened pseudo-coded C++ Hancitor SystemInfo function is as follows:\n\n```\n\n-----\n\n```\n////////////////////////////////////////////////////////////////////////////////\n//////////// Hancitor MainThreadProcessor //////////////////////////////////////\n////////////////////////////////////////////////////////////////////////////////\n signed int __cdecl SystemInfo(int a1, int a2, int a3)\n{\n version_ret = GetVersion();\n bot_id = qword_1E6178;\n win_version = version_ret;\n build_bot_1 = HIDWORD(qword_1E6178);\n if ( !qword_1E6178 )\n {\n  LODWORD(v7) = Adapteers_GetWindowsDirectoryA();\n  build_bot_1 = HIDWORD(v7);\n  bot_id = v7;\n  qword_1E6178 = v7;\n }\n GetComputerNameA_0((signed int)&comp_name);\n ExternalAPI_resolution(v8, bot_id, (int)&external_ip);\n win_version_1 = (unsigned __int8)win_version;\n check_if_x64 = GetNativeSystemInfo() == 1;\n comp_name_info = pbData_1;\n if ( check_if_x64 )\n {\n  if ( !pbData_1 )\n  {\n   pbData_1 = GetProcessHeap_0(0x2000);\n   func1(pbData_1, (char *)&unk_1E4018, 0x2000);\n   Crypto_func(pbData_1, 0x2000, (int)&pbData_key, 8);\n   comp_name_info = pbData_1;\n  }\n  wsprintfA(\n   &formatted_systeminfo,\n   \"GUID=%I64u&BUILD=%s&INFO=%s&IP=%s&TYPE=1&WIN=%d.%d(x64)\",\n    bot_id,\n    build_bot_1,\n    comp_name_info,\n   &comp_name,\n   &external_ip,\n    win_version_1,\n   HIBYTE(win_version));\n }\nC. Hancitor RC4 CryptDecrypt Routine\nThe Hancitor dropper heavily utilizes RtlDecompressBuffer and Crypto API to decrypt\nits payloads. Rather than relying on custom decryption, the malware simply implements\nthe RC4 decryption logic.\n\n```\n\n-----\n\n## IV. Yara Signature\n\n\n-----\n\n```\nimport pe \nrule crime_win32_hancitor_dropper {\n  meta:\n   author = \"@VK_Intel\"\n   reference = \"Detects Hancitor Dropper/Loader\"\n   date = \"2018-11-04\"\n   hash1 = \"c61f929981c573e43dd08f0c5a047ba3a3167436b493df819461d4e7953a91ed\"\n  strings:\n   $s1 = \"Rundll32.exe %s,f1\" fullword ascii\n   $s2 = \"explorer.exe\" fullword ascii\n   $s3 = \"Mozilla/5.0 (Windows NT 6.1; Win64; x64; Trident/7.0; rv:11.0) like\nGecko\" fullword ascii\n   $s4 = \"GUID=%I64u&BUILD=%s&INFO=%s&IP=%s&TYPE=1&WIN=%d.%d(x64)\" fullword ascii\n   $s5 = \"GUID=%I64u&BUILD=%s&INFO=%s&IP=%s&TYPE=1&WIN=%d.%d(x32)\" fullword ascii\n   $s6 = \"http://api.ipify.org\" fullword ascii\n   $s7 = \"Content-Type: application/x-www-form-urlencoded\" fullword ascii\n   $crypt_sysfunction = { 8d ?? ?? ?? ?? ?? 50 e8 ?? ?? ?? ?? 8d ?? ?? 50 e8 ?? ??\n?? ?? 0f b6 c3 83 c4 08 c1 eb 08 89 ?? ?? 0f b6 db e8 ?? ?? ?? ?? 83 f8 01 a1 ?? ??\n?? ?? 75 ?? 85 c0 75 ?? 68 00 20 00 00 e8 ?? ?? ?? ?? 68 00 20 00 00 68 18 40 1e 00\n50 a3 ?? ?? ?? ?? e8 ?? ?? ?? ?? 6a 08 68 10 40 1e 00 68 00 20 00 00 ff ?? ?? ?? ??\n?? e8 ?? ?? ?? ?? a1 ?? ?? ?? ?? 83 c4 20}\n   $external_ip_resolution = { 55 8b ec 51 80 ?? ?? ?? ?? ?? ?? 75 ?? 8d ?? ?? 50\n6a 20 68 80 61 1e 00 68 c4 31 1e 00 e8 ?? ?? ?? ?? 83 c4 10 83 f8 01 75 ?? 8b ?? ??\nc6 ?? ?? ?? ?? ?? ?? 68 80 61 1e 00 ff ?? ?? ff ?? ?? ?? ?? ?? b8 01 00 00 00 8b e5\n5d c3 68 dc 31 1e 00 ff ?? ?? c6 ?? ?? ?? ?? ?? ?? ff ?? ?? ?? ?? ?? 33 c0 8b e5 5d\nc3}\n   $main_cmd_processor = { 55 8b ec 8b ?? ?? 80 ?? ?? ?? 75 ?? 0f ?? ?? 83 c0 9e\n83 f8 10 77 ?? 0f ?? ?? ?? ?? ?? ?? ff ?? ?? ?? ?? ?? ?? 8d ?? ?? 50 e8 ?? ?? ?? ??\n8b ?? ?? 83 c4 04 89 ?? b8 01 00 00 00 5d c3 6a 01 8d ?? ?? 50 e8 ?? ?? ?? ?? 8b ??\n?? 83 c4 08 89 ?? b8 01 00 00 00 5d c3 6a 00 eb ?? 8d ?? ?? 50 e8 ?? ?? ?? ?? 8b ??\n?? 83 c4 04 89 ?? b8 01 00 00 00 5d c3 8b ?? ?? c7 ?? ?? ?? ?? ?? b8 01 00 00 00 5d\nc3 33 c0 5d c3}\n  condition:\n   ( uint16(0) == 0x5a4d and\n     filesize < 60KB and\n     pe.imphash() == \"9ea0470ccffd0a7ac8dd70e0968d3e95\" and\n     ( all of them )\n   or 5 of ($s*) and ( $main_cmd_processor ) or ( $crypt_sysfunction and\n$external_ip_resolution ) )\n   }\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-11-05 - Let's Learn- In-Depth Reversing of Hancitor Dropper-Loader- 2016 vs 2018 Malware Progression.pdf"
    ],
    "report_names": [
        "2018-11-05 - Let's Learn- In-Depth Reversing of Hancitor Dropper-Loader- 2016 vs 2018 Malware Progression.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535536,
    "ts_updated_at": 1743041165,
    "ts_creation_date": 1653712809,
    "ts_modification_date": 1653712809,
    "files": {
        "pdf": "https://archive.orkl.eu/3bf21e3b576d0ea4087e39f6b99c6584a18c4325.pdf",
        "text": "https://archive.orkl.eu/3bf21e3b576d0ea4087e39f6b99c6584a18c4325.txt",
        "img": "https://archive.orkl.eu/3bf21e3b576d0ea4087e39f6b99c6584a18c4325.jpg"
    }
}