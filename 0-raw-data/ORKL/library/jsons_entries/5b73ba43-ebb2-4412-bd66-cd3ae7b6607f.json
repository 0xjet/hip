{
    "id": "5b73ba43-ebb2-4412-bd66-cd3ae7b6607f",
    "created_at": "2023-01-12T15:02:55.712454Z",
    "updated_at": "2025-03-27T02:08:00.099645Z",
    "deleted_at": null,
    "sha1_hash": "1f76a6e89ab6850e090f0f6683baf34174e1f6eb",
    "title": "2018-12-18 - Scumbag Combo- Agent Tesla and XpertRAT",
    "authors": "",
    "file_creation_date": "2022-05-28T03:29:11Z",
    "file_modification_date": "2022-05-28T03:29:11Z",
    "file_size": 579790,
    "plain_text": "# Scumbag Combo: Agent Tesla and XpertRAT\n\n**labs.k7computing.com/**\n\nBy K7 Labs December 18, 2018\n\nUnity is strength ‚Äì this age old adage is true for just about everyone, even the bad guys.\n\nIt has become a common practice for threat actors to work in tandem for various reasons,\nviz. better chances of evading detection, increased magnitude or sophistication of the\nattack, etc., all of which are means to higher ill-gotten gains. And the availability of\n(malicious) source code on popular platforms like GitHub, Pastebin, etc. only makes life\neasier for these cyber criminals.\n\nWith this blog post we are going to explain one such recent ‚Äúcollaboration‚Äù which we would\nlike to dub ‚ÄúThe Scumbag Combo‚Äù, a true story of two malware families coming together to\nvictimize the innocent and vulnerable.\n\nFirst, an introductory pictorial representation of the infection flow (Figure 1) before going\ninto the morbid details.\n\nFigure 1: Infection flow\n\n\n-----\n\nIt all starts with a spam email containing an XLSX attachment that exploits the Microsoft\n[Equation Editor‚Äôs remote code execution vulnerability (CVE-2017-11882) to download the](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-11882)\nfile vbs.exe hosted on an open directory (Figure 2), save it as svchost.exe under\n_%AppData% directory and automatically execute it. That covers half the picture and is_\nfairly standard stuff, but then the rest gets pretty interesting.\n\nFigure 2: Open\n\ndirectory\nOn execution, this fake svchost.exe decrypts the code responsible for the delivery of the\naforementioned scumbags into allocated heap memory, and transfers the control to it\n(Figure 3).\n\nFigure 3: Decryption routine\nThis decrypted code then continues to construct an import table for APIs to be used later.\nAdditionally, it also checks for the presence of malware analysis and debugging tools\n(Figure 4), as well as anti-malware processes (Figure 5).\n\n\n-----\n\nanalysis and debugging tools\n\nmalware processes\nIt further looks for the following anti-malware processes:\n\n**avp.exe**\n**bdwtxag.exe**\n**bdagent.exe**\n**dwengine.exe**\n**avastui.exe**\n\nIf any of the aforementioned processes are found it terminates itself.\n\n\nFigure 4: Malware\n\nFigure 5: Anti\n\nIf suitably assuaged, it continues to create a folder called ‚Äúfolder‚Äù under %AppData% and\ncopies itself to this location as folder.exe (Figure 6).\n\nFigure 6: Self-copy as folder.exe\nAs the next step it decrypts a PE file LUCKYGUY2NEW.exe (Figure 7) into allocated heap\nmemory, drops it under the %temp% folder, and executes it using the API ShellExecuteW.\n\n\n-----\n\nFigure 7: Decrypting LUCKYGUY2NEW.exe\nThis binary, LUCKYGUY2NEW.exe, which is found to be an MSIL file, is the first of the\nscumbag duo to get onto the compromised system: Agent Tesla. It has keylogging, screen\nand video capturing, and password stealing capabilities. The password stealing module\ncan extract saved passwords (Instagram, Twitter, Gmail, Facebook, etc.) from various\nbrowsers (Figure 8), mails and FTP clients.\n\nFigure 8: MSIL\n\nmethods used for stealing passwords\n\n\n-----\n\nHaving delivered the Agent Tesla component, svchost.exe goes on to execute its copy\n_folder.exe from within %AppData%\\folder, which orchestrates the dramatic entry of the_\nsecond protagonist of the scumbag show: XpertRAT. After executing folder.exe, the\n_svchost.exe process gets terminated._\n\nNote, persistence of folder.exe is handled by a VB script folder.vbs dropped in the Startup\ndirectory (Figure 9).\n\nFigure 9: VBS in Startup folder\nfolder.exe does a redundant check for traces of the same set of malware\nanalysis/debugging tools and anti-malware processes as depicted in Figures 4 and 5\nabove.\n\nNext it decrypts yet another PE file in yet another blob of heap memory. And if you think\nthat this is the XpertRAT component, well, you are plain wrong. Dumping the file from\nmemory revealed it to be a Visual Basic compiled binary which injects into a legitimate\nMicrosoft Internet Explorer (iexplore.exe) process.\n\nfolder.exe then creates another folder.exe process in a suspended state, injects the\ndecrypted Visual Basic binary into it and resumes the thread (Figure 10). By the way,\nwhat‚Äôs with these guys and the word ‚Äúfolder‚Äù?! No imagination. Sheesh!\n\n\n-----\n\nFigure 10: Injection of the latest decrypted binary\nOnce the injected process begins executing, it spawns the legitimate iexplore.exe process\nin a suspended state, injects its own code into it and resumes the thread. This then\nconnects to a Command and Control server (C&C or C2) to which it sends the\ncompromised system information (Figure 11), and requests for the Remote Access Trojan\n(RAT) component ‚Äì XpertRAT.\n\nFigure 11: C&C communication (compromised system information)\nThe C&C server, after validating the information from the compromised system, will\nrespond with the RAT component ‚Äì passwords.dll, an XpertRAT plugin as depicted in\nFigure 12.\n\n\n-----\n\nFigure 12:\n\nThe XpertRAT plugin ‚Äì image courtesy app.any.run\nThis plugin is used to retrieve all the usernames and passwords (Instagram, Twitter, Gmail,\nFacebook, etc.) stored in various browser caches and emails on the compromised system,\nwhich may then be stored in a text file to be either dispatched to the C&C or accessed\nremotely.\n\nLo and behold, all the actors are now on stage.\n\nBut worry not K7 users, for as always, we have you covered at every single layer of this\nattack! üôÇ\n\n**Security Guidelines**\n\nInstall the latest service packs & hotfixes from Microsoft and enable automatic\nupdate/notification for patches on Windows.\nCultivate the usage of spam filters.\nDo not open any email attachment that looks suspicious or that you weren‚Äôt\nexpecting.\nCheck the email and make sure it is not spoofed before downloading and opening\nany attachments.\nUpgrade all applications to the latest ‚Ä¢ stable versions.\nInstall, enable and regularly update reliable security software such as K7 Total\nSecurity.\n\n**Indicators of Compromise (IoCs)**\n\nFiles:\n\n**Hash** **Component** **K7 Detection**\n\n\n-----\n\n**Hash** **Component** **K7 Detection**\n\n528D53B945516C8F18C63C5B8DF4695E XLSX attachment Trojan (\n0001140e1 )\n\nE0374BCC3615F00CDD9C9E3845A1EB74 svchost.exe / vbs.exe Riskware (\n0040eff71 )\n\n88A93172E9BB75CE8638C36FF744BE55 LUCKYGUY2NEW.exe Trojan (\n0052d5341 )\n\n9F9C272BF3372F6EE920DEAA00926689 folder.vbs Trojan (\n0001140e1 )\n\n\n5C3E2E94AF5622A06D06EAC83CFA4C2B VB file dumped from\nmemory\n\n\nTrojan (\n004be7cd1 )\n\n\n2EEC4FEAAD2D41A806A8D3197A4F538B passwords.dll Trojan (\n0001140e1 )\n\nURLs:\n\nDynamic detection:\n\nBehaviour based detection of folder.exe process injection into iexplore.exe\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-12-18 - Scumbag Combo- Agent Tesla and XpertRAT.pdf"
    ],
    "report_names": [
        "2018-12-18 - Scumbag Combo- Agent Tesla and XpertRAT.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535775,
    "ts_updated_at": 1743041280,
    "ts_creation_date": 1653708551,
    "ts_modification_date": 1653708551,
    "files": {
        "pdf": "https://archive.orkl.eu/1f76a6e89ab6850e090f0f6683baf34174e1f6eb.pdf",
        "text": "https://archive.orkl.eu/1f76a6e89ab6850e090f0f6683baf34174e1f6eb.txt",
        "img": "https://archive.orkl.eu/1f76a6e89ab6850e090f0f6683baf34174e1f6eb.jpg"
    }
}