{
    "id": "a6f58d39-2060-46a9-866d-36e9b4062384",
    "created_at": "2023-01-12T15:07:33.320127Z",
    "updated_at": "2025-03-27T02:06:06.078809Z",
    "deleted_at": null,
    "sha1_hash": "c6a09036c1d86128ebac6c7d36cd2948d167c0ab",
    "title": "2013-06-03 - Alina- Following The Shadow Part 2",
    "authors": "",
    "file_creation_date": "2022-05-28T02:12:17Z",
    "file_modification_date": "2022-05-28T02:12:17Z",
    "file_size": 355137,
    "plain_text": "# Alina: Following The Shadow Part 2\n\n**[trustwave.com/Resources/SpiderLabs-Blog/Alina--Following-The-Shadow-Part-2/](https://www.trustwave.com/Resources/SpiderLabs-Blog/Alina--Following-The-Shadow-Part-2/)**\n\nThis will likely be the final blog post in this series on the Alina Point of Sale (POS) malware\nfamily. If you're just now joining us, please be sure to check out my previous blog posts on\nthis topic, which cover the intricacies of version 4.0, as well as information about how this\nmalware has evolved with respect to exfiltration and command and control (C&C).\n\n[Alina: Casting a Shadow on POS](http://blog.spiderlabs.com/2013/05/alina-shedding-some-light-on-this-malware-family.html)\n[Alina: Following The Shadow Part 1](http://blog.spiderlabs.com/2013/05/alina-following-the-shadow-part-1.html)\n\nFor this final part, I'm going to focus on how this malware is installed, what protections the\nauthor has placed on the malware to prevent Anti-Virus detection and/or reverse\nengineering of it, and how Alina aggregates track data. I may also throw in some other\nrandom tidbits of information that I've encountered depending on how long this blog post\ngoes. My last one in particular was quite lengthy, so I'm going to do my best to avoid that\nthis time around. We're going to be looking at the same versions as before. I've included the\ntimeline graph below as a reference for readers.\n\n\n-----\n\n**Installation**\n\nOverall the malware authors were fairly consistent with regards to how this malware is\ninstalled, as opposed to previous characteristics that we've looked at, where many changes\nwere incorporated in a large number of revisions. I've illustrated the changes witnessed\nthroughout various versions below:\n\n\n-----\n\n**v0.1 / v1.0**\n\nFor the early versions of Alina, the authors followed a simple process for malware\ninstallation. In essence, the malware looks to see if it has been supplied with the 'ALINA=\n<exe_name>' argument, where '<exe_name>' refers to an executable path. If this argument\nis supplied, Alina will not perform the installation procedure, but will instead simply delete\nthis executable name before exiting.\n\nIf Alina started without this argument, it will begin the installation procedure. Alina copies\nitself to the following path:\n%TEMP%\\ALINA_<6_random_letters>.exe\n\nIt then modifies the HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\ALINAhuahs\nregistry key, and writes the location of the previously copied executable. This is a simple\npersistence technique that is encountered regularly when dealing with malicious samples.\nFinally, Alina will call the new executable with the 'ALINA=' argument, and point it to itself,\nensuring the original file is deleted. I'm done my best to demonstrate this process visually\nbelow:\n\n**v2.x / v3.x / v4.x**\n\nStarting with version 2.0, the authors of Alina decided that they needed something a bit\nstealthier regarding how the malware is installed. Specifically, instead of installing the\nmalware to 'ALINA_<6_random_letters>.exe', they instead decided to choose from a pool of\nseven potential malware names. When Alina is installed, it chooses to copy itself to one of\nthe following names within the %TEMP% directory:\n\njava exe\n\n\n-----\n\njusched.exe\njucheck.exe\ndesktop.exe\nadobeflash.exe\nmsupdate.exe\nwindowsfirewall.exe\n\nPersistence once again utilizes the Run registry key, however, the specific name coincides\nwith the chosen malware name. For example, if 'windowsfirewall.exe' was chosen, the\nmalware would install to the 'windowsfirewall' registry key. Additionally, when these versions\nof Alina are installed, the malware will look for previously installed instances and remove\nthem. Once again I've tried to visualize this below:\n\n**v5.x**\n\nWith version 5, we see a number of overall changes to Alina (many of which were covered\nin the previous post). With regard to installation, we see the authors shift away from a\ncompletely random choice of malware names. This likely has to due with the fact that every\ntime Alina ran on the victim machine in versions 2.x-4.x, the malware would essentially\nreinstall, and often chose a different name than previously. It's likely the authors of Alina\nwished instead to chose a random name originally, and then stick with it for the remainder of\nthe malware's existence. In version 5.x, Alina has increased its pool of potential malware\nnames to eleven. Additionally, instead of randomly choosing them every time, Alina utilizes\n\n\n-----\n\nthe victim s volume serial number to decide which name to choose. This ensures a random\nname to begin with, but also ensures that it is consistent every time the system reboots.\nThe following pool of potential malware names is utilized:\n\ndefender.exe\nexplorer.exe\nsvchost.exe\nscvhost.exe\nctfmon.exe\nrundll32.exe\ncmd.exe\ncsrss.exe\ndasHost.exe\nservices.exe\nTaskmgr.exe\n\n**Protections**\n\nLooking at how the protections for Alina have evolved over time has been quite fascinating.\nIt's quite common to see malware that targets Point of Sale devices not employ common\ntechniques seen in the wild, such as packing, crypting, and anti-debugging. As we look at\nAlina over the course of a few months, it becomes clear that the authors attempted to\ncombat some threat that we can only speculate towards. It's possible that Anti-Virus began\ndetecting the samples, which led to them adding protections. Additionally, they may have\nbeen fearful of reverse engineers gaining insight into the inner workings of their malware,\nwhich prompted them to make changes.\n\n\n-----\n\n**UPX**\n\nI'm sure a number of the people reading this blog are familiar with UPX, or the Ultimate\nPacker for eXecutables. UPX is one of the most popular, if not the most popular, packers on\nthe market. Given the fact that it's so popular and (somewhat more importantly) free, it\nmakes complete sense that the authors of Alina chose to pack their malware using this\nproduct. Not only does it reduce to overall file size of the malware, but it also prevents\nsimple detection mechanisms, such as searching for strings within the binary. UPX began\nbeing used with versions 2.1 and above.\n\n**Visual Basic Crypter**\n\nStarting with version 5.2, we begin seeing a large leap with regard to protections.\nSpecifically, we begin seeing a crypter written in Visual Basic being thrown on top of Alina.\nWhile packers have historically been created with the primary purpose of speeding up\nexecutables, crypters main purpose in life is to make my life difficult. In other words,\ncrypters were built primarily to obfuscate binaries. One of the interesting side-affects of\nutilizing a crypter is that in some cases it will actually increase the rate of detection by the\nAnti-Virus community. An Anti-Virus company may not have a specific detection in place for\na given family of malware, but they may have a signature in place for a crypter that is\ntypically utilized for malicious purposes.\n\nAs an example, Alina version 2.0, which is not packed at all, is only detected by 30 Anti[Virus companies (VirusTotal). Conversely, Alina version 5.2, which makes use of the crypter](https://www.virustotal.com/en/file/8782d38bc326d3127dcbd4f6f9a4342a503517cc8504920ac5db4e4dfb16e046/analysis/)\n[is detected by 33 Anti-Virus companies (VirusTotal). This isn't a comprehensive test of](https://www.virustotal.com/en/file/442da19c353f3de27bc096f8cdfdb6e7e76cb24eb7fbffabdaea12a38ed305d2/analysis/)\n\n\n-----\n\ncourse, and there are a number of reasons why version 5.2 may be detected more than 2.0,\nbut I'm simply using it to illustrate my point.\n\n**UPX Protector**\n\nUPX Protector is a utility that was developed to hinder UPX from being easily unpacked.\nUtilizing a simple command-line utility, UPX can be trivially unpacked. UPX Protector\nattempts to prevent this by corrupting the header (thus the reason we were unable to get a\nPE timestamp in version 5.5 in the previous blog post), cloaking sections, modifying the\nentry-point, etc. This protection was put into place starting with version 5.5.\n\n**Aggregating Track Data**\n\nFor the most part, the task of aggregation of track data was fairly consistent for most of\nAlina's history. Up until versions 5.x, the process looked like this:\n\nCreate an array of processes to look at via calls to CreateToolhelp32Snapshot(),\nProcess32First(), and Process32Next(), ignoring processes in the following blacklist:\n\nexplorer.exe\nchrome.exe\nfirefox.exe\niexplore.exe\nsvchost.exe\nsmss.exe\ncrss.exe\nwininit.exe\nsteam.exe\ndevenv.exe\nthunderbird.exe\nskype.exe\npidgin.exe\n\nLoop through every process, and read pages of memory via calls to VirtualQueryEx()\nand ReadProcessMemory(), targeting RAM with read/write privileges.\nApply a number of regular expressions against this read memory, targeting Track 1\nand Track 2 data.\nExfiltrate any data discovered and begin this process from the beginning.\n\nStarting with version 5.x, the authors decided to spawn a new separate thread for each\nprocess they targeted. This meant that each process was constantly having its memory\nread, which decreased the chance that the authors would miss any track data being\nprocessed. The downside to this, however, was that it made the malware extremely noisy\n\n\n-----\n\nand increased the chance of detection on the victim. This is just one example of how the\nauthors weighed the consequences of their decisions and determined that it would be better\nto have a higher rate of success versus a greater chance of detection.\n\n**Random Thoughts / Points of Interest**\n\nOverall it's been very interesting to see Alina grow over the months in many different ways.\nAs I mentioned originally in my first blog post, memory dumpers targeting POS devices are\nnothing new, however, the trend towards automation and C&C has been interesting to say\nthe least. Looking back, I find it very interesting to see some of the processes in the\nblacklist, such as steam.exe, skype.exe, pidgin.exe, etc. If I had to speculate, I'd argue that\nseeing these processes demonstrates a lack of sophistication on the author's part. I\nwouldn't be surprised to discover that the author was running these programs in his\ndevelopment environment, and decided to add Steam, Pidgin, Thunderbird, etc. to the list in\norder make things easier on their end. Alternatively, I've heard reports of Alina showing up\non a number of end-user machines (as opposed to POS devices), and it's certainly possible\nthat these processes were added simply because they are commonly found on end-user\ndevices. However, these are only sporadic rumors. I can only say for certain is that\nTrustwave has encountered Alina on a number of forensic cases affecting the Food and\nBeverage industry. It is very likely that this malware is being used for attacks on other\nindustries as well; simply due to the way the malware works.\n\nPer some comments we've received from the prior postsâ€”I'd like to emphasize that Alina is\nvery generic in nature. While it targets track data, and is most likely found on POS devices,\nit isn't limited to these machines, or any POS vendor in particular.\n\nAt this point I'm going to wrap things up as I've once again made this post longer than I\nanticipated. I hope you've enjoyed reading about Alina as much as I have reversing it.\nThanks for reading!\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2013/2013-06-03 - Alina- Following The Shadow Part 2.pdf"
    ],
    "report_names": [
        "2013-06-03 - Alina- Following The Shadow Part 2.pdf"
    ],
    "threat_actors": [
        {
            "id": "af509bbb-8d18-4903-a9bd-9e94099c6b30",
            "created_at": "2023-01-06T13:46:38.585525Z",
            "updated_at": "2025-03-27T02:00:02.866727Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "TIN WOODLAWN",
                "OceanLotus Group",
                "OceanLotus",
                "Sea Lotus",
                "G0050",
                "Cobalt Kitty",
                "SeaLotus",
                "ATK17",
                "Ocean Lotus",
                "Ocean Buffalo",
                "POND LOACH",
                "Canvas Cyclone",
                "APT-C-00",
                "APT-32",
                "APT 32"
            ],
            "source_name": "MISPGALAXY:APT32",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2439ad53-39cc-4fff-8fdf-4028d65803c0",
            "created_at": "2022-10-25T16:07:23.353204Z",
            "updated_at": "2025-03-27T02:02:09.749502Z",
            "deleted_at": null,
            "main_name": "APT 32",
            "aliases": [
                "APT 32",
                "APT-C-00",
                "APT-LY-100",
                "ATK 17",
                "Lotus Bane",
                "Ocean Buffalo",
                "OceanLotus",
                "Operation Cobalt Kitty",
                "Operation PhantomLance",
                "Pond Loach",
                "SeaLotus",
                "SectorF01",
                "Tin Woodlawn"
            ],
            "source_name": "ETDA:APT 32",
            "tools": [
                "Agentemis",
                "Android.Backdoor.736.origin",
                "AtNow",
                "Backdoor.MacOS.OCEANLOTUS.F",
                "BadCake",
                "CACTUSTORCH",
                "CamCapture Plugin",
                "CinaRAT",
                "Cobalt Strike",
                "CobaltStrike",
                "Cuegoe",
                "DKMC",
                "Denis",
                "Goopy",
                "HiddenLotus",
                "KOMPROGO",
                "KerrDown",
                "METALJACK",
                "MSFvenom",
                "Mimikatz",
                "Nishang",
                "OSX_OCEANLOTUS.D",
                "OceanLotus",
                "PHOREAL",
                "PWNDROID1",
                "PhantomLance",
                "PowerSploit",
                "Quasar RAT",
                "QuasarRAT",
                "RatSnif",
                "Remy",
                "Remy RAT",
                "Rizzo",
                "Roland",
                "Roland RAT",
                "SOUNDBITE",
                "Salgorea",
                "Splinter RAT",
                "Terracotta VPN",
                "Yggdrasil",
                "cobeacon",
                "denesRAT",
                "fingerprintjs2"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536053,
    "ts_updated_at": 1743041166,
    "ts_creation_date": 1653703937,
    "ts_modification_date": 1653703937,
    "files": {
        "pdf": "https://archive.orkl.eu/c6a09036c1d86128ebac6c7d36cd2948d167c0ab.pdf",
        "text": "https://archive.orkl.eu/c6a09036c1d86128ebac6c7d36cd2948d167c0ab.txt",
        "img": "https://archive.orkl.eu/c6a09036c1d86128ebac6c7d36cd2948d167c0ab.jpg"
    }
}