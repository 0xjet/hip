{
    "id": "2f5187c8-cb4a-4be7-8836-e4c939da539b",
    "created_at": "2023-01-12T15:07:14.193923Z",
    "updated_at": "2025-03-27T02:08:41.311098Z",
    "deleted_at": null,
    "sha1_hash": "e1f33b8076d18254b705927ebd3e36cc5f722745",
    "title": "2019-07-28 - Third time's the charm- Analysing WannaCry samples",
    "authors": "",
    "file_creation_date": "2022-05-28T01:27:33Z",
    "file_modification_date": "2022-05-28T01:27:33Z",
    "file_size": 1401802,
    "plain_text": "# Third time's the charm? Analysing WannaCry samples\n\n**[dissectingmalwa.re/third-times-the-charm-analysing-wannacry-samples.html](https://dissectingmalwa.re/third-times-the-charm-analysing-wannacry-samples.html)**\n\nSun 28 July 2019 in [Ransomware](https://dissectingmalwa.re/category/ransomware.html)\n\nAfter over two years since the inital spread of the ransomware and Malwaretechs sentencing\nlast week I got a bit nostalgic and took a second look at different samples\n\nSince the first wave of infections in May 2017 WannaCry is basically the goto example for the\nwhole ransomware scheme and that is actually a good thing. The potential damage that\nWannaCry and the variants following the original version would have been massive if it\nwouldn't have been for Malwaretech, 2sec4u and all the other researchers who helped to\ncontain the spread of ransomware powered by the wormable EternalBlue exploit. Funnily\nenough there are still people from around the world that pay the ~300$ ransom in hopes to\n[get their data decrypted as can be seen here.](https://twitter.com/actual_ransom)\n\n**_A general disclaimer as always: downloading and running the samples (especially the_**\n**_ones without the kill switch) linked below will lead to the encryption of your personal_**\n**_data, so be f$cking careful. Also check with your local laws as owning malware_**\n**_binaries/ sources might be illegal depending on where you live._**\n\n### The three samples I'll be looking at:\n\n\n-----\n\nWannacry Sample #1 sometimes referred to as dropper available @\n[https://www.ghidra.ninja/samples/wannacry.zip](https://www.ghidra.ninja/samples/wannacry.zip) `sha256`\n```\n24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c\n\n```\nWannacry Sample #2 sometimes referred to as \"encryptor\" available @\n[https://github.com/ytisf/theZoo/tree/master/malwares/Binaries/Ransomware.WannaCry](https://github.com/ytisf/theZoo/tree/master/malwares/Binaries/Ransomware.WannaCry)\n```\nsha256 ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa\n\n```\nWannacry Plus available @\n[https://github.com/ytisf/theZoo/tree/master/malwares/Binaries/Ransomware.WannaCry_Plus](https://github.com/ytisf/theZoo/tree/master/malwares/Binaries/Ransomware.WannaCry_Plus)\n```\nsha256 55504677f82981962d85495231695d3a92aa0b31ec35a957bd9cbbef618658e3 The\n\n```\nfirst thing we're going to take a look at is the symbol tree. Stepping into the function called\n_entry: we notice that it is in fact not the main / WinMain function, but rather a preparing_\nfunction that will call WinMain at the end (this might acutally be an artifact of Ghidra's\ndecompiler).\n\n\n-----\n\nBecause the\n\ndecompilation result in our WinMain function is not that pretty yet we will edit its function\n[signature to match the one described in the Win32 API Reference.](https://docs.microsoft.com/en-us/windows/win32/learnwin32/winmain--the-application-entry-point) `int WINAPI`\n\n\n-----\n\n```\nwWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, PWSTR pCmdLine, int\nnCmdShow);\n\n```\nAfter this is done the decompilation result will be much better and easier on the eyes. One of\nthe first things you will spot is the famous Kill Switch URL registered by Malwaretech after\nthe inital outbreak which is to this day pointing to the Kryptos Logic sinkhole. After Line 41\nyou are also able to see multiple InternetOpen etc. function calls that will check if the\naforementioned URL is registered and reachable. If that is the case it will close the\nconnection socket and exit to WinMain before the encryption processs even started. Of\ncourse this also means that if the infected PC is not connected to the Interwebs (remember it\npropagates via SMB over local networks as well) or is unable to resolve the domain name\nthe ransomware will go to town with the user's files. Looking into sample #2 there is acutally\nno such kill switch which means that it is one of the later versions following the inital\noutbreak.\n\n\n-----\n\nTo show the differences between the kill switched first sample and the second rambo version\nI fired up hasherezade's awesome PE-Bear and loaded Sample #2 and #1. This indeed\nconfirms that the samples are basically the same, but version #2 is missing the notorious kill\nswitch.\n\n\n-----\n\n## WannaCry Plus\n\nI haven't heard of this strain/ variant before, but it got it's own subfolder in ytisf's TheZoo so it\nhas to be special in some way, right? Let's first check the entropy of the binary with \"Detect it\neasy\" to see if it is packed or obfuscated in any way:\n\n\n-----\n\nLooking at the entropy graph we can pretty comfortably say that the PE is neither packed nor\nobfuscated (which would have been out of the ordinary for a WannaCry sample anyway).\nLooking at the symbol tree we are greated with a new function called PlayGame. Please no\nFortnite ransomware kthxbye :D We'll have a look into that later..\n\nJumping into the entry function things are looking\n\nquite different compared to first two samples. Following the procedure we are dropped into\nFUN_10001016 which is what i presume the file encryption function. This pretty easy to spot\nthrough the rather characteristic combination of FindResourceA, CreateFileA and WriteFile.\n\nTo see what happens if I run the malware I fired up a Windows 7 x86 VM in VirtualBox\n[provided by https://modern.ie/. After seeing the error message below I thought the](https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/)\nexecutable might actually be a x86_64 one since it refuses to run on the 32-bit Windows 7\n\n\n-----\n\nSystem. Even these days it is actually quite unusual for malware to be compiled for x64\nsystems only since it'll cut out a lot of the old and vulnerable systems running x86 XP for\nexample (which is kind of a no-brainer since the potatohead holding PCs for ransom would\nwant to maximise the attack surface and earnings).\n\nKudos to Microsoft in this case: Their Defender and SmartScreen really stepped up their\ngame. For an attacker and (sadly) for a malware reverse engineer it is actually quite difficult\nto circumvent or disable the built in Mal-/Ransomware Protection. You are constantly greeted\nwith Pop-Ups about a detected ransomware executable and the Defender will even go as far\nas simply deleting your precious sample :(\n\n\n-----\n\nBut even after calming down the Windows Defender I couldn't get the malware to encrypt\nanything :S\n\n\n-----\n\n[Looking at the Anyrun Sandbox Analysis over here we see the same error message but it](https://app.any.run/tasks/f889f338-712f-44aa-b387-f501f3ed7c48/)\nseems to drop another executable called \"SearchProtocolHost.exe\" which is probably\nRunPE Process Hollowing at play. The next step will probably be manual debugging, so stay\ntuned!\n\n## IOCs\n\n### Wannacry (SHA256)\n```\n24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c\ned01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa\n55504677f82981962d85495231695d3a92aa0b31ec35a957bd9cbbef618658e3\n32f24601153be0885f11d62e0a8a2f0280a2034fc981d8184180c5d3b1b9e8cf\n697158bcade7373ccc9e52ea1171d780988fc845d2b696898654e18954578920\ned01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-07-28 - Third time's the charm- Analysing WannaCry samples.pdf"
    ],
    "report_names": [
        "2019-07-28 - Third time's the charm- Analysing WannaCry samples.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536034,
    "ts_updated_at": 1743041321,
    "ts_creation_date": 1653701253,
    "ts_modification_date": 1653701253,
    "files": {
        "pdf": "https://archive.orkl.eu/e1f33b8076d18254b705927ebd3e36cc5f722745.pdf",
        "text": "https://archive.orkl.eu/e1f33b8076d18254b705927ebd3e36cc5f722745.txt",
        "img": "https://archive.orkl.eu/e1f33b8076d18254b705927ebd3e36cc5f722745.jpg"
    }
}