{
    "id": "a9aa7d4e-f48f-47be-a424-e272ea0fccb2",
    "created_at": "2023-01-12T15:05:40.679894Z",
    "updated_at": "2025-03-27T02:16:26.089031Z",
    "deleted_at": null,
    "sha1_hash": "c24c3bcdf314badcd0fe0228315f4a07fbd91aa7",
    "title": "2019-04-07 - Mobile Malware Analysis - Tricks used in Anubis",
    "authors": "",
    "file_creation_date": "2022-05-28T00:31:03Z",
    "file_modification_date": "2022-05-28T00:31:03Z",
    "file_size": 1084332,
    "plain_text": "# Mobile Malware Analysis : Tricks used in Anubis\n\n**[eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/](https://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/)**\n\neybisi\n2019-04-07\n\n[Malware,](https://eybisi.run/tags/Malware/) [Mobile](https://eybisi.run/tags/Mobile/)\n\n## Anubis\n\nAnubis is my first case of `complicated android malware and taught me so much about`\nandroid malware. I want to share these learnings in this post. Anubis is almost one year old\n[but its impact is much higher than older banker families and campaign is still going on. Small](https://twitter.com/0xabc0/status/1113698644442656773)\nsection of anubis downloader samples found in play store in between July 2018 and March\n2019 :\n\n\n-----\n\nAnubis is full of tricks. List of capabilities:\n\nSteal information with overlay attacks from banking apps\nRansomware\nSMS interception / Call forwarding\nRAT\nKeylogger\n\nTo spread malware generally google play store is used.\n\n## Downloaders\n\nAnubis generally consist of two part. I’ll call them downloader and payload. If malware\nspreads over third party sites, such as `flash updates it only downloads payload of`\nanubis. But if malware spreads over google play store, it uses downloader. Because it needs\nto. If payload of anubis is used it will be detected by play protect easily. So to download\npayload, fake applications deployed on play store. But how an application downloads and\ninstalls another application ?\n\nEasy, with `REQUEST_INSTALL_PACKAGES permission. I think in the current state of Play`\nStore this permission is dangerous than any other one. Because Play Protect can catch\nmalware and rats if published on play store. Spread of malware generally comes from this\npermission. Users need to check if this permission is in permission list.\n\n## Social Engineering\n\nMalware needs to lower suspicion of user after installation. Anubis downloaders use little but\nstrong steps to make user believe it is legitimate app. Since threat actors want to catch\nvaluable victims, generally these fake applications will be finance related apps. Such as\n```\nCurrency Converter .\n\n```\n**Curreny - Gold - Euro** **Currency Center**\n\n( notice #1 trending )\n\n\n-----\n\nBut these apps will imitate legitimate ones. Here is how earlier fake apps worked. After\ninstalling, app will remove itself from homescreen. Why ? Lets say you downloaded an app.\nBut it didn’t worked like you wanted. What you do ? Go back to homescreen and delete that\napp right ? Now you need to go to settings. Also after opening fake app, generally app will\nprompt `App needs to be updated and forward user to legitimate app that have same app`\nicon, app name and almost same developer name. So you downloaded an app, it forwarded\nto real one and you installed it. When you go back to your homescreen, you will see only one\napp which is legitimate one. With this, suspicion of user is lowered. But when you go to\nsettings and list application, you will see 2 of them.\n\nAlso ! if you try to remove malware from settings an system error(!) will show up.\n\n## System Update ?\n\nAfter user installs downloader, app will download second stage of attack, payload. Generally\nname of downloaded apk will be either `Sistem Guncellemesi, Operator Guncellemesi,`\n```\nFlash Update, Yazilim Guncellemesi . Names are in Turkish, meaning System Update,\n\n```\n\n-----\n\nOperator Update, Software Update. Icons of these apps:\n\n\n**Flash Player**\n**Update** **Update**\n\n\n**Operator**\n**Update** **Service Update**\n\n\n**System**\n**Update**\n\n\nWith these icons threat actors want user to believe these are legitimate apps. After\ndownloader gets payload app from command and control server, prompt will shown to user.\nUser needs to activate `third-party installation and press yes to prompt screen. Then`\napp will installed. After user opens up, app will ask for permissions then nothing will shown\nand app will dissepear from app list.\n\n\n-----\n\nDid you see flickering after giving Accessibility permission ? We will come to that.\n\n## Persistence\n\nIn desktop malware generally malware will write itself to `Startup folder to get persistence`\nand open itself each boot. What about Android malware ? Let me introduce you to\n```\nRECEIVE_BOOT_COMPLETED . With this receiver, app can open itself in background when\n\n```\ndevice is booted. Cool right ?\n\n## You cant delete me !\n\nLets say user gave all permission to application and installed it. But you want to remove app.\nWhen you go to settings and try to delete app, you click the app icon. It says `System apps`\n```\ncannot be deleted and you are forwarded to user to Home Screen.\n\n```\nWhat ?\n\nApp didn’t take device admin permissions. How it can do that ? Lets find out.\n\n## Accessibility\n\nFrom [official android page :’Accessibility Services run in the background and receive](https://developer.android.com/reference/android/view/accessibility/AccessibilityEvent)\ncallbacks by the system when AccessibilityEvents are fired. Such events denote some state\ntransition in the user interface, for example, the focus has changed, a button has been\n**clicked, etc. Such a service can optionally request the capability for querying the content of**\nthe active window‘.\n\nWhat can go wrong right ?\n\nIt can track user activities and have ability to query certain things such as message boxes.\nEach accessibility event have source component that defines which application triggered\ncurrent event. There are different event types anubis use :\n\nTYPE_VIEW_CLICKED\nTYPE VIEW FOCUSED\n\n\n-----\n\nTYPE_VIEW_TEXT_CHANGED\nTYPE_WINDOW_STATE_CHANGED\n\n[To see what all Accessibility Event types are take a look at : AccessibilityEvent](https://developer.android.com/reference/android/view/accessibility/AccessibilityEvent)\n\nAnubis tracks all accessibility events and checks event types. So if you open new app\nwindow state will change and event will trigger. Event type of\n```\nTYPE_WINDOW_STATE_CHANGED is first check. To remove malware you probably go to\n\n```\nSettings. Settings is also an android application called `com.android.settings . Second`\ncheck is if triggered event comes from `com.android.settings . Then malware checks if`\ncertain strings in Event description.\n\nFirst check is for name of the app you clicked :\n\nServis Guncellemesi (this.a.i(this))\n\nThen below strings:\n\nuninstall (this.f)\nto remove (this.g)\n\nIf all conditions hold, an Activity is triggered `a() . This activity just opens AlertDialog which`\nsays `System apps cannot be deleted . Since Application doesnt have any Launchable`\ncontent, android opens alert box in the Homescreen. So whenever you try to open Malware’s\ndetails in Settings you forwarded to homescreen with alert box and you can’t delete app.\n\n\n-----\n\nMaybe if I remove Accessibility permission from app, I should able to remove it right ? No.\nLets say you removed permission. All’s fine. But when you open Settings again, malware will\nconstantly ask you to give permission. You cant navigate to Apps section of Settings to\nremove app. Fine, maybe If I reboot then I can remove app ? Remember\n```\nRECEIVE_BOOT_COMPLETED permission ? App will start again and ask for Accessibility\n\n```\npermission. But you have other ways to remove the app. If you have application manager\napps with package name other than `com.android.settings you can delete malware. Or`\nby booting in safe mode. Also if you have adb enabled and you know packagename you can\ndelete it with : `adb uninstall packagename . To learn package names you can list all`\npackages with `adb shell pm list packages`\n\n## Keylogger\n\nNow we covered `TYPE_WINDOW_STATE_CHANGED event. Lets look at other 3 event.`\n\nTYPE_VIEW_CLICKED\nTYPE_VIEW_FOCUSED\n\n\n-----\n\nTYPE_VIEW_TEXT_CHANGED\n\nEVERY input box you click/focus and write text into it, will trigger one the three event. No\nmatter what app you are in. So lets say TYPE_VIEW_TEXT_CHANGED event triggered and\nmalware caught it. With just `obj = accessibilityEvent.getText().toString(); it can`\nget changed text and send back to its command and control server. Event type 16 =\n\n```\nTYPE_VIEW_TEXT_CHANGED\n\n```\n\nRemember flickering after giving the accessibility permission to malware ? With accessibility,\napp can press buttons (yes literally). Malware press `yes without user interaction.`\n```\n for ( node :\n source.findAccessibilityNodeInfosByText(this.e)) {\n         node.performAction(16);\n }\n\n```\nYou guessed right, action 16 is `ACTION_CLICK and this.e holds` `StringYes .`\n\n## Play Protect\n\nEven though malware installed on the device from downloader without being flagged, Play\nProtect will constantly scan the device if its enabled and will flag anubis app as a malware.\nTo overcome this malware tries to disable Play protect.\n\n\n-----\n\n## Package List\n\nWhen malware installed, first thing it does is listing installed packages and sending it to\ncommand and control server. These application names are sometimes used for another\npurpose. For example when threat actor knows you have, lets say ‘com.x.bank’ app, threat\nactor sends sms that crafted for that app to lure user to open `com.x.bank application.` `You`\n```\nhave received 10.000$. Login in to your X account With this technique user will\n\n```\nopen that app and fake overlay will shown. This can be taught as backup plan for phishing\nuser.\n\nHow can android app list installed packages ? Easy `getInstalledApplications`\n```\n pman = context.getPackageManager()\n for ( ApplicationInfo appInf :\n pman.getInstalledApplications(128)){\n   if(appInf.packageName.equals(\"com.x.bank\")){\n     arrayList.add(\"com.x.bank\")\n   }\n }\n\n## Overlay Attack\n\n```\nMalware authors always try to find creative ways to fool victims to get their information.\n[Overlay attack is one of them. Since early 2016 (MazarBot ) a lot of android malware used](https://lukasstefanko.com/2016/02/android-mazarbot-stealing-credit-card-information-in-italy-with-certified-issued-by-putin.html)\nthis technique for collecting user information. When targeted apps opened, malware triggers\nand pulls phishing page that generated for that targeted app from command and control\nserver and `overlays over targeted app. Showing it is easier.`\n\n\n-----\n\n(random banking app is chosen. There are 100+ targeted apps)\n\nSince overlayed screen is similar to original app and process of overlaying is done in very\nshort time, user probably dont get suspicious. But how malware detects opened apps and\noverlays itself on top of another process ? Lets find out !\n\n## Process Scanning\n\nGetting package list is not enough for overlay attack. Malware needs to know that user just\nopened “com.x.bank” app to make believable overlay scenerio. Or user wont fall it and be\nsuspicious about it. There is no “an app opened” service in android. The way malware does\nis simple: somehow get running process list and get top process. Put that function in\n```\nWhile(true){ } loop. This way you will know when new app opened. The ways of getting\n\n```\nprocess list differs in targeted SDK versions. Anubis need permission to get process list if\nAPI version is greater than 23. It uses `PACKAGE_USAGE_STATS permission to use`\nUsageStatsManager and get list of running processes. If API version is < 23 then there are\nfunctions to get list of processes without any permission. I’ll focus on this topic on my next\n\n\n-----\n\npost. After getting process/package names, malware compare these with banking apps\npackage names. Then opens up corresponding phishing page through webView. This action\ndoesn’t need any permission. Any app can open itself without user interaction ! (Not in\nAndroid 9 YAY !)\n\nThen collected data will be send to command and control server.\n\n## Battery issues\n\nBut running in forever loop will cause some battery issues right? Battery optimizing apps will\nclose malware. Malware author was aware of this and here comes another permission\n```\nREQUEST_IGNORE_BATTERY_OPTIMIZATIONS . With this permission app will not seen in\n\n```\nbattery optimizations.\n\n## SMS Interception and Call forwarding\n\nThis is scary part. Malware already have SMS_READ permission for reading sms. Why ? For\nOTP codes. Addition to reading, malware requests for being default SMS app. If user\naccepts, threat actor behind the command and control server can delete SMS from device.\nThen sms will be removed and user wont have any clue.\n\nCall forwarding, oh this is really scary. Lets say bank understood user is victim of malware.\nCalls him/her number. But who opens the phone ? threat actor.\n\n\n-----\n\n## Conclusion\n\nTwo permission for two stages of anubis. `REQUEST_INSTALL_PACKAGES and`\n```\nPACKAGE_USAGE_STATS these are releated to core components of the malware to fool user.\n\n```\nI hope you learned something new about android malware. If you have any question feel free\nto ask me [@0xabc0](https://twitter.com/0xabc0)\n\nWhile writing this post, Android announced 9 beta with great security related news ! Now\napps can’t open itself without user interaction, no more overlay tactics for malware !\n\n## Reference\n\n[Anubis Image gregory-the-gregory](https://forum.yugiohcardmaker.net/user/731508-gregory-the-gregory/)\n\n## Readings\n\nAnubis Related:\n\n[Koodous for finding anubis sample](https://koodous.com/apks?search=tag:anubis)\n\n[LukasStefanko’s twitter thread](https://twitter.com/LukasStefanko/status/1084728042927341569)\n\n[Trend Micro’s post about Anubis](https://blog.trendmicro.com/trendlabs-security-intelligence/google-play-apps-drop-anubis-banking-malware-use-motion-based-evasion-tactics/)\n\n[IBM X-Force’s post about Anubis](https://securityintelligence.com/anubis-strikes-again-mobile-malware-continues-to-plague-users-in-official-app-stores/)\n\n[Sophos Labs’ post about Anubis](https://news.sophos.com/en-us/2018/08/14/anubis-is-back-are-you-prepared/)\n\nIf you want to read related posts about android malware heres my other posts:\n\n[How to defeat packers in Android ecosystem](https://pentest.blog/n-ways-to-unpack-mobile-malware/)\n\n[How to setup android malware analysis lab (in Turkish)](https://eybisi.run/2018/07/31/Mobil-Zararli-Analizi-Bolum-1-Ortami-Kuralim/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-04-07 - Mobile Malware Analysis - Tricks used in Anubis.pdf"
    ],
    "report_names": [
        "2019-04-07 - Mobile Malware Analysis - Tricks used in Anubis.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535940,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653697863,
    "ts_modification_date": 1653697863,
    "files": {
        "pdf": "https://archive.orkl.eu/c24c3bcdf314badcd0fe0228315f4a07fbd91aa7.pdf",
        "text": "https://archive.orkl.eu/c24c3bcdf314badcd0fe0228315f4a07fbd91aa7.txt",
        "img": "https://archive.orkl.eu/c24c3bcdf314badcd0fe0228315f4a07fbd91aa7.jpg"
    }
}