{
    "id": "4a9fa744-9216-4455-907a-6fad21a939de",
    "created_at": "2023-01-12T15:10:45.694272Z",
    "updated_at": "2025-03-27T02:17:14.425465Z",
    "deleted_at": null,
    "sha1_hash": "cfd172508bbd7569019c61559b99cbe39067975f",
    "title": "2018-02-04 - MALWARE ANALYSIS – PLUGX",
    "authors": "",
    "file_creation_date": "2022-05-28T18:25:26Z",
    "file_modification_date": "2022-05-28T18:25:26Z",
    "file_size": 2407828,
    "plain_text": "# Malware Analysis – PlugX\n\n**[countuponsecurity.com/2018/02/04/malware-analysis-plugx/](https://countuponsecurity.com/2018/02/04/malware-analysis-plugx/)**\n\nBy Luis Rocha February 4, 2018\n\n_[The PlugX malware family has always intrigued_\n_me. I was curious to look at one variant. Going_\n_over the Internet and the research articles and_\n_[blogs about it I came across the research made](http://blog.airbuscybersecurity.com/post/2016/06/Getting-a-PlugX-builder)_\n_by Fabien Perigaud. From here I got an old_\n_PlugX builder. Then I set a lab that allowed me_\n_to get insight about how an attacker would_\n_operate a PlugX campaign. In this post, l will_\n_cover a brief overview about the PlugX builder,_\n_analyze and debug the malware installation and_\n_do a quick look at the C2 traffic. ~LR]_\n\n[PlugX is commonly used by different](https://www.fireeye.com/blog/threat-research/2017/04/apt10_menupass_grou.html) [threat](https://researchcenter.paloaltonetworks.com/2017/06/unit42-paranoid-plugx/)\n[groups](http://blog.jpcert.or.jp/2015/01/analysis-of-a-r-ff05.html) [on](https://www.lastline.com/labsblog/an-analysis-of-plugx-malware/) [targeted](https://researchcenter.paloaltonetworks.com/2015/05/plugx-uses-legitimate-samsung-application-for-dll-side-loading/) [attacks. PlugX is also](https://www.fireeye.com/blog/threat-research/2013/05/targeted-attack-trend-alert-plugx-the-old-dog-with-a-new-trick.html)\nrefered as KORPLUG, SOGU, DestroyRAT and is a modular backdoor that is designed to\nrely on the execution of signed and legitimated executables to load malicious code. PlugX,\nnormally has three main components, a DLL, an encrypted binary file and a legitimate and\nsigned executable that is used to load the malware using a technique known as DLL search\norder hijacking. But let’s start with a quick overview about the builder.\n\nThe patched builder, MD5 6aad032a084de893b0e8184c17f0376a, is an English version,\nfrom Q3 2013, of the featured-rich and modular command & control interface for PlugX that\nallows an operator to:\n\nBuild payloads, set campaigns and define the preferred method for the compromised\nhosts to check-in and communicate with the controller.\nProxy connections and build a tiered C2 communication model.\nDefine persistence mechanisms and its attributes.\nSet the process(s) to be injected with the payload.\nDefine a schedule for the C2 call backs.\nEnable keylogging and screen capture.\nManage compromises systems per campaign.\n\nThen for each compromised system, the operator has extensive capabilities to interact with\nthe systems over the controller that includes the following modules:\n\nDisk module allows the operator to write, read, upload, download and execute files.\n\n\n-----\n\nNetworking browser module allows the operator to browse network connections and\nconnect to another system via SMB.\nProcess module to enumerate, kill and list loaded modules per process.\nServices module allows the operator to enumerate, start, stop and changing booting\nproperties\nRegistry module allows the operator to browse the registry and create, delete or modify\nkeys.\nNetstat module allows the operator to enumerate TCP and UDP network connections\nand the associated processes\nCapture module allows the operator to perform screen captures\nControl plugin allows the operator to view or remote control the compromised system in\na similar way like VNC.\nShell module allows the operator to get a command line shell on the compromised\nsystem.\nPortMap module allows the operator to establish port forwarding rules.\nSQL module allows the operator to connect to SQL servers and execute SQL\nstatements.\nOption module allows the operator to shut down, reboot, lock, log-off or send message\nboxes.\nKeylogger module captures keystrokes per process including window titles.\n\nThe picture below shows the Plug-X C2 interface.\n\nSo, with this we used the builder functionality to define the different settings specifying C2\ncomms password, campaign, mutex, IP addresses, installation properties, injected binaries,\nschedule for call-back, etc. Then we build our payload. The PlugX binary produced by this\nversion of the builder (LZ 2013-8-18) is a self-extracting RAR archive that contains three\nfiles. This is sometimes referred in the literature as the PlugX trinity payload. Executing the\nself-extracting RAR archive will drop the three files to the directory chosen during the\nprocess. In this case “%AUTO%/RasTls”. The files are: A legitimate signed executable from\nKaspersky AV solution named “avp.exe”, MD5 e26d04cecd6c7c71cfbb3f335875bc31, which\n[is susceptible to DLL search order hijacking . The file “avp.exe” when executed will load the](https://countuponsecurity.com/2016/05/24/digital-forensics-dll-search-order/)\nsecond file: “ushata.dll”, MD5 728fe666b673c781f5a018490a7a412a, which in this case is a\n\n\n-----\n\nDLL crafted by the PlugX builder which on is turn will load the third file. The third file:\n“ushata.DLL.818”, MD5 “21078990300b4cdb6149dbd95dff146f” contains obfuscated and\npacked shellcode.\n\nSo, let’s look at the mechanics of what happens when the self-extracting archive is executed.\nThe three files are extracted to a temporary directory and “avp.exe” is executed. The\n“avp.exe” when executed will load “ushata.dll” from the running directory due to the DLL\nsearch order hijacking using Kernel32.LoadLibrary API.\n\nThen “ushata.dll” DLL entry point is executed. The DLL entry point contains code that verifies\nif the system date is equal or higher than 20130808. If yes it will get a handle to\n“ushata.DLL.818”, reads its contents into memory and changes the memory address\nsegment permissions to RWX using Kernel32.VirtualProtect API. Finally, returns to the first\ninstruction of the loaded file (shellcode). The file “ushata.DLL.818” contains obfuscated\nshellcode. The picture below shows the beginning of the obfuscated shellcode.\n\n\n-----\n\nThe shellcode unpacks itself using a custom algorithm. This shellcode contains position\nindependent code. Figure below shows the unpacked shellcode.\n\n[The shellcode starts by locating the kernel32.dll address by accessing the Thread](https://web.archive.org/web/20170413084049/https://vxheaven.org/lib/vra06.html)\n[Information Block (TIB) that contains a pointer to the Process](http://blog.harmonysecurity.com/2009_06_01_archive.html) [Environment](http://garage4hackers.com/archive/index.php/t-1902.html) [Block (PEB)](http://sandsprite.com/CodeStuff/Understanding_the_Peb_Loader_Data_List.html)\nstructure. Figure below shows a snippet of the shellcode that contains the different sequence\nof assembly instructions for the code to find the Kernel32.dll.\n\n\n-----\n\nIt then reads kernel32.dll export table to locate the desired Windows API’s by comparing\nthem with stacked strings. Then, the shellcode decompresses a DLL (offset 0x784) MD5\n333e2767c8e575fbbb1c47147b9f9643, into memory using the LZNT1 algorithm by\nleveraging ntdll.dll.RtlDecompressBuffer API. The DLL contains the PE header replaced with\nthe “XV” value. Restoring the PE header signature allows us to recover the malicious DLL.\n\n\n-----\n\nNext, the payload will start performing different actions to achieve persistence. On Windows\n7 and beyond, PlugX creates a folder “%ProgramData%\\RasTl” where “RasTl” matches the\ninstallation settings defined in the builder. Then, it changes the folder attributes to\n“SYSTEM|HIDDEN” using the SetFileAttributesW API. Next, copies its three components into\nthe folder and sets all files with the “SYSTEM|HIDDEN” attribute.\n\n\n-----\n\nThe payload also modifies the timestamps of the created directory and files with the\ntimestamps obtained from ntdll.dll using the SetFileTime API.\n\nThen it creates the service “RasTl” where the ImagePath points to\n“%ProgramData%\\RasTl\\avp.exe”\n\nIf the malware fails to start the just installed service, it will delete it and then it will create a\npersistence mechanism in the registry by setting the registry value\n“C:\\ProgramData\\RasTls\\avp.exe” to the key\n“HKLM\\SOFTWARE\\Classes\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\RasTls”\nusing the RegSetValueExW API.\n\n\n-----\n\nIf the builder options had the Keylogger functionality enabled, then it may create a file with a\nrandom name such as “%ProgramData%\\RasTl\\rjowfhxnzmdknsixtx” that stores the key\nstrokes. If the payload has been built with Screen capture functionality, it may create the\nfolder “%ProgramData%\\RasTl \\RasTl\\Screen” to store JPG images in the format\n<datetime>.jpg that are taken at the frequency specified during the build process. The\npayload may also create the file “%ProgramData%\\DEBUG.LOG” that contains debugging\ninformation about its execution (also interesting that during execution the malware outputs\ndebug messages about what is happening using the OutputDebugString API. This messages\ncould be viewed with DebugView from SysInternals). The malicious code completes its\nmission by starting a new instance of “svchost.exe” and then injects the malicious code into\n[svchost.exe process address space using process hollowing technique. The pictures below](https://countuponsecurity.com/2015/12/07/malware-analysis-dridex-process-hollowing/)\nshows the first step of the process hollowing technique where the payload creates a new\n“svchost.exe” instance in SUSPENDED state.\n\nand then uses WriteProcessMemory API to inject the malicious payload\n\nThen the main thread, which is still in suspended state, is changed in order to point to the\nentry point of the new image base using the SetThreadContext API. Finally, the\nResumeThread API is invoked and the malicious code starts executing. The malware also\n[has the capabilities to bypass User Account Control (UAC) if needed. From this moment](http://blog.jpcert.or.jp/2015/02/a-new-uac-bypass-method-that-dridex-uses.html)\nonward, the control is passed over “svchost.exe” and Plug-X starts doing its thing. In this\ncase we have the builder so we know the settings which were defined during building\nprocess. However, we would like to understand how could we extract the configuration\n[settings. During Black Hat 2014, Takahiro Haruyama and](https://twitter.com/cci_forensics) [Hiroshi Suzuki gave a presentation](https://twitter.com/herosi_t)\n[titled “I know You Want Me – Unplugging PlugX” where the authors go to great length](https://www.blackhat.com/docs/asia-14/materials/Haruyama/Asia-14-Haruyama-I-Know-You-Want-Me-Unplugging-PlugX.pdf)\nanalyzing a variety of PlugX samples, its evolution and categorizing them into threat groups.\n[But better is that the Takahiro released a set of PlugX parsers for the different types of PlugX](http://takahiroharuyama.github.io/blog/2014/03/27/id-slash-idapython-scripts-extracting-plugx-configs/)\nsamples i.e, Type I, Type II and Type III. How can we use this parser? The one we are\n\n\n-----\n\ndealing in this article is considered a PlugX type II. To dump the configuration, we need to\nuse Immunity Debugger and use the Python API. We need to place the “plugx_dumper.py”\nfile into the “PyCommands” folder inside Immunity Debugger installation path. Then attached\nthe debugger to the infected process e.g, “svchost.exe” and run the plugin. The plugin will\ndump the configuration settings and will also extract the decompressed DLL\n\nWe can see that this parser is able to find the injected shellcode, decode its configuration\nand all the settings an attacker would set on the builder and also dump the injected DLL\nwhich contains the core functionality of the malware.\n\nIn terms of networking, as observed in the PlugX controller, the malware can be configured\nto speak with a controller using several network protocols. In this case we configured it to\nspeak using HTTP on port 80. The network traffic contains a 16-byte header followed by a\npayload. The header is encoded with a custom routine and the payload is encoded and\ncompressed with LZNT1. Far from a comprehensive analysis we launched a Shell prompt\nfrom the controller, typed command “ipconfig” and observed the network traffic. In parallel,\n\n\n-----\n\nwe attached a debugger to svchost.exe and set breakpoints: on Ws2_32.dll!WSASend and\nWs2_32.dll!WSARecv to capture the packets ; on ntdll.dll!RtlCompressBuffer and\nntdll.dll!RtlDecompressBuffer to view the data before and after compression. ; On custom\nencoding routine to view the data before and after. The figure below shows a disassemble\nlisting of the custom encoding routine.\n\nSo, from a debugger view, with the right breakpoints we could start to observe what is\nhappening. In the picture below, on the left-hand side it shows the packet before encoding\nand compression. It contains a 16-byte header, where the first 4-bytes are the key for the\ncustom encoding routine. The next 4-bytes are the flags which contain the\ncommands/plugins being used. Then the next 4-bytes is the size. After the header there is\nthe payload which in this case contains is output of the ipconfig.exe command. On the righthand side, we have the packet after encoding and compressing. It contains the 16-byte\nheader encoded following by the payload encoded and compressed.\n\n\n-----\n\nThen, the malware uses WSASend API to send the traffic.\n\nCapturing the traffic, we can observe the same data.\n\n\n-----\n\nOn the controller side, when the packet arrives, the header will be decoded and then the\npayload will be decoded and decompressed. Finally, the output is showed to the operator.\n\nNow that we started to understand how C2 traffic is handled, we can capture it and decode it.\nKyle Creyts has created a [PlugX decoder that supports PCAP’s. The decoder supports](https://github.com/kcreyts/plugxdecoder)\n[decryption of PlugX Type I.But Fabien Perigaud reversed the Type II algorithm and](https://airbus-cyber-security.com/plugx-v2-meet-scontroller/)\nimplemented it in python. If we combine Kyle’s work with the work from Takahiro Haruyama\nand Fabien Perigaud we could create a PCAP parser to extract PlugX Type II and Type III.\nBelow illustrates a proof-of-concept for this exercise against 1 packet. We captured the traffic\nand then used a small python script to decrypt a packet. No dependencies on Windows\n[because it uses the herrcore’s standalone LZNT1 implementation that is based on the one](https://gist.github.com/herrcore/344ba2ea540f622b52efba858050539f)\nfrom the [ChopShop protocol analysis and decoder framework by MITRE.](https://github.com/MITRECND/chopshop)\n\n\n-----\n\nThat’s it for today! We build a lab with a PlugX controller, got a view on its capabilities. Then\nwe looked at the malware installation and debugged it in order to find and interpret some of\nits mechanics such as DLL search order hijacking, obfuscated shellcode, persistence\nmechanism and process hollowing. Then, we used a readily available parser to dump its\nconfiguration from memory. Finally, we briefly looked the way the malware communicates\nwith the C2 and created a small script to decode the traffic. Now, with such environment\nready, in a controlled and isolated lab, we can further simulate different tools and techniques\n\n\n-----\n\nand observe how an attacker would operate compromised systems. Then we can learn,\npractice at our own pace and look behind the scenes to better understand attack methods\nand ideally find and implement countermeasures.\n\nReferences:\n[Analysis of a PlugX malware variant used for targeted attacks by CRCL.lu](http://circl.lu/assets/files/tr-12/tr-12-circl-plugx-analysis-v1.pdf)\n[Operation Cloud Hopper by PWC](https://www.pwc.co.uk/cyber-security/pdf/cloud-hopper-annex-b-final.pdf)\n[PlugX Payload Extraction by Kevin O’Reilly](https://info.contextis.com/acton/attachment/24535/f-030c/1/-/-/-/-/PlugX%20-%20Payload%20Extraction.pdf)\nOther than the authors and articles cited troughout the article, a fantastic compilation about\n[PlugX articles and papers since 2011 is available here.](http://tracker.h3x.eu/info/290)\n\nCredits: Thanks to [Michael Bailey who showed me new techniques on how to deal with](https://twitter.com/mykill)\nshellcode which I will likely cover on a post soon.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-02-04 - MALWARE ANALYSIS – PLUGX.pdf"
    ],
    "report_names": [
        "2018-02-04 - MALWARE ANALYSIS – PLUGX.pdf"
    ],
    "threat_actors": [
        {
            "id": "ec14074c-8517-40e1-b4d7-3897f1254487",
            "created_at": "2023-01-06T13:46:38.300905Z",
            "updated_at": "2025-03-27T02:00:02.799108Z",
            "deleted_at": null,
            "main_name": "APT10",
            "aliases": [
                "TA429",
                "STONE PANDA",
                "POTASSIUM",
                "Red Apollo",
                "HOGFISH",
                "Cloud Hopper",
                "BRONZE RIVERSIDE",
                "ATK41",
                "G0045",
                "Menupass Team",
                "happyyongzi",
                "CVNX",
                "Granite Taurus"
            ],
            "source_name": "MISPGALAXY:APT10",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ba3fff0c-3ba0-4855-9eeb-1af9ee18136a",
            "created_at": "2022-10-25T15:50:23.298889Z",
            "updated_at": "2025-03-27T02:00:55.433541Z",
            "deleted_at": null,
            "main_name": "menuPass",
            "aliases": [
                "menuPass",
                "POTASSIUM",
                "Stone Panda",
                "APT10",
                "Red Apollo",
                "CVNX",
                "HOGFISH",
                "BRONZE RIVERSIDE"
            ],
            "source_name": "MITRE:menuPass",
            "tools": [
                "certutil",
                "FYAnti",
                "UPPERCUT",
                "SNUGRIDE",
                "P8RAT",
                "RedLeaves",
                "SodaMaster",
                "pwdump",
                "Mimikatz",
                "PlugX",
                "PowerSploit",
                "ChChes",
                "cmd",
                "QuasarRAT",
                "AdFind",
                "Cobalt Strike",
                "PoisonIvy",
                "EvilGrab",
                "esentutl",
                "Impacket",
                "Ecipekac",
                "PsExec",
                "HUI Loader"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "ba9fa308-a29a-4928-9c06-73aafec7624c",
            "created_at": "2024-05-01T02:03:07.981061Z",
            "updated_at": "2025-03-27T02:05:17.28602Z",
            "deleted_at": null,
            "main_name": "BRONZE RIVERSIDE",
            "aliases": [
                "CTG-5938 ",
                "CVNX ",
                "Hogfish ",
                "MenuPass ",
                "POTASSIUM ",
                "Red Apollo ",
                "Stone Panda ",
                "APT10 "
            ],
            "source_name": "Secureworks:BRONZE RIVERSIDE",
            "tools": [
                " ChChes",
                " Cobalt Strike",
                " PlugX",
                " PoisonIvy",
                " QuasarRAT",
                " QuasarRAT Loader",
                " RedLeaves",
                "ANEL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "04b07437-41bb-4126-bcbb-def16f19d7c6",
            "created_at": "2022-10-25T16:07:24.232628Z",
            "updated_at": "2025-03-27T02:02:10.146043Z",
            "deleted_at": null,
            "main_name": "Stone Panda",
            "aliases": [
                "APT 10",
                "ATK 41",
                "Bronze Riverside",
                "CTG-5938",
                "CVNX",
                "Cuckoo Spear",
                "Earth Kasha",
                "Granite Taurus",
                "Happyyongzi",
                "Hogfish",
                "ITG01",
                "Operation A41APT",
                "Operation Cache Panda",
                "Operation ChessMaster",
                "Operation Cloud Hopper",
                "Operation Cuckoo Spear",
                "Operation New Battle",
                "Operation Soft Cell",
                "Operation TradeSecret",
                "Potassium",
                "Red Apollo",
                "Stone Panda",
                "TA429",
                "menuPass",
                "menuPass Team"
            ],
            "source_name": "ETDA:Stone Panda",
            "tools": [
                "Agent.dhwf",
                "Agentemis",
                "Anel",
                "AngryRebel",
                "BKDR_EVILOGE",
                "BKDR_HGDER",
                "BKDR_NVICM",
                "BUGJUICE",
                "CHINACHOPPER",
                "ChChes",
                "China Chopper",
                "Chymine",
                "CinaRAT",
                "Cobalt Strike",
                "CobaltStrike",
                "DARKTOWN",
                "DESLoader",
                "DILLJUICE",
                "DILLWEED",
                "Darkmoon",
                "DelfsCake",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "Ecipekac",
                "Emdivi",
                "EvilGrab",
                "EvilGrab RAT",
                "FYAnti",
                "Farfli",
                "Gen:Trojan.Heur.PT",
                "Gh0st RAT",
                "Ghost RAT",
                "GreetCake",
                "HAYMAKER",
                "HEAVYHAND",
                "HEAVYPOT",
                "HTran",
                "HUC Packet Transmit Tool",
                "Ham Backdoor",
                "HiddenFace",
                "Impacket",
                "Invoke the Hash",
                "KABOB",
                "Kaba",
                "Korplug",
                "LODEINFO",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "MiS-Type",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "NBTscan",
                "NOOPDOOR",
                "Newsripper",
                "P8RAT",
                "PCRat",
                "PlugX",
                "Poison Ivy",
                "Poldat",
                "PowerSploit",
                "PowerView",
                "PsExec",
                "PsList",
                "Quarks PwDump",
                "Quasar RAT",
                "QuasarRAT",
                "RedDelta",
                "RedLeaves",
                "Rubeus",
                "SNUGRIDE",
                "SPIVY",
                "SharpSploit",
                "SigLoader",
                "SinoChopper",
                "SodaMaster",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Trochilus RAT",
                "UpperCut",
                "Vidgrab",
                "WinRAR",
                "WmiExec",
                "Wmonder",
                "Xamtrav",
                "Yggdrasil",
                "Zlib",
                "certutil",
                "certutil.exe",
                "cobeacon",
                "dfls",
                "lena",
                "nbtscan",
                "pivy",
                "poisonivy",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536245,
    "ts_updated_at": 1743041834,
    "ts_creation_date": 1653762326,
    "ts_modification_date": 1653762326,
    "files": {
        "pdf": "https://archive.orkl.eu/cfd172508bbd7569019c61559b99cbe39067975f.pdf",
        "text": "https://archive.orkl.eu/cfd172508bbd7569019c61559b99cbe39067975f.txt",
        "img": "https://archive.orkl.eu/cfd172508bbd7569019c61559b99cbe39067975f.jpg"
    }
}