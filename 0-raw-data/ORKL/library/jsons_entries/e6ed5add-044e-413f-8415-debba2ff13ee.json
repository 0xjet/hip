{
    "id": "e6ed5add-044e-413f-8415-debba2ff13ee",
    "created_at": "2023-01-12T15:08:43.613821Z",
    "updated_at": "2025-03-27T02:16:41.948872Z",
    "deleted_at": null,
    "sha1_hash": "2447819675e4b6bd40638b09d0e1ac16df42b7f9",
    "title": "2021-07-08 - Observations and Recommendations from the Ongoing REvil-Kaseya Incident",
    "authors": "",
    "file_creation_date": "2022-05-28T19:41:07Z",
    "file_modification_date": "2022-05-28T19:41:07Z",
    "file_size": 557835,
    "plain_text": "# Observations and Recommendations from the Ongoing REvil-Kaseya Incident\n\n**[blog.gigamon.com/2021/07/08/observations-and-recommendations-from-the-ongoing-revil-kaseya-incident/](https://blog.gigamon.com/2021/07/08/observations-and-recommendations-from-the-ongoing-revil-kaseya-incident/)**\n\nJuly 8, 2021\n\n[Home »](https://blog.gigamon.com/) [Security » Observations and Recommendations from the Ongoing REvil-Kaseya](https://blog.gigamon.com/category/security/)\nIncident\n\n[Security / July 8, 2021](https://blog.gigamon.com/category/security/)\n\n[Joe Slowik &nbsp](https://blog.gigamon.com/author/joeslowik/)\n\n## Background\n\nOn July 2, 2021, software vendor Kaseya’s [VSA remote monitoring and management tool](https://helpdesk.kaseya.com/hc/en-gb/categories/360001423952-VSA)\n[became the point of focus for an intrusion campaign impacting multiple managed service](https://helpdesk.kaseya.com/hc/en-gb/articles/4403584098961)\nproviders (MSPs). While initially viewed as a software supply-chain intrusion (implying\ncompromise of Kaseya and modification of VSA packages), subsequent analysis identified\n[the intrusion sequence as exploitation of known but unpatched vulnerabilities in VSA,](https://csirt.divd.nl/2021/07/04/Kaseya-Case-Update-2/)\n\n\n-----\n\n[followed by use of MSP privileged connections to clients to deliver REvil ransomware. REvil,](https://attack.mitre.org/software/S0496/)\n[similar to DarkSide ransomware, operates via an affiliate model where attackers can operate](https://blog.gigamon.com/2021/05/17/tracking-darkside-and-ransomware-the-network-view/)\nthe malware.\n\n[Continuous updates from security firm Huntress as well as Kaseya itself indicated dozens of](https://www.huntress.com/blog/rapid-response-kaseya-vsa-mass-msp-ransomware-incident)\nVSA customers (MSPs) were impacted, leading to follow-on impacts at more than one\nthousand entities linked to the impacted MSPs.\n\n[Affected entities ranged from a Swedish grocery chain that shuttered hundreds of locations](https://www.bbc.com/news/technology-57707530)\ndue to the incident, to [several school systems in New Zealand.](https://www.nzherald.co.nz/nz/kaseya-ransomware-attack-millions-demanded-in-ransom-as-businesses-scramble-to-stem-impact/ZEVUH4BEMFK5C5SPT5JQ5SQMYE/)\n\nWhile the impact of this incident will only become clear with more time, sufficient information\nnow exists to analyze precisely how this event took place, and how network defenders can\nprepare for future, similar incidents should they occur.\n\n## Initial Delivery and Execution\n\nInitial delivery and execution mechanisms for this incident relied on identification and\n[subsequent exploitation of vulnerabilities within the VSA platform. While initial reporting](https://www.wired.com/story/kaseya-supply-chain-ransomware-attack-msps/)\n[suggested a potential breach at Kaseya leading to the distribution of malicious VSA updates,](https://therecord.media/revil-ransomware-executes-supply-chain-attack-via-malicious-kaseya-update/)\n[subsequent analysis revealed this to not be the case. Instead, while the company’s software](https://csirt.divd.nl/2021/07/04/Kaseya-Case-Update-2/)\nwas certainly impacted through the event, Kaseya itself appears to have avoided a breach of\nits own network.\n\n\n-----\n\nRather than a software supply chain compromise, the incident instead reflects a services\nsupply chain incident. In this scenario, the adversary abuses trust relationships between\nultimate victims and MSPs in order to deploy a malicious capability.\n\nPrevious examples of service-focused supply chain activity include the CloudHopper\ncampaign and the [Palmetto Fusion activity](https://collaborate.mitre.org/attackics/index.php/Group/G0009) [described by the U.S. government. At this time, it](https://www.washingtonpost.com/world/national-security/us-officials-say-russian-government-hackers-have-penetrated-energy-and-nuclear-company-business-networks/2017/07/08/bbfde9a2-638b-11e7-8adc-fea80e32bf47_story.html)\nis not clear whether the MSPs targeted in this incident were deliberate selections (for\nexample, based on the number or type of clients managed) or opportunistic identification of\nentities running vulnerable and exposed VSA instances. On the latter point, Kaseya\nrepeatedly stated during response to this incident that only the on-premises version of VSA\nwas impacted by the vulnerabilities under discussion, while the software as a service (SaaS)\n[platform showed no evidence of exploitation.](https://helpdesk.kaseya.com/hc/en-gb/articles/4403584098961)\n\nBased on [analysis from Huntress, enabled through data sharing from victim MSPs, initial](https://www.huntress.com/blog/rapid-response-kaseya-vsa-mass-msp-ransomware-incident)\nintrusion at MSP entities started by accessing an externally exposed VSA-related resource\n— dl.asp — and abusing a flaw in that application’s authentication process. Once\nauthentication was circumvented, the intruders used built-in VSA functionality to upload at\nleast two files:\n\nAgent.crt, an encoded REvil ransomware payload that would be distributed to MSP\nclients\nScreenshot.jpg, an executable masquerading as an image file designed to delete\nrelevant logs and other cleanup actions on impacted VSA instances\n\nWhile upload of these items appears to have abused legitimate VSA functionality following\nthe authentication bypass noted above, actual process execution appears to rely on another\nvulnerability, potentially SQL injection, via another exposed application,\nuserFilterTableRpt.asp. Through exploitation, the REvil affiliate would be able to achieve\ncommand execution of the deployed payloads in the victim environment, leading to follow-on\ninfection stages described below.\n\nAs noted by Kaseya, the following HTTP GET and POST requests relate to the previouslydescribed activity:\n```\nPOST: /dl.asp, /cgi-bin/KUpload.dll, /userFilterTableRpt.asp\nGET: /done.asp\n\n```\nThe above items in this specific incident were accessed by an entity potentially using the\n[command line tool cURL based on the User Agent “curl/7.69.1” in network logs and traffic.](https://curl.se/)\n\nWhile specific evidence is unavailable at the time of this writing, the above exploitation path\nindicates the REvil affiliate involved was able to access VSA instances directly via an\n[external network connection. Review of VSA exposure through web scanning tools indicated](https://beta.shodan.io/search?query=server:+kaseya+app+server)\n\n\n-----\n\n[more than one thousand such instances were externally accessible at the time of the incident](https://csirt.divd.nl/2021/07/06/Kaseya-Case-Update-3/)\n(although significantly reduced since then), indicating a potential intrusion path while also\ninforming victim selection based purely on availability.\n\n## Subsequent Propagation to Victims\n\nOnce the intruder compromised MSP entities, they abused VSA characteristics to enable\nfollow-on distribution and execution of REvil ransomware in MSP customer environments.\nThe entity enabled this phase of operations through a combination of impersonating\nlegitimate VSA functionality for distribution and using Kaseya-prescribed antivirus directory\nexclusions to evade (some) security solutions.\n\n[Based on reporting from multiple](https://news.sophos.com/en-us/2021/07/04/independence-day-revil-uses-supply-chain-exploit-to-attack-hundreds-of-businesses/) [third](https://doublepulsar.com/kaseya-supply-chain-attack-delivers-mass-ransomware-event-to-us-companies-76e4ec6ec64b) [parties, subsequent activity leverages the legitimate](https://www.cybereason.com/blog/cybereason-vs-revil-ransomware-the-kaseya-chronicles)\nKaseya VSA update agent (agentmon.exe on local systems) to push a malicious update\nobject that drops an encoded file (agent.crt) to disk. The update agent then launches a series\nof Windows commands for subsequent functionality on victim machines:\n```\nping 127.0.0.1 -n <Parameter> >> nul &\n%SystemDrive%\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe Set-MpPreference\n-DisableRealtimeMonitoring $true -DisableIntrusionPreventionSystem $true DisableIOAVProtection $true -DisableScriptScanning $true EnableControlledFolderAccess Disabled -EnableNetworkProtection AuditMode -Force MAPSReporting Disabled -SubmitSamplesConsent NeverSend & copy /Y\n%SystemDrive%\\Windows\\System32\\certutil.exe %SystemDrive%\\Windows\\cert.exe & echo\n%RANDOM% >>>> %SystemDrive%\\Windows\\cert.exe & %SystemDrive%\\Windows\\cert.exe -decode\n<VSA Agent Directory>\\agent.crt <VSA Agent Directory> \\agent.exe & del /q /f <VSA\nAgent Directory> \\agent.crt %SystemDrive%\\Windows\\cert.exe & <VSA Agent\nDirectory>\\agent.exe\n\n```\nThe above breaks down to the following steps:\n\n1. Establish a timer via the “ping” function to localhost, setting the number of pings to\n\nroughly equal the amount of time between execution and 1630 UTC on 02 July 2021.\nIn this fashion, all payloads are synchronized to execute at approximately the same\ntime.\n2. Use PowerShell to disable multiple security, prevention, and monitoring functions on\n\nthe victim machine.\n[3. Create a copy of the legitimate Windows binary “certutil.exe” in the Windows directory.](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil)\n4. Use the copy of certutil to decode the “agent.crt” payload, save it as an executable,\n\nthen launch the program.\n5. Remove artifacts (agent.crt, agent.exe, and the copy of certutil) from the victim host.\n\n\n-----\n\nAt the end of the above sequence, a REvil ransomware variant executes, resulting in\nencryption of the host. Of note, while REvil contains the capability of “checking in” with\ncontrollers (to send victim information and other statistics) via a list of domains within the\nransomware’s configuration, the specific REvil variants distributed in this campaign disabled\nthis functionality. As a result, network traffic from the ransomware execution is essentially\nnon-existent, with no observed Command and Control (C2) observables, or even (given the\ndistribution mechanism) artifacts related to lateral movement.\n\n## Detection and Defensive Possibilities\n\nThe above sequence of behaviors presents a vexing problem to network defenders,\nespecially for those representing ultimate victims for ransomware operations. Given the use\n(and abuse) of otherwise legitimate, trusted network pathways, detection and mitigation\nopportunities would appear limited. Yet, by reviewing how this operation took place, even\nwith only preliminary data and investigations ongoing, viable defensive strategies are\nrevealed. Through appropriate leveraging of available data sources, recognizing adversary\ntradecraft, and applying this understanding to revealed anomalies in network observables,\ndefenders can formulate a plan to detect similar attack vectors in future encounters.\n\n### Intermediate Victim Opportunities\n\nThe REvil affiliate in this campaign breached MSPs using an unpatched vulnerability in\nexternal-facing software. While the vulnerability aspect of matters presents a difficult to\naddress problem, as it was neither publicly disclosed nor was there a patch available, other\naspects of this initial intrusion pathway offer multiple detection and mitigation possibilities.\n\nFirst, attack surface identification, and subsequent reduction, could remove or substantially\nlimit access to vulnerable resources (such as the VSA portal). While potentially limiting ease\nand convenience of access, placing such a portal behind a virtual private network (VPN) or\nother control significantly increases the difficulty of exploitation or even illicit authentication to\nthe resource. Identifying such resources and implementing appropriate security architecture\nthus represents a powerful if not critical control that may have minimized risk of incidents\nsuch as this REvil event. Furthermore, establishing such limits facilitates the creation of\nnetwork choke points that can enable further monitoring of environments and ensuring that\ntraffic of interest passes through sensors for analysis and response.\n\nSecond, the events in question reveal several anomalous items that are revealed through\nnetwork security monitoring (NSM) and analysis. For example, MSP compromise relies not\njust on subverting authentication, but using this to enable upload of malicious payloads via\nan authorized portal. Yet identifying or baselining what should be uploaded through such\napplications can allow defenders to identify suspicious or outright malicious objects utilizing\nthis mechanism. Such an approach is especially rewarded in cases like “Screenshot.jpg,”\nwhere a file object attempts to use a benign extension to mask a binary payload, and\n“Agent crt ” where an executable is transferred using a common encoding schema\n\n\n-----\n\nThird, various activities described previously, from authentication to upload to command\ninjection to achieve program execution, took place via a somewhat anomalous User Agent\nbelonging to the cURL utility. While cURL is a legitimate program, identifying this User Agent\nassociated with the network activities linked to ultimate REvil distribution is exceptionally\nstrange, and provides a potential alerting point for intrusions. Categorizing and appropriately\nprofiling communication metadata, especially linked to sensitive resources such as\ninteractive portals, or even HTTP commands such as POST associated with plaintext\ncommands or other observables, can assist in identifying activity for further investigation.\n\n### Ultimate Victim Defensive Measures\n\nFrom the perspective of ultimate victims of this campaign, defensive measures are sadly\nmore limited. An organization adopting best practices from their vendor would be left almost\ncompletely blind to potential exploitation given the use of a trusted network path (update\npush from MSP VSA nodes) and requirements to curtail or eliminate security monitoring of\nproduct directories.\n\nBased on these observations, one of the first concrete actions defenders and asset owners\ncan take in this situation is to simply ignore (or at least refine) vendor recommendations.\nInstead of allow-listing or omitting entire directories from security monitoring and response,\nnarrowly tailoring adjustments to match specific file names, file paths, and potentially even\nfile signatures could significantly reduce attack surface and minimize a malicious actor’s\nability to action a supply chain compromise. Such work is, however, arduous and has the risk\nof breaking updates or other functionality. Yet, as examples like this incident and the previous\n[SolarWinds and Microsoft intrusion linked to Russian intelligence operations demonstrate,](https://www.domaintools.com/resources/blog/continuous-eruption-further-analysis-of-the-solarwinds-supply-incident)\nthe testing and analysis required to action such limits may be well worth the effort given the\nincrease in security by treating vendor updates with greater scrutiny.\n\nFrom a network perspective, defenders are in a more limited state as services such as the\nVSA update process will leverage implicitly-trusted, likely encrypted pathways for data\ntransfer. Yet as such trust-subverting intrusions become more common, organizations gain\ngreater incentive to apply further scrutiny to these relationships.\n\n[Through techniques such as SSL decryption and greater application of NSM practices to](https://www.gigamon.com/products/optimize-traffic/traffic-intelligence/gigasmart/ssl-tls-decryption.html)\neven nominally-trusted communication pathways, defenders can potentially identify the initial\nstages of an intrusion such as that employed by REvil operators in this incident. Looking for\ncommunication artifacts or observables such as the transfer of encoded objects (like\n“agent.crt”) or downloaded binary files without a known good, known expected signature can\nserve as critical tripwires for defenders that matters are not what they seem, leading to a\nresponse that curtails or prevents subsequent ransomware activity.\n\n## Conclusion\n\n\n-----\n\nSupply chain-oriented intrusions, whether through products or services, are an increasing\nthreat to organizations. By adopting a more robust and complete posture with respect to\n[NSM and network detection and response (NDR), defenders can identify the precursors](https://www.gigamon.com/products/detect-respond/gigamon-threatinsight.html)\nassociated with such activity (if they are a supplier of interest, in products or services), or\nalterations in otherwise normal activity (if one is an end user).\n\nBy minimizing blind spots; increasing visibility into all traffic, including TLS inspection; and\nanalyzing communication streams, combined with thorough coverage of systems and\nendpoints, defenders can layer defenses in such a fashion to detect or even defeat these\ntypes of intrusions, whether their ultimate goal is ransomware deployment, as seen in this\nincident, or espionage operations.\n\n## How to Take Action\n\nTo learn how to leverage Gigamon for SSL decryption and blind spot elimination for better\n[NSM and for network detection and response, contact us here.](https://www.gigamon.com/contact-sales.html?intcid=blog)\n\nCONTINUE THE DISCUSSION\n\nPeople are talking about this in the Gigamon Community’s Network Detection and Response\n(NDR) group.\n\n**Share your thoughts today**\n\n[NDR Resource](https://blog.gigamon.com/tag/ndr-resource/) [Ransomware](https://blog.gigamon.com/tag/ransomware/)\n\n## RELATED CONTENT\n\nREPORT\n\n2022 Ransomware Defense Report\n\nGET YOUR COPY\n\nWEBINAR\n\nRansomware Best Practices: Agentless Threat Hunting\n\n\n-----\n\nWATCH ON-DEMAND\n\nREPORT\n\n2022 TLS Trends Data\n\nDOWNLOAD REPORT\n\nWEBPAGE\n\nSuddenly, Ransomware Has Nowhere to Hide\n\nTAKE A LOOK\n\nOLDER ARTICLE\n\nPartner Spotlight: Gigamon and The Teneo Group Help Customers with Their Changing\nNeeds\nNEWER ARTICLE\n\n[What Is TLS 1.2, and Why Should You (Still) Care?](https://blog.gigamon.com/2021/07/14/what-is-tls-1-2-and-why-should-you-still-care/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-08 - Observations and Recommendations from the Ongoing REvil-Kaseya Incident.pdf"
    ],
    "report_names": [
        "2021-07-08 - Observations and Recommendations from the Ongoing REvil-Kaseya Incident.pdf"
    ],
    "threat_actors": [
        {
            "id": "a792743d-78a4-40c9-9d9a-a12c52880297",
            "created_at": "2023-01-06T13:46:38.75457Z",
            "updated_at": "2025-03-27T02:00:02.909884Z",
            "deleted_at": null,
            "main_name": "ALLANITE",
            "aliases": [
                "Palmetto Fusion",
                "Allanite"
            ],
            "source_name": "MISPGALAXY:ALLANITE",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ec14074c-8517-40e1-b4d7-3897f1254487",
            "created_at": "2023-01-06T13:46:38.300905Z",
            "updated_at": "2025-03-27T02:00:02.799108Z",
            "deleted_at": null,
            "main_name": "APT10",
            "aliases": [
                "TA429",
                "STONE PANDA",
                "POTASSIUM",
                "Red Apollo",
                "HOGFISH",
                "Cloud Hopper",
                "BRONZE RIVERSIDE",
                "ATK41",
                "G0045",
                "Menupass Team",
                "happyyongzi",
                "CVNX",
                "Granite Taurus"
            ],
            "source_name": "MISPGALAXY:APT10",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "46a151bd-e4c2-46f9-aee9-ee6942b01098",
            "created_at": "2023-01-06T13:46:38.288168Z",
            "updated_at": "2025-03-27T02:00:02.794118Z",
            "deleted_at": null,
            "main_name": "APT19",
            "aliases": [
                "Black Vine",
                "TEMP.Avengers",
                "PinkPanther",
                "G0073",
                "KungFu Kittens",
                "Group 13",
                "Shell Crew",
                "BRONZE FIRESTONE",
                "G0009",
                "Sunshop Group",
                "DEEP PANDA",
                "Codoso"
            ],
            "source_name": "MISPGALAXY:APT19",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "0a0132a3-526d-4698-be49-5e75530c1417",
            "created_at": "2022-10-25T15:50:23.856139Z",
            "updated_at": "2025-03-27T02:00:55.559398Z",
            "deleted_at": null,
            "main_name": "ALLANITE",
            "aliases": [
                "ALLANITE",
                "Palmetto Fusion"
            ],
            "source_name": "MITRE:ALLANITE",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "1c4281e9-0a4c-4f20-94a2-25ed3661cc98",
            "created_at": "2022-10-25T16:07:23.301826Z",
            "updated_at": "2025-03-27T02:02:09.72625Z",
            "deleted_at": null,
            "main_name": "Allanite",
            "aliases": [
                "Palmetto Fusion"
            ],
            "source_name": "ETDA:Allanite",
            "tools": [
                "PsExec",
                "SecreetsDump",
                "THC Hydra"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536123,
    "ts_updated_at": 1743041801,
    "ts_creation_date": 1653766867,
    "ts_modification_date": 1653766867,
    "files": {
        "pdf": "https://archive.orkl.eu/2447819675e4b6bd40638b09d0e1ac16df42b7f9.pdf",
        "text": "https://archive.orkl.eu/2447819675e4b6bd40638b09d0e1ac16df42b7f9.txt",
        "img": "https://archive.orkl.eu/2447819675e4b6bd40638b09d0e1ac16df42b7f9.jpg"
    }
}