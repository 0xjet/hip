{
    "id": "98377891-6d2f-4ca7-b2b7-76c862d1f1a8",
    "created_at": "2023-01-12T15:04:57.03655Z",
    "updated_at": "2025-03-27T02:14:12.244539Z",
    "deleted_at": null,
    "sha1_hash": "3914c4b6300324afaf331a0d135ced2df204ce91",
    "title": "2020-06-08 - Analysis of Valak Maldoc",
    "authors": "",
    "file_creation_date": "2022-05-27T22:12:19Z",
    "file_modification_date": "2022-05-27T22:12:19Z",
    "file_size": 1030653,
    "plain_text": "# Analysis of Valak Maldoc\n\n**security-soup.net/analysis-of-valak-maldoc/**\n\nadmin June 8, 2020\n\n## Summary\n\nThe Valak malware variant appears to be an emerging threat due to an increased volume of\ncampaign activity by its operators. Besides its relative newness, Valak is also noteworthy for\na few of its other operational aspects such as an interesting execution chain and some\nunconventional tactics leveraged in the VB macro script of its maldoc downloader. One of\nthese interesting samples of the Valak malware came across my desk earlier this week, so I\nwanted to share some additional details that may help others in their own analysis and\nperhaps provide some insight into how to approach its detection, response, and remediation.\n\n\n-----\n\nIn this blog, I will briefly share a Python script I developed to crack the password protected\nmaldocs in the event an analyst does not have access to the original email message\ncontaining the password. Next, I will cover a few different methods that can be utilized to\nextract the VBA macros from the document. Finally, I will show a quick how-to with some\nbasic static analysis techniques to de-obfuscate the macro script, and review the antianalysis/evasion tactics within the document, and extract the indicators of compromise\n(IOCs) therein. Let’s go!\n\n## Valak Overview\n\nThe Valak malware was first discovered around December 2019. It appears to be generally\nused as a downloader to deliver secondary malware payloads for other eCrime actors. In\nparticular, it [appears that](https://www.malware-traffic-analysis.net/2020/06/03/index2.html) [Lunar Spider‘s Bokbot (IcedID) is a common follow-up malware in](https://malpedia.caad.fkie.fraunhofer.de/actor/lunar_spider)\nrecent campaigns. However, Valak is a modular framework that has the capability to\ndownload additional plugins to facilitate infostealing and reconnaissance. Security\n[researchers at Cybereason recently produced a great write up detailing these additional](https://www.cybereason.com/blog/valak-more-than-meets-the-eye)\ncapabilities and its overall execution chain so I would recommend checking out this resource\nfor more technical details.\n\n## Cracking the ZIP Archive\n\nThe recent Valak campaigns that I have observed have all been delivered via zipped email\nattachments that are password protected. The ZIP archive contains a Microsoft Word\ndocument that is weaponized with macros. The password is provided in the body of the\nemail. This tactic serves a dual purpose for the threat actor as it enables some basic\nsandbox evasion, but also supports the social engineering pretext by building trust with the\nintended victim and appearing more secure.\n\nMany analysts are likely to have access to the original email and thus can easily recover the\npassword. However, in some cases analysts may encounter scenarios where they obtain the\nZIP archive containing the maldoc, but do not have access to the email for a variety of\nreasons whether due to privacy limitations or simply sourcing issues from an online\nrepository or similar. I found myself in this same spot earlier this week as I was looking into\nValak samples. I had obtained the ZIP from, but I did not have access to the original email. I\nneeded to get inside to get a peek at those sweet IOCs.\n\n\n-----\n\nFigure 1. Eric Andre\n[Ultimately, my solution was to write a quick program in Python to brute-force the password](https://github.com/Sec-Soup/valak-cracker)\nand extract the archive’s contents. The password cracking portion is based on a regex of the\nknown password naming convention, so it should be noted that if/when the actors change\nthis convention this script would need to be updated. In future revisions I also plan to add the\ncapability to pass a dictionary file to the program as an argument that will help extend its\nfunctionality. I’m certainly no Pythonista, so YMMV, but this does get the job done. Please\n[feel free to use and/or suggest changes on the github:](https://github.com/Sec-Soup/valak-cracker)\n\n\n-----\n\nFigure 2. valak-cracker.py\nUsing the program is very simple as you can see below. Just invoke the Python interpreter\nand then the script’s name with the argument “-f” followed by the name of the ZIP archive. It\nwill extract the file to your working directory and print “extraction succeeded” when the\ncorrect password is found. This is compatible with Python3 and you will also need a couple\n[dependencies such as pyzipper and](https://github.com/danifus/pyzipper) [exrex.](https://github.com/asciimoo/exrex)\n\nFigure 3. Extraction Succeeded\n\n## Extracting the VBA Macro\n\nA Microsoft Office document weaponized with macros is nothing new. These VBA macros\nare executed when an unsuspecting user clicks “Enable Content,” kicking off the infection\nchain and leading to the download of next-stage payloads.\n\nWhether opening this particular maldoc with a known password or using my tool, the next\nstep is focused on extracting the VBA macro code from the Word DOC itself, which is the\ndownloader for the initial Valak DLL payload. The following document is what I recovered\nafter running the script:\n\nFilename: [dictate.06.20.doc](https://www.virustotal.com/gui/file/a4f1ea5dd434deee93bdf312f658a7a26f767c7683601fa8b23ef096392eef17/detection)\nSHA256: a4f1ea5dd434deee93bdf312f658a7a26f767c7683601fa8b23ef096392eef17\n\n\n-----\n\nUsually, analysts can quickly review these macros by simply opening up the onboard VBA\n[project editor within the MS Word Program. I’ve shown how to do this before, so I won’t go](https://security-soup.net/how-to-extract-network-indicators-of-compromise-iocs-from-maldoc-macros-part-3/)\ninto much detail here. Suffice to say that you can hold down SHIFT while stepping through\nthe macro to disable the auto open function or simply search through the modules contained\nwithin the project and copy out the VBA code. This approach is fairly straightforward, but can\noften be slow due to its manual nature, and if the macro is heavily obfuscated, can\nunnecessarily complicate analysis. We can do better with tools.\n\nFigure 4.\n\nThe Tool Man\nThere are lots of tools available that can help out with macro analysis, but I tend to always\ngravitate to either [oledump or](https://blog.didierstevens.com/programs/oledump-py/) [olevba. Both work great for this type of task and I will briefly](https://github.com/decalage2/oletools/wiki/olevba)\ncompare/contrast how to use these to extract the macros and also provide a little insight into\ntheir pros and cons and maybe why in certain situations you would want to use one over the\n[other. I will also give an honorable mention to ViperMonkey. This is is a powerful tool that](https://github.com/decalage2/ViperMonkey)\nincludes similar functionality to dump OLE steams and parse the VBA macro, but also\nincludes a VBA emulation engine that can automatically de-obfuscate the code as well —\nsaving a ton of time. Unfortunately, I kept getting errors on this sample so I had to do that bit\nby hand. More on this later in the next section.\n\n**oledump.py**\n\nAnyways, oledump is a program written by security researcher, Didier Stevens. As you might\nhave guessed, it dumps the streams from OLE files (DOC, XLS, PPT, etc…) and has wide\nvariety of plugins that you can use to further manipulate the dumped streams. The basic\n\n\n-----\n\nusage for oledump.py is very simple and and will print the document streams.\n\nFigure 5. The Dumped Streams\nAs highlighted in Figure 5 above, the basic command dumps the streams and highlights\nthose that contain VBA macro code. Based on this output we now know that streams A3, A4,\nA5, A12, and A13 all contain macros. I like oledump for its plugin flexibility and additional\nanalysis capabilities, but it also has many options that come onboard that can be passed as\narguments. Possibly the two most important that analysts will need to use is the\n“decompress” option which is used with the “-v” argument and the “select” option used with “s”. The raw dump of the OLE streams are compressed, so using this option combo to select\nstreams of interest is the best way to get the code human readable on the quick.\n\nFigure 6. Select and decompress\n\n\n-----\n\nHere we have our first look at the obfuscated code contained within the functions of the\nmacro. An analyst could choose to select all of the streams and dump them out at once, but\nhere they are shown separately. Most of the streams can be skipped over because they are\ncomprised of garbage code. Once we get to stream A13, we finally find something pretty\ninteresting.\n\nFigure 7. Obfuscated Array\nI gotta tell ya, bad guys just love arrays for obfuscating their macros. Rarely do I stumble\nacross a sample that doesn’t contain some sort of array declaration and then subsequent\noperations on the indices of that array to scramble the code. For now, we can just copy out\nthe dumped macros or write them to a file for future analysis. We have one more tool to\ndiscuss before getting into the de-obfuscation .\n\n**olevba**\n\nNext up is olevba, a tool written by security researcher, Philippe Lagadec. It has similar\nfunctionality as oledump, but its output is slightly different and comparatively less flexible as it\ndoes not have an extensive list of plugins. However, a noteworthy feature of oledump is its\ndefault triage mode that performs an initial analysis of the macro and provides a summary of\nsuspicious strings and operations that are identified in the document. This may give analysts\na quick boost to speed up an investigation when time constraints are critical. This program\ncan also be ran against multiple files if there is a use-case for a high volume of analyses that\nrequire automated workloads. Usage of olevba is also quite simple and can be executed via\nthe command line or used as a python module.\n\n\n-----\n\nFigure 8. Default olevba output\nThe output is for both tools is generally similar, although olevba does include a feature that\nhighlights potentially suspicious keywords in the dumped macro. For example, it will highlight\nthe “AutoOpen()” function in bright yellow, which is typically the initial indicator an analyst will\nseek out as this function is what will immediately execute when a victim opens the document.\nKeep in mind that macros are often obfuscated and not necessarily linear in operation.\n\nFigure 9. Highlight AutoOpen()\n\n\n-----\n\nIn the next example from the olevba output, we can see suspicious keywords highlighted in\nred. Here, we see a [declare statement that includes what appears to be capability to](https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/declare-statement)\n[download files from via the URLDownloadToFile function, which is part of the urlmon library](https://wellsr.com/vba/2018/excel/download-files-with-vba-urldownloadtofile/)\nbuilt in to Windows. The Lib clause is a required statement in the declaration syntax and\nindicates the macro will be loading a DLL or some other code resource (urlmon in this case).\n\nFigure 10. Highlight suspicious keywords\nFinally, we get to the end of the dumped macro. We can see here that olevba has extracted\nthe same obfuscated array as we observed previously. At the end of the output, is the triage\nsummary, which summarized all of the suspicious keywords that were highlighted in the\nautomated analysis.\n\nFigure 11. Array (again) and Summary\n\n\n-----\n\nSo, that s a quick look at two different tools that have similar capability to dump and analyze\nmacros. Both are easy to use and have broad functionality. I use both tools frequently,\ndepending on the task at hand. I would recommend downloading both and keeping them as\na part of your kit.\n\n## De-obfuscating the Macro\n\nNow that the macro code has been obtained, the final analysis step here is to de-obfuscate\nthe macro. Obfuscation and anti-analysis techniques are commonly employed to evade\ndetection and avoid complete analysis by automated sandboxes. This particular macro for\nthe Valak malware sample is not that complicated and so it can be decoded fairly easily. The\ntools covered above include several options that can aid in this type of de-obfuscation such\nas manipulating and decoding strings, but it isn’t really necessary in this situation. Compared\nto some of the bizarrely extensive obfuscation in a lot of other eCrime downloaders, this\nexample is downright simple. It’s about 200 lines of mostly junk code. After removing about\n75% of the code, we are left with the only lines that perform some operations.\n\nFigure 12.Macro after junk removal\nDespite the relative simplicity of the macro obfuscation, this macro code is pretty interesting\nfor a few of its features related to evading detection. The operators have used a few sneaky\ntricks that diverge from a lot of classic TTPs that are observed in similar eCrime\n\n\n-----\n\ndownloaders. Notably, here we see a complete absence of PowerShell and/or the WebClent\nclass to download the payload from the URL. Instead we see the usage of the\nURLDownloadToFile, which is a VBA function along with the urlmon Windows library. We\n[also see a command shell opened via an interesting usage of the Exec method with a](https://www.vbsedit.com/html/5593b353-ef4b-4c99-8ae1-f963bac48929.asp)\n[WshShell object. Let me repeat that: the adversary just got shell and downloaded a file](https://www.vbsedit.com/html/5593b353-ef4b-4c99-8ae1-f963bac48929.asp)\nwithout using CMD or PowerShell. I’m no detection engineer, but I think that might cause\nsome problems. Nice.\n\nFinally, the script launches regsvr32 and loads the downloaded DLL payload into the\nprocess. The last block is the encoded array that was covered in the previous section.\nDecoding this block is easy as long as we pay attention to the split/join functions and do a\nsimple string replacement using the two keys “love” and “xxxxxxx”. The array ultimately\ndecodes into the URL where the actors have stashed the Valak DLL. It also includes an\nargument to write that downloaded file into the “C:\\ProgramData” directory as a randomly\nnamed .dat file. Here’s what the final pieces look like all cleaned up:\n\nFigure 13. Final code\n\n## Conclusion\n\nSo that’s it, my take on conducting analysis on a recent Valak sample. I’ve shared a few\nresources and tools that can hopefully enable analysts to improve the velocity and fidelity of\ntheir data gathering for triage and investigations. This variant of Valak is deceptively simple\nin its obfuscation, but definitely has some intriguing evasion and anti-analysis tricks up its\nsleeve. This is a newer threat that is just now emerging into the landscape so it remains to\nbe seen what its ultimate impact may be going forward. Its association with other high profile\neCrime threats could indicate a continuing trend towards collaboration on high volume\ncampaigns, sophisticated development cycles, and devastating post-intrusion action.\nATT&CK tagging is provided below, and I’ve included only the IOCs from this specific\n[maldoc, but others from the overall campaign are available thanks to Brad Duncan.](https://pastebin.com/WmAWQQ06)\n\n\n-----\n\n## IOCs\n\nhxxp[:]//nwwgbluv65j6g0xgr-xk[.]com/czwih/fxla[.]php?l=gap6[.]cab\n\n## ATT&CK Tagging\n\n**Initial Access**\n\n**[Phishing attachment (ATT&CK ID: T1193)](https://attack.mitre.org/techniques/T1193/)**\n**Execution**\n\n**[User Execution (ATT&CK ID: T1204)](https://attack.mitre.org/techniques/T1204/)**\n**Scripting** **[(ATT&CK ID: T1064)](https://attack.mitre.org/techniques/T1064/)**\n**[Regsvr32 (ATT&CK ID: ID: T1117)](https://attack.mitre.org/techniques/T1117/)**\n**Defense Evasion**\n\n**[Deobfuscate/Decode Files or Information (ATT&CK ID: T1140)](https://attack.mitre.org/techniques/T1140/)**\n**[Masquerading (ATT&CK ID: T1036)](https://attack.mitre.org/techniques/T1036/)**\n**[Process Injection (ATT&CK ID: T1055)](https://attack.mitre.org/techniques/T1055/)**\n**Command and Control**\n\n**[Remote File Copy (ATT&CK ID: T1105)](https://attack.mitre.org/techniques/T1105/)**\n\n## References\n\n[1] [https://www.malware-traffic-analysis.net/2020/06/03/index2.html](https://www.malware-traffic-analysis.net/2020/06/03/index2.html)\n\n[2] [https://malpedia.caad.fkie.fraunhofer.de/actor/lunar_spider](https://malpedia.caad.fkie.fraunhofer.de/actor/lunar_spider)\n\n[3] [https://www.cybereason.com/blog/valak-more-than-meets-the-eye](https://www.cybereason.com/blog/valak-more-than-meets-the-eye)\n\n[4] [https://github.com/Sec-Soup/valak-cracker](https://github.com/Sec-Soup/valak-cracker)\n\n[5] [https://github.com/danifus/pyzipper](https://github.com/danifus/pyzipper)\n\n[6] [https://github.com/asciimoo/exrex](https://github.com/asciimoo/exrex)\n\n[7] https://www.virustotal.com/gui/file/a4f1ea5dd434deee93bdf312f658a7a26f767c7683601fa\n8b23ef096392eef17/detection\n\n[8] [https://github.com/Sec-Soup/Array-Decoder/blob/master/arrayDecoder.py](https://github.com/Sec-Soup/Array-Decoder/blob/master/arrayDecoder.py)\n\n[9] https://security-soup.net/how-to-extract-network-indicators-of-compromise-iocs-frommaldoc-macros-part-3/\n\n[10] [https://blog.didierstevens.com/programs/oledump-py/](https://blog.didierstevens.com/programs/oledump-py/)\n\n[11] [https://github.com/decalage2/oletools/wiki/olevba](https://github.com/decalage2/oletools/wiki/olevba)\n\n[12] [https://github.com/decalage2/ViperMonkey](https://github.com/decalage2/ViperMonkey)\n\n\n-----\n\n[13] [https://wellsr.com/vba/2018/excel/download-files-with-vba-urldownloadtofile/](https://wellsr.com/vba/2018/excel/download-files-with-vba-urldownloadtofile/)\n\n[14] https://docs.microsoft.com/en-us/office/vba/language/reference/user-interfacehelp/declare-statement\n\n[15] [https://www.vbsedit.com/html/5593b353-ef4b-4c99-8ae1-f963bac48929.asp](https://www.vbsedit.com/html/5593b353-ef4b-4c99-8ae1-f963bac48929.asp)\n\n[16] [https://www.vbsedit.com/html/7b956233-c1aa-4b59-b36d-f3e97a9b02f0.asp](https://www.vbsedit.com/html/7b956233-c1aa-4b59-b36d-f3e97a9b02f0.asp)\n\n[17] [https://pastebin.com/WmAWQQ06](https://pastebin.com/WmAWQQ06)\n\n[10] [https://attack.mitre.org/techniques/T1204/](https://attack.mitre.org/techniques/T1204/)\n\n[11] [https://attack.mitre.org/techniques/T1117/](https://attack.mitre.org/techniques/T1117/)\n\n[12] [https://attack.mitre.org/techniques/T1047/](https://attack.mitre.org/techniques/T1047/)\n\n[14] [https://attack.mitre.org/techniques/T1140/](https://attack.mitre.org/techniques/T1140/)\n\n[15] [https://attack.mitre.org/techniques/T1036/](https://attack.mitre.org/techniques/T1036/)\n\n[16] [https://attack.mitre.org/techniques/T1055/](https://attack.mitre.org/techniques/T1055/)\n\n[17] [https://attack.mitre.org/techniques/T1105/](https://attack.mitre.org/techniques/T1105/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-08 - Analysis of Valak Maldoc.pdf"
    ],
    "report_names": [
        "2020-06-08 - Analysis of Valak Maldoc.pdf"
    ],
    "threat_actors": [
        {
            "id": "475ea823-9e47-4098-b235-0900bc1a5362",
            "created_at": "2022-10-25T16:07:24.506596Z",
            "updated_at": "2025-03-27T02:02:10.263346Z",
            "deleted_at": null,
            "main_name": "Lunar Spider",
            "aliases": [
                "Gold SwathMore"
            ],
            "source_name": "ETDA:Lunar Spider",
            "tools": [
                "BokBot",
                "IceID",
                "IcedID",
                "NeverQuest",
                "Vawtrak",
                "grabnew"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "c2385aea-d30b-4dbc-844d-fef465cf3ea9",
            "created_at": "2023-01-06T13:46:38.916521Z",
            "updated_at": "2025-03-27T02:00:02.950071Z",
            "deleted_at": null,
            "main_name": "LUNAR SPIDER",
            "aliases": [
                "GOLD SWATHMORE"
            ],
            "source_name": "MISPGALAXY:LUNAR SPIDER",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "7cfe3bc9-7a6c-4ee1-a635-5ea7b947147f",
            "created_at": "2024-06-19T02:03:08.122318Z",
            "updated_at": "2025-03-27T02:05:17.398805Z",
            "deleted_at": null,
            "main_name": "GOLD SWATHMORE",
            "aliases": [
                "Lunar Spider "
            ],
            "source_name": "Secureworks:GOLD SWATHMORE",
            "tools": [
                " GlobeImposter",
                " Gozi",
                " Gozi Trojan",
                " IcedID",
                " Latrodectus",
                " TrickBot",
                " TrickBot",
                "Cobalt Strike"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535897,
    "ts_updated_at": 1743041652,
    "ts_creation_date": 1653689539,
    "ts_modification_date": 1653689539,
    "files": {
        "pdf": "https://archive.orkl.eu/3914c4b6300324afaf331a0d135ced2df204ce91.pdf",
        "text": "https://archive.orkl.eu/3914c4b6300324afaf331a0d135ced2df204ce91.txt",
        "img": "https://archive.orkl.eu/3914c4b6300324afaf331a0d135ced2df204ce91.jpg"
    }
}