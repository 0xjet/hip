{
    "id": "225a4139-81e4-4468-a397-f13c3d87681f",
    "created_at": "2023-01-12T14:59:15.477579Z",
    "updated_at": "2025-03-27T02:17:27.708163Z",
    "deleted_at": null,
    "sha1_hash": "532851c4615c0fab9c08c6c52c81709896f47e77",
    "title": "2022-05-10 - APT34 targets Jordan Government using new Saitama backdoor",
    "authors": "",
    "file_creation_date": "2022-05-28T23:25:44Z",
    "file_modification_date": "2022-05-28T23:25:44Z",
    "file_size": 2510425,
    "plain_text": "# APT34 targets Jordan Government using new Saitama backdoor\n\n**[blog.malwarebytes.com/threat-intelligence/2022/05/apt34-targets-jordan-government-using-new-saitama-backdoor/](https://blog.malwarebytes.com/threat-intelligence/2022/05/apt34-targets-jordan-government-using-new-saitama-backdoor/)**\n\nThreat Intelligence Team May 10, 2022\n\nOn April 26th, we identified a suspicious email that targeted a government official from\nJordan’s foreign ministry. The email contained a malicious Excel document that drops a new\nbackdoor named Saitama. Following our investigation, we were able to attribute this attack to\nthe known Iranian Actor APT34.\n\nAlso known as OilRig/COBALT GYPSY/IRN2/HELIX KITTEN, APT34 is an Iranian threat\ngroup that has targeted Middle Eastern countries and victims worldwide since at least 2014.\nThe group is known to focus on the financial, governmental, energy, chemical, and\ntelecommunication sectors.\n\nIn this blog post, we describe the attack flow and share details about the Saitama backdoor.\n\n## Malicious email file\n\nThe malicious email was sent to the victim via a Microsoft Outlook account with the subject\n“Confirmation Receive Document” with an Excel file called “Confirmation Receive\nDocument.xls”. The sender pretends to be a person from the Government of Jordan by using\nits coat of arms as a signature.\n\n\n-----\n\nFigure 1: Malicious email\n\n## Excel document\n\nThe Excel attachment contains a macro that performs malicious activities. The document has\nan image that tries to convince the victim to enable a macro.\n\nFigure 2: Excel doc\nAfter enabling the macro, the image is replaced with the Jordan government’s the coat of the\narms:\n\n\n-----\n\nFigure 3: Excel doc after enabling the macro\nThe macro has been executed on WorkBook_Open(). Here are the main functionalities of\nthis macro:\n\n\n-----\n\nFigure 4: Macro\n\nHides the current sheet and shows the new sheet that contains the coat of arms image.\nCalls the “eNotif’ function which is used to send a notification of each steps of macro\nexecution to its server using the DNS protocol. To send a notification it builds the server\ndomain for that step that contains the following parts: “qw” + identification of the step (in\nthis step “zbabz”) + random number + domain name (joexpediagroup.com) =\nqwzbabz7055.joexpediagroup.com. Then it uses the following WMI query to get the IP\naddress of the request: Select * From Win32_PingStatus Where Address = ‘” &\np_sHostName & “‘” which performs the DNS communication the the created\nsubdomain.\nCreates a TaskService object and Gets the task folder that contains the list of the\ncurrent tasks\nCalls ENotif function\n\n\n-----\n\nChecks if there is a mouse connected to PC and if that is the case performs the\nfollowing steps\n\nCreates %APPDATA%/MicrosoftUpdate directory\nCreates “Update.exe”, “Update.exe.config” and\n“Microsoft.Exchange.WenServices.dll”\nReads the content of the UserForm1.label1, UserForm2.label1 and\n_UserForm3.label1 that are in base64 format, decodes them and finally writes_\nthem into the created files in the previous step\nCalls a ENotif function for each writes function\nChecks the existence of the Update.exe file and if for some reason it has not been\nwritten to disk, it writes it using a technique that loads a DotNet assembly directly using\nmscorlib and Assembly.Load by manually accessing the VTable of the IUnknown. This\n[technique was taken from Github (link). Even though, this technique was not used in](https://gist.github.com/monoxgas/1b36031c5593ebfed3229f4424f77090)\nthis macro since the file was already written, the function name (“Test”) suggests that\nthe threat actor is trying to implement this technique in future attacks.\nFinally, it calls the ENotif function.\n\n\n-----\n\nFigure 5: Load .Net assembly\n\nDefines a xml schema for a scheduled task and registers it using the RegisterTask\nfunction. The name of the scheduled task is MicrosoftUpdate and is used to make\n_update.exe persistent._\n\n\n-----\n\nFigure 6: Task Schema\n\n## Saitama Backdoor – A finite state machine\n\nThe dropped payload is a small backdoor that is written in .Net. It has the following\ninteresting pdb path: E:\\Saitama\\Saitama.Agent\\obj\\Release\\Saitama.Agent.pdb.\n\nSaitama backdoor abuses the DNS protocol for its command and control communications.\nThis is stealthier than other communication methods, such as HTTP. Also, the actor cleverly\nuses techniques such as compression and long random sleep times. They employed these\ntricks to disguise malicious traffic in between legitimate traffic.\n\n\n-----\n\n-----\n\nFigure 7: DNS communications\nAnother element that we found interesting about this backdoor is the way that it is\n[implemented. The whole flow of the program is defined explicitly as a finite-state machine, as](https://en.wikipedia.org/wiki/Finite-state_machine)\nshown in the Figure 7. In short, the machine will change its state depending on the command\nsent to every state. Graphically, the program flow can be seen as this:\n\n\n-----\n\nFigure 8: Graphical view of the state machine\nThe finite-machine state can be:\n\n### BEGIN\n\nIt is the initial state of the machine. It just accepts the start command that puts the machine\ninto the ALIVE state.\n\n### ALIVE\n\nThis state fetches the C&C server, expecting to receive a command from the attackers.\nThese servers are generated by using the PRNG algorithm that involves transformations like\nthe Mersenne Twister. These transformations will generate subdomains of the hard coded\ndomains in the Config class (Figure 8).\n\n\n-----\n\nFigure 9: Main domains are hardcoded\nFigure 9 shows an example of the generated subdomain:\n\nFigure 10: Connection attempt to a C&C server\nThis state has two possible next stages. If the performed DNS request fails, the next stage is\nSLEEP. Otherwise, the next stage is RECEIVE.\n\n### SLEEP and SECOND SLEEP\n\nThese states put the backdoor in sleep mode. The amount of time that the program will sleep\nis determined by the previous stage. It is clear that one of the main motivations of the actor is\nto be as stealthy as possible. For example, unsuccessful DNS requests puts the backdoor in\nsleep mode for a time between 6 and 8 hours! There are different sleep times depending on\nthe situations (values are expressed in milliseconds):\n\n\n-----\n\nFigure 11: A different sleep time for every situation\nThere is also a “Second Sleep” state that puts the program on sleep mode a different amount\nof time.\n\n### RECEIVE\n\nThis state is used to receiving commands from the C&C servers. Commands are sent using\nthe IP address field that is returned by the DNS requests. Further details about the\ncommunication protocol are provided later in this report. In a nutshell, every DNS request is\ncapable of receiving 4 bytes. The backdoor will concatenate responses, building buffers in\nthat way. These buffers will contain the commands that the backdoor will execute.\n\n### DO (DoTask)\n\nThat state will execute commands received from the server. The backdoor has capabilities\nlike executing remote pre-established commands, custom commands or dropping files.\nThe communication supports compression, also. The following figure shows the list of\npossible commands that can be executed by the backdoor.\n\n**ID** **Type** **Command**\n\n1 PS Get-NetIPAddress -AddressFamily IPv4 | Select-Object IPAddress\n\n2 PS Get-NetNeighbor -AddressFamily IPv4 | Select-Object “IPADDress”\n\n3 CMD whoami\n\n4 PS [System.Environment]::OSVersion.VersionString\n\n5 CMD net user\n\n\n-----\n\n**ID** **Type** **Command**\n\n6 — ———[NOT USED]———\n\n7 PS Get-ChildItem -Path “C:\\Program Files” | Select-Object Name\n\n8 PS Get-ChildItem -Path ‘C:\\Program Files (x86)’ | Select-Object Name\n\n9 PS Get-ChildItem -Path ‘C:’ | Select-Object Name\n\n10 CMD hostname\n\n11 PS Get-NetTCPConnection | Where-Object {$_.State -eq “Established”} | SelectObject “LocalAddress”, “LocalPort”, “RemoteAddress”, “RemotePort”\n\n12 PS $(ping -n 1 10.65.4.50 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.4.51 | findstr /i\nttl) -eq $null;$(ping -n 1 10.65.65.65 | findstr /i ttl) -eq $null;$(ping -n 1\n10.65.53.53 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.21.200 | findstr /i ttl) -eq\n$null\n\n13 PS nslookup ise-posture.mofagov.gover.local | findstr /i Address;nslookup\nwebmail.gov.jo | findstr /i Address\n\n14 PS $(ping -n 1 10.10.21.201 | findstr /i ttl) -eq $null;$(ping -n 1 10.10.19.201 |\nfindstr /i ttl) -eq $null;$(ping -n 1 10.10.19.202 | findstr /i ttl) -eq $null;$(ping -n\n1 10.10.24.200 | findstr /i ttl) -eq $null\n\n15 PS $(ping -n 1 10.10.10.4 | findstr /i ttl) -eq $null;$(ping -n 1 10.10.50.10 | findstr /i\nttl) -eq $null;$(ping -n 1 10.10.22.50 | findstr /i ttl) -eq $null;$(ping -n 1\n10.10.45.19 | findstr /i ttl) -eq $null\n\n16 PS $(ping -n 1 10.65.51.11 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.6.1 | findstr /i\nttl) -eq $null;$(ping -n 1 10.65.52.200 | findstr /i ttl) -eq $null;$(ping -n 1\n10.65.6.3 | findstr /i ttl) -eq $null\n\n17 PS $(ping -n 1 10.65.45.18 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.28.41 | findstr\n/i ttl) -eq $null;$(ping -n 1 10.65.36.13 | findstr /i ttl) -eq $null;$(ping -n 1\n10.65.51.10 | findstr /i ttl) -eq $null\n\n18 PS $(ping -n 1 10.10.22.42 | findstr /i ttl) -eq $null;$(ping -n 1 10.10.23.200 |\nfindstr /i ttl) -eq $null;$(ping -n 1 10.10.45.19 | findstr /i ttl) -eq $null;$(ping -n 1\n10.10.19.50 | findstr /i ttl) -eq $null\n\n19 PS $(ping -n 1 10.65.45.3 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.4.52 | findstr /i\nttl) -eq $null;$(ping -n 1 10.65.31.155 | findstr /i ttl) -eq $null;$(ping -n 1 iseposture.mofagov.gover.local | findstr /i ttl) -eq $null\n\n20 PS Get-NetIPConfiguration | Foreach IPv4DefaultGateway | Select-Object\nNextHop\n\n21 PS Get-DnsClientServerAddress -AddressFamily IPv4 | Select-Object\nSERVERAddresses\n\n\n-----\n\n**ID** **Type** **Command**\n\n22 CMD systeminfo | findstr /i \\”Domain\\”\n\nFigure 12: List of predefined commands\nIt is pretty shocking to see that even when attackers have the possibility of sending any\ncommand, they choose to add that predefined list in the backdoor in Base64 format. As we\ncan see, some of them are common reconnaissance snippets, but some of them are not that\ncommon. In fact, some of the commands contain internal IPs and also internal domain\n**names (like ise-posture.mofagov.gover.local). That shows that this malware was clearly**\ntargeted and also indicates that the actor has some previous knowledge about the internal\ninfrastructure of the victim.\n\n### SEND – SEND AND RECEIVE\n\nThe Send state is used to send the results generated by commands to the actor’s server. In\nthis case, the name of the subdomain will contain the data. As domain names are used to\nexfiltrate unknown amounts of data, attackers had to split this data in different buffers. Every\nbuffer is then sent through a different DNS request. As it can be seen in the Figure 12, all the\nrequired information in order to reconstruct original data is sent to the attackers. The size of\nthe buffer is only sent in the first packet.\n\nFigure 13: Send data to server\n\n## Attribution\n\nThere are several indicators that suggest that this campaign has been operated by APT34.\n\nMaldoc similarity: The madoc used in this campaign shared some similarities with\nmaldocs used in previous campaigns of this actor. More specifically similar to what was\nmentioned in CheckPoint’s [report this maldoc registers a scheduled task that would](https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/)\nlaunch the executable every X minutes, also it uses the same anti sandboxing\ntechnique (checking if there is a mouse connected to the PC or not). Finally, we see a\nsimilar pattern to beacon back to the attacker server and inform the attacker about the\ncurrent stage of execution.\n\n\n-----\n\nVictims similarity: The group is known to target the government of Jordan and this is\nthe case in this campaign.\nPayload similarity: DNS is the most common method used by APT34 for its C&C\ncommunications. The group is also known to use uncommon encodings such as\nBase32 and Base36 in its previous campaigns. The Saitama backdoor uses a similar\n[Base32 encoding for sending data to the servers that is used by DNSpionage. Also, to](https://blog.talosintelligence.com/2018/11/dnspionage-campaign-targets-middle-east.html)\nbuild subdomains it uses Base32 encoding that is similar to what was reported by\n[Mandiant.](https://www.mandiant.com/resources/targeted-attacks)\n\nMalwarebytes customers are protected from this attack via our Anti-Exploit layer.\n\n## IOCs\n\n**Maldoc:**\n\nConfirmation Receive Document.xls\n\n26884f872f4fae13da21fa2a24c24e963ee1eb66da47e270246d6d9dc7204c2b\n\n**Saitama backdoor:**\n\nupdate.exe\n\ne0872958b8d3824089e5e1cfab03d9d98d22b9bcb294463818d721380075a52d\n\n**C2s:**\n\nuber-asia.com\n\nasiaworldremit.com\n\njoexpediagroup.com\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-10 - APT34 targets Jordan Government using new Saitama backdoor.pdf"
    ],
    "report_names": [
        "2022-05-10 - APT34 targets Jordan Government using new Saitama backdoor.pdf"
    ],
    "threat_actors": [
        {
            "id": "ce10c1bd-4467-45f9-af83-28fc88e35ca4",
            "created_at": "2022-10-25T15:50:23.458833Z",
            "updated_at": "2025-03-27T02:00:55.475188Z",
            "deleted_at": null,
            "main_name": "APT34",
            "aliases": null,
            "source_name": "MITRE:APT34",
            "tools": [
                "netstat",
                "Systeminfo",
                "PsExec",
                "SEASHARPEE",
                "Tasklist",
                "Mimikatz",
                "POWRUNER",
                "certutil"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "4632103e-8035-4a83-9ecb-c1e12e21288c",
            "created_at": "2022-10-25T16:07:23.542255Z",
            "updated_at": "2025-03-27T02:02:09.854487Z",
            "deleted_at": null,
            "main_name": "DNSpionage",
            "aliases": [],
            "source_name": "ETDA:DNSpionage",
            "tools": [
                "Agent Drable",
                "AgentDrable",
                "CACTUSPIPE",
                "DNSpionage",
                "DropperBackdoor",
                "Karkoff",
                "MailDropper",
                "OILYFACE"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8d76e350-dfb5-4733-800d-876de41f690d",
            "created_at": "2023-01-06T13:46:38.841887Z",
            "updated_at": "2025-03-27T02:00:02.932838Z",
            "deleted_at": null,
            "main_name": "DNSpionage",
            "aliases": [
                "COBALT EDGEWATER"
            ],
            "source_name": "MISPGALAXY:DNSpionage",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3eebdb3f-f4e3-42e5-bb4d-f02a13328316",
            "created_at": "2024-05-01T02:03:08.014303Z",
            "updated_at": "2025-03-27T02:05:17.306592Z",
            "deleted_at": null,
            "main_name": "COBALT EDGEWATER",
            "aliases": [
                "Cold River ",
                "DNSpionage ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT EDGEWATER",
            "tools": [
                " DNSpionage",
                " Karkoff",
                " MailDropper",
                " SideTwist",
                " TWOTONE",
                "AgentDrable"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "3fff98c9-ad02-401d-9d4b-f78b5b634f31",
            "created_at": "2023-01-06T13:46:38.376868Z",
            "updated_at": "2025-03-27T02:00:02.818071Z",
            "deleted_at": null,
            "main_name": "Cleaver",
            "aliases": [
                "Cobalt Gypsy",
                "G0003",
                "Operation Cleaver",
                "Op Cleaver",
                "Tarh Andishan",
                "Alibaba",
                "TG-2889"
            ],
            "source_name": "MISPGALAXY:Cleaver",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535555,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1653780344,
    "ts_modification_date": 1653780344,
    "files": {
        "pdf": "https://archive.orkl.eu/532851c4615c0fab9c08c6c52c81709896f47e77.pdf",
        "text": "https://archive.orkl.eu/532851c4615c0fab9c08c6c52c81709896f47e77.txt",
        "img": "https://archive.orkl.eu/532851c4615c0fab9c08c6c52c81709896f47e77.jpg"
    }
}