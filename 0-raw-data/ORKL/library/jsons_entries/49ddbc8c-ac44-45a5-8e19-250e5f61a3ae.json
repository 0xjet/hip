{
    "id": "49ddbc8c-ac44-45a5-8e19-250e5f61a3ae",
    "created_at": "2023-01-12T15:05:12.71368Z",
    "updated_at": "2025-03-27T02:05:26.314235Z",
    "deleted_at": null,
    "sha1_hash": "fa47b31b2e6640bc13680c4ddb45f12c3e98c1b9",
    "title": "2021-11-15 - Infect If Needed - A Deeper Dive Into Targeted Backdoor macOS.Macma",
    "authors": "",
    "file_creation_date": "2022-05-28T19:56:14Z",
    "file_modification_date": "2022-05-28T19:56:14Z",
    "file_size": 1831372,
    "plain_text": "# Infect If Needed | A Deeper Dive Into Targeted Backdoor macOS.Macma\n\n**[sentinelone.com/labs/infect-if-needed-a-deeper-dive-into-targeted-backdoor-macos-macma/](https://www.sentinelone.com/labs/infect-if-needed-a-deeper-dive-into-targeted-backdoor-macos-macma/)**\n\nPhil Stokes\n\n[Last week, Google’s Threat Analysis Group published details around what appears to be](https://blog.google/threat-analysis-group/analyzing-watering-hole-campaign-using-macos-exploits/)\nAPT activity targeting, among others, Mac users visiting Hong Kong websites supporting pro[democracy activism. Google’s report focused on the use of two vulnerabilities: a zero day](https://assets.sentinelone.com/infog/sentinelone-zero-day)\nand a N-day (a known vulnerability with an available patch).\n\nBy the time of Google’s publication both had, in fact, been patched for some months. What\nreceived less attention was the malware that the vulnerabilities were leveraged to drop: a\n[backdoor that works just fine even on the latest patched systems of macOS Monterey.](https://www.sentinelone.com/blog/apples-macos-monterey-6-security-changes-that-may-have-passed-you-by/)\n\nGoogle labelled the backdoor “Macma”, and we will follow suit. Shortly after Google’s\n[publication, a rapid triage of the backdoor was published by Objective-See (under the name](https://www.sentinelone.com/labs/6-pro-tricks-for-rapid-macos-malware-triage-with-radare2/)\n“OSX.CDDS”). In this post, we take a deeper dive into macOS.Macma, reveal further IoCs to\naid defenders and threat hunters, and speculate on some of macOS.Macma’s (hithertounmentioned) interesting artifacts.\n\n## How macOS.Macma Gains Persistence\n\nThanks to the work of Google’s TAG team, we were able to grab two versions of the\nbackdoor used by the threat actors, which we will label `UserAgent 2019 and` `UserAgent`\n```\n2021 . Both are interesting, but arguably the earlier 2019 version has greater longevity since\n\n```\n\n-----\n\nthe delivery mechanism appears to work just fine on macOS Monterey.\n\nThe 2019 version of macOS.Macma will run just fine on macOS Monterey\n```\nUserAgent 2019 is a Mach-O binary dropped by an application called\n\n```\n“SafariFlashActivity.app”, itself contained in a .DMG file (the disk image sample found by\nGoogle has the name “install_flash_player_osx.dmg”). `UserAgent 2021 is a standalone`\nMach-O binary and contains much the same functionality as the 2019 version along with\nsome added AV capture capabilities. This version of macOS.Macma is installed by a\nseparate Mach-O binary dropped when the threat actors leverage the vulnerabilities\ndescribed in Google’s post.\n\nBoth versions install the same persistence agent, `com.UserAgent.va.plist in the current`\nuser’s `~/Library/LaunchAgents folder.`\n\n\n-----\n\nMacma’s persistence agent, com.UserAgent.va.plist\nThe property list is worth pausing over as it contains some interesting features. First, aside\nfrom the path to the executable, we can see that the persistence agent passes two\narguments to the malware before it is run: `-runMode, and` `ifneeded .`\n\nThe agent also switches the current working directory to a custom folder, in which later will\nbe deposited data from the separate keylogger module, among other things.\n\nWe find it interesting that the developer chose to include the `LimitLoadToSessionType`\nkey with the value “Aqua”. The “Aqua” value ensures the LaunchAgent only runs when there\n[is a logged in GUI user (as opposed to running as a background task or running when a user](https://developer.apple.com/library/archive/technotes/tn2083/_index.html#//apple_ref/doc/uid/DTS10003794-CH1-SUBSECTION3)\nlogs in via SSH). This is likely necessary to ensure other functionality, such as requesting\nthat the user gives access to the Microphone and Accessibility features.\n\n\n-----\n\nVictims are prompted to allow macOS.Macma access to the Microphone\nHowever, since `launchd defaults to “Aqua” when no key is specified at all, this inclusion is`\nrather redundant. We might speculate that the inclusion of the key here suggests the\n[developer is familiar with developing other LaunchAgents in other contexts where other keys](https://developer.apple.com/library/archive/technotes/tn2083/_index.html#//apple_ref/doc/uid/DTS10003794-CH1-SUBSECTION3)\nare indeed necessary.\n\n## Application Bundle Confusion Suggests A “Messy” Development Process\n\nSince we are discussing property lists, there’s some interesting artifacts in the\nSafariFlashActivity.app’s Info.plist, and that in turn led us to notice a number of other oddities\nin the bundle executables.\n\nOne of the great things about finding malware built into a bundle with an Info.plist is it gives\naway some interesting details about when, and on what machine, the malware was built.\n\n\n-----\n\nmacOS.Macma was built on El Capitan\nIn this case, we see the malware was built on an El Capitan machine running build 15C43.\nThat’s curious, because build 15C43 was never a public release build: it was a beta of El\nCapitan 11.2 available to developers and AppleSeed (Apple beta testers) briefly around\nOctober to November 2015. On December 8th, 2015, El Capitan 11.2 was released with\nbuild number 15C50, superseding the previous public release of 11.1, build 15B42 from\nOctober 21st.\n\n[At this juncture, let’s note that the malware was signed with an ad hoc signature, meaning it](https://developer.apple.com/documentation/security/seccodesignatureflags/1397793-adhoc)\ndid not require an Apple Developer account or ID to satisfy code signing requirements.\n\nTherein lies an anomaly: the bundle was signed without needing a developer account, but it\nseems that the macOS version used to create this version of macOS.Macma was indeed\nsourced from a developer account. Such an account could possibly belong to the author(s);\npossibly be stolen, or possibly acquired with a fake ID. However, the latter two scenarios\nseem inconsistent with the ad hoc signature. If the developer had a fake or stolen Apple ID,\nwhy not codesign it with that for added credibility?\n\nWhile we’re speculating about the developer or developers’ identities, two other artifacts in\nthe bundle are worthy of mention. The main executable in `../MacOS is called`\n“SafariFlashActivity” and was apparently compiled on Sept 16th, 2019. In the\n```\n../Resources folder, we see what appears to be an earlier version of the executable,\n\n```\n“SafariFlashActivity1”, built some nine days earlier on Sept 7th.\n\n\n-----\n\nWhile these two executables share a large amount of code and functionality, there are also a\nnumber of differences between them. Perhaps the most intriguing are that they appear – by\naccident or by design – to have been created by two entirely different users.\n\nUser strings from two binaries in the same macOS.Macma bundle\nThe user account “lifei” (speculatively, Li Fei, a common-enough Chinese name) seems to\nhave replaced the user account “lxk”. Of course, it could be the same person operating\ndifferent user accounts, or two entirely different individuals building separately from a\ncommon project. Indeed, there are sufficiently large differences in the code in such a short\nspace of time to make it plausible to suggest that two developers were working\nindependently on the same project and that one was chosen over the other for the final\nexecutable embedded in the `../MacOs folder.`\n\nNote that in the “lifei” builds, we see both the use of “Mac_Ma” for the first time, and\n“preexcel” — used as the team identifier in the final code signature. Neither of these appear\nin the “lxk” build, where “SafariFlashActivity” appears to be the project name. This bifurcation\neven extends to an unusual inconsistency between the identifier used in the bundle and that\nused in the code signature, where one is `xxxxx.SafariFlashActivity and the other is`\n```\nxxxxxx.preexcl-project .\n\n```\nInconsistent identifiers used in the bundle and code signature of macOS.Macma\nIn any case, the string “lifei” is found in several of the other binaries in the 2019 version of\nmacOS.Macma, whereas “lxk” is not seen again. In the 2021 version, both “lifei” and “lxk”\nand all other developer artifacts have disappeared entirely from both the installer and\nUserAgent binaries, suggesting that the development process had been deliberately cleaned\nup.\n\n\n-----\n\nUser lifei’s “Macma” seems to have won the ‘battle of the devs’\nFinally, if we return to the various (admittedly, falsifiable) compilation dates found in the\nbundle, there is another curiosity: we noted that the malware appears to have been compiled\non a 2015 developer build of macOS, yet the Info.plist has a copyright date of 2018, and the\nexecutables in this bundle were built well-over 3 years later in September 2019 according to\nthe (entirely manipulatable) timestamps.\n\nWhat can we conclude from all these tangled weeds? Nothing concrete, admittedly. But there\ndo seem to be two plausible, if competing, narratives: perhaps the threat actor went to\nextraordinary, and likely unnecessary, lengths to muddle the artifacts in these binaries.\nAlternatively, the threat actor had a somewhat confused development process with more\nthan one developer and changing requirements. No doubt the truth is far more complex, but\ngiven the nature of the artifacts above, we suspect the latter may well be at least part of the\nstory.\n\nFor defenders, all this provides a plethora of collectible artifacts that may, perhaps, help us to\nidentify this malware or track this threat actor in future incidents.\n\n## macOS.Macma – Links To Android and Linux Malware?\n\nThings start to get even more interesting when we take a look at artifacts in the executable\ncode itself. As we noted in the introduction, an early report on this malware dubbed it\n“OSX.CDDS”. We can see why. The code is littered with methods prefixed with CDDS.\n\n\n-----\n\nSome of the CDDS methods found in the 2021 UserAgent executable\nThat code, according to Google TAG, is an implementation for a DDS – Data Distribution\nService – framework. While our searches turned up blank trying to find a specific\nimplementation of DDS that matched the functions used in macOS.Macma, we did find other\nmalware that uses the same framework.\n\nAndroid malware drops an ELF bin that contains the same CDDS framework\n\n\n-----\n\nLinks to known Android malware droppers\nThese ELF bins and both versions of macOS.Macma’s UserAgent also share another\ncommonality, the strings “Octstr2Dec” and “Dec2Octstr”.\n\nCommonalities between macOS.Macma and a malicious ELF Shared object file\n[These latter strings, which appear to be conversions for strings containing octals and](https://www.jianshu.com/p/55e1545f2d45)\ndecimals, may simply be a matter of coincidence or of code reuse. The code similarities we\n[found also have links back to installers for the notorious Shedun Android malware.](https://en.wikipedia.org/wiki/Shedun)\n\nIn their report, Google’s TAG pointed out that macOS.Macma was associated with an iOS\nexploit chain that they had not been able to entirely recover. Our analysis suggests that the\nactors behind macOS.Macma at least were reusing code from ELF/Android developers and\npossibly could have also been targeting Android phones with malware as well. Further\nanalysis is needed to see how far these connections extend.\n\n## Macma’s Keylogger and AV Capture Functionality\n\n\n-----\n\nWhile the earlier reports referred to above have already covered the basics of\nmacOS.Macma functionality, we want to expand on previous reporting to reveal further IoCs.\n\nAs previously mentioned, macOS.Macma will drop a persistence agent at\n```\n~/Library/LaunchAgents/com.UserAgent.va.plist and an executable at\n~/Library/Preferences/lib/UserAgent .\n\n```\nAs we noted above, the LaunchAgent will ensure that before the job starts, the executable’s\ncurrent working directory will be changed to the aforementioned “lib” folder. This folder is\nused as a repository for data culled by the keylogger, “kAgent”, which itself is dropped at\n```\n~/Library/Preferences/Tools/, along with the “at” and “arch” Mach-O binaries.\n\n```\nBinaries dropped by macOS.Macma\nThe kAgent keylogger creates text files of captured keystrokes from any text input field,\nincluding Spotlight, Finder, Safari, Mail, Messages and other apps that have text fields for\npasswords and so on. The text files are created with Unix timestamps for names and\ncollected in directories called “data”.\n\n\n-----\n\nThe file 1636804188 contains data captured by the keylogger\nWe also note that this malware reaches out to a remote .php file to return the user’s IP\naddress. The same URL has a long history of use.\n```\nhttp://cgi1.apnic.net/cgi-bin/my-ip.php\n\n```\nBoth Android and macOS malware ping this URL\nFinally, one further IoC we noted in the `../MacOS/SafariFlashActivity “lifei” binary that`\nnever appeared anywhere else, and we also did not see dropped on any of our test runs,\nwas:\n```\n/Users/%s/Library/Safari/Safari.app/Contents/MacOS/UpdateHelper\n\n```\n\n-----\n\nMalware tries to drop a file in the Safari folder\nThis is worth mentioning since the target folder, the User’s Library/Safari folder, is TCC\nprotected since Mojave. For that reason, any attempt to install there would fall afoul of\n[current TCC protections (bypasses notwithstanding). It looks, therefore, like a remnant of the](https://www.sentinelone.com/labs/bypassing-macos-tcc-user-privacy-protections-by-accident-and-design/)\nearlier code development from El Capitan era, and indeed we do not see this string in later\nversions. However, it’s unique enough for defenders to watch out for: there’s never any\nlegitimate reason for an executable at this path to exist on any version of macOS.\n\n## Conclusion\n\nCatching APTs targeting macOS users is a rare event, and we are lucky in this instance to\nhave a fairly transparent view of the malware being dropped. Regardless of the vector used\nto drop the malware, the payload itself is perfectly functional and capable of exfiltrating data\nand spying on macOS users. It’s just another reminder, [if one were needed, that simply](https://www.sentinelone.com/blog/when-apple-admits-macos-malware-is-a-problem-its-time-to-take-notice/)\ninvesting in a Mac does not guarantee you safe passage against bad actors. This may have\nbeen an APT-developed payload, but the code is simple enough for anyone interested in\nmalfeasance to reproduce.\n\n## Indicators of Compromise\n\n**SHA1**\n\n000830573ff24345d88ef7916f9745aff5ee813d; UserAgent 2021 payload, Mach-O\n\n07f8549d2a8cc76023acee374c18bbe31bb19d91; UserAgent 2019, Mach-0\n\n0e7b90ec564cb3b6ea080be2829b1a593fff009f; (Related) ELF DYN Shared object file\n\n2303a9c0092f9b0ccac8536419ee48626a253f94; UserAgent 2021 installer, Mach-0\n\n31f0642fe76b2bdf694710a0741e9a153e04b485; SafariFlashActivity1, Mach-0\n\n734070ae052939c946d096a13bc4a78d0265a3a2; (Related) ELF DYN Shared object file\n\n77a86a6b26a6d0f15f0cb40df62c88249ba80773; at, Mach-0\n\n941e8f52f49aa387a315a0238cff8e043e2a7222; install_flash_player_osx.dmg, DMG\n\nb2f0dae9f5b4f9d62b73d24f1f52dcb6d66d2f52; client, Mach-0\n\nb6a11933b95ad1f8c2ad97afedd49a188e0587d2; SafariFlashActivity, Mach-0\n\nc4511ad16564eabb2c179d2e36f3f1e59a3f1346; arch, Mach-0\n\nf7549ff73f9ce9f83f8181255de7c3f24ffb2237; SafariFlashActivityInstall, shell script\n\n\n-----\n\n**File Paths**\n~/Library/Preferences/Tools/at\n~/Library/Preferences/Tools/arch\n~/Library/Preferences/Tools/kAgent\n~/Library/LaunchAgents/com.UserAgent.va.plist\n~/Library/Preferences/UserAgent/lib/Data/\n~/Library/Preferences/UserAgent/lib/UserAgent\n~/Library/Safari/Safari.app/Contents/MacOS/UpdateHelper\n\n**Identifiers**\nxxxxx.SafariFlashActivity\nxxxxxx.preexcl.project\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-15 - Infect If Needed - A Deeper Dive Into Targeted Backdoor macOS.Macma.pdf"
    ],
    "report_names": [
        "2021-11-15 - Infect If Needed - A Deeper Dive Into Targeted Backdoor macOS.Macma.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535912,
    "ts_updated_at": 1743041126,
    "ts_creation_date": 1653767774,
    "ts_modification_date": 1653767774,
    "files": {
        "pdf": "https://archive.orkl.eu/fa47b31b2e6640bc13680c4ddb45f12c3e98c1b9.pdf",
        "text": "https://archive.orkl.eu/fa47b31b2e6640bc13680c4ddb45f12c3e98c1b9.txt",
        "img": "https://archive.orkl.eu/fa47b31b2e6640bc13680c4ddb45f12c3e98c1b9.jpg"
    }
}