{
    "id": "c7209fcc-7ebe-4594-9342-305da5596c6d",
    "created_at": "2023-01-12T15:04:23.075689Z",
    "updated_at": "2025-03-27T02:13:34.685953Z",
    "deleted_at": null,
    "sha1_hash": "a5169d7aed970d9b1568b74ac4680eb6941aa3a2",
    "title": "2022-02-01 - N-W0rm analysis (Part 1)",
    "authors": "",
    "file_creation_date": "2022-05-28T19:14:22Z",
    "file_modification_date": "2022-05-28T19:14:22Z",
    "file_size": 2849923,
    "plain_text": "# N-W0rm analysis (Part 1)\n\n**secuinfra.com/en/techtalk/n-w0rm-analysis-part-1/**\n\n01.02.2022\n\nThis article shows our analysis of an N-W0rm sample. This appears to be a relatively new sample and according to Malware Bazaar the first\nsample was seen on the 18 January 2022.th\n\n\n-----\n\ne got t e sa p e o a a e a aa a d e ce do ot o t s sa p e s de e ed o e e, acco d g to @e ecute a a e, 0\nis delivered via Email.\n\nIf you want to follow along you can grab the sample from here:\n[https://bazaar.abuse.ch/sample/1b976a1fa26c4118d09cd6b1eaeceafccc783008c22da58d6f5b1b3019fa1ba4/](https://bazaar.abuse.ch/sample/1b976a1fa26c4118d09cd6b1eaeceafccc783008c22da58d6f5b1b3019fa1ba4/)\n\n## Overview\n\nBefore we start analyzing the sample, let’s take a closer look at the architecture of the compromise. The following figure shows the infection\nfrom the first stage to the final payload:\n\n\n-----\n\nFigure_1: Infection overview\n\nAs you can see in the figure above the infection ends with two 2 .NET binaries being dropped. Today’s article will describe all the way from the\ninitial infection to that point. The analysis of the two binaries will be covered in our next article.\n\n## First Stage\n\nThis sample is delivered as a VBS file that uses obfuscation to make static analysis harder and evade signatures. In our first step, we will\ndeobfuscate the VBS code and unveil the second stage. Below you will find the full code of the first stage. Line 3 contains a rather long string\nthat contains obfuscated PowerShell. As this long line would destroy the image, we replaced it for aesthetic reasons.\n\nFigure_2:Initial VBS Code\n\nAs the original source only contains 5 lines, we can walk through the code line by line.\n\nHere some important strings are scrambled by replacing some chars with other chars and then at runtime reversing this operation. We can\nreverse this operation by using the python REPL.\n\nFigure_3: Deobfuscating the first line\n\nSo, the string will be deobfuscated to Wscript.SheLL. This means that this sample will send some commands to the operating system\nsomewhere later. In the next line nothing interesting is happening, only the Wscript.SheLL object is created. Now line 3 is the interesting part\nas this line holds a long string containing obfuscated PowerShell code. As in line 4, this code will also be executed, we will need to analyze it to\nfully understand this malware.\n\nFirst, as we can see in line 3, the full PowerShell Code is in one line. We normally don’t write code like this. To make this at least a bit more\nreadable, we need to space this code across multiple lines, like it is usually done. Semicolons (;) are used to indicate Line-Breaks. To use\nthose to our advantage, we can paste this long line into a text editor and replace all semicolons with a line-break (\\n) and a semicolon to keep\nthe syntax.\n\n\n-----\n\nFigure_4: Beautified PowerShell Code\n\nThe first that pops into our eye is the IP address at the top. We will come back to it later, but for now, we found an important IOC.\n\nThis PowerShell snippet defines a function called CHGBGWUCPVSBXIVTHVKR in line 2. This function will be called in line 10 and the result\nis executed with IEX in line 11. So based on the call of IEX to the result of the function we can assume that the function decodes some further\nPowerShell that is executed. The string that will be deobfuscated is in line 10 which is again a very long string, that we have replaced again\nhere. To deobfuscate this string, the probably easiest thing we could do is to copy this whole code snippet, replace the IEX in line 11 by echo\nand execute it in a PowerShell session. Alternately you could reimplement the function in e.g., Python and execute it there. We opted for the\nsecond method and reimplemented the logic on python. The screenshot below shows the code.\n\nFigure_5: Reimplementation of deobfuscation loop\n\nBy running our Python script to deobfuscate the long string, we get yet again an obfuscated PowerShell command.\n\nFigure_6: Output of the above Python script\n\nAgain, we can either enter this code into a PowerShell session or recreate the Script in e.g., Python, and execute it there. Again, we choose to\nreimplement it in Python. The code can be seen below:\n\nFigure_7: Deobfusaction and output\n\n\n-----\n\ns ast decoded co a d b gs us bac to t e beg g e e be t e add ess at t e beg g at s t e co te t o t e a ab e\n$Hx. So, all this decoding only to download the file and execute it.\n\n## Stage 2 (RILSXDKOPJHN.TXT)\n\nOh Boy, the second stage looks a bit bulkier than the first one. This sample is fully packed with obfuscated strings and the usage of the replace\nfunction is rather dominant here. As this stage contains a bit more code than the previous one, we will not copy-paste every single line here. If\nyou want to truly understand what is happening here, we recommend that you download the sample yourself and follow along.\n\nWe will begin by decoding the first big block of obfuscated string right at the beginning:\n\nFigure_8: First Block of obfuscatated code in the second stage\n\nThe obfuscated string is in the second line. This string is first modified by calling replace() twice on it. Lastly, the string is then deobfuscated by\nthe loop in line 3. This loop might look strange at first, but it is rather simple.\n\nThis loop starts by calling -split on the string from line 2, i.e., converting the big string into a list based on a condition. This Regex-based\ncondition searches for hex-characters and after every second occurrence, it splits. That means our iterate variable always contains two hexchars. These chars are then converted to ASCII and lastly concatenated. If we put all this together, we can again recreate this logic in python.\n\nFigure_9: Python based deobfusaction of the first block\n\nRunning this script yields the following output (I’ve added the variable $A1 from the first line for clearness):\n\nFigure_10: Full first deobfuscated block\n\nWe also get an interesting IOC here. So, the second stage starts by creating the directory\n**C:\\ProgramData\\YHWZHLCQJHGQRFRHWZLCKSEUZIHLSJYATIODFBQPXTUSLQUEHVXQJENITGNZ, then sleeps for 3 seconds.**\n\nThe next two lines are important because we get our persistence indicators here. The newly created directory is set as StartUp, meaning it is\nexecuted each time the system is rebooted.\n\nLet’s go back to the code and take a look at the next block.\n\nThe next step is interesting. The Variable $ZEJOTRZCRVYEGGCGNZPLJDJROGPKEIGINPVGHOQXYSFSXBDOKJATKYHEPRNO will\nhold what appears to be HTML content, starting with a scripblock inserting VBScript code.\n\nFigure_11: Beginning of the scriptblock\n\nNow the function var_func() takes no arguments and its only purpose is to deobfuscate multiple strings it contains\n\n\n-----\n\ne 36 e ca see t at t s be a ta e t at be sa ed t e o o g pat\n**C:\\ProgramData\\YHWZHLCQJHGQRFRHWZLCKSEUZIHLSJYATIODFBQPXTUSLQUEHVXQJENITGNZ\\YHWZHLCQJHGQRFRHWZLCKSE**\n\nFigure_12: Creation of an HTA file\n\nAs the content of this hta is only obfuscated by the usage of repeatably calls to replace() we will not show all steps taken to deobfuscate but\nrather only the end result. The decoding ends with the scripts downloading the next stage from http://15.188.246[.]78/Q/SSSSSSHSJSJSA.txt\nand executing it.\n\n## Stage 3\n\nThis will be the final stage I promise!\n\nAgain, we are greeted with a bunch of obfuscated code. This time there are two big blocks of obfuscated code. Both strings start with 4D5A,\ni.e., the MZ header.\n\nNext follows a function called vip(). While looking a bit confusing, it only decodes the base64 input.\n\nLastly, the code contains a huge block of obfuscated code, that is passed as input to the vip() function. Let’s pass this big chunk of code into\nthe vip() function and take a look at what is happening. To make things maybe a bit easier to understand, I’ve pasted the decoded block below.\n\nFigure_13: Last block of code in third stage\n\nWe can see a new function called HB which takes a single parameter and appears to do some decoding. This function is called in lines 17 and\n18. Further down below we recognize some important Strings. E.g., look at like 33 where we see chunks of .NET code to load binaries into\nmemory. I assume that all the lines up from 19 are only responsible to load the two binaries that are decoded in lines 17 and 18. As for now,\nI’m not really interested in how the binary is loaded but rather only the binaries, let’s dump them to disc by deobfuscating them. As we only\nreally need the two strings that start with 4D5A, the function to deobfuscate them, and then a single call to the function we can write the\nfollowing code.\n\n\n-----\n\nFigure_14: Deobfusaction of the two PE’s\n\nRunning that code dumps two .NET binaries which will be analyzed in the next article.\n\n**Host-Based Indicators:**\n\nC:\\ProgramData\\YHWZHLCQJHGQRFRHWZLCKSEUZIHLSJYATIODFBQPXTUSLQUEHVXQJENITGNZ\\YHWZHLCQJHGQRFRHWZLCK\nMD5 (RILSXDKOPJHN.TXT) = 3d8ff7f298f64d9150a11e61dcbfd87b\nMD5 (SSSSSSHSJSJSA.txt) = 9ce8d6f136b95fab140bc8904666003a\nMD5 (1b976a1fa26c4118d09cd6b1eaeceafccc783008c22da58d6f5b1b3019fa1ba4.vbs) = e04e4cb7e410b885babba54cd59d5ae9\nMD5 (first_pe.exe) = 83dc22a1493e609b8b16f732e909418f\nMD5 (second_pe.exe) = 08587e04a2196aa97a0f939812229d2d\n\n**Network-Based Indicators:**\n\nhttp://15.188.246.78/Q/SSSSSSHSJSJSA.txt\nhttp://15.188.246.78/Q/RILSXDKOPJHN.TXT\n\nfazitanfang\n\n## Series overview\n\n[N-W0rm analysis Part 2](https://www.secuinfra.com/en/techtalk/n-w0rm-analysis-part-2/)\n\nfazitende\n\n[SECUINFRA Falcon Team · Author](https://www.secuinfra.com/en/author/si_falcon_tm/)\n\nDigital Forensics & Incident Response Experten\n\nNeben den Tätigkeiten, die im Rahmen von Kundenaufträgen zu verantworten sind, kümmert sich das Falcon Team um den Betrieb, die\nWeiterentwicklung und die Forschung zu diversen Projekten und Themen im DF/IR Bereich.\n\nDas SECUINFRA Falcon Team ist auf die Bereiche Digital Forensics (DF) und Incident Response (IR) spezialisiert. Hierzu zählen die\nklassische Host-Based Forensik, aber auch Themen wie Malware Analysis oder Compromise Assessment gehören zu diesem\nAufgabengebiet. Neben den Tätigkeiten, die im Rahmen von Kundenaufträgen zu verantworten sind, kümmert sich das Falcon Team um den\nBetrieb, die Weiterentwicklung und die Forschung zu diversen Projekten und Themen im DF/IR Bereich. Dazu zählen beispielsweise Threat\nIntelligence oder die Erstellung von Erkennungsregeln auf Basis von Yara.\nDigital Forensics & Incident Response experts\n\nIn addition to the activities that are the responsibility of customer orders, the Falcon team takes care of the operation, further development and\nresearch of various projects and topics in the DF/IR area.\n\nThe SECUINFRA Falcon Team is specialized in the areas of Digital Forensics (DF) and Incident Response (IR). This includes classic hostbased forensics, but also topics such as malware analysis or compromise assessment. In addition to the activities for which we are responsible\nwithin the scope of customer orders, the Falcon team is also responsible for the operation, further development and research of various\nprojects and topics in the DF/IR area. These include, for example, threat intelligence or the creation of detection rules based on Yara.\n\n\n-----\n\n[posts](https://www.secuinfra.com/en/author/si_falcon_tm/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-01 - N-W0rm analysis (Part 1).pdf"
    ],
    "report_names": [
        "2022-02-01 - N-W0rm analysis (Part 1).pdf"
    ],
    "threat_actors": [
        {
            "id": "08c8f238-1df5-4e75-b4d8-276ebead502d",
            "created_at": "2023-01-06T13:46:39.344081Z",
            "updated_at": "2025-03-27T02:00:03.056208Z",
            "deleted_at": null,
            "main_name": "Copy-Paste",
            "aliases": [],
            "source_name": "MISPGALAXY:Copy-Paste",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535863,
    "ts_updated_at": 1743041614,
    "ts_creation_date": 1653765262,
    "ts_modification_date": 1653765262,
    "files": {
        "pdf": "https://archive.orkl.eu/a5169d7aed970d9b1568b74ac4680eb6941aa3a2.pdf",
        "text": "https://archive.orkl.eu/a5169d7aed970d9b1568b74ac4680eb6941aa3a2.txt",
        "img": "https://archive.orkl.eu/a5169d7aed970d9b1568b74ac4680eb6941aa3a2.jpg"
    }
}