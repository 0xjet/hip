{
    "id": "0be880f4-c0f1-4116-ab47-8e70985499d6",
    "created_at": "2023-01-12T15:05:10.323393Z",
    "updated_at": "2025-03-27T02:15:41.810246Z",
    "deleted_at": null,
    "sha1_hash": "001dda1e9954d7a1e5e3b45226d6c376c38c77fa",
    "title": "2020-09-03 - Turning Open Source Against Malware",
    "authors": "",
    "file_creation_date": "2022-05-28T15:17:01Z",
    "file_modification_date": "2022-05-28T15:17:01Z",
    "file_size": 872127,
    "plain_text": "# Turning Open Source Against Malware\n\n**[intezer.com/blog/threat-hunting/turning-open-source-against-malware/](https://www.intezer.com/blog/threat-hunting/turning-open-source-against-malware/)**\n\nWritten by Paul Litvak - 3 September 2020\n\n### Get Free Account\n\nJoin Now\n\n**Introduction**\n\n\nSeptember 3, 2020\n\n\nOffensive Security Tools are any kind of functionality meant to facilitate intrusions and\nsecurity bypasses in order to achieve the former.\n\nGenerally we can divide them into three categories:\n\n1. Close Source Tools: The most infamous example is CobaltStrike.\n2. Open Source “as is” Standalone Tools: Metasploit, Mimikatz, and various RAT/C2\n\nframeworks are some examples.\n\n\n-----\n\n3. Open Source Libraries: Examples include some memory injection libraries and other\n\noffensive libraries which must be incorporated in a tool in order to be useful.\n\nUnsophisticated actors adopt OSTs to fill in R&D resources which they don’t possess while\nadvanced actors, including government-backed ones, incorporate OSTs so they can spend\ntheir resources elsewhere in advancing operations or upgrading infrastructure, for example.\n\nWe analyzed thousands of threat actor reports from security companies dating back to\n2015, checking for their references to open source OST projects. What we found is the\nnumber of references to open source OST projects is steadily on the rise which indicates\ntheir increasing usage.\n\nWhat is special about OST libraries is they can’t operate independently and must be\nincluded as part of a bigger tool. These embedded libraries are rarely documented by\nsecurity companies due to the difficulty it takes to identify them, as they are only part of a\nmalicious file and usually stripped of strings.\n\nThe ability to detect files that use offensive libraries can enhance threat hunting capabilities\nas very few legitimate programs will include such functionalities.\n\n**In this article we will present a tutorial on how you can create code-based YARA**\n**signatures to find malware using OST libraries.**\n\nThis article is a part of a larger investigation into the effects of free publication of OSTs. The\n[full research will be presented at VirusBulletin.](https://vblocalhost.com/presentations/the-ost-map-mapping-malware-usage-of-open-source-offensive-security-tools/)\n\n## Malware Adopting Open Source\n\n\n-----\n\nMalware developers aren t much different from normal programmers in that they both want\nto do their job in the easiest way possible. For some tasks, the most efficient solution is to\nsimply copy and paste code from the Internet. If malware developers take this short cut\nwhen developing their tools, we as defenders should take advantage of it.\n\nDuring our investigation, we identified which open source OST libraries threat actors most\noften copy and paste into their toolsets. One conclusion we drew is that many actors\noutsource memory injection logic into a small subset of open source libraries.\n\nAs an example, using only string reuse, we can observe that Lazarus, Winnti, Trickbot,\n[Ramsay, and DarkHotel all have used the ImprovedReflectiveDllInjection library:](https://github.com/dismantl/ImprovedReflectiveDLLInjection)\n\n[(‘Search Exact String’ result available for Intezer Analyze users)](https://analyze.intezer.com/strings?stringValue=DLL%20and%20target%20process%20must%20be%20same%20architecture&)\n\n[(Strings from one of the files found when making the above string search)](https://analyze.intezer.com/files/916654e2ee43d2ee43f0d5e9d41f8527aaf239684f91f9b92ac5c1937cd45c91)\n\n\n-----\n\nWe can confirm this by searching for the strings on Github and finding the specific code\nthey used:\n\nCreating YARA signatures from OST library strings can yield some successful threat\ndetections, however, attackers can easily remove those strings. We have witnessed first\nhand these malware families removing such strings once they have recognized their\nmistake and we are aware of multiple other threat actors using this library without the\naccompanying strings.\n\nTherefore we must find a different method to create signatures to detect the use of these\nlibraries.\n\n## Code-based Signatures\n\nThe premise of code reuse signatures is to create YARA rules based on repeating binary\npatterns. These binary patterns are normalized code instructions. Normalized as in they\nmust be readjusted to account for inconsistencies between different compilation outputs\n(e.g. different registers being used or varying immediate values). Each compiler has\ndifferent compilation optimization rules and even the slightest difference can result in\nsignatures becoming essentially ineffective.\n\nTo demonstrate how you can create a code-based YARA signature, let’s look at the\n[MemoryModule library as an example. We uploaded a batch of precompiled MemoryModule](https://github.com/fancycode/MemoryModule)\n[binaries to Mega.nz so you can follow along.](https://mega.nz/file/ytwyXYJY#SU5vCDYf_9M3gcC3HSqIWoKgcr7zfGSzskAP46VyJ9A)\n\nWe compile the library and search for assembly code that looks unique to our library (we\n[also generate a PDB file so that we can easily track the code). We chose the following](https://docs.microsoft.com/en-us/cpp/build/reference/debug-generate-debug-info?view=vs-2019)\nblocks in the MemoryLoadLibraryEx function:\n\n\n-----\n\nThe blocks we will inspect specifically are the top center and middle left blocks, which can\nbe traced to the [following code:](https://github.com/fancycode/MemoryModule/blob/master/MemoryModule.c#L571)\n\n**Note: It’s also possible to do this the opposite way. First, choose the source code which**\nseems unique and then only track the related assembly. It really depends on what is most\ncomfortable for you.\n\nIt’s important to compile the library via several compiler versions in order to ensure the\nbinary patterns we are signing don’t change drastically. You can find here an open source\nscript we made available for this task. Generally, choosing small blocks with simple\ninstructions like the ones we selected is recommended since there is less room for changes\nto be made through different compiler versions.\n\nAfter browsing through these libraries to make certain that our code remains the same\nbetween different compiler versions, we can start building our binary YARA signature.\n\nFor the sake of brevity we rearranged the function so only the code we’re interested in\nappears on screen:\n\n\n-----\n\n[Using an Intel Instruction Set reference sheet, turn the first block into a binary pattern:](https://c9x.me/x86/)\n```\nB8 4D 5A 00 00 => mov reg, imm32 => B? 4D 5A 00 00\n66 39 01    => cmp [reg], reg => 66 39 ??\n\n```\n[For example, mov reg, imm32 is encoded as B8+ rd in the mov command. This means the](https://c9x.me/x86/html/file_module_x86_id_176.html)\nsecond byte has possible values 8-0xf so let’s put a question mark over it.\n\nWe avoid signing the jz instruction because it can turn to jnz on another compiler’s whim.\nFor this reason, familiarity with compiler behavior is useful and can be attained by reviewing\nmultiple versions of the same code through binaries created for different library versions.\n\nMoving on to the second block, let’s turn only its beginning sequence into a binary pattern:\n```\nB9 C1 00 00 00   => mov ecx, 0C1h  => B9 C1 00 00 00\nFF 15 DE 2B 00 00 => call cs:offset => FF 15 ?? ?? ?? ??\n33 C0       => xor eax, eax  => 33 C0\n\n```\nWe don’t normalize mov ecx, 0C1h because it isn’t part of the function’s logic (it’s used to\nhandle the stack frame, aka ‘the function’s infrastructure’) and as you can see below it\nsometimes doesn’t trail our “real” logic:\n\n\n-----\n\nNext let’s combine the two functions into a YARA rule and add a condition for the blocks to\nbe close to each other. We chose a distance of 0x800 bytes after reviewing the same code\nin newer compilers, where the blocks end up on opposite sides of the same function due to\nnew optimizations (as can be seen in the V142/V141 versions):\n```\nrule MemoryModule_x64 {\n strings:\n  // First block:\n  $s1 = { \n   B? 4D 5A 00 00    // mov <reg>, 0x00004D5A\n   66 39         // cmp <reg>, <reg>\n  }\n  // Second block:\n  $s2 = { \n   B9 C1 00 00 00    // mov ecx, 0x000000C1\n   FF 15 ?? ?? ?? ??   // call cs:[mem]\n   33 C0 48       // xor eax, eax\n  }\n condition:\n  $s1 and $s2 in (@s1..@s1+0x800) and $s3 in (@s1..@s1+0x50) and positives > 0\n}\n\n```\nFinally we’ll test the validity of our new rule.\n\nLet’s make sure we don’t miss any MemoryModule binaries (no false negatives):\n\n\n-----\n\nBefore deploying the signature, we test it on VirusTotal.\n\nIn this case we had to add a block to the signature (we chose the one to the right from the\ninitial figure) to reduce false positives, as we found the 0x800 distance made the signature\ntoo generic and returned hits on programs that didn’t use MemoryModule.\n\nThe final signature looks like this:\n```\nrule MemoryModule_x64 {\n strings:\n  // First block:\n  $s1 = { \n   B? 4D 5A 00 00    // mov <reg>, 0x00004D5A\n   66 39         // cmp <reg>, <reg>\n  }\n  // Second block:\n  $s2 = { \n   B9 C1 00 00 00    // mov ecx, 0x000000C1\n   FF 15 ?? ?? ?? ??   // call cs:[mem]\n   33 C0 48       // xor eax, eax\n  }\n  // Third block:\n  $s3 = { \n   48 63 ?? ??      // movsxd <reg>, dword ptr [reg+0x3C]\n   48 8D ?? 08 01 00 00 // lea <reg>, [reg+0x108]\n   4? ?? ??       // cmp <reg>, <reg>\n  }\n condition:\n  $s1 and $s2 in (@s1..@s1+0x800) and $s3 in (@s1..@s1+0x50) and positives > 0\n}\n\n## Conclusion\n\n```\nMalware developers often incorporate open source libraries in order to cut costs and\npreserve their research and development resources for other activities. In this article we\npresented how you can create signatures to target malware that outsource their offensive\n\n\n-----\n\ncapabilities to these libraries. We demonstrated why signatures based on strings can be\neasily broken when hunting for these projects and how you can create more advanced\ncode-based signatures to catch malware that incorporate OST libraries.\n\nWe hope this post was productive for you and wish you happy hunting! We invite you to\n[virtually attend the talk which will present the full research study at VirusBulletin.](https://vblocalhost.com/presentations/the-ost-map-mapping-malware-usage-of-open-source-offensive-security-tools/)\n\n**The Intezer Analyze enterprise edition generates code-based YARA signatures for**\n**any detected threat similar to the signature detailed in this post.** **[Learn more](https://www.intezer.com/resource/automate-threat-hunting-with-code-based-vaccines/)**\n\n**Paul Litvak**\nPaul is a malware analyst and reverse engineer at Intezer. He previously served as a\ndeveloper in the Israel Defense Force (IDF) Intelligence Corps for three years.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-09-03 - Turning Open Source Against Malware.pdf"
    ],
    "report_names": [
        "2020-09-03 - Turning Open Source Against Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "1dadf04e-d725-426f-9f6c-08c5be7da159",
            "created_at": "2022-10-25T15:50:23.624538Z",
            "updated_at": "2025-03-27T02:00:55.508759Z",
            "deleted_at": null,
            "main_name": "Darkhotel",
            "aliases": [
                "Darkhotel",
                "DUBNIUM",
                "Zigzag Hail"
            ],
            "source_name": "MITRE:Darkhotel",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b13c19d6-247d-47ba-86ba-15a94accc179",
            "created_at": "2024-05-01T02:03:08.149923Z",
            "updated_at": "2025-03-27T02:05:17.422065Z",
            "deleted_at": null,
            "main_name": "TUNGSTEN BRIDGE",
            "aliases": [
                "DUBNIUM ",
                "DarkHotel ",
                "CTG-1948 "
            ],
            "source_name": "Secureworks:TUNGSTEN BRIDGE",
            "tools": [
                "Nemim"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "2b4eec94-7672-4bee-acb2-b857d0d26d12",
            "created_at": "2023-01-06T13:46:38.272109Z",
            "updated_at": "2025-03-27T02:00:02.790029Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "DUBNIUM",
                "Fallout Team",
                "Luder",
                "Tapaoux",
                "Shadow Crane",
                "APT-C-06",
                "SIG25",
                "Karba",
                "Nemim",
                "Nemin",
                "G0012",
                "ATK52",
                "T-APT-02",
                "TUNGSTEN BRIDGE",
                "Zigzag Hail"
            ],
            "source_name": "MISPGALAXY:DarkHotel",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "4c68ccd0-caba-4189-9ead-86ac4c2d9b70",
            "created_at": "2024-05-01T02:03:07.930196Z",
            "updated_at": "2025-03-27T02:05:17.251237Z",
            "deleted_at": null,
            "main_name": "BRONZE ATLAS",
            "aliases": [
                "Axiom",
                "BARIUM ",
                "Blackfly ",
                "CTG-2633",
                "GREF",
                "Group 72 ",
                "Red Kelpie ",
                "TG-2633 ",
                "Wicked Panda ",
                "Winnti",
                "APT41 "
            ],
            "source_name": "Secureworks:BRONZE ATLAS",
            "tools": [
                " CCleaner v5.33 backdoor",
                " ChinaChopper",
                " Cobalt Strike",
                " Dicey MSDN",
                " ForkPlayground",
                " HUC Proxy Malware (Htran)",
                " Mimikatz",
                " PipeMon",
                " PlugX",
                " PortReuse",
                " Powershell Empire",
                " RCMD",
                " RbDoor",
                " SPEEDBOAT",
                " ShadowPad",
                " Sidewalk",
                " Speculoos",
                " TeamViewer",
                " Winnkit",
                " Winnti",
                " reg save",
                " vssadmin",
                "Acehash"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "c0cedde3-5a9b-430f-9b77-e6568307205e",
            "created_at": "2022-10-25T16:07:23.528994Z",
            "updated_at": "2025-03-27T02:02:09.847683Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "APT-C-06",
                "ATK 52",
                "CTG-1948",
                "Dubnium",
                "Fallout Team",
                "Higaisa",
                "Luder",
                "Operation DarkHotel",
                "Operation Daybreak",
                "Operation Inexsmar",
                "Operation PowerFall",
                "Operation The Gh0st Remains the Same",
                "SIG25",
                "Shadow Crane",
                "T-APT-02",
                "Tungsten Bridge",
                "Zigzag Hail"
            ],
            "source_name": "ETDA:DarkHotel",
            "tools": [
                "Asruex",
                "DarkHotel",
                "DmaUp3.exe",
                "GreezeBackdoor",
                "Karba",
                "Nemain",
                "Nemim",
                "Ramsay",
                "Retro",
                "Tapaoux",
                "Trojan.Win32.Karba.e",
                "Virus.Win32.Pioneer.dx",
                "igfxext.exe",
                "msieckc.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535910,
    "ts_updated_at": 1743041741,
    "ts_creation_date": 1653751021,
    "ts_modification_date": 1653751021,
    "files": {
        "pdf": "https://archive.orkl.eu/001dda1e9954d7a1e5e3b45226d6c376c38c77fa.pdf",
        "text": "https://archive.orkl.eu/001dda1e9954d7a1e5e3b45226d6c376c38c77fa.txt",
        "img": "https://archive.orkl.eu/001dda1e9954d7a1e5e3b45226d6c376c38c77fa.jpg"
    }
}