{
    "id": "7ec46134-cd47-4077-ba5b-febdcd75c2b5",
    "created_at": "2023-01-12T14:59:36.547532Z",
    "updated_at": "2025-03-27T02:06:13.619689Z",
    "deleted_at": null,
    "sha1_hash": "847b05e154c21c7466bc6686054fe9d72c49b148",
    "title": "2021-06-25 - Microsoft signed a malicious Netfilter rootkit",
    "authors": "",
    "file_creation_date": "2022-05-28T02:22:45Z",
    "file_modification_date": "2022-05-28T02:22:45Z",
    "file_size": 560730,
    "plain_text": "# Microsoft signed a malicious Netfilter rootkit\n\n**[gdatasoftware.com/blog/microsoft-signed-a-malicious-netfilter-rootkit](https://www.gdatasoftware.com/blog/microsoft-signed-a-malicious-netfilter-rootkit)**\n\n06/25/2021\n\nG DATA Blog\nWhat started as a false positive alert for a Microsoft signed file turns out to be a WFP\napplication layer enforcement callout driver that redirects traffic to a Chinese IP. How did this\nhappen?\n\nLast week our alert system notified us of a possible false positive because we detected a\ndriver[1] named \"Netfilter\" that was signed by Microsoft. Since Windows Vista, any code that\nruns in kernel mode is required to be tested and signed before public release to ensure\nstability for the operating system. Drivers without a Microsoft certificate cannot be installed\nby default.\n\nIn this case the detection was a true positive, so we forwarded our findings to Microsoft who\npromptly added malware signatures to Windows Defender and are now conducting an\ninternal investigation. At the time of writing it is still unknown how the driver could pass the\nsigning process.\n\n\n-----\n\n## String decoding\n\nThe first thing I noted after opening the strings view are some strings that looked encoded or\nencrypted. While this is not necessarily a sign of a malicious file, it is odd that a driver\nobfuscates a part of their strings.\n\nI decoded the strings using the following Python snippet.\n```\ndef decryptNetfilterStr(encodedString): key = [9,0,7,6,8,3,1] i = 0 decodedString\n= \"\" for ch in encodedString: decodedString = decodedString + chr(ord(ch) ^\nkey[i%7]) i += 1 return decodedString\n\n```\n\n-----\n\nEncrypted strings\n\nDecrypted strings\n\n## Similar samples\n\nSearching for this URL as well as the PDB path and the similar samples feature on Virustotal\nwe found older samples as well as the dropper[2] of the netfilter driver. The oldest sample[3]\nsignatures date back to March 2021. Virustotal queries to find similar samples via URL and\nPDB path are listed below.\n```\ncontent:{5c68656c6c6f5c52656c656173655c6e657466696c7465726472762e706462}\ncontent:{687474703a2f2f3131302e34322e342e3138303a323038302f75}\n\n```\n\n-----\n\nAdditionally the following Yara rule will find samples via retrohunting.\n```\nrule NetfilterRootkit : Rootkit x64\n{ meta: author = \"Karsten Hahn @ GDATA CyberDefense\" description =\n\"Netfilter kernel-mode rootkit\" sha256 =\n\"115034373fc0ec8f75fb075b7a7011b603259ecc0aca271445e559b5404a1406\" sha256 =\n\"63D61549030FCF46FF1DC138122580B4364F0FE99E6B068BC6A3D6903656AFF0\" strings:\n$s_1 = \"\\\\??\\\\netfilter\\x00\" wide $s_2 = \"IPv4 filter for redirect\\x00\" wide\n$s_3 =\n\"\\\\Registry\\\\Machine\\\\SOFTWARE\\\\Microsoft\\\\SystemCertificates\\\\ROOT\\\\Certificates\\\\\\x0\n     $s_4 = \"Accept:\ntext/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,\nexchange;v=b3;q=0.9\\x0D\" $url = \"http://110.42.4.180:2080/u\\x00\" $pdb_1 =\n\"C:\\\\Users\\\\omen\\\\source\\\\repos\\\\netfilterdrv\\\\x64\\\\Release\\\\netfilterdrv.pdb\\x00\"\n//RSDS [20] G:\\<symbol>\\hello\\x64\\Release\\netfilterdrv.pdb $pdb_2 = {52 53 44 53\n[20] 47 3A 5C E6 BA 90 E7 A0 81 5C 68 65 6C 6C 6F 5C 78 36 34 5C 52 65 6C 65 61 73 65\n5C 6E 65 74 66 69 6C 74 65 72 64 72 76 2E 70 64 62} condition: any of\n($pdb_*, $url) or all of ($s_*)\n}\n\n## Dropper and installation\n\n```\nThe dropper places the driver into %APPDATA%\\netfilter.sys. Then it creates the file\n**%TEMP%\\c.xalm with the following contents and issues the command regini.exe x.calm to**\nregister the driver.\n\nContents of %TEMP%\\x.calm\n\n## Command and control server\n\nThe URL hxxp://110.42.4.180:2081/u in the decoded string listing is the server of the rootkit.\nThe Netfilter driver[1] connects to it for fetching configuration information.\n\nAfter connecting to the hardcoded URL hxxp://110.42.4.180:2081/u the server replies with\nthe following string.\n\nEach URL has a specific purpose.\n\n**URL** **Purpose**\n\nhxxp://110.42.4.180:2081/p Proxy settings\n\n\n-----\n\n**URL** **Purpose**\n\nhxxp://110.42.4.180:2081/s Redirection IPs\n\nhxxp://110.42.4.180:2081/h? Ping with CPU-ID\n\nhxxp://110.42.4.180:2081/c Root certificate\n\nhxxp://110.42.4.180:2081/v? Self update\n\n## IP redirection\n\nThe core functionality of the malware is its IP redirection. A list of targeted IP addresses are\nredirected to 45(.)248.10.244:3000. These IP addresses as well as the redirection target are\nfetched from hxxp://110.42.4.180:2081/s.\n\n[Researcher @jaydinbas reversed the redirection configuration in this tweet and provided the](https://twitter.com/jaydinbas)\n[latest decoded configuration in a pastebin. The general format as observed](https://pastebin.com/ZtEENLe2)\nby [@cci_forensics and](https://twitter.com/cci_forensics) [@jaydinbas is [<redirection_target>-<port_number>]](https://twitter.com/jaydinbas)\n**{<ip_to_redirect1>|<ip_to_redirect2>|...}**\n\nEncoded redirection configuration\n\n## Update mechanism\n\nThe sample has a self-update routine that sends its own MD5 hash to the server via\n**hxxp://110.42.4.180:2081/v?v=6&m=<md5>. A request might look like this:**\n**hxxp://110.42.4.180:2081/v?v=6&m=921fa8a5442e9bf3fe727e770cded4ab. The server**\nthen responds with the URL for the latest sample, e.g., hxxp://110.42.4.180:2081/d6 or with\nOK if the sample is up-to-date. The malware replaces its own file accordingly.\n\n\n-----\n\nCode that checks if the driver is up-to-date and replaces it with a newest version.\n\n## Root certificate\n\nThe rootkit receives a root certificate via hxxp://110.42.4.180:2081/c and writes it to\n**\\Registry\\Machine\\SOFTWARE\\Microsoft\\SystemCertificates\\ROOT\\Certificates\\. The**\ndata that is returned from the server has the format [<certificate name>]:{<certificate data\n**blob>}**\n\nRoot certificate data as it is sent by the server\n\n## Proxy\n\nAt hxxp://110.42.4.180:2081/p the malware requests the proxy which it sets as\n**AutoConfigURL in the registry key \\Software\\Microsoft\\Windows\\CurrentVersion\\**\n**Internet Settings. The returned value at the time of writing is**\n**hxxp://ptaohuawu.bagua.com.hgdjkgh.com:2508/baidu.txt**\n\n## Sample hashes\n\n\n-----\n\n**Description** **SHA256**\n\n\n\n[1] Netfilter\ndriver\n\n[2] Netfilter\ndropper\n\n[3] Netfilter\ndriver, older\nversion\nsigned in\nMarch\n\n\n63d61549030fcf46ff1dc138122580b4364f0fe99e6b068bc6a3d6903656aff0\n\nd64f906376f21677d0585e93dae8b36248f94be7091b01fd1d4381916a326afe\n\n115034373fc0ec8f75fb075b7a7011b603259ecc0aca271445e559b5404a1406\n\n\n## Contributions\n\nMany thanks to all the contributors below.\n\n[Johann Aydinbas for the splendid analysis on Twitter](https://twitter.com/jaydinbas)\n\n[Takahiro Haruyama for additions to the analysis above](https://twitter.com/cci_forensics)\n\n[Florian Roth for the sample collection sheet and additional Yara rules](https://twitter.com/cyb3rops)\n\n**Karsten Hahn**\n\nMalware Analyst\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-25 - Microsoft signed a malicious Netfilter rootkit.pdf"
    ],
    "report_names": [
        "2021-06-25 - Microsoft signed a malicious Netfilter rootkit.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535576,
    "ts_updated_at": 1743041173,
    "ts_creation_date": 1653704565,
    "ts_modification_date": 1653704565,
    "files": {
        "pdf": "https://archive.orkl.eu/847b05e154c21c7466bc6686054fe9d72c49b148.pdf",
        "text": "https://archive.orkl.eu/847b05e154c21c7466bc6686054fe9d72c49b148.txt",
        "img": "https://archive.orkl.eu/847b05e154c21c7466bc6686054fe9d72c49b148.jpg"
    }
}