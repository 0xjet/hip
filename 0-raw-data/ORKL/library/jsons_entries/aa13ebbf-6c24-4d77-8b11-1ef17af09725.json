{
    "id": "aa13ebbf-6c24-4d77-8b11-1ef17af09725",
    "created_at": "2023-01-12T14:59:01.530104Z",
    "updated_at": "2025-03-27T02:06:04.645105Z",
    "deleted_at": null,
    "sha1_hash": "dd30bb8b3e5dd5849d36d21b995a43e7fa5a8b6c",
    "title": "2020-05-05 - GuLoader AntiVM Techniques",
    "authors": "",
    "file_creation_date": "2022-05-28T15:23:23Z",
    "file_modification_date": "2022-05-28T15:23:23Z",
    "file_size": 536835,
    "plain_text": "# [RE014] GuLoader AntiVM Techniques\n\n**[blog.vincss.net/2020/05/re014-guloader-antivm-techniques.html](https://blog.vincss.net/2020/05/re014-guloader-antivm-techniques.html)**\n\nThời gian gần đây, Twitter của các chuyên gia nước ngoài liên tục xuất hiện hash tag\n**[#GuLoader, đây là một downloader phổ biến đang được các nhóm tin tặc sử dụng rộng rãi](https://www.google.com/search?q=%23GuLoader)**\nnhằm tải về mã độc chính lợi dụng các dịch vụ cloud của Google Drive và Microsoft\nOneDrive. GuLoader rất nhỏ, nhẹ, được viết bằng VB6 và thường được nén trong file .rar.\nKhi người dùng vô tình thực thi loader này, nó sẽ tải xuống Trojans (RAT) hoặc các dòng mã\nđộc đánh cắp thông tin như Agent Tesla, FormBook, NanoCore RAT, Netwire RAT, Remcos\nRAT, ...\n\n[Ở Việt Nam cũng không ngoại lệ, chúng tôi đã tiếp cận và có bài phân tích chi tiết về](https://blog.vincss.net/2020/03/re011-unpack-crypter-cua-malware-netwire-bang-x64dbg.html)\ndownloader này. Mới đây, khách hàng của chúng tôi tiếp tục nhận được email có file đính\nkèm lạ, qua kiểm tra, phân tích và so sánh, chúng tôi nhận thấy đây chính là một biến thể\ncủa GuLoader. Nhiệm vụ của nó là tải về NanoCore RAT để thực thi trên máy người dùng.\nTrong bài viết này, chúng tôi sẽ không đi vào phân tích chi tiết mà chỉ tập trung vào các kĩ\nthuật Anti-VM được sử dụng trong shellcode.\n\n## 1. Anti-VM\n\n### 1.1. Kết hợp ZwQueryVirtualMemory với các hash đã tính toán trước\n\n\n-----\n\nThông thường, để phân tích mã độc, người phân tích sẽ thực thi mã độc trên một môi\ntrường riêng biệt nhằm thu thập các thông tin tương tác với hệ thống trong quá trình thực thi.\nTuy nhiên, với các biến thể mới của Guloader, khi thực thi sẽ nhận được thông báo sau:\n\n_Hình 1. Thông báo lỗi khi thực thi trên môi trường ảo hóa hoặc thông qua debugger_\n\nDebug loader sẽ tới được shellcode. Shellcode thực hiện push một loạt các hash đã tính\ntoán trước lên stack:\n\npush  0xB314751D\npush  0xA7C53F01\npush  0x7F21185B\npush  0x3E17ADE6\npush  0xF21FD920\npush  0x27AA3188\npush  0xDFCB8F12\npush  0x2D9CC76C\n\nTiến hành resolve hàm API ZwQueryVirtualMemory ứng với hash đã tính toán trước là\n**0x8802EDAC.**\n\n_Hình 2. Lấy địa chỉ hàm API ZwQueryVirtualMemory_\n\nTiếp theo sử dụng vòng lặp để quét toàn bộ vùng nhớ từ 0x00010000 tới 0x7FFFF000, gọi\nhàm ZwQueryVirtualMemory kiểm tra access protection của các vùng nhớ này. Nếu vùng\nnhớ thỏa mãn điều kiện, sẽ quét vùng nhớ đó, gặp chuỗi sẽ gọi hàm tính toán hash cho\nchuỗi đó và so sánh với các hash đã thiết lập trên Stack. Khi trùng hash, loader lấy địa chỉ\nbase của msvbvm60.dll để tìm hàm MessageBoxA, giải mã chuỗi “This program cannot be\n_run under virtual environment or debugging software !” và hiển thị thông báo như Hình 1._\n\n\n-----\n\n_Hình 3. Tính toán hash của các chuỗi trên vùng nhớ_\n\n[Hàm tính toán hash mà loader sử dụng chính là thuật toán djb2:](https://theartincode.stanis.me/008-djb2/)\n\n\n-----\n\n_Hình 4. Hàm tính toán hash_\n\nVới máy sử dụng để debug loader, chúng tôi có được chuỗi “vmtoolsdControlWndClass”\ntrùng với một hash đã được loader tính toán trước là 0xB314751D. Các hash còn lại theo\nphỏng đoán của chúng tôi có thể liên quan đến VirtualBox hoặc môi trường sandbox khác.\n\n_Hình 5. Phát hiện môi trường ảo hóa sử dụng VMware_\n\n### 1.2. Kiểm tra sự tồn tại của QEMU Guest Agent\n\nBên cạnh kĩ thuật nói trên, loader cũng thực hiện kiểm tra xem môi trường phân tích có sử\n\n\n-----\n\ndụng Qemu guest agent (qga) hay không thông qua hàm CreateFileA.\n\n_Hình 6. Lấy địa chỉ hàm API CreateFileA_\n\nSử dụng hàm này để kiểm tra sự tồn tại của “C:\\ProgramData\\qemu-ga\\qga.state” trên máy:\n\n_Hình 7. Gọi hàm CreateFileA để kiểm tra sự tồn tại của file_\n\nNếu tồn tại file trên hệ thống sẽ hiển thị thông báo như Hình 1:\n\n_Hình 8. Hiển thị thông báo nếu có qga.state_\n\n### 1.3. Sử dụng CPUID\n\n\n-----\n\nBên cạnh hai kĩ thuật trên, loader còn sử dụng thêm lệnh CPUID để kiểm tra xem chương\ntrình có đang thực thi trong môi trường ảo hóa hay không?\n\n_Hình 9. Sử dụng CPUID để kiểm tra_\n\nLệnh CPUID được thực thi với giá trị của EAX = 1. Bit thứ 31 của ECX nếu trên máy vật lý\nsẽ bằng 0. Trên máy ảo, nó sẽ bằng 1.\n\n## 2. Bonus\n\nLoader này sử dụng kĩ thuật code injection phức tạp nhằm làm khó người phân tích.\n\nTạo một tiến trình con là RegAsm.exe ở trạng thái suspended.\nMap msvbvm60.dll vào triến trình vừa tạo.\nThực hiện inject shellcode vào RegAsm.exe.\nThiết lập context của tiến trình nhằm chuyển hướng thực thi tới đoạn code đã inject và\ngọi hàm ZwResumeThread để thực thi.\n\nShellcode thực thi bên trong tiến trình RegAsm.exe sẽ thực hiện tải về, giải mã và thực thi\npayload. Payload mới được lưu trên Google Drive:\n\n\n-----\n\n_Hình 10. Loader thực hiện tải payload từ Google Drive_\n\nGiải mã payload và map vào memory để thực thi. Payload có kích thước 0x32A00:\n\n_Hình 11. Payload sau khi tải về được giải mã trên memory_\n\nPayload thu được chính là NanoCore RAT:\n\n_Hình 12. Payload thu được là NanoCore RAT_\n\n\n-----\n\n**Tran Trung Kien (aka m4n0w4r)**\n**Dang Dinh Phuong**\n**R&D Center - VinCSS (a member of Vingroup)**\n\n\n-----",
    "language": "VI",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-05 - GuLoader AntiVM Techniques.pdf"
    ],
    "report_names": [
        "2020-05-05 - GuLoader AntiVM Techniques.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535541,
    "ts_updated_at": 1743041164,
    "ts_creation_date": 1653751403,
    "ts_modification_date": 1653751403,
    "files": {
        "pdf": "https://archive.orkl.eu/dd30bb8b3e5dd5849d36d21b995a43e7fa5a8b6c.pdf",
        "text": "https://archive.orkl.eu/dd30bb8b3e5dd5849d36d21b995a43e7fa5a8b6c.txt",
        "img": "https://archive.orkl.eu/dd30bb8b3e5dd5849d36d21b995a43e7fa5a8b6c.jpg"
    }
}