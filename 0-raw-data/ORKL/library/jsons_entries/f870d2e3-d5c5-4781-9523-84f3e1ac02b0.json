{
    "id": "f870d2e3-d5c5-4781-9523-84f3e1ac02b0",
    "created_at": "2022-10-25T16:48:10.974413Z",
    "updated_at": "2025-03-27T02:16:43.018658Z",
    "deleted_at": null,
    "sha1_hash": "5195fd48ff0ef5362f467e1de21044eea72ce2b7",
    "title": "VB2015_Catching_the_silent_whisper",
    "authors": "",
    "file_creation_date": "2015-10-08T10:30:19Z",
    "file_modification_date": "2015-10-08T10:30:19Z",
    "file_size": 579236,
    "plain_text": "## Catching the silent whisper: Understanding the Derusbi family tree\n\n##### Micky Pun, Eric Leung, Neo Tan\n\n###### Virus Bulletin 2015\n\n\n-----\n\n####  What is Derusbi\n\n  Background\n\n  Variants of Derusbi\n\n  Technical Analysis\n\n\n-----\n\n# What is Derusbi\n\n\n-----\n\n####  DLL\n\n  Remote Access Trojan\n\n  Relies on other malware to load or plant on a system\n\n  Resides on a system by imitating legitimate software DLLs\n (OfficeUt32.dll, Office32.dll, Update.dll…etc) during static file header scanning\n\n  Limited amount of samples (The number of samples since 2008\n till today are still in the hundreds)\n\n\n-----\n\n# Background\n\n\n-----\n\n####  Timeline\n\n  2008 – Earliest sample with compile time Aug 3, 2008\n\n» (md5: 338e4deb0be7769ef2c9d7080fb56154)\n\n####  2011 – Mitsubishi Heavy Industries hack (discovered Oct, 2011)\n\n» (md5: 1cd7835b9ac253a72f8cd94405100d62) (Ref: [ixoxiブログ)( compile time Apr 15,2011 )](https://ixoxi.wordpress.com/2011/10/16/%E4%B8%89%E8%8F%B1%E9%87%8D%E5%B7%A5%E3%82%B5%E3%82%A4%E3%83%90%E3%83%BC%E6%94%BB%E6%92%83-%E3%82%B9%E3%83%91%E3%82%A4%E3%82%A6%E3%82%A7%E3%82%A2%E3%83%BB%E3%82%A6%E3%82%A4%E3%83%AB%E3%82%B9-derusbi/)\n\n####  2014 – CareFirst BlueCross BlueShield hack (by the work of Sakula)\n\n###### »Revealed In May 2015 »1.1 millions customer information breached »Actual took place at June 2014 (Ref: CareFirstAnswers)\n\n####  2015 – Anthem hack (by the work of Sakula)\n\n###### »Revealed in Mar 2015 »78.8 million people information breached (Ref : AnthemFacts ) »Data is stolen around Dec 2014 (Ref: AnthemFacts ) »Part of the Deep Panda Campaign\n\n\n-----\n\n###### 1. Attachment in\n Collected from Deep Panda(2014) and \n spear-phishing email\n Anthem Breach (2014)\n or drive-by download\n\n### Remote\n Sakula\n Administration Tool\n\n#### Shyape\n\n### TXPFProxy.dll\n\n###### Sample with\n\n### Derusbi DLL\n\n###### compilation dated\n Collected from Mitsubishi at 2012 Hack(2011) and ShellCrew\n Campaign(2013)\n\n\n-----\n\n###### 2. Sakula unpacks Shyape (downloader)\n Collected from Deep Panda(2014) and \n Anthem Breach (2014)\n\n### Remote\n Sakula\n Administration Tool\n\n#### Shyape\n\n### TXPFProxy.dll\n\n###### Sample with\n\n### Derusbi DLL\n\n###### compilation dated\n Collected from Mitsubishi at 2012 Hack(2011) and ShellCrew\n Campaign(2013)\n\n\n-----\n\n###### 3a. Derusbi DLL is downloaded and ran\n Collected from Deep Panda(2014) and \n as service\n Anthem Breach (2014)\n\n### Remote\n Sakula\n Administration Tool\n\n#### Shyape\n\n### TXPFProxy.dll\n\n###### Sample with\n\n### Derusbi DLL\n\n###### compilation dated\n Collected from Mitsubishi at 2012 Hack(2011) and ShellCrew\n Campaign(2013)\n\n\n-----\n\n###### 3b. Infoadmin.dll\n Collected from Deep Panda(2014) and \n and sqlsrv32.dll\n Anthem Breach (2014)\n\n### Remote\n Sakula\n Administration Tool\n\n#### Shyape\n\n### TXPFProxy.dll\n\n###### Sample with\n\n### Derusbi DLL\n\n###### compilation dated\n Collected from Mitsubishi at 2012 Hack(2011) and ShellCrew\n Campaign(2013)\n\n\n-----\n\n###### 3c. TXPFProxy.dll\n Collected from Deep Panda(2014) and  (possible relative\n Anthem Breach (2014) of infoadmin.dll\n and sqlsrv32.dll)\n\n### Remote\n Sakula\n Administration Tool\n\n#### Shyape\n\n### TXPFProxy.dll\n\n###### Sample with\n\n### Derusbi DLL\n\n###### compilation dated\n Collected from Mitsubishi at 2012 Hack(2011) and ShellCrew\n Campaign(2013)\n\n\n-----\n\n###### Sakula, Shyape, Derusbi shares\n Collected from Deep Panda(2014) and \n the same stolen\n Anthem Breach (2014)\n Digital Signature\n\n### Remote DTOPTOOLZ\n Sakula Co.\n Administration Tool\n\n#### Shyape\n\n### TXPFProxy.dll\n\n###### Sample with\n\n### Derusbi DLL\n\n###### compilation dated\n Collected from Mitsubishi at 2012 Hack(2011) and ShellCrew\n Campaign(2013)\n\n\n-----\n\n###### Shyape and Derusbi both uses similar traffic\n Collected from Deep Panda(2014) and \n pattern to say covert\n Anthem Breach (2014)\n\n### Remote\n Sakula\n Administration Tool\n\n#### Shyape\n\n### TXPFProxy.dll\n\n###### Sample with\n\n### Derusbi DLL\n\n###### compilation dated\n Collected from Mitsubishi at 2012 Hack(2011) and ShellCrew\n Campaign(2013)\n\n\n-----\n\n-----\n\n###### Share the similar\n Collected from Deep Panda(2014) and  constructing\n Anthem Breach (2014) method for\n identifier\n\n### Remote\n Sakula\n Administration Tool\n\n#### Shyape\n\n### TXPFProxy.dll\n\n###### Sample with\n\n### Derusbi DLL\n\n###### compilation dated\n Collected from Mitsubishi at 2012 Hack(2011) and ShellCrew\n Campaign(2013)\n\n\n-----\n\n-----\n\n# Variants of Derusbi\n\n\n-----\n\n-----\n\n-----\n\n-----\n\n-----\n\n-----\n\n####  Some notes:\n\n###### »64-bit version first seen in 2011 – somewhat rare »Newer samples don’t necessarily use the newest version of a specific\n class »Much more features in samples from 2013/2014 versus 2008\n\n\n-----\n\n# Technical Analysis\n\n\n-----\n\n####  DllEntryPoint\n\n###### »Initialization »Calls regsvr32.exe »If sample is packed, unpack the export functions\n\n####  DllRegisterServer\n\n###### »Persistence Management\n\n####  DllUnregisterServer\n\n###### »Invoke Payload/BDSocket Thread\n\n####  ServiceMain\n\n###### »Main code »Contains the Payload/BDSocket Thread\n\n\n-----\n\n# Technical Analysis\n\n##### Persistence Management\n\n\n-----\n\n###### DLLEntryPoint\n\n Invoke by sysprep.exe\n Invoke via regsvr32.exe\n\n Invoke by starting a service via svchost.exe\n DllRegisterServer\n\n Invoke via regsvr32.exe /s /u\n\n Service control dispatcher creates a new thread to execute DllUnRegisterServer\n\n ServiceMain\n Directly calls\n Payload\n\n\n-----\n\n####  Decrypt and store built-in configuration at\n\n###### »Key: HK_Local_Machine\\Software\\Microsoft\\RPC »Subkey: Security »Data: xor(not(one-byte key))[Decrypted Configuration]\n\n####  Backup the current file to %SystemFolder% with filename\n\n###### »[hardcoded-prefix]{randomstring}.[hardcoded-extension]\n\n####  Store the persistent DLL path in\n\n###### »Key: HK_LOCAL_MACHINE\\System\\CurrentControlSet\\Service\\\n {Persistent Service Name}\\Parameter »Subkey: ServiceDLL\n\n\n-----\n\n##### Persistent service name\n\n Beacon URL\n\n File path where the Derusbi client is stored on\n the computer under a\n different name\n\n\n-----\n\n-----\n\n####  If McAfee's anti-virus service is detected, it would not use\n regsvr32.exe to invoke the DllUnregisterServer export function\n\n  It will copy of regsvr32.exe to update.exe, run update.exe and\n then invoke the DllUnregisterServer export function\n\n\n-----\n\n|Key: HK_LM\\Software\\Microsoft\\RPC Sub Key: Security|xor(not(one-byte key))[Decrypted Configuration] Persistent Service Identifier Name|\n|---|---|\n\n|Key: HK_LM\\Software\\Microsoft\\Windows NT\\Current Version\\Svchost\\ Sub Key: netsvcs|Persistent Service Service Service Service Name Name Name Name|\n|---|---|\n\n|Key: HK_LM\\System\\CurrentControlSet\\Service\\Persistent Service Name\\Parameter Sub Key: ServiceDll|Path to Derusbi DLL at %systemRoot%|\n|---|---|\n\n\n###### Key: HK_LM\\Software\\Microsoft\\RPC xor(not(one-byte key))[Decrypted Configuration] Sub Key: Security\n Persistent Service Identifier\n Name\n\n Key: HK_LM\\Software\\Microsoft\\Windows\n Persistent\n Service Service Service\n NT\\Current Version\\Svchost\\\n Service\n Name Name Name\n Sub Key: netsvcs\n Name\n\n Key: HK_LM\\System\\CurrentControlSet\\Service\\Persistent\n Path to Derusbi DLL\n Service Name\\Parameter\n at %systemRoot%\n Sub Key: ServiceDll\n\n\n-----\n\n# Technical Analysis\n\n##### Payload\n\n\n-----\n\n####  Main Thread\n\n###### Decrypt Run\n Load Elevate Start 2[nd]\n and Load Original\n Config Privileges Thread\n Driver Service\n\n • SeDebugPrivilege\n • SeLoadDriverPrivilege\n • SeShutdownPrivilege\n • SeTcbPrivilege\n\n\n-----\n\n####  Main Thread\n\n###### Decrypt Run\n Load Elevate Start 2[nd]\n and Load Original\n Config Privileges Thread\n Driver Service\n\n####  Not all samples contain an embedded driver\n\n  XOR-encrypted, with 4-byte key\n\n  Conditions for decrypting and loading driver\n\n###### »360’s ZhuDongFangYu.exe must not be running (optional) »The username of the current process must be “system”\n\n\n-----\n\n####  Main Thread\n\n###### Decrypt Run\n Load Elevate Start 2[nd]\n and Load Original\n Config Privileges Thread\n Driver Service\n\n####  Example Drivers:\n\n###### »Keylogger »USB/Disk infector »Network hooking driver\n\n\n-----\n\n####  Derusbi Sample (MD5: 92d18d1ca7e66539873be7f5366b04d1)\n\n  Iterate all directories on the disk\n\n  Drop Derusbi when service DLLs found\n\n  Create autorun.inf to auto-register Derusbi when the infected\n drive is connected to a computer\n\n\n-----\n\n####  Main Thread\n\n###### Decrypt Run\n Load Elevate Start 2[nd]\n and Load Original\n Config Privileges Thread\n Driver Service\n\n####  Second Thread\n\n###### Wait and Process\n Setup Connection to Load Config C&C Commands until\n C&C\n Shutdown\n\n\n-----\n\n# Technical Analysis\n\n##### Built-in modules\n\n\n-----\n\n####  Written in C++\n\n  RTTI information!\n\n###### »Thanks to IDA ClassInformer plugin\n\n####  Unfortunately, some 2014 samples uses updated classes\n\n\n-----\n\n####  INTERNAL_CMD\n\n  PCC_BASEMOD\n\n  PCC_CMD\n\n  PCC_FILE\n\n  PCC_MISC\n\n  PCC_PROXY\n\n  PCC_SYS\n\n\n-----\n\n####  All command classes are child classes of abstract class\n PCC_BASEMOD\n\n\n-----\n\n####  PCC_BASEMOD\n\n  INTERNAL_CMD\n\n  Novetta, 2014 describes some of these functions for an older\n Derusbi sample\n\n\n-----\n\n####  There is also a default handler\n\n###### »packet_type/class_id: 100h\n\n####  Some of its functions:\n\n###### »Terminate current connection (deprecated) »Cleanup data stored in the different modules »Backup configuration to registry, set current file to be deleted on\n reboot, terminate current process immediately »Terminate after current jobs »Install a new DLL\n\n\n-----\n\n####  INTERNAL_CMD (supersedes PCC_CMD class)\n\n###### »2011 – Present\n\n  Some samples from 2012 do not have this class though »Class ID: 5 »Interactive shell commands »Has help/? functions!!! »Common OS operations (v1.1)\n\n  cd, dir, md, rd, del, copy, ren, type, start »Additional commands in v1.2\n\n  runas\n  reboot [-f]\n  shutdown [-f]\n  clearlog\n  wget [httpurl]\n\n\n-----\n\n####  PCC_MISC\n\n###### »2011 – Present »Most samples have this class »Class ID: 10 »Mixture of numerical and text commands »Command IDs:\n\n  ID=1: save attached file to temp dir and load as DLL. Can remember up to\n 16 files.\n  ID=2: delete temp file. Attached filename must correspond to one of the 16\n saved from command ID 1\n\n\n-----\n\n####  PCC_MISC\n\n###### »2011 – Present »Most samples have this class »Class ID: 10 »Mixture of numerical and text commands »Text commands:\n\n  “pstore”: steals password information from IE and firefox and send to C2\n  “keylog\": send keylog info to C2\n  “info”: gathers system information and send to C2\n » OS name and build number » Network adapter info » IE version » Proxy server info » AV info (Norton, 360, Kaspersky, Trend Micro, ESET, Avira)\n\n\n-----\n\n####  PCC_SYS\n\n###### »2008 – Present »Almost all samples have this class »Class ID: 4 (80h in older samples) »4 types of numerical commands\n\n  Processes-related: enumerate and kill processes\n  Services-related: enumerate, start, stop, delete services\n  Registry-related: enumerate, create/delete keys, set/delete/replace values\n  Screenshot command »Each type contains its own command IDs\n\n\n-----\n\n####  PCC_FILE\n\n###### »2008 – Present »Almost all samples have this class »Class ID: 8 (84h in older samples) »Numerical commands\n\n  Cleanup\n  Enumerate all drives\n  Find/rename/delete/copy/move file\n  Save a file to system\n  Recursively enumerate directory\n  Start new process\n  Recursively enumerate all drives\n\n\n-----\n\n####  Old code, just packed\n\n###### »Class structure and functions from 2011/2012 »Compatibility/on-going attack?\n\n####  New version\n\n###### »Same payload delivery »Updated built-in classes\n\n\n-----\n\n####  Still written in C++\n\n  No RTTI information\n\n  Updated/rewritten classes\n\n###### »Custom code for creating new() objects »New is_this_data_for_me() virtual function »Dynamically decrypt embedded helper DLL during class initialization\n\n  Inject helper DLL into explorer.exe in class command handler function\n  Communicate with helper DLL using pipes »Removed duplicate functionality in modules\n\n\n-----\n\n####  Command IDs changed\n\n  No more verbose commands\n\n  No interactive shell\n\n  PCC_SYS, PCC_FILE, default_handler functionality still there\n\n  Identify newer OS like Win8 (but no Win 8.1 or 10)\n\n  Processor architecture detection(x86, x64, IA64, ARM)\n\n\n-----\n\n# Conclusion\n\n\n-----\n\n####  Samples circulating between vendors\n\n###### »Limited number of samples »Delayed discovery »Corrupt files\n\n####  To improve detection\n\n###### »Class/modular structure »IPS »Sakula/Shyape\n\n\n-----\n\n####  Modular\n\n  Fully-featured for stealth and espionage\n\n  Targeted attacks\n\n  Operations could take up to 2 years\n\n\n-----\n\n# Any questions?\n\n##### {mpun, ericleung, ntan}@fortinet.com\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.virusbulletin.com/uploads/pdf/conference_slides/2015/Pun-etal-VB2015.pdf"
    ],
    "report_names": [
        "Pun-etal-VB2015.pdf"
    ],
    "threat_actors": [
        {
            "id": "7a9a7873-8e41-40ae-9d06-b27c92bb54e4",
            "created_at": "2022-10-25T16:47:55.568362Z",
            "updated_at": "2025-03-27T02:05:17.264615Z",
            "deleted_at": null,
            "main_name": "BRONZE FIRESTONE",
            "aliases": [
                "C0d0s0",
                "Deep Panda ",
                "Pupa ",
                "TG-3551 ",
                "APT19 "
            ],
            "source_name": "Secureworks:BRONZE FIRESTONE",
            "tools": [
                " Alice's Rabbit Hole",
                " Briba",
                " Cobalt Strike",
                " Derusbi",
                " PlugX",
                " PoisonIvy",
                " Powershell Empire",
                " Zuguo",
                "9002"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "3fad11c6-4336-4b28-a606-f510eca5452e",
            "created_at": "2022-10-25T16:07:24.346573Z",
            "updated_at": "2025-03-27T02:02:10.183211Z",
            "deleted_at": null,
            "main_name": "Turbine Panda",
            "aliases": [
                "APT 26",
                "Black Vine",
                "Bronze Express",
                "Group 13",
                "JerseyMikes",
                "KungFu Kittens",
                "PinkPanther",
                "Shell Crew",
                "Turbine Panda",
                "WebMasters"
            ],
            "source_name": "ETDA:Turbine Panda",
            "tools": [
                "Agent.dhwf",
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "FF-RAT",
                "FormerFirstRAT",
                "Hurix",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mivast",
                "PlugX",
                "RbDoor",
                "RedDelta",
                "RibDoor",
                "Sakula",
                "Sakula RAT",
                "Sakurel",
                "Sogu",
                "StreamEx",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Winnti",
                "Xamtrav",
                "cobeacon",
                "ffrat"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "2f07a03f-eb1f-47c8-a8e9-a1a00f2ec253",
            "created_at": "2022-10-25T16:07:24.277669Z",
            "updated_at": "2025-03-27T02:02:10.157972Z",
            "deleted_at": null,
            "main_name": "TA428",
            "aliases": [
                "Operation LagTime IT",
                "Operation StealthyTrident",
                "ThunderCats"
            ],
            "source_name": "ETDA:TA428",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Agent.dhwf",
                "Albaniiutas",
                "BlueTraveller",
                "Chymine",
                "Cotx RAT",
                "CoughingDown",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Gen:Trojan.Heur.PT",
                "Kaba",
                "Korplug",
                "LuckyBack",
                "PhantomNet",
                "PlugX",
                "Poison Ivy",
                "RedDelta",
                "RoyalRoad",
                "SManager",
                "SPIVY",
                "Sogu",
                "TIGERPLUG",
                "TManger",
                "TVT",
                "Thoper",
                "Xamtrav",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "64ca1755-3883-4173-8e0a-6e5cf92faafd",
            "created_at": "2022-10-25T15:50:23.636456Z",
            "updated_at": "2025-03-27T02:00:55.51077Z",
            "deleted_at": null,
            "main_name": "Deep Panda",
            "aliases": [
                "Deep Panda",
                "Shell Crew",
                "KungFu Kittens",
                "PinkPanther",
                "Black Vine"
            ],
            "source_name": "MITRE:Deep Panda",
            "tools": [
                "Mivast",
                "StreamEx",
                "Sakula",
                "Tasklist",
                "Derusbi"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "46a151bd-e4c2-46f9-aee9-ee6942b01098",
            "created_at": "2023-01-06T13:46:38.288168Z",
            "updated_at": "2025-03-27T02:00:02.794118Z",
            "deleted_at": null,
            "main_name": "APT19",
            "aliases": [
                "Black Vine",
                "TEMP.Avengers",
                "PinkPanther",
                "G0073",
                "KungFu Kittens",
                "Group 13",
                "Shell Crew",
                "BRONZE FIRESTONE",
                "G0009",
                "Sunshop Group",
                "DEEP PANDA",
                "Codoso"
            ],
            "source_name": "MISPGALAXY:APT19",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "0639667a-fb3f-43d9-a38c-6c123fd19c7f",
            "created_at": "2022-10-25T16:07:23.335869Z",
            "updated_at": "2025-03-27T02:02:09.743237Z",
            "deleted_at": null,
            "main_name": "APT 19",
            "aliases": [
                "APT 19",
                "Bronze Firestone",
                "C0d0so0",
                "Codoso",
                "Deep Panda",
                "Operation Kingslayer",
                "Red Pegasus",
                "Sunshop Group",
                "TG-3551"
            ],
            "source_name": "ETDA:APT 19",
            "tools": [
                "Agentemis",
                "C0d0so0",
                "Cobalt Strike",
                "CobaltStrike",
                "Derusbi",
                "EmPyre",
                "EmpireProject",
                "Fire Chili",
                "PowerShell Empire",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716490,
    "ts_updated_at": 1743041803,
    "ts_creation_date": 1444300219,
    "ts_modification_date": 1444300219,
    "files": {
        "pdf": "https://archive.orkl.eu/5195fd48ff0ef5362f467e1de21044eea72ce2b7.pdf",
        "text": "https://archive.orkl.eu/5195fd48ff0ef5362f467e1de21044eea72ce2b7.txt",
        "img": "https://archive.orkl.eu/5195fd48ff0ef5362f467e1de21044eea72ce2b7.jpg"
    }
}