{
    "id": "386d2b89-68f4-49ec-94d4-5b380a36e417",
    "created_at": "2023-01-12T15:07:42.907433Z",
    "updated_at": "2025-03-27T02:05:34.911418Z",
    "deleted_at": null,
    "sha1_hash": "eed153cd74ff3b872175633ebcc5fb53d4a5a6c7",
    "title": "2020-06-22 - Comparative analysis between Bindiff and Diaphora - Patched Smokeloader Study Case",
    "authors": "",
    "file_creation_date": "2022-05-27T19:01:20Z",
    "file_modification_date": "2022-05-27T19:01:20Z",
    "file_size": 1397676,
    "plain_text": "# Comparative analysis between Bindiff and Diaphora - Patched Smokeloader Study Case\n\n**m.alvar.es/2020/06/comparative-analysis-between-bindiff.html**\n\nThis article presents a comparative study case of diffing binaries using two technologies: Bindiff [[1] and](https://www.zynamics.com/bindiff.html)\n_Diaphora_ [[2]. We approached this topic in a Malware Analysis perspective by analyzing a (guess which](http://diaphora.re/)\nmalware family?) Smokeloader (! :D) campaign.\n\nIn August 2019, I spotted this campaign using patched samples of Smokeloader 2018 samples. This specific\nactor patched binaries to add new controllers URLs without needing to pay extra money (Smokeloader's\nseller charges extra-fee for C2 URL updates). This campaign was described in more detail in this previous\n[article [3].](http://security.neurolabs.club/2019/08/smokeloaders-hardcoded-domains-sneaky.html)\n\n[More details about the original samples [4][5] analyzed in this article can be found in the following tables:](https://www.virustotal.com/gui/file/b61991e6b19229de40323d7e15e1b710a9e7f5fafe5d0ebdfc08918e373967d3)\n\n\nFilename:\n\nSize:\n\n\nsmokeloader_2018_unpatched.bin\n\n33792 Bytes\n\n\nFile type: PE32 executable (GUI) Intel 80386, for Microsoft Windows\n\nmd5: 76d9c9d7a779005f6caeaa72dbdde445\n\nsha1: 34efc6312c7bff374563b1e429e2e29b5da119c2\n\nsha256: b61991e6b19229de40323d7e15e1b710a9e7f5fafe5d0ebdfc08918e373967d3\n\n\n-----\n\nFilename:\n\n\nsmokeloader_2018_patched.bin\n\n\nSize: 1202732 Bytes\n\nFile type: PE32 executable (GUI) Intel 80386, for Microsoft Windows\n\nmd5: 7ba7a0d8d3e09be16291d5e7f37dcadb\n\nsha1: 933d532332c9d3c2e41f8871768e0b1c08aaed0c\n\nsha256: 6632e26a6970d8269a9d36594c07bc87d266d898bc7f99198ed081d9ff183b3f\n\n[The following tables hold details about the unpacked code dumped from \"explorer.exe\" used in this article [6]](https://www.virustotal.com/gui/file/865c18d1dd13eaa77fabf2e03610e8eb405e2baa39bf68906d856af946e5ffe1)\n\n[[7].](https://www.virustotal.com/gui/file/421482d292700639c27025db06a858aafee24d89737410571faf40d8dcb53288)\n\n\nFilename:\n\n\nexplorer.exe.7e8e32c0.0x02ee0000-0x02ef3fff.dmp\n\n\nSize: 81920 Bytes\n\nFile type: data\n\nmd5: 711c02bec678b9dace09bed151d4cedd\n\nsha1: 84d6b468fed7dd7a40a1eeba8bdc025e05538f3c\n\nsha256: 865c18d1dd13eaa77fabf2e03610e8eb405e2baa39bf68906d856af946e5ffe1\n\n\nFilename:\n\n\nexplorer.exe.7e8df030.0x00be0000-0x00bf3fff_patched.dmp\n\n\nSize: 81920 Bytes (yes, same size)\n\nFile type: data\n\nmd5: d8f23c399f8de9490e808d71d00763ef\n\nsha1: e1daad6cb696966c5ced8b7d6a2425ff249bf227\n\nsha256: 421482d292700639c27025db06a858aafee24d89737410571faf40d8dcb53288\n\nSummarizing the main changes implemented by this patch are:\n\nwipes out the code for decrypting C2 URLs;\nreplaces it with NOPs and hardcoded C2 URL string; and\npreserves the original size of decryption function to not disrupt offsets;\n\nFigure 01 and 02 presents the graph of the original code. Figure 01 is the code used for indexing a table of\nencrypted C2 URLs payloads. Figure 02 lists the code used for decrypting the C2 URLs. This function is\ncalled in other parts of the code (not only by the function shown in Figure 01) - this is why they are not\n\n\n-----\n\nmerged in one function. We labeled functions (e.g. ___decrypt_C2_url and_ ___decrypt_c2_algorithm ) in this_\nassembly code to make it easier to read.\n\nFigure 01 - Original code used for decrypting C2 URLs.\n\n\n-----\n\nFigure 02 - Original encryption scheme used for decrypting C2 URLs.\n\nFigure 03 and 04 shows the same functions on the patched version of Smokeloader. We can notice that the\nfirst function is the same as the unpatched version but the second function was replaced. This second\nfunction returns the address for the hardcoded URL in ECX. More details about how it works can be found in\n[this article [3].](http://security.neurolabs.club/2019/08/smokeloaders-hardcoded-domains-sneaky.html)\n\n\n-----\n\nFigure 03 - Patched code used for decrypting C2 URLs.\n\nFigure 04 - Patched code returning decrypted C2 URL string.\n\nThe next sections describe the output of Diaphora and Bindiff when diffing the samples above.\n\n**.::[ Diffing using Diaphora ]**\n\n_Diaphora is an Open Source binary diffing tool that uses SQLite as an intermediate representation for storing_\n[code and characteristics of reversed binaries [8]. It implements many diffing heuristics (strategies) directly on](https://www.youtube.com/watch?v=eAVfRxp99DM)\n\n\n-----\n\ntop of this database. The main advantage of this approach is that Diaphora is technology agnostic - this\nmeans that it does not depend on any reversing framework such as Ghidra, IDApro, or Binary Ninja.\n\nIt can even compare reversing databases built up using one specific tool with projects using another tool.\nThis characteristic facilitates collaboration among researchers. Another big advantage is that by using\n_SQLite for describing its heuristics it makes the processing of adding a new heuristic as \"simple\" as writing a_\nnew SQL so more people can contribute to the growth of the project and more experimental heuristics can\nbe quickly prototyped and verified.\n\nIn the experiment described in this section, we used Diaphora version 2.0.2 (released in October 2019) and\n_IDApro_ _7.5. Diaphora works as an IDApro_ _Python script and can be easily executed by \"File -> Script File\" or_\n\"alt + F7\". Figure 05 shows its main interface.\n\nFigure 05 - Diaphora main Dialog Interface\n\nThis interface is a little bit confusing at a first sight especially for users that did not go through the\ndocumentation before trying to use it. It expects the user to input both SQLite databases to be compared,\nboundaries (for the working database), and set up some checkboxes with options.\n\nFirst, we used Diaphora over the reference database (unpatched Smokeloader) for extracting characteristics\nand generating our reference Diaphora SQLite database. For doing this we just need to open the reference\ndatabase on IDA, open Diaphora, and fill the \"Export IDA database to SQLite\" input field. Diaphora will\nexport its SQLite database to the same base directory of the IDA working files.\n\n\n-----\n\nAfter executing Diaphora on our patched Smokeloader using out saved labeled database of Smokeloader\n_2018 as a reference in Diaphora we get four new tabs in IDA:_\n\n_Best Matches - common functions to both databases. The ones with 100% match ratio;_\n_Partial Matches - all functions that are not Best matches and not unmatched;_\n_Unmatched in Primary - all functions in the first database that are not present in the second;_\n_Unmatched in Secondary - all functions in the second database that are not present in the first;_\n\nFigure 06 shows the content of the \"Best Matches\" tab in our example.\n\nFigure 06 - Diaphora Best Matches tab\n\nEach row shows function labels in primary and second databases, matching ratio (which goes from 0 to 1),\namount of basic blocks in each database and information about which heuristic was used to compare both\nfunctions. Diaphora provides features to importing features (such as commends and function labels) from the\nreference database to the target database. Usually, you will want to copy all annotations from one database\nto another in this \"Best Matches\" tab. By checking this tab we can see that few core functions are kept intact\nin the patched version and we are facing two very similar applications.\n\nFigure 07 presents the \"Partial Matches\" functions.\n\nFigure 07 - Partial Matches functions and our \"__decrypt_C2_url\" function right there with 0.978 matching\n\nratio.\n\n\n-----\n\n_Diaphora provides very fine level diffing and most of these functions are basically unmatching constants._\nThese matches are marked in yellow in the graph diff view. Figure 08 and 09 shows the\n\"__set_file_attributes\" function and its match in the primary database. We can clearly see that they actually\nare the same function.\n\nFigure 08 - Diffing \"__set_file_attributes\" function assembly view.\n\n\n-----\n\nFigure 09 - Diffing \"__set_file_attributes\" function using graph view.\n\nFigure 10 shows the relevant patch we are interested in the \"__decrypt_C2_url\" function. As we can see both\nfunctions are basically identical until the jump instruction. The function jumps to what I labeled as\n\"__decrypt_C2_algorithm\" and is used as a function in other places around the code.\n\n\n-----\n\nFigure 10 - \"__decrypt_C2_url\" graph diff pointed in the \"Partial Matches\" tab\n\nWhat disappointed me a little bit was that Diaphora did not include the rest of the code of\n\"__decrypt_C2_algorithm\" in this function. This move bumped up the matching ratio and this was misleading\nwhen prioritizing what to manually analyze. The \"__decrypt_C2_algorithm\" function shows up in the\n\"Unmatched in Secondary\" tab. This is a good thing as functions in this tab should be the priority in this kind\nof analysis. In our example, we got 18 functions (out of 52) to analyze marked in the \"Unmatched in\n_Secondary\" tab. Figure 11 shows this tab and Figure 12 shows the graph view of this function._\n\n\n-----\n\nFigure 11 - \"Unmatched in Secondary\" tab and patched \"__decrypted_C2_algorithm\" function\n\nFigure 12 - Patched version of \"__decrypt_C2_algorithm\" function\n\nThe nicest thing about using Diaphora is that all this analysis could be easily shared by sharing compressed\n_SQLite databases around. So that is it for the Diaphora side._\n\n**.:: [ Diffing using BinDiff ]**\n\n_BinDiff is an executable-comparison tool created by Zynamics_ [[9] (called SABRE in earlier days) in 2007.](https://www.zynamics.com/company.html)\nZynamics was acquired by Google in 2011 and BinDiff became freeware in 2016 [[10][11]. BinDiff is a plugin](https://security.googleblog.com/2016/03/bindiff-now-available-for-free.html)\nof IDAPro and works directly over IDBs (IDA pro Database). Because of this design, BinDiff requires users to\nhave an IDA license (#notcool). BinDiff _6.0 supports also Ghidra using this extra plugin called BinExport [12]_\nwhich implements something similar to Diaphora's design.\n\nOALabs released a very didactic video tutorial on BinDiff [[13]. This video also teaches how to install BinDiff.](https://www.youtube.com/watch?v=BLBjcZe-C3I)\nWe used BinDiff _6.0 and IDAPro_ _7.5 in this experiment. BinDiff adds a new option to the \"File\" menu in IDA_\nand to compare two executable is as easy as opening a new IDB on top of the current one. Figure 13 shows\nthe BinDiff option in IDA.\n\n\n-----\n\nFigure 13 - BinDiff option in IDAPro\n\nAfter loading an annotated IDA database using BinDiff, it will add 4 new tabs:\n\n_Primary Unmatched - functions in the primary database that did not match any function in the_\nsecondary database;\n_Secondary Unmatched - functions in the secondary database that did not match any function in the_\nprimary database;\n_Statistics - general similarity information about both executables;_\n_Matched Functions - all functions with matches and their respective similarity index._\n\nThe two first tabs hold the same information as their correlated tabs in Diaphora. Statistics tab provides highlevel information about the matching process. Information in this tab can be used for quick knowing if the\nbinary is a variation of the reference database. Figure 13 shows the data presented in the Statistics tab after\nloading our reference Smokeloader database against the patched one using BinDiff.\n\n\n-----\n\nFigure 14 - Statistics tab and confidence and similarity indexes\n\n_BinDiff calculated a similarity index of 95% (with 99% confidence). This means that we are likely dealing with_\ntwo versions of the same software. The other metrics are more about counters and general information about\nboth databases.\n\nFigure 14 shows the Matched Functions tab and the similarity index for each match. It is also possible to see\nthe heuristic used for each match.\n\nFigure 15 - Matched Functions tab\n\n_BinDiff managed to match 51 out of 52 functions. This is a very good result. Besides that Bindiff managed to_\nfind out the two most affected functions by the patch: (i) \"__decrypt_C2_algorithm\" and (ii)\n\" _decrypt C2 url\". It is possible to zoom in and visualize changes in graphs of the function matched._\n\n\n-----\n\nFigure 16 shows changes in function \"__decrypt_C2_url\" (73% of similarity and 97% of confidence).\n\nFigure 16 - Changes in function \"__decrypt_C2_url\"\n\nAs we can see, BinDiff hits the bullseye and detects exactly the changes without splitting the function into\ntwo parts. The way BinDiff organizes its graphs makes changes really easy to visualize.\n\n_Bindiff also matches the \"__decrypt_C2_algorithm\" function with some other function located at_\n\"0x00BE19A5\" using the \"loop count\" heuristic but the similarity index is only 19% and confidence is 27%.\nThis means that Bindiff matched the \"__decrypted_C2_algorithm\" function, which was wiped out with the\npatch, with some other random function. I don't even consider this a false-positive as results clearly state that\nthis match has low confidence. It is useful to get a spotlight pointed to this function - this for sure is a good\nplace to start an analysis in this specific scenario.\n\n**.:: [ Conclusions ]**\n\nFor the specific malware analysis problem discussed in this article, we definitely got better results using\n_BinDiff than Diaphora. I also feel that all fine program analysis used in heuristics applied by BinDiff makes a_\nbig difference in the final result.\n\nIn terms of general design (not taking in consideration heuristics), I think Diaphora has more advantages\nthan Bindiff, because of its intermediate representation using an open specification format as SQLite and\n\n\n-----\n\n_SQL for modeling heuristics. Diaphora is also Open Source so there is a task force sustained by a_\ncommunity in order to improve heuristics and this is the way to go IMHO.\n\n_Diaphora also takes boundaries as parameters and this can be very useful in case of analyzing big_\ndatabases especially when analyzing patches for vulnerability development purposes. In line with that, this\narticle focuses on malware analysis but these same technologies could also be used for analyzing\nvulnerabilities and its patches - ammunition to another blog post.\n\n**.:: [ References ]**\n\n[1] https://www.zynamics.com/bindiff.html\n\n[2] http://diaphora.re/\n\n[3] http://security.neurolabs.club/2019/08/smokeloaders-hardcoded-domains-sneaky.html\n\n[4]\nhttps://www.virustotal.com/gui/file/b61991e6b19229de40323d7e15e1b710a9e7f5fafe5d0ebdfc08918e373967d3\n\n[5]\nhttps://www.virustotal.com/gui/file/6632e26a6970d8269a9d36594c07bc87d266d898bc7f99198ed081d9ff183b3f\n\n[6]\nhttps://www.virustotal.com/gui/file/865c18d1dd13eaa77fabf2e03610e8eb405e2baa39bf68906d856af946e5ffe1\n\n[7]\nhttps://www.virustotal.com/gui/file/421482d292700639c27025db06a858aafee24d89737410571faf40d8dcb53288\n\n[8] https://www.youtube.com/watch?v=eAVfRxp99DM (BSides Joxean)\n\n[9] https://www.zynamics.com/company.html\n\n[10] https://security.googleblog.com/2016/03/bindiff-now-available-for-free.html\n\n[11] https://www.zynamics.com/bindiff/manual/#N20140\n\n[12] https://github.com/google/binexport/tree/v11/java/BinExport\n\n[13] https://www.youtube.com/watch?v=BLBjcZe-C3I (BinDiff OALabs)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-22 - Comparative analysis between Bindiff and Diaphora - Patched Smokeloader Study Case.pdf"
    ],
    "report_names": [
        "2020-06-22 - Comparative analysis between Bindiff and Diaphora - Patched Smokeloader Study Case.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536062,
    "ts_updated_at": 1743041134,
    "ts_creation_date": 1653678080,
    "ts_modification_date": 1653678080,
    "files": {
        "pdf": "https://archive.orkl.eu/eed153cd74ff3b872175633ebcc5fb53d4a5a6c7.pdf",
        "text": "https://archive.orkl.eu/eed153cd74ff3b872175633ebcc5fb53d4a5a6c7.txt",
        "img": "https://archive.orkl.eu/eed153cd74ff3b872175633ebcc5fb53d4a5a6c7.jpg"
    }
}