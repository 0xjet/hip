{
    "id": "3dde32f0-3111-4459-a195-853fbd3aaa18",
    "created_at": "2023-01-12T15:09:43.780217Z",
    "updated_at": "2025-03-27T02:05:55.683087Z",
    "deleted_at": null,
    "sha1_hash": "d7d7edffab017a790ad3208bcc628eca36f940c9",
    "title": "2022-02-08 - Conficker Analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T16:04:29Z",
    "file_modification_date": "2022-05-28T16:04:29Z",
    "file_size": 1228091,
    "plain_text": "# Conficker\n\n**[github.com/itaymigdal/malware-analysis-writeups/blob/main/Conficker/Conficker.md](https://github.com/itaymigdal/malware-analysis-writeups/blob/main/Conficker/Conficker.md)**\n\nitaymigdal\n\n\n**Malware**\n**Name**\n\n\n**File**\n**Type** **SHA256**\n\n\nConficker x32\ndll\n\n## Intro\n\n\na30b63e1ed900d3f223277b1d3b09b045abc85600da0d3102fa61fb2bfc2ff99\n\n\nAlmost 15 years old ago, a worm named Conficker did a LOT of trouble. to this day,\nthere are some Windows environments (mainly XP based networks) which are still\ninfected with this piece of code (brilliant code for 2008). With millions of infections all\nover the world, 5 variations, and a lot of damage, some say this is the most remarkable\nworm that was ever made.\n\nSo i took it for a ride in my lab.\n\n## Analysis process\n\nI first encountered that worm when i received a Disk On Key with an `autorun.inf file`\nand weird file with suspicious extension `jwgkvsq.vmx which both were super infected`\nin AV engines. Any time an infected DOK inserted into a computer, it pops up this\nwindow:\n\n\n-----\n\nThis is a very nice social engineering trick, the `autorun.inf is disguised as the`\nexplorer icon and caption (look at the duplicated explorer actions, one under \"Install or\nrun a program\" - which invoking the `autorun.inf, and the other under \"General`\noptions\" - the benigh one). Observing the autorun file:\n\nWe see a lot of shity unclear randomness which not clear if this is obfuscation or a\nbinary. By scrolling down (how down? line 1227) some few strings are exposed inside\nthis sea of garbage:\n\n\n-----\n\nCleaning it up:\n\nThe first line bind the `autorun.inf to explorer icon. The second line executes the`\nother file using Rundll32.exe which invokes a gibberish export function (actually, this\nmethod isn't even exist in `jwgkvsq.vmx dll. before validating the export name -`\nDllMain is called).\n\nOpening `jwgkvsq.vmx in Pestudio:`\n\nFirst stage is packed by UPX. unpacking:\n\n\n-----\n\nFor my convenience, here i converted the dll to exe (the tool just changed a single bit in\nPE header):\n\nEntropy is 8 so the file is still packed:\n\nWe will try to unpack it later, for now let's run the file under Procmon to get a general\nidea of the file operations. The file is very noisy and many operation were seen.\n\nThe file persists itself in a run key:\n\n\n-----\n\nDeletes Windows Defender from run key:\n\nResets the TCP receive window using Netsh.exe (not sure exactly why, but it's part of\nthe setup for the upcoming Brute Force).\n\nProbes for live hosts in the internal network by trying to connect to their SMB share:\n\n\n-----\n\nIn this part i started to debug the file under debugger in order to unpack it. Even though\nthis is an old malware and fair to think that it is lacking protections, it's not true. it\ncontains polymorphism, obfuscation and anti-analysis tricks. after some struggling with\nit and at least 5 `VirtualAlloc, I saw a PE file that was written to a newly allocated`\nmemory:\n\n[The file was in its mapped format (reference), and for some reason i was unable to](https://www.youtube.com/watch?v=cc1tX1t_bLg)\nunmap it to its raw format, trying various methods. i suspect that the reason is because\nthe PE headers were corrupted in some way. So in some point i gave up the\nunmapping, and moved on to the very JUICY strings armed with my prior knowledge on\nConficker actions.\n\nFirst were the `autorun.inf strings which were written to every Disk on Key that`\ninserted to an infected machine:\n\n\n-----\n\nThen there are a big list of security producs and related names, which will compared\nagainst each DNS lookup the host makes, and if the DNS request contains any of these\nwords, the request will be blocked! that is done by hooking the DNS library in every\nprocess!!\n\n\n-----\n\nIt also has the ability to retrieve the external IP address of the machine by quering each\nof those sites:\n\nAnd there is the password list (part of it, it's longer):\n\n\n-----\n\n## Spreading\n\nThe worm spreads itself by 3 mechanisms:\n\n1. By Brute Forcing SMB shares using the password list. when it guesses the right\n\npassword, it writes the payload to the remote share and runs it by creating a\nremote service.\n2. By Infecting DOKs and removable drives.\n3. By [ms08-067, which is being exploited heavily by it. for that, the worm creates a](https://docs.microsoft.com/en-us/security-updates/securitybulletins/2008/ms08-067)\n\nlocal HTTP server on the infected machine, which serves the payload for any host\nthat is exploited successfuly.\n\n## More capabilities which not discussed\n\n[1. The worm contains a DGA algorithm (explained here).](https://blog.malwarebytes.com/security-world/2016/12/explained-domain-generating-algorithm/)\n2. The worm changes TCP settings, like the allowed current TCP connections, in\n\norder to optimize the Brute Force process.\n3. The worm shuts down system services, like `Windows Defender and`\n```\n   Background Intelligent Transfer Service to disrupt automatic updates\n\n```\nand protections.\n4. The worm injects itself to system services like `Explorer.exe and`\n```\n   Svchost.exe .\n\n```\n5. The worm deletes the System Restore Points.\n6. The worm contains anti-analysis, anti-sandbox and anti-vm capabilities, and a lot\n\nof obfuscation and \"spaghetti code\".\n\n## Conclusion\n\n\n-----\n\nConficker is a sophisticated, contagious, brutal and noisy Windows worm. In this writeup\ni discussed only a small part of Conficker whole story, there is a [comprehensive article](https://www.f-secure.com/v-descs/worm_w32_downadup_al.shtml)\nabout it as well.\n\nHope you enjoyed :)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-08 - Conficker Analysis.pdf"
    ],
    "report_names": [
        "2022-02-08 - Conficker Analysis.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536183,
    "ts_updated_at": 1743041155,
    "ts_creation_date": 1653753869,
    "ts_modification_date": 1653753869,
    "files": {
        "pdf": "https://archive.orkl.eu/d7d7edffab017a790ad3208bcc628eca36f940c9.pdf",
        "text": "https://archive.orkl.eu/d7d7edffab017a790ad3208bcc628eca36f940c9.txt",
        "img": "https://archive.orkl.eu/d7d7edffab017a790ad3208bcc628eca36f940c9.jpg"
    }
}