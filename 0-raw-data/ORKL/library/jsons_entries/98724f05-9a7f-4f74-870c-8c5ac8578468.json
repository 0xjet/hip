{
    "id": "98724f05-9a7f-4f74-870c-8c5ac8578468",
    "created_at": "2023-01-12T14:59:36.708002Z",
    "updated_at": "2025-03-27T02:05:28.774921Z",
    "deleted_at": null,
    "sha1_hash": "225a677ae294b6f88b60349ca029f9917ee644dc",
    "title": "2017-12-13 - Tyupkin ATM Malware- Take The Money Now Or Never!",
    "authors": "",
    "file_creation_date": "2022-05-28T19:26:07Z",
    "file_modification_date": "2022-05-28T19:26:07Z",
    "file_size": 939754,
    "plain_text": "# Tyupkin ATM Malware: Take The Money Now Or Never!\n\n**lastline.com/labsblog/tyupkin-atm-malware/**\n\nDecember 13, 2017\n\nPosted by [Alexander Sevtsov ON DEC 13, 2017](https://www.lastline.com/author/alexander/)\nA Sandbox is a dynamic file analysis system that allows a researcher to analyze the behavior\nof potentially malicious code in a virtualized environment without damaging a real host\nsystem. In some cases, a sandbox has to analyze an attack without seeing the full chain (for\nexample when it analyzes a dropped file without the corresponding dropper component) or\nmust work with limited information about the target environment (for example when an attack\ntargets a particular operating system or runtime). In the worst-case scenario, these missing\npieces can completely hinder the sandbox’s ability to successfully run an application.\n\n## Lastline Sandbox\n\nIn today’s blog post, we are going to dive deep into one such example and show how the\nLastline sandbox can still classify malware despite an incomplete environment, and even\nhow a security researcher or incident responder can still be able to elicit behavior from a\n\n\n-----\n\nmalware sample. This can be done via the so-called application bundles. These bundles\nallow the user to extend, customize, and tailor the analysis environment to the needs of the\nparticular attack and allow us to analyze and dissect an application requiring non-existent\nWindows DLLs, file path or registry values.\n\n## ATM Malware\n\nFor today’s case study, we use a Tyupkin malware sample, a .Net application for bank\n[automated teller machines (ATM) running on the Microsoft Windows operating system.](https://en.wikipedia.org/wiki/Automated_teller_machine)\nTyupkin’s aim is to steal cash by sending a specific command to the cash dispenser of the\ncompromised ATM. During the analysis, our sandbox will trick the malware into believing that\nour analysis environment is an ATM itself. We will achieve this by submitting our sample\nbundled with a few specific DLLs that provide programmer’s interfaces to a Windows-based\n[ATM, Extensions for Financial Services (XFS).](https://en.wikipedia.org/wiki/CEN/XFS)\n\n**Delivery Vectors**\n\nInterestingly, this malware family seems to be delivered to the ATM manually. In other words,\nto install the malware, the attacker requires physical access to an ATM via an exposed USB\nport or other input/output bus. Note that this is not usually necessary as some attackers have\nbeen known to install ATM malware as part of [an internal software update processes.](https://www.bankinfosecurity.com/atm-hackers-double-down-on-remote-malware-attacks-a-10338)\n\n**Anti-Analysis**\n\nAs with many malware families, ATM malware actively tries to hinder incident response and\nevade dynamic analysis systems by using well-known, off-the-shelf code protectors and\npackers, such as .NET Reactor, .Net Confuser, VMProtect, and Themida. This is a common\n[self-defense mechanism. For example, one of the previously seen ATM infectors packed with](https://securelist.com/atm-infector/74772/)\nthe Themida packer makes use of several anti-debug and anti-sandbox tricks (as shown\nbelow in the analysis overview of the sample SHA1:\n3022e60790e17303def03761c8fa7e7393a0ad26): IsDebuggerPresent,\n_CheckRemoteDebuggerPresent, RDTSC timing evasions, and Windows class names to_\nname a few.\n\n\n-----\n\nFigure 1. Lastline analysis overview of an ATM infector packed with Themida\n\n[Some other families, such as ATMii, are known to perform the remote code injection hiding](https://securelist.com/atmii-a-small-but-effective-atm-robber/82707/)\nthe malicious code in a specific ATM process.\n\nFigure 2. Lastline analysis overview of an ATMii malware, remote code injection\n\n**Tyupkin Malware**\n\nThe piece of ATM malware that is the subject of this article is known as Tyupkin (SHA1:\n0c3e6c1d4873416dec94c16e97163746d580603d). The entry point has the following code:\n\n\n-----\n\nFigure 3. The entry point\n\nThe first sandbox evasion we see is an execution delay of 10 minutes. Considering that\nmany automated malware analysis systems to allocate only 4-5 minutes to analyze\napplication behaviors, it is not a surprise to see such a simple yet potentially effective\nevasion attempt.\n\nLet’s now step into the Form1 class, and further, into the InitializeComponent method. The\npurpose of this method is to register a specific event handler Form1_Shown.\n\nFigure 4. Registering an event handler\n\nBelow a fragment of “Form1_Shown” code:\n\n\n-----\n\nFigure 5. Form1_Shown function\n\nIt first retrieves a path to the system directory through the _[SHGetFolderPath function and](https://msdn.microsoft.com/en-us/library/windows/desktop/bb762181(v=vs.85).aspx)_\nverifies whether it already infected the underlying system. Then it hides the main window by\n[calling ShowWindow API with SW_HIDE parameter, and adds itself to the autorun to make](https://msdn.microsoft.com/en-us/library/windows/desktop/ms633548(v=vs.85).aspx)\nsure it will run after reboot:\n\nHKLM\\SOFTWARE\\MICROSOFT\\WINDOWS\\CURRENTVERSION\\RUN: AptraDebug\n\nNext, it checks whether the connection to the XFS Manager was successfully established\nand if not, it deletes itself by using the following command:\n\ndel /F /S /Q C:\\WINDOWS\\system32\\ulssm.exe\n\nIf the connection is successful, the program runs two threads: the first checks the current\nsystem time which then allows the second thread to execute only on Sunday and Monday\nnights, and only at specific time intervals. This is done by calling a combination of _time64\n[and _localtime64 functions, and then parsing the time_t structure. We can see a snippet of](https://msdn.microsoft.com/en-us/library/1f4c8f33.aspx)\nsuch code in the fragment below:\n\n\n-----\n\nFigure 6. Checking time interval, Tyupkin ATM malware\n\nThe second thread contains the main functionality of the malware. Tyupkin supports several\noperations, or activation codes, known only by the criminals, which prevents unauthorized\naccess (or black-box analysis approach). Given a proper activation code (entered using the\nATM PIN pad) the malware can delete itself or hide/show its main window. It can also\n[programmatically disable the network interfaces through the NcFreeNetconProperties API](https://msdn.microsoft.com/en-us/library/windows/desktop/aa366190(v=vs.85).aspx)\n(netshell.dll) every time the cash is dispensed (probably to foil any attempt to communicate\nwith the infected machine):\n\n\n-----\n\nFigure 7. Disabling LAN (beautified decompiled code)\n\nThe malware is also able to extend the timeout interval (probably for those sleepyheads\ncriminals who don’t want to withdraw money just during the first hours of the day, as\nmandated by the checks performed by the first thread), and, most importantly, to withdraw\nmoney, which is after all its main purpose. This is achieved by calling WFSExecute API when\nthe dwCommand parameter is equal to WFS_CMD_CDM_DISPENSE (0x12E). To get the\ncurrent balance of the cash units, the malware calls WFSGetInfo API with dwCategory\nparameter set to WFS_INF_CDM_CASH_UNIT_INFO (0x303). If successful, the following\ntext will appear on the ATM’s screen: “Take the money now!” prompting the user to enter a\ncassette number and press enter:\n\n\n-----\n\nFigure 8. Dispensing cash, Tyupkin ATM malware\n\nBelow is the complete workflow of the Tyupkin ATM malware:\n\n\n-----\n\nFigure 9. Tyupkin ATM malware workflow\n\n**Automatic Analysis for Detection**\n\nAs we can see in the analysis above, this Tyupkin malware family requires a very specific\nenvironment to exhibit its behavior. Even if the malware successfully loads (which is not a\ngiven) entire functionalities are still not triggered if a specific library is not installed.\n\nAs we discussed in earlier blog posts, the Lastline analysis engine is able to dynamically\nadjust the environment to meet the attackers’ goals, to alter the system information at\n[runtime, or detect malicious behaviors even in program sections that are not fully executed.](https://www.lastline.com/labsblog/awakening-dormant-functionality-in-malware-programs/)\n\nAnother approach to detect this type of targeted attack is by using the environment sensitivity\nof the program against the attacker itself. The main idea is to flag a sample as suspicious\nwhenever the analyzed code is deemed too dependent on a specific environment, for\nexample when some ATM components are required for execution\n\n\n-----\n\n## Manual Analysis via Lastline Application Bundles\n\nDetecting such malware is important, but sometimes a malware analyst needs to go further\nand see more details of the behavior by manually adjusting the analysis environment to meet\nthe attacker requirements. This can include invoking the executable with a specific command\nline, altering the registry or file-system, or loading code in the context of a particular process.\n\nThe Lastline analysis sandbox allows doing exactly this via a concept we call Lastline\n_application bundles. These bundles, called llappbundles, allow the analyst to specify exactly_\nhow the environment is to be “prepared” and how the analysis will be performed by the\nsandbox (both Windows or Mac OS sandboxes are supported).\n\nFor example, sometimes an executable requires additional command line launch parameters\n—must be run from a particular folder or with a specific file name—or it should run a specific\nexport function (in case of DLL), or run a file imports APIs from a DLL that is not present in\nthe guest OS. All these issues are addressed by llappbundles. Below we can see a\nscreenshot of a successful (i.e., complete with behaviors) execution of the Typkin malware\nafter loading an application bundle with both sample and required libraries.\n\nFigure 10. Tyupkin analysis overview, Lastline Application Bundle\n\n[In order to create an application bundle we used the create_appbundle function:](https://analysis.www.lastline.com/analyst-api-docs/html/analysis_client_application_bundles.html#api-client-application-bundles)\n\n```\nimport logging\n\n```\n```\nimport llappbundle.helper\n\n```\n```\ntyupkin_appbundle = llappbundle.helper.create_appbundle(\n\n```\n```\n  files={\n\n```\n```\n    r\"ulssm.exe\": open(\"myfiles/tyupkin.exe_\", \"rb\"),\n\n```\n\n-----\n\n```\n    r msxfs.dll : open( myfiles/msxfs.dll, rb ),\n\n```\n```\n    r\"xfs_supp.dll\": open(\"myfiles/xfs_supp.dll\", \"rb\"),\n\n```\n```\n    r\"xfs_conf.dll\": open(\"myfiles/xfs_conf.dll\", \"rb\")\n\n```\n```\n  },\n\n```\n```\n  run_directory=\"${TEMP}\",\n\n```\n```\n  main_subject=r\"ulssm.exe\",\n\n```\n```\n  logger=logging\n\n```\n```\n)\n\n```\n```\nwith open('myfiles/tyupkin.app','wb') as output_stream:\n\n```\n```\n  output_stream.write(tyupkin_appbundle.read())\n\n```\n\nAnother approach is to create an archive with all the DLLs and the main executable file—the\nLastline analysis engine is smart enough to generate an application bundle from it.\n\n## Conclusion\n\nIn this article, we showed how a security researcher or incident response organization can\nanalyze applications, such as ATM malware, that require non-default Windows libraries. By\nsubmitting programs as application bundles (llappbundles), it is possible to perform dynamic\ncustomization of the guest analysis environment. This easily allows incident responders to\ninvestigate evasion and persistence mechanisms as well as analyze packers and protectors\nthat are normally used to hinder analysis. Further, it is possible to improve detection of\nsamples targeting specific environments, a behavior commonly found in advanced persistent\nthreats.\n\nAbout\nLatest Posts\n\n## Alexander Sevtsov\n\nAlexander Sevtsov is a Malware Reverse Engineer at Lastline. Prior to joining Lastline, he\nworked for Kaspersky Lab, Avira and Huawei, focusing on different methods of automatic\nmalware detection. His research interests are modern evasion techniques and deep\ndocument analysis.\n\n\n-----\n\n**[Latest posts by Alexander Sevtsov (see all)](https://www.lastline.com/author/alexander/)**\n\n[Evasive Monero Miners: Deserting the Sandbox for Profit - June 20, 2018](https://www.lastline.com/labsblog/evasive-monero-miners/)\n[I Hash You: A Simple But Effective Trick to Evade Dynamic Analysis - April 10, 2018](https://www.lastline.com/labsblog/evasive-malware-tricks/)\n[Olympic Destroyer: A new Candidate in South Korea - February 21, 2018](https://www.lastline.com/labsblog/olympic-destroyer-south-korea/)\n\nTags:\n\n[ATM,](https://www.lastline.com/tag/atm/) [ATM Malware,](https://www.lastline.com/tag/atm-malware/) [ATMii,](https://www.lastline.com/tag/atmii/) [Lastline Sandbox,](https://www.lastline.com/tag/lastline-sandbox/) [sandboxes,](https://www.lastline.com/tag/sandboxes/) [Themida packer,](https://www.lastline.com/tag/themida-packer/) [Tyupkin,](https://www.lastline.com/tag/tyupkin/) Tyupkin\nmalware\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-12-13 - Tyupkin ATM Malware- Take The Money Now Or Never!.pdf"
    ],
    "report_names": [
        "2017-12-13 - Tyupkin ATM Malware- Take The Money Now Or Never!.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535576,
    "ts_updated_at": 1743041128,
    "ts_creation_date": 1653765967,
    "ts_modification_date": 1653765967,
    "files": {
        "pdf": "https://archive.orkl.eu/225a677ae294b6f88b60349ca029f9917ee644dc.pdf",
        "text": "https://archive.orkl.eu/225a677ae294b6f88b60349ca029f9917ee644dc.txt",
        "img": "https://archive.orkl.eu/225a677ae294b6f88b60349ca029f9917ee644dc.jpg"
    }
}