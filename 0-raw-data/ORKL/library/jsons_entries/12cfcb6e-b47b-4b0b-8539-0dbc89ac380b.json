{
    "id": "12cfcb6e-b47b-4b0b-8539-0dbc89ac380b",
    "created_at": "2023-01-12T15:09:04.035582Z",
    "updated_at": "2025-03-27T02:09:30.281788Z",
    "deleted_at": null,
    "sha1_hash": "4c999f68cd837513175ef261e5e01c4210321dc2",
    "title": "2020-05-29 - ShellReset RAT Spread Through Macro-Based Documents Using AppLocker Bypass",
    "authors": "",
    "file_creation_date": "2022-05-28T19:34:40Z",
    "file_modification_date": "2022-05-28T19:34:40Z",
    "file_size": 6069296,
    "plain_text": "# ShellReset RAT Spread Through Macro-Based Documents Using AppLocker Bypass\n\n**[zscaler.com/blogs/research/shellreset-rat-spread-through-macro-based-documents-using-applocker-bypass](https://www.zscaler.com/blogs/research/shellreset-rat-spread-through-macro-based-documents-using-applocker-bypass)**\n\nAs we've mentioned in previous blogs, cybercriminals will often tie their attacks to current\nevents. So, it isn't surprising that we noticed another one of these, with this particular\none using tech events in London as the bait.\n\nIn February 2020 and May 2020, we observed four malicious macro-based Microsoft Word\ndocuments hosted on newly registered sites with top-level domains of .space and .xyz. We\nattribute these attacks to the same threat actor due to the similar tactics, techniques and\nprocedures (TTPs) used to deploy the final payload.\n\nThe final .NET payload, to the best of our knowledge, has not been observed in the wild\nbefore. It has a small code section in it that overlaps with the QuasarRAT. However, this\ncode was not used at runtime. We have assigned the name - ShellReset to this RAT based\non the unique strings found inside the final payload.\n\nDue to the limited instances we have observed in the wild, we suspect this to be a lowvolume targeted attack. Some of the themes used in these attacks by the threat actor are\nrelated to important events that were originally scheduled to take place in London earlier\n[this year, including the 5G Expo and](https://5gexpo.net/global/) [Futurebuild.](https://www.futurebuild.co.uk/)\n\nThe infection chain involves interesting techniques, such as compiling the payload at\nruntime on the endpoint using trusted Windows utilities to bypass security mechanisms and\ndownloading the next stages in the form of obfuscated source code from the attacker’s\nserver.\n\n\n-----\n\nIn this blog, we provide a detailed description of the distribution strategy and the technical\nanalysis of the attack.\n\n## Distribution strategy\n\nThe first instance of the document related to this campaign was found on February 24,\n2020. It was hosted at the URL: hxxps://documentsharing.space/files/5G%20Expo.doc?\nclientEmail=\n\n**MD5 hash: 93f913f3b9e0ef3f5cedd196eae3f2ae**\n\n**File name: 5G Expo.doc**\n\nThe content of this document was related to 5G Expo event, which was scheduled to take\nplace on March 17-18, 2020 in London as shown in Figure 1.\n\n\n-----\n\n_Figure 1: This document displays the 5G Expo 2020 theme after macros are enabled._\n\nOn the same day, we observed another instance of a document hosted on the same\ndomain at the URL: hxxps://documentsharing.space/files/FutureBuild.doc?clientEmail=\n\n**MD5 hash: b34b74effbd8647c4f5dc61358e1555f**\n\n**File name: FutureBuild.doc**\n\nThe content of this document was related to Futurebuild 2020 conference, which was\nsupposed to take place between March 3-5, 2020 in London. The document spoofed the\ncontents to look like an admission voucher for this conference as shown in Figure 2.\n\n_Figure 2: The document displays the Futurebuild 2020 theme after macros are enabled._\n\n\n-----\n\nIn both cases, the domain used to host the file was documentsharing[.]space. As per the\nWhois records of the domain, it was registered on October 21, 2019.\n\nThe next two instances of the documents from the same threat actor were observed in May\n2020.\n\nOn May 19, 2020, we found a malicious macro-based Word document hosted at the URL:\nhxxps://misrmarket[.]xyz/files/Get%20Stared.doc?clientEmail=\n\n**MD5 hash: 7bebf686b6e1d3fa537e8a0c2e5a4bdc**\n\n**File name: Get%20Stared.doc**\n\nThe content of this document was a message about a personal data revolution and included\na list of legitimate sites as shown in Figure 3.\n\n_Figure 3: The document displays a message about a personal data revolution._\n\n\n-----\n\nUpon further research, we found that this text was copied from a legitimate site,\ndatacoup.com, as shown in Figure 4. Attackers use such tactics for social engineering\npurposes to make the content of the file look relevant and legitimate.\n\n_Figure 4: The message displayed in the document was copied from datacoup.com._\n\nThe site that was used to host this document is a spoof of the popular site, anonfiles.com,\nwhich allows the users to upload their files anonymously. There is a slight difference\nbetween the user interface of this spoofed site and the original site.\n\nFigure 5 shows the user interface of the spoofed site.\n\n\n-----\n\n_Figure 5: The web user interface of the spoofed version of anonfiles.com._\n\nFigure 6 shows the user interface of the original site.\n\n\n-----\n\n_Figure 6: The original site, anonfiles.com, and the differences with the spoofed version._\n\nThe regions of the site marked in red were not present in the spoofed domain. As per Whois\ndata, the spoofed site, misrmarket[.]xyz, was registered on February 26, 2020.\n\nA common pattern we observed in all the URLs hosting the documents was: “?clientEmail=”\n\nThis parameter of the URL contained the email address of the targeted user.\n\n## Technical analysis of the macro\n\nWhen the macro-based document is opened, it will display a message that asks the user to\nenable macros to view the contents as shown in Figure 7.\n\n_Figure 7: The message displayed by the document, which asks the user to enable macros._\n\nWhen the macros are enabled, the Auto_Open() subroutine of the macro is called, which\nwill hide the above image and display the image corresponding to the theme of the\ndocument (5G Expo, Future Build 2020, and others) as described in previous section.\n\nThe relevant macro code section, which unhides the image after macros are enabled, is\nshown in Figure 8.\n\n\n-----\n\n_Figure 8: The macro code used to unhide the image._\n\nFor the purpose of analysis, we will take the file with MD5 hash:\n7bebf686b6e1d3fa537e8a0c2e5a4bdc\n\nThe contents of the macro are shown in Figure 9.\n\n_Figure 9: The macro code in the document._\n\nThe main functions performed by this macro code are:\n\nIt sets the working directory and the name of the dropped file to ServiceHostV1000.\nIt contains the complete C# code embedded inside the macro, which will be written at\nruntime to the file: ServiceHostV1000.cs in the working directory. The C# code is\nobfuscated at the source level. The obfuscation is simple. Only the variable, class and\nmethod names are obfuscated.\n\n\n-----\n\nIt sets the compiler directory to the location of the file, csc.exe, on the machine.\nCsc.exe is the command line compiler for C# code and is installed by default with\nMicrosoft .NET framework. The macro searches for versions 3.5 and 4.0.x on the\nmachine. It sets the compiler directory accordingly based on the version of .NET\nframework installed on the machine as shown in Figure 10.\n\n_Figure 10: The macro code used to compile C# code on the machine._\n\nIt compiles the code using csc.exe and the command line parameter:”-target:winexe out:”. The compiled binary will be present in the Startup directory.\nIt deletes the working directory that contained the source code.\nIt executes the compiled binary.\n\n## AppLocker bypass\n\nMSbuild.exe was used in this case to compile the code on the machine using a .csproj file\nas a method to bypass Windows security mechanisms, such as AppLocker and Device\n[Guard. This technique was made public for the first time by Casey Smith a few years ago.](https://twitter.com/subtee)\n\n## Analysis of .NET binary\n\n**MD5 hash: 4e0f9f47849949b14525c844005bb567**\n\n**File name: ServiceHostV1000.exe**\n\nThe main subroutine of the .NET binary is shown in Figure 11.\n\n\n-----\n\n_Figure 11: The main subroutine of .NET binary._\n\nBelow are the main operations performed by this .NET binary.\n\nIt sends an HTTP GET request to the URL: misrmarket[.]xyz/files/app-provider/getApp and\nsets the Content-type request header field to: “application/json”.\n\nFigure 12 shows the contents of the response from the server, which contains a JSON file.\n\n\n-----\n\n_Figure 12: The server response containing the JSON data._\n\nThis JSON file contains three keys:\n\n**Version: Set to null.**\n\n**csproj: Contains project file used by msbuild.exe at the time of compiling the C# project.**\n\n**cs: Contains the C# code that needs to be compiled at runtime.**\n\n1. The C# code used DataContractJsonSerializer class to parse the JSON response\n\nfrom the server and extract the individual members. The .cs and .csproj files were\ndropped in the location: %USERPROFILE%\\ServiceTaskV1001 with the file names,\nw.cs and w.csproj.\n2. For compiling the C# code, it uses msbuild.exe. The versions of .NET framework\n\nchecked on the machine to find msbuild.exe are version 3.5 and 4.0.x as shown in\nFigure 13.\n\n_Figure 13: Code section which checks version of .NET framework on the machine._\n\n\n-----\n\n## Analysis of .NET-based RAT\n\n**MD5 hash of the payload: 8f62d7499d5599b9db7eeddf9c01a061**\n\n**System information gathering**\n\nThe first activity performed by the payload is to gather information about the system as\nshown in Figure 14.\n\n_Figure 14: The code section used to gather system information._\n\nInformation about the following properties are collected from the machine:\n\nBot ID: A unique identifier for the machine. The calculation of this field is detailed later\nin this blog.\nCPU name: Processor details.\nRAM – The total amount of RAM installed on the machine.\nUser name\nHost name\nSystem drive name\nSystem directory path\nUptime\nOperating system type: This field is set to windows.\n\n**Calculation of unique bot ID: The payload first calculates a unique identifier for the**\nmachine which will be used to identify the bot. It calculates this ID using various properties\nof the machine as detailed below.\n\na = “SerialNumber” field from the output of WMI query: SELECT * FROM Win32_DiskDrive\n\nb = “Name” field from the output of WMI query: SELECT * FROM Win32_Processor\n\nc = “Manufacturer” and “SerialNumber” field from the output of WMI query: SELECT *\nFROM Win32_BaseBoard\n\nd = “Manufacturer” field from the output of WMI query: SELECT * FROM Win32_BIOS\n\n\n-----\n\nThe final ID is calculated by linking all the above values (a, b, c and d), then calculating the\nMD5 hash and using the first 12 characters of the resulting MD5 hash.\n\nThis can be represented as: MD5(a+b+c+d)[0:12]\n\nA unique integer value of 15 is appended to it to generate the final ID.\n\nOnce the above information is collected from the machine, it is sent to the server in an\nHTTP POST request as shown in Figure 15.\n\n_Figure 15: The code section used to register the bot with the Command and Control (C&C)_\n_server._\n\nThe request is sent to the URL: hxxp://theashyggdrasil[.]xyz/api/clients/identifyClient and\nthe Content-Type field is set to “application/json”. This first network request post-infection is\nused to register the bot with the attacker’s server with a unique identifier.\n\nThe network request is shown in Figure 16.\n\n\n-----\n\n_Figure 16: The system information sent to C&C server in an HTTP POST request._\n\n## C&C communication\n\nOnce the bot is registered with the server, it sends a GET request to the path:\n/api/orders/getOrders/<bot_id> to fetch the command that needs to be executed on the\nmachine. The response from the server will be in JSON format that will be parsed by the\nbot.\n\nThe subroutine that handles the C&C communication is shown in Figure 17.\n\n_Figure 17: The subroutine that handles the C&C communication_\n\n\n-----\n\nThere are four operations supported by the bot, which are described below.\n\n**cmdExec: This operation allows the attacker to execute code on the machine. By parsing**\nthe JSON response, a CmdReq structure is retrieved which has two members:\n\nshellId\n\ncommand\n\nThe subroutine for cmdExec operation is shown in Figure 18.\n\n_Figure 18: The subroutine that handles the cmdExec command._\n\nIf the command is equal to “***reset*shell***”, then a new instance of cmd.exe is spawned\non the machine as shown in Figure 19.\n\n\n-----\n\n_Figure 19: The subroutine used to spawn a new shell._\n\nFor any other command, the same shell will be used to execute.\n\n**getDir: This command can retrieve the complete list of all the files present in a specific path**\non the machine.\n\n\n-----\n\n_Figure 20: The subroutine that handles the getDir command._\n\nThis information will be exfiltrated to the server in an HTTP GET request to the path:\n/api/files/onGetDirRun\n\n**uploadFile: This command is used to upload a file from a given path on the machine to the**\nattacker’s server as shown in Figure 21.\n\n\n-----\n\n_Figure 21: The subroutine that handles the uploadFile C&C command._\n\nAwsInfoRes is a class with two members:\n\nuploadUrl\n\nfileKey\n\nThis information is retrieved from the server by sending an HTTP GET request to the\npath: /api/assets/getAwsUploadUrl\n\nFrom the JSON response, the uploadURL and fileKey values are extracted.\n\nThe file will be exfiltrated by sending an HTTP PUT request to the URL defined in the\nuploadURL member of the AwsInfoRes object.\n\n**getScreenshot: This command allows the attacker to remotely take screenshots of the**\nmachine as shown in Figure 22.\n\n\n-----\n\n_Figure 22: The subroutine that handles the getScreenshot command._\n\n## QuasarRAT code overlap\n\nThere is a small code section in this .NET binary that has a code overlap with the\nQuasarRAT. The overlap is only with the StringHelper class of the QuasarRAT.\n\nFigure 23 shows this section of code from the .NET binary.\n\n\n-----\n\n_Figure 23: The code section that has overlap with the QuasarRAT._\n\n[These functions are similar to the ones defined in the StringHelper class of QuasarRAT.](https://github.com/quasar/QuasarRAT/blob/3aed553e1aa8cb506dec96125d2fe2c9f6fd8dc2/Quasar.Common/Helpers/StringHelper.cs#L7)\nHowever, most of these functions are not called in the .NET binary in this case.\n\n## Cloud Sandbox detection\n\n[Figure 24 shows the Zscaler Cloud Sandbox successfully detecting this document-based](https://www.zscaler.com/products/sandboxing)\nthreat.\n\n_Figure 24: The Zscaler Cloud Sandbox detection._\n\nIn addition to sandbox detections, Zscaler’s multilayered cloud security platform detects\n[indicators at various levels, as seen here: Win32.RAT.ShellReset](https://threatlibrary.zscaler.com/?keyword=Win32.RAT.ShellReset)\n\n## Conclusion\n\nThis threat actor leverages themes relevant to current events, such as conferences and\nexhibitions, to spread malicious macro-based documents. Users should verify the source of\nsuch documents before opening them.\n\nAs an extra precaution, users should not enable macros for Microsoft Office files that are\nreceived from untrusted sources since these macros have the capability to run malicious\ncode on the machine.\n\nThe Zscaler ThreatLabZ team will continue to monitor this attack, as well as others, to help\nkeep our customers safe.\n\n\n-----\n\n## MITRE ATT&CK TTP Mapping\n\nTactic Technique\n\nT1064 Macros in document used for code execution.\n\nT1127 Uses MSBuild.exe to proxy execution of code through a trusted Windows\nUtility.\n\nT1060 Startup directory-based persistence.\n\nT1113 Takes screen captures of the desktop.\n\nTA0010 Data exfiltrated from the machine to the server.\n\nT1083 File and Directory discovery.\n\nT1059 Uses cmd.exe to execute commands remotely on the machine.\n\n## Indicators of Compromise (IOCs)\n\n**Hashes of the macro-based documents**\n\n93f913f3b9e0ef3f5cedd196eae3f2ae\n\nb34b74effbd8647c4f5dc61358e1555f\n\n7bebf686b6e1d3fa537e8a0c2e5a4bdc\n\n1d94b086996c99785f78bf484295027a\n\n**URLs hosting the documents**\n\nhxxps://documentsharing.space/files/5G%20Expo.doc?clientEmail=\n\nhxxps://documentsharing.space/files/FutureBuild.doc?clientEmail=\n\nhxxps://misrmarket.xyz/files/Get%20Stared.doc\n\nhxxps://consumerspost.xyz/files/Swissin-Voucher.doc\n\n**URLs used to download next stage**\n\nhxxps://misrmarket.xyz/files/app-provider/getApp\n\nhxxps://misrmarket.xyz/files/app-provider/getLatestVersion\n\nhxxps://centeralfiles.xyz/files/app-provider/getApp\n\n\n-----\n\nhxxps://centeralfiles.xyz/files/app-provider/ getLatestVersion\n\n**Post-infection domains**\n\ntheashyggdrasil.xyz\n\n**API endpoints used in post-infection domains**\n\n/api/cmd/onCmdRun\n\n/api/clients/identifyClient\n\n/api/assets/onCreated\n\n/api/assets/getAwsUploadUrl\n\n/api/files/onGetDirRun\n\n/api/orders/getOrders/\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-29 - ShellReset RAT Spread Through Macro-Based Documents Using AppLocker Bypass.pdf"
    ],
    "report_names": [
        "2020-05-29 - ShellReset RAT Spread Through Macro-Based Documents Using AppLocker Bypass.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536144,
    "ts_updated_at": 1743041370,
    "ts_creation_date": 1653766480,
    "ts_modification_date": 1653766480,
    "files": {
        "pdf": "https://archive.orkl.eu/4c999f68cd837513175ef261e5e01c4210321dc2.pdf",
        "text": "https://archive.orkl.eu/4c999f68cd837513175ef261e5e01c4210321dc2.txt",
        "img": "https://archive.orkl.eu/4c999f68cd837513175ef261e5e01c4210321dc2.jpg"
    }
}