{
    "id": "8240262d-48ec-4ba0-b934-a1a10dc62e94",
    "created_at": "2023-01-12T15:06:18.9501Z",
    "updated_at": "2025-03-27T02:11:06.253607Z",
    "deleted_at": null,
    "sha1_hash": "3c1ac5b8f4e2b1147d8b51ab26f35d24c1fbce2f",
    "title": "2021-10-11 - Iran-linked DEV-0343 targeting defense, GIS, and maritime sectors",
    "authors": "",
    "file_creation_date": "2022-05-28T16:15:05Z",
    "file_modification_date": "2022-05-28T16:15:05Z",
    "file_size": 366467,
    "plain_text": "# Iran-linked DEV-0343 targeting defense, GIS, and maritime sectors\n\n**[microsoft.com/security/blog/2021/10/11/iran-linked-dev-0343-targeting-defense-gis-and-maritime-sectors/](https://www.microsoft.com/security/blog/2021/10/11/iran-linked-dev-0343-targeting-defense-gis-and-maritime-sectors/)**\n\nOctober 11, 2021\n\n#### DEV-0343 is a new activity cluster that the Microsoft Threat Intelligence Center (MSTIC) first observed and began tracking in late July 2021. MSTIC has observed DEV-0343 conducting extensive password spraying against more than 250 Office 365 tenants, with a focus on US and Israeli defense technology companies, Persian Gulf ports of entry, or global maritime transportation companies with business presence in the Middle East. Less than 20 of the targeted tenants were successfully compromised, but DEV-0343 continues to evolve their techniques to refine its attacks. MSTIC noted that Office 365 accounts with multifactor authentication (MFA) enabled are resilient against password sprays.\n\n Microsoft uses DEV-#### designations as a temporary name given to an unknown, emerging, or a developing cluster of threat activity, allowing MSTIC to track it as a unique set of information until they can reach high confidence about the origin or identity of the actor behind the operation. Once it meets the criteria, a DEV is converted to a named actor. As with any observed nation state actor activity, Microsoft has directly notified customers that have been targeted or compromised, providing them with the information they need to secure their accounts.\n\n\n-----\n\n#### Targeting in this DEV-0343 activity has been observed across defense companies that support United States, European Union, and Israeli government partners producing military- grade radars, drone technology, satellite systems, and emergency response communication systems. Further activity has targeted customers in geographic information systems (GIS), spatial analytics, regional ports of entry in the Persian Gulf, and several maritime and cargo transportation companies with a business focus in the Middle East.\n\n This activity likely supports the national interests of the Islamic Republic of Iran based on pattern-of-life analysis, extensive crossover in geographic and sectoral targeting with Iranian actors, and alignment of techniques and targets with another actor originating in Iran. Microsoft assesses this targeting supports Iranian government tracking of adversary security services and maritime shipping in the Middle East to enhance their contingency plans. Gaining access to commercial satellite imagery and proprietary shipping plans and logs could help Iran compensate for its developing satellite program. Given Iran’s past cyber and military attacks against shipping and maritime targets, Microsoft believes this activity increases the risk to companies in these sectors, and we encourage our customers in these industries and geographic regions to review the information shared in this blog to defend themselves from this threat.\n\n DEV-0343 conducts extensive password sprays emulating a Firefox browser and using IPs hosted on a Tor proxy network. They are most active between Sunday and Thursday between 7:30 AM and 8:30 PM Iran Time (04:00:00 and 17:00:00 UTC) with significant drop- offs in activity before 7:30 AM and after 8:30 PM Iran Time. They typically target dozens to hundreds of accounts within an organization, depending on the size, and enumerate each account from dozens to thousands of times. On average, between 150 and 1,000+ unique Tor proxy IP addresses are used in attacks against each organization.\n\n DEV-0343 operators typically target two Exchange endpoints – Autodiscover and ActiveSync – as a feature of the enumeration/password spray tool they use. This allows DEV-0343 to validate active accounts and passwords, and further refine their password spray activity.\n\n## Observed behaviors\n\n#### DEV-0343 uses an elaborate series of Tor IP addresses to obfuscate their operational infrastructure. Because of this, there are no static set of indicators of compromise (IOCs) for us to share tied to this activity. The list below provides a series of behaviors and tactics we have observed being used by the attackers. We encourage our customers to use this information to look for similar patterns in logs and network activity to identify areas for further investigation.\n\n Extensive inbound traffic from Tor IP addresses for password spray campaigns Emulation of FireFox (most common) or Chrome browsers in password spray campaigns Enumeration of Exchange ActiveSync (most common) or Autodiscover endpoints\n\n\n-----\n\n#### Use of enumeration/password spray tool similar to the o365spray tool hosted at https://github.com/0xZDH/o365spray Use of Autodiscover to validate accounts and passwords Observed password spray activity commonly peaking between 04:00:00 and 11:00:00 UTC\n\n## Recommended defenses\n\n#### The following guidance can mitigate the techniques described in the threat activity:\n\n Enable multifactor authentication to mitigate compromised credentials.\n For Office 365 users, see multifactor authentication support. For Consumer and Personal email accounts, see how to use two step verification. Microsoft strongly encourages all customers to download and use passwordless solutions like Microsoft Authenticator to secure accounts. Review and enforce recommended Exchange Online access policies.\n Block ActiveSync clients from bypassing Conditional Access policies. Block all incoming traffic from anonymizing services where possible.\n\n## Advanced hunting queries\n\n### Microsoft 365 Defender\n\n#### To locate related activity, run the following advanced hunting queries in Microsoft 365 Defender:\n```\nAlertInfo\n| where Title in~('Unusual sequence of failed logons to Exchange services',\n'Unusual sequence of failed logons',\n'Password spraying')\n| join AlertEvidence on AlertId\n\n### Azure Sentinel\n\n#### Azure Sentinel customers can use the following detection queries to look for this activity:\n\n The query below identifies evidence of password sprays activity where ClientAppUsed is either Exchange ActiveSync or Autodiscover and emulated browser is Chrome or Firefox. The query is leveraging Azure AD data to look for failures from multiple accounts from the same IP address within a time window. Details on whether there were successful authentications by the IP address within the time window are also included. This can be an indicator that an attack was successful. The default failure account threshold is 5 and the default time window for failures is 20m.\n\n```\n\n-----\n\n```\nlet timeRange = 3d;\nlet lookBack = 7d;\nlet authenticationWindow = 20m;\nlet authenticationThreshold = 5;\nlet isGUID = \"[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}\";\nlet failureCodes = dynamic([50053, 50126]); // invalid password, account is\nlocked - too many sign ins, expired password\nlet successCodes = dynamic([0, 50055, 50057, 50155, 50105, 50133, 50005,\n50076, 50079, 50173, 50158, 50072, 50074, 53003, 53000, 53001, 50129]);\nlet ClientApps = dynamic([\"AutoDiscover\",\"Exchange ActiveSync\"]);\nlet BrowserList = dynamic([\"Chrome\",\"Firefox \"]);\n// Lookup up resolved identities from last 7 days\nlet aadFunc = (tableName:string){\nlet identityLookup = table(tableName)\n| where TimeGenerated >= ago(lookBack)\n| where not(Identity matches regex isGUID)\n| where isnotempty(UserId)\n| summarize by UserId, lu_UserDisplayName = UserDisplayName,\nlu_UserPrincipalName = UserPrincipalName, Type;\n// collect window threshold breaches\ntable(tableName)\n| where TimeGenerated > ago(timeRange)\n| where ResultType in(failureCodes)\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated),\nmake_set(ClientAppUsed), count() by bin(TimeGenerated,\nauthenticationWindow), IPAddress, AppDisplayName, UserPrincipalName, Type\n| summarize FailedPrincipalCount = dcount(UserPrincipalName) by\nbin(TimeGenerated, authenticationWindow), IPAddress, AppDisplayName, Type\n| where FailedPrincipalCount >= authenticationThreshold\n| summarize WindowThresholdBreaches = count() by IPAddress, Type\n| join kind= inner (\n// where we breached a threshold, join the details back on all failure data\ntable(tableName)\n| where TimeGenerated > ago(timeRange)\n| where ResultType in(failureCodes)\n| extend LocationDetails = todynamic(LocationDetails)\n| extend FullLocation = strcat(LocationDetails.countryOrRegion,'|',\nLocationDetails.state, '|', LocationDetails.city)\n| extend DeviceDetail = todynamic(DeviceDetail)\n| extend Browser = DeviceDetail.browser\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated),\nmake_set(ClientAppUsed), make_set(FullLocation), make_set(Browser),\nFailureCount = count() by IPAddress, AppDisplayName, UserPrincipalName,\nUserDisplayName, Identity, UserId, Type\n// lookup any unresolved identities\n| extend UnresolvedUserId = iff(Identity matches regex isGUID, UserId, \"\")\n| join kind= leftouter (\n\n```\n\n-----\n\n```\nidentityLookup\n) on $left.UnresolvedUserId==$right.UserId\n| extend UserDisplayName=iff(isempty(lu_UserDisplayName), UserDisplayName,\nlu_UserDisplayName)\n| extend UserPrincipalName=iff(isempty(lu_UserPrincipalName),\nUserPrincipalName, lu_UserPrincipalName)\n| summarize StartTime = min(StartTime), EndTime = max(EndTime),\nmake_set(UserPrincipalName), make_set(UserDisplayName),\nmake_set(set_ClientAppUsed), make_set(set_Browser),\nmake_set(set_FullLocation), make_list(FailureCount) by IPAddress,\nAppDisplayName, Type\n| extend FailedPrincipalCount = arraylength(set_UserPrincipalName)\n) on IPAddress\n| project IPAddress, StartTime, EndTime, TargetedApplication=AppDisplayName,\nFailedPrincipalCount, UserPrincipalNames=set_UserPrincipalName,\nUserDisplayNames=set_UserDisplayName, ClientAppUsed=set_set_ClientAppUsed,\nLocations=set_set_FullLocation, FailureCountByPrincipal=list_FailureCount,\nWindowThresholdBreaches, Type, Browsers = set_set_Browser\n| join kind= inner (\ntable(tableName) // get data on success vs. failure history for each IP\n| where TimeGenerated > ago(timeRange)\n| where ResultType in(successCodes) or ResultType in(failureCodes) //\nsuccess or failure types\n| summarize GlobalSuccessPrincipalCount = dcountif(UserPrincipalName,\n(ResultType in(successCodes))), ResultTypeSuccesses =\nmake_set_if(ResultType, (ResultType in(successCodes))),\nGlobalFailPrincipalCount = dcountif(UserPrincipalName, (ResultType\nin(failureCodes))), ResultTypeFailures = make_set_if(ResultType, (ResultType\nin(failureCodes))) by IPAddress, Type\n| where GlobalFailPrincipalCount > GlobalSuccessPrincipalCount // where the\nnumber of failed principals is greater than success - eliminates FPs from\nIPs who authenticate successfully alot and as a side effect have alot of\nfailures\n) on IPAddress\n| project-away IPAddress1\n| extend timestamp=StartTime, IPCustomEntity = IPAddress\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n| where Browsers has_any (BrowserList)\n| where ClientAppUsed has_any (ClientApps)\n\n#### One of the results that the query surfaces is the IPAddress field from where the sign-in originated. Customers can leverage their threat intel data that have details about the TOR exit nodes to join with this query and make it even higher fidelity. It is often worthwhile to have a list of all the known TOR exit nodes so that these could be used for matching with\n\n```\n\n-----\n\n#### queries of Azure Sentinel, or to block sign-ins from the TOR exit nodes using conditional access. Azure Sentinel also provides playbooks that can leverage third party providers of TOR information like Big Data Cloud to synchronize the list of known TOR exit nodes on an hourly basis. Here is the link to one such playbook: https://github.com/Azure/Azure- Sentinel/blob/master/Playbooks/Update-NamedLocations-TOR/readme.md.\n\n Next, we have another hunting query that identifies instances where a single user account has seen a high incidence of failed attempts from highly volatile IP addresses. Changing the IP address for every password attempt is becoming a more common technique among sophisticated threat groups. Often, threat groups randomize the user agent they are using as well as IP address. This technique has been enabled by the emergence of services providing huge numbers of residential IP addresses. These services are often enabled through malicious browser plugins. This query is best executed over longer timeframes. Results with the highest “IPs”, “Failures” and “DaysWithAttempts” are good candidates for further investigation. This query intentionally does not cluster on UserAgent, IP, etc. This query is clustering on the highly volatile IP behavior.\n```\nlet timeRange = 14d;\nlet UnsuccessfulLoginCountryThreshold = 5; // Number of failed countries\nattempting to login, good way to filter.\nlet ClientApps = dynamic([\"AutoDiscover\",\"Exchange ActiveSync\"]);\nlet BrowserList = dynamic([\"Chrome\",\"Firefox \"]);\nSigninLogs\n| where TimeGenerated > ago(timeRange)\n// Limit to username/password failure errors, most common when\nbruteforcing/spraying\n| where ResultType has_any(\"50126\", \"50053\")\n//Narrowing the result even further to clientapps and browser that are seen\nin this attack.\n| where ClientAppUsed has_any (ClientApps)\n| extend Browser = tostring(DeviceDetail.browser)\n| where Browser has_any (BrowserList)\n// Find instances where an IP has only been used once\n| summarize IPLogins=count(), make_list(TimeGenerated) by IPAddress,\nLocation, UserPrincipalName\n| where IPLogins == 1\n// We only keep instances where there is 1 event, so we know there will only\nbe one datetime in the list\n| extend LoginAttemptTime =\nformat_datetime(todatetime(list_TimeGenerated[0]), 'dd-MM-yyyy')\n// So far we've only collected failures, we join back to the log to ensure\nthere were no successful logins from the IP\n| join kind=leftouter (\nSigninLogs\n| where TimeGenerated > ago(timeRange)\n| where ResultType == 0\n\n```\n\n-----\n\n```\n| summarize count() by IPAddress, UserPrincipalNameSuccess=UserPrincipalName\n) on $left.IPAddress == $right.IPAddress\n// Where there have been fewer than 2 successful logins from the IP\n| where count_ < 2 or isempty(count_)\n// Confirm that the result is for the same account where possible\n| where UserPrincipalName == UserPrincipalNameSuccess or\nisempty(UserPrincipalNameSuccess)\n// Summarize the collected details around the users email address\n| summarize IPs=dcount(IPAddress),\nUnsuccessfulLoginCountryCount=dcount(Location), make_list(IPAddress),\nmake_list(Location), DaysWithAttempts=dcount(LoginAttemptTime),\nFailures=count() by UserPrincipalName\n| project UserPrincipalName, Failures, IPs, UnsuccessfulLoginCountryCount,\nDaysWithAttempts, IPAddresses=list_IPAddress,\nIPAddressLocations=list_Location\n// Join back to get countries the user has successfully authenticated from\nto compare with failures\n| join kind=leftouter (\nSigninLogs\n| where TimeGenerated > ago(timeRange)\n| where ResultType == 0\n// If there is no location make the output pretty\n| extend Location = iff(isempty(Location), \"NODATA\", Location)\n| summarize SuccessfulLoginCountries=make_set(Location),\nSuccessfulLoginCountryCount=dcount(Location) by UserPrincipalName\n) on $left.UserPrincipalName == $right.UserPrincipalName\n| project-away UserPrincipalName1\n| order by UnsuccessfulLoginCountryCount desc\n// Calculate the difference between countries with successful vs. failed\nlogins\n| extend IPIncreaseOnSuccess = UnsuccessfulLoginCountryCount SuccessfulLoginCountryCount\n// The below line can be removed if the actor is using IPs in one country\n| where UnsuccessfulLoginCountryCount > UnsuccessfulLoginCountryThreshold\n| project UserPrincipalName, Failures, IPs, DaysWithAttempts,\nUnsuccessfulLoginCountryCount, UnuccessfulLoginCountries=IPAddressLocations,\nSuccessfulLoginCountries, FailureIPAddresses=IPAddresses\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-10-11 - Iran-linked DEV-0343 targeting defense, GIS, and maritime sectors.pdf"
    ],
    "report_names": [
        "2021-10-11 - Iran-linked DEV-0343 targeting defense, GIS, and maritime sectors.pdf"
    ],
    "threat_actors": [
        {
            "id": "faa4a29b-254a-45bd-b412-9a1cbddbd5e3",
            "created_at": "2022-10-25T16:07:23.80111Z",
            "updated_at": "2025-03-27T02:02:09.985067Z",
            "deleted_at": null,
            "main_name": "LookBack",
            "aliases": [
                "FlowingFrog",
                "LookBack",
                "LookingFrog",
                "TA410",
                "Witchetty"
            ],
            "source_name": "ETDA:LookBack",
            "tools": [
                "FlowCloud",
                "GUP Proxy Tool",
                "SodomMain",
                "SodomMain RAT",
                "SodomNormal"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "c4cd33a4-3ec0-4a21-b20f-99d3b7cc6525",
            "created_at": "2024-01-09T02:00:04.205662Z",
            "updated_at": "2025-03-27T02:00:03.280398Z",
            "deleted_at": null,
            "main_name": "Gray Sandstorm",
            "aliases": [
                "DEV-0343"
            ],
            "source_name": "MISPGALAXY:Gray Sandstorm",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535978,
    "ts_updated_at": 1743041466,
    "ts_creation_date": 1653754505,
    "ts_modification_date": 1653754505,
    "files": {
        "pdf": "https://archive.orkl.eu/3c1ac5b8f4e2b1147d8b51ab26f35d24c1fbce2f.pdf",
        "text": "https://archive.orkl.eu/3c1ac5b8f4e2b1147d8b51ab26f35d24c1fbce2f.txt",
        "img": "https://archive.orkl.eu/3c1ac5b8f4e2b1147d8b51ab26f35d24c1fbce2f.jpg"
    }
}