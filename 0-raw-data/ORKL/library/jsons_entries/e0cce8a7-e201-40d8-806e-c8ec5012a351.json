{
    "id": "e0cce8a7-e201-40d8-806e-c8ec5012a351",
    "created_at": "2023-01-12T15:05:53.181724Z",
    "updated_at": "2025-03-27T02:05:56.950308Z",
    "deleted_at": null,
    "sha1_hash": "84120fe11bebec646e7e3b88789620819530f77a",
    "title": "2017-08-29 - Inside the Kronos malware – part 2",
    "authors": "",
    "file_creation_date": "2022-05-28T04:56:52Z",
    "file_modification_date": "2022-05-28T04:56:52Z",
    "file_size": 954814,
    "plain_text": "# Inside the Kronos malware – part 2\n\n**[blog.malwarebytes.com/cybercrime/2017/08/inside-kronos-malware-p2/](https://blog.malwarebytes.com/cybercrime/2017/08/inside-kronos-malware-p2/)**\n\nMalwarebytes Labs August 29, 2017\n\nIn the [previous part of the Kronos analysis, we took a look at the installation process of](https://blog.malwarebytes.com/cybercrime/2017/08/inside-kronos-malware/)\nKronos and explained the technical details of the tricks that this malware uses in order to\nremain more stealthy. Now we will move on to look at the malicious actions that Kronos can\nperform.\n\n## Analyzed samples\n\n_[Special thanks to @shotgunner101 and](https://twitter.com/shotgunner101)_ _[@chrisdoman for sharing the samples.](https://twitter.com/chrisdoman)_\n\n## Configuration and targets\n\nKronos is known as a banking Trojan. For the purpose of enabling and configuring this\nfeature, the bot may download from its CnC additional configuration file. After being fetched,\nit is stored in the installation folder in encrypted form. (It is worth to notice that when the\nconfig is sent over the network it is encrypted using AES CBC mode – but when it is stored\non the disk, AES in ECB mode is used.)\n\nBelow you can see an example of the installation folder of Kronos, created in\n```\n%APPDATA%/Microsoft . The folder name is further used as a BotId . Both stored files, the\n\n```\nexecutable and the configuration, has the same name that differs only by the extension:\n\n\n-----\n\nHere you can see the captured configuration file in a decrypted form:\n\n[https://gist.github.com/malwarezone/d6de3d53395849123596f5d9e68fe3a3#file-config-txt](https://gist.github.com/malwarezone/d6de3d53395849123596f5d9e68fe3a3#file-config-txt)\n\nThe format of the configuration follows the standard defined by the famous Zeus malware.\n\nThe config specifies the external script that is going to be injected in the targeted website, as\nwell as the place of the injection. Below you can see a fragment of the configuration for a\nsample target – Wells Fargo Bank:\n\n[In the given example, the injected script is figrabber.js](https://gist.github.com/malwarezone/d6de3d53395849123596f5d9e68fe3a3#file-figrabber-js)\n\nIt is hosted on the server of the attacker:\n\n\n-----\n\nIndeed, if we open the websites that are targeted by the malware we can see that the injects\nhas been performed. The fragments of code that were defined in the config are implanted in\nthe source of a legitimate website. Some examples included below:\n\nFacebook:\n\nCitibank:\n\n\n-----\n\nThe injected scripts are responsible for opening additional pop-up that is trying to phish the\nuser and steal his/her personal data:\n\nWells Fargo:\n\n\n-----\n\nMore cases, and their comparison with a normal site behavior before the infection,\ndemonstrated on the video:\n\n\n-----\n\nWatch Video At:\n\nhttps://youtu.be/HrKL8Hdx6Ks\n\nThe form is customized to fit the theme of each page. However, its content is the same for\neach target. Overall, the attack is not very sophisticated and it will probably look suspicious\nto the more advanced users. It’s based purely on social engineering – trying to convince a\nuser to input all personal data that are necessary for banking operations:\n\n\n-----\n\n## Downloader\n\nApart from infecting browsers and stealing the data, Kronos also has a downloader feature.\nDuring our tests, it downloaded a new executable and saved it in the `%TEMP% . Payloads are`\nstored in the additional directory with the same name as the main installation directory:\n\n\n-----\n\nDownloaded payload:\n\n[6f7f79dd2a2bf58ba08d03c64ead5ced – nCBngA.exe](https://virustotal.com/#/file/e675aac1fbb288eb16c1646a288eb8fe3e2c842f03db772f924b0d7c6b122f15/)\n\nThe payload is downloaded from Kronos CnC:\n\n…in unencrypted form:\n\n\n-----\n\nIn the analyzed case, downloaded payload was just an update of the Kronos bot. However,\nthe same feature may also be used for fetching and deploying other malware families.\n\n## Command and Controll (CnC) server\n\n[In the analyzed case, Kronos used Fast-Flux technique for its CnC. The domain was](https://en.wikipedia.org/wiki/Fast_flux)\nresolved to a different IP each time. For example, the domain `hjbkjbhkjhbkjhl.info was`\nresolved to an IP address randomly picked from the pool given below:\n```\n46.175.146.50\n46.172.209.210\n47.188.161.114\n74.109.250.65\n77.122.51.88\n77.122.51.88\n89.25.31.94\n89.185.15.235\n91.196.93.112\n176.32.5.207\n188.25.234.208\n109.121.227.191\n\n```\nWatching the communication with the CnC, we observed queries to the site `connect.php,`\nwith an optional parameter `a :`\n```\nconnect.php - initial beacon\nconnect.php?a=0 - sending data to the CnC\nconnect.php?a=1 - downloading the configuration form the Cnc\n\n## CnC panel\n\n```\n\n-----\n\nThanks to the code of the CnC panel that leaked online, we can have more insights on all the\nfunctionalities and their implementation. Like most of the malware panels, the Kronos panel\nis written in PHP and uses MySQL database. Overview of the files:\n\nIt turns out, that in total the bot has three commands:\n```\n   a=0 – sends the grabbed page content\n   a=1 – fetch the configuration file\n   a=2 – send the logged windows\n\n```\nBelow we can see the relevant fragments of the panel’s code (implemented inside\n```\nconnect.php ), responsible for parsing and storing the data uploaded by the respective\n\n```\ncommands.\n\n\n-----\n\nCommand #0 ( a=0 ):\n\nCommand #2 ( a=2 ):\n\nThe configuration that is sent to the bot is prepared by the following code:\n\nCommand #1 ( a=1 ):\n\n\n-----\n\nWe can also see very clearly how the config is encrypted – using AES in CBC mode, where\nthe key is first 16 bytes of md5 of the BotId (it confirms what researchers form Lexsi lab\nfound by reverse engineering).\n\nHowever, AES is not the only cryptographic algorithm that is utilized by Kronos. Other\ncommands use BlowFish in ECB mode:\n\nCommand #0 ( a=0 ):\n\nCommand #2 ( a=2 ):\n\nIn all cases, there is a variable called `UniqueId that is used as a key. The` `UniqueId is`\nnothing more but the `BotId, that is sent in every POST request in XOR encoded form.`\n\n\n-----\n\nYou can find the corresponding Python scripts for decoding the appropriate requests and\nresponses here:\n\n[https://github.com/hasherezade/malware_analysis/tree/master/kronos](https://github.com/hasherezade/malware_analysis/tree/master/kronos)\n\nKronos comes also with option of adding some plugins, extending the core functionality:\n\nAs we may conclude, the plugins are capable of extending Kronos with some espionage\ncapabilities, such as VNC (for viewing the desktop) and logging typed keystrokes.\n\n## Decrypting the communication\n\n[With the help of prepared scripts (available here), we can decrypt the important elements of](https://github.com/hasherezade/malware_analysis/tree/master/kronos)\nthe communication between the Kronos bot and the CnC server. Let’s assume that we have\na PCAP file with a captured traffic.\n\n**The BotId**\n\nWe need to start from getting the Kronos `BotId, because as we know it will be used to`\nderive the encryption keys. We will find it in the requests sent by the bot to its CnC (74 bytes\nlong):\n\n\n-----\n\nAfter dumping the request, we can use the following script to decode it:\n```\n./kronos_beacon_decoder.py --infile dump1.bin\n\n```\nAs the output we will get the decoded beacon, consisting of:\n\n1. Hash of the configuration file (if no configuration file was present at the moment, this\n\npart will be filled with “X” characters)\n2. The BotId\n\nExample:\n```\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX{117BB161-6479-4624-858B-4D2CE81593A2}\n\n```\nSo, in the demonstrated case the BotId is `{117BB161-6479-4624-858B-4D2CE81593A2} .`\n\n**The configuration**\n\nHaving the BotId, we can move to decrypt the configuration. It arrives in the response to the\n```\na=1 request:\n\n```\nExample of the request followed by the encrypted response from the CnC:\n\n\n-----\n\nAfter dumping the response, we can use another script to decode it, giving the BotId as a\nparameter:\n```\n./kronos_a1_decoder.py --datafile dump2.bin --botid {117BB161-6479-4624-858B4D2CE81593A2}\n\n```\nAs a result, we will get the configuration file. Example of the decoded config:\n\n[https://gist.github.com/malwarezone/a7fc13d4142da0c6a67b5e575156c720#file-config-txt](https://gist.github.com/malwarezone/a7fc13d4142da0c6a67b5e575156c720#file-config-txt)\n\n**The sent reports**\n\nSometimes we can find the Kronos bot reporting to the CnC in requests a=0 or a=2:\n\nExample of the encrypted request:\n\n\n-----\n\nFinding out what was exactly the data stolen by Kronos is not difficult if we dump the data\nand use the dedicated script:\n```\n./kronos_a02_decoder.py --datafile dump3.bin --botid {117BB161-6479-4624-858B4D2CE81593A2}\n\n```\nExample of the decoded report:\n\n[https://gist.github.com/malwarezone/a03fa49de475dfbdb7c499ff2bbb3314#file-a0_req-txt](https://gist.github.com/malwarezone/a03fa49de475dfbdb7c499ff2bbb3314#file-a0_req-txt)\n\n## Conclusion\n\nIn terms of code quality, Kronos is written in a decent way, however its features are nothing\n[novel. Although the bot got good reviews on underground forums, in terms of popularity it](https://blog.sensecy.com/2014/07/15/two-new-banking-trojans-offered-for-sale-on-the-russian-underground/)\nwas always legging behind. Probably its relatively high price was the important factor\ndeciding why it lost with the competitors.\n\n## Appendix\n\nSee also:\n\n[Inside the Kronos malware – part 1](https://blog.malwarebytes.com/cybercrime/2017/08/inside-kronos-malware/)\n\nThis video cannot be displayed because your Functional Cookies are currently disabled.\n[To enable them, please visit our privacy policy and search for the Cookies section. Select](https://www.malwarebytes.com/privacy/#how-we-collect-information)\n_“Click Here” to open the Privacy Preference Center and select “Functional Cookies” in the_\nmenu. You can switch the tab back to “Active” or disable by moving the tab to “Inactive.”\nClick “Save Settings.”\n\n_This was a guest post written by Hasherezade, an independent researcher and programmer_\n_with a strong interest in InfoSec. She loves going in details about malware and sharing threat_\n_[information with the community. Check her out on Twitter @hasherezade and her personal](https://twitter.com/hasherezade)_\n_[blog: https://hshrzd wordpress com](https://hshrzd.wordpress.com/)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-08-29 - Inside the Kronos malware – part 2.pdf"
    ],
    "report_names": [
        "2017-08-29 - Inside the Kronos malware – part 2.pdf"
    ],
    "threat_actors": [
        {
            "id": "56daf304-dd2c-4fa1-a01f-8c0a7e5e5c30",
            "created_at": "2022-10-25T16:07:23.586985Z",
            "updated_at": "2025-03-27T02:02:09.876755Z",
            "deleted_at": null,
            "main_name": "EmpireMonkey",
            "aliases": [
                "Anthropoid Spider",
                "CobaltGoblin",
                "EmpireMonkey"
            ],
            "source_name": "ETDA:EmpireMonkey",
            "tools": [
                "AKO Doxware",
                "AKO Ransomware",
                "MedusaLocker",
                "MedusaReborn"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535953,
    "ts_updated_at": 1743041156,
    "ts_creation_date": 1653713812,
    "ts_modification_date": 1653713812,
    "files": {
        "pdf": "https://archive.orkl.eu/84120fe11bebec646e7e3b88789620819530f77a.pdf",
        "text": "https://archive.orkl.eu/84120fe11bebec646e7e3b88789620819530f77a.txt",
        "img": "https://archive.orkl.eu/84120fe11bebec646e7e3b88789620819530f77a.jpg"
    }
}