{
    "id": "7e1d9d30-9e89-48bb-8c90-f290740a0b55",
    "created_at": "2023-01-12T15:08:31.979203Z",
    "updated_at": "2025-03-27T02:05:37.630163Z",
    "deleted_at": null,
    "sha1_hash": "b022d3b692cd06291e485752d5b8ca56d9651dbf",
    "title": "2021-08-06 - Inside DarkSide, the ransomware that attacked Colonial Pipeline",
    "authors": "",
    "file_creation_date": "2022-05-28T01:55:56Z",
    "file_modification_date": "2022-05-28T01:55:56Z",
    "file_size": 4754071,
    "plain_text": "# Inside DarkSide, the ransomware that attacked Colonial Pipeline\n\n**metabaseq.com/recursos/inside-darkside-the-ransomware-that-attacked-colonial-pipeline**\n\n## Executive Summary\n\nOn May 7th, 2021, Colonial Pipeline reported that its digital infrastructure had been compromised due to a cyberattack, and as a precautionary\nmeasure, it would suspend its services until the severity of the situation was determined.\n\nColonial is the largest pipeline operator in the U.S. and transports more than 3 million barrels of gasoline, diesel, and jet fuel between the U.S.\nGulf Coast and the New York Harbor area.\n\nThis cyberattack utilized ransomware which encrypted critical information systems and requested payment to recover the information.\n\nResearchers have allegedly attributed this attack to the DarkSide group, whose modus operandi known as Ransomware-as-a-Service (RaaS),\ninvolves not only the encryption of information with Salsa20, using an RSA-1024 public key, but also the exfiltration of information used for\npayment negotiation.\n\n\n-----\n\na S de as a ected u e ous o ga at o s a ous secto s, c ud g dust y, ega, su a ce, ea t ca e, a d e e gy o e e,\naccording to a January 27th, 2021 publication on DarkSide’s website about its rules of use, affiliated individuals cannot target the funeral\nservice sector, hospitals, nursing homes, or companies distributing the COVID-19 vaccine.\n\nTo pay the demands, the organization promotes the use of Monero, a cryptocurrency distinguished by its anonymity and superior security\ncompared to other currencies in the market. DarkSide members use an administrative panel via The Onion Router (TOR) to communicate with\nvictims and manage the delivery of the ransomware to its victims.\n\nGovernment entities have already identified this specific version of the ransomware, and you can find the Indicators of Compromise (IOC) at\nthe end of the blog.\n\nColonial has already faced a series of extortions so that the stolen information is not published, and it is presumed that the payment has\n[already been made for an amount close to $5 million USD, reported zdnet. According to researcher Brian Krebs, the group’s servers have](https://www.zdnet.com/article/colonial-pipeline-paid-close-to-5-million-in-ransomware-blackmail-payment/)\nalready been seized, as well as one of the cryptocurrency accounts used to pay its affiliates.\n\nIn this blog, we analyze in detail one of the DarkSide samples used during the attack, providing TTPs (Tactics, Techniques, and Procedures)\nand IOCs (Indicators of Compromise) that serve for monitoring, detection, and eradication strategies of this type of cyberthreats.\n\n## Main findings\n\nDarkSide and SODINOKIBI (REvil),although not identical, share the same modus operandi.\n[DarkSide does not attack computers with the language of some of the countries formerly known as the Republics of the Soviet Union.](https://en.wikipedia.org/wiki/Republics_of_the_Soviet_Union)\nDarkSide’s infrastructure is hosted with a Russian provider.\nEncryption is very fast due toa one-thread-per-processor implementation.\nIt encrypts files on hard disks, removable drives, and network drives.\n\n## Initial infection\n\nMalicious actors use techniques such as spear-phishing with malicious links to try to infect their victims. In turn, they obtain legitimate\ncredentials through SQL Injection attacks by accessing credentials stored in databases or even in different places on the dark web where\ncompromised credentials of organizations are listed. According to Mandiant, in the case of Colonial, the attackers used valid VPN credentials\nof an employee who did not have multi-factor authentication enabled, and remote access was achieved without restrictions.\n\n## DarkSide’s ransomware behavior\n\nOnce it has been possible to access a computer of the attacked organization, some versions occupy a Dropper, where their job is to decrypt\nDarkSide in memory (in some cases with a simple XOR) and execute it.\n\n**DarkSide:**\n\nType: Win32 Binary - Delphi\n\nMD5: 222792d2e75782516d653d5cccfcf33b\n\nName(s): net.bin, Darkside.exe\n\nCompilation Timestamp: Dec 15, 2020 22:26:41\n\nFirst time viewed: Dec 29, 2020 18:22:15\n\nFirst time analyzed: Dec 28, 06:37:28\n\nLast time analyzed: May 14, 2021 00:06:50\n\nCountry of first entry in VT: India\n\n## General malware scheme\n\nThe following diagram shows a general outline of the ransomware execution flow:\n\n\n-----\n\n-----\n\n## Configuration loaded into memory\n\nThe entire malware configuration is loaded (and compressed) in the .data section in memory with a length of 2745 bytes.\n\nWhen the decompression algorithm is applied, 159040 bytes are obtained with a table containing the global configuration of the ransomware\n(See Figure 4):\n\nWhitelist files\nWhitelist extensions\nFast encryption files (these files are encrypted with a faster encryption algorithm due to their larger size)\n\nName of processes to stop:\n\nvmcompute.exe\nvmms.exe\nvmwp.exe\nsvchost.exe\nTeamViewer.exe\nexplorer.exe\n\nName of services to stop: Many of them ensure that the document is not being occupied and can then be encrypted: sql, oracle, ocssd,\n**dbsnmp, synctime, agntsvc, isqlplussvc, xfssvccon, mydesktopservice, ocautoupds, encsvc, firefox, tbirdconfig,**\n**mydesktopqos, ocomm, dbeng50, sqbcoreservice, excel, infopath, msaccess, mspub, onenote, outlook, powerpnt, steam,**\n**thebat, thunderbird, visio, winword, wordpad, notepad**\nName of the server where the stolen data will be sent to\nThe message written on the screen background\nRansom message leaving infected directories (with an embedded key\n\nFigure 1: Darkside configurations loaded into memory\n\n## List of whitelisted countries and languages\n\nThe ransomware makes a call to GetSystemDefaultUILanguage, which returns a Language Code Identifier (LCID) of the system and also\nexecutes GetUserDefaultLangID to get the user’s language.\n\nThe following codes correspond to the countries that fall within the whitelist. In case the system contains one of these LCIDs, the ransomware\nwill not affect any files.\n\n**Russian (Russia)** **ru-RU** **0x419**\n\nUkrainian (Ukraine) uk-UA 0x422\n\nBelarusian (Belarus) be-BY 0x423\n\nTajik (Cyrillic, Tajikistan) tg-Cyrl-TJ 0x428\n\nArmenian (Armenia) hy-AM 0x42B\n\nAzerbaijani (Latin, Azerbaijan) az-Latn-AZ 0x42C\n\nGeorgian (Georgia) ka-GE 0x437\n\nKazakh (Kazakhstan) kk-KZ 0x43F\n\n\n-----\n\nKyrgyz (Kyrgyzstan) ky-KG 0x440\n\nTurkmen (Turkmenistan) tk-TM 0x442\n\nUzbek (Latin, Uzbekistan) uz-Latn-UZ 0x443\n\nTatar (Russia) tt-RU 0x444\n\nRomanian (Moldova) ro-MD 0x818\n\nRussian (Moldova) ru-MD 0x819\n\nAzerbaijani (Cyrillic, Azerbaijan) az-Cyrl-AZ 0x82C\n\nUzbek (Cyrillic, Uzbekistan) uz-Cyrl-UZ 0x843\n\nArabic (Syria) ar-SY 0x2801\n\n## Information collected prior to data encryption\n\nBefore starting file encryption, certain information about the infected host is collected:\n\nlang: Language configured in the system\nusername: Current user name\nhostname: Name of the machine\ndomain: Determines if it is attached to an AD\nos_type: Operating system type\nos_version: Malware version, in our case 1.8.6.1\nos_arch: Architecture: x86 o x64\ndisks: Ratio of free space versus total disk space\nid: Machine guide, universal device identifier\n\nThe previous information is printed in a template, with a JSON format as shown below:\n\n\"os\":{\"lang\":\"%s\",.\"username\":\"%s\",\"hostname\":\"%s\",\"domain\":\"%s\",\"os_type\":\"windows\",\"os_ve.sion\":\"%s\",\"os_arch\":\"%s\",\"disks\":\"%s.\n\",\"id\":\"%s\"}\n\nThe generated sequence is printed in the following format:\n\n**%.8x=%s&%.8x=%s**\n\nGiving the following result:\n\n88bed015=/LkZFINJp3VPMHYvngh5vC5eEnPRdbWNJteVfehRLo+C+fI+92EFe5qDvzMSxSE6vLXevA3RamgvvsHXxbuTZW/ED+t\\iA3ggKHt9Y8F\n\nThis information is sent to the attackers’ central server via HTTP POST request, located at securebestapp20[.]com, a domain created on\nSeptember 16th, 2020, which is hosted on the infrastructure of the Russian provider Eurobyte (eurobyte[.]ru), which according to SpamHaus,\nwas one of the most used providers for running botnets in 2020 (See Figure 2).\n\n\n-----\n\n[Figure 2: Hosted Botnets in 2020 (Source)](https://www.spamhaus.com/custom-content/uploads/2020/08/2020-Q2_Botnet_Threat_Update.pdf)\nInterestingly, the User-Agent used for communication with the C2 is malformed. At first glance, everything looks normal, but when we look\nclosely at the rv:79.0 field and the Firefox/80 field, we notice a discrepancy. According to the standard, these two fields should be the same, so\nit may be a factor used by the server to only accept connections from the ransomware controlled by them.\n\n**Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:79.0) Gecko/20100101 Firefox/80**\n\nIn Figure 3, you can see the moment when the domain is accessed using the Windows Internet Connect API.\n\nFigure 3: Darkside connecting to the C2\n\n## File encryption\n\nIn case the malware decides to continue with the encryption (if it is not discarded by the whitelist), it uses a recursive main function that scans\neach directory of the identified logical drives (see Figure 4):\n\nRemovable drives: Floppy, Thumb drive, flash card\nHard drives in the computer\nMounted network drives\n\n\n-----\n\nFigure 4: Identifying the logical units to be encrypted\nThe general process is detailed in the flow diagram in Figure 5.\n\n\n-----\n\nFigure 5: File encryption\nThe process starts by evaluating whether the path has a directory. If it does, the process copies the “readme” file with the attackers’ message\nto that destination.\n\nIf not, the path is viewed as a file and the process evaluates if the filename is present in the whitelist embedded in the malware, as shown\nbelow:\n\nautorun.inf\nboot.ini\nboot\nfont.bin\nbootsect.bak\ndesktop.ini\nicon\n\n\n-----\n\ncac e db\nntldr\nntuser.dat\nntuser.dat.log\nntuser.ini\n\nIf the file contains one of the following extensions, it is not encrypted:\n\nAfter making the initial validations, the malware proceeds to encrypt the files swiftly by occupying one thread per available processor following\nthe following steps:\n\n1. An input/output (e/o) completion port is created via the CreateIoCompletionPort API\n2. Files to be encrypted are added to a queue via PostQueuedCompletionPort API\n3. The encrypted files are obtained from the queue via GetQueuedCompletionPort\n\nThe file to be encrypted is passed to the function at address 0xD6209C, which starts this process. Figure 6 shows the use of the APIs to\nenqueue and remove encrypted files.\n\nFigure 6: Functions related to encryption\nThe use of the stream cipher Salsa20 for file encryption is confirmed. In Figure 7, we can see the quarter-round function described in\n[Wikipedia, which is used to customize the matrix, and on the right side (in the function sub_D6209C), the implementation made by the](https://en.wikipedia.org/wiki/Salsa20)\nmalware.\n\n\n-----\n\nFigure 7: Confirming use of Salsa algorithm20\nWith this matrix, a 64-byte block is generated and used to encrypt the files, to which this block (encrypted with RSA) is also added at the end.\nIn Figure 8, you can see the encrypted block in memory and how it ends up being added to the encrypted files on disk.\n\nFigure 8: Salsa20 block added at the end of the encrypted file\nOnce the files have been encrypted, the following information is sent to the server:\n\n\"{\"id\":\"%s\",\"uid\":\"%s\",\"enc-num\":\"%u\",\"enc-size\":\"%s\",\"skip-num\":\"%u\",\"elapsed-time\":\"%u%u\"}\n\nid: Previously generated victim ID\nuid: again the victim's ID\nenc-num: number of infected files\nenc-size: total number of encrypted bytes\nskip-num: number of files that were not encrypted (on the whitelist)\nelapsed-time: length of time of infection\n\n## Shadow copy removal\n\nShadow copies are a mechanism by which Windows generates a backup of the information, if they are deleted, there is no way to restore the\ninformation once encrypted.\n\nIn the case of DarkSide, the command is encoded in hexadecimal and uses the call to CreateProcessW to invoke it as follows:\n\n**powershell -ep  bypass  -c  \"(0..61) | % {$s+=[char][byte]**\n\n('0x'+'4765742D576D694F626A6563742057696E33325F536861646F77636F7079207C20466F72456163682D4F626A656374207B245F2E44656\n\nWhich via VMI, it gets the shadow copies and deletes them:\n\n\n-----\n\n**Get** **Object** **3 _S ado copy |** **o** **ac** **Object {$_** **e ete();}**\n\n## Generation of the wallpaper\n\nOnce the victim’s files have been encrypted, the malware will change the wallpaper of their computer to inform them. The image seen in that\nwallpaper is generated by the malware and is stored in the C:\\ProgramData directory <id>BMP with <id> being the id generated for that\nparticular victim, as shown in Figure 9.\n\nFigure 9: Message for the victim\n\n## Cleanup after encryption\n\nOnce the file encryption tasks are finished, the malware deletes itself, usually to make forensic analysis more difficult. For this task, it calls\nShellExecuteW function with the following command:\n\n**cmd.exe /C DEL /F /Q C:\\%USERNAME%\\<ruta_del_malware>\\darkside.exe >> NULL**\n\n## DarkSide and REvil similarities\n\n### // Configuration\n\nIn both cases, the binaries occupy a configuration that is encrypted and embedded within the data section of the binary. This configuration in\nboth cases affects some parameters of the execution, in addition to containing the address of the connection server and the attacker’s public\nkey. However, the format differs; while REvil uses a single string with JSON format, DarkSide has a division between the configurations and\nthe public key. In addition, for DarkSide, the configuration after being decrypted must be unpacked. Figure 10 shows these differences:\n\n\n-----\n\nFigure 10: Comparison of configurations between Darkside and REvil\n\n### // Generation of the Mutex\n\nIn regards to the generation of the Mutex of the process, in the case of REvil, it is a fixed value that corresponds to “Global\\206в87e0-0e60df25-dd8f-8e4e7e7d1e3bf0”. In the case of Darkside, the generation of this Mutex is dynamic. First, a template is generated, which is\n“Global\\XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX” and then a crc32 is generated from the\ncontents of the executable, and the X values are replaced with the generated value. This process implies that each build of the executable will\nhave its own unique Mutex, allowing the malware to know if it is on a host that hasn’t been infected before. In the case of the sample we have,\nthe result is \"Global1609d3ee11333b13ecaf8b7d62361a1de1”.\n\n### // Packaging\n\nThe REvil executable is packaged with a custom algorithm, making it much more challenging to analyze, while all DarkSide samples found so\nfar are unpackaged.\n\n### // Generating the file extension\n\nA random file extension is added to every infected file. This extension prevents the malware from applying more than one encryption process\nto the host files, so it is essential always to generate the same file extension. In the case of REvil, this extension is generated by a crc32 of the\ncontents of the cpuid function call. For DarkSide, a crc32 is made to the contents of the\nHKEY_LOCAL_MACHINE_MACHINE_SOFTWARE_Microsoft_Cryptography_MachineGuid registry.\n\n## Recommendations\n\nRansomware attacks have become the top method used by attackers worldwide to obtain large amounts of money in a short period of time.\nransomware payments have tripled from 2019 to date. In the case of Colonial, due to the critical nature of their business and the need to\nrestart operations immediately, the company did not have many options but to pay the total of $5 million USD. Unfortunately, ransomware\nattacks are global and are increasing in frequency and scale.\n\nIn Latin America and Mexico, the cases continue to rise. In November 2019, the IT systems of PEMEX were compromised by ransomware;\n[according to bleepingcomputer, attackers asked for the sum of $4.9 million USD. In 2021 alone, we’ve seen attacks on multiple Mexican](https://www.bleepingcomputer.com/news/security/mexicos-pemex-oil-suffers-ransomware-attack-49-million-demanded/)\ninstitutions, including banks, with gigabytes of information were leaked on the deep web, due to a possible lack of payment, along with an\nattack on the National Lottery of Mexico.\n\n### Why are ransomware attacks growing exponentially?\n\nThe ease of executing ransomware attacks through services known as ransomware as a service (RaaS) reduces the barriers of entry. RaaS\nallows non-technical people to hire a service that allows them to compromise companies with minimal effort, sharing profits with the creators of\nthe service.\n\n### How can we combat this threat that is here to stay for years to come?\n\nFirst of all, accept that sooner or later, your organization is going to be infected with ransomware unless you proactively make changes. The\nfirst step is to strengthen your processes, people, and technology by testing your systems against a ransomware attack. Metabase Q offers a\ndifferent spin on ransomware as a Service via its APT Simulation service. By replicating multiple ransomware families like WannaCry, Ryuk,\nREvil, DarkSide, Avaddon, etc., in your network, we are able to test how well your systems would respond. The benefits include:\n\n\n-----\n\nSt e gt e you o ga at o s a so a e o to g, detect o a d e ad cat o capab t es\nProcesses: Gap detection and strengthening of policies and procedures established to react to an incident\nPeople: Incident response training of SOC personnel\nTechnology: Identifying gaps in your security solutions: SMTP Gateway, Endpoint, Lateral Movement, Event Correlation, Malicious\nCallbacks, etc. Is your investment yielding the expected results?\n\nThis new service reverse engineers emerging threats such as ransomware to reproduce the malicious code. Unlike RaaS, Metabase Q has the\ncontrol to execute the ransomware without the potential side effects of irreversible damage, such as deleting shadow copies or publishing\nsensitive information on the Deepweb. By utilizing the TTPs (Techniques, Tactics, and Procedures) and IOCs (Indicators of Compromise) used\nby malware in the real world, we can train and strengthen your processes, people, and technology.\n\nWe train your team to detect and fight real ransomware in your organization without having to pay millions of dollars for the ransom. Contact us\nat: [contact@metabaseq.com](http://10.10.0.46/mailto:mailto:contact@metabaseq.com)\n\nThank you, Bryan Gonzalez & Jose Zorrilla from Ocelot, for your support during this analysis.\n\n## Indicators of compromise (IOCs)\n\n### // Registry Changes\n\nHKCR.bfabc626(Default)\n\nHKCR\\bfabc626\\DefaultIcon(Default), Data: C:\\Users\\root\\AppData\\Local\\bfabc626.ico\"\n\nHKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Explorer\\GlobalAssocChangedCounter\", Data: 74\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\5.0\\Cache\\Content\\CachePrefix Data: “”\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\5.0\\Cache\\Cookies\\CachePrefix\", Data: Cookie:\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\5.0\\Cache\\History\\CachePrefix Data: Visited:\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\ProxyBypass, Data: 1\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\IntranetName, Data: 1\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\UNCAsIntranet, Data: 1\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\AutoDetect, Data: 0\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\ProxyBypass, Data: 1\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\IntranetName, Data: 1\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\UNCAsIntranet, Data: 1\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\AutoDetect, Data: 0\n\nHKLM\\System\\CurrentControlSet\\Services\\bam\\State\\UserSettings\\S-1-5-21-637130822-2221118250-149488871001\\Device\\HarddiskVolume4\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe, Data: 59 D4 90 A5 A5 4C D7 01 00 00 00 00 00\n00 00 00\n\nHKCU\\Control Panel\\Desktop\\WallPaper, Data: C:\\ProgramData\\bfabc626.BMP\"\n\nHKCU\\Control Panel\\Desktop\\WallpaperStyle, Data: 10\n\nHKCU\\Control Panel\\Desktop\\Wallpaper, Data: C:\\ProgramData\\bfabc626.BMP\n// Created files\n\nC:\\%USERNAME%\\AppData\\Local\\bfabc626.ico\n\nC:\\ProgramData\\bfabc626.BMP\n\nC:\\%USERNAME%\\AppData\\Local\\Temp\\3582-490\n\n### //URLs seen\n\nThe last part is variable so it is not recommended to use it as a detection pattern.\n\nhxxp://securebestapp20[.]com/mhzPjMHjEl\n\nhxxp://securebestapp20[.]com/mhzpjmhjel\n\nhxxps://securebestapp20[.]com/i7zMFQGyg0\n\nhxxp://securebestapp20[.]com/adbeeccba\n\nhxxps://securebestapp20[.]com/TpqTgJUS3v\n\nhxxp://securebestapp20[.]com/ddbcebcd\n\nhxxp://securebestapp20[.]com/bbaededade\n\n\n-----\n\nps //secu ebestapp 0[ ]co / g J8 G6\n\n### Binaries communicating to securebestapp20[.]com\n\nF9fc1a1a95d5723c140c2a8effc93722\n\nF75ba194742c978239da2892061ba1b4\n\nCfcfb68901ffe513e9f0d76b17d02f96\n\n9d418ecc0f3bf45029263b0944236884\n\n91e2807955c5004f13006ff795cb803c\n\n6a7fdab1c7f6c5a5482749be5c4bf1a4\n\n3fd9b0117a0e79191859630148dcdc6d\n\n222792d2e75782516d653d5cccfcf33b\n\nE44450150e8683a0addd5c686cd4d202\n\nC2764be55336f83a59aa0f63a0b36732\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-06 - Inside DarkSide, the ransomware that attacked Colonial Pipeline.pdf"
    ],
    "report_names": [
        "2021-08-06 - Inside DarkSide, the ransomware that attacked Colonial Pipeline.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536111,
    "ts_updated_at": 1743041137,
    "ts_creation_date": 1653702956,
    "ts_modification_date": 1653702956,
    "files": {
        "pdf": "https://archive.orkl.eu/b022d3b692cd06291e485752d5b8ca56d9651dbf.pdf",
        "text": "https://archive.orkl.eu/b022d3b692cd06291e485752d5b8ca56d9651dbf.txt",
        "img": "https://archive.orkl.eu/b022d3b692cd06291e485752d5b8ca56d9651dbf.jpg"
    }
}