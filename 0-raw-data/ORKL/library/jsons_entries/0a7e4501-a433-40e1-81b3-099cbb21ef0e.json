{
    "id": "0a7e4501-a433-40e1-81b3-099cbb21ef0e",
    "created_at": "2023-01-12T15:00:36.162056Z",
    "updated_at": "2025-03-27T02:15:02.383935Z",
    "deleted_at": null,
    "sha1_hash": "074fda0684c71c296cad1b2a7fa93f55d84e2421",
    "title": "2022-06-09 - Lyceum .NET DNS Backdoor",
    "authors": "",
    "file_creation_date": "2022-06-13T04:03:05Z",
    "file_modification_date": "2022-06-13T04:03:05Z",
    "file_size": 1504118,
    "plain_text": "# Lyceum .NET DNS Backdoor\n\n**zscaler.com/blogs/security-research/lyceum-net-dns-backdoor**\n\nActive since 2017, Lyceum group is a state-sponsored Iranian APT group that is known for targeting\nMiddle Eastern organizations in the energy and telecommunication sectors and mostly relying on\n.NET based malwares.\n\nZscaler ThreatLabz recently observed a new campaign where the Lyceum Group was utilizing a\nnewly developed and customized .NET based malware targeting the Middle East by copying the\nunderlying code from an open source tool.\n\n## Key Features of this attack:\n\n1. The new malware is a .NET based DNS Backdoor which is a customized version of the open\n\n[source tool “DIG.net”](https://www.codeproject.com/Articles/23673/DNS-NET-Resolver-C)\n2. The malware leverages a DNS attack technique called \"DNS Hijacking\" in which an\n\nattacker- controlled DNS server manipulates the response of DNS queries and resolve them as\nper their malicious requirements.\n3. The malware employs the DNS protocol for command and control (C2) communication which\n\nincreases stealth and keeps the malware communication probes under the radar to evade\ndetection.\n4. Comprises functionalities like Upload/Download Files and execution of system commands on\n\nthe infected machine by abusing DNS records, including TXT records for incoming commands\nand A records for data exfiltration.\n\n## Delivery mechanism\n\nDuring this campaign, the macro-enabled Word document (File name: ir_drones.docm) shown below\nis downloaded from the domain “http[:]//news-spot.live” disguising itself as a news report related to\nmilitary affairs in Iran. The text of the document is copied from the following original report here:\nhttps[:]//www[.]rferl[.]org/a/iran-drone-program-threats-interests/31660048.html\n\n\n-----\n\n_Fig 1. Attached Macro-enabled Word Document_\n\nOnce the user enables the macro content, the following AutoOpen() function is executed which\nincreases picture brightness using “PictureFormat.Brightness = 0.5” revealing content with the\nheadline, “Iran Deploys Drones To Target Internal Threat, Protect External Interests.”\n\n_Fig 2. AutoOpen() function revealing content to lure the victims_\n\nThe threat actor then leverages the AutoClose() function to drop the DNS backdoor onto the system.\nUpon closing the document the AutoClose() function is executed, reading a PE file from the text box\npresent on the 7th page of the word document and parsing it further into the required format as\nshown below with the “MZ” header as the initial two bytes of the byte stream.\n\n\n-----\n\n_Fig 3. AutoClose() function reading the PE File_\n\nThis PE file is then further written into the Startup folder in order to maintain persistence via the\nmacro code as shown below in the screenshot. With this tactic, whenever the system is restarted,\nthe DNS Backdoor is executed.\n\n_Fig 4. DNS Backdoor dropped in the Startup folder_\n\nThe dropped binary is a .NET based DNS Backdoor named “DnsSystem” which allows the threat\nactors to execute system commands remotely and upload/download data on the infected machine.\n\nBelow, we analyze the dropped .NET based DNS Backdoor and its inner workings.\n\n## Lyceum .NET DNS backdoor\n\n\n-----\n\nThe Lyceum Group has developed a .NET based DNS Backdoor which has been widely used in the\nwild in their recent campaigns. As discussed earlier, the backdoor was dropped in the Startup folder\nof the infected system from a Macro Enabled Word document.\n\n**md5: 8199f14502e80581000bd5b3bda250ee**\n\n**Filename: DnsSystem.exe**\n\n## Attack Chain Analysis\n\nThe .NET based DNS Backdoor is a customized version of the Open source tool DIG.net (DnsDig)\nfound here: [DNS.NET Resolver (C#) - CodeProject. DIG.net is an open source DNS Resolver which](https://www.codeproject.com/Articles/23673/DNS-NET-Resolver-C)\ncan be leveraged to perform DNS queries onto the DNS Server and then parse the response. The\nthreat actors have customized and appended code that allows them to perform DNS queries for\nvarious records onto the custom DNS Server, parse the response of the query in order to execute\nsystem commands remotely, and upload/download files from the Command & Control server by\nleveraging the DNS protocol.\n\nInitially the malware sets up an attacker controlled DNS server by acquiring the IP Address of the\ndomain name “cyberclub[.]one” = 85[.]206[.]175[.]199 using Dns.GetHostAddresses() for the DIG\nResolver function, which in turn triggers an DNS request to cyberclub[.]one for resolving the IP\naddress. Now this IP is associated as the custom attacker controlled DNS Server for all the further\nDNS queries initiated by the malware.\n\n_Fig 5. Initialize Attacker-Controlled DNS Server_\n\nNext, the Form Load function generates a unique BotID depending on the current Windows\nusername. It converts the username into its MD5 equivalent using the CreateMD5() function, and\nparses the first 8 bytes of the MD5 as the BotID for the identification of the user and system infected\nby the malware.\n\n\n-----\n\n_Fig 6. Generation of BotID using the Windows username_\n\nNow, the backdoor needs to receive commands from the C2 server in order to perform tasks. The\nbackdoor sends across an initial DNS query to “trailers.apple.com” wherein the domain name\n**“trailers.apple.com” is concatenated with the previously generated BotID before initiation of the**\nDNS request. The DNS query is then sent to the DNS server in order to fetch the “TXT” records for\nthe provided domain name by passing three arguments to the BeginDigIt() function:\n\nName: Target Domain name - EF58DF5Ftrailers.apple.com\nqType: Records to be queried - TXT\nqClass: Dns class value - IN (default)\n\n_Fig 7. Setup of DNS Query parameters before execution of BeginDigIt() Function_\n\nThe BeginDigIt function then executes the main DNS resolver function “DigIt.” This sends across the\nDNS query in order to fetch the DNS record for the provided target domain name to the DNS server,\nand parses the response as seen in the code snippet below.\n\n_Fig 8. DNS Query DigIt Function_\n\n\n-----\n\nComparing the Digit Resolver Code DigIt() function strings with the Dig.Net tool output from the\nscreenshot shown below provides us further assurance that the Dig.Net tool has been customized by\nthe Lyceum Group to develop the following .Net based DNS backdoor..\n\n_Fig 9. Original Dig.net GUI Output_\n\nThe malware utilizes a DNS attack technique known as “DNS Hijacking” where in the DNS server is\nbeing controlled by the attackers which would allow them to manipulate the response to the DNS\nqueries. Now let's analyze the DNS Hijacking routine below.\n\nAs discussed earlier, the backdoor performs initial DNS queries in order to fetch the TXT records for\nthe domain EF58DF5trailers.apple.com. EF58DF5 is the BotID generated based on the Windows\nuser to receive commands from the C2 server.\n\n\n-----\n\n_Fig 10. DNS query to attacker-controlled DNS server to fetch TXT records._\n\nAs can be seen in the above screenshot, a DNS query is performed to fetch the TXT records for the\ndomain name: EF58DF5trailers.apple.com to the DNS Server: 85[.]206[.]175[.]199 which is the\nattacker-controlled DNS server previously initialized.\n\nHere’s where the DNS hijacking happens: As the malware sends across a DNS query to fetch the\nTXT records to the attacker-controlled DNS server, the attacker controlled DNS server responds with\nan incorrect response consisting of the commands to be executed by the backdoor such as\nipconfig,whoami,uploaddd etc as shown in the screenshot below.\n\n_Fig 11. Ipconfig command returned as the TXT record from the attacker controlled DNS server_\n\nFollowing is the DIG.Net DNS response received by the backdoor and then further parsed in order to\nexecute commands on the infected machine.\n\n\n-----\n\n_Fig 12. DIG.net output received by the backdoor_\n\nThe above screenshot consists of the DNS query performed to the attacker controlled DNS server\nalong with the target domain name EF58DF5trailers.apple.com. The Answer section consists of the\nquery response, which includes the target Domain name and the response to the TXT record with\ntwo values, “ipconfig” - command to be executed and “1291” - Communication ID\n\nNext, the Dig.net response is parsed using multiple pattern regex code routines which parse out the\nTXT record values—the aforementioned command and communication ID—from the complete\nresponse received by the malware.\n\n_Fig 13. Parsing of TXT Records_\n\nNext, depending on the command received in the TXT record from the C2 server, there are three\nfunctions which can be performed by the Lyceum backdoor:\n\n**Download Files - If the command received from the DNS query consists of a string:**\n**“downloaddd” it initiates the download routine and downloads the file from the URL using**\nDownloadFileAsync(). The URL would be the first 11 bytes of the TXT record response value,\nand stores that downloaded file in the Downloads folder as shown below in the code snippet.\nThis functionality can be leveraged to drop additional malware on the infected machine.\n\n\n-----\n\n_Fig 14. Backdoor Download Routine_\n\n**Upload Files - If the command received from the DNS query consists of a string: “uploaddd”,**\nit uploads the local file on the disk using UploadFileAsync() function to an External URL after\nparsing the TXT record response value into two variables: uriString (external URL) and\nfilename (Local File). This functionality can be leveraged to exfiltrate data.\n\n_Fig 14. Backdoor Upload Routine_\n\n**Command Execution - If none of the above strings match the TXT record response then the**\nresponse is passed on to the Command execution routine. There, the response to the txt\nrecord is executed as a command on the infected machine using “cmd.exe /c\n**<txt_record_response_command>” and the command output is sent across to the C2 server**\nin the form of DNS A Records.\n\n\n-----\n\n_Fig 15. Backdoor Command Execution Routine_\n\nIn this case, the TXT record response we received for the DNS query performed against the attacker\ncontrolled DNS server is “ipconfig”. This response initiates the Command execution routine of the\nbackdoor and thus the command “ipconfig” would be executed on the infected machine - cmd.exe /c\nipconfig\n\nFurther, the command output is exfiltrated to the C2 server, encoded in Base64 and then\nconcatenated with the Communication ID and the previously generated BotUID using “$” as the\nseparator.\n\n_Fig 16. Command Output exfiltration Pattern setup_\n\n\n-----\n\nData Exfil Pattern: [base64encoded_command_output]$[communication_id]$[Bot_ID]\n\nOnce the command output is encoded in the above mentioned pattern, the DNS backdoor then\nsends across the output to the C2 server via DNS query in the form of A records in multiple blocks of\nqueries, where the A record values consists of the encoded command output. Once the command\noutput is transmitted completely, an “Enddd” command is sent across in a Base64-encoded data\nexfil pattern to notify the end of the command output as shown below in the screenshot.\n\n_Fig 17. Exfiltration of Encoded Command Output via A records queries on the attacker controlled_\n_DNS server_\n\n**Decoded A Records:**\n\n**IPConfig Command Output -**\n\n**Encoded A record =**\nICAgSVB2NCBBZGRyZXNzLiAuIC4gLiAuIC4gLiAuIC4gLiAuIDogMTkyLjE2OC4.yLjEw$929$5686BB2F\n\n**Decoded A record =**\n\nIPv4 Address. . . . . . . . . . . : 192.168.2.10 $ ComID: 929 $ UID: 5686BB2F\n\n**End Command -**\n\n**Encoded A record = RW5kZGQ=$1291$$EF58DF5F**\n\n**Decoded A record = Enddd $ ComID: 1291 $ UID: EF58DF5F**\n\n**Cloud Sandbox detection**\n\n\n-----\n\n_Fig 18: The Zscaler Cloud Sandbox successfully detected the malware._\n\n## Conclusion\n\nAPT threat actors are continuously evolving their tactics and malware to successfully carry out\nattacks against their targets. Attackers continuously embrace new anti-analysis tricks to evade\nsecurity solutions; re-packaging of malware makes static analysis even more challenging. The\nZscaler ThreatLabz team will continue to monitor these attacks to help keep our customers safe.\n\n**MITRE ATT&CK mapping:**\n\nT1059 Command and Scripting Interpreter\n\nT1055 Process Injection\n\nT1562 Disable or Modify Tools\n\nT1010 Application Window Discovery\n\nT1018 Remote System Discovery\n\nT1057 Process Discovery\n\nT1518 Security Software Discovery\n\nT1071 Application Layer Protocol\n\n**IOC:**\n\nDocm Hash:\n\n13814a190f61b36aff24d6aa1de56fe2\n\n\n-----\n\nExe Hash:\n\n8199f14502e80581000bd5b3bda250ee\n\nDomain and URL's:\n\ncyberclub[.]one\nhxxp://news-spot[.]live/Reports/1/?id=1111&pid=a52\n\nhxxp://news-spot[.]live/Reports/1/?id=1111&pid=a28\n\nhxxp://news-spot[.]live/Reports/1/?id=1111&pid=a40\n\nhxxp://news-spot[.]live/Reports/1/45/DnsSystem[.]exe\n\n## About ThreatLabz\n\nThreatLabz is the security research arm of Zscaler. This world-class team is responsible for hunting\nnew threats and ensuring that the thousands of organizations using the global Zscaler platform are\nalways protected. In addition to malware research and behavioral analysis, team members are\ninvolved in the research and development of new prototype modules for advanced threat protection\non the Zscaler platform, and regularly conduct internal security audits to ensure that Zscaler products\nand infrastructure meet security compliance standards. ThreatLabz regularly publishes in-depth\nanalyses of new and emerging threats on its portal, research.zscaler.com.\n\n[Stay updated on ThreatLabz research by subscribing to our Trust Issues newsletter today.](https://info.zscaler.com/resources-threat-labz-newsletter-subscription)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-09 - Lyceum .NET DNS Backdoor.pdf"
    ],
    "report_names": [
        "2022-06-09 - Lyceum .NET DNS Backdoor.pdf"
    ],
    "threat_actors": [
        {
            "id": "cde987a8-c71f-49e2-b761-5b7fa2b4ada6",
            "created_at": "2022-10-25T16:07:23.706646Z",
            "updated_at": "2025-03-27T02:02:09.933918Z",
            "deleted_at": null,
            "main_name": "Hexane",
            "aliases": [
                "ATK 120",
                "Cobalt Lyceum",
                "Lyceum",
                "Operation Out to Sea",
                "Siamesekitten",
                "Yellow Dev 9"
            ],
            "source_name": "ETDA:Hexane",
            "tools": [
                "DanBot",
                "DanDrop",
                "Decrypt-RDCMan.ps1",
                "Get-LAPSP.ps1",
                "James",
                "Milan",
                "kl.ps1"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "a7df240e-6750-4b71-99de-85831b92faa2",
            "created_at": "2022-10-25T15:50:23.859253Z",
            "updated_at": "2025-03-27T02:00:55.546377Z",
            "deleted_at": null,
            "main_name": "HEXANE",
            "aliases": [
                "Lyceum",
                "Siamesekitten",
                "Spirlin"
            ],
            "source_name": "MITRE:HEXANE",
            "tools": [
                "Milan",
                "netstat",
                "BITSAdmin",
                "DnsSystem",
                "DanBot",
                "ipconfig",
                "Mimikatz",
                "Kevin",
                "PoshC2"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "fb8f3a5f-01a9-498e-9396-52f844424c33",
            "created_at": "2023-01-06T13:46:39.045338Z",
            "updated_at": "2025-03-27T02:00:02.984648Z",
            "deleted_at": null,
            "main_name": "LYCEUM",
            "aliases": [
                "siamesekitten",
                "Chrono Kitten",
                "Storm-0133",
                "COBALT LYCEUM",
                "UNC1530",
                "Spirlin",
                "MYSTICDOME"
            ],
            "source_name": "MISPGALAXY:LYCEUM",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535636,
    "ts_updated_at": 1743041702,
    "ts_creation_date": 1655092985,
    "ts_modification_date": 1655092985,
    "files": {
        "pdf": "https://archive.orkl.eu/074fda0684c71c296cad1b2a7fa93f55d84e2421.pdf",
        "text": "https://archive.orkl.eu/074fda0684c71c296cad1b2a7fa93f55d84e2421.txt",
        "img": "https://archive.orkl.eu/074fda0684c71c296cad1b2a7fa93f55d84e2421.jpg"
    }
}