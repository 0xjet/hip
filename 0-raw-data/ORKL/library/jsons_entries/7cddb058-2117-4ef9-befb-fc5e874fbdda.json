{
    "id": "7cddb058-2117-4ef9-befb-fc5e874fbdda",
    "created_at": "2023-01-12T15:01:52.763851Z",
    "updated_at": "2025-03-27T02:17:11.716819Z",
    "deleted_at": null,
    "sha1_hash": "448d088a88c363ed0b8f09df9679c07d8a131727",
    "title": "2018-05-24 - VPNFilter EXIF to C2 mechanism analysed",
    "authors": "",
    "file_creation_date": "2022-05-28T02:03:08Z",
    "file_modification_date": "2022-05-28T02:03:08Z",
    "file_size": 1512293,
    "plain_text": "# VPNFilter EXIF to C2 mechanism analysed\n\n**[securelist.com/vpnfilter-exif-to-c2-mechanism-analysed/85721/](https://securelist.com/vpnfilter-exif-to-c2-mechanism-analysed/85721/)**\n\nAuthors\n\nGReAT\n\nOn May 23 2018, our colleagues from Cisco Talos published their excellent analysis of\nVPNFilter, an IoT / router malware which exhibits some worrying characteristics.\n\nSome of the things which stand out about VPNFilter are:\n\nIt has a redundant, multi-stage command and control mechanism which uses three\ndifferent channels to receive information\nIt has a multi-stage architecture, in which some of the more complex functionality runs\nonly in the memory of the infected devices\nIt contains a destructive payload which is capable of rendering the infected devices\nunbootable\nIt uses a broken (or incorrect) RC4 implementation which has been observed before\nwith the BlackEnergy malware\n\n\n-----\n\nStage 2 command and control can be executed over TOR, meaning it will be hard to\nnotice for someone checking the network traffic\n\nWe’ve decided to look a bit into the C&C mechanism for the persistent malware payload. As\ndescribed in the Talos blog, this mechanism has several stages:\n\nFirst, the malware tries to visit a number of gallery pages hosted on photobucket[.]com\nand fetches the first image from the page.\nIf this fails, the malware tries fetching an image file from a hardcoded domain,\ntoknowall[.]com. This C2 domain is currently sinkholed by the FBI.\nIf that fails as well, the malware goes into a passive backdoor mode, in which it\nprocesses network traffic on the infected device waiting for the attacker’s commands.\n\nFor the first two scenarios in which the malware successfully receives an image file, a C2\nextraction subroutine is called which converts the image EXIF coordinates into an IPv4\naddress. This is used as an easy way to avoid using DNS lookups to reach the C&C. Of\ncourse, in case this fails, the malware will indeed lookup the hardcoded domain\n(toknowall[.]com). It may be worth pointing that in the past, the BlackEnergy APT devs have\nshown a preference for using IP addresses for C&C instead of hardcoded domain names,\nwhich can be easily sinkholed.\n\nTo analyse the EXIF processing mechanism, we looked into the sample\n**5f358afee76f2a74b1a3443c6012b27b, mentioned in the Talos blog. The sample is an i386**\nELF binary and is about 280KB in size.\n\nUnfortunately for researchers, it appears that the photobucket.com galleries used by the\nmalware have been deleted, so the malware cannot use the first C2 mechanism anymore.\nFor instance:\n\n\n-----\n\nWith these galleries unavailable, the malware tries to reach the hardcoded domain\ntoknowall[.]com.\n\nWhile looking at the pDNS history for this domain, we noticed that it resolved to an IP\naddresses in France, at OVH, between Jan and Feb 2018:\n\nInterestingly, when visiting this website’s C2 URL, we are presented with a JPG image,\nsuggesting it is still an active C2:\n\n\n-----\n\nHere s how it looks when viewed as an image:\n\nWhen we look into the EXIF data for the picture, for instance using IrfanView, it looks as\nfollowing:\n\nFilename – update.jpg\n\nGPS information: –\nGPSLatitude – 97 30 -175 (97.451389)\nGPSLongitude – -118 140 -22 (-115.672778)\n\nHow to get the IP out of these? The subroutine which calculates the C2 IP from the Latitude\nand Longitude can be found at offset 0x08049160 in the sample.\n\nAs it turns out, VPNFilter implements an actual EXIF parser to get the required information.\n\n\n-----\n\nFirst, it searches for a binary value 0xE1. This makes sense because the EXIF attribute\ninformation begins with a tag “0xFF 0xE1”. Then, it verifies that the tag is followed by a string\n“Exif”. This is the exact data that should appear in a correct header of the Exif tag:\n\n**Exif tag**\nFF E1 Exif tag\nxx Length of field\n45 78 69 66 00 ‘Exif’\n00 Padding\n\nThe tag is followed by an additional header:\n\n**“Attribute information” header**\n49 49 (or 4D 4D) Byte order, ‘II’ for little endian (‘MM’ for big endian)\n2A 00 Fixed value\nxx xx Offset of the first IFD\n\nThe data following this header is supposed to be the actual “attribute information” that is\norganized in so-called IFDs (Image File Directory) that are data records of a specific format.\nEach IFD consists of the following data:\n\n**IFD record**\nxx xx IFD tag\nxx xx Data type\nxx xx xx xx Number of data records of the same data type\nxx xx xx xx Offset of the actual data, from the beginning of the EXIF\n\nThe malware’s parser carefully traverses each record until it finds the one with a tag ’25 88′\n(0x8825 little endian). This is the tag value for “GPS Info”. That IFD record is, in turn, a list of\ntagged IFD records that hold separate values for latitude, longitude, timestamp, speed, etc.\nIn our case, the code is looking for the tags ‘2’ (latitude) and ‘4’ (longitude). The data for\nlatitude and longitude are stored as three values in the “rational” format : two 32-bit values,\nthe first is the enumerator and the second one is the denominator. Each of these three\nvalues corresponds to degrees, minutes and seconds, respectively.\n\nThen, for each record of interest, the code extracts the enumerator part and produces a\nstring of three integers (i.e. “97 30 4294967121” and “4294967178 140 4294967274″ that will\nbe displayed by a typical EXIF parser as 1193143 deg 55′ 21.00″, 4296160226 deg 47′\n54.00”). Then, curiously enough, it uses sscanf() to convert these strings back to integers.\n**This may indicate that the GPS Info parser was taken from a third-party source file and**\n**used as-is. The extracted integers are then used to produce an actual IP address. The**\npseudocode in C is as follows:\n```\nconst char lat[] = \"97 30 4294967121\"; // from Exif data\n\n```\n\n-----\n\n```\nconst char lon[] = 4294967178 140 4294967274 ; // from Exif data\nint o1p1, o1p2, o2p1, o3p1, o3p2, o4p1;\nuint8_t octets[4];\n\n```\nsscanf(lat, \"%d %d %d\", &o1p2, &o1p1, &o2p1);\nsscanf(lon, \"%d %d %d\", &o3p2, &o3p1, &o4p1);\noctets[0] = o1p1 + ( o1p2 + 0x5A );\noctets[1] = o2p1 + ( o1p2 + 0x5A );\noctets[2] = o3p1 + ( o3p2 + 0xB4 );\noctets[3] = o4p1 + ( o3p2 + 0xB4 );\n\nprintf(\"%u.%u.%u.%u\\n\", octets[0], octets[1], octets[2], octets[3]);\n\nThe implementation of the EXIF parser appears to be pretty generic. The fact that it correctly\nhandles the byte order (swapping the data, if required) and traverses all EXIF records\nskipping them correctly, and that the GPS data is converted to a string and then back to\nintegers most likely indicates that the code was reused from an EXIF-parsing library or\ntoolkit.\n\nFor the values provided here, the code will produce the IP address “217.12.202.40” that is a\nknown C&C of VPNFilter.\n\n\n-----\n\nIt should be noted that this IP is included in Cisco Talos IOCs list as a known C&C.\nCurrently, it appears to be down.\n\n## What’s next?\n\nPerhaps the most interesting question is who is behind VPNFilter. In their Affidavit for\nsinkholing the malware C2, FBI suggests it is related to Sofacy:\n\nInterestingly, the same Affidavit contains the following phrase: “Sofacy Group, also known as\n_apt28, sandworm, x-agent, pawn storm, fancy bear and sednit”. This would suggest that_\nSandworm, also known as BlackEnergy APT, is regarded as subgroup of Sofacy by the FBI.\nMost threat intel companies have held these groups separate before, although their activity is\nknown to have overlapped in several cases.\n\nPerhaps the most interesting technical detail, which Cisco Talos points in their blog linking\nVPNFilter to BlackEnergy, is the usage of a flawed RC4 algorithm.The RC4 key scheduling\nalgorithm implementation from these is missing the typical “swap” at the end of the loop.\nWhile rare, this mistake or perhaps optimization from BlackEnergy, has been spotted by\nresearchers and described publicly going as far back as 2010. For instance, Joe Stewart’s\nexcellent analysis of Blackenergy2 explains this peculiarity.\n\n\n-----\n\nSo, is VPNFilter related to BlackEnergy? If we are to consider only the RC4 key scheduling\nimplementation alone, we can say there is only a low confidence link. However, it should be\nnoted that BlackEnergy is known to have deployed router malware going back as far as\n2014, which we described in our blogpost: “BE2 custom plugins, router abuse, and target\nprofiles“. We continue to look for other similarities which could support this theory.\n\n[APT](https://securelist.com/tag/apt/)\n[BlackEnergy](https://securelist.com/tag/blackenergy/)\n[Internet of Things](https://securelist.com/tag/internet-of-things/)\n[Malware Descriptions](https://securelist.com/tag/malware-descriptions/)\n[Router](https://securelist.com/tag/router/)\n[Targeted attacks](https://securelist.com/tag/targeted-attacks/)\n\nAuthors\n\nGReAT\n\nVPNFilter EXIF to C2 mechanism analysed\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-05-24 - VPNFilter EXIF to C2 mechanism analysed.pdf"
    ],
    "report_names": [
        "2018-05-24 - VPNFilter EXIF to C2 mechanism analysed.pdf"
    ],
    "threat_actors": [
        {
            "id": "b3e954e8-8bbb-46f3-84de-d6f12dc7e1a6",
            "created_at": "2022-10-25T15:50:23.339976Z",
            "updated_at": "2025-03-27T02:00:55.446795Z",
            "deleted_at": null,
            "main_name": "Sandworm Team",
            "aliases": [
                "Sandworm Team",
                "ELECTRUM",
                "Telebots",
                "IRON VIKING",
                "BlackEnergy (Group)",
                "Quedagh",
                "Voodoo Bear",
                "IRIDIUM",
                "Seashell Blizzard",
                "FROZENBARENTS",
                "APT44"
            ],
            "source_name": "MITRE:Sandworm Team",
            "tools": [
                "Bad Rabbit",
                "Mimikatz",
                "Exaramel for Linux",
                "Exaramel for Windows",
                "GreyEnergy",
                "PsExec",
                "Prestige",
                "P.A.S. Webshell",
                "VPNFilter",
                "Cyclops Blink",
                "SDelete",
                "AcidRain",
                "Industroyer",
                "Industroyer2",
                "BlackEnergy",
                "Cobalt Strike",
                "NotPetya",
                "KillDisk",
                "PoshC2",
                "Impacket",
                "Invoke-PSImage",
                "Olympic Destroyer"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8941e146-3e7f-4b4e-9b66-c2da052ee6df",
            "created_at": "2023-01-06T13:46:38.402513Z",
            "updated_at": "2025-03-27T02:00:02.824555Z",
            "deleted_at": null,
            "main_name": "Sandworm",
            "aliases": [
                "G0034",
                "IRIDIUM",
                "Blue Echidna",
                "FROZENBARENTS",
                "Seashell Blizzard",
                "IRON VIKING",
                "ELECTRUM",
                "TeleBots",
                "UAC-0113",
                "UAC-0082",
                "APT44",
                "Quedagh",
                "VOODOO BEAR",
                "TEMP.Noble"
            ],
            "source_name": "MISPGALAXY:Sandworm",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "7bd810cb-d674-4763-86eb-2cc182d24ea0",
            "created_at": "2022-10-25T16:07:24.1537Z",
            "updated_at": "2025-03-27T02:02:10.126127Z",
            "deleted_at": null,
            "main_name": "Sandworm Team",
            "aliases": [
                "APT 44",
                "ATK 14",
                "BE2",
                "Blue Echidna",
                "CTG-7263",
                "FROZENBARENTS",
                "IRIDIUM",
                "Iron Viking",
                "Quedagh",
                "Sandworm",
                "Sandworm Team",
                "Seashell Blizzard",
                "TEMP.Noble",
                "UAC-0082",
                "UAC-0113",
                "UAC-0125",
                "UAC-0133",
                "Voodoo Bear"
            ],
            "source_name": "ETDA:Sandworm Team",
            "tools": [
                "AWFULSHRED",
                "ArguePatch",
                "BIASBOAT",
                "Black Energy",
                "BlackEnergy",
                "CaddyWiper",
                "Colibri Loader",
                "Cyclops Blink",
                "CyclopsBlink",
                "DCRat",
                "DarkCrystal RAT",
                "Fobushell",
                "GOSSIPFLOW",
                "Gcat",
                "IcyWell",
                "Industroyer2",
                "JaguarBlade",
                "JuicyPotato",
                "Kapeka",
                "KillDisk.NCX",
                "LOADGRIP",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "ORCSHRED",
                "P.A.S.",
                "PassKillDisk",
                "Pitvotnacci",
                "PsList",
                "QUEUESEED",
                "RansomBoggs",
                "RottenPotato",
                "SOLOSHRED",
                "SwiftSlicer",
                "VPNFilter",
                "Warzone",
                "Warzone RAT",
                "Weevly"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d2516b8e-e74f-490d-8a15-43ad6763c7ab",
            "created_at": "2022-10-25T16:07:24.212584Z",
            "updated_at": "2025-03-27T02:02:10.141001Z",
            "deleted_at": null,
            "main_name": "Sofacy",
            "aliases": [
                "APT 28",
                "ATK 5",
                "Blue Athena",
                "BlueDelta",
                "FROZENLAKE",
                "Fancy Bear",
                "Fighting Ursa",
                "Forest Blizzard",
                "Grey-Cloud",
                "Grizzly Steppe",
                "Group 74",
                "GruesomeLarch",
                "ITG05",
                "Iron Twilight",
                "Operation DealersChoice",
                "Operation Dear Joohn",
                "Operation Komplex",
                "Operation Pawn Storm",
                "Operation Russian Doll",
                "Operation Steal-It",
                "Pawn Storm",
                "SIG40",
                "Sednit",
                "Snakemackerel",
                "Sofacy",
                "Strontium",
                "T-APT-12",
                "TA422",
                "TAG-0700",
                "TAG-110",
                "TG-4127",
                "Tsar Team",
                "UAC-0028",
                "UAC-0063"
            ],
            "source_name": "ETDA:Sofacy",
            "tools": [
                "ADVSTORESHELL",
                "AZZY",
                "Backdoor.SofacyX",
                "CHERRYSPY",
                "CORESHELL",
                "Carberp",
                "Computrace",
                "DealersChoice",
                "Delphacy",
                "Downdelph",
                "Downrage",
                "Drovorub",
                "EVILTOSS",
                "Foozer",
                "GAMEFISH",
                "GooseEgg",
                "Graphite",
                "HATVIBE",
                "HIDEDRV",
                "Headlace",
                "Impacket",
                "JHUHUGIT",
                "JKEYSKW",
                "Koadic",
                "Komplex",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LoJack",
                "LoJax",
                "MASEPIE",
                "Mimikatz",
                "NETUI",
                "Nimcy",
                "OCEANMAP",
                "OLDBAIT",
                "PocoDown",
                "PocoDownloader",
                "Popr-d30",
                "ProcDump",
                "PythocyDbg",
                "SMBExec",
                "SOURFACE",
                "SPLM",
                "STEELHOOK",
                "Sasfis",
                "Sedkit",
                "Sednit",
                "Sedreco",
                "Seduploader",
                "Shunnael",
                "SkinnyBoy",
                "Sofacy",
                "SofacyCarberp",
                "SpiderLabs Responder",
                "Trojan.Shunnael",
                "Trojan.Sofacy",
                "USB Stealer",
                "USBStealer",
                "VPNFilter",
                "Win32/USBStealer",
                "WinIDS",
                "Winexe",
                "X-Agent",
                "X-Tunnel",
                "XAPS",
                "XTunnel",
                "Xagent",
                "Zebrocy",
                "Zekapab",
                "carberplike",
                "certutil",
                "certutil.exe",
                "fysbis",
                "webhp"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535712,
    "ts_updated_at": 1743041831,
    "ts_creation_date": 1653703388,
    "ts_modification_date": 1653703388,
    "files": {
        "pdf": "https://archive.orkl.eu/448d088a88c363ed0b8f09df9679c07d8a131727.pdf",
        "text": "https://archive.orkl.eu/448d088a88c363ed0b8f09df9679c07d8a131727.txt",
        "img": "https://archive.orkl.eu/448d088a88c363ed0b8f09df9679c07d8a131727.jpg"
    }
}