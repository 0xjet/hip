{
    "id": "db797b5a-2aa7-4c8d-9f4e-1ea626722d4c",
    "created_at": "2023-01-12T15:05:11.175553Z",
    "updated_at": "2025-03-27T02:05:55.589133Z",
    "deleted_at": null,
    "sha1_hash": "e0c137b04899ffd7d78fb22fdf0bca83c644b48d",
    "title": "2018-11-08 - Deep Analysis of TrickBot New Module pwgrab",
    "authors": "",
    "file_creation_date": "2022-05-29T10:46:00Z",
    "file_modification_date": "2022-05-29T10:46:00Z",
    "file_size": 234536,
    "plain_text": "# Deep Analysis of TrickBot New Module pwgrab\n\n**[fortinet.com/blog/threat-research/deep-analysis-of-trickbot-new-module-pwgrab.html](https://www.fortinet.com/blog/threat-research/deep-analysis-of-trickbot-new-module-pwgrab.html)**\n\nThreat Research\n\n\nNovember 8, 2018\n\n\nBy [Xiaopeng Zhang | November 08, 2018](https://www.fortinet.com/blog/search?author=Xiaopeng+Zhang)\nThe TrickBot malware family has been live for several years, mainly focused on stealing\nvictim’s online banking information. In new samples recently collected by FortiGuard Labs,\nwe found a new TrickBot variant, with a new module pwgrab, which attempt to steal\ncredentials, autofill data, history and so on from browsers as well as several software\napplications. I did a deep analysis on this pwgrab module, and in this blog I will explain how it\nworks on a victim’s system.\n\n**TrickBot downloaded by opening an excel file**\n\nThe new TrickBot variant is spread by an Excel file (originally named “Sep_report.xls”) using\na malicious Macro VBS code that is executed when the victim opens the file in Microsoft\nExcel. We captured this sample on October 19, 2018. Figure 1 shows that “Sep_report.xls”th\n\n\n-----\n\nis opened in Microsoft Excel where it requests that the victim enable the embedded Macro by\nclicking on the “Enable Content” button.\n\nFigure 1. Sep_report.xls opened in Microsoft Excel\n\nThe VBA code is password protected for viewing. To analyze the code, I manually modified\nthe protected flag to bypass the password protection.\n\nThe VBA code starts with the function “Workbook_Open”, which is called automatically when\nthe Excel file is opened. It then reads data from Text control, which is encoded Powershell\ncode. In Figure 2 you can see part of the decoded Powershell code.\n\nFigure 2. Decoded Powershell code\n\nFinally, the Powershell code is executed to download the file from “hxxp://excel_office.com/secure.excel” and save it to a local temporary folder with the name “pointer.exe”_\nwhereupon it runs it. As you may have guessed, the “pointer.exe” file is actually TrickBot.\n\n**Task Schduler Starts TrickBot to load pwgrab32**\n\nWhen “pointer.exe” runs for the very first time, it creates the “%AppData%\\VsCard” folder as\nits home folder, then copies “pointer.exe” into it and renames it as “pointes.exe”. In this\nversion it also changes its module folder: the new one is “%AppData%\\VsCard\\Data” instead\nof the previous “%AppData%\\[random folder name]\\Modules”. Figure 3 is a screenshot of\nthe new folder.\n\nFigure 3. Screenshot of the new module folder “Data”\n\nAs with its previous version, it installs itself into the system “Task Scheduler” so it can run\nautomatically by “Task Scheduler”.\n\nAfter “pointes.exe” runs for a little while, it sends the command “5” request to its C&C server\nwith the string “pwgrab32” for a 32-bit platform (or “pwgrab64” for a 64-bit platform) asking to\ndownload the new module of “pwgrab32”, just as it does for downloading other module files\nsuch as “systeminfo32” and “injectdll32”.\n\nTo learn more about the packet format of command “5” and the command’s purpose, you can\nrefer to my [previous blog. All files downloaded through command “5” in older versions are](https://www.fortinet.com/blog/threat-research/deep-analysis-of-the-online-banking-botnet-trickbot.html)\nAES encrypted. Recent versions have added one more XOR encryption on AES encrypted\ndata .So to get to the original pwgrab32 module we had to go through two-layer decryption.\nThe pwgrab32 module was generated on October 16, 2018 and was developed withth\nBorland Delphi 3.0. Figure 4 shows the pwgrab32 module analyzed in a PE tool.\n\nFigure 4. Decrypted pwgrab32 being analyzed in CFF Explorer\n\n\n-----\n\nDuring my analysis of pointes.exe I can see that it uses some anti-analysis techniques to\nmake it harder to be analyzed. For example, it encrypts all string information to protect itself\nfrom being analyzed statically and dynamically loads APIs during running time.\n\nFrom the file name of “pwgrab32” we can guess it will grab password information from the\nvictim’s system. Let’s go on to see how it will do this.\n\nAfter downloading and decrypting “pwgrab32”, “pointes.exe” continues to load “pwgrab32”.\nJust like when loading other modules, it calls the API “CreateProcessAsUserW” to create a\nsuspended “svchost.exe” process. It then injects a piece of code from the “pointes.exe”\nmemory to this svchost.exe process memory by calling the API “WriteProcessMemory”. By\ncalling the API “ZwQueryInformationProcess”, “pointes.exe” can get “svchost.exe”’s\n[ProcessBasicInformation from which it can locate the OEP (Original Entry Point) of](https://en.wikipedia.org/wiki/Entry_point)\n“svchost.exe” in its PE structure. Furthermore, it can modify the code at OEP to execute the\ncopied piece of code. It then calls “ResumeThread” to resume running “svchost.exe”. Figure\n5 is a code snippet of finding “svchost.exe”’s OEP.\n\nFigure 5. Find svchost.exe OEP\n\nNext, API “WriteProcessMemory”, “SignalObjectAndWait”, and “WaitForSingleObject” are\ncalled a number of times by both “pointes.exe” and “svchost.exe” to maintain synchronicity to\nfinish copying the decrypted pwgrab32 and related information, such as copying the C&C\nserver IP list from “pointes.exe” onto “svchost.exe”. Finally, “pwgrab32!10006634” (the OEP\nof pwgrab32) is called by the copied piece of code mentioned above.\n\nFrom this point on, the pwgrab32 takes over the work to collect any password related data.\n\n**pwgrab32 Collects Credentials from Browsers of Victim’s System**\n\nAt first “pwgrab32” decodes the “core-parser.dll” module, loads into the memory, and makes\nit ready for use. It has several export functions, as shown in Figure 6.\n\nFigure 6. core-parser.dll export function list\n\nFunction “EnumDpostServer” returns the C&C server IP address, which will be called by\n“pwgrab32” when it wants to send data to the C&C server.\n\nIt launches three threads to grab credentials from three different browsers. They all share the\nsame thread function but different parameters. From my analysis, parameter 1 is for Internet\nExplorer, 2 is for Firefox, 3 is for Chrome, and 4 is for Edge. However, in this version Edge is\ndisabled.\n\nThere is also a very huge function, “pwgrab32!sub_100137F8”, which executes the operation\nof collecting saved credentials from all browsers. There are different code branches for\ndifferent browsers. I will show you how it works.\n\n\n-----\n\nOne interesting thing I found in the pwgrab32 code is that it encrypts plain text byte by byte,\ndecrypts it back to plain text, and uses that decrypted plain text. Is this a joke by the Trickbot\nauthor? No, it should be an anti-analysis technique to hide plain text. However, I think the\nauthor simply forgot to remove the decryption function and replace the plain text with the\nencrypted one before compiling this module. This error appears many times throughout the\npwgrab32 module. Figure 7 shows a code snippet of that.\n\nFigure 7. Plain text “IE password” being encrypted first and decrypted later\n\n**1>  Thread Parameter 1 for Internet Explorer:**\n\nAccording to the Windows system version, there are two different code branches for IE.\n\nIf a victim’s system version is Windows 2000, Windows XP, Windows Vista, Windows Server\n2008, Windows 7, Windows 10, or Windows Server 2016, it reads and enumerates values\nfrom the system registry sub-key “HKEY_CURRENT_USER\\Software\\Microsoft\\Internet\nExplorer\\IntelliForms\\Storage2”, which contains the SHA1 hash code list of saved website\nhosts and saved credentials for this website. Figure 8 is a screenshot of the “Storage2” subkey on my Windows 7 system. Calling the APIs “FindFirstUrlCacheEntryW” and\n“FindNextUrlCacheEntryW”, this malware can enumerate all cached websites. Furthermore it\ncan calculate SHA1 hash code for each website host (for example “http://www.fortinet.com/”)\nthrough comparison with the hash code from the sub-key “Storage2”, whereupon it can\nobtain the website’s host. It then parses the third column data to get the credential for the\nwebsite. Finally, it saves the collected credentials in this format:\n\n“Website host|Login ID|Login password”.\n\nFigure 8. Screenshot of sub-key “Storage2”\n\nWhen the victim’s system is another version, it calls some additional APIs to get credentials.\nHere is a pseudo code of this process for getting credentials.\n\n\n-----\n\n```\nif ( VaultEnumerateVaults(0, &a4, &a5) )\nreturn 0;\n v70 = 0; a2 = 0;\n if ( a4 ) {  v71 = 0;  a3 = 0;\nwhile ( !VaultOpenVault(v71 + a5, 0, &vars0) && !VaultEnumerateItems(vars0, 512, &a1,\n&retaddr) )    \n {    v72 = 0;\n   if ( a1 ) {\n    v73 = lpCriticalSection;\n    v74 = a7;\n    do {\n     memset(&a65, 0, 0xE08u);\n     if ( v74 )\n      v75 = sub_100133F2(v72, &a65);\n     else\n      v75 = sub_1001329C(v72, &a65);\n     if ( v75 ) {\n      wnsprintfA(&String, 1024, \"%S|%S|%S\\n\", &a66, &a67, &a68);\n      v76 = sub_1000CBB8(&String);\n      sub_1000D1AA(v73, &String, v76);\n     }\n     ++v72;\n     }\n     while ( v72 < a1 );\n    v70 = a2;  v71 = a3;\n   }\n   VaultFree(retaddr);\n   VaultCloseVault(vars0);\n\n```\n**2> Thread Parameter 2 for Mozilla Firefox:**\n\nThis code thread reads the Firefox installation path from the system registry, and then calls\nthe API “SetCurrentDirectoryA” with the installation path to set the current directory to the\nFirefox installation path so it can easily read the credential files of Firefox and load a dll\nwhich is used to handle Firefox credentials.\n\n“pwgrab32” continues to load nss3.dll of Firefox and read some Firefox files from its AppData\nfolder, such as \"%AppData%\\Mozilla\\Firefox\\Profiles\\e375zm7t.default\\logins.json\". It then\ncalls the APIs of nss3.dll, like “PK11_GetInternalKeySlot”, “PK11_Authenticate”, and\n“PK11SDR_Decrypt” to parse saved credentials in the file, “logins.json”. Below is a piece of\ndata from “logins json”\n\n\n-----\n\n```\n{ id :5, hostname : https://api.twitter.com, httpRealm :null, formSubmitURL : https:/\n code**]ZrlGaGjQ\",\"encryptedPassword\":\"M1Doc8NAwcEiCH[**hide\ncode**]jwG+/I/0+lBje8WVoEska\",\"guid\":\"{24146e3a-321f-5e81-95d9-ab245208835f}\"\n\n```\nFinally, it saves the credentials in a format like IE’s.\n\n**3> Thread Parameter 3 for Google Chrome:**\n\nBefore the thread function is created, pwgrab32 makes two file backups of the files “Login\nData” and “Web Data”. Both of them are located in the\n\"%LocalAppData%\\Google\\Chrome\\User Data\\Default\\” folder. Chrome stores the login\ncredentials of the victim in the file “Login Data”, and saved autofill and credit card information\nis stored in the file “Web Data”. It makes a backup of the two files so it can read data from\nbackup files instead of the original files to avoid a reading conflict when the victim is using\nChrome. The two backup files are “Login Data.bak” and “Web Data.bak”. They are both\nSQLite database files.\n\n[“pwgrab32” uses the open source project SQLite database engine to handle the two SQLite](https://www.sqlite.org/index.html)\nfiles. In Figure 9, you can see that the data of the SQLite database engine is linked in\n“pwgrab32”.\n\nFigure 9. SQLite database engine’s code\n\nNext, “pwgrab32” executes an SQL expression like \"select origin_url, username_value,\n_password_value, length(d_value) from logins where blacklisted_by_user = 0\" to obtain the_\ncredentials from “Login Data.bak”.\n\n“pwgrab32” continues to execute three SQL expressions to grab autofill information, credit\ncard information, email address, country, company, street address, full name, phone number,\netc. from “Web Data.bak”.\n\nThe SQL expressions are decrypted from three local variables:\n\n\n-----\n\n```\n SELECT name, value FROM autofill WHERE name<> cd[Meta] AND name<> cd[OpenGraph] \nAND name<>\"cd[Schema.org]\" AND name<>\"cd[DataLayer]\" AND name<>\"cd[buttonFeatures]\"\nAND name<>\"cd[buttonText]\" AND name<>\"cd[formFeatures]\" ORDER BY name; “\n“SELECT expiration_month, expiration_year, card_number_encrypted, use_date, origin\nFROM credit_cards ORDER BY origin;”\n“SELECT profiles.origin, profiles.company_name, profiles.street_address,\nprofiles.city, profiles.state, profiles.zipcode, profiles.country_code\n,profiles.language_code, emails.email, names.first_name, names.middle_name,\nnames.last_name, names.full_name, phones.number FROM autofill_profiles AS profiles\nINNER JOIN autofill_profile_emails AS emails ON(profiles.guid = emails.guid) INNER\nJOIN autofill_profile_names AS names ON(profiles.guid = names.guid) INNER JOIN\nautofill_profile_phones AS phones ON(profiles.guid = phones.guid); “\n\n```\nThe grabbed credentials and form autofill information collected from the browsers is sent to\nthe C&C server immediately when one is done.\n\nNext, I’ll discuss the packet format and how it’s sent to its C&C server in the “Report\nCredentials” section below.\n\n**pwgrab32 Collects Credentials from some Clients**\n\nAfter all of the three threads above are finished, “pwgrab32” steals credentials from three\nclient software sources: “Outlook”, “FileZilla”, and “WinSCP”. In Figure 10 you can see the\nfunctions being called to collect credentials from them.\n\nFigure 10. Functions to collect credential from Outlook, FileZilla and WinSCP\n\n“Outlook”’s profile is stored in the system registry. According to different versions, its registry\npaths are \"HKCU\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows Messaging\n_Subsystem\\Profiles\\Outlook\",_\n\n\"HKCU\\Software\\Microsoft\\Office\\15.0\\Outlook\\Profiles\\Outlook\" and\n\n\"HKCU\\Software\\Microsoft\\Office\\16.0\\Outlook\\Profiles\\Outlook\".\n\n“pwgrab32” then goes through all the keys and reads and parses the values to grab the\ncredentials.\n\nFigure 11 shows an Outlook credential grabbed by “pwgrab32” from my test system. The\nformat is “Host|Account name|Password”.\n\nFigure 11. Grabbed credentials from Outlook\n\n\n-----\n\nFileZilla is an FTP client software that stores its history as plain text in file\n\"%APPDATA%\\\\filezilla\\\\recentservers.xml\", and stores its login data as plain text in file\n\"%APPDATA%\\\\filezilla\\\\sitemanager.xml\". “pwgrab32” can easily obtain their history records\nand credentials by parsing these two XML files.\n\nWinSCP is another FTP client software. Its credentials are stored in the system registry\nunder the registry path “HKCU\\Software\\Martin Prikryl\\WinSCP 2\\Sessions\\”. “pwgrab32” can\ngrab its credentials by enumerating all of the sub-keys and reading out their values\n“HostName”, “PortNumber”, “UserName”, “Password”, and “FSProtocol”.\n\n**Report Credentials**\n\nTrickbot has many C&C commands. I have talked about these commands in detail in my\n[previous blog.](https://www.fortinet.com/blog/threat-research/deep-analysis-of-the-online-banking-botnet-trickbot.html)\n\nIn module “pwgrab32”, however, I observed that it has new command numbers: 81 and 83.\n\nCommand 81 is for reporting grabbed credentials of Browsers, FTP clients, and Outlook.\n\nCommand 83 is for reporting grabbed form autofill information from Google Chrome.\n\nIt uses HTTP POST method to report the plain text credentials to the C&C server.\n\nThe POST URI format is like this:\n\n_POST /[group tag]/[Client_ID]/[Command number]/_\n\nThe body part is the grabbed credentials or form autofill information in plain text.\n\n“group tag” is “auto1”.\n\n“Client_ID” is generated with the computer name, Windows version and random string.\n\nFigure 12 shows reporting “chrome password” using command 81.\n\nFigure 13 shows reporting “chrome autofill information” using command 83.\n\nFigure 12. Report grabbed credential data from Chrome\n\nFigure 13. Report form autofill data from Chrome\n\nBelow is an IP list of the C&C servers that are used to handle the credential data. The IP list\nwas decrypted by “pointes.exe” from the file “dpost”, and was passed to “pwgrab32” by\ncalling the API WriteProcessMemory. Calling the API EnumDpostServer(fun_index) of coreparser.dll, we can get one IP of them by using the fun_index.\n\n_<dpost>_\n\n\n-----\n\n_<handler>http://173.171.132.82:8082</handler>_\n\n_<handler>http://66.181.167.72:8082</handler>_\n\n_<handler>http://46.146.252.178:8082</handler>_\n\n_<handler>http://97.88.100.152:8082</handler>_\n\n_<handler>http://174.105.232.193:8082</handler>_\n\n_<handler>http://23.142.128.34:80</handler>_\n\n_<handler>http://177.0.69.68:80</handler>_\n\n_<handler>http://5.228.72.17:80</handler>_\n\n_<handler>http://174.105.232.193:80</handler>_\n\n_<handler>http://177.0.69.68:80</handler>_\n\n_<handler>http://23.226.138.220:443</handler>_\n\n_<handler>http://23.226.138.196:443</handler>_\n\n_<handler>http://23.226.138.221:443</handler>_\n\n_<handler>http://92.38.135.151:443</handler>_\n\n_<handler>http://198.23.252.204:443</handler>_\n\n_</dpost>_\n\n**Solutions**\n\n\"hxxp://excel-office.com/secure.excel \" is rated as Malicious Websites by the FortiGuard\nWebfilter service, and Sep_report.xls is detected as VBA/Agent.JHAZ!tr.dldr and\npointer.exe as W32/GenKryptik.COMA!tr by the FortiGuard Antivirus service.\n\n**How to remove this malware:**\n\n1) Open Task Scheduler and go to Task Scheduler(Local) -> Task Scheduler Library\n\n2) Select the item named “Msnetcs”, press the Delete key, and then click Yes.\n\n3) Restart your system and delete the entire folder of %AppData%\\VsCard.\n\n**IoC**\n\n**URL:**\n\n\n-----\n\nhxxp://excel-office.com/secure.excel\n\n**Sample SHA256:**\n\n[Sep_report.xls]\n\n41288C8A4E58078DC2E905C07505E8C317D6CC60E2539BFA4DF5D557E874CDEC\n\n[secure.excel] or [pointer.exe] or [pointes.exe]\n\nD5CADEF60EDD2C4DE115FFD69328921D9438ACD76FB42F3FEC50BDAAB225620D\n\n**Reference**\n\nhttps://www.fortinet.com/blog/threat-research/deep-analysis-of-the-online-banking-botnettrickbot.html\n\nhttps://www.fortinet.com/blog/threat-research/new-trickbot-plugin-harvests-email-addressesfrom-sql-servers-screenlocker-module-not-for-ransom.html\n\nhttps://blog.malwarebytes.com/threat-analysis/2017/08/trickbot-comes-with-new-tricksattacking-outlook-and-browsing-data/\n\nhttps://www.webroot.com/blog/2018/03/21/trickbot-banking-trojan-adapts-new-module/\n\nhttps://blog.trendmicro.com/trendlabs-security-intelligence/trickbot-shows-off-new-trickpassword-grabber-module/\n\n_[Sign up for our weekly FortiGuard Threat Brief.](https://www.fortinet.com/fortiguard/threat-intelligence/threat-research.html?utm_source=nreleaseblog&utm_campaign=2018-q2-fortiguardlabs-cta)_\n\n_Know your vulnerabilities – get the facts about your network security. A_ _Fortinet Cyber Threat_\n_Assessment can help you better understand: Security and Threat Prevention, User_\n_Productivity, and Network Utilization and Performance._\n\n## Related Posts\n\nCopyright © 2022 Fortinet, Inc. All Rights Reserved\n\n[Terms of ServicesPrivacy Policy](https://www.fortinet.com/corporate/about-us/legal.html)\n| Cookie Settings\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-11-08 - Deep Analysis of TrickBot New Module pwgrab.pdf"
    ],
    "report_names": [
        "2018-11-08 - Deep Analysis of TrickBot New Module pwgrab.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535911,
    "ts_updated_at": 1743041155,
    "ts_creation_date": 1653821160,
    "ts_modification_date": 1653821160,
    "files": {
        "pdf": "https://archive.orkl.eu/e0c137b04899ffd7d78fb22fdf0bca83c644b48d.pdf",
        "text": "https://archive.orkl.eu/e0c137b04899ffd7d78fb22fdf0bca83c644b48d.txt",
        "img": "https://archive.orkl.eu/e0c137b04899ffd7d78fb22fdf0bca83c644b48d.jpg"
    }
}