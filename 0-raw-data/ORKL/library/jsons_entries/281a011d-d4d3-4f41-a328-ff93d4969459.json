{
    "id": "281a011d-d4d3-4f41-a328-ff93d4969459",
    "created_at": "2023-01-12T15:08:20.065881Z",
    "updated_at": "2025-03-27T02:16:25.86526Z",
    "deleted_at": null,
    "sha1_hash": "c763dfce277e2c5f7ba5874b3e24999d057380d6",
    "title": "2022-04-05 - Incident report- From CLI to console, chasing an attacker in AWS",
    "authors": "",
    "file_creation_date": "2022-05-27T21:09:00Z",
    "file_modification_date": "2022-05-27T21:09:00Z",
    "file_size": 567670,
    "plain_text": "# Incident report: From CLI to console, chasing an attacker in AWS\n\n**[expel.com/blog/incident-report-from-cli-to-console-chasing-an-attacker-in-aws/](https://expel.com/blog/incident-report-from-cli-to-console-chasing-an-attacker-in-aws/)**\n\nApril 5, 2022\n\nRecently, our SOC detected unauthorized access into one of our customer’s Amazon Web\nServices (AWS) environments. The attacker used a long-term access key to gain initial\naccess. Once they got in, they were able to abuse the AWS Identity and Access\nManagement (IAM) service to escalate privileges to administrative roles and create two new\nusers and access keys — creating a foothold in their environment. However, we stopped\nthem before the attacker was able to get any further.\n\nIn this post, we’ll walk you through how we spotted unauthorized access, the investigative\nsteps we took to understand what the attacker did in AWS, and share our lessons learned\nand key takeaways from the incident.\n\n## Quick background\n\nBefore we tell you how it went down, for this customer we’re ingesting AWS CloudTrail logs\nand applying our own custom detections. This customer did not have AWS GuardDuty\nenabled for their monitored AWS accounts — nor did we have any visibility beyond the AWS\ncontrol plane.\n\n## Our initial lead\n\nOur first clue into the incident was an AWS alert based on CloudTrail logs for a console login\nfrom an IAM user originating from an atypical country.\n\nFrom the AWS alert (screenshot below), our SOC was able to extract the following details\nabout the console login:\n\nThe authentication originated from Indonesia\nThe type of AWS account was an IAM user\nMulti-factor authentication (MFA) was not used for the authentication\n\n\n-----\n\nThe details about the AWS console login prompted our SOC to ask the following questions:\n\nDoes this IAM user typically login from Indonesia?\nWhy is this IAM user authenticating to the console directly and not via an identity\nprovider?\nWhy wasn’t MFA used?\n\nThese questions combined certainly raised our suspicion.\n\nSOC pro-tip: IAM accounts typically have long-term access keys associated with them. You’ll\nsee these long-term access keys start with “AKIA.” Most of the AWS incidents we detect\nwere the result of a publicly exposed long-term access key.\n\nThe first step in our investigative process was to understand what happened after the\n[successful AWS console login. We used one of our bots, Ruxie™, to gain some more insight.](https://expel.com/buy/managed-detection-response/)\nAs a quick refresher, our robot Ruxie (yes – we give our robots names) automates\ninvestigative workflows to surface up more details to our analysts.\n\nWe used Ruxie to list the most recent interesting API calls from the AWS account in the initial\nlead (interesting in this context is mostly anything that isn’t Get*, List*, Describe*, and\nHead*). API calls that are sometimes associated with attacker activities in AWS are\nhighlighted in orange. We highlight these actions in orange to provide a visual cue to our\nanalysts that something may be amiss here.\n\n\n-----\n\nThe list of API calls returned by Ruxie showed us that the source IP address associated with\n[the atypical console login also issued API calls to CreateUser,](https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateUser.html) [CreateAccessKey, and](https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateAccessKey.html)\n[AttachUserPolicy. For the AWS defenders out there, it’s important to note that AWS accounts](https://docs.aws.amazon.com/IAM/latest/APIReference/API_AttachUserPolicy.html)\n[are assigned temporary access keys when authenticating to the AWS console (these access](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_identifiers.html#identifiers-unique-ids)\nkeys typically start with “ASIA”).\n\nNow this activity really has our attention. But why?\n\nThe CreateUser API call is used to create a new IAM user. The CreateAccessKey API call\ncreates a new long-term access key for a specific user. AttachUserPolicy attaches a\nspecified policy to a specified user.\n\nTherefore, an attacker can use these API calls to:\n\nCreate a new IAM user\nCreate a new long-term access key for the user\nAttach a highly privileged policy to the user for elevated access\n\nThis series of API calls can give an attacker persistent and elevated access in an AWS\nenvironment — yep, this activity certainly has our attention.\n\nThe next question our SOC asked was, “where does this IAM user typically authenticate\nfrom?” Ruxie to the rescue. Ruxie provided our analysts with a list of login activity by region\nand frequency for the IAM user listed in our lead alert.\n\nBottom line? Logins from Indonesia are highly suspicious.\n\n\n-----\n\nRecently authenticated regions Ruxie action for the source IAM user\nOK, so at this point we have an IAM user logging in to the AWS console, from a location\nwe’ve confirmed is atypical, and that account is issuing API calls to create new users, longterm access keys, and to attach highly privileged policies to users for elevated access.\n\nAt this point our SOC declared an incident, issued a recommendation to our customer to\nreset the (arn:aws:iam::123456789012:user/comp_user1) account credentials, and in\nparallel began working to answer:\n\nHow did the attacker obtain AWS console creds?\nWhat else did the attacker do in AWS?\n\n## How did the attacker obtain AWS console creds?\n\nThe next step in our investigative process was to get a more detailed timeline of all AWS API\ncalls issued by the source IP address associated with the lead alert for the console login.\nThis investigative step helps us better understand the actions performed by the attacker.\n\nAPI calls in AWS triage timeline\n[When examining the detailed timeline of API calls, the attacker first issued a ListUsers API](https://docs.aws.amazon.com/IAM/latest/APIReference/API_ListUsers.html)\ncall using the arn:aws:iam::123456789012:user/comp_user2 IAM user from the AWS\ncommand line interface (aws-cli). Note that this is a different IAM user from the lead alert. We\ninferred the arn:aws:iam::123456789012:user/comp_user2 IAM user was also\ncompromised since the API call originated from the same IP address recorded in the console\nlogin. More on this in a second.\n\n\n-----\n\nNext, the attacker issued two calls to the [UpdateLoginProfile API; one for the](https://docs.aws.amazon.com/IAM/latest/APIReference/API_UpdateLoginProfile.html)\n**arn:aws:iam::123456789012:user/comp_user1 IAM user (succeeded) and one for the**\n**arn:aws:iam::123456789012:user/comp_user2 IAM user (failed with the**\nNoSuchEntityException reason).\nFinally, CloudTrail logs recorded a ConsoleLogin from the\n**arn:aws:iam::123456789012:user/comp_user1 account.**\n\nSo as a quick recap, our investigation revealed the attacker took the following steps to gain\naccess to the AWS console:\n\nUsed the AWS access keys for arn:aws:iam::123456789012:user/comp_user2 to\nissue a ListUsers API call.\n\nThe results of the ListUsers API call returned\n**arn:aws:iam::123456789012:user/comp_user1 in the results.**\nIssued an API call to UpdateLoginProfile to change the AWS console password for the\n**arn:aws:iam::123456789012:user/comp_user1 account.**\nAuthenticated into the AWS console using the\n**arn:aws:iam::123456789012:user/comp_user1 account.**\n\nIt’s our working theory that the AWS access keys for the\n**arn:aws:iam::123456789012:user/comp_user2 account were discovered by the attacker in**\na publicly available code repository.\n\n## What else did the attacker do in AWS?\n\nSOC pro-tip: At this point in our investigation, CloudTrail logs indicate the attacker has\naccess to the AWS console for this customer. Therefore, we’re expecting to see attacker\nactivity recorded from different IP addresses associated with AWS. (Don’t exclude these in\nyour search!)\n\nImmediately following the authentication to the AWS console, the attacker issued the\nfollowing API calls:\n\nCreateUser\nCreateAccessKey\nAttachUserPolicy\n[CreateLoginProfile](https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateLoginProfile.html)\n\nThis allowed the attacker to create two new IAM users with accompanying long-term access\nkeys and attached a policy that allowed one of the new users to create and change their\nAWS console password. For one of the newly created IAM user accounts, the attacker\n[issued an AttachUserPolicy API call to attach an AdministratorAccess policy to the newly](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_job-functions.html#jf_administrator)\ncreated IAM user — allowing the attacker to elevate their privileges in AWS.\n\n\n-----\n\nLastly, the attacker used one of the newly created IAM users to make a call to the\n[RequestServiceQuotaIncrease API in order to increase the EC2 quota. It’s our opinion that](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/service-quotas/request-service-quota-increase.html)\nthis action was taken in preparation for starting multiple large EC2 instances for\ncryptocurrency mining. It is at this point that we worked with the customer to begin\nremediation.\n\nCrisis averted!\n\nHere’s the final play-by-play of the actions taken by the attacker in AWS mapped to the\nMITRE ATT&CK framework:\n\nMITRE tactics mapped to AWS API calls\nYou can check out additional AWS API calls we’ve seen associated with attacker activity in\nour [AWS mind map.](https://expel.io/blog/mind-map-for-aws-investigations/)\n\n## Remediation in AWS\n\nWith the scope of the compromise understood, we provided our customer with the following\nremediation recommendations:\n\n1. Delete the two created accounts and accompanying access keys for\n\n**arn:aws:iam::123456789012:user/created_user1 and**\n**arn:aws:iam::123456789012:user/created_user2**\n2. Deactivate the long term access keys associated with the\n\n**arn:aws:iam::123456789012:user/comp_user1 and**\n**arn:aws:iam::123456789012:user/comp_user2 IAM users**\n3. Reset the AWS console password for the\n\n**arn:aws:iam::123456789012:user/comp_user1 and**\n**arn:aws:iam::123456789012:user/comp_user2 IAM users**\n\nWe also recommended that the customer ensure AWS access keys are not being\naccidentally released to the public and implement least privilege with regards to AWS users.\nAdditionally, we recommended the customer implement MFA for IAM user AWS console\nauthentications.\n\n\n-----\n\n## Lessons learned\n\nWhat stood out the most in this incident was the attacker’s technique to use an exposed\nlong-term access key to gain access to the AWS console — potentially for ease of access\nand persistence. Simply put, the attacker wants to go from the aws-cli to the AWS console.\nTo achieve this, the attacker issued API calls UpdateLoginProfile or CreateLoginProfile from\nan IAM user. We now have a detection based on CloudTrail logs that alerts our SOC anytime\nwe see these specific API calls originating from an IAM user where the User-Agent is the\naws-cli. We’ve added some additional logic to reduce benign noise associated with AWS IP\naddresses.\n\nWe’re also exploring additional detections based on CloudTrail logs where we see newly\n[created IAM users issue API calls to RequestServiceQuotaIncrease to increase the EC2](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/service-quotas/request-service-quota-increase.html)\nquota. This could be a signal of potential unauthorized activity in EC2.\n\nWhile we detected unauthorized activity early in the attack lifecycle, we’re a learning\norganization and always looking for opportunities to improve our detection and response\ncapabilities in AWS.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-05 - Incident report- From CLI to console, chasing an attacker in AWS.pdf"
    ],
    "report_names": [
        "2022-04-05 - Incident report- From CLI to console, chasing an attacker in AWS.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536100,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1653685740,
    "ts_modification_date": 1653685740,
    "files": {
        "pdf": "https://archive.orkl.eu/c763dfce277e2c5f7ba5874b3e24999d057380d6.pdf",
        "text": "https://archive.orkl.eu/c763dfce277e2c5f7ba5874b3e24999d057380d6.txt",
        "img": "https://archive.orkl.eu/c763dfce277e2c5f7ba5874b3e24999d057380d6.jpg"
    }
}