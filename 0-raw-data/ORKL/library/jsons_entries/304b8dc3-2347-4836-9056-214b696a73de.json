{
    "id": "304b8dc3-2347-4836-9056-214b696a73de",
    "created_at": "2023-01-12T15:03:58.667153Z",
    "updated_at": "2025-03-27T02:06:00.617392Z",
    "deleted_at": null,
    "sha1_hash": "6de9a17ede5a06ede4951ba8dabe5107ac82ed4c",
    "title": "2021-02-01 - Trickbot masrv Module",
    "authors": "",
    "file_creation_date": "2022-05-28T23:08:46Z",
    "file_modification_date": "2022-05-28T23:08:46Z",
    "file_size": 856146,
    "plain_text": "# TrickBot masrv Module\n\n**kryptoslogic.com/blog/2021/02/trickbot-masrv-module/**\n\n[Authored by: Kryptos Logic Vantage Team on Monday, February 1, 2021](https://twitter.com/kryptoslogic)\n\nTags: [TrickBot](https://www.kryptoslogic.com/blog/tag/trickbot)\n\n## Overview\n\nActive since 2016, TrickBot is one of the most prevalent modular banking trojans. The botnet’s modules\ncarry out objectives such as credential harvesting, propagating via the network, web injection and others.\nBeing an actively developed botnet, we often come across updated modules and in some cases new\ntools that are added as part of its arsenal.\n\nRecently we have discovered a relatively new module that goes by the name `masrv . The module is a`\n[network scanner that incorporates the Masscan open-source tool. Additionally, the module contains an](https://github.com/robertdavidgraham/masscan)\nunreferenced Anchor C2 communication function and a list of hardcoded IPs which have previously been\nassociated with Anchor and Bazar 12.\n\nWe believe this module is used as one of TrickBot’s network reconnaissance tools to gather more\ninformation about the victim’s network.\n\n## The masrv module\n\nThe module arrives as either a 32-bit or 64-bit DLL, depending on the Windows OS version of the victim\nmachine the bot is running on. Both DLLs we observed are debug builds and log their execution into\nstandard output.\n\n\n-----\n\nAs with other TrickBot modules, the module is executed via its export functions `Start and` `Control .`\n\n## Commands for the Module’s C2\n\nThe module makes requests to the C2 to receive information that it requires to pass as parameters to\nMasscan.\n\n**Command** **HTTP Method** **Description**\n\n81 POST send results\n\nfreq GET Get frequency for running Masscan\n\ndomains GET Get a List of IP address ranges followed by port range\n\nover GET Signal to the C2 that scan is complete\n\nrate GET Get rate value for transmitting packets\n\nnpcap.exe GET Get Nmap’s packet sniffing library installer\n\nThe URI construction for the GET requests follows this format:\n```\nhttp://<c2>:<port>/<gtag>/<botID>/mass/<command_string>\n\n```\n`gtag - The Campaign ID that is seen in the config4` present in the main bot.\n```\n   botID - The Bot ID created in the victim machine by the main bot.\n   command_string - One of the string commands from the above table.\n\n```\nAt the time of researching this module, we were unable to pull down the config associated with `masrv .`\nSo, in order to observe a dynamic run, we have implemented a mock server on `localhost at port`\n```\n8080, to be able to feed responses back to the module. Below is an example of one of the GET request\n\n```\nbeing made for the command `freq .`\n\n**Network capture of the Module traffic**\n\n## Information Gathering\n\nAt first, the module makes GET requests for information from the commands `freq,` `domains and`\n```\nrate . If successful, the module executes Masscan’s main function routine which is compiled within the\n\n```\nDLL. Below we can see the execution result of the log from standard output. The date mentioned in the\n\n\n-----\n\nlogs is that of when the module was compiled.\n```\nSendEvent(VERS, MASS scanner build Dec 4 2020 13:19:27 started)\nExecute Control(masrv) CtlArg=127.0.0.1:8080\nSend cmd to server: freq\nResponse buf: 1\nHTTP message success: URI=127.0.0.1:8080/mor2/JOHNPC_W617601.CC081DEDCA3EE2CECFA265AF5C904BF3/mass/freq DATA=1\nSendEvent(DBG, Successfully executed command: freq)\nSend cmd to server: domains\nResponse buf: 127.0.0.0/16\n80-81,53\nHTTP message success: URI=127.0.0.1:8080/mor2/JOHNPC_W617601.CC081DEDCA3EE2CECFA265AF5C904BF3/mass/domains DATA=127.0.0.0/16\n80-81,53\nSendEvent(DBG, Successfully executed command: domains)\nSend cmd to server: rate\nResponse buf: 1000\nHTTP message success: URI=127.0.0.1:8080/mor2/JOHNPC_W617601.CC081DEDCA3EE2CECFA265AF5C904BF3/mass/rate DATA=1000\nSendEvent(DBG, Successfully executed command: rate)\n\n```\nThe Masscan tool has its own network stack and doesn’t rely on that of the OS. In order for it to be able to\nretrieve the results, Masscan requires a low-level packet filter and on a Windows OS it attempts to load\n```\nNPcap\\Packet.dll . If Packet.dll doesn’t exist, then the module makes a request to download the\nNPcap executable from the C2. NPcap is silently installed on the machine by passing the parameter\n/S . It gets executed by invoking CreateProcessA or ShellExecuteExA (if the first API is\n\n```\nunsuccessful).\n\nThe Masscan tool also attempts to initialize the network adapter. If the tool fails to detect any interface, a\nmodule-specific function is called that tries to get a MAC address from the ARP table, to pass to Masscan\nas `--router-mac <mac> . For each ARP entry in the` `MIB_IPNETTABLE,5` the module finds the\ncorresponding index of the IPv4 entry in the `MIB_IPADDRTABLE .6` It leverages the APIs `GetIpNetTable`\nand `GetIpAddrTable respectively to retrieve this information. If successful, it gets the dotted-decimal`\nformat of the IPv4 address and logs the results of the `ping command that is run on the target` `8.8.8.8`\nfrom that IPv4 address. If the ping ran successfully, the module gathers the ARP type information and\nlogs the ARP entry of the IPv4 address. Then it queries for the MAC address from the `MIB_IPNETROW`\nentry. Below is an example of the `ping command.`\n```\nping 8.8.8.8 -S 127.0.0.1\n\n```\nThe module sends results from the Masscan run if it has discovered open ports on any of the IP ranges\nthat were provided. Results are aggregated by calling a module-specific function from the Masscan\nfunction `output_report_status which adds discovered ports to a global string. These results are`\nposted back (via the `81 message) regularly, with the frequency, in seconds, determined by the` `freq`\nvalue queried at the beginning.\n\n\n-----\n\n**POST Request**\n\n## Anchor/Bazar reference\n\nBoth the 32-bit and 64-bit DLLs have an unreferenced function that share similarities to Anchor’s C2\ncommunication subroutine. It is not uncommon for this actor to be seen sharing code between its toolset.\nAdditionally, this function references a list of hardcoded IPs from the binary which have previously been\nassociated with both Anchor and Bazar.\n\n\n-----\n\n```\n5 [ ] 5 [ ] 5[ ] 5\n193[.]183[.]98[.]66\n91[.]217[.]137[.]37\n87[.]98[.]175[.]85\n185[.]121[.]177[.]177\n169[.]239[.]202[.]202\n198[.]251[.]90[.]143\n5[.]132[.]191[.]104\n111[.]67[.]20[.]8\n163[.]53[.]248[.]170\n142[.]4[.]204[.]111\n142[.]4[.]205[.]47\n158[.]69[.]239[.]167\n104[.]37[.]195[.]178\n192[.]99[.]85[.]244\n158[.]69[.]160[.]164\n46[.]28[.]207[.]199\n31[.]171[.]251[.]118\n81[.]2[.]241[.]148\n51[.]254[.]25[.]115\n82[.]141[.]39[.]32\n50[.]3[.]82[.]215\n46[.]101[.]70[.]183\n5[.]45[.]97[.]127\n130[.]255[.]78[.]223\n144[.]76[.]133[.]38\n139[.]59[.]208[.]246\n172[.]104[.]136[.]243\n45[.]71[.]112[.]70\n163[.]172[.]185[.]51\n87[.]98[.]175[.]85\n5[.]135[.]183[.]146\n\n## Conclusion\n\n```\nThis new module is an indication of the actor’s continued investment in improving their network\nreconnaissance toolkit, even after recent disruption efforts .7 We provide some IOCs and a YARA rule\nrelated to this module below.\n\n## IOCs\n\nPDB paths:\n```\nD:\\Project\\masrv\\build-masrv\\debug\\Desktop_msvc_15_0_32bit\\masrv.pdb\nD:\\Project\\masrv\\build-masrv\\debug\\Desktop_msvc_15_0_64bit\\masrv.pdb\n\n```\n**Module**\n**Name** **SHA256** **Description**\n\nmasrvDll32 2c29de91a5be3bffafb521e04b88819d23c6f71843c8f2d54516ec2afefd24c6 32-bit DLL\n\nmasrvDll64 e1c5a377450d04372bfe9d943d322fbdd53c274c3772836eb044fd2a4b08a870 64-bit DLL\n\n## YARA\n\n\n-----\n\n```\n u e c ot__ as\n{\n  meta:\n    id = \"4kWjG0InTDyHiur8cCzPeG\"\n    fingerprint = \"3e91c19602340a43e026ffdb23b1d6a0c4e186d67f743e962c75aa51ea0c4d1c\"\n    version = \"1.0\"\n    first_imported = \"2021-01-29\"\n    last_modified = \"2021-01-29\"\n    status = \"RELEASED\"\n    sharing = \"TLP:WHITE\"\n    source = \"KRYPTOS LOGIC\"\n    description = \"Detects TrickBot masrvDll module\"\n    category = \"MALWARE\"\n    malware = \"BOT\"\n  strings:\n    $a = \"http://127.0.0.1:8080/gid/uid/pcap.exe\"\n    $b = \"c:\\\\\\\\temp\\\\\\\\maserv.txt\"\n    $c = \"Send cmd to server: %s\\\\r\\\\n\"\n    $d = \"HTTP message success: URI=%s DATA=%.*s\\\\r\\\\n\"\n  condition:\n    all of them\n}\n\n## References\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-02-01 - Trickbot masrv Module.pdf"
    ],
    "report_names": [
        "2021-02-01 - Trickbot masrv Module.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535838,
    "ts_updated_at": 1743041160,
    "ts_creation_date": 1653779326,
    "ts_modification_date": 1653779326,
    "files": {
        "pdf": "https://archive.orkl.eu/6de9a17ede5a06ede4951ba8dabe5107ac82ed4c.pdf",
        "text": "https://archive.orkl.eu/6de9a17ede5a06ede4951ba8dabe5107ac82ed4c.txt",
        "img": "https://archive.orkl.eu/6de9a17ede5a06ede4951ba8dabe5107ac82ed4c.jpg"
    }
}