{
    "id": "81e7e9c4-ccf1-48d5-9390-d86d609cb001",
    "created_at": "2023-02-02T02:08:34.00099Z",
    "updated_at": "2025-03-27T02:09:07.289739Z",
    "deleted_at": null,
    "sha1_hash": "5465c6ad851d83d704a31502d0dead4e252f8fa2",
    "title": "2023-01-18 - A long way to SectopRat",
    "authors": "",
    "file_creation_date": "2023-02-01T07:49:11Z",
    "file_modification_date": "2023-02-01T07:49:11Z",
    "file_size": 162211,
    "plain_text": "# A long way to SectopRat\n\n**[medium.com/@gi7w0rm/a-long-way-to-sectoprat-eb2f0aad6ec8](https://medium.com/@gi7w0rm/a-long-way-to-sectoprat-eb2f0aad6ec8)**\n\nGi7w0rm January 23, 2023\n\n[Gi7w0rm](https://medium.com/?source=post_page-----eb2f0aad6ec8--------------------------------)\n\nJan 18\n\n\n11 min read\n\n## Investigating a highly obfuscated stealer sample\n\nHello there, welcome back to another block post. To my disappointment, it has been a while.\nLife can be very busy. But I am happy to be back. This time, with a rather “small” story about\na malware reverse engineering safari, which started around 4 days ago and got so\ninteresting, that I thought I should share it.\n\nIt all started back on Saturday, 14 January 2023 on Twitter, where I received a direct\n[message from a fellow security researcher grep_security.](https://twitter.com/grep_security)\n\n[He had seen my post about the Raccoonv2 C2 list which I had shared the day before and](https://github.com/Gi7w0rm/MalwareConfigLists/tree/main/Raccoon_v2)\nobserved an IP in the list, which was right in the neighborhood of an IP he had observed for\nsome time\n\n\n-----\n\nFigure 1 - The message that got it all started\nCurious, I took a look at the IP he shared. The Url led to the following Directory Listing, which\nat the time of writing is still up and running:\n\nFigure 2 — OpenDir with “log_data”\nWell, it was not Raccoon_v2. But I was immediately convinced it was something bad. I had\n[seen such folders before with so-called stealer malware. The likes of](https://medium.com/@gi7w0rm/what-is-stealer-malware-65fd7c29516a) [Mars Stealer and](https://malpedia.caad.fkie.fraunhofer.de/details/win.mars_stealer)\n[AgentTesla are often found to have logs stored similarly. My interest was sparked and so I](https://malpedia.caad.fkie.fraunhofer.de/details/win.agent_tesla)\ndecided to take a deeper dig.\n\nFirst some reconnaissance about the IP:\n\nFigure 3 — OTX results for IP\nAs you can see the IP in question seems to be from a hosting network in Kazakhstan. And if\nyou look at the domain associated, you will see there are quite a lot of words and patterns\nbelonging to cryptocurrencies and the crypto ökosystem. “.exchange” domains, “/airdrop/” as\npath names, “layer zero” and “network” in one domain, etc. All with some sort of\nTyposquatting. This smelled phishy.\n\nAnd indeed, grep_security noticed that the whole /24 Subnet seems to be related to this kind\nof suspicious activity. Besides, there are several reported C2s for Infostealer malware in this\nSubnet. Among them RedLine, Raccoon, and others.\n\nBut neither RedLine nor Raccoon has the kind of OpenDir pattern we observed above. So\nlet's find out if there is malware related to our IP:\n\nFigure 4 — VirusTotal result (3rd sample was uploaded after initial analysis)\nAs you can see, 2 samples were observed reaching out to this IP:\n\nSample1:\nhttps://www.virustotal.com/gui/file/88b426437c97301982bf096306af1bde70caa0a9a99a6051\n4b31d0fa0ea64afd\n\nSample2:\nhttps://www.virustotal.com/gui/file/8a94861424eac30e36085d408100510a9af570f6dd61a4c6\n33d7e918e4317548\n\nFor the remaining article, we will be looking at Sample 1.\n\nFirst thing I always do: Detonate it in Trai.ge!\n\n## Behavioral Report\n\n### Have a look at the Hatching Triage automated malware analysis report for this sample, with a score of 10 out of 10.\n\n\n-----\n\ntria.ge\n\nAs you can see, it lights up like a Christmas tree. A collection of interesting artifacts can be\nobserved in the following image. Note that the Pastebin link shows a single IP which is called\nvia TCP after resolution. Also, note the TCP Port 15647 and the “PowerShell get-process”\ncalls for “avastui” and “avgui”. It will help to do attribution later on.\n\nFigure 6 — IoC Collection — Interesting artifacts marked in Red Circles\nAnother interesting thing is the legitimate jsc.exe which is part of the .Net Framework\nbehaves very strangely here, calling out to Pastebin, as well as to the 2 possible C2 Servers.\n\nAt this point, I decided to take a closer look at Sample 1. And before anything else, I\n[uploaded it to unpac.me in the hopes of some easy unpacking. And indeed, there were 3](https://www.unpac.me/results/8b910cb5-0dce-4110-a15b-a193d92be576#/)\nsamples unpacked:\n\nFigure 7 — 3 Binaries extracted from Sample1\nAs you can see, we are looking at 1 unknown PE file and 2 legitimate Microsoft-signed\nbinaries. One is psapi.dll and the other cachmgr.exe\n\nSadly, my reversing capabilities do not include Assembly yet, so this is where I ran into a\ndilemma. I had no idea what the unknown binary was doing and therefore I was at a dead\nend.\n\nBut there was more to this attack. So I just jumped this step and decided to look at the next\nstep. As you can see in Figure 6, after our malicious Sample gets executed, a folder named\n“SETUP_37419\" is created in the Users Temp folder. From there, Engine.exe gets executed,\nand shortly after we see a command-line task started with “cmd.exe /c cmd < 4”. Well, time\nto take a look at that folder and its contents:\n\nFigure 8 — Setup Folder Content\nThis is where things start to get more interesting because I can understand what I am\nseeing. 2 Images, 1 Executable, a .qsp file, and a Setup.txt file. At this time I didn’t know\nwhat a .qsp file is, so let's take a look at it with a text editor:\n\nFigure 9 — .qsp content\nThat's a lucky hit. What we can learn from here is that the file seems associated with\n[QSetup. The qsp file contains all instructions needed so that Engine.exe knows what it](https://www.pantaray.com/qsetup.html)\nshould execute on the System. It's even mentioned on the bottom of their webpage as the\n[software used to execute on the Customers device. Uploading Engine.exe to VirusTotal also](https://www.virustotal.com/gui/file/e6e73497e85e9ece4c92ac7d49e07b9d55e932ba2d9e5789b94b95a9841ee524/details)\nfurther confirms this theory. Furthermore, we see that the Directory “Temp/5col3ccv. tda/” is\nreferenced. Also, a list of Items is given: “.\\45”,”.\\4”, and “.\\7”. This also explains what our\ncmd command means:\n\n“cmd /c cmd < 4\" will probably execute whatever is contained in the file named 4.\n\n\n-----\n\nThe other 3 files, the 2 .bmp files, and the Setup.txt file are not very interesting. Both images\nare resources of the installer and the Setup.txt has the same content as the .qsp but in a\ndifferent format.\n\nSo next, let's take a look at the folder mentioned in the .qsp file:\n\nFigure 10–5col3ccv.tda Folder Content after Execution\nIf you are wondering where “.\\7\" is, we will get there. It gets changed during the Install\nprocess. But let's look at “./4” which is executed by cmd.\n\nUpon opening it, we are greeted by tons of gibberish:\n\nFigure 11 — Obfuscated CMD commands\nBut if you look at it closer you will notice that most of it is trash code, which is included to\nconfuse and only some of the Lines contain valid code. Basically, a String replacement\nwhere Set <very_long_random_string> = Char.\n\nAfter deobfuscating this, we get the following lines of cmd commands:\n\nFigure 12 — Deobfuscated CMD commands\nLet's try to understand the above script. The first thing that comes to the eye is the search for\nprocesses called “avastui” and “avgui” using the PowerShell get-process scriptlet. Both\nprocesses belong to the Avast AntiVirus Suite. If the Processes should be running, the script\nsets the Variable Champion.exe.pif to AutoIT3.exe, and the file ending of the file named “S”\nto “S.a3x”. This already foreshadows the next stage of this attack. Then, the Script creates a\nrandomly named directory (in Figure 10 you see it as 17473). It creates a file called\nChampion.exe.pif (Or AutoIt3, if Avast was found) in this random folder and pipes MZ into it.\nThen it searches a certain String in the file named “45”. If we look at “45\" in a HexEditor, we\nsee a bunch of binary data, where the string that is searched via findstr is appended to the\nbeginning. The flags /V and /R let findstr ignore the string and pipe everything except it into\nthe newly created file. Note the “>>” which will append the content rather than overwriting it.\n[The outcome? A perfectly valid PE file, which after some investigation proves to be a](https://www.virustotal.com/gui/file/237d1bca6e056df5bb16a1216a434634109478f882d3b1d58344c801d184f95d/detection)\nlegitimate AutoIT3 executable.\n\nThe script then moves the file “7” into the same random directory where the AutoIT3\nexecutable called Champion.exe.pif is. Thereby it gets renamed to “S” or “S.a3x” depending\non the AvastDetection. After that, “Champion.exe.pif” executes “S”. A ping to localhost is\nexecuted, probably to give the execution some time before the PowerShell script dies.\n\nSo our next goal is obvious: What exactly is “S” or “S.a3x”? And what does it do?\n\nWell, we know already it's probably an AutoIT Script. We also know there will be an\nexecution of “jsc.exe” next. But at the time I had no idea of the AutoIT file format. So after\nlooking at the “S” file and realizing I could not read anything in it because of the obfuscation,\nI decided to call for help via Twitter:\n\n\n-----\n\nAt that time I thought I was facing a .a3x file, so I thought it had been compiled in some\nway. Even after looking at “S” in a Text Editor, I had just understood gibberish and therefore I\nsaw my fears come true. However, some hours after this tweet I realized, that I was looking\nat a highly obfuscated “.au3\" file. Other than “.a3x”, “.au3” is not compiled but a readable\nscript. Still, the obfuscation was so strong that I wasn’t mad when some people started\nreacting to my post, telling me they would like to take a look at it.\n\n[At this point, I would like to give a huge thanks and shoutout to Hexacorn,](https://twitter.com/Hexacorn)\n[_EthicalChaos_,](https://twitter.com/_EthicalChaos_) [_theVIVI,](https://twitter.com/_theVIVI) [DidierStevens,](https://twitter.com/DidierStevens/) [richeyward,](https://twitter.com/richeyward) [luc4m, and especially dr4k0nia](https://twitter.com/luc4m)\n(who solved the riddle), because all stepped forward voluntarily in the last days, to help\nwith this ! I really appreciate seeing so many researchers who are willing to help and I\nam honored to have such a nice community on Twitter!\n\nSo what did I look at? Here is a little extract.\n\nFigure 13 — Obfuscated AutoIT Script\nThe script had 10255 lines in this style, the only thing sticking out was a blog of Hex data. It\nhas to be noted that the script had 0/64 detections at the time of submitting it to VT.\n\nI tried to extract the Hex Block and convert it to a binary, as this would be a common way of\nembedding a binary into a script file. However, I had no success.\n\nLuckily, others had more luck:\n\n[Both dr4konia and _EthicalChaos_ came up with a decryption method working the same as](https://twitter.com/dr4k0nia/status/1614691627376730112)\nthe “DoctrineDrama” in Figure13 which spans through the whole script:\n\nFigure 14 — Decryption Funktion\nWith the help of this function, Hexacorn was able to produce the first script which was slightly\nless obfuscated. However, it was still full of string replacements, which made it nearly\nunreadable. If you want to look at this and would like a little headstart, check out his version\n[here. I uploaded it to Triage as means of a file transfer.](https://tria.ge/230115-zbheqafh3x)\n\nAs you can see, the parts deobfuscated are function calls and imported libraries. This did\ngive further proof of a possible process injection through Process Hollowing:\n\nAs initially expected, the AutoIT script injected some code into the legitimate “jsc.exe”. This\ncode was then responsible to conduct the malicious activity. Besides, the script was also\nresponsible for the initial DNS Query that was observed.\n\nFigure 15 — Weird Ping\nIt was probably implemented for execution control.\n\n\n-----\n\nSadly, the AutoIT script proved to be too bulletproof to fully reverse it. Until now, none of the\nresearchers that took a look at it were able to archive full deobfuscation. (Please notify me if\nyou should manage to do it, and I will gladly add an Update to this post.)\n\nHowever, after a while, [dr4k0nia was able to dump the final payload!](https://twitter.com/dr4k0nia)\n\nI saw this as a big breakthrough, as we were able to dump the final stage of this attack, a\n.Net binary with the Sha-256 Hash:\n[“a835602db71a42876d0a88cc452cb60001de4875a5e91316da9a74363f481910\"](https://bazaar.abuse.ch/sample/a835602db71a42876d0a88cc452cb60001de4875a5e91316da9a74363f481910/)\n\nHowever, we soon learned that the binary was strongly obfuscated using flow-dependent\nmutations and flow-dependent variables which made the important parts nearly unreadable.\nHowever, upon opening the file in DNSpy, some important functions could be recovered,\nwhich made it possible to determine the nature of the file:\n\nFigure 16 — Stealer == True\nFrom the function names and some other artifacts, it's clear that we are looking at a\nCredential Stealer. It fingerprints the system and then steals as much sensitive data as\npossible. Just as we expected.\n\nWe also see the creation of a TCP Client, which is used for C2 Communication:\n\nFigure 17 — TCP Client\nA [string dump was released by dr4konia. A slightly cleaned-up version by me can be found](https://pastebin.com/raw/pjBNEQDw)\n[here. It further proves the malicious nature of this binary.](https://github.com/Gi7w0rm/MalwareConfigLists/blob/main/strings_dump/Arechclient2.txt)\n\nAs we can’t fully deobfuscate the binary, we can not fully prove what Stealer this is. However,\nbased on several artifacts, I do believe we are dealing with a highly obfuscated Version of\nArechclient2/Sectop_Rat.\n\nFirst, ArechClient2 Detections which are based on the TCP Connection Init by ArechClient2\ndid hit on [VirusTotal. Second,](https://www.virustotal.com/gui/file/a835602db71a42876d0a88cc452cb60001de4875a5e91316da9a74363f481910/behavior) [MalwareBazaar also identifies it as ArechClient2. Prior](https://bazaar.abuse.ch/sample/a835602db71a42876d0a88cc452cb60001de4875a5e91316da9a74363f481910/#intel)\nAnalysis of this threat has shown very similar TTP: A connection via TCP/IP, a Connection to\nPort 15647, JSON-based communication, a connection attempt to eth0[.]me, even the\nStrings observed in the string dump by dr4konia, all align with this threat.\n\nFigure 18 — Old analysis left, our analysis string dump right\nSo, the reversing is done, the Threat is identified, and we are done, right?\n\nWell, not fully, there is some more info I would like to add.\n\nFirst of all, my initial goal in this analysis besides the identification of the threat was to\ndecrypt the log data accessible in the Open Directory mentioned in Figure 2. However, while\ndr4konia was able to uncover the AES Key used by our sample, it appears that the IV used\n\n\n-----\n\nis randomly generated and attached to the extracted data. This makes decryption of the data\nimpossible.\n\nSecondly, I initially thought this threat was shared via a crypto scam attack, based on the\nURLs associated with our initial IP address (77.73.133.81). However, after further research, I\ndiscovered that the Execution Parent of our Sample is actually a file called “obs-installersetupx64–29.685.zip”.\n\nThis shows that the sample is probably shared through one of the many Google Ads\nCampaigns which are currently ongoing, where threat actors register malicious websites,\nmake them appear like official software pages, and then lure victims into downloading\nmalicious software. These pages are often advertised through Google Ad Campaigns,\nallowing the Threat Actors to place their malicious sites right at the top of Google Searches\nfor the Software Product in question. And these campaigns prove to be successful. The\nOpenDirectory with the alleged LogData contained 18.158 individual files, meaning this actor\nalone has likely hacked more than 18000 victims.\n\nIT Security Researcher [Germán Fernández also noticed this connection and found 70](https://twitter.com/1ZRR4H)\ndomains associated with this threat.\n\nWell, I will leave it here for today. If you have read until here, I am glad you made it. I want to\ntake this opportunity to thank grep_security for reaching out with his question. It was a nice\nhunt and I am happy we made it. Thanks again to all the people who helped during this\ninvestigation.\n\n[If you haven't, please follow my Twitter for more awesome IT-Security content. Also follow](https://twitter.com/Gi7w0rm)\n[dr4k0nia,](https://twitter.com/dr4k0nia) [grep_security, and all the others mentioned above, they deserve it :)](https://twitter.com/grep_security)\n\n[For a list of IoC, please see this file on Github.](https://github.com/Gi7w0rm/MalwareConfigLists/blob/main/ArechClient2_SectopRat/TTPs.md)\n\nUntil next time!\n\nCheers\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-01-18 - A long way to SectopRat.pdf"
    ],
    "report_names": [
        "2023-01-18 - A long way to SectopRat.pdf"
    ],
    "threat_actors": [
        {
            "id": "dfee8b2e-d6b9-4143-a0d9-ca39396dd3bf",
            "created_at": "2022-10-25T16:07:24.467088Z",
            "updated_at": "2025-03-27T02:02:10.241387Z",
            "deleted_at": null,
            "main_name": "Circles",
            "aliases": [],
            "source_name": "ETDA:Circles",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1675303714,
    "ts_updated_at": 1743041347,
    "ts_creation_date": 1675237751,
    "ts_modification_date": 1675237751,
    "files": {
        "pdf": "https://archive.orkl.eu/5465c6ad851d83d704a31502d0dead4e252f8fa2.pdf",
        "text": "https://archive.orkl.eu/5465c6ad851d83d704a31502d0dead4e252f8fa2.txt",
        "img": "https://archive.orkl.eu/5465c6ad851d83d704a31502d0dead4e252f8fa2.jpg"
    }
}