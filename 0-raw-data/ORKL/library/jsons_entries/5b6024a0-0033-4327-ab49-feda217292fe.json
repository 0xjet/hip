{
    "id": "5b6024a0-0033-4327-ab49-feda217292fe",
    "created_at": "2022-10-25T16:48:19.516593Z",
    "updated_at": "2025-03-27T02:08:40.861481Z",
    "deleted_at": null,
    "sha1_hash": "5199ecac3bdeea3219a68a109e1ecd9b3c6452a6",
    "title": "bheu17_ppt_16x9",
    "authors": "",
    "file_creation_date": "2017-11-28T03:33:25Z",
    "file_modification_date": "2017-11-28T03:33:25Z",
    "file_size": 25935399,
    "plain_text": "## A Process is No One: Hunting for Token Manipulation\n\n##### Jared Atkinson & Robby Winchester\n\n\n-----\n\n### @jaredcatkinson\n\n###### • Adversary Detection Technical Lead @ SpecterOps\n • Developer:\n\n • PowerForensics\n • Uproot\n • ACE\n • PSReflect-Functions\n • Microsoft MVP - Cloud and Data Center Management (PowerShell)\n • Former:\n\n • U.S. Air Force Hunt Team\n • Veris Group’s Adaptive Threat Division\n\n\n-----\n\n### @robwinchester3\n\n###### • Adversary Detection Lead @ SpecterOps\n • Contributor:\n\n • Co-author of ACE\n • HELK\n • Former:\n\n • U.S. Air Force Red Team\n • Veris Group’s Adaptive Threat Division\n\n\n-----\n\n### Overview\n\n###### • What is “Hunt”?\n • Attacker TTP\n • Creating a Useful Hypothesis\n • Case Study\n\n • Detecting Access Token Manipulation\n\n\n-----\n\n-----\n\n### What is Hunt ?\n\n###### • Actively searching for malicious activity in the environment that has\n evaded current in place defenses\n • Rooted in the assume breach mentality\n\n\n-----\n\n### Generic Hunt Process\n\n\n-----\n\n### Generic Hunt Process Problems\n\n###### • Gather data\n\n • What data should we collect?\n • Why are we collecting that data?\n • SIEMs, like Splunk, are expensive…\n • Open source alternatives, like ELK, are technically free but cost time\n • Hunt for bad\n\n • What are you looking for in the gathered data?\n • What is “good” activity that can safely be filtered?\n • How much time do you have to search through the data?\n • Must balance “Hunting” time with “Investigation” time\n\n\n-----\n\n### Hypothesis Driven Hunting\n\n\n-----\n\n### Hypothesis Driven Hunting Benefits\n\n###### • Focuses data collection effort\n • Provides a specific goal for the team\n • Combats data collection for data collection sake\n • Helps eliminate “analysis paralysis”\n • Track hypotheses over time\n\n • What Tactics are you not covering\n • Identify knowledge gaps that training can help fill\n • Inform purchasing decisions moving forward\n\n\n-----\n\n### Great, so how do I make a hypothesis?\n\n###### • This is the focus of the presentation!\n • We will walk you through how to make a hypothesis that will\n actually result in something tangible\n • Will do a practical demonstration on using this process to create\n and execute a hypothesis for Access Token Manipulation\n\n\n-----\n\n### First, what are we looking for?\n\n###### • Assume Breach\n\n • Tons of organizations have been breached\n • It’s a matter of WHEN not IF a breach will occur\n • Focus on post-exploitation activity\n\n • Most in place defenses tools focus on preventing/detecting the initial attack\n\n • Firewalls\n • Anti-Virus\n • Intrusion Detection/Prevention Systems\n • If you can stop the attack before the objective is achieved, the attack is still stopped\n\n\n-----\n\n### MITRE Cyber Attack Lifecycle\n\n\n-----\n\n### MITRE ATT&CK Framework\n\n###### • A body of knowledge for cataloging an adversary activity during the\n attack cycle\n\n • Similar to how OWASP defines application security vunerabilities\n • Used as a reference for both offense and defense\n\n • Red Canary’s Atomic Red Team Project (https://github.com/redcanaryco/atomic-red- team)\n • Includes Windows, Unix, and MacOS TTPs\n • Categories loosely correspond with the attack cycle\n\n • Persistence\n • Lateral Movement\n • etc.\n\n\n-----\n\n### MITRE ATT&CK Framework\n\n\n-----\n\n### TTPs: What are they?\n\n###### • We will explain the meaning of TTPs with an example of a Car\n • Tactics - The employment and ordered arrangement of forces in\n relation to each other\n\n • Preventative Maintenance\n • Techniques - Non-prescriptive ways or methods used to perform\n missions, functions, or tasks\n\n • Changing Oil\n • Procedures - Standard, detailed steps that prescribe HOW to\n perform specified tasks\n\n • Detailed manufacturer’s instructions for oil change\n\n\n-----\n\n### Tactics & Techniques\n\n###### • Tactics\n\n • Sorted by column headers\n\n • Techniques\n\n • Represented by individual entries in ATT&CK matrix\n • 217 techniques currently documented\n • Windows, Linux, MacOS\n\n\n-----\n\n### Procedures\n\n###### • In the detailed information of each technique specific examples or\n threats are included as available\n • Not all procedures are included, but the data set is large and\n growing\n\n\n-----\n\n### Why is this useful?\n\n###### • Focus on detecting the behavior, not hashes and specific tool\n signatures\n • Reference throughout the hypothesis process\n • Tracking hunt history (technique coverage)\n • Plan/chart future hunt activity\n • Identify areas (Tactics) lacking coverage\n\n\n-----\n\n-----\n\n# Enter the Hunt Hypothesis\n\n\n-----\n\n### Our Hypothesis Process\n\n###### • 5 step process to create meaningful hunt hypotheses\n 1) Identify the Tactic and Technique 2) Identify the Procedure(s) 3) Identify the Collection Requirements 4) Identify the Scope 5) Document Excluded Factors\n\n • Intended to be used to create hunt hypotheses to be completed in\n one week\n\n\n-----\n\n### Phase 1: Identify the Tactic & Technique\n\n###### • High level what are you looking for?\n • Used to track interest (tactics) over time in environment\n • Attacks rarely use only one Tactic or Technique\n\n • Specifically focus your efforts\n\n\n-----\n\n### Phase 2: Identify the Procedures\n\n###### • Specific examples and implementations of the selected technique\n • Frequently found in APT reports, threat intelligence, etc.\n • Understand and examine the different procedures\n • What can and cannot be easily changed across all of the\n procedures?\n • Perform research to understand the basic concepts of each\n procedure\n\n\n-----\n\n### Requirements\n\n###### • Bulk of the research time\n • Replicate malicious activity in the lab\n • Identify common behaviors\n • Identify high false positives\n\n • If possible, test in a small portion of the network\n • Should result in a POC collection capability which gathers desired\n data\n\n\n-----\n\n### Phase 4: Identify the Scope\n\n###### • Two factors for scope:\n\n • Time\n\n • Length of execution window\n • We recommend starting with week long execution windows\n • Number of data sources to collect\n\n • Can be host or network information\n • How much data can be collected in the timeframe?\n • How much data can be analyzed in the timeframe?\n • Primarily based on collection requirements\n • Scope may be limited due to limited collection capability\n\n\n-----\n\n### Phase 5: Document Excluded Factors\n\n###### • What things were you unable to include in the hypothesis at each\n level?\n\n • What TTPs were not able to be researched during this hunt?\n • Technical collection limitations?\n • Political limitations?\n • Scope limitations?\n • Will feed future hunt hypotheses\n • Informs future technology purchases\n • Quantifies the effects of scope limitation\n\n\n-----\n\n### What do we have at the end?\n\n###### • Specific behavior being “hunted” for in the environment\n • Understanding of the attack technique\n • Knowledge of data required to detect the activity\n\n\n-----\n\n### Benefit of this process\n\n###### • Focuses hunt efforts to have a tangible result\n • Incremental improvement of security posture over time\n • Can transition reported attack techniques to real security quickly\n\n\n-----\n\n-----\n\n# Case Study\n\n##### Detecting Access Token Manipulation\n\n\n-----\n\n### CISO went to Hacker Summercamp\n\n###### • Our situation:\n\n • Small security budget\n • No EDR capability (agent-based monitoring)\n • Poor lateral network visibility\n • Lots of local administrators\n • Our task:\n\n • Can we detect it?\n • Can we stop it?\n • Have we been affected by it?\n • Our reality:\n\n • Don’t want to focus on the Empire specifically, but maybe its capabilities\n\n\n-----\n\n### Phase 1: Tactic and Technique(s)\n\n###### • Empire is commonly used for:\n\n • Privilege Escalation\n\n • Access Token Manipulation\n • Bypass User Account Control\n • Defense Evasion\n\n • DLL Injection\n • Credential Access\n\n • Credential Dumping\n • Lateral Movement\n\n • Pass the Hash\n • Pass the Ticket\n • Windows Management Instrumentation\n • Tactic - Privilege Escalation [1]\n • Technique - Access Token Manipulation [2]\n\n1https://attack.mitre.org/wiki/Privilege_Escalation\n\n\n-----\n\n### Access Token Manipulation\n\n###### • Windows uses access tokens to determine the security context of a\n running process or thread\n • Attackers can manipulate their applied access token to access\n securable objects or perform privileged operations that they previously were not able to do.\n • Procedures\n\n • Token Impersonation (Theft)\n • Create a Process with a Token\n • Create Token → Impersonate Token\n\n\n-----\n\n### Windows Authentication Overview\n\n###### • Windows creates a logon session upon successful authentication\n\n • User credentials (if any) are stored in lsass.exe\n\n • Credentials may be used later for Single Sign On\n • Credentials are tied to the logon session\n • Typical credentials: NTLM hash, Kerberos tickets, plaintext passwords\n • Tokens define the security context of a process/thread\n\n • When a process/thread wants to act in a user context it uses a token\n\n • Interact with a securable object or perform an action that requires privilege\n • Tokens are tied to logon sessions and determine how the cred is used\n#### Thread/Process → Token → Logon Session → Credential\n\n\n-----\n\n### Logon Session Types\n\n###### • The logon session type is the only thing that matters for\n credential/token theft\n\n • NOT the token type. Credentials are tied to a logon session, NOT a token!\n • Types\n\n • Network logon (type 3): the client proves they have credentials, but does not send them to the server (credentials are NOT in memory)\n • Non-Network logon (Interactive/NetworkCleartext/etc.): the client sends credentials to the service (credentials are in lsass.exe)\n • Implication:\n\n • If Logon Session Type is 3 (Network logon) then there is no credential/token to steal\n\n\n-----\n\n### What is an Access Token?\n\n###### • Kernel object that describes the security context of a\n process/thread\n • Contains the following information:\n\n • User Account Security Identifier (SID)\n • Group SIDs\n • Logon SID (Logon Session Identifier)\n • List of Privileges held by user or groups\n • Token Integrity Level\n • Impersonation Level\n • Optional list of restricting SIDs\n\n\n-----\n\n### Token Types & Impersonation Levels\n\n###### • 1) Primary - a process token\n\n • OS uses token’s credentials to authenticate remotely.\n • 2) Impersonation - a thread token\n\n • Threads use Impersonation tokens to impersonate other security contexts\n • OS might use token’s credentials to authenticate remotely\n • Token Impersonation Levels\n\n • Anonymous - Remote server cannot identify/impersonate client\n • Identification - Remote server can identify user, but not impersonate\n • Impersonation - The remote server can identify and impersonate the client across one computer boundary\n • Delegation - The server can impersonate the client on across multiple boundaries, and can make calls on behalf of the client.\n\n\n-----\n\n### Who has seen or done this??\n\n\n-----\n\n### Access Token Manipulation Overview\n\n###### • Every process has a primary token that describes the security\n context of the user account associated with the process\n • By default, threads use the process’ primary token\n • Threads can impersonate a client account\n\n • The thread will have both a primary and impersonation token in this case\n • Token Impersonation\n • Create a Process with a Token\n • Make and Impersonate Token\n\n\n-----\n\n### Phase 2: Identify the Procedures\n\n###### • Technique - Access Token Manipulation\n\n • Token Impersonation\n • Create a Process with a Token\n • Make and Impersonate Token\n\n\n-----\n\n### Token Impersonation (Theft)\n\n###### • Situation:\n\n • Your target user has a non-network Logon Session on the system.\n • Assuming admin rights, you can directly impersonate the token.\n • DuplicateToken(Ex)\n\n • Creates a new access token that duplicates an existing token.[1]\n • Can use returned token w/ ImpersonateLoggedOnUser or SetThreadToken\n • ImpersonateLoggedOnUser\n\n • Lets the calling thread impersonate a logged on user’s security context.[2]\n • Works with primary and impersonation tokens.[2]\n • SetThreadToken\n\n • Assigns an impersonation token to a thread.[3]\n\n1https://msdn.microsoft.com/en-us/library/windows/desktop/aa446617(v=vs.85).aspx\n\n\n-----\n\n-----\n\n### Create a Process with a Token\n\n###### • Situation:\n\n • You want a quick way to create a process with a security context for a different user account.\n • DuplicateToken(Ex)\n\n • Creates a new access token that duplicates an existing token.[1]\n • Can use returned token w/ ImpersonateLoggedOnUser or SetThreadToken\n • CreateProcessWithTokenW\n\n • Creates a new process and its primary thread.[1]\n • Process runs in the security context of the user account represented by the specified token.[1]\n\n\n-----\n\n-----\n\n### Make and Impersonate Token\n\n###### • Situation:\n\n • You have a username and password, but the user is not logged on\n • LogonUser\n\n • Set the dwLogonType to LOGON32_LOGON_NEW_CREDENTIALS (type 9)\n • Creates a NewCredential Logon Session for specified user and password\n\n • Local authentication will use the parent process’ user\n • Network authentication will use the specified user account\n • Returns a copy of the new Logon Session’s access token\n • SetThreadToken\n\n • Assigns an impersonation token to a thread.\n\n\n-----\n\n-----\n\n### Phase 2: Identify the Procedures\n\n###### • Technique - Access Token Manipulation\n\n • Token Impersonation\n • Create a Process with a Token\n • Make and Impersonate Token\n • Procedure\n\n • Token Impersonation\n • Create and Impersonate Token\n\n\n-----\n\n### Phase 3: Collection Requirements\n\n###### • Interact with known Access Token Manipulation tools to identify\n collection requirements\n\n • Incognito (Meterpreter)\n • Invoke-TokenManipulation (PowerSploit/PowerShell Empire)\n • Cobalt Strike\n • Collect relevant data points\n\n • Access Tokens for each process and thread\n\n\n-----\n\n### Collecting - Access Tokens\n\n###### • Enumerate processes/threads (Get-Process)\n • OpenProcess[1] - Returns a handle to a process object\n • OpenProcessToken[2] - Opens an access token associated with a\n process\n • OpenThread[3] - Returns a handle to a Thread object\n • OpenThreadToken[4] - Opens an access token associated with a\n thread\n • GetTokenInformation[5] - Retrieves a specified type of information\n about an access token\n\n1https://msdn.microsoft.com/en-us/library/windows/desktop/ms684320(v=vs.85).aspx\n2https://msdn microsoft com/en-us/library/windows/desktop/aa379295(v=vs 85) aspx\n\n\n-----\n\n### Get-AccessToken\n\n\n-----\n\n### Collecting - Ticket Granting Tickets\n\n###### • Enumerate LSA Logon Sessions\n\n • LsaEnumerateLogonSessions[1] - Returns a handle to an array of session data structures.\n • LsaGetLogonSessionData[2] - Queries each session handle for its associated information (logon type, user, etc.).\n • Request each Logon Session’s Ticket Granting Ticket\n\n • LsaRegisterLogonProcess[3] - Establishes a connection to the Local Security Authority Server.\n • LsaCallAuthenticationPackage[4] - Calls a specified function implemented by an authentication package (Kerberos).\n • LsaDeregisterLogonProcess[5] - Closes the connection to the Local Security Authority Server.\n\n1https://msdn.microsoft.com/en-us/library/windows/desktop/aa378275(v=vs.85).aspx\n\n\n-----\n\n### Get-KerberosTicketGrantingTicket\n\n\n-----\n\n### Phase 4: Identify the Scope\n\n###### • Our timeframe:\n\n • One week\n • Our environment:\n\n • 3 Domains\n • 1 Linux Server (non-domain joined)\n • 9 Windows Workstations\n • 2 Windows Servers\n • No sensitive production systems\n • Our scope:\n\n • 3 domains\n • Windows Servers and Workstations (11)\n\n\n-----\n\n### Phase 5: Document Excluded Factors\n\n###### • Privilege Escalation\n\n • Bypass User Account Control\n • New Service\n • Credential Access\n\n • Credential Dumping\n • Account Manipulation\n • Security Support Providers\n • Lateral Movement\n\n • Pass the Hash\n • Pass the Ticket\n • Scope\n\n • Lacked credentials for the Linux Server\n\n\n-----\n\n-----\n\n# Hunt Execution Demo!!\n\n\n-----\n\n### Adversary Runs Get-System\n\n\n-----\n\n### Query Impersonation Tokens\n\n\n-----\n\n### Stolen Token in Detail\n\n\n-----\n\n### Establish PSRemoting Session to Targets\n\n\n-----\n\n### Query Kerberos TGTs in Each Session\n\n\n-----\n\n### Viewing Malicious Session in Detail\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://www.blackhat.com/docs/eu-17/materials/eu-17-Atkinson-A-Process-Is-No-One-Hunting-For-Token-Manipulation.pdf"
    ],
    "report_names": [
        "eu-17-Atkinson-A-Process-Is-No-One-Hunting-For-Token-Manipulation.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716499,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1511840005,
    "ts_modification_date": 1511840005,
    "files": {
        "pdf": "https://archive.orkl.eu/5199ecac3bdeea3219a68a109e1ecd9b3c6452a6.pdf",
        "text": "https://archive.orkl.eu/5199ecac3bdeea3219a68a109e1ecd9b3c6452a6.txt",
        "img": "https://archive.orkl.eu/5199ecac3bdeea3219a68a109e1ecd9b3c6452a6.jpg"
    }
}