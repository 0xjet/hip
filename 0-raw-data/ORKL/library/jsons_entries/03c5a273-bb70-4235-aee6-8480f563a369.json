{
    "id": "03c5a273-bb70-4235-aee6-8480f563a369",
    "created_at": "2023-01-12T15:01:13.366041Z",
    "updated_at": "2025-03-27T02:10:20.61613Z",
    "deleted_at": null,
    "sha1_hash": "22d9c394d7f3b7605d6149f4c7975bbf56ef2509",
    "title": "2021-06-02 - SharpPanda- Chinese APT Group Targets Southeast Asian Government With Previously Unknown Backdoor",
    "authors": "",
    "file_creation_date": "2022-05-28T18:11:44Z",
    "file_modification_date": "2022-05-28T18:11:44Z",
    "file_size": 1363713,
    "plain_text": "# SharpPanda: Chinese APT Group Targets Southeast Asian Government With Previously Unknown Backdoor\n\n**research.checkpoint.com/2021/chinese-apt-group-targets-southeast-asian-government-with-previously-unknown-**\nbackdoor/\n\nJune 3, 2021\n\nJune 3, 2021\n\n## Introduction\n\nCheck Point Research identified an ongoing surveillance operation targeting a Southeast\nAsian government. The attackers use spear-phishing to gain initial access and leverage old\nMicrosoft Office vulnerabilities together with the chain of in-memory loaders to attempt and\ninstall a previously unknown backdoor on victim’s machines.\n\nOur investigation shows the operation was carried out by what we believe is a Chinese APT\ngroup that has been testing and refining the tools in its arsenal for at least 3 years.\n\n[While some initial artifacts of this attack have already been analyzed by VinCSS, in this](https://blog.vincss.net/2021/05/re022-phan-1-phan-tich-nhanh-mau-ma-doc-gia-mao-cong-van-cua-uy-ban-kiem-tra-tw-VietNam.html)\nreport we will reveal the full infection chain used in this attack and provide a full analysis of\nthe TTPs used throughout this campaign as well as the new tools uncovered during the\nresearch. We will also explore the evolution of the actor’s tools since they have been first\nseen in the wild.\n\n\n-----\n\n## Infection Chain\n\nThe investigation starts from the campaign of malicious DOCX documents that are sent to\ndifferent employees of a government entity in Southeast Asia. In some cases, the emails are\nspoofed to look like they were from other government-related entities. The attachments to\nthese emails are weaponized copies of legitimate looking official documents and use the\nremote template technique to pull the next stage from the attacker’s server.\n\n**Figure 1: Examples of lure documents sent to the victims**\n\nEach document downloads a template from a different URL but with a similar pattern, with\nthe working folder containing names of brands ( ipad, `surface,` `apple, etc.) to`\ndistinguish between each victim.\n\n**Figure 2: External template URL**\n\nThe remote templates in all the cases are RTF files weaponized using a variant of a tool\nnamed [RoyalRoad. This tool allows the attacker to create customized documents with](https://nao-sec.org/2020/01/an-overhead-view-of-the-royal-road.html)\nembedded objects that exploit the Equation Editor vulnerabilities of Microsoft Word. Despite\n\n\n-----\n\nthe fact that these vulnerabilities are few years old, they are still used by multiple attack\ngroups, and especially popular with Chinese APT groups.\n\nThe initial documents and RTF files are just the very start of an elaborate multi-stage\ninfection-chain we will analyze.\n\n**Figure 3: Full infection chain**\n\n## RoyalRoad RTF\n\nAs all RoyalRoad RTFs, the next stage RTF document contains encrypted payload and\nshellcode.\n\n**Figure 4: RTFobj output, exposing OLE objects information**\n\nTo decrypt the payload from the package, the attacker uses the RC4 algorithm with the key\n```\n123456, and the resulted DLL file is saved as 5.t in the %Temp% folder. The shellcode is\n\n```\nalso responsible for the persistence mechanism – it creates the scheduled task named\n\n\n-----\n\n```\nWindows Update that should run the exported function StartW from 5.t with\nrundll32.exe, once a day.\n\n```\nThe use of `StartW as exported function, is common with Cobalt Strike DLL’s. The use of`\nsuch an export name might indicate that in other cases, the same toolset is used to deliver\nCobalt Strike instead of the payloads we describe below.\n\n## 5.t Downloader\n\nThe `5.t DLL’s original name is` `Download.dll . It starts with a common anti-sandboxing`\ntechnique detecting the acceleration of code execution: it gets the local time before and after\na Sleep function call and checks if the Sleep was skipped.\n\nThen the loader gathers data on the victim’s computer including hostname, OS name and\nversion, system type (32/64 bit), user name, MAC addresses of the networking adapters. It\nalso queries WMI for the anti-virus information.\n\nThe loader then encrypts the information using the RC4 with the key `123456 and base64`\nencodes it.\n\nThe data is then sent via GET HTTP to:\n```\nhttps://<C&C IP>/<working_folder>/Main.php?Data=<encrypted_data> with the\n\n```\nUser-Agent `Microsoft Internet Explorer and then the loader gets the response from`\n```\nhttps://<C&C IP>/<working_folder>/buy/<hostname>.html .\n\n```\nIf the threat actor finds the victim machine interesting, the response from the server contains\nthe next stage executable in encrypted form, in the same way the data is sent to the C&C\nserver.\n\nTo verify the integrity of the received message, the loader uses the FNV-1A64 hash algorithm\nto check if the prefix of the decrypted message is `A257, and also calculates the MD5 of the`\nmessage to makes sure it’s the same one as specified at the start of the message.\n\n**Figure 5: Start of the decrypted response**\n\nIn the end, the loader loads the decrypted DLL to memory, starts its execution from the\n```\nStartW export function and notifies the server about the result of the operation.\n\n## The Loader\n\n```\n\n-----\n\nTo ensure only one instance of the loader is running, the loader first creates an event named\n```\n9DJ8;;L;'4299FDS12JS and proceeds with the execution if the event did not exist before.\n\n```\nFor anti-analysis purposes, the loader functionality is implemented as a shellcode, which is\nstored encrypted inside the binary. The loader decrypts the shellcode by XORing it with the\n32 byte key:\n```\n[0x8a, 0x4e, 0xd1, 0xbb, 0xc4, 0xcc, 0x75, 0x3a, 0x4b, 0x5f, 0xe1, 0x99,\n0x3a, 0x4b, 0x5f, 0x61, 0xd1, 0xbb, 0xc4, 0x50, 0xe4, 0x99, 0x3a, 0x4b,\n0xe4, 0x99, 0xcc, 0x75, 0x3a, 0xe4, 0x90, 0x8a], then loads the needed libraries\n\n```\nand passes the execution to the shellcode itself.\n\n**Figure 6: List of loaded libraries used for by shellcode to dynamically resolve API**\n**functions**\n\nAnother anti-analysis technique observed being used by the shellcode inside the loader is\ndynamic API resolving using the known hash method. This way, the loader is able to not only\nhide its main functionality but also avoid static detection of suspicious API calls by\ndynamically resolving them instead of using static imports.\n\nThe decrypted shellcode contains a configuration that is used to obtain and correctly run the\nnext stage. It includes the C&C server IP and port, as well as some other values that we will\ndiscuss later.\n\n\n-----\n\n**Figure 7: Malware configuration**\n\nOnce initialized, the shellcode sends the `CONNECT HTTP/1.1 message to the IP:port from`\nthe configuration and follows up with another message containing the identifier (in our case\n```\nadmin ) XORed with a hardcoded 48-byte key. The received message is decrypted in the\n\n```\nsame way and the shellcode checks if it starts with the magic number: `0x11d4 . If the`\nserver returns valid data, the loader runs several checks on its PE headers, load the\nbackdoor to memory and executes an exported function named `MainThread .`\n\nThe loader DLL also contains a PE executable in a resource named `TXT . The executable`\nis named `SurvExe based on the PDB path left by the attacker:`\n```\nC:\\Users\\user\\Desktop\\0814-surexe\\x64\\SurvExe\\x64\\Release\\SurvExe.pdb .\n\n```\nThis executable is supposed to be responsible for copying the file passed to it as a\nparameter to the `TEMP directory with the name` `OEJFISDOFJDLK . However, the resource is`\nnot used and seems to have been left by the attacker from previous malware versions.\n\n## The Backdoor\n\nAs we discussed before, at the final stage of the infection chain the malicious loader is\nsupposed to download, decrypt and load a DLL file into memory. In theory, this plug-in\narchitecture might be used to download and install any other module in addition to the\nbackdoor we received.\n\nThe backdoor module appears to be a custom and unique malware with the internal name\n```\nVictoryDll_x86.dll .\n\n```\nThe backdoor capabilities include the ability to:\n\nDelete/Create/Rename/Read/Write Files and get files attributes\nGet processes and services information\nGet screenshots\nPipe Read/Write – run commands through cmd.exe\nCreate/Terminate Process\nGet TCP/UDP tables\nGet CDROM drives data\nGet registry keys info\nGet titles of all top-level windows\nGet victim’s computer information – computer name, user name, gateway address,\nadapter data, Windows version (major/minor version and build number) and type of\nuser\nShutdown PC\n\n\n-----\n\n## C&C Communication\n\nFor the C&C communication, the backdoor uses the same configuration as the one from the\nprevious step, which contains server IP and port.\n\nFirst, it sends to the server “Start conversation” ( 0x540 ) message XORed with hard-coded\n256-byte key.\n\n**Figure 8: “Start conversation” request sent by the backdoor**\n\nThe server, in turn, returns the “Get Victim Information” ( 0x541 ) message and the new 256byte key that will be used for all the subsequent communication.\n\n**Figure 9: Response from C&C server**\n\nAll the subsequent communication with the C&C server has the following format:\n\n[ Size ] followed by XORed [ TypeID ] and [ Data ] (with 256-byte key).\n\nThe full list of commands and different types of messages between the C&C and the\nbackdoor is provided in Appendix A\n\n\n-----\n\n## Some History\n\nSearching for files similar to the final backdoor in the wild, we encountered a set of files that\nwere submitted to VirusTotal in 2018. The files were named by the author as `MClient and`\nappear to be part of a project internally called `SharpM, according to their PDB paths.`\nCompilation timestamps also show a similar timeframe between July 2017 and June 2018,\nand upon examination of the files, they were found to be older test versions of our\n```\nVictoryDll backdoor and its loaders chain.\n\n```\nThe numerous similarities include:\n\nThe specific implementation of the main backdoor functionality is identical;\n\nThe `SurvExe resource in the loader is very similar to one of the` `MClient ’s methods`\nusing the same event name pattern. Also, `SurvExe seems to have inherited the`\nmasquerading technique from `MClient – both were internally named` `svchost.exe .`\n\n**Figure 10: SurvExe module code compared to MClient’s code (right)**\n\nThe connection method has the same format. Moreover, `MClient ’s connection XOR`\nkey and `VictoryDll ‘s initial XOR key are the same (in fact,` `VictoryDll ‘s XOR`\nkey is the expansion of this key to 256 bytes):\n\n\n-----\n\n**Figure 11: MClient’s XOR key compared to VictoryDLL’s XOR key (right)**\n```\n   MClient contained an additional DLL called AutoStartup_DLL, whose purpose\n\n```\nwas to create the scheduled task called `Windows Update – a functionality which in`\nour campaign was delegated to the RTF exploit.\n\n## Same but Different\n\nThe backdoor has also undergone some changes in the architecture, functionality and\nnaming:\n\nDifferent export function names: in our backdoor, the exported function is named\n```\n   MainThread while in all versions of the MClient variant the export function was\n\n```\nnamed `GetCPUID .`\nSame configuration fields, but the different obfuscation used. In the later version, the\nconfiguration is a part of the encrypted shellcode inside the loader, whereas in\n```\n   MClient the configuration is hardcoded in the backdoor XORed with the byte 0x56\n\n```\nor, in some test versions, not obfuscated at all.\n```\n   MClient has an addition al persistence mechanism besides the scheduled task\n\n```\nthe `VictoryDll has in its infection chain: in case of low privileges, on Windows 10,`\nor having Kaspersky installed on the victim’s computer, `MClient adds itself to`\n```\n   SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run registry with the name Intel\n   USB3 Driver .\n   MClient versions from 2018 contain the code that bypasses UAC using wusa.exe. In\n   VictoryDll this function doesn’t exist anymore; instead of that, the code only tries to\n\n```\nget the user’s privileges by attempting to open the file `C:\\Windows\\l and checking`\nthe result of this operation.\nThe `MClient version from January 2018`\n( aa5458bdfefe2a97611bb0fd9cf155a06f88ef5d ) also contained a keylogger\nfunctionality which has since been removed in the subsequent test versions and not\npresent in `VictoryDll .`\n\n\n-----\n\nOverall, we can see that in these 3 years, most of the functionality of `MClient and`\n```\nAutoStartup_DLL was preserved and split between multiple components – probably to\n\n```\ncomplicate the analysis and decrease the detection rates at each stage. We may also\nassume that there exist other modules based on the code from 2018 that might be installed\nby the attacker in the later stages of the attack.\n\n## Infrastructure\n\nFirst stage C&C servers are hosted by 2 different cloud services, located in Asia (Hong Kong\nand Malaysia). The backdoor C&C server, `107.148.165[.]151, is hosted on Zenlayer, a`\nUS-based provider which is widely used for C&C purposes by multiple threat actors.\n\nThe threat actor operates the C&C servers in a limited daily window, making it harder to gain\naccess to the advanced parts of the infection chain. Specifically, it returned the next stage\npayloads only during 01:00 – 08:00 UTC on workdays.\n\nAt some point in the research, one of the attacker’s servers that served the loader\ncomponent had directory listing enabled for a limited time. In addition to that, the `Main.php`\nfile was served without processing and revealed a piece of PHP code whose purpose was to\nlog all the incoming requests with the date, IP address and decrypted data to `log.txt`\n\n**Figure 12: File listing on the server**\n\n\n-----\n\n**Figure 13: Fragment of the simple PHP code that logs the requests, found on the**\n**server**\n\n## Attribution\n\nWe attribute this cluster of activity to a Chinese threat group with medium to high confidence,\nbased on the following artifacts and indicators:\n\nThe RoyalRoad RTF exploit building kit mentioned above, has been reported by\nnumerous researchers as a tool of choice among Chinese APT groups.\n\nThe C&C servers returned payloads only between 01:00 – 08:00 UTC, which we\nbelieve are the working hours in the attackers’ country, therefore the range of possible\norigins of this attack is limited.\n\nThe C&C servers did not return any payload (even during working hours), specifically\nthe period between May 1st and 5 – this was when theth [Labor Day holidays in China](https://publicholidays.cn/2021-dates/)\ntook place.\n\nSome test versions of the backdoor contained internet connectivity check with\n[www.baidu.com – a leading Chinese website.](https://www.baidu.com/)\n\nSome test versions of the backdoor from 2018 were uploaded to VirusTotal from China.\n\n**Figure 14: Submissions for test backdoors**\n**(f8088c15f9ea2a1e167d5fa24b65ec356939ba91 and**\n**7a38ae6df845def6f28a4826290f1726772b247e)**\n\nWhile we could identify overlaps in TTPs with multiple Chinese APT groups, we have been\nunable to attribute this set of activities to any known group.\n\n## Conclusion\n\nWe unveiled the latest activity of what seems to be a long-running Chinese operation that\nmanaged to stay under the radar for more than 3 years. In this campaign, the attackers\nutilized the set of Microsoft Office exploits and loaders with anti-analysis and anti-debugging\n\n\n-----\n\ntechniques to install a previously unknown backdoor.\n\nAnalyzing the backdoor’s code evolution since its first appearance in the wild showed how it\ntransformed from a single executable to a multi-stage attack, making it harder to detect and\ninvestigate.\n\n[Check Point Threat Emulation blocks this attack from the very first step.](https://www.checkpoint.com/infinity-vision/zero-day-protection/)\n\n## Appendix A: Backdoor Commands\n\n**Message Type** **Type ID** **Arguments** **Source**\n\n**Send victim’s information** 0x2 Info Victim\n\n**CDROM drives data** 0x4 – / Drives data Both\n\n**Get Files data** 0x5/0x6 Path / Files data Both\n\n**Create Process** 0x7 Command Line C&C\nserver\n\n\n**Rename File** 0x8 Old filename, New\nfilename\n\n\nC&C\nserver\n\n\n**Delete File** 0x9 Filename C&C\nserver\n\n\n**Read File** 0xa Filename, Offset / File’s\ncontent\n\n\nBoth\n\n\n**Exit Pipe** 0xb – C&C\nserver\n\n**Create Pipe** 0xc – C&C\nserver\n\n**Write To Pipe** 0xd Buffer C&C\nserver\n\n\n-----\n\n**Get Uninstalled software data** 0xe – / Software data Both\n\n**Get windows text** 0xf – / Windows text Both\n\n**Get active processes data** 0x10 – / Processes data Both\n\n**Terminate Process** 0x11 Process ID C&C\nserver\n\n**Get screenshot** 0x12/0x13 – / Screenshot temp file Both\n\n**Get services data** 0x14 – / Services data Both\n\n**Get TCP/UDP tables** 0x15 – / Tables data Both\n\n**Get registry key data** 0x16 Registry path / Reg data Both\n\n**Shutdown** 0x17 – C&C\nserver\n\n**Exit process** 0x18 – C&C\nserver\n\n**Restart current process** 0x19 – C&C\nserver\n\n**Write to file** 0x4C7 Filename, Buffer C&C\nserver\n\n**Start Connection** 0x540 Zero Byte Victim\n\n\n**Get victim’s information/Update**\n**XOR key**\n\n\n0x541 New XOR key / Victim’s\ninfo\n\n\nBoth\n\n\n**None** 0x120E – C&C\nserver\n\n\n-----\n\n**Ack** 0x129D3 Name (‘admin’ in our\ncase)\n\n## Appendix B: Indicators of Compromise\n\n**Documents**\n```\n278c4fc89f8e921bc6c7d015e3445a1cc6319a66\n42be0232970d5274c5278de77d172b7594ff6755\nf9d958c537b097d45b4fca83048567a52bb597bf\nfefec06620f2ef48f24b2106a246813c1b5258f4\n548bbf4b79eb5a173741e43aa4ba17b92be8ed3a\n417e4274771a9614d49493157761c12e54060588\n\n```\n**Executables**\n```\n03a57262a2f3563cf0faef5cde5656da437d58ce 5.t\n388b7130700dcc45a052b8cd447d1eb76c9c2c54 5.t\n176a0468dd70abe199483f1af287e5c5e2179b8c 5.t\n01e1913b1471e7a1d332bfc8b1e54b88350cb8ad loader\n8bad3d47b2fc53dc6f9e48debac9533937c32609 ServExe (x64)\n0a588f02e60de547969d000968a458dcdc341312 VictoryDll\n\n```\n**C&C servers**\n```\n45.91.225[.]139\n107.148.165[.]151\n45.121.146[.]88\n\n```\n**Old backdoor versions**\n\n**MClient:**\n```\naa5458bdfefe2a97611bb0fd9cf155a06f88ef5d\n4da26e656ef5554fac83d1e02105fad0d1bd7979\nf8088c15f9ea2a1e167d5fa24b65ec356939ba91\n0726e56885478357de3dce13efff40bfba53ddc2\n7855a30e933e2b5c3db3661075c065af2e40b94e\n696a4df81337e7ecd0ea01ae92d8af3d13855c12\nabaaab07985add1771da0c086553fef3974cf742\n7a38ae6df845def6f28a4826290f1726772b247e\n\n```\n**Autostart_DLL:**\n```\ne16b08947cc772edf36d97403276b14a5ac966d0\nc81ba6c37bc5c9b2cacf0dc53b3105329e6c2ecc\na96dfbad7d02b7c0e4a0244df30e11f6f6370dde\n6f5315f9dd0db860c18018a961f7929bec642918\n\n## Appendix C: MITRE ATT&CK Matrix\n\n```\n\nVictim\n\n\n-----\n\n**Tactic** **Technique** **Technique Name**\n\nInitial Access T1566.001 Phishing:\nSpearphishing\nAttachment\n\nExecution T1204.002 User Execution:\nMalicious File\n\nT1203 Exploitation for Client Execution\n\nT1059.003 Execution Command and Scripting Interpreter:\nWindows Command Shell\n\nPersistence T1053 Scheduled Task/Job\n\n\nDefense\nEvasion\n\n\nT1027 Obfuscated Files or\nInformation\n\n\nT1221 Template Injection\n\nDiscovery T1082 System Information\nDiscovery\n\nT1518 Software Discovery\n\nT1057 Process Discovery\n\nT1012 Query Registry\n\nT1007 System Service discovery\n\nT1081 File and Directory Discovery\n\nT1010 Application Window Discovery\n\nCollection T1113 Screen Capture\n\n\n-----\n\nT1005 Data from Local System\n\n\nCommand\nand Control\n\n\nT1132 Data Encoding\n\n\nT1104 Multi-Stage Channels\n\nT1071.001 Application Layer Protocol: Web Protocols\n\nT1573.001 Encrypted Channel: Symmetric Cryptography\n\nExfiltration T1041 Exfiltration Over C2\nChannel\n\nImpact T1529 System\nShutdown/Reboot\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-02 - SharpPanda- Chinese APT Group Targets Southeast Asian Government With Previously Unknown Backdoor.pdf"
    ],
    "report_names": [
        "2021-06-02 - SharpPanda- Chinese APT Group Targets Southeast Asian Government With Previously Unknown Backdoor.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "8a3bd03a-f69b-455b-b88b-3842a3528bfd",
            "created_at": "2022-10-25T16:07:24.178007Z",
            "updated_at": "2025-03-27T02:02:10.132529Z",
            "deleted_at": null,
            "main_name": "SharpPanda",
            "aliases": [
                "Sharp Dragon",
                "SharpPanda"
            ],
            "source_name": "ETDA:SharpPanda",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Agentemis",
                "Cobalt Strike",
                "CobaltStrike",
                "RoyalRoad",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e7ef34b6-e7b6-46f3-8dd8-2708c1659cd6",
            "created_at": "2023-11-08T02:00:07.107758Z",
            "updated_at": "2025-03-27T02:00:03.182575Z",
            "deleted_at": null,
            "main_name": "SharpPanda",
            "aliases": [],
            "source_name": "MISPGALAXY:SharpPanda",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535673,
    "ts_updated_at": 1743041420,
    "ts_creation_date": 1653761504,
    "ts_modification_date": 1653761504,
    "files": {
        "pdf": "https://archive.orkl.eu/22d9c394d7f3b7605d6149f4c7975bbf56ef2509.pdf",
        "text": "https://archive.orkl.eu/22d9c394d7f3b7605d6149f4c7975bbf56ef2509.txt",
        "img": "https://archive.orkl.eu/22d9c394d7f3b7605d6149f4c7975bbf56ef2509.jpg"
    }
}