{
    "id": "dea1a8a9-2dcf-4893-af75-02c543fef8d7",
    "created_at": "2023-01-12T15:08:14.22337Z",
    "updated_at": "2025-03-27T02:15:45.276253Z",
    "deleted_at": null,
    "sha1_hash": "1c2fee7e6e3042e4730aa11a6f70107fce9af378",
    "title": "2021-02-01 - DPRK Targeting Researchers II- .Sys Payload and Registry Hunting",
    "authors": "",
    "file_creation_date": "2022-05-28T17:33:58Z",
    "file_modification_date": "2022-05-28T17:33:58Z",
    "file_size": 1578397,
    "plain_text": "# DPRK Targeting Researchers II: .Sys Payload and Registry Hunting\n\n**[norfolkinfosec.com/dprk-targeting-researchers-ii-sys-payload-and-registry-hunting/](https://norfolkinfosec.com/dprk-targeting-researchers-ii-sys-payload-and-registry-hunting/)**\n\nnorfolk February 1, 2021\n\nIn an [earlier post, this blog examined malware from a DPRK-affiliated campaign targeting](https://norfolkinfosec.com/dprk-malware-targeting-security-researchers/)\n[security researchers. Since the initial public post about this activity from Google, multiple](https://blog.google/threat-analysis-group/new-campaign-targeting-security-researchers/)\nvendors [have corroborated and supplemented the technical details in this attack.](https://www.microsoft.com/security/blog/2021/01/28/zinc-attacks-against-security-researchers/)\n\nWhereas the previous post examined a DLL file delivered via social engineering and\nVisualStudio, this post examines the inner-workings of a malicious .sys file likely delivered\nthrough a watering hole. In addition to reverse engineering, this post offers possible threat\nhunting avenues for identifying data associated with this file hidden in the registry of a\ncompromised system.\n\nFor those purely interested in the hunting portion of this post (the malware reads, and likely\nexecutes, data from the registry), click here to skip ahead. As a disclaimer, the hunt workflow\nproposed is merely hypothetical, and should not be considered any sort of official security\nguidance.\n\n(2/1 Update, Stage 2 can be found here)\n\n**Technical Analysis**\n\nFilename: helpsvc.sys\n\nMD5: ae17ce1eb59dd82f38efb9666f279044\n\nSHA1: 3b3acb4a55ba8e2da36223ae59ed420f856b0aaf\n\nSHA256: a4fb20b15efd72f983f0fb3325c0352d8a266a69bb5f6ca2eba0556c3e00bd15\n\nExamining this file in IDA reveals that this file is a DLL likely intended to run as a service,\ngiven one of its exports (ServiceMain) and several of its imports\n(RegisterServiceCtrlHandlerW, SetServiceStatus). There are a few routes available for\ndebugging a file like this- ultimately, I settled on the following steps:\n\n1) Edit the first two bytes of ServiceMain to EB FE, [creating a loop that allows us to attack,](https://norfolkinfosec.com/emissary-panda-dll-backdoor/)\nresume, and debug it\n\n2) Modify a [previous service-installing PowerShell script from a different DPRK adversary](https://twitter.com/KevinPerlow/status/1088501115245727744)\n\n3) Run PSExec with [system-level permissions](https://specopssoft.com/blog/how-to-become-the-local-system-account-with-psexec/)\n\n4) Use PSExec to run x64dbg, giving it the permissions needed to step into the running\nservice and begin debugging\n\nThe PowerShell script was selected for simplicity; in short, previous research showed that it\ncan be used to install a DLL as a service This current task requires that a DLL be installed\n\n\n-----\n\nas a service. Thus, it did the job of handling the appropriate registry modifications.\n\n_Modified script to install the driver. Note that the .cfg and .dat files are not needed. For_\n_simplicity, during this analysis I created dummy files in their place to save time rather than_\n_removing them altogether, as they do not affect the script’s overall execution._\n\nThis PowerShell script will start a new copy of svchost, which in turn runs this new service.\nThe PowerShell script will also indicate that it is waiting for the service to start; this is\nexpected, as several key routines within the malware occur before the ServiceStatus is set.\n\nBy stepping into the svchost process, resuming this process, and selecting the correct\nrunning thread, we can place a breakpoint on the infinite loop and re-patch the malware to\nthe original instructions.\n\n_Double click the RIP to reach the infinite loop and set a breakpoint._\n\n\n-----\n\n_Right click -> Binary -> Edit_\n\nOnce this patch is in place, the malware will resume its expected behavior. First, the malware\nsteps into a function and begins placing data in memory in a similar fashion as the previously\nanalyzed DLL. In this instance, the malware decrypts three values:\n\n– SubVersion\n\n– Description\n\n– Software\\Microsoft\\Windows\\CurrentVersion\\KernelConfig\n\nThis third value is a registry entry. The malware attempts to open this value under HKLM;\nhowever, this value does not exist, and the malware does not create it. This strongly\n**suggests another mechanism, such as code launched via browser exploit or another**\n**dropper, places this data in the registry.**\n\nIf the malware does open this key, it attempts to read data within values named SubVersion\nand Description (the two other decrypted strings). For the purposes of continuing the\nanalysis, I created this registry key and these two entries, with dummy values in each\nlocation. The values chosen were random, which led to some trial and error to determine\ntheir possible purpose.\n\n\n-----\n\n_The RegQueryValue call takes in a handle (78) to a previously opened key and reads the_\n_data stored from this key into memory._\n\nAfter some attempts, it seemed that anything longer than four bytes in the SubVersion entry\nled to an error during the malware’s execution. Specifically, the malware returned 0xEA and\ngracefully terminated. In addition, the malware seemed to hit an exception when tested with\nexactly four bytes. I picked a random two-byte value to allow it to proceed.\n\nFor the Description entry, I used human-readable sentences and words to make them easier\nto track.\n\n_Contents_\n\n_of the Description key created to allow the malware to proceed._\nAfter reading the Description value, it begins transforming this data through a loop; however,\nthe number of repetitions of the loop is not dependent on the length of the Description data.\nInstead, the malware uses a value that appears to be [10 in hex, 16 in decimal] fewer than\nthe value stored in the SubVersion registry key. In addition, the malware truncates 16 hex\ncharacters off of the start of the data being transformed.\n\n\n-----\n\n_Data transformation_\n\nAfter this transformation, the malware steps into a function that checks for the presence of a\nPE header (MZ) and allocates memory. This function also contains a call to a dynamic API\nresolution routine similar to the previously examined DLL associated with this campaign;\nunfortunately, neither of these routines could be properly examined during this analysis\n(likely due to the lack of a proper expected payload or other similar factors).\n\nFollowing these function calls, the malware starts the service.\nSecond Stage Payload\n\n_After publication, an analyst who wished to remain anonymous pointed me to a copy of the_\n_missing registry data. I left the previous writing intact, as the analytic method may prove_\n_useful to future readers. Below contains some brief technical analysis of the payload_\n_decrypted from the registry._\n\n\n-----\n\nName: KernelConfig Registry data (approx. 2mb)\nMD5 7904d5ee5700c126432a0b4dab2776c9\nSHA1 79bd808e03ed03821b6d72dd8246995eb893de70\nSHA256 7c4ea495f9145bd9bdc3f9f084053a63a76061992ce16254f68e88147323a8ef\n\nThis file can be given a .reg extension, which will import the data into the device’s registry.\nWith this data in place, the malware properly continues its routine and decrypts and runs an\nexecutable payload.\n\nUnlike the DLL analyzed in a previous post that functioned as a downloader, this file has a\nwide range of additional features. This second-stage file begins by dynamically resolving a\nvery large list of APIs from Windows libraries such as kernel32, advapi, ntdll, userenv, and\nothers. The malware then:\n\n– Performs a startup check\n– Communicates with the C2 server (using the OpenSSL library)\n– Uses a Case-Switch workflow to carry out commands\n\nThe startup check (and other routines within the malware) use the same in-memory decoding\nroutine to decrypt hidden strings containing important values for the malware’s execution. In\nthis case, the malware can use this routine to decode three C2 servers for communication. In\naddition, it can write to and read data from the a key located at\nHKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\DriverConfig.\n\nAfter this, the malware will contact a C2 server. The decoded C2s for this sample are:\n\nhxxp: // www.colasprint[.]com/_vti_log/upload.asp\nhxxps: // www.dronerc[.]it/forum/uploads/index.php\nhxxps: // www.fabioluciani[.]com/es/include/include.asp\n\nC2 Workflow\n\nThe malware supports a wide range of commands and actions. Some of the highlights are:\n\n\n-----\n\n– Writing files to the disk and executing them\n– Collecting network adapter information\n– Enumerating running processes and there start times\n– Collecting drive and file info\n– Enumerating items in a directory\n– Creating a process\n– Terminating a process\n– Performing a screen capture\n\nScreen capture code\nBased on these commands, the tool is likely used to conduct reconnaissance and potentially\nto triage a device before taking further steps in the environment.\n\n**Hunting Possibilities**\n\n\n-----\n\nWhen looking for malware like this on a device or across a network, an initial instinct might\nbe to search for known malicious registry key values. At the time of this writing, the only\nknown registry entries for this malware are the ones described above at KernelConfig;\nhowever, the attackers could easily change this (or could have deployed malware that uses\ndifferent values against targets that have yet to identify the infection).\n\nFrom a defensive perspective, however, two things work in our favor:\n\n– Registry key values are usually small\n– Code needed to execute a malicious workflow is usually larger than a registry key\n\nGiven these two facts, one option is to examine the registry for any uncharacteristically\n**_large values. As this post will shortly show, this is merely a starting point for hunting;_**\nhowever, it’s an effective one.\n\nAs an experiment, I pulled malware samples from previous (unrelated) adversary activity. An\nuncompressed meterpreter shell took up just under 1 kb (1,000 bytes). A compressed\nversion took up approximately 300 bytes. I consider these to be a reasonable estimate for\nthe lower-bounds of an executable payload size that an attacker would use.\n\nI then modified [an open-source PowerShell script to enumerate the every key and value in](https://stackoverflow.com/questions/11304608/enumerate-all-registry-value-via-powershell)\nthe CurrentVersion location of HKLM. In a real scenario, I would likely try this against the\nentire registry.\n```\nGet-ChildItem -Recurse registry::hklm\\software\\microsoft\\windows\\currentversion\\ |\nforeach-object { \n$path = $_.PSPath\n$_.Property | foreach-object {\n$name = $_\n$data = get-itemproperty -literalpath $path -name $name | \n select -expand $name\n $dl = $data.length\n#[pscustomobject]@{value=$name; data=$data; key=$path}\nadd-content -path \"c:\\users\\[user]\\desktop\\dump2.txt\" -value \"$path¿$name¿$dl\"\n}\n}\n\n```\nThis produces a CSV file of approximately 194,000 values (I used the upside down question\nmark as a delimiter and edited out excess commas and quotation marks) with the key path,\nkey name, and length of the data. In theory, sorting these by the largest keys should show\noutliers. I used the following Python code:\n\n\n-----\n\n```\nimport csv\nimport re\nkeys = []\nwith open(\"c:\\\\users\\\\[user]\\\\desktop\\\\dump.txt\", encoding=\"utf-8\") as csvfile:\n  reader = csv.reader(csvfile, delimiter=\",\")\n  for line in reader:\n    if int(line[2]) > 199:\n      demo_value = re.sub(\".*?hklm\",\"hklm\",line[0])\n    else:\n      demo_value = line[0]\n    keyadd = []\n    keyadd.append(int(line[2]))\n    keyadd.append(str(line[1]))\n    keyadd.append(demo_value)\n    keys.append(keyadd)\n  #print(len(keys))\n  keys.sort(reverse=True)\n  for item in keys:\n    print(item\n\n```\nOut of 194,000 entries within the CurrentVersion section of the HKLM hive:\n\n– A 100KB payload such as the one analyzed in the previous post would easily top the list\n\n– A 1KB uncompressed meterpreter shell would also top the list\n\n– A 300 byte compressed meterpreter shell would be harder to identify, ranking right around\nthe top 100\n\nAs mentioned above, this is just a starting point. Additions to this workflow, such as\ngenerating the last modified time of the registry key, would likely greatly improve this\n\n\n-----\n\nworkflow. Parsing the data for character entropy would also likely improve the accuracy.\nEven without these two changes, however, a malicious payload stored in a registry value\nwould easily rank in the top 99% of values.\nUpdate 2/1/2021: Analysis of the proper, adversary-intended KernelConfig value shows that\nthe registry data is approximately 2mb. Registry data of this size would likely rank at the top\nof any registry dump in this proposed workflow.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-02-01 - DPRK Targeting Researchers II- .Sys Payload and Registry Hunting.pdf"
    ],
    "report_names": [
        "2021-02-01 - DPRK Targeting Researchers II- .Sys Payload and Registry Hunting.pdf"
    ],
    "threat_actors": [
        {
            "id": "e3492534-85a6-4c87-a754-5ae4a56d7c8c",
            "created_at": "2022-10-25T15:50:23.819113Z",
            "updated_at": "2025-03-27T02:00:55.552554Z",
            "deleted_at": null,
            "main_name": "Threat Group-3390",
            "aliases": [
                "Threat Group-3390",
                "Earth Smilodon",
                "TG-3390",
                "Emissary Panda",
                "BRONZE UNION",
                "APT27",
                "Iron Tiger",
                "LuckyMouse"
            ],
            "source_name": "MITRE:Threat Group-3390",
            "tools": [
                "Systeminfo",
                "gsecdump",
                "PlugX",
                "ASPXSpy",
                "Cobalt Strike",
                "Mimikatz",
                "Impacket",
                "gh0st RAT",
                "certutil",
                "China Chopper",
                "HTTPBrowser",
                "Tasklist",
                "netstat",
                "SysUpdate",
                "HyperBro",
                "ZxShell",
                "RCSession",
                "ipconfig",
                "Clambling",
                "pwdump",
                "NBTscan",
                "Pandora",
                "Windows Credential Editor"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "9e767b38-12ae-4ef7-9878-5ce1701066d7",
            "created_at": "2024-05-01T02:03:08.131819Z",
            "updated_at": "2025-03-27T02:05:17.413497Z",
            "deleted_at": null,
            "main_name": "NICKEL ACADEMY",
            "aliases": [
                "COVELLITE ",
                "CTG-2460 ",
                "Diamond Sleet ",
                "Guardians of Peace",
                "HIDDEN COBRA ",
                "High Anonymous",
                "Labyrinth Chollima ",
                "NNPT Group",
                "New Romanic Cyber Army Team",
                "Temp.Hermit ",
                "The Lazarus Group ",
                "UNC577 ",
                "Who Am I?",
                "Whois Team",
                "ZINC ",
                "Black Artemis "
            ],
            "source_name": "Secureworks:NICKEL ACADEMY",
            "tools": [
                " DarkMessenger",
                " Destover",
                " Duuzer",
                " HOPLIGHT",
                " Joanap",
                " KorHigh",
                " LiveJinx",
                " Volgmer",
                "Brambul"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "2c980ea7-04c4-4193-8535-52f87e66a96e",
            "created_at": "2024-05-01T02:03:07.994126Z",
            "updated_at": "2025-03-27T02:05:17.293799Z",
            "deleted_at": null,
            "main_name": "BRONZE UNION",
            "aliases": [
                "Budworm ",
                "Emissary Panda ",
                "Iron Tiger ",
                "Lucky Mouse ",
                "TG-3390 ",
                "Temp.Hippo ",
                "APT27 "
            ],
            "source_name": "Secureworks:BRONZE UNION",
            "tools": [
                " ASPXSpy",
                " China Chopper",
                " Enfal",
                " Gh0st RAT",
                " HttpBrowser",
                " Hunter",
                " HyperBro",
                " OwaAuth",
                " PlugX",
                " PoisonIvy",
                " Sysupdate",
                " ZxShell",
                "9002"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "c63ab035-f9f2-4723-959b-97a7b98b5942",
            "created_at": "2023-01-06T13:46:38.298354Z",
            "updated_at": "2025-03-27T02:00:02.798255Z",
            "deleted_at": null,
            "main_name": "APT27",
            "aliases": [
                "TG-3390",
                "EMISSARY PANDA",
                "TEMP.Hippo",
                "Budworm",
                "Group 35",
                "BRONZE UNION",
                "Lucky Mouse",
                "Iron Taurus",
                "GreedyTaotie",
                "Red Phoenix",
                "ZipToken",
                "Iron Tiger",
                "G0027",
                "Earth Smilodon"
            ],
            "source_name": "MISPGALAXY:APT27",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5c13338b-eaed-429a-9437-f5015aa98276",
            "created_at": "2022-10-25T16:07:23.582715Z",
            "updated_at": "2025-03-27T02:02:09.875151Z",
            "deleted_at": null,
            "main_name": "Emissary Panda",
            "aliases": [
                "APT 27",
                "ATK 15",
                "Bronze Union",
                "Budworm",
                "Earth Smilodon",
                "Emissary Panda",
                "Group 35",
                "Iron Taurus",
                "Iron Tiger",
                "LuckyMouse",
                "Operation DRBControl",
                "Operation Iron Tiger",
                "Operation PZChao",
                "Operation SpoiledLegacy",
                "Operation StealthyTrident",
                "Red Phoenix",
                "TEMP.Hippo",
                "TG-3390",
                "ZipToken"
            ],
            "source_name": "ETDA:Emissary Panda",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Agent.dhwf",
                "AngryRebel",
                "Antak",
                "CHINACHOPPER",
                "China Chopper",
                "Destroy RAT",
                "DestroyRAT",
                "FOCUSFJORD",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HTTPBrowser",
                "HTran",
                "HUC Packet Transmit Tool",
                "HighShell",
                "HttpBrowser RAT",
                "HttpDump",
                "HyperBro",
                "HyperSSL",
                "HyperShell",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "Nishang",
                "OwaAuth",
                "PCRat",
                "PlugX",
                "ProcDump",
                "PsExec",
                "RedDelta",
                "SEASHARPEE",
                "Sensocode",
                "SinoChopper",
                "Sogu",
                "SysUpdate",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Token Control",
                "TokenControl",
                "TwoFace",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Xamtrav",
                "ZXShell",
                "gsecdump",
                "luckyowa"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536094,
    "ts_updated_at": 1743041745,
    "ts_creation_date": 1653759238,
    "ts_modification_date": 1653759238,
    "files": {
        "pdf": "https://archive.orkl.eu/1c2fee7e6e3042e4730aa11a6f70107fce9af378.pdf",
        "text": "https://archive.orkl.eu/1c2fee7e6e3042e4730aa11a6f70107fce9af378.txt",
        "img": "https://archive.orkl.eu/1c2fee7e6e3042e4730aa11a6f70107fce9af378.jpg"
    }
}