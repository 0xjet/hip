{
    "id": "2d2c25ed-f578-4b73-b1da-4ff4b2a0b926",
    "created_at": "2022-10-25T16:48:19.023147Z",
    "updated_at": "2025-03-27T02:06:02.671928Z",
    "deleted_at": null,
    "sha1_hash": "a3d51c820a7f44fe2d5d2bc1616dba298c76b65e",
    "title": "Developments in IOS Forensics",
    "authors": "",
    "file_creation_date": "2008-03-07T16:39:33Z",
    "file_modification_date": "2008-03-07T16:55:27Z",
    "file_size": 211581,
    "plain_text": "# Developments in Cisco IOS Forensics\n\n### Felix ‘FX’ Lindner BlackHat Briefings Washington DC, Feb. 2008\n\n\n-----\n\n# Agenda\n\n### � IP Routing Infrastructure and Cisco IOS � Cisco IOS Internals � Debugging and Post Mortem Analysis Today � A New Analysis Approach\n#### � Proposal � Features � Challenges\n### � Initial Public Offer � Future Work\n\n\n-----\n\n# IP Routing Infrastructure\n\n### � The Internet and corporate networks almost exclusively run on the Internet Protocol\n#### � IP Version 4 is still prevalent protocol � IP Version 6 coming up very slowly\n### � The design of IP requires intelligent nodes in the network to make routing decisions\n#### � This is a design principle of the protocol and cannot be changed � “Flat” networks have their own issues\n\n\n-----\n\n# IP Infrastructure & Security\n\n### � All security protocols on top of IP share common design goals:\n#### � Guarantee end-to-end integrity (some also confidentiality) of the traffic � Detect modification, replay, injection and holding back of traffic � Inform the upper protocol layers\n### � None of them can recover from attacks rooted in the routing infrastructure\n#### � Security protocols cannot influence routing\n\n\n-----\n\n# Infrastructure Monoculture\n\n#### � Cisco Systems’ routing platforms form the single largest population of networking equipment today\n##### � Equivalently distributed in the Internet core, government and corporate networks � Many different hardware platforms with different CPUs � Large investment sums bound to the equipment � Hard to replace � All run basically the same operating system\n#### � Protecting this infrastructure is critical � Therefore, in-depth analysis and diagnostics are of paramount importance\n\n\n-----\n\n# Cisco IOS\n\n#### � Cisco® Internetwork Operating System® � Monolithic operating system � Compile-time linked functionality – the 3 dimensional complexity of IOS\n##### � Platform dependent code � Feature-set dependent code � Major, Minor and Release version dependent code\n#### � Several tens of thousands different IOS images used in today’s networks\n##### � Over 10.000 still officially supported\n\n\n-----\n\n# Inside Cisco IOS\n\n### � One large ELF binary � Essentially a large, statically linked UNIX program\n#### � Loaded by ROMMON, a kind-of BIOS\n### � Runs directly on the router’s main CPU\n#### � If the CPU provides virtual memory and privilege separation (for example Supervisor and User mode on MIPS), it will not be used\n\n\n-----\n\n# Inside Cisco IOS\n\n### � Processes are rather like threads\n#### � No virtual memory mapping per process\n### � Run-to-completion, cooperative multitasking\n#### � Interrupt driven handling of critical events\n### � System-wide global data structures\n#### � Common heap � Very little abstraction around the data structures � No way to force abstraction\n\n\n-----\n\n# The IOS Code Security Issue\n\n#### � 12.4(16a) with enterprise base feature set consists of 25.316.780 bytes binary code!\n##### � This is a 2600 with PowerPC CPU � Not including 505.900 bytes firmware for E1T1 and initialization\n#### � All written in plain C � Sharing the same address space � Sharing the same heap � Sharing the same data structures � Sharing millions of pointers\n\n\n-----\n\n# The IOS Code Security Issue\n\n### � A single mistake in the most unimportant piece of code can influence anything on the system, including kernel, security subsystems and cryptographic code. � Therefore, everything on IOS is a good target for remote code execution exploits in kernel context.\n\n\n-----\n\n# Isn’t Cisco aware of that?\n\n#### � Cisco recently started the distribution of the next generation IOS-XR\n##### � Commercial QNX microkernel � Real processes (memory protection?) � Concurrent scheduling � Significantly higher hardware requirements\n#### � People never use the latest IOS\n##### � Production corporate networks usually run on 12.1 or 12.2, which 12.5 is already available � Not even Cisco’s own engineers would recommend the latest IOS release to a customer � That only covers people actively maintaining their network, not everyone running one\n\n\n-----\n\n## Just, how often are routers hacked?\n\n##### � Keynote speaker Jerry Dixon mentioned not updated routers as a cause for concern\n###### � Do you know how expensive that is?\n##### � Old vulnerabilities like the HTTP level 16 bug are still actively scanned for\n###### � The router is used as a jump pad for further attacks\n##### � TCL backdoors are commonly used � Patched images are not rare\n###### � IOS images cost money � People will use images from anywhere � Patching images is not hard\n##### � Lawful Interception is its own can of worms\n###### � The router’s operator is not supposed to know that LI is performed � Who watches the watchers?\n\n\n-----\n\n# And the future?\n\n#### � Ever noticed attackers take on the target with the lowest efforts required and the highest return of invest?\n##### � Windows became just a lot harder � UNIXes are hardened, even OS X � Infected PCs leave obvious traces\n#### � The question is not: “Will routers become a target?” � The question should be: “Do we want to know when they did?”\n\n\n-----\n\n# Summary – Part I\n\n### � A significant share of the Internet, governmental and corporate networks runs on:\n#### � one out of several tens of thousands of builds � of more or less the same code base � in a single process environment\n### ... and we cannot bypass it, even if we could tell that it’s compromised\n\n Next question: How can we even tell?\n\n\n-----\n\n## Error Handling and Recovery\n\n### � The software architecture of IOS dictates how exception handling has to be done\n#### � Remember, IOS is like a large UNIX process � What happens when a UNIX process segfaults?\n### � Upon an exception, IOS can only restart the entire system\n#### � Even on-board, scheduled diagnostic processes can only forcefully crash the system\n\n\n-----\n\n# Crash Cause Evidence\n\n### � Reboot is a clean recovery method � Reboot destroys all volatile evidence of the crash cause\n#### � Everything on the router is volatile! � Exception: startup configuration and IOS image\n### � Later IOS releases write an information file called “crashinfo”\n#### � Crashinfo contains very little information � Contents depend on what IOS thought was the cause of the crash\n\n\n-----\n\n# Runtime Evidence\n\n### � Crashinfo is only written upon device crashes � Successful attacks don’t cause device crashes � The available methods are:\n#### � Show commands � Debug commands � SNMP monitoring � Syslog monitoring\n\n\n-----\n\n# Show Commands\n\n### � IOS offers a plethora of inspection commands known as the “show” commands\n#### � Requires access to the command line interface\n### � Geared towards network engineers � Thousands of different options and versions � Almost no access to code\n#### � 12.4 even limits memory show commands\n\n\n-----\n\n# Debug Commands\n\n#### � “debug” enables in-code debugging output � Debug output has scheduler precedence\n##### � Too much debug output halts the router � Not an option in production environments\n#### � Enabling the right debug output is an art\n##### � Turn on the wrong ones and you see very little � Turn on too many and the router stops working � Commands depend on the IOS version\n#### � For debug commands to be useful, you have to know what you are looking for before it happens\n##### � Not very useful for security analysis\n\n\n-----\n\n## SNMP and Syslog Monitoring\n\n#### � Commonly accepted method for monitoring networking equipment � SNMP depending on the implemented MIB\n##### � Geared towards networking functionality � Very little process related information\n#### � Syslog is about as useful for security monitoring on IOS as it is on UNIX systems � Both generate continuous network traffic � Both consume system resources on the router � Then again, someone has to read the logs.\n\n\n-----\n\n# Summary – Part II\n\n### � Identifying compromised routers using today’s tools and methods is hard, if not impossible. � There is not enough data to perform any post mortem analysis of router crashes, security related or not. � We cannot distinguish between a functional problem, an attempted attack and a successful attack on infrastructure running IOS.\n\n\n-----\n\n# A (not so) New Approach\n\n### � We need the maximum amount of evidence\n#### � A full snapshot of the device is just enough\n### � We don’t need it continuously\n#### � We need it on-demand � We need it when the device crashes\n### � We need an independent and solid analysis framework to process the evidence\n#### � We need to be able to extend and adjust it\n\n\n-----\n\n# Getting the Evidence\n\n### � Cisco IOS can write complete core dumps\n#### � Memory dump of the main memory � Memory dump of the IO memory � Memory dump of the PCI memory (if applicable)\n### � Core dumps are written in two cases\n#### � The device crashes � The user issues the “write core” command\n\n\n-----\n\n# Core Dump Destinations\n\n### � IOS supports various destinations\n#### � TFTP server (bug!) � FTP server � RCP server � Flash file system (later IOS releases)\n### � Core dumps are enabled by configuration\n#### � Configuration commands do not differ between IOS versions � Configuration change has no effect on the router’s operation or performance\n\n\n-----\n\n## Core Dump Enabled Infrastructure\n\n### � Configure all IOS devices to dump core onto one or more centrally located FTP servers\n#### � Minimizes required monitoring of devices: A router crashed if you find a core dump on the FTP server � Preserves evidence � Allows crash correlation between different routers\n### � Why wasn’t it used before?\n#### � Core dumps were useless, except for Cisco developers and exploit writers.\n\n\n-----\n\n# Analyzing Core Dumps\n\n### Disclaimer: � Any of the following methods can be implemented in whatever your preferred programming language is. � This presentation will be centric to our implementation: Recurity Labs CIR.\n\n\n-----\n\n## Core Dump Analyzer Requirements\n\n### � Must be 100% independent\n#### � No Cisco code � No disassembly based analysis\n### � Must gradually recover abstraction\n#### � No assumptions about anything � Ability to cope with massively corrupted data\n### � Should not be exploitable itself\n#### � Preferably not written in C\n\n\n-----\n\n# The Image Blueprint\n\n### � The IOS image (ELF file) contains all required information about the memory mapping on the router.\n#### � The image serves as the memory layout blueprint, to be applied to the core files\n### � Using a known-to-be-good image also allows verification of the code and read-only data segments\n#### � Now we can easily and reliably detect runtime patched images\n\n\n-----\n\n# Heap Reconstruction\n\n### � IOS uses one large heap � The IOS heap contains plenty of meta-data for debugging purposes\n#### � 40 bytes overhead per heap block in IOS up to 12.3 � 48 bytes overhead per heap block in IOS 12.4\n### � Reconstructing the entire heap allows extensive integrity and validity checks\n#### � Exceeding by far the on-board checks IOS performs during runtime\n\n\n-----\n\n# Heap Verification\n\n#### � Full functionality of “CheckHeaps”\n##### � Verify the integrity of the allocated and free heap block doubly linked lists\n#### � Find holes in addressable heap\n##### � Invisible to CheckHeaps\n#### � Identify heap overflow footprints\n##### � Values not verified by CheckHeaps\n#### � Map heap blocks to referencing processes � Identify formerly allocated heap blocks\n##### � Catches memory usage peaks from the recent past\n\n\n-----\n\n# Process List\n\n### � Extraction of the IOS Process List\n#### � Identify the processes’ stack block\n##### � Create individual, per process back-traces � Identify return address overwrites\n#### � Obtain the processes’ scheduling state � Obtain the processes’ CPU usage history � Obtain the processes’ CPU context\n### � Almost any post mortem analysis method known can be applied, given the two reconstructed data structures.\n\n\n-----\n\n# TCL Backdoor Detection\n\n#### � TCL scripting is available on later Cisco IOS versions � TCL scripts listening on TCP sockets\n##### � Well known method � Used to simplify automated administration � Used to silently keep privileged access to routers � Known bug: not terminated when the VTY session ends (fixed) � Simple TCL backdoor scripts published\n#### � CIR can extract all TCP script chunks from IOS heap and dump them for further analysis\n\n\n-----\n\n# Your Wishes Please !\n\n#### � Interface tables � CDP tables � Static routing � Spanning tree � Router processes � Access Lists � VLAN tables � CEF Tree � VPN context � User sessions\n##### � Keys � Listening ports � User\n � Callback code for\n\n#### � IPv6 tables incoming connections\n\n##### � Verification that it is\n\n#### � ARP tables\n\n##### located in .TEXT\n\n#### � Dialer tables\n\n\n-----\n\n## IOS Packet Forwarding Memory\n\n#### � IOS performs routing either as:\n##### � Process switching � Fast switching � Particle systems � Hardware accelerated switching\n#### � Except hardware switching, all use IO memory\n##### � IO memory is written as separate code dump � By default, about 6% of the router’s memory is dedicated as IO memory\n###### � In real world installations, it is common to increase the percentage to speed up forwarding\n#### � Hardware switched packets use PCI memory\n##### � PCI memory is written as separate core dump\n\n\n-----\n\n# IO Memory Buffers\n\n#### � Routing (switching) ring buffers are grouped by packet size\n##### � Small � Medium � Big � Huge\n#### � Interfaces have their own buffers for locally handled traffic � IOS tries really hard to not copy packets around in memory � New traffic does not automatically erase older traffic in a linear way\n\n\n-----\n\n# Traffic Extraction\n\n#### � CIR dumps packets that were process switched by the router from IO memory into a PCAP file\n##### � Traffic addressed to and from the router itself � Traffic that was process switching inspected\n###### � Access List matching � QoS routed traffic\n#### � CIR could dump packets that were forwarded through the router too\n##### � Reconstruction of packet fragments possible � Is it desirable?\n\n\n-----\n\n# Advanced Traffic Extraction\n\n#### � Writing core to a remote server uses IO memory\n##### � Overwrites part of the traffic evidence\n#### � CIR can use a GDB link instead of a core dump\n##### � Serial GDB protocol allows direct access to router memory via the console � Uses Zynamics GDB debug link\n#### � Disconnecting all network interfaces preserves IO and PCI memory contents\n##### � Using GDB halts the router\n#### � All data is preserved – useful for emergency inspections\n\n\n-----\n\n## Traffic Extraction Applications\n\n### � Identification of attack jump pad routers � 0day identification against systems on segmented network interfaces\n#### � If you got the packet, you got the 0day\n### � Spoofing attack backtracking\n#### � One hop at the time, obviously\n### � LE detection\n\n\n-----\n\n# Challenges\n\n##### � The analysis framework has to handle the complexity of the Cisco IOS landscape\n###### � Hardware platforms � Image versions � Any-to-Any relation!\n##### � CIR is currently IOS feature set independent � CIR successfully tested against IOS 12.0 – 12.5 � CIR currently supports\n###### � Cisco 1700 � Cisco 2600 � Cisco 3600 (upcoming) � Cisco 7200 (upcoming)\n##### � Your wishes decide the course.\n\n\n-----\n\n# Summary – Part III\n\n#### � Writing core dumps is a viable method for obtaining IOS evidence when it is needed.\n##### � The evidence includes forwarded and received packets.\n#### � An independent analysis framework can distinguish between bugs and attacks, enabling real forensics on IOS routers. � Recurity Labs’ CIR already reliably identifies many types of attacks and IOS backdoors.\n##### � CIR is work-in-progress � CIR’s future depends on the feedback we receive from the community.\n\n\n-----\n\n# Initial Public Offer\n\n#### � An analysis framework’s quality is directly related to the amount of cases it has seen\n##### � CIR needs a lot more food to grow up � We want to provide it to everyone while constantly developing and improving it\n#### � Free Service: http://cir.recurity-labs.com\n##### � Processing on our servers � Always using the latest version � Please be gentle, it’s the   version\n\n## α\n\n#### � Given enough interest, there will be a professional tool in the future\n\n\n-----\n\n# At the end, it’s all up to you!\n\n### � We think CIR could be useful\n#### � For the networking engineer � For the forensics professional � To finally know the state of our infrastructure\n### � We can think of way too many things\n#### � Platforms � Features � Reports\n### � Please help ☺\n\n\n-----\n\n# cir.recurity-labs.com\n\n##### Felix ´FX´ Lindner\n###### Head\n\n fx@recurity-labs.com\n\n Recurity Labs GmbH, Berlin, Germany http://www.recurity-labs.com\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://www.recurity-labs.com/research/RecurityLabs_Developments_in_IOS_Forensics.pdf"
    ],
    "report_names": [
        "RecurityLabs_Developments_in_IOS_Forensics.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716499,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1204907973,
    "ts_modification_date": 1204908927,
    "files": {
        "pdf": "https://archive.orkl.eu/a3d51c820a7f44fe2d5d2bc1616dba298c76b65e.pdf",
        "text": "https://archive.orkl.eu/a3d51c820a7f44fe2d5d2bc1616dba298c76b65e.txt",
        "img": "https://archive.orkl.eu/a3d51c820a7f44fe2d5d2bc1616dba298c76b65e.jpg"
    }
}