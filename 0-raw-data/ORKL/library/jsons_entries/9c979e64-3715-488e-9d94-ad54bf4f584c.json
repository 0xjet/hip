{
    "id": "9c979e64-3715-488e-9d94-ad54bf4f584c",
    "created_at": "2023-01-12T15:06:07.599962Z",
    "updated_at": "2025-03-27T02:12:11.071142Z",
    "deleted_at": null,
    "sha1_hash": "e4cdb943fc2885ac39e7a9683d884aaf22aca881",
    "title": "2021-12-01 - Analyzing How TeamTNT Used Compromised Docker Hub Accounts",
    "authors": "",
    "file_creation_date": "2022-05-28T18:14:17Z",
    "file_modification_date": "2022-05-28T18:14:17Z",
    "file_size": 1416258,
    "plain_text": "# Analyzing How TeamTNT Used Compromised Docker Hub Accounts\n\n**[trendmicro.com/en_us/research/21/l/more-tools-in-the-arsenal-how-teamtnt-used-compromised-docker-hu.html](https://www.trendmicro.com/en_us/research/21/l/more-tools-in-the-arsenal-how-teamtnt-used-compromised-docker-hu.html)**\n\nDecember 1, 2021\n\nCloud\n\nFollowing our previous disclosure of compromised Docker hub accounts delivering cryptocurrency miners, we\nanalyze these accounts and discover more malicious actions that you need to be aware of.\n\nBy: Trend Micro Research December 01, 2021 Read time: ( words)\n\n[In early November, we disclosed that compromised Docker Hub accounts were being used for cryptocurrency](https://www.trendmicro.com/en_us/research/21/k/compromised-docker-hub-accounts-abused-for-cryptomining-linked-t.html)\nmining and that these activities were tied to the TeamTNT threat actor. While those accounts have now been\nremoved, we were still able to investigate TeamTNT’s activities in connection with these compromised\naccounts.\n\nIn addition to the behavior we noted earlier, we identified several other actions that the same threat actor\ncarried out in different venues. One was the use of Weave Scope, a legitimate tool by Weaveworks used to\nmonitor/control deployed containers.\n\n**Weave ScopeWeave Scope is a visualization and monitoring tool for Docker and Kubernetes. System**\nadministrators can use this to monitor and control their deployed containers/pods/workloads.\n\n\n-----\n\nFigure 1. Weave Scope window\n\nOne can manage running containers by executing, rebooting, pausing, stopping or even deleting containers, all\nof which can be controlled from a web console (either local or in the cloud).\n\nIn this attack scenario, the compromised underlying host was made a node of the threat actor-controlled\nWeave Scope Cloud instance, from where they could execute various commands.\n\nFigure 2.\n\nTerminal command executed via Weave Scope\nThe administration features make Weave Scope an interesting target. This is how attackers targeted this\nrecently:\n\n**1. The attacker spins up a new privileged container based on an image from a compromised account. In the**\narguments, the attacker attempts to mount the root file system of the underlying host to the ‘/host’ mount point\nand executes a bash script fetched from the attacker’s infrastructure.\n\n\n-----\n\nFigures 3-5. Code to spin up new container\n\n**2. The script ‘scope2.sh’ is downloaded and piped to ‘bash’ to be executed. The script initially checks if the**\nhostname’s value is ‘HaXXoRsMoPPeD’ halting the execution if true. This looks like a flag to check if a system\nhas already been compromised.\n\nFigure 6. Script checking for hostname\n\n**3. Environment variables are set, which overrides localization settings, prevents command history logging, and**\nexports a new path.\n\n**4. A variable ‘SCOPE_TOKEN’ is populated from a controlled endpoint, which contains the Weave Scope**\nservice token. ‘SCOPESHFILE’ contains the Weave Scope script, which is encoded in base64.\n\nFigure 7. Encoded\n\nscript\n**5. The path to ‘docker’ binary is fetched using ‘type docker’. To evade any TTY events, they’re redirected to**\n‘/dev/null’. Based on this, the execution proceeds.\n\n\n-----\n\n**6. The file /tmp/.ws is checked:**\n\na. If the file doesn’t exist, the following commands are executed:\n\ni. The ‘/tmp/’ path is remounted with read-write permissions using the ‘mount’ utility.\n\nii. The base64 encoded string of the ‘SCOPESHFILE’ variable is decoded and the output is redirected to\n‘/tmp/.ws’. This is the Weaveworks’ script and is hidden by default since the file name begins with a ‘.\n\niii. The permissions of the newly created script are changed to executable using ‘chmod’\n\nb. If the file ‘/tmp/.ws’ exists, then execution proceeds as follows:\n\ni. The ‘/tmp/’ path is remounted as read-write using ‘mount’ utility.\n\nii. The Weaveworks utility Weave Scope at /tmp/.ws is stopped and launched with the service token fetched on\nstep 4.\n\nFigure 8. Stop and relaunch of Weave Scope utility\n\n[Weaveworks published a blog post in September 2020 that shared best practices for securing Weave Scope.](https://www.weave.works/blog/preventing-malicious-use-of-weave-scope)\nUnfortunately, the abuse of this legitimate tool is still quite prevalent.\n\n**Trend Micro Solutions**\n\n_Cloud One Workload Security™_\n\nWhen a new container is created over Docker daemon’s REST API, the rule ‘1010326 – Identified Docker\nDaemon Remote API Call’ triggers with different notes for different steps of the container creation from image.\n\nEvents are generated when the 'containerd’ process is created and are logged using the Integrity Monitoring\nmodule:\n\n\n-----\n\nFigure 9: Alert for containerd process\n\nWhen the Docker Daemon is observed listening on TCP port, the Log Inspection module detects this as seen\nbelow:\n\nFigure 10. Results of Log Inspection module\n\nThe AntiMalware Module detects the malicious script ‘scope2.sh’ as a Trojan:\n\nFigure 11. Detection of malicious script\n\nIntrusion Prevention\n\n1. 1010326 - Identified Docker Daemon Remote API Call\n2. 1010561 - Identified Kubernetes Unprotected Primary Channel Information Disclosure\n3. 1010762 - Identified Kubernetes API Server LoadBalancer Status Patch Request\n4. 1010769 - Identified Kubernetes Namespace API Requests\n5. 1009493 - Kubernetes Dashboard Authentication Bypass Information Disclosure Vulnerability (CVE-2018\n18264)\n6. 1009450 - Kubernetes API Proxy Request Handling Privilege Escalation Vulnerability (CVE-2018\n1002105)\n7. 1009561 - Kubernetes API Server Denial of Service Vulnerability (CVE-2019-1002100)\n\nLog Inspection\n\n\n-----\n\n1. 1009105 Kubernetes\n2. 1008619 - Application – Docker\n3. 1010349 - Docker Daemon Remote API Calls\n\nIntegrity Monitoring\n\n1. 1008271 – Application - Docker\n2. 1009060 - Application - Kubernetes Cluster master\n3. 1009434 - Application - Kubernetes Cluster node\n\n_Cloud One Network Security™_\n\nThe following rules are triggered by this attack in Network Security:\n\n29993: HTTP: Docker Container With Root Directory Mounted with Write Permission Creation Attempt\n33719: HTTP: Docker Daemon \"create/exec\" API with \"Cmd\" Key Set to Execute Shell Commands\n33905: HTTP: Kubernetes API Proxy Request Handling Privilege Escalation Vulnerability\n34487: HTTP: Kubernetes Dashboard Authentication Bypass Vulnerability\n34488: HTTPS: Kubernetes Dashboard Authentication Bypass Vulnerability\n34668: HTTP: Docker Build Image API Request with remote and networkmode Parameters Set\n34796: HTTP: Docker Version API Check Request\n35799: HTTP: Kubernetes Overlength json-patch Request\n38836: HTTP: Kubernetes API Namespaces Request\n38837: HTTP: Kubernetes API Namespaces Status Request\n38838: HTTP: Kubernetes API Create Namespace Request\n38839: HTTP: Kubernetes API Delete Namespace Request\n38840: HTTP: Kubernetes API Update Namespace Request\n38847: HTTP: Kubernetes API Server loadBalancer Status Patch Request\n38892: HTTP: Kubernetes API Admission Control Create Mutating Webhook Request\n38893: HTTP: Kubernetes API Admission Control Create Validating Webhook Request\n38896: HTTP: Kubernetes API Admission Control Resources Request\n38898: HTTP: Kubernetes API Admission Control List Mutating Webhook Configurations Request\n38899: HTTP: Kubernetes API Admission Control List Validating Webhook Configurations Request\n38901: HTTP: Kubernetes API Admission Control Delete Validating Webhook Request\n38902: HTTP: Kubernetes API Admission Control Delete Mutating Webhook Request\n38903: HTTP: Kubernetes API Admission Control Update Validating Webhook Request\n38904: HTTP: Kubernetes API Admission Control Update Mutating Webhook Request\n38905: HTTP: Kubernetes API Admission Control Read Mutating Webhook Request\n38906: HTTP: Kubernetes API Admission Control Read Validating Webhook Request\n38907: HTTP: Kubernetes API Admission Control Replace Mutating Webhook Request\n38908: HTTP: Kubernetes API Admission Control Replace Validating Webhook Request\n38909: HTTP: Kubernetes API CustomResourceDefinition Resources Request\n38910: HTTP: Kubernetes API Create CustomResourceDefinition Request\n38916: HTTP: Kubernetes API List CustomResourceDefinition Resources Request\n38917: HTTP: Kubernetes API Update CustomResourceDefinition Resources Request\n38918: HTTP: Kubernetes API Update Status CustomResourceDefinition Resources Request\n38919: HTTP: Kubernetes API Read CustomResourceDefinition Resources Request\n\n_Trend Micro Vision One™_\n\n\n-----\n\nFigure 12.\n\nDetection Model for Weave Scope abuse\nSince Weave Scope is a legitimate tool used in workloads, one can enable or disable the XDR Model from\nDetection Model Management by toggling the ‘Status’. If the tool is not supposed to be used in the environment\nand there are alerts as XDR Model triggers or Observed Attack Techniques, it must be checked.\n\n_Workbench_\n\nFigure 13.\n\nWorkbench diagram\nThe diagram in Figure 13 demonstrates the power of correlation amongst different Cloud One™ modules,\ncomposed into a single screen. The left panel shows the sequence of observed attack techniques with the\nevents generated from Cloud One™ modules, while the right panel details the various objects involved in this\nattempt. The corresponding MITRE ATT&CK tags help identify the parts of the framework being abused.\n\n\n-----\n\nFigure\n\n14. Workbench diagram\nThis Workbench shows all the workloads using the Impact Scope in the organization where the unencrypted\nDocker REST API is exposed and on which it’s listening.\n\n_Root Cause Analysis_\n\n\n-----\n\n-----\n\nFigure 15 and 16. Root cause analysis diagrams\nIn the RCAs generated from the Observed Attack Techniques, we can deep dive into the various fields of\nimportance, such as the exact time at which the outbound connection was observed and the process lineage\nwith the process command line. This shows that ‘nsenter’ is being executed from ‘scope’, it’s being used to\ncreate a ‘bash’ shell, and the context is fetched from the PID 1 or ‘init’ process responsible for starting and\nshutting down the system.\n\nEscaping from a compromised container\n\nBased on our research, the attackers also used a well-known technique to escape from a compromised\ncontainer to the host. They did this by using bind mounts and fetching the Docker Hub credentials from the\nfollowing paths:\n\n1. /root/.docker/config.json\n2. /home/*/.docker/config.json\n\nAs per Docker’s [official documentation:](https://docs.docker.com/engine/reference/commandline/login/)\n\n“You can log into any public or private repository for which you have credentials. When you log in, the\ncommand stores credentials in $HOME/.docker/config.json on Linux or\n%USERPROFILE%/.docker/config.json”.\n\nWhen someone logs into their Docker Hub account using the Docker command line and there are no credential\nstores specified, the username, password and registry server link are populated as a JSON that looks like this:\n\n\n-----\n\nFigure\n\n17. Code with Docker login\nBy default, the registry used is of Docker Inc. The value of ‘auths.auth’ field is the base64-encoded string that\ncontains the credentials in the format ‘username:password’. If these credentials are compromised, one can\ngain access to the victims’ information:\n\n1. Email ID used to create the account\n2. Private Images\n3. Access tokens\n4. Slack Webhooks\n5. Content Subscriptions\n6. Upgraded features\n\nNow we take a look into how the enumeration of exposed kubelets was performed.\n\nEnumeration Of Exposed Kubelets\n\nThis attack abused the Docker REST API to create a container from an image that had a script at the\nfilesystem path ‘/root/init.sh’, which contains the following:\n\n**1. They initially update the alpine-based container and add the packages they need in later operations, like**\ncompiling zgrab from source, using masscan, etc.\n\nFigure 18. Building zgrab\n\n**2. Once the above steps are executed, they begin the execution of their malicious function using a kill switch,**\nwhich is based on the contents of a certain endpoint on the attacker’s infrastructure to be equal to ‘RUN’.\n\nFigure 19. Executing malicious\n\nfunctions\n**3. Once the kill switch is confirmed to be equal to ‘RUN’, the malicious PWN function is executed.**\n\n\n-----\n\nFigure 20: Checking for\n\nthe kill switch\nThis script fetches a scan range from a malicious server endpoint. If the results fetched contain ‘ENDE’, that\nsignals the exit of the malicious script.\n\nThe results returned by the endpoint is stored in the variable ‘SCAN_RANGE’, which is later appended to\n‘.0.0.0/8’. For example, if the value returned from the endpoint is 10, then the value of ‘SCAN_RANGE’ will be\n‘10.0.0.0/8’\n\nThe variable ‘rndstr’ is a six-letter random alphabetical string that accumulates a list of IP addresses of running\npods with the kubelet API TCP port 10250 exposed that have been found using masscan and zgrab. Once this\nsubnet is completed, the results are sent back to the threat actor using a for loop, which iterates over the\nresults acquired via a website.\n\nOnce the results are sent, the kill switch loop loops back for a new subnet from the infrastructure unless all the\nsubnets are enumerated.\n\n[The threat actor seems to do this as preparation to later target exposed kubelets. Earlier, we detailed about the](https://www.trendmicro.com/en_us/research/21/k/teamtnt-upgrades-arsenal-refines-focus-on-kubernetes-and-gpu-env.html)\nshift in focus from Docker REST API to Kubernetes API. Here’s a trend of exposed Kubernetes API port 10250\nindexed by Shodan from approximately 1,200 exposed workloads, months ago:\n\nFigure 21. Growth in exposed port 10250\n\n**Trend Micro Solutions**\n\n_Cloud One Workload Security™_\n\nIntrusion Prevention\n\n1. 1010326 - Identified Docker Daemon Remote API Call\n2. 1010561 - Identified Kubernetes Unprotected Primary Channel Information Disclosure\n3. 1010762 - Identified Kubernetes API Server LoadBalancer Status Patch Request\n4. 1010769 - Identified Kubernetes Namespace API Requests\n5. 1009493 - Kubernetes Dashboard Authentication Bypass Information Disclosure Vulnerability (CVE-2018\n18264)\n\n\n-----\n\n6. 1009450 Kubernetes API Proxy Request Handling Privilege Escalation Vulnerability (CVE 2018\n\n1002105)\n7. 1009561 - Kubernetes API Server Denial of Service Vulnerability (CVE-2019-1002100)\n\nLog Inspection\n\n1. 1009105 – Kubernetes\n2. 1008619 - Application – Docker\n3. 1010349 - Docker Daemon Remote API Calls\n\nIntegrity Monitoring\n\n1. 1008271 – Application - Docker\n2. 1009060 - Application - Kubernetes Cluster master\n3. 1009434 - Application - Kubernetes Cluster node\n\nCloud One Network Security™C\n\n29993: HTTP: Docker Container With Root Directory Mounted with Write Permission Creation Attempt\n33719: HTTP: Docker Daemon \"create/exec\" API with \"Cmd\" Key Set to Execute Shell Commands\n33905: HTTP: Kubernetes API Proxy Request Handling Privilege Escalation Vulnerability\n34487: HTTP: Kubernetes Dashboard Authentication Bypass Vulnerability\n34488: HTTPS: Kubernetes Dashboard Authentication Bypass Vulnerability\n34668: HTTP: Docker Build Image API Request with remote and networkmode Parameters Set\n34796: HTTP: Docker Version API Check Request\n35799: HTTP: Kubernetes Overlength json-patch Request\n38836: HTTP: Kubernetes API Namespaces Request\n38837: HTTP: Kubernetes API Namespaces Status Request\n38838: HTTP: Kubernetes API Create Namespace Request\n38839: HTTP: Kubernetes API Delete Namespace Request\n38840: HTTP: Kubernetes API Update Namespace Request\n38847: HTTP: Kubernetes API Server loadBalancer Status Patch Request\n38892: HTTP: Kubernetes API Admission Control Create Mutating Webhook Request\n38893: HTTP: Kubernetes API Admission Control Create Validating Webhook Request\n38896: HTTP: Kubernetes API Admission Control Resources Request\n38898: HTTP: Kubernetes API Admission Control List Mutating Webhook Configurations Request\n38899: HTTP: Kubernetes API Admission Control List Validating Webhook Configurations Request\n38901: HTTP: Kubernetes API Admission Control Delete Validating Webhook Request\n38902: HTTP: Kubernetes API Admission Control Delete Mutating Webhook Request\n38903: HTTP: Kubernetes API Admission Control Update Validating Webhook Request\n38904: HTTP: Kubernetes API Admission Control Update Mutating Webhook Request\n38905: HTTP: Kubernetes API Admission Control Read Mutating Webhook Request\n38906: HTTP: Kubernetes API Admission Control Read Validating Webhook Request\n38907: HTTP: Kubernetes API Admission Control Replace Mutating Webhook Request\n38908: HTTP: Kubernetes API Admission Control Replace Validating Webhook Request\n38909: HTTP: Kubernetes API CustomResourceDefinition Resources Request\n38910: HTTP: Kubernetes API Create CustomResourceDefinition Request\n38916: HTTP: Kubernetes API List CustomResourceDefinition Resources Request\n38917: HTTP: Kubernetes API Update CustomResourceDefinition Resources Request\n38918: HTTP: Kubernetes API Update Status CustomResourceDefinition Resources Request\n38919: HTTP: Kubernetes API Read CustomResourceDefinition Resources Request\n\n\n-----\n\nConclusion\n\nVulnerabilities posed by poor security misconfigurations or inherent software bugs are difficult to protect. In the\nabove case, we observed the use of legitimate platforms like Weaveworks. To stay protected, we need to\nrethink about inculcating security in our daily work by regular patching, staying updated and alerted with the\nlatest happenings in cyberspace.\n\n[Trend Micro™ Cloud One™ – Workload Security equips defenders and analysts with the ability to protect](https://www.trendmicro.com/en_us/business/products/hybrid-cloud/cloud-one-workload-security.html)\nsystems against vulnerabilities, exploits, and malware, offering protection from on-premise to cloud workloads.\nVirtual patching can protect critical systems even before the official patches are made available.\n\n[Trend Micro™ Vision One™ provides a clear view of the most important events as alerts in a concise manner,](https://www.trendmicro.com/en_us/business/products/detection-response.html)\nbecause the race is about quick response. With XDR capabilities with telemetries from your multi-cloud\nenvironments or on-premise workloads, security teams get a clear and vivid understanding of what to prioritize.\n\nIndicators Of Compromise\n\n_IP address_\n\n45.9.148[.]182\n\n_Domain_\n\ndl[.]chimaera.cc\n\n_Shell scripts_\n\nHash Detection Name\n\n7c110dc507ed4e2694500c7c37fe9176e9f4db23bc4753c0bfc9f3479eb6385a Trojan.SH.MALXMR.UWELG\n\nb7cef848b61cfb7d667e60ade3a1781def69f5395b5ad6a2a16f7b7fa11ef1db Trojan.Win32.FRS.VSNW0CK21\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-01 - Analyzing How TeamTNT Used Compromised Docker Hub Accounts.pdf"
    ],
    "report_names": [
        "2021-12-01 - Analyzing How TeamTNT Used Compromised Docker Hub Accounts.pdf"
    ],
    "threat_actors": [
        {
            "id": "f809bfcb-b200-4988-80a8-be78ef6a52ef",
            "created_at": "2023-01-06T13:46:39.186988Z",
            "updated_at": "2025-03-27T02:00:03.016358Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "Adept Libra"
            ],
            "source_name": "MISPGALAXY:TeamTNT",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c3ca592f-0669-49bd-ab5c-310007ab2fb4",
            "created_at": "2022-10-25T15:50:23.334495Z",
            "updated_at": "2025-03-27T02:00:55.445098Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "TeamTNT"
            ],
            "source_name": "MITRE:TeamTNT",
            "tools": [
                "Peirates",
                "MimiPenguin",
                "LaZagne",
                "Hildegard"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535967,
    "ts_updated_at": 1743041531,
    "ts_creation_date": 1653761657,
    "ts_modification_date": 1653761657,
    "files": {
        "pdf": "https://archive.orkl.eu/e4cdb943fc2885ac39e7a9683d884aaf22aca881.pdf",
        "text": "https://archive.orkl.eu/e4cdb943fc2885ac39e7a9683d884aaf22aca881.txt",
        "img": "https://archive.orkl.eu/e4cdb943fc2885ac39e7a9683d884aaf22aca881.jpg"
    }
}