{
    "id": "d4abcf66-26ed-4a19-af02-5a8b3ec19f6b",
    "created_at": "2023-01-12T15:00:38.980846Z",
    "updated_at": "2025-03-27T02:05:48.392908Z",
    "deleted_at": null,
    "sha1_hash": "77eb2b1550132af8637f7bc504dc0143910847da",
    "title": "2014-10-30 - COM Object hijacking- the discreet way of persistence",
    "authors": "",
    "file_creation_date": "2022-05-27T23:13:04Z",
    "file_modification_date": "2022-05-27T23:13:04Z",
    "file_size": 340565,
    "plain_text": "# COM Object hijacking: the discreet way of persistence\n\n**[gdatasoftware.com/blog/2014/10/23941-com-object-hijacking-the-discreet-way-of-persistence](https://www.gdatasoftware.com/blog/2014/10/23941-com-object-hijacking-the-discreet-way-of-persistence)**\n\nG DATA SecurityLabs experts discovered a new Remote Administration Tool, which we\ndubbed COMpfun. This RAT supports 32-bit and 64-bit Windows versions, up to the\nWindows 8 operating system. The features are rather common for today’s espionage tools:\nfile management (download and upload), screenshot taking, Keylogger functionality, code\nexecution possibility and more. It uses the HTTPS and an asymmetric encryption (RSA) to\ncommunicate with the command and control server. The big novelty is the persistence\nmechanism: the malware hijacks a legitimate COM object in order to be injected into the\nprocesses of the compromised system. And it is remarkable, that this hijacking action does\nnot need administrator rights. With this RAT, Attackers could spy on an infected system for\nquite a long time, as this detection evasion and persistence mechanism is indeed pretty\nadvanced!\n\n## What is a COM object?\n\n[COM (Component Object Model) is described by Microsoft as “platform-independent,](http://msdn.microsoft.com/en-us/library/windows/desktop/ms694363%28v=vs.85%29.aspx)\ndistributed, object-oriented system for creating binary software components that can\ninteract”. The purpose of this technology is to provide an interface to allow developers to\ncontrol and manipulate objects of other applications. We already spoke about this technology\nin the [IcoScript case. Each COM object is defined by a unique ID called CLSID. For example](https://www.virusbtn.com/virusbulletin/archive/2014/08/vb201408-IcoScript)\nthe CLSID to create an instance of Internet Explorer is {0002DF01-0000-0000-C000000000000046}.\n\n## COM object hijacking analysis\n\nDuring the installation phase, the malware drops two files into the directory:\n%APPDATA%\\Roaming\\Microsoft\\Installer\\{BCDE0395-E52F-467C-8E3D-C4579291692E}\\\n\nThe file names are created using the following scheme: api-ms-win-downlevel-[4charrandom]-l1-1-0._dl\n\nOne file is the 32-bit version of the malware and the second one is the 64-bit version.\n\nThe second step: the creation of two registry entries:\n\nHKCU\\Software\\Classes\\CLSID\\{b5f8350b-0548-48b1-a6ee88bd00b4a5e7}\\InprocServer32\nHKCU\\Software\\Classes\\Wow6432Node\\CLSID\\{BCDE0395-E52F-467C-8E3DC4579291692E }\\InprocServer32\n\n\n-----\n\nFor each entry, the default value is the path to the files that were dropped before. In the\nfollowing screenshot, the file containing rhwm is the 64-bit version of the malware and the file\ncontaining dtjb was created for the 32-bit version, respectively.\n\nThe purpose of the keys is to define a COM object with the CLSIDs {b5f8350b-0548-48b1a6ee-88bd00b4a5e7} and {BCDE0395-E52F-467C-8E3D-C4579291692E}. If these objects\nare instanced, the library will be loaded into the respective process. But the CLSIDs are\npredefined by Microsoft and the newly created owns replace the originals:\n\n{b5f8350b-0548-48b1-a6ee-88bd00b4a5e7}: the CLSID of the class\n[CAccPropServicesClass.](http://msdn.microsoft.com/en-us/library/accessibility.caccpropservicesclass%28v=vs.110%29.aspx?cs-save-lang=1&cs-lang=cpp#code-snippet-1)\n{BCDE0395-E52F-467C-8E3D-C4579291692E}: it’s the CLSID of the class\n[MMDeviceEnumerator.](http://msdn.microsoft.com/en-us/library/windows/desktop/dd316556%28v=vs.85%29.aspx)\n\nThese two instances are used by a lot of applications, for example by the browser (by using\nthe CoCreateInstance() function). With Process Explorer, we are able to list the library\nloaded into a specific process. Here are the loaded libraries designed for a 32-bit process:\n\n\n-----\n\nThe following screenshot shows the loaded libraries in a 64-bit process:\n\n\n-----\n\nIn both of these cases, we can see our dropped library. The processes use the registry key\npreviously created to load the malicious library instead of the original Microsoft library\n\n## Conclusion\n\nThis new approach of persistence mechanism has several advantages: the attacker does not\nneed to perform DLL injection, which is usually monitored by anti-virus software. Therefore,\nhe has overcome one important security measure, in most of the cases.\n\nAs soon as the infection was successful, Microsoft Windows then natively executes the\nlibrary in the processes of the infected user. Hence, the attacking process is hard to be\nidentified. Using COM hijacking is undoubtedly silent. It is not even detected by Sysinternals’\nAutoruns.\n\nSo, in our case, we have seen this mechanism being used combined with a RAT and this\nwould mean a hassle for any infected and therefore affected user, as the attackers can spy\non him pretty secretly for quite some time. But, obviously, this new persistence mechanism is\nnot limited to the use of RATs. Attackers can combine it with any other type of malware, too!\n\nG DATA customers are protected: the latest scan engines detect the analyzed samples (see\nbelow). Furthermore, our behavior blocker technology identifies this threat and blocks it.\n\n\n-----\n\n## IOC\n\n Registry\n\nHKCU\\Software\\Classes\\CLSID\\{b5f8350b-0548-48b1-a6ee-88bd00b4a5e7}\\\nHKCU\\Software\\Classes\\Wow6432Node\\CLSID\\{BCDE0395-E52F-467C-8E3DC4579291692E }\n\n## Files\n\n%APPDATA%\\Roaming\\Microsoft\\Installer\\{BCDE0395-E52F-467C-8E3DC4579291692E}\\\n\nThe file names are created using the following scheme: api-ms-win-downlevel-[4charrandom]-l1-1-0._dl\n\n## MD5\n\n482a70b7f29361665c80089fbf49b41f\n(Trojan.Generic.11683196; Win32.Trojan.COMpfun.B)\n88fc61bcd28a9a0dc167bc78ba969fce\n(Trojan.Generic.11671459; Win32.Trojan.COMpfun.A)\n11f814e7fb9616f46c6e4b72e1cf39f6\n(Gen:Trojan.Heur2.LP.dq8@aKnXWtic; Win32.Trojan.COMpfun.C)\n671d230ae8874bb89db7099d1c8945e0\n(Win64.Trojan.COMpfun.C)\n\n---------------------------------\n### Side note:\n\nYou are maybe wondering about the malware signature name containing “fun”. During our\nanalysis, the [4char-random] value of the malware name was “pfun” and… yeah, we thought\nthat this was ‘fun’ny, indeed ;-)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2014/2014-10-30 - COM Object hijacking- the discreet way of persistence.pdf"
    ],
    "report_names": [
        "2014-10-30 - COM Object hijacking- the discreet way of persistence.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535638,
    "ts_updated_at": 1743041148,
    "ts_creation_date": 1653693184,
    "ts_modification_date": 1653693184,
    "files": {
        "pdf": "https://archive.orkl.eu/77eb2b1550132af8637f7bc504dc0143910847da.pdf",
        "text": "https://archive.orkl.eu/77eb2b1550132af8637f7bc504dc0143910847da.txt",
        "img": "https://archive.orkl.eu/77eb2b1550132af8637f7bc504dc0143910847da.jpg"
    }
}