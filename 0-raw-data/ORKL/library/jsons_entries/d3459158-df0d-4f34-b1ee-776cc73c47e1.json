{
    "id": "d3459158-df0d-4f34-b1ee-776cc73c47e1",
    "created_at": "2023-01-12T15:01:11.123942Z",
    "updated_at": "2025-03-27T02:05:20.129238Z",
    "deleted_at": null,
    "sha1_hash": "e1415f94f6ddd798edd47005500bd9f7aa5efcc1",
    "title": "2015-04-27 - Threat Spotlight- TeslaCrypt – Decrypt It Yourself",
    "authors": "",
    "file_creation_date": "2022-05-27T18:59:03Z",
    "file_modification_date": "2022-05-27T18:59:03Z",
    "file_size": 1056570,
    "plain_text": "# Threat Spotlight: TeslaCrypt – Decrypt It Yourself\n\n**blogs.cisco.com/security/talos/teslacrypt**\n\nTalos Group April 27, 2015\n\n_[This post was authored by: Andrea Allievi,](http://blogs.cisco.com/author/AndreaAllievi)_ _[Earl Carter &](http://blogs.cisco.com/author/earlcarter)_ _[Emmanuel Tacheau](http://blogs.cisco.com/author/emmanueltacheau)_\n\n_Update 4/28: Windows files recompiled with backward compatibility in Visual Studio 2008_\n\n_[Update 5/8: We’ve made the source code available via Github here](https://github.com/vrtadmin/TeslaDecrypt)_\n\n_[Update 6/9/2016: We’ve released a tool to decrypt any TeslaCrypt Version](http://blog.talosintel.com/2016/06/teslacrypt-decryptor.html)_\n\nAfter the takedown of Cryptolocker, we have seen the rise of Cryptowall. Cryptowall 2\nintroduced “features” such as advanced anti-debugging techniques, only to have many of\nthose features removed in Cryptowall 3. Ransomware is becoming an extremely lucrative\nbusiness, leading to many variants and campaigns targeting even localized regions in their\nown specific languages. Although it is possible that these multiple variants are sponsored by\nthe same threat actor, the most likely conclusion is that multiple threat actors are jumping in\nto claim a portion of an ever increasing ransomware market. One of the latest variants is\ncalled TeslaCrypt and appears to be a derivative of the original Cryptolocker ransomware.\n\n\n-----\n\nAlthough it claims to be using asymmetric RSA-2048 to encrypt files, it is making use of\nsymmetric AES instead. Talos was able to develop a tool which decrypts the files encrypted\nby the TeslaCrypt ransomware.\n\nClick for Larger\n\nImage\n\nAt the first glance, the dropper appears to be related to the original CryptoLocker. The\nmalware states that data files, such as photos, videos and documents on the victim’s\ncomputer have been encrypted with the RSA-2048 asymmetric algorithm. As we shall see,\nthat statement is not entirely accurate.\n\nTargeting files that users value highly makes ransomware very effective at getting users to\npay the ransom. TeslaCrypt is interesting because it also targets and encrypts computer\ngames files, such as saved games and Steam activation keys. This means that TeslaCrypt is\ntargeting many different types of users, including PC gamers. Just like irreplaceable photos,\na game save, which is the product of countless hours of gaming, is extremely valuable and\nhard to replace.\n\nWe have analysed two samples of TeslaCrypt, the first dated March 2015 and the second\ndated April 2015. Their SHA256 are:\n\n3372c1edab46837f1e973164fa2d726c5c5e17bcb888828ccd7c4dfcc234a370\n6c6f88ebd42e3ef5ca6c77622176183414d318845f709591bc4117704f1c95f4\n\n\n-----\n\nBoth samples implement the following hashing algorithms:\n\nSHA1\nSHA256\nRIPEMD160\nBASE58\nBASE64\n\n## Infection Vector And Setup Function\n\nThis ransomware is usually distributed as an email attachment or through websites that\nredirect the victim to the Angler Exploit Kit. In our analysis, the exploit kit delivered a\nmalicious Flash object containing an exploit against CVE-2015-0311. The payload for this\nexploit was a TeslaCrypt sample.\n\nWe are only going to give a quick introduction on the dropper’s architecture and the setup\nfunction because this functionality has been widely covered.\n\nMost TeslaCrypt samples use COM+ sandbox evasion techniques. For example, the dropper\nwe analysed uses simple detection code that verifies if the “URLReader2” COM interface has\nbeen correctly installed in the DirectShow filter graph list:\n\nIf the check passes, the real dropper is extracted and executed using a well-known method\nthat makes use of the ZwMap(Unmap)ViewOfSection API functions to unmap the original PE\nmemory image and re-map another image file. The final unpacked executable locates\nspecific Windows directories such as the Application Data directory, and builds support files\nlike the “key.dat” file, and files to store decryption instructions. The executable also adjusts its\nown privileges (adds “SeDebugPrivilege”) and copies itself using a random file name to the\nuser’s Application Data directory. A new process is then spawned and execution is\ntransferred to it. The original dropper file is deleted. The main malware window is created\nand five threads are spawned, followed by the window message dispatching cycle.\n\n\n-----\n\nTeslaCrypt threads perform the following:\n\nDelete all system Volume Shadow Copies by executing “vssadmin.exe delete shadows\n/all /quiet” command\nOpen the “key.dat” file and recover encryption keys. If “key.dat” file doesn’t exist, create\nthe keys and store them in an encrypted form in the “key.dat” file.\nSend the new master encryption key to the C&C server through POST request (the\nlatest sample that we have analysed contains the following C&C server URLs:\n\n7tno4hib47vlep5o.63ghdye17.com\n7tno4hib47vlep5o.79fhdm16.com\n7tno4hib47vlep5o.tor2web.blutmagie.de\n7tno4hib47vlep5o.tor2web.fi\nImplement anti-tampering protection: every 200 milliseconds, TeslaCrypt enumerates\nall running processes and if a process with a filename that contains any of the words\nbelow is found, that process is terminated using the TerminateProcess Windows API\nfunction\n\ntaskmgr\nprocexp\nregedit\nmsconfig\ncmd.exe\n\n## File Encryption – Introduction\n\nAfter the initialization routine and the deletion of the Volume Shadow copies, the sample\ncreates the “key.dat” file where it stores all the encryption keys. The dropper from March\n2015 calculates at least 2 different main keys: a payment key and a master encryption key.\nThe other dropper implements the concept of an additional key known as the “Recovery key’.\n\n“GetAndHashOsData” is the function responsible for creating the base buffer for the\ngeneration of all keys. At startup it acquires the following info:\n\nthe global workstation’s LAN network statistics, using the NetStatisticsGet API function\n64 random bytes generated by Windows Crypto functions\nall heap descriptors of its own process\nall active process descriptors and the threads descriptors of each process\nall loaded modules in each process\nthe workstation’s physical memory information\n\nOnce the data is acquired, it generates a big array of SHA1 values, one for every 20 bytes of\nacquired data. At the end it calculates and stores a global SHA1 value for the entire array, in\na symbol that we have called “g_lpGlobalOsDataSha1”.\n\n\n-----\n\nWith these 2 items, the FillBuffWithEncryptedOsData routine is able to fill a generic buffer\nwith the calculated data, in a pseudo-random manner. A master key and a payment key are\ngenerated using this function (each key is 32 bytes wide), their SHA256 is calculated and\nfinally a custom algorithm is used to shift left and shift right the 2 keys. The two shifted\nSHA256 values are stored in the “key.dat” file.\n\n## The Key File\n\nThe “OpenKeyFileAndWrite” routine tries to open the “key.dat” file, located in the user’s\nApplication Data directory. If it doesn’t exist, it generates the 2 master keys (3 in case of the\nmost recent dropper) as well as other keys, and stores them in the key file.\n\nHere is a little schema of the layout of the “key.dat” file:\n\n- = We currently don’t know precisely how this value is used by TeslaCrypt\n\nThe latest version of the dropper creates a “RECOVERY_KEY.TXT” file inside the user’s\ndocument directory. It does this to achieve a particular goal: if the victim workstation is offline\nor if a firewall blocks the communication with the C&C server, the dropper will proceed with\nthe destruction of the master key inside the “key.dat” file, after the encryption of all files has\nbeen completed. To recover the files, the user would have to connect to the threat actor’s\nTOR website and provide the recovery key. The threat actors use a custom algorithm to to\nrecover the master key from the recovery key:\n\n\n-----\n\nClick for Larger\n\nImage\nThe recovery key file contains 3 pieces of information in an human-readable form, separated\nby a carriage return character:\n\nThe Bitcoin address\nThe payment key ID (32 hex digits)\nThe recovery key (64 hex digits)\n\n## The File Encryption Algorithm\n\nFile encryption is performed in a dedicated thread. The code for the encryption thread takes\nthe shifted master key, calculates its SHA256 hash and starts to enumerate all files of the\nvictim workstation (filtering by extension type, Tesla Crypt supports over 170 different file\nextensions).\n\n“EncryptFile” is the function that manages the entire file-encryption process. It:\n\ngenerates a 16-bytes Initialization Vector for AES, using the GetAndHashOsData API\nfunction\nreads the target file\ninitializes the AES encryption algorithm through the creation of the AES context data\nstructure\nfinally encrypts the contents of the file using an AES CBC 256-bit algorithm\nimplemented in the “EncryptWithCbcAes” function.\n\nWhen the process is complete, the new encrypted file is created. The new file contains a\nsmall header (composed of the AES Initialization Vector in its first 16 bytes followed by the\noriginal file size in the next 4 bytes), and then the actual encrypted bytes.\n\n\n-----\n\nThe pop up window displays misleading information: the encryption method is a symmetric\nAES, and not an asymmetric RSA-2048 as stated by TeslaCrypt in the screenshot above. As\nproof that TeslaCrypt is truly using symmetric AES and not asymmetric RSA, we provide for\na decryption utility capable of decrypting all the files encrypted by this ransomware (provided\nyou have the master key).\n\n## The Talos TeslaCrypt Decryption Tool\n\nOur decryption utility is a command line utility. It needs the “key.dat” file to properly recover\nthe master key used for file encryption. Before it begins execution, it searches for “key.dat” in\nits original location (the user’s Application Data directory), or in the current directory. If it isn’t\nable to find and correctly parse the “key.dat” file, it will return an error and exit.\n\nClick for Larger\n\nImage\nTo use this tool, just copy the “key.dat” file into the tool’s directory and then specify either the\nencrypted file or a directory containing encrypted files. That’s it! Files should be decrypted\nand returned to their original content.\n\nHere is the list of command line options:\n\n/help – Show the help message\n/key – Manually specify the master key for the decryption (32 bytes/64 digits)\n/keyfile – Specify the path of the “key.dat” file used to recover the master key.\n/file – Decrypt an encrypted file\n\n\n-----\n\n/dir – Decrypt all the .ecc files in the target directory and its subdirs\n/scanEntirePc – Decrypt “.ecc” files on the entire computer\n/KeepOriginal – Keep the original file(s) in the encryption process\n/deleteTeslaCrypt – Automatically kill and delete the TeslaCrypt dropper (if found active\nin the target system)\n\nBack up your encrypted files before you use this utility. Provided without any guarantees.\n\n## Link to the Tool\n\nThe TeslaCrypt Decryption Tool is provide as-is and is not officially supported. The user\nassumes all liability for the use of the tool.\n\n[Windows binary: https://github.com/vrtadmin/TeslaDecrypt/tree/master/Windows](https://github.com/vrtadmin/TeslaDecrypt/tree/master/Windows)\n\n## IOCs\n\nHashes:\n\n3372c1edab46837f1e973164fa2d726c5c5e17bcb888828ccd7c4dfcc234a370\n\n6c6f88ebd42e3ef5ca6c77622176183414d318845f709591bc4117704f1c95f4\n\nIP Addresses:\n\n38.229.70.4\n\n82.130.26.27\n\n192.251.226.206\n\nDomains Contacted:\n\n7tno4hib47vlep5o.63ghdye17.com\n\n7tno4hib47vlep5o.79fhdm16.com\n\n7tno4hib47vlep5o.tor2web.blutmagie.de\n\n7tno4hib47vlep5o.tor2web.fi\n\nThreatGrid has also added a behavioral indicator to identify TeslaCrypt.\n\nClick for Larger\n\nImage\n\n## Conclusion\n\n\n-----\n\nAnalysing TeslaCrypt ransomware was a challenge. All the encryption and hashing\nalgorithms in the dropper made the analysis pretty difficult. As we have seen, sometimes the\nthreat actors authors even lie. Nevertheless, ransomware continues to plague users.\nIncorporating a layered defense is critical to combating this type of threat before it has the\nchance to encrypt files. A good system backup policy is the best way to recover files that\nhave been hijacked.\n\n[Advanced Malware Protection (AMP) is ideally suited](http://www.cisco.com/c/en/us/support/security/amp-firepower-software-license/tsd-products-support-series-home.html)\nto prevent the execution of the malware used by\nthese threat actors.\n\n[CWS or WSA web scanning prevents access to](http://www.cisco.com/c/en/us/products/security/cloud-web-security/index.html)\nmalicious websites and detects malware used in\nthese attacks.\n\n[The Network Security protection of IPS and NGFW](http://www.cisco.com/c/en/us/products/security/intrusion-prevention-system-ips/index.html)\nhave up-to-date signatures to detect malicious\nnetwork activity by threat actors.\n\n[ESA can block malicious emails including phishing](http://www.cisco.com/c/en/us/products/security/email-security-appliance/index.html)\nand malicious attachments sent by threat actors as\npart of their campaign.\n\nShare:\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-04-27 - Threat Spotlight- TeslaCrypt – Decrypt It Yourself.pdf"
    ],
    "report_names": [
        "2015-04-27 - Threat Spotlight- TeslaCrypt – Decrypt It Yourself.pdf"
    ],
    "threat_actors": [
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535671,
    "ts_updated_at": 1743041120,
    "ts_creation_date": 1653677943,
    "ts_modification_date": 1653677943,
    "files": {
        "pdf": "https://archive.orkl.eu/e1415f94f6ddd798edd47005500bd9f7aa5efcc1.pdf",
        "text": "https://archive.orkl.eu/e1415f94f6ddd798edd47005500bd9f7aa5efcc1.txt",
        "img": "https://archive.orkl.eu/e1415f94f6ddd798edd47005500bd9f7aa5efcc1.jpg"
    }
}