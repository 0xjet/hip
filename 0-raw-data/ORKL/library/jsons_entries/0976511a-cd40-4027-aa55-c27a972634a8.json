{
    "id": "0976511a-cd40-4027-aa55-c27a972634a8",
    "created_at": "2022-10-25T16:48:17.499238Z",
    "updated_at": "2025-03-27T02:06:14.337182Z",
    "deleted_at": null,
    "sha1_hash": "c43d948df473b1caeda9ea7bd32ea57c3aa07278",
    "title": "Windows Forensics",
    "authors": "",
    "file_creation_date": "2017-05-16T16:01:28Z",
    "file_modification_date": "2017-05-16T16:01:28Z",
    "file_size": 1678194,
    "plain_text": "# Windows Credentials\n\n## Attack • Mitigation • Defense\n\n Chad Tilbury\n\n###### @chadtilbury\n\n\n-----\n\n###### 15+ YEARS\n\n Computer Crime Investigations CrowdStrike • Mandiant • US Air Force OSI Special Agent\n\n SANS INSTITUTE\n\n Senior Instructor and Co-Author:     FOR500: Windows Forensics      FOR508: Advanced Forensics and Incident Response\n\n CONNECT\n\n E-mail:   chad.tilbury@crowdstrike.com\n CHAD TILBURY\n LinkedIn: Chad Tilbury TECHNICAL ADVISOR\n\n**CROWDSTRIKE SERVICES**\n\n\n-----\n\n###### Credentials\n\n\n\n###### • Priority #1 post-exploitation\n\n • Domain admin is ultimate goal\n • Nearly everything in Windows is tied to an account\n\n • Difficult to move without one\n • Easy and relatively stealthy means to traverse the network\n\n • Account limitations are rare\n • “Sleeper” credentials can provide access after remediation\n\n\n-----\n\n######  User Access Control\n (UAC)\n\n  Managed Service\n Accounts\n\n  KB2871997\n\n\n######  SSP plaintext\n password mitigations  Local admin remote \n logon restrictions  Protected Processes  Restricted Admin  Domain Protected Users\n Security Group  LSA Cache cleanup  Group Managed Service \n\n\n######  Credential Guard\n\n  Remote Credential  \n Guard\n\n  Device Guard  \n (prevent execution of  \n untrusted code)\n\n\n-----\n\n### Hashes\n\n###### Tokens\n\n Cached Credentials\n\n LSA Secrets\n\n Tickets\n\n NTDS.DIT\n\n|Col1|The password for each user account in Windows is stored in multiple formats: LM and NT hashes are most well known. TsPkg, WDigest, and LiveSSP can be decrypted to provide plaintext passwords (prior to Win8.1) How are they acquired and used? Hashes are available in the LSASS process and can be extracted with admin privileges. Once dumped, hashes can be cracked or used immediately in a Pass the Hash attack. Common tools: Mimikatz • fgdump • gsecdump • Metasploit • SMBshell • PWDumpX • creddump • WCE|\n|---|---|\n\n\n-----\n\n|Admin Action|Logon Type|Credentials on Target?|Notes|\n|---|---|---|---|\n|Console logon|2|Yes*|*Except when Credential Guard is enabled|\n|Runas|2|Yes*|*Except when Credential Guard is enabled|\n|Remote Desktop|10|Yes*|*Except for enabled Remote Credential Guard|\n|Net Use|3|No|Including /u: parameter|\n|PowerShell Remoting|3|No|Invoke-Command; Enter-PSSession|\n|PsExec alternate creds|3 + 2|Yes|-u <username> -p <password)|\n|PsExec w/o explicit creds|3|No||\n|Remote Scheduled Task|4|Yes|Password saved as LSA Secret|\n|Run as a Service|5|Yes|(w/ user account) -- Password saved as LSA Secret|\n\n\n###### Remote Registry 3 No\n\n\n-----\n\n-----\n\n-----\n\n### • Prevent admin account compromise\n • Stop remote interactive sessions with highly\n privileged accounts\n\n#### • Proper termination of RDP sessions\n\n###### • Win8.1+  force the use of Restricted Admin?\n • Win10  deploy Remote Credential Guard\n\n### • Upgrade to Windows 10\n\n###### • Credential Guard\n • TsPkg, WDigest, etc. -- SSO creds obsolescence\n • Domain Protected Users Group (PtH mitigation)\n\n\n-----\n\n###### Hashes\n\n### Tokens\n\n###### Cached Credentials\n\n LSA Secrets\n\n Tickets\n\n NTDS.DIT\n\n\n###### Common tools: Incognito • Metasploit • PowerShell \n```\n• Mimikatz\n\n```\n|Col1|Delegate tokens are powerful authentication resources used for SSO. They allow attackers to impersonate a user’s security context, including over the network. How are they acquired and used? The SeImpersonate privilege lets tokens be copied from processes. The new token can then be used to authenticate as the new user. A target user or service must be logged on or have running processes. Common tools: Incognito • Metasploit • PowerShell • Mimikatz|\n|---|---|\n\n\n-----\n\n-----\n\n#### • Prevent admin account compromise\n • Stop remote interactive sessions with highly\n privileged accounts\n • Proper termination of RDP sessions\n\n###### • Win8.1+  force the use of Restricted Admin Mode?\n • Win10  deploy Remote Credential Guard\n\n#### • Account designation of “Account is Sensitive and\n Cannot be Delegated” in Active Directory\n • Domain Protected Users security group accounts do\n t t d l t t k\n\n\n-----\n\n###### Hashes\n\n Tokens\n\n Cached Credentials\n\n LSA Secrets\n\n Tickets\n\n NTDS.DIT\n\n|Col1|Stored domain credentials to allow logons when domain controller access is unavailable. Most systems cache the last 10 logon hashes by default. How are they acquired and used? Cached credentials must be cracked. Hashes are salted and case-sensitive, making decryption very slow. These hashes cannot be used for Pass the Hash attacks. Common tools: cachedump • Metasploit • PWDumpX • creddump|\n|---|---|\n\n\n-----\n\n###### Local NT Hashes\n\n Cached Hashes\n\n\n###### The creddump utilities can extract hashes, cached credentials and LSA Secrets from offline registry hives: github com/Neohapsis/creddump7\n\n\n-----\n\n### • Prevent admin account compromise\n\n • Limit number of cached logon accounts\n\n###### • SOFTWARE\\Microsoft\\Windows NT\\Current Version\\Winlogon\n (cachedlogonscount value)\n • A cachedlogonscount of zero or one is not always the right answer\n\n### • Enforce password length and complexity rules\n\n###### • Brute force cracking is required for this attack\n\n### • Domain Protected Users security group accounts do\n not cache credentials\n\n\n-----\n\n###### Hashes\n\n Tokens\n\n Cached Credentials\n\n LSA Secrets\n\n Tickets\n\n NTDS.DIT\n\n\n###### Common tools: Cain • Metasploit • Mimikatz \n```\n• gsecdump • PWDumpX • creddump • PowerShell\n\n```\n|Col1|Credentials stored in the registry to allow services or tasks to be run with user privileges. In addition to service accounts, may also hold application passwords like VPN or auto-logon credentials. How are they acquired and used? Administrator privileges allow access to encrypted registry data and the keys necessary to decrypt. Passwords are plaintext Common tools: Cain • Metasploit • Mimikatz • gsecdump • PWDumpX • creddump • PowerShell|\n|---|---|\n\n\n-----\n\n### Get-LsaSecret.ps1 from the Nishang PowerShell pentest framework used to dump (and decrypt) LSA Secrets\n\n###### https://github com/samratashok/nishang\n\n\n-----\n\n### • Prevent admin account compromise\n\n • Do not employ services or schedule tasks       \n requiring privileged accounts on low trust systems\n\n • Reduce number of services that require domain\n accounts to execute\n\n###### • Heavily audit any accounts that must be used\n\n### • (Group) Managed Service Accounts\n\n\n-----\n\n###### Hashes\n\n Tokens\n\n Cached Credentials\n\n LSA Secrets\n\n### Tickets\n\n###### NTDS.DIT\n\n\n###### How are they acquired and used? Tickets can be stolen from memory and used to authenticate elsewhere (Pass the Ticket). Further, access to the DC allows tickets to be created for any user with no expiration (Golden Ticket). Service account tickets can be requested and forged, including offline cracking of service account hashes (Kerberoasting).\n\n Common tools: Mimikatz • WCE • kerberoast\n\n|Col1|Kerberos issues tickets to authenticated users that can be reused without additional authentication. Tickets are cached in memory and are valid for 10 hours. How are they acquired and used? Tickets can be stolen from memory and used to authenticate elsewhere (Pass the Ticket). Further, access to the DC allows tickets to be created for any user with no expiration (Golden Ticket). Service account tickets can be requested and forged, including offline cracking of service account hashes (Kerberoasting). Common tools: Mimikatz • WCE • kerberoast|\n|---|---|\n\n\n-----\n\n-----\n\n|Kerberos Attacks|Col2|\n|---|---|\n|Pass the Ticket|Steal ticket from memory and pass or import on other systems|\n|Overpass the Hash|Use NT hash to request a service ticket for the same account|\n|Kerberoasting|Request service ticket for highly privileged service & crack NT hash|\n|Golden Ticket|Kerberos TGT for any account with no expiration. Survives full password reset|\n|Silver Ticket|All-access pass for a single service or computer|\n\n\n###### Skeleton Key Patch LSASS on domain controller to add backdoor password that works for any domain account\n\n\n-----\n\n### • Credential Guard (Win10+)\n\n###### • Domain Protected Users Group (Win8+) – Some attacks\n\n### • Remote Credential Guard (Win10+)\n\n###### • Restricted Admin (Win8+)\n\n### • Long & complex passwords on service accounts (to\n prevent Kerberoasting)\n\n###### • Change service account passwords regularly\n • Group Managed Service Accounts are a great mitigation\n\n### • Audit service accounts for unusual activity\n • Change KRBTGT password regularly (yearly)\n\n\n-----\n\n|Attack Type|Description|Mitigation|\n|---|---|---|\n|Pass the Ticket|Steal ticket from memory and pass or import on other systems|Credential Guard; Remote Credential Guard|\n|Overpass the Hash|Use NT hash to request a service ticket for the same account|Credential Guard; Protected Users Group; Disable RC4 authentication|\n|Kerberoasting|Request service ticket for highly privileged service & crack NT hash|Long and complex service account passwords; Managed Service Accounts|\n|Golden Ticket|Kerberos TGT for any account with no expiration. Survives full password reset|Protect domain admin accounts; Change KRBTGT password regularly|\n|Silver Ticket|All-access pass for a single service or computer|Regular computer account password updates|\n\n\n###### Skeleton Key Patch LSASS on domain controller to add backdoor password to any account\n\n\n###### Protect domain admin accounts; Smart card usage for privileged accounts\n\n\n-----\n\n###### Hashes\n\n Tokens\n\n Cached Credentials\n\n LSA Secrets\n\n Tickets\n\n NTDS.DIT\n\n|Col1|Active Directory Domain Services (AD DS) database holds all user and computer account hashes (LM/NT) in the domain. Encrypted, but algorithm is well known and easy to defeat. How is it acquired and used? Located in the \\Windows\\NTDS folder on the domain controller. The file is locked, so admin access is required to load a driver to access raw disk, or use the Volume Shadow Copy Service. Common tools: ntdsutil • VSSAdmin • NTDSXtract • VSSOwn.vbs • PowerShell • ntdsdump|\n|---|---|\n\n\n-----\n\n```\nCommandProcess: conhost.exe Pid: 141716\nCommandHistory: 0x1b8f80 Application: cmd.exe Flags: Allocated, Reset\nCommandCount: 12 LastAdded: 11 LastDisplayed: 11\nFirstCommand: 0 CommandCountMax: 50\nProcessHandle: 0x60\nCmd #0 @ 0x196970: vssadmin list shadows\nCmd #1 @ 0x1bd240: cd \\\nCmd #2 @ 0x1b9290: dir\nCmd #3 @ 0x1bd260: cd temp\nCmd #4 @ 0x1b92b0: dir\nCmd #5 @ 0x19c6a0: copy\n\\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy49\\windows\\system32\\config\\SYSTEM .\nCmd #6 @ 0x19c760: dir\nCmd #7 @ 0x19c780: copy\n\\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy49\\windows\\system32\\config\\SAM .\nCmd #8 @ 0x19c830: copy\n\\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy49\\windows\\ntds\\ntds.dit .\nCmd #9 @ 0x1c1ab0: dir\n\n```\n\n-----\n\n## Don’t allow Domain Admin accounts  \n to be compromised.\n\n\n-----\n\n# Credential Attack Detection\n\n\n-----\n\n### “As any pass-the-ticket attack, the attacker replays the golden ticket in a standard Kerberos protocol. Therefore, there is no clear indication of such attack in Windows logs.”\n\n\n-----\n\n### “Golden Ticket events may have one of these issues:\n\n###### The Account Domain field is blank when it should be DOMAIN The Account Domain field is DOMAIN FQDN when it should be DOMAIN.” –Sean Metcalf, adsecurity.org\n\n\n-----\n\n### p\n\n Kerberoasting uses RC4 encryption downgrade\n\n (but almost no one logs these events)\n\n\n-----\n\n-----\n\n##### Event logs are critical for detection\n\n###### • Authentication events (EID 4624, 4762, 4648, 4720, etc.)\n • New services (EID 7045)\n • Application and Process Crashes\n • Failed and anomalous SMB activity (EID 5140)\n • AV / Security logs\n • Domain Protected User security group logs\n\n • Applications and Services Logs\\Microsoft\\Windows\\Microsoft\\Authentication\n • Process tracking\n\n • Command line captures\n • PowerShell auditing\n\n\n-----\n\n-----\n\n###### Initiation of two near-simultaneous services by helpdesk account\n\n\n-----\n\n### ** Review and correlate your Anti-Virus logs ** \n\n###### A li ti E t L S t E t L\n\n\n-----\n\n-----\n\n###### • Registry changes\n\n • Disabled computer account pwd updates (Silver Tickets) \n```\n  SYSTEM\\CurrentControlSet\\Services\\Netlogon\\Parameters \n  DisablePasswordChange=1\n\n • Enabled WDigest credentials (post Win8.1)\n  SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\Wdigest\n\n  UseLogonCredential=1\n • Memory Analysis\n\n • Process injection\n • Loaded drivers\n • Kernel-level security agent detections\n • Behavioral Analytics\n\n```\n\n-----\n\n# Credential Best Practices\n\n\n-----\n\n### Restrict and Protect Privileged Domain Accounts\n\n###### • Reduce the number of Domain/Enterprise Admins\n • Enforce multi-factor authentication (MFA) for all network\n and cloud admin accounts\n • Separate administrative accounts from user accounts for\n administrative personnel\n • Create specific administrative workstation hosts for\n administrators\n • Use the Domain Protected Users security group!\n\n\n-----\n\n### Limit Local Admin Accounts\n\n###### • Don’t give users admin\n • Unique and complex\n passwords for local admin  (LAPS)\n • Deny network logons for\n local accounts\n\n### Audit account usage and monitor for anomalies Image source: Local Administrator Password\n**Solution https://technet.microsoft.com/en-**\n\n\n**Image source: Local Administrator Password**\n\n\n-----\n\n### Use a Tiered Administrative Access Model\n\n###### • Administration of AD\n • Servers and Applications\n • Workstations and Devices\n\n**Image source:**\n**Securing Privileged Access Reference Material by**\n\n\n\n###### • Workstations and Devices\n\n\n-----\n\n### • Audit and limit the number of services running as\n system and domain accounts\n\n###### • Utilize Group Managed Service Accounts\n • … or regularly change and use long & complex passwords\n\n### • Upgrade to Windows 10 /Server 2016\n\n###### • Enable Credential Guard & Remote Credential Guard\n\n### • Force LSASS as protected process on legacy Win8.1\n • Establish remote connections using network logon\n instead of interactive logon when possible\n\n\n-----\n\n### • Limit workstation to workstation communication\n\n###### • Restrict inbound NetBIOS, SMB traffic using the Windows\n Firewall\n • … or VLAN segmentation of workstations\n • So many hack tools leverage SMB authentication\n • Is workstation to workstation RDP really necessary?\n\n### • Enable stricter Kerberos security\n\n###### • Disable LM & NTLM (force Kerberos)\n • Short validity for tickets\n • No account delegation\n\n\n-----\n\n###### Chart by Benjamin Delpy: https://goo.gl/1K3AC7\n\n\n-----\n\n## Materials from:\n\n###### http://dfir.to/FOR508\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://www.first.org/resources/papers/conf2017/Windows-Credentials-Attacks-and-Mitigation-Techniques.pdf"
    ],
    "report_names": [
        "Windows-Credentials-Attacks-and-Mitigation-Techniques.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716497,
    "ts_updated_at": 1743041174,
    "ts_creation_date": 1494950488,
    "ts_modification_date": 1494950488,
    "files": {
        "pdf": "https://archive.orkl.eu/c43d948df473b1caeda9ea7bd32ea57c3aa07278.pdf",
        "text": "https://archive.orkl.eu/c43d948df473b1caeda9ea7bd32ea57c3aa07278.txt",
        "img": "https://archive.orkl.eu/c43d948df473b1caeda9ea7bd32ea57c3aa07278.jpg"
    }
}