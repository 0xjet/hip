{
    "id": "27a8cb76-a339-41ad-b611-a2d414504d4f",
    "created_at": "2023-01-12T15:05:29.12786Z",
    "updated_at": "2025-03-27T02:11:47.762077Z",
    "deleted_at": null,
    "sha1_hash": "24e23a18e870fcdbdee81d2f6a65a6eb1ba85256",
    "title": "2017-06-27 - New Ransomware Variant -Nyetya- Compromises Systems Worldwide",
    "authors": "",
    "file_creation_date": "2022-05-28T21:43:50Z",
    "file_modification_date": "2022-05-28T21:43:50Z",
    "file_size": 398424,
    "plain_text": "# New Ransomware Variant \"Nyetya\" Compromises Systems Worldwide\n\n**[blog.talosintelligence.com/2017/06/worldwide-ransomware-variant.html](http://blog.talosintelligence.com/2017/06/worldwide-ransomware-variant.html)**\n\n**_Note: This blog post discusses active research by Talos into a new threat. This information_**\n_should be considered preliminary and will be updated as research continues._\n\n_Update 2017-07-06 12:30 EDT: Updated to explain the modified DoublePulsar backdoor._\n\n\n-----\n\nSince the SamSam attacks that targeted US healthcare entities in March 2016, Talos has\nbeen concerned about the proliferation of malware via unpatched network vulnerabilities. In\nMay 2017, WannaCry ransomware took advantage of a vulnerability in SMBv1 and spread\nlike wildfire across the Internet.\n\nToday a new malware variant has surfaced that is distinct enough from Petya that people\nhave referred to it by various names such as Petrwrap and GoldenEye. Talos is identifying\nthis new malware variant as Nyetya. The sample leverages EternalBlue, EternalRomance,\nWMI, and PsExec for lateral movement inside an affected network. This behavior is detailed\nlater in the blog under \"Malware Functionality\". Unlike WannaCry, Nyetya does not appear to\ncontain an external scanning component.\n\nThe identification of the initial vector is still under investigation. We have observed no use of\nemail or Office documents as a delivery mechanism for this malware. We believe that\ninfections are associated with software update systems for a Ukrainian tax accounting\npackage called MeDoc. Talos is investigating this currently.\n\nGiven the circumstances of this attack, Talos assesses with high confidence that the intent of\nthe actor behind Nyetya was destructive in nature and not economically motivated. Talos\nstrongly recommends users and organizations decline to pay the ransom. Any attempts to\nobtain a decryption key will be fruitless as the associated mailbox used for payment\nverification and decryption key sharing has been shut down by the posteo.de. This renders\nany successful payment as useless as there is no method of communication available for\nthis actor to use to verify payments from victims or distribute decryption keys once ransom\n\n\n-----\n\npayments have been received. There is also no method used by the malware to directly\nconnect to command and control for remote unlocking.\n\n## Recovery of User Credentials\n\nNyetya requires user credentials to spread itself laterally via the PsExec and WMI vectors\n(which are detailed in the \"Malware Functionality\" section). Talos has identified three ways\nNyetya can obtain these credentials.\n\nFirst, credentials can be manually passed in via a command line argument. Here is the\nsyntax:\n```\nrundll32.exe C:\\Windows\\perfc.dat,#1 60 \"username:password\"\n\n```\nA second method consists to use the CredEnumerateW Windows API.\n\nFinally, Perfc.dat contains three embedded executables in its resource section which are\ncompressed with zlib. Two of the executables are used to recover user credentials (32 and\n64 bits) while the third one is the PsExec binary. The executables related to credential\nrecovery are dropped as a temporary files in the userâ€™s %TEMP% folder and run with a\nnamed pipe parameter (containing a GUID). The main executable communicates with the\ndropped executable using this named pipe. For example:\n```\nC:\\WINDOWS\\TEMP\\561D.tmp, \\\\.\\pipe\\{C1F0BF2D-8C17-4550-AF5A-65A22C61739C}\n\n```\nThe dropped .tmp executable seems to be based on Mimikatz, a popular open source tool\nused for recovery of user credentials from computer memory using several different\ntechniques. However, Talos has confirmed that the executable is not specifically the\n**_Mimikatz tool._**\n\nThe recovered credentials are then used for launching malware on the remote system using\nWMIC and PsExec. This is detailed below.\n\n## Malware Functionality\n\nPerfc.dat contains the functionality needed to further compromise the system and contains a\nsingle unnamed export function referred to as #1. As part of the propagation process, the\nmalware enumerates all visible machines on the network via the NetServerEnum API call\nand then scans for an open TCP 139 port. This is done to compile a list of devices that\nexpose this port and may possibly be susceptible to compromise.\n\nNyetya has several mechanisms that are used to propagate once a device is infected:\n\n\n-----\n\n1. EternalBlue - the same exploit used by WannaCry.\n2. EternalRomance - an SMBv1 exploit leaked by \"ShadowBrokers\"\n3. PsExec - a legitimate Windows administration tool.\n4. WMI - Windows Management Instrumentation, a legitimate Windows component.\n\nThese mechanisms are used to attempt installation and execution of perfc.dat on other\ndevices to spread laterally.\n\nFor systems that have not had [MS17-010 applied, the EternalBlue and EternalRomance](https://technet.microsoft.com/en-us/library/security/ms17-010.aspx)\nexploits are leveraged to compromise systems. The exploit launched against the victim\nsystem depends on the operating system of the intended target.\n\nEternalBlue\n\nWindows Server 2008 R2\nWindows Server 2008\nWindows 7\nEternalRomance\n\nWindows XP\nWindows Server 2003\nWindows Vista\n\nThe two exploits drop a modified version of DoublePulsar which is a persistent backdoor\nrunning in kernel space of the compromised system. The developer modified only few bytes\nfrom the original version but this modification allowed it to evade network detection and the\nopen source DoublePulsar scanning tools available on the Internet. The modification can be\ndivided in 3 parts:\n\nThe attacker modified the command codes:\n\nOriginal Command Code Nyetya Command Code Purpose\n\n0x23 0xF0 PING\n\n0x77 0xF1 KILL\n\n0xC8 0xF2 EXEC\n\nThe attacker modified the response codes:\n\nOriginal Response Code Nyetya Response Code Purpose\n\n0x10 0x11 OK\n\n\n-----\n\n0x20 0x21 CMD_INVALID\n\n0x30 0x31 ALLOCATION_FAILURE\n\nThe attacker modified where the response code is stored in the SMB response packet.\nIn the original version of DouplePulsar, the code was stored in the MultiplexID field\n(offset 0x1E). In the Nyetya version, the response code is stored in a reserved field\n(offset 0x16) which is normally set to 0x0000\n\nWe implemented a specific NGIPS / Snort rule to detect this DoublePulsar variant: 43459.\n\nPsExec is used to execute the following instruction (where w.x.y.z is an IP address) using the\ncurrent user's windows token (from the \"Recovery of User Credentials\" section above) to\ninstall the malware on the networked device.\n```\nC:\\WINDOWS\\dllhost.dat \\\\w.x.y.z -accepteula -s -d C:\\Windows\\System32\\rundll32.exe\nC:\\Windows\\perfc.dat,#1 60\n\n```\nWMI is used to execute the following command which performs the same function as above,\nbut using the current user's username and password (as username and password), retrieved\nfrom the \"Recovery of User Credentials\" section above.\n```\nWbem\\wmic.exe /node:\"w.x.y.z\" /user:\"username\" /password:\"password\" \"process call\ncreate \"C:\\Windows\\System32\\rundll32.exe \\\"C:\\Windows\\perfc.dat\\\" #1 60\"\n\n```\nOnce a system is successfully compromised, the malware encrypts files on the host using\n2048-bit RSA encryption. Additionally, the malware cleans event logs on the compromised\ndevice using the following command:\n```\nwevtutil cl Setup & wevtutil cl System & wevtutil cl Security & wevtutil cl\nApplication & fsutil usn deletejournal /D %c:\n\n```\nNytetya attempts to obtain administrative privileges (SeShutdowPrivilege and\nSeDebugPrivilege) for the current user through the Windows API AdjustTokenPrivileges. If\nsuccessful, Nyetya overwrites the boot sector on PhysicalDrive0 without first saving a copy. If\noverwriting the boot sector fails, Nyetya instead wipes the first ten sectors of the disk drive.\nAdditionally, if Nyetya finds a process file name hash of 2E214B44 on the system, it will also\nwipe the first ten sectors of the disk drive. Talos has identified that this hash is referring to\navp.exe, which corresponds to Kaspersky Anti-virus. Systems that have the boot sector\noverwritten will see this message when restarting their systems.\n\n\n-----\n\nScreenshot of a system compromised by Nyetya.\n\nNote that regardless of whether Nyetya is successful in overwriting the boot sector or not, it\nwill proceed to create a scheduled task via schtasks to reboot the system one hour after\ninfection.\n\nWithout analyzing the key generation or key storage components, Talos believes that the\nactors behind Nyetya did not intended for the boot sector or the ten sectors that are wiped to\nbe restorable. Thus, Nyetya is intended to be destructive rather than as a tool for financial\ngain.\n\n## Mitigation and Prevention\n\nThere are several ways customers can mitigate and prevent Nyetya from impacting your\nenvironment.\n\nFirst and foremost, we strongly recommend that customers who have NOT yet already\napplied MS17-010 to go do so immediately. Given the severity of the vulnerability and\nthe widely available tools that exploit it, leaving this vulnerability unpatched is unwise.\nEnsure you have anti-malware software deployed on your systems that can detect and\nblock the execution of known malicious executables.\nImplement a disaster recovery plan that includes backing up and restoring data from\nbackup devices that are kept offline. Adversaries frequently target backup mechanisms\nto limit the possibilities a user may be able to restore their files without paying the\nransom.\nDisable SMBv1, if possible, on networks and move to a more updated version of SMB.\n(SMBv2 was introduced with Microsoft Vista)\n\n\n-----\n\nOrganizing your networks in a number of well-defined logical segments, and allowing\naccess to network assets only to those users and systems within a segment may help\nwith containing outbreaks of self-spreading worms such as Nyetya.\n\nAs Nyetya attempts to overwrite the boot sector on an infected machine, Talos tested using\n[MBRFilter to prevent any changes being allowed to the system boot sector. This test proved](https://www.talosintelligence.com/mbrfilter)\nsuccessful and the machine boot sector remained intact in a good state. For users or\nenterprises that can do so, we recommend using MBRFilter. Note that MBRFilter is an open\nsource project from Talos and no warranties or guarantees are provided.\n\n## Coverage\n\nCisco customers are protected from Nyetya via the following products and services.\n\n[Advanced Malware Protection (AMP) is ideally suited to prevent the execution of the](https://www.cisco.com/c/en/us/support/security/amp-firepower-software-license/tsd-products-support-series-home.html)\nmalware used by these threat actors.\n\n[Network Security appliances such as NGFW,](https://www.cisco.com/c/en/us/products/security/asa-next-generation-firewall-services/index.html) [NGIPS, and](https://www.cisco.com/c/en/us/products/security/intrusion-prevention-system-ips/index.html) [Meraki MX can detect malicious](https://meraki.cisco.com/products/appliances)\nactivity associated with this threat.\n\n[AMP Threat Grid helps identify malicious binaries and build protection into all Cisco Security](https://www.cisco.com/c/en/us/solutions/enterprise-networks/amp-threat-grid/index.html)\nproducts.\n\nEmail and web have not been identified as attack vectors at this time. Additionally, there are\nno known C2 elements related to this malware at this time. The malware, if transferred\nacross these systems on your networks, will be blocked.\n\n\n-----\n\nOpen Source Snort Subscriber Rule Set customers can stay up to date by downloading the\n[latest rule pack available for purchase on Snort.org.](https://www.snort.org/products)\n\n### NGIPS / Snort Rules\n\nThe following NGIPS / Snort rules detect this threat:\n\n42944 - OS-WINDOWS Microsoft Windows SMB remote code execution attempt\n42340 - OS-WINDOWS Microsoft Windows SMB anonymous session IPC share\naccess attempt\n41984 - OS-WINDOWS Microsoft Windows SMBv1 identical MID and FID type\nconfusion attempt\n43459 - MALWARE-CNC Win.Trojan.Doublepulsar variant successful ping response\n\nThe following NGIPS / Snort rules are also indicators of infection traffic:\n\n5718 - OS-WINDOWS Microsoft Windows SMB-DS Trans unicode Max Param/Count\nOS-WINDOWS attempt\n1917 - INDICATOR-SCAN UPnP service discover attempt\n5730 - OS-WINDOWS Microsoft Windows SMB-DS Trans Max Param OS-WINDOWS\nattempt\n26385 - FILE-EXECUTABLE Microsoft Windows executable file save onto SMB share\nattempt\n43370 - NETBIOS DCERPC possible wmi remote process launch\n\n### Threat Grid\n\nThreat Grid is capable of detecting malware samples related to Nyetya as malicious.\n\n## Indicators of Compromise (IOCs)\n\n\n-----\n\n### AMP Coverage\n\nW32.Ransomware.Nyetya.Talos\n\n### SHA256\n\n027cc450ef5f8c5f653329641ec1fed91f694e0d229928963b30f6b0d7d3a745\neae9771e2eeb7ea3c6059485da39e77b8c0c369232f01334954fbac1c186c998\n(password stealer)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-06-27 - New Ransomware Variant -Nyetya- Compromises Systems Worldwide.pdf"
    ],
    "report_names": [
        "2017-06-27 - New Ransomware Variant -Nyetya- Compromises Systems Worldwide.pdf"
    ],
    "threat_actors": [
        {
            "id": "d4f7cf97-9c98-409c-8b95-b80d14c576a5",
            "created_at": "2022-10-25T16:07:24.561104Z",
            "updated_at": "2025-03-27T02:02:10.281202Z",
            "deleted_at": null,
            "main_name": "Shadow Brokers",
            "aliases": [],
            "source_name": "ETDA:Shadow Brokers",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "171b85f2-8f6f-46c0-92e0-c591f61ea167",
            "created_at": "2023-01-06T13:46:38.830188Z",
            "updated_at": "2025-03-27T02:00:02.929729Z",
            "deleted_at": null,
            "main_name": "The Shadow Brokers",
            "aliases": [
                "Shadow Brokers",
                "ShadowBrokers",
                "The ShadowBrokers",
                "TSB"
            ],
            "source_name": "MISPGALAXY:The Shadow Brokers",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535929,
    "ts_updated_at": 1743041507,
    "ts_creation_date": 1653774230,
    "ts_modification_date": 1653774230,
    "files": {
        "pdf": "https://archive.orkl.eu/24e23a18e870fcdbdee81d2f6a65a6eb1ba85256.pdf",
        "text": "https://archive.orkl.eu/24e23a18e870fcdbdee81d2f6a65a6eb1ba85256.txt",
        "img": "https://archive.orkl.eu/24e23a18e870fcdbdee81d2f6a65a6eb1ba85256.jpg"
    }
}