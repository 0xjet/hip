{
    "id": "62c15974-1274-43b1-8959-f673826d7ca0",
    "created_at": "2023-01-12T15:02:58.031536Z",
    "updated_at": "2025-03-27T02:05:30.770498Z",
    "deleted_at": null,
    "sha1_hash": "bf6b44ab64706f801e690bea23595e4d58723374",
    "title": "2019-07-16 - The Avast Abuser- Metamorfo Banking Malware Hides By Abusing Avast Executable",
    "authors": "",
    "file_creation_date": "2022-05-28T00:28:02Z",
    "file_modification_date": "2022-05-28T00:28:02Z",
    "file_size": 130659,
    "plain_text": "# The Avast Abuser: Metamorfo Banking Malware Hides By Abusing Avast Executable\n\n**medium.com/@chenerlich/the-avast-abuser-metamorfo-banking-malware-hides-by-abusing-avast-executable-**\nac9b8b392767\n\nChen Erlich April 9, 2020\n\nCh\nen\n\n\n[Chen Erlich](https://medium.com/@chenerlich?source=post_page-----ac9b8b392767--------------------------------)\n\nApr 3, 2020\n\n\n10 min read\n\n**Source: ensilo.com/BreakingMalware**\n\n**Twitter:** [@chen_erlich](https://twitter.com/chen_erlich)\n\n\n-----\n\n## SUMMARY\n\nIn May 2019, enSilo’s Threat Intelligence team observed activity by a cybercrime group,\nspreading Metamorfo — A Brazilian banking trojan. The variants we discovered abuse an\nexecutable digitally signed by Avast, which is one of the most popular AV products in the world\n[for consumers. We were able to connect this activity to a campaign reported by TrendMicro](https://blog.trendmicro.com/trendlabs-security-intelligence/analysis-abuse-of-custom-actions-in-windows-installer-msi-to-run-malicious-javascript-vbscript-and-powershell-scripts/)\nwhich targeted an executable by a different Anti-Virus vendor, Avira. This\n\nfurther highlights the Modus-Operandi of the group.\n\nThis blog post describes in detail one of the variants used in this campaign and highlights\nunique Tactics, Techniques and Procedures (TTPs) used in this campaign which were not\npreviously disclosed.\n\n\n-----\n\n## TECHNICAL ANALYSIS\n\nIn May 2019, enSilo detected a new activity by a Brazilian cybercrime group. Both loader\nvariants and their respective payloads that were analyzed share similar TTPs and code\nassociated with a Brazilian cybercrime group.\n\n## Execution Flow Overview\n\nOn execution, the MSI downloader starts by checking if it is running in a virtual machine. If not,\ndownloads a zip file, unzips it, deletes itself, establishes persistency and restarts the system.\n\nThe zip file contains the following files:\n\n1. jesus.exe — Signed AVDump32 — Avast’s memory dump utility. Renamed to a random\nname.\n\n2. dbghelp.dll — Malicious file to be side loaded by AJWrDz.exe.\n\n3. jesus.dmp — Payload to be loaded by the injected Windows Media Player\n\nexecutable (wmplayer.exe). Later renamed to the same random name as\n\njesus.exe with a .dmp extension.\n\n4. ssleay64.dll — Known variant of Metamorfo. Will be loaded and used in the\n\ninjected wmplayer.exe.\n\n5. ssleay32.dll — OpenSSL Shared Library.\n\n6. borlndmm.dll — Borland Memory Manager.\n\n7. libeay32.dll — OpenSSL Shared Library.\n\nDuring the rest of the analysis we will refer jesus.exe as “AJWrDz.exe” which is the random\nname generated in this execution. After the system reboots, the file “AJWrDz.exe” executes,\nwhich in turn triggers the side-loading of the malicious (and fake) DLL file “dbghelp.dll”. This\nmalicious DLL file injects itself to Windows Media Player process — wmplayer.exe, and\nreflectively loads the renamed jesus.dmp file, “AJWrDz.dmp”.\n\nThe following diagram describes the high-level execution flow of the variants in this campaign:\n\n\n-----\n\n## MSI DOWNLOADER\n\n[The following is the static characteristics of the Windows Installer (MSI) downloader which](https://docs.microsoft.com/en-us/windows/desktop/msi/windows-installer-portal)\nstarts the infection, this MSI downloader is similar to the one used in the earlier part of the\ncampaign:\n\n**File Name: HNR-Not03958576535323.msi**\n\n**SHA1: F1498E679885389C32FDF5EC39813FE5D4D34F23**\n\n**Size: 287232 bytes**\n\n\n-----\n\n**Creation Time: 2009–12–11 11:47:44**\n\nDuring the time of analysis this variant had very low detection rate in VirusTotal, as can be seen\nin figure 2:\n\nAll MSI files in this campaign have different names, but share unique characteristics:\n\n1. Disguised as “” to look legitimate as seen in figure 3:\n\n\n-----\n\n2. Created using the “Advanced Installer” tool, which is imported in all of them, as shown in\nfigure 4.\n\n3. Contain a vmdetect.exe [MD5: 55FFEE241709AE96CF64CB0B9A96F0D7] to avoid\ndetection, as shown in figure 4:\n\n\n-----\n\n4. Use the . The CustomAction table enables integration of custom code and data into an\ninstallation. The source of the code that is executed can be a stream contained within the\ndatabase, a recently installed file, or an existing executable file. The attackers abused this\nfeature to add the malicious JavaScript/VBS payload as shown in figure 5.\n\n\n-----\n\n## The JavaScript payload\n\nThe downloader’s JavaScript payload is obfuscated:\n\nFigure 6: Obfuscated MSI payload\nAfter deobfuscation:\n\nFigure 7: Deobfuscated MSI payload\nThe samples in this campaign communicate with a URL in the following format:\n\nThe ”{random}” part may change between different MSI downloaders. The image2.png file is\nactually a zip file which is downloaded and extracted to a target folder. In this variant it is\n\n\n-----\n\nextracted to %APPDATA%\\Macromedia. Next, the MSI downloader creates in this location a\n_desktop.txt file containing the string “NULL”._\n\nThe purpose of the desktop.txt file is to indicate whether the system is infected by the malware.\nIf it exists, the MSI will exit after it will open Adobe’s website to explain how to install updates. It\ndoes so by executing:\n\n_“c:\\Windows\\System32\\cmd.exe /C start /MAX https://helpx.adobe[.]com//acrobat/kb/install-_\n_updates-reader-acrobat.html”_\n\nOtherwise, it will open legal terms of use page in Adobe’s site and continue the payload\nexecution. This following command executes to open the terms of use page:\n\n“c:\\Windows\\System32\\cmd.exe /C start /MAX https://adobe.ly/2RY5GJR”\n\nwhich will redirect to “https://www.adobe.com//legal/terms.html”.\n\nNote that both URLs are with the Brazilian 2-letter abbreviation, suggesting the victims’ origin.\n\nThe files are extracted to a newly created folder with a randomized name under the same path,\nand the zip file is then deleted. The “AJWrDz.exe” executable path is written to the registry Run\nkey “HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run” to achieve persistency. As a\nfinal step the system is restarted to trigger its execution.\n\n## THE AVAST ABUSE\n\nAfter the system restart, the “AJWrDz.exe” file executes. Its static characteristics are:\n\n**File Name: AJWrDz.exe (renamed from jesus.exe)**\n\n**SHA1: 2A1A5D7C85560924EDC434A1D2F23ED3445D86F4**\n\n**Size: 814296 bytes**\n\n**Creation Time: 2018–10–08 13:07:15**\n\nThis is a legitimate file, AVDump32.exe, digitally signed by “AVAST Software” as shown in\nfigure 8:\n\n\n-----\n\nAvDump32.exe legitimate use is to create *.dmp files of Avast processes in case there is an\nunhandled exception. When Avast is installed legitimately on a system the file is located in Its\noriginal location: C:\\Program Files\\AVAST Software\\Avast.\n\nFigure 9 suggests that this file was submitted to VirusTotal as “jesus.exe”, which is the name of\nthe file in the downloaded zip, before it’s being renamed in the MSI payload:\n\n\n-----\n\nAvDump32.exe is abused by the Metamorfo to side-load the “dbghelp.dll” by leveraging the DLL\nsearch order. Note that this is a common issue which makes it possible to leverage the DLL\nside-loading attack, often referred to as DLL Hijacking. Figure 10 shows the DLL files imported\nby this executable:\n\n\n-----\n\nYou can find another example of abusing the DLL search order in one of our previous blog\nposts.\n\nThe side loaded “dbghelp.dll” is a malicious file written in Delphi and compiled using the\nEmbarcadero Delphi IDE with the following characteristics:\n\n**File Name: dbghelp.dll**\n\n**SHA1: 08823578841AEED044EAD81ED6DB16DD95B6FF4B**\n\n**Size: 5595136 bytes**\n\n**Creation Time: 2019–04–27 22:17:17**\n\n\n-----\n\nAfter being side-loaded by AvDump32.exe, the DLLs execution starts with the following steps:\n\n1. Resolves WINAPI functions\n2. Hides its GUI using WINAPI call\n3. Compares if the DLL is being ran by wmplayer. More on this later.\n\nNext, the DLL file creates the mutex — [7F4HRE-375E-AEF3-BE9A-OBJT389F53] and writes\nto HKCU\\Software\\index (as shown in figure 11) the name of the running process which is later\nused to know the name of the .dmp file that should be loaded. Finally, it injects itself to Windows\nMedia Player executable — wmplayer.exe.\n\n\n-----\n\nThe process wmplayer.exe is a rather strange victim for injection given that various Windows\ndistributions don’t come with Windows Media Player installed by default, so it can only be\nimplied that this software is probably more common in the victim’s origin, and that it probably\ntargets home users.\n\nMetamorfo uses a DLL injection technique with a twist. Instead of getting a handle to the victim\nprocess using OpenProcess, which relies on having a running process, the injection uses\n_CreateProcess with CREATE_SUSPENDED flag. Then it creates a remote thread which loads_\nthe malicious DLL and executes it. The process’ main thread is never resumed and thus only\nthe malware code executes. Figure 12 shows the CreateProcess call:\n\nThe injection flow is as follows:\n\n\n-----\n\n## INJECTED PAYLOAD\n\nUpon injection, the DLL validates that it runs under the wmplayer.exe process by checking the\nprocess name and goes on to execute its malicious activity. It creates a second mutex — One_InstanceJes, resolves more WINAPI functions, checks for the registry “index” key (which was_\npreviously written)the execution location and for the “ADWrDz.dmp” file. If this file exists, it\nextracts it in-memory using RtlDecompressFragment and reflectively loads it.\n\n## No DEP\n\n\n-----\n\n[dbghelp.dll is incompatible with DEP (Data Exception Prevention), as shown in Figure 14. Thus,](https://docs.microsoft.com/en-us/windows/win32/memory/data-execution-prevention)\nwhen it loads the operating system will disable DEP for the injected wmplayer.exe process. This\nmeans that code can be executed from memory regions that are not marked as executable in\nthe context of this process.\n\nMetamorpho uses this to execute the reflectively loaded payload from a non-executable region.\nThis makes the payload harder to detect by memory forensics toolkits and security products\nwhich many times look specifically for executable memory.\n\n## Leveraging CreateTimerQueueTimer\n\n\n-----\n\nOnce ADWrDz.dmp is loaded into memory Metamorfo leverages the CreateTimerQueueTimer\nWINAPI call to execute it (as shown in figure 14).\n\n_CreateTimerQueueTimer is a WINAPI that creates a_ [queue for timers. These timer objects](https://msdn.microsoft.com/en-us/library/windows/desktop/ms686796(v=vs.85).aspx)\nallow the selection of a callback function at a specified time. The original function of the API is\nto be part of the process chain by creating a timer routine, but here, the callback function of the\nAPI is the entry point of the malware’s actual payload.\n\nThe use of CreateTimerQueueTimer makes detection harder since the payload will not run in\nthe remote thread context.\n\nThis kind of technique was previously used in malware variants such as Emotet and Hancitor.\n\nThroughout the “ADWrDz.dmp” execution, it outputs debug comments in Portuguese as shown\nin figure 16:\n\n\n-----\n\nEntering the CreateTimerQueueTimer callback, Metamorfo creates another mutex — libea54,\nand starts checking for the existence of directories and files relevant for its execution. Since\nthere are multiple variations of Metamorfo in this campaign, the attackers used different\nlocations in the file system to drop their files, see IOCs section.\n\nNext, Metamorfo checks for the existence of “mreb.xml” and “mreboot”, as can be seen in figure\n17. These artifacts were not available to us and we couldn’t verify their purpose.\n\n\n-----\n\nr\nIf they aren’t found, it creates another mutex by the name — [7F4HRE-375E-AEF3-BE9A_OBJT389F53]. Then, it checks internet connection by trying to resolve “goole.com” (Misspelled)_\naddress. If internet connection is available,\n\nit sends a GET request to “https://www.localizaip.com[.]br/api/iplocation.php” to retrieve geo\ndata.\n\nMetamorfo’s C&C communication is encrypted using the dropped OpenSSL libraries\nlibeay32.dll and ssleay32.dll.\n\n\n-----\n\nBased on the gathered data, if the victim is not from Brazil or Portugal it will print the following\noutput and send the collected data to the C&C “https://x1-lb12.internal[.]gocache.me”, which\nresided in Brazil, and finish.\n\na\nIf the victim is from Brazil or Portugal, it will start monitoring running applications in the system\nusing a message loop:\n\n\n-----\n\n## The ssleay64.dll payload\n\nIf the malware identifies a file named “mreb.xml” or a folder named “mreboot”, it loads a\nmalicious “ssleay64.dll”, also written in Delphi, compiled by Borland Delphi, which has the\nfollowing characteristics:\n\n**File Name: ssleay64.dll**\n\n**SHA1: F5E63580710E8FA884377A746FC822E5**\n\n**Size:** [1445888 bytes](https://www.virustotal.com/gui/search/size%25253A1445888)\n\n\n-----\n\n**Creation Time: 2019–04–08 12:15:27**\n\nThe DLL holds various resources. Some of them are encrypted and will be used as payloads to\nsteal victim’s data, while others are cursor related resources.\n\nLike samples from previous campaigns Metamorfo can display fake forms on targeted banking\n[sites and steal credentials from the victims. On previous campaigns Metamorfo used Windows](https://www.fireeye.com/blog/threat-research/2018/04/metamorfo-campaign-targeting-brazilian-users.html)\nUpdate to hide its malicious activity. Similarly, in this campaign Metamorfo uses a fake “Blue\nScreen” window. It does so after disabling the taskbar as can be seen in Figures 20 and 21:\n\n\n-----\n\n## Evading Banking Protection & Anti-Fraud Products\n\nMetamorfo also makes efforts to evade banking protection and anti-fraud products by setting a\nhook on LoadLibraryW function and checking which DLL is loaded, the trampoline can be seen\nin Figure 22:\n\n\n-----\n\nWith the help of this trampoline, for every LoadLibraryW call the attackers will check if the DLL\nto be loaded contains one of the following anti-fraud and banking protection strings:\n\nGbpinj\nScpbrad\nScpad\nTrusteer\nWarsaw\nGblplugin\nIpsbho\nHook\n\nIf one of them is matched, the DLL LoadLibraryW call is trying to load wouldn’t load.\n\nFigure 23 shows a few searched strings:\n\n\n-----\n\n## IOCS\n\n Hashes:\n\nMSI — F1498E679885389C32FDF5EC39813FE5D4D34F23\nOther related samples\nAvDump32.exe — 2A1A5D7C85560924EDC434A1D2F23ED3445D86F4\nDbghelp.dll — 08823578841AEED044EAD81ED6DB16DD95B6FF4B\nOther related samples\nSsleay64.dll F5E63580710E8FA884377A746FC822E5\n\n\n-----\n\nC00BF102482C61E4CAB3C6B6666697779092FADC\n6242CC3009A96F97AB9586C970DB26EDE5512F9A\n03A5BEF2B9DE1DF5C19C9F4D2AEC6F780F4749D0\nC15154D7323EA0C7A40912C799599DACCEB4E7CE\n\n**URLs:**\n\nhttps://s3-eu-west-1[.]amazonaws.com/disenyrt3/image2.png\n\nhttps://s3-eu-west-1[.]amazonaws.com/sharknadorki/image2.png\n\nhttps://s3-eu-west-1[.]amazonaws.com/jasonrwk5wg/image2.png\n\nhttps://s3-eu-west-1[.]amazonaws.com/frezaaaewrwty/image2.png\n\nhttps://s3-eu-west-1[.]amazonaws.com/cadeaadl54t4gw4/image2.png\n\nhttps://s3-eu-west-1[.]amazonaws.com/sharknadorki/image2.png\nhttps://s3-eu-west-1[.]amazonaws.com/jooosan/image2.png\nhttps://s3-eu-west-1[.]amazonaws.com/shhakkr/image2.png\n\nwww.goole[.]com\n\nhttps://www.localizaip.com[.]br/api/iplocation.php\n\nmrs04s09-in-f206.1e100[.]net\n\nlhr25s13-in-f78.1e100[.]net\n\ndub08s01-in-f14.1e100[.]net\n\nlhr25s11-in-f46.1e100[.]net\n\n**Files:**\n\n%APPDATA%\\Macromedia\n%APPDATA%\\Macromedia\\desktop.txt\n%APPDATA%\\TeamViewer\n%APPDATA%\\TeamViewer\\desktop.txt\n%APPDATA%\\DMCache\n%APPDATA%\\DMCache\\desktop.txt\n%APPDATA%\\AnyDesk\n%APPDATA%\\AnyDesk\\desktop.txt\n\n**Registry:**\n\nHKCU\\Software\\index\n\n\n-----\n\n**Mutexes:**\n\n[7F4HRE-375E-AEF3-BE9A-OBJT389F53]\nlibea54\nOne-InstanceJes\n\nThanks for reading. Follow me on Twitter for more posts like this one.\n\n## Chen Erlich\n\n### The latest Tweets from Chen Erlich (@chen_erlich). Security Researcher. Opinions are on my own. #MalwareResearch…\n\ntwitter.com\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-07-16 - The Avast Abuser- Metamorfo Banking Malware Hides By Abusing Avast Executable.pdf"
    ],
    "report_names": [
        "2019-07-16 - The Avast Abuser- Metamorfo Banking Malware Hides By Abusing Avast Executable.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535778,
    "ts_updated_at": 1743041130,
    "ts_creation_date": 1653697682,
    "ts_modification_date": 1653697682,
    "files": {
        "pdf": "https://archive.orkl.eu/bf6b44ab64706f801e690bea23595e4d58723374.pdf",
        "text": "https://archive.orkl.eu/bf6b44ab64706f801e690bea23595e4d58723374.txt",
        "img": "https://archive.orkl.eu/bf6b44ab64706f801e690bea23595e4d58723374.jpg"
    }
}