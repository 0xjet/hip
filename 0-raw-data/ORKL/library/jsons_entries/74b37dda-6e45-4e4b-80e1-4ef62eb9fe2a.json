{
    "id": "74b37dda-6e45-4e4b-80e1-4ef62eb9fe2a",
    "created_at": "2023-01-12T15:08:51.085275Z",
    "updated_at": "2025-03-27T02:05:23.124107Z",
    "deleted_at": null,
    "sha1_hash": "b0ce49690cf02d1ded32f4a024ae81b71ee10fa0",
    "title": "2022-02-26 - Yours Truly, Signed AV Driver- Weaponizing An Antivirus Driver",
    "authors": "",
    "file_creation_date": "2022-05-28T15:46:17Z",
    "file_modification_date": "2022-05-28T15:46:17Z",
    "file_size": 430131,
    "plain_text": "# Yours Truly, Signed AV Driver: Weaponizing an Antivirus Driver\n\n**[cyber.aon.com/aon_cyber_labs/yours-truly-signed-av-driver-weaponizing-an-antivirus-driver/](https://cyber.aon.com/aon_cyber_labs/yours-truly-signed-av-driver-weaponizing-an-antivirus-driver/)**\n\nAs we head into 2022, ransomware groups continue to plague our digital environment with new and interesting techniques to\nbypass Antivirus (AV) and Endpoint Detection and Response (EDR) solutions and ensuring the successful execution of their\nransomware payloads.\n\nIn December 2021, Stroz Friedberg’s Incident Response Services team engaged in a Digital Forensics and Incident\nResponse (DFIR) investigation and environment-wide recovery of a Cuba ransomware incident. We discovered novel\nindicators of compromise (IOCs) utilizing an interesting technique. Here, as part of the Cuba’s toolset, the threat actor group\nexecuted a script that abused a function in an Avast Anti Rootkit kernel driver to terminate popular AV and EDR®\nprocesses.\n\n\nWhile the use of kernel drivers to target and kill AV and EDR solutions1 prior to encryption has been known and discussed\nfor some time, the abuse of a signed and valid driver from an Antivirus vendor2 was surprisingly effective and ironic.\n\nAt the time of writing this article, there are three different versions of the same attack. They are listed below in the order of\nimplementation complexity:\n\nA self-contained PowerShell script, dropped alongside the Avast driver, that installs and loads the driver and executes\na small number of functions to control the driver.\nAn executable that unpacks and loads in memory a small executable to control the driver. Within this blog, we refer to\nthis executable as the controller. Additional tools are used to install and load the Avast driver in the infected system.\nA batch script that installs a service to load the Avast kernel driver, then launches a PowerShell script to decode, load\nand execute the controller in memory.\n\nThis article delves into the implementation of the third variant of the attack where the attacker uses a batch script as\ndescribed in the third bullet point above.\n\n## The Staging – Batch Script\n\nThe first stage of the hijack starts with the threat actor dropping three files, a batch script, a PowerShell script, and an Avast\ndriver, within the target system’s “C:\\Windows” and “C:\\Windows\\Temp” directories.\n\nThe threat actor executes the batch script to create and start a new service that utilizes a legitimate Avast Anti Rootkit kernel\ndriver named aswArPot.sys. A short timeout is included to ensure the service is fully started, prior to the execution of the\nPowerShell script used to unpack and execute the controller.\n```\n@ echo off \nsc.exe create aswSP_ArPot2 binPath= C:\\windows\\temp\\aswArPot.sys type= kernel \nsc.exe start aswSP_ArPot2 \nTimeout /t 3 \nC:\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe -windowstyle hidden -executionpolicy bypass -file\nc:\\windows\\temp\\SAMPLE.ps1\n\n## The Obfuscation – PowerShell Loader Script\n\n```\nThe PowerShell script contains multiple layers of obfuscation which, when executed, decodes its contents, and rebuilds the\ncontroller. Once the PowerShell script finishes rebuilding the controller, it utilizes Windows Application Programming\nInterfaces (APIs) to load and execute the controller in memory.\n\n\n-----\n\n```\n   yp yp\n  using System; \n  using System.Diagnostics; \n  using System.Runtime.InteropServices; \n  public static class RANDOMSTRING1 { \n    [DllImport(\"kernel32.dll\")] \n    public static extern IntPtr VirtualAlloc(IntPtr RANDOMSTRING2, uint RANDOMSTRING3, uint RANDOMSTRING4,\nuint RANDOMSTRING5); \n    [DllImport(\"PowrProf.dll\")] \n    public static extern IntPtr EnumPwrSchemes(IntPtr RANDOMSTRING6, IntPtr RANDOMSTRING7); \n  } \n'@ \nFunction ouBmwjaLNIuXYiiWYYxZt() { \nreturn (([regex]::Matches('[Redacted_Base64_String…]\n\n## The Controller – Malicious Portable Executable (PE)\n\n```\nThe small (~5KB in size) PE loaded into memory proved to be simple, yet effective. The executable is designed to collate a\nlist of actively running processes, then compare them to an obfuscated hardcoded list of CRC64 checksum values of AV and\nEDR processes names. If any process name directly correlates to an entry in the hardcoded list, an I/O Control (IOCTL)\ncode is sent to the Avast driver, resulting in the termination of the process.\n\nDisassembling the sample on Ghidra provides insight into the hashing and comparison functions of the controller:\n\n1. The initial function creates a handle to reference the recently installed Avast driver via the CreateFileW API. If the driver\nhandle returns as valid, the executable calls a function to find and terminate processes.\n\n2. Once inside this function, a snapshot of actively running processes is taken. The function then iterates through the\nlowercase Unicode representation of processes names and calculates a CRC64 checksum on each of them using the\nCRC64_ECMA_182 algorithm.\n\n\n-----\n\n3. The executable then cycles through the hardcoded list of CRC64 checksum values (QWORD_009c2030), each of which\nrepresents the name of known AV or EDR processes. In the sample discussed in this article, the hardcoded list contained\n119 (0x77) CRC64 checksum values.\n\n4. If the sample finds a match, it calls the Avast process termination function passing the handle of the Avast driver, and the\nmatching process ID.\n\n5. The DeviceIoControl API is called, which sends the 0x9988c094 IOCTL code to the Avast driver, along with the process\nID. This results in the Avast driver terminating the process at Kernel level, bypassing tamper protection implemented in most\nAV and EDR products.\n\n## The Kill – Avast IOCTL Code\n\nThe aswArPot.sys Avast driver interprets the 0x9988c094 IOCTL code as a signal to terminate a given process. Below are\nthe pieces of the Avast driver disassembled and decompiled for research purposes, which show the method to terminate a\nprocess from kernel mode, using KeAttachProcess and ZwTerminateProcess functions:\n\n\n-----\n\n_Figure 1. IOCTL code comparison within Avast driver’s code, which calls its process terminating function_\n\n\n-----\n\n_Figure 2. Avast driver’s process terminating function_\n\nThis IOCTL code and function can be found on multiple versions of the aswArPot.sys Avast driver, including the version\ndistributed on Avast products as of December 2021. However, it was confirmed, through behavioral analysis, that the latest\ndistributed versions of the Avast driver are not susceptible to this abuse. Upon contacting the Avast Bug Bounty team, we\nhave received confirmation that the issue was known and had been resolved by Avast on a February 2021 update of the\ndriver. Furthermore, we have received confirmation that Avast has been in contact with Microsoft to have them invalidate the\nsignature of older versions of the driver. Avast has been informed by Microsoft that a security update on March 2022 would\ncontain the signature update.\n\nThe specific aswArPot.sys driver utilized by the threat actors in this instance (SHA256:\n4b5229b3250c8c08b98cb710d6c056144271de099a57ae09f5d2097fc41bd4f1) has the following file version information:\n\n\n-----\n\nCopyright: Copyright (c) 2021 AVAST Software\nProduct: Avast Antivirus\nDescription: Avast Anti Rootkit\nOriginal Name: aswArPot.sys\nInternal Name: aswArPot\nFile Version: 21.1.187.0\nDate signed: 2021-02-01 14:09:00\n\n## The Targets\n\nDifferent implementations of this driver’s abuse, found either on VirusTotal or on the engagements, contain different lists of\ntargeted processes.\n\nThe smallest PowerShell script implementation targets only one specific process.\nThree “early” versions of the PE found on VirusTotal contained clear-text strings of the targeted processes, along with\nthe transparently named PDB path “F:\\\\Source\\\\WorkNew19\\\\KillAV\\\\Release\\\\KillAV.pdb“. These versions contained\n53, 72 and 88 targeted processes with the PE compilation timestamps of October 28, November 2th nd and November\n3, 2021, respectively. rd\nThe PE with the longest target list of all, found during the Cuba ransomware incident, contained 110 unique targeted\nprocesses (after removing duplicates) represented as CRC64 checksum values. It also contained the newest PE\ncompilation timestamp of all.\n\n\nUtilizing the HashDB API service from OpenAnalysis,3 we were able to recover the clear-text strings corresponding to the\nhardcoded CRC64 checksums of the latter sample mentioned above. The list contains process names from well-known AV\nand EDR vendors, which include, amongst others, processes names from SentinelOne, Cylance, Avast, Carbon Black,® ® ® ®\nSophos, McAfee, and Malwarebytes . ® ® ®\n\nBelow is the list of 110 targeted processes found in the latest PE:\n\nagentsvc.exe mfemms.exe SophosSafestore64.exe\n\nalsvc.exe msmpeng.exe sophosui.exe\n\navastsvc.exe notifier.exe ssdvagent.exe\n\navastui.exe ntrtscan.exe sspservice.exe\n\navp.exe paui.exe svcgenerichost.exe\n\navpsus.exe pccntmon.exe swc_service.exe\n\nbcc.exe psanhost.exe swi_fc.exe\n\nbccavsvc.exe psuamain.exe swi_service.exe\n\nccsvchst.exe psuaservice.exe tesvc.exe\n\nclientmanager.exe remediationservice.exe TmCCSF.exe\n\ncoreframeworkhost.exe repmgr.exe tmcpmadapter.exe\n\ncoreserviceshell.exe RepUtils.exe tmlisten.exe\n\ncpda.exe repux.exe updaterui.exe\n\ncptraylogic.exe savadminservice.exe vapm.exe\n\ncptrayui.exe savapi.exe VipreNis.exe\n\ncylancesvc.exe savservice.exe vstskmgr.exe\n\nds_monitor.exe SBAMSvc.exe wrsa.exe\n\ndsa.exe sbamtray.exe sophossafestore.exe\n\n\n-----\n\nefrservice.exe sbpimsvc.exe sophoslivequeryservice.exe\n\nepam_svc.exe scanhost.exe sophososquery.exe\n\nepwd.exe sdcservice.exe sophosfimservice.exe\n\nhmpalert.exe SEDService.exe sophosmtrextension.exe\n\nhostedagent.exe sentinelagent.exe sophoscleanup.exe\n\nidafserverhostservice.exe SentinelAgentWorker.exe sophos ui.exe\n\niptray.exe sentinelhelperservice.exe cloudendpointservice.exe\n\nklnagent.exe sentinelservicehost.exe cetasvc.exe\n\nlogwriter.exe sentinelstaticenginescanner.exe endpointbasecamp.exe\n\nmacmnsvc.exe SentinelUI.exe wscommunicator.exe\n\nmacompatsvc.exe sepagent.exe dsa-connect.exe\n\nmasvc.exe sepWscSvc64.exe responseservice.exe\n\nmbamservice.exe sfc.exe epab_svc.exe\n\nmbcloudea.exe smcgui.exe fsagentservice.exe\n\nmcsagent.exe SophosCleanM64.exe endpoint agent tray.exe\n\nmcsclient.exe sophosfilescanner.exe easervicemonitor.exe\n\nmctray.exe sophosfs.exe aswtoolssvc.exe\n\nmfeann.exe SophosHealth.exe avwrapper.exe\n\nmfemactl.exe SophosNtpService.exe\n\n## Future Functionality?\n\nThe PE found during the Cuba ransomware incident also contains a second smaller chunk of CRC64 checksums, which\ncorrespond to the names of three specific ransomware executables utilized by Cuba Ransomware: “a.exe”, “anet.exe” and\n“aus.exe”. These checksums sit next to unutilized strings “/c del“, “>> NUL” and “\\\\system32\\\\cmd.exe“. These strings are\nnever referenced. Along with the recent iterations and enhancements on observed versions of this PE, these strings indicate\nthat a potential future version of this executable could include a function to automatically delete the ransomware executables\nfrom disk.\n\n## Closing Remarks\n\nThe capabilities brought to the table by exploiting functionalities of a signed and widely distributed Antivirus piece of\nsoftware, running under the highest privileges on a system, demonstrates the power of this technique. The sophistication\nand resources being applied by ransomware groups into new innovative ways to bypass security controls continues to\nincrease.\n\n## IOCs\n\nBelow is a list of publicly found samples:\n\n**File Name** **SHA256 Hash**\n\neset.ps1 8fcfa67e1fde51f7d99c3714f80b7672a0bb0d31c6cafdb5e7670b845d4dee98\n\nA82.exe 4306c5d152cdd86f3506f91633ef3ae7d8cf0dd25f3e37bec43423c4742f4c42\n\nKillAV.exe aeb044d310801d546d10b247164c78afde638a90b6ef2f04e1f40170e54dec03\n\n\n-----\n\nf68cea99e6887739cd82865f9b973664117af14c1a25d4917eec25ce4b26a381\n\nc5e3b725080712c175840c59a37a5daa.virus\n\n## ATT&CK® Mapping\n\n**Execution**\n\nT1059.001 – Command and Scripting Interpreter – PowerShell\nT1106 – Native API\nT1569.002 – System Services – Service Execution\nT1204.002 – User Execution – Malicious File\n\n**Defense Evasion**\n\nT1458.002 – Abuse Elevation Control Mechanism – Bypass User Access Control\nT1140 – Deobfuscate/Decode Files or Information\nT1211 – Exploitation for Defense Evasion\nT1574.010 – Hijack Execution Flow – Service File Permissions Weakness\nT1562.001 – Impair Defense – Disable or Modify Tools\nT1036.005 – Masquerading – Match Legitimate Name or Location\nT1027.001 – Obfuscated Files or Information – Binary Padding\nT1027.002 – Software Packing\nT1055.002 – Process Injection – Portable Execution Injection\nT1218 – Signed Binary Proxy Execution\n\n**Discovery**\n\nT1057 – Process Discovery\n\n_Acknowledgements: Special thanks to Aon’s Cyber Solutions team member, Nhan Huynh, for assistance with revising_\n_content and ensuring accuracy._\n\nAuthors: Eduardo Mattos and Rob Homewood\n\nFebruary 26, 2022\n\n©Aon plc 2022\n\nThis material has been prepared for informational purposes only and should not be relied on for any other purpose. You should consult with your own professional advisors or IT\nspecialists before implementing any recommendation or following the guidance provided herein. Further, the information provided and the statements expressed are not intended\nto address the circumstances of any particular individual or entity. Although we endeavor to provide accurate and timely information and use sources that we consider reliable,\nthere can be no guarantee that such information is accurate as of the date it is received or that it will continue to be accurate in the future.\n\n1 How DoppelPaymer Hunts and Kills Windows Processes, https://www.crowdstrike.com/blog/how-doppelpaymer-huntsand-kills-windows-processes\n\n2 Signed Binary Proxy Execution – T1218, https://attack.mitre.org/techniques/T1218/\n\n3 https://hashdb.openanalysis.net/\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-26 - Yours Truly, Signed AV Driver- Weaponizing An Antivirus Driver.pdf"
    ],
    "report_names": [
        "2022-02-26 - Yours Truly, Signed AV Driver- Weaponizing An Antivirus Driver.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536131,
    "ts_updated_at": 1743041123,
    "ts_creation_date": 1653752777,
    "ts_modification_date": 1653752777,
    "files": {
        "pdf": "https://archive.orkl.eu/b0ce49690cf02d1ded32f4a024ae81b71ee10fa0.pdf",
        "text": "https://archive.orkl.eu/b0ce49690cf02d1ded32f4a024ae81b71ee10fa0.txt",
        "img": "https://archive.orkl.eu/b0ce49690cf02d1ded32f4a024ae81b71ee10fa0.jpg"
    }
}