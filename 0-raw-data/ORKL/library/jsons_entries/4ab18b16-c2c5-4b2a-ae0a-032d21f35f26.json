{
    "id": "4ab18b16-c2c5-4b2a-ae0a-032d21f35f26",
    "created_at": "2023-01-12T15:00:46.262219Z",
    "updated_at": "2025-03-27T02:16:26.267407Z",
    "deleted_at": null,
    "sha1_hash": "e36ac7a8c44a6f1dba8af08ce849fca002c297da",
    "title": "Hunting for Suspicious Usage of Background Intelligent",
    "authors": "",
    "file_creation_date": "2021-05-23T22:17:54Z",
    "file_modification_date": "2021-05-23T22:17:54Z",
    "file_size": 943724,
    "plain_text": "# Hunting for Suspicious Usage of Background Intelligent Transfer Service (BITS)\n\n**[blog.menasec.net/2021/05/hunting-for-suspicious-usage-of.html](https://blog.menasec.net/2021/05/hunting-for-suspicious-usage-of.html)**\n\n## BITS Overview\n\n[Background Intelligent Transfer Service (BITS) is used by programmers and system](https://docs.microsoft.com/en-us/windows/win32/bits/background-intelligent-transfer-service-portal)\nadministrators to download files from or upload files to HTTP web servers and SMB file\nshares.\n\nBITS will take the cost of the transfer into consideration, as well as the network usage so that\nthe user's foreground work has as little impact as possible. BITS also handles network\ninterruptions, pausing and automatically resuming transfers, even after a reboot, which\nmakes it a very good candidate for implant Command and Control standard tasks (download,\nupload and ex-filtration).\n\nBITS includes PowerShell cmdlets for creating and managing transfers as well as the\nBitsAdmin command-line utility.\n\nBITS is composed of a Client (i.e. bitsadmin, powershell) loading Bitsproxy.dll, qmgrprxy.dll\nor Microsoft.BackgroundIntelligentTransfer.Management.Interop.dll and a Server\n(svchost.exe with the process's command-line value contains the keyword \"BITS\" and hosting\nthe service DLL qmgr.dll):\n\n\n-----\n\nFigure 1 - BITS Client\n\nFigure 2 - BITS Server\n\nCommunication between the BITS client and server is performed via RPC, and\n[the IBackgroundCopyManager is the main BITS interface used to enumerate or create new](https://docs.microsoft.com/en-us/windows/win32/api/bits/nn-bits-ibackgroundcopymanager)\nBITS Jobs:\n\n\n-----\n\nFigure 3 - OleView of the BITS service exposed interfaces\n\n\n-----\n\nFigure 4 - BITS IBackgroundCopyManager Interface exposed Methods\n\nFigure 5 - BITS JOB TYPE\n\nFrom a behavior perspective all the download and upload activities are performed by the\nBITS server (svchost.exe) impersonating the BITS client which breaks the link between the\n[client and the server if using standard monitoring telemetry such as Sysmon network and file](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon)\ncreation events.\n\n[BITS can be also abused for persistence by setting a command to run every time a JOB](https://pentestlab.blog/2019/10/30/persistence-bits-jobs/)\ntransfer job enters the BG_JOB_STATE_ERROR or BG_JOB_STATE_TRANSFERRED\n[state using the IBackgroundCopyJob2::SetNotifyCmdLine method (i.e. bitsadmin.exe](https://docs.microsoft.com/en-us/windows/win32/api/bits1_5/nf-bits1_5-ibackgroundcopyjob2-setnotifycmdline)\n/SetNotifyCmdLine) which will result in a malicious program or command to be run\npersistently on a target system.\n\n\n-----\n\nFigure 6 - BITS SetNotifyCmdLine Parameters\n\n## Detection and Hunting\n\nFrom a detection and forensics perspective Windows provides good logging events for the\nBITS client activities via the Microsoft-Windows-Bits-Client provider (enabled by default),\nkey events are:\n\nEventID 3 - BITS service created a new Job\nEventID 59 - BITS started the <jobname> transfer job that is associated with\nhttp://example.com URL.\nEventID 60 - BITS stopped transferring the <jobname> transfer job that is associated\nwith the http://example.com URL. The status code is 0xxxx.\nEventID 4 - The transfer job is complete\nEventID 5 - Job cancelled.\nOther events that are related to performance and transfer errors\n\nEvents such as 59, 60 and 61 contains the download/upload URL (very useful for forensics\nand detection) and event 3 contains the details of the BITS client process path and the Job\nname (very useful for detecting abnormal BITS clients).\n\n\n-----\n\n[Below example of BITS events resulting from this malware sample (Remcos or Netwire RAT](https://app.any.run/tasks/43b6c05a-e0a8-4627-9f8d-ca66a950ed17/)\nloader):\n\nFigure 7 - BITS Client Event Logs 3 and 60\n\n### A) Unusual BITS Client:\n\nBy default on a Windows machine there are a limited number of BITS clients (native\nWindows binaries) and the majority are related to third party programs such as browsers. To\nbaseline the clients we can use Bitsproxy.dll or qmgrprxy.dll ImageLoad events (such as\nSysmon EventId 7) or BITS Client Event Logs EventId 3.\n\n\n-----\n\nBy default the following are the known normal BITS client with process path residing under\nc:\\windows\\ directory.\n\nc:\\Windows\\SysWOW64\\bitsadmin.exe\nc:\\Windows\\System32\\MDMAppInstaller.exe\nc:\\Windows\\System32\\DeviceEnroller.exe\nc:\\Windows\\SysWOW64\\OneDriveSetup.exe\nc:\\Windows\\System32\\ofdeploy.exe\nc:\\Windows\\System32\\directxdatabaseupdater.exe\nc:\\Windows\\System32\\MRT.exe (x)\nc:\\Windows\\System32\\aitstatic.exe\nc:\\Windows\\System32\\desktopimgdownldr.exe\nc:\\Windows\\System32\\Speech_OneCore\\common\\SpeechModelDownload.exe\nc:\\Windows\\System32\\RecoveryDrive.exe\nc:\\Windows\\System32\\svchost.exe (BITS service)\n\nExcluding the above we can hunt/detect for unusual client, below an example of a hunting\nEQL query:\n\nFigure 8 - Unusual Bits Client Hunt\n\n\n-----\n\nFigure 9 - Notepad.exe Unusual BITS Client\n\n### B) Program Execution via BITS SetNotifyCmdline Persistence:\n\nPrograms set to execute via the SetNotifyCmdline method are a child of the BITS service,\nthere are some legit instances especially signed stuff running from program files directories,\nbut its quite rare:\n\n\n-----\n\nFigure 10 - Malware example persisting via BITS SetNotifyCmdline Method\n\n### C) Execution of a File Downloaded via BITS Service:\n\nLast example is to hunt for executable content that is downloaded via BITS service and\nimmediately executed, we can do that by correlating File rename event (old file name always\nfollow this pattern BITXXXX.tmp and renamed to the target file name) by the BITS service\nfollowed by process execution by file.path/process.executable:\n\nFigure 11 - Download & Execution of a file via BITS using PowerShell\n\nAs you can see below we can link the file download activity to the process execution event:\n\n\n-----\n\nFigure 12 - Hunt for Process Execution of a File Downloaded via BITS service\n\nThere other scenarios but that should give you an idea of the building blocks and how to play\nwith them to spot unusual combinations.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/AV Tech/Hunting for Suspicious Usage of Background Intelligent.pdf"
    ],
    "report_names": [
        "Hunting for Suspicious Usage of Background Intelligent.pdf"
    ],
    "threat_actors": [
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d2516b8e-e74f-490d-8a15-43ad6763c7ab",
            "created_at": "2022-10-25T16:07:24.212584Z",
            "updated_at": "2025-03-27T02:02:10.141001Z",
            "deleted_at": null,
            "main_name": "Sofacy",
            "aliases": [
                "APT 28",
                "ATK 5",
                "Blue Athena",
                "BlueDelta",
                "FROZENLAKE",
                "Fancy Bear",
                "Fighting Ursa",
                "Forest Blizzard",
                "Grey-Cloud",
                "Grizzly Steppe",
                "Group 74",
                "GruesomeLarch",
                "ITG05",
                "Iron Twilight",
                "Operation DealersChoice",
                "Operation Dear Joohn",
                "Operation Komplex",
                "Operation Pawn Storm",
                "Operation Russian Doll",
                "Operation Steal-It",
                "Pawn Storm",
                "SIG40",
                "Sednit",
                "Snakemackerel",
                "Sofacy",
                "Strontium",
                "T-APT-12",
                "TA422",
                "TAG-0700",
                "TAG-110",
                "TG-4127",
                "Tsar Team",
                "UAC-0028",
                "UAC-0063"
            ],
            "source_name": "ETDA:Sofacy",
            "tools": [
                "ADVSTORESHELL",
                "AZZY",
                "Backdoor.SofacyX",
                "CHERRYSPY",
                "CORESHELL",
                "Carberp",
                "Computrace",
                "DealersChoice",
                "Delphacy",
                "Downdelph",
                "Downrage",
                "Drovorub",
                "EVILTOSS",
                "Foozer",
                "GAMEFISH",
                "GooseEgg",
                "Graphite",
                "HATVIBE",
                "HIDEDRV",
                "Headlace",
                "Impacket",
                "JHUHUGIT",
                "JKEYSKW",
                "Koadic",
                "Komplex",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LoJack",
                "LoJax",
                "MASEPIE",
                "Mimikatz",
                "NETUI",
                "Nimcy",
                "OCEANMAP",
                "OLDBAIT",
                "PocoDown",
                "PocoDownloader",
                "Popr-d30",
                "ProcDump",
                "PythocyDbg",
                "SMBExec",
                "SOURFACE",
                "SPLM",
                "STEELHOOK",
                "Sasfis",
                "Sedkit",
                "Sednit",
                "Sedreco",
                "Seduploader",
                "Shunnael",
                "SkinnyBoy",
                "Sofacy",
                "SofacyCarberp",
                "SpiderLabs Responder",
                "Trojan.Shunnael",
                "Trojan.Sofacy",
                "USB Stealer",
                "USBStealer",
                "VPNFilter",
                "Win32/USBStealer",
                "WinIDS",
                "Winexe",
                "X-Agent",
                "X-Tunnel",
                "XAPS",
                "XTunnel",
                "Xagent",
                "Zebrocy",
                "Zekapab",
                "carberplike",
                "certutil",
                "certutil.exe",
                "fysbis",
                "webhp"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535646,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1621808274,
    "ts_modification_date": 1621808274,
    "files": {
        "pdf": "https://archive.orkl.eu/e36ac7a8c44a6f1dba8af08ce849fca002c297da.pdf",
        "text": "https://archive.orkl.eu/e36ac7a8c44a6f1dba8af08ce849fca002c297da.txt",
        "img": "https://archive.orkl.eu/e36ac7a8c44a6f1dba8af08ce849fca002c297da.jpg"
    }
}