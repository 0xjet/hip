{
    "id": "d330b9ed-cced-4be0-abca-8d6c9026850b",
    "created_at": "2023-01-12T14:59:24.770988Z",
    "updated_at": "2025-03-27T02:09:18.557939Z",
    "deleted_at": null,
    "sha1_hash": "82c1338e7ee8f00958dec7a16dac0bc6ab21e8fc",
    "title": "2022-04-18 - An Investigation of the BlackCat Ransomware via Trend Micro Vision One",
    "authors": "",
    "file_creation_date": "2022-05-28T19:32:22Z",
    "file_modification_date": "2022-05-28T19:32:22Z",
    "file_size": 986323,
    "plain_text": "# An Investigation of the BlackCat Ransomware via Trend Micro Vision One\n\n**[trendmicro.com/en_us/research/22/d/an-investigation-of-the-blackcat-ransomware.html](https://www.trendmicro.com/en_us/research/22/d/an-investigation-of-the-blackcat-ransomware.html)**\n\nApril 18, 2022\n\nRansomware\n\nWe recently investigated a case related to the BlackCat ransomware group using the Trend\nMicro Vision One™ platform, which comes with extended detection and response (XDR)\ncapabilities. BlackCat (aka AlphaVM or AlphaV) is a ransomware family created in the Rust\nprogramming language and operated under a ransomware-as-a-service (RaaS) model.\n\nBy: Lucas Silva, Leandro Froes April 18, 2022 Read time: ( words)\n\n[We recently investigated a case related to the BlackCat ransomware group using the Trend](https://www.trendmicro.com/vinfo/us/security/definition/ransomware)\nMicro Vision One™ platform, which comes with extended detection and response (XDR)\ncapabilities. BlackCat (aka AlphaVM or AlphaV) is a ransomware family created in the Rust\n[programming language and operated under a ransomware-as-a-service (RaaS) model. Our](https://www.trendmicro.com/vinfo/us/security/definition/ransomware-as-a-service-raas)\ndata indicates that BlackCat is primarily delivered via third-party frameworks and toolsets (for\nexample, Cobalt Strike) and uses exploitation of exposed and vulnerable applications (for\nexample, Microsoft Exchange Server) as an entry point.\n\nBlackCat has versions that work on both Windows and Linux operating systems and in\nVMware’s ESXi environment. In this incident, we identified the exploitation of CVE-202131207. This vulnerability abuses the New-MailboxExportRequest PowerShell command to\nexport the user mailbox to an arbitrary file location, which could be used to write a web shell\non the Exchange Server.\n\nIn this blog entry, we discuss the kill chain used by the malicious actors behind this incident\nand how we used the Trend Micro Vision One platform to track the threats involved in the\nincident. We also dive deeper into the notable post-exploitation routines that were used until\nthe host’s encryption.\n\n## Finding the threats\n\nWe begin with the Trend Micro Vision One platform, where we noticed an incident being\ncreated in the Vision One console with a few workbenches related to it. Upon checking, we\nnoticed several suspicious web shells being dropped on the local Microsoft Exchange Server.\nBased on that information, we started the analysis of the Exchange Server.\n\n\n-----\n\nFigure 1. The\n\nincident view created by Vision One\nWe first noticed that ASPX files, normally dropped after ProxyShell and ProxyLogon\nexploitation, were dropped and detected (Backdoor.ASP.WEBSHELL.SMYXBH5A) in the\naffected machine. This type of ProxyShell exploitation usually involves three vulnerabilities:\n[CVE-2021-34473,](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-34473) [CVE-2021-34523, and the previously mentioned CVE-2021-31207. The](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-34523)\nfirst two were patched in July 2021, while the last one was fixed in May 2021. Successful\nexploitation of these vulnerabilities could lead to arbitrary writing of files that an attacker could\nabuse to upload web shells to a target Exchange Server. In this engagement, we determined\nthat CVE-2021-31207 was being actively exploited.\n\nThe exploitation is performed by importing a web shell as an email inside the user draft\nmailbox. It is then exported to c:/inetpub/wwwroot/aspnet_client/{5-random-digit}.aspx. Upon\nanalysis of the infected host, we identified several web shell variants used by the malicious\nactors.\n\nFigure 2. The email saved in the drafts folder\n\n\n-----\n\nFigure 3. The ASPX files as shown on the Vision One\n\nworkbench\nA web shell is a piece of code written in web development programming language, such as\nASP or JSP, that attackers could drop onto web servers to gain remote access and the ability\nto execute arbitrary code and commands to meet their objectives.\n\nWe discovered that the web shell employed in the attack uses the exec_code query\nparameter to execute the desired command.\n\nFigure 4. A\n\nsnippet of web shell content\nOnce a web shell is successfully inserted into the victim’s server, it could allow remote\nattackers to perform various tasks, such as stealing data and dropping other malicious tools.\nIn this engagement, we saw the Internet Information Services (IIS) process (w3wp.exe)\nspawning a PowerShell process that downloaded a Cobalt Strike beacon (detected as\nBackdoor.Win32.COBEACON.OSLJDO).\n\nFigure 5. The IIS\n\nprocess w3wp.exe spawning a PowerShell process\nThe PowerShell method WebClient.DownloadFile was used to download a DLL file from the\nIP address 5[.]255[.]100[.]242. After the download, the DLL was executed using rundll32.exe\nto call the exported function ASN1_OBJECT_create.\n\n\n-----\n\nFigure 6. The PowerShell command used to download the\n\nDLL\nUpon further investigation, we discovered that the DLL, libeay32.dll, was a tampered version\nof a known DLL normally used by OpenSSL and by other programs to help with SSL\ncommunication. The malicious actors modified an exported function of the DLL to host a\nCobalt Strike stager shellcode. The DLL was using a nonvalid certificate that belonged to the\nvideo communications company Zoom and was issued by GoDaddy.\n\nFigure 7. The libeay32.dll certificate\n\nFigure 8. The libeay32.dll issuer\n\nOnce executed, the exported function (ASN1_OBJECT_create) works as a loader for a\nclassic Cobalt Strike stager shellcode. Although this function contains a lot of code, most of it\nis just junk code containing useless operations. What it really does is simply allocate memory\nusing VirtualAlloc, copy a nonencrypted shellcode to the allocated region, and then transfer\nthe execution to it. The shellcode then decrypts another shellcode, which is the Cobalt Strike\nstager shellcode.\n\n\n-----\n\nbeing allocated for the first shellcode\n\nbeing transferred to the first shellcode\n\n\nFigure 9. Virtual memory\n\nFigure 10. Execution\n\n\n-----\n\nFigure 11. Decrypted\n\nCobalt Strike stager shellcode\nThe stager performs an HTTP GET request to a remote server mimicking a normal jQuery\nrequest to the path /jquery-3.5.1.slim.min.js. The shellcode then reads the server response,\nallocates memory also using the VirtualAlloc function, copies the downloaded content to the\nallocated region, and then transfers the execution to a hard-coded offset within the\ndownloaded content.\n\nBecause of the way malleable command-and-control (C&C) stagers work, the behavior\ndepends on the content being downloaded. During our research, we were not able to collect\nthe payload from the remote server. However, using the Vision One platform, we collected\nenough information to be able to state that the downloaded payload managed to spawn the\nWerFault.exe process and inject into it the system to host another Cobalt Strike beacon.\n\nIt should be noted that all the following activities described in this blog post were performed\nby the injected WerFault.exe process.\n\nWhile using the Vision One platform, we identified the C&C server used by the malicious\nactors.\n\n\n-----\n\nFigure 12. The Cobalt\n\nStrike beacon C&C server as shown in the Vision One console\nThe spawned WerFault.exe process generated the following activities:\n\nDiscovered accounts (account discovery technique)\nDropped and executed the NetScan tool\nDropped and executed the Bloodhound tool\nDropped the CrackMapExec tool\nDropped other versions of the tampered DLL to remote machines (lateral movement)\nExecuted the PowerShell version of the Inveigh tool\n\nThe following commands were executed for account discovery:\n\nnet group “Domain Admins” /DOMAIN\nnet group “Domain Controllers” /DOMAIN\nnet group “Enterprise Admins” /DOMAIN\nsysteminfo\n\nFigure 13. The account discovery commands\n\n\n-----\n\nThe NetScan tool was dropped on the file path C:\\Windows\\debug and used to scan the\n[network (network discovery activities). The same directory was also used to drop other tools](https://attack.mitre.org/techniques/T1046/)\nand samples described in this blog post. The NetScan tool, created by SoftPerfect, is capable\nof pinging remote computers, scanning ports, and discovering shared folders.\n\nFigure 14. The network scanning tool execution\n\nAfter the initial account discovery, the BloodHound tool was dropped. This tool allows the\nanalysis of Active Directory (AD) rights and relations. Using the collected data, BloodHound\nmaps out AD objects such as users, groups, and computers, and then accesses and queries\nthese relationships.\n\nFigure 15. BloodHound being dropped into the system\n\n\n-----\n\nFigure 16. Data extracted using BloodHound\n\n[CrackMapExec (aka CME) is a post-exploitation tool that abuses built-in AD features and](https://attack.mitre.org/software/S0488/)\nprotocols to achieve its functionality. Its capabilities include auto-injecting Mimikatz, shellcode,\nand DLLs into memory using PowerShell, and dumping NTDS.dit. The malicious actors tried\nto use the tool to dump credentials and conduct lateral movement through the network\n(detected as HackTool.Win32.Mpacket.SM).\n\nFigure 17. The\n\nCrackMapExec execution\nThe spawned WerFault.exe process was also responsible for spreading other tampered\nversions of libeay32.dll to other machines across the environment via SMB.\n\nFigure 18. WerFault.exe\n\nused to drop the libeay32.dll across the environment\n[Inveigh is a cross-platform .NET IPv4/IPv6 machine-in-the-middle penetration-testing tool. It](https://github.com/Kevin-Robertson/Inveigh)\ncan conduct spoofing attacks and NTLM challenge/response captures via SMB service. The\ninformation is captured through both packet sniffing and protocol-specific listeners/sockets. In\nthis incident, the PowerShell version of Inveigh was used to spoof the mDNS (multicast DNS)\nand NBNS (NetBIOS Name Service) protocols.\n\n\n-----\n\nFigure 19. The Inveigh command being executed\n\n## BlackCat execution\n\nBefore the execution of the BlackCat ransomware, we identified suspicious batch scripts\nbeing used by the malicious actors to prepare the environment for encryption.\n\nA file named spread.bat was created, and the following PowerShell command was used to\nexecute the spread.bat file. It should be noted that we could not collect the .bat file to verify its\ncontent.\n\npowershell -nop -exec bypass -EncodedCommand\nLgBcAHMAcAByAGUAYQBkAC4AYgBhAHQAIABtAGsAcwBoAGEAcgBlACAAUgBFAEEARAA=\n\nThe Vision One platform decoded the command, resulting in the code shown in the following\nfigure.\n\nFigure 20. The code generated after\n\ndecoding the command used to execute spread.bat\nAnother batch file, 123.bat, was executed. As with the previous batch file, we could not collect\nit to analyze its content.\n\nTo execute the sample, a token is required to avoid automated sandbox analysis. However,\nany provided token can bypass the restriction and enable the malware execution. The\nransomware also supports other commands, which can be obtained via the -h or --help\nparameters.\n\nFigure 21. The BlackCat help command\n\noutput\n\n\n-----\n\nThe malicious actors used SysVol Share to host the BlackCat sample that was executed\nacross the environment. This approach was used because the contents of SysVol Share are\nreplicated across all domain controllers in the Windows Server domain, meaning that all\nmachines will be able to access it. A copy of the sample was also dropped locally on the\nC:\\Windows\\debug folder.\n\nFigure 22. The BlackCat\n\nbinary that was dropped in SysVol Share\nFile permissions were changed using icacls.exe, a command-line utility that can be used to\nmodify NTFS permissions, as well as net share commands.\n\nFigure 23. Permission granted through\n\nicalcls.exe\n\nFigure 24. Permission granted\n\nthrough net share commands\nAfter preparing the environment, the malicious actors proceeded to execute the ransomware.\nUpon execution, BlackCat performs the following tasks:\n\nQuery the system UUID using wmic.\nThe universally unique identifier (UUID) is later used, together with the token, to identify\nthe victim in a Tor website hosted by the malicious actors.\nDelete volume shadow copies.\nUse BCDedit to disable recovery mode.\nIncrease the number of network requests that the server service can perform.\nThis allows the malware to access enough files during the encryption process.\nStop the IIS service using the iisreset.exe, a well-known tool used to handle IIS\nservices.\n\n\n-----\n\nExecute arp command to display current ARP (Address Resolution Protocol) entries.\nExecute Fsutil to allow the use of both remote and local symlinks.\nClear all event logs via wevutil.exe.\n\nOnce these tasks are finished, the target files are encrypted, and a 7-random-digit extension\nis added to the files. The ransom note (detected as Ransom.Win32.BLACKCAT.B.note) is\nthen dropped. It informs the victim that their data has been stolen and instructs them to\naccess a Tor onion domain.\n\nFigure 25. The BlackCat ransom note\nBlackCat samples, which are immediately detected by Trend Micro Predictive Machine\nLearning, are detected as Ransom.Win32.BLACKCAT.YXCCY.\n\n## Conclusion and security recommendations\n\nThis investigation gave us the opportunity to learn more about the BlackCat infection chain. It\nhighlights the continued evolution of threats that are designed to evade detection. Notable\ncapabilities and characteristics we observed included evasive tactics, such as masking a\ntampered DLL to make it seem legitimate.\n\nOrganizations should take note of the continuing trend among malicious actors of using\nCobalt Strike in attacks, living-off-the-land binaries (LOLBins), and red team or penetrationtesting tools to blend in with the environment.\n\nFor organizations, a good patch management protocol can help prevent the exploitation of\nvulnerable internet-facing servers. Early containment and mitigation are also essential to cut\noff more damaging attacks that compromise environments and deploy ransomware. In this\ncase, close monitoring of the system and prompt detection could have prevented all that was\ndescribed here from coming to pass.\n\nIn analyzing and correlating ransomware attacks, the use of multilayered detection and\nresponse solutions such as Trend Micro Vision One can provide powerful XDR capabilities\nthat collect and automatically correlate data across multiple security layers — email,\n\n\n-----\n\nendpoints, servers, cloud workloads, and networks — to prevent attacks via automated\nprotection, while also ensuring that no significant incidents go unnoticed.\n\n[A list of the indicators of compromise (IOCs) for this case can be found here.](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/22/d/an-investigation-of-the-blackcat-ransomware-via-trend-micro-vision-one/an-investigation-of-the-blackcat-ransomware-via-trend-micro-vision-one-iocs.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-18 - An Investigation of the BlackCat Ransomware via Trend Micro Vision One.pdf"
    ],
    "report_names": [
        "2022-04-18 - An Investigation of the BlackCat Ransomware via Trend Micro Vision One.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535564,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653766342,
    "ts_modification_date": 1653766342,
    "files": {
        "pdf": "https://archive.orkl.eu/82c1338e7ee8f00958dec7a16dac0bc6ab21e8fc.pdf",
        "text": "https://archive.orkl.eu/82c1338e7ee8f00958dec7a16dac0bc6ab21e8fc.txt",
        "img": "https://archive.orkl.eu/82c1338e7ee8f00958dec7a16dac0bc6ab21e8fc.jpg"
    }
}