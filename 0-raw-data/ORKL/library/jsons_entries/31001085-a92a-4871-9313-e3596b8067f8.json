{
    "id": "31001085-a92a-4871-9313-e3596b8067f8",
    "created_at": "2023-01-12T15:01:23.402537Z",
    "updated_at": "2025-03-27T02:16:28.846652Z",
    "deleted_at": null,
    "sha1_hash": "0bbc69cd38a6feff50ea02edceec761995c90e96",
    "title": "2022-01-12 - Abusing Microsoft Office Using Malicious Web Archive Files",
    "authors": "",
    "file_creation_date": "2022-05-28T17:13:06Z",
    "file_modification_date": "2022-05-28T17:13:06Z",
    "file_size": 2339018,
    "plain_text": "# Abusing Microsoft Office Using Malicious Web Archive Files\n\n**[netskope.com/blog/abusing-microsoft-office-using-malicious-web-archive-files](https://www.netskope.com/blog/abusing-microsoft-office-using-malicious-web-archive-files)**\n\nGustavo Palazolo January 12, 2022\n\n## Summary\n\n[In November of 2021, we described several techniques used by attackers to deliver malware](https://www.netskope.com/blog/malicious-office-documents-multiple-ways-to-deliver-payloads)\n[through infected Microsoft Office files. In addition to exploits like CVE-2021-40444, these](https://www.netskope.com/blog/microsoft-office-document-triggering-new-zero-day)\n[infected documents frequently abuse VBA (Visual Basic for Applications) to execute their](https://docs.microsoft.com/en-us/office/vba/library-reference/concepts/getting-started-with-vba-in-office)\ntechniques, regardless of the final payload. Attackers also often use extra layers of\nprotection to evade signature-based detections, like constructing PowerShell scripts and\n[WMI namespaces at runtime, as done by Emotet. In addition to code obfuscation, attackers](https://www.netskope.com/blog/you-can-run-but-you-cant-hide-detecting-malicious-office-documents)\nuse other techniques to evade detection like non-standard file types in Microsoft Word.\n\nNetskope Threat Labs is currently tracking a malicious campaign that uses Web Page\nArchive files (“.mht” or “.mhtml”) to deliver infected documents, which eventually deploys a\n[backdoor that uses Glitch for C2 communication. This is effective because Microsoft Word is](https://glitch.com/)\nable to open the document in “.mht” format, even using the “.doc” extension.\n\n[The usage of Web Archive files to deliver infected documents was previously seen and](https://www.mandiant.com/resources/cyber-espionage-apt32)\nlinked to [APT32 (a.k.a. Ocean Lotus and Cobalt Kitty), a cyber espionage group known for](https://malpedia.caad.fkie.fraunhofer.de/actor/apt32)\ntargeting [governments and](https://www.mandiant.com/resources/apt32-targeting-chinese-government-in-covid-19-related-espionage) [journalists. Furthermore, a similar backdoor used in this](https://cpj.org/2021/02/vietnam-based-hacking-oceanlotus-targets-journalists/)\n[campaign was spotted in August 2021 and also linked to this same threat group.](https://twitter.com/ShadowChasing1/status/1430787243644317696)\n\n\n-----\n\nIn this blog post, we will show details about how this threat campaign works.\n\n## Stage 01 – RAR Files\n\nThe attack chain starts with a RAR file that contains the infected Web Archive, probably\n[delivered through phishing campaigns. We have spotted some of the files in VirusTotal with a](https://www.virustotal.com/gui/file/a571a35c182c209ab755a8e3ec483b155a2b686de0e3ffc382d569cdef80c227)\nlow detection rate, between 7 and 10 engines.\n\nRAR files related to this malicious campaign.\nThe MHT file compressed in the RAR is quite large, between 35 and 63 MB, containing the\ninfected Word document as well as other files used throughout the attack.\n\nWeb Archive file that is opened by Microsoft Word.\n[Furthermore, we also found the “Zone.Identifier” file within the RAR, which is a common ADS](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-fscc/6e3f7352-d11c-4d76-8c39-2516a9df36e8)\n[(Alternate Data Stream) used to store metadata about the original file.](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-fscc/c54dec26-1551-4d3a-a0ea-4fa40f848eb3)\n\n\n-----\n\nZone.Identifier ADS within the RAR file.\n\nModern browsers may include additional information about the downloaded object in this\n[ADS, such as the source URL and the ZoneID, which defines the security zone based on](https://blog.didierstevens.com/2017/05/09/quickpost-internet-zone-ids/)\nwhere the file was downloaded from.\n\n[Microsoft Word won’t open the Web Archive file if the ZoneID is 3 or 4, as this indicates that](https://support.microsoft.com/en-us/topic/how-to-resolve-the-problem-word-experienced-an-error-trying-to-open-the-file-when-opening-a-word-2007-2010-file-easy-fix-article-0903bb9b-d8e4-aabd-0364-f832d26ecff7)\nthe file came from untrustworthy sources. It’s unclear if the attackers created this ADS on\npurpose, but the “ZoneId=2” bypasses the Office protection by making it look as if it came\nfrom a trusted site.\n\nWe can test this by changing the ZoneId to a higher number, which prevents the file from\nbeing opened.\n\nWeb Archive error when ZoneId is higher than 2.\n\n## Stage 02 – Infected Word File\n\nAs previously mentioned, Microsoft Word is able to handle Web Archives, and as soon as the\nvictim opens the file, the infected document within the Web Archive is opened, luring the user\nto click on the “Enable Content” button to execute the malicious code. Analysis tools such as\n[olevba and oledump are able to parse “.mht” and “.mhtml” files, however, we were not able to](https://github.com/decalage2/oletools)\nextract the code from these malicious files using these tools.\n\n\n-----\n\nFake message asking the victim to enable the file’s content.\nThe attackers also protected the VBA project with a password, likely to delay analysis.\n\nVBA project protected by password.\n\nOnce the protection is removed, we can observe a large and obfuscated VBA macro code.\n\n\n-----\n\nMalicious VBA code within the document.\n[We created a script to decode all the strings in this VBA code, which revealed some file](https://github.com/netskopeoss/NetskopeThreatLabsIOCs/blob/main/MHTGlitch/script/deobfuscate_macro_strings.py)\nnames and paths.\n\nSome VBA decoded strings.\n\nAfter some minor deobfuscation and analysis of the VBA code, we can tell that the script:\n\n1. Drops the payload to “C:\\ProgramData\\Microsoft\\User Account\n\n**Pictures\\guest.bmp“;**\n2. Copies the payload to “C:\\ProgramData\\Microsoft Outlook Sync\\guest.bmp“;\n3. Creates and display a decoy document named “Document.doc“;\n4. Rename the payload from “guest.bmp” to “background.dll“;\n5. Executes the DLL by calling either “SaveProfile” or “OpenProfile” export functions.\n\nThe final payload lies within the Web Archive, and the attackers removed the magic number\nand the MS-DOS stub message, likely to avoid detection. When the VBA code drops the DLL\nin the disk, it replaces the two bytes at the beginning of the file.\n\n\n-----\n\nVBA\n\nfixing DLL’s magic number.\nAfter executing the payload, the VBA code deletes the original Word file and opens the\ndecoy document.\n\nDecoy file created by the malicious VBA code.\n\n## Stage 03 – DLL Backdoor\n\nThe payload is a 64-bit DLL named “background.dll”, which is executed every 10 minutes\nthrough a scheduled task named “Winrar Update”.\n\n\n-----\n\nBackdoor persistence technique.\nThe DLL is quite large (between 20 and 32 MB) and it’s packed. The malicious entry point is\nlocated in the DLL exported function named either SaveProfile or OpenProfile. As soon as\nit’s running, the payload is unpacked and injected into another process.\n\nDLL unpacking and injecting payload.\nThe API “CreateProcessW” is used to create a “rundll32.exe” process that runs indefinitely,\nby calling the “Sleep” function from “kernel32.dll”. Using Windows native binaries (LoLBins)\nfor malicious activities is a common technique to stay under the radar, as previously\n[mentioned in our blog post.](https://www.netskope.com/blog/not-laughing-malicious-office-documents-using-lolbins)\n\n\n-----\n\nProcess injection technique.\nLooking closely at the function we named “mw_inject_payload”, it’s possible to observe\ncalls to “VirtualAllocEx”, used to allocate memory in the new process, and\n“WriteProcessMemory”, used to write the payload in the allocated space.\n\nOnce the unpacked payload is running, it starts by collecting information about the\nenvironment, such as the network adapter information, username, computer name, etc.\n\nBackdoor collecting environment information.\n\nFurthermore, the backdoor also enumerates all system’s directories and files and collects\ninformation about running processes.\n\n\n-----\n\nBackdoor collecting information about directories, files, and processes.\nOnce the data is collected, the malware compiles everything in a single location and encrypts\nthe content before sending it to the C2 server.\n\nEncrypting data before C2 communication.\nFinally, the data is sent to a C2 server hosted on [Glitch, which is a cloud service that](https://glitch.com/)\nprovides tools for collaborative web development.\n\n\n-----\n\nBackdoor C2 communication.\nWe have reported all the malicious URLs we found in this campaign to Glitch’s abuse team,\nwhich took immediate action to bring them down.\n\n## Conclusion\n\nAttackers will opt to use all available tools and techniques to minimize the chances of\ndetection, like in the case we just analyzed, where the usage of Web Archive files to deliver\ninfected documents minimizes the chances of signature-based detection. Also, by using a\ncloud service for C2 communication, attackers increase their chances to stay under the\nradar.\n\n## Protection\n\nNetskope Threat Labs is actively monitoring this campaign and has ensured coverage for all\nknown threat indicators and payloads.\n\n**Netskope Threat Protection**\n\nWin32.Trojan.MHTGlitch\n\n\n-----\n\n**Netskope Advanced Threat Protection provides proactive coverage against this**\nthreat.\n\nGen.Malware.Detect.By.StHeur indicates a sample that was detected using static\nanalysis\nGen.Malware.Detect.By.Sandbox indicates a sample that was detected by our\ncloud sandbox\n\n## IOCs\n\nA full list of IOCs, a Yara rule, and the script used in this analysis are all available in our Git\nrepo.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-12 - Abusing Microsoft Office Using Malicious Web Archive Files.pdf"
    ],
    "report_names": [
        "2022-01-12 - Abusing Microsoft Office Using Malicious Web Archive Files.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "870f6f62-84f5-48ca-a18e-cf2902cd6924",
            "created_at": "2022-10-25T15:50:23.303818Z",
            "updated_at": "2025-03-27T02:00:55.435309Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "APT32",
                "SeaLotus",
                "OceanLotus",
                "APT-C-00",
                "Canvas Cyclone"
            ],
            "source_name": "MITRE:APT32",
            "tools": [
                "Mimikatz",
                "ipconfig",
                "Kerrdown",
                "Cobalt Strike",
                "SOUNDBITE",
                "OSX_OCEANLOTUS.D",
                "KOMPROGO",
                "netsh",
                "RotaJakiro",
                "PHOREAL",
                "Arp",
                "Denis",
                "Goopy"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "af509bbb-8d18-4903-a9bd-9e94099c6b30",
            "created_at": "2023-01-06T13:46:38.585525Z",
            "updated_at": "2025-03-27T02:00:02.866727Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "TIN WOODLAWN",
                "OceanLotus Group",
                "OceanLotus",
                "Sea Lotus",
                "G0050",
                "Cobalt Kitty",
                "SeaLotus",
                "ATK17",
                "Ocean Lotus",
                "Ocean Buffalo",
                "POND LOACH",
                "Canvas Cyclone",
                "APT-C-00",
                "APT-32",
                "APT 32"
            ],
            "source_name": "MISPGALAXY:APT32",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f1518ac1-4710-4dd1-a422-e3801e4806cb",
            "created_at": "2024-05-01T02:03:08.147856Z",
            "updated_at": "2025-03-27T02:05:17.421275Z",
            "deleted_at": null,
            "main_name": "TIN WOODLAWN",
            "aliases": [
                "Cobalt Kitty",
                "OceanLotus",
                "WOODLAWN ",
                "APT32 "
            ],
            "source_name": "Secureworks:TIN WOODLAWN",
            "tools": [
                " Denis",
                " Goopy",
                " JEShell",
                " KerrDown",
                " Mimikatz",
                " Ratsnif",
                " Remy",
                " Rizzo",
                " RolandRAT",
                "Cobalt Strike"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "2439ad53-39cc-4fff-8fdf-4028d65803c0",
            "created_at": "2022-10-25T16:07:23.353204Z",
            "updated_at": "2025-03-27T02:02:09.749502Z",
            "deleted_at": null,
            "main_name": "APT 32",
            "aliases": [
                "APT 32",
                "APT-C-00",
                "APT-LY-100",
                "ATK 17",
                "Lotus Bane",
                "Ocean Buffalo",
                "OceanLotus",
                "Operation Cobalt Kitty",
                "Operation PhantomLance",
                "Pond Loach",
                "SeaLotus",
                "SectorF01",
                "Tin Woodlawn"
            ],
            "source_name": "ETDA:APT 32",
            "tools": [
                "Agentemis",
                "Android.Backdoor.736.origin",
                "AtNow",
                "Backdoor.MacOS.OCEANLOTUS.F",
                "BadCake",
                "CACTUSTORCH",
                "CamCapture Plugin",
                "CinaRAT",
                "Cobalt Strike",
                "CobaltStrike",
                "Cuegoe",
                "DKMC",
                "Denis",
                "Goopy",
                "HiddenLotus",
                "KOMPROGO",
                "KerrDown",
                "METALJACK",
                "MSFvenom",
                "Mimikatz",
                "Nishang",
                "OSX_OCEANLOTUS.D",
                "OceanLotus",
                "PHOREAL",
                "PWNDROID1",
                "PhantomLance",
                "PowerSploit",
                "Quasar RAT",
                "QuasarRAT",
                "RatSnif",
                "Remy",
                "Remy RAT",
                "Rizzo",
                "Roland",
                "Roland RAT",
                "SOUNDBITE",
                "Salgorea",
                "Splinter RAT",
                "Terracotta VPN",
                "Yggdrasil",
                "cobeacon",
                "denesRAT",
                "fingerprintjs2"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535683,
    "ts_updated_at": 1743041788,
    "ts_creation_date": 1653757986,
    "ts_modification_date": 1653757986,
    "files": {
        "pdf": "https://archive.orkl.eu/0bbc69cd38a6feff50ea02edceec761995c90e96.pdf",
        "text": "https://archive.orkl.eu/0bbc69cd38a6feff50ea02edceec761995c90e96.txt",
        "img": "https://archive.orkl.eu/0bbc69cd38a6feff50ea02edceec761995c90e96.jpg"
    }
}