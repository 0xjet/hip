{
    "id": "30511dc9-40f5-4c92-830f-d4292353ff55",
    "created_at": "2023-01-12T15:03:48.608718Z",
    "updated_at": "2025-03-27T02:17:11.79221Z",
    "deleted_at": null,
    "sha1_hash": "d335d8e61ee18268cdf166774314daec7bf3cf58",
    "title": "2022-05-27 - How bootkits are implemented in modern firmware and how UEFI differs from Legacy BIOS",
    "authors": "",
    "file_creation_date": "2022-06-01T12:22:58Z",
    "file_modification_date": "2022-06-01T12:22:58Z",
    "file_size": 8063537,
    "plain_text": "# Как буткиты внедряются в современные прошивки и чем UEFI отличается от Legacy BIOS / Habr\n\n**habr.com/ru/amp/post/668154/**\n\nptsecurity\n\nptsecurity\n\n## Как буткиты внедряются в современные прошивки и чем UEFI отличается от Legacy BIOS\n\nПривет, Хабр! На связи Антон Белоусов и Алексей Вишняков, и мы продолжаем вместе\nс вами изучать буткиты — наиболее опасный класс вредоносного ПО. Гонка\nвооружений между разработчиками решений в области ИБ и вирусописателями не\nостанавливается ни на секунду: первые активно внедряют новые механизмы\nпротиводействия киберугрозам, а вторые — инструменты их обхода. Как раз с точки\nзрения безопасности нас заинтересовал современный стандарт предзагрузки\nоперационных систем UEFI. Поэтому в этом посте мы решили:\n\nразобраться, чем загрузка в режиме UEFI отличается от загрузки в режиме Legacy\nBIOS;\n\nрассказать о новых экземплярах буткитов, нацеленных на компрометацию UEFI;\n\n\n-----\n\nвыяснить, похожи ли они на своих предшественников (обширную группу так\nназываемых legacy-буткитов мы подробно изучили [в прошлый раз);](https://habr.com/ru/company/pt/blog/655695/)\n\nрассмотреть используемые злоумышленниками техники и слабые места систем\nна платформе UEFI.\n\nКто не хочет читать много букв, может ознакомиться с этой же информацией в\nформате [вебинара. Такой же уровень полезности гарантируем!](https://www.youtube.com/watch?v=qAh4hPqC1rs)\n\nБуткиты бывают двух типов. Первые заточены на более ранние платформы, так\nназываемые Legacy BIOS. Вторые адаптированы под современные решения, которые\nимеют универсальный интерфейс UEFI для связи ОС с программами, которые\nуправляют низкоуровневыми функциями устройств (далее — UEFI, прошивка).\n\nНесмотря на более современный подход к обеспечению безопасности UEFI, в коде его\nпрошивок регулярно обнаруживают уязвимости. Например, в феврале этого года наши\nколлеги из компании Binarly [выявили более двух десятков брешей в UEFI, которые](https://www.anti-malware.ru/news/2022-02-02-111332/38103)\nзатрагивают миллионы устройств от крупнейших производителей. Злоумышленники,\nконечно же, не дремлют и стараются их активно эксплуатировать. Поэтому\nактуальность исследования защищенности платформы только растет. Большинство\nбуткитов универсальны. Например, [ESPecter и](https://www.welivesecurity.com/2021/10/05/uefi-threats-moving-esp-introducing-especter-bootkit/) [FinSpy умеют заражать как старые, так](https://securelist.com/finspy-unseen-findings/104322/)\nи новые платформы. Одним из недавно обнаруженных UEFI-буткитов стал\n[MoonBounce.](https://securelist.com/moonbounce-the-dark-side-of-uefi-firmware/105468/)\n\n## Архитектура UEFI\n\nUEFI (Unified Extensible Firmware Interface, единый интерфейс расширяемой прошивки)\n— это небольшая операционная система, которая начинает работать при включении\nкомпьютера. Она пришла на замену устаревшей модели BIOS. UEFI позволяет\nунифицировать процесс разработки и создавать отдельные модули, а не только\nпрошивку целиком. Фреймворк имеет хорошо читаемый и документированный код на\nC. Многие пользователи отмечают удобный интерфейс, который разрешает\nпользоваться мышью. Среди других преимуществ платформы — поддержка сети «из\nкоробки» и возможность работать с дисками объемом более 2 ТБ. Все это позволяет\nускорить процесс разработки и сделать его безопаснее.\n\n\n-----\n\nИнтерфейс UEFI\n\nВычисление размера диска\nПо требованиям платформы диск должен быть размечен в формате GPT.\nСоответственно, длина адреса блока будет равна 64 битам. Опираясь на эти данные,\nдавайте вычислим гипотетический размер диска, который можно адресовать с\nпомощью этого формата. Если использовать сектор размером 512 байтов, получим\nболее 9 зеттабайт.\n\nКод для инициализации оборудования, в том числе код для загрузки ОС, разумеется,\nважный элемент платформы, однако наибольший интерес для нас представляет\nинтерфейс, который позволяет взаимодействовать с UEFI.\n\n\n-----\n\nВысокоуровневый взгляд на UEFI\nПриложения и драйвера UEFI имеют две таблицы для работы с API-интерфейсом —\nEFI Boot Services Table (службы доступны в процессе загрузки) и EFI Runtime Services\nTable (службы доступны и в процессе загрузки, и в процессе работы ядра ОС). APIинтерфейс необходим, чтобы взаимодействовать с оборудованием, выделять память и\nвыполнять другие простые функции по аналогии с WinAPI.\n\nEFI Boot Services Table и EFI Runtime Services Table\n\n\n-----\n\nКак мы уже говорили ранее, прошивку UEFI можно дополнять модулями. Утилита UEFI\nTool позволяет парсить файлы прошивок различных вендоров. Например, файл\nпрошивки Asus содержит множество драйверов и модулей. С помощью этой утилиты в\nпроцессе разработки можно менять, удалять или добавлять модули в зависимости от\nслучая.\n\nФайл прошивки Asus, открытый в UEFI Tool\nНапомним схему цепочки программ в Legacy BIOS (ее мы рассматривали в прошлой\nстатье).\n\n\n-----\n\nЗагрузка в режиме BIOS\nПри переходе к UEFI такие компоненты, как MBR и VBR, исчезают, и их функции\nчастично берут на себя другие модули.\n\nЗагрузка в режиме UEFI\nВ UEFI процессор тоже стартует в реальном режиме, но переключение происходит на\nраннем этапе исполнения кода прошивки. За счет этого компоненты, которые\nнаходятся в файловой системе и затрагивают ОС, сразу работают в защищенном\nрежиме.\n\nКод UEFI достаточно сложный. Он включает семь стадий работы прошивки: Security,\nPre-EFI Initialization, Driver Execution Environment, Boot Device Selection, Transient\nSystem Load, Runtime и Afterlife. Что интересно, работа на стадии SEC происходит во\nвременной памяти, формирующейся из кэша процессора. На этом уровне прошивка\nстановится корнем доверия всей системы.\n\n\n-----\n\nНа стадии DXE выполняются DXE-драйверы для устройств. Именно на данном этапе\nзлоумышленникам удобнее всего встраивать вредоносные сущности в полезную\nнагрузку. BDS — стадия выбора загрузочного устройства, которое отвечает за запуск\nОС. Runtime — стадия работы ОС. Afterlife — стадия завершения работы компьютера.\n\nСтадии кода UEFI Источник: https://edk2-docs.gitbook.io/edk-ii-buildspecification/2_design_discussion/23_boot_sequence\nNVRAM-переменные помогают UEFI понимать, с какого устройства требуется\nзагрузиться. Они хранятся в энергонезависимой памяти. Есть стандартные\nпеременные и те, которые определяют разработчики платформ. Например,\nпеременные db и dbx используются Secure Boot, они содержат базу данных с ключами\nи хешами.\n\nНам интересна переменная BootOrder, определяющая порядок загружаемых устройств,\nи переменная Boot#### с номером устройства.\n\n\n-----\n\nСписок NVRAM-переменных\nЕсли рассмотреть дамп переменной Boot004 (она относится к первому устройству в\nсписке BootOrder), можно обнаружить путь к менеджеру загрузки bootmgfw.efi. Так\nпеременная указывает прошивке, где искать менеджер загрузки. В переменной также\nесть отсылка в виде GUID на хранилище параметров загрузки BCD (Boot Configuration\nData). В зависимости от системы важные данные можно сохранять непосредственно в\nNVRAM-область.\n\n\n-----\n\nДамп переменной Boot0004\nНиже представлена схема диска, размеченного с помощью GPT. В нулевом секторе\nрасположен Protective MBR. Его формат предполагает всего один раздел,\nописывающий весь диск. Намеренно указывается специальный диск этого раздела: это\nнеобходимо, чтобы компьютер без поддержки UEFI мог распознать диск формата GPT\nи случайно не затер его.\n\nВ первом секторе размещен заголовок. Он содержит параметры диска, разметку и\nадреса смещения данных.\n\nСхема диска, размеченного GPT\nЗа первым сектором следует таблица разделов. В ней 128 элементов, каждый из\nкоторых описывает определенный логический раздел на диске.\n\n\n-----\n\nСтруктура элемента таблицы\nБольше всего интересен первый элемент — type (член структуры, описывающей\nраздел), который позволяет найти раздел EFI System Partition. Там расположен\nменеджер загрузки.\n\n\n-----\n\nРаздел EFI System Partition\nРаздел EFI System Partition имеет структуру формата FAT32, содержит таблицы\nкластеров, адрес корневой директории и древовидную структуру расположения всех\nфайлов. Его можно распарсить, прочитать и найти все необходимые файлы.\nНапример, для Windows есть специальная утилита mountvol.exe, позволяющая\nсмонтировать по умолчанию скрытый раздел EFI System Partition и посмотреть его\nсодержимое. Для этого необходимо указать ключ /S и букву диска, куда его следует\nсмонтировать. В директории, которая была в NVRAM-переменной, находится файл\nменеджера загрузки. Помимо него, там есть и другие файлы: модуль, отвечающий за\nработу отладчика, и файл BCD (куст реестра с BCD-параметрами). Параметры будут\nнеобходимы в процессе работы менеджера загрузки и инициализации системы.\n\n\n-----\n\nИспользование утилиты mountvol.exe\nМенеджер загрузки является UEFI-приложением, поэтому должен соответствовать\nсоглашению о точке входа. Точка входа менеджера загрузки имеет определенную\nсигнатуру. Ее второй параметр — SystemTable — указывает на структуру, которая, в\nсвою очередь, содержит указатели на таблицу RuntimeServices и таблицу BootServices.\nИх задача — предоставить API-интерфейс для работы с оборудованием.\n\nТочка входа менеджера загрузки\n**Давайте обобщим ключевые отличия загрузки в режиме UEFI от загрузки в**\n**режиме Legacy BIOS:**\n\n**переключение режимов выполняется UEFI на ранней стадии;**\n\n**для работы с оборудованием используется API-интерфейс, в частности**\n**RuntimeServices и BootServices;**\n\n**менеджер загрузки (bootmgf.efi) инициализирует механизм проверки**\n**целостности кода (Code Integrity);**\n\n**загрузчик ОС winload.efi заворачивает UEFI-сервисы для использования**\n**ядром через HAL.**\n\n\n-----\n\n## Изучаем Secure Boot\n\nНа наш взгляд, самый интересный компонент прошивки UEFI — Secure Boot. Его\nархитектура хорошо описана и проиллюстрирована в книге «Руткиты и буткиты.\nОбратная разработка вредоносных программ и угрозы следующего поколения» (12+)\nза авторством Алекса Матросова, Евгения Родионова и Сергея Братуся.\n\nВ основе Secure Boot лежит набор ключей разного уровня. Самый важный среди них —\nplatform key (PK), который содержится в прошивке. Начальный PK верифицирует key\nexchange key (KEK).\n\nСтоит отметить, что существует две базы ключей:\n\ndb — база ключей для аутентификации, отвечает за проверку подписей модулей;\n\ndbx — база запрещенных ключей и хешей.\n\nСогласно алгоритму работы Secure Boot, при загрузке нового модуля проверяется не\nтолько его подпись, но и хеш. Дело в том, что бывают модули UEFI-драйверов с\nабсолютно легитимными подписями. При обнаружении критически опасной\nуязвимости, даже если модуль пройдет проверку подписи, но его хеш будет отмечен в\nбазе исключений, он не будет допущен к загрузке и исполнению.\n\nUEFI-модули могут быть двух форматов:\n\n   -   Portable Executable (привычный для Windows);\n\n   -   Terse Executable. Этот формат похож на Portable Executable, но лишен части\nполей и имеет другие сигнатуры.\n\n\n-----\n\nАлгоритм работы Secure Boot Источник: https://edk2-docs.gitbook.io/understanding-theuefi-secure-boot-chain/secure_boot_chain_in_uefi/uefi_secure_boot\n\n## Как работает UEFI-буткит\n\nЕсть два варианта заражения:\n\n1.   Заражение прошивки\n\n\n-----\n\n2.   Заражение в EFI System Partition, в частности:\n\n-   подмена bootmgfw.efi\n\n-   добавление нового модуля\n\n\n-----\n\nИзвестны успешные атаки, в ходе которых злоумышленникам удавалось перезаписать\nкод в SPI-чипе, то есть, по сути, заразить его. Позднее появилась пара буткитов,\nнацеленных на компрометацию менеджера загрузки.\n\nНа данный момент мы можем выделить два вектора атаки на UEFI-платформу:\nперепрошивка SPI и модификация менеджера загрузки. Касательно второго вектора\nследует выделить частный случай добавления нового модуля в раздел EFI System\nPartition и последующего изменения пути в NVRAM-переменной, которая указывает, с\nкакого устройства необходимо загрузиться.\n\n### Первая ласточка — буткит LoJax\n\nПервый UEFI-буткит был [найден и описан специалистами ESET. В LoJax](https://www.welivesecurity.com/2018/09/27/lojax-first-uefi-rootkit-found-wild-courtesy-sednit-group/)\nиспользовался подход перезаписи содержимого прошивки. Другими словами, он\nсчитывал прошивку, находил маркеры, что-то добавлял и записывал обратно.\n\n\n-----\n\nСхема работы\n\n\nбуткита LoJax Источник: https://www.welivesecurity.com/wpcontent/uploads/2018/09/ESET-LoJax.pdf\n\n\n-----\n\nВажно понимать, что чип SPI представляет собой некое PCI-устройство.\nСледовательно, чтобы с ним взаимодействовать нужен особый интерфейс. Поэтому\nчтение и запись содержимого чипа — это многоступенчатая и сложная операция,\nвключающая работу с различными флагами и параметрами. Если изучить код одного\nиз модулей LoJax, умеющих читать и писать в SPI, можно убедиться, что это\nдействительно PCI-устройство. В модуле прописан PCI-адрес устройства, а с\nустройством этот модуль взаимодействует посредством драйвера с помощью функции\nDeviceIoControl.\n\nФункция DeviceIoControl\nИнтерфейс работы с SPI непрозрачен. Кроме того, механизмы безопасности защищают\nего от простого считывания. В случае LoJax в основу подхода по компрометации легла\nэксплуатация уязвимости race condition. Стоит отметить, что данная уязвимость\nприсутствует не во всех системах. У SPI-чипа есть набор флагов, управляющих не\nтолько разрешением на запись, но и его блокировкой. Один из флагов можно сбросить\nс помощью кода, работающего в режиме System Management Mode (SMM). Это\nпривилегированный режим, в котором приостанавливается исполнение другого кода, в\nтом числе кода ОС и гипервизора. Как только происходит попытка записи, SMM\nблокирует возможность записывать. Поэтому создатели буткитов используют два\nпотока. Таким способом они одновременно пытаются сбросить защитные флаги и\nзаписать что-то в чип.\n\n\n-----\n\nСхема эксплуатации race condition для перезаписи SPI Источник:\nhttps://composter.com.ua/documents/Exploiting_Flash_Protection_Race_Condition.pdf\nЧтобы взаимодействовать c PCI-устройством, LoJax использует драйвер в составе\n[утилиты Read & Write Everything. Утилита позволяет работать с низкоуровневыми](http://rweverything.com/)\nкомпонентами системы: физической памятью, устройствами ввода-вывода и другими.\nЧтобы выполнять функции чтения-записи физической памяти, взаимодействия с\nустройствами и различными низкоуровневыми подсистемами и настройками, она\nимеет подписанный легитимный драйвер, который как раз и использовали\nразработчики LoJax.\n\n\n-----\n\nУтилита RW\nОтметим, что PCI-устройства должны следовать соглашениям и в том числе иметь в\nсвоем составе блок данных PCI Configuration Space. PCI Configuration Space находится\nнепосредственно в PCI-устройстве. Чтобы читать этот блок или записывать в него, есть\nдва порта ввода-вывода: 0xCF8 и 0xCFC.\n\nСтруктура PCI Configuration Space Источник:\nhttps://en.wikipedia.org/wiki/PCI_configuration_space\n\n\n-----\n\nЧерез порт PCI_COFIG_ADDRESS указывается адрес внутри блока данных, откуда\nможно считать (read) или записать (write) данные. Так, можно считать данные из PCI\nConfiguration Space, например идентификатор устройства или его производителя, а\nтакже специфические для этого устройства значения. Порт PCI_CONFIG_DATA\nиспользуется для считывания и записи данных. Направление зависит от применяемой\nинструкции: IN — считывание, OUT — запись.\n\nКроме того, у PCI-устройства есть Base Address Registers — область, содержащая\nспецифические значения для данного устройства. Например, адрес в физической\nпамяти, куда отображены управляющие регистры SPI. По сути, за счет взаимодействия\nс PCI-регистрами, отображенными в физической памяти, и выполняется чтение\nпрошивки и запись в нее.\n\nФункция записи и чтения прошивки\nОбращаем внимание, что в памяти отображается не содержимое чипа, а, например,\nчетыре или восемь байтов, каждый из которых может быть либо флагом, либо\nуправляющим значением. Эти значения изменяются — и выполняется взаимодействие.\nЕсли расписать последовательность шагов, то сначала мы:\n\nсчитываем PCI-регистры из Base Address Registers с помощью портов CF8 и CFC;\n\nполучаем адрес регистров, отображенных в физической памяти;\n\nпишем в отображенные регистры команды управления, в частности указываем\nадрес, откуда необходимо считать новую прошивку.\n\nВсе перечисленные операции выполняются в цикле. Он включает установку\nконтрольного флага, начало чтения (или записи) и изменение дополнительных\nпараметров.\n\n\n-----\n\nМанипуляция с байтами в сегменте физической памяти\nЭти, на первый взгляд, сложные манипуляции помогают буткиту LoJax достичь цели:\nзаписать вредоносный код в прошивку, заменить модуль с легитимным кодом на свой и\nисполнить его на ранней стадии загрузки системы. Так он будет недосягаем для\nантивирусов и других средств защиты, а атакующие смогут получить необходимый им\npersist.\n\n### Знакомьтесь: MosaicRegressor\n\nЕще один интересный буткит — [MosaicRegressor, исследованный специалистами](https://www.kaspersky.ru/about/press-releases/2020_mozaika-regressa-obnaruzheno-novoe-vredonosnoe-po-dlya-zarazheniya-kompyutera-na-nizkom-urovne)\n«Лаборатории Касперского». В его случае начальный вектор заражения неизвестен, то\nесть никто не знает, как буткит был установлен.\n\n\n-----\n\nСостав MosaicRegressor\nВ зараженной прошивке исследователи обнаружили четыре модуля, два драйвера и\nдва приложения, исполняющих вредоносную нагрузку. Рассмотрим их подробнее.\nПервым исполняется модуль SmmInterfaceBase. В его задачу входит создание c\nпомощью API-функции CreateEventEx события EVENT_GROUPR_READY_TO_BOOT.\nЭто событие наступает перед тем, как управление передается менеджеру загрузки.\nТогда же вызывается обратный вызов NotifyFunction.\n\nСостав модулей MosaicRegressor\n\n\n-----\n\nИнтересно, что происходит внутри callback? Давайте посмотрим. С помощью\nуникального идентификатора приложения (GUID) обнаруживается модуль\nSmmAccessSub. Затем он запускается.\n\nМодуль SmmAccessSub\nВ этом модуле SmmAccessSub, по нашему мнению, довольно тривиальный подход к\npersist. Он заключается в сбросе пользовательского модуля в папку Startup. При этом\nникаких действий с драйверами или подмен не происходит.\n\nЕще одним модулем в зараженной прошивке был SmmReset. Он сбрасывает значение\nEFE до нуля.\n\n\n-----\n\nМодуль SmmReset\nБуткит MosaicRegressor не использует SmmReset, однако модуль для работы с точно\nтакой же переменной есть в утекшем [репозитории Hacking Team и применяется, чтобы](https://github.com/hackedteam/vector-edk)\nопределить, заражена прошивка или нет.\n\nФрагмент кода из репозитория vector-edk. Установка флага заражения прошивки\nИсточник: https://github.com/hackedteam/vector-edk/\n\n### MoonBounce — самый примечательный экземпляр\n\nMoonBounce можно назвать новинкой в списке буткитов, угрожающих UEFI. Его\n[обнаружили в конце января 2022 года. Вредонос отличает сложная и интересная схема](https://securelist.com/moonbounce-the-dark-side-of-uefi-firmware/105468/)\nзаражения. Так же, как и в случае с MosaicRegressor, начальный вектор проникновения\nнеизвестен.\n\n\n-----\n\nВ прошивке буткит начинает работать до стадии исполнения драйверов. При этом\nвредоносные действия выполняются не в драйвере, а непосредственно в коде\nпрошивки — в начале стадии DXE. Принцип работы MoonBounce следующий: буткит\nперехватывает несколько функций Boot-сервисов. Первая функция размещает в\nпамяти шеллкод уровня Ring 0, другая — перехватывает функцию, которая передает\nуправление ядру ОС, а затем перехватывает функцию выделения памяти внутри ядра\nExAllocatePool. Все это MoonBounce делает, чтобы исполнить шеллкод, который был\n«замаплен» еще на стадии работы прошивки. Дальше в дело вступает сам шеллкод: он\nзагружает и вызывает вредоносный драйвер, который обладает возможностями\nруткита. Как вы, наверное, уже поняли, необычно здесь то, что случилось не\n«аккуратное внедрение» модуля, а заражение всей прошивки.\n\nПринцип работы MoonBounce Источник: https://securelist.com/moonbounce-the-dark-sideof-uefi-firmware/105468/\n\n## Атаки на Boot-менеджеры\n\n\n-----\n\nАтаки на Boot-менеджеры рассмотрим на примере буткитов FinSpy и ESPecter. [FinSpy,](https://securelist.com/finspy-unseen-findings/104322/)\nтакже известный как FinFisher, подменяет оригинальный менеджер загрузки на\nвредоносный. В частности, при передаче управления от UEFI к менеджеру загрузки\nвызывается вредоносный менеджер, который выполняет некоторые функции\n(например, перехватывает функции передачи управления ядру или патчит код,\nответственный за проверку цифровых подписей), а затем загружается оригинальный\nBoot-менеджер.\n\nСодержимое зараженного EFI System Partition и код для монтирования EFI System\nPartition Источник: https://securelist.com/finspy-unseen-findings/104322/\nДля заражения раздела EFI System Partition злоумышленникам достаточно\nвоспользоваться банальным набором API. Это позволяет им смонтировать раздел и в\nдальнейшем работать с ним, как с любым другим диском.\n\nПринцип работы FinSpy\nАлгоритм работы FinSpy выглядит так:\n\n\n-----\n\nподмененный Boot-менеджер загружает оригинальный Boot-менеджер;\n\nподменный менеджер патчит в оригинальном функцию, передающую управление\nсначала загрузчику, а затем ядру.\n\nВторое действие позволяет перехватить ядерную функцию создания системного\nпотока. Она, в свою очередь, дает возможность сбросить вредоносную нагрузку.\nПрошивка UEFI в этой атаке затронута не была.\n\n[ESPecter замыкает пятерку буткитов, на текущий момент известных исследователям.](https://www.welivesecurity.com/2021/10/05/uefi-threats-moving-esp-introducing-especter-bootkit/)\nЕго корни уходят как минимум в 2012 год. В процессе своей работы ESPecter патчит\nменеджер загрузки, чтобы заменить легитимный драйвер (либо beep.sys, либо\nwinsys.dll) на вредоносный. Кроме того, загрузчик буткита патчит проверку целостности\nзагрузчика (да-да, загрузчик проверяет сам себя на пропатченность).\n\nЛогика работы\n\nESPecter Источник: https://www.welivesecurity.com/2021/10/05/uefi-threats-moving-espintroducing-especter-bootkit/\n\n\n-----\n\nБуткит ESPecter отключает проверку цифровой подписи драйверов, чтобы загрузить в\nсистему подменный beep.sys или winsys.dll и запустить его.\n\nВредоносный код, позволяющий обойти проверку цифровой подписи Источник:\nhttps://www.welivesecurity.com/2021/10/05/uefi-threats-moving-esp-introducing-especterbootkit/\n\nПодмена легитимного драйвера на вредоносный при выключенной проверке подписи\nдрайверов Источник: https://www.welivesecurity.com/2021/10/05/uefi-threats-moving-espintroducing-especter-bootkit/\nВ ядре Windows предусмотрена функция, отвечающая за инициализацию проверки\nцелостности. Если ее запатчить и приравнять к нулю переменную CiOptions, проверки\nбудут проходить так словно драйверы подписаны Этот подход ESPecter применяет\n\n\n-----\n\nдля legacy-систем.\n\n## Что это за зверь такой — System Management Mode\n\nРассказывая о буткитах, нельзя не упомянуть System Management Mode —\nпривилегированный режим работы процессора. Он необходим для управления\nэлектропитанием и проприетарными функциями (их определяют сами вендоры).\n\nРасширенная схема\n\nуровней привилегий в ПК Источник: https://medium.com/swlh/negative-rings-in-intelarchitecture-the-security-threats-youve-probably-never-heard-of-d725a4b6f831\nРежим SMM, который часто еще называют Ring -2, непрозрачен для ОС. Переходя в\nнего, процессор может выполнять код. Код обычно находится в области памяти\nSMRAM. Она начинается с адреса SMBASE. SMBASE по дефолту имеет\nфиксированный адрес, но также может меняться с помощью специальных MSRрегистров. В режиме SMM процессор сохраняет весь свой контекст (значения почти\nвсех регистров в верхней области памяти).\n\n\n-----\n\nСтруктура памяти SMRAM\nПерейти в режим SMM процессор может несколькими способами. Например, он может\nвыполнить прерывание (System Management Interrupt, SMI). Выделяют три вида\nпрерывания:\n\n-   аппаратное,\n\n-   системное,\n\n-   программное.\n\nС позиции атакующего системные прерывания сложны в реализации. Тогда как\nпрограммные вполне можно вызвать кодом на уровне драйвера. Для этого на порты b3\nи b2 необходимо отправить определенное значение (оно отличается для разных\nустройств), и процессор переключится в режим SMM.\n\n\n-----\n\nФрагмент кода из фреймворка CHIPSEC для вызова программного SMI Источник:\nhttps://github.com/chipsec/chipsec/blob/main/drivers/win7/amd64/cpu.asm\n\n\n-----\n\nВысокоуровневое представление процесса обновления BIOS из ОС Источник: Rootkits\nand Bootkits by Alex Matrosov, Eugene Rodionov, and Sergey Bratus (No Starch Press,\n2019)\nРежим SMM опасен еще и тем, что имеет доступ ко всей памяти системы. Из этого\nвырисовывается несколько возможных вариантов эксплуатации: использование\nруткита с доступом к системе либо перезапись содержимого чипа SPI. SMM имеет\nмного уязвимостей, преимущественно вендороспецифичных, например, SMM Callout,\nкоторая позволяет выполнить код в режиме SMM за пределами SMRAM. Убедиться в\nнеиллюзорности угроз можно, ознакомившись со [списком уязвимостей. По большей](https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=smm)\nчасти они характерны либо для конкретного девайса, либо фреймворка.\n\n## Резюме\n\nВ заключение кратко перечислим главные моменты статьи:\n\nUEFI-буткиты могут обойти все механизмы защиты и получить контроль над всей\nсистемой;\n\nSPI-буткит невозможно удалить ни переустановкой ОС, ни форматированием\nжесткого диска;\n\nдля борьбы с буткитами есть механизмы защиты, такие как Secure Boot и Intel\nBoot Guard, но они не панацея;\n\n\n-----\n\nнаибольшую опасность сегодня представляют уязвимости в режиме SMM и\nподсистеме Intel ME.\n\nКак эффективно обнаруживать UEFI-буткиты, расскажем на следующем вебинаре.\n[Stay tuned!](https://www.ptsecurity.com/ru-ru/research/webinar/?PAGEN_1=2)\n\nПосмотреть видеоверсию статьи и скачать [презентацию вы можете](https://www.ptsecurity.com/upload/corporate/ru-ru/webinars/ics/Webinar_Bootkits_UEFI.pdf) на сайте Positive\nTechnologies.\n\n_Авторы:_\n\n_Антон Белоусов, старший специалист отдела обнаружения вредоносного ПО_\n_[экспертного центра безопасности Positive Technologies](https://www.ptsecurity.com/ru-ru/services/esc/)_\n\n_Алексей Вишняков, руководитель отдела обнаружения вредоносного ПО_\n_экспертного центра безопасности Positive Technologies_\n\nТеги:\n\nХабы:\n\n[@ptsecurity](https://habr.com/users/ptsecurity/posts/)\nПользователь\n\n[Комментарии](https://habr.com/post/668154/comments/)\nПохожие публикации\n\nЛучшие за сутки\n\n\n-----",
    "language": "RU",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-27 - How bootkits are implemented in modern firmware and how UEFI differs from Legacy BIOS.pdf"
    ],
    "report_names": [
        "2022-05-27 - How bootkits are implemented in modern firmware and how UEFI differs from Legacy BIOS.pdf"
    ],
    "threat_actors": [
        {
            "id": "a3687241-9876-477b-aa13-a7c368ffda58",
            "created_at": "2022-10-25T16:07:24.496902Z",
            "updated_at": "2025-03-27T02:02:10.256629Z",
            "deleted_at": null,
            "main_name": "Hacking Team",
            "aliases": [],
            "source_name": "ETDA:Hacking Team",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e90c06e4-e3e0-4f46-a3b5-17b84b31da62",
            "created_at": "2023-01-06T13:46:39.018236Z",
            "updated_at": "2025-03-27T02:00:02.978356Z",
            "deleted_at": null,
            "main_name": "Hacking Team",
            "aliases": [],
            "source_name": "MISPGALAXY:Hacking Team",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d2516b8e-e74f-490d-8a15-43ad6763c7ab",
            "created_at": "2022-10-25T16:07:24.212584Z",
            "updated_at": "2025-03-27T02:02:10.141001Z",
            "deleted_at": null,
            "main_name": "Sofacy",
            "aliases": [
                "APT 28",
                "ATK 5",
                "Blue Athena",
                "BlueDelta",
                "FROZENLAKE",
                "Fancy Bear",
                "Fighting Ursa",
                "Forest Blizzard",
                "Grey-Cloud",
                "Grizzly Steppe",
                "Group 74",
                "GruesomeLarch",
                "ITG05",
                "Iron Twilight",
                "Operation DealersChoice",
                "Operation Dear Joohn",
                "Operation Komplex",
                "Operation Pawn Storm",
                "Operation Russian Doll",
                "Operation Steal-It",
                "Pawn Storm",
                "SIG40",
                "Sednit",
                "Snakemackerel",
                "Sofacy",
                "Strontium",
                "T-APT-12",
                "TA422",
                "TAG-0700",
                "TAG-110",
                "TG-4127",
                "Tsar Team",
                "UAC-0028",
                "UAC-0063"
            ],
            "source_name": "ETDA:Sofacy",
            "tools": [
                "ADVSTORESHELL",
                "AZZY",
                "Backdoor.SofacyX",
                "CHERRYSPY",
                "CORESHELL",
                "Carberp",
                "Computrace",
                "DealersChoice",
                "Delphacy",
                "Downdelph",
                "Downrage",
                "Drovorub",
                "EVILTOSS",
                "Foozer",
                "GAMEFISH",
                "GooseEgg",
                "Graphite",
                "HATVIBE",
                "HIDEDRV",
                "Headlace",
                "Impacket",
                "JHUHUGIT",
                "JKEYSKW",
                "Koadic",
                "Komplex",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LoJack",
                "LoJax",
                "MASEPIE",
                "Mimikatz",
                "NETUI",
                "Nimcy",
                "OCEANMAP",
                "OLDBAIT",
                "PocoDown",
                "PocoDownloader",
                "Popr-d30",
                "ProcDump",
                "PythocyDbg",
                "SMBExec",
                "SOURFACE",
                "SPLM",
                "STEELHOOK",
                "Sasfis",
                "Sedkit",
                "Sednit",
                "Sedreco",
                "Seduploader",
                "Shunnael",
                "SkinnyBoy",
                "Sofacy",
                "SofacyCarberp",
                "SpiderLabs Responder",
                "Trojan.Shunnael",
                "Trojan.Sofacy",
                "USB Stealer",
                "USBStealer",
                "VPNFilter",
                "Win32/USBStealer",
                "WinIDS",
                "Winexe",
                "X-Agent",
                "X-Tunnel",
                "XAPS",
                "XTunnel",
                "Xagent",
                "Zebrocy",
                "Zekapab",
                "carberplike",
                "certutil",
                "certutil.exe",
                "fysbis",
                "webhp"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535828,
    "ts_updated_at": 1743041831,
    "ts_creation_date": 1654086178,
    "ts_modification_date": 1654086178,
    "files": {
        "pdf": "https://archive.orkl.eu/d335d8e61ee18268cdf166774314daec7bf3cf58.pdf",
        "text": "https://archive.orkl.eu/d335d8e61ee18268cdf166774314daec7bf3cf58.txt",
        "img": "https://archive.orkl.eu/d335d8e61ee18268cdf166774314daec7bf3cf58.jpg"
    }
}