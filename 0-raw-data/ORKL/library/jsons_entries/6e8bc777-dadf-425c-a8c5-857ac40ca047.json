{
    "id": "6e8bc777-dadf-425c-a8c5-857ac40ca047",
    "created_at": "2022-10-25T16:48:18.431293Z",
    "updated_at": "2025-03-27T02:05:59.802328Z",
    "deleted_at": null,
    "sha1_hash": "83a39ba787596d0eda418d8d6c725e08ca8f0b7a",
    "title": "",
    "authors": "",
    "file_creation_date": "2017-10-17T16:00:17Z",
    "file_modification_date": "2017-10-17T16:00:17Z",
    "file_size": 981942,
    "plain_text": "# Malware Report\n\n## “Dridex Version 4”\n\n**SIN CLASIFICAR**\n\n\n-----\n\n### August, 2017\n\n#### CONTENTS\n\n**1.** **EXECUTIVE SUMMARY ............................................................................................................ 2**\n\n**2.** **CHARACTERISTICS OF THE TROJAN ....................................................................................... 3**\n\n**3.** **INFECTION PROCESS .............................................................................................................. 6**\n\n3.1. Infection Vectors.............................................................................................................. 6\n\n3.2. Interactions with the Affected System ........................................................................ 6\n\n**4.** **PERSISTENCE IN THE SYSTEM ................................................................................................... 7**\n\n**5.** **INJECTION VIA ATOMBOMBING ........................................................................................... 9**\n\n5.1. Search for the target process ....................................................................................... 9\n\n5.2. Search for alertable threads ....................................................................................... 10\n\n5.3. Injection of shellcode in the target process ............................................................. 10\n\n5.4. Execution of the shellcode in the target process ................................................... 12\n\n**6.** **NETWORK CONNECTIONS .................................................................................................... 13**\n\n**7.** **IOCS ....................................................................................................................................... 14**\n\n**8.** **REFERENCIAS ......................................................................................................................... 14**\n\n#### 1. Executive Summary \n\nThe present document gathers analysis of a new variant of harmful code called\n“Dridex”, specifically the fourth version.\n\n2\n\n##### SIN CLASIFICAR\n\n\n-----\n\nDridex is a banking Trojan famous for its sophistication and its ability to go undetected\non the devices it infects. These devices, once infected, are incorporated onto a modular\nbotnet, at which point malicious characteristics, whether external or their own, can be\nfreely added to them, via modules or libraries.\n\nThe first version appeared toward the end of 2014. At the beginning of 2015, a new,\nimportant update was launched, giving way to a second version. When looking at the\nearlier versions of Dridex, the most stable and resistant of them was the third, which was\nlaunched in April 2015 and was used in well-known cyberattacks up until the fourth\nversion, the latest known version and subject of this report, which was found in February\nof 2017.\n\nNo new major updates for Dridex had been found since the dismantlement of\nimportant components of the botnet, carried out by government agencies in 2015. [1]\n\nThis new variant of the banking Trojan incorporates new functionalities. One of these\nis called AtomBombing, a functionality whose aim is to inject code without calling\nsuspicious APIs to avoid being detected by monitoring systems. It incorporates the DLL\nhijacking technique to achieve persistence. Finally, various cryptographic methods were\noptimized and used to obtain the configuration. [2]\n\n#### 2. CHARACTERISTICS OF THE TROJAN\n\nThe following are some static properties of the analysed file.\n\nThe hash of the Trojan:\n\nMD5 001fcf14529ac92a458836f7cec03896\n\nSHA256 a6db7759c737cbf6335b6d77d43110044ec049e8d4cbf7fa9bd4087fa7e415c7\n\nThe internal date of creation of the analyzed sample is May 16, 2017. The file in\nquestion was compiled to be executed in 64 bit environments and, at the same time,\nsimulate the legitimate dll of Microsoft.\n\n**Figure 1. File properties**\n\nAdditionally, it is encrypted with a distinctive algorithm to avoid detection by\nantiviruses.\n\nIt has been observed that the executable has a fairly high number of sections,\n11 in total, as we can see in Figure 2:\n\n3\n\n##### SIN CLASIFICAR\n\n|MD5|001fcf14529ac92a458836f7cec03896|\n|---|---|\n|SHA256|a6db7759c737cbf6335b6d77d43110044ec049e8d4cbf7fa9bd4087fa7e415c7|\n\n\n-----\n\n**Figure 2. Static information of the analyzed binary**\n\nIn the DATA section, we can observe that the entropy is at 7.799, and is a fairly\nlarge in size. It is in this section that the highly encrypted and packaged binary (which,\nonce decrypted, becomes the real malicious code) can be found.\n\nIn the first decrypted layer, the executable stores memory in the process, then\ncopies the code and, finally, summons it and runs it, as we see in Figure 3:\n\n**Figure 3. Jump to shellcode**\n\nThe first thing the code does is to obtain the addresses of the functions that it will\neventually be using. It does this with a dynamic search through the libraries\ndownloaded by the program.\n\nTo carry out this task, it runs through the PEB_LDR_DATA structure and the LDRMODULE structures to locate the base address of the loaded dlls. It proceeds to access\nthe offset of the export table in order to run through all of the functions exported by\nthe dll and find the address of the sought function in he computer’s memory.\n\n**Figure 4. Enumeration of loaded modules**\n\n4\n\n##### SIN CLASIFICAR\n\n\n-----\n\nThe shellcode, in turn, checks to see whether there is a hook in the\nundocumented LdrLoadDll function, accessing its address and checking whether the\nfirst byte is the same as E9, the equivalent of a jmp assembler.\n\n**Figure 5. Hook Verification**\n\nIf the previous verification was successful, it proceeds to demap the dll memory\nprocess with the name “snxhk.dll” which is an Avast and AVG library that creates hooks\nto monitor processes happening in the sandbox.\n\n**Figure 6. Library: snxhk.dll**\n\nFinally, the shellcode decrypts the executable found in the DATA section in the\ncomputer’s memory, copies it into the base image’s address, and then runs the new\nresulting executable.\n\n**Figure 7. Decrypted executable**\n\nIn summary, the full process of the sample being unpacked can be seen in Figure\n8, where it is detailed more schematically.\n\n**Figure 8. Complete unpacking process**\n\n5\n\n##### SIN CLASIFICAR\n\n\n-----\n\n#### 3. INFECTION PROCESS\n\n 3.1. Infection Vectors\n\nThe infection of the device is not clearly understood. It may come by way of an\nexploit kit or spam campaign.\n\n#### 3.2. Interactions with the Affected System\n\nOnce it is run, the Trojan will proceed to verify if it is the only instance of malware\nrunning on the device, as well as to verify if it has already been injected in the\nexplorer.exe process.\n\nAll of this is carried out by creating and opening a mutex. In order to achieve\nthis, it first strings together the device name and the username, then calculates its MD5\nhash.\n\n**Figure 9. Hash calculation**\n\nNext, it adds brackets to the beginning and the end, and separates it with\nhyphens, similar to a COM object.\n\n**Figure 10. Mutex created in the system**\n\nUsing this algorithm, it may be possible to develop a vaccine that creates these\nmutexes in systems to avoid infection by Dridex.\n\nMalware that is not running creates a folder in %WINDOWS%\\system32\\[0-9]{4]\n\n6\n\n##### SIN CLASIFICAR\n\n\n-----\n\n**Figure 11. Created folder**\n\nThe malware copies a legitimate .exe into the folder along with an associated\n.dll or .cpl. This .dll or .cpl is not legitimate — it’s a Trojan. Upon running the .exe from\nthe folder, the malicious .dll or .cpl will load via a technique known as hijacking.\n\nIt also programs a task with a randomized name (“Domitxtdoi” in our example in\nFigure 12), which will run every 60 minutes.\n\n**Figure 12. Creation of task**\n\nIn this example, we see that the tcmsetup.exe runs so that the malicious .dll,\nTAPI32.dll, loads, thus beginning the infection process.\n\nAfter programming the task, it launches a series of commands: it creates a rule\nin the firewall for explorer.exe, which is where it will be injected:\n```\nnetsh advfirewall firewall add rule name=\"Core Networking - Multicast Listener Done\n(ICMPv4-In)\" program=\"C:\\Windows\\Explorer.EXE\" dir=in action=allow protocol=TCP\nlocalport=any\n\n```\n**Creation of the malicious task**\n```\nschtasks.exe /Create /F /TN \"Utdcm\" /SC minute /MO 60 /TR\n\"C:\\Windows\\system32\\3007\\tcmsetup.exe\" /RL highest \n\n```\nDuring this process, the malicious .dll will have been injected into the explorer.exe\nprocess using the AtomBombing technique. It will then wait for the user to open a\nbrowser like Internet Explorer, Firefox, Chrome, etc.\n\nThe moment the user opens a browser, a new shellcode will be injected from\nexplorer.exe to the browser using the same AtomBombing technique.\n\n#### 4. PERSISTENCE IN THE SYSTEM\n\nTo ensure its persistence in the system, it carries out the following actions.\n\nIt creates a folder with four random numbers on C:\\Windows\\System32, inside\nof which it copies a legitimate Windows executable (not always the same one) and a\n.dll that it knows will be loaded by the executable. This .dll will be modified with the\nharmful code.\n\n7\n\n##### SIN CLASIFICAR\n\n\n-----\n\n**Figure 13. Persistence in the system**\n\nThis technique is known as DLL hijacking. It takes advantage of the command that allows\nthe system to search libraries/files that it’s going to load/use. In the case of the image\nabove, the executable \"SystemPropertiesPerformance.exe\" will load \"SYSDM.CPL\" among\nother libraries. By default, the first place that it will search for the \"SYSDM.CPL\" file will be\nin the directory where the application is running, in this case C: \\ Windows \\ System32 \\\n1365. If it does not find it, it will look it up on other routes depending on how the search\norder of .dlls in the system is set.\n\nWhen it copies an executable and a modified .dll in the same directory, Dridex’s aim is\nto raise as little suspicion as possible, since its malicious actions are carried out by way of\na legitimate program.\n\nTo execute the file, it creates a scheduled task to run it in the random number folder (C:\n\\ Windows \\ System32 \\ 1365) every hour, as indicated in the previous section.\n\n**Figure 14. Creation of the programmed task**\n\nAs already mentioned, the folder is composed of four random numbers, and the\nexecutable it creates is not always the same, just like the .dll, so it is aware of which\nexecutable loads which library at all times, and is able to modify said library with harmful\ncode.\n\nGoing further in our analysis, we see that it acts in the following manner:\n\n1. It will list all executables in the folder \"C: \\ Windows \\ System32 \\\"\n\n2. It will hash the name of each executable and compare it with a value that\n\nhas been previously saved. If it matches, it will remain with that executable\n(in each execution that the hash is different).\n\n3. It will read the IAT of the selected executable and from there choose a .dll\n\nfor eventual hijacking.\n\n8\n\n##### SIN CLASIFICAR\n\n\n-----\n\n4. It will read the IAT of the .dll selected in point 3.\n\n5. It will make a copy of the malicious code (the .dll itself) and add a section at\n\nthe end with a random name to copy the IAT obtained in point 4.\n\n6. It will copy both the selected executable (3) and the modified malicious .dll\n\n(5) into a random folder.\n\nIn this way it obtains persistence in the system and every time that file is executed it will\nload the malicious .dll.\n\nThe malware will also create a copy of itself in executable format along with a registry\nkey in the AppData\\Roaming\\[random folder name] with the route in\n\"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\".\n\n**Figure 15. Registry key**\n\n#### 5. INJECTION VIA ATOMBOMBING\n\nDridex uses the AtomBombing technique to write a shellcode in other processes without\nraising suspicions.\n\nIt achieves this through APC calls and one of the most used Windows Executive Objects,\ncalled Atoms.\n\nBelow are the different phases of injection into another process.\n\n#### 5.1. Search for the target process \n\n9\n\n##### SIN CLASIFICAR\n\n\n-----\n\nThe target process in this case is explorer.exe, and to inject into it, it must first be accessed\nin order to perform an enumeration of the processes involved, making use of functions\nsuch as the following:\n\nOnce it finds the process explorer.exe, it calls the OpenProcess function to begin\nenumerating alertable threads.\n\n#### 5.2.  Search for alertable threads\n\nAt this point, the malware will try to find some thread in an alertable state, as this will allow\nit to make APC calls in order to execute code in the target process.\n\nTo find an alertable thread, it first obtains a handle for each thread in explorer.exe. It will\nthen launch a call to NtQueueApcThread as NtSetEvent and wait for any of the threads\nto respond.\n\nIf it works correctly, it will obtain the first thread that answers the call and start with the\ninjection.\n\n#### 5.3. Injection of shellcode in the target process\n\nFirst, the malicious .dll makes a call to GlobalAddAtomW and creates a new Atom with\nthe content it wishes to inject in the target process, in this case explorer.exe.\n\nSecond, the malicious .dll calls the NtQueueApcThread and sends as a parameter the\nfunction to be run by explorer.exe.\n\n10\n\n##### SIN CLASIFICAR\n\n\n-----\n\nThe first time this is done, it makes a call to memset to make sure that the zone where it\nwill write the shellcode is at 0.\n\n**Figure 19. Memory wipe**\n\nIt is important to indicate that the zone that Dridex has chosen for copying the shellcode\nis in ntdll as we can see in R8. This is because ntdll is always loaded on the same offset in\nall processes, regardless of the ASLR.\n\nIn the following iterations the function passed as parameter of NtQueueApcThread will\nbe GlobalAtomGetAtomNameW, which will cause the target process to get the Atom\nthat just created the malicious .dll and write it in the indicated zone, in such a way that\nit will write its contents inside the explorer.exe without raising suspicions.\n\nFirst it will create an IAT for the shellcode.\n\n**Figure 20. IAT creation in explorer.exe**\n\nAnd after several iterations it will copy the shellcode in explorer.exe completely.\n\n11\n\n##### SIN CLASIFICAR\n\n\n-----\n\n**Figure 21. Shellcode in explorer.exe**\n\n#### 5.4. Execution of the shellcode in the target process\n\nOnce the shellcode is copied to the explorer, it must be executed.\n\nTo do this, Dridex modifies the GlobalAtomGetAtomNameA function in the same way\nthat it has injected the shellcode, using Atoms.\n\nOriginal code of the function:\n\n**Figure 22. Original function**\n\n12\n\n##### SIN CLASIFICAR\n\n\n-----\n\nHere's how the function has been modified:\n\n**Figure 23. Modified function**\n\nAs you can see, when you call GlobalAtomGetAtomNameA in explorer.exe the\nprogram will execute the shellcode.\n\nAfter the modification, from the malicious .dll, a call will be made to\nGlobalAtomGetAtomNameA using NtQueueApcThread.\n\n**Figure 24. Remote execution of the shellcode**\n\nAt this point the shellcode will start executing.\n\nAfter this, GlobalAtomGetAtomNameA is returned to its original state, to avoid\nsuspicion.\n\n#### 6. NETWORK CONNECTIONS\n\nThe Trojan, once it has been injected into the explorer.exe process, opens port\n443 (usually used for the HTTPS protocol) and waits for some connection.\n\n13\n\n##### SIN CLASIFICAR\n\n\n-----\n\n**Figure 25. Port 443 opened**\n\n#### 7. IOCs\n\nTo check if a computer has been compromised by this version of Dridex, the\nfollowing points should be considered:\n\n   - The explorer.exe process has port 443 listening and there is a firewall rule in place\n\nallowing network traffic for that process.\n\n   - Directories that match the expression %SYSTEM%\\[0-9] {4}, and contain a\n\nlegitimate executable next to a .dll or .cpl file.\n\n   - Scheduled tasks that execute a file in path %SYSTEM%\\[0-9] {4} in periods of 60\n\nminutes.\n\n#### 8. REFERENCIAS\n\n**Inside the Dridex Malware Takedown**\n\n[1] Link: [http://www.bankinfosecurity.com/dridex-botnet-disruption-lessons-](http://www.bankinfosecurity.com/dridex-botnet-disruption-lessons-learned-a-8594)\n\n[learned-a-8594](http://www.bankinfosecurity.com/dridex-botnet-disruption-lessons-learned-a-8594)\n\n**Dridex v4 - AtomBombing and other surprises**\n\n[2] Link: https://www.virusbulletin.com/conference/vb2017/abstracts/dridex-v4\natombombing-and-other-surprises/\n\n**Dridex Banking Malware Sample Technical Analysis and Solution**\n\n[3] Link: [http://blog.nsfocus.net/dridex-banking-malware-sample-technical-](http://blog.nsfocus.net/dridex-banking-malware-sample-technical-analysis-solution/)\n\n[analysis-solution/](http://blog.nsfocus.net/dridex-banking-malware-sample-technical-analysis-solution/)\n\n14\n\n##### SIN CLASIFICAR\n\n|[1]|Inside the Dridex Malware Takedown Link: http://www.bankinfosecurity.com/dridex-botnet-disruption-lessons- learned-a-8594|\n|---|---|\n|[2]|Dridex v4 - AtomBombing and other surprises Link: https://www.virusbulletin.com/conference/vb2017/abstracts/dridex-v4- atombombing-and-other-surprises/|\n|[3]|Dridex Banking Malware Sample Technical Analysis and Solution Link: http://blog.nsfocus.net/dridex-banking-malware-sample-technical- analysis-solution/|\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.pandasecurity.com/mediacenter/src/uploads/2017/10/Informe_Dridex_Revisado_FINAL_EN-2.pdf"
    ],
    "report_names": [
        "Informe_Dridex_Revisado_FINAL_EN-2.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716498,
    "ts_updated_at": 1743041159,
    "ts_creation_date": 1508256017,
    "ts_modification_date": 1508256017,
    "files": {
        "pdf": "https://archive.orkl.eu/83a39ba787596d0eda418d8d6c725e08ca8f0b7a.pdf",
        "text": "https://archive.orkl.eu/83a39ba787596d0eda418d8d6c725e08ca8f0b7a.txt",
        "img": "https://archive.orkl.eu/83a39ba787596d0eda418d8d6c725e08ca8f0b7a.jpg"
    }
}