{
    "id": "08f432ad-d302-4c15-9873-32b9be917231",
    "created_at": "2023-01-12T15:03:42.716929Z",
    "updated_at": "2025-03-27T02:05:29.583488Z",
    "deleted_at": null,
    "sha1_hash": "15786de08f85b4e7074c116b3eda3031cbbd9d35",
    "title": "2017-07-10 - Upatre - Trojan Downloader",
    "authors": "",
    "file_creation_date": "2022-05-28T19:14:12Z",
    "file_modification_date": "2022-05-28T19:14:12Z",
    "file_size": 838509,
    "plain_text": "# Upatre - Trojan Downloader\n\n**secrary.com/ReversingMalware/Upatre/**\n\n[cd ../reverse_engineering_malware 6 minutes read](https://secrary.com/ReversingMalware)\n[You can get the sample from theZoo](https://github.com/ytisf/theZoo/tree/master/malwares/Binaries/Waski.Upatre)\n\nSHA-256: `1b893ca3b782679b1e5d1afecb75be7bcc145b5da21a30f6c18dbddc9c6de4e7`\n\n[We can use behavior analysis from hybrid-analysis.](https://www.hybrid-analysis.com/sample/1b893ca3b782679b1e5d1afecb75be7bcc145b5da21a30f6c18dbddc9c6de4e7?environmentId=100)\n\nSeems like there is no known protection mechanism.\n\nIn the strings, there is nothing important other than this base64 encoded string:\n\n\n-----\n\n…and imports is not eloquent but there is our friend `GetProcAddress :`\n\nLet’s open in `IDA :`\n```\nsub_403760 is used to get necessary Win API functions:\n\n```\n\n-----\n\nInside `sub_403760, malware decrytes strings and uses` `GetProcAddress to get`\naddresses of functions:\n\nTo decrypt strings before call `GetProcAddress,` `Upatre uses following decryption routine:`\n\n\n-----\n\nInside `sub_402F30 malware uses this teqnique to get addresses for following Win API`\nfunctions:\n```\nNtAllocateVirtualMemory, NtUnmapViewOfSection, CreateThread,\nWaitForSingleObject, LoadLibraryA, HeapAlloc, RtlAllocateHeap,\nRtlDecompressBuffer, FlushInstructionCache, NtGetContextThread .\n\n```\nThe decryption routine is used heavily by malware in different places to get plain text.\n\n\n-----\n\nAt `00403572,` `Upatre decodes base64 encoded string and saves at` `004051B0 (I`\nrenamed variable as `decrypted_bin ):`\n\nAt `0040386D it creates a new thread:`\n\n\n-----\n\nMain work starts inside the thread at `00403900, Where it decryptes and gets addresses for`\nseveral Win API functions: `CreateProcessW,` `ExitProcess,` `NtWriteVirtualMemory,`\n```\nNtSetContextThread, etc.\n\n```\nCreates itself as a new process in suspended mode and saves `Context :`\n\n## Anti-Debug:\n\n\n-----\n\nThere is one interesting anti-debug trick, at the start, it saves `PEB and uses` `BeingDebug`\nvalue `[PEB+2] in XOR decryption routine, outside of a debugger this value is` `0 and`\nadding `0 don’t cause any error, but if we try to add` `1 (which is the value of` `[PEB+2] if`\nthe executable is inside a debugger) it may cause error. In this case\n```\nRtlDecompressBuffer returns 0xC0000242 (STATUS_BAD_COMPRESSION_BUFFER)\n\n```\nerror.\n\nThe reason of this error is that before calling `RtlDecompressBuffer, malware`\ndecrypts(with XOR) decoded strings using `0x4C+[PEB+2] which is` `0x4D inside a`\ndebugger instead of `0x4C, because of this result is corrupted output.`\n```\n[eax+2] is the value of BeingDebug :\n\n```\n\n-----\n\nWe can use `ScyllaHide plugin for` `IDA to defeat this anti-debug method.`\n\nDecompresses decoded and decrypted base64 string using `RtlDecompressBuffer (format`\n```\nCOMPRESSION_FORMAT_LZNT1 ):\n\n```\n…and writes into suspened process:\n\nAfter decompress it calls `NtSetContextThread, value of` `EIP is` `401265 :`\n\n\n-----\n\nResumes thread and exits:\n\nBefore `NtResumeProcess call attach` `x32dbg to child process and set` `EIP to` `401265 :`\n\nClose `IDA and start analyzing of the child process.`\n\nTries to read `uttE047.tmp file from` `%TEMP% directory without success:`\n\n\n-----\n\nCreates one and writes location of the executable:\n\nInside of `uttE047.tmp file:`\n\nCopies executale to `%TEMP% directory as` `utilview.exe :`\n\n\n-----\n\n…and creates as new process:\n\nThis process is exactly same as the first process, creates a new process and injects\ndecoded and decompressed code.\n\nLet’s reverse last part (injected code) a little bit higher level.\n\nNow we are here: sample.exe -> sample.exe -> utilview.exe -> utilview.exe\n\nThe injected code is also same as before it checks `uttE047.tmp file, but this time there is`\n```\nuttE047.tmp in %TEMP% directory and malware goes a different direction, reads the\n\n```\ncontent of `uttE047.tmp, which is the location of the executable and removes that`\nexecutable:\n\n\n-----\n\nAfter this it gets IP of the victim using `checkip.dyndns.com :`\n\nAlso, there is a typo in user-agent string:\n\nand parses IP from returned file:\n\n\n-----\n\nIt tries to download `questd.pdf from` `http://penangstreetfood.net/wp-`\n```\ncontent/uploads/questd.pdf and http://yumproject.com/wpcontent/uploads/2014/11/questd.pdf without success.\n\n```\nSends `GET requests to` `95.181.46.38 with client related information, last string derives`\nfrom victim’s IP address, `B is instead of` `.`\n\nThat’s all… `Upatre ’s main function is to download malicious files.`\n\n## Note\n\nIf you prefer you can use my script to extract payload instead of doing it manually:\n\nI know, I overlook many things related to `Upatre, due to my limited knowledge, if you find`\nsomething interesting please contact me.\n\nI’m new to reversing malware and any kind of feedback is helpful for me.\n\nTwitter: [@_qaz_qaz](https://twitter.com/_qaz_qaz)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-07-10 - Upatre - Trojan Downloader.pdf"
    ],
    "report_names": [
        "2017-07-10 - Upatre - Trojan Downloader.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535822,
    "ts_updated_at": 1743041129,
    "ts_creation_date": 1653765252,
    "ts_modification_date": 1653765252,
    "files": {
        "pdf": "https://archive.orkl.eu/15786de08f85b4e7074c116b3eda3031cbbd9d35.pdf",
        "text": "https://archive.orkl.eu/15786de08f85b4e7074c116b3eda3031cbbd9d35.txt",
        "img": "https://archive.orkl.eu/15786de08f85b4e7074c116b3eda3031cbbd9d35.jpg"
    }
}