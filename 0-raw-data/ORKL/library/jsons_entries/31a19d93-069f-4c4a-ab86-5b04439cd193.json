{
    "id": "31a19d93-069f-4c4a-ab86-5b04439cd193",
    "created_at": "2023-01-12T15:03:39.355784Z",
    "updated_at": "2025-03-27T02:05:35.644427Z",
    "deleted_at": null,
    "sha1_hash": "5949d2e84b12eeca5318b0ccf428e381dc1478ea",
    "title": "2019-12-18 - Understanding Ransomware Series- Detecting Sodin",
    "authors": "",
    "file_creation_date": "2022-05-27T22:59:52Z",
    "file_modification_date": "2022-05-27T22:59:52Z",
    "file_size": 3458218,
    "plain_text": "# Detecting Sodin\n\n**hatching.io/blog/ransomware-part2**\n\n\n-----\n\n2019-12-18\n\n\n-----\n\ntriage\n\nransomware\n\nWritten by\nPete Cowman\n\nSodin - also known as Sodinokibi or REvil - is a successful ransomware family which often\nemploys advanced evasion techniques to avoid notice until the right time. It is developed and\noperated as ransomware-as-a-service (RaaS), meaning that threat actors can pay to make\nuse of the software to run their campaigns.\n\nActive from early 2019, Sodin has rapidly become a dominant force in ransomware activity,\nquickly filling the gap left by the end of Gandcrab being available as a service. There are\nmany good writeups of the Sodin family available online, and in this blog post, we are not\ndoing a full analysis of the sample. Instead, we will breakdown the main ways in which Sodin\nis detectable and identifiable within a dynamic sandbox environment, aiming to give\n[examples of some of the techniques covered in part 1 of this miniseries.](https://hatching.io/blog/ransomware-part1/)\n\n### Analyzed Samples\n\n**SHA256** **tria.ge Analysis**\n\n\ne5d23a3bb61b99e227bb8cbfc0e7f1e40fe\na34aac4dcb80acc925cfd7e3d18ec\n\n06b323e0b626dc4f051596a39f52c46b35f\n88ea6f85a56de0fd76ec73c7f3851\n\n0fa207940ea53e2b54a2b769d8ab033a6b2\nc5e08c78bf4d7dade79849960b54d\n\n139a7d6656feebe539b2cb94b0729602f62\n18f54fb5b7531b58cfe040f180548\n\n## Ransomware Information\n\n\nhttps://tria.ge/reports/191216pg5st7zccj/\n\nhttps://tria.ge/reports/1912164zdx1n374x/\n\nhttps://tria.ge/reports/1912168bfljdyw2s/\n\nhttps://tria.ge/reports/1912164rcmytrrka/\n\n\nRansomware is unusual among malware as it has no interest in hiding its infection from the\nuser once it has carried out its task. Sodin is no exception to this, dropping ransom notes to\nthe directories in which it has encrypted files and changing the wallpaper to point the victim\ntowards these files.\n\n**Ransom Note**\n\n\n-----\n\n[We took a look at ransom notes in the last blog post in this series so we won t go over the](https://hatching.io/blog/ransomware-part1/)\ndetails again here, but in summary, they contain instructions for the victim on how to pay the\nransom and decrypt their files.\n\n**Example ransom note created by Sodin infection**\n\nIn the case of the Sodin family, this note contains several URLs which the victim is meant to\nvisit to receive the instructions and see how much is being demanded in ransom. No bitcoin\naddress or information regarding the ransom is available directly in this file, which is\nunfortunate (extracting these can be useful for tracking campaigns/threat actors), but these\nURLs are still worth extracting for further investigation.\n\nThe name of the ransom note is defined by the `nname field within the configuration`\ndiscussed later in this blog post and will include the file extension given to all encrypted files.\nFor example, where `{\"EXT\"} is replaced by the extension` `{\"EXT\"}.info.txt .`\n\n**Analyzing Ransom Notes via tria.ge**\n\nThe tria.ge sandbox includes detections for many aspects of ransomware but there will\nalways be data we don’t include in the final report for one reason or another. However, our\nkernel driver maintains a record of almost all activity on the VM which can be accessed\ndirectly via the Triage API, enabling users to run custom parsers/extractors over the data. In\nthis section, we will do a quick example on fetching and processing this information to extract\nbasic information from a Sodin ransom note - although many other uses are also possible.\n\n[Documentation for the API can be found at https://tria.ge/docs/.](https://tria.ge/docs/)\n\n\n-----\n\nOnemon, the kernel driver used in Triage, records a log of system events for each task within\nan analysis (a ‘task’ is a specific VM instance run during analysis - for example a sample run\non Windows 7 and Windows 10 will have 2 tasks, 1 for each VM). This data can be\ndownloaded in JSON format via the following command\n\ncurl -H ‘Authorization: Bearer <YOUR_API_KEY>’\n[‘https://api.tria.ge/v0/samples/{sampleID}/{taskID}/logs/onemon.json'](https://api.tria.ge/v0/samples/%7BsampleID%7D/%7BtaskID%7D/logs/onemon.json')\n\nNote that you must pass your API key to access Triage endpoints. This can be found on your\n\n[account page][acount].\n\nThe `taskID field should simply be replaced by a string like` `task1 referencing the exact`\nanalysis you would like to access - for reference, the taskID value can be seen in the final\npart of the URL when viewing a report online.\n\nAs an example, requesting the `onemon.json file for the first sample linked in this blogpost`\nlooks as follows:\n```\ncurl -H 'Authorization: Bearer <YOUR_API_KEY>' \\\n 'https://api.tria.ge/v0/samples/191216-pg5st7zccj/task1/logs/onemon.json'\n\n```\nThe file received from the API contains 1 JSON object per line, each representing an event\nwithin the system. The results below have been prettified for readability.\n\n\n-----\n\n```\n{\n  \"kind\": \"onemon.File\",\n  \"event\": {\n    \"dstpath\": \"\",\n    \"flags\": \"NoFileFlags\",\n    \"id\": 844424930209781,\n    \"kind\": \"CreateModify\",\n    \"pid\": 1444,\n    \"srcpath\": \"C:\\\\Users\\\\Admin\\\\AppData\\\\Local\\\\Temp\\\\st748h0795z.bmp\",\n    \"status\": 0,\n    \"ts\": 36769\n  }\n}\n{\n  \"kind\": \"onemon.Registry\",\n  \"event\": {\n    \"kind\": \"SetValueKeyStr\",\n    \"path\": \"\\\\REGISTRY\\\\USER\\\\S-1-5-21-1774239815-1814403401-22009749911000\\\\Control Panel\\\\Desktop\\\\Wallpaper\",\n    \"pid\": 1444,\n    \"status\": 0,\n    \"ts\": 36769,\n    \"valued\": null,\n    \"valuei\": 0,\n    \"values\": \"C:\\\\Users\\\\Admin\\\\AppData\\\\Local\\\\Temp\\\\st748h0795z.bmp\"\n  }\n}\n{\n  \"kind\": \"onemon.NetworkFlow\",\n  \"event\": {\n    \"dstip\": 134744072,\n    \"dstport\": 53,\n    \"pid\": 284,\n    \"proto\": 17,\n    \"srcip\": 285214474,\n    \"srcport\": 60531,\n    \"ts\": 36894\n  }\n}\n\n```\n_Example events in onemon.json_\n\nEach line includes a ‘kind’ tag which defines the structure contained within the following\n‘event’ tag. There are many different ‘kind’ definitions, but likely the main ones which will be\nof interest are `onemon.Registry,` `onemon.Process, and` `onemon.File . We can`\ncombine the ‘kind’ tag and the ‘status’ tag within the event structure to form filters using grep,\ne.g., to show only events where a write operation took place in the registry, we could use\n```\ngrep onemon.Registry | grep SetValueKeyStr .\n\n```\nIn this example, we are interested in the ransom notes dropped by Sodin during analysis. By\ndefault, Triage dumps the contents of all .txt files created by a sample so that automated\nprocessing can be carried out on the files, e.g., to extract URLs. These dumps are (currently)\n\n\n-----\n\nstored as FileContents blocks within the onemon log:\n```\n{\n  \"kind\": \"onemon.FileContents\",\n  \"event\": {\n    \"buf\":\n\"SABlAGwAbABvACAAZABlAGEAcgAgAGYAcgBpAGUAbgBkACEADQAKAA0ACgBZAG8AdQByACAAZgBpAGwAZQBzA\n    \"id\": 844424930209780,\n    \"pid\": 1444,\n    \"ts\": 33462\n  }\n}\n\n```\n_Sodin ransom note in onemon.json_\n\nThe `onemon.FileContents blocks are linked to standard` `onemon.File events where the`\nsample performed a CreateFile operation for a .txt file. These blocks contain metadata useful\nfor relating the file dumps to their original file names and paths, the ID value shown above\nacts as the reference. Note the `\"flags\": \"DumpContents\" field in this event type`\n```\n{\n  \"kind\": \"onemon.File\",\n  \"event\": {\n    \"dstpath\": \"\",\n    \"flags\": \"DumpContents\",\n    \"id\": 844424930209780,\n    \"kind\": \"CreateModify\",\n    \"pid\": 1444,\n    \"srcpath\": \"C:\\\\Users\\\\Public\\\\Videos\\\\Sample Videos\\\\43s40i71l.info.txt\",\n    \"status\": 0,\n    \"ts\": 33462\n  }\n}\n\n```\nIf we are looking for a specific file, we can grep through the json for the file name and then\npick out the specific FileContents block that we were looking for based on the ID value.\n\nThe `\"buf\" section of the FileContents block shown above is a base64-encoded`\nrepresentation of the data written to the file, extracted by intercepting the API call for the file\nwrite and dumping the buffer contents. In order to retrieve the original contents, simply\ndecode the value.\n\nAt this point the entire contents of the file are available in plaintext for any further processing\ndesired - extracting contact URLs/email addresses, bitcoin wallets, personal identifier codes\netc.\n\nWe have produced a simple Python script which, when passed a Triage analysis ID and your\nAPI key, will perform the process outlined above and dump every .txt file found in the\nonemon.json to the current directory. It will generate a number of `.txt files. You can find`\n\n\n-----\n\nthe script [here. To use it, you ll need the Triage ID, the task ID of the analysis you want to](https://hatching.io/static/other/triage-ransomnote.py)\nexamine, and your API key for tria.ge. Usage may look as follows:\n```\npython3 triage-ransomnote.py <API-Key> 191216-4rcmytrrka task1\n\n### Ransom Portal Overview\n\n```\nThe URLs contained within the ransom note lead to a web portal customized to the victim\nbased on a generated ID value, which is the final part of the address (see ransom note\nabove). To make it harder for analysts to use automated tools to gather information, victims\nmust enter some basic information when accessing their portal - a generated ‘key’ visible in\nthe ransom note and the extension used when encrypting files (this can differ based on the\nconfiguration settings).\n\n**Ransom portal landing page**\n\nAfter submitting this information, the victim can then access payment details and other\ninformation, including guides on using Bitcoin; a trial decryptor that can be used on a single\nfile; and even a chat support feature to get assistance from the malware operators.\n\n\n-----\n\n**Main elements of Sodin ransom portal**\n\n\n-----\n\n**Main elements of Sodin ransom portal**\n\nThe most useful information on this page is the ransom price and the Bitcoin address which\nis to be used for payment - using a framework like Selenium it would be possible to automate\nthe gathering of these addresses for tracking.\n\n### Desktop Wallpaper Change\n\nTo make sure the victim is aware of the infection, Sodin also generates a new desktop\nbackground image and makes it active via the registry.\n\n[The image is a bitmap created through the DrawTextW function in User32.dll. The text to be](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-drawtextw)\nwritten is defined within the malware’s JSON config section (discussed later in this post).\n\n**Sample passes string into DrawTextW to create background image**\n\n\n-----\n\nThe image is saved to the user s Local AppData directory with a random file name, and the\nregistry key `HKCU\\\\Control Panel\\\\Desktop\\\\Wallpaper is set to point to the new file.`\n\n### Preventing System Recovery\n\nLike many other ransomware families, Sodin attempts to make recovery of the infected\nmachine more difficult by disabling or removing some Windows features. It achieves this\nusing common `vssadmin and` `bcdedit commands.`\n\nBrief descriptions of these commands are provided below for reference. In a dynamic\nanalysis environment, these are reasonably clear indicators of maliciousness, as there are\nfew legitimate reasons for an application to delete backups or interfere with boot settings.\n\n**Command** **Description**\n\n\nvssadmin Delete Shadows /All\n/Quiet\n\nbcdedit /set {default}\nrecoveryenabled No\n\nbcdedit /set {default}\nbootstatuspolicy\nignoreallfailures\n\n### Configuration\n\n\nDelete system shadow copies\n\nDisables Windows Error Recovery on startup\n\nSets system to ignore errors and boot as normal (NB:\nthis is also the default Windows setting)\n\n\nTo enable threat actors to customize their Sodin campaign, the family includes a\nconfiguration file embedded within the executable. This is packaged as a PE section with a\ndistinct name - the 2 variants we have examined for this blogpost used `.grrr and`\n```\n.zeacl .\n\n```\n\n-----\n\n_PE sections from unpacked Sodin samples_\n\nThese sections are a JSON configuration file encrypted using RC4 which contain a large\namount of information about the particular campaign the sample belongs to\n\n\n-----\n\n```\n{\n  \"pk\": \"GadtWz2QBTacskL+55Wpo65IkwY28qJOxHoe4Xte81M=\",\n  \"pid\": \"10\",\n  \"sub\": \"7\",\n  \"dbg\": false,\n  \"fast\": true,\n  \"wipe\": true,\n  \"wht\": {\n    \"fld\": [\"appdata\", \"google\", \"msocache\", \"mozilla\", \"program files\",\n\"windows\", \"perflogs\", \"application data\", \"windows.old\", \"system volume\ninformation\", \"program files (x86)\", \"$windows.~ws\", \"intel\", \"$recycle.bin\",\n\"$windows.~bt\", \"programdata\", \"boot\", \"tor browser\"],\n    \"fls\": [\"ntuser.dat.log\", \"bootsect.bak\", \"ntuser.dat\", \"iconcache.db\",\n\"ntldr\", \"autorun.inf\", \"boot.ini\", \"bootfont.bin\", \"desktop.ini\", \"thumbs.db\",\n\"ntuser.ini\"],\n    \"ext\": [\"ldf\", \"msi\", \"nomedia\", \"msu\", \"wpx\", \"ani\", \"shs\", \"theme\", \"386\",\n\"adv\", \"icns\", \"lnk\", \"ico\", \"ics\", \"rom\", \"sys\", \"mod\", \"cur\", \"com\", \"scr\", \"cpl\",\n\"diagcfg\", \"lock\", \"diagcab\", \"msstyles\", \"idx\", \"msc\", \"icl\", \"rtp\", \"exe\", \"drv\",\n\"hta\", \"nls\", \"deskthemepack\", \"cmd\", \"hlp\", \"themepack\", \"dll\", \"mpa\", \"msp\", \"ps1\",\n\"prf\", \"ocx\", \"bat\", \"diagpkg\", \"cab\", \"bin\", \"spl\", \"key\"]\n  },\n  \"wfld\": [\"backup\"],\n  \"prc\": [\"mysql.exe\"],\n  \"dmn\": \"lyricalduniya.com;theboardroomafrica.com;chrisanne.com;ownidentity.com;web865.com;[...]\",\n  \"net\":true,\n  \"nbody\n\":\"SABlAGwAbABvACAAZABlAGEAcgAgAGYAcgBpAGUAbgBkACEADQAKAA0ACgBZAG8AdQByACAAZgBpAGwAZQB\n  \"nname\": {\"EXT\"}.info.txt,\n  \"exp\":false,\n\"img\":\"WQBvAHUAcgAgAGYAaQBsAGUAcwAgAGEAcgBlACAAZQBuAGMAcgB5AHAAdABlAGQAIQAgAE8AcABlAG4\n}\n\n```\nThere are quite a few useful fields in here - these are outlined in the table below.\n\n**Field**\n**Name** **Description**\n\npk Base64-encoded public key used for file encryption\n\npid Only used if `net field is also set, sent to C2 servers. Likely related to campaign`\nidentifier etc.\n\nsub See `pid`\n\ndbg Enable/disable debug mode (for the malware author)\n\nfast Boolean value which changes how large files are encrypted\n\n\n-----\n\n**Field**\n**Name** **Description**\n\nwipe Boolean. If set, sample will try to erase contents of folders blacklisted in the\n```\n      wfld field\n\n```\nwht Defines whitelists for encryption process. Contains 3 sections:\n\n1. `fld : folders to ignore`\n\n2. `fls : specific files to ignore`\n\n3. `ext : whitelisted file extensions`\n\nwfld List of folder names. If the `wipe field is set to true then the malware will`\nattempt to erase the contents of all folders\n\nprc List of process names the malware will try to terminate before carrying out file\nencryption\n\ndmn List of domain names which the malware will attempt to contact to use as C2\n\nnet Boolean value. Sets whether sample should send host information to C2 servers\nlisted in `dmn key`\n\nnbody Base64-encoded version of the ransom note dropped to the file system after\nencryption\n\nnname Filename of the ransom note\n\nexp Boolean value. Defines whether or not the malware will use an exploit to try and\nescalate privileges on the system\n\nimg Base64-encoded version of the text shown in the wallpaper background set by\nthe malware.\n\n_Configuration field details_\n\nWhen delivered to a new system Sodin samples are packed using a custom algorithm, hiding\nthe existence of the specially named resource sections. The malware uses a PE overwrite\napproach to its unpacking mechanism - it allocates heap space using LocalAlloc, writes the\nunpacker stub to it, and then passes execution to that area after marking it RWX with\nVirtualProtect.\n\n\n-----\n\n_Create and call unpacker stub_\n\nThe unpacker stub then writes the new PE to the address space in which the original file was\nmapped, clearing the content of the entire region before writing the new executable and\njumping back to the updated Entry Point. We can now dump the executable and examine the\nsections, as shown previously.\n\nThe configuration itself is still encrypted at this stage, but in its unpacked form it is possible to\nanalyze the decryption process and recreate it. The algorithm is RC4 - we can clearly see\nthe SBox creation and swapping operations\n\nbut some minor changes have been made to prevent easy decryption with standard\nRC4 tools.\n\nExamining the executable we can see that the key for the decryption is the first 32 bytes of\nthe resource section.\n\n\n-----\n\n**Preparing keylength and ciphertext parameters and passing them to the configuration**\n**decryption function**\n\nWith this information and analysis of the decryption function, it was possible to build a\nconfiguration extractor to parse and report details from these configurations during dynamic\nanalysis of the samples. In Hatching Triage, we have implemented a system that enables\ntaking process memory dumps when particular conditions are met during an analysis. Using\nthis, we can obtain the unpacked executable and run processing on it to include the\ninformation in the analysis report and enable easy identification of particular campaigns or\nactors.\n\nThe Sodin extractor is not available on Triage yet while testing and improvements to the\n[memory dumping methodology are implemented, but keep an eye on our Twitter account for](https://twitter.com/hatching_io)\nupdates when that is released.\n\n### File Encryption\n\nSodin can encrypt files on local storage or any mapped network shares, overwriting the\noriginal files and renaming them with an extension generated on a per-infection basis. This\nprocess is highly customizable through the embedded configuration section, allowing for\ncertain files/folders to be whitelisted and protected from the encryption process. The Sodin\nexecutable also accepts a command-line parameter - by passing the value `-nolan, one`\ncan disable the encryption of mapped network shares and limit the effects to only the\ninfected machine.\n\n\n-----\n\n```\n wht : {\n  \"fld\": [\"appdata\", \"google\", \"msocache\", \"mozilla\", \"program files\", \"windows\",\n\"perflogs\", \"application data\", \"windows.old\", \"system volume information\", \"program\nfiles (x86)\", \"$windows.~ws\", \"intel\", \"$recycle.bin\", \"$windows.~bt\", \"programdata\",\n\"boot\", \"tor browser\"],\n  \"fls\": [\"ntuser.dat.log\", \"bootsect.bak\", \"ntuser.dat\", \"iconcache.db\", \"ntldr\",\n\"autorun.inf\", \"boot.ini\", \"bootfont.bin\", \"desktop.ini\", \"thumbs.db\", \"ntuser.ini\"],\n  \"ext\": [\"ldf\", \"msi\", \"nomedia\", \"msu\", \"wpx\", \"ani\", \"shs\", \"theme\", \"386\",\n\"adv\", \"icns\", \"lnk\", \"ico\", \"ics\", \"rom\", \"sys\", \"mod\", \"cur\", \"com\", \"scr\", \"cpl\",\n\"diagcfg\", \"lock\", \"diagcab\", \"msstyles\", \"idx\", \"msc\", \"icl\", \"rtp\", \"exe\", \"drv\",\n\"hta\", \"nls\", \"deskthemepack\", \"cmd\", \"hlp\", \"themepack\", \"dll\", \"mpa\", \"msp\", \"ps1\",\n\"prf\", \"ocx\", \"bat\", \"diagpkg\", \"cab\", \"bin\", \"spl\", \"key\"]\n}\n\n```\n_Whitelist configuration section_\n\nThe keys specify whitelists for:\n```\n   fld - folder names\n   fls - specific file names\n   ext - file extensions\n\n```\nThe malware iterates through every directory and file on the system, checking them against\nthese configuration values and queuing them up for encryption if they are not excluded.\nOnce encrypted, the files are renamed with a new extension.\n\n## Encrypted File Extension\n\nBefore starting the encryption process, Sodin generates the random file extension which is\napplied to every encrypted file. The extension is a string of letters and numbers from 5 to 10\ncharacters long, which is generated and saved to the registry along with other information\ngathered at various stages (discussed below).\n\n\n-----\n\n**File extension saved to SOFTWARE\\\\WOW6432Node\\\\recfg\\\\rnd_ext**\n\nThe extension itself is tricky to accurately identify as Sodin-related due to the generic nature\nof it, but the registry path is relatively specific and is readily detectable in a sandbox.\n\n## Other Registry Changes\n\nAs well as the file extension, Sodin saves a few other bits of data to the\n```\nSoftware\\\\Wow6432Node\\\\recfg registry key .\n\n```\n**Values within the recfg registry key**\n\nNone of the values assigned to these keys are static, but all of the key names are common\nacross Sodin samples. We won’t go into the details of these here, but the image above gives\na basic outline of the contents.\n\nIn a dynamic environment, this sort of registry structure is ideal for identifying a family.\n\n\n-----\n\n**Tria.ge signature output for registry keys**\n\n## Conclusion\n\nSodin is a complex family with far more functionality than we have covered here, but this has\noutlined the main indicators which are useful for identifying samples within a dynamic\nenvironment like Triage. References to a number of samples used as source material for this\npost can be found in the header at the top of the page.\n\nWe’ll be continuing to expand coverage over the coming weeks for ransomware families with\nransom note and configuration extractors. In the next post in this mini-series we’ll cover\nanother family which poses some different challenges to analysis and present ways to solve\nthem.\n\nUntil next time, Happy Holidays!\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-12-18 - Understanding Ransomware Series- Detecting Sodin.pdf"
    ],
    "report_names": [
        "2019-12-18 - Understanding Ransomware Series- Detecting Sodin.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535819,
    "ts_updated_at": 1743041135,
    "ts_creation_date": 1653692392,
    "ts_modification_date": 1653692392,
    "files": {
        "pdf": "https://archive.orkl.eu/5949d2e84b12eeca5318b0ccf428e381dc1478ea.pdf",
        "text": "https://archive.orkl.eu/5949d2e84b12eeca5318b0ccf428e381dc1478ea.txt",
        "img": "https://archive.orkl.eu/5949d2e84b12eeca5318b0ccf428e381dc1478ea.jpg"
    }
}