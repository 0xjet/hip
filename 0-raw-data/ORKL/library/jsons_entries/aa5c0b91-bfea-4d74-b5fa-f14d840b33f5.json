{
    "id": "aa5c0b91-bfea-4d74-b5fa-f14d840b33f5",
    "created_at": "2023-02-02T02:08:42.961399Z",
    "updated_at": "2025-03-27T02:05:55.38312Z",
    "deleted_at": null,
    "sha1_hash": "2ca0620bb557a96fe4ec5a77f9cda8e9b7f74425",
    "title": "2022-12-28 - HTML Smuggling Detection",
    "authors": "",
    "file_creation_date": "2023-02-01T07:39:16Z",
    "file_modification_date": "2023-02-01T07:39:16Z",
    "file_size": 441260,
    "plain_text": "# HTML Smuggling Detection\n\n**[micahbabinski.medium.com/html-smuggling-detection-5adefebb6841](https://micahbabinski.medium.com/html-smuggling-detection-5adefebb6841)**\n\nMicah Babinski December 28, 2022\n\n[Micah Babinski](https://micahbabinski.medium.com/?source=post_page-----5adefebb6841--------------------------------)\n\nDec 28, 2022\n\n\n15 min read\n\nThe most famous fictional smuggler that I could think of\n\n## Introduction\n\nIn this article I‚Äôll delve into HTML smuggling detection, following the detection engineering\nprocess I‚Äôve described over my last two posts. This process includes research, testing, and\ndevelopment of new detection concepts. Unlike my previous posts however, this time we‚Äôll be\nobserving, profiling, and detecting real QakBot malware in the lab. With this piece I hope to\nshow how current and aspiring detection engineers can go beyond simulated, CTF-style\nchallenges to study and detect real-world attacker techniques, flagging them for our SOC,\nand allowing our incident response colleagues to neutralize the threat.\n\n\n-----\n\n## Our Itinerary\n\nAfter some background and defining the objective, I‚Äôll demonstrate how we can execute\nQakBot HTML Smuggling malware in the lab, tracking it‚Äôs behavior in Splunk. Then, I‚Äôll\nsequence observable events of this attack, and identify useful detection points (which I think\nof as ‚Äúbuilding blocks,‚Äù or links of the attack chain). I‚Äôll also introduce correlation (specifically\nchain rules), a crucial tool in your threat detection toolbox. To illustrate what this looks like, I‚Äôll\ndiscuss and demonstrate an as-yet-unreleased capability of Sigma, called Sigma\nCorrelations. I‚Äôll wrap up by testing a new chain rule against 10 additional samples of QakBot\nHTML Smuggling malware to see how it performs.\n\nLet‚Äôs get started! üèÅüèÅüèÅ\n\n## Background\n\nEarly on in my cybersecurity journey, John Strand of Black Hills Information Security said\nsomething that stuck with me: ‚ÄúThere is no ‚ÄòYOU HAVE BEEN HACKED‚Äô log.‚Äù Event logs can\nbe confusing and hard to read even on a good day. Deriving useful, actionable insights from\nlogs is tricky! The challenge sometimes requires deep analysis and specialized techniques to\nbe successful.\n\nI‚Äôve had that lesson in the back of my mind throughout my career in security, and it was with\nthis in mind that a few months ago, I started seeing tons of posts like this one from\n[@pr0xylife:](https://twitter.com/pr0xylife)\n\nI like the way that pr0xylife and their peers summarize these attacks so succinctly, and I\nfound myself repeating the sequence of file types out loud ‚Äî almost like a weird form of\npoetry!\n\nI wanted to learn more, but didn‚Äôt know how to get started. I had reviewed some excellent\nresearch on QakBot by the team at Trellix, so I knew a bit about their techniques. (If you\nhave never heard of QakBot, please read the Trellix report!) As I started following QakBot\nactivity and digging deeper, I realized that pr0xylife and others were describing the subtle\ncombinations and variations in the way QakBot could trick its victims and evade our\ndefenses. Some examples:\n\nIt uses, where a malicious HTML file containing encoded JavaScript is executed by the\nvictim‚Äôs browser, downloading the next stage of the payload.\nIt uses to block sandboxing analysis.\nIt uses a disk image format called an .iso file to evade the Mark-of-the-Web protection,\nas Red Canary .\nLNK files disguised to lure users into executing to hidden .CMD and .DLL files.\nAnd on and on with ever more deceptive tricks!\n\n\n-----\n\nViewed independently of one another, few of these behaviors will trigger an alert, much less\nget escalated, in many SOCs. So it seemed like a good use case for correlation, where\nmultiple security event log entries are aggregated, sequenced, and timed in relation to each\nother to yield more sophisticated and high-fidelity alerts. If this sounds confusing, keep\nreading! By the end of this article, you should have a much better understanding of what\ncorrelation means and how you can put it to work for threat detection.\n\n## The Objective\n\nThere are some detections out there for HTML smuggling and other QakBot-connected\ntechniques. These are mostly based on matching suspicious log events, such as this one\nfrom Elastic security:\n\n## Suspicious HTML File Creation | Elastic Security Solution [8.5] | Elastic\n\n### Identifies the execution of a browser process to open an HTML file with high entropy and size. Adversaries may smuggle‚Ä¶\n\nwww.elastic.co\n\nI wanted to see if I could build my own detections, utilizing correlation (as opposed to simple\nmatching) to make them resilient to subtle shifts in attack behavior.\n\nTBH, I was also sick of QakBot‚Äôs dumb chicanery and wanted a reliable way to place it\nsquarely within our sights.\n\nMe, after seeing yet another QakBot variation\n\n## Initial Observation and Analysis of QakBot Malware\n\nTo accomplish my objective, I had to go beyond threat intelligence reports from security\nvendors and Atomic Red Team tests; I needed my own data created from real malware\nsamples. I turned to an old favorite: malware-traffic-analysis.net by Brad Duncan\n(@malware_traffic). This site is among the most useful educational resources I have come\nacross in security. In addition to Wireshark tutorials and hands-on network traffic exercises,\nthe site offers quality analysis of real-world malware samples, including QakBot HTML\nsmuggling files.\n\nAfter making snapshots of my lab VMs, I fired up my virtual detection lab and visited a recent\nentry. Be careful, the files hosted on this site are unsafe!\n\n\n-----\n\n## Malware-Traffic-Analysis.net - 2022-12-09 - HTML smuggling leads to Qakbot, distribution/botnet‚Ä¶\n\n### NOTES: The HTML file used for smuggling was posted to VirusTotal today, and create/modify dates for the disk image &‚Ä¶\n\nwww.malware-traffic-analysis.net\n\nI downloaded the artifacts zip file and extracted it to my downloads folder using the WinRAR\nutility built into my detection lab:\n\nThe IOC notes were extremely helpful in giving context to the included files. Among the\nnotes were the following, which let me know that the infection chain started with the HTML\nfile, called SCAN_DT6281.html.\n```\n2022-12-09 (FRIDAY) - HTML SMUGGLING FOR QAKBOT (QBOT) DISTRIBUTION TAG: AZD\n\nDISTRIBUTION:\n- Unknown source, possibly email --> HTML file --> password-protected zip archive -->\nextracted ISO image with .img file extension\n\n```\nI opened the HTML file in Chrome browser and noticed an immediate zip file\ndownload (bottom left below):\n\nSeems legit\n_‚Ä¶sure, let‚Äôs open up the zip file, why not?_\n\nThe zip file was password protected but could be opened using the password displayed on\nthe HTML page. The zip file contained a single .img file, which I know to be another\nmountable disk image file format. Double-clicking this mounted the file as the D drive on my\nsystem:\n\nThe shortcut LNK (SCAN_DT6281) and hidden folder (IncomingPay)\nI also noticed a hidden directory called IncomingPay, which contained a .lnk file, two text files\nwhich contained (I kid you not) excerpts from the Wikipedia page on Psychology, a .cmd file\nü§î, and a .lc file ü§∑.\n\nAs a security professional and dutiful watcher of corporate security awareness training, all of\nmy üö©üö©üö© were up and waving in the breeze. But this is for science, so I take the bait and\ndouble-click the LNK file, just as the attacker wants the victim to do. üé£ A command line\nwindow appears for a few seconds, then disappears:\n\nThe LNK file target property is interesting:\n\n\n-----\n\n```\nC:\\Windows\\System32\\cmd.exe /c IncomingPay\\Issues.cmd A B C D E F G H I J K L M N O P\nQ R S T U V W X Y Z 0 1 2 3 4 5 6 7 8 9\n\n```\nThis tells me that I‚Äôve run the Issues.cmd file located in the IncomingPay directory using\nCMD, which is important to know for later. Now back in Splunk, I start running queries to see\nwhat is happening on my victim VM:\n\nNotice the commands logged immediately after I took the bait!\nHow do I know what searches to run? I don‚Äôt really, but through my experience as an analyst\nand researcher I know that there are certain types of evidence that may appear in my logs ‚Äî\nprocess executions, file creations, network connections, and the like. This is where on-thejob experience as a security analyst, or a good dose of CTF-style trainings (like those\n[available at CyberDefenders or](https://cyberdefenders.org/) [LetsDefend) come in handy.](https://letsdefend.io/)\n\nAfter refreshing my searches a few times and wondering if I had done something wrong, I\nnoticed a definite, incontrovertible sign of an intrusion: a burst of recon activity on my victim\nhost:\n\nI forgot to include in the screenshot, but the parent process for all these commands was\nwermgr.exe (what???)\nAs I was looking at these commands, I noted the time period in which they occurred ‚Äî all\nwithin the span of a few seconds! Also, the processes were all spawned by an unusual\n[parent ‚Äî wermgr.exe (the Windows Error Reporting Manager). A good detection opportunity,](https://strontic.github.io/xcyclopedia/library/wermgr.exe-0F652BF7ADA772981E8AAB0D108FCC92.html)\nperhaps? Event the most confused admin or overbuilt piece of [legit] software will not run all\nthese suspicious recon commands within such a short timeframe, and never as children of a\nwermgr.exe. Swinging over to my network connections, I noticed that wermgr.exe had\nsuddenly become extremely chatty with external IP addresses:\n\nUhhhhh‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶\nFollowing this initial assessment of my data, I determined that:\n\nThe malware sample contained a malicious initial access vector (duh, the rogues\ngallery of the .html, .zip, .img, .lnk, .cmd, and .lc files).\nThe malware would download the zip file after opening the HTML page in a browser,\nand the zip file contained a mountable .img file.\nThe mounted drive contained a malicious shortcut that would result in the execution of\nadditional commands.\nAn injected wermgr.exe process spawned an automated burst of recon activity and\nthen connected to suspicious external IP addresses, presumably to send the attacker\ninformation about our system and network.\n\nIn Mitre ATT&CK terms, this all amounts to Initial Access, Defense Evasion, Discovery, and\nCommand and Control. In other words: big oof.\n\n\n-----\n\nRogues Gallery\n\n## Breaking Down the Attack into Detection Building Blocks\n\nHaving performed an initial execution of the QakBot HTML smuggling technique in the lab\nand reverted to my VM snapshots, it was time to dig further into the logs to see what was\nhappening.\n\nAs I reviewed the various types of events generated by the attack, I began to develop a\nplain-language narrative understanding of what was happening:\n\n‚ÄúAn attacker sends a victim an HTML file that purports to contain a report, invoice, or\nother document of interest to them. Basically, a phishing lure. When the victim opens\n**the file in their browser, embedded JavaScript code executes, which downloads or**\n**builds a password-protected zip file on the victim‚Äôs system. When the victim unzips**\n**the archive, the extraction creates a mountable disk image file. After mounting the**\n**drive, the user sees a shortcut that they believe will take them to the resource they are**\ntrying to find. But the shortcut actually calls a command or scripting interpreter that\n**executes other malicious files that are hidden on the disk drive, leading to initial**\naccess compromise.‚Äù\n\nThat‚Äôs a wordy chunk of prose right there, but it makes sense in my head. If I am going to\ndetect something, I need to understand it first! Note the bold text: I used my narrative to\nhighlight events that I could use to detect the attack chain. Based on this review, I analyzed\nthe logs from the attack, trying to isolate the following events:\n\n1. Phishing email sent to victim containing an HTML attachment.\n2. Creation of an HTML file in suspicious locations.\n3. Opening of a stand-alone HTML file in a browser application.\n4. Download/creation of a zip file by the browser application.\n5. Opening/extraction of a password-protected zip file.\n6. Creation of a mountable disk drive file format (.iso, .img, etc).\n7. Mounting a drive.\n8. Process execution on an external drive (either from an executable on that drive, or\n\nsystem executable touching files on that drive).\n\nWhew! That‚Äôs‚Ä¶a lot of events.\n\n## The Good News\n\nThe good news was, there are ways to detect nearly every event listed above! This means I\nhad numerous ideas for how to query and filter available logs to extract the meaningful\nevents (building blocks) for future detections.\n\n\n-----\n\n## The Bad News\n\nThe bad news was, none of these many events is, on its own, malicious. Again, there is no\nYOU HAVE BEEN HACKED log: each one of these events could occur in the course of\nnormal business and be completely safe and benign. The solution would be to correlate\nthese events, in an ordered or unordered sequence, grouping them by a common attribute\nlike hostname, and triggering an alert when all of these occur within a time window, like an\nhour. The problem is, from my analysis and testing (more on that in a moment), chaining or\n_correlating that many events would result in a brittle detection._\n\n## Brittle vs. Resilient\n\n‚ÄúBrittleness‚Äù describes the degree to which a detection idea falls apart in the face of subtle\nchanges to attacker techniques, variations in actions performed by the victim, problems with\nlogging, or other factors outside of our control. Brittle detections contrast with ‚Äúresilient‚Äù\ndetections, which are flexible and can withstand these subtle shifts.\n\nIt‚Äôs not as simple as saying ‚ÄúBrittle = bad and resilient = good.‚Äù A brittle detection could be\nhighly-targeted, with a narrow ‚Äúaperture.‚Äù The advantage could be that, if a brittle detection\nrule fires, there is a very high probability that it is a true positive. Resilient detections may\nhave a wider aperture and may match more potential malicious activity. However, this could\nlead to false positives and a frustrated SOC if they are not developed with care.\n\nWith this in mind, I returned to my list of events from above.\n\n## Determining the Building Blocks to Test\n\nIn context, I realized that items one through three in the list above may not be good\ncomponents of my HTML Smuggling detection. Lack of visibility and a high volume of\ninnocent behavior would hinder item 1. I struck item two because I had limited ability to test\nthis event, and item three proved unreliable depending on which browser I used. Plus, while\nnot technically HTML Smuggling, a lot of QakBot activity uses URLs, rather than stand-alone\nHTML files, to deliver the initial payload.\n\nItem five (extraction of a password-protected zip file) has lots of potential, and can be\n[detected using this rule written by Florian Roth and inspired by the research of](https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_security_susp_opened_encrypted_zip.yml)\n[@SBousseaden. However, I left it out of my scope because 1) that event was not logging in](https://twitter.com/SBousseaden)\nmy lab and 2) some documentation indicates that it is only applicable to certain operating\nsystems.\n\nAfter exploring my data, enumerating possible detection building blocks for my correlation,\nand winnowing that list down based on further analysis, I had the following building blocks:\n\n1.\n\n\n-----\n\n2.\n3.\n4.\n\nWith these building block concepts in place, I wrote or adapted a query and Sigma rule for\neach one, then correlated them into a chain rule.\n\n## Sigma Correlations\n\nCorrelation allows us to track log events through time. Rather than triggering an alert for\neach of the four events listed above, a chain rule correlation allows us to alert only when all\nfour events occur in order on the same host by the same user, which is much more\nsuspicious. Many SIEM products and their corresponding query languages support this type\nof chaining (although some do not).\n\nTo support this functionality, Sigma has a Correlations standard in progress that will allow us\nto write custom correlation rules in a common format then convert them to whatever SIEM\nproduct supports this logic. The draft standard can be reviewed here:\n\n## sigma-specification/Sigma_Correlations.md at main ¬∑ SigmaHQ/sigma-specification\n\n### Sigma correlations is a new YAML-based extension that allows the expression of aggregations and relationships between‚Ä¶\n\ngithub.com\n\nWhat might this look like? It‚Äôs a draft standard, and subject to change, but a simple\nexample of a brute force chain rule might look like this:\n```\naction: correlationtype: temporalrule:  - many_failed_logins  successful_logingroup-by:  - Usertimespan: 1hordered: true\n\n```\nWhen the rule query ‚Äúmany_failed_logins‚Äù is matched followed by the ‚Äúsuccessful_login‚Äù rule\nwithin a one hour window, the correlation rule will fire. For a good example of a SIEM product\n[that supports correlations, check out SumoLogic chain rules.](https://help.sumologic.com/docs/cse/rules/write-chain-rule/#:~:text=About%20Chain%20rules%E2%80%8B&text=In%20a%20Chain%20rule%20you,rule%20expressions%20in%20the%20rule.)\n\nMy draft correlations rule looks like this:\n\n\n-----\n\n```\ntitle: HTML Smuggling Activity Chain Ruleid: 0952f2fa e29b 4eb5 831c\nce21520c56e3status: experimentaldescription: Detects HTML smuggling-style compromise\n(such as HTML > ZIP > ISO/IMG/VHD > CMD/BAT/VBS > DLL). Includes rules to detect\nzipfile dropped by browser, ISO/IMG/VHD/LNK file extraction, disk image mount,\nfollowed by user-initiated process creation on an external drive.references:  https://blog.talosintelligence.com/html-smugglers-turn-to-svgimages/#:~:text=HTML%20smuggling%20is%20a%20technique,directly%20on%20the%20victim's%2\n  - https://www.malwarebytes.com/blog/news/2021/11/evasive-maneuvers-htmlsmuggling-explained  - Original research and analysis performed off of QakBot\nintelligence gathered at https://github.com/pr0xylife/Qakbot, https://www.malwaretraffic-analysis.net/, and https://github.com/executemalware/Malware-IOCsauthor:\nMicah Babinskidate: 2022/12/27tags:  - attack.s0650  - attack.s0483  attack.initial_access  - attack.defense_evasion  - attack.execution  attack.t1564  - attack.t1566.001  - attack.t1566  - attack.t1027  attack.t1027.006  - attack.t1059  - attack.t1204  - attack.t1204.002action:\ncorrelationtype: temporalrule:  - 1_win_zipfile_drop.yml  2_win_susp_file_extraction.yml  - 3_win_security_iso_mount.yml  4_win_process_creation_ext_drive.ymlgroup-by:  - ComputerName  - Usertimespan:\n1hordered: truefalsepositives:  - Unknownlevel: high\n\n```\nThis looks like many other Sigma rules you may have seen before, but has some unique\nelements. The action and type statements let you know this is a correlation rule of the\ntemporal type. The four rules listed show the component rules in scope (these must be in\nthe same directory as the correlation). The timespan specifies that the four participating\nrules must fire within one hour of each other, and the group-by statement defines fields in\nthe rules which relate them to each other. Finally, the ordered: true statement lets Sigma\nknow that these rules should occur in sequence.\n\nAgain, the Sigma Correlations specification is in development, and is subject to\nchange. Still, this will be a very useful expansion of Sigma‚Äôs capabilities, so I wanted to\npreview it for you now!\n\n## Testing the Correlation\n\nWith this detection concept taking shape, and a hypothesis developed in the form of my\ncorrelation rule, it was time to test the detection with a larger sample size. I relied on the\nMalwareBazaar repository from Abuse.ch, which provides a helpful library of tagged malware\nsamples. I downloaded 10 QakBot HTML samples, mostly reported by pr0xylife, ranging in\ndate first seen from July 11 to December 22, 2022. I prepared the samples on my lab VM,\nand named each one according to its first seen date and its ‚Äúhumanhash‚Äù property (a\nrandom, unique sequence of human-readable words, such as (‚Äúdakota-earth-mockingbirdmarch‚Äù):\n\nMy 10 lovely HTML smuggling samples all ready to test\nTo track my results, I made a simple table in Google Sheets:\n\n\n-----\n\nI made a clean, pre-test snapshot of my victim VM host to revert back to after each test, and\nstarted in on the test. After testing seven of the ten samples, my sequence of four building\nblocks had perfect coverage! When I hit the eighth sample, however, the fourth rule in the\nchain did not fire, because the .lnk file called RunDLL32.exe directly, instead of cmd.exe or\nwscript.exe. This was fine ‚Äî I simply made an adjustment to the conditions of my Sigma\nrule, retested, and got perfect matches! I was delighted with the results and excited to share\nthe detection use case with the community.\n\n## Bonus Round!\n\nMany QakBot phishing attacks do not use .html attachments, but instead use malicious .pdf\nfiles with embedded links, or just good old-fashioned phishing links that point to zip files\nhosted on a compromised website. To test whether my detection was flexible enough to\ncatch these instances as well, I tested them on a couple of recent examples from the IOC\nrepository maintained by @ExecuteMalware, and found that these URL-based driveby\nattacks were also caught by the detection. The one documented here even included a .wsf\n(Windows Script File) ‚Äî a file type with which I was unfamiliar but was nonetheless caught by\nmy detection.\n\nWindows Script File (.wsf) Delivered During a Recent QakBot Attack\nHooray for resilience!\n\n## Conclusion\n\nCongratulations! You‚Äôve reached the end of a lengthy post about some dense, complicated\n[topics. You can find all the rules referenced here. Thank you for reading, and I hope you‚Äôve](https://github.com/mbabinski/Sigma-Rules/tree/main/2022_HTMLSmuggling)\nenjoyed my ramblings on QakBot, HTML Smuggling, Sigma, and correlations. I am truly\nexcited for Sigma Correlations to launch. It will be a big win for the detection engineering\ncommunity and will allow us to share more sophisticated detection use cases.\n\nI was really pleased with how my tests went, particularly when it showed that one of the\nbuilding blocks in my chain rule had failed and needed adjustment! After all, why test if you\nthink your work is already perfect? Lastly, this experience drove home for me what I had\nalready started to believe ‚Äî that we can‚Äôt detect what we don‚Äôt understand. There‚Äôs no\nsubstitute for first-hand experience with real live malware if you are trying to see what it\ndoes.\n\nThanks to the Detection Lab project that I‚Äôve enthused about in previous posts, this real-life\nexperience is in reach for more people than ever. Lastly, thanks to pr0xylife, Brad\n(malware_traffic), and executemalware for providing pristine repositories of well-documented\nQakBot malware samples for us to access, analyze, and understand. These are truly an\neducational treasure trove!\n\n\n-----\n\nPlease feel free to send me ideas, comments, or suggestions on how I can improve. I am still\nnew to this, and I welcome respectful feedback and critique in any form.\n\nAs always, happy analyzing! üßê\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-12-28 - HTML Smuggling Detection.pdf"
    ],
    "report_names": [
        "2022-12-28 - HTML Smuggling Detection.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1675303722,
    "ts_updated_at": 1743041155,
    "ts_creation_date": 1675237156,
    "ts_modification_date": 1675237156,
    "files": {
        "pdf": "https://archive.orkl.eu/2ca0620bb557a96fe4ec5a77f9cda8e9b7f74425.pdf",
        "text": "https://archive.orkl.eu/2ca0620bb557a96fe4ec5a77f9cda8e9b7f74425.txt",
        "img": "https://archive.orkl.eu/2ca0620bb557a96fe4ec5a77f9cda8e9b7f74425.jpg"
    }
}