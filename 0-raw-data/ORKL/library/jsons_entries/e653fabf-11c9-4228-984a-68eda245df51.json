{
    "id": "e653fabf-11c9-4228-984a-68eda245df51",
    "created_at": "2024-07-26T02:06:13.057879Z",
    "updated_at": "2025-03-27T02:16:17.042833Z",
    "deleted_at": null,
    "sha1_hash": "713707179b0523ec30b93d788d83a51d1511672b",
    "title": "MoonWalk | ThreatLabz",
    "authors": "",
    "file_creation_date": "2024-07-25T13:32:18Z",
    "file_modification_date": "2024-07-25T13:32:18Z",
    "file_size": 4889713,
    "plain_text": "### Zscaler Blog\n\n**Get the latest Zscaler blog updates in your inbox**\n**Subscribe**\n\n[Security Research](https://www.zscaler.com/blogs?type=security-research)\n\n## MoonWalk: A deep dive into the updated arsenal of APT41 | Part 2\n\n**[YIN HONG CHANG,](https://www.zscaler.com/author/yinhongchang)**\n\n**[SUDEEP SINGH](https://www.zscaler.com/author/sudeepsingh)**\nJULY 11, 2024 - 18 MIN READ\n\n**[THREATLABZ RESEARCH](https://www.zscaler.com/blogs?topic=threatlabz-research)**\n\nCopy URL\n\n### Introduction\n\n\n[Security Research](https://www.zscaler.com/blogs?type=security-research)\n\n## MoonWalk: A deep dive into the updated arsenal of APT41 | Part 2\n\n**[YIN HONG CHANG,](https://www.zscaler.com/author/yinhongchang)**\n\n**[SUDEEP SINGH](https://www.zscaler.com/author/sudeepsingh)**\nJULY 11, 2024 - 18 MIN READ\n\n**[THREATLABZ RESEARCH](https://www.zscaler.com/blogs?topic=threatlabz-research)**\n\n\n-----\n\n[MoonWalk. For details of DodgeBox, go toPart 1.](https://www.zscaler.com/blogs/security-research/dodgebox-deep-dive-updated-arsenal-apt41-part-1)\n\nIn Part 2 of this blog series, we examine the MoonWalk backdoor, a new addition to APT41's\n[toolkit. Continuing from our previous analysis of the DodgeBox loader in Part 1, we have](https://www.zscaler.com/blogs/security-research/dodgebox-deep-dive-updated-arsenal-apt41-part-1)\ndiscovered that MoonWalk shares several evasion techniques. It makes use of Google Drive\nfor command-and-control (C2) communication and abuses Windows Fibers, a lesserknown Windows feature, to evade anti-virus (AV) and Endpoint Detection and Response\n(EDR) solutions.\n\n### Key Takeaways\n\nAPT41, a China-based nation-state threat actor known for campaigns in Southeast\n\nAsia, has been observed using a new backdoor called MoonWalk.\nMoonWalk shares a common development toolkit with DodgeBox, reusing code that\nimplements evasive techniques such as DLL hollowing, import resolution, DLL\n\nunhooking, and call stack spoofing. Additionally, MoonWalk employs further evasion\n\ntactics, including the use of Google Drive as its C2 channel to blend in with legitimate\nnetwork traffic and the utilization of Windows Fibers to evade AV/EDR security\nsolutions.\n\nMoonWalk's modular design allows attackers to easily update its capabilities, modify its\n\nbehavior, and customize functionality for different scenarios.\n\n### Technical Analysis\n\n#### Attack chain\n\nThe focus of this blog post is the second half of the attack chain that begins with the in\nmemory execution of MoonWalk backdoor. Once the MoonWalk backdoor is successfully\nloaded by DodgeBox, the malware decrypts and reflectively loads two embedded plugins (C2\nand Utility). The C2 plugin uses a custom encrypted C2 protocol to communicate with the\n\nattacker-controlled Google Drive account.\n\nA figure depicting the attack chain used to deploy MoonWalk with the DodgeBox loader is\nshown below.\n\n\n-----\n\nFigure 1: Attack chain used to deploy the DodgeBox loader and MoonWalk backdoor.\n\n#### MoonWalk analysis\n\nMoonWalk is a malware backdoor written in C that shares many code similarities with\n\nDodgeBox, suggesting a common development toolkit. It incorporates many evasion related\nfunctions from DodgeBox, including those related to the following:\n\nDLL hollowing\n\nImport resolution\n\nDLL unhooking\nCall stack spoofing\n\nAdditionally, MoonWalk utilizes the same DLL blocklist as DodgeBox.\n\nThreatLabz analysis reveals MoonWalk's modular design, allowing it to load different plugin\n\ncomponents as needed. The sample examined by ThreatLabz contains two embedded\n\nplugins, a C2 plugin for C2 communication, and a utility plugin that provides functionality\nrelated to compression and public-key cryptography. This modular architecture makes\n\nMoonWalk highly adaptable, enabling attackers to customize its functionality for different\n\nscenarios.\n\n\n-----\n\n**Unloading the DodgeBox loader**\n\nWhen MoonWalk first initializes, it resolves its imports using the same algorithms as\nDodgeBox. Then, depending on the DodgeBox configuration\n\nparameter `Config.fShouldUnloadStealthVector, MoonWalk unloads the DodgeBox`\n\nDLL from memory and unlinks it from the Process Environment Block (PEB). This reduces\n\nMoonWalk’s in-memory footprint, and obfuscates its origins, hindering memory forensic\n\nanalysis.\n\n**Using Windows Fibers**\n\nNext, MoonWalk initializes global structures used to manage Windows Fibers. Windows\n\nFibers are a lightweight threading mechanism, available in the Windows operating system\n\nsince Windows NT SP5. Unlike traditional threads, which are scheduled by the operating\nsystem, fibers are cooperatively scheduled by the application itself. This allows developers to\n\ntune an application’s performance for a specific workload. However, due to the complexity of\n\nutilizing Windows Fibers, and performance improvements of computer hardware, Windows\nFibers were not widely adopted, and remains an obscure feature.\n\nHowever, with the increased focus on cybersecurity in recent years, there has been an uptick\n\nin interest in Windows Fibers from the research and red-teaming community. Multiple\n\n[research papers (1, 2, 3) and open-sourced proof of concepts (POCs) have been published,](https://www.ired.team/offensive-security/code-injection-process-injection/executing-shellcode-with-createfiber)\nabusing Windows Fibers to evade AVs/EDR solutions.\n\nAPT41 may have been following these developments, as they have incorporated Windows\n\nFibers into the MoonWalk backdoor. At a high level, MoonWalk maintains a global array of\n\nfibers. When a function needs to be executed as a fiber, a fiber is created using\nthe `CreateFiber API. This fiber is then packaged together with the address of the`\n\nfunction and its arguments and other metadata, and inserted into the global array. The main\nfiber then schedules these fibers for execution. This use of Windows Fibers helps\n\nMoonWalk evade AVs and EDRs which do not support the scanning of Windows Fibers, and\n\nalso makes analysis challenging by breaking up the control flow.\n\n**Configuration**\n\nMoonWalk decrypts its configuration, which is hard-coded within its `.lrsrc section. Like`\n\nDodgeBox, MoonWalk uses MD5 for configuration validation and AES Cipher Feedback\n\n(AES-CFB) for decryption.\n\nHowever, MoonWalk's configuration is more complex, featuring nested structures and\narrays. This configuration contains various execution parameters including the following:\n\nMutex names\n\nA fib fi ti\n\n\n-----\n\nEncryption keys\n\nC2-related data\n\nIn the sample we analyzed, MoonWalk's configuration (referred to as `Config ) included`\n\nOAuth secrets used to authenticate with the attacker-controlled Google Drive account, and\n\nother notable fields as shown below:\n\n```\nConfig.szClientSecret:\n\n```\n```\nXXXXXXXXBiuo8VPZUH1dBHkv86mC1xFU_Z3\n\n```\n```\nConfig.rgbXorKey:\n\n```\n```\na8e6bd132daf0360b1af1f5eea15e42f8c6f1dcd7d34376ae4e83a1a4f5907c0\n\n```\n```\nConfig.szMutexName:\n\n```\n```\nGlobal\\ctXjvsAxpzyqElmk\n\n```\n```\nConfig.szName:\n\n```\n```\ndefault\n\n```\n\nAfter loading the default configuration, MoonWalk searches for a new configuration file at\n```\nC:\\ProgramData\\[MD5(Config.rgbIDBytes)] . If found, the malware decrypts and\n\n```\nloads this file. A sample of MoonWalk's decrypted configuration is available in the Appendix\n\nof this blog for reference.\n\n**Unpacking and loading plugins**\n\nMoonWalk then extracts embedded plugins from the `.lrsrc section. In the MoonWalk`\n\nsample we analyzed, there were two plugins embedded within this section: one plugin for\n\nC2, and another plugin which provides utility functions such as public key cryptography and\ncompression.\n\nEach plugin in the `.lrsrc section is prefixed with 72 bytes of metadata, which includes`\n\nAES-CFB secrets, an MD5 checksum, and plugin type information. The plugin type\n\ninformation fields provide information about the features of a plugin. These fields help\nidentify whether a plugin serves as a command handler, C2, or utility. More details about the\n\nstructure of plugin metadata can be found in the Appendix section.\n\n\nstru\n\n\n-----\n\nthen goes through this list to load the C2 plugin and its dependencies, such as the utility\n[plugin, using DLL hollowing. This process is similar to what we previously described in Part 1](https://www.zscaler.com/blogs/security-research/dodgebox-deep-dive-updated-arsenal-apt41-part-1)\n\nfor DodgeBox. Like DodgeBox, this MoonWalk sample stores a copy of the host DLL\n\nin `C:\\Windows\\Microsoft.NET\\assembly\\GAC_MSIL\\System.Data.Trace .`\n\n**Network Communication**\n\nAfter loading the C2 plugin, MoonWalk is prepared to establish communication with the C2\n\nserver. MoonWalk utilizes Google Drive for C2 communications. This helps MoonWalk\nevade detection, as traffic to and from reputable cloud services are less likely to raise\nsuspicion, especially if a target is already using this service. Strangely, MoonWalk uses the\n\nstring curl/7.54.0 as its User-Agent when making HTTP requests, even though it does not\nutilize libcurl in its C2 plugin, and uses the WinHTTP family of APIs instead.\n\nAt a high level, MoonWalk communicates over Google Drive in the following manner:\n\n|Step|Description|\n|---|---|\n|1 - Initialization|MoonWalk obtains an access token from the Google Authorization Server, by utilizing the OAuth secrets in its confgi uration ( Config.szClientID, Config.szCli entSecret and Config.szRefreshToken ). MoonWalk generates 16 random bytes, and hex-encodes them, resulting in a string such as: f137da1a9019849fbc2aac49a4b6 f2c3. We will reference this string as SessionID . MoonWalk uses the Google Drive APIs to retrieve the ID for the /data directory. MoonWalk retrieves the ID for the /data/temp directory.|\n\n\n2 - Cryptographic Handshake (Client\nHello and Server Hello)\n\n\nMoonWalk searches /data/temp for a\nfile named after the\ngenerated `SessionID (i.e.` `f137da1a90`\n```\n19849fbc2aac49a4b6f2c3 ). If the file\n\n```\nis not found, MoonWalk generates and\n\n\n-----\n\n|Step|Description|\n|---|---|\n||file /data/temp/[SessionID] to initiate a cryptographic handshake and exchange AES keys with the server. MoonWalk then looks for the /data/[SessionID] directory, and its subdirectory /data/[SessionID]/s1 . The directory titled s[number] seems to serve as the designated location where MoonWalk will retrieve and download forthcoming C2 instructions. Lastly, MoonWalk searches for the /data/[SessionID]/s1/1 file. As it becomes available, MoonWalk downloads and processes it, and completes the cryptographic handshake.|\n|3 - Information Gathering|MoonWalk then checks for the existence of the directory /data/[SessionID]/c1, and creates it if it does not exist. Then, MoonWalk gathers information such as the computer name, user name, and OS version, and uploads this to the file /data/[SessionID]/c1/1 .|\n\n\n4 - Heartbeat MoonWalk then proceeds to send\nheartbeats regularly to the C2 server by\n\nupdating a file named “ temp.txt ” with\n\nthe current Unix timestamp as a string.\n\nMoonWalk also regularly polls\nthe `/data/[SessionID]/s1 directory`\n\nfor new files. If a new file is found,\n\nMoonWalk processes it and uploads its\nresponse in\n\nthe `/data/[SessionID]/c1 directory.`\n\nDuring our analysis of MoonWalk,\n\nonly ping commands were observed,\nwhere MoonWalk responded by\nuploading encoded files to\n\n\n-----\n\n**p** **p**\n\nthe `/data/[SessionID]/c1 directory,`\n\ncontaining the current Unix timestamp.\n\nTable 1: High-level view of the MoonWalk C2 communication protocol using Google Drive.\n\n**Cryptographic Handshake (Client Hello)**\n\nDuring the cryptographic handshake phase, MoonWalk exchanges AES keys with the server\n\nusing a custom protocol. Because of this, it becomes very difficult or impossible to decode\nencrypted C2 messages without access to these AES keys, which exist only in MoonWalk’s\nprocess memory.\n\nThe process begins with MoonWalk generating a 32-byte AES key ( rgbClientAESKey )\n\nand a 16-byte initialization vector (IV) ( rgbClientAESIV ) using a custom random number\n\ngenerator. The AES key is then treated as an Elliptic-curve Diffie-Hellman (ECDH) private key,\nto generate the corresponding ECDH public key ( rgbECDHPublicKey ) using\n\nthe `curve25519_donna function.`\n\nMoonWalk then encodes the ECDH public key and AES IV by XORing them with the XOR\nkey from MoonWalk's configuration ( Config.rgbXorKey ). A checksum is created by\n\nperforming an MD5 hash on the concatenation of `Config.rgbXorKey, ECDH public key,`\n\nand AES IV, and then taking the hash’s first four bytes. Finally, MoonWalk uploads this data\n\nto Google Drive at the path `/data/temp/[SessionID] .`\n\nThe figure below shows content of an uploaded file:\n\nFigure 2: Contents of a MoonWalk Client Hello key exchange message.\n\nThe table below provides a description of the various fields contained within the uploaded\nfile:\n\n**Offset** **Size in bytes** **Description**\n\n0x00 1 Unknown field, possibly a\n\n|Col1|the /data/[SessionID]/c1 directory, containing the current Unix timestamp.|\n|---|---|\n\n|Ofsfet|Size in bytes|Description|\n|---|---|---|\n\n\n-----\n\n|Offset|Size in bytes|Description|\n|---|---|---|\n|||message type enum.|\n|0x01|32|rgbECDHPublicKey XORed with Config.rgbXorKe y rgbECDHPublicKey before the XOR operation is: d2 04 7b 20 60 c4 25 e2 da 01 f8 1d 5b 89 d1 8c ae bd 07 d3 da bc 82 41 e1 b1 14 2c 57 b5 5a 07|\n|0x21|16|rgbClientAESIV XORed with Config.rgbXorKe y rgbClientAESIV before the XOR operation is: c4 e9 27 7c 18 e3 67 c7 49 32 0a a6 f8 be 7a 67|\n|0x31|4|First four bytes of MD5 (Config.rgbXorKey | rgbECDHPublicKey | rgbClientAESIV)|\n|0x35|15|Unknown bytes.|\n\n\nTable 2: Description of MoonWalk Client Hello key exchange message.\n\n**Cryptographic Handshake (Server Hello)**\n\nMoonWalk then downloads the file located at `/data/[SessionID]/s1/1 . This file`\n\ncontains the server’s response to MoonWalk’s handshake above.\n\n\n-----\n\nscheme. Here, we walk through the decoding process of this scheme, using the Server Hello\n\nfile as an example.\n\nThe figure below is an example of the overall layout of the encoded Server Hello file:\n\nFigure 3: MoonWalk Server Hello message format.\n\nA description of these fields is shown in the following table.\n\n**Offset** **Size in bytes** **Description**\n```\n                              rgbFileXorKey\n\n```\n0x00 8 The XOR key used to\n\ndecode `rgbEncodedByt`\n```\n                              es .\n\n```\nUnknown, potentially a\n0x08 8\nmessage type field.\n```\n                              dwNumEncodedBytes\n\n```\nThe number of encoded\nbytes that follows. This\n\nfield is encoded\nwith `rgbFileXorKey .`\n\n0x10 2 Decoding this field shows\n\nthat there are 0xbc\nencoded bytes within this\n\nfile.\n```\n                              85 20 XOR 85\n                              9c = 00 bc\n\n```\n0x12 dwNumEncodedBytes `rgbEncodedBytes`\n\n|Ofsfet|Size in bytes|Description|\n|---|---|---|\n|0x00|8|rgbFileXorKey The XOR key used to decode rgbEncodedByt es .|\n|0x08|8|Unknown, potentially a message type fei ld.|\n|0x10|2|dwNumEncodedBytes The number of encoded bytes that follows. This fei ld is encoded with rgbFileXorKey . Decoding this fei ld shows that there are 0xbc encoded bytes within this file. 85 20 XOR 85 9c = 00 bc|\n\n\n-----\n\n|Offset|Size in bytes|Description|\n|---|---|---|\n|||The encoded bytes within this file. These bytes appear to contain message metadata, such as Google Drive file IDs, message headers, or junk bytes. To decode these bytes, rgbFileXorKey is used, starting with the third byte of the XOR key. 18 25 ea a3 39 b4 e8 45 7f 01 99 ba 07 d6 XOR 29 44 ae cd 5f fb 85 20 29 44 ae cd 5f fb = 31 61 44 6e 66 4f 6d 65 56 45 37 77 58 2d|\n|0x??|variable|rgbEncryptedBytes The rest of the file is not encoded, because this section is typically encrypted with AES-CFB, using the AES keys exchanged during the cryptographic handshake phase.|\n\n\nTable 3: Description of the MoonWalk Server Hello message format.\n\nThe figure below shows the Server Hello file after decoding:\n\n\n-----\n\nFigure 4: Example contents of a decoded MoonWalk Server Hello message.\n\nThe decoded Server Hello fields are described in the table below.\n\n**Offset** **Size in bytes** **Description**\n```\n                              rgbFileXorKey\n\n```\n0x00 8 The XOR key, used to\n\ndecode `rgbEncodedByt`\n```\n                              es .\n\n```\n0x08 8 Unknown\n\n0x10 2 `dwNumEncodedBytes`\n```\n                              szHeartBeatFileID\n\n```\n0x12 variable The Google Drive ID of\n\nthe heartbeat\n\nfile, `temp.txt .`\n\n0x34 variable Unknown\n\n0xce 48 Encoded buffer, XOR\nencoded\n\n|Ofsfet|Size in bytes|Description|\n|---|---|---|\n|0x00|8|rgbFileXorKey The XOR key, used to decode rgbEncodedByt es .|\n|0x08|8|Unknown|\n|0x10|2|dwNumEncodedBytes|\n|0x12|variable|szHeartBeatFileID The Google Drive ID of the heartbeat file, temp.txt .|\n|0x34|variable|Unknown|\n\n\n-----\n\n|Offset|Size in bytes|Description|\n|---|---|---|\n|||with Config.rgbXorKe y . After decoding, the following fei lds are revealed: rgbServerECDHBasePo int - Used as the ECDH base point, which MoonWalk later uses to generate the shared AES key used by the server. 77 82 64 13 04 16 94 da 35 d2 1e b8 27 d7 35 ff 02 8a 47 85 56 41 29 5b cb 3b 28 22 f2 69 3d 3a The remaining bytes after decoding contain a checksum, and additional unknown bytes.|\n|0xfe|4|Checksum generated by MD5 (rgbServerECDHBaseP oint | Config.rgbXorKey.)|\n|0x102|variable|Unknown|\n\n\nTable 4: Description of fields within a MoonWalk Server Hello message.\n\nWith this information, MoonWalk generates a public key ( rgbECDHServerPublicKey )\n\nusing the `curve25519_donna function. Then,` `rgbECDHServerPublicKey is XORed`\n\nagainst `Config.rgbXorKey to generate the server AES key.`\n```\nCurve25519_Donna(\n\n```\n```\n Cur\n\n```\n\n-----\n\n```\n  // 000001e6`246391ec b5 8f a7 ee 0b da d6 79-79 60 85 79 bf 32 ad 91\n  // 000001e6`246391fc 24 a3 39 66 4c 4b 49 97-6c 71 92 d3 55 45 4b 3e\n  a1->rgbClientAESKey,  \n  // Private Key:\n  // 000001e6`2463920c 54 be fd a7 f4 0f 62 15-fb 22 9a 48 04 e3 6e 90\n  // 000001e6`2463921c 85 4b b9 c7 f2 5f de 57-65 59 9c 90 18 04 d9 d1\n  a1->rgbECDHServerBasepoint);\n  // Basepoint:\n  // 000001e6`24639251 77 82 64 13 04 16 94 da-35 d2 1e b8 27 d7 35 ff\n  // 000001e6`24639261 02 8a 47 85 56 41 29 5b-cb 3b 28 22 f2 69 3d 3a\nrgbServerAESKey = rgbECDHServerPublicKey ^ Config.rgbXorKey\n// 1d 69 1a fd 26 75 d5 19-c8 cf 9a 27 55 27 49 be\n// a8 cc 24 ab 31 7f 7e fd-88 99 a8 c9 1a 1c 4c fe\n\n```\nIn this manner, MoonWalk exchanges AES keys with its C2, and thus concludes the\ncryptographic handshake.\n\n**Information gathering**\n\nDuring this phase, MoonWalk collects information about the environment and uploads it to\n\nGoogle Drive. The gathered data includes details such as the processor architecture,\nWindows product type, version and build numbers, computer and usernames, as well as IP\n\naddresses. This information is then compressed using LZ4. A checksum is then added, using\n\nthe 32-bit MurmurHash2 algorithm, with a customized mixing constant where `r is set`\n\nto `15, and with the initial seed set to` `0x12345678 . These bytes are then encrypted using`\n\nAES-CFB with the server’s AES key, and packaged using the custom scheme detailed above,\n\nbefore being uploaded to Google Drive.\n\nMore details of the environment information collected are provided in the Appendix of this\n\nblog.\n\n**Heartbeat**\n\nMoonWalk also regularly sends heartbeats to the server. It uploads the current Unix\n\ntimestamp in plain text to a `temp.txt file on Google Drive, using the file`\n\nID `szHeartBeatFileID retrieved as part of the cryptographic handshake.`\n\n**Backdoor capabilities**\n\nIn our analysis of MoonWalk, we did not observe the C2 sending any other commands or\n\nplugins. If a command handler plugin ( dwPluginTypePart2 == 1 described in the\n\nAppendix) is not found, MoonWalk defaults to a built-in list of handlers. These handlers\ncontain functionality, which include the following:\n\n\n-----\n\nSteal token (token impersonation)\nCreate token (log on to the Windows machine using given credentials)\n\nDownload new configuration\n\nExecute command line commands\n\n**Note: This list is not complete as further analysis is required.**\n### Conclusion\n\nMoonWalk is a sophisticated and modular backdoor that incorporates evasion techniques\n\nseen in DodgeBox. It also introduces innovative techniques, including the utilization of\nWindows Fibers, which are not commonly observed. These evasion techniques combined\n\nwith the usage of a custom complex C2 communication protocol abusing Google Drive to\n\nblend in with legitimate traffic highlights the highly skilled nature of the APT41 threat\nadversary.\n\nWe continue to closely monitor the latest tactics, techniques, and procedures (TTPs) of this\n\nthreat actor to protect our customers and share research with the security community.\n\n### Zscaler Coverage\n\nZscaler’s multilayered cloud security platform detects indicators related to DodgeBox at\nvarious levels with the following threat name.\n\n[Win64.Backdoor.Moonwalk](https://threatlibrary.zscaler.com/?keyword=Win64.Backdoor.Moonwalk)\n\n### Indicators Of Compromise (IOCs)\n\n|MD5 Hash|Description|\n|---|---|\n|5b1e8455291d99a1724327b9a7fc2616|MoonWalk backdoor (related to DodgeBox loader with MD5: d72f202c1d684c9a19f075290a60920f).|\n|b69984cbf52b418673bd08279ca845d6|Utility plugin|\n|5217b8552321556ea434474377cfcd02|C2 plugin|\n|bfd6286bb39a0e24a2af28c63bd8e194|MoonWalk backdoor (related to DodgeBox loader with MD5: 393065ef9754e3f39b24b2d1051eab61).|\n|75bfb7d5199bf0c4e62525099b33e14f|C2 plugin|\n\n\n-----\n\n**p**\n\n|f68ef9e40462c9760bf9c829edd9f4a9|Utility plugin|\n|---|---|\n\n|Entity|Description|\n|---|---|\n|GDrive OAuth Client ID #1|XXXXXXXX5917- dudeis843uv3v1lrm1n12jbq9l9a86lq.apps. googleusercontent.com|\n|GDrive Client Secret #1|XXXXXXXX8OPdXrMnPIbIvODh4bnYT VtdKJY|\n|GDrive Refresh Token #1|XXXXXXXXEqC4HrQVCgYIARAAGAkSN wF- L9IrS7n6zr6G_vE7_huP5uJuMT6aMtOnu 3WgmTMRiEc5QJaQgVX4gbUV7ltUbF XVmd5KOZM|\n|GDrive OAuth Client ID #2|XXXXXXXX3108- 0pm3bsjc0mto2e1k4kp2u8817lgk3e3v.a pps.googleusercontent.com|\n|GDrive Client Secret #2|XXXXXXXXBiuo8VPZUH1dBHkv86mC1x FU_Z3|\n|GDrive Refresh Token #2|XXXXXXXXiYDPmH9cCgYIARAAGAkSN wF- L9IrcM7YiuxWrNuyIfKINyNc_pEVytGNN K750ZyyIm32qH6Wh3dGIBTvdPJ2v92xA ohHwWw|\n|Threat actor’s email address (linked to GDrive)|jsonmakesam@gmail.com|\n\n|Heartbeat related network requests|Description|\n|---|---|\n\n\nVerb:\n\n```\nPATCH\n\n```\n\nMoonWalk updating `temp.txt with`\n\nUnix timestamp.\n\n\n-----\n\n|Heartbeat related network requests|Description|\n|---|---|\n|URL: https://www.googleapis.com/uplo ad/drive/v3/files/[redacted_id] URL Params: uploadType=media&fields=id,name,size,mimeType,modifiedTime User-Agent: curl/7.54.0||\n|Verb: GET URL: https://www.googleapis.com/driv e/v3/files URL Params: fields=files(id,name,size,mimeT ype,modifiedTime)&q= [redacted_id]%20in%20parents%20 and%20trashed%20%3D%20false%20& pageSize=300 User-Agent: curl/7.54.0|MoonWalk querying for new commands.|\n\n\n### MITRE ATT&CK Framework\n\n|Tactic|ID|Technique|Description|\n|---|---|---|---|\n|Defense Evasion|T1027|Obfuscated Files or Information|MoonWalk uses AES-CFB to encrypt strings, confgi urations, and bundled payloads.|\n\n\n-----\n\n|Tactic|ID|Technique|Description|\n|---|---|---|---|\n|Defense Evasion|T1027.007|Obfuscated Files or Information: Dynamic API Resolution|MoonWalk uses salted FNV1a hashes to dynamically resolve APIs.|\n|Defense Evasion|T1620|Reflective Code Loading|MoonWalk reflectively loads plugin DLLs, utilizing DLL hollowing.|\n|Defense Evasion|T1106|Native API|MoonWalk uses Windows Native APIs like NtCreateFi le, LdrLoadDll, and NtAllocate VirtualMemory, as opposed to their Win32 counterparts.|\n\n\nDefense Evasion T1562.001 Impair Defenses:\n\nDisable or Modify\n\nTools\n\n\nMoonWalk\n\nutilizes stack\n\nspoofing when\ncalling APIs to\n\nmonitor for\n\nsecurity software.\nMoonWalk\n\nperforms a scan\n\nwithin its own\naddress space to\n\ndetect any\n\nalterations, such\n\nas hooks or\ndebugger\n\nbreakpoints. If it\n\nidentifies any\nsigns of\n\n\n-----\n\n|Tactic|ID|Technique|Description|\n|---|---|---|---|\n||||DodgeBox takes action to restore the original code from disk, efefctively undoing any unauthorized changes made to its code.|\n|Command and Control|T1102.002|Web Service: Bidirectional Communication|MoonWalk has a C2 plugin that utilizes an attacker- controlled Google Drive account to implement a C2 communication channel.|\n|Command and Control|T1573|Encrypted Channel|MoonWalk leverages a custom network protocol to exchange encrypted C2 messages.|\n|Reconnaissance|T1592|Gather Victim Host Information|MoonWalk collects information about the hardware and software confgi uration of the victim's host.|\n|Reconnaissance|T1590|Gather Victim Network Information|MoonWalk collects the IP address of the victim's host.|\n\n\n-----\n\n#### .lrsrc section\n\nAn example of the .lrsrc section from MoonWalk is shown in the figure below.\n\nFigure 5: An example of the `.lrsrc section from MoonWalk.`\n\nThe table below provides a description of the various fields.\n\n|Ofsfet|Size in bytes|Description|\n|---|---|---|\n|0x00|4|dwOffsetToEncrypted Config Ofsfet from the start of .lrsrc section|\n|0x04|4|dwSizeOfEncryptedCo nfig|\n|0x08|4|dwNumEmbeddedPlugin s|\n|0x0c|4|rgsEmbeddedPlugin[0 ].dwPluginOffset Ofsfet to embedded plugin, containing a plugin’s metadata, followed by the plugin.|\n|0x10|4|rgsEmbeddedPlugin[0 ].dwPluginSize Size of the plugin including its metadata.|\n\n\n-----\n\n|Offset|Size in bytes|Description|\n|---|---|---|\n|0x14|4|rgsEmbeddedPlugin[1 ].dwPluginOffset|\n|0x18|4|rgsEmbeddedPlugin[1 ].dwPluginSize|\n\n\n#### Plugin metadata\n\nAn example of a MoonWalk C2 plugin’s metadata is shown in the figure below.\n\nFigure 6: An example of a MoonWalk C2 plugin’s metadata.\n\nThe table below provides a description of the various fields.\n\n|Ofsfet|Size in bytes|Description|\n|---|---|---|\n|0x00|4|dwPluginTypePart1 A combination of dwPluginTypePart1 and dwPluginTypePart 2 determine a plugin’s functionality|\n|0x04|4|dwPluginTypePart2 A combination of dwPluginTypePart1 and dwPluginTypePart 2 determine a plugin’s functionality|\n\n\n-----\n\n|Offset|Size in bytes|Description|\n|---|---|---|\n|0x08|4|Flag to load plugin only if OS and processor information have been successfully collected by MoonWalk.|\n|0x0c|4|Dictates how MoonWalk should retrieve a plugin’s exports.|\n|0x10|4|Unknown|\n|0x14|16|MD5 of plugin metadata and plugin data.|\n|0x24|16|Hashed with MD5 to produce the AES key for decrypting the plugin.|\n|0x34|16|AES IV|\n|0x44|4|Size of plugin data that follows.|\n\n\n#### Decrypted configuration\n\nMoonWalk's configuration is complex, containing arrays and nested structures of various\ntypes, as shown in the figure below. This analysis will focus only on the relevant fields, with\nnon-essential bytes omitted from the analysis. These omitted bytes will either have\n\nunknown functionality or contain metadata for parsing the configuration.\n\nAn example of MoonWalk’s decrypted configuration is shown in the figure below.\n\n\n-----\n\nFigure 7: MoonWalk's configuration which contains arrays and nested structures of various\ntypes.\n\nThe table below provides a description of the various fields.\n\n**Offset** **Size in bytes** **Description**\n\n0x00 16 `rgbIDBytes`\n\nThe MD5 hash of this\nvalue is also used to\ngenerate the path to\n\n|Ofsfet|Size in bytes|Description|\n|---|---|---|\n\n\n-----\n\n|Offset|Size in bytes|Description|\n|---|---|---|\n|||override a confgi uration file on disk.|\n|0x10|24|szMutexName The name of the mutex that MoonWalk uses to ensure only one instance of the backdoor is running.|\n|0x2c|variable|wszConfigName Postulated to be the name of the confgi uration. Since this is the confgi uration extracted from the binary, it is the “ default ”. During our analysis, we did not receive additional confgi urations.|\n|0x3a|32|rgbXorKey This is the XOR key used to encrypt C2 communications. In this sample, the value is: a8e6bd132daf0360b1a f1f5eea15e42f8c6f1d cd7d34376ae4e83a1a4 f5907c0 .|\n|0x5e|8|Appears to be used as a heartbeat related interval lower bound.|\n|0x66|8|Appears to be used as a heartbeat related interval upper bound.|\n\n\n-----\n\n|Offset|Size in bytes|Description|\n|---|---|---|\n|0x96|4|fEnableHeartBeat|\n|0x9a|8|Appears to be used as another heartbeat related interval lower bound.|\n|0xa2|8|Appears to be used as another heartbeat related interval upper bound.|\n|0x0130|variable|szClientID OAuth client ID used to authenticate with Google Drive.|\n|0x17f|variable|szClientSecret OAuth client secret used to authenticate with Google Drive.|\n|0x1a9|variable|szRefreshToken OAuth refresh token used to authenticate with Google Drive.|\n\n\n#### Gathered environment information\n\nThis is the list of environment information gathered by MoonWalk and uploaded to\n\nGoogleDrive as part of its initialization process.\n\nVictim hash (FNV1a hash of the concatenation of the computer\nname `Config.rgbIDBytes and the machine’s GUID).`\n\nWindows major and minor version numbers\nWindows build number\n\nComputer name\nUser name\nExecutable path (full path to the current process’s executable file).\n\nImpersonation status\nCPU t t ti\n\n\n-----\n\nIPv6 addresses\n\n```\nConfig.rgbIDBytes\n\n```\n```\nConfig.wszConfigName\n\n```\n\nVarious heartbeat related interval fields from MoonWalk’s configuration.\n\n##### Was this post useful?\n\nYes, very! Not really\n\n### Explore more Zscaler blogs\n\n\nNot really\n\n\n##### The Ret APT\n\n**[R E A D P O S](https://www.zscaler.com/blogs/security-research/return-higaisa-apt)**\n\n\n-----\n\n# Get the latest Zscaler blog updates in\n your inbox\n\nEmail Address\n\n**Subscribe**\n\n[By submitting the form, you are agreeing to our privacy policy.](https://www.zscaler.com/privacy/company-privacy-policy)\n\n\n**P O P U L A R L I N K S**\n\n**English**\n\nZscaler is universally recognized as the leader in zero trust. Leveraging the largest security cloud on the planet, Zscaler anticipates, secures, and simplifies the\nexperience of doing business for the world's most established companies.\n\nPlease enter your email to subscribe **→**\n\n[Sitemap](https://www.zscaler.com/sitemap.xml) [Privacy](https://www.zscaler.com/privacy/overview) [Legal](https://www.zscaler.com/legal/overview) [Security](https://www.zscaler.com/security/vulnerability-disclosure-program)\n\n**© 2024 Zscaler, Inc.** All rights reserved. Zscaler™ and other trademarks listed at zscaler.com/legal/trademarks are either (i) registered trademarks or service\n\nmarks or (ii) trademarks or service marks of Zscaler, Inc. in the United States and/or other countries. Any other trademarks are the properties of their\nrespective owners.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2024/2024.07.10.A_deep_dive_into_the_updated_arsenal_of_APT41/MoonWalk_A_deep_dive_into_the_updated_arsenal_of_APT41.pdf"
    ],
    "report_names": [
        "MoonWalk_A_deep_dive_into_the_updated_arsenal_of_APT41"
    ],
    "threat_actors": [
        {
            "id": "873919c0-bc6a-4c19-b18d-c107e4aa3d20",
            "created_at": "2023-01-06T13:46:39.138138Z",
            "updated_at": "2025-03-27T02:00:03.005534Z",
            "deleted_at": null,
            "main_name": "Higaisa",
            "aliases": [],
            "source_name": "MISPGALAXY:Higaisa",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "dc78f675-b309-431d-8160-b8dcff037d4f",
            "created_at": "2024-05-01T02:03:08.142224Z",
            "updated_at": "2025-03-27T02:05:17.417972Z",
            "deleted_at": null,
            "main_name": "NICKEL KIMBALL",
            "aliases": [
                "Black Banshee ",
                "Crooked Pisces ",
                "Emerald Sleet ",
                "Kimsuky ",
                "Opal Sleet ",
                "SharpTongue ",
                "TA427 ",
                "THALLIUM ",
                "Velvet Chollima ",
                "APT43 "
            ],
            "source_name": "Secureworks:NICKEL KIMBALL",
            "tools": [
                " KONNI",
                " KimJongRAT",
                " Kimsuky",
                "BabyShark"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "30c9c492-afc6-4aa1-8fe6-cecffed946e0",
            "created_at": "2022-10-25T15:50:23.400822Z",
            "updated_at": "2025-03-27T02:00:55.461334Z",
            "deleted_at": null,
            "main_name": "Higaisa",
            "aliases": [
                "Higaisa"
            ],
            "source_name": "MITRE:Higaisa",
            "tools": [
                "PlugX",
                "certutil",
                "gh0st RAT"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "4c68ccd0-caba-4189-9ead-86ac4c2d9b70",
            "created_at": "2024-05-01T02:03:07.930196Z",
            "updated_at": "2025-03-27T02:05:17.251237Z",
            "deleted_at": null,
            "main_name": "BRONZE ATLAS",
            "aliases": [
                "Axiom",
                "BARIUM ",
                "Blackfly ",
                "CTG-2633",
                "GREF",
                "Group 72 ",
                "Red Kelpie ",
                "TG-2633 ",
                "Wicked Panda ",
                "Winnti",
                "APT41 "
            ],
            "source_name": "Secureworks:BRONZE ATLAS",
            "tools": [
                " CCleaner v5.33 backdoor",
                " ChinaChopper",
                " Cobalt Strike",
                " Dicey MSDN",
                " ForkPlayground",
                " HUC Proxy Malware (Htran)",
                " Mimikatz",
                " PipeMon",
                " PlugX",
                " PortReuse",
                " Powershell Empire",
                " RCMD",
                " RbDoor",
                " SPEEDBOAT",
                " ShadowPad",
                " Sidewalk",
                " Speculoos",
                " TeamViewer",
                " Winnkit",
                " Winnti",
                " reg save",
                " vssadmin",
                "Acehash"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "760f2827-1718-4eed-8234-4027c1346145",
            "created_at": "2023-01-06T13:46:38.670947Z",
            "updated_at": "2025-03-27T02:00:02.888195Z",
            "deleted_at": null,
            "main_name": "Kimsuky",
            "aliases": [
                "Thallium",
                "G0086",
                "APT43",
                "Springtail",
                "Sparkling Pisces",
                "Velvet Chollima",
                "Black Banshee",
                "Operation Stolen Pencil",
                "Emerald Sleet",
                "THALLIUM"
            ],
            "source_name": "MISPGALAXY:Kimsuky",
            "tools": [
                "RevClient",
                "xrat",
                "QUASARRAT",
                "RDP Wrapper",
                "TightVNC",
                "BabyShark"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "191d7f9a-8c3c-442a-9f13-debe259d4cc2",
            "created_at": "2022-10-25T15:50:23.280374Z",
            "updated_at": "2025-03-27T02:00:55.423485Z",
            "deleted_at": null,
            "main_name": "Kimsuky",
            "aliases": [
                "Kimsuky",
                "Black Banshee",
                "Velvet Chollima",
                "Emerald Sleet",
                "THALLIUM",
                "APT43",
                "TA427"
            ],
            "source_name": "MITRE:Kimsuky",
            "tools": [
                "schtasks",
                "Amadey",
                "Brave Prince",
                "CSPY Downloader",
                "gh0st RAT",
                "AppleSeed",
                "NOKKI",
                "QuasarRAT",
                "Gold Dragon",
                "PsExec",
                "KGH_SPY",
                "Mimikatz",
                "BabyShark"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "c0cedde3-5a9b-430f-9b77-e6568307205e",
            "created_at": "2022-10-25T16:07:23.528994Z",
            "updated_at": "2025-03-27T02:02:09.847683Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "APT-C-06",
                "ATK 52",
                "CTG-1948",
                "Dubnium",
                "Fallout Team",
                "Higaisa",
                "Luder",
                "Operation DarkHotel",
                "Operation Daybreak",
                "Operation Inexsmar",
                "Operation PowerFall",
                "Operation The Gh0st Remains the Same",
                "SIG25",
                "Shadow Crane",
                "T-APT-02",
                "Tungsten Bridge",
                "Zigzag Hail"
            ],
            "source_name": "ETDA:DarkHotel",
            "tools": [
                "Asruex",
                "DarkHotel",
                "DmaUp3.exe",
                "GreezeBackdoor",
                "Karba",
                "Nemain",
                "Nemim",
                "Ramsay",
                "Retro",
                "Tapaoux",
                "Trojan.Win32.Karba.e",
                "Virus.Win32.Pioneer.dx",
                "igfxext.exe",
                "msieckc.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "4d5f939b-aea9-4a0e-8bff-003079a261ea",
            "created_at": "2023-01-06T13:46:39.04841Z",
            "updated_at": "2025-03-27T02:00:02.985296Z",
            "deleted_at": null,
            "main_name": "APT41",
            "aliases": [
                "G0096",
                "Grayfly",
                "BARIUM",
                "BRONZE ATLAS",
                "BRONZE EXPORT",
                "Red Kelpie",
                "HOODOO",
                "Brass Typhoon",
                "TA415",
                "WICKED SPIDER",
                "WICKED PANDA",
                "G0044",
                "Earth Baku"
            ],
            "source_name": "MISPGALAXY:APT41",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e698860d-57e8-4780-b7c3-41e5a8314ec0",
            "created_at": "2022-10-25T15:50:23.287929Z",
            "updated_at": "2025-03-27T02:00:55.43005Z",
            "deleted_at": null,
            "main_name": "APT41",
            "aliases": [
                "APT41",
                "Wicked Panda",
                "Brass Typhoon",
                "BARIUM"
            ],
            "source_name": "MITRE:APT41",
            "tools": [
                "ASPXSpy",
                "BITSAdmin",
                "PlugX",
                "Impacket",
                "gh0st RAT",
                "netstat",
                "PowerSploit",
                "ZxShell",
                "KEYPLUG",
                "ipconfig",
                "sqlmap",
                "China Chopper",
                "ShadowPad",
                "MESSAGETAP",
                "Mimikatz",
                "certutil",
                "njRAT",
                "Cobalt Strike",
                "pwdump",
                "BLACKCOFFEE",
                "ROCKBOOT",
                "dsquery",
                "Winnti for Linux",
                "DUSTTRAP",
                "Derusbi",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "71a1e16c-3ba6-4193-be62-be53527817bc",
            "created_at": "2022-10-25T16:07:23.753455Z",
            "updated_at": "2025-03-27T02:02:09.963016Z",
            "deleted_at": null,
            "main_name": "Kimsuky",
            "aliases": [
                "APT 43",
                "Black Banshee",
                "Emerald Sleet",
                "ITG16",
                "KTA082",
                "Kimsuky",
                "Larva-24005",
                "Operation Baby Coin",
                "Operation Covert Stalker",
                "Operation DEEP#DRIVE",
                "Operation DEEP#GOSU",
                "Operation Kabar Cobra",
                "Operation Mystery Baby",
                "Operation Red Salt",
                "Operation Smoke Screen",
                "Operation Stealth Power",
                "Operation Stolen Pencil",
                "SharpTongue",
                "Sparkling Pisces",
                "Springtail",
                "TA406",
                "TA427",
                "Thallium",
                "UAT-5394",
                "Velvet Chollima"
            ],
            "source_name": "ETDA:Kimsuky",
            "tools": [
                "AngryRebel",
                "AppleSeed",
                "BITTERSWEET",
                "BabyShark",
                "BoBoStealer",
                "CSPY Downloader",
                "Farfli",
                "FlowerPower",
                "Gh0st RAT",
                "Ghost RAT",
                "Gold Dragon",
                "GoldDragon",
                "GoldStamp",
                "JamBog",
                "KGH Spyware Suite",
                "KGH_SPY",
                "KPortScan",
                "KimJongRAT",
                "Kimsuky",
                "LATEOP",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Lovexxx",
                "MailPassView",
                "Mechanical",
                "Mimikatz",
                "MoonPeak",
                "Moudour",
                "MyDogs",
                "Mydoor",
                "Network Password Recovery",
                "PCRat",
                "ProcDump",
                "PsExec",
                "ReconShark",
                "Remote Desktop PassView",
                "SHARPEXT",
                "SWEETDROP",
                "SmallTiger",
                "SniffPass",
                "TODDLERSHARK",
                "TRANSLATEXT",
                "Troll Stealer",
                "TrollAgent",
                "VENOMBITE",
                "WebBrowserPassView",
                "xRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1721959573,
    "ts_updated_at": 1743041777,
    "ts_creation_date": 1721914338,
    "ts_modification_date": 1721914338,
    "files": {
        "pdf": "https://archive.orkl.eu/713707179b0523ec30b93d788d83a51d1511672b.pdf",
        "text": "https://archive.orkl.eu/713707179b0523ec30b93d788d83a51d1511672b.txt",
        "img": "https://archive.orkl.eu/713707179b0523ec30b93d788d83a51d1511672b.jpg"
    }
}