{
    "id": "003a8bee-cabb-4fc9-9236-8863c31081c6",
    "created_at": "2022-10-25T16:48:17.931087Z",
    "updated_at": "2025-03-27T02:17:11.560068Z",
    "deleted_at": null,
    "sha1_hash": "4245d60547605ffedc778613ce46f7367150f90f",
    "title": "2020-08-01 - Russian GRU 85th GTsSS Deploys Previously Undisclosed Drovorub Malware",
    "authors": "",
    "file_creation_date": "2020-08-13T06:58:20Z",
    "file_modification_date": "2020-08-13T06:58:20Z",
    "file_size": 2105487,
    "plain_text": "## National Security Agency Federal Bureau of Investigation\n Cybersecurity Advisory\n\n# Russian GRU 85th GTsSS\n\n Deploys Previously\n\n Undisclosed Drovorub Malware\n\n## August 2020 Rev 1.0\n\n#### U/OO/160679-20\n PP-20-0714\n\n\n-----\n\n### Notices and history \n\n#### Disclaimer of Warranties and Endorsement\n\nThe information and opinions contained in this document are provided \"as is\" and without any warranties\nor guarantees. Reference herein to any specific commercial products, process, or service by trade name,\ntrademark, manufacturer, or otherwise, does not necessarily constitute or imply its endorsement,\nrecommendation, or favoring by the United States Government. This guidance shall not be used for\nadvertising or product endorsement purposes.\n\n#### Sources and Methods\n\nNSA and FBI use a variety of sources, methods, and partnerships to acquire information about foreign\ncyber threats. This advisory contains the information NSA and FBI have concluded can be publicly\nreleased, consistent with the protection of sources and methods and the public interest.\n\n### Publication Information\n\n#### Purpose\n\nThis advisory was developed as a joint effort between NSA and FBI in support of each agency’s\nrespective missions. The release of this advisory furthers NSA’s cybersecurity missions, including its\nresponsibilities to identify and disseminate threats to National Security Systems, Department of Defense\ninformation systems, and the Defense Industrial Base, and to develop and issue cybersecurity\nspecifications and mitigations. This information may be shared broadly to reach all appropriate\nstakeholders.\n\n#### Contact Information\n\nClient Requirements / General Cybersecurity Inquiries:\n[Cybersecurity Requirements Center, 410-854-4200, Cybersecurity_Requests@nsa.gov](mailto:Cybersecurity_Requests@nsa.gov)\n\nMedia Inquiries / Press Desk:\nMedia Relations, 443-634-0721, MediaRelations@nsa.gov\n\n#### Trademark Recognition\n\nLinux[®] is a registered trademark of Linus Torvalds.\nGitHub[®] is a registered trademark of GitHub, Inc.\nMITRE[®] and ATT&CK[®] are registered trademarks of The MITRE Corporation.\nOpenSSL[®] is a registered trademark of the OpenSSL Software Foundation, Inc.\nRed Hat[®] is a registered trademark of Red Hat, Inc.\nSnort[®] is a registered trademark of Cisco Technology, Inc.\nSuricata[®] is a registered trademark of the Open Information Security Foundation Inc.\nSysinternals[®] is a registered trademark of Microsoft Corporation.\nVolatility[®] is a registered trademark of the Volatility Foundation, Inc.\nZeek[®] is a registered trademark of the International Computer Science Institute.\nYara[®] is a registered trademark of Chronicle Security.\n\n\n-----\n\n### Executive Summary\n\nThe Russian General Staff Main Intelligence Directorate (GRU) 85th Main Special Service Center\n(GTsSS), military unit 26165, is deploying previously undisclosed malware for Linux[®] systems, called\nDrovorub, as part of its cyber espionage operations. GTsSS malicious cyber activity has previously been\nattributed by the private sector using the names Fancy Bear, APT28, Strontium, and a variety of other\nidentifiers. (Department of Justice, 2018) (Washington Post, 2018) (CrowdStrike, 2016) This publication\nprovides background on Drovorub, attribution of its use to the GTsSS, detailed technical information on\nthe Drovorub malware, guidance on how to detect Drovorub on infected systems, and mitigation\nrecommendations. Information in this Cybersecurity Advisory is being disclosed publicly to assist National\nSecurity System owners and the public to counter the capabilities of the GRU, an organization which\ncontinues to threaten the United States and U.S. allies as part of its rogue behavior, including their\ninterference in the 2016 U.S. Presidential Election as described in the 2017 Intelligence Community\nAssessment, Assessing Russian Activities and Intentions in Recent US Elections (Office of the Director of\nNational Intelligence, 2017).\n\nDrovorub is a Linux malware toolset consisting of an implant coupled with a kernel module rootkit, a file\ntransfer and port forwarding tool, and a Command and Control (C2) server. When deployed on a victim\nmachine, the Drovorub implant (client) provides the capability for direct communications with actorcontrolled C2 infrastructure; file download and upload capabilities; execution of arbitrary commands as\n\"root\"; and port forwarding of network traffic to other hosts on the network.\n\nA number of complementary detection techniques effectively identify Drovorub malware activity. However,\nthe Drovorub-kernel module poses a challenge to large-scale detection on the host because it hides\nDrovorub artifacts from tools commonly used for live-response at scale. While packet inspection at\nnetwork boundaries can be used to detect Drovorub on networks, host-based methods include probing,\nsecurity products, live response, memory analysis, and media (disk image) analysis. Specific guidance for\nrunning Volatility[®], probing for file hiding behavior, Snort[®] rules, and Yara[®] rules are all included in the\nDetection section of this advisory.\n\nTo prevent a system from being susceptible to Drovorub’s hiding and persistence, system administrators\nshould update to Linux Kernel 3.7 or later in order to take full advantage of kernel signing enforcement.\nAdditionally, system owners are advised to configure systems to load only modules with a valid digital\nsignature making it more difficult for an actor to introduce a malicious kernel module into the system.\n\n\n-----\n\n### TABLE OF CONTENTS\n##### Russian GRU 85th GTsSS Deploys Previously Undisclosed Drovorub Malware 1 Notices and history .......................................................................................................................ii\n Disclaimer of Warranties and Endorsement .....................................................................................................ii Sources and Methods ...............................................................................................................................................ii Publication Information .................................................................................................................ii\n Purpose ...........................................................................................................................................................................ii Contact Information ....................................................................................................................................................ii Trademark Recognition ............................................................................................................................................ii Executive Summary ......................................................................................................................iii List of Figures ................................................................................................................................ v List of Tables ................................................................................................................................. vi Introduction ................................................................................................................................... 1\n What is Drovorub? ..................................................................................................................................................... 1 Drovorub-server .......................................................................................................................................................... 2 Drovorub-client ............................................................................................................................................................ 2 Drovorub-kernel module .......................................................................................................................................... 2 Drovorub-agent ........................................................................................................................................................... 2 Attribution ...................................................................................................................................... 2\n Why is the malware called “Drovorub”, and what does it mean? ........................................................... 2 Drovorub Technical Details ......................................................................................................... 3\n Drovorub Components Configuration ................................................................................................................ 3\n Drovorub-server Configuration ......................................................................................................................... 3 Drovorub-client Configuration ........................................................................................................................... 3 Drovorub-agent Configuration .......................................................................................................................... 4 Drovorub Implant Operation .................................................................................................................................. 5\n Drovorub-client and Drovorub-kernel module Installation ..................................................................... 5 Linux Kernel Module Persistence ................................................................................................................... 5 Network Communications .................................................................................................................................. 6 Host-based Communications ......................................................................................................................... 27 Evasion .................................................................................................................................................................... 28 Detection ...................................................................................................................................................................... 30\n Detection Methodologies .................................................................................................................................. 30 Memory Analysis with Volatility ...................................................................................................................... 31 Drovorub-kernel Module Detection Method .............................................................................................. 35 Snort Rules ............................................................................................................................................................ 35 Yara Rules .............................................................................................................................................................. 35 Preventative Mitigations ........................................................................................................................................ 37\n Apply Linux Updates .......................................................................................................................................... 37 Prevent Untrusted Kernel Modules .............................................................................................................. 37 Works Cited ................................................................................................................................. 39\n\n\n-----\n\n### List of Figures\n\n##### Figure 1: Drovorub components ............................................................................................................................... 1 Figure 2: Example Drovorub-server configuration file ..................................................................................... 3 Figure 3: Example of the initial Drovorub-client configuration file ............................................................... 4 Figure 4: Example of the Drovorub-client's configuration file with hidden artifacts listed .................. 4 Figure 5: Example initial Drovorub-agent configuration file ........................................................................... 5 Figure 6: Drovorub-agent configuration file after registration with a Drovorub-server ........................ 5 Figure 7: Basic Drovorub JSON payload structure ........................................................................................... 6 Figure 8: WebSocket message structure .............................................................................................................. 7 Figure 9: Initial WebSocket connection and Drovorub authentication session ...................................... 7 Figure 10: HTTP Upgrade request .......................................................................................................................... 8 Figure 11: HTTP 101 Switching Protocols ........................................................................................................... 8 Figure 12: C2 commands for authentication ........................................................................................................ 8 Figure 13: Client \"auth.hello\" authentication request to Drovorub-server ................................................ 9 Figure 14: Drovorub-server \"auth.hello\" response to client authentication request............................. 9 Figure 15: Client \"auth.login\" (\"signin\" mode) ................................................................................................... 10 Figure 16: Manual generation of passphrase and AES-256 key and IV for \"signin\" process ........ 10 Figure 17: Manual generation of the “clientid” value ...................................................................................... 10 Figure 18: Manual generation of the HMAC \"token\" value (“signin” process)...................................... 11 Figure 19: Drovorub-server \"auth.pending\" response ................................................................................... 11 Figure 20: Client \"auth.commit\" message........................................................................................................... 12 Figure 21: Drovorub-server \"auth.passed\" response ..................................................................................... 12 Figure 22: Client \"auth.login\" - \"login\" request .................................................................................................. 12 Figure 23: Manual generation of the HMAC “token” value (“login” process) ........................................ 13 Figure 24: Server \"auth.passed\" response ........................................................................................................ 13 Figure 25: Basic structure of Drovorub communications .............................................................................. 14 Figure 26: Drovorub-server \"ping\" request ......................................................................................................... 14 Figure 27: Drovorub-client or Drovorub-agent \"pong\" response ............................................................... 14 Figure 28: File download sequence ...................................................................................................................... 17 Figure 29: File upload sequence ............................................................................................................................ 17 Figure 30: “transfer_request” ................................................................................................................................... 18 Figure 31: “open” .......................................................................................................................................................... 18 Figure 32: “open_success” ....................................................................................................................................... 18 Figure 33: “read” ........................................................................................................................................................... 18 Figure 34: “read_data” ................................................................................................................................................ 19 Figure 35: “close” .......................................................................................................................................................... 19 Figure 36: \"file_add_request\" .................................................................................................................................. 21 Figure 37: Drovorub-client \"net_list_request\" sent to Drovorub-server .................................................. 21 Figure 38: Drovorub-server “net_list_reply” sent to Drovorub-client ........................................................ 21 Figure 39: Drovorub-server sends an \"open\" action to start a command-line shell on a Drovorub- client ................................................................................................................................................................................... 22 Figure 40: Drovorub-client reports successful opening of command-line shell ................................... 23 Figure 41: Drovorub-server sends a shell command ..................................................................................... 23 Figure 42: Drovorub-client responds with results of the shell command ............................................... 23 Figure 43: Drovorub-server sends a \"close\" action to terminate the shell ............................................. 23 Figure 44: Example “tunnel” setup ........................................................................................................................ 25 Figure 45: \"addtun\" action ......................................................................................................................................... 26 Figure 46: \"open\" action ............................................................................................................................................. 26\n\n\n-----\n\n##### Figure 47: \"open_success\" response ................................................................................................................... 26 Figure 48: \"data\" action .............................................................................................................................................. 27 Figure 49: Volatility command finding the hidden Kernel Module ............................................................. 32 Figure 50: Volatility command to dump the Kernel Module from memory ............................................. 32 Figure 51: Yara rule match ....................................................................................................................................... 32 Figure 52: Volatility “psxview” plugin finding the Drovorub-client .............................................................. 32 Figure 53: Volatility “linux_psaux” plugin finding the Drovorub-client ...................................................... 33 Figure 54: Dumping the “/tmp/dr_client” process from memory ................................................................ 33 Figure 55: Yara match against dumped file from memory ........................................................................... 33 Figure 56: Attributes of the two files dumped from memory ........................................................................ 33 Figure 57: Volatility “linux_lsof” plugin finding a network socket open .................................................... 34 Figure 58: Volatility “linux_netstat” plugin showing network connection information ........................ 34 Figure 59: Example Wireshark display filter ...................................................................................................... 34 Figure 60: Example C2 packet in Wireshark ..................................................................................................... 34 Figure 61: Using the “strings” utility ....................................................................................................................... 35 Figure 62: Using “grep” to search through the strings file ............................................................................ 35 Figure 63: Drovorub-kernel module detection method .................................................................................. 35 Figure 64: Snort Rule #1 ............................................................................................................................................ 35 Figure 65: Snort Rule #2 ............................................................................................................................................ 35 Figure 66: Yara Rule #1 ............................................................................................................................................. 36 Figure 67: Yara Rule #2 ............................................................................................................................................. 36 Figure 68: Yara Rule #3 ............................................................................................................................................. 37 Figure 69: Yara Rule #4 ............................................................................................................................................. 37\n\n### List of Tables\n\n##### Table I: Drovorub components .................................................................................................................................. 1 Table II: Drovorub supported C2 modules ......................................................................................................... 14 Table III: Drovorub “cloud.auth” module actions .............................................................................................. 14 Table IV: Drovorub “cloud.auth” module action parameters ....................................................................... 14 Table V: Drovorub “file” module actions .............................................................................................................. 15 Table VI: Drovorub “file” module action parameters ....................................................................................... 16 Table VII: Drovorub “monitor” module actions .................................................................................................. 19 Table VIII: Drovorub “monitor” module action parameters ........................................................................... 20 Table IX: Drovorub “shell” module actions ......................................................................................................... 22 Table X: Drovorub “shell” module action parameters .................................................................................... 22 Table XI: Drovorub “tunnel” module actions ...................................................................................................... 24 Table XII: Drovorub “tunnel” module action parameters ............................................................................... 24 Table XIII: Kernel module command format ...................................................................................................... 27 Table XIV: Kernel module command types ........................................................................................................ 27 Table XV: Kernel module buffer header data structure ................................................................................. 28 Table XVI: Kernel module command code values .......................................................................................... 28\n\n\n-----\n\n### Introduction\n\n#### What is Drovorub?\n\nDrovorub is a Linux malware toolset consisting of an implant coupled with a kernel module rootkit, a file\ntransfer and port forwarding tool, and a Command and Control (C2) server. When deployed on a victim\nmachine, the Drovorub implant (client) provides the capability for direct communications with actorcontrolled C2 infrastructure (T1071.001[1]); file download and upload capabilities (T1041); execution of\narbitrary commands as \"root\" (T1059.004); and port forwarding of network traffic to other hosts on the\nnetwork (T1090). The kernel module rootkit uses a variety of means to hide itself and the implant on\ninfected devices (T1014), and persists through reboot of an infected machine unless UEFI secure boot is\nenabled in “Full” or “Thorough” mode. Despite this concealment, effective detection techniques and\nmitigation strategies are described below.\n\n**_Figure 1: Drovorub components_**\n\n**_Table I: Drovorub components_**\n\n**Drovorub Component** **Function**\n**Drovorub-client** Implant\n**Drovorub-kernel module** Rootkit\n**Drovorub-agent** Port Forwarding and File Transfer Tool\n**Drovorub-server** Command and Control (C2) Server\n\nThe Drovorub malware suite is comprised of four separate executable components: Drovorub-agent,\nDrovorub-client, Drovorub-server and Drovorub-kernel module. Communication between the components\nis conducted via JSON over WebSockets. (Fette & Melnikov, 2011) The Drovorub-agent, Drovorub-client,\nand Drovorub-server require configuration files and an RSA public key (for the Drovorub-agent and\n\n1 Identification of MITRE® ATT&CK® Technique.\n\n|rub components|Col2|\n|---|---|\n|Drovorub Component Function||\n|Drovorub-client|Implant|\n|Drovorub-kernel module|Rootkit|\n|Drovorub-agent|Port Forwarding and File Transfer Tool|\n|Drovorub-server|Command and Control (C2) Server|\n\n\n-----\n\nDrovorub-client) or private key (for the Drovorub-server) for communication. A brief overview of each\ncomponent is provided below.\n\n#### Drovorub-server\n\nThe Drovorub-server, installed on actor-controlled infrastructure, enables C2 for the Drovorub-client and\nDrovorub-agent. The Drovorub-server uses a MySQL database to manage the connecting Drovorubclient(s) and Drovorub-agent(s). The database stores data used for Drovorub-agent and Drovorub-client\nregistration, authentication, and tasking.\n\n#### Drovorub-client\n\nThe Drovorub-client component is installed on target endpoints by the actor. This component receives\ncommands from its remote Drovorub-server and offers file transfer to/from the victim, port forwarding, and\na remote shell capability. Additionally, the Drovorub-client is packaged with a Drovorub-kernel module\nthat provides rootkit-based stealth functionality to hide the client and kernel module.\n\n#### Drovorub-kernel module\n\nThe Drovorub-kernel module implements the base functionality for hiding itself and various artifacts from\nuser-space, including specified files and directories, network ports and sessions, the Drovorub-client\nprocess, and Drovorub-client child processes.\n\n#### Drovorub-agent\n\nThe Drovorub-agent is likely to be installed on Internet-accessible hosts or actor controlled infrastructure.\nThe Drovorub-agent executable receives commands from its configured Drovorub-server. This\ncomponent includes much of the same functionality as the Drovorub-client, except for the remote shell\ncapability. Additionally, the Drovorub-agent is not packaged with the Drovorub-kernel module rootkit. The\napparent purposes of the Drovorub-agent are: to upload files to and download files from Drovorub-client\nendpoints, and to forward network traffic through port relays.\n\n### Attribution\n\nDrovorub is proprietary malware developed for use by the Russian General Staff Main Intelligence\nDirectorate (GRU) 85th Main Special Service Center (GTsSS), military unit 26165. GTsSS malicious\ncyber activity has previously been attributed by the private sector using the names Fancy Bear, APT28,\nStrontium, and a variety of other identifiers. (Department of Justice, 2018) (Washington Post, 2018)\n(CrowdStrike, 2016)\n\nIn addition to NSA's and FBI's attribution to GTsSS, operational Drovorub command and control\ninfrastructure has been associated with publicly known GTsSS operational cyber infrastructure. For one\nexample, on August 5, 2019, Microsoft Security Response Center published information linking IP\naddress 82.118.242.171 to Strontium infrastructure in connection with the exploitation of Internet of\nThings (IoT) devices in April 2019. (Microsoft Security Response Center, 2019) (Microsoft, 2019) NSA\nand FBI have confirmed that this same IP address was also used to access the Drovorub C2 IP address\n185.86.149.125 in April 2019.\n\n#### Why is the malware called “Drovorub”, and what does it mean? \n\nThe name Drovorub comes from a variety of artifacts discovered in Drovorub files and from operations\nconducted by the GTsSS using this malware; it is the name used by the GTsSS actors themselves. Drovo\n\n[дрово] translates to “firewood”, or “wood”. Rub [руб] translates to \"to fell”, or “to chop.” Taken together,\nthey translate to “woodcutter” or “to split wood.”\n\n\n-----\n\n### Drovorub Technical Details\n\nThe following sections contain technical details of Drovorub, including component functionality and toolset\ninteraction. All IP addresses, ports, crypto keys, transferred files, file paths, and tunneled data used in the\nexamples were generated in a lab environment and should not be assumed to have actually been used\nby the actor. Dates and times contained in the examples were either redacted or modified. Additionally,\nthe JSON examples have newlines and tabs added for readability.\n\n#### Drovorub Components Configuration\n\n**Drovorub-server Configuration**\n\nThe Drovorub-server configuration file is a JSON-formatted text file. It must be present when the\nDrovorub-server executable is launched and its path is provided as a command-line argument. It contains\nthe IP address, port, database name, username, and password for its backend MySQL database. It also\ncontains the path to its private RSA key, its listening host IP address or domain and port, as well as the\ninterval at which to send keep-alive WebSocket \"ping\" messages to connected Drovorub-clients and\nDrovorub-agents. An example Drovorub-server configuration file is shown below. The use of the \"phrase\"\nfield in the configuration file is unknown.\n\n```\n{\n\n```\n```\n\"db_host\"    : \"<DB_IP_ADDR>\",\n\"db_port\"    : \"<DB_PORT>\",\n\"db_db\"     : \"<DB_NAME>\",\n\"db_user\"    : \"<DB_USER>\",\n\"db_password\"  : \"<DB_PASS>\",\n\"lport\"     : \"<LHOST>\",\n\"lhost\"     : \"<LPORT>\", \n\"ping_sec\"   : \"<SEC>\",\n\n```\n```\n                \"priv_key_file\" : \"<PRIVATE_KEY_FILE>\",\n                \"phrase\"    : \"<PHRASE>\"\n            }\n\n```\n**_Figure 2: Example Drovorub-server configuration file_**\n\n**Drovorub-client Configuration**\n\nThe initial configuration for the Drovorub-client is embedded within its executable. It includes the\nDrovorub-server callback URL[2], a username and password, and an RSA public key. Both the\nusername/password pair and the RSA public key are used for authentication with the Drovorub-server.\nUpon successful registration with the Drovorub-server, the Drovorub-client writes a separate configuration\nfile to disk, which will be hidden by the Drovorub-kernel module. This post-installation configuration file is\na JSON-formatted text file. The initial content of the file includes \"id\" and \"key\" values used for the\nDrovorub-client instance's identification and future authentication attempts with the Drovorub-server. See\nthe Network Communications section for details on the Drovorub authentication process. Additional\ncontent in the configuration file is added to persist current hiding of arbitrary kernel modules, network\nports, files, directories, and processes being effected by the Drovorub-kernel module, as well as any\nnetwork port relays that are configured within the target. Below is an example of the contents of an initial\nDrovorub-client configuration file:\n\n2 The URL consists of configurable IP address or domain name, port, and URI.\n\n\n-----\n\n```\n{\n   \"id\" : \"cbcf6abc-466b-11e9-853b-000c29cb9f6f\",\n   \"key\": \"Y2xpZW50a2V5\"\n}\n\n```\n\n**_Figure 3: Example of the initial Drovorub-client configuration file_**\n\nThe value for \"id\" is a 128-bit time-based UUID string that the Drovorub-server generates for the\nDrovorub-client when it connects for the first time. This UUID is generated by the open-source POCO\nC++ libraries, which are statically linked. The final 48 bits (6 bytes) of the UUID are the MAC address of\none of the Drovorub-server’s Ethernet adapters. Therefore, it is expected that the last 6 bytes of the \"id\"\nvalue will be the same for Drovorub-clients and Drovorub-agents that connect to the same Drovorubserver.\n\nThe default \"key\" value is the base64 encoding of the ASCII string \"clientkey\". The ASCII string\n\"clientkey\" is hardcoded in the Drovorub-server binary. The \"key\" value is returned from the Drovorubserver to the client during the initial handshake (See the \"signin\" authentication process described in the\nNetwork Communications section).\n\nBelow is an example of the Drovorub-client's configuration file with some information about hiding of files,\nmodules, and network ports. If the file, module, or network port is currently being hidden by the Drovorubkernel module, the \"active\" field will be set to \"true\". Otherwise, it will be \"false\". For files and modules, the\n\"mask\" field is the name of the file or module that is being hidden. Each file, module, or network port also\nhas an assigned UUID (the \"id\" field) used to keep track of the entry.\n\n```\n{\n   \"id\" : \"6fa41616-aff1-11ea-acd5-000c29283bbc\",\n   \"key\": \"Y2xpZW50a2V5\",\n   \"monitor\" : {\n       \"file\" : [\n          {\n             \"active\" : \"true\",\n             \"id\" : \"d9dc492b-5a32-8e5f-0724-845aa13fff98\",\n             \"mask\" : \"testfile1\"\n          }\n       ],\n       \"module\" : [\n          {\n             \"active\" : \"true\",\n             \"id\" : \"48a5e9d0-74c7-cc17-2966-0ea17a1d997a\",\n             \"mask\" : \"testmodule1\"\n          }\n       ],\n       \"net\" : [\n          {\n             \"active\" : \"true\",\n             \"id\" : \"4f355d5d-9753-76c7-161e-7ef051654a2b\",\n             \"port\" : \"12345\",\n             \"protocol\" : \"tcp\"\n          }\n       ]\n   }\n}\n\n```\n\n**_Figure 4: Example of the Drovorub-client's configuration file with hidden artifacts listed_**\n\n**Drovorub-agent Configuration**\n\nThe Drovorub-agent configuration file is a JSON-formatted text file. It must be present when the\nDrovorub-agent executable is launched and its path is provided as a command-line argument. Initially it\ncontains a callback URL, a username and password, and an RSA public key. Below is an example of an\ninitial Drovorub-agent configuration file:\n\n\n-----\n\n```\n{\n\n```\n```\n                \"client_login\" : \"user123\",\n                \"client_pass\" : \"pass4567\",\n                \"pub_key_file\" : \"public_key\",\n                \"server_host\" : \"192.168.57.100\",\n                \"server_port\" : \"45122\",\n                \"server_uri\"  : \"/ws\"\n            }\n\n```\n**_Figure 5: Example initial Drovorub-agent configuration file_**\n\nOnce the Drovorub-agent has successfully registered with its Drovorub-server for the first time, two\nadditional fields are added to the configuration file: \"clientid\" and \"clientkey_base64\". Just like the\nDrovorub-client's \"id\" value, the Drovorub-agent's \"clientid\" is also a 128-bit UUID string generated by the\nDrovorub-server and sent to the Drovorub-agent during the initial authentication. It is used to identify the\nunique Drovorub-agent instance. The Drovorub-agent's \"clientkey_base64\" is also by default the base64\nencoding of the ASCII string \"clientkey\". Below is an example of a Drovorub-agent configuration file after\nsuccessful connection with its server:\n\n```\n{\n\n```\n```\n        \"client_login\"   : \"user123\",\n        \"client_pass\"   : \"pass4567\",\n        \"clientid\"     : \"e391847c-bae7-11ea-b4bc-000c29130b71\",\n        \"clientkey_base64\" : \"Y2xpZW50a2V5\",\n        \"pub_key_file\"   : \"public_key\",\n        \"server_host\"   : \"192.168.57.100\",\n        \"server_port\"   : \"45122\",\n        \"server_uri\"    : \"/ws\"\n     }\n\n```\n**_Figure 6: Drovorub-agent configuration file after registration with a Drovorub-server_**\n\n#### Drovorub Implant Operation\n\n**Drovorub-client and Drovorub-kernel module Installation**\n\nWhen the Drovorub-client and Drovorub-kernel module are installed and executed, the following setup\nactivities are performed:\n\n  - the Drovorub-kernel module sets up all the system call hooks that are needed for its rootkit\nfunctionality (see the Evasion section for more details)\n\n  - the Drovorub-client registers itself with the Drovorub-kernel module (see the Host-based\nCommunications section for how the Drovorub-client and Drovorub-kernel module communicate)\n\n  - the Drovorub-kernel module hides the Drovorub-client's running processes and the Drovorubclient's executable on disk (see the Evasion section for more details)\n\nIf the Drovorub-client is unable to communicate with the Drovorub-kernel module, it will stop execution.\nOnce the Drovorub-client and Drovorub-kernel module have completed their setup activities, the\nDrovorub-client will attempt to authenticate with its configured Drovorub-server. Once it has successfully\nregistered with the Drovorub-server, the Drovorub-client immediately requests lists of any additional files,\nmodules, or network ports to hide and then waits for commands from the Drovorub-server.\n\n**Linux Kernel Module Persistence**\n\nThe GTsSS cyber program uses a wide variety of proprietary and publicly known techniques to gain\naccess to target networks and to persist their malware on compromised devices.\n\nIndependent of a specific cyber actor or toolkit, kernel modules can persist using capabilities built into\nLinux for loading kernel modules on boot. On Red Hat[®] based distributions this could include, but is not\nlimited to, placing a .modules executable script within /etc/sysconfig/modules/, adding the kernel module\n\n\n-----\n\nto /etc/modules.conf, or placing a .conf file within /etc/modules-load.d/. On Debian based distributions this\ncould include but is not limited to adding the kernel module to /etc/modules, or placing a .conf file within\n/etc/modules-load.d/. Kernel modules typically reside within\n/lib/modules/<KERNEL_RELEASE>/kernel/drivers/, where <KERNEL_RELEASE> is the Linux kernel\nrelease of the target machine. (Configuring the System > Priming the kernel, 2016)\n\n**Network Communications**\n\n_Overview_\nAll network communication between the Drovorub components (i.e. client, agent, and server) uses the\nWebSocket protocol implemented in the publically available POCO C++ library that is statically linked into\neach component. The WebSocket protocol, defined in RFC 6455, is an application layer protocol that\nruns over TCP and consists of an initial handshake followed by message frames for data transfer.\nDrovorub can be configured to use non-standard TCP ports for WebSocket communication. All Drovorub\nnetwork communications pass through a Drovorub-server. Drovorub-clients and Drovorub-agents do not\ntalk directly to each other, but communicate through the Drovorub-server. This means that Drovorubclients and Drovorub-agents can only communicate with other clients and agents who are connected to\nthe same Drovorub-server.\n\nDrovorub uses JSON as the message format for its WebSocket payloads. All Drovorub JSON payloads\nhave the basic structure shown in Figure 7 below. The payload is a single JSON object that contains one\nmember named “children” whose value is an array of JSON objects. The actual ordering of the JSON\nobjects within the “children” array may differ from what is shown below. Each object in the “children” array\nalways contains two members named “name” and “value”. The value of the “value” member is always\nbase64 encoded in each object, with one exception that is detailed in the Command Tasking section.\nEvery Drovorub JSON payload will contain a minimum of two objects in the “children” array. Those\nobjects have the “name” member values “module” and “action”. The “module” and “action” objects denote,\nin general, a specific C2 command or response. Additional JSON objects, denoted by the “…”, represent\nthe potential parameters associated with the specific “module” and “action” listed. Drovorub C2\ncommands are further discussed in the Command Tasking section. This format of the payload applies to\nall network communications between the Drovorub components.\n\n```\n{\"children\":\n   [\n       {\"name\":\"module\",\"value\":\"<BASE64 VALUE>\"},\n       {\"name\":\"action\",\"value\":\"<BASE64 VALUE>\"},\n       ...\n   ]\n}\n\n```\n\n**_Figure 7: Basic Drovorub JSON payload structure_**\n\nOf particular importance, the WebSocket protocol implements a feature called \"masking\"[3] that affects how\ntraffic appears on the network. Per RFC 6455, every WebSocket client message sent to a WebSocket\nserver is XOR \"masked\" with a random 4-byte value that is unique for each message. The XOR value is\npassed in the message frame header so the payload data can be de-obfuscated by the WebSocket\nserver. WebSocket server-to-client traffic is not XOR \"masked\". In the case of Drovorub, Drovorubservers act as WebSocket servers while Drovorub-clients and Drovorub-agents act as WebSocket clients.\nTherefore, all traffic sent from a Drovorub-server to a Drovorub-client or Drovorub-agent will be readable\nas plaintext JSON messages, whereas traffic to the Drovorub-server will appear to be random data\nbecause of the XOR masking. The following diagram, taken from RFC 6455, shows the structure of a\nWebSocket message frame. (Fette & Melnikov, 2011)\n\n3 See RFC 6455 “The WebSocket Protocol” for more details on client-to-server “masking”.\n\n\n-----\n\n**_Figure 8: WebSocket message structure_**\n\nIn WebSocket client-to-server messages, the mask bit is set to 1 and the 4-byte XOR value is contained\nin the “Masking-key” field. The payload data, which in this case is the JSON, will be XOR'd with the\nmasking key. Each new masked message contains a new 4-byte masking key value, which will be used\nto obfuscate and deobfuscate the payload data. For WebSocket server-to-client messages, the mask bit\nis set to 0 and no XOR masking is performed. Figure 9, below, shows the \"Follow TCP Stream\" view of an\ninitial WebSocket connection and Drovorub authentication session that illustrates client-to-server\n\"masking\". The client-to-server traffic (red text) appears to be unrecognizable while the server-to-client\ntraffic (blue text) is plaintext JSON. The client-to-server traffic has been \"masked\" per RFC 6455. (Fette &\nMelnikov, 2011)\n\n**_Figure 9: Initial WebSocket connection and Drovorub authentication session_**\n\n_Authentication_\nThe following is a description of the process used by both the Drovorub-client and Drovorub-agent to\nconnect and authenticate to the Drovorub-server. In this description, the term “client” will be used to refer\nto either the Drovorub-client or Drovorub-agent unless otherwise specified, as both follow the same\nprocess.\n\n\n-----\n\nThe client initiates communication with the Drovorub-server by first establishing a WebSocket connection\nvia an HTTP Upgrade request, as shown in Figure 10, below. For the Drovorub-client, the Drovorubserver IP address and port information is embedded within the executable, whereas for the Drovorubagent, it is contained the Drovorub-agent's configuration file.\n\n```\nGET /ws HTTP/1.0\nConnection: Upgrade\nHost: 192.168.1.2:12345\nSec-WebSocket-Key: Ui/SCrtEKS/BaslV9vSMUw==\nSec-WebSocket-Version: 13\nUpgrade: websocket\n\n```\n\n**_Figure 10: HTTP Upgrade request_**\n\nThe Drovorub-server responds with a HTTP 101 Switching Protocols response, as shown in Figure 11,\nbelow.\n\n```\nHTTP/1.0 101 Switching Protocols\nConnection: Upgrade\nContent-Length: 0\nDate: Thu, 05 Nov 2020 13:07:00 GMT\nSec-WebSocket-Accept: SeoYykqncmS/fWcGFIHcv3AR26k=\nUpgrade: websocket\n\n```\n\n**_Figure 11: HTTP 101 Switching Protocols_**\n\nDetails about how WebSocket clients and servers verify the connection during the WebSocket handshake\nprocess can be found in RFC 6455 and are not discussed here. (Fette & Melnikov, 2011)\n\nOnce the client establishes a WebSocket connection, it attempts to authenticate with the Drovorubserver. There are two processes for Drovorub authentication: “signin” and “login”. The “signin” process is\nused to register a client for the first time with a Drovorub-server. The “login” process is used for\nsubsequent authentication attempts after a client has already registered itself with a Drovorub-server. The\nbelow diagram depicts the C2 commands used during the authentication process for both “signin” and\n“login”.\n\n**_Figure 12: C2 commands for authentication_**\n\nBoth processes begin with an authentication request from the client to the Drovorub-server, as shown in\nthe example below (before WebSocket “masking”). The \"module\" used for Drovorub authentication is\n\"Y2xvdWQuYXV0aA==\" which decodes to \"cloud.auth\". The request contains an “action” object with a\n\n\n-----\n\n“value” member that base64 decodes to “auth.hello”. The “auth.hello” action takes one parameter, a\n“token” object. The token is a randomly generated 16 byte value that is encrypted with the client’s RSA\npublic key and then base64 encoded. (NOTE: The “token” value contains carriage returns and newline\ncharacters “\\r\\n”. The Drovorub-server will remove these characters before base64 decoding the “token”.)\n\n```\n{\"children\":\n  [\n    {\"name\":\"module\",\"value\":\"Y2xvdWQuYXV0aA==\"},\n    {\"name\":\"action\",\"value\":\"YXV0aC5oZWxsbw==\"},\n    {\"name\":\"token\",\"value\":\"AIzX7mWtXtkJOBPeiVtC/0Nyofzgs+GZjZbwi0dd\n    8Ak6/RtktfYjUltekzJXNt+CrGvG+ClA\\r\\n7Hmq772qrvUUjI/8g9MlDRN8vy+ZB\n    cclCSv6KtBZ1+nxV285tquowBIEsEiYGX+ULzdhaG3I\\r\\nvHO/R8Me5xQqkRoS51\n    LadZUY8SzEZ/0Eyg5Dtcu9ESzA3mldahqt0gVNExpcr7RfcrlDcfC2\\r\\nkdEzvck\n    IlSDaHbcVT3y9GAp6IUgpmZuSFBkgXHfslUFmNvoAl/Tl5qFzi40woEU2f9kC6JWJ\n    \\r\\n3zCBj+dvCL/oyaoXu7qBOf5hm32/ZjYP+N9AXJI0Jj8zLVb/rjiKoA==\"}\n  ]\n}\n\n```\n\n**_Figure 13: Client \"auth.hello\" authentication request to Drovorub-server_**\n\nWhen the Drovorub-server receives the authentication request, it decrypts the “token” value with the\ncorresponding RSA private key. To prove it successfully decrypted the token, the Drovorub-server\ngenerates a “serverid”. The \"serverid\" is produced by first generating a random 16 byte value, appending\nthe decrypted client token, and then generating a SHA1 digest of the byte values. The random 16 byte\nvalue generated by the Drovorub-server is used as its \"token\" in its response to the client. The Drovorubserver builds an “auth.hello” message with the “serverid” and its unencrypted token and sends it to the\nclient. (NOTE: The Drovorub-server's token is not encrypted as it will be used by the client to generate the\nsame \"serverid\", essentially proving the Drovorub-server decrypted the client token value.) An example of\nthe Drovorub-server response to a client authentication request is shown below.\n\n```\n{\"children\":\n  [\n    {\"name\":\"module\",\"value\":\"Y2xvdWQuYXV0aA==\"},\n    {\"name\":\"action\",\"value\":\"YXV0aC5oZWxsbw==\"},\n    {\"name\":\"serverid\",\"value\":\"6EJKTebFfyODBcBqM+JBVCwJkoM=\"},\n    {\"name\":\"token\",\"value\":\"+ynYaT4H/8N+EbEx59kDlg==\"}\n  ]\n}\n\n```\n\n**_Figure 14: Drovorub-server \"auth.hello\" response to client authentication request_**\n\nThe client then verifies the “serverid” value is valid by doing its own calculation of this value given the\nDrovorub-server’s token from the response message. If the “serverid” values match, the client continues\nwith the authentication process.\n\nOnce, the “serverid” is validated, the client sends an “auth.login” (YXV0aC5sb2dpbg==) message\nspecifying whether it wants to “signin” (c2lnbmlu) or “login” (bG9naW4=) to the Drovorub-server. This is\ndenoted by the “mode” value in the client’s request. The “auth.login” message requires two parameters, a\n“clientid” and a “token”. These values are essentially a username and password, respectively, which are\nprovided to the Drovorub-server to login. The “clientid” and “token” values are different for the “signin” and\n“login” process. Details about these values are presented in the following sections.\n\n_Client \"signin\" Process_\n\nThe following figure is an example of an “auth.login” message for “signin” authentication.\n\n\n-----\n\n```\n{\"children\":\n  [\n    {\"name\":\"module\",\"value\":\"Y2xvdWQuYXV0aA==\"},\n    {\"name\":\"action\",\"value\":\"YXV0aC5sb2dpbg==\"},\n    {\"name\":\"mode\",\"value\":\"c2lnbmlu\"},\n    {\"name\":\"clientid\",\"value\":\"FUegGfcIMH53hGX31fZuQg==\"},\n    {\"name\":\"token\",\"value\":\"WAKDUg4GCbPZTyea12NqnQ==\"}\n  ]\n}\n\n```\n\n**_Figure 15: Client \"auth.login\" (\"signin\" mode)_**\n\nThe \"signin\" process is executed if the client is authenticating with the Drovorub-server for the first time,\nmeaning the \"id\" and \"key\" values (in the case of the Drovorub-client), or the \"clientid\" and\n\"clientkey_base64\" values (in the case of a Drovorub-agent) are not present in its configuration file.\nDuring \"signin\", the client authenticates to the Drovorub-server by providing the credentials the Drovorubserver has stored in its MySQL database. The Drovorub-client and Drovorub-agent store these\ncredentials in different places. The Drovorub-client has the credentials embedded in itself, whereas the\nDrovorub-agent stores the credentials in its configuration file. The username and password are referred to\nas \"client_login\" and \"client_pass\", respectively.\n\nPrior to providing the credentials to the Drovorub-server, the client first encrypts the \"client_login\" value\nwith an AES-256 (CBC mode) key and initialization vector (IV). To build the key and IV, a passphrase is\nused that can be generated by both the Drovorub-server and the connecting client. It is the SHA1 digest\nof the \"serverid\" concatenated with the client's decrypted token from the \"auth.hello\" messages. The\ngenerated passphrase is then used to create the AES-256 key and IV. An example of how to manually\ngenerate the passphrase and AES-256 key and IV is shown below.\n\n\n1. Assume the \"serverid\" and decrypted client \"token\" values are as follows:\n\na. \"serverid\" value (hex): `e8424a4de6c57f238305c06a33e241542c099283`\nb. client “token” value (hex): `d6c08982dc56bdb63d8603a44c73a2b0`\n2. Generate the passphrase: `sha1sum(serverid + client token)`\n\na. “ [echo -n \"e8424a4de6c57f238305c06a33e241542c099283d6c08982dc56bdb63d8603a44c73a2b0\" ]\n```\n       | xxd -r -p | openssl dgst -sha1 -binary | xxd\n\n```\nb. Passphrase (hex) = `5f3f954dd33ae5ac6e19038cf3797754f5a94375`\n3. Use the passphrase to generate the AES-256 key and IV.\n\n\na. `echo -n \"5f3f954dd33ae5ac6e19038cf3797754f5a94375\" | xxd -r -p | openssl aes-256-`\n```\n       cbc -pass stdin -nosalt -P -md md5\n\n```\nb. **Key =** `330af64e5df4bf442564910664a5fe8b7a114a02e315d1ea28c78d6874903965`\nc. **IV =** `dda34761124699ee2c58c8af62218262`\n**_Figure 16: Manual generation of passphrase and AES-256 key and IV for \"signin\" process_**\n\nThe \"client_login\" value is then encrypted with the AES-256 key and IV and used as the \"clientid\" value in\nthe client's “auth.login” message. The following example shows how to manually generate the \"clientid\"\nshown in Figure 16 above.\n\n\n1. Assume the \"client_login\" value is as follows:\n\na. \"client_login\": `user123`\n2. Encrypt the \"client_login value with the AES-256 key and IV:\n\na. `echo -n \"user123\" | openssl enc -aes256 -e -K`\n```\n       330af64e5df4bf442564910664a5fe8b7a114a02e315d1ea28c78d6874903965 -iv\n       dda34761124699ee2c58c8af62218262 | base64\n\n```\nb. **\"clientid\":** `FUegGfcIMH53hGX31fZuQg== (same value as seen in Figure 15 above)`\n\n\n**_Figure 17: Manual generation of the “clientid” value_**\n\nThe client’s password for the \"signin\" process is never sent across the network. Instead, the client sends\na keyed-hash message authentication code (HMAC). To generate the HMAC, the client retrieves its\n\"client_pass\" value and uses this value as an HMAC key. To fully generate the HMAC, the client uses the\n\"serverid\" as the text value that is hashed. The client passes both the HMAC key and \"serverid\" to the\nPOCO library's HMAC-MD5 engine to generate the HMAC value. The HMAC value is base64 encoded\n\n\n-----\n\nand used as the \"token\" value in the “auth.login” message. The following example shows how to manually\ngenerate the HMAC \"token\" value seen in Figure 17 above.\n\n\n1. Assume the \"client_pass\" and the \"serverid\" values are as follows:\n\na. \"client_pass\": `pass4567`\nb. \"serverid\" (hex): `e8424a4de6c57f238305c06a33e241542c099283`\n2. Generate the HMAC:\n\na. `echo -n \" e8424a4de6c57f238305c06a33e241542c099283\" | xxd -r -p | openssl dgst -md5`\n```\n       -hmac pass4567 -binary | base64\n\n```\nb. **\"token\":** `WAKDUg4GCbPZTyea12NqnQ== (same value as seen in Figure 15 above)`\n\n\n**_Figure 18: Manual generation of the HMAC \"token\" value (“signin” process)_**\n\nThe client then builds its “auth.login” (mode = \"signin\") message and sends it to the Drovorub-server, as\nshown in the example at the beginning of this section. To reiterate, the \"clientid\" is the AES encrypted\n\"client_login\" value and the \"token\" is an HMAC of the \"serverid\" value using the \"client_pass\" value as\nthe key.\n\nThe Drovorub-server then parses the client's \"auth.login\" request and determines if the \"signin\" table or\nthe \"login\" table will be queried by checking the \"mode\" value specified. If the client is requesting to\n\"signin\", the Drovorub-server decrypts the \"clientid\" using the same AES-256 key and IV that was\ngenerated by the client. The Drovorub-server is able to generate the same AES-256 key and IV because\nthe \"serverid\" and decrypted client \"token\" from the initial \"auth.hello\" messages are known by both the\nDrovorub-server and the client. The decrypted \"clientid\" is the plaintext username stored in the \"signin\"\ntable in the Drovorub-server's MySQL database.\n\nThe Drovorub-server then logs into its MySQL database and queries for the password corresponding to\nthe decrypted \"clientid\" sent by the client. The returned password is then used as a key to generate an\nHMAC over the \"serverid\". The Drovorub-server compares this HMAC to the one sent by the client in the\n“auth.login” message. If these values match, the Drovorub-server uses the POCO UUIDGenerator library\nto generate a unique UUID for the authenticating client. The Drovorub-server then formulates an\n“auth.pending” (YXV0aC5wZW5kaW5n) message, like the one shown in the example below.\n\n```\n{\"children\":\n  [\n    {\"name\":\"module\",\"value\":\"Y2xvdWQuYXV0aA==\"},\n    {\"name\":\"action\",\"value\":\"YXV0aC5wZW5kaW5n\"},\n    {\"name\":\"clientid\",\"value\":\"D7MSQ8AJxrZxxd3GCNYK+cs7rp1Ebcs\n    dI1Sb3SlZjSy5Ayyi1BI7Xw32KCqjs0pe\"},\n    {\"name\":\"clientkey\",\"value\":\"PMC3eUxbK9TkZ6ofyV8HyUNj5jVNAG\n    HUA9Qbu3RUYmI=\"}\n  ]\n}\n\n```\n\n**_Figure 19: Drovorub-server \"auth.pending\" response_**\n\nThe \"clientid\" value is the UUID generated by the Drovorub-server and is encrypted using the same AES256 key and IV. The \"clientkey\" value is the hard-coded constant string \"clientkey\" that is first hex\nencoded and then encrypted with the same AES-256 key and IV.\n\nThe client parses the Drovorub-server's \"auth.pending\" message and stores the \"clientid\" and the\n\"clientkey\" values in its existing configuration file. The \"clientid\" value is decrypted before being stored in\nthe configuration file. Likewise, the \"clientkey\" value is also decrypted, but instead is stored as a base64\nencoded string in the configuration file. For the Drovorub-client, these values are stored in the fields\nnamed \"id\" and \"key\", whereas for the Drovorub-agent these values are stored in the fields named\n\"clientid\" and \"clientkey_base64\". These values are used for any future authentication attempts to the\nDrovorub-server, in which case the \"login\" process described in the next section is used.\n\n\n-----\n\nNext, the client responds to the Drovorub-server with an \"auth.commit\" message, indicating a successful\nwrite to its configuration file. The Drovorub-server parses the client's response looking for a module value\nof \"cloud.auth\" (Y2xvdWQuYXV0aA==) and an action value of \"auth.commit\" (YXV0aC5jb21taXQ=). If\nboth of these values are received, the client is registered in the Drovorub-server's MySQL database. The\nvalues entered into the database are the generated UUID, the base64 encoded string \"clientkey\", and an\n\"accountid\", which is likely used to differentiate between a Drovorub-client and a Drovorub-agent. Finally,\nthe Drovorub-server responds to the client with an \"auth.passed\" (YXV0aC5wYXNzZWQ=) message, as\nshown in the example below. The client has now successfully authenticated and registered itself for the\nfirst time with the Drovorub-server and is ready for tasking.\n\n```\n{\"children\":\n   [\n       {\"name\":\"module\",\"value\":\"Y2xvdWQuYXV0aA==\"},\n       {\"name\":\"action\",\"value\":\"YXV0aC5jb21taXQ=\"}\n   ]\n}\n\n```\n\n**_Figure 20: Client \"auth.commit\" message_**\n\n```\n{\"children\":\n   [\n       {\"name\":\"module\",\"value\":\"Y2xvdWQuYXV0aA==\"},\n       {\"name\":\"action\",\"value\":\"YXV0aC5wYXNzZWQ=\"}\n   ]\n}\n\n```\n\n**_Figure 21: Drovorub-server \"auth.passed\" response_**\n\n_Client \"login\" Process_\n\nThe following is an example of an “auth.login” message for “login” authentication.\n\n```\n{\"children\":\n  [\n    {\"name\":\"module\",\"value\":\"Y2xvdWQuYXV0aA==\"},\n    {\"name\":\"action\",\"value\":\"YXV0aC5sb2dpbg==\"},\n    {\"name\":\"mode\",\"value\":\"bG9naW4=\"},\n    {\"name\":\"clientid\",\"value\":\"4h0fm4AffQntf0O7hhdhIlZUmbZvsk3\n    1jU08OwgomXsVf+HIKaPWpWwcYJ9cS493\"},\n    {\"name\":\"token\",\"value\":\"axCTGMUnr2v9FhRQmf2wYQ==\"}\n  ]\n}\n\n```\n\n**_Figure 22: Client \"auth.login\" - \"login\" request_**\n\nThe client follows the \"login\" process for authentication if it has previously registered itself with the\nDrovorub-server. For a registered Drovorub-client, its configuration file contains \"id\" and \"key\" entries,\nwhereas for a registered Drovorub-agent, its configuration file contains \"clientid\" and \"clientkey_base64\"\nentries. The client uses these values from its configuration file to authenticate with the Drovorub-server.\n\nPrior to sending the authentication request, the client first generates an AES-256 key and IV. This is done\nin the same manner as described in the \"signin\" process. First, the client generates a SHA1 digest of the\n\"serverid\" concatenated with the decrypted client \"token\" sent in the initial \"auth.hello\" messages. Then\nthe client generates the AES-256 key and IV using the SHA1 digest as the passphrase. Finally, the client\nencrypts the “id” (Drovorub-client) or \"clientid” (Drovorub-agent) value from its configuration file with that\nAES-256 key and IV and then base64 encodes it. This value is used as the “clientid” in the “auth.login”\nmessage. (NOTE: This AES-256 key and IV are different from the ones generated during the \"signin\"\nprocess and will be unique each time a client authenticates with the Drovorub-server. This is because the\nDrovorub-server generates a new random 16 byte value to build the \"serverid\" each time, which is then\nused to create the passphrase needed to generate the AES-256 key and IV.)\n\n\n-----\n\nThe “key” (Drovorub-client) or “clientkey_base64” (Drovorub-agent) value from the client’s configuration\nfile is used to build the “token” value in the “auth.login” message. Just like the “token” in the “signin”\nprocess, this “token” value is also an HMAC. To generate the HMAC, the \"key\" (or \"clientkey_base64\")\nvalue is retrieved and base64 decoded. The decoded value is then hex encoded and returned as a string.\nThis returned string value is then hex encoded again and used as the HMAC key. To fully generate the\nHMAC, the \"serverid\" from the server's \"auth.hello\" message is used as the text value that is hashed.\nBoth the HMAC key and \"serverid\" are passed to the POCO library's HMAC MD5 engine to generate the\nHMAC value. Once the HMAC is generated, it is base64 encoded. The following table shows how to\nmanually generate the HMAC “token” value seen in Figure 22 above.\n\n\n1. Assume the client's \"key\" (or “clientkey_base64”) value in its configuration file and the \"serverid\" are as follows:\n\na. \"key\": `Y2xpZW50a2V5`\nb. \"serverid\": a541a27adf5673d53ff2db8adc7608b071fbcd31\n2. Base64 decode the \"key\" value\n\na. `echo -n \"Y2xpZW50a2V5\" | base64 -d`\nb. Result: `clientkey`\n3. Hex encode \"clientkey\"\n\na. `echo -n \"Y2xpZW50a2V5\" | base64 -d | xxd`\nb. Result: `636c69656e746b6579`\n4. Hex encode \"636c69656e746b6579\"\n\na. `echo -n \"636c69656e746b6579\" | xxd`\nb. HMAC key: 363336633639363536653734366236353739\n5. Generate the HMAC\n\na. `echo -n 9a8b64bcb7156e49f7b82087d3fbabaae18013aa | xxd -r -p | openssl dgst -md5 -`\n```\n       mac HMAC -macopt hexkey:363336633639363536653734366236353739 -binary | base64\n\n```\nb. **HMAC value (base64):** `axCTGMUnr2v9FhRQmf2wYQ== (same value as seen in Figure 22 above)`\n\n\n**_Figure 23: Manual generation of the HMAC “token” value (“login” process)_**\n\nThe Drovorub-server parses the client's “auth.login” message and decrypts the \"clientid\" using the same\nAES-256 key and IV the client used to encrypt the value. Again, the Drovorub-server is able to generate\nthe same AES-256 key and IV because the \"serverid\" and decrypted client \"token\" from the \"auth.hello\"\nmessages are known by both the Drovorub-server and the client. Using the decrypted \"clientid\", the\nDrovorub-server queries its MySQL database and retrieves the corresponding \"clientkey\" (i.e. password)\nfor the authenticating client. The Drovorub-server then performs the same HMAC MD5 operation on the\n\"clientkey\" to generate an HMAC value. If the Drovorub-server's generated HMAC matches the client's\nHMAC in the \"token\" field of the \"auth.login\" message, the Drovorub-client is authenticated and the\nDrovorub-server responds with an \"auth.passed\" message. The Drovorub-client has now successfully\nlogged into the Drovorub-server and is ready for tasking.\n\n```\n{\"children\":\n   [\n       {\"name\":\"module\",\"value\":\"Y2xvdWQuYXV0aA==\"},\n       {\"name\":\"action\",\"value\":\"YXV0aC5wYXNzZWQ=\"}\n   ]\n}\n\n```\n\n**_Figure 24: Server \"auth.passed\" response_**\n\n_Command Tasking_\nAs mentioned previously, all Drovorub C2 communications have the basic form shown in the figure below,\nalthough the order of the JSON objects within the “children” array may differ slightly for different C2\ncommands. One exception to this structure is a periodic \"ping\"/\"pong\" keep-alive check. Again, this\nstructure applies to all communications to and from the Drovorub-server, Drovorub-client, and Drovorubagent. C2 tasks are grouped into modules based on apparent function, with each module supporting\nvarious \"action\" values, which are the C2 commands and responses.\n\n\n-----\n\n```\n{\"children\":\n   [\n       {\"name\":\"module\",\"value\":\"<BASE64_VALUE>\"},\n       {\"name\":\"action\",\"value\":\"<BASE64_VALUE>\"},\n      ...\n   ]\n}\n\n```\n\n**_Figure 25: Basic structure of Drovorub communications_**\n\nThe following figures show the structure of the \"ping\" requests from the Drovorub-server and the \"pong\"\nresponse from either a Drovorub-client or Drovorub-agent. Both are sent in plaintext, but the \"pong\"\nresponses will be masked via RFC 6455. The interval at which the keep-alive checks are sent is defined\nin the Drovorub-server's configuration file.\n```\n              {\"ping\":\"ping\"}\n\n```\n**_Figure 26: Drovorub-server \"ping\" request_**\n```\n           {\"pong\":\"pong\"}\n\n```\n**_Figure 27: Drovorub-client or Drovorub-agent \"pong\" response_**\n\nThe following table shows supported C2 modules for the Drovorub-server, Drovorub-client, and Drovorubagent.\n\n**_Table II: Drovorub supported C2 modules_**\n\n**Module** **Module (Base64)** **Description**\n**cloud.auth** Y2xvdWQuYXV0aA== Authentication module\n**file** ZmlsZQ== File transfer module (upload/download)\n**monitor** bW9uaXRvcg== Rootkit artifact hiding module (not supported by\n**Drovorub-agent)**\n**shell** c2hlbGw= Remote shell module (not supported by Drovorub**agent)**\n**tunnel** dHVubmVs Port forwarding module\n\n_\"cloud.auth\" module_\n\nThe \"cloud.auth\" module is used for authentication of Drovorub-clients and Drovorub-agents with the\nDrovorub-server. See the Authentication section above for further details on this module. The following\ntable shows the supported actions for \"cloud.auth\" as well as the possible parameters associated with\nthose actions.\n\n**_Table III: Drovorub “cloud.auth” module actions_**\n\n**Action** **Action (Base64)** **Parameters supported**\n**auth.hello** YXV0aC5oZWxsbw== clientid, serverid, token\n**auth.login** YXV0aC5sb2dpbg== mode, clientid, token\n**auth.failed** YXV0aC5mYWlsZWQ= Clientid\n**auth.pending** YXV0aC5wZW5kaW5n clientid, clientkey\n**auth.passed** YXV0aC5wYXNzZWQ= None\n\n**_Table IV: Drovorub “cloud.auth” module action parameters_**\n\n|e II: Drovorub supported C2 modules|Col2|Col3|\n|---|---|---|\n|Module Module (Base64) Description|||\n|cloud.auth|Y2xvdWQuYXV0aA==|Authentication module|\n|file|ZmlsZQ==|File transfer module (upload/download)|\n|monitor|bW9uaXRvcg==|Rootkit artifact hiding module (not supported by Drovorub-agent)|\n|shell|c2hlbGw=|Remote shell module (not supported by Drovorub- agent)|\n|tunnel|dHVubmVs|Port forwarding module|\n\n|ub “cloud.auth” module actions|Col2|Col3|\n|---|---|---|\n|Action Action (Base64) Parameters supported|||\n|auth.hello|YXV0aC5oZWxsbw==|clientid, serverid, token|\n|auth.login|YXV0aC5sb2dpbg==|mode, clientid, token|\n|auth.failed|YXV0aC5mYWlsZWQ=|Clientid|\n|auth.pending|YXV0aC5wZW5kaW5n|clientid, clientkey|\n|auth.passed|YXV0aC5wYXNzZWQ=|None|\n\n|ub “cloud.auth” module action parameters|Col2|Col3|\n|---|---|---|\n|Parameter Name Parameter Value Parameter Value (Base64)|||\n|clientid|<variable>|<variable>|\n|clientkey|clientkey|Y2xpZW50a2V5|\n|mode|signin|c2lnbmlu|\n\n\n-----\n\n|Parameter Name Parameter Value Parameter Value (Base64)|Col2|Col3|\n|---|---|---|\n||login|bG9naW4=|\n|serverid|<variable>|<variable>|\n|token|<variable>|<variable>|\n\n\n_\"file\" module_\n\nThe \"file\" module is used for file transfer. Files can be uploaded to and downloaded from Drovorub-clients\nonly, by either other Drovorub-clients or Drovorub-agents.\n\nThe following tables show the actions and their supported parameters for the \"file\" module. All actions\ninclude at a minimum a \"session_id\", \"src_id\", and \"dst_id\" to keep track of the current file transfer\nsession. Except for \"transfer_request\" actions, the \"src_id\" is usually the sender of the action while\n\"dst_id\" is the receiver of the action. For \"transfer_request\" actions, a Drovorub-server is the sender of the\naction and the \"src_id\" is the receiver, which is either a Drovorub-agent or Drovorub-client.\n\n**_Table V: Drovorub “file” module actions_**\n\n|Table V: Drovorub “file” module actions|Col2|Col3|Col4|\n|---|---|---|---|\n|Action Action (Base64) Parameters Description Supported||||\n|transfer_request|dHJhbnNmZXJfcmVxdWVzdA==|session_id, src_id, dst_id, local_path, remote_id, remote_path, mode|Initiate a file transfer; “mode” is either “upload” or “download”; “remote_id” and “remote_path” specify the client or agent UUID and the path to which a file is being uploaded to or downloaded from; the command is sent from a Drovorub- server to \"src_id\"|\n|transfer_status|dHJhbnNmZXJfc3RhdHVz|session_id, src_id, dst_id, status, progress, reason|Status and progress of file transfer|\n|transfer_abort|dHJhbnNmZXJfYWJvcnQ=|session_id, src_id, dst_id|Abort the file transfer|\n|open|b3Blbg==|session_id, path, mode, src_id, dst_id|Open the given file (\"path\") for either reading (download) or writing (upload) based on the access mode (\"mode\" = \"r\" or \"w\"); (NOTE: If a Drovorub-agent is the receiver of this command (\"dst_id\"), it always responds back with \"open_fail\")|\n\n\n-----\n\n|Action Action (Base64) Parameters Description Supported|Col2|Col3|Col4|\n|---|---|---|---|\n|open_success|b3Blbl9zdWNjZXNz|session_id, src_id, dst_id, size|Report successful open or creation of a file|\n|open_fail|b3Blbl9mYWls|session_id, src_id, dst_id, reason|Report an error opening or creating a file|\n|read|cmVhZA==|session_id, src_id, dst_id|Start file download|\n|read_fail|cmVhZF9mYWls|session_id, src_id, dst_id, reason|Report an error during file download|\n|read_data|cmVhZF9kYXRh|session_id, src_id, dst_id, offset, data|Sending file data (for file downloads)|\n|write|d3JpdGU=|session_id, src_id, dst_id, offset, data|Sending file data (for file uploads)|\n|write_fail|d3JpdGVfZmFpbA==|session_id, src_id, dst_id, reason|Report an error during file upload|\n|close|Y2xvc2U=|session_id, src_id, dst_id, status|Close the file (end of file transfer)|\n\n\n**_Table VI: Drovorub “file” module action parameters_**\n\n|Table VI: Drovorub “file” module action parameters|Col2|Col3|Col4|\n|---|---|---|---|\n|Parameter Name Parameter Parameter Description Value(s) Value(s) (Base64)||||\n|session_id|<variable>|<variable>|A unique UUID to track the file transfer session|\n|src_id|<variable>|<variable>|The UUID of the sender of the command|\n|dst_id|<variable>|<variable>|The UUID of the receiver of the command|\n|local_path|<variable>|<variable>|A file path|\n|remote_id|<variable>|<variable>|The UUID of the remote Drovorub-client for which a file is being uploaded to or downloaded from|\n|remote_path|<variable>|<variable>|The file path on the remote Drovorub- client intended to be downloaded or uploaded to|\n|mode|upload|dXBsb2Fk|Either: (a) type of file transfer (upload or download) OR (b) type of file access (r, w, rw)|\n||download|ZG93bmxvYWQ||\n||r|cg==||\n||w|dw==||\n||rw|cnc=||\n|path|<variable>|<variable>|A file path|\n|size|<variable>|<variable>|Size of file being downloaded; value always appears to be zero for file uploads (probably because no file data has been uploaded yet via a \"write\" action)|\n|offset|<variable>|<variable>|Offset in the file to insert contents of the “data” parameter|\n|data|<variable>|<variable>|File content|\n|status|progress|cHJvZ3Jlc3M=|Status of file transfer|\n||complete|Y29tcGxldGU=||\n||error|ZXJyb3I=||\n\n\n-----\n\n|Parameter Name Parameter Parameter Description Value(s) Value(s) (Base64)|Col2|Col3|Col4|\n|---|---|---|---|\n||aborted|YWJvcnRlZA==||\n|progress|<variable>|<variable>|File transfer percent completed|\n|reason|<variable>|<variable>|Reason for reported error|\n\n\nThe figures below show the command sequence for file download and file upload, if successful. Any\nerrors opening, reading, or writing files are reported at the appropriate stage.\n\n**_Figure 28: File download sequence_**\n\n**_Figure 29: File upload sequence_**\n\n_File Download Example_\n\nThe following steps illustrate an example sequence of actions for a Drovorub-agent downloading a file\nfrom a Drovorub-client.\n\n**1. \"transfer_request\": A Drovorub-server sends a \"transfer_request\" to the Drovorub-agent to**\n\ninitiate the file transfer. In this case, the \"mode\" value decodes to \"download\" so this is a file\ndownload. The \"remote_id\" parameter is the UUID of the Drovorub-client from which to download\nthe file specified in \"remote_path\". In this case, the file being downloaded is \"/etc/passwd\". The\n\"local_path\" parameter is the file path on the Drovorub-agent where the file is downloaded to,\nwhich in this case is \"/tmp/passwd\".\n\n\n-----\n\n```\n{\"children\":\n  [\n    {\"name\":\"module\",\"value\":\"ZmlsZQ==\"},\n    {\"name\":\"action\",\"value\":\"dHJhbnNmZXJfcmVxdWVzdA==\"},\n    {\"name\":\"session_id\",\"value\":\"UGRrQnh2MnQzVzBsa0U4Zg==\"},\n    {\"name\":\"src_id\",\"value\":\"ZTM5MTg0N2MtYmFlNy0xMWVhLWI0YmMtMDAwYzI5MTMwYjcx\"},\n    {\"name\":\"dst_id\",\"value\":\"YjkyMzdlYzAtYmFlNy0xMWVhLTlkYTAtMDAwYzI5MTMwYjcx\"},\n    {\"name\":\"local_path\",\"value\":\"L3RtcC9wYXNzd2Q=\"},\n    {\"name\":\"remote_id\",\"value\":\"YzhiNDY0ODAtYmFlNy0xMWVhLWI2ZWYtMDAwYzI5MTMwYjcx\"},\n    {\"name\":\"remote_path\",\"value\":\"L2V0Yy9wYXNzd2Q=\"},\n    {\"name\":\"mode\",\"value\":\"ZG93bmxvYWQ=\"}\n  ]\n}\n\n```\n**_Figure 30: “transfer_request”_**\n\n**2. \"open\": The Drovorub-agent sends the \"open\" action to the intended Drovorub-client, instructing**\n\nit to open the specified file path for reading. The \"mode\" parameter is set to \"r\" for read access.\n\n```\n{\"children\":\n  [\n    {\"name\":\"module\",\"value\":\"ZmlsZQ==\"},\n    {\"name\":\"session_id\",\"value\":\"UGRrQnh2MnQzVzBsa0U4Zg==\"},\n    {\"name\":\"path\",\"value\":\"L3RtcC9zdGFnZXovcGFzc3dk\"},\n    {\"name\":\"mode\",\"value\":\"cg==\"},\n    {\"name\":\"action\",\"value\":\"b3Blbg==\"},\n    {\"name\":\"src_id\",\"value\":\"YjkyMzdlYzAtYmFlNy0xMWVhLTlkYTAtMDAwYzI5MTMwYjcx\"},\n    {\"name\":\"dst_id\",\"value\":\"YzhiNDY0ODAtYmFlNy0xMWVhLWI2ZWYtMDAwYzI5MTMwYjcx\"}\n  ]\n\n```\n```\n}\n\n```\n\n**_Figure 31: “open”_**\n\n\n**3. \"open_success\": The Drovorub-client sends an \"open_success\" response to the Drovorub-**\n\nagent, which signifies that the Drovorub-client successfully opened the specified file for reading.\nThe response includes the size of the file being downloaded.\n```\n {\"children\":\n   [\n     {\"name\":\"module\",\"value\":\"ZmlsZQ==\"},\n     {\"name\":\"session_id\",\"value\":\"UGRrQnh2MnQzVzBsa0U4Zg==\"},\n     {\"name\":\"size\",\"value\":\"MTk0OQ==\"},\n     {\"name\":\"action\",\"value\":\"b3Blbl9zdWNjZXNz\"},\n     {\"name\":\"src_id\",\"value\":\"YzhiNDY0ODAtYmFlNy0xMWVhLWI2ZWYtMDAwYzI5MTMwYjcx\"},\n     {\"name\":\"dst_id\",\"value\":\"YjkyMzdlYzAtYmFlNy0xMWVhLTlkYTAtMDAwYzI5MTMwYjcx\"}\n   ]\n }\n\n```\n**_Figure 32: “open_success”_**\n\n**4. \"read\": The Drovorub-agent sends the \"read\" command to the Drovorub-client, which signifies**\n\nthat the Drovorub-agent is ready to receive the file data.\n\n```\n{\"children\":\n  [\n    {\"name\":\"module\",\"value\":\"ZmlsZQ==\"},\n    {\"name\":\"session_id\",\"value\":\"UGRrQnh2MnQzVzBsa0U4Zg==\"},\n    {\"name\":\"action\",\"value\":\"cmVhZA==\"},\n    {\"name\":\"src_id\",\"value\":\"YjkyMzdlYzAtYmFlNy0xMWVhLTlkYTAtMDAwYzI5MTMwYjcx\"},\n    {\"name\":\"dst_id\",\"value\":\"YzhiNDY0ODAtYmFlNy0xMWVhLWI2ZWYtMDAwYzI5MTMwYjcx\"}\n  ]\n}\n\n```\n**_Figure 33: “read”_**\n\n\n-----\n\n**5. \"read_data\": The Drovorub-client sends a \"read_data\" response containing the file contents.**\n\nMultiple \"read_data\" responses can be sent at this stage if the file is large. The response includes\nan \"offset\" parameter that indicates the file offset of the provided data.\n\n```\n   {\"children\":\n     [\n       {\"name\":\"module\",\"value\":\"ZmlsZQ==\"},\n       {\"name\":\"session_id\",\"value\":\"UGRrQnh2MnQzVzBsa0U4Zg==\"},\n       {\"name\":\"src_id\",\"value\":\"YzhiNDY0ODAtYmFlNy0xMWVhLWI2ZWYtMDAwYzI5MTMwYjcx\"},\n       {\"name\":\"dst_id\",\"value\":\"YjkyMzdlYzAtYmFlNy0xMWVhLTlkYTAtMDAwYzI5MTMwYjcx\"},\n       {\"name\":\"action\",\"value\":\"cmVhZF9kYXRh\"},\n       {\"name\":\"offset\",\"value\":\"MA==\"},\n       {\"name\":\"data\",\"value\":\"cm9vdDp4OjA6MDpyb290Oi9yb2…<TRUNCATED>…\"}\n     ]\n   }\n\n```\n**_Figure 34: “read_data”_**\n\n**6. \"close\": The Drovorub-agent sends a \"close\" command to the Drovorub-client to end the file**\n\ntransfer and close the open file.\n```\n   {\"children\":\n     [\n       {\"name\":\"module\",\"value\":\"ZmlsZQ==\"},\n       {\"name\":\"session_id\",\"value\":\"UGRrQnh2MnQzVzBsa0U4Zg==\"},\n       {\"name\":\"action\",\"value\":\"Y2xvc2U=\"},\n       {\"name\":\"src_id\",\"value\":\"YjkyMzdlYzAtYmFlNy0xMWVhLTlkYTAtMDAwYzI5MTMwYjcx\"},\n       {\"name\":\"dst_id\",\"value\":\"YzhiNDY0ODAtYmFlNy0xMWVhLWI2ZWYtMDAwYzI5MTMwYjcx\"}\n     ]\n   }\n\n```\n**_Figure 35: “close”_**\n\n_\"monitor\" module_\n\nThe \"monitor\" module is used for hiding specific file, module, and/or network artifacts from user-space\nview. It allows artifacts to be added, deleted, or modified. This module is supported by the Drovorubclient, but not the Drovorub-agent. (NOTE: The Drovorub-agent does make requests for artifacts to hide,\nbut the Drovorub-server always responds with \"null\", indicating nothing to hide.) The Drovorub-client\nrecords information about all hidden file, module, and network artifacts in its configuration file (see\nexample in the Drovorub-client Configuration section). The Drovorub-client relays all \"monitor\" module\ncommands to the Drovorub-kernel module for implementation (see the Host-based Communication\nsection for details on how the Drovorub-client and Drovorub-kernel module communicate). The following\ntables show the actions and their supported parameters for the \"monitor\" module.\n\n**_Table VII: Drovorub “monitor” module actions_**\n\n|Table VII: Drovorub “monitor” module actions|Col2|Col3|Col4|\n|---|---|---|---|\n|Action Action (Base64) Parameters Description Supported||||\n|file_list_request|ZmlsZV9saXN0X3JlcXVlc3Q=|client_id|Request sent to Drovorub-server for file, module, or network artifacts to hide|\n|module_list_request|bW9kdWxlX2xpc3RfcmVxdWVzdA=|||\n|net_list_request|bmV0X2xpc3RfcmVxdWVzdA==|||\n|file_list_reply|ZmlsZV9saXN0X3JlcGx5|client_id, records, mon_id, mask, port, proto, active|Response to a request for file, module, network, or artifacts to hide|\n|module_list_reply|bW9kdWxlX2xpc3RfcmVwbHk=|||\n|net_list_reply|bmV0X2xpc3RfcmVwbHk=|||\n|file_add_request|ZmlsZV9hZGRfcmVxdWVzdA==|||\n\n\n-----\n\n|Action Action (Base64) Parameters Description Supported|Col2|Col3|Col4|\n|---|---|---|---|\n|module_add_request|bW9kdWxlX2FkZF9yZXF1ZXN0|client_id, mon_id, mask, port, proto, active|Add a specific file, module, or network artifact to the list of hidden artifacts|\n|net_add_request|bmV0X2FkZF9yZXF1ZXN0|||\n|file_del_request|ZmlsZV9kZWxfcmVxdWVzdA==|client_id, mon_id|Delete a specific file, module, or network artifact that matches the given \"mon_id\"|\n|module_del_request|bW9kdWxlX2RlbF9yZXF1ZXN0|||\n|net_del_request|bmV0X2RlbF9yZXF1ZXN0|||\n|file_mod_request|ZmlsZV9tb2RfcmVxdWVzdA==|client_id, mon_id, mask, port, proto, active|Modify a current file, module, or network artifact that matches the given \"mon_id\"; update current entry with values given in \"mask\", \"port\", \"proto\", and \"active\" parameters|\n|module_mod_request|bW9kdWxlX21vZF9yZXF1ZXN0|||\n|net_mod_request|bmV0X21vZF9yZXF1ZXN0|||\n\n\n**_Table VIII: Drovorub “monitor” module action parameters_**\n\n**Parameter** **Parameter** **Parameter Value** **Description**\n**Name** **Value(s)** **(Base64)**\n\n**active** true dHJ1ZQ== Whether the file, module, network, or process\nartifact should currently be hidden or not\nfalse ZmFsc2U=\n\n**client_id** <variable> <variable> The Drovorub-client or Drovorub-agent UUID\n**mask** <variable> <variable> The name of the file or module to hide\n**mon_id** <variable> <variable> A UUID that identifies the specific file, module,\nnetwork, or process artifact entry\n**port** <variable> <variable> Network port number\n**proto** <variable> <variable> Network protocol (e.g. tcp or udp)\n**reason** <variable> <variable> An error message\n**records** <variable> <variable> An array of file, module, network, and/or artifact\nentries; each entry contains at a minimum a\nmon_id and a client_id\n\nThe following are examples of some of the \"monitor\" module commands.\n\n_\"file_add_request\" Example_\n\nThe following command shows an example of adding a file name to the list of hidden artifacts. The\n\"mon_id\" value is an identifier for this specific file. The \"mask\" value is the name of file to be hidden; in\nthis example, \"collectz\" (\"Y29sbGVjdHo\"). Finally, \"active\" specifies whether the kernel module should be\nactively hiding the file or not; in this example, \"active\" is set to true (\"dHJ1ZQ==\").\n\n|Table VIII: Drovorub “monitor” module action parameters|Col2|Col3|Col4|\n|---|---|---|---|\n|Parameter Parameter Parameter Value Description Name Value(s) (Base64)||||\n|active|true|dHJ1ZQ==|Whether the file, module, network, or process artifact should currently be hidden or not|\n||false|ZmFsc2U=||\n|client_id|<variable>|<variable>|The Drovorub-client or Drovorub-agent UUID|\n|mask|<variable>|<variable>|The name of the file or module to hide|\n|mon_id|<variable>|<variable>|A UUID that identifies the specific file, module, network, or process artifact entry|\n|port|<variable>|<variable>|Network port number|\n|proto|<variable>|<variable>|Network protocol (e.g. tcp or udp)|\n|reason|<variable>|<variable>|An error message|\n|records|<variable>|<variable>|An array of file, module, network, and/or artifact entries; each entry contains at a minimum a mon_id and a client_id|\n\n\n-----\n\n```\n   {\"children\":\n     [\n       {\"name\":\"module\",\"value\":\"bW9uaXRvcg==\"},\n       {\"name\":\"action\",\"value\":\"ZmlsZV9hZGRfcmVxdWVzdA==\"},\n       {\"name\":\"client_id\",\"value\":\"YzhiNDY0ODAtYmFlNy0xMWVhLWI2ZWYtMDAwYzI5MTMwYjcx\"},\n       {\"name\":\"mon_id\",\"value\":\"Mzk1NjAyNTQtNjIyZS1iMDIyLTNlYmUtNDA0ODY3ZjlhYTRk\"},\n       {\"name\":\"mask\",\"value\":\"Y29sbGVjdHo=\"},\n       {\"name\":\"active\",\"value\":\"dHJ1ZQ==\"}\n     ]\n   }\n\n```\n**_Figure 36: \"file_add_request\"_**\n\n_\"net_list_request\" / \"net_list_reply\" Example_\n\nThe Drovorub-client requests all of its network artifact records.\n```\n   {\"children\":\n     [\n       {\"name\":\"module\",\"value\":\"bW9uaXRvcg==\"},\n       {\"name\":\"action\",\"value\":\"bmV0X2xpc3RfcmVxdWVzdA==\"},\n       {\"name\":\"client_id\",\"value\":\"YzhiNDY0ODAtYmFlNy0xMWVhLWI2ZWYtMDAwYzI5MTMwYjcx\"}\n     ]\n   }\n\n```\n**_Figure 37: Drovorub-client \"net_list_request\" sent to Drovorub-server_**\n\nThe Drovorub-server responds back with a list of network artifact \"records\". Each record contains a\nunique UUID (\"mon_id\"), the port to hide (\"port\"), the protocol associated with the port (\"proto\"), whether\nto enable or disable hiding of the port (\"active\"), and finally the UUID of the Drovorub-client (\"client_id\"). In\nthis example, the Drovorub-client should be hiding TCP ports 12345 and 45678.\n```\n {\"children\":\n   [\n     {\"name\":\"module\",\"value\":\"bW9uaXRvcg==\"},\n     {\"name\":\"action\",\"value\":\"bmV0X2xpc3RfcmVwbHk=\"},\n     {\"name\":\"client_id\",\"value\":\"YzhiNDY0ODAtYmFlNy0xMWVhLWI2ZWYtMDAwYzI5MTMwYjcx\"},\n     {\"name\":\"records\",\"value\":\n       [\n         [\n           {\"name\":\"mon_id\",\"value\":\"MmZjYTllY2MtOWM0Mi0xOWRhLTlmYWItOGZlMmU \n           5ZmI3YmUx\"},\n           {\"name\":\"port\",\"value\":\"MTIzNDU=\"},\n           {\"name\":\"proto\",\"value\":\"dGNw\"},\n           {\"name\":\"active\",\"value\":\"dHJ1ZQ==\"},\n           {\"name\":\"client_id\",\"value\":\"YzhiNDY0ODAtYmFlNy0xMWVhLWI2ZWYtMDAw\n           YzI5MTMwYjcx\"}\n         ],\n         [\n           {\"name\":\"mon_id\",\"value\":\"OTU0NTI0MDEtM2QxYy0zMWZmLTVmOTgtZTY0Mjd\n           mYTVlNWQ4\"},\n           {\"name\":\"port\",\"value\":\"NDU2Nzg=\"},\n           {\"name\":\"proto\",\"value\":\"dGNw\"},\n           {\"name\":\"active\",\"value\":\"dHJ1ZQ==\"},\n           {\"name\":\"client_id\",\"value\":\"YzhiNDY0ODAtYmFlNy0xMWVhLWI2ZWYtMDAw\n           YzI5MTMwYjcx\"}\n         ]\n       ]\n     }\n   ]\n }\n\n```\n**_Figure 38: Drovorub-server “net_list_reply” sent to Drovorub-client_**\n\n_\"shell\" module_\n\nThe \"shell\" module provides remote shell access on Drovorub-clients only. Drovorub-agents do not\nsupport the \"shell\" module. The command-line shell program used to execute commands is hardcoded in\n\n\n-----\n\nthe Drovorub-client binary. The following tables show the actions and their supported parameters for the\n\"shell\" module.\n\n**_Table IX: Drovorub “shell” module actions_**\n\n**Action** **Action (Base64)** **Parameters Supported** **Description**\n**open** b3Blbg== session.id, src_id, dst_id Request a command-line shell be\nopened on a Drovorub_client\n(“dst_id”)\n**open.success** b3Blbi5zdWNjZXNz session.id, src_id, dst_id Report successful open of shell\n**open.fail** b3Blbi5mYWls session.id, src_id, dst_id Report failure to open shell\n**data** ZGF0YQ== session.id, src_id, dst_id, Send and receive arbitrary shell\ndata commands and results\n\n**close** Y2xvc2U= session.id, src_id, dst_id Terminate the shell\n\n**_Table X: Drovorub “shell” module action parameters_**\n\n##### Parameter Name Parameter Value(s) Parameter Value(s) Description\n (Base64)\n session.id <variable> <variable> A unique id to track the shell session src_id <variable> <variable> UUID of sender of command or results dst_id <variable> <variable> UUID of receiver of command or results data <variable> <variable> Shell commands and responses\n\n_Shell Example_\n\nThe following is an example of opening a shell session on a Drovorub-client and sending commands:\n\n**1. \"open\": A Drovorub-server sends the \"open\" action to a Drovorub-client to open a command-line**\n\nshell.\n```\n {\"children\":\n   [\n     {\"name\":\"module\",\"value\":\"c2hlbGw=\"},\n     {\"name\":\"action\",\"value\":\"b3Blbg==\"},\n     {\"name\":\"session.id\",\"value\":\"ODhjY2ExMjI0NjRiOGNiNGViMWE3NDYyYWM4NDA5Mjc5Yj\n     AxMTU5Mw==\"},\n     {\"name\":\"src_id\",\"value\":\"OTcyMDVjZGMtYzA2Yy0xMWVhLTk0MWEtMDAwYzI5MTMwYjcx\"},\n     {\"name\":\"dst_id\",\"value\":\"OTYwNWRlMjYtYzA2Yy0xMWVhLWI2NTAtMDAwYzI5MTMwYjcx\"}\n   ]\n }\n\n```\n**_Figure 39: Drovorub-server sends an \"open\" action to start a command-line shell on a Drovorub-client_**\n\n**2. \"open.success\": The Drovorub-client reports back that the command-line shell was successfully**\n\nopened.\n\n|Table IX: Drovorub “shell” module actions|Col2|Col3|Col4|\n|---|---|---|---|\n|Action Action (Base64) Parameters Supported Description||||\n|open|b3Blbg==|session.id, src_id, dst_id|Request a command-line shell be opened on a Drovorub_client (“dst_id”)|\n|open.success|b3Blbi5zdWNjZXNz|session.id, src_id, dst_id|Report successful open of shell|\n|open.fail|b3Blbi5mYWls|session.id, src_id, dst_id|Report failure to open shell|\n|data|ZGF0YQ==|session.id, src_id, dst_id, data|Send and receive arbitrary shell commands and results|\n|close|Y2xvc2U=|session.id, src_id, dst_id|Terminate the shell|\n\n|Table X: Drovorub “shell” module action parameters|Col2|Col3|Col4|\n|---|---|---|---|\n|Parameter Name Parameter Value(s) Parameter Value(s) Description (Base64)||||\n|session.id|<variable>|<variable>|A unique id to track the shell session|\n|src_id|<variable>|<variable>|UUID of sender of command or results|\n|dst_id|<variable>|<variable>|UUID of receiver of command or results|\n|data|<variable>|<variable>|Shell commands and responses|\n\n\n-----\n\n```\n {\"children\":\n   [\n     {\"name\":\"module\",\"value\":\"c2hlbGw=\"},\n     {\"name\":\"action\",\"value\":\"b3Blbi5zdWNjZXNz\"},\n     {\"name\":\"session.id\",\"value\":\"ODhjY2ExMjI0NjRiOGNiNGViMWE3NDYyYWM4NDA5Mjc5Yj\n     AxMTU5Mw==\"},\n     {\"name\":\"src_id\",\"value\":\"OTYwNWRlMjYtYzA2Yy0xMWVhLWI2NTAtMDAwYzI5MTMwYjcx\"},\n     {\"name\":\"dst_id\",\"value\":\"OTcyMDVjZGMtYzA2Yy0xMWVhLTk0MWEtMDAwYzI5MTMwYjcx\"}\n   ]\n }\n\n```\n**_Figure 40: Drovorub-client reports successful opening of command-line shell_**\n\n**3. \"data\": The Drovorub-server sends a \"data\" action containing the shell command to execute. In**\n\nthe below example, the \"id\" command is sent.\n```\n {\"children\":\n   [\n     {\"name\":\"module\",\"value\":\"c2hlbGw=\"},\n     {\"name\":\"action\",\"value\":\"ZGF0YQ==\"},\n     {\"name\":\"session.id\",\"value\":\"ODhjY2ExMjI0NjRiOGNiNGViMWE3NDYyYWM4NDA5Mjc5Yj\n     AxMTU5Mw==\"},\n     {\"name\":\"src_id\",\"value\":\"OTcyMDVjZGMtYzA2Yy0xMWVhLTk0MWEtMDAwYzI5MTMwYjcx\"},\n     {\"name\":\"dst_id\",\"value\":\"OTYwNWRlMjYtYzA2Yy0xMWVhLWI2NTAtMDAwYzI5MTMwYjcx\"},\n     {\"name\":\"data\",\"value\":\"aWQNCg==\"}\n   ]\n }\n\n```\n**_Figure 41: Drovorub-server sends a shell command_**\n\n**4. \"data\": The Drovorub-client responds with the results of the command. (NOTE: This command**\n\nand response sequence in steps 3 and 4 will repeat until the Drovorub-server is done sending\ncommands.)\n\n```\n {\"children\":\n   [\n     {\"name\":\"module\",\"value\":\"c2hlbGw=\"},\n     {\"name\":\"action\",\"value\":\"ZGF0YQ==\"},\n     {\"name\":\"session.id\",\"value\":\"ODhjY2ExMjI0NjRiOGNiNGViMWE3NDYyYWM4NDA5Mjc5Yj\n     AxMTU5Mw==\"},\n     {\"name\":\"src_id\",\"value\":\"OTYwNWRlMjYtYzA2Yy0xMWVhLWI2NTAtMDAwYzI5MTMwYjcx\"},\n     {\"name\":\"dst_id\",\"value\":\"OTcyMDVjZGMtYzA2Yy0xMWVhLTk0MWEtMDAwYzI5MTMwYjcx\"},\n     {\"name\":\"data\",\"value\":\"YmFzaC00LjEjIGlkCnVpZD0wKHJvb3QpIGdpZD0wKHJvb3QpIGdy\n     b3Vwcz0wKHJvb3Qp\"}\n   ]\n }\n\n```\n**_Figure 42: Drovorub-client responds with results of the shell command_**\n\n**5. \"close\": When the Drovorub-server is done sending commands, it sends the \"close\" action which**\n\ntells the Drovorub-client to terminate the shell. The Drovorub-client will respond back with its own\n\"close\" action signifying it has terminated the shell.\n```\n {\"children\":\n   [\n     {\"name\":\"module\",\"value\":\"c2hlbGw=\"},\n     {\"name\":\"action\",\"value\":\"Y2xvc2U=\"},\n     {\"name\":\"session.id\",\"value\":\"ODhjY2ExMjI0NjRiOGNiNGViMWE3NDYyYWM4NDA5Mjc5Yj \n     AxMTU5Mw==\"},\n     {\"name\":\"src_id\",\"value\":\"OTcyMDVjZGMtYzA2Yy0xMWVhLTk0MWEtMDAwYzI5MTMwYjcx\"},\n     {\"name\":\"dst_id\",\"value\":\"OTYwNWRlMjYtYzA2Yy0xMWVhLWI2NTAtMDAwYzI5MTMwYjcx\"}\n   ]\n }\n\n```\n**_Figure 43: Drovorub-server sends a \"close\" action to terminate the shell_**\n\n\n-----\n\n_\"tunnel\" module_\n\nThe \"tunnel\" module provides port forwarding capability and is supported by both Drovorub-clients and\nDrovorub-agents. Port forwarding rules are maintained in the Drovorub-client or Drovorub-agent memory\nand not in any firewall or other table on those endpoints. Every port forwarding rule is assigned a unique\nUUID value (\"id\") to keep track of it. Likewise, each connection established through a port forwarder is\nassigned a unique session identifier (\"sessionid\"). It should also be noted that connections established on\nDrovorub-clients through this port forwarding capability are not automatically hidden by the Drovorubkernel module. Separate \"monitor\" module commands would need to be issued prior to adding any port\nforwarding rules to hide connections established on those ports. The following tables show the actions\nand their supported parameters for the \"tunnel\" module.\n\n**_Table XI: Drovorub “tunnel” module actions_**\n\n**Action** **Action (Base64)** **Parameters** **Description**\n**Supported**\n\n**addtun** YWRkdHVu id, srcid, lhost, lport, Create a new port forwarding rule on\ndstid, rhost, rport, the Drovorub-client or Drovorub-agent\nenabled specified by “srcid”; \"srcid\" will start up\n\na TCP listener on the specified local\nhost IP and port (“lhost” and “lport”);\nconnections will be forwarded to the\nspecified remote host IP and port\n(“rhost” and “rport”) through the\nDrovorub-client or Drovorub-agent\nspecified by “dstid”\n**modtun** bW9kdHVu id, srcid, lhost, lport, Modify an existing port forwarding rule\ndstid, rhost, rport, on the Drovorub-client or Drovorubenabled agent specified by “srcid”\n\n**deltun** ZGVsdHVu id, dstid Delete an existing port forwarding rule\non the Drovorub-client or Drovorubagent specified by “dstid”\n**open** b3Blbg== id, sessionid, srcid, Open a new TCP connection from\ndstid, rhost, rport “srcid” to “dstid” to forward traffic to\n\nthe given “rhost” and “rport”\n**open_success** b3Blbl9zdWNjZXNz id, sessionid, srcid, Respond to an “open” request that the\ndstid TCP connection was successfully\n\nestablished\n**open_fail** b3Blbl9mYWls id, sessionid, srcid, Respond to an “open” request\ndstid reporting failure to establish the TCP\n\nconnection\n**data** ZGF0YQ== id, sessionid, srcid, Send and receive data through the\ndstid, data TCP port forwarded connection\n\n**close** Y2xvc2U= id, sessionid, srcid, Close the TCP port forwarded\ndstid connection\n\n**_Table XII: Drovorub “tunnel” module action parameters_**\n\n|Table XI: Drovorub “tunnel” module actions|Col2|Col3|Col4|\n|---|---|---|---|\n|Action Action (Base64) Parameters Description Supported||||\n|addtun|YWRkdHVu|id, srcid, lhost, lport, dstid, rhost, rport, enabled|Create a new port forwarding rule on the Drovorub-client or Drovorub-agent specified by “srcid”; \"srcid\" will start up a TCP listener on the specified local host IP and port (“lhost” and “lport”); connections will be forwarded to the specified remote host IP and port (“rhost” and “rport”) through the Drovorub-client or Drovorub-agent specified by “dstid”|\n|modtun|bW9kdHVu|id, srcid, lhost, lport, dstid, rhost, rport, enabled|Modify an existing port forwarding rule on the Drovorub-client or Drovorub- agent specified by “srcid”|\n|deltun|ZGVsdHVu|id, dstid|Delete an existing port forwarding rule on the Drovorub-client or Drovorub- agent specified by “dstid”|\n|open|b3Blbg==|id, sessionid, srcid, dstid, rhost, rport|Open a new TCP connection from “srcid” to “dstid” to forward traffic to the given “rhost” and “rport”|\n|open_success|b3Blbl9zdWNjZXNz|id, sessionid, srcid, dstid|Respond to an “open” request that the TCP connection was successfully established|\n|open_fail|b3Blbl9mYWls|id, sessionid, srcid, dstid|Respond to an “open” request reporting failure to establish the TCP connection|\n|data|ZGF0YQ==|id, sessionid, srcid, dstid, data|Send and receive data through the TCP port forwarded connection|\n|close|Y2xvc2U=|id, sessionid, srcid, dstid|Close the TCP port forwarded connection|\n\n|Table XII: Drovorub “tunnel” module action parameters|Col2|Col3|Col4|\n|---|---|---|---|\n|Parameter Name Parameter Parameter Description Value(s) Value(s) (Base64)||||\n|sessionid|<variable>|<variable>|A unique UUID to track an open TCP connection|\n|srcid|<variable>|<variable>|A unique UUID that represents one of the tunnel endpoints; tunnel endpoints|\n\n\n-----\n\n|Parameter Name Parameter Parameter Description Value(s) Value(s) (Base64)|Col2|Col3|Col4|\n|---|---|---|---|\n||||can be either Drovorub-clients or Drovorub-agents|\n|dstid|<variable>|<variable>|A unique UUID that represents one of the tunnel endpoints; tunnel endpoints can be Drovorub-clients or Drovorub- agents|\n|id|<variable>|<variable>|Unique UUID for the port forwarding entry|\n|lhost|<variable>|<variable>|Listening host IP|\n|lport|<variable>|<variable>|Listening host port|\n|rhost|<variable>|<variable>|Remote host IP to forward traffic to|\n|rport|<variable>|<variable>|Remote host port to forward traffic to|\n|data|<variable>|<variable>|Send/receive data through port forwarder|\n|enabled|true|dHJ1ZQ==|Enable (true) or disable (false) the port forwarding rule|\n||false|ZmFsc2U=||\n|reason|<variable>|<variable>|Reason for reported error|\n\n\nThe following diagram illustrates one potential port tunneling configuration. This scenario shows how port\nforwarding could be setup between a Drovorub-agent and a Drovorub-client to relay network traffic to a\nremote host within the compromised network where the Drovorub-client infected machine resides.\n\n**_Figure 44: Example “tunnel” setup_**\n\n\n-----\n\n_Tunnel Example_\n\nThe following is an example sequence of actions to add a new port forwarding rule on a Drovorub-agent\nto relay network traffic to a remote host via a Drovorub-client. The remote host, in this case, is another\nmachine on the same network as the Drovorub-client.\n\n**1. \"addtun\": A Drovorub-server sends the \"addtun\" action to a Drovorub-agent to create a new port**\n\nforwarding rule. In this example, the Drovorub-agent (\"srcid\") will establish a listener on one of its\nnetwork interfaces specified by “lhost” and “lport”. In this case, the listener is established at IP\naddress 192.168.57.100 on port 7777. Any connections to this IP and port will be forwarded to\nthe remote host specified by “rhost” and “rport” via the Drovorub-client (“dstid”). In this case the\nremote host is at IP address 192.168.57.200 and port 5555.\n```\n    {\"children\":\n      [\n        {\"name\":\"module\",\"value\":\"dHVubmVs\"},\n        {\"name\":\"action\",\"value\":\"YWRkdHVu\"},\n        {\"name\":\"id\",\"value\":\"YTBmOTBhNDktNGViMC1mMDRjLTNkYzgtN2IzMGE1YjQ1ZmNk\"},\n        {\"name\":\"srcid\",\"value\":\"NGFiMDExNTQtYzEyZS0xMWVhLWI5M2UtMDAwYzI5MTMwYjcx\"},\n        {\"name\":\"lhost\",\"value\":\"MTkyLjE2OC41Ny4xMDA=\"},\n        {\"name\":\"lport\",\"value\":\"Nzc3Nw==\"},\n        {\"name\":\"dstid\",\"value\":\"NTJmMDI4ZDYtYzEyZS0xMWVhLWI4NDctMDAwYzI5MTMwYjcx\"},\n        {\"name\":\"rhost\",\"value\":\"MTkyLjE2OC41Ny4yMDA=\"},\n        {\"name\":\"rport\",\"value\":\"NTU1NQ==\"},\n        {\"name\":\"enabled\",\"value\":\"dHJ1ZQ==\"}\n      ]\n    }\n\n```\n**_Figure 45: \"addtun\" action_**\n\n**2. \"open\": When the Drovorub-agent receives a connection on the listening port, it sends the**\n\n\"open\" action to establish a TCP connection with the Drovorub-client that matches the port\nforwarding rule (\"id\") it saved in memory. The \"dstid\", \"rhost\", and \"rport\" values match those in\nthe saved rule. The \"sessionid\" is used to track this new connection.\n\n```\n{\"children\":\n  [\n    {\"name\":\"module\",\"value\":\"dHVubmVs\"},\n    {\"name\":\"action\",\"value\":\"b3Blbg==\"},\n    {\"name\":\"id\",\"value\":\"YTBmOTBhNDktNGViMC1mMDRjLTNkYzgtN2IzMGE1YjQ1ZmNk\"},\n    {\"name\":\"sessionid\",\"value\":\"OGE3M2VkOTItYzEyZS0xMWVhLWIzZGUtMDAwYzI5MTMwYjcx\"},\n    {\"name\":\"dstid\",\"value\":\"NTJmMDI4ZDYtYzEyZS0xMWVhLWI4NDctMDAwYzI5MTMwYjcx\"},\n    {\"name\":\"srcid\",\"value\":\"NGFiMDExNTQtYzEyZS0xMWVhLWI5M2UtMDAwYzI5MTMwYjcx\"},\n    {\"name\":\"rhost\",\"value\":\"MTkyLjE2OC41Ny4yMDA=\"},\n    {\"name\":\"rport\",\"value\":\"NTU1NQ==\"}\n  ]\n}\n\n```\n**_Figure 46: \"open\" action_**\n\n**3. \"open_success\": If the connection is successfully established, the Drovorub-client (\"srcid\")**\n\nresponds back to the Drovorub-agent (\"dstid\") with the \"open_success\" action.\n```\n {\"children\":\n   [\n     {\"name\":\"module\",\"value\":\"dHVubmVs\"},\n     {\"name\":\"action\",\"value\":\"b3Blbl9zdWNjZXNz\"},\n     {\"name\":\"id\",\"value\":\"YTBmOTBhNDktNGViMC1mMDRjLTNkYzgtN2IzMGE1YjQ1ZmNk\"},\n     {\"name\":\"srcid\",\"value\":\"NTJmMDI4ZDYtYzEyZS0xMWVhLWI4NDctMDAwYzI5MTMwYjcx\"},\n     {\"name\":\"dstid\",\"value\":\"NGFiMDExNTQtYzEyZS0xMWVhLWI5M2UtMDAwYzI5MTMwYjcx\"},\n     {\"name\":\"sessionid\",\"value\":\"OGE3M2VkOTItYzEyZS0xMWVhLWIzZGUtMDAwYzI5MTMwYjcx\"}\n   ]\n }\n\n```\n**_Figure 47: \"open_success\" response_**\n\n\n-----\n\n**4. \"data\": Traffic can now be sent and received through the established TCP port forwarded**\n\nconnection using the \"data\" action. The \"srcid\" is the tunnel endpoint currently sending data, while\n“dstid” is the tunnel endpoint currently receiving data.\n```\n   {\"children\":\n     [\n       {\"name\":\"module\",\"value\":\"dHVubmVs\"},\n       {\"name\":\"action\",\"value\":\"ZGF0YQ==\"},\n       {\"name\":\"id\",\"value\":\"YTBmOTBhNDktNGViMC1mMDRjLTNkYzgtN2IzMGE1YjQ1ZmNk\"},\n       {\"name\":\"sessionid\",\"value\":\"OGE3M2VkOTItYzEyZS0xMWVhLWIzZGUtMDAwYzI5MTMwYjcx\"},\n       {\"name\":\"dstid\",\"value\":\"NTJmMDI4ZDYtYzEyZS0xMWVhLWI4NDctMDAwYzI5MTMwYjcx\"},\n       {\"name\":\"srcid\",\"value\":\"NGFiMDExNTQtYzEyZS0xMWVhLWI5M2UtMDAwYzI5MTMwYjcx\"},\n       {\"name\":\"data\",\"value\":\"aGVsbG8K\"}\n     ]\n   }\n\n```\n**_Figure 48: \"data\" action_**\n\n**Host-based Communications**\n\nThe Drovorub-client and Drovorub-kernel module communicate over a designated pseudo-device (e.g.\n/dev/zero) that is not traditionally used for bi-directional, full duplex input/output (I/O). When the Drovorubkernel module is first loaded and initialized, it hooks the standard read/write file API methods for the\ndesignated pseudo-device. Any writes to the pseudo-device from the registered Drovorub-client process\nare directly parsed by the Drovorub-kernel module and when the Drovorub-kernel module has status or\nresponse data to deliver back to Drovorub-client, it sends a signal (SIGUSR1) to the Drovorub-client\nprocess, waits for a subsequent read request on the pseudo-device by the Drovorub-client process, and\nthen delivers its data to the Drovorub-client I/O buffer. Custom command code constructs are employed in\nthese transfers, depending on the direction of the communication. Both are described below.\n\n_Drovorub-client to Drovorub-kernel module_\nThis transfer path is used to issue various commands, mostly in response to tasking originally transmitted\nto the Drovorub-client by the Drovorub-server. The Drovorub-client allocates and writes a sequential data\nbuffer to the pseudo-device formatted as follows:\n\n**_Table XIII: Kernel module command format_**\n\n**Content Type** **Content Data** **Description**\n**ASCII string** \"ASDFZXCV\" Signature string\n**ASCII string** \":\" Separator string between fields\n**ASCII string** Command code Command string\n**ASCII string** \":\" Separator string between fields (NOTE: This field is optional if\n_the command does not require any data)_\n**Arbitrary** Data Any data associated with the command, up to the end of the\ndata buffer (NOTE: This field is optional if the command does\n_not require any data)_\n\nThe following command code string values are used within the Drovorub-client to issue commands to the\nkernel module:\n\n**_Table XIV: Kernel module command types_**\n\n|Table XIII: Kernel module command format|Col2|Col3|\n|---|---|---|\n|Content Type Content Data Description|||\n|ASCII string|\"ASDFZXCV\"|Signature string|\n|ASCII string|\":\"|Separator string between fields|\n|ASCII string|Command code|Command string|\n|ASCII string|\":\"|Separator string between fields (NOTE: This field is optional if the command does not require any data)|\n|Arbitrary|Data|Any data associated with the command, up to the end of the data buffer (NOTE: This field is optional if the command does not require any data)|\n\n|le command types|Col2|\n|---|---|\n|Command String Description||\n|\"hf\"|Hide a file|\n|\"uf\"|Unhide a file|\n|\"hm\"|Hide a module|\n|\"um\"|Unhide a module|\n\n\n-----\n\n|Command String Description|Col2|\n|---|---|\n|\"hp\"|Hide a process|\n|\"up\"|Unhide a process|\n|\"rs\"|Register client with kernel module|\n|\"sc!^2a\"|Clean up|\n|\"ht\"|Hide tcp port|\n|\"ut\"|Unhide tcp port|\n|\"hu\"|Hide udp port|\n|\"uu\"|Unhide udp port|\n\n\nThe buffer is then parsed by the Drovorub-kernel module, which is monitoring any writes made to the\npseudo-device.\n\n_Drovorub-kernel module to Drovorub-client_\nThis transfer path is used to deliver status and/or data in response to processed commands, when\napplicable. The Drovorub-kernel module allocates and fills a buffer using the following data structure for\nthe header, followed by any data buffer that is associated with the command status or response.\n\n**_Table XV: Kernel module buffer header data structure_**\n\n**Content Type** **Content Data** **Description**\n**32-bit unsigned integer** 0xA38246BC Signature value\n**Unsigned char** Command code Command code\n**32-bit unsigned integer** length Length of any data transmitted (in bytes)\n**Unsigned char** Status code Status/Error code: 0 = success, 1 = failure/error\n\nOnce the header and data buffer have been composed, the Drovorub-kernel module sends a signal\n(SIGUSR1) to the Drovorub-client process as an alert that data is available to be read from the pseudodevice. Each read request for the pseudo-device is monitored by the Drovorub-kernel module and, when\nthe registered Drovorub-client process makes a read on the pseudo-device, the stored data buffer is\ncopied directly to the Drovorub-client process I/O buffer.\n\nThe following command code values are used within the Drovorub-kernel module to send status or results\nback to the Drovorub-client:\n\n**_Table XVI: Kernel module command code values_**\n\n**Decimal** **Hex** **Description**\n**Value** **Value**\n\n**6** 0x06 hidden files list\n**12** 0x0C hidden modules list\n**3** 0x03 hidden processes list\n**15** 0x0F hidden tcp connections list\n**45** 0x2D hidden udp connections list\n\n**Evasion**\n\nThe Drovorub-kernel module implements the base functionality for hiding various artifacts from userspace, including specified files and directories, processes and evidence of those processes within the\n\"/proc\" filesystem, network ports and sessions, and specified loaded kernel modules, to include itself.\nEssential to implementation of its hiding capabilities, kernel functions are hooked, either by patching the\nfunctions directly or by overwriting function pointers that point to the functions. Using this technique, the\nDrovorub-kernel module institutes: process hiding, file hiding, socket hiding, netfilter hiding, and hiding\nfrom raw socket receives.\n\n|ble XV: Kernel module buffer header data structure|Col2|Col3|\n|---|---|---|\n|Content Type Content Data Description|||\n|32-bit unsigned integer|0xA38246BC|Signature value|\n|Unsigned char|Command code|Command code|\n|32-bit unsigned integer|length|Length of any data transmitted (in bytes)|\n|Unsigned char|Status code|Status/Error code: 0 = success, 1 = failure/error|\n\n|ule command code values|Col2|Col3|\n|---|---|---|\n|Decimal Hex Description Value Value|||\n|6|0x06|hidden files list|\n|12|0x0C|hidden modules list|\n|3|0x03|hidden processes list|\n|15|0x0F|hidden tcp connections list|\n|45|0x2D|hidden udp connections list|\n\n\n-----\n\n_Process hiding_\nThe Drovorub-kernel module can hide processes from system calls and from the proc filesystem (/proc).\nDepending on the Linux kernel version, the Drovorub-kernel module may hook either the find_pid_ns(),\nfind_pid(), or find_task_by_pid_type() kernel function to hide processes from system calls. Hiding\nprocesses from the proc filesystem is achieved by hooking multiple kernel functions, which may include\nd_lookup(), iterate_dir(), or vfs_readdir() depending on the Linux kernel version. The Drovorub-kernel\nmodule also hooks the lookup function stored in f_path.dentry->d_inode->i_op->lookup of the file “/proc”.\nFinally, the Drovorub-kernel module hooks the do_fork() kernel function to hide child processes spawned\nfrom a hidden process.\n\n_File Hiding_\nTo hide files, the Drovorub-kernel module hooks either the iterate_dir() or vfs_readdir() kernel functions,\ndepending on the kernel version. Hidden files are filtered out of the directory listings, but hidden files are\nstill available by filename if the name is known.\n\n_Socket Hiding_\nTo hide network sockets, the Drovorub-kernel module hooks the appropriate kernel function and filters out\nthe hidden sockets. It determines the function to hook by opening up the appropriate interface in the\n/proc/net directory in the proc file system. For TCP connections, the Drovorub-kernel module accesses\n/proc/net/tcp and /proc/net/tcp6. For UDP connections, it accesses /proc/net/udp and /proc/net/udp6. After\nhooking the appropriate function, the Drovorub-kernel module compares connection entries to the\nconfigured hidden list and filters out hidden connections. The Drovorub-kernel module filters out TCP\nconnections based on the source or destination port, UDP connections based on source port only, or any\nconnections owned by a hidden process.\n\n_Netfilter Hiding_\nIn Linux, Netfilter is a component that enables the filtering of packets in the kernel. It is commonly used by\nfirewalls to perform packet filtering. The Drovorub-kernel module registers a Netfilter hook (the term hook\nhere does not imply patching, but rather is the common term for registering a Netfilter callback function) at\nhook numbers LOCAL_IN and LOCAL_OUT.\n\nThe Drovorub-kernel module also covertly hooks the kernel's nf_register_hook() function, which is the\nfunction used to register a Netfilter hook. When nf_register_hook() is called, the Drovorub-kernel module\nfirst calls the original nf_register_hook() function, allowing the new Netfilter hook to be added. It then\nunregisters any hook that it had previously registered at the same hook number, using the\nnf_unregister_hook() kernel function. Finally, the Drovorub-kernel module will re-register its Netfilter hook\nusing the nf_register_hook() function. The purpose of removing and re-adding the Drovorub-kernel\nmodule Netfilter hook appears to be to ensure that its Netfilter hook gets called before any other nonDrovorub registered hook at the same hook number.\n\nWhen a Drovorub-kernel module Netfilter hook is called, the Drovorub-kernel module determines whether\nthe packet is part of a hidden TCP connection, or part of a TCP connection to or from a hidden process. If\nso, its Netfilter hook returns NF_STOP, preventing any other registered Netfilter hooks from being called\nfor the packet.\n\nTo facilitate identification of packets to or from hidden processes, the Drovorub-kernel module covertly\nhooks the kernel socket functions for establishing or accepting connections, as well as for removing\nconnections. It finds these functions by creating a kernel socket using the sock_create() kernel function\nand looking in the returned socket structure (assume it’s named \"s\" here) at s->ops->accept, s->ops>connect, and s->ops->release. Whenever the hooked accept call is made (incoming connections) or the\nhooked connect call is made (outgoing connections), the Drovorub-kernel module checks to see if the\n\n\n-----\n\ncalling process is hidden. If so, the socket is saved off in a global list to be checked by the Drovorubkernel module Netfilter hooks for each packet. (NOTE: UDP is not supported by the kernel module's\nNetfilter hook, only TCP.)\n\n_Hiding from raw socket receives_\nThe Drovorub-kernel module hooks the skb_recv_datagram() kernel function. Any packet that is part of a\nhidden network session is filtered from raw socket receives. The network session must have been\nexplicitly hidden to have its packets filtered out. Packets from network sessions with hidden processes\nare not automatically filtered.\n\n#### Detection\n\n**Detection Methodologies**\n\nA number of complementary detection techniques effectively identify Drovorub malware activity. However,\nthe Drovorub-kernel module poses a challenge to large-scale detection on the host because it hides\nDrovorub artifacts from tools commonly used for live-response at scale. Below is a discussion of the\nadvantages and disadvantages of various detection methodologies available for Drovorub malware.\n\n**NOTE: Some of the techniques identified in this section can affect the availability or stability of a system.**\nDefenders should follow organizational policies and incident response best practices to minimize the risk\nto operations while hunting for Drovorub malware.\n\n_Network-Based Detection_\nNetwork Intrusion Detection Systems (NIDS) can feasibly identify command and control messages\nbetween the Drovorub-client or Drovorub-agent and Drovorub-server. Specifically, some NIDS (e.g.\nSuricata[®], Zeek[®], Snort, etc.) that can dynamically de-obfuscate “masked” WebSocket protocol messages\nvia scripting capabilities. Using a TLS proxy at the network boundary would allow for the detection of\ncommand and control messages even under a TLS encrypted channel.\n\nSpecifically, some NIDS (e.g. Snort, Suricata, Zeek, etc.) can dynamically de-obfuscate “masked”\nWebSocket protocol messages via scripting capabilities.\n\n**Advantages: High-confidence, large-scale (network-wide) detection of network command and control.**\n\n**Disadvantages: Subject to evasion via TLS or if the format of messages changes.**\n\n_Host-Based Detection_\n\n_Probing_\n\nA script to communicate with the Drovorub-kernel module of the malware is included below. This script\nattempts to probe whether the Drovorub-kernel module hides a specific file based on a known\npreconfigured file prefix.\n\n**Advantages: Quick, scalable deployment of detections to endpoints to detect known samples, with a**\nrelatively low risk of affecting system stability.\n\n**Disadvantages: Subject to evasion if the file prefix differs from the known value.**\n\n\n-----\n\n_Security Products (e.g. Antivirus, Endpoint Detection and Response, etc.) and Logging_\n\nSecurity products may provide visibility into various artifacts of Drovorub malware, including detection of\nthe rootkit functionality. Evaluating specific product detection is outside the scope of this publication;\nhowever, defenders should consider whether any security products in their environment might be\neffective in detecting Drovorub malware.\n\nProperly configured logging by the Linux Kernel Auditing System may additionally reveal artifacts of the\ninitial compromise and installation of Drovorub malware.\n\n_Live Response_\n\nIncident responders commonly use live response techniques, such as searching for specific filenames,\npaths, hashes, and Yara rules on running systems using native system binaries and libraries (which use\nsystem calls provided by the kernel), to detect malicious activity at enterprise scale. The Drovorub-kernel\nmodule hides itself and related files, processes, and network connections by hooking (modifying the logic\nand output of) certain kernel functions, significantly reducing or completely obviating the efficacy of this\ndetection methodology. This detection method is therefore subject to an increased risk of false negatives\n(failing to detect a compromised endpoint).\n\n_Memory Analysis_\n\nCapturing and analyzing the running memory of an endpoint is the most effective approach in detecting\nthe Drovorub-kernel module because it offers the greatest insight into the behaviors the rootkit takes to\nhide itself and other artifacts on the system. Publically available tools such as Linux Memory Grabber\n(LMG), LiME and Volatility, or Rekall can be used to acquire and analyze memory. Detailed guidance for\nrevealing Drovorub-kernel module behaviors is provided in the Memory Analysis with Volatility section\nbelow.\n\n**Advantages: Provides greatest level of visibility into specific rootkit behaviors and artifacts such as files,**\nother processes, and network connections hidden by the malware.\n\n**Disadvantages: Higher potential impact to system stability (during acquisition), and not as scalable to a**\nlarge number of endpoints.\n\n_Media (Disk Image) Analysis_\n\nSeveral Drovorub file-based artifacts are present and persistent on compromised endpoint disk media,\nthough hidden from normal system binaries and system calls by the rootkit. Acquiring raw media images\nis a viable detection method for known Drovorub samples using IOCs (e.g. file names and paths) or Yara\nrules.\n\n**Advantages: Provides visibility into Drovorub files on disk, including configuration data.**\n\n**Disadvantages: Loss of memory-resident artifacts, higher potential impact to system stability (during**\nacquisition), and not as scalable to a large number of endpoints.\n\n**Memory Analysis with Volatility**\n\nUsing Volatility software for memory analysis, it may be possible to detect the presence of the Drovorub\nmalware on compromised hosts. Volatility requires the appropriate Linux profile for the operating system\nwhere the memory was captured, in order to run correctly. Many Linux profiles are available to download\nfrom Volatility’s GitHub[®] website.\n\n\n-----\n\n_Drovorub-kernel Module_\nThe kernel module resident in memory is hidden from some of the commands that would typically show\nthe running module, such as “linux_lsmod”. One plugin that can be used to carve memory for concealed\nmodules is the “linux_hidden_modules” plugin. Here is an example of a Volatility command run against a\nLinux CentOS memory image infected with Drovorub that finds the hidden kernel module:\n\n```\n# python vol.py -f /root/working/mem.img --profile=LinuxCentOS65x64 linux_hidden_modules\nVolatility Foundation Volatility Framework 2.6\nOffset (V)     Name\n------------------ ---0xffffffffa0008060 dr_mod\n\n```\n\n**_Figure 49: Volatility command finding the hidden Kernel Module_**\n\nVolatility can be used to dump the module from memory for further examination. The following example\nshows this process by using the “linux_moddump” plugin (results truncated for readability):\n\n```\n# python vol.py -f /root/working/mem.img --profile=LinuxCentOS65x64 linux_moddump -dump-dir=carvings --base=0xffffffffa0008060\nVolatility Foundation Volatility Framework 2.6\n...\nwalking 83 syms to be fixed....\n...\nWrote 68952 bytes to dr_mod.0xffffffffa0008060.lkm\n\n```\n\n**_Figure 50: Volatility command to dump the Kernel Module from memory_**\n\nThe file dr_mod.0xffffffffa0008060.lkm is carved out of memory to a folder named “carvings”. Using the\n“drovorub_kernel_module_unique_strings” Yara rule later in this advisory, Yara can be run against the file\nto determine if it is the Drovorub-kernel module. The comparison below shows a match for the malware.\n\n```\n# yara drovorub_kernel_module_unique_strings carvings/\ndrovorub_kernel_module_unique_strings carvings//dr_mod.0xffffffffa0008060.lkm\n\n```\n\n**_Figure 51: Yara rule match_**\n\n_Drovorub-client_\nThe Drovorub-client also tries to hides itself using anti-forensic techniques. Volatility plugins such as\n“linux_pslist” may not display the process in the process list. It can be discovered, however, using the\n“linux_psxview” plugin. The below truncated results shows the Drovorub file “dr_client” hidden from the\n“pslist” plugin with the “False” flag, but it is seen by several other plugins with the “True” flag.\n\n```\n# python vol.py -f /root/working/mem.img --profile=LinuxCentOS65x64 linux_psxview\nVolatility Foundation Volatility Framework 2.6\nOffset(V)     Name       PID pslist psscan pid_hash kmem_cache parents\nleaders\n------------------ ------------- ------ ------ ------ -------- ---------- ------- ------ \n0x0000000000400000 dr_client    856 False True  True   True    False  False\n\n```\n\n**_Figure 52: Volatility “psxview” plugin finding the Drovorub-client_**\n\nIt can also be seen using the “linux_psaux” plugin which show more detail on the running processes. In\nthe below truncated output, the “dr_client” process is shown running from the tmp directory:\n\n\n-----\n\n```\n# python vol.py -f /root/working/mem.img --profile=LinuxCentOS65x64 linux_psaux\nVolatility Foundation Volatility Framework 2.6\nPid  Uid  Gid  Arguments\n1   0   0   /sbin/init\n2   0   0   [kthreadd]\n3   0   0   [migration/0]\n...\n856  0   0   /tmp/dr_client\n...\n\n```\n\n**_Figure 53: Volatility “linux_psaux” plugin finding the Drovorub-client_**\n\nTo dump the code for this process, the “linux_procdump” plugin can be used. Here is an example of the\n“/tmp/dr_client” process being carved out of memory:\n\n```\n# python vol.py -f /root/working/mem.img --profile=LinuxCentOS65x64 linux_procdump -dump-dir=carvings --pid=856\nVolatility Foundation Volatility Framework 2.6\nOffset       Name         Pid       Address      Output File\n------------------ -------------------- --------------- ------------------ ----------0xffff88007bdb7500 dr_client      856       0x0000000000400000\ncarvings/dr_client.856.0x400000\n\n```\n\n**_Figure 54: Dumping the “/tmp/dr_client” process from memory_**\n\nRunning the dumped file against the “drovorub_unique_network_comms_strings” Yara rule later in this\nadvisory, also produces a match:\n\n```\n# yara drovorub_unique_network_comms_strings carvings/\ndrovorub_unique_network_comms_strings carvings//dr_client.856.0x400000\n\n```\n\n**_Figure 55: Yara match against dumped file from memory_**\n\nThe attributes of the two files examined are as follows (the sizes of the files will not correspond to the\noriginal files on disk.)\n\n```\n# ls -l carvings\ntotal 3592\ndrwxr-x---. 2 root root  4096 ./\ndrwxr-x---. 8 root root  4096 ../\n-rw-r-----. 1 root root 3600384 dr_client.856.0x400000\n-rw-r-----. 1 root root  68952 dr_mod.0xffffffffa0008060.lkm\n# file carvings/*\ncarvings/dr_client.856.0x400000: ELF 64-but LSB executable, x86-64, version 1\n(GNU/Linux), statically linked, stripped\ncarvings/dr_mod.0xffffffffa0008060.lkm: ELF 64-bit LSB relocatable, Intel 80386, version\n1 (SYSV), not stripped\n\n```\n\n**_Figure 56: Attributes of the two files dumped from memory_**\n\n_Drovorub Networking_\nWhen running the plugin “linux_lsof” against the image to see open file descriptors, the malware shows\nthat it has a network socket open for possible C2 communication:\n\n\n-----\n\n```\n# python vol.py -f /root/working/mem.img --profile=LinuxCentOS65x64 linux_lsof\nVolatility Foundation Volatility Framework 2.6\nOffset       Name              Pid   FD    Path\n------------------ ------------------------------ -------- -------- ---0xffff88007bdb7500 dr_client              856    0 socket:[20516]\n\n```\n\n**_Figure 57: Volatility “linux_lsof” plugin finding a network socket open_**\n\nTo verify an open socket and to see more information on any network connections, the “linux_netstat”\nplugin should be run. The below command shows the Drovorub-client with an established connection\nalong with information on the IP addresses, ports, and PID used by the socket:\n\n```\n# python vol.py -f /root/working/mem.img --profile=LinuxCentOS65x64 linux_netstat\nVolatility Foundation Volatility Framework 2.6\nTCP   192.168.57.25  :57272 192.168.57.100 :32177 ESTABLISHED    dr_client/856\n\n```\n\n**_Figure 58: Volatility “linux_netstat” plugin showing network connection information_**\n\nAnother tool that can be used to examine memory is Bulk Extractor. One of its features is to extract\nnetwork traffic from an image. This is useful as it may provide some network traffic generated by the\nmalware in pcap format. Once Bulk Extractor has finished parsing the memory image, locate the pcap file\nin the output directory and open it with Wireshark. By using display filters on some of the terms in the C2\ncommunications described at the beginning of this advisory, the results may identify the host as being\ncompromised. An example display filter could be:\n\n```\n(tcp.payload matches “\\“name\\”:\\”module\\””) or (“tcp.payload matches\n“\\“name\\”:\\”action\\””) or (“tcp.payload matches “\\“name\\”:\\”token\\””)\n\n```\n\n**_Figure 59: Example Wireshark display filter_**\n\nHere is one of the C2 packets found using the above display filter:\n\n**_Figure 60: Example C2 packet in Wireshark_**\n\n\n-----\n\n_Drovorub Strings_\nUsing a keyword list of the terms described in this advisory, a search can be conducted on the strings in\nthe memory capture. Using the Sysinternals[®] “strings.exe” utility, a file can be created that contains all of\nthe strings in the image:\n\n```\nStrings.exe –o –n 4 –nobanner mem.img > mem_strings.txt\n\n```\n\n**_Figure 61: Using the “strings” utility_**\n\nBy using grep to search through the strings file for terms such as “sc!^2a”, “do_fork”, or “net_list_request”,\nthe results may give an indication that the system has been compromised.\n\n```\n# grep –i “do_fork” mem_strings.txt\n25083726:do_fork\n25084057:do_fork_test\n25201760:<6>kgdbts:RUN do_fork for %i breakpoints\n2973869845:do_fork\n3106559992:  #10 [f2815f68] do_fork at c011cebb\n3324151024:DO_FORK: from %d, %d to %ld, %ld\n3667433893:do_fork\n\n```\n\n**_Figure 62: Using “grep” to search through the strings file_**\n\n**Drovorub-kernel Module Detection Method**\n\nIf the following commands are run on the command-line and the “testfile” disappears, the system is\ninfected with Drovorub. If the “testfile” does not disappear, the system may still be infected with Drovorub.\nThe signature “ASDFZXCV” could have changed or the pseudo-device used for host-based\ncommunications between Drovorub-client and Drovorub-kernel module could be something other than\n/dev/zero.\n\n```\ntouch testfile\necho “ASDFZXCV:hf:testfile” > /dev/zero\nls\n\n```\n\n**_Figure 63: Drovorub-kernel module detection method_**\n\n**Snort Rules**\n\nThe following Snort rules can be used to detect the network communications from Drovorub-server to\nDrovorub-client (or Drovorub-agent). Rule #1 can also detect unmasked Drovorub-client (or Drovorubagent) to Drovorub-server communications.\n\n```\nalert tcp any any -> any any (msg: \"Drovorub WebSocket JSON Comms\";\ncontent:\"{|22|children|22|:[{|22|name|22|:\"; pcre:\n\"/\\x81.{1,4}\\{\\x22children\\x22:\\[\\{\\x22name\\x22:\\x22[a-z09_]{1,32}\\x22,\\x22value\\x22:\\x22[a-zA-Z0-9+\\/]{1,256}={0,2}\\x22\\}/\"; sid: 1; rev: 1;)\n\n```\n\n**_Figure 64: Snort Rule #1_**\n\n```\nalert tcp any any -> any any (msg:\"Drovorub WebSocket Ping\";\nflow:established,from_server; dsize:18; content:\"|89 10 7b 22 70 69 6e 67 22 3a 22 70 69\n6e 67 22 7d 0a|\";depth:18; sid: 2; rev: 1;)\n\n```\n\n**_Figure 65: Snort Rule #2_**\n\n**Yara Rules**\n\nThese Yara rules can be used to detect Drovorub components. Since the Drovorub-kernel module\nactively hides itself and the Drovorub-client, these rules are most effective if run against a forensic image.\n\n```\nrule generic_poco_openssl {\n  meta:\n\n```\n\n-----\n\n```\n    description = “Rule to detect statically linked POCO and OpenSSL libraries. These\nlibraries are present in the Drovorub-server, Drovorub-agent, and Drovorub-client\nbinaries. Hits on this rule do not mean that the file(s) are Drovorub-related, only that\nthey COULD be and should be further investigated.” \n  strings: \n    $mw1 = { 89 F1 48 89 FE 48 89 D7 48 F7 C6 FF FF FF FF 0F 84 6B 02 00 00 48 F7 C7\nFF FF FF FF 0F 84 5E 02 00 00 48 8D 2D } \n    $mw2 = { 41 54 49 89 D4 55 53 F6 47 19 04 48 8B 2E 75 08 31 DB F6 45 00 03 75 } \n    $mw3 = { 85 C0 BA 15 00 00 00 75 09 89 D0 5B C3 0F 1F 44 00 00 BE } \n    $mw4 = { 53 8A 47 08 3C 06 74 21 84 C0 74 1D 3C 07 74 20 B9 ?? ?? ?? ?? BA FD 03\n00 00 BE ?? ?? ?? ?? BF ?? ?? ?? ?? E8 ?? ?? ?? ?? 83 E8 06 3C 01 77 2B 48 8B 1F 48 8B 73\n10 48 89 DF E8 ?? ?? ?? ?? 48 8D 43 08 48 C7 43 10 00 00 00 00 48 C7 43 28 00 00 00 00 48\n89 43 18 48 89 43 20 5B C3 } \n  condition: \n    all of them \n}\n\n```\n\n**_Figure 66: Yara Rule #1_**\n\n```\nrule drovorub_library_and_unique_strings\n{\n  meta:\n    description = “Rule to detect Drovorub-server, Drovorub-agent, and Drovorub-client\nbinaries based on unique strings and strings indicating statically linked libraries.”\n  strings: \n    $s1 = \"Poco\" ascii wide \n    $s2 = \"Json\" ascii wide \n    $s3 = \"OpenSSL\" ascii wide \n    $a1 = \"clientid\" ascii wide \n    $a2 = \"-----BEGIN\" ascii wide \n    $a3 = \"-----END\" ascii wide \n    $a4 = \"tunnel\" ascii wide \n  condition: \n    (filesize > 1MB and filesize < 10MB and (uint32(0) == 0x464c457f)) and (#s1 > 20\nand #s2 > 15 and #s3 > 15 and all of ($a*)) \n}\n\n```\n\n**_Figure 67: Yara Rule #2_**\n\n```\nrule drovorub_unique_network_comms_strings\n{  \n  meta:\n    description = “Rule to detect Drovorub-server, Drovorub-agent, or Drovorub-client\nbased on unique network communication strings.”\n  strings: \n    $s_01 = \"action\" wide ascii \n    $s_02 = \"auth.commit\" wide ascii \n    $s_03 = \"auth.hello\" wide ascii \n    $s_04 = \"auth.login\" wide ascii \n    $s_05 = \"auth.pending\" wide ascii \n    $s_06 = \"client_id\" wide ascii \n    $s_07 = \"client_login\" wide ascii \n    $s_08 = \"client_pass\" wide ascii \n    $s_09 = \"clientid\" wide ascii \n    $s_10 = \"clientkey_base64\" wide ascii \n    $s_11 = \"file_list_request\" wide ascii \n    $s_12 = \"module_list_request\" wide ascii \n    $s_13 = \"monitor\" wide ascii \n    $s_14 = \"net_list_request\" wide ascii \n    $s_15 = \"server finished\" wide ascii \n    $s_16 = \"serverid\" wide ascii \n    $s_17 = \"tunnel\" wide ascii \n\n```\n\n-----\n\n```\n  condition: \n    all of them \n}\n\n```\n\n**_Figure 68: Yara Rule #3_**\n\n```\nrule drovorub_kernel_module_unique_strings\n{ \n  meta:\n    description = “Rule detects the Drovorub-kernel module based on unique strings.”\n  strings:  \n    $s_01 = \"/proc\" wide ascii \n    $s_02 = \"/proc/net/packet\" wide ascii \n    $s_03 = \"/proc/net/raw\" wide ascii \n    $s_04 = \"/proc/net/tcp\" wide ascii \n    $s_05 = \"/proc/net/tcp6\" wide ascii \n    $s_06 = \"/proc/net/udp\" wide ascii \n    $s_07 = \"/proc/net/udp6\" wide ascii \n    $s_08 = \"cs02\" wide ascii \n    $s_09 = \"do_fork\" wide ascii \n    $s_10 = \"es01\" wide ascii \n    $s_11 = \"g001\" wide ascii \n    $s_12 = \"g002\" wide ascii \n    $s_13 = \"i001\" wide ascii \n    $s_14 = \"i002\" wide ascii \n    $s_15 = \"i003\" wide ascii \n    $s_16 = \"i004\" wide ascii \n    $s_17 = \"module\" wide ascii \n    $s_18 = \"sc!^2a\" wide ascii \n    $s_19 = \"sysfs\" wide ascii \n    $s_20 = \"tr01\" wide ascii \n    $s_21 = \"tr02\" wide ascii \n    $s_22 = \"tr03\" wide ascii \n    $s_23 = \"tr04\" wide ascii \n    $s_24 = \"tr05\" wide ascii \n    $s_25 = \"tr06\" wide ascii \n    $s_26 = \"tr07\" wide ascii \n    $s_27 = \"tr08\" wide ascii \n    $s_28 = \"tr09\" wide ascii \n  condition: \n    all of them \n}\n\n```\n\n**_Figure 69: Yara Rule #4_**\n\n#### Preventative Mitigations\n\n**NOTE: The mitigations that follow are not meant to protect against the initial access vector. The**\nmitigations are designed to prevent Drovorub’s persistence and hiding technique only.\n\n**Apply Linux Updates**\n\nSystem administrators should continually check for and run the latest version of vendor-supplied software\nfor computer systems in order to take advantage of software advancements and the latest security\ndetection and mitigation safeguards (National Security Agency, 2018). System administrators should\nupdate to Linux Kernel 3.7 or later in order to take full advantage of kernel signing enforcement.\n\n**Prevent Untrusted Kernel Modules**\n\nSystem owners are advised to configure systems to load only modules with a valid digital signature\nmaking it more difficult for an actor to introduce a malicious kernel module into the system. An adversary\ncould use a malicious kernel module to control the system, hide, or persist across reboots (National\nSecurity Agency, 2017).\n\n\n-----\n\nActivating UEFI Secure Boot is necessary to ensure that only signed kernel modules can be loaded. This\nrequires a UEFI-compliant platform configured in UEFI native mode (not legacy or compatibility modes) in\nThorough or Full enforcement mode. Once enabled, Secure Boot creates an integrity chain at boot by\nverifying signatures of firmware, bootloader(s), and Machine Owner Key (MOK). The kernel, initial\nfilesystem, and kernel modules are then verified by this MOK, which is distributed with Secure Boot-ready\nLinux distributions. Components with untrusted or absent signatures are denied from execution by Secure\nBoot policy. Enabling Secure Boot may prevent some products from loading, potentially affecting system\nfunctionality, and may require custom configuration (National Security Agency, 2017).\n\n\n-----\n\n### Works Cited\n\n##### Configuring the System > Priming the kernel. (2016). In O. Pelz, & J. Hobson, CentOS 7 Linux\n Server Cookbook - Second Edition. Packt Publishing.\n\n Department of Justice. (2018, October 5). U.S. Attorney Brady Announces Charges Against 7\n Russian Military Hackers. The United States Attorney's Office Western District of Pennsylvania. Retrieved from https://www.justice.gov/usao-wdpa/pr/us-attorney-brady- announces-charges-against-7-russian-military-hackers\n\n Fette & Melnikov. (2011). RFC 6455 The WebSocket Protocol. Retrieved from https://www.rfc editor.org/rfc/rfc6455.txt\n\n Microsoft. (2019). The Enemy Within Modern Supply Chain Attacks. Retrieved from\n https://i.blackhat.com/USA-19/Thursday/us-19-Doerr-The-Enemy-Within-Modern- Supply-Chain-Attacks.pdf\n\n Microsoft Security Response Center. (2019). \"Corporate IoT - a path to intrusion\". Microsoft\n Blog. Retrieved from https://msrc-blog.microsoft.com/2019/08/05/corporate-iot-a-path-to- intrusion/\n\n National Security Agency. (2017). Securing Kernel Modules on Linux Operating Systems.\n Retrieved 2020, from https://apps.nsa.gov/iaarchive/library/reports/securing-kernel- modules-on-linux-operating-systems.cfm\n\n National Security Agency. (2018). NSA's Top Ten Cybersecurity Mitigation Strategies. Retrieved\n 2020, from https://www.nsa.gov/Portals/70/documents/what-we- do/cybersecurity/professional-resources/csi-nsas-top10-cybersecurity-mitigation- strategies.pdf\n\n Office of the Director of National Intelligence. (2017, January 6). Intelligence Community\n Assessment: Assessing Russian Activities and Intentions in Recent US Elections. Retrieved from dni.gov: https://www.dni.gov/files/documents/ICA_2017_01.pdf\n\n Washington Post. (2018, July 13). Timeline: How Russian agents allegedly hacked the DNC\n and Clinton's campaign. Retrieved from https://www.washingtonpost.com/news/politics/wp/2018/07/13/timeline-how-russian- agents-allegedly-hacked-the-dnc-and-clintons-campaign\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        },
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        },
        {
            "id": "5910e58f-4bc9-4e4e-9dbb-887804094a01",
            "created_at": "2022-10-25T16:32:58.457399Z",
            "updated_at": "2022-10-25T16:32:58.457399Z",
            "deleted_at": null,
            "name": "OTX",
            "url": "https://otx.alienvault.com",
            "description": "Alienvault Open Threat Exchange (OTX)",
            "reports": null
        },
        {
            "id": "4e039bf8-7239-4999-8ec0-eb202d1465af",
            "created_at": "2022-12-04T11:19:36.52593Z",
            "updated_at": "2022-12-04T11:19:36.52593Z",
            "deleted_at": null,
            "name": "ORKL",
            "url": "https://github.com/ORKL/library",
            "description": "ORKL Community Contributed Content",
            "reports": null
        },
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://media.defense.gov/2020/Aug/13/2002476465/-1/-1/0/CSA_DROVORUB_RUSSIAN_GRU_MALWARE_AUG_2020.PDF",
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-08-01 - Russian GRU 85th GTsSS Deploys Previously Undisclosed Drovorub Malware.PDF"
    ],
    "report_names": [
        "CSA_DROVORUB_RUSSIAN_GRU_MALWARE_AUG_2020.PDF",
        "2020-08-01 - Russian GRU 85th GTsSS Deploys Previously Undisclosed Drovorub Malware.PDF"
    ],
    "threat_actors": [
        {
            "id": "67bf0462-41a3-4da5-b876-187e9ef7c375",
            "created_at": "2022-10-25T16:07:23.44832Z",
            "updated_at": "2025-03-27T02:02:09.806007Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "Careto",
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "ETDA:Careto",
            "tools": [
                "Careto"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f5bf6853-3f6e-452c-a7b7-8f81c9a27476",
            "created_at": "2023-01-06T13:46:38.677391Z",
            "updated_at": "2025-03-27T02:00:02.889755Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "MISPGALAXY:Careto",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d2516b8e-e74f-490d-8a15-43ad6763c7ab",
            "created_at": "2022-10-25T16:07:24.212584Z",
            "updated_at": "2025-03-27T02:02:10.141001Z",
            "deleted_at": null,
            "main_name": "Sofacy",
            "aliases": [
                "APT 28",
                "ATK 5",
                "Blue Athena",
                "BlueDelta",
                "FROZENLAKE",
                "Fancy Bear",
                "Fighting Ursa",
                "Forest Blizzard",
                "Grey-Cloud",
                "Grizzly Steppe",
                "Group 74",
                "GruesomeLarch",
                "ITG05",
                "Iron Twilight",
                "Operation DealersChoice",
                "Operation Dear Joohn",
                "Operation Komplex",
                "Operation Pawn Storm",
                "Operation Russian Doll",
                "Operation Steal-It",
                "Pawn Storm",
                "SIG40",
                "Sednit",
                "Snakemackerel",
                "Sofacy",
                "Strontium",
                "T-APT-12",
                "TA422",
                "TAG-0700",
                "TAG-110",
                "TG-4127",
                "Tsar Team",
                "UAC-0028",
                "UAC-0063"
            ],
            "source_name": "ETDA:Sofacy",
            "tools": [
                "ADVSTORESHELL",
                "AZZY",
                "Backdoor.SofacyX",
                "CHERRYSPY",
                "CORESHELL",
                "Carberp",
                "Computrace",
                "DealersChoice",
                "Delphacy",
                "Downdelph",
                "Downrage",
                "Drovorub",
                "EVILTOSS",
                "Foozer",
                "GAMEFISH",
                "GooseEgg",
                "Graphite",
                "HATVIBE",
                "HIDEDRV",
                "Headlace",
                "Impacket",
                "JHUHUGIT",
                "JKEYSKW",
                "Koadic",
                "Komplex",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LoJack",
                "LoJax",
                "MASEPIE",
                "Mimikatz",
                "NETUI",
                "Nimcy",
                "OCEANMAP",
                "OLDBAIT",
                "PocoDown",
                "PocoDownloader",
                "Popr-d30",
                "ProcDump",
                "PythocyDbg",
                "SMBExec",
                "SOURFACE",
                "SPLM",
                "STEELHOOK",
                "Sasfis",
                "Sedkit",
                "Sednit",
                "Sedreco",
                "Seduploader",
                "Shunnael",
                "SkinnyBoy",
                "Sofacy",
                "SofacyCarberp",
                "SpiderLabs Responder",
                "Trojan.Shunnael",
                "Trojan.Sofacy",
                "USB Stealer",
                "USBStealer",
                "VPNFilter",
                "Win32/USBStealer",
                "WinIDS",
                "Winexe",
                "X-Agent",
                "X-Tunnel",
                "XAPS",
                "XTunnel",
                "Xagent",
                "Zebrocy",
                "Zekapab",
                "carberplike",
                "certutil",
                "certutil.exe",
                "fysbis",
                "webhp"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716497,
    "ts_updated_at": 1743041831,
    "ts_creation_date": 1597301900,
    "ts_modification_date": 1597301900,
    "files": {
        "pdf": "https://archive.orkl.eu/4245d60547605ffedc778613ce46f7367150f90f.pdf",
        "text": "https://archive.orkl.eu/4245d60547605ffedc778613ce46f7367150f90f.txt",
        "img": "https://archive.orkl.eu/4245d60547605ffedc778613ce46f7367150f90f.jpg"
    }
}