{
    "id": "13d6a63f-ca83-401a-a9e7-29e2a666821a",
    "created_at": "2023-01-12T15:06:36.722745Z",
    "updated_at": "2025-03-27T02:15:17.324929Z",
    "deleted_at": null,
    "sha1_hash": "c0b451546d64e16bdc932cf612ad5bf87907d289",
    "title": "2022-03-03 - Threat Hunting for Malicious PowerShell Usage in Gigasheet",
    "authors": "",
    "file_creation_date": "2022-05-27T18:57:42Z",
    "file_modification_date": "2022-05-27T18:57:42Z",
    "file_size": 3823433,
    "plain_text": "# Threat Hunting for Malicious PowerShell Usage in Gigasheet\n\n**[gigasheet.co/post/threat-hunting-for-malicious-powershell-usage-in-gigasheet](https://www.gigasheet.co/post/threat-hunting-for-malicious-powershell-usage-in-gigasheet)**\n\nSyed Hasan March 3, 2022\n\nSyed Hasan\n\n6 min read\n\nPowerShell exploitation has become one of the most lucrative attack vectors for threat\nactors. In this blog, we’ll uncover some of the most common ways to hunt for malicious\nPowerShell. Let’s get to operationalizing these threat hunts! �\n\n\n-----\n\n## PowerShell: A Threat Actors’ Favorite\n\nEver wonder why PowerShell is the go-to tool for threat actors, after they gain initial access?\n\nPowerShell is a Microsoft-developed, cross-platform utility, most extensively deployed on\nWindows endpoints and servers. It is often the default choice used to automate tedious\ntasks, configurations, and interfacing with the Windows operating system. As such, you can\nimagine how deeply rooted and pervasive it is on the machine.\n\nWith its own scripting language, command-line shell, and ability to hide in plain sight,\nPowershell in the wrong hands leads to very destructive outcomes, as does happen today.\nPowerShell is a favorite amongst several threat actors, the likes of which include HAFNIUM,\nAPT38, APT33, Bazar, and others.\n\n## Hunting PowerShell: Where are the Payloads?\n\n\n-----\n\nLet s kick off the juicy part of the blog. I ve got several hunt use-cases which can easily be\noperationalized to detect PowerShell baddies in a Windows-based infrastructure. Before we\ndiscuss the hunts, let’s quickly ingest our logs to Gigasheet.\n\n**Uploading PowerShell Logs to Gigasheet**\n\nIf enhanced logging is enabled on Windows-based systems, PowerShell logs events in three\nlog channels:\n\nWindows PowerShell\n\nMicrosoft-Windows-PowerShell Operational\n\nMicrosoft-Windows-PowerShell Admin\n\nYou can fetch these log files from the folder: C:\\Windows\\System32\\winevt\\Logs\\\n\nGigasheet [can easily handle native evtx](https://www.gigasheet.co/post/online-evtx-parser-and-viewer) (event)log files. Simply log in, head over to the Your\n_Files page, and click on Upload. Drag and drop your log files, however large they are, and let_\nGigasheet crunch the data for you.\n\n\n-----\n\n**_Fun Fact: Gigasheet can handle up to a billion rows without breaking a sweat. Care to_**\n_challenge us? Go ahead!_\n\n**PowerShell Downgrade Attacks**\n\nIsn’t PowerShell a great tool for offensive operations? Well, it does a great job at logging\neach operation as well. But there’s a little catch; these security features need to be enabled\nand are only available in versions above 5. As such, threat actors love to downgrade\nPowerShell and take a toll on the system by subverting all defenses.\n\nBut could we really not detect PowerShell if it was downgraded? Well, we can. Yes, the\nscript-block logging and transcription are not going to work anymore but the default\n**_Windows PowerShell channel still logs a bit of information for us to detect suspicious_**\nactivity.\n\nWe’re particularly interested in the EngineVersion field which logs the PS engine which was\nused to execute the command from the user. A value of 2 (or below 5) are of interest as they\ncan indicate execution using a downgrade.\n\nDouble-click the recently uploaded PowerShell log file and let’s start by filtering for the value:\n**_EngineVersion=2. Whew, out of ~17 thousand rows, we get just 33 results. That’s excellent_**\nnoise reduction. But the problem is - this version of PowerShell doesn't log anything beyond\nthe engine version. So what can we do here?\n\nWell, you could pivot from the Windows PowerShell log channel to the Security log channel.\nExecution of PowerShell, regardless of the version, is likely going to log an event if you’ve\ngot process command-line logging enabled. Simply fetch the date and time, ingest Security\nlogs into Gigasheet, and run a comparison against time.\n\n\n-----\n\nHere s an example search against time. See how the -version 2 flag is used to downgrade\nPowerShell and later, the ls command is executed to list the directory.\n\n**_Note: If you’re having trouble taking note of the fields’ long name, simply rename them to_**\n_something meaningful. Gigasheet allows you to take full control of your data once you’ve_\n_uploaded it!_\n\n**Obfuscated Commands**\n\nPowerShell has in-built support for encoding and compressing data. Obfuscation of this kind\ncan greatly help attackers deliver payload across the network without ringing alarm bells.\nHowever, scripting languages like PowerShell make it just as easy to detect these\ncommands!\n\nLet’s start off easy. Look for the -EncodedCommand parameter or variations of it to detect\nany base-64 encoded commands. Mind you - there are hundreds of variations which you can\nuse to hunt for this very parameter. Here’s a handy regular expression from the fellows at\nUnit42:\n\n**_\\-[Ee^]{1,2}[NnCcOoDdEeMmAa^]+ [A-Za-z0-9+/=]{5,}_**\n\n\n-----\n\n**_Credits:_** [Unit42](https://unit42.paloaltonetworks.com/unit42-pulling-back-the-curtains-on-encodedcommand-powershell-attacks/)\n\nWe can search for these commands by using the Search in FIles feature in Gigasheet.\nAlternatively, we can filter on the same using the contains operator. As a result of our filters,\nwe get just 50 rows to analyze. On the right - you can see an open row with an encoded\ncommand as part of the PowerShell process. It decodes to whoami which is a common\ncommand used for reconnaissance.\n\nThough there’s one other way you can detect encoded commands in Gigasheet! Simply use\nthe Character Count feature and sort the rows by size to see what rows rank the highest.\nOutliers are where you’re likely going to see encoded commands since they’re abnormally\nlonger in length.\n\n\n-----\n\nNotice the length of the EventData field. Let’s run a few aggregations against the column\nnow. We’ll start off by grouping the data against the EventID field. You can do so by rightclicking on the column and pressing Group.\n\n\n-----\n\nHow about a quick minimum and maximum aggregation on the length column from the\n_Character Count function? Group the data using a field - I’ll be using the EventID field. Once_\ndone, click the arrow by the Length field to select your desired aggregation. I’ll be choosing\nthe min and max aggregations for a quick comparison.\n\nSee how the minimum value is close to ~300. Yet the maximum values touch ~2700. Clearly,\nthere are outliers which we might want to investigate.\n\n\n-----\n\n-----\n\nOpen up an event ID of your interest (say 400), and let s sort the EventData (Length) field in\ndescending order. See how the text field is filled with lots of junk data. Reading the entire\ncommand, we can see it has the -e flag to execute encoded commands. Other malware\nsamples might also include the GZipStream or MemoryStreamcalls for in-memory\nexecution or compressed streams of data.\n\nWe can also continue our analysis by decoding this data using a tool like Cyberchef. There’s\nthe payload in plain-text. Follow-up to this would be analyzing the decoded PowerShell\npayload, extracting IoCs, and taking action.\n\n**Fileless Malware**\n\n\n-----\n\nPowerShell is also preferred by threat actors for its ability to execute binaries (called\nassemblies in PS) in-memory. Leaving no trace on disk, the only artifacts left behind are logs\n\n- which if disabled can render a visibility gap for forensic analysts.\n\nInvocation of functions like Invoke-Expression and System.Reflection.Assembly (Load)\nare good indicators of in-memory execution. Apart from function calls, we can also look for\nweb requests to retrieve resources which might later be piped into the calls we previously\ndiscussed. GitHub hosts one of the largest corpus of red-team scripts which are also utilized\nby threat groups to compromise systems. As such, we can also use requests to\n**_*.githubusercontent.com* as an indicator of suspicious activity._**\n\nLet’s use this information to supercharge our PowerShell hunt.\n\nFiltering on githubusercontent, we get just ~400 events. That’s a bit noisy but there’s a\ngreat chance they’re all suspicious.It’d be even more intriguing to see these logs if your\norganization blocked traffic to GitHub yet this log popped up. Although the execution\n_would’ve likely failed, you’re still witnessing a log from an ongoing compromise._\n\nFor instance, this log shows a reference to Invoke-Mimikatz which is the PowerShellequivalent module of the notorious credential dumper, Mimikatz. Successful execution could\nmean your credentials have been compromised and need to be changed immediately.\n\n\n-----\n\nBut, hey, where’s this actually executed? This log doesn’t show execution. Here’s another log\nwhich shows how the download is enclosed within an Invoke-Expression call to execute the\nretrieved code directly into memory - leaving no file on the disk.\n\n\n-----\n\nYou can proceed with your analysis by looking for the ScriptBlock in the PowerShell\nOperational log source (if you had the configuration enabled). It logs the entire downloaded\nand executed script. However, if a downgrade attack was performed in conjunction, you’re\nlikely going to be stuck with the command only.\n\nHere’s the log for the Invoke-Mimikatz call which has over 139 ScriptBlock events in total:\n\n## What’s Next?\n\nI’ve just covered hunting strategies against some of the most commonly used attack\ntechniques by threat actors. PowerShell isn’t going away any sooner. It’s better this way that\nhunters and defenders work on sound strategies to hunt for these threats proactively.\n\nThat’s it for this article - but you can continue your threat hunts on Gigasheet for free! That’s\nright. Use [this link to sign up on Gigasheet and get started now!](https://beta.gigasheet.co/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-03 - Threat Hunting for Malicious PowerShell Usage in Gigasheet.pdf"
    ],
    "report_names": [
        "2022-03-03 - Threat Hunting for Malicious PowerShell Usage in Gigasheet.pdf"
    ],
    "threat_actors": [
        {
            "id": "529c1ae9-4579-4245-86a6-20f4563a695d",
            "created_at": "2022-10-25T16:07:23.702006Z",
            "updated_at": "2025-03-27T02:02:09.93109Z",
            "deleted_at": null,
            "main_name": "Hafnium",
            "aliases": [
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "ETDA:Hafnium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "7c969685-459b-4c93-a788-74108eab6f47",
            "created_at": "2023-01-06T13:46:39.189751Z",
            "updated_at": "2025-03-27T02:00:03.017103Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "ATK233",
                "G0125",
                "Operation Exchange Marauder",
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "MISPGALAXY:HAFNIUM",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f426f0a0-faef-4c0e-bcf8-88974116c9d0",
            "created_at": "2022-10-25T15:50:23.240383Z",
            "updated_at": "2025-03-27T02:00:55.404232Z",
            "deleted_at": null,
            "main_name": "APT38",
            "aliases": [
                "APT38",
                "NICKEL GLADSTONE",
                "BeagleBoyz",
                "Bluenoroff",
                "Stardust Chollima",
                "Sapphire Sleet",
                "COPERNICIUM"
            ],
            "source_name": "MITRE:APT38",
            "tools": [
                "ECCENTRICBANDWAGON",
                "HOPLIGHT",
                "Mimikatz",
                "KillDisk",
                "DarkComet"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2704d770-43b4-4bc4-8a5a-05df87416848",
            "created_at": "2022-10-25T15:50:23.306305Z",
            "updated_at": "2025-03-27T02:00:55.43633Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "HAFNIUM",
                "Operation Exchange Marauder",
                "Silk Typhoon"
            ],
            "source_name": "MITRE:HAFNIUM",
            "tools": [
                "Tarrask",
                "ASPXSpy",
                "Impacket",
                "PsExec",
                "China Chopper"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "b23e717c-0b27-47e0-b3c8-4defe6dd857f",
            "created_at": "2023-01-06T13:46:38.367369Z",
            "updated_at": "2025-03-27T02:00:02.815758Z",
            "deleted_at": null,
            "main_name": "APT33",
            "aliases": [
                "ATK35",
                "Peach Sandstorm",
                "TA451",
                "APT 33",
                "Elfin",
                "Refined Kitten",
                "MAGNALLIUM",
                "HOLMIUM",
                "COBALT TRINITY",
                "G0064"
            ],
            "source_name": "MISPGALAXY:APT33",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9fe49a5b-f3e6-4fbf-99a1-db15dad460c3",
            "created_at": "2024-05-01T02:03:08.045004Z",
            "updated_at": "2025-03-27T02:05:17.325038Z",
            "deleted_at": null,
            "main_name": "COBALT TRINITY",
            "aliases": [
                "Elfin ",
                "HOLMIUM ",
                "MAGNALIUM ",
                "Peach Sandstorm ",
                "Refined Kitten ",
                "TA451 ",
                "APT33 "
            ],
            "source_name": "Secureworks:COBALT TRINITY",
            "tools": [
                " Cadlotcorg",
                " Dello RAT",
                " Imminent Monitor",
                " KDALogger",
                " Koadic",
                " NanoCore",
                " NetWire",
                " POWERTON",
                " PoshC2",
                " Poylog",
                " PupyRAT",
                " Schoolbag",
                "AutoCore"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8bc1a044-a23b-4904-903c-13f463605cb3",
            "created_at": "2024-05-01T02:03:08.136237Z",
            "updated_at": "2025-03-27T02:05:17.415795Z",
            "deleted_at": null,
            "main_name": "NICKEL GLADSTONE",
            "aliases": [
                "Bluenoroff ",
                "CTG-6459 ",
                "Citrine Sleet ",
                "HIDDEN COBRA ",
                "Lazarus Group",
                "Sapphire Sleet ",
                "Stardust Chollima ",
                "APT38 "
            ],
            "source_name": "Secureworks:NICKEL GLADSTONE",
            "tools": [
                " Bankshot",
                " CATCH22",
                " CCGC_Proxy",
                " Cur1Agent",
                " Ratankba",
                " Server_TrafficForwarder",
                " Wcry",
                "AlphaNC"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a2b92056-9378-4749-926b-7e10c4500dac",
            "created_at": "2023-01-06T13:46:38.430595Z",
            "updated_at": "2025-03-27T02:00:02.831633Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Operation DarkSeoul",
                "APT38",
                "ATK117",
                "DEV-1222",
                "G0032",
                "APT 38",
                "Stardust Chollima",
                "APT-C-26",
                "ATK3",
                "Diamond Sleet",
                "Hidden Cobra",
                "Unit 121",
                "Subgroup: Bluenoroff",
                "NICKEL GLADSTONE",
                "DEV-0139",
                "Andariel",
                "Operation Troy",
                "COVELLITE",
                "TA404",
                "Lazarus group",
                "Dark Seoul",
                "G0082",
                "NewRomanic Cyber Army Team",
                "Bluenoroff",
                "Appleworm",
                "Nickel Academy",
                "COPERNICIUM",
                "Hastati Group",
                "Bureau 121",
                "Operation AppleJeus",
                "Whois Hacking Team",
                "Citrine Sleet",
                "Sapphire Sleet",
                "Group 77",
                "Labyrinth Chollima",
                "Operation GhostSecret",
                "BeagleBoyz"
            ],
            "source_name": "MISPGALAXY:Lazarus Group",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e5ff825b-0456-4013-b90a-971b93def74a",
            "created_at": "2022-10-25T15:50:23.824058Z",
            "updated_at": "2025-03-27T02:00:55.553346Z",
            "deleted_at": null,
            "main_name": "APT33",
            "aliases": [
                "APT33",
                "HOLMIUM",
                "Elfin",
                "Peach Sandstorm"
            ],
            "source_name": "MITRE:APT33",
            "tools": [
                "PowerSploit",
                "AutoIt backdoor",
                "PoshC2",
                "Mimikatz",
                "NanoCore",
                "DEADWOOD",
                "StoneDrill",
                "POWERTON",
                "LaZagne",
                "TURNEDUP",
                "NETWIRE",
                "Pupy",
                "ftp",
                "Shamoon"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535996,
    "ts_updated_at": 1743041717,
    "ts_creation_date": 1653677862,
    "ts_modification_date": 1653677862,
    "files": {
        "pdf": "https://archive.orkl.eu/c0b451546d64e16bdc932cf612ad5bf87907d289.pdf",
        "text": "https://archive.orkl.eu/c0b451546d64e16bdc932cf612ad5bf87907d289.txt",
        "img": "https://archive.orkl.eu/c0b451546d64e16bdc932cf612ad5bf87907d289.jpg"
    }
}