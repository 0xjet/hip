{
    "id": "f8996341-c454-4957-bff7-62f02a07927a",
    "created_at": "2023-03-03T02:05:22.673566Z",
    "updated_at": "2025-03-27T02:12:11.098801Z",
    "deleted_at": null,
    "sha1_hash": "4a6603f402f64adce020dd569f1fa592fbcc1385",
    "title": "2014-04-02 - Tofsee botnet",
    "authors": "",
    "file_creation_date": "2023-03-01T09:37:52Z",
    "file_modification_date": "2023-03-01T09:37:52Z",
    "file_size": 3254285,
    "plain_text": "# Virus Bulletin :: Tofsee botnet\n\n**virusbulletin.com/virusbulletin/2014/04/tofsee-botnet**\n\n## Tofsee botnet\n\n2014-04-02\n\n### Ryan Mi\n\nFortinet, Canada\nEditor: Helen Martin\n**Abstract**\n\nThe spam botnet Tofsee can be divided into three components: loader, core module and\nplug-ins. Ryan Mi describes how the components communicate with the C&C server, and\nhow they work with one another.\n\nThe spam botnet Tofsee, a.k.a. ‘GHEG’, has been active for many years. I first encountered\nit in May 2013, since when I have been monitoring its activities. Based on my analysis, the\nTofsee botnet can be divided into three components: loader, core module and plug-ins. In\nthis article I will describe how the components communicate with the C&C server, and how\nthey work with one another.\n\n## The loader\n\nThe loader is a relatively simple and independent component compared with the other two.\nUsually, the file comes from a social network and disguises itself as an interesting picture.\nAfter successfully luring victims into executing it, the loader will communicate with a list of\nC&C servers that are hard-coded within its code, then download and run the core module. At\nthe same time, it downloads a picture file and displays it to the victim.\n\nFigure 1 shows the initial communication between the victim machine and the C&C server.\n\n\n-----\n\n**Figure 1. Initial communication between victim and C&C server.**\n\nThe loader’s request contains parameters that provide the Windows version and system bit\ntype to the C&C server. The reply from the C&C server is encrypted. After decryption, the\ninformation is revealed in the following format: KEYS(l,u,p), Path, URL, Content-Length. An\nexample is shown in Figure 2, with the corresponding values:\n\n11, name03, 3sRd6Nf8H, tsone/ajuno.php,\nhxxp://wickedreport.com/images/2009/05/naughty-elephant.jpg, 25\n\nThe ‘KEYS(l,u,p)’and ‘Path’ value will be used to connect to the same C&C server again and\nto download the core module binary. The ‘URL’ value is the link to download the picture file.\n\n\n-----\n\n**Figure 2. Victim downloads the core module.**\n\n## The core module\n\nThe core module is the main control component. It hides itself in the victim system, keeps\ntalking to the C&C server, fetches new configuration data and loads plug-ins.\n\nAlthough the core module connects to the C&C server through ports 443, 995 or 465, the\nconnections are not standard SSL. The streams between them are encrypted by a\ncustomized encryption routine. After setting up the TCP connection, the C&C server will send\na 200-byte package to the core module. The decrypted data includes an initialized 128-byte\nkey table, the victim’s public IP address, server status flags, etc. (see Figure 3).\n\n\n-----\n\n**Figure 3. 200-byte package sent to the core module that includes the key table.**\n\nThe core module inspects the package received from the C&C server. If all goes well, the\ncore module will generate a package which includes local information (such as: local time,\nunique ID, system version, etc.) and send it back to the C&C server. The core module will\nuse the key table and a hard-coded key string, ‘abcdefg’, for encryption to generate the\npackage. From this point on, communication between the victim and the C&C server will use\nthe key table and the hard-coded key string for encryption and decryption.\n\nNext, the server may return a new C&C server list (Figure 4) or request local configuration\ninformation from the victim and provide some new configuration files to the core module.\n\n\n-----\n\n**Figure 4. New C&C server list.**\n\nIn Tofsee, at the beginning of each configuration, there are a couple of bytes that indicate the\nlength and CRC value of the configuration data. Following these bytes, the configuration can\nbe divided into three parts: configuration type, configuration name and configuration data.\nFor example, we can see in Figure 4 that the configuration type is 1, the name is ‘work_srv’,\nand the rest is the corresponding data. Each specific type of configuration contains different\nconfiguration data. For example, configuration type 1 contains a list of C&C servers;\nconfiguration type 5 is for plug-ins; configuration type 7 contains string variables for spam.\n\nFigure 5 shows some of the configurations collected from Tofsee C&C servers.\n\n\n-----\n\n**Figure 5. List of Tofsee configurations.**\n\nThe name gives us a general idea of what each configuration is for. Types 7 and 8 in\nparticular have a large number of configurations. These contain string variables which will be\nused by the email template to generate random spam emails.\n\nFigure 6 shows part of the template from the configuration ‘3-psmtp_task’.\n\n\n-----\n\n**Figure 6. Part of the configuration template.**\n\nIn the template, we found many variables such as %RNDRCOLOR, %RND_DEXL,\n%EVA_URL, etc. So, for example, Figure 7 shows the content of configuration ‘7%EVA_URL’.\n\n\n-----\n\n**Figure 7. A list of URLs in a configuration for spam email.**\n\nIn the lower half of configuration ‘3-psmtp_task’ there is a small script for sending spam\nusing the ‘direct-to-MX’ method. Figure 8 shows part of the script.\n\n\n-----\n\n**Figure 8. The lower half of ‘3-psmtp_task’.**\n\nOnce Tofsee’s core module has been deployed in the victim system, the C&C server will\nsend it lots of new configurations every day. Figure 9 shows information based on my\ntracking data. (Note that the statistics were generated on 10 January 2014.)\n\n\n-----\n\n**Figure 9. Updating frequency of Tofsee configurations.**\n\nSome of the configurations were updated quite frequently, especially those with ‘URL’ as part\nof their names. It is interesting to see that the configuration ‘3-psmtp_task’ has not been\nupdated for a while, even though it is still top of the list, as shown in Figure 9. It appears that\nconfiguration types 11 and 8 were introduced recently.\n\n\n-----\n\nThe type 11 configuration has a similar data structure to 3-psmtp_task . It uses type 8 to\ngenerate spam. These have been introduced to replace the ‘3-psmtp_task’ configuration, as\nwe can tell from the update times shown in Figure 10.\n\n**Figure 10. Type 11 configuration.**\n\nOne more thing about the configuration is that, based on my data, the Tofsee C&C servers\nhave not been changed frequently. Configurations ‘1-start_srv’ and ‘1-work_srv’ contain a list\nof C&C servers, as shown in Figure 11. (Please refer to Figure 4 for the content of these\nconfigurations.) These C&C servers are mainly hosted in Malaysia, Hong Kong and Eastern\nEuropean countries.\n\n\n-----\n\n**Figure 11. Configurations that contain a list of C&C servers.**\n\n## The plug-ins\n\nThe plug-ins are of configuration type 5. From the data in Figure 12, we can tell that the plugins are not updated frequently. The most recently updated one, ‘5-12’, is related to\nspamming.\n\n**Figure 12. List of plug-ins.**\n\nThe following is a list of plug-ins and their names:\n\n5-1: plg_ddos\n\n5-2: plg_antibot - kill\n\n5-3: plg_sniff\n\n5-4: plg_proxy\n\n5-5: plg_webm\n\n5-6: plg protect\n\n\n-----\n\n5-7: plg_locs\n\n5-11: plg_text\n\n5-12: psmtp\n\n5-14: plg_miner\n\n5-16: plg_spread1\n\n5-17: plg_spread2\n\n5-18: plg_sys_cfg\n\nAll of the plug-ins received from the C&C server are loaded into the core module’s memory\nand run under the core module. All of the plug-ins are DLL files and have the same exported\nfunction, ‘plg_init’, which will be called by the core module to initialize them.\n\nFigure 13 shows the part of the core module code that loads the plug-ins.\n\n**Figure 13. Snippet of core module code for loading the plug-ins.**\n\nThe function ‘plg_init’ only takes one parameter, ‘Function_Structure’, which is a big array of\nfunction memory locations. ‘Function_Structure’ is first initialized by the core module, and\nlater the plug-ins will update it by adding or removing items. Since the core module and the\nplug-ins all run under the same process, they can share different functions with one another.\nFigure 14 shows how the plug-in ‘5-4’ accesses functions.\n\n\n-----\n\n**Figure 14. Snippet of plug-in code to access functions using ‘Function_Structure’.**\n\nTofsee’s overriding behaviour is spamming, of course. However, its use of plug-ins allows for\nadditional functionality. So far, based on my analysis, the binaries that have been\ndownloaded from the C&C server have functionalities such as DDoSing, sniffing, rootkit\nprotection and litecoin mining.\n\nWe will continue to keep an eye on this botnet to see what new features appear and how it\nevolves.\n\n## Latest articles:\n\n### Cryptojacking on the fly: TeamTNT using NVIDIA drivers to mine cryptocurrency\n\nTeamTNT is known for attacking insecure and vulnerable Kubernetes deployments in order\nto infiltrate organizations’ dedicated environments and transform them into attack\nlaunchpads. In this article Aditya Sood presents a new module introduced by…\n\n### Collector-stealer: a Russian origin credential and information extractor\n\nCollector-stealer, a piece of malware of Russian origin, is heavily used on the Internet to\nexfiltrate sensitive data from end-user systems and store it in its C&C panels. In this article,\nresearchers Aditya K Sood and Rohit Chaturvedi present a 360…\n\n\n-----\n\n### Fighting Fire with Fire\n\nIn 1989, Joe Wells encountered his first virus: Jerusalem. He disassembled the virus, and\nfrom that moment onward, was intrigued by the properties of these small pieces of selfreplicating code. Joe Wells was an expert on computer viruses, was partly…\n\n### Run your malicious VBA macros anywhere!\n\nKurt Natvig wanted to understand whether it’s possible to recompile VBA macros to another\nlanguage, which could then easily be ‘run’ on any gateway, thus revealing a sample’s true\nnature in a safe manner. In this article he explains how he recompiled…\n\n### Dissecting the design and vulnerabilities in AZORult C&C panels\n\nAditya K Sood looks at the command-and-control (C&C) design of the AZORult malware,\ndiscussing his team's findings related to the C&C design and some security issues they\nidentified during the research.\n\n[Bulletin Archive](https://www.virusbulletin.com/virusbulletin/archive)\n\n_Copyright © 2014 Virus Bulletin_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2014/2014-04-02 - Tofsee botnet.pdf"
    ],
    "report_names": [
        "2014-04-02 - Tofsee botnet.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f809bfcb-b200-4988-80a8-be78ef6a52ef",
            "created_at": "2023-01-06T13:46:39.186988Z",
            "updated_at": "2025-03-27T02:00:03.016358Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "Adept Libra"
            ],
            "source_name": "MISPGALAXY:TeamTNT",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c3ca592f-0669-49bd-ab5c-310007ab2fb4",
            "created_at": "2022-10-25T15:50:23.334495Z",
            "updated_at": "2025-03-27T02:00:55.445098Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "TeamTNT"
            ],
            "source_name": "MITRE:TeamTNT",
            "tools": [
                "Peirates",
                "MimiPenguin",
                "LaZagne",
                "Hildegard"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1677809122,
    "ts_updated_at": 1743041531,
    "ts_creation_date": 1677663472,
    "ts_modification_date": 1677663472,
    "files": {
        "pdf": "https://archive.orkl.eu/4a6603f402f64adce020dd569f1fa592fbcc1385.pdf",
        "text": "https://archive.orkl.eu/4a6603f402f64adce020dd569f1fa592fbcc1385.txt",
        "img": "https://archive.orkl.eu/4a6603f402f64adce020dd569f1fa592fbcc1385.jpg"
    }
}