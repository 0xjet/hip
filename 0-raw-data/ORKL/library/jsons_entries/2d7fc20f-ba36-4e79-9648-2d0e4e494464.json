{
    "id": "2d7fc20f-ba36-4e79-9648-2d0e4e494464",
    "created_at": "2023-01-12T15:09:12.312958Z",
    "updated_at": "2025-03-27T02:06:10.366627Z",
    "deleted_at": null,
    "sha1_hash": "943753b29c5f4714d0b0de1629add1b0af2ba2a2",
    "title": "2021-02-01 - BazarLoader Mocks Researchers in December 2020 Malspam Campaign",
    "authors": "",
    "file_creation_date": "2022-05-27T22:31:54Z",
    "file_modification_date": "2022-05-27T22:31:54Z",
    "file_size": 628822,
    "plain_text": "# BazarLoader Mocks Researchers in December 2020 Malspam Campaign\n\n**[gosecure.net/blog/2021/02/01/bazarloader-mocks-researchers-in-december-2020-malspam-campaign/](https://www.gosecure.net/blog/2021/02/01/bazarloader-mocks-researchers-in-december-2020-malspam-campaign/)**\n\nLilly Chalupowski February 1, 2021\n\n## Preface\n\nOur Inbox Detection and Response (IDR) team has observed a new BazarLoader campaign targeting the information\ntechnology, aeronautic and financial industries. The IDR team has successfully blocked over 550 thousand BazarLoader\nmalspam emails throughout this campaign alone.\n\nGoSecure researchers received a sample from the IDR team which was suspected of being BazarLoader, named Report\n_Preview15-10.exe, on 2020-10-06. Shortly after, GoSecure researchers received yet another BazarLoader sample on 2020-_\n_10-08 named Document2-85.exe, which exhibited similar behavior._\n\n## Analysis\n\nThe initial infection vector, which has been observed by our Inbox Detection and Response Team (IDR), is via malspam\ncontaining fake employment termination notices and anonymous surveys. The threat actor(s) primarily use Google Drive\nand Google Docs to distribute their malicious payloads. The employment termination malspam was observed on October 6,\n2020 and the anonymous survey malspam was observed on October 8, 2020. This can be seen in Figure 1 and Figure 2.\n\n_Figure 1: BazarLoader Employment Termination Malspam_\n\n_Figure 2: BazarLoader Fake Anonymous Survey_\n\nWe will firstly analyze the employment termination malspam.\n\nOnce the user clicks the link, they will be redirected to\n\nhxxps://docs[.]google[.]com/document/d/e/2PACX1vR_9tGGWDcS1ZyIuiGpMQg2Sv9nRWempyUKuQ1iyJp_HHt1C87OPirnO7EImnOW6ILbrmHXUpl_OIxQ/pub to\ndownload an executable\n\n\n-----\n\nThe executable Review_Report15 10.exe (3c27fca6d9cf1379eee93e6fea339e61) will appear as a\nPDF document to users who do not have extensions enabled in Windows, as seen in Figure 3.\n\n_Figure 3: Stage 1 PDF Icon Lure_\n\nTo help obfuscate its purpose, BazarLoader appears to be bound or obfuscated with legitimate resources from YUVPlayer\n_(A Lightweight YUV player which supports various YUV formats). An example of this can be seen in Figure 4._\n\n_Figure 4: YUVPlayer Dialog Embedded Resource_\n\nOnce executed, the legitimate application or dialogs will not be shown to the user. Instead, it will call\n```\nadvapi32.CryptHashData using the string s_)q03vcOm95^+Rj3dG_Jx@k0GGwYOIddH_14025b520 as the data to create\n\n```\na hash using the `PROV_RSA_FULL Windows cryptographic provider. Once the hash is created, it will create a key using`\n```\nadvapi32.CryptDeriveKey . It will then obtain a handle to the current process for the purpose of allocating memory with\nPAGE_EXECUTE_READWRITE permissions. The next function is responsible for copying the shellcode from the .data\n\n```\nsection to the newly allocated memory location. Once the encrypted shellcode has been copied to executable memory, it\nwill then use `advapi32.CryptEncrypt to decrypt the shellcode. Once the shellcode has been successfully decrypted, it`\nwill execute the shellcode.\n\n\n-----\n\n_Figure 5: BazarLoader Shellcode Decryption Routine_\n\n_Figure 6: Executing Stage 1 Decrypted Shellcode_\n\nThe shellcode will obtain a handle to `kernel32.LoadLibraryA,` `kernel32.GetProcAddress,`\n```\nkernel32.VirtualAlloc, kernel32.VirtualProtect and ntdll.ZwFlushInstructionCache, by enumerating the\n\n```\nProcess Environment Block (PEB) using the instruction `mov rax,qword ptr gs: [60] . This is common with shellcode`\nas it will need to resolve these APIs dynamically to interact with the Windows operating system.\nOnce completed, it will then call `kernel32.VirtualALloc to prepare injecting a PE executable for the next stage. To`\nbuild the PE header, it will use the routine shown in Figure 7.\n\n_Figure 7: Prepare Stage 2 PE_\n\nOnce PE header has been partially copied (excluding MZ magic value), it will start to copy the `.text section using the`\nroutine shown in Figure 8.\n\n\n-----\n\n_Figure 8: Copy .text Section_\nOnce the `.text section is copied, it will start resolving many different Windows APIs using` `kernel32.GetProcAddress .`\n\nWhen the additional APIs have been resolved, it will then make the `.text section it copied earlier executable using`\n```\nkernel32.VirtualProtect, as seen in Figure 9.\n\n```\n_Figure 9: Make .text Section Executable_\n**NOTE:** _On different debugging sessions the virtual addressing changed during analysis._\n\n\n-----\n\nInterestingly, the Portable Executable (PE) BazarLoader is copied into memory (without the MZ\nheader) and will start execution at the end of the `.text section using a direct` `call . This can make unpacking the next`\nstage confusing for reverse engineers as this is not where code in a PE file is supposed to begin. This code at the end of\nthe `.text section is solely responsible for making a call to the real Original Entrypoint (OEP) of the PE. It is important to`\nnote that this is simply used as shellcode and not as a PE in memory. The other benefit of this technique is no calls to\nthread related APIs are required, making it more challenging for Endpoint Detection and Response (EDR) solutions to\ndetect. This can be seen in Figure 10.\n\n_Figure 10: OEP Shellcode/PE Trickery_\nAfter the previous trickery in the new memory space, it will start creating another PE in memory, but this time the header\ndoes start with the MZ magic value. After building the headers, it will copy each PE section one at a time, as seen in Figure\n_11._\n\n_Figure 11: Building .text Section for Stage 2_\nOnce the PE has been extracted to memory, it will make a direct call instead of using Threading APIs (same trickery as\nbefore). This can be seen in Figure 12.\n\n_Figure 12: Calling Stage 2 Shellcode_\nBazarLoaderâ€™s stage 2 shellcode will make use of encrypted stack strings for many purposes\n\nthroughout the rest of its code.\n\nBefore it continues with its malicious activity, it will check if the locale is Armenian (0x2b). Interestingly, instead of shutting\ndown gracefully when the Armenian locale is detected, it will execute a `jmp instruction to an invalid address, causing an`\naccess violation exception. We have seen Russian crimeware checking for the Armenian keyboard layout previously in\nmalware such as KPot, we hypothesize this could be similar behavior.\n\n\n-----\n\nTo avoid running more than one instance of itself, BazarLoader will create a mutex with a hard coded UUID, then use\n```\nkernel32.GetLastError to check for the error ERROR_ALREADY_EXISTS . If the mutex already exists, it will exit the\n\n```\nprocess. The call to `kernel32.CreateMutexA can be seen in Figure 13.`\n\n_Figure 13: Mutex Creation_\nInterestingly, BazarLoader will check for mutexes twice.\n\nOnce completed, it will decyrpt its C2 configuration, as seen in Figure 14.\n\n_Figure 14: BazarLoader Stage 2 Decrypted Downloader Config_\nOnce BazarLoader has determined the Armenian language is not being used and another instance of itself is not running, it\nwill make a HTTP HEAD request to hxxps://titlecs[.]com. It will continue to do this until it receives a `200 response from the`\nC2 server. The first request will be sent using `wininet.HttpSendRequestA, as seen in Figure 15.`\n\n_Figure 15: HTTP HEAD Request_\nIt is important to note that the HTTP header `Update is not a standard header and can be considered anomalous.`\nThis HEAD request can be seen in Figure 16.\n\n\n-----\n\n_Figure 16: BazarLoader C2 Download Domain HEAD Request_\nThe C2 server will respond with a `200 OK message.`\n\nBazarLoader will also check if it is connected to the internet by making a request to microsoft[.]com, as seen in Figure 17.\n\n_Figure 17: BazarLoader Internet Connectivity Check_\nOnce completed, it will make a POST request to the second domain in its configuration, as seen in Figure 18.\n\n_Figure 18: BazarLoader C2 Checkin_\nOnce completed, it will make a HTTP GET request in order to obtain the next stage, as seen in Figure 19.\n\n\n-----\n\n_Figure 19: BazarLoader Downloading Encrypted Payload_\n\n## Differences Between Versions\n\nThere are a few notable differences between the first version of BazarLoader sent on 2020-10-06 (Employment Termination\nMalspam) and the one sent on 2020-10-08 (Survey Malspam). The main difference between the two versions is the\nmalware author(s) now include the string Stupid Defender to mock researchers, the shellcode that was stored in the\n```\n.data section is now stored in the .rsc section, the functionality to get a pointer to the encrypted shellcode and to\n\n```\ndecrypt it have been broken out into their own separate functions. This can be seen in Figures 20 and 21.\n\n\n-----\n\n_Figure 20: Updated Main Shellcode Decryption/Execution Routine_\n\n_Figure 21: Obtain Encrypted Pointer to Encrypted Shellcode from the Resource Section_\n\n_Figure 22: Encrypted Shellcode in Resource Section_\n\n## Summary\n\nBazarLoader is becoming increasingly popular amongst threat actors. We suspect the reason behind the malware\ndeveloper(s) success is their use of techniques such as avoiding the use of threading APIs and faking PE injection, when in\nreality, it is simply shellcode injection. These techniques are likely used to confuse Endpoint Detection and Response\n(EDR) solutions.\n\n## Indicators of Compromise\n\n\n-----\n\n**Indicator** **Description**\n\nhxxps://titlecs[.]com/issues/284 BazarLoader\nEncrypted\nPayload URL\n\nhxxps://titlecs[.]com/issues/282 BazarLoader\nEncrypted\nPayload URL\n\nhxxp://ds46x1[.]com/1/run BazarLoader\nEncrypted\nPayload URL\n\nlabelcs[.]com BazarLoader\nC2 Domain\n(Employment\nTermination\nMalspam)\n\nmixcinc[.]com BazarLoader\nC2 Domain\n(Employment\nTermination\nMalspam)\n\nnicknamec[.]com BazarLoader\nC2 Domain\n(Employment\nTermination\nMalspam)\n\n3c27fca6d9cf1379eee93e6fea339e61 BazarLoader\nShellcode\nInjector\n(Preview1510.exe)\n\n3ee60e0efeb5b349a5ba7325ce4a33dc BazarLoader\nShellcode\nInjector\n(Document285.exe)\n\n\nhxxps://docs[.]google[.]com/document/d/e/2PACX\n1vR_9tGGWDcS1ZyIuiGpMQg2Sv9nRWempyUKuQ1iyJp_HHt1C87OPirnO7EImnOW6ILbrmHXUpl_OIxQ/p\n\nhxxps://docs[.]google[.]com/document/d/e/2PACX\n1vQ7wK9C0fLCwS3voYLhGz3Gmy6g4UMKe_xZ1ds8xv7LonpviJBXefG9rBZuMPkmtytDYe_5rbDztBnK/pub\n\n\nEmployment\nTermination\nMalspam\nPayload URL\n\nSurvey\nMalspam\nPayload URL\n\n\nds45x1[.]com BazarLoader\nC2 Domain\n(Survey\nMalspam)\n\nds46x1[.]com BazarLoader\nC2 Domain\n(Survey\nMalspam)\n\nds47x1[.]com BazarLoader\nC2 Domain\n(Survey\nMalspam)\n\n\n-----\n\nmarcene[.]jack[at]peytoneley[.]com BazarLoader\nMalspam\nEmail\n\n\nshannon[.]ong35[at]myhunter[.]cuny[.]edu\n\nBazarLoader Malspam\n\n\nBazarLoader\nMalspam\nEmail\n\n\nbessie[.]wilson[at]griply[.]com BazarLoader\nMalspam\nEmail\n\n## Researchers\n\nLilly Chalupowski\nPaul Neuman\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-02-01 - BazarLoader Mocks Researchers in December 2020 Malspam Campaign.pdf"
    ],
    "report_names": [
        "2021-02-01 - BazarLoader Mocks Researchers in December 2020 Malspam Campaign.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536152,
    "ts_updated_at": 1743041170,
    "ts_creation_date": 1653690714,
    "ts_modification_date": 1653690714,
    "files": {
        "pdf": "https://archive.orkl.eu/943753b29c5f4714d0b0de1629add1b0af2ba2a2.pdf",
        "text": "https://archive.orkl.eu/943753b29c5f4714d0b0de1629add1b0af2ba2a2.txt",
        "img": "https://archive.orkl.eu/943753b29c5f4714d0b0de1629add1b0af2ba2a2.jpg"
    }
}