{
    "id": "0ef6ce6f-da0c-4ba0-8c73-4c81d9f57e43",
    "created_at": "2023-01-12T14:59:03.956563Z",
    "updated_at": "2025-03-27T02:12:13.853325Z",
    "deleted_at": null,
    "sha1_hash": "06fe5f6e0504e8aa2a12b3f455c4892517c254e4",
    "title": "2020-04-15 - Multistage FreeDom loader used in Aggah Campaign to spread Nanocore and AZORult",
    "authors": "",
    "file_creation_date": "2022-05-28T19:34:11Z",
    "file_modification_date": "2022-05-28T19:34:11Z",
    "file_size": 4516305,
    "plain_text": "# Multistage FreeDom Loader Used to Spread AZORult and NanoCore RAT\n\n**[zscaler.com/blogs/research/multistage-freedom-loader-used-spread-azorult-and-nanocore-rat](https://www.zscaler.com/blogs/research/multistage-freedom-loader-used-spread-azorult-and-nanocore-rat)**\n\n[In March 2020, ThreatLabz observed several Microsoft Office PowerPoint files being used](https://www.zscaler.com/threatlabz/threat-map-dashboard)\nin the wild by a threat actor to spread AZORult and NanoCore RAT. The malicious files in\nthis campaign used an interesting payload delivery method that distinguishes it from the\ncommon malware delivery methods observed on a daily basis. The infection chain is\nmodular, with multiple stages involved before the final payload is executed on the machine.\n\nSince the last week of March 2020, we observed a few changes in the encoding method\nand the macro code used in the loader, which we will also describe in this blog.\n\nThis campaign is active in the wild at the time of this writing.\n\nWe provide a technical description of the infection chain and the unique indicators found in\nthe files, which we used to categorize the loader with a specific name. We also used the\nunique delivery method used in this campaign, along with other attributes, to correlate this\n[threat actor to the Aggah campaign, which was documented in April 2019 by Unit 42.](https://unit42.paloaltonetworks.com/aggah-campaign-bit-ly-blogspot-and-pastebin-used-for-c2-in-large-scale-campaign/)\n\nThe older instances of the campaign in 2019 were used to spread the Revenge RAT. In the\nnew instances, we have observed a few changes in the campaign in addition to the type of\nfinal payload delivered.\n\n## Email delivery method\n\nThe malware delivery method in this campaign involves sending Microsoft Office\nPowerPoint files as attachments to the users. An example of the email is shown in Figure 1.\n\n\n-----\n\n_Figure 1: An email targeting users in Indonesia._\n\nFigure 2 shows two more email samples that show the threat actor targeting users in South\nKorea.\n\n_Figure 2: An email targeting South Korean users with an analysis report theme._\n\n\n-----\n\n_Figure 3: An email targeting South Korea users with a business proposal theme._\n\nBased on the analysis of the email content and email headers, we concluded that this threat\nactor has been actively targeting users in the Asian subcontinent, specifically South Korea\nand Indonesia. The content of the emails varies from business proposals to product price\nnegotiations.\n\n## Technical analysis of the multistage loader\n\nWe will take a Microsoft Office PowerPoint file as an example to demonstrate the infection\nchain and the various steps involved in it.\n\nThe MD5 hash for this is: 0b0b570451b699d96c70ebf400628caa.\n\n### Macro-based downloader [Stage 1]\n\nThe PowerPoint file contains a macro that leverages mshta to download the next stage\npayload from Pastebin. Auto_Close() in the macro ensures that the malicious code is\nexecuted only when the file is closed.\n\nAll the instances we observed in March 2020 were using j.mp as the shortened URL service\nto download the next stage payload.\n\nThe relevant macro code is shown in Figure 4.\n\n_Figure 4: The macro code in the Microsoft Office file used to download the next stage._\n\n\n-----\n\nThe shortened URL redirects to the Pastebin URL: hxxps://pastebin[.]com/raw/rsbLNHJg,\nwhich contains the encoded next stage. We can see in Figure 5 that this Pastebin account\nbelongs to the username LUNLAYLOO.\n\n_Figure 5: The encoded content of the next stage hosted on Pastebin._\n\nFigure 6 shows a screenshot of the Pastebin account hosting this content. All the content\nhosted by this user on Pastebin is set to private.\n\n\n-----\n\n_Figure 6: All the pastes under the username Lunlayloo on Pastebin are set to private._\n\nAmong all the samples we analyzed in this campaign, the Pastebin accounts that were\nused to host the multiple stages belonged only to three individuals (listed below) and they\nwere re-used across all the samples.\n\nlunlayloo\nredcobalt\ngogga7\n\n### JavaScript loader [Stage 2]\n\nWith the help of a macro, it downloads an encoded VBScript from Pastebin as shown in\nFigure 7.\n\n_Figure 7: The obfuscated JavaScript downloaded by the macro._\n\n\n-----\n\nThe encoding method used was consistent across all the samples we observed in March\n2020. In the newer variants seen in the wild, we observed a few changes in the encoding\nmethod, which we will describe later in this blog.\n\nThe URL-encoded text was decoded using the unescape() function.\n\nThe decoded script is a VBScript as shown in Figure 8.\n\n_Figure 8: The decoded VBScript used to download the next stage and start the infection_\n_chain._\n\nThe main operations performed at this stage are:\n\n1. It creates a scheduled task with the name Pornhub. This task leverages mshta to\n\ndownload the next stage payload from Pastebin as well. We observed the scheduled\ntask name set to Pornhub in all the samples used in this campaign, which is another\nindicator we used to correlate the samples.\n2. The same command that was scheduled in step 1 is also immediately executed to\n\nstart the infection chain.\n3. It creates the following three Windows registry keys for persistence (used for the\n\nbackup plan as the name indicates) to ensure that the infection chain begins once the\nmachine is restarted.\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\BACKup2\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\BACKup3\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\\n\nThe fact that this VBScript ensures that a scheduled task is created and three backup\nWindows Registry keys are created for persistence indicates that the attacker took extra\nmeasures to ensure that the infection chain starts on the machine.\n\n### VBScript leverages PowerShell [Stage 3]\n\n\n-----\n\nIn Stage 3, another encoded VBScript is fetched from Pastebin as shown below.\n\n_Figure 9: The encoded VBScript downloaded in Stage 3._\n\nThis VBScript, once decoded, looks as shown in Figure 10.\n\n_Figure 10: The VBScript uses PowerShell to load .NET assemblies._\n\nAs we can see in the decoded VBScript, it leverages PowerShell to continue the infection\nchain.\n\nBelow are the main operations performed by the PowerShell command line:\n\n1. Set the TLS version to 1.2 by setting SecurityProtocolType to 3072.\n2. Download a Base64 encoded blob from Pastebin. This Base64 encoded blob decodes\n\nto another PowerShell script as shown in Figure 11. The script is executed by calling\nIEX (Invoke Execution). We will describe this script in more detail later.\n\n\n-----\n\n_Figure 11: The PowerShell code that is used to decompress the .NET loader._\n\nIt then downloads another payload from Pastebin. This payload contains the hex\nrepresentation of the binary code with the characters “K_E” instead of “0x” as shown in\nFigure 12. By performing a simple replace operation, this payload is passed as a byte array\nto the function: [Givara]::FreeDom(). We will refer to this payload as payload2.\n\n\n-----\n\n_Figure 12: The encoded malicious binary downloaded from Pastebin._\n\nThe MD5 hash of the payload is: 60221d709e0ad65bb23bd00a3977c55d\n\nThis corresponds to the AZORult Delphi binary file. We will not be describing the\nfunctionality of this binary in detail in this blog since it is a well-known infostealer. The\nstrings are available in plain text and the screenshot in Figure 13 shows the strings\ncorresponding to information it steals (Skype, Telegram, Steam, cryptocurrencies, Pidgin\nand others).\n\n\n-----\n\n_Figure 13: The Unicode strings in the binary file that corresponds to the information stolen._\n\nAcross all the samples we observed in this campaign, the final payload varied between\nAZORult and NanoCore infostealer binaries.\n\nWe observed that the function name [Givara]::FreeDom() in the loader was consistent\nacross all the samples.\n\nThe function name appears to be a reference to Che Guevara who is remembered as a\nfreedom fighter by many.\n\n### PowerShell starts the FreeDom loader [Stage 4]\n\nLet's take a look at the PowerShell script, which was downloaded in step 2 of stage 3. This\nPowerShell script contains a GZip compressed .NET binary, which will be decompressed\nand stored in the variable $decompressedByteArray\n\nStage 3 will reference the variable $decompressedByteArray to load it as a .NET assembly\nusing the method [System.Reflection.Assembly]::Load().\n\nThe MD5 hash of the loader is: c726636d2b7f8c838f7f882071181c95.\n\n\n-----\n\nThe method [Givara]::FreeDom() is defined in the .NET loader and it is used to load the\ninfostealer malicious binary (in this case, AZORult).\n\nSo the payload execution is triggered using the following syntax:\n\nGuevara_Loader. [Givara]::FreeDom(‘notepad.exe’, infostealer_binary)\n\nHere, Guevara_Loader refers to the .NET binary used to load and inject the final infostealer\nbinary in the notepad.exe process.\n\nIt is important to note that there were no changes made to the loader binary by the threat\nactor throughout the campaign.\n\n## FreeDom .NET loader analysis\n\nThe .NET loader binary is protected using the Confuser Ex 1.0.0 obfuscator.\n\nOn VirusTotal, the first instance of the loader was observed on January 16, 2020.\n\nAfter removing the Confuser Ex 1.0.0 protection, we can decompile the binary successfully.\n\nThe [Givara]::FreeDom function, which is passed the string, notepad.exe and the AZORult\nbinary, is shown in Figure 14.\n\n_Figure 14: This is the main function of the FreeDom loader._\n\nThe parameters for FreeDom function are as follows:\n\nFTONJ – A string called notepad.exe\n\nCoco – The byte array corresponding to the AZORult binary\n\nThe HeHe class checks for the presence of notepad.exe in different system paths on the\nmachine. Once it locates the file, it passes that to the tickleme() function along with the\nAZORult byte array as shown in Figure 15.\n\n\n-----\n\n_Figure 15: It check for the presence of notepad.exe and injects the AZORult binary into it._\n\nThe tickleme() function, in turn, calls a function called FUN(), which is responsible for\nstarting a new instance of the notepad.exe process and injecting the AZORult binary into it\nusing the process hollowing method.\n\n## Macro code changes in new variants\n\nThe newer variants in this campaign updated the encoding method and the macro used.\n\nAs an example, let us look at a macro-based PowerPoint file with MD5 hash:\n7db36d502e4a1d35873c8a0c51bafbbf\n\nThe newer variant of the macro is as shown in Figure 16.\n\n_Figure 16: The macro code in the new variant._\n\nIn this new variant, the macro creates a Windows persistence key in the location:\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\ and adds the command line\nto leverage mshta to download the malicious next stage payload.\n\nAs a result, the infection chain does not start unless the machine is rebooted.\n\nAlso, we observed the macro using the bit.ly URL shortening link directly instead of the j.mp\nURL shortening link observed in the previous variant.\n\n\n-----\n\n## Encoding changes in the new variant\n\nThe other key change we observed in the new variant is in the script encoding used for\neach stage. In the previous variant, the encoding method was simple because it just\ninvolved URL encoding and the unescape() function was called to decode it.\n\nAn example of the new encoding method is as shown in Figure 17.\n\n_Figure 17: The JavaScript code using a new encoding method for multiple stages._\n\nThis method calls eval() two times. The first eval() call corresponds to the JavaScript\nfunction, which is responsible for XOR decryption. The second eval() call corresponds to\nexecuting the script decrypted by the first eval() call.\n\nThe XOR decryption stub is as shown in Figure 18.\n\n_Figure 18: The XOR decryption script._\n\n## Changes in the final payload\n\n\n-----\n\nThe final payload downloaded in the newer variants is a NanoCore RAT unlike AZORult or\nRevenge RAT observed in previous instances of the campaign. In this specific example, the\nMD5 hash of the NanoCore payload is: 35de5c352023db9d406a835ef7f318e5.\n\nWe mention briefly how the NanoCore RAT is encrypted here.\n\nThe .NET assembly contains a bitmap image in the resource section as shown in Figure 19.\n\n_Figure 19: The bitmap resource inside the .NET binary._\n\nThe bitmap image is accessed from the resource with the\nname “WinForms.Library.Properties.Resources”. The encrypted .NET assembly is extracted\nfrom the pixels of the bitmap image. This encrypted assembly is decrypted using an XOR\ndecryption routine and finally loaded using the Assembly.Load() method.\n\nThe relevant code sections are shown in Figure 20.\n\n\n-----\n\n_Figure 20: Extracting, decrypting and loading the .NET assembly._\n\nThe next stage .NET assembly is a loader that is used to decrypt the final .NET assembly,\nwhich is injected into another process and executed.\n\nFigure 21 shows the configuration of the next stage .NET assembly.\n\n\n-----\n\n_Figure 21: The main configuration of the .NET loader._\n\nThe final payload is encrypted and stored inside a resource with the name “OSkRTM8”.\nThis payload is decrypted as shown in Figure 22.\n\n_Figure 22: Payload decryption._\n\nThis decrypted payload is injected as shown in Figure 23.\n\n_Figure 23: The code injection invocation._\n\nThe MD5 hash of the injected payload is: 7679fec5f6bf7206635b96efa52d1d07.\n\nBelow are relevant strings from the binary which indicate it is NanoCore\n\n\n-----\n\n00000000FEF5  000000411CF5   0  NanoCore Client\n\n00000000FF05  000000411D05   0  NanoCore Client.exe\n\nAnd the configuration used by this instance of the NanoCore RAT is shown in Figure 24.\n\nFigure 24: The NanoCore RAT configuration file.\n\nThe C&C server is listening on port 54932 at the IP address 216.170.114.4.\n\n## Cloud Sandbox detection\n\n[Figure 25 shows the Zscaler Cloud Sandbox successfully detecting this PowerPoint-](https://www.zscaler.com/products/sandboxing)\nbased threat.\n\n_Figure 25: Zscaler Cloud Sandbox detection._\n\nIn addition to sandbox detections, Zscaler’s multilayered cloud security platform detects\nindicators at various levels.\n\n\n-----\n\n## Conclusion\n\nThis threat actor combines multiple stages in the infection chain to make detection difficult\nover the network. The tactics, techniques and procedures (TTPs) used by this threat actor\nare also evolving with time.\n\nAs an extra precaution, users should not enable macros for Microsoft Office files that are\nreceived from untrusted sources since these macros have the capability to run malicious\ncode on your machine.\n\nThe Zscaler ThreatLabZ team will continue to monitor this campaign, as well as others, to\nhelp keep our customers safe.\n\n## Indicators of compromise\n\n### PowerPoint files, old variant\n\nf934dc6b441789365d5aa641bbf8ef3f\n\n0b0b570451b699d96c70ebf400628caa\n\nb825645e1132c77550d14503974c9ea2\n\n89e3d26cdc862e47d6c7d665135e28d6\n\ndc01e01fea24cf2f2a208d62e219889b\n\n16ac16400e2f1f125664b62c16be9c88\n\n4cfea775333d107ec43d621aa4c9968b\n\n4d299bee18901eb48929f3b493f65699\n\ncd425ac433c6fa5b79eecbdd385740ab\n\n### PowerPoint files, new variant\n\nbbe077e2cd3c321427a16557d26a3438\n\ncc53f0a1a256678ba7d79aa475128d9c\n\n7db36d502e4a1d35873c8a0c51bafbbf\n\n13ae5088ae7e5ac1335a573d52befabc\n\n7083ee8cabbf500a3b286b8027f8f9fe\n\n\n-----\n\n2d3b0a3369e7a33b5c3e3115d7fa5a58\n\n9f8db1103850e43681ea79cec06e13c7\n\n56b4f3bc5b500d4120b55ff3dcaf1cc9\n\n5d926bae6c76e8b86192c205c49cd195\n\nf35b21cf37fbdae346858b490a0f230a\n\n### Network IOCs\n\n23.247.102[.]10/manabotnet/index.php\n\n23.81.246[.]150/manabotnet-stryka/index.php\n\nwon2020.duckdns[.]org:3090\n\n216.170.114[.]4: 54392\n\n### Pastebin users\n\nhttps://pastebin[.]com/u/lunlayloo\n\nhttps://pastebin[.]com/u/redcobalt\n\nhttps://pastebin[.]com/u/gogga7\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-04-15 - Multistage FreeDom loader used in Aggah Campaign to spread Nanocore and AZORult.pdf"
    ],
    "report_names": [
        "2020-04-15 - Multistage FreeDom loader used in Aggah Campaign to spread Nanocore and AZORult.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "28851008-77b4-47eb-abcd-1bb5b3f19fc2",
            "created_at": "2023-06-20T02:02:10.254614Z",
            "updated_at": "2025-03-27T02:00:03.130853Z",
            "deleted_at": null,
            "main_name": "Hagga",
            "aliases": [
                "TH-157",
                "Aggah"
            ],
            "source_name": "MISPGALAXY:Hagga",
            "tools": [
                "Agent Tesla"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b0d34dd6-ee90-483b-bb6c-441332274160",
            "created_at": "2022-10-25T16:07:23.296754Z",
            "updated_at": "2025-03-27T02:02:09.724313Z",
            "deleted_at": null,
            "main_name": "Aggah",
            "aliases": [
                "Operation Red Deer",
                "Operation Roma225"
            ],
            "source_name": "ETDA:Aggah",
            "tools": [
                "AgenTesla",
                "Agent Tesla",
                "AgentTesla",
                "Aggah",
                "Atros2.CKPN",
                "Bladabindi",
                "Jorik",
                "Nancrat",
                "NanoCore",
                "NanoCore RAT",
                "Negasteal",
                "Origin Logger",
                "Revenge RAT",
                "RevengeRAT",
                "Revetrat",
                "Warzone",
                "Warzone RAT",
                "ZPAQ",
                "Zurten",
                "njRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535543,
    "ts_updated_at": 1743041533,
    "ts_creation_date": 1653766451,
    "ts_modification_date": 1653766451,
    "files": {
        "pdf": "https://archive.orkl.eu/06fe5f6e0504e8aa2a12b3f455c4892517c254e4.pdf",
        "text": "https://archive.orkl.eu/06fe5f6e0504e8aa2a12b3f455c4892517c254e4.txt",
        "img": "https://archive.orkl.eu/06fe5f6e0504e8aa2a12b3f455c4892517c254e4.jpg"
    }
}