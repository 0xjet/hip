{
    "id": "03f92654-7e63-4417-89e8-8b0e26773840",
    "created_at": "2023-01-12T15:10:36.278357Z",
    "updated_at": "2025-03-27T02:08:23.145146Z",
    "deleted_at": null,
    "sha1_hash": "235d249c2126b7705522713418ef6db0369399c3",
    "title": "2018-07-24 - Emotet- The Tricky Trojan that ‘Git Clones’",
    "authors": "",
    "file_creation_date": "2022-05-27T22:17:02Z",
    "file_modification_date": "2022-05-27T22:17:02Z",
    "file_size": 564806,
    "plain_text": "# Emotet: The Tricky Trojan that ‘Git Clones’\n\n**[research.checkpoint.com/emotet-tricky-trojan-git-clones/](https://research.checkpoint.com/emotet-tricky-trojan-git-clones/)**\n\nJuly 24, 2018\n**Research by: Ofer Caspi, Ben Herzog**\n\n\nJuly 24, 2018\n\n\nThe Emotet Trojan downloader originally debuted in 2014 as a banking Trojan that took an\nunusual approach to stealing banking credentials; Instead of hooking per-browser functions\nin the victim’s web browser process, Emotet directly hooked network API functions.\n\nFour years have passed since 2014 and Emotet continues to be a point of interest; not many\nwould-be botnets live to see their fourth birthday. With their ear to the ground on Twitter,\nanalysts have been rather preoccupied with Emotet – and for good reason. Despite its age,\nEmotet is far from just barely alive. It spreads itself abundantly through spam emails, network\nshares and the Rig Exploit Kit. While some features have stayed constant, during the four\nyears of Emotet’s lifecycle, modules have come and gone. Most significantly, the banking\nmodule, previously the malware’s core functionality, was [removed at some point in 2017.](https://www.cert.pl/en/news/single/analysis-of-emotet-v4/)\n\n\n-----\n\n**Figure 1: A comparative heat map of Emotet’s impact per country (measured by number of**\naffected organizations). Red indicates a larger amount of organizations affected.\n\nThere are several things that stand out about Emotet, but foremost among them is its\nmodular structure and complex ecosystem. To have a working business model, it is\ntechnically enough to have The C&C server say “here, take this file and execute it”. As a\nresult, it’s not every botnet that bothers to set up an ecosystem of modules, let alone one\nthat even has the concept of a “version”. But Emotet does, including a communication\nprotocol built on top of Google’s Protobuf, utilizing LZMA compression and built on\nasymmetric crypto. The authors would probably take “over-engineered” as a compliment.\n\nThe use of Protobuf is not an isolated incident. Emotet is uncharacteristically eager to\nemploy third-party open source code. Most malware authors just can’t be bothered to do a\nliterature review of existing solutions to their problem, and would rather re-invent the wheel.\nSome authors do admit defeat and incorporate one-or-another piece of third-party code into\ntheir creation, but that’s still nothing compared to the leap made by the Emotet team, whose\ncode directory tree literally has an “Open Source” folder in it. Apart from communication\nprotocols implemented with Protobuf, Emotet features, for example, web servers written in\n[Libevent and encryption built on top of OpenSSL. In the category of conspicuous interest in](https://github.com/libevent/libevent)\nthe open source community, this puts Emotet squarely ahead of the vast majority of malware\n(and narrowly behind Microsoft).\n\nEmotet is invested in the technical cat-and-mouse game of malware ‘author vs. analyst’ more\n[than could possibly be healthy (for either the author or the analyst). Where the GandCrab](https://research.checkpoint.com/gandcrab-ransomware-mindset/)\nguys went for banter and spectacle, the Emotet team went with a grim, humorless\n\n\n-----\n\ndetermination to use every method they could think of to stick it to the man with the\ndisassembler.\n\nJust one example — in Code Obfuscation 101 you read about “converting control flow\nstructures into a state machine”; it then remains one of those things-that-could-theoreticallybe-done, like using difficult opaque predicates or compiling the malware with The\nMovfuscator. Emotet goes and actually uses a state machine for its main control flow.\n\n**Figure 2: Libevent strings from Emotet – or, as we’ve recently taken to calling it,**\nGNU/Emotet.\n\n**Technical Details**\n\n**Main Module / Dropper**\n\nThe main functionality of Emotet’s dropper is three-fold:\n\n1. Update the malware to its latest version.\n2. Achieve persistence on the victim system.\n3. Download and execute the modules, which serve as the malware’s main payload.\n\nBy updating itself with high frequency and constantly rotating its C&C servers, Emotet stays\nahead of signature-based AV products and manages to retain the foothold that it has in the\nbotnet arena. This same principle applies to the dropper executable itself, hosted on\nEmotet’s C&C server. Frequently rotating it, and the accompanying modules, makes sure\nthat during at least the few following hours, AV signatures will not be able to simply patternmatch the files as malicious, and will have to rely on more advanced and more delicate\nmethods such as ML engines and behavioral analysis. The dropper is packed, and while it is\nconstantly rotated, most of the functionality stays constant and changes tend to be minor.\n\nAs is standard for malware strains of this type, the Emotet dropper collects information from\nthe infected machine such as the Computer and User name, OS version, and the list of\nprocesses running on the victim machine.\n\n\n-----\n\nOnce all this information is gathered and the malware is updated to its latest version, Emotet\nsends a request to the C&C server. Addresses of potential live C&C servers, and the Emotet\nservers’ RSA public key, are all hard-coded in the malware executable. The addresses are in\nplain IP format followed by a port number (somewhat atypically; malware authors usually\nfavor domain names). Communication is encrypted with a randomly-generated AES key,\nwhich is encrypted using the server public key and appended to the message. This protocol\nis unusually cryptographically sound and even a person with full access to the malware\nsample and a traffic log will be unable to recover the original communication, unless the\noriginal process that spawned the AES key is still running.\n\nAssuming the request successfully goes through, the C&C server responds with an up-todate list of modules. Usually during this transaction the infected client will receive between 2\nand 5 modules; the exact number depends on the information an infected system sends to\nthe C&C. The request method periodically rotates between a GET and a POST, probably as\na small gesture to further frustrate attempts to communicate with the server directly. When\nusing GET, the request body is instead sent as the cookie header.\n\nAs a part of the request, the infected host will include the current malware file hash; the\nserver uses this information to decide whether the Emotet version that issued the request\nneeds to be updated. If the hash is of an old version of the malware, a new Emotet version is\nsent; otherwise, execution proceeds as described above, and the modules are executed.\nWhen responding, the C&C server uses the same AES key that the client sent originally.\n\nOn a typical malware, these communications would take place over raw TCP or HTTP, and\nwould probably use GET request parameters or some homebrew format in the request body\nto transfer information. Encryption or obfuscation might be used, but the underlying protocol\nis almost invariably of this “deadline is due tomorrow” kind. In contrast, Emotet’s messages\n[are constructed and parsed using Protocol Buffers (“ProtoBuf”), Google’s “language-neutral,](https://developers.google.com/protocol-buffers/)\nplatform-neutral, extensible mechanism for serializing structured data”.\n\n\n-----\n\n**Figure 3: The latest protobuf definition structure that the malware has been seen to use.**\n\n**Figure 4: Decompiled code that builds the registration request sent to the C&C server.**\n\n**Figure 5: Overall structure of the registration request being sent.**\n\n\n-----\n\n**Figure 6: A sample traffic capture of an Emotet client request and the server response.**\n\n**Emotet’s Modules**\n\nEmotet’s modules have come and gone over the years. The large variety we have observed\nover time leads us to the conclusion that a module may be tailored to the customer, if the\nprice is right. Based on what we know, we estimate the price of Emotet to be somewhere in\nthe $2000 range.\n\nEmotet’s modules that we’ve seen in the wild so far all share the same general structure:\nThey are DLL files, not packed but otherwise moderately obfuscated. First, a homebrew\nImport Table is constructed by dedicated functions comparing against the functions’ hash\nvalue by a [homebrew hash function. This is similar, but not identical, to methods of full](https://gist.github.com/psrok1/5a67c3306080f62969e8d0e63a988b4e)\ndynamic resolution commonly seen in malware, where every call to a function passes\nthrough a “filter” which searches for that function by hash. Here, all the functions are\nresolved first, and the main flow is reached later. This has the effect of making analysis\n\n\n-----\n\nsomewhat less of a hassle. All DLL names, function names and other incriminating strings\nare obfuscated using a simple rotating XOR cipher (the decryption function for which is,\nitself, obfuscated to make it look rather more complicated than it really is).\n\n**Figure 7: Emotet feeds precomputed function name hash values to its name resolution**\nroutine.\n\nOnce function resolution is done, the module typically proceeds to its main functionality. Here\nthe modules can be separated, in broad strokes, into two types: the “wrapper” modules and\nthe “original” modules.\n\n“Wrapper” modules are modules that are thin wrappers for ready-made data mining\n[executables courtesy of Nirsoft. Under this category, one might find a module dedicated to](https://www.nirsoft.net/)\nmining credentials stored in the user’s web browser, which is just a thin wrapper for the\n[freeware tool WebBrowserPassView, a whole copy of which is embedded into the malware](https://www.nirsoft.net/utils/web_browser_password.html)\n(and encrypted using rotating XOR). Similarly, there is an “email credential stealer” module\n[which is a wrapper for MailPassView.](https://www.nirsoft.net/utils/mailpv.html)\n\n\n-----\n\n**Figure 8: WebBrowserPassView, when not used in headless mode.**\n\n“Original” modules have been implemented from scratch by Emotet’s author. Their tactics\nvary, but our general impression is that most of these do not directly subvert / monetize the\nvictim (as do miners, backdoors, ransomware, etc), and are instead aimed at getting more\npeople infected with Emotet. For instance, one of the modules uses the deprecated Simple\nMAPI interface in order to harvest the list of MS-Outlook’s locally stored email addresses,\nwhich are later used to send Emotet Spam. Even more straightforward is the “Worm”\nmodule, which has a built-in table of passwords that it uses to try and brute-force accessible\nSMB shares, so it can infect more stations on the LAN with Emotet.\n\n**Figure 9: Emotet uses the deprecated Simple MAPI to harvest email addresses.**\n\n**Figure 10: Emotet’s table of common passwords to try against SMB share accounts.**\n\n\n-----\n\n**Figure 11: Typical spam message sent by Emotet.**\n\nOne last curiosity that we have seen is a rather convoluted module that was linked with the\nlibevent library and upnp functionality. Upnp was used to enable port forwarding and make\nthe victim machine accessible from the WAN, whereas Libevent was used to set up a simple\nserver that answers with an “EHLO” to incoming packets. This seems to be some sort of PoC\nor sanity check, checking if the compromised machine has been successfully made\naccessible from the outside, and is available for the C&C to initiate contact with.\n\n\n-----\n\n**Figure 12: The single block of actual user-authored functionality in a 672-function module.**\n\n**Some Samples**\n\nDuring our research, we found it difficult to obtain Emotet modules for testing. Few of the\n(excellent) write-ups on this strain of malware offered access to module hashes, and fewer\nstill had the hashes identified by the module function or were available for download\nanywhere. Obtaining the modules independently requires direct communication using\nEmotet’s overwrought communication protocol, and then the modules themselves that you\nget are somewhat of a lottery (not to mention that, as described above, if you use an out-ofdate executable or protocol you get an updated version of Emotet instead of the modules;\nfinding out about that was fun). Therefore, for what it is worth, we have uploaded the abovementioned modules to VirusTotal, and provide their hashes and descriptions below. These\nwere retrieved late May 2018. We hope they are of use to you.\n\n**sha256** **module**\n**purpose**\n\nd4491f9b885bba06d7ee6e02e6e71272893638bbb92f2c23b9ddf52f8a26a702 Email\naddress\nharvester\n\n\n-----\n\n621c0a11ee0100b8fc3190e471ed4936204e897d97394ba9614ec95f1b69c69C Email\ncredential\nstealer\n\nd7efad30d0a56983fba15f0be28877bd7d55c723388005baa322b94c02540f11 Spam\n\n86cf916c547b6f228b8e7bd4667715db0467c3d141f6226e27025797aeca10ec Browser\nCredential\nStealer\n\n022a5dfe18ee332c020a245cac64f4aa4fc5dd528f79923d00d8ffe376fc76da Connection\nVerifier /\n“EHLO”\nresponder\n\n**Conclusion**\n\nWith its years of experience and sophisticated ecosystem, Emotet seems to be here to stay.\nIts eagerness to make use of open-source libraries, and “do the right thing” in general, is\n[both refreshing and alarming. Easy access to third-party libraries is known to be a powerful](https://xkcd.com/353/)\nstimulant for any development process, and discipline in design definitely has its benefits, as\nwell as its pitfalls. Who knows — maybe in a few years we will see enterprise-grade malware\nwritten in Java which invokes RansomwareResourceMediator.getMediatorInstance() and\nMoneroMinerFactory.getAbstractMiner().\n\n**Detection**\n\nThe following Check Point products detect the Emotet Trojan:\n\n**ThreatCloud: as Emotet (Emotet.TC)**\n**Threat Emulation: as Worm.Win.Emotet.A or Worm.Win.Emotet.B**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-07-24 - Emotet- The Tricky Trojan that ‘Git Clones’.pdf"
    ],
    "report_names": [
        "2018-07-24 - Emotet- The Tricky Trojan that ‘Git Clones’.pdf"
    ],
    "threat_actors": [
        {
            "id": "81dde5cc-c29f-430d-8c6e-e5e92d5015e7",
            "created_at": "2022-10-25T16:07:23.704358Z",
            "updated_at": "2025-03-27T02:02:09.932453Z",
            "deleted_at": null,
            "main_name": "Harvester",
            "aliases": [],
            "source_name": "ETDA:Harvester",
            "tools": [
                "Agentemis",
                "Cobalt Strike",
                "CobaltStrike",
                "Graphon",
                "Metasploit",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536236,
    "ts_updated_at": 1743041303,
    "ts_creation_date": 1653689822,
    "ts_modification_date": 1653689822,
    "files": {
        "pdf": "https://archive.orkl.eu/235d249c2126b7705522713418ef6db0369399c3.pdf",
        "text": "https://archive.orkl.eu/235d249c2126b7705522713418ef6db0369399c3.txt",
        "img": "https://archive.orkl.eu/235d249c2126b7705522713418ef6db0369399c3.jpg"
    }
}