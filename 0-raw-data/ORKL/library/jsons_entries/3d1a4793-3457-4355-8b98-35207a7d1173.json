{
    "id": "3d1a4793-3457-4355-8b98-35207a7d1173",
    "created_at": "2023-01-12T15:00:35.119528Z",
    "updated_at": "2025-03-27T02:05:22.974009Z",
    "deleted_at": null,
    "sha1_hash": "fc4b34faec5674c2e5ee62d513f552eba7c31b48",
    "title": "2021-03-17 - Automatic Gobfuscator Deobfuscation with EKANS Ransomware",
    "authors": "",
    "file_creation_date": "2022-05-28T17:37:40Z",
    "file_modification_date": "2022-05-28T17:37:40Z",
    "file_size": 1393136,
    "plain_text": "# Automatic Gobfuscator Deobfuscation with EKANS Ransomware\n\n**goggleheadedhacker.com/blog/post/22**\n\nJacob Pimental March 17, 2021\n\n### 17 March 2021\n\n[A few months ago I saw an article by Netlab 360 describing the malware BlackRota,](https://blog.netlab.360.com/blackrota-an-obfuscated-backdoor-written-in-go-en/)\n[specifically the obfuscation method used known as gobuscate. I noticed that a deobfuscator](https://github.com/unixpickle/gobfuscate)\n[was made for this using Binary Ninja’s API, so I decided to take a crack at developing a](https://github.com/kryptoslogic/binja_degobfuscate)\nplugin for Cutter. To demonstrate the tool I created, I will also give a brief analysis of another\nmalware sample that uses gobfuscate, Ekans.\n\n## How Gobfuscate Works\n\n### Package Renaming\n\nOne of the things gobfuscate will do is rename package names to make it harder for analysts\nto identify them. It does this by taking the package name, hashing it using sha256, and\nreplacing any numbers in the hash with letters using the algorithm:\n\n```\n’g’ + (x – ‘0’) # x is the current character\n\n```\n\n-----\n\nThis means that the package name contains only the characters `a-p and is irreversible.`\nThe example that the gobfuscate GitHub page gives is that the package\n```\ngithub.com/unixpickle/deleteme becomes\njiikegpkifenppiphdhi/igijfdokiaecdkihheha/jhiofoppieegdaif .\n\n### String Encryption\n\n```\nEach string in the binary is replaced by a function call. Each function contains two bytearrays that are Xor’d together to return the original string. There are a few different ways that\nthe byte-arrays are stored after the binary is compiled. The first way was through a\nhardcoded array.\n\n_Normal byte-array XOR Loop_\n\n\n-----\n\nThe byte-arrays can also be stored in pointers, which are run through the function\n```\nstringslicetobyte and XOR’d together.\n\n```\n_Byte-arrays being stored in pointers_\n\nThese differentiations were noted when designing the deobfuscator, as not all functions will\nbe the same. The names for the string decryption functions always contain `funcN at the`\nend, where `N is an integer value. This makes them easy to spot and write a decryptor for.`\n\n## How the Deobfuscator Works\n\nUsing Cutter’s API I was able to create a plugin that will either deobfuscate the string\nencryption function that the cursor is on or bulk deobfuscate all strings in the current method.\nTo install the deobfuscator you will need to know the location in which Cutter stores plugins.\n\n\n-----\n\nYou can find this by going to `Edit -> Preferences -> Plugins in Cutter.`\n\n_Plugin location for Cutter_\n\n[Then download the python script from the GitHub repository and move it into the](https://github.com/JacobPimental/DeGobfuscate) `Python`\nfolder under `plugins . Cutter will need to be reloaded after this. To use the plugin, right-`\nclick on a gobfuscate function then select either `Plugins -> DeGobfuscate or` `Plugins`\n```\n-> Bulk DeGobfuscate . The decrypted string is added as a comment above the function. If\n\n```\nthe comment doesn’t appear right away, go to `View -> Refresh Contents to refresh the`\nscreen, which should show the comment.\n\n_Example of encrypted string function_\n\nThe deobfuscator utilizes Cutter’s API to loop through the assembly code in the function and\ngrab the two byte-arrays that are present. It will then XOR these together and create a\ncomment at the location. It also checks to see if the arrays are stored in either a pointer or\nare hardcoded into the function.\n\n## Ekans Analysis\n\nThe Ekans ransomware has been associated with attacks on Industrial Control Systems\n(ICS). Ekans does not rely on outside resources to perform its functions. Everything is stored\nwithin the binary itself, mostly using the gobfuscate string encryption functions. This makes it\nan ideal candidate for testing the degobfuscate plugin. You can find this specific sample on\n[Hybrid Analysis. The first step in this analysis will be to use rizin-gohelper to recover the](https://www.hybrid-analysis.com/sample/e5262db186c97bbe533f0a674b08ecdafa3798ea7bc17c705df526419c168b60/5e39b4177476481e3a3953bb)\nfunction names from the gopclntab.\n\nThe first thing the ransomware will do is attempt to create a Mutex `Global\\EKANS . If that`\nMutex already exists then execution will end. It will then create the public key object that it\nwill use to encrypt files using RSA. The public key is stored in a string in the `main.main`\nfunction, which was encrypted by gobfuscate. After running the deobfuscator over this, the\npublic key is shown in a comment above the decryption function. It is best to view multi-line\n\n\n-----\n\ncomments in the disassembly view in Cutter since the graph view only shows the first line.\nThis string will then be passed to Golang’s `pem.Decode function and later the`\n```\nParsePKCS1PublicKey function.\n\n```\n_Creation of Public Key_\n\nAfter this, the ransomware will create an array of objects to whitelist. This includes file\nextensions, file names, directories, and a regex statement. The lists are:\n\n\n-----\n\nFile extensions:\n\n.docx\n.dll\n.exe\n.sys\n.mui\n.tmp\n.lnk\n.config\n.manifest\n.tlb\n.olb\n.blf\n.ico\n.regtrans-ms\n.devicemetadata-ms\n.settingcontent-ms\n.bat\n.cmd\n.ps1\n\n\n-----\n\nFile names:\n\ndesktop.ini\niconcache.db\nntuser.dat\nntuser.ini\nntuser.dat.log1\nntuser.dat.log2\nusrclass.dat\nusrclass.dat.log1\nusrclass.dat.log2\nbootmgr\nbootnxt\nwindir\nSystemDrive\nntldr\nNTDETECT.COM\nboot.ini\nbootfont.bin\nbootsect.bak\ndesktop.ini\nctfmon.exe\niconcache.db\nntuser.dat\nDirectories:\n```\n      :\\\\$Recycle.Bin\n      :\\\\ProgramData\n      :\\\\Users\\\\All Users\n      :\\\\Program Files\n      :\\\\Local Settings\n      :\\\\Boot\n      :\\\\System Volume Information\n      :\\\\Recovery\n      \\\\AppData\\\\\n\n```\nRegex:\n```\n      .+\\\\Microsoft\\\\(User Account Pictures|Windows\\\\\n      (Explorer|Caches)|Device Stage\\\\Device|Windows)\\\\\n\n```\nAll of these strings were encrypted via gobfuscate, which is why the “bulk” option exists.\nEkans will then enumerate drives and grab a list of all files that do not match the whitelists.\nThis new file list will later be passed to worker threads for encryption.\n\n\n-----\n\n_Whitelist creation function_\n\nThe ransomware will then kill a list of 288 hard-coded services. Instead of listing all of the\n[services in this article here, you can find them here. The Ekans process will then kill a list of](https://github.com/JacobPimental/Malware-Analysis-Notes/tree/main/Ekans_Notes)\n1118 processes, which are also included in the linked repository. Ekans will then delete\nshadow copies using a `WbemScripting.SWbemLocator object with the following WMI`\nquery:\n\n```\nSELECT * FROM Win32_ShadowCopy\n\n```\n\n-----\n\nAfter this, the ransomware will create several threads and pass in the filenames to these via\nGolLang’s `channel functions. The threads will take the filenames, encrypt the files, and`\nwrite them back to disk.\n\n_Loop used to create encryption threads_\n\nFinally, the ransom note is dropped to the file `Fix-Your-Files.txt . The note itself is hard-`\ncoded and uses the `sprintf function with the ransomware author’s email to format the`\nnote, which in this case is `bapcocrypt@ctemplar.com .`\n\n\n-----\n\n_Unformatted Ransom Note_\n\n## Conclusion\n\nI did not want to delve too deep into the Ekans ransomware analysis as this was to\ndemonstrate the usefulness of the degobfuscator plugin. This was my first attempt at making\na plugin for Cutter and I enjoyed the challenge very much. I am excited to see what Cutter\nhas in store for the future and will continue to make plugins for it to aid other analysts. As\n[always, if you have any questions feel free to reach out to me on my Twitter or](https://twitter.com/Jacob_Pimental) [LinkedIn.](https://www.linkedin.com/in/jacobpimental/)\n\nThanks for reading and happy reversing!\n\n**Malware Analysis, GoLang, Cutter, Ekans, Ransomware**\n\n## More Content Like This:\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-17 - Automatic Gobfuscator Deobfuscation with EKANS Ransomware.pdf"
    ],
    "report_names": [
        "2021-03-17 - Automatic Gobfuscator Deobfuscation with EKANS Ransomware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535635,
    "ts_updated_at": 1743041122,
    "ts_creation_date": 1653759460,
    "ts_modification_date": 1653759460,
    "files": {
        "pdf": "https://archive.orkl.eu/fc4b34faec5674c2e5ee62d513f552eba7c31b48.pdf",
        "text": "https://archive.orkl.eu/fc4b34faec5674c2e5ee62d513f552eba7c31b48.txt",
        "img": "https://archive.orkl.eu/fc4b34faec5674c2e5ee62d513f552eba7c31b48.jpg"
    }
}