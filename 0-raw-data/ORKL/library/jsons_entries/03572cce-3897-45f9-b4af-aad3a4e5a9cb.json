{
    "id": "03572cce-3897-45f9-b4af-aad3a4e5a9cb",
    "created_at": "2023-01-12T15:06:55.626515Z",
    "updated_at": "2025-03-27T02:06:07.980704Z",
    "deleted_at": null,
    "sha1_hash": "bf528ba127e07804e9762a01a75eaecb65983f76",
    "title": "2021-06-01 - Hex-Rays, GetProcAddress, and Malware Analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T18:26:57Z",
    "file_modification_date": "2022-05-28T18:26:57Z",
    "file_size": 236445,
    "plain_text": "# Hex-Rays, GetProcAddress, and Malware Analysis\n\n**[msreverseengineering.com/blog/2021/6/1/hex-rays-getprocaddress-and-malware-analysis](https://www.msreverseengineering.com/blog/2021/6/1/hex-rays-getprocaddress-and-malware-analysis)**\n\nJune 1, 2021 [Rolf Rolles](http://10.10.0.46/blog?author=5111cf9ee4b0a36262da10df)\n\n\nJune 1, 2021\n\n\nThis entry is about how to make the best use of IDA and Hex-Rays with regards to a\ncommon scenario in malware analysis, namely, dynamic lookup of APIs via\n```\nGetProcAddress (and/or import resolution via hash). I have been tempted to write this\n\n```\nblog entry several times; in fact, I uploaded the original code for this entry exactly one year\nago today. The problem that the script solves is simple: given the name of an API function,\nretrieve the proper type signature from IDA's type libraries. This makes it easier for the\nanalyst to apply the proper types to the decompilation, which massively aid in readability\nand presentability. No more manually looking up and copying/pasting API type definitions,\nor ignoring the problem due to its tedious solution; just get the information directly from the\nIDA SDK. [Here is a link to the script. EDIT LATER: I decided to write a small GUI for the](https://github.com/RolfRolles/Miscellaneous/blob/master/PrintTypeSignature.py)\nfunctionality. [You can find the Hex-Rays GUI plugin here.](https://github.com/RolfRolles/Miscellaneous/blob/master/APIRetypeGUI.py)\n\n## Background\n\nHex-Rays v7.4 introduced special handling for `GetProcAddress . We can see the`\ndifference -- several of them, actually -- in the following two screenshots. The first comes\nfrom Hex-Rays 7.1:\n\nThe second comes from Hex-Rays 7.6:\n\n\n-----\n\nSeveral new features are evident in the screenshots -- more aggressive variable mapping\neliminating the first two lines, and automatic variable renaming changing the names of\nvariables -- but the one this entry focuses on has to do with the type assigned to the return\nvalue of `GetProcAddress . Hex-Rays v7.4+ draw upon IDA's type libraries to automatically`\nresolve the name of the procedure to its proper function pointer type signature, and set the\nreturn type of `GetProcAddress to that type.`\n\nThis change is evident in the screenshots above: for 7.1, the variable is named `v7, its`\ntype is the generic `FARPROC, and the final line shows a nasty cast on the function call. For`\n7.6, the variable is named `IsWow64Process, its type is` `BOOL (__stdcall *)(HANDLE,`\n```\nPBOOL) (the proper type signature for the IsWow64Process API), and the final line shows\n\n```\nno cast. Beyond the casts, we can also see that applying the type signature also changes\nthe types of other local variables: `v5 in the first has the generic type` `int, whereas` `v5`\nhas the proper type `BOOL in the second.`\n\nThese screenshots clearly demonstrate that IDA is capable of resolving an API name to its\nproper type signature, the desirable effects of applying the proper type signature on\nreadability, and the secondary effects of setting the types of other variables involved in\ncalling those APIs.\n\n## Relevance to Malware Analysis\n\nHex-Rays' built-in functionality won't work directly when malware looks up API names by\nhash, or uses encrypted strings for the API names: the decompiler must see a fixed string\nbeing passed to `GetProcAddress to do its magic. Although the malware analysis`\ncommunity seems very comfortable in dealing with imports via hash and encrypted strings,\nthey seem less comfortable with applying proper type signatures to the resultant variables\nand structure members. [Only one publication I'm aware of bothers to tackle this, and it](https://cyber.wtf/2019/03/22/using-ida-python-to-analyze-trickbot/)\nrelies upon manual effort to retrieve the type definitions and create `typedef s for them.`\nThis is unfortunate, as applying said types dramatically cleans up the decompilation output,\nbut this is understandable, as the manual effort involved is rather cumbersome.\n\nAs a result, most publications that encounter this problem feature screenshots like this one.\nNote all of the casts on the function pointer invocations, and the so-called \"partial types\"\n\n`QWORD` etc :\n\n\n-----\n\n(I chose not to link the analysis from which the above screenshot was lifted, because my\ngoal here is positive assistance to the malware analysis community, and not to draw\nnegative attention to anyone's work in particular. This pattern is extremely frequent\nthroughout presentations of malware analysis; it is immaterial who authored the screenshot\nabove, and I had other examples to choose from.)\n\n## The Solution\n\nI did not know how to resolve an API name to its type signature, so I simply reverse\nengineered how Hex-Rays implements the functionality mentioned at the top of this entry.\nThe result is a function `PrintTypeSignature(apiName) you can use in your scripts and`\nday-to-day work that does what its name implies: retrieves and prints the type signature for\nan API specified by name.\n\nThe script includes a demo function `Demo() that resolves a number of API type signatures`\nand prints them to the console. It begins by declaring a list of strings:\n\nThe output of the script is the type signatures, ready to be copied and pasted into the\nvariable type window and/or a structure declaration.\n\n## GUI\n\n\n-----\n\nI decided to add a small GUI to the functionality. After you run [this plugin, you will have a](https://github.com/RolfRolles/Miscellaneous/blob/master/APIRetypeGUI.py)\nnew entry on your Hex-Rays right-click menu that appears when your cursor is over a\npointer-sized local variable, as follows:\n\nOnce you click on that, it will ask you to enter an API name:\n\nIf there are no errors, the script will change the type of the variable to the function prototype\nfor the API.\n\n## A Final Note\n\nArchitecturally, there is a discrepancy between how the Hex-Rays microcode machinery\nhandles type information for direct calls versus indirect ones. To summarize, you may still\nsee casts in the output after applying the proper type signature to a variable or structure\nmember. If this happens, right-click on the indirect call and press `Force call type to`\nforce the proper type information to be applied at the call site. However, only do this once\nyou have set the proper type information for the function pointer variable or structure\nmember.\n\n\n-----\n\nMostly I published this because I want to see more types applied, and fewer casts, in the\nmalware analysis publications that I read. Please, use my script!\n\n## Addendum\n\n[After publishing this article, I was made aware of prior work that is strongly related. That](https://usualsuspect.re/article/ida-tricks-handling-dynamic-imports)\nwork focuses on the same problem, albeit in the disassembly listing rather than in Hex-Rays\n(and hence does not discuss some of the considerations from my entry above). Its ultimate\nsolution is very similar to mine; it includes two out of three API calls from the one I came up\nwith in this entry.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-01 - Hex-Rays, GetProcAddress, and Malware Analysis.pdf"
    ],
    "report_names": [
        "2021-06-01 - Hex-Rays, GetProcAddress, and Malware Analysis.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536015,
    "ts_updated_at": 1743041167,
    "ts_creation_date": 1653762417,
    "ts_modification_date": 1653762417,
    "files": {
        "pdf": "https://archive.orkl.eu/bf528ba127e07804e9762a01a75eaecb65983f76.pdf",
        "text": "https://archive.orkl.eu/bf528ba127e07804e9762a01a75eaecb65983f76.txt",
        "img": "https://archive.orkl.eu/bf528ba127e07804e9762a01a75eaecb65983f76.jpg"
    }
}