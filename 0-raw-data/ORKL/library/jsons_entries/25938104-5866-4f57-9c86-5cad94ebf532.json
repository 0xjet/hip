{
    "id": "25938104-5866-4f57-9c86-5cad94ebf532",
    "created_at": "2023-01-12T15:07:39.463189Z",
    "updated_at": "2025-03-27T02:11:06.201066Z",
    "deleted_at": null,
    "sha1_hash": "2360a211a63de70587ba91f3d6cdb7fc79e0fb85",
    "title": "2017-04-13 - A deeper look into malware abusing TeamViewer",
    "authors": "",
    "file_creation_date": "2022-05-28T02:42:24Z",
    "file_modification_date": "2022-05-28T02:42:24Z",
    "file_size": 1078671,
    "plain_text": "# A deeper look into malware abusing TeamViewer\n\n**[blog.avast.com/a-deeper-look-into-malware-abusing-teamviewer](https://blog.avast.com/a-deeper-look-into-malware-abusing-teamviewer)**\n\n[Jaromír Hořejší 13 Apr 2017](https://blog.avast.com/author/jarom%C3%ADr-ho%C5%99ej%C5%A1%C3%AD)\n\nAnalyzing TeamSpy, malware that gives hackers complete remote control of PCs.\n\nTeamViewer, a remote control program, can be very handy when you need remote IT\nsupport. The cybercriminals behind TeamSpy, unfortunately, also find the tool to be quite\nuseful and use it to carry out malicious activity.\n\nTeamSpy infects computers by tricking people into downloading a malicious attachment and\nenabling macros. After that, the [malware secretly installs TeamViewer, giving the](https://www.avast.com/c-malware)\ncybercriminals full control of the infected computer. TeamSpy first appeared back in 2013,\n[which is when CrySyS Lab and](https://www.crysys.hu/teamspy/teamspy.pdf) [Kaspersky Lab published white papers about its operation.](https://kasperskycontenthub.com/wp-content/uploads/sites/43/vlpdfs/theteamspystory_final_t2.pdf)\n[Heimdal Security recently reported that the malware has resurfaced with a targeted spam](https://heimdalsecurity.com/blog/security-alert-teamspy-turn-teamviewer-into-spying-tool/)\ncampaign. We too have seen an uptick and have therefor decided to take a closer look.\n\n\n-----\n\n## Hiding commands\n\nMost malware communicates with a command and control (C&C) server after infecting a\ndevice. As the name suggests, a C&C server is the control center that sends out commands\nfor malware to carry out. C&C servers are also where malware sends back the data it\ncollects. For this communication, malware authors usually implement a custom protocol,\nwhich can be easily spotted and distinguished from other traffic and thus blocked by antivirus\nsolutions. To make it more difficult for antivirus solutions to detect, some malware authors\nuse popular remote control programs, like TeamViewer, instead to take advantage of their\n[VPN network to better mask the communication between their malware and C&C servers.](https://www.avast.com/c-what-is-a-vpn)\n\n## How TeamSpy infects\n\nTeamSpy is spread via spam emails that are designed to trick people into opening an\nattachment. The attachment is an Excel file with macros. When the attachment is opened,\nthe following screen appears:\n\n\n-----\n\nWhen the macros are enabled by the targeted person, the infection process begins, running\ncompletely in the background, so the victim doesn't notice anything. If we look inside the\nmalicious macro, we can see slightly obfuscated strings, usually split into one or more\nsubstrings, which are later concatenated. The most important information is circled in red\nbelow and are a link, from which something is downloaded, and a password, which will be\nused later.\n\nThe link, disk.karelia.pro, is a legitimate Russian service for uploading and sharing files.\nAlthough the attachment of the downloaded is a PNG, it is actually an EXE file, more\n[specifically it is an Inno Setup installer protected by the password.](http://www.jrsoftware.org/isinfo.php)\n\nWith the help of the [innounp utility, we were able to easily list or extract the files from the Inno](http://innounp.sourceforge.net/)\nSetup installer used by the malware. As shown in the listing below, most of the files are\nregular, digitally signed TeamViewer binaries, with the exception of two files - msimg32.dll\nand tvr.cfg. Tvr.cfg is TeamSpy’s configuration file and will be described later, msimg32.dll is\nthe malware itself. Msimg32.dll is a DLL library which is part of Windows OS. In this case,\n[however, TeamSpy abuses the DLL search order, so that the fake msimg32.dll from the](http://resources.infosecinstitute.com/dll-hijacking-attacks-revisited/)\ncurrent directory is loaded into the process instead of the original msimg32.dll from\n_Windows/System32 directory. The malware itself is in the fake msimg32.dll library._\n\n\n-----\n\n## TeamSpy’s invisibility cloak\n\nNormally when you install the TeamViewer, you see a GUI window with an ID and password,\nwhich the other party needs to know if they want to remotely connect to your computer.\n\n\n-----\n\nIf TeamSpy successfully infects a PC, nothing is shown - remember everything runs in the\nbackground, so that the victim doesn’t notice TeamViewer is installed. This is achieved by\nhooking many API functions and altering their behavior. TeamSpy hooks the following APIs\n(nearly 50 different APIs):\n\nkernel32.dll\n\nCreateMutexW, CreateDirectoryW, CreateFileW, CreateProcessW, GetVolumeInformationW,\nGetDriveTypeW, GetCommandLineW, GetCommandLineA, GetStartupInfoA, MoveFileExW,\nCreateMutexA\n\nuser32.dll\n\nSetWindowTextW, TrackPopupMenuEx, DrawTextExW, InvalidateRect, InvalidateRgn,\nRedrawWindow, SetWindowRgn, UpdateWindow, SetFocus, SetActiveWindow,\nSetForegroundWindow, MoveWindow, DialogBoxParamW, LoadIconW, SetWindowLongW,\nFindWindowW, SystemParametersInfoW, RegisterClassExW, CreateWindowExW,\n\n\n-----\n\nCreateDialogParamW, SetWindowPos, ShowWindow, GetLayeredWindowAttributes,\nSetLayeredWindowAttributes, IsWindowVisible, GetWindowRect, MessageBoxA,\nMessageBoxW\n\nadvapi32.dll\n\nRegCreateKeyW, RegCreateKeyExW, RegOpenKeyExW, CreateProcessAsUserW,\nCreateProcessWithLogonW, CreateProcessWithTokenW, Shell_NotifyIconW, ShellExecuteW\n\niphlpapi.dll\n\nGetAdaptersInfo\n\nSome hooks block the application’s access to some specific resources, e.g. if _[RegCreateKey](https://msdn.microsoft.com/en-us/library/windows/desktop/ms724844(v=vs.85).aspx)_\nor _[RegOpenKey attempt to access the Software\\TeamViewer registry key, the error code:](https://msdn.microsoft.com/en-us/library/windows/desktop/ms724895(v=vs.85).aspx)_\n_ERROR_BADKEY is returned._\n\n[Hooking the GetCommandLine makes TeamViewer think that it was started with a predefined](https://msdn.microsoft.com/en-us/library/windows/desktop/ms683156(v=vs.85).aspx)\npassword (instead of a randomly generated password, TeamViewer users can normally set\nthis password to an arbitrary value by adding a command line parameter)\n\n\n-----\n\n[Hooking SetWindowLayeredAttributes sets the TeamViewer window opacity to 0 (instruction](https://msdn.microsoft.com/en-us/library/windows/desktop/ms633540(v=vs.85).aspx)\n_PUSH 0), which according to the MSDN_ [documentation means the following: “When bAlpha](https://msdn.microsoft.com/en-us/default.aspx)\nis 0, the window is completely transparent. When bAlpha is 255, the window is opaque.”\n\n[Hooking CreateDialogParam blocks some dialogs unwanted by the malware from even being](https://msdn.microsoft.com/en-us/library/windows/desktop/ms645445(v=vs.85).aspx)\ncreated. These dialogs can be looked up in the file TeamViewer_Resource_en.dll, they are\nreferenced with numbers like 10075, see the figure below.\n\nIn case of [ShowWindow, it defines it’s own nCmdShow parameters 4d2h and 10e1h. If other](https://msdn.microsoft.com/en-us/library/windows/desktop/ms633548(v=vs.85).aspx)\nvalues than these are passed, nothing happens.\n\n\n-----\n\n[Probably the most interesting is the hooking of the CreateWindowEx API. Via a series of](https://msdn.microsoft.com/en-us/library/windows/desktop/ms632680(v=vs.85).aspx)\nclass name checks, it identifies a window and other window controls that belong to the\nTeamViewer chat window. With help of a tool like [WinSpy++, we can see all the windows](http://www.catch22.net/software/winspy-17)\nbelonging to the particular process (even if they are hidden). As you can see from the figure\nbelow, there is a ControlWin window, which has several TVWidgets. One widget belongs to\nthe chat - it has two ATL:???????? text edits, one for the chat message history and one for\nthe new chat message, one combo box with a drop down list of chat participants and the\nbutton Send. “message 01” is the received message in the chat, “message 02” is message\nwhich will be sent after clicking the “Send” button. The chat window cannot be normally seen,\nas the malware runs in the background, but it is possible to patch the malware, so that hiding\nwindows does not happen.\n\nThe code snippet below shows how the malware obtains handles to these window controls.\n_[GetWindowLong and](https://msdn.microsoft.com/en-us/library/windows/desktop/ms633584(v=vs.85).aspx)_ [CallWindowProc and](https://msdn.microsoft.com/en-us/library/windows/desktop/ms633571(v=vs.85).aspx) _[SetWindowLong with nIndex = GWL_PROC](https://msdn.microsoft.com/en-us/library/windows/desktop/ms633591(v=vs.85).aspx)_\nreplaces the old address for the window procedure of the chat history text edit with a custom\n\n\n-----\n\nwindow procedure.\n\nThe custom window procedure listens for incoming messages, and based on the window\nmessage id, it either sends a new message or it waits for a reply from the C&C server\n[(EM_SETCHARFORMAT message arrived).](https://msdn.microsoft.com/en-us/library/windows/desktop/bb774230(v=vs.85).aspx)\n\nThe figure below shows how a new message is sent. Malware first sets focus to the new\nmessage text edit with _[WM_SETFOCUS, then it sets the new message edit text by](https://msdn.microsoft.com/en-us/library/windows/desktop/ms646283(v=vs.85).aspx)_\n_[WM_SETTEXT and at last it clicks on the “Send” button by sending BM_CLICK.](https://msdn.microsoft.com/en-us/library/windows/desktop/ms632644(v=vs.85).aspx)_\n\n\n-----\n\nSimilar modifications are applied to most of the 50 APIs listed above. Some patches are very\nsimple, having no more than a few instructions, while some patches are very complex, like\n_[CreateWindowEx. We will not list all of them here, however, the final effect is clear -](https://msdn.microsoft.com/en-us/library/windows/desktop/ms632680(v=vs.85).aspx)_\nTeamViewer’s windows are not displayed to the victim. They silently exist in the system and\nthat’s all.\n\n## Configuration file\n\nTeamSpy’s configuration is stored in tvr.cfg file. It uses a simple custom [encryption algorithm,](https://www.avast.com/c-encryption)\nwhich can be seen below. It reads the input file and uses the password “TeamViewer”. The\nalgorithm runs two counters, cnt1 (0..number of bytes in tvr.cfg ) and cnt2 (0..length of the\npassword). It takes a byte from the password, adds the result of the multiplication cnt1*cnt2.\nThis is done for each character of the password. These results are all XORed, one character\nis produced, and at the end of the loop, it is XORed with the respective byte from the\nconfiguration file. These steps are repeated for all bytes in configuration file.\n\n\n-----\n\nThe decrypted configuration file can be seen below. The names of the parameters are mostly\nself explanatory. The most important for us are the password (infected machine has\npassword “superpass” ) and server1, where the infected machine ID is exfiltrated.\n\n## Phoning home\n\nThe communication between the infected machine and the C&C server is established soon\nafter the infection process starts. The following request is regularly sent. The names of most\nparameters can be clearly deduced.\n\n_id = TeamViewer ID, cybercriminals need this id, which together with the password are_\nenough to remotely connect to the infected computer\n\n_tout = timeout_\n\n_idl = idle time_\n\n_osbt = 32bit/64bit_\n\n_osv = OS version_\n\n_osbd = OS build version_\n\n_ossp = service pack_\n\n\n-----\n\n_tvrv = TeamViewer version_\n\n_uname = user name_\n\n_cname = computer name_\n\n_vpn = has TeamViewer vpn_\n\n_avr = antivirus solution_\n\nWhen we open the C&C server in a web browser, we see the following login page:\n\n## Chat control\n\nThe infected computer is controlled via TeamViewer. Cybercriminals can connect to the\nremote computer (they know the ID and password for TeamViewer) or they can send\ncommands via the TeamViewer chat, to basically do whatever they please on the infected\nmachine. The communication via the TeamViewer chat allows for the basic backdoor\nfunctionalities to be performed: applist, wcmd, ver, os, vpn, locale, time, webcam, genid.\nInside the TeamSpy code, these commands are compared to their crc32 checksums, so\ncollisions can very easily happen. Because crc32(wcmd) = 07B182EB = crc32(aacvqdz),\nboth of these commands are interchangeable.\n\n\n-----\n\nUsing TeamViewer’s legitimate VPN encrypts the traffic and makes it indistinguishable from\nlegitimate TeamViewer traffic. Once the machine is infected, the criminals have full access to\nthe computer. They can steal and exfiltrate sensitive data, download and execute arbitrary\nprograms, and more.\n\nAbusing the legitimate application with sideloading is a clever technique, because not every\nuser checks legitimacy of all the DLL libraries in the same directory. Checking the signature\nof the main executable does not reveal anything suspicious and may let the victim think that\n\n\n-----\n\neverything is alright. See the digital signature of the main update_w32.exe file below. This file\nis not malicious.\n\nIt is important to remember that there are more malware classes that abuse TeamViewer,\nnot just TeamSpy. This blogpost just describes one of them. The principle is, however, similar\nin other malware classes.\n\n5.0 SHAs\n\nXLS with macros\n\n[FE7CA42EE57CEDAD4E539A01A1C38E22F3A4EDC197D95237E056AF02F252C739](https://virustotal.com/en/file/fe7ca42ee57cedad4e539a01a1c38e22f3a4edc197d95237e056af02f252c739/analysis/)\n\nPassword protected Inno Installer\n\n[AD377654518C19BE85FA6BF09570D8D1C8ABA52FFCD83061127851A2DAEF4858](https://virustotal.com/en/file/AD377654518C19BE85FA6BF09570D8D1C8ABA52FFCD83061127851A2DAEF4858/analysis/)\n\nFake msimg32.dll\n\n[921FB1D6E783A6CA70BD1399EA5A18C78027D3016BEA6881F132A253F3C97ED6](https://virustotal.com/en/file/921FB1D6E783A6CA70BD1399EA5A18C78027D3016BEA6881F132A253F3C97ED6/analysis/)\n\n6.0 and yes, we detect it\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-04-13 - A deeper look into malware abusing TeamViewer.pdf"
    ],
    "report_names": [
        "2017-04-13 - A deeper look into malware abusing TeamViewer.pdf"
    ],
    "threat_actors": [
        {
            "id": "1d8dd2ca-5592-482e-b89d-6a7e1a49f4f6",
            "created_at": "2023-01-06T13:46:38.408359Z",
            "updated_at": "2025-03-27T02:00:02.826069Z",
            "deleted_at": null,
            "main_name": "TeamSpy Crew",
            "aliases": [
                "TeamSpy",
                "Team Bear",
                "Anger Bear",
                "IRON LYRIC"
            ],
            "source_name": "MISPGALAXY:TeamSpy Crew",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536059,
    "ts_updated_at": 1743041466,
    "ts_creation_date": 1653705744,
    "ts_modification_date": 1653705744,
    "files": {
        "pdf": "https://archive.orkl.eu/2360a211a63de70587ba91f3d6cdb7fc79e0fb85.pdf",
        "text": "https://archive.orkl.eu/2360a211a63de70587ba91f3d6cdb7fc79e0fb85.txt",
        "img": "https://archive.orkl.eu/2360a211a63de70587ba91f3d6cdb7fc79e0fb85.jpg"
    }
}