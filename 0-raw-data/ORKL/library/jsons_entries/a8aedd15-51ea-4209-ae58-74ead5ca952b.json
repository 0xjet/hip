{
    "id": "a8aedd15-51ea-4209-ae58-74ead5ca952b",
    "created_at": "2023-03-03T02:05:45.96752Z",
    "updated_at": "2025-03-27T02:05:37.407308Z",
    "deleted_at": null,
    "sha1_hash": "e47d5207c87a4210703fcc5968d0370f352a1706",
    "title": "2016-12-22 - Tofsee Spambot features .ch DGA - Reversal and Countermesaures",
    "authors": "",
    "file_creation_date": "2023-03-01T09:37:39Z",
    "file_modification_date": "2023-03-01T09:37:39Z",
    "file_size": 377059,
    "plain_text": "# Tofsee Spambot features .ch DGA - Reversal and Countermesaures\n\n**[govcert.ch/blog/tofsee-spambot-features-.ch-dga-reversal-and-countermesaures/](https://www.govcert.ch/blog/tofsee-spambot-features-.ch-dga-reversal-and-countermesaures/)**\n\n## GovCERT.ch\n\n[Homepage](https://www.govcert.ch/)\n[GovCERT.ch](https://www.govcert.ch/blog/) Blog\n\n### Blog Posts\n\nRecently published blog posts:\n\n[16.09.2022Unflattening ConfuserEx .NET Code in IDA](https://www.govcert.ch/blog/unflattening-confuserex-code-in-ida/)\n[12.12.2021Zero-Day Exploit Targeting Popular Java Library Log4j](https://www.govcert.ch/blog/zero-day-exploit-targeting-popular-java-library-log4j/)\n[09.03.2021Exchange Vulnerability 2021](https://www.govcert.ch/blog/exchange-vulnerability-2021/)\n\n### Blog Archive\n\n\nClose\n\n\nGo to the blog archive and browse all previous blog posts\nwe have published so\nfar.\n\n### RSS Feed\n\nSubscribe to the GovCERT.ch blog RSS feed to stay up to\ndate and get notified\nabout new blog posts.\n\n\n-----\n\nWhitepapers\n\n### Whitepapers\n\nRecently published whitepapers:\n\n[16.09.2022Unflattening ConfuserEx .NET Code in IDA](https://www.govcert.ch/whitepapers/unflattening-confuserex-code-in-ida/)\n[23.09.2019Trickbot - An analysis of data collected from the botnet](https://www.govcert.ch/whitepapers/trickbot-an-analysis-of-data-collected-from-the-botnet/)\n[03.03.2017Scripting IDA Debugger to Deobfuscate Nymaim](https://www.govcert.ch/whitepapers/scripting-ida-debugger-to-deobfuscate-nymaim/)\n\n### Whitepapers RSS feed\n\n\nClose\n\n\nSubscribe to the whitepapers RSS feed to stay up to date\nand get notified about\nnew whitepapers.\n\n[Report an Incident](https://www.govcert.ch/report/)\n\nClose\n\n### Report an incident to NCSC\n\nReport an incident:\nincidents[at]govcert{dot}ch\n\nGeneral inquiries:\noutreach[at]govcert{dot}ch\n\n### Point of contact for CERTs and CSIRTs\n\nThe following email address can be considered as point of\ncontact for FIRST\nmembers and other\nCERTs/CSIRTs:\n\nincidents[at]govcert{dot}ch\n\n### Encrypted Email\n\nGovCERT.ch [PGP-Key (preferred)](https://www.govcert.ch/downloads/govcert.pgp)\n\nAlternative GovCERT.ch PGP Key (for older versions of PGP without\nCurve25519 support)\n\n[GovCERT.ch SMIME](https://www.govcert.ch/downloads/govcert_2021.crt)\n\n\n-----\n\n[Statistics](https://www.govcert.ch/statistics/)\n\n\n-----\n\nToday we came across an interesting malware sample that appeared in Close\nour malware zoo. The malware, which we identified as Tofsee, has tried\nto spam out hundreds of emails within a couple of minutes. However, this wasnâ€™t\nthe reason why it popped up on our radar (we analyze thousands of malware\nsamples every single day, many of which are spambots too). The reason why\nthis particular sample caught our attention were the domains queried by the\nmalware. The domains appear to be algorithmically generated, and about half of\nthe domains use the country code top level domain (ccTLD) of Switzerland:\n\n_Wireshark screenshot of Tofsee DNS queries (click to enlarge)_\nDomain generation algorithms (DGAs) that use the ccTLD for Switzerland are\nvery rare. Gozi is currently the only malware covered by the DGArchive that\nuses .ch --- and only in 1 of over 90 different known configurations.\n\nThis blog post first describes the analysis of the DGA. We then give a\nreimplementation of the DGA in Python, as well as a list of the generated\ndomains for the next 52 weeks. We conclude with measure that we took to deal\nwith algorithmically generated .ch domains.\n\n## Analysis\n\nWe analyzed the following Tofsee sample, with a fairly recent compile timestamp\nof Fri, 16 Dec 2016 07:09:11:\n```\nmd5 490e121113fbadd776ca270c6788c59a\n\nsha c294e79a5f0fbbffd535bb517f43bf69e9bbfb03\n\nsha256 36704ec52701920451437a870e7d538eb409f50a4ae2f8231869500d1d6de159\n\n### Seeding\n\n```\nThe following graph node show the seeding of the DGA. First, the number of\nseconds that have elapsed since 1 January 1974 are counted (offset\n0x40A0A0). The difference between this date and the unix epoch --- 126230400\n\n\n-----\n\nseconds --- is added to the result at 0x0040A0A8, effectively yielding the current\nunix time. It is unclear to us why the authors used this convoluted method to get\nthe current time.\nThe unix time then undergoes four integer division by 60,60,24\nand 7, to get the number of weeks since epoch. This value is used as the seed\nfor the upcoming domain generation algorithm. Domains are therefore valid for\none week, starting on Thursday at midnight UTC.\n\n_Seeding of the DGA (click to enlarge)_\n\n\n-----\n\nSeeding also calls a pseudo random number generator (PRNG) and takes the\nresult modulo 10 to get a value between 0 and 9. The random number generator\nis the standard linear congruential algorithm used by the Borland C/C++\ncompiler:\n```\nunsigned int rand()\n\n{\n\n  r2 = 22695477 * r2 + 1;\n\n  return r2 >> 16;\n\n}\n\n```\nThe initial value of r2 is virtually unpredictable:\n```\nGetSystemTimeAsFileTime(&SystemTimeAsFileTime);\n\nGetVolumeInformationA(0, 0, 4u, &VolumeSerialNumber, 0, 0, 0, 0);\n\nr2 = (VolumeSerialNumber \\\n\n   ^ SystemTimeAsFileTime.dwHighDateTime \\\n\n   ^ GetTickCount()) & 0x7FFFFFFF;\n\n### DGA\n\n```\nThe generated domains, along with the port 443 and an unknown constant 2,\nare stored 69 bytes apart in memory (called target in the next graph). In total 10\ndomains are generated:\n\n\n-----\n\n_Loop that generates 10 domains (click to enlarge)_\n\n\n-----\n\nAt offset 0x040A0FC a random string is generated based on the seed, i.e.,\nnumber of weeks. We will come back to this routine later. The random string is\nrepeated once at 0x040A114; so that, for example, drs becomes drsdrs.\n\nA random letter between \"a\" and \"j\" is then appended to the string to complete\nthe second level domain. The picked letter is based on the unpredictable PRNG\nshown in the seeding section above for the first generated sld. After that, the\nDGA picks the remaining letters in order (offsets 0x0040A16D to 0040A175). For\nexample, if in the first iteration the letter \"c\" is appended, then the following\niterations append \"d\",\"e\",\"f\",\"g\",\"h\",\"j\",\"a\" and finally \"b\".\n\nThe top level domain is set to .ch for the first five domains, and to .biz for the\nremaining five domains. For any given run of the malware this will result in\nexactly one tld per generated second level domain per run of the malware,\nalthough a second level domain will be paired with both top level domains\nthrough additional runs of the malware.\n\nFinally, let's come back to the random string generation routine called at\n0x040A0FC:\n\n\n-----\n\n_Disassembly of the sld generation (click to enlarge)_\nThis routine uses the seed r, i.e., the number of weeks since January 1st, 1970,\nto generate a random string as follows:\n```\nstring = \"\"\n\nDO\n  string += r % 26 + 'a'\n\n  r = r / 26      // integer division\n\nWHILE r\n\nstring = reverse(string)\n\n```\nFor example, as of December 20, 2016, the number of week since epoch is\n2450. Dividing by 26 results in 94 with a remainder of 6, so the first letter is g.\nDividing 94 by 26 results in 3 with remainder 16, so the second letter is q.\nDividing 3 by 26 results in 0, so we append letter d and exit the loop. The\nrandom string gqd is reversed resulting in dqg.\n\n### Reimplementation\n\nThe following reimplementation of the DGA in Python prints all 20 potential\ndomains for any given date. Please note that each actual run of the malware will\nonly generate and test one domain per second level domain.\n\n\n-----\n\n```\nfrom datetime import datetime\n\nimport time\n\nimport argparse\n\ndef dga(r):\n\n  domain = \"\"\n\n  while True:\n\n    domain += chr(r % 26 + ord('a'))\n\n    r //= 26\n\n    if not r:\n\n      break\n\n  for i in range(10):\n\n    for tld in ['.biz', '.ch']:\n\n      yield 2*domain[::-1] + chr(i + ord('a')) + tld\n\ndef printdomains(date):\n\n  unixtimestamp = time.mktime(date.timetuple())\n\n  seed = int(unixtimestamp // 60 // 60 // 24 // 7)\n\n  for domain in dga(seed):\n\n    print(domain)\n\n\nif __name__==\"__main__\":\n\n  parser = argparse.ArgumentParser()\n\n  parser.add_argument(\"-d\", \"--date\", help=\"date for which to generate\ndomains\")\n\n  args = parser.parse_args()\n\n  if args.date:\n\n    d = datetime.strptime(args.date, \"%Y-%m-%d\")\n\n  else:\n\n    d = datetime.now()\n\n  printdomains(d)\n\n### List of Domains\n\n```\nThe following table lists all generated domains of the next 52 weeks. The\ndomains are given as brace expansions, so dqgdqg{a..j}.{ch,biz} stands for 20\ndifferent domains. All times are given in CET.\n\n**start** **end** **domains**\n\n2016-12-15 01:00:00 2016-12-22 00:59:59 dqgdqg{a..j}.{ch,biz}\n\n2016-12-22 01:00:00 2016-12-29 00:59:59 dqhdqh{a..j}.{ch,biz}\n\n2016-12-29 01:00:00 2017-01-05 00:59:59 dqidqi{a..j}.{ch,biz}\n\n2017-01-05 01:00:00 2017-01-12 00:59:59 dqjdqj{a..j}.{ch,biz}\n\n\n-----\n\n**start** **end** **domains**\n\n2017-01-12 01:00:00 2017-01-19 00:59:59 dqkdqk{a..j}.{ch,biz}\n\n2017-01-19 01:00:00 2017-01-26 00:59:59 dqldql{a..j}.{ch,biz}\n\n2017-01-26 01:00:00 2017-02-02 00:59:59 dqmdqm{a..j}.{ch,biz}\n\n2017-02-02 01:00:00 2017-02-09 00:59:59 dqndqn{a..j}.{ch,biz}\n\n2017-02-09 01:00:00 2017-02-16 00:59:59 dqodqo{a..j}.{ch,biz}\n\n2017-02-16 01:00:00 2017-02-23 00:59:59 dqpdqp{a..j}.{ch,biz}\n\n2017-02-23 01:00:00 2017-03-02 00:59:59 dqqdqq{a..j}.{ch,biz}\n\n2017-03-02 01:00:00 2017-03-09 00:59:59 dqrdqr{a..j}.{ch,biz}\n\n2017-03-09 01:00:00 2017-03-16 00:59:59 dqsdqs{a..j}.{ch,biz}\n\n2017-03-16 01:00:00 2017-03-23 00:59:59 dqtdqt{a..j}.{ch,biz}\n\n2017-03-23 01:00:00 2017-03-30 01:59:59 dqudqu{a..j}.{ch,biz}\n\n2017-03-30 02:00:00 2017-04-06 01:59:59 dqvdqv{a..j}.{ch,biz}\n\n2017-04-06 02:00:00 2017-04-13 01:59:59 dqwdqw{a..j}.{ch,biz}\n\n2017-04-13 02:00:00 2017-04-20 01:59:59 dqxdqx{a..j}.{ch,biz}\n\n2017-04-20 02:00:00 2017-04-27 01:59:59 dqydqy{a..j}.{ch,biz}\n\n2017-04-27 02:00:00 2017-05-04 01:59:59 dqzdqz{a..j}.{ch,biz}\n\n2017-05-04 02:00:00 2017-05-11 01:59:59 dradra{a..j}.{ch,biz}\n\n2017-05-11 02:00:00 2017-05-18 01:59:59 drbdrb{a..j}.{ch,biz}\n\n2017-05-18 02:00:00 2017-05-25 01:59:59 drcdrc{a..j}.{ch,biz}\n\n2017-05-25 02:00:00 2017-06-01 01:59:59 drddrd{a..j}.{ch,biz}\n\n2017-06-01 02:00:00 2017-06-08 01:59:59 dredre{a..j}.{ch,biz}\n\n2017-06-08 02:00:00 2017-06-15 01:59:59 drfdrf{a..j}.{ch,biz}\n\n2017-06-15 02:00:00 2017-06-22 01:59:59 drgdrg{a..j}.{ch,biz}\n\n2017-06-22 02:00:00 2017-06-29 01:59:59 drhdrh{a..j}.{ch,biz}\n\n2017-06-29 02:00:00 2017-07-06 01:59:59 dridri{a..j}.{ch,biz}\n\n\n-----\n\n**start** **end** **domains**\n\n2017-07-06 02:00:00 2017-07-13 01:59:59 drjdrj{a..j}.{ch,biz}\n\n2017-07-13 02:00:00 2017-07-20 01:59:59 drkdrk{a..j}.{ch,biz}\n\n2017-07-20 02:00:00 2017-07-27 01:59:59 drldrl{a..j}.{ch,biz}\n\n2017-07-27 02:00:00 2017-08-03 01:59:59 drmdrm{a..j}.{ch,biz}\n\n2017-08-03 02:00:00 2017-08-10 01:59:59 drndrn{a..j}.{ch,biz}\n\n2017-08-10 02:00:00 2017-08-17 01:59:59 drodro{a..j}.{ch,biz}\n\n2017-08-17 02:00:00 2017-08-24 01:59:59 drpdrp{a..j}.{ch,biz}\n\n2017-08-24 02:00:00 2017-08-31 01:59:59 drqdrq{a..j}.{ch,biz}\n\n2017-08-31 02:00:00 2017-09-07 01:59:59 drrdrr{a..j}.{ch,biz}\n\n2017-09-07 02:00:00 2017-09-14 01:59:59 drsdrs{a..j}.{ch,biz}\n\n2017-09-14 02:00:00 2017-09-21 01:59:59 drtdrt{a..j}.{ch,biz}\n\n2017-09-21 02:00:00 2017-09-28 01:59:59 drudru{a..j}.{ch,biz}\n\n2017-09-28 02:00:00 2017-10-05 01:59:59 drvdrv{a..j}.{ch,biz}\n\n2017-10-05 02:00:00 2017-10-12 01:59:59 drwdrw{a..j}.{ch,biz}\n\n2017-10-12 02:00:00 2017-10-19 01:59:59 drxdrx{a..j}.{ch,biz}\n\n2017-10-19 02:00:00 2017-10-26 01:59:59 drydry{a..j}.{ch,biz}\n\n2017-10-26 02:00:00 2017-11-02 00:59:59 drzdrz{a..j}.{ch,biz}\n\n2017-11-02 01:00:00 2017-11-09 00:59:59 dsadsa{a..j}.{ch,biz}\n\n2017-11-09 01:00:00 2017-11-16 00:59:59 dsbdsb{a..j}.{ch,biz}\n\n2017-11-16 01:00:00 2017-11-23 00:59:59 dscdsc{a..j}.{ch,biz}\n\n2017-11-23 01:00:00 2017-11-30 00:59:59 dsddsd{a..j}.{ch,biz}\n\n2017-11-30 01:00:00 2017-12-07 00:59:59 dsedse{a..j}.{ch,biz}\n\n2017-12-07 01:00:00 2017-12-14 00:59:59 dsfdsf{a..j}.{ch,biz}\n\n### Actions taken\n\n\n-----\n\nTo prevent that the Tofsee botnet operators are able to abuse the Swiss domain\nname space (ccTLD .ch) for hosting their botnet Command&Control\ninfrastructure (C&C), we have discussed further actions with the registry of\nccTLD .ch (SWITCH). Together with SWITCH and the Registrar of Last Resort\n[(RoLR), all possible DGA domain name combinations have been set to non](http://www.rolr.eu/)\nregistrable at the registry level. It is therefore not possible to register any of the\nDGA domain names for the next 12 months.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-12-22 - Tofsee Spambot features .ch DGA - Reversal and Countermesaures.pdf"
    ],
    "report_names": [
        "2016-12-22 - Tofsee Spambot features .ch DGA - Reversal and Countermesaures.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1677809145,
    "ts_updated_at": 1743041137,
    "ts_creation_date": 1677663459,
    "ts_modification_date": 1677663459,
    "files": {
        "pdf": "https://archive.orkl.eu/e47d5207c87a4210703fcc5968d0370f352a1706.pdf",
        "text": "https://archive.orkl.eu/e47d5207c87a4210703fcc5968d0370f352a1706.txt",
        "img": "https://archive.orkl.eu/e47d5207c87a4210703fcc5968d0370f352a1706.jpg"
    }
}