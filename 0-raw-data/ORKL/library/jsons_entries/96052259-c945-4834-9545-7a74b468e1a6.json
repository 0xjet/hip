{
    "id": "96052259-c945-4834-9545-7a74b468e1a6",
    "created_at": "2023-05-06T02:08:44.517349Z",
    "updated_at": "2025-03-27T02:05:34.143805Z",
    "deleted_at": null,
    "sha1_hash": "32b0664ccf759ce5d5daf0156b9576456b3fbfb8",
    "title": "2023-03-31 - Splunk Insights- Investigating the 3CXDesktopApp Supply Chain Compromise",
    "authors": "",
    "file_creation_date": "2023-05-05T01:45:08Z",
    "file_modification_date": "2023-05-05T01:45:08Z",
    "file_size": 1201511,
    "plain_text": "# Splunk Insights: Investigating the 3CXDesktopApp Supply Chain Compromise\n\n**[splunk.com/en_us/blog/security/splunk-insights-investigating-the-3cxdesktopapp-supply-chain-compromise.html](https://www.splunk.com/en_us/blog/security/splunk-insights-investigating-the-3cxdesktopapp-supply-chain-compromise.html)**\n\nMarch 31, 2023\n\nSECURITY\n\nBy [Splunk Threat Research Team March 31, 2023](https://www.splunk.com/en_us/blog/author/secmrkt-research.html)\n\nCrowdStrike announced on 3/29/2023 that an active intrusion campaign was targeting 3CX\n[customers utilizing a legitimate, signed binary, 3CXDesktopApp (CISA link). As the investigations and](https://www.cisa.gov/news-events/alerts/2023/03/30/supply-chain-attack-against-3cxdesktopapp)\npublic information came out publicly from vendors all across the spectrum, C3X customers of all sizes\nbegan investigating their fleet for signs of compromise. These campaigns are often referred to as\nsupply chain compromises, or MITRE ATT&CK [T1195. The most notable of these attacks which](https://attack.mitre.org/techniques/T1195/)\n[brought supply chain security to the forefront of most organizations’ security posture was SolarWinds.](https://www.splunk.com/en_us/blog/security/detecting-supernova-malware-solarwinds-continued.html)\nA notable learning of dealing with the Solarwinds vulnerability was the difficulty associated with\nidentifying supply chain compromises at the source. For the 3CXDesktopApp, it all began after a 7\nday sleep that the compromised software version began to trigger different anti-virus products and\nshowed suspicious behaviors in EDR products.\n\nOrganization defenders must consider attack surface comprising both endpoint and network. Utilizing\nour defense in depth approach, tracking anti-virus, EDR and other alerts provided can assist with\npiecing together the puzzle. It’s not a simple task when it comes to identifying software supply chain\ncompromises. It may all begin with a post-exploitation event and working backwards allows us to see\nthe source.\n\nIn this Splunk blog post, we aim to equip defenders with the necessary tools and strategies to\nactively hunt down and counteract this campaign. Additionally, we will offer some resilient analytic\nideas that can serve as a foundation for future threat detection and response efforts.\n\n## Infection Chain Walk Through\n\n\n-----\n\nThe supply chain compromise begins when users download an affected version of the\n3CXDesktopApp, which subsequently loads a maliciously crafted or trojanized ffmpeg.dll. This\ncompromised component is responsible for initiating the malicious activities associated with the\nattack.\n\nAffected 3CX versions:\n\n3CXDesktopApp-18.12.407.msi\n3CXDesktopApp-18.12.416.msi\n\n### ffmpeg.dll\n\nThe patched ffmpeg.dll is responsible for reading another DLL named \"d3dcompiler_47.dll,\" which\ncontains an encrypted shellcode and additional DLLs that will download several .ico files. Figure 1\npresents a code snippet of the maliciously crafted ffmpeg.dll that reads the \"d3dcompiler_47.dll\" file\nto search for an embedded encrypted shellcode, starting with an 8-byte sequence \"0xFE 0xED 0xFA\n0xCE 0xFE 0xED 0xFA 0xCE.\"\n\n\n-----\n\n_Figure 1_\n\n### D3dcompiler_47.dll\n\nThe shellcode is encrypted using the RC4 algorithm, with a specific decryption key \"3jB(2bsG#c7\".\nFigure 2 illustrates the encrypted code block embedded in d3dcompiler_47.dll before and after the\ndecryption process. Upon examining the decrypted portion of the screenshot, it becomes evident that\nthe shellcode contains instructions to load another DLL.\n\n\n-----\n\n_Figure 2_\n\n### Decrypted-DLL\n\nThe shellcode proceeds to load the decrypted DLL export \"DllGetClassObject,\" which initiates a\nthread to examine the manifest file. It then sleeps for a duration based on a randomly generated\nvalue relative to the system date and time. Following this, it reads the machine GUID from the\n[registry. Figure 3 demonstrates how the shellcode accesses the Cryptography registry to parse the](https://www.splunk.com/en_us/blog/learn/cryptography.html)\nMachineGUID of the targeted or compromised host.\n\n_Figure 3_\n\nUpon retrieving the Machine GUID, the shellcode calls a function that attempts to download several\n.ico files from the GitHub repository. At the time of writing, the URL link was no longer accessible, but\nthe [cybersecurity community shared the files, enabling us to examine the next stage.](https://twitter.com/fr0gger_/status/1641325932760948737?s=46&t=yQ2cOUcQNpWKLmg_cvVIxQ)\n\nFigure 4 presents a code snippet of the decrypted DLL that attempts to download multiple .ico files\nfor decoding and decryption. The code highlights an intriguing approach employed by the attacker,\nusing .ico files as configuration files. After downloading the .ico files, the shellcode reads them byte\nby byte, searching for the character \"$\". This character serves as a marker for the encoded and\nencrypted [C2 URL link.](https://www.splunk.com/en_us/blog/learn/c2-command-and-control.html)\n\n\n-----\n\n_Figure 4_\n\nFigure 5 presents a basic hex view snippet of two malicious .ico files that the decrypted DLL attempts\nto download. The hex bytes highlighted in the yellow box represent the base64-encoded and\n[encrypted C2 URL link, which begins with the \"$\" character. We recommend using the decrypt-ico.py](https://github.com/volexity/threat-intel/blob/main/2023/2023-03-30%203CX/attachments/decrypt_ico.py)\nscript created by the Volexity team to automatically decrypt this string. The decrypted C2 server can\nbe found in the IOC section of this blog.\n\n_Figure 5_\n\n\n-----\n\nThe aforementioned C2 server proceeds to download an additional configuration JSON file,\nultimately leading to the final payload binary, which is a browser stealer malware. This malware is\ndesigned to extract sensitive information from the victim's web browsers.\n\n### Browser Stealer Payload\n\nThe browser stealer is a separate x64-bit DLL that executes its malicious code through the\n\"DllGetClassObject\" export function. This malware aims to extract information such as domain name,\ncomputer name, and OS version using the NetWkstaGetInfo() and RtlGetVersion() APIs. Figure 6.1\nand 6.2 display code snippets illustrating how the malware retrieves the specified information using\nthese two Windows APIs and formats it before transmitting the data to its C2 server.\n\n_Figure 6.1_\n\n_Figure 6.2_\n\nFinally, the malware targets several well-known browsers, including \"Chrome,\" \"Firefox,\" \"MSEdge,\"\nand \"Brave,\" in order to steal information. It achieves this by accessing browser history and the\nplaces.sqlite database, copying it, and then querying the discovered SQLite browser databases to\nparse the URL and title, limited to the first 500 entries. Figure 7 displays a code snippet illustrating\nhow the stealer executes the SQL command once it locates the browser SQLite database it needs to\nparse and subsequently sends the information to its C2 server.\n\n\n-----\n\n_Figure 7_\n\n**Description** **Values**\n\nTargeted browser Chrome, msedge, firefox and brave\n\nTargeted browser file path AppData\\Local\\Google\\Chrome\\User Data\n\nAppData\\Local\\Microsoft\\Edge\\User Data\n\nAppData\\Local\\BraveSoftware\\Brave-Browser\\User Data\n\nAppData\\Roaming\\Mozilla\\Firefox\\Profiles\n\nTargeted browser database History, places.sqlite\n\n\nSQL command\n\n### IOCs\n\n\nSELECT url, title FROM urls ORDER BY id DESC LIMIT 500\n\nSELECT url, title FROM moz_places ORDER BY id DESC LIMIT 500\n\n\n-----\n\nDecrypted C2 in\n.ico\n\nGithub repo URL\nlink\n\n\nhxxps://www[.]3cx[.]com/blog/event-trainings/\n\nhxxps://msstorageazure[.]com/window\n\nhxxps://akamaitechcloudservices[.]com/v2/storage\n\nhxxps://akamaitechcloudservices[.]com/v2/storage\n\nhxxps://azureonlinestorage[.]com/azure/storage\n\nhxxps://msedgepackageinfo[.]com/microsoft-edge\n\nhxxps://glcloudservice[.]com/v1/console\n\nhxxps://pbxsources[.]com/exchange\nhxxps://officestoragebox[.]com/api/session\n\nhxxps://visualstudiofactory[.]com/workload\n\nhxxps://azuredeploystore[.]com/cloud/services\n\nhxxps://msstorageboxes[.]com/office\n\nhxxps://officeaddons[.]com/technologies\n\nhxxps://sourceslabs[.]com/downloads\n\nhxxps://zacharryblogs[.]com/feedhxxps://pbxcloudeservices[.]com/phonesystem\n\nhxxps[:]//raw[.]githubusercontent[.]com/IconStorages/images/main/icon%d[.]ico\n\n\n.ico zip archive [5c54932fdbb077d73c58ac41a1ad3f6ea5576b3e1f719c8b714b637c9ceb361b](https://www.virustotal.com/gui/file/5c54932fdbb077d73c58ac41a1ad3f6ea5576b3e1f719c8b714b637c9ceb361b/details)\n\nffmpeg.dll [7986bbaee8940da11ce089383521ab420c443ab7b15ed42aed91fd31ce833896](https://www.virustotal.com/gui/file/7986bbaee8940da11ce089383521ab420c443ab7b15ed42aed91fd31ce833896)\n\nffmpeg.dll [c485674ee63ec8d4e8fde9800788175a8b02d3f9416d0e763360fff7f8eb4e02](https://www.virustotal.com/gui/file/c485674ee63ec8d4e8fde9800788175a8b02d3f9416d0e763360fff7f8eb4e02)\n\nd3dcompiler_47.dll [11be1803e2e307b647a8a7e02d128335c448ff741bf06bf52b332e0bbf423b03](https://www.virustotal.com/gui/file/11be1803e2e307b647a8a7e02d128335c448ff741bf06bf52b332e0bbf423b03)\n\nWe identified several key factors during our analysis that aid in guiding Splunk content creation. Now,\nlet's delve into the content and examine the various ways in which Splunk can be of assistance.\n\n## Security Content\n\nThere are numerous methods for generating content in Splunk, as well as a wide variety of data\nsources. Based on the indicators provided and our analysis above, we can present the following\ncontent. Some of these examples may serve as Splunk inspiration, while others may be suitable for\nnotables. Throughout our discussion, we will offer insights on building resilient analytics for each\nexample.\n\n### Hunting 3CXDesktopApp Software\n\nInitially, like many, we want to identify endpoints across our fleet that have C3XdesktopApp running\nand what version. We decided to use the Endpoint.Processes datamodel so the results would be\nback fast. If data is not normalized in the datamodel, that’s ok! Modify the analytic for your\nenvironment by looking for the process names. Note here that the datamodel does not provide file\nversion, we are specifically just looking for where this process is running across the fleet.\n\n\n-----\n\n```\n| tstats security_content_summariesonly count min(_time) as firstTime max(_time) as\nlastTime from datamodel=Endpoint.Processes where Processes.process_name=3CXDesktopApp.exe OR\nProcesses.process_name=\"3CX Desktop App\" by Processes.dest Processes.user\nProcesses.parent_process_name Processes.process_name Processes.original_file_name\nProcesses.process Processes.process_id Processes.parent_process_id\n\n| `drop_dm_object_name(Processes)`\n\n| `security_content_ctime(firstTime)`\n\n| `security_content_ctime(lastTime)`\n\n```\nTwo aspects we recommend examining closely at this time are the file path and the command line.\nThese elements may vary across different environments, so it's important to identify the default\nlocation of the binary for your organization and determine if the command line follows a consistent\npattern.\n```\n| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as\nlastTime from datamodel=Endpoint.Processes where Processes.process_name=3CXDesktopApp.exe OR\nProcesses.process_name=\"3CX Desktop App\" by Processes.process_path Processes.process_name\n\n| `drop_dm_object_name(Processes)`\n\n| `security_content_ctime(firstTime)`\n\n| `security_content_ctime(lastTime)`\n\n\n### Windows Vulnerable 3CX Software\n\n```\nSwitching to Sysmon, we wrote a query to look for 3CXDesktopApp by file version. Depending on the\nEDR product in use, many provide signature information, VirusTotal enrichment, prevalence and so\nforth.\n\nThe [Splunk Attack Range uses a broad configuration file meant to capture every artifact provided.](https://www.splunk.com/en_us/blog/security/attack-range-v3-0.html)\nEach EDR product today provides similar or more, so it is very important to understand the product\nand how it can assist your organization in an event like this.\n```\n`sysmon` (process_name=3CXDesktopApp.exe OR OriginalFileName=3CXDesktopApp.exe) \nFileVersion=18.12.*\n\n| rename Computer as dest\n\n| stats count min(_time) as firstTime max(_time) as lastTime by dest,\nparent_process_name,process_name, OriginalFileName, CommandLine\n\n```\n\n-----\n\nAccording to [3CX, the security issue affects version numbers 18.12.407 and 18.12.416 on Windows.](https://www.3cx.com/blog/news/desktopapp-security-alert/)\nWe adopt a slightly broader approach by searching for any 18.12.* version, primarily to monitor for\nany instances that may have gone unnoticed. Furthermore, you can modify this analytic to examine\nany version or simply extract the version information for an inventory overview.\n\nAnother take on this query showing just the process and version number by host.\n```\n`sysmon` (process_name=3CXDesktopApp.exe OR OriginalFileName=3CXDesktopApp.exe)\n\n| rename Computer as dest\n\n| stats count min(_time) as firstTime max(_time) as lastTime by dest process_name FileVersion\n\n\n```\n18.12.422 is the latest version as of 3/31/2023.\n\n### 3CX Supply Chain Attack Network Indicators\n\nWe would like to thank CrowdStrike and numerous other organizations for providing indicators. The\nmethod for detecting the domains used will depend on an organization's security stack. Some\nproducts reveal the URI, while others do not. In our case, we utilize DNS queries from Sysmon, which\npopulates the Network_Resolution data model.\n\nHunting with these domains may provide false positives and filtering / tuning is definitely\nrecommended. Note here that a hit on the domain is not 100% true positive. Some of these are\nlegitimate and will require further review. In addition to looking for the domains, it may provide value\nin doing two additional tasks based on product support:\n\n1. Restrict the network indicators to 3CXDesktopApp, or broadly any process\n2. Add URIs to the lookup, or a new query, and hunt for beaconing activity.\n\n\n-----\n\n```\n| tstats summariesonly values(DNS.answer) as IPs min(_time) as firstTime from\ndatamodel=Network_Resolution by DNS.src, DNS.query\n\n| `drop_dm_object_name(DNS)`\n\n| `security_content_ctime(firstTime)`\n\n| `security_content_ctime(lastTime)`\n\n| lookup 3cx_ioc_domains domain as query OUTPUT Description isIOC\n\n| search isIOC=true\n\n```\n[Utilizing the Splunk App for Lookup File Editing, we can easily add/remove indicators or new](https://splunkbase.splunk.com/app/1724)\ncolumns.\n\n### DLLs on Disk\n\nAs mentioned earlier, it is important to pay attention to the process path. In this specific campaign, we\naim to identify any additional files that were dropped on the disk, collect their hashes, and explore\npotential leads that may offer further insights. Using Sysmon, we have narrowed our focus to the\n\\Appdata\\local\\ path and sorted the data by the ImageLoaded (DLL) and various metadata points that\nSysmon offers. It's important to note that different EDR products will provide varying levels of\nvisibility, so as you analyze this telemetry, start identifying alternative ways to pivot. Be sure to check\nfor prevalence within your organization. For example, if the ffmpeg.dll with this specific hash is found\non only 5 out of 5,000 endpoints, it is certainly worth investigating further.\n```\n`sysmon` 3cxdesktopapp.exe \nImageLoaded=\"C:\\\\Users\\\\Administrator\\\\AppData\\\\Local\\\\Programs\\\\3CXDesktopApp\\\\*\" | stats\nvalues(ImageLoaded) by loaded_file MD5 FileVersion Company Description\nservice_dll_signature_verified\n\n```\n\n-----\n\n#ToolTips\n\nImage loads are a voluminous datasource and can be cumbersome to hunt through. Here are some\ntips to narrow down interesting image loads.\n\n1. Focus on non-standard paths. Native Windows DLLs will not run out of the user profile\n2. Identify signing information and use it to your advantage to look for Unsigned or revoked based\n\non file paths\n3. If possible, look for processes loading DLLs from non-standard paths. Filter by signing status.\n\n### Registry\n\nRevisiting the initial installation process involving MsiExec.exe, it's important to note that several\nregistry modifications occur to ensure the persistence of this version of 3CXDesktopApp.\n```\n`sysmon` EventID IN (12,13,14)  process_name=\"msiexec.exe\" *\\\\appdata\\\\*\n\n| stats values(registry_value_data) by registry_path\n\n\n```\nNow the registry modifications from the 3CXDesktopApp. This is an abbreviated version as there are\na lot of standard modifications in the output.\n```\n`sysmon` EventID IN (12,13,14)  process_name=\"3cxdesktopapp.exe\"\n\n| stats values(registry_value_data) by registry_path\n\n\n## Learn More\n\n```\n\n-----\n\n[You can find the latest content and security analytic stories on](https://research.splunk.com/stories/3cx_supply_chain_attack/) [GitHub and in Splunkbase.](https://github.com/splunk/security-content/releases/tag/v3.63.0) Splunk\nSecurity Essentials also has all these detections available via push update.\n\nFor a full list of security content, check out the [release notes on](https://docs.splunk.com/Documentation/ESSOC/3.21.0/RN/Enhancements) [Splunk Docs.](https://docs.splunk.com/Documentation/ESSOC)\n\n## Feedback\n\nAny feedback or requests? Feel free to put in an issue on GitHub and we’ll follow up. Alternatively,\n[join us on the Slack channel #security-research. Follow these instructions If you need an invitation to](https://splunk-usergroups.slack.com/)\nour Splunk user groups on Slack.\n\n## Contributors\n\n[We would like to thank Michael Haag and](https://twitter.com/M_haggis) [Teoderick Contreras for authoring this post and the entire](https://twitter.com/tccontre18)\n[Splunk Threat Research Team (Rod Soto,](https://twitter.com/rodsoto) [Mauricio Velazco,](https://twitter.com/mvelazco) [Lou Stella,](https://twitter.com/ljstella) [Bhavin Patel,](https://twitter.com/hackpsy) [Eric McGinnis,](https://twitter.com/SnekCharmerr)\n[and Patrick Bareiss) for their contribution to this release.](https://twitter.com/bareiss_patrick)\n\n## References:\n\nPosted by\n\n**[Splunk Threat Research Team](https://www.splunk.com/en_us/blog/author/secmrkt-research.html)**\n\nThe Splunk Threat Research Team is an active part of a customer’s overall defense strategy by\nenhancing Splunk security offerings with verified research and security content such as use cases,\ndetection searches, and playbooks. We help security teams around the globe strengthen operations\nby providing tactical guidance and insights to detect, investigate and respond against the latest\nthreats. The Splunk Threat Research Team focuses on understanding how threats, actors, and\nvulnerabilities work, and the team replicates attacks which are stored as datasets in the Attack Data\nrepository.\n\nOur goal is to provide security teams with research they can leverage in their day to day operations\n\n\n-----\n\nand to become the industry standard for SIEM detections. We are a team of industry-recognized\nexperts who are encouraged to improve the security industry by sharing our work with the community\nvia conference talks, open-sourcing projects, and writing white papers or blogs. You will also find us\npresenting our research at conferences such as Defcon, Blackhat, RSA, and many more.\n\n[Read more Splunk Security Content.](https://github.com/splunk/security_content)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-03-31 - Splunk Insights- Investigating the 3CXDesktopApp Supply Chain Compromise.pdf"
    ],
    "report_names": [
        "2023-03-31 - Splunk Insights- Investigating the 3CXDesktopApp Supply Chain Compromise.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1683338924,
    "ts_updated_at": 1743041134,
    "ts_creation_date": 1683251108,
    "ts_modification_date": 1683251108,
    "files": {
        "pdf": "https://archive.orkl.eu/32b0664ccf759ce5d5daf0156b9576456b3fbfb8.pdf",
        "text": "https://archive.orkl.eu/32b0664ccf759ce5d5daf0156b9576456b3fbfb8.txt",
        "img": "https://archive.orkl.eu/32b0664ccf759ce5d5daf0156b9576456b3fbfb8.jpg"
    }
}