{
    "id": "7a53858b-b2e8-4c44-8554-3dcff57a04f0",
    "created_at": "2023-01-12T15:00:05.87228Z",
    "updated_at": "2025-03-27T02:06:02.859997Z",
    "deleted_at": null,
    "sha1_hash": "ce3bb2129f93024ee0da9a2fc95c380ebac211ba",
    "title": "2016-10-24 - Introducing TrickBot, Dyreza’s successor",
    "authors": "",
    "file_creation_date": "2022-05-28T04:55:59Z",
    "file_modification_date": "2022-05-28T04:55:59Z",
    "file_size": 1147918,
    "plain_text": "# Introducing TrickBot, Dyreza’s successor\n\n**[blog.malwarebytes.com/threat-analysis/2016/10/trick-bot-dyrezas-successor/](https://blog.malwarebytes.com/threat-analysis/2016/10/trick-bot-dyrezas-successor/)**\n\nMalwarebytes Labs October 24, 2016\n\nRecently, our analyst [Jérôme Segura captured an interesting payload in the wild. It turned](https://blog.malwarebytes.com/author/jeromesegura/)\nout to be a new bot that, at the moment of analysis, hadn’t been described yet. According to\n[strings found inside the code, the authors named it TrickBot (or “TrickLoader”).](https://www.malwarebytes.com/trickbot/)\n\nMany links indicate that this bot is another product of the threat actors previously\n[behind Dyreza, a credential-stealer. While TrickBot seems to be written from scratch, it](https://blog.malwarebytes.com/threat-analysis/2015/11/a-technical-look-at-dyreza/)\ncontains many similar features and solutions to those we encountered analyzing Dyreza.\n\n## Analyzed samples\n\n**TrickBot’s modules:**\n\n[533b0bdae7f4c8dcd57556a45e1a62c8 – systeminfo32.dll](https://virustotal.com/en/file/a5725af4391d21a232dc6d4ad33d7d915bd190bdac9b1826b73f364dc5c1aa65/analysis/1477056933/)\n[c5a0a3dba3c3046e446bd940c20b6092 -systeminfo64.dll](https://virustotal.com/en/file/d461e3801e5c2efe54d202e23d55a3c58a97996c3af59dbefb988a677feb66aa/analysis/1477356071/)\n\n**Additional payload:**\n\n## Distribution\n\n[The payload was spread via malvertising campaign, which dropped the Rig EK:](https://blog.malwarebytes.com/cybercrime/exploits/2016/09/rig-exploit-kit-takes-on-large-malvertising-campaign/)\n\n\n-----\n\n## Behavioral analysis\n\nAfter being deployed, TrickBot copies itself into %APPDATA% and deletes the original\nsample. It doesn’t change the initial name of the executable, however. (In the given example,\nthe analyzed sample was named “trick.exe”.)\n\nFirst, we can see it dropping two additional files: client_id and group_tag. They are\ngenerated locally and used to identify, appropriately, the individual bot and the campaign to\nwhich it belongs. The content of both files is not encrypted; it contains text in Unicode.\n\nAn example of the client_id consists of the name of the attacked machine, operating system\nversion, and a randomly-generated string:\n\n\n-----\n\nExample of the group_tag:\n\nThen, in the same location, we can see config.conf appearing. This file is downloaded from\nthe [C&C and stored in encrypted form.](https://blog.malwarebytes.com/glossary/cc/)\n\nAfter some time, we can see another folder being created in %APPDATA% named Modules.\nThe malware drops additional modules downloaded from the C&C, which are also stored\nencrypted. In a particular session, TrickBot downloaded modules called injectDll32 and\n_systeminfo32:_\n\nThis particular module may also have a corresponding folder where its configuration is\nstored. The pattern of the naming convention is [module name]_configs.\n\n\n-----\n\nWhen we observe the execution of the malware via monitoring tools, i.e. ProcessExplorer,\nwe can find it deploying two instances of svchost:\n\nThe bot achieves persistence by adding itself as a task in Windows Task Scheduler. It\ndoesn’t put any effort in hiding the task under a legitimate name, and instead just calls it\n“Bot.”\n\nIf the process is killed, it is automatically restarted by the Task Scheduler Engine:\n\n## Network communication\n\nTrickBot connects to the several servers:\n\nFirst, it connects to a legitimate server myexternalip.com in order to fetch the IP visible from\noutside.\n\n\n-----\n\nThe interesting part is that it doesn t try to disguise as a legitimate browser. Instead, it uses\nits own User Agent: “BotLoader” or “TrickLoader.”\n\nMost—but not all—of the communication with its main C&C is SSL encrypted. Below, you\ncan see an example of one of the commands sent to the C&C:\n\nLooking at the URL of POST request, we notice the group_id and the client_id that are the\nsame as in the files. After that, the command id follows. This format was typical for Dyreza.\n\nThe bot also downloads an additional payload (in the particular session it was:\n[47d9e7c464927052ca0d22af7ad61f5d) without encrypting the traffic:](https://virustotal.com/en/file/817109d3ea13fe1e718defe4a16959f64d966404a3dcfbe6b1aa85cffc3da765/analysis/)\n\n\n-----\n\nC&Cs are set up on hacked wireless routers, such as MikroTik. This way of setting up the\ninfrastructure was also previously used by Dyreza.\n\n\n-----\n\nIn this example of a used HTTPs certificate, we can see that the used data is fully random\nand not even trying to imitate legitimate-looking names:\n\n\n-----\n\n## Inside the malware\n\nTrickBot is composed of several layers. As usual, the first layer is used for protection: It\ncarries the encrypted payload and tries to hide it from AV software.\n\n**Loader**\n\n\n-----\n\nThe second layer is a main bot loader that chooses whether to deploy a 32-bit or 64-bit\npayload. New PE files are stored in resources in encrypted form. However, the authors didn’t\ntry to hide the functionality of particular elements, and looking at the names of the resources,\nwe can easily guess what their purpose is:\n\nSelected modules are decrypted during execution.\n\nAt the beginning, the application fetches information about the victim’s operating system in\norder to choose the appropriate way to follow:\n\nDepending on the environment, a suitable payload is picked from resources, decrypted by a\nsimple algorithm, and validated:\n\n\n-----\n\n[The decrypting procedure is different than the one found in Dyreza, however, the general](https://github.com/hasherezade/malware_analysis/blob/master/dyreza/dyreza_decoder.py)\nidea of organizing content (three encrypted modules in resources) is analogous.\n```\ndef decode(data):\n  decoded = bytearray()\n  key = 0x3039\n  i = 0\n  for i in range(0, len(data)):\n    dec_val = data[i] ^ (key % 0x100)\n    key *= 0x0AE529\n    key += 0x24D69\n    decoded.append(dec_val)\n  return decoded\n\n```\n_See full decoding script:_\n_[https://github.com/hasherezade/malware_analysis/blob/master/trickbot/trick_decoder.py](https://github.com/hasherezade/malware_analysis/blob/master/trickbot/trick_decoder.py)_\n\nReturning to our malware analysis, next, the unpacked bot is mapped to the memory by a\ndedicated function and deployed.\n\nThe 32-bit bot maps the new module inside its own memory (self-injection):\n\n\n-----\n\nand then redirects execution there:\n\nEntry point of the new module (TrickBot core):\n\nIn the case of 64-bit payload being chosen, first the additional executable—a 64bit PE loader\n—is unpacked and run. Then it loads the core, malicious bot.\n\nIn contrast to Dyreza, whose main modules were DLLs, TrickBot uses EXEs.\n\n**The TrickBot internals**\n\nThe bot is written in C++. It comes with two resources with descriptive names: CONFIG,\nwhich stores encrypted configuration, and KEY, which stores the Elliptic Curve key:\n\nIn general, this malware is verbose: meaningful names can be found at every stage.\n\n\n-----\n\nThe name TrickBot also appears in the name of the global mutex ( Global\\\\TrickBot )\ncreated by the application in order to ensure that it is run only once:\n\nAt first execution, TrickBot copies itself into a new location (in %APPDATA%) and deploys\nthe new copy, giving as an argument path to the original one that needs to be deleted:\n\nAdding a task of running bot into the Task Scheduler:\n\nSetting the triggering event:\n\n\n-----\n\nWe can find the date pointing to the beginning of 2016, which may confirm the observation\nthat the bot is new, and was written this year.\n\n**TrickBot’s commands**\n\nTrickBot communicates with its C&C and sends several commands in a format similar to the\none used by Dyreza. Below is list of format strings used by TrickBot commands:\n\nCompare that with Dyreza’s command format:\n\nTrickBot’s command IDs are hardcoded in the format strings. However, all of them are\ndeployed from inside the same function that gets the command ID as a parameter:\n\n\n-----\n\nAfter filling the appropriate format string and sending it to the C&C, the bot checks the HTTP\nresponse code. If the returned code is different than 200 (OK), 403 (Forbidden), or 404 (Not\n_found), then it tries again._\n\nHere’s a full list of implemented command IDs:\n```\n0\n1\n5\n10\n14\n23\n25\n63\n\n```\nEach command has the same prefix – that is a group id of the campaign and bot’s individual\nid (the same data that are stored in dropped files). Format:\n```\n/[group_id]/[client_id]/[command_id]/...\n\n```\nSample url:\n```\nhttps://193.9.28.24/tmt2/TESTMACHINE_W617601.653EB63213B91453D28A68C80FCA3AC4/5/sinj/\n\n```\n[More notes about the protocol here.](https://gist.github.com/hasherezade/88837ea728d3950c7c38160d016ea6cf)\n\n**Encryption**\n\nTrickBot uses alternatively two encryption algorithms: AES and ECC.\n\n\n-----\n\nThe downloaded modules and configuration are encrypted by AES in CBC mode. The AES\nkey and initialization vector are derived from the data, by a custom, predefined algorithm.\nFirst, 32 bytes of input data is hashed, using SHA256. Then, the output of the hashing\nfunction is appended to the data buffer and hashed again. This step is repeated until the full\nsize of data in buffer become 4096. So, the hashing operation repeats 128 times. Below you\ncan see the responsible fragment of code:\n\n\n-----\n\nFirst 32 byte long chunk of data is used as a initial value to derive AES key:\n\nAnd bytes from 16 to 48 are used as a initial value to derive AES initialization vector:\n\n\n-----\n\nCompare with the content of CONFIG (mind the fact that the first DWORD is a size, and is\nnot included in the data):\n\n_Full decoding script you can find here:_\n_https://github.com/hasherezade/malware_analysis/blob/master/trickbot/trick_config_decoder._\n_py_\n\nDecrypting hardcoded configuration using AES:\n\nIn case if particular input could not be decrypted via AES, the attempt is made to decrypt it\nvia ECC:\n\n\n-----\n\n**Trick Bot’s configuration**\n\nSimilarly to Dyreza, TrickBot uses configuration files, that are stored encrypted.\n\nTrick Bot’s executable comes with a hardcoded configuration, that, during execution is\nsubstituted by its fresh version, downloaded from the C&C and saved in the file config.conf.\nBelow you can see the decrypted content of the hardcoded one:\n\nThis file contains bidirectional Unicode text that may be interpreted or compiled differently\nthan what appears below. To review, open the file in an editor that reveals hidden Unicode\ncharacters.\n\n[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)\n\n[Show hidden characters](http://10.10.0.46/%7B%7B%20revealButtonHref%20%7D%7D)\n\n<mcconf>\n\n<ver>1000002</ver>\n\n<gtag>tmt2</gtag>\n\n<servs>\n\n\n-----\n\n<srv>91.219.28.77:443</srv>\n\n<srv>193.9.28.24:443</srv>\n\n<srv>37.1.209.51:443</srv>\n\n<srv>138.201.44.28:443</srv>\n\n<srv>188.116.23.98:443</srv>\n\n<srv>104.250.138.194:443</srv>\n\n<srv>46.22.211.34:443</srv>\n\n<srv>68.179.234.69:443</srv>\n\n<srv>5.12.28.0:443</srv>\n\n<srv>36.37.176.6:443</srv>\n\n<srv>37.109.52.75:443</srv>\n\n<srv>27.208.131.97:443</srv>\n\n</servs>\n\n<autorun>\n\n<modulename=\"systeminfo\" ctl=\"GetSystemInfo\"/>\n\n<modulename=\"injectDll\"/>\n\n</autorun>\n\n</mcconf>\n\n[view raw](https://gist.github.com/hasherezade/0c464f970018f509444243b67a0c5447/raw/8efd199d3cae8ed26623e606bfb4cf08daf45ea3/mcconf.xml)\n\n[mcconf.xml](https://gist.github.com/hasherezade/0c464f970018f509444243b67a0c5447#file-mcconf-xml)\n\nhosted with ❤ by [GitHub](https://github.com/)\nCompare it with a downloaded one – version number got incremented, and some C&Cs have\nchanged:\n\nThis file contains bidirectional Unicode text that may be interpreted or compiled differently\nthan what appears below. To review, open the file in an editor that reveals hidden Unicode\ncharacters.\n\n[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)\n\n\n-----\n\n[Show hidden characters](http://10.10.0.46/%7B%7B%20revealButtonHref%20%7D%7D)\n\n<mcconf>\n\n<ver>1000003</ver>\n\n<gtag>tt0002</gtag>\n\n<servs>\n\n<srv>91.219.28.77:443</srv>\n\n<srv>193.9.28.24:443</srv>\n\n<srv>37.1.209.51:443</srv>\n\n<srv>138.201.44.28:443</srv>\n\n<srv>188.116.23.98:443</srv>\n\n<srv>104.250.138.194:443</srv>\n\n<srv>46.22.211.34:443</srv>\n\n<srv>68.179.234.69:443</srv>\n\n<srv>5.12.28.0:443</srv>\n\n<srv>36.37.176.6:443</srv>\n\n<srv>37.109.52.75:443</srv>\n\n<srv>84.232.251.0:443</srv>\n\n</servs>\n\n<autorun>\n\n<module name=\"systeminfo\" ctl=\"GetSystemInfo\"/>\n\n<module name=\"injectDll\"/>\n\n</autorun>\n\n</mcconf>\n\n[view raw](https://gist.github.com/hasherezade/0c464f970018f509444243b67a0c5447/raw/8efd199d3cae8ed26623e606bfb4cf08daf45ea3/mcconf2.xml)\n\n[mcconf2.xml](https://gist.github.com/hasherezade/0c464f970018f509444243b67a0c5447#file-mcconf2-xml)\n\nhosted with ❤ by [GitHub](https://github.com/)\n\n\n-----\n\nNotice that names of the listed modules (systeminfo, injectDll) are corresponding to those,\nthat we found in the folder Modules during the behavioral analysis. It is due to the fact, that\nthis configuration gives instructions to the bot, and orders it to download particular elements.\n\nSome of the requests result in downloading additional pieces of configuration. Example of\nthe response, after being decrypted by the bot:\n\nThis file contains bidirectional Unicode text that may be interpreted or compiled differently\nthan what appears below. To review, open the file in an editor that reveals hidden Unicode\ncharacters.\n[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)\n\n[Show hidden characters](http://10.10.0.46/%7B%7B%20revealButtonHref%20%7D%7D)\n\n<servconf>\n\n<expir>1480550400</expir>\n\n<plugins>\n\n<psrv>80.79.114.179:443</psrv>\n\n</plugins>\n\n</servconf>\n\n[view raw](https://gist.github.com/hasherezade/0c464f970018f509444243b67a0c5447/raw/8efd199d3cae8ed26623e606bfb4cf08daf45ea3/servconf.xml)\n\n[servconf.xml](https://gist.github.com/hasherezade/0c464f970018f509444243b67a0c5447#file-servconf-xml)\n\nhosted with ❤ by [GitHub](https://github.com/)\n**Modules**\n\nTrickBot is a persistent botnet agent – but its main power lies in the modules, that are DLLs\ndynamically fetched from the C&C. During the analyzed session, the bot downloaded two\nmodules.\n\ngetsysinfo – used for general system info gathering\ninjectDll – the banker module, injecting DLLs in target browsers in order to steal\ncredentials\n\nList of the attacked browser is hardcoded in the injectDll32.dll:\n\n\n-----\n\nIt case of the Dyreza, this attack was performed directly from the main bot, rather than from\nthe added DLL.\n\nDetails of the attacked target are given in an additional configuration file, stored in the folder:\n_Modules\\injectDll32_config. Below we can see its decrypted form revealing the attacked_\nonline-banking systems:\n\nThis file contains bidirectional Unicode text that may be interpreted or compiled differently\nthan what appears below. To review, open the file in an editor that reveals hidden Unicode\ncharacters.\n\n[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)\n\n[Show hidden characters](http://10.10.0.46/%7B%7B%20revealButtonHref%20%7D%7D)\n\n<igroup>\n\n<dinj>\n\n<lm>*/onlineserv/CM*</lm>\n\n<hl>91.219.28.103/response.php</hl>\n\n<pri>100</pri>\n\n<sq>1</sq>\n\n</dinj>\n\n\n-----\n\n</igroup>\n\n<igroup>\n\n<dinj>\n\n<lm>*ibanking.stgeorge.com.au/ibank/loginPage.action*</lm>\n\n<hl>91.219.28.103/response.php</hl>\n\n<pri>100</pri>\n\n<sq>1</sq>\n\n</dinj>\n\n</igroup>\n\n<igroup>\n\n<dinj>\n\n<lm>*ib.nab.com.au/nabib/index.jsp*</lm>\n\n<hl>91.219.28.103/response.php</hl>\n\n<pri>100</pri>\n\n<sq>1</sq>\n\n</dinj>\n\n</igroup>\n\n<igroup>\n\n<dinj>\n\n<lm>*banking.westpac.com.au/wbc/banking/handler*</lm>\n\n<hl>91.219.28.103/response.php</hl>\n\n<pri>100</pri>\n\n<sq>1</sq>\n\n</dinj>\n\n</igroup>\n\n<igroup>\n\n\n-----\n\n<dinj>\n\n<lm>*anz.com/IBAU/BANKAWAYTRAN*</lm>\n\n<hl>91.219.28.103/response.php</hl>\n\n<pri>100</pri>\n\n<sq>1</sq>\n\n</dinj>\n\n<dinj>\n\n<lm>*anz.com/INETBANK/login.asp*</lm>\n\n<hl>91.219.28.103/response.php</hl>\n\n<pri>100</pri>\n\n<sq>1</sq>\n\n</dinj>\n\n</igroup>\n\n<igroup>\n\n<dinj>\n\n<lm>*cibconline.cibc.com/olbtxn/authentication/*.cibc*</lm>\n\n<hl>91.219.28.103/response.php</hl>\n\n<pri>100</pri>\n\n<sq>1</sq>\n\n</dinj>\n\n</igroup>\n\n[view raw](https://gist.github.com/hasherezade/0c464f970018f509444243b67a0c5447/raw/8efd199d3cae8ed26623e606bfb4cf08daf45ea3/dinj.xml)\n\n[dinj.xml](https://gist.github.com/hasherezade/0c464f970018f509444243b67a0c5447#file-dinj-xml)\n\nhosted with ❤ by [GitHub](https://github.com/)\nThe instances of svchost.exe, observed during the behavioral analysis, are used to deploy\nparticular modules.\n\nBelow – the module injectDll (marked sinj) in memory of svchost:\n\n\n-----\n\nand the module systeminfo (marked GetSystemInfo) in memory of the another instance of\n_svchost:_\n\n## Conclusion\n\nTrick Bot have many similarities with Dyreza, that are visible at the code design level as well\nas the communication protocol level. However, comparing the code of both, shows, that it\nhas been rewritten from scratch.\n\nSo far, Trick Bot does not have as many features as Dyreza bot. It may be possible, that the\nauthors intentionally decided to make the main executable lightweight, and focus on making\nit dynamically expendable using downloaded modules. Another option is that it still not the\nfinal version.\n\nOne thing is sure – it is an interesting piece of work, written by professionals. Probability is\nvery high, that it will become as popular as its predecessor.\n\n## Appendix\n\n[http://www.threatgeek.com/2016/10/trickbot-the-dyre-connection.html – analysis of the](http://www.threatgeek.com/2016/10/trickbot-the-dyre-connection.html)\nTrickBot at Threat Geek Blog\n\n\n-----\n\n_This was a guest post written by Hasherezade, an independent researcher and programmer_\n_with a strong interest in InfoSec. She loves going in details about malware and sharing threat_\n_[information with the community. Check her out on Twitter @hasherezade and her personal](https://twitter.com/hasherezade)_\n_[blog: https://hshrzd.wordpress.com.](https://hshrzd.wordpress.com/)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-10-24 - Introducing TrickBot, Dyreza’s successor.pdf"
    ],
    "report_names": [
        "2016-10-24 - Introducing TrickBot, Dyreza’s successor.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535605,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1653713759,
    "ts_modification_date": 1653713759,
    "files": {
        "pdf": "https://archive.orkl.eu/ce3bb2129f93024ee0da9a2fc95c380ebac211ba.pdf",
        "text": "https://archive.orkl.eu/ce3bb2129f93024ee0da9a2fc95c380ebac211ba.txt",
        "img": "https://archive.orkl.eu/ce3bb2129f93024ee0da9a2fc95c380ebac211ba.jpg"
    }
}