{
    "id": "61a1a55a-56ef-4565-85f7-178c37aab5ff",
    "created_at": "2023-02-02T02:08:08.737584Z",
    "updated_at": "2025-03-27T02:05:50.914662Z",
    "deleted_at": null,
    "sha1_hash": "0f17a32262e175afa0ab9696820d4b35effe2ce5",
    "title": "2022-12-07 - New Babuk Ransomware Found in Major Attack",
    "authors": "",
    "file_creation_date": "2023-02-01T07:37:52Z",
    "file_modification_date": "2023-02-01T07:37:52Z",
    "file_size": 1771795,
    "plain_text": "# Babuk Ransomware Variant in Major New Attack\n\n**[blog.morphisec.com/babuk-ransomware-variant-major-attack](https://blog.morphisec.com/babuk-ransomware-variant-major-attack)**\n\nMorphisec Labs\n\n## New Babuk Ransomware Found in Major Attack\n\nPosted by [Morphisec Labs on December 7, 2022](https://blog.morphisec.com/author/morphisec-labs)\n\n[Tweet](https://twitter.com/share)\n\n[During November, Morphisec identified a brand-new variant of Babuk ransomware while](https://malpedia.caad.fkie.fraunhofer.de/details/win.babuk)\ninvestigating a customer's prevention event. Babuk was first discovered at the beginning of\n2021, when it began targeting businesses to steal and encrypt data in double-extortion\n\n\n-----\n\n[attacks. Later in the year, a threat actor leaked the complete source code for Babuk on a](https://www.bleepingcomputer.com/news/security/babuk-ransomwares-full-source-code-leaked-on-hacker-forum/)\nRussian-speaking hacking forum.\n\nNow threat actors have combined Babuk’s leaked source code with open-source evasive\nsoftware and side loading techniques to create a variant previously unseen in the wild.\n[During the same month, Trend Micro released details about a similar ransomware,](https://www.trendmicro.com/en_us/research/22/k/wannaren-returns-as-life-ransomware--targets-india.html)\nmistakenly attributing it to WannaRen and naming the ransomware after the targeted\ncompany’s name. This time attackers used a new Babuk strain to target a large\nmanufacturing company with more than 10,000 workstations and server devices.\n\nThe attackers had network access for two weeks of full reconnaissance prior to launching\ntheir attack. They have compromised the company’s domain controller and used it to\ndistribute ransomware to all devices within the organization through GPO. At this time, we\nwon't publish details about the full attack chain due to an ongoing investigation. Instead, we\nwill dive into the ransomware itself.\n\nWatch Video At:\n\nhttps://youtu.be/YtvG0UOLT54\n\n\n-----\n\n## Technical Analysis\n\n### Deployment\n\nBefore starting mass infection in the domain, the attacker deploys the following malware\nfiles in the domain controller:\n\n<file>.bat a BAT script responsible for checking the existence of security solutions and\nstarting the execution of a Microsoft installer (.msi)\n<file>.msi we discuss this installer in more detail below\n\nThe attacker uses the domain controller’s NETLOGON folder—a shared folder holding the\nGroup Policy login script files. This ensures the .bat file executes throughout the whole\ndomain.\n\n### Execution\n\nThe msi installer contains four files:\n\nSapphireIMSClient.exe under the hood, this executable is NTSD.exe—a Symbolic\nDebugger tool for Windows. It's a legitimate tool that’s vulnerable to DLL side-loading:\n\ndbgeng.dll the main malware component, it impersonates a legitimate DLL used by\nNTSD.exe and exploits the DLL side-loading vulnerability.\nTwo encrypted files sc.ocs and config.ocs\n\nThe .bat file will:\n\nSetup a UAC bypass in the registry\n\nCheck for security solutions and block communication to them by adding new firewall\nrules\n\n\n-----\n\nExecute the installer responsible for unpacking files into the\nC:\\Users\\Public\\SapphireIMSClient\\ folder\n\nAfter that, the .bat executes the following command line:\nC:\\Users\\Public\\SapphireIMSClient\\SapphireIMSClient.exe\nC:\\Users\\Public\\SapphireIMSClient\\sc.ocs C:\\Users\\Public\\SapphireIMSClient\\config.ocs\n\n### Injecting Open-Source Tools Into Legitimate DLL\n\nAs noted, the NTDS.exe (SapphireIMSClient.exe) is a legitimate executable that loads a\nknown core DLL named dbgeng.dll without validating its path. The attacker drops the\nmalicious DLL in the same directory with the same name. This leads to the execution of the\nlegitimate Microsoft signed process. Attackers were also previously using vulnerable Word\nOffice applications. Our current assumption is that they’re targeting Microsoft signed\napplications as this dramatically reduces machine learning thresholds for suspicious\nclassification. (No vendor wants to kill Microsoft processes.)\n\nThe malicious code in dbgeng.dll has two responsibilities:\n\n1. Reading the .ocs files into memory\n\nA) sc.ocs an encrypted shellcode—the actual reflective loader of the final payload\n\nB) config.ocs an encrypted binary—the final payload\n\n2. Executing the next stage\n\nThe first task is done in a new thread, as seen in the following snippet:\n\n\n-----\n\nThe malware reads the .ocs file paths from the command line parameters delivered during\nthe execution of the Microsoft application and decrypts the content.\n\nAlthough this logic is widely available online, there's high similarity between the code in the\nDLL and the code in the open-source project: pe-loader (https://github.com/polycone/peloader/blob/master/loader/src/system/system.cpp).\n\nAs mentioned, the execution is divided into two routines. The first, denoted by the figure\nabove, is located in the DLL loading routine, and is responsible for reading the .ocs files and\ndecrypting the sc.ocs file (i.e., the shellcode). The second routine is the DebugCreate\nexported function. It starts with a long Sleep, waiting for the reading task to end, before\nmoving on.\n\n\n-----\n\nInside DebugCreate the malware adjusts the protection permissions to RWX, decrypts the\npayload, and transfers the execution to the decrypted shellcode:\n\n### Reflective Loader Shellcode\n\nThe shellcode acts as a reflective loader. The code was first published by Stephen Fewer\n(https://github.com/stephenfewer) but we noticed modifications. There are dozens of\nimplementations and modifications to the original technique but digging deeper revealed a\nhigh correlation between the shellcode used by the attacker and the following GitHub project:\nmalisal/loaders/pe.c (https://github.com/malisal/loaders/blob/master/pe/pe.c)\n\nThe attacker edited some functions, such as the Windows API hashing function, but the\noverall structure and code flow is the same. It looks like the attacker took “inspiration” from\nthe open-source project.\n\n## Final Payload: Modified Babuk Ransomware\n\n\n-----\n\nThe final payload was Babuk ransomware compiled from the source code leaked last year:\nHildaboo/BabukRansomwareSourceCode\n(https://github.com/Hildaboo/BabukRansomwareSourceCode)\n\nWith the following list of processes to stop:\n\n\"sql.exe\"        \"dbeng50.exe\"\n\n\"oracle.exe\"      \"sqbcoreservice.exe\"\n\n\"ocssd.exe\"       \"excel.exe\"\n\n\"dbsnmp.exe\"      \"infopath.exe\"\n\n\"synctime.exe\"     \"msaccess.exe\"\n\n\"agntsvc.exe\"      \"mspub.exe\"\n\n\"isqlplussvc.exe\"    \"onenote.exe\"\n\n\"xfssvccon.exe\"     \"outlook.exe\"\n\n\"mydesktopservice.exe\" \"powerpnt.exe\"\n\n\"ocautoupds.exe\"    \"steam.exe\"\n\n\"encsvc.exe\"      \"thebat.exe\"\n\n\"firefox.exe\"      \"thunderbird.exe\"\n\n\"tbirdconfig.exe\"    \"visio.exe\"\n\n\"mydesktopqos.exe\"   \"winword.exe\"\n\n\n-----\n\nocomm.exe       wordpad.exe\n\n\"dbeng50.exe\"      \"notepad.exe\"\n\n### Similarities\n\n**Code structure: the overall execution flow and code structure correlates to that**\npresented by Babuk ransomware\n**Same encryption algorithm: one of the most characterizing functions of any**\nransomware is the encryption method. We verified that the payload in our case\nmatches the one in the Babuk source-code\n**Configuration: the configuration and usage of the original and variant overlaps**\n\nThe below screenshot shows how certain code blocks match between the source-code and\nthe de-compilation.\n\n**Note: the compiler does its magic in some cases, which can lead to different code**\n**positioning and code reduction.**\n\n### Modifications\n\nWe noticed the shadow copy deletion routine is different from that present in the sourcecode.\n\n_Babuk Ransomware_\n\nThe leaked Babuk source-code shows Shadow Copies deleted by creating new cmd.exe\nprocesses will execute the vssadmin.exe utility:\n\n\n-----\n\n_Modified Babuk Ransomware: The Final Payload Used_\n\nThe malware iterates over the available Shadow Copies by using COM objects that execute\n_WMI queries. The code snippet below shows how the malware executes a WMI query to get_\neach Shadow Copy’s ID, and then using COM, deletes each Shadow Copy by its ID.\n\nIt's worth noting that malware such as BlackMatter and Conti ransomware have exhibited\nsimilar behavior.\n\n## Why Defending Against Babuk Ransomware is So Hard\n\nModern NGAV, EPP, and EDR/XDR have limited visibility into runtime. They’re usually\nrestricted to the use of hooking and/or event tracing for Windows (ETW). Assuming hooks\nand ETW aren’t tampered with, they're just a drop in the ocean of an application’s lifetime\n\n\n-----\n\nexecution activities. This means if an application was loaded successfully, most of the time\nsecurity monitoring solutions will stay blind to the execution of the application until a\nsignificant impact is visible on the system.\n\nThe application's virtualized runtime address space is much larger than a single file.\nTherefore, applying a traditional scanning approach during application execution is a lost\nbattle. Furthermore, such scanning significantly degrades usability and must be minimized as\nmuch as possible.\n\nAttackers know these weaknesses of monitoring and scanning solutions and strive to\nmaintain stealth within the memory of an application. This applies to this new Babuk variant,\nwhich implements side-loading, executes within legitimate applications, and implements\nreflective loading functionality to hide the rest of the execution steps. The attackers\nimplement similar evasion techniques to their initial access and lateral movement steps,\nwhich we will describe in the next blog.\n\n## Moving Target Defense Technology\n\nBecause these threats are highly evasive and exist primarily in device memory, no level of\nNGAV or best-of-breed EDR can reliably detect and stop them. Morphisec's revolutionary,\npatented [Moving Target Defense (MTD) technology is an industry-leading solution that stops](https://www.morphisec.com/moving-target-defense)\nundetectable attacks. It provides an ultra-lightweight, highly effective defensive against inmemory attacks.\n\nMTD morphs the runtime memory environment in an unpredictable manner to hide\napplication and operating system targets from adversaries. This leads to a dramatically\nreduced attack surface that makes targets impossible to find. MTD presents decoys to fool\nand trap threats without affecting usability. It blocks and exposes attackers relying on the\ninvisibility of dynamic execution in-memory.\n\nBy morphing device memory during runtime, Morphisec’s MTD augments an organization's\nexisting security stack to stop and attribute fileless attacks that are otherwise impossible to\ndetect.\n\n## Results of the Attack\n\n[The company used a next generation anti-virus (NGAV) solution and Morphisec Guard to](https://www.morphisec.com/products/morphisec-guard-endpoint-protection)\ndefend their endpoints. The ransomware evaded the NGAV on the company’s endpoints, but\nMorphisec’s Moving Target Defense (MTD) technology stopped the attack, preventing any\ndamage.\n\nMarket-leading EDRs like CrowdStrike and SentinelOne were not able to prevent the new\nBabuk variant at the time of the attack. SentinelOne updated its signatures to detect the\nencrypted shellcode parameter 72 hours after the ransomware was uploaded to an open\n\n\n-----\n\nrepository, and CrowdStrike has also now updated its detection.\n\nAs this new variant of Babuk ransomware shows, MTD delivers unparalleled protection\n[against unknown and in-memory attacks. To learn more, watch for Morphisec’s virtual event](https://engage.morphisec.com/babuk-webinar-2022)\nto hear Morphisec threat research experts share exclusive details about the attack,\nincluding:\n\nFurther technical analysis of the ransomware, including the differences between the\noriginal Babuk ransomware and the new variant\nMore detail on the techniques the ransomware uses to evade NGAV, EPP, and EDR\nsolutions\nRecommendations for adjusting your security posture to protect against the new threat\nPlus we take selected questions about the ransomware\n\n[Register now to watch Threat Alert: New Babuk Ransomware Variant Discovered.](https://engage.morphisec.com/babuk-webinar-2022)\n\nTo protect the privacy of the affected company, Morphisec is not currently releasing the\nindicators of compromise (IOCs) publicly. To request the IOCs, please email Morphisec CTO\n[Michael Gorelik.](mailto:michael@morphisec.com)\n\n[Contact SalesInquire via Azure](mailto:sales@morphisec.com)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-12-07 - New Babuk Ransomware Found in Major Attack.pdf"
    ],
    "report_names": [
        "2022-12-07 - New Babuk Ransomware Found in Major Attack.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1675303688,
    "ts_updated_at": 1743041150,
    "ts_creation_date": 1675237072,
    "ts_modification_date": 1675237072,
    "files": {
        "pdf": "https://archive.orkl.eu/0f17a32262e175afa0ab9696820d4b35effe2ce5.pdf",
        "text": "https://archive.orkl.eu/0f17a32262e175afa0ab9696820d4b35effe2ce5.txt",
        "img": "https://archive.orkl.eu/0f17a32262e175afa0ab9696820d4b35effe2ce5.jpg"
    }
}