{
    "id": "36f4a46a-d4d6-49dd-89c0-0c7fac1356eb",
    "created_at": "2023-01-12T15:09:32.671816Z",
    "updated_at": "2025-03-27T02:06:08.07464Z",
    "deleted_at": null,
    "sha1_hash": "86659a2664dff0b0e6786c80659f7f7058d817e6",
    "title": "2020-09-17 - Complex obfuscation- Meh… (1-2)",
    "authors": "",
    "file_creation_date": "2022-05-28T18:57:55Z",
    "file_modification_date": "2022-05-28T18:57:55Z",
    "file_size": 1107988,
    "plain_text": "# Complex obfuscation? Meh… (1/2)\n\n**decoded.avast.io/janrubin/complex-obfuscation-meh/**\n\nby [Jan RubínSeptember 17, 20207 min read](https://decoded.avast.io/author/janrubin/)\n\n\nSeptember 17, 2020\n\n\nFor some time now, we’ve been monitoring a new strain of malicious programs that we are\nreferring to as “Meh” (we will explain why later on). It all started when we came across large\namounts of files with randomly generated strings at their beginning, followed by a compiled\nAutoIt script… and what a ride it has been since. In this blog series, we will describe how\nwe peeled away at Meh’s obfuscation and what we found thereafter.\n\n## Analysis\n\nMeh is composed of two main parts. The first part is a crypter, we named MehCrypter, that\nconsists of multiple stages, and is distributed as a compiled AutoIt script prepended with a\nrandomly generated string sequence. This string sequence is skipped by the AutoIt\ninterpreter that scans for the magic bytes that determine the file format and effectively\nobfuscates the file without influencing its functionality.\n\nThe second part is a password stealer, called Meh. The stealer is the core of the malware\nand holds many functionalities. It is capable of stealing clipboard contents, keylogging,\nstealing cryptocurrency wallets, downloading additional files via torrents, and much more.\nNearly all of its functionalities are performed in subthreads, executed from injected\nprocesses. We will focus on the password stealer in our next blog post.\n\n## MehCrypter\n\nFirst and foremost, Meh is a password stealer/keylogger. But to get there, we need to chew\nthrough several layers of the MehCrypter. First, let’s take a look at a snippet of what the\nactual crypter looks like from a high level view:\n\n\n-----\n\n_A snippet of the MehCrypter AutoIt script_\nThe string at the beginning of the file is randomly generated and its length varies as well.\nWe have seen samples with several MB of data prepended in this area to samples with\nalmost no data at all.\n\nUpon a closer look, however, the file also contains code which is actually a compiled AutoIt\nscript which can be interpreted by the AutoIt interpreter. The interpreter is designed in such\na way that it searches the entire file content until it finds the string `AU3!EA06 . Thus, the`\nwhole prepended string is skipped completely and serves only as a confusion technique to\navoid detection.\n\nThe decompilation yields a very readable script which serves a single purpose: concatenate\nhard coded hexadecimal strings, decode them, and load the result PE using reflective\nloading via a custom AutoIt PE loader.\n\n\n-----\n\n_A snippet of an AutoIt PE loader_\nNote that up to this point, the crypter is very generic and we have seen at least five different\nfamilies using it so far, with the most known being Agent Tesla and XMRig.\n\n### MehCrypter dropper\n\nFrom the script described above, we can manually extract the binary. This binary is a very\nsimple dropper written in Borland Delphi which makes several HTTP POST requests to the\nC&C server in order to download three additional files:\n\nhttp://83[.]171.237.233/s2/pe.bin\nhttp://83[.]171.237.233/s2/base.au3\nhttp://83[.]171.237.233/s2/autoit.exe\n\nAfter these files are downloaded, they are saved into the `C:\\testintel2\\ directory and`\nthe file `base.au3 is executed (i.e. interpreted by` `autoit.exe ).` `pe.bin is an encrypted`\nMeh password stealer binary. But we will get to that later.\n\nFurthermore, the dropper also tries to clean up the environment from previous installations\nof the Meh password stealer, which we’ll discuss in depth in the next part of this blog series.\nSpecifically, it attempts to terminate several processes:\n\nnotepad.exe\nwerfault.exe\nvbc.exe\n\n\n-----\n\nsysteminfo.exe\ncalc.exe\n\nThese processes are used by Meh for later PE injections. At this stage it also removes its\ninstallation folder `C:\\programdata\\intel\\wireless .`\n\nWe would like to mention one file that is also created by the Meh dropper:\n```\nC:\\testintel2\\a.txt\n\n```\nThis file contains only three bytes: `meh . This was so hilarious upon the first look that we`\ndecided to name the whole family Meh, including its crypter, MehCrypter.\n```\nbase.au3 uses the same crypter (MehCrypter) as the original sample. However, it\n\n```\ncontains a shellcode only instead of a whole PE binary. Thus, it omits the PE loader part\nand it is executed using the CallWindowProc API function.\n\n### base.au3 shellcode\n\nbase.au3 shellcode has two parts. In the first part, the shellcode constructs yet another\nshellcode on the stack. We can see its beginning at the address `0x00000025 . The second`\nshellcode is executed later via an indirect jump.\n\n_Assembly of the base.au3 shellcode with the beginning of the second shellcode_\nThe second part is an unencrypted binary file. The MZ header starts at the address\n```\n0x0000168A .\n\n```\n\n-----\n\n_Assembly of the base.au3 shellcode with the beginning of the binary_\nAs we might guess, the second (constructed) shellcode is in fact another PE loader that just\nloads and executes the hardcoded binary file. This binary is the last stage of the crypter’s\n_envelope and is a stager for the Meh password stealer._\n\n## Meh stager\n\nAfter the long journey of peeling away MehCrypter’s layers, we finally reach the Meh stager,\nwritten in Borland Delphi. This stager is the third (and final) PE loader, which decrypts the\naforementioned `pe.bin file using a very simple XOR cipher.`\n\n### pe.bin decryption\n\nThe decryption function takes two inputs – a base64-encoded ciphertext and a key.\nFortunately, both of these are contained in the `pe.bin .`\n\nThe contents of the `pe.bin file can look like this:`\n\n\n-----\n\n_The contents of pe.bin file with the highlighted XOR key_\nAs can be seen in the screenshot above there is a randomly generated string at the\nbeginning of the file, similarly to the initial AutoIt script. After a series of random letters,\nhowever, we can see a string delimited by pipes, followed by a base64 string. These are\nexactly the parameters the decryption function needs. A corresponding decryptor written in\nPython can be found below.\n\nThe key, as shown above, is not used in this exact form. The malware replaces the first\ncharacter of the key-string with “ a ” and omits the last letter. Thus, the actual key is\n```\nasUzmbiYd .\n\n```\nAfter that, the base64 string is decoded and a one-byte key is derived from the XOR key\nstring:\n\nThe bit-negated version of this one-byte key is then used to decrypt the content of the file.\nAs mentioned before, the cipher is a simple XOR cipher:\n\nDue to a bad key-derivation procedure, the actual size of the key-space is just 256 keys.\nTherefore, an analyst can bruteforce the decryption key, e.g. by trying to decrypt the PE file\nheader looking for MZ magic bytes.\n\n[The whole decryptor written in Python can be found here.](https://github.com/avast/ioc/blob/master/Meh/extras/decryptor_pe_bin.py)\n\n## Campaign overview\n\nThe surge of Meh and MehCrypter infections started mid-June where we were counting\nseveral thousands infections per day. The malware is most prevalent in Spain where Avast\nblocked infection attempts on more than 80 000 of our users The second most targeted\n\n\n-----\n\ncountry is Argentina with more than 2,000 attacked users.\n\n_Map illustrating the countries Meh has targeted from June to September 2020_\n\n_Graph illustrating Meh’s spread in time (hits)_\n\n## Summary\n\nIn this post, we looked into a MehCrypter family that is used to obfuscate many malware\nfamilies circulating in the wild. One of these families is the Meh password stealer, which we\nwill describe in detail in the next part of the series, so stay tuned!\n\n## IoCs\n\nFile name Hash\n\n\n-----\n\nInitial\nAutoIt\nscript\n\nStage 1 –\nDropper\n\nStage 2 –\nShellcode\n\nStage 3 –\nShellcode\n2\n\nStage 4 –\nMeh\nstager\n\n\n94c2479d0a222ebdce04c02f0b0e58ec433b62299c9a537a31090bb75a33a06e\n\n43bfa7e8b83b54b18b6b48365008b2588a15ccebb3db57b2b9311f257e81f34c\n\n34684e4c46d237bfd8964d3bb1fae8a7d04faa6562d8a41d0523796f2e80a2a6\n\n2256801ef5bfe8743c548a580fefe6822c87b1d3105ffb593cbaef0f806344c5\n\n657ea4bf4e591d48ee4aaa2233e870eb99a17435968652e31fc9f33bbb2fe282\n\n\npe.bin 66de6f71f268a76358f88dc882fad2d2eaaec273b4d946ed930b8b7571f778a8\n\nbase.au3 75949175f00eb365a94266b5da285ec3f6c46dadfd8db48ef0d3c4f079ac6d30\n\nautoit.exe 1da298cab4d537b0b7b5dabf09bff6a212b9e45731e0cc772f99026005fb9e48\n\nURL\n\nhttp://83[.]171.237.233/s2/pe.bin\n\nhttp://83[.]171.237.233/s2/base.au3\n\nhttp://83[.]171.237.233/s2/autoit.exe\n\nRepository: [https://github.com/avast/ioc/tree/master/Meh](https://github.com/avast/ioc/tree/master/Meh)\n\n[Tagged ascrypter,](https://decoded.avast.io/tag/crypter/) [obfuscation,](https://decoded.avast.io/tag/obfuscation/) [reversing,](https://decoded.avast.io/tag/reversing/) [stealer](https://decoded.avast.io/tag/stealer/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-09-17 - Complex obfuscation- Meh… (1-2).pdf"
    ],
    "report_names": [
        "2020-09-17 - Complex obfuscation- Meh… (1-2).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536172,
    "ts_updated_at": 1743041168,
    "ts_creation_date": 1653764275,
    "ts_modification_date": 1653764275,
    "files": {
        "pdf": "https://archive.orkl.eu/86659a2664dff0b0e6786c80659f7f7058d817e6.pdf",
        "text": "https://archive.orkl.eu/86659a2664dff0b0e6786c80659f7f7058d817e6.txt",
        "img": "https://archive.orkl.eu/86659a2664dff0b0e6786c80659f7f7058d817e6.jpg"
    }
}