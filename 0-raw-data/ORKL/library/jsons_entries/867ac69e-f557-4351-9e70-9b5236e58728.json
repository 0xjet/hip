{
    "id": "867ac69e-f557-4351-9e70-9b5236e58728",
    "created_at": "2023-01-12T15:01:20.954036Z",
    "updated_at": "2025-03-27T02:05:51.429241Z",
    "deleted_at": null,
    "sha1_hash": "067133dbe81a43f99ea25df4df931009ac802bcd",
    "title": "2017-03-14 - PetrWrap- the new Petya-based ransomware used in targeted attacks",
    "authors": "",
    "file_creation_date": "2022-05-28T03:24:47Z",
    "file_modification_date": "2022-05-28T03:24:47Z",
    "file_size": 243353,
    "plain_text": "# PetrWrap: the new Petya-based ransomware used in targeted attacks\n\n**[securelist.com/blog/research/77762/petrwrap-the-new-petya-based-ransomware-used-in-targeted-attacks/](https://securelist.com/blog/research/77762/petrwrap-the-new-petya-based-ransomware-used-in-targeted-attacks/)**\n\nAuthors\n\nAnton Ivanov\n\nFedor Sinitsyn\n\n## Previously unknown ransomware technique\n\nUPDATE June 27, 2017: About a new wave of Petya/Petrwrap/NotPetya/exPetr ransomware\nattacks read: [Schroedinger’s Pet(ya)](https://securelist.com/schroedingers-petya/78870/)\n\nThis year we found a new family of ransomware used in targeted attacks against\norganizations. After penetrating an organization’s network the threat actors used the PsExec\ntool to install ransomware on all endpoints and servers in the organization. The next\ninteresting fact about this ransomware is that the threat actors decided to use the well-known\n\n\n-----\n\n[Petya ransomware to encrypt user data. As you may know, this family of ransomware has a](https://www.bleepingcomputer.com/news/security/the-petya-and-mischa-ransomwares-part-of-a-new-affiliate-service/)\nRaaS model, but the threat actor decided not to use this ability. To get a workable version of\nthe ransomware, the group behind PetrWrap created a special module that patches the\noriginal Petya ransomware “on the fly”. This is what makes this new malware so unique.\n\n## Tech details\n\nThe PetrWrap Trojan is written in C and compiled in MS Visual Studio. It carries a sample of\nthe Petya ransomware v3 inside its data section and uses Petya to infect the victim’s\nmachine. What’s more, PetrWrap implements its own cryptographic routines and modifies\nthe code of Petya in runtime to control its execution. This allows the criminals behind\nPetrWrap to hide the fact that they are using Petya during infection.\n\n### Modus operandi\n\nAfter being launched PetrWrap delays its execution (sleeps for 5400 seconds = 1.5 hours).\nAfter that it decrypts the main DLL of Petya from its data section and gets ready to call its\nexported function ZuWQdweafdsg345312. This function normally prepares Petya for further\noperations and starts the MBR overwrite process. PetrWrap, however, needs to hook a\ncouple of Petya’s functions first, so it replaces the instructions that call Petya’s DllEntryPoint\nwith NOPs (hex bytes 0x90). This prevents Petya from proceeding on its own and allows\nPetrWrap to make all the necessary computations and preparations before letting it continue.\n\n_Main function of PetrWrap_\n\n\n-----\n\nAfter that PetrWrap makes the necessary cryptographic computations (we ll discuss them in\nmore detail below), hooks two Petya procedures (which are responsible for the generation of\nthe configuration data, dubbed petya_generate_config, and for the MBR overwrite process,\ndubbed petya_infect) and then passes the execution to Petya. For more information on what\n[the original Petya was capable of, please see our previous publication.](https://securelist.com/blog/research/74609/petya-the-two-in-one-trojan/)\n\n### Cryptographic scheme\n\nNormally, Petya generates a 16-byte key and uses the Salsa20 cipher to encrypt the MFT of\nthe NTFS partitions found on local drives. To make decryption possible only by its operators,\nit uses the Elliptic Curve Diffie-Hellman (ECDH) key agreement algorithm with the curve\nsecp192k1 and a public key is embedded into Petya’s body.\n\nThe criminals behind PetrWrap faced a problem: if they used Petya as is, they would be\nunable to decrypt the victim’s machine because they would need the Petya operators’ private\nkey. So what they decided to do was to completely replace the ECDH part of Petya with their\nown independent implementation and use their own private and public keys.\n\nPetrWrap implementation uses cryptographic routines from OpenSSL (whereas Petya used\nthe mbedtls library) and proceeds as follows:\n\nThe Trojan contains an embedded public key master_pub (which is a point on the\ncurve prime192v1 which is again different from the one chosen by Petya);\nDuring each infection PetrWrap generates a new pair of session keys ec_session_priv\n+ ec_session_pub;\nComputes ecdh_shared_digest = SHA512(ECDH(master_pub, ec_session_priv));\n‘Intercepts’ the salsa key generated by Petya and encrypts it using ecdh_shared_digest\n(there are a number of semi-useless manipulations which come down to essentially\nencrypting the salsa key with AES-256 using different parts of ecdh_shared_digest as\nthe key and IV);\nConstructs user_id which is a string representation that contains the encrypted salsa\nkey and the ec_session_pub;\nPasses this user_id to Petya, which uses it as if it was its own data (puts it into the\nconfiguration for the bootloader to be shown to the user after the PC reboot).\n\n\n-----\n\n_The ECDH shared key computation implemented in PetrWrap_\n\n### Hooked procedures\n\nPetrWrap hooks two procedures in Petya which we will call petya_infect and\npetya_generate_config and replaces them with its own procedures dubbed wrap_infect and\nwrap_generate_config.\n\nwrap_infect implements the following functionality:\n\nsaves the salsa key generated by Petya for further use;\npatches the Petya bootloader code and ransom text in order to skip the flashing skull\nanimation and to wipe all mention of Petya in the ransom message;\npasses execution to the original petya_infect procedure.\n\nwrap_generate_config in turn does the following:\n\ncalls the original petya_generate_config procedure;\ngenerates the user_id string according to the algorithm described in the previous\nparagraph;\nreplaces Petya’s id string with this newly generated user_id.\n\n\n-----\n\n_The screen of the infected machine_\n\n## Technical summary\n\nAs a result of all the manipulations described above, PetrWrap achieves the following goals:\n\n1. The victim’s machine is locked and the MFT of NTFS partitions is encrypted securely\n\n(because Petya v3 which is used in this attack doesn’t have flaws of the earlier\nversions and implements Salsa20 correctly);\n\n2. The lockscreen doesn’t show the flashing skull animation and doesn’t contain any\n\nmentions of Petya which makes it harder to assess the situation and determine the\nextent of the caused damage;\n\n3. The developers of PetrWrap didn’t have to write the low-level bootloader code and risk\n\nmaking mistakes similar to the ones observed in earlier versions of Petya.\n\n## Decryption\n\nUnfortunately, this family of ransomware uses a strong encryption algorithm, meaning a\ndecryption tool is out of the question. However, victims can try restoring files using third-party\ntools such as R-Studio.\n\n## Detection\n\n\n-----\n\nKaspersky products successfully detect this ransomware as Trojan-Ransom.Win32.PetrWrap\nand PDM:Trojan.Win32.Generic.\n\n## Conclusion\n\nTargeted attacks on organizations with the main aim of encrypting data are becoming more\npopular. The groups using ransomware in their targeted attacks usually try to find vulnerable\nservers or servers with unprotected RDP access. After penetrating an organization’s network\nthey use special frameworks like Mimikatz to obtain the necessary credentials for installing\nransomware throughout the network. To protect against such attacks, organizations need to\nkeep their server software up to date, use secure passwords for remote access systems,\ninstall security solutions on their servers and use security solutions with behavioral detection\ncomponents on their endpoints.\n\n**Sample MD5**\n\n17c25c8a7c141195ee887de905f33d7b – Trojan-Ransom.Win32.PetrWrap.b\n\n[APT](https://securelist.com/tag/apt/)\n[Encryption](https://securelist.com/tag/encryption/)\n[Financial malware](https://securelist.com/tag/financial-malware/)\n[Malware Technologies](https://securelist.com/tag/malware-technologies/)\n[Petya](https://securelist.com/tag/petya/)\n[RaaS](https://securelist.com/tag/raas/)\n[Ransomware](https://securelist.com/tag/ransomware/)\n[Targeted attacks](https://securelist.com/tag/targeted-attacks/)\n\nAuthors\n\nAnton Ivanov\n\nFedor Sinitsyn\n\nPetrWrap: the new Petya-based ransomware used in targeted attacks\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-03-14 - PetrWrap- the new Petya-based ransomware used in targeted attacks.pdf"
    ],
    "report_names": [
        "2017-03-14 - PetrWrap- the new Petya-based ransomware used in targeted attacks.pdf"
    ],
    "threat_actors": [
        {
            "id": "32a223a8-3c79-4146-87c5-8557d38662ae",
            "created_at": "2022-10-25T15:50:23.703698Z",
            "updated_at": "2025-03-27T02:00:55.528031Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Lazarus Group",
                "Labyrinth Chollima",
                "HIDDEN COBRA",
                "Guardians of Peace",
                "NICKEL ACADEMY",
                "Diamond Sleet"
            ],
            "source_name": "MITRE:Lazarus Group",
            "tools": [
                "RawDisk",
                "Proxysvc",
                "BADCALL",
                "FALLCHILL",
                "WannaCry",
                "HOPLIGHT",
                "TYPEFRAME",
                "Dtrack",
                "HotCroissant",
                "HARDRAIN",
                "Dacls",
                "KEYMARBLE",
                "TAINTEDSCRIBE",
                "AuditCred",
                "netsh",
                "ECCENTRICBANDWAGON",
                "AppleJeus",
                "BLINDINGCAN",
                "ThreatNeedle",
                "Volgmer",
                "Cryptoistic",
                "RATANKBA",
                "Bankshot",
                "Torisma",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "a2b92056-9378-4749-926b-7e10c4500dac",
            "created_at": "2023-01-06T13:46:38.430595Z",
            "updated_at": "2025-03-27T02:00:02.831633Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Operation DarkSeoul",
                "APT38",
                "ATK117",
                "DEV-1222",
                "G0032",
                "APT 38",
                "Stardust Chollima",
                "APT-C-26",
                "ATK3",
                "Diamond Sleet",
                "Hidden Cobra",
                "Unit 121",
                "Subgroup: Bluenoroff",
                "NICKEL GLADSTONE",
                "DEV-0139",
                "Andariel",
                "Operation Troy",
                "COVELLITE",
                "TA404",
                "Lazarus group",
                "Dark Seoul",
                "G0082",
                "NewRomanic Cyber Army Team",
                "Bluenoroff",
                "Appleworm",
                "Nickel Academy",
                "COPERNICIUM",
                "Hastati Group",
                "Bureau 121",
                "Operation AppleJeus",
                "Whois Hacking Team",
                "Citrine Sleet",
                "Sapphire Sleet",
                "Group 77",
                "Labyrinth Chollima",
                "Operation GhostSecret",
                "BeagleBoyz"
            ],
            "source_name": "MISPGALAXY:Lazarus Group",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f32df445-9fb4-4234-99e0-3561f6498e4e",
            "created_at": "2022-10-25T16:07:23.756373Z",
            "updated_at": "2025-03-27T02:02:09.966155Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "APT-C-26",
                "ATK 3",
                "Appleworm",
                "Citrine Sleet",
                "DEV-0139",
                "Diamond Sleet",
                "Gleaming Pisces",
                "Gods Apostles",
                "Gods Disciples",
                "Group 77",
                "Guardians of Peace",
                "Hastati Group",
                "Hidden Cobra",
                "ITG03",
                "Jade Sleet",
                "Labyrinth Chollima",
                "Lazarus Group",
                "NewRomanic Cyber Army Team",
                "Operation 99",
                "Operation AppleJeus",
                "Operation AppleJeus sequel",
                "Operation Blockbuster: Breach of Sony Pictures Entertainment",
                "Operation CryptoCore",
                "Operation Dream Job",
                "Operation Dream Magic",
                "Operation Flame",
                "Operation GhostSecret",
                "Operation In(ter)caption",
                "Operation LolZarus",
                "Operation Marstech Mayhem",
                "Operation No Pineapple!",
                "Operation North Star",
                "Operation Phantom Circuit",
                "Operation Sharpshooter",
                "Operation Ten Days of Rain / DarkSeoul",
                "Operation Troy",
                "SectorA01",
                "Slow Pisces",
                "TA404",
                "TraderTraitor",
                "UNC2970",
                "UNC4034",
                "UNC4736",
                "UNC4899",
                "UNC577",
                "Whois Hacking Team"
            ],
            "source_name": "ETDA:Lazarus Group",
            "tools": [
                "3CX Backdoor",
                "3Rat Client",
                "3proxy",
                "AIRDRY",
                "ARTFULPIE",
                "ATMDtrack",
                "AlphaNC",
                "Alreay",
                "Andaratm",
                "AngryRebel",
                "AppleJeus",
                "Aryan",
                "AuditCred",
                "BADCALL",
                "BISTROMATH",
                "BLINDINGCAN",
                "BTC Changer",
                "BUFFETLINE",
                "BanSwift",
                "Bankshot",
                "Bitrep",
                "Bitsran",
                "BlindToad",
                "Bookcode",
                "BootWreck",
                "BottomLoader",
                "Brambul",
                "BravoNC",
                "Breut",
                "COLDCAT",
                "COPPERHEDGE",
                "CROWDEDFLOUNDER",
                "Castov",
                "CheeseTray",
                "CleanToad",
                "ClientTraficForwarder",
                "CollectionRAT",
                "Concealment Troy",
                "Contopee",
                "CookieTime",
                "Cyruslish",
                "DAVESHELL",
                "DBLL Dropper",
                "DLRAT",
                "DRATzarus",
                "DRATzarus RAT",
                "Dacls",
                "Dacls RAT",
                "DarkComet",
                "DarkKomet",
                "DeltaCharlie",
                "DeltaNC",
                "Dembr",
                "Destover",
                "DoublePulsar",
                "Dozer",
                "Dtrack",
                "Duuzer",
                "DyePack",
                "ECCENTRICBANDWAGON",
                "ELECTRICFISH",
                "Escad",
                "EternalBlue",
                "FALLCHILL",
                "FYNLOS",
                "FallChill RAT",
                "Farfli",
                "Fimlis",
                "FoggyBrass",
                "FudModule",
                "Fynloski",
                "Gh0st RAT",
                "Ghost RAT",
                "Gopuram",
                "HARDRAIN",
                "HIDDEN COBRA RAT/Worm",
                "HLOADER",
                "HOOKSHOT",
                "HOPLIGHT",
                "HOTCROISSANT",
                "HOTWAX",
                "HTTP Troy",
                "Hawup",
                "Hawup RAT",
                "Hermes",
                "HotCroissant",
                "HotelAlfa",
                "Hotwax",
                "HtDnDownLoader",
                "Http Dr0pper",
                "ICONICSTEALER",
                "Joanap",
                "Jokra",
                "KANDYKORN",
                "KEYMARBLE",
                "Kaos",
                "KillDisk",
                "KillMBR",
                "Koredos",
                "Krademok",
                "LIGHTSHIFT",
                "LIGHTSHOW",
                "LOLBAS",
                "LOLBins",
                "Lazarus",
                "LightlessCan",
                "Living off the Land",
                "MATA",
                "MBRkiller",
                "MagicRAT",
                "Manuscrypt",
                "Mimail",
                "Mimikatz",
                "Moudour",
                "Mydoom",
                "Mydoor",
                "Mytob",
                "NACHOCHEESE",
                "NachoCheese",
                "NestEgg",
                "NickelLoader",
                "NineRAT",
                "Novarg",
                "NukeSped",
                "OpBlockBuster",
                "PCRat",
                "PEBBLEDASH",
                "PLANKWALK",
                "POOLRAT",
                "PSLogger",
                "PhanDoor",
                "Plink",
                "PondRAT",
                "PowerBrace",
                "PowerRatankba",
                "PowerShell RAT",
                "PowerSpritz",
                "PowerTask",
                "Preft",
                "ProcDump",
                "Proxysvc",
                "PuTTY Link",
                "QUICKRIDE",
                "QUICKRIDE.POWER",
                "Quickcafe",
                "QuiteRAT",
                "R-C1",
                "ROptimizer",
                "Ratabanka",
                "RatabankaPOS",
                "Ratankba",
                "RatankbaPOS",
                "RawDisk",
                "RedShawl",
                "Rifdoor",
                "Rising Sun",
                "Romeo-CoreOne",
                "RomeoAlfa",
                "RomeoBravo",
                "RomeoCharlie",
                "RomeoCore",
                "RomeoDelta",
                "RomeoEcho",
                "RomeoFoxtrot",
                "RomeoGolf",
                "RomeoHotel",
                "RomeoMike",
                "RomeoNovember",
                "RomeoWhiskey",
                "Romeos",
                "RustBucket",
                "SHADYCAT",
                "SHARPKNOT",
                "SIGFLIP",
                "SIMPLESEA",
                "SLICKSHOES",
                "SORRYBRUTE",
                "SUDDENICON",
                "SUGARLOADER",
                "SheepRAT",
                "SierraAlfa",
                "SierraBravo",
                "SierraCharlie",
                "SierraJuliett-MikeOne",
                "SierraJuliett-MikeTwo",
                "SimpleTea",
                "SimplexTea",
                "SmallTiger",
                "Stunnel",
                "TAINTEDSCRIBE",
                "TAXHAUL",
                "TFlower",
                "TOUCHKEY",
                "TOUCHMOVE",
                "TOUCHSHIFT",
                "TOUCHSHOT",
                "TWOPENCE",
                "TYPEFRAME",
                "Tdrop",
                "Tdrop2",
                "ThreatNeedle",
                "Tiger RAT",
                "TigerRAT",
                "Trojan Manuscript",
                "Troy",
                "TroyRAT",
                "VEILEDSIGNAL",
                "VHD",
                "VHD Ransomware",
                "VIVACIOUSGIFT",
                "VSingle",
                "ValeforBeta",
                "Volgmer",
                "Vyveva",
                "W1_RAT",
                "Wana Decrypt0r",
                "WanaCry",
                "WanaCrypt",
                "WanaCrypt0r",
                "WannaCry",
                "WannaCrypt",
                "WannaCryptor",
                "WbBot",
                "Wcry",
                "Win32/KillDisk.NBB",
                "Win32/KillDisk.NBC",
                "Win32/KillDisk.NBD",
                "Win32/KillDisk.NBH",
                "Win32/KillDisk.NBI",
                "WinorDLL64",
                "Winsec",
                "WolfRAT",
                "Wormhole",
                "YamaBot",
                "Yort",
                "ZetaNile",
                "concealment_troy",
                "http_troy",
                "httpdr0pper",
                "httpdropper",
                "klovbot",
                "sRDI"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535680,
    "ts_updated_at": 1743041151,
    "ts_creation_date": 1653708287,
    "ts_modification_date": 1653708287,
    "files": {
        "pdf": "https://archive.orkl.eu/067133dbe81a43f99ea25df4df931009ac802bcd.pdf",
        "text": "https://archive.orkl.eu/067133dbe81a43f99ea25df4df931009ac802bcd.txt",
        "img": "https://archive.orkl.eu/067133dbe81a43f99ea25df4df931009ac802bcd.jpg"
    }
}