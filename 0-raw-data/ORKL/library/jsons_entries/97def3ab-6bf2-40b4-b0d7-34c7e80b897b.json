{
    "id": "97def3ab-6bf2-40b4-b0d7-34c7e80b897b",
    "created_at": "2023-01-12T14:58:58.061273Z",
    "updated_at": "2025-03-27T02:10:54.39114Z",
    "deleted_at": null,
    "sha1_hash": "8e01ad660d73046d50660df8fea934d68df3f75c",
    "title": "2021-10-08 - Malware Flagpro used by targeted attack group BlackTech",
    "authors": "",
    "file_creation_date": "2022-05-28T02:19:08Z",
    "file_modification_date": "2022-05-28T02:19:08Z",
    "file_size": 442674,
    "plain_text": "# 標的型攻撃グループBlackTechが使用するマルウェア Flagproについて\n\n**[insight-jp.nttsecurity.com/post/102h7vx/blacktechflagpro](https://insight-jp.nttsecurity.com/post/102h7vx/blacktechflagpro)**\n\nHiroki Hada\n\n本日の記事は、SOC アナリスト 小池 倫太郎、小澤 文生 の記事です。\n\n--\n## はじめに\n\n\n-----\n\nBlackTechは2021年も引き続き活発に攻撃を続けており、日本企業を狙った攻撃が複数観測\nされています。そうした攻撃の中で、新たなマルウェアが使用されており、私たちはそれを\nFlagproと呼んでいます。ここでは、Flagproの概要やタイムライン、詳細な解析結果を共有\nします。\n\n## 攻撃の概要\n\nFlagproは攻撃の初期段階で使用されるマルウェアで、攻撃環境の調査や2次検体のダウンロ\nード・実行に使用されます。Flagproを用いた攻撃はおおよそ似通った形式で、攻撃はスピ\nアフィッシングメールから始まります。メールは標的組織に適した内容で、取引先などとの\n連絡のように見せかけた文面となっており、攻撃者が事前に標的組織を調べ上げたことが分\nかります。\n\nメールにはパスワード保護されたアーカイブファイル（ZIPやRAR形式）が添付されてお\nり、メール本文にそのファイルを展開するためのパスワードが書かれています。アーカイブ\nファイルには、xlsm形式のオフィスファイルが含まれています。xlsmファイルにはマクロが\n仕込まれており、ユーザがそのマクロを有効化してしまうことでマルウェアが展開されま\nす。xlsmファイルに含まれているコンテンツは標的組織に適した内容であることがあり、一\n見すると攻撃であることは気づきにくくなっています。\n\nxlsmファイルに仕込まれたマクロが実行されると、スタートアップディレクトリにexeファ\nイルが作成されます。このexeファイルがFlagproです。多くの場合、ここで作成されるexe\nファイルはdwm.exeという名前となっています。次にシステムが起動したとき、スタートア\nップディレクトリに配置されたFlagproが実行されます。\n\nFlagproはC&Cサーバと通信を行い、サーバからコマンドを受け取って実行したり、2次検体\nをダウンロードして実行したりします。攻撃者は最初に環境調査を行い、Flagproの動作環\n境が標的として適しているか調査します。適していると判断した場合、2次検体がダウンロ\nード・実行されます。\n\n## タイムライン\n\n私たちは防衛、メディア、通信に関わる複数の企業に対する攻撃でFlagproが使用されてい\nることを確認しています。2020年10月にはオンラインサービスへ投稿されたサンプルが存\n在しており、その時点で攻撃に使用されていた可能性があります。\n\n\n-----\n\n## Flagproの機能\n\nSOCでは、2021年7月に、従来のFlagproではみられなかった、MFC (Microsoft Foundation\nClass) ライブラリを使用して実装された新たなFlagproを確認しました。このFlagproに実装\nされたクラスの中に、”CV20_LoaderApp”や”CV20_LoaderDlg”という名前のクラスが存在し\nていました。このクラス名から、Flagproの役割がDownloaderであり、検体のバージョンが\n2.0であることが推測されます。\n\n本記事では、MFCが使用された当該検体をFlagpro v2.0とし、MFCが使用されていない従来\nの検体を便宜上、Flagpro v1.0と呼称していきます。\n\nFlagproに実装されている主要な機能は以下の通りで、Flagpro v2.0ではCV20_LoaderAppク\nラスのメンバー関数の中に実装されていました。\n\nツールのダウンロードと実行\nOSコマンドの実行と実行結果の送信\nWindowsに保存された認証情報の収集と収集した情報の送信\n\nFlagproは起動した後、基本的な動作として、C&Cサーバにコマンドをリクエストし、受信\nしたコマンドに従って、ツールのダウンロードと実行、OSコマンドの実行と実行結果の送\n信、Basic認証などの認証情報の収集と収集した情報の送信を実行します。その後、一定の\n時間待機した後、コマンドを再度リクエストし、この一連の動作を繰り返し実行します。\n\nツールのダウンロードと実行では、まず、ダウンロードしたファイルを %Temp%\\~MY[09A-F].tmp というファイルパスで保存します。そして、保存したファイル名に拡張子\n「.exe」を追記して実行します。\n\nFlagpro v1.0では、外部サイトにアクセスした際に、「Windows セキュリティ」というタイ\nトルのダイアログが表示されていた場合、自動的にOKボタンを押下してダイアログをクロ\nーズさせています。他に、「Windows 安全」や「Windows Security」といったタイトルの\nダイアログに対しても同じようにクローズ処理が実施され、このことから、日本や台湾、英\n語圏の国をターゲットとしていることが伺えます。Flagpro v2.0では、追加で、ダイアログ\nにユーザ名やパスワードといったログイン情報が記入されていることを確認してから、ダイ\nアログのOKボタンを自動的に押下させています。\n\n\n-----\n\nまた、Flagpro v2.0で実装されたものですが、外部サイトにアクセスした際に、タイトルが\n「Internet Explorer 7」から「Internet Explorer 11」までのダイアログが表示されていた場\n合、該当するダイアログにWM_CLOSEメッセージを送信し、ダイアログを自動的にクロー\nズさせています。\n\nこうしたダイアログを自動的にクローズさせる機能は、Proxy認証の確認ダイアログが表示\nされるなどといった、Flagproによる外部接続をユーザに気付かれてしまうリスクを低減さ\nせるために実装されたものだと推測されます。\n\nFlagpro v2.0では、簡便な難読化として、以下のように、同じコードを繰り返し挿入し、重\n要な処理をみえにくくしていました。\n\n## 受信コマンド\n\nC&Cサーバから取得したコマンドはBase64方式でエンコードされており、デコードする\nと、Flagpro v2.0の場合、以下のような形式となっていました。\n\nDownload Commandは、以下のように、2つのフラグとダウンロードファイルのURLパスで\n構成されています。冒頭の文字列”Exec”は活動フラグになっており、これがDownload\nCommand 1とDownload Command 2の両方に記載されていないとダウンロードやOSコマン\nド実行、認証情報の収集といった主要な処理が実施されません。次の文字列”Yes”は実行フ\nラグとなっており、これが記載されていないと、ダウンロードしたファイルは実行されませ\nん。\n\n\n-----\n\nTime Intervalは次にコマンドをリクエストするまでの待機時間で、単位はミリ秒です。\n\n実際に、C&Cサーバから受信したコマンド例を以下に示します。\n\n## C&C通信\n\nFlagpro v1.0とv2.0によるC&Cサーバとの通信処理は、Internet ExplorerのCOMオブジェク\nトを使用して実装されています。C&Cサーバとの通信はHTTPプロトコルを使用していま\nす。\n\nコマンドをリクエストする場合やOSコマンドの実行結果を送信する場合、そして、収集し\nた認証情報を送信する場合、それぞれ以下に示す特定のURLパスとクエリーでC&Cサーバに\nアクセスしにいきます。送信データはBase64方式でエンコードされ、URLパラメータの値\nとしてC&Cサーバに送られています。\n\nアクセスの目的 **URLパスとクエリー**\n\nコマンドのリクエスト /index.html\n\nOSコマンドの実行結果の送信 /index.htmld?flag=[Encode Data]\n\n認証情報の送信 /index.htmld?flagpro=[Encoded Data]\n\nツールをダウンロードする場合は、サーバに設置されているファイルの名前に依存するた\nめ、特定のURLパスはありません。\n\n実際に、Flagpro v2.0がC&Cサーバと通信した際のトラフィック（コマンドのリクエスト）\nを以下に示します。\n\n\n-----\n\n2021年7月時点で、レスポンスが必要となるコマンドリクエストやダウンロード以外のURL\nパスとクエリーでアクセスした場合、C&Cサーバは以下のようなレスポンスを返しました。\nレスポンスボディには、意図は不明ですが、「Hello Boy!」と記載されていました。\n\n## 検知ロジック\n\nFlagproを用いた攻撃では、ネットワークおよびエンドポイントでの検知ロジックが有効で\nす。ネットワークによる検知の場合、Flagproが使用する index.htmld?flag=[Base64文字列]\nや index.htmld?flagpro=[Base64文字列] などの特徴的なURLパスを用いることができます。\n\nエンドポイントにおける検知としては、FlagproがC&Cサーバからデータを取得するときに\n使用される一時ファイルの命名規則 %TEMP%\\~MY[0-9A-F].tmp や %TEMP%\\~MY[0-9AF].tmp.exe を用いることができます。また、FlagproがC&Cサーバとの通信成立初期に実行\nする調査コマンドも特徴となりえます。\n\n## おわりに\n\n\n-----\n\n2020年10月頃から、Flagproを使用した攻撃が日本に対して行われています。基本的に攻撃\nの手法に変化はありませんが、標的に合わせてデコイファイルやファイル名を設定したり、\n環境を注意深くチェックしたりと、巧妙な攻撃となっています。今後もBlackTechによる攻\n撃には細心の注意を払う必要があるでしょう。\n\n## IoC\n\n54e6ea47eb04634d3e87fd7787e2136ccfbcc80ade34f246a12cf93bab527f6b\ne197c583f57e6c560b576278233e3ab050e38aa9424a5d95b172de66f9cfe970\n655ca39beb2413803af099879401e6d634942a169d2f57eb30f96154a78b2ad5\n840ce62f92fc519cd1a33b62f4b9f92a962b7fb28c12d2f607dec0b520e6a4b2\nba27ae12e6f3c2c87fd2478072dfa2747d368a507c69cd90b653c9e707254a1d\n45[.]76.184.227\n45[.]32.23.140\n139[.]162.87.180\n107[.]191.61.40\norg.misecure[.]com\nupdate.centosupdates[.]com\n\n\n-----",
    "language": "JA",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-10-08 - Malware Flagpro used by targeted attack group BlackTech.pdf"
    ],
    "report_names": [
        "2021-10-08 - Malware Flagpro used by targeted attack group BlackTech.pdf"
    ],
    "threat_actors": [
        {
            "id": "2646f776-792a-4498-967b-ec0d3498fdf1",
            "created_at": "2022-10-25T15:50:23.475784Z",
            "updated_at": "2025-03-27T02:00:55.479958Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Palmerworm"
            ],
            "source_name": "MITRE:BlackTech",
            "tools": [
                "Kivars",
                "PsExec",
                "TSCookie",
                "Flagpro",
                "Waterbear"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d3a7123c-f519-49a0-a234-de24a1ef052a",
            "created_at": "2022-10-25T16:47:55.545211Z",
            "updated_at": "2025-03-27T02:05:17.254744Z",
            "deleted_at": null,
            "main_name": "BRONZE CANAL",
            "aliases": [
                "CTG-6177 ",
                "Circuit Panda ",
                "Palmerworm ",
                "Shrouded Crossbow ",
                "BlackTech"
            ],
            "source_name": "Secureworks:BRONZE CANAL",
            "tools": [
                " DRIGO",
                " Flagpro",
                " Gh0stTimes",
                " PLEAD",
                " Spiderpig",
                " Waterbear",
                "Bifrose"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75024aad-424b-449a-b286-352fe9226bcb",
            "created_at": "2023-01-06T13:46:38.962724Z",
            "updated_at": "2025-03-27T02:00:02.964002Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "CIRCUIT PANDA",
                "Temp.Overboard",
                "G0098",
                "Red Djinn",
                "HUAPI",
                "Palmerworm",
                "T-APT-03",
                "Manga Taurus",
                "Earth Hundun"
            ],
            "source_name": "MISPGALAXY:BlackTech",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "efa7c047-b61c-4598-96d5-e00d01dec96b",
            "created_at": "2022-10-25T16:07:23.404442Z",
            "updated_at": "2025-03-27T02:02:09.781478Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Circuit Panda",
                "Earth Hundun",
                "Manga Taurus",
                "Operation PLEAD",
                "Operation Shrouded Crossbow",
                "Operation Waterbear",
                "Palmerworm",
                "Radio Panda",
                "Red Djinn",
                "T-APT-03",
                "TEMP.Overboard"
            ],
            "source_name": "ETDA:BlackTech",
            "tools": [
                "BIFROST",
                "BUSYICE",
                "BendyBear",
                "Bluether",
                "CAPGELD",
                "DRIGO",
                "Deuterbear",
                "Flagpro",
                "GOODTIMES",
                "Gh0stTimes",
                "IconDown",
                "KIVARS",
                "LOLBAS",
                "LOLBins",
                "Linopid",
                "Living off the Land",
                "TSCookie",
                "Waterbear",
                "XBOW",
                "elf.bifrose"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535538,
    "ts_updated_at": 1743041454,
    "ts_creation_date": 1653704348,
    "ts_modification_date": 1653704348,
    "files": {
        "pdf": "https://archive.orkl.eu/8e01ad660d73046d50660df8fea934d68df3f75c.pdf",
        "text": "https://archive.orkl.eu/8e01ad660d73046d50660df8fea934d68df3f75c.txt",
        "img": "https://archive.orkl.eu/8e01ad660d73046d50660df8fea934d68df3f75c.jpg"
    }
}