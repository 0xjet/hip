{
    "id": "d2f17d62-f7ff-4c01-8e18-5c3db9857b2c",
    "created_at": "2023-01-12T15:08:32.8924Z",
    "updated_at": "2025-03-27T02:05:48.976294Z",
    "deleted_at": null,
    "sha1_hash": "989b3cd3d6f78459759388cc878d053de309dec0",
    "title": "2015-04-17 - Andromeda-Gamarue bot loves JSON too (new versions details)",
    "authors": "",
    "file_creation_date": "2022-05-28T00:29:09Z",
    "file_modification_date": "2022-05-28T00:29:09Z",
    "file_size": 856166,
    "plain_text": "# Andromeda/Gamarue bot loves JSON too (new versions details)\n\n**eternal-todo.com/blog/andromeda-gamarue-loves-json**\n\n[Analysis](https://eternal-todo.com/category/analysis)\n[Andromeda](https://eternal-todo.com/category/andromeda)\n[Botnet](https://eternal-todo.com/category/botnet)\n[Gamarue](https://eternal-todo.com/category/gamarue)\n[Malware](https://eternal-todo.com/category/malware)\n[Reversing](https://eternal-todo.com/category/reversing)\n\nAfter [my last post about Andromeda different updates related to version 2.07 and 2.08](http://eternal-todo.com/blog/yet-another-andromeda-gamarue-analysis)\n[appeared. Mostly, Fortinet was talking about the version 2.7 features and the](http://blog.fortinet.com/post/andromeda-2-7-features) new antianalysis tricks of version 2.08. After that, Kimberly was also mentioning version 2.09 in his\nblog but I have not seen too many details about the latest versions of Andromeda. This is\na summary of the interesting details about the newer versions.\n\n## Andromeda versions\n\nAfter version 2.08, the parameter used to send the bot version to the panel was removed\nfrom the POST request, so now it is a bit more difficult to distinguish between versions. An\neasy way to spot the different versions is taking a look at the request format strings:\n\n**_id:%lu|bid:%lu|bv:%lu|sv:%lu|pa:%lu|la:%lu|ar:%lu (<=2.06)_**\n\n**_id:%lu|bid:%lu|bv:%lu|os:%lu|la:%lu|rg:%lu (2.07/2.08)_**\n\n**_id:%lu|bid:%lu|os:%lu|la:%lu|rg:%lu_** (2.09)\n\n**_{\"id\":%lu,\"bid\":%lu,\"os\":%lu,\"la\":%lu,\"rg\":%lu}_** (2.10?)\n\nIf the element bv (bot version) is present, it is easy, but if it is not there this trick can help.\nThe latest version I have analyzed uses JSON to communicate with the control panel, but I\nam not 100% sure if that it is really version 2.10 (advertised in March 2015) or a variation\nof version 2.09. I say that I am not sure because Alexandru Maximciuc (Bitdefender)\nspotted one version already in January 2015 and since then there were more botnets\nusing this version and before the advertisement was published in March.\n\nNowadays, most of the Andromeda botnets use the leaked version 2.06. Then, the latest\nversion seems to be really popular too, together with version 2.09. The rest of the versions\nseem to have a lower number of botnets.\n\n## RC4 key and C&C URL decryption\n\nSince version 2.09 Andromeda includes the fake RC4 key\n_754037e7be8f61cbb1b85ab46c7da77d which is the MD5 hash of \"go fuck yourself\" Of_\n\n\n-----\n\ncourse, this is just a distraction for the analysts and the good key is located in a different\noffset in memory. The RC4 key is used to encrypt the communication with the C&C but in\nreverse order is also used to decrypt the C&C URLs. I won't give more details about it\n[because this blog post explains really well how and where the decrypted URLs are stored](http://byte-atlas.blogspot.nl/2015/04/kf-andromeda-bruteforcing.html)\nin memory.\n\n## Task types removed\n\nIn the previous versions of Andromeda seven different task types were supported when\nthe bot was asking the C&C for tasks to execute:\n\n1: Download executable\n\n2: Install plugin\n\n3: Update bot\n\n4: Install DLL\n\n5: Uninstall DLL\n\n6: Delete plugins\n\n9: Kill bot\n\nHowever, since version 2.09 the task types in charge of installing and uninstalling DLLs\nhave been removed:\n\n\n-----\n\n## Network Time Protocol (NTP) traffic\n\nThe latest version of Andromeda uses some NTP domains to obtain the real time and\nstore that in a variable. This timestamp will be incremented by the bot as a time counter\nand it will be used as the first argument of the function \"aStart\", apparently exported by\nsome plugins. The hardcoded NTP domains are:\n```\neurope.pool.ntp.org\nnorth-america.pool.ntp.org\nsouth-america.pool.ntp.org\nasia.pool.ntp.org\noceania.pool.ntp.org\nafrica.pool.ntp.org\npool.ntp.org\n\n## C&C requests\n\n```\nI was talking above about the request format used to send the different parameters to the\ncontrol panel. This POST request is encrypted with the RC4 key and used to be encoded\nwith Base64. However, this latest version of Andromeda skips the Base64 encoding and\nsends the data directly. It also changes the Content-Type header from the usual\n“application/x-www-form-urlencoded” to “application/octet-stream”. Fortunately for the\nlovers of SNORT rules, it keeps using the same User-Agent, “Mozilla/4.0”. This is an\nexample of a random sample:\n\n\n-----\n\nTalking about the C&C response, all the previous versions use the Botid (bid) to decrypt\nthis information. However, the latest version uses the same RC4 key needed to encrypt\nthe request, instead of the Botid.\n\n## Plugin decryption\n\nWhen the previous Andromeda versions (<=2.09) were installing plugins from a given\nURL, the bot was decrypting them skipping certain bytes as header and using the RC4 key\nto decrypt the data from a specific offset. After that aPLib was used to decompress the\nfinal DLL. In the latest version the process to decrypt the plugins is slightly more complex:\n\nDecrypt the header (43 bytes) with the RC4 key\n\n\nThe first DWORD is the XOR key to decrypt the other header values (after the 16\nbyte)\n\nThe first 16 bytes are the RC4 key to decrypt the plugin\n\nAfter that there is an aPLib compression layer too\n\n\nth\n\n\n-----\n\nSince version 2.09 Andromeda added a TeamViewer plugin to its collection and it sends\nthe TeamViewer ID and password to the panel to be able to connect easily to the machine.\n\n## More processes blacklisted\n\nHe Xu (Fortinet) made a good job when he added a screenshot with the new hashes\nblacklisted in versions 2.07 and 2.08. I really liked the idea and I did the same with these\nnew versions. I also tried to discover what processes were hidden after these hashes,\nuncovering all except one :) This is the full list:\n```\ndd 99DD4432h ; vmwareuser.exe \ndd 2D859DB4h ; vmwareservice.exe \ndd 64340DCEh ; vboxservice.exe \ndd 63C54474h ; vboxtray.exe \ndd 349C9C8Bh ; sandboxiedcomlaunch.exe \ndd 3446EBCEh ; sandboxierpcss.exe \ndd 5BA9B1FEh ; procmon.exe \ndd 3CE2BEF3h ; regmon.exe \ndd 3D46F02Bh ; filemon.exe \ndd 77AE10F7h ; wireshark.exe \ndd 0F344E95Dh ; netmon.exe \ndd 2DBE6D6Fh ; prl_tools_service.exe (Parallels) \ndd 0A3D10244h ; prl_tools.exe (Parallels) \ndd 1D72ED91h ; prl_cc.exe (Parallels) \ndd 96936BBEh ; sharedintapp.exe (Parallels) \ndd 278CDF58h ; vmtoolsd.exe \ndd 3BFFF885h ; vmsrvc.exe \ndd 6D3323D9h ; vmusrvc.exe \ndd 0D2EFC6C4h ; python.exe \ndd 0DE1BACD2h ; perl.exe \ndd 3044F7D4h ; ???\n\n```\nAs you can see, the version 2.09 includes the same hashes as the version 2.08, but the\nlatest version adds python.exe, perl.exe and another mysterious process to the black list.\nIt would be nice if someone could uncover this missing process. Challenge:\nCRC32(lower($process)) = 0x3044F7D4; $process = ???\n\n## Anti-analysis bypass\n\nThe old Andromeda versions used to include a nice bypass of the anti-analysis routine. If\nthe CRC32 checksum of the system drive volume name was 0x20C7DD84 then the bot\nwas executing correctly even if it was running in a virtual environment. The latest version\n\n\n-----\n\nhas removed this bypass but it includes a different one. It is a bit more annoying to set it\nup, but not really difficult.\n\nYou need to create a value “is_not_vm” with a DWORD equal to the botid in the registry\nkey “HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies”. After that even if you are executing\nthe blacklisted processes it will infect correctly.\n\n## More fun!\n\nIt seems that the development of Andromeda continues and they keep adding more\nfunctionalities and new features to the bot. It is always fun taking a look at the new\nadditions, so I am looking forward to the next version already ;) I want more fun! :)\n\n**b4da6909cf8b5e3791fc5be398247570 (latest)**\n**511e1a70e071ef059e07ff92cba4fe70 (2.09)**\n**9048e3797b1b24e83be5cf6f6a18fcb0 (2.08)**\n**d7c00d17e7a36987a359d77db4568df0 (2.07)**\n**a6dd2204319d5fc96995bbbb22a41960 (2.06)**\n\n\n-----\n\n## Update (2015-05-05)\n\nOn the 24th of April [@thedude13 found an Andromeda variant sending a new parameter](https://twitter.com/thedude13)\nto the control panel:\n\nThis variant (c73190c0b99109155df4c4c1006da43d) adds the parameter \"bb\" to the\nrequest format string:\n\n**{\"id\":%lu,\"bid\":%lu,\"os\":%lu,\"la\":%lu,\"rg\":%lu,\"bb\":%lu}**\n\nDigging a bit in the code we can see that this new parameter is a flag specifying if the\ninfected system uses a \"friendly\" keyboard layout (bb_flag = 1). The list of cool countries\nconsidered friends by Andromeda are: Russia, Ukraine, Belarus and Kazakhstan.\n\nThis flag, besides being sent to the panel, will be checked in several locations in the code.\nIf it is set:\n\nIt will not assure persistence of the bot after the system shuts down.\nNo tasks will be executed in the infected system, meaning that no plugins/udpates\nwill be installed and no additional malware will be dropped.\nIt will not disable security services and system notifications.\nIt will not disable UAC.\nIt will not generate NTP traffic and it will not hook the NtMapViewOfSection function.\n\n\n-----\n\n## Update (2015-07-26)\n\nIn the paragraph related to the new processes blacklisted I was asking for some help to\ndiscover which process name was related to the CRC32 value 0x3044F7D4. After some\ntries with well-known security tools I was not able to uncover it. I did not try with processes\nrelated to AV software though. Yesterday, a new comment was added by snemes solving\nthe mystery (kudos to him!!). The process name avpui.exe (Kaspersky) has that specific\nCRC32 value :) This process is not the AV engine itself but the graphic interface\n(separated processes since Kaspersky Internet Security 2014). That's curious. Another\nquestion could be why Andromeda checks just for that Kaspersky process name and not\nfor other AV products...:?\n\nSubmitted by jesparza on Fri, 2015/04/17 - 01:47\n\n#1Submitted by snemes (not verified) on Sat, 2015/07/25 - 20:23.\n\n### The missing CRC32 value,\n\nThe missing CRC32 value, 0x3044f7d4 is the checksum for avpui.exe\n\nYou are welcome. :)\n\n#2Submitted by jesparza on Sun, 2015/07/26 - 17:57.\n\n### Oh!! Nice!! Thank you!! ;) I\n\n\n-----\n\nOh!! Nice!! Thank you!! ;) I will update the blog post with this info...:)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-04-17 - Andromeda-Gamarue bot loves JSON too (new versions details).pdf"
    ],
    "report_names": [
        "2015-04-17 - Andromeda-Gamarue bot loves JSON too (new versions details).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536112,
    "ts_updated_at": 1743041148,
    "ts_creation_date": 1653697749,
    "ts_modification_date": 1653697749,
    "files": {
        "pdf": "https://archive.orkl.eu/989b3cd3d6f78459759388cc878d053de309dec0.pdf",
        "text": "https://archive.orkl.eu/989b3cd3d6f78459759388cc878d053de309dec0.txt",
        "img": "https://archive.orkl.eu/989b3cd3d6f78459759388cc878d053de309dec0.jpg"
    }
}