{
    "id": "f5a6671e-c5e0-4850-a762-fff41e2f1260",
    "created_at": "2023-01-12T14:59:07.596114Z",
    "updated_at": "2025-03-27T02:17:23.428101Z",
    "deleted_at": null,
    "sha1_hash": "f61d03ffa7b06ea40b335da6af500ef696265cb8",
    "title": "2019-10-17 - Let's Learn- Dissecting Lazarus Windows x86 Loader Involved in Crypto Trading App Distribution- -snowman- & ADVObfuscator",
    "authors": "",
    "file_creation_date": "2022-05-28T04:41:45Z",
    "file_modification_date": "2022-05-28T04:41:45Z",
    "file_size": 754057,
    "plain_text": "# Let's Learn: Dissecting Lazarus Windows x86 Loader Involved in Crypto Trading App Distribution: \"snowman\" & ADVObfuscator\n\n**[vkremez.com/2019/10/lets-learn-dissecting-lazarus-windows.html](https://www.vkremez.com/2019/10/lets-learn-dissecting-lazarus-windows.html)**\n\nGoal: Document and dissect the latest Lazarus Windows 32-bit (x86) version involved in the\ncrypto trading application distribution targeting Windows and macOS users. The malware\n[and the campaign were originally discovered by MalwareHunterTeam.](https://twitter.com/malwrhunterteam)\n\nWhere we found it now?: https://www.jmttrading[.]org/ (Sectigo cert from July 11) ->\nhttps://github[.]com/jmttrading/JMTTrader/releases -> JMTTrader_Win.msi - signed\ninstaller (Sectigo given cert too) -> drops signed CrashReporter.exe to AppData.\n\n[(The Mac .dmg has malware too...) pic.twitter.com/7r3SuWbItP](https://t.co/7r3SuWbItP)\n[— MalwareHunterTeam (@malwrhunterteam) October 11, 2019](https://twitter.com/malwrhunterteam/status/1182624997577244673?ref_src=twsrc%5Etfw)\n\nSource:\n\nSigned Windows .msi SHA-256:\n\n07c38ca1e0370421f74c949507fc0d21f4cfcb5866a4f9c0751aefa0d6e97542\nSigned Windows malware SHA-256:\n\n9bf8e8ac82b8f7c3707eb12e77f94cd0e06a972658610d136993235cbfa53641\nmacOS .dmg SHA-256:\n\ne352d6ea4da596abfdf51f617584611fc9321d5a6d1c22aff243aecdef8e7e55\nmacOS malware SHA-256:\n\n4d6078fc1ea6d3cd65c3ceabf65961689c5bc2d81f18c55b859211a60c141806\n**Outline:**\n```\nI. Background & Summary\nII. Lazarus Windows 32-bit (x86) Loader/Backdoor Internals\nIII. Command Line Check Function\nIV. Encoder Function\nV. Malware Capabilities\nVI. Lazarus Loader/Backdoor: ADVObfuscator as \"snowman\" Library\n\n```\nI. Background & Summary\n\n\n-----\n\nThe purported North Korean state-sponsored group known as “Lazarus” appears to continue\ntargeting crypto users via elaborate and sophisticated malware distribution methodology by\nsetting up the website, Twitter, and GitHub account as well as leveraging digital certificate for\nthe Windows malware specifically.\nPreviously, Kaspersky researchers noted the very similar malware in 2018 in the report titled\n“Operation AppleJeus: Lazarus hits cryptocurrency exchange with fake installer and macOS\nmalware.”\n\nThe group appears to employ both macOS and Windows malware variants. While the\nmacOS version remained to be unobfuscated and simple, the Windows version of this\nmalware is rather notable and included the renamed ADVObfuscation library as “snowman”\nto complicate malware reverse engineering.\nThe final payload is yet unknown; however, the group previously deployed this similar\nloader/backdoor to install the malware backdoor known as “Fallchill.”\nII. Lazarus Windows 32-bit (x86) Loader/Backdoor Internals\n\n\n-----\n\nThe malware backdoor 32-bit (x86) is coded in Microsoft Visual C++ 8. It is signed and\nexecuted via \"Maintain\" parameter. The malware itself is heavily obfuscated executed as\ntask \"JMTCrashReporter\".\n\nThe compilation timestamp is Friday, October 04 02:22:31 2019 UTC with the Sectigo signer\nfor \"JMT TRADING GROUP INC\" with the postal code \"91748\" and valid from 12/07/2019\n00:00:00 to 11/07/2020 23:59:59. The zip code corresponds to the Los Angeles area, United\nStates.\nIII. Command Line Check Function\nThe malware checks for the argument “Maintain” before final execution.\n```\n//////////////////////////////////////////////////////////////////////////////////////\n/////////////////////////////// Compare Cmd Function\n////////////////////////////////////////////\n//////////////////////////////////////////////////////////////////////////////////////\nchar __thiscall compare_command(void *this)\n{\n...\n v1 = this;\n v2 = GetCommandLineA();\n v3 = sub_445020(v2, 0x20u);\n **((_DWORD **)v1 + 1) = v3;\n if ( !v3 )\n  goto LABEL_9;\n v4 = (_DWORD *)*((_DWORD *)v1 + 1);\n v5 = strcmp((const char *)++*v4, **((const char ***)v1 + 2));// 'Maintain' arg\ncheck \n if ( v5 )\n  v5 = -(v5 < 0) | 1;\n if ( v5 )\nLABEL_9:\n  result = 1;\n else\n  result = 0;\n return result;\n}\n\n```\n\n-----\n\n**IV. Encoder Function**\nThe binary encodes the victim information using the key “X,%`PMk--Jj8s+6=15:20:11” before\nsubmitting the information to the server. The pseudo-coded function is as follows:\n```\n//////////////////////////////////////////////////////////////////////////////////////\n/////////////////////////////// Encoder Function\n////////////////////////////////////////////\n//////////////////////////////////////////////////////////////////////////////////////\nint __thiscall encoder_func(int this)\n{\n...\n v1 = this;\n v2 = this;\n v3 = *(_DWORD **)(this + 8);\n *v3 ^= 0x721u;\n *v3 ^= 0x721u;\n v4 = **(_DWORD **)(this + 8);\n v5 = *(_DWORD **)(this + 8);\n *v5 ^= 0x721u;\n *v5 ^= 0x721u;\n v6 = **(_DWORD **)(v1 + 8);\n v7 = *(_DWORD **)(v1 + 12);\n *v7 ^= 0x721u;\n *v7 ^= 0x721u;\n v8 = **(_DWORD **)(v1 + 12);\n v9 = *(_DWORD **)(v2 + 8);\n *v9 -= 0xCBC;\n *v9 += 0xCBC;\n *(_BYTE *)(**(_DWORD **)(v2 + 8) + **(_DWORD **)(v2 + 4)) = *(_BYTE *)\n   (**(_DWORD **)(v2 + 4) + v4) ^ key[v6 % v8]; // X,%`PMk--Jj8s+6=15:20:11\n return **(_DWORD **)(v2 + 16);\n}\n\n```\nV. Malware Capabilities\nThe similar binary capabilities were documented as part of the analogous unobfuscated\n[MacOS version in the report titled “Pass the AppleJeus.” In this case, the Windows malware](https://objective-see.com/blog/blog_0x49.html)\nincludes the separator “--wMKBUqjC7ZMG5A5g”\nThe malware capabilities include the following shortened functionality:\n```\nRead/write itself to various directories \nQuery registry and save in the registry\nConnect to the server\nFind files\nExtract and decode resource \nCollect processes delete and terminate them\n\n```\nThe malware formats the request and processes the command from the server as follows:\n\n\n-----\n\n```\nRequest/%lu\n%sd.e%sc \"%s > %s 2>&1\"\n\n```\nThe malware connection form-data is as this for example:\n```\nxX7ZXX5A5g\n--wMKBUqjC7ZMG5A5g\nContent-Disposition: form-data; name=\"token\"; \n11056\n--wMKBUqjC7ZMG5A5g\nContent-Disposition: form-data; name=\"query\"; \nconn\n--wMKBUqjC7ZMG5A5g\nContent-Disposition: form-data; name=\"content\"; filename=\"mont.jpg\"\nContent-Type: application/octet-stream\n\n```\nVI. Lazarus Loader/Backdoor: ADVObfuscator as \"snowman\" Library\nOne of the more interesting discoveries was that the Lazarus malware utilizes the\n[ADVObfuscator open-source library simply renamed as “snowman” based on the template](https://github.com/andrivet/ADVobfuscator)\nC++ definition left in the binary. The malware developer appears to have simply manually\ninserted the obfuscator library with the definitions.\n_“ADVobfuscator demonstrates how to use C++11 language to generate, at compile-time,_\n_obfuscated code without using any external tool and without modifying the compiler. The_\n_technics presented rely only on C++11, as standardized by ISO. It shows also how to_\n_introduce some form of randomness to generate polymorphic code and it gives some_\n_concrete examples like the encryption of strings literals and the obfuscation of calls using_\n_finite state machines.”_\nThe Lazarus sample introduces randomness leveraging mov instruction and offsets to\nfunction to complicate static and dynamic analysis as well as reverse engineering efforts.\n\n\n-----\n\nThe fragment of the typical generated deobfuscation code is as follows:\n```\n///////////////////////////////////////////////////\n//// FRAGMENT OF OBFUSCATION ADDRESS RETRIEVE /////\n///////////////////////////////////////////////////\n0FBEC0    MOVSX EAX,AL\n83E8 07    SUB EAX,7\n88440C 78   MOV BYTE PTR SS:[ESP+ECX+78],AL\n41      INC ECX\n83F9 1C    CMP ECX,1C\n\n```\n[During AppSec2014, Sebastien Andrivet demonstrated this exact similar technique used by](https://github.com/andrivet/ADVobfuscator/blob/master/Docs/AppSecForum2014-Andrivet-Cplusplus11_metaprogramming_applied_to_software_obfuscation.pdf)\nthe Lazarus sample via the renamed ADVObfuscation library.\n\n\n-----\n\nThe relevant template and definition of the original relevant source code are as follows:\n\n\n-----\n\n```\n#define OBFUSCATED_CALL0(f)\nandrivet::ADVobfuscator::ObfuscatedCall<andrivet::ADVobfuscator::Machine1::Machine>\n(MakeObfuscatedAddress(f, andrivet::ADVobfuscator::MetaRandom<__COUNTER__,\n400>::value + 278))\n#define OBFUSCATED_CALL_RET0(R, f)\nandrivet::ADVobfuscator::ObfuscatedCallRet<andrivet::ADVobfuscator::Machine1::Machine,\n R>(MakeObfuscatedAddress(f, andrivet::ADVobfuscator::MetaRandom<__COUNTER__,\n400>::value + 278))\n#define OBFUSCATED_CALL(f, ...)\nandrivet::ADVobfuscator::ObfuscatedCall<andrivet::ADVobfuscator::Machine1::Machine>\n(MakeObfuscatedAddress(f, andrivet::ADVobfuscator::MetaRandom<__COUNTER__,\n400>::value + 278), __VA_ARGS__)\n#define OBFUSCATED_CALL_RET(R, f, ...)\nandrivet::ADVobfuscator::ObfuscatedCallRet<andrivet::ADVobfuscator::Machine1::Machine,\n R>(MakeObfuscatedAddress(f, andrivet::ADVobfuscator::MetaRandom<__COUNTER__,\n400>::value + 278), __VA_ARGS__)\n  // Obfuscate the address of the target. \n  // Very simple implementation but enough to annoy IDA and Co.\n  template<typename F>\n  struct ObfuscatedAddress\n  {\n    // Pointer to a function\n    using func_ptr_t = void(*)();\n    // Integral type big enough (and not too big) to store a \n   function pointer\n    using func_ptr_integral = std::conditional<sizeof(func_ptr_t) <= \n    sizeof(long), long, long long>::type;\n    func_ptr_integral f_;\n    int offset_;\n    constexpr ObfuscatedAddress(F f, int offset): \n    f_{reinterpret_cast<func_ptr_integral>(f) + offset}, offset_{offset} {}\n    constexpr F original() const { return reinterpret_cast<F>(f_ - offset_); }\n  };\n  // Create a instance of ObfuscatedFunc and deduce types\n  template<typename F>\n  constexpr ObfuscatedAddress<F> MakeObfuscatedAddress(F f, int offset) { \n   return ObfuscatedAddress<F>(f, offset); }\n}}\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-10-17 - Let's Learn- Dissecting Lazarus Windows x86 Loader Involved in Crypto Trading App Distribution- -snowman- & ADVObfuscator.pdf"
    ],
    "report_names": [
        "2019-10-17 - Let's Learn- Dissecting Lazarus Windows x86 Loader Involved in Crypto Trading App Distribution- -snowman- & ADVObfuscator.pdf"
    ],
    "threat_actors": [
        {
            "id": "a2b92056-9378-4749-926b-7e10c4500dac",
            "created_at": "2023-01-06T13:46:38.430595Z",
            "updated_at": "2025-03-27T02:00:02.831633Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Operation DarkSeoul",
                "APT38",
                "ATK117",
                "DEV-1222",
                "G0032",
                "APT 38",
                "Stardust Chollima",
                "APT-C-26",
                "ATK3",
                "Diamond Sleet",
                "Hidden Cobra",
                "Unit 121",
                "Subgroup: Bluenoroff",
                "NICKEL GLADSTONE",
                "DEV-0139",
                "Andariel",
                "Operation Troy",
                "COVELLITE",
                "TA404",
                "Lazarus group",
                "Dark Seoul",
                "G0082",
                "NewRomanic Cyber Army Team",
                "Bluenoroff",
                "Appleworm",
                "Nickel Academy",
                "COPERNICIUM",
                "Hastati Group",
                "Bureau 121",
                "Operation AppleJeus",
                "Whois Hacking Team",
                "Citrine Sleet",
                "Sapphire Sleet",
                "Group 77",
                "Labyrinth Chollima",
                "Operation GhostSecret",
                "BeagleBoyz"
            ],
            "source_name": "MISPGALAXY:Lazarus Group",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f32df445-9fb4-4234-99e0-3561f6498e4e",
            "created_at": "2022-10-25T16:07:23.756373Z",
            "updated_at": "2025-03-27T02:02:09.966155Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "APT-C-26",
                "ATK 3",
                "Appleworm",
                "Citrine Sleet",
                "DEV-0139",
                "Diamond Sleet",
                "Gleaming Pisces",
                "Gods Apostles",
                "Gods Disciples",
                "Group 77",
                "Guardians of Peace",
                "Hastati Group",
                "Hidden Cobra",
                "ITG03",
                "Jade Sleet",
                "Labyrinth Chollima",
                "Lazarus Group",
                "NewRomanic Cyber Army Team",
                "Operation 99",
                "Operation AppleJeus",
                "Operation AppleJeus sequel",
                "Operation Blockbuster: Breach of Sony Pictures Entertainment",
                "Operation CryptoCore",
                "Operation Dream Job",
                "Operation Dream Magic",
                "Operation Flame",
                "Operation GhostSecret",
                "Operation In(ter)caption",
                "Operation LolZarus",
                "Operation Marstech Mayhem",
                "Operation No Pineapple!",
                "Operation North Star",
                "Operation Phantom Circuit",
                "Operation Sharpshooter",
                "Operation Ten Days of Rain / DarkSeoul",
                "Operation Troy",
                "SectorA01",
                "Slow Pisces",
                "TA404",
                "TraderTraitor",
                "UNC2970",
                "UNC4034",
                "UNC4736",
                "UNC4899",
                "UNC577",
                "Whois Hacking Team"
            ],
            "source_name": "ETDA:Lazarus Group",
            "tools": [
                "3CX Backdoor",
                "3Rat Client",
                "3proxy",
                "AIRDRY",
                "ARTFULPIE",
                "ATMDtrack",
                "AlphaNC",
                "Alreay",
                "Andaratm",
                "AngryRebel",
                "AppleJeus",
                "Aryan",
                "AuditCred",
                "BADCALL",
                "BISTROMATH",
                "BLINDINGCAN",
                "BTC Changer",
                "BUFFETLINE",
                "BanSwift",
                "Bankshot",
                "Bitrep",
                "Bitsran",
                "BlindToad",
                "Bookcode",
                "BootWreck",
                "BottomLoader",
                "Brambul",
                "BravoNC",
                "Breut",
                "COLDCAT",
                "COPPERHEDGE",
                "CROWDEDFLOUNDER",
                "Castov",
                "CheeseTray",
                "CleanToad",
                "ClientTraficForwarder",
                "CollectionRAT",
                "Concealment Troy",
                "Contopee",
                "CookieTime",
                "Cyruslish",
                "DAVESHELL",
                "DBLL Dropper",
                "DLRAT",
                "DRATzarus",
                "DRATzarus RAT",
                "Dacls",
                "Dacls RAT",
                "DarkComet",
                "DarkKomet",
                "DeltaCharlie",
                "DeltaNC",
                "Dembr",
                "Destover",
                "DoublePulsar",
                "Dozer",
                "Dtrack",
                "Duuzer",
                "DyePack",
                "ECCENTRICBANDWAGON",
                "ELECTRICFISH",
                "Escad",
                "EternalBlue",
                "FALLCHILL",
                "FYNLOS",
                "FallChill RAT",
                "Farfli",
                "Fimlis",
                "FoggyBrass",
                "FudModule",
                "Fynloski",
                "Gh0st RAT",
                "Ghost RAT",
                "Gopuram",
                "HARDRAIN",
                "HIDDEN COBRA RAT/Worm",
                "HLOADER",
                "HOOKSHOT",
                "HOPLIGHT",
                "HOTCROISSANT",
                "HOTWAX",
                "HTTP Troy",
                "Hawup",
                "Hawup RAT",
                "Hermes",
                "HotCroissant",
                "HotelAlfa",
                "Hotwax",
                "HtDnDownLoader",
                "Http Dr0pper",
                "ICONICSTEALER",
                "Joanap",
                "Jokra",
                "KANDYKORN",
                "KEYMARBLE",
                "Kaos",
                "KillDisk",
                "KillMBR",
                "Koredos",
                "Krademok",
                "LIGHTSHIFT",
                "LIGHTSHOW",
                "LOLBAS",
                "LOLBins",
                "Lazarus",
                "LightlessCan",
                "Living off the Land",
                "MATA",
                "MBRkiller",
                "MagicRAT",
                "Manuscrypt",
                "Mimail",
                "Mimikatz",
                "Moudour",
                "Mydoom",
                "Mydoor",
                "Mytob",
                "NACHOCHEESE",
                "NachoCheese",
                "NestEgg",
                "NickelLoader",
                "NineRAT",
                "Novarg",
                "NukeSped",
                "OpBlockBuster",
                "PCRat",
                "PEBBLEDASH",
                "PLANKWALK",
                "POOLRAT",
                "PSLogger",
                "PhanDoor",
                "Plink",
                "PondRAT",
                "PowerBrace",
                "PowerRatankba",
                "PowerShell RAT",
                "PowerSpritz",
                "PowerTask",
                "Preft",
                "ProcDump",
                "Proxysvc",
                "PuTTY Link",
                "QUICKRIDE",
                "QUICKRIDE.POWER",
                "Quickcafe",
                "QuiteRAT",
                "R-C1",
                "ROptimizer",
                "Ratabanka",
                "RatabankaPOS",
                "Ratankba",
                "RatankbaPOS",
                "RawDisk",
                "RedShawl",
                "Rifdoor",
                "Rising Sun",
                "Romeo-CoreOne",
                "RomeoAlfa",
                "RomeoBravo",
                "RomeoCharlie",
                "RomeoCore",
                "RomeoDelta",
                "RomeoEcho",
                "RomeoFoxtrot",
                "RomeoGolf",
                "RomeoHotel",
                "RomeoMike",
                "RomeoNovember",
                "RomeoWhiskey",
                "Romeos",
                "RustBucket",
                "SHADYCAT",
                "SHARPKNOT",
                "SIGFLIP",
                "SIMPLESEA",
                "SLICKSHOES",
                "SORRYBRUTE",
                "SUDDENICON",
                "SUGARLOADER",
                "SheepRAT",
                "SierraAlfa",
                "SierraBravo",
                "SierraCharlie",
                "SierraJuliett-MikeOne",
                "SierraJuliett-MikeTwo",
                "SimpleTea",
                "SimplexTea",
                "SmallTiger",
                "Stunnel",
                "TAINTEDSCRIBE",
                "TAXHAUL",
                "TFlower",
                "TOUCHKEY",
                "TOUCHMOVE",
                "TOUCHSHIFT",
                "TOUCHSHOT",
                "TWOPENCE",
                "TYPEFRAME",
                "Tdrop",
                "Tdrop2",
                "ThreatNeedle",
                "Tiger RAT",
                "TigerRAT",
                "Trojan Manuscript",
                "Troy",
                "TroyRAT",
                "VEILEDSIGNAL",
                "VHD",
                "VHD Ransomware",
                "VIVACIOUSGIFT",
                "VSingle",
                "ValeforBeta",
                "Volgmer",
                "Vyveva",
                "W1_RAT",
                "Wana Decrypt0r",
                "WanaCry",
                "WanaCrypt",
                "WanaCrypt0r",
                "WannaCry",
                "WannaCrypt",
                "WannaCryptor",
                "WbBot",
                "Wcry",
                "Win32/KillDisk.NBB",
                "Win32/KillDisk.NBC",
                "Win32/KillDisk.NBD",
                "Win32/KillDisk.NBH",
                "Win32/KillDisk.NBI",
                "WinorDLL64",
                "Winsec",
                "WolfRAT",
                "Wormhole",
                "YamaBot",
                "Yort",
                "ZetaNile",
                "concealment_troy",
                "http_troy",
                "httpdr0pper",
                "httpdropper",
                "klovbot",
                "sRDI"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535547,
    "ts_updated_at": 1743041843,
    "ts_creation_date": 1653712905,
    "ts_modification_date": 1653712905,
    "files": {
        "pdf": "https://archive.orkl.eu/f61d03ffa7b06ea40b335da6af500ef696265cb8.pdf",
        "text": "https://archive.orkl.eu/f61d03ffa7b06ea40b335da6af500ef696265cb8.txt",
        "img": "https://archive.orkl.eu/f61d03ffa7b06ea40b335da6af500ef696265cb8.jpg"
    }
}