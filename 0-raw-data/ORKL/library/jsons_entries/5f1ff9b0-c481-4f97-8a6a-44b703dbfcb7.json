{
    "id": "5f1ff9b0-c481-4f97-8a6a-44b703dbfcb7",
    "created_at": "2023-06-05T02:07:37.356204Z",
    "updated_at": "2025-03-27T02:05:25.78344Z",
    "deleted_at": null,
    "sha1_hash": "3072eea635456d47b5f1e8cd92732ae980b2f05b",
    "title": "2023-05-19 - Malware source code investigation- AsyncRAT",
    "authors": "",
    "file_creation_date": "2023-06-04T13:03:00Z",
    "file_modification_date": "2023-06-04T13:03:00Z",
    "file_size": 4742505,
    "plain_text": "# Malware source code investigation: AsyncRAT\n\n**[mssplab.github.io/threat-hunting/2023/05/19/malware-src-asyncrat.html](https://mssplab.github.io/threat-hunting/2023/05/19/malware-src-asyncrat.html)**\n\n8 minute read\n\n\nMay 19, 2023\n\n\nAsyncRAT is a Remote Access Trojan (RAT) designed to remotely monitor and control\ninfected systems. It is free, open-source, and often used by cybercriminals for malicious\npurposes, such as stealing sensitive information, installing more malware, or performing\nDDoS attacks.\n\n\n-----\n\n**AsyncRAT was published as an open source remote administration tool project on GitHub in**\nJanuary 2019.\n\n_AsyncRAT is a regular malware product and set of tools utilized by attackers and APT_\norganizations. Threat actors and adversaries utilized a variety of intriguing script injectors\nand spear phishing attachments to deliver AsyncRAT to targeted hosts or networks across\nmultiple campaigns.\n\n\n-----\n\nIn this small research we are detailed investigate the source code of AsyncRAT and\nhighlights the main features.\n\n[AsyncRAT has been included in app.any.run’s weekly TOP 10 malware trends tracker for the](https://any.run/malware-trends/)\npast few months.\n\n\n-----\n\n## Client-Server Architecture\n\nWhen executed, the AsyncRat GUI allows criminals to control the infected machine. The\ncode is open-source and can be modified to suit the purposes of criminals:\n\n_AsyncRAT implements a client-server architecture. The client side is the infected machine,_\nwhereas the server side is the attacker-operated control interface. The client establishes a\nconnection with the server using asynchronous TCP sockets, which permits multiple\nsimultaneous connections without interference.\n\n\n-----\n\n## Core Functionalities\n\n_AsyncRAT includes several functionalities that permit a high degree of control over infected_\nsystems:\n\n**Remote Desktop - The client captures screenshots of the desktop and sends them to the**\nserver, allowing the attacker to see the victim’s activities in real time.\n\n_AsyncRAT uses the .NET Framework’s built-in libraries to capture screenshots from the_\nvictim’s machine. The following is a more technical breakdown of how this feature works in\nthe AsyncRAT client.\n\nIn the AsyncRAT’s source code, you would find a function responsible for capturing\nscreenshots. This function is typically invoked when the server sends a specific command to\nthe client.\n\nTo capture the screenshot, AsyncRAT leverages the System.Drawing namespace in the\n```\n.NET Framework, which provides access to GDI+ basic graphics functionality. More\n\n```\nspecifically, it uses the Bitmap and Graphics classes to capture and store the\nscreenshot(/Plugin/Options/Options/Handler/HandleThumbnails.cs):\n\n\n-----\n\nThis code does the following:\n\nCreates a new Bitmap object with the same size as the screen. The\n```\n   Screen.PrimaryScreen.Bounds property is used to determine the size of the screen.\n\n```\nCreates a Graphics object from the bitmap. This object is used to perform the\nscreenshot operation.\n\nUses the Graphics.CopyFromScreen method to take the screenshot. This method\ncopies the pixels from the screen and stores them in the bitmap.\n\nAfter the screenshot is captured and stored in the bitmap, AsyncRAT then usually converts\nthe bitmap to a byte array and sends it to the server. The server can then reconstruct the\nbitmap from the byte array to view the screenshot. It’s worth noting that the screenshot is\nusually compressed before being sent to reduce network usage.\n\n**Keylogger - AsyncRAT logs keystrokes and periodically sends the data to the server. This**\nfeature can capture sensitive information like passwords and credit card numbers.\n\n_AsyncRAT captures keystrokes by using the SetWindowsHookEx function, which is part of the_\nWindows API. This function allows the application to install a “hook” that monitors the\nmessage traffic in the system and retrieves specific types of messages, such as keypresses.\n\n\n-----\n\nThe following is a code of how AsyncRAT implement a keylogger in C# using the\n```\nSetWindowsHookEx function (Plugin/LimeLogger/LimeLogger/Packet.cs):\n\n```\nThe SetHook function installs the keyboard hook by calling SetWindowsHookEx with the\n```\nLowLevelKeyboardProc delegate. The hook is then uninstalled using UnsetHook:\n\n```\n\n-----\n\n**File Explorer - The client can navigate the filesystem, upload files to the server, download**\nfiles from the server, and execute files.\n\nTo accomplish these tasks, AsyncRAT uses standard .NET Framework libraries. Let’s break\ndown each function separately.\n\n_Navigating the File System. The System.IO namespace in the .NET Framework contains_\nclasses for manipulating files and directories. For example, AsyncRAT retrieve a list of files in\na directory using the Directory.GetFiles method\n(Plugin/FileSearcher/FileSearcher/Packet.cs):\n\n\n-----\n\nAnd get subdirectories with Directory.GetDirectories method\n(Plugin/FileManager/FileManager/Handler/FileManager.cs):\n\n\n-----\n\n_Uploading Files To the Server. To read the contents of a file, AsyncRAT uses the_\n```\nFile.ReadAllBytes method, which reads a file and returns its contents as a byte array (for\n\n```\nexample in Plugin/FileSearcher/FileSearcher/Packet.cs):\n\n_Downloading Files from the Server. When the server sends a file, it is usually in the form of a_\nbyte array. The client can save this byte array to a file using the File.WriteAllBytes\nmethod (for example in: Server/HandlePacket/HandleFileSearcher.cs):\n\n\n-----\n\n_Executing Files. To execute a file, AsyncRAT uses the Process.Start method from the_\n```\nSystem.Diagnostics namespace\n\n```\n(Plugin/FileManager/FileManager/Handler/FileManager.cs):\n\n**Process Manager - The client retrieves a list of running processes and can kill or start**\nprocesses.\n\n\n-----\n\n_AsyncRAT utilizes the System.Diagnostics namespace in the .NET Framework to interact_\nwith system processes.\nRetrieving a List of Running Processes. The Process class in the\n```\nSystem.Diagnostics namespace has a static method GetProcesses that returns an array of\nProcess objects, which represent all the processes currently running on the system. Here is\n\n```\nhow it’s used (Plugin/ProcessManager/ProcessManager/Packet.cs):\n\nalso use SELECT ProcessId, Name, ExecutablePath FROM Win32_Process query:\n\n\n-----\n\n_Starting a Process. To start a new process, AsyncRAT uses the Process.Start method,_\nwhich starts a process resource by specifying the name of an application or document:\n\n\n-----\n\nNote that all these operations require sufficient permissions. If the AsyncRAT client doesn’t\nhave the necessary permissions, these operations will fail.\n\n**Remote Shell - The client can execute shell commands from the server, enabling an even**\ngreater degree of control.\n\nThe ability to execute shell commands remotely is a powerful feature of AsyncRAT. This\nfeature allows the attacker to execute virtually any command, as if they were physically\npresent at the victim’s machine.\n\n_AsyncRAT executes shell commands by using the System.Diagnostics.Process class in_\nthe .NET Framework. This class provides the Start method, which can start a new process.\nTo execute a shell command, AsyncRAT starts a new instance of cmd.exe with the shell\ncommand as a parameter\n(Plugin/Miscellaneous/Miscellaneous/Handler/HandleShell.cs):\n\n\n-----\n\n## Stealth and Persistence\n\nTo evade detection, AsyncRAT uses several techniques:\n\n**Process Injection - AsyncRAT injects its core functionality into a separate process to hide**\nits malicious activities.\n\nThe injector is used to load into the memory the AsyncRAT file by taking advantage of the\n[Process Hollowing technique. As demonstrated, a new thread is created, put in a suspended](https://attack.mitre.org/techniques/T1055/012/)\nstate (pause), the target file mapped into the memory, and then executed:\n\n\n-----\n\n**Anti-Analysis - The client employs various anti-analysis techniques, including the detection**\nof virtual machines and sandbox environments.\n\nMalware often employs anti-analysis techniques to evade detection, avoid being analyzed in\na controlled environment, and ultimately to make reverse-engineering more challenging. This\nincludes checks for virtual machines (VMs) and sandbox environments, which are commonly\nused tools for malware analysis.\n\n\n-----\n\nAnalyzing the source code of AsyncRAT, you may find various techniques that it employs to\nachieve this (Client/Helper/Anti_Analysis.cs). While specific implementation details\ncould vary depending on the version or variant of the RAT, here’s an example of what these\nanti-analysis checks might look like in practice.\n\nHere is how AsyncRAT check for a VM and a sandbox:\n\nAs you can see, just check if Sbiedll.dll is loaded, which is a module of sandboxie\nsandbox.\n\nAlso check disk size:\n\n\n-----\n\nThe logic is simple, determine if a compromised host is operating in a malware lab or\nsandbox by examining the size of its hard drive.\n\nAnother method is IsXP: check if its process is running in XP Windows Operating System:\n\nCheck if remote debugger exist:\n\nThe following image depicts the code that drops a .bat script in the %temp% folder to delete\nitself as part of a defense evasion technique to clear its trace after execution and drop a copy\nof itself on the compromised host:\n\n**Persistence - The client installs itself to the registry or startup folder to maintain persistence**\nafter system reboots.\n\n\n-----\n\nThe AsyncRAT client will verify that its code executes with administrative permissions. If so, it\nwill add Windows Scheduled Tasks using schtasks.exe with the highest runlevel\npermissions to execute a duplicate of itself, if AsyncRAT is not running with administrative\nprivileges, it will use Registry Run Key\n```\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run for its\n\n```\npersistence:\n\n## Connection and Control\n\nOn execution, the client initiates a connection to the server. After a successful connection,\nthe client sends detailed system information to the server, including the computer name, user\nname, operating system, processor, and installed antivirus software. The client also\ndownloads a small .NET assembly DLL file from the server, which is injected into a newly\ncreated process. This is where the AsyncRAT’s core functionality is executed.\n\n_AsyncRAT will decrypt its AES encrypted configuration data including the port and C2 IP_\naddress that will be used for C2 communication:\n\n\n-----\n\nThis is the code snippet for C2 server communication and C2 downloads:\n\n## Updating and Uninstalling\n\n_AsyncRAT allows for the updating and uninstalling of the client directly from the server._\n\n\n-----\n\nThe uninstall functionality would typically involve the server sending a command to the client,\ntelling it to remove itself from the infected machine. This might involve deleting the client\nbinary, as well as any other files created by the client. The client might also remove any\nregistry keys it has created, and undo any other changes it has made to the system.\n\n## Conclusion\n\nGiven its open-source nature and availability on GitHub since January 2019, AsyncRAT is\naccessible to a wide range of threat actors, including both individual malicious actors and\nsophisticated APT groups. This availability, combined with its powerful features, makes it a\npopular choice for cybercriminals.\n\nThe observed campaigns leveraging spear-phishing attacks and script loaders, such as the\none using a Microsoft OneNote attachment to load a .HTA file, demonstrate that attackers\ncan employ a variety of methods to deliver AsyncRAT to targeted hosts or networks. This\nunderlines the importance of a comprehensive security posture, encompassing not just\nmalware detection and removal, but also employee training and robust email security\nmeasures to combat spear-phishing attacks.\n\nBy Cyber Threat Hunters from MSSPLab:\n\n\n-----\n\n[@cocomelonc](https://www.linkedin.com/in/zhassulan-zhussupov-5a347419b/)\n[@wqkasper](https://www.linkedin.com/in/aruzhan-kaldybek-775735226)\n\n## References\n\n[https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp](https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp)\n[https://malpedia.caad.fkie.fraunhofer.de/details/win.asyncrat](https://malpedia.caad.fkie.fraunhofer.de/details/win.asyncrat)\n[https://twitter.com/anyrun_app/status/1617401778240102400](https://twitter.com/anyrun_app/status/1617401778240102400?s=20&t=ED5KEvCMTz8_F2IjR61j8Q)\n[https://any.run/malware-trends/](https://any.run/malware-trends/)\n[MITRE ATT&CK: Process Hollowing](https://attack.mitre.org/techniques/T1055/012/)\n[https://research.splunk.com/stories/asyncrat/](https://research.splunk.com/stories/asyncrat/)\n\nThanks for your time happy hacking and good bye!\n_All drawings and screenshots are MSSPLab’s_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-05-19 - Malware source code investigation- AsyncRAT.pdf"
    ],
    "report_names": [
        "2023-05-19 - Malware source code investigation- AsyncRAT.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1685930857,
    "ts_updated_at": 1743041125,
    "ts_creation_date": 1685883780,
    "ts_modification_date": 1685883780,
    "files": {
        "pdf": "https://archive.orkl.eu/3072eea635456d47b5f1e8cd92732ae980b2f05b.pdf",
        "text": "https://archive.orkl.eu/3072eea635456d47b5f1e8cd92732ae980b2f05b.txt",
        "img": "https://archive.orkl.eu/3072eea635456d47b5f1e8cd92732ae980b2f05b.jpg"
    }
}