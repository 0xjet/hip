{
    "id": "ce8f0f5d-b4cc-40bb-a54b-203647c8c65d",
    "created_at": "2023-01-12T15:09:21.15205Z",
    "updated_at": "2025-03-27T02:05:46.641341Z",
    "deleted_at": null,
    "sha1_hash": "e12aed3f25dc271c59067b144ac64a92588ccdaa",
    "title": "2017-10-11 - Spoofed SEC Emails Distribute Evolved DNSMessenger",
    "authors": "",
    "file_creation_date": "2022-05-27T21:57:51Z",
    "file_modification_date": "2022-05-27T21:57:51Z",
    "file_size": 1178817,
    "plain_text": "# Spoofed SEC Emails Distribute Evolved DNSMessenger\n\n**[blog.talosintelligence.com/2017/10/dnsmessenger-sec-campaign.html](https://blog.talosintelligence.com/2017/10/dnsmessenger-sec-campaign.html)**\n\n## Executive Summary\n\n\n-----\n\n[Cisco Talos previously published research into a targeted attack that leveraged an interesting](https://blog.talosintelligence.com/2017/03/dnsmessenger.html)\ninfection process using DNS TXT records to create a bidirectional command and control (C2)\nchannel. Using this channel, the attackers were able to directly interact with the Windows\nCommand Processor using the contents of DNS TXT record queries and the associated\nresponses generated on the attacker-controlled DNS server.\n\nWe have since observed additional attacks leveraging this type of malware attempting to\ninfect several target organizations. These attacks began with a targeted spear phishing email\nto initiate the malware infections and also leveraged compromised U.S. state government\nservers to host malicious code used in later stages of the malware infection chain. The spear\nphishing emails were spoofed to make them appear as if they were sent by the Securities\nand Exchange Commission (SEC) in an attempt to add a level of legitimacy and convince\nusers to open them. The organizations targeted in this latest malware campaign were similar\nto those targeted during previous DNSMessenger campaigns. These attacks were highly\ntargeted in nature, the use of obfuscation as well as the presence of a complex multi-stage\ninfection process indicates that this is a sophisticated and highly motivated threat actor that\nis continuing to operate.\n\n## Technical Details\n\nThe emails associated with this malware campaign were spoofed to make them appear as if\nthey had originated from the Securities and Exchange Commission (SEC) Electronic Data\nGathering, Analysis, and Retrieval (EDGAR) system. For those not familiar with this system,\nEDGAR is an automated filing platform that organizations can use to submit filings which are\nlegally required to be performed by publicly traded companies. This was likely done to\nincrease the perceived legitimacy of the emails and increase the chances that the recipient\nwould open the email and associated attachments.\n\n**Figure 1: Example Malicious Email**\n\nThe emails themselves contained a malicious attachment that when opened would initiate a\nsophisticated multi-stage infection process leading to infection with DNSMessenger malware.\nThe malicious attachments were Microsoft Word documents. Rather than leveraging macros\nor OLE objects, which are some of the most common ways that Microsoft Word documents\nare leveraged to execute code, these attachments leveraged Dynamic Data Exchange\n\n\n-----\n\n[(DDE) to perform code execution. A description of this technique has been published here.](https://sensepost.com/blog/2017/macro-less-code-exec-in-msword/)\nThis technique has recently been publicized following a Microsoft decision that this\nfunctionality is a feature by design and will not be removed. We are now seeing it actively\nbeing used by attackers in the wild, as demonstrated in this attack.\n\nSimilar to the emails described above, the malicious attachments were made to appear as if\nthey had originated from the SEC and include logos and branding as well as information that\nwould be expected from any documents received from the SEC. When opened, victims\nwould be greeted with a message informing them that the document contains links to\nexternal files, and asking them to allow/deny the content to be retrieved and displayed.\n\n**Figure 2: DDE Message Prompt**\n\n**Figure 3: Example Malicious Document**\n\nIn the case of this attack, if the user allows the external content to be retrieved, the malicious\n\n\n-----\n\ndocument will reach out to attacker hosted content to retrieve code that will be executed to\ninitiate the malware infection. Interestingly, the DDEAUTO field used by this malicious\ndocument retrieved code that the attacker had initially hosted on a Louisiana state\ngovernment website, which was seemingly compromised and used for this purpose. The\nDDEAUTO command that is executed is below:\n\n**Figure 4: DDE Code Retrieval Command**\n\nThe aforementioned command results in the code hosted at the referenced URL to be\ndownloaded and executed directly using Powershell. The contents of the code that is\nretrieved from the server is Powershell code and includes a code blob that is both Base64\nencoded and gzipped. The code is retrieved, deobfuscated, then passed to the InvokeExpression (IEX) cmdlet and executed by Powershell.\n\n**Figure 5: Stage 1 Code**\n\nThe deobfuscated code is responsible for staging and kicking off subsequent stages of the\ninfection process. It is also responsible for achieving persistence on systems. The code\nfeatures a number of ways that persistence may be achieved depending on the operating\nenvironment of the malware. It determines the version of Powershell on the infected system\nas well as the access privileges of the user to determine how to proceed with achieving this\npersistence.\n\nFirst, a blob of code called $ServiceCode, which is also both base64 encoded and\ncompressed using gzip, is written to the Windows registry using the following Powershell\ncommand:\n\n**Figure 6: Registry Creation**\n\nA second block of code present in the Powershell is called $stagerCode and is responsible\nfor extracting and decoding the code that was previously stored in the registry, then\nexecuting this code, first checking for the presence of the mutex '1823821749'. If this mutex\ndoes not exist, execution continues.\n\n**Figure 7: Mutex Check and Execution**\n\nThe malware then attempts to write the contents of $stagerCode along with the appropriate\nPowerShell command to execute it to the following registry locations, creating a new registry\nkey called \"IE\"\n\n\n-----\n\nHKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\nHKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\nHKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServices\nHKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\nHKEY_USERS\\.Default\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\nHKLM:\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\nHKLM:\\System\\CurrentControlSet\\Services\\VxD\nHKCR:\\vbsfile\\shell\\open\\command\n\n**Figure 8: Registry Activity**\n\nThe malware also creates a new scheduled task called \"IE\" that is responsible for executing\n$stagerCode each time the system boots, using a random startup delay period.\n\n**Figure 9: Scheduled Task Creation**\n\nThe malware then queries the system to determine the characteristics of the environment in\nwhich it is operating to determine how to proceed. It specifically checks the version of\n\n\n-----\n\nPowershell that is installed on the system. If the system is running a Powershell version later\nthan Powershell 2.0, the malware will write the contents of $ServiceCode to an Alternate\nData Stream (ADS) of the the following file location:\n\n_%PROGRAMDATA%\\Windows:kernel32.dll_\n\nThe malware then checks to determine the privilege level of the user that was infected. If the\nuser has administrative privileges on the infected system, it will set up a WMI event\nconsumer and filter as an additional WMI-based persistence mechanism. The filter name is\n\"kernel32_filter\" and the consumer name is \"kernel32_consumer\". The Powershell code used\nfor the performance of these tasks is below:\n\n**Figure 10: ADS and WMI Persistence**\n\nOnce all of these tasks have completed, the malware then enters the next stage of the\ninfection process by executing $stagerCode directly using the IEX Powershell cmdlet.\n\nThis next stage of the malware infection was heavily obfuscated with both variables and\nfunction names obscured. Most of the strings within this code were also base64 encoded.\nThe code associated with this stage starts by defining an array containing a list of domains\nthat will be used for subsequent Command and Control (C2) communications. A list of the\ndomains in this array is included in the Indicators of Compromise section of this blog.\n\nThe malware also obtains the serial number of the system from the BIOS. It calculates the\nMD5 hash of the serial number and returns the first ten bytes.\n\n**_Example S/N: VMware-56 4d 64 66 d0 7d f4 26-2c ad a5 8b f8 51 26 f8_**\n**_Resulting Value: EFA29DD310_**\n\n\n-----\n\nThe malware then sets a counter value to zero. The aforementioned hash value, the\nhardcoded string \"stage\", the value of the counter, and a randomly selected domain from the\narray are then combined to create the initial hostname that will be used by the malware to\nstart making DNS requests.\n\n**_Example Hostname: EFA29DD310.stage.0.ns0.pw_**\n\nAt this point the malware enters a loop which will continue until it receives an A record lookup\nresult of 0.0.0.0 or any lookup fails entirely. The A record result represents a checksum\nvalue, which will be explained below. The IPv4 value returned by the DNS server in response\nto the A record request is then converted to an integer, then a binary number.\n\n**_Example IP: 107.50.99.116_**\n**_Integer Value: 1798464372_**\n**_Binary: 1101011001100100110001101110100_**\n\nThe same generated hostname is then used by the malware to make a TXT record request.\nThe result of the TXT record query is then used to calculate an MD5 hash and the first eight\nbytes of the MD5 hash are then run through a checksum algorithm that returns an integer\nvalue which is converted into a binary number.\n\n**_Example TXT Query Result:_**\n```\nH4sIAIia3VkC/909a1fbSJafyTn5DxXhbkvYEpg8pgcjpnnkwXQgLNCTnnG8HdkqQGBLjiRDCPE5+x/2H+4v2X\n\n```\n**MD5: 432B4077F72EE96CA70B57F10B68F35E**\n**Selected Bytes: 432B4077**\n**Checksum: 1126908023**\n**Binary: 1000011001010110100000001110111**\n\nOnce the malware has both the binary values from the A record response and the above\nchecksum calculation, they are compared. If the A record response and the TXT record\nresponse match, the result of the TXT record query response is appended to the end of a\nfinal resulting string, a new domain is then randomly selected from the array and the counter\nvalue previously mentioned, and included in the hostname used for queries, is incremented\nby one. If they don't match, the queries continue in kind until they do.\n\nThis process continues until the result of the A record lookup is 0.0.0.0, which indicates a\ncompletion of the code collection via DNS, at which time the resulting string is returned for\nfurther processing. This result string is then decoded using Base64 and decompressed using\n\n\n-----\n\ngzip. It is then passed to the Powershell IEX cmdlet to execute the code that was retrieved\nusing DNS.\n\nDuring analysis of this specific attack, we were unable to obtain this next stage of Powershell\ncode from the C2 servers. Given the targeted nature of this attack it is likely that the attacker\nis restricting these communications in an attempt to evade analysis by information security\n[companies and researchers. It's been reported that the stage 4 payload is documented here.](https://wraithhacker.com/2017/10/11/more-info-on-evolved-dnsmessenger/)\n\n## Conclusion\n\nThis attack shows the level of sophistication that is associated with threats facing\norganizations today. Attackers often employ multiple layers of obfuscation in an attempt to\nmake analysis more difficult, evade detection and prevention capabilities, and continue to\noperate under the radar by limiting their attacks to only the organizations that they are\ntargeting. It is also important for organizations to be aware of some of the more interesting\ntechniques that malware is using to execute malicious code on systems and gain persistence\non systems once they are infected. In this particular case, the malware featured the\ncapability to leverage WMI, ADS, scheduled tasks, as well as registry keys to obtain\npersistence. The use of DNS as a conveyance for later stage code and C2 communications\nis also becoming more and more commonplace. Talos continues to monitor the threat\nlandscape for unique and targeted attacks such as this one so that customers remain\nprotected as attackers change the techniques they use to perform their malicious activities.\n\n## Coverage\n\nAdditional ways our customers can detect and block this threat are listed below.\n\n[Advanced Malware Protection (AMP) is ideally suited to prevent the execution of the](https://www.cisco.com/c/en/us/products/security/advanced-malware-protection)\nmalware used by these threat actors.\n\n\n-----\n\n[CWS or WSA web scanning prevents access to malicious websites and detects malware](https://www.cisco.com/c/en/us/products/security/cloud-web-security/index.html)\nused in these attacks.\n\n[Email Security can block malicious emails sent by threat actors as part of their campaign.](https://www.cisco.com/c/en/us/products/security/email-security-appliance/index.html)\n\n[Network Security appliances such asNGFW,NGIPS, andMeraki MX can detect malicious](https://www.cisco.com/c/en/us/products/security/firewalls/index.html)\nactivity associated with this threat.\n\n[AMP Threat Grid helps identify malicious binaries and build protection into all Cisco Security](https://www.cisco.com/c/en/us/solutions/enterprise-networks/amp-threat-grid/index.html)\nproducts.\n\n[Umbrella, our secure internet gateway (SIG), blocks users from connecting to malicious](https://umbrella.cisco.com/)\ndomains, IPs, and URLs, whether users are on or off the corporate network.\n\nOpen Source Snort Subscriber Rule Set customers can stay up to date by downloading the\n[latest rule pack available for purchase on Snort.org.](https://www.snort.org/products)\n\n## Indicators of Compromise (IOCs)\n\nThe following Indicators of Compromise (IOCs) are associated with the attack described in\nthis blog post.\n\n### Malicious Word Documents:\n\n1a1294fce91af3f7e7691f8307d07aebd4636402e4e6a244faac5ac9b36f8428\n\nbf38288956449bb120bae525b6632f0294d25593da8938bbe79849d6defed5cb\n\n### Stage 2 PowerShell\n\n8c5209671c9d4f0928f1ae253c40ce7515d220186bb4a97cbaf6c25bd3be53cf\n\nec3aee4e579e0d1db922252f9a15f1208c4f9ac03bd996af4884725a96a3fdf6\n\n### Domains:\n\ntrt[.]doe[.]louisiana[.]gov\n\nns0[.]pw\n\nns0[.]site\n\nns0[.]space\n\nns0[.]website\n\nns1[.]press\n\nns1[.]website\n\nns2[.]press\n\nns3[.]site\n\nns3[.]space\n\n\n-----\n\nns4[.]site\nns4[.]space\nns5[.]biz\nns5[.]online\nns5[.]pw\n\n### IP Addresses:\n\n206[.]218[.]181[.]46\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-10-11 - Spoofed SEC Emails Distribute Evolved DNSMessenger.pdf"
    ],
    "report_names": [
        "2017-10-11 - Spoofed SEC Emails Distribute Evolved DNSMessenger.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536161,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1653688671,
    "ts_modification_date": 1653688671,
    "files": {
        "pdf": "https://archive.orkl.eu/e12aed3f25dc271c59067b144ac64a92588ccdaa.pdf",
        "text": "https://archive.orkl.eu/e12aed3f25dc271c59067b144ac64a92588ccdaa.txt",
        "img": "https://archive.orkl.eu/e12aed3f25dc271c59067b144ac64a92588ccdaa.jpg"
    }
}