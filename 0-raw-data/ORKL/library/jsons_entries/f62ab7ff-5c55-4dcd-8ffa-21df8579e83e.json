{
    "id": "f62ab7ff-5c55-4dcd-8ffa-21df8579e83e",
    "created_at": "2023-01-12T15:01:58.066397Z",
    "updated_at": "2025-03-27T02:06:12.128878Z",
    "deleted_at": null,
    "sha1_hash": "f6cca978efbc48359143fcb35b280bfc0a2200d3",
    "title": "2022-07-13 - Uncovering a macOS App Sandbox escape vulnerability- A deep dive into CVE-2022-26706",
    "authors": "",
    "file_creation_date": "2022-09-01T10:10:46Z",
    "file_modification_date": "2022-09-01T10:10:46Z",
    "file_size": 914761,
    "plain_text": "# Uncovering a macOS App Sandbox escape vulnerability: A deep dive into CVE-2022-26706\n\n**microsoft.com/security/blog/2022/07/13/uncovering-a-macos-app-sandbox-escape-vulnerability-a-deep-dive-into-cve-**\n2022-26706/\n\nJuly 13, 2022\n\nMicrosoft uncovered a vulnerability in macOS that could allow specially crafted codes to\nescape the App Sandbox and run unrestricted on the system. We shared these findings with\n[Apple through Coordinated Vulnerability Disclosure (CVD) via](https://www.microsoft.com/en-us/msrc/cvd?rtc=1) Microsoft Security Vulnerability\nResearch (MSVR) in October 2021. A fix for this vulnerability, now identified as CVE-202226706, was included in the security updates released by Apple on May 16, 2022. Microsoft\nshares the vulnerability disclosure credit with another researcher, Arsenii Kostromin\n(0x3c3e), who discovered a similar technique independently.\n\nWe encourage macOS users to install these security updates as soon as possible. We also\nwant to thank the Apple product security team for their responsiveness in fixing this issue.\n\nThe App Sandbox is Apple’s access control technology that application developers must\nadopt to distribute their apps through the Mac App Store. Essentially, an app’s processes are\nenforced with customizable rules, such as the ability to read or write specific files. The App\nSandbox also restricts the processes’ access to system resources and user data to minimize\nthe impact or damage if the app becomes compromised. However, we found that specially\ncrafted codes could bypass these rules. An attacker could take advantage of this sandbox\nescape vulnerability to gain elevated privileges on the affected device or execute malicious\ncommands like installing additional payloads.\n\n\n-----\n\nWe found the vulnerability while researching potential ways to run and detect malicious\nmacros in Microsoft Office on macOS. For backward compatibility, Microsoft Word can read\nor write files with an “~$” prefix. Our findings revealed that it was possible to escape the\nsandbox by leveraging macOS’s Launch Services to run an open –stdin command on a\nspecially crafted Python file with the said prefix.\n\nOur research shows that even the built-in, baseline security features in macOS could still be\nbypassed, potentially compromising system and user data. Therefore, collaboration between\nvulnerability researchers, software vendors, and the larger security community remains\ncrucial to helping secure the overall user experience. This includes responsibly disclosing\nvulnerabilities to vendors.\n\nIn addition, insights from this case study not only enhance our protection technologies, such\nas [Microsoft Defender for Endpoint, but they also help strengthen the security strategies of](https://www.microsoft.com/security/business/threat-protection/endpoint-defender)\nsoftware vendors and the computing landscape at large. This blog post thus provides details\nof our research and overviews of similar sandbox escape vulnerabilities reported by other\nsecurity researchers that helped enrich our analysis.\n\n## How macOS App Sandbox works\n\nIn a nutshell, macOS apps can specify sandbox rules for the operating system to enforce on\nthemselves. The App Sandbox restricts system calls to an allowed subset, and the said\nsystem calls can be allowed or disallowed based on files, objects, and arguments. Simply\nput, the sandbox rules are a defense-in-depth mechanism that dictates the kind of operations\nan application can or can’t do, regardless of the type of user running it. Examples of such\noperations include:\n\nthe kind of files an application can or can’t read or write;\nwhether the application can access specific resources such as the camera or the\nmicrophone, and;\nwhether the application is allowed to perform inbound or outbound network\nconnections.\n\n\n-----\n\n[Figure 1. Illustration of a sandboxed app, from the App Sandbox documentation (photo](https://developer.apple.com/library/archive/documentation/Security/Conceptual/AppSandboxDesignGuide/AboutAppSandbox/AboutAppSandbox.html)\ncredit: Apple)\nTherefore, the App Sandbox is a useful tool for all macOS developers in providing baseline\nsecurity for their applications, especially for those that have large attack surfaces and run\nuser-provided code. One example of these applications is Microsoft Office.\n\n### Sandboxing Microsoft Office in macOS\n\nAttackers have targeted Microsoft Office in their attempts to gain a foothold on devices and\nnetworks. One of their techniques is abusing Office macros, which they use in social\nengineering attacks to trick users into downloading malware and other payloads.\n\nOn Windows systems, [Microsoft Defender Application Guard for Office helps secure](https://docs.microsoft.com/microsoft-365/security/office-365-security/install-app-guard?view=o365-worldwide)\nMicrosoft Office against such macro abuse by isolating the host environment using Hyper-V.\nWith this feature enabled, an attacker must first be equipped with a Hyper-V guest-to-host\nvulnerability to affect the host system—a very high bar compared to simply running a macro.\nWithout a similar isolation technology and default setting on macOS, Office must rely on the\noperating system’s existing mitigation strategies. Currently, the most promising technology is\nthe macOS App Sandbox.\n\nViewing the Microsoft sandbox rules is quite straightforward with the codesign utility. Figure 2\nbelow shows the truncated sandbox rules for Microsoft Word:\n\n\n-----\n\nFigure 2. Viewing the Microsoft Word sandbox rules with the codesign utility\nOne of the rules dictates the kind of files the application is allowed to read or write. As seen\nin the screenshot of the syntax below, Word is allowed to read or write files with filenames\nthat start with the “~$” prefix. The reason for this rule is rooted in the way Office works\ninternally and remains intact for backward compatibility.\n\nFigure 3. File read and write sandbox rule for Microsoft Word\nDespite the security restrictions imposed by the App Sandbox’s rules on applications, it’s\npossible for attackers to bypass the said rules and let malicious codes “escape” the sandbox\nand execute arbitrary commands on an affected device. These codes could be hidden in a\n\n\n-----\n\nspecially crafted Word macro, which, as mentioned earlier, is one of the attackers preferred\nentry points.\n\n### Previously reported Office-specific sandbox escape vulnerability\n\n[For example, in 2018, MDSec reported a vulnerability in Microsoft Office on macOS that](https://www.mdsec.co.uk/2018/08/escaping-the-sandbox-microsoft-office-on-macos/)\ncould allow an attacker to bypass the App Sandbox. As explained in their blog post, MDSec’s\nproof-of-concept (POC) exploit took advantage of the fact that Word could drop files with\narbitrary contents to arbitrary directories (even after passing traditional permission checks),\nas long as these files’ filenames began with a “~$” prefix. This bypass was relatively\nstraightforward: have a specially crafted macro drop a .plist file in the user’s LaunchAgents\ndirectory.\n\n[The LaunchAgents directory is a well-known persistence mechanism in macOS. PLIST files](https://attack.mitre.org/techniques/T1543/001/)\nthat adhere to a specific structure describe (that is, contain the metadata of) macOS launch\n_agents initiated by the launchd process when a user signs in. Since these launch agents will_\nbe the children of launchd, they won’t inherit the sandbox rules enforced onto Word, and\ntherefore will be out of the Office sandbox.\n\nShortly after the above vulnerability was reported, Microsoft deployed a fix that denied file\nwrites to the LaunchAgents directory and other folders with similar implications. The said\ndisclosure also prompted us to look into different possible sandbox escapes in Microsoft\nWord and other applications.\n\n## Exploring Launch Services as means of escaping the sandbox\n\n[In 2020, several blog posts described a generic sandbox escape vulnerability in macOS’s](https://desi-jarvis.medium.com/office365-macos-sandbox-escape-fcce4fa4123c)\n_/usr/bin/open utility, a command commonly used to launch files, folders, and applications just_\nas if a user double-clicked them. While open is a handy command, it doesn’t create child\nprocesses on its own. Instead, it performs an inter-process communication (IPC) with the\nmacOS Launch Services, whose logic is implemented in the context of the launchd process.\nLaunch Services then performs the heavy lifting by resolving the handler and launching the\nright app. Since launchd creates the process, it’s not restricted by the caller’s sandbox,\nsimilar to how MDSec’s POC exploit worked in 2018.\n\nHowever, using open for sandbox escape purposes isn’t trivial because the destination app\nmust be registered within Launch Services. This means that, for example, one couldn’t run\nfiles like osascript outside the sandbox using open. Our internal offensive security team\ntherefore decided to reassess the open utility for sandbox escape purposes and use it in a\nlarger end-to-end attack simulation.\n\nOur obvious first attempt in creating a POC exploit was to create a macro that launches a\nshell script with the Terminal app. Surprisingly, the POC didn’t work because files dropped\nfrom within the sandboxed Word app were automatically given the extended attribute\n\n\n-----\n\n_com.apple.quarantine (the same one used by Safari to keep track of internet-downloaded_\nfiles, as well as by [Gatekeeper to block malicious files from executing), and Terminal simply](https://support.apple.com/en-us/HT202491)\nrefused to run files with that attribute. We also tried using Python scripts, but the Python app\nhad similar issues running files having the said attribute.\n\nOur second attempt was to use application extensibility features. For example, Terminal\nwould run the default macOS shell (zsh), which would then run arbitrary commands from files\nlike ~/.zshenv before running its own command line. This meant that dropping a .zshenv file\nin the user’s home directory and launching the Terminal app would cause the sandbox\nescape. However, due to Word’s sandbox rules, dropping a .zshenv file wasn’t\nstraightforward, as the rules only allowed an application to write to files that begin with the\n“~$” prefix.\n\nHowever, there is an interesting way of writing such a file indirectly. macOS was shipped with\nan application called Archive Utility responsible of extracting archive files (such as ZIP files).\nSuch archives were extracted without any user interaction, and the files inside an archive\nwere extracted in the same directory as the archive itself. Therefore, our second POC\nworked as follows:\n\n1. Prepare the payload by creating a .zshenv file with arbitrary commands and placing it\n\nin a ZIPfile. Encode the ZIPfile contents in a Word macro and drop those contents into\na file “~$exploit.zip” in the user’s home directory.\n2. Launch Archive Utility with the open command on the “~$exploit.zip” file. Archive Utility\n\nran outside the sandbox (since it’s the child process of /usr/bin/open) and was\ntherefore permitted to create files with arbitrary names. By default, Archive Utility\nextracted the files next to the archive itself—in our case, the user’s home directory.\nTherefore, this step successfully created a .zshenv file with arbitrary contents in the\nuser’s home directory.\n3. Launch the Terminal app with the open command. Since Terminal hosted zsh and zsh\n\nran commands from the .zshenv file, the said file could escape the Word sandbox\nsuccessfully.\n\n\n-----\n\nFigure 4. Preparing a Word macro with our sandbox escape for an internal Red Team\noperation\n\n### Perception Point’s CVE-2021-30864\n\n[In October 2021, Perception Point published a blog post that discussed a similar finding (and](https://perception-point.io/a-technical-analysis-of-cve-2021-30864-bypassing-app-sandbox-restrictions/)\nmore elegant, in our opinion). In the said post, Perception Point released details about their\n[sandbox escape (now identified as CVE-2021-30864), which used the following facts:](https://www.cve.org/CVERecord?id=CVE-2021-30864)\n\n1. Every sandboxed process had its own container directory that’s used as a “scratch\n\nspace.” The sandboxed process could write arbitrary files, including arbitrary filenames,\nto that directory unrestricted.\n2. The open command had an interesting –env option that could set or override arbitrary\n\nenvironment variables for the launched app.\n\nTherefore, Perception Point’s POC exploit was cleverly simple:\n\n1. Drop a .zshenv file in the container directory. This was allowed because sandbox rules\n\nweren’t enforced on that directory.\n2. Launch Terminal with the open command but use the –env option to override the\n\n_HOME environment variable to point to the container directory. This made zsh consider_\nthe user’s home directory to be the container directory, and run commands from the\nplanted .zshenv file.\n\n\n-----\n\nApple has since patched the vulnerability Perception Point reported in the latest version of\nmacOS, Monterey. While we could still create the “~$exploit.zip” file in the user’s home\ndirectory, using open to launch the Archive Utility on the ZIP file now resulted in it being\nextracted to the Downloads folder. While this is an interesting behavior, we could no longer\nuse it for sandbox escape purposes.\n\n## Final exploit attempt: Revisiting the ‘open’ command\n\nAfter discovering that Apple has fixed both variants that abuse .zshenv,, we decided to\nexamine all the command line options of the open command. Soon after, we came across\nthe following:\n\nFigure 5. The –stdin option in the open utility as presented by its manual entry\nAs mentioned earlier, we couldn’t run Python with a dropped .py file since Python refuses to\nrun files with the “com.apple.quarantine” extended attribute. We also considered abusing the\n_PYTHONSTARTUP environment variable, but Apple’s fix to CVE-2021-30864 apparently_\nprevented that option, too. However, –stdin bypassed the “com.apple.quarantine” extended\nattribute restriction, as there was no way for Python to know that the contents from its\nstandard input originated from a quarantined file.\n\nOur POC exploit thus became simply as follows:\n\n1. Drop a “~$exploit.py” file with arbitrary Python commands.\n2. Run open –stdin=’~$exploit.py’ -a Python, which runs the Python app with our dropped\n\nfile serving as its standard input. Python happily runs our code, and since it’s a child\nprocess of launchd, it isn’t bound to Word’s sandbox rules.\n\n\n-----\n\nFigure 6. Sample minimal POC exploit code\nWe also came up with a version that’s short enough to be a Twitter post:\n\nFigure 7. “Tweetable” POC exploit\n\n## Detecting App Sandbox escapes with Microsoft Defender for Endpoint\n\nSince our initial discovery of leveraging Launch Services in macOS for generic sandbox\nescapes, we have been using our POC exploits in Red Team operations to emulate end-to[end attacks against Microsoft Defender for Endpoint, improve its capabilities, and challenge](https://www.microsoft.com/security/business/threat-protection/endpoint-defender)\nour detections. Shortly after our Red Team used our first POC exploit, our Blue Team\nmembers used it to train artificial intelligence (AI) models to detect our exploit not only in\nMicrosoft Office but also on any app used for a similar Launch Services-based sandbox\nescape.\n\nAfter we learned of Perception Point’s technique and created our own new exploit technique\n(the Python POC), our Red Team saw another opportunity to fully test our own detection\ndurability. Indeed, the same set of detection rules that handled our first sandbox escape\nvulnerability still turned out to be durable—even before the vulnerability related to our second\nPOC exploit was patched.\n\n\n-----\n\nFigure 8. Microsoft Defender for Endpoint detecting Office sandbox escape\nFor Defender for Endpoint customers, such detection durability feeds into the product’s\n[threat and vulnerability management capabilities, which allows them to quickly discover,](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/next-gen-threat-and-vuln-mgt?view=o365-worldwide)\nprioritize, and remediate misconfigurations and vulnerabilities—including those affecting nonWindows devices—through a unified security console.\n\nLearn how Microsoft Defender for Endpoint delivers a complete endpoint security solution\nacross all platforms.\n\n**_Jonathan Bar Or_**\n\n_Microsoft 365 Defender Research Team_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-07-13 - Uncovering a macOS App Sandbox escape vulnerability- A deep dive into CVE-2022-26706.pdf"
    ],
    "report_names": [
        "2022-07-13 - Uncovering a macOS App Sandbox escape vulnerability- A deep dive into CVE-2022-26706.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535718,
    "ts_updated_at": 1743041172,
    "ts_creation_date": 1662027046,
    "ts_modification_date": 1662027046,
    "files": {
        "pdf": "https://archive.orkl.eu/f6cca978efbc48359143fcb35b280bfc0a2200d3.pdf",
        "text": "https://archive.orkl.eu/f6cca978efbc48359143fcb35b280bfc0a2200d3.txt",
        "img": "https://archive.orkl.eu/f6cca978efbc48359143fcb35b280bfc0a2200d3.jpg"
    }
}