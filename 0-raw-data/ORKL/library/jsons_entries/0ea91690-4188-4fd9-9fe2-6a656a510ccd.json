{
    "id": "0ea91690-4188-4fd9-9fe2-6a656a510ccd",
    "created_at": "2022-10-25T16:48:24.875709Z",
    "updated_at": "2025-03-27T02:05:26.512829Z",
    "deleted_at": null,
    "sha1_hash": "060acb843997b3d26eb38624156bb51adcc57c45",
    "title": "Microsoft Word - SunCryptRansomware_Whitepaper - Vlad Pasca.docx",
    "authors": "",
    "file_creation_date": "2022-04-12T16:45:45Z",
    "file_modification_date": "2022-04-12T12:47:11Z",
    "file_size": 16532900,
    "plain_text": "# A Detailed Analysis of The SunCrypt Ransomware\n\n\n**SecurityScorecard.com**\n\ninfo@securityscorecard.com\n\n©2022 SecurityScorecard Inc.\n\n214 West 29[th] St, 5[th] Floor\n\nNew York, NY 10001\n\n1.800.682.1707\n\n\n-----\n\n## Table of Contents\n\n### Executive Summary 3\n\n Analysis and Findings 3\n\n Delete Volume Shadow Copies 9\n\n Thread activity – sub_1235120 function 13\n\n Thread activity – sub_12115D0 function 19\n\n Thread activity – sub_12363D0 function 20\n\n Indicators of Compromise 24\n\n**it** **d** | 2\n\n\n-----\n\n## Executive Summary \n\nSunCrypt ransomware is a less sophisticated malware that has impacted multiple companies\nsince 2019. The malware can run with one of the following parameters: \"-noshares\", \"-nomutex\",\n\"-noreport\", \"-noservices\", \"-vm\", \"-path\", \"-justcrypt\", and \"-keep_exe\". The ransomware kills a list\nof targeted processes and deletes all Volume Shadow Copies using COM objects.\n\nThe encryption is done using multithreading with I/O completion ports, which is a common\ntechnique used by most current ransomware families. SunCrypt uses a combination of\nCurve25519 and ChaCha20 algorithms during the encryption routine. The binary deletes the\nWindows event logs via two different methods and performs self-deletion at the end of the\nexecution.\n\n## Analysis and Findings\n\nSHA256: 759f2b24be12e208903b00f9719db71a332ddf8252986c26afbcda9f32623bc4\n\nThe malware forces the system not to display the critical-error-handler message box using\nSetErrorMode (0x1 = SEM_FAILCRITICALERRORS):\n\nFigure 1\n\nThe binary loads multiple DLLs into the address space of the process by calling the LoadLibraryA\nAPI. The list of DLLs contains \"ntdll.dll\", \"advapi32.dll\", \"kernel32.dll\", and \"rstrtmgr.dll\". An example\nof such a function call is displayed below:\n\nFigure 2\n\nGetProcAddress is utilized to retrieve the address of multiple exported functions: \"strncpy\",\n\"_atoi64\", \"atoi\", \"isxdigit\", \"isdigit\", \"memset\", \"memcpy\", \"NtSetInformationFile\",\n\"SystemFunction036\", \"SetVolumeMountPointW\", \"RmStartSession\", \"RmRegisterResources\",\n\"RmGetList\", and \"RmEndSession\" (see figure 3).\n\nFigure 3\n\nSunCrypt can run with the following parameters \"-noshares\", \"-nomutex\", \"-noreport\", \"noservices\", \"-vm\", \"-path\", \"-justcrypt\", \"-keep_exe\". We’ll explain the purpose of each parameter\nin the upcoming paragraphs:\n\n**it** **d** | 3\n\n\n-----\n\nFigure 4\n\nThe ransomware uses the FNV hash function in order to compute 4-byte hash values that are\ncompared with the hard-coded ones corresponding to different parameters. The\nimplementation of the hash function can be spotted through the identification of the FNV prime\n(0x01000193):\n\nFigure 5\n\nThe GetCommandLineW routine is used to extract the command-line string for the current\nprocess:\n\n**it** **d** | 4\n\n\n-----\n\nFigure 6\n\nThe malicious process retrieves an array of pointers to the command line arguments, along with\na count of the arguments via a function call to CommandLineToArgvW:\n\nFigure 7\n\nOpenProcessToken is utilized to open the access token associated with the current process (0x20\n= TOKEN_ADJUST_PRIVILEGES):\n\nFigure 8\n\nThe malware performs multiple calls to LookupPrivilegeValueA in order to extract the locally\nunique identifier (LUID) for the following privileges: \"SeTakeOwnershipPrivilege\",\n\"SeBackupPrivilege\", \"SeSecurityPrivilege\", \"SeRestorePrivilege\", \"SeDebugPrivilege\",\n\"SeImpersonatePrivilege\", and \"SeIncreaseBasePriorityPrivilege\". Figure 9 displays an example of\na function call:\n\nFigure 9\n\nThe malicious executable enables the above privileges using the AdjustTokenPrivileges function:\n\nFigure 10\n\nSunCrypt retrieves information about the current system via a function call to GetSystemInfo:\n\n**it** **d** | 5\n\n\n-----\n\nFigure 11\n\nThe GetModuleHandleA routine is utilized to extract a module handle for \"ntdll.dll\":\n\nFigure 12\n\nThe malware retrieves version information about the operating system by calling the\nRtlGetVersion routine:\n\nFigure 13\n\nThe binary creates a mutex called\n\"0c91c96fd7124f21a0193cf842e3495f6daf84a394f44013e92a87ad9d2ef4a0ceec9dd2e2eca22e\" in\norder to ensure that only one copy of the executable is running at a single time:\n\nFigure 14\n\nThe executable takes a snapshot of all processes in the system using CreateToolhelp32Snapshot\n(0x2 = TH32CS_SNAPPROCESS):\n\nFigure 15\n\nThe processes are enumerated using the Process32First and Process32Next APIs:\n\n**it** **d** | 6\n\n\n-----\n\nFigure 16\n\nFigure 17\n\nSunCrypt targets a list of processes that will be killed:\n\n  - \"ocssd\" \"dbsnmp\" \"synctime\" \"agntsvc\" \"isqlplussvc\" \"xfssvccon\" \"mydesktopservice\"\n\"ocautoupds\" \"encsvc\" \"firefox\" \"tbirdconfig\"\n\n  - \"mydesktopqos\" \"ocomm\" \"dbeng50\" \"sqbcoreservice\" \"excel\" \"infopath\" \"msaccess\"\n\"mspub\" \"onenote\" \"outlook\" \"powerpnt\" \"steam\"\n\n  - \"thebat\" \"thunderbird\" \"visio\" \"winword\" \"wordpad\" \"ssms\" \"notepad\" \"fdhost\"\n\"fdlauncher\" \"launchpad\" \"sqlceip\" \"sqlwriter\"\n\nThe comparison between a process name and one of the above processes is employed using\nStrStrIA:\n\nFigure 18\n\nThe ransomware opens a targeted process via a function call to OpenProcess (0x1FFFFF =\n**PROCESS_ALL_ACCESS):**\n\nFigure 19\n\nThe TerminateProcess routine is used to kill a targeted process:\n\nFigure 20\n\nThe malicious file tries to locate the \"winlogon.exe\" process:\n\n**it** **d** | 7\n\n\n-----\n\nFigure 21\n\nOpenProcess is used to retrieve a handle to the above process (0x400 =\n**PROCESS_QUERY_INFORMATION):**\n\nFigure 22\n\nThe executable opens the access token associated with “winlogon.exe” (0xF =\n**TOKEN_ASSIGN_PRIMARY | TOKEN_DUPLICATE | TOKEN_IMPERSONATE | TOKEN_QUERY):**\n\nFigure 23\n\nThe DuplicateTokenEx API is used to create a new access token that duplicates the token\nextracted above (0x2000000 = **MAXIMUM_ALLOWED, 0x2 =** **SecurityIdentification, 0x2 =**\n**TokenImpersonation):**\n\nFigure 24\n\nThe process assigns the impersonation token to the calling thread using SetThreadToken:\n\nFigure 25\n\nSunCrypt sets the highest possible priority for the current process (0x100 =\n**REALTIME_PRIORITY_CLASS):**\n\n**it** **d** | 8\n\n\n-----\n\nFigure 26\n\nThe process I/O priority is set to 3 (High) via a function call to ZwSetInformationProcess (0x21 =\n**ProcessIoPriority):**\n\nFigure 27\n\nA new thread is created by calling the CreateThread API:\n\nFigure 28\n\nThere is a function call to RevertToSelf that terminates the impersonation.\n\n## Delete Volume Shadow Copies\n\nCoInitialize is used to initialize the COM library on the current thread:\n\nFigure 29\n\nThe ransomware creates an IWbemContext Interface by calling the CoCreateInstance API with\nthe {674B6698-EE92-11D0-AD71-00C04FD8FDFF} parameter:\n\nFigure 30\n\n**it** **d** | 9\n\n\n-----\n\nThe IsWow64Process routine is utilized to determine whether the current process is running on\na 64-bit environment:\n\nFigure 31\n\nThe malware creates an IWbemLocator object with the CLSID {4590f811-1d3a-11d0-891f00aa004b2e24}”:\n\nFigure 32\n\nThe malicious executable calls the ConnectServer function for connecting to the local\n“ROOT\\CIMV2” namespace:\n\nFigure 33\n\nThere is a function call to CoSetProxyBlanket that sets the authentication information used to\nmake calls on a proxy (0xA = RPC_C_AUTHN_WINNT, 0x3 = RPC_C_AUTHN_LEVEL_CALL, 0x3 =\n**RPC_C_IMP_LEVEL_IMPERSONATE):**\n\nFigure 34\n\nThe malware retrieves an enumerator of all shadow copies using the following WQL query\n“SELECT * FROM Win32_ShadowCopy”:\n\n**it** **d** | 10\n\n\n-----\n\nFigure 35\n\nThe id property value of a specific shadow copy is extracted using the IwbemClassObject::Get\nmethod:\n\nFigure 36\n\nThe Volume Shadow Copies are deleted using the DeleteInstance function:\n\nFigure 37\n\nSunCrypt utilizes multithreading with I/O completion ports when encrypting files. The main\npurpose is to establish a communication between the main thread and the worker threads that\nare responsible for files encryption.\n\nThe ransomware creates an I/O completion port that is not yet associated with a file handle using\nCreateIoCompletionPort:\n\nFigure 38\n\nThe binary creates 4 (2 * number of cores) threads that will handle the files encryption (the IOCP\nhandle is passed as a parameter):\n\n**it** **d** | 11\n\n\n-----\n\nFigure 39\n\nThe GetLogicalDrives API is used to extract a bitmask representing the available disk drives:\n\nFigure 40\n\nThe drive type is retrieved via a call to GetDriveTypeW. It expects a return value that is less or\nequal to 5:\n\nFigure 41\n\nSunCrypt verifies whether the Windows Boot Manager (bootmgr) file is present in any of the\nextracted drives using the GetFileAttributesW routine:\n\nFigure 42\n\nFor example, the above file exists in the C drive, and this one will not be encrypted by the malware.\nThis operation is unusual for most of the ransomware families, because other families choose to\nwhitelist specific directories (“Program Files”) rather than avoiding to encrypt the drive\ncompletely.\n\nThe malware verifies the presence of a boot file called bootmgr.efi:\n\nFigure 43\n\nThe CreateThread function is used to create a new thread that will traverse the targeted drive\n(see figure 44). It’s important to mention that there is no checking to determine if the drive is\n\n**it** **d** | 12\n\n\n-----\n\nempty or not (for example, the D drive might correspond to CD/DVD drive).\n\nFigure 44\n\n## Thread activity – sub_1235120 function\n\nThere is a comparison between the drive name and the \"\\\\AppData\" or \"\\\\Application Data\"\nstrings:\n\nFigure 45\n\nSetFileAttributesW is utilized to set an attribute for the drive (0x80 = FILE_ATTRIBUTE_NORMAL):\n\nFigure 46\n\nThe ransomware enumerates the above drive using FindFirstFileW (figure 47); however, it\ncorresponds to the DVD drive and it’s empty. This execution flow will be explained in detail when\nencrypting network shares.\n\nFigure 47\n\nWe continue with the analysis of the main thread.\n\nThe malware starts to enumerate the network resources via a function call to WNetOpenEnumW\n(0x2 = RESOURCE_GLOBALNET, 0x0 = RESOURCETYPE_ANY, 0x13 = RESOURCEUSAGE_ALL):\n\n**it** **d** | 13\n\n\n-----\n\nFigure 48\n\nThe enumeration of network resources continues by calling the WNetEnumResourceW API:\n\nFigure 49\n\nThe binary makes a connection to a network share using the WNetAddConnection2W routine:\n\nFigure 50\n\nSunCrypt starts enumerating a network share using FindFirstFileW:\n\nFigure 51\n\nA file extension is extracted by calling the PathFindExtensionW function:\n\nFigure 52\n\nThe files that have the following extensions will be skipped: \".exe\", \".dll\", \".ocx\", and \".sys\". An\nexample of such comparison is displayed in figure 53:\n\n**it** **d** | 14\n\n\n-----\n\nFigure 53\n\nThe following directories/files will not be encrypted: \"windows\", \"$Recycle.bin\", \"System Volume\nInformation\", \"ntldr\", \"ntdetect.com\", \"bootfont.bin\", \"boot.ini\", and\n\"YOUR_FILES_ARE_ENCRYPTED.HTML\". An example of such comparison is displayed below:\n\nFigure 54\n\nThe file enumeration continues by calling the FindNextFileW routine:\n\nFigure 55\n\nSunCrypt generates 32 random bytes by calling the SystemFunction036 function:\n\nFigure 56\n\nThis buffer represents a 32-byte secret key for Curve25519 (ECC algorithm). The ransomware\njumps to the curve function that is used to compute the session public key (observe a base point\nof 09 followed by all zeros):\n\nFigure 57\n\nThe capa tool identifies the implementation of the Curve25519 algorithm (see figure 58). The\nsession public key computed above is shown in figure 59.\n\n**it** **d** | 15\n\n\n-----\n\nFigure 58\n\nFigure 59\n\nThe session public key is appended to the file chosen for encryption:\n\nFigure 60\n\nThe ransomware opens the newly modified file using CreateFileW (0xc0010000 =\n**GENERIC_READ | GENERIC_WRITE | DELETE, 0x1 = FILE_SHARE_READ, 0x3 = OPEN_EXISTING,**\n0x50000000 = FILE_FLAG_OVERLAPPED | FILE_FLAG_RANDOM_ACCESS):\n\nFigure 61\n\n**it** **d** | 16\n\n\n-----\n\nSunCrypt comes with a hard coded Curve25519 public key:\n\nFigure 62\n\nThe ransomware computes a shared secret between the above key and the generated session\npublic key using the Curve25519 algorithm:\n\nFigure 63\n\nThe shared secret is a 32-byte buffer that will be used to encrypt the targeted file using the\nChaCha algorithm, as we will describe later on:\n\nFigure 64\n\nThe binary adds the “expand 32-byte k” string to the above buffer, which suggests that the\nencryption algorithm will be Salsa20 or ChaCha:\n\nFigure 65\n\nSunCrypt associates the IOCP created earlier with the targeted file handle using the\nCreateIoCompletionPort API:\n\nFigure 66\n\nPostQueuedCompletionStatus is utilized to send an I/O completion packet to the IOCP:\n\n**it** **d** | 17\n\n\n-----\n\nFigure 67\n\nThe ransomware creates a ransom note called \"YOUR_FILES_ARE_ENCRYPTED.HTML\" in every\ndirectory (0x40000000 = GENERIC_WRITE, 0x1 = FILE_SHARE_READ, 0x1 = CREATE_NEW):\n\nFigure 68\n\nThe ransom note is displayed below:\n\nFigure 69\n\n**it** **d** | 18\n\n\n-----\n\n## Thread activity – sub_12115D0 function\n\nThe malicious process retrieves a handle that can be used to enumerate the list of channels that\nare registered on the local computer via a call to EvtOpenChannelEnum:\n\nFigure 70\n\nThe enumeration starts by extracting a channel name from the enumerator using\nEvtNextChannelPath:\n\nFigure 71\n\nThe purpose of the malware is to clear the event logs using the EvtClearLog routine:\n\nFigure 72\n\nFigure 73\n\nThe channels enumeration continues using the same API as above:\n\n**it** **d** | 19\n\n\n-----\n\nFigure 74\n\nThe ransomware opens the \"SYSTEM\\CurrentControlSet\\Services\\EventLog\" registry key using\nthe RegOpenKeyA function (0x80000002 = HKEY_LOCAL_MACHINE):\n\nFigure 75\n\nThe file enumerates the subkeys of the above registry key using RegEnumKeyA:\n\nFigure 76\n\nSunCrypt opens a handle to the “Application” event log via a function call to OpenEventLogA:\n\nFigure 77\n\nThe malware clears the “Application” event log using the ClearEventLogA API. This is the 2nd\nmethod employed by SunCrypt to clear all event logs:\n\nFigure 78\n\n## Thread activity – sub_12363D0 function\n\nA worker thread responsible for file encryption dequeues an I/O completion packet from the IOCP\nusing GetQueuedCompletionStatus:\n\n**it** **d** | 20\n\n\n-----\n\nFigure 79\n\nSunCrypt passes the ChaCha20 key along with the encrypted file name to the encryption\nfunction:\n\nFigure 80\n\nThe ChaCha20 algorithm implementation is manual, and it doesn’t rely on Windows APIs, as\nhighlighted below:\n\n**it** **d** | 21\n\n\n-----\n\nFigure 81\n\nThe encrypted content is written to the file by calling the WriteFile API (see figure 82). The\ntargeted files should be at least 512 bytes long; otherwise they will not be encrypted by SunCrypt.\n\nFigure 82\n\nWe continue with the analysis of the main thread. It’s worth mentioning that the events log\ndeletion operation is repeated in the main thread with an identical execution flow.\n\nThe ransomware extracts the path of the current executable using GetModuleFileNameW:\n\nFigure 83\n\nThe ransomware deletes itself via a function call to CreateProcessW (0x8000000 =\n**CREATE_NO_WINDOW):**\n\n**it** **d** | 22\n\n\n-----\n\nFigure 84\n\nWe want to provide some observations regarding the usage of command-line parameters.\n\n### Parameter Explanation\n\n**-nomutex** No difference in execution\n\n**-noservices** No difference in execution\n\n**-noreport** No difference in execution\n\n**-vm** No difference in execution\n\n**-path** Encrypt a single directory\n\n**-noshares** Do not encrypt network shares\n\n**-keep_exe** Do not delete the executable\n\nDo not kill the targeted processes. Do not\n**-justcrypt**\n\ndelete the Volume Shadow Copies\n\nSunCrypt proves that a relatively low-level complexity code could still produce significant\ndamages. As opposed to ransomware families such as LockBit or Conti, the encryption of a\nsystem takes tens of minutes and can be detected by monitoring the CPU usage for a longer\ntime period.\n\n**it** **d** | 23\n\n|Parameter|Explanation|\n|---|---|\n|-nomutex|No difference in execution|\n|-noservices|No difference in execution|\n|-noreport|No difference in execution|\n|-vm|No difference in execution|\n|-path|Encrypt a single directory|\n|-noshares|Do not encrypt network shares|\n|-keep_exe|Do not delete the executable|\n|-justcrypt|Do not kill the targeted processes. Do not delete the Volume Shadow Copies|\n\n\n-----\n\n## Indicators of Compromise\n\n### Mutex\n\n0c91c96fd7124f21a0193cf842e3495f6daf84a394f44013e92a87ad9d2ef4a0ceec9dd2e2eca22e\n\n### SunCrypt Ransom Note\n\nYOUR_FILES_ARE_ENCRYPTED.HTML\n\n### Processes spawned\n\ncmd.exe /C ping 127.0.0.1 -n 10 > nul & del /f /q \\\"<Path to executable>\" > nul\n\n**it** **d** | 24\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://cdn.pathfactory.com/assets/10555/contents/394789/0dd521f8-aa64-4517-834e-bc852e9ab95d.pdf"
    ],
    "report_names": [
        "0dd521f8-aa64-4517-834e-bc852e9ab95d.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716504,
    "ts_updated_at": 1743041126,
    "ts_creation_date": 1649781945,
    "ts_modification_date": 1649767631,
    "files": {
        "pdf": "https://archive.orkl.eu/060acb843997b3d26eb38624156bb51adcc57c45.pdf",
        "text": "https://archive.orkl.eu/060acb843997b3d26eb38624156bb51adcc57c45.txt",
        "img": "https://archive.orkl.eu/060acb843997b3d26eb38624156bb51adcc57c45.jpg"
    }
}