{
    "id": "fac682f6-3c88-4694-9fd1-5842285a105c",
    "created_at": "2023-01-12T15:02:20.53099Z",
    "updated_at": "2025-03-27T02:06:02.591008Z",
    "deleted_at": null,
    "sha1_hash": "aa7c42a60f493c93bbe7aba4bdccf20e65474ac9",
    "title": "2022-01-06 - Unpacking Emotet malware part 01",
    "authors": "",
    "file_creation_date": "2022-05-27T18:58:03Z",
    "file_modification_date": "2022-05-27T18:58:03Z",
    "file_size": 2523229,
    "plain_text": "# Unpacking Emotet malware part 01\n\n**muha2xmad.github.io/unpacking/emotet-part-1/**\n\n\nJanuary 6, 2022\n\n\n-----\n\n### Muhammad Hasan Ali\n\nMalware Analysis learner\n\n3 minute read\n\n**As-salamu Alaykum**\n\n## Introduction\n\nEmotet is a Trojan that spreads through spam emails. The infection may arrive either via\n[malicious script, macro-enabled document files, or malicious link. 1](https://www.darkreading.com/edge-articles/emotet-101-how-the-ransomware-works----and-why-it-s-so-darn-effective)\n\n**Download the sample:** **[Here](https://app.any.run/tasks/f907a5b5-689a-472d-a2f7-1a2c4899fc96/)**\n\nMD5: `CA06ACD3E1CAB1691A7670A5F23BAEF4`\n\n## Virustotal VT\n\nwe can see that the malware is detected by 57 out of 68 as a trojan.\n\nFigure(1):\n\n## In Details section VT Details\n\n1- Different names of the sample\n\nFigure(2):\n2- Header info\n\n\n-----\n\nFigure(3):\n\nShows compilation Timestamp which can be changed. and Shows number of sections\n\n## DiE\n\n**open DiE to get more info about the sample**\n\nFigure(4):\n\nAs we see that info about file type, Entry point, and sections. It will help us in our analysis\n\n## Entropy:\n\n**press over “Entropy” as in the previous figure(4)**\n\n\n-----\n\nFigure(5):\n\nShows that it has high entropy in .text section which is an indicator to be packed\n\n## PEstudio analysis\n\n Indicators section:\n\nFigure(6):\n\n*Level 1 is most malicious and bigger numbers “3” are less malicious. Shows different\nmalicious indicators that help us in the analysis.\n\n## Sections section:\n\n\n-----\n\nFigure(7):\n\n**The previous figure shows:**\n\n1- .text section is packed\n\n2- .text section contains the entry point for the executable. This means that, in addition to\nholding the compressed data, .text section also contains the stub code responsible for\n[unpacking. 2](https://malware.news/t/the-basics-of-packed-malware-manually-unpacking-upx-executables/35961)\n\n*The section which is responsible for unpacking can vary as in UPX packing\n\n3- .text section is executable\n\n4- .data section is writable\n\n## Strings section:\n\n**press over** `blacklist to list them`\n\n\n-----\n\nFigure(8):\n\nStrings are good indicators to know what this malware is trying to do on the system\n\n## IDA analysis\n\nTo analyze the assemble code to know how to unpack and where to start the debugging\n\nOpen it in IDA: It shows that is low number of functions which another indicator that is\npacked\n\n\n-----\n\nFigure(9):\n\nPress over “start” which located in the function as in the previous figure to get started\n\n\n-----\n\nFigure(10):\n\nBecause Emotet malware uses a customized packer. we can try to unpack it through\n**dynamic analysis. Through dynamic analysis the malware does the unpacking process.**\n**The process will need to allocate memory for the next stage.**\n\nSo it’s a good assumption that we will see a call to VirtualAlloc. We need to search which\n[function has VirtualAlloc call. 3](https://distributedcompute.com/2020/02/20/unpacking-emotet/)\n\nIf you searched you will find that call `sub_417D50 is the unpacking routine`\n\n\n-----\n\nFigure(11):\n\nThis our unpacking function: `sub_417D50`\n\n\n-----\n\nFigure(12):\n\n## Abnormal epilogue\n\nFirst we need to clear what normal prologue and epilogue are?\n\nThe procedure prologue and epilogue are standard initialization sequences that compilers\ngenerate for almost all of their functions.\n\n\n-----\n\nFigure(13):\n\nWhat is NOT normal here is epilogue in the last figure:\n\nFigure(14):\n\nYou don’t `push anything before` `ret this called abnormal.`\n\nnormal epilogue is to `pop EBP before` `ret . Here it will return` `ecx because it executes`\nthe last instruction- top of the stack-.\n\nAnd the real return is from this function `loc_417D9A because this is 2nd top of the stack.`\n\nWe need to know what is happening in this function?\n\n\n-----\n\nFigure(15):\n\n**In the last figure we see the coming:**\n```\n   VirtualAlloc is moved to ECX, then\n   ECX is moved to dword_41C218, then\n   dword_41C218 is moved to ECX\n\n```\nthen `push ECX and then` `ret`\nAnd the real return is from this function `loc_417D9A`\n\nSo we need to know the address of this function to set a Breakpoint in x64dbg by pressing\n```\nspace .\n\n```\nFigure(16):\n\nWe know that code is packed. We search for abnormal jumps:\n\n\n-----\n\n```\n   jmp or call Instructions to registers\n   Jmp to strange memory addresses (long jump)\n\n```\nWhy searching for abnormal jumps? the address to the location of where data is being\nunpacked to is stored in a register (such as `ecx ), and that memory address is often in an`\nentirely different section.\n\n**I will write an article about “indicators of packed file”. InshAllah**\n\nIf we return to start function and search you will find it.\n\nHere we see our abnormal `jmp ecx :`\n\nFigure(17):\n\nPress `space to get its address:` `00417F1F .`\n\nFigure(18):\n\n**How to Unpack in the next part. InshAllah**\n\n**Edit:** [part 02](https://muha2xmad.github.io/unpacking/emotet-part-2/)\n\n## Article quote\n\nﺑﺎﻟﺒﻼءﻨﺎل إﻻ[ّ] [ُ]اﻟﻤﻨﺎزل اﻟﻌﻠﯿﺎ ﻻ ﺗ\n\n## References\n\n\n-----\n\n[Inspired by: https://malgamy.github.io/malware-analysis/Emotet-Malware-0x01/](https://malgamy.github.io/malware-analysis/Emotet-Malware-0x01/)\n\n1- https://www.darkreading.com/edge-articles/emotet-101-how-the-ransomware-works—and-why-it-s-so-darn-effective\n\n2- https://malware.news/t/the-basics-of-packed-malware-manually-unpacking-upxexecutables/35961\n\n3- [https://distributedcompute.com/2020/02/20/unpacking-emotet/](https://distributedcompute.com/2020/02/20/unpacking-emotet/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-06 - Unpacking Emotet malware part 01.pdf"
    ],
    "report_names": [
        "2022-01-06 - Unpacking Emotet malware part 01.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535740,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1653677883,
    "ts_modification_date": 1653677883,
    "files": {
        "pdf": "https://archive.orkl.eu/aa7c42a60f493c93bbe7aba4bdccf20e65474ac9.pdf",
        "text": "https://archive.orkl.eu/aa7c42a60f493c93bbe7aba4bdccf20e65474ac9.txt",
        "img": "https://archive.orkl.eu/aa7c42a60f493c93bbe7aba4bdccf20e65474ac9.jpg"
    }
}