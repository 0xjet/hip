{
    "id": "c58f5f06-e398-49b3-9e54-0020b1e008ab",
    "created_at": "2023-01-12T15:03:36.658649Z",
    "updated_at": "2025-03-27T02:08:40.173535Z",
    "deleted_at": null,
    "sha1_hash": "04f7aa283d791c37ad4583e405755a28ef3604fb",
    "title": "2021-04-20 - Zero-Day Exploits in SonicWall Email Security Lead to Enterprise Compromise",
    "authors": "",
    "file_creation_date": "2022-05-28T00:43:56Z",
    "file_modification_date": "2022-05-28T00:43:56Z",
    "file_size": 119532,
    "plain_text": "# Zero-Day Exploits in SonicWall Email Security Lead to Enterprise Compromise\n\n**[fireeye.com/blog/threat-research/2021/04/zero-day-exploits-in-sonicwall-email-security-lead-to-compromise.html](https://www.fireeye.com/blog/threat-research/2021/04/zero-day-exploits-in-sonicwall-email-security-lead-to-compromise.html)**\n\nThreat Research\n\nJosh Fleischer, Chris DiGiamo, Alex Pennino\n\nApr 20, 2021\n\n12 mins read\n\nThreat Research\n\nZero Day Threats\n\n\n-----\n\nIn March 2021, Mandiant Managed Defense identified three zero-day vulnerabilities in\nSonicWall’s Email Security (ES) product that were being exploited in the wild. These\nvulnerabilities were executed in conjunction to obtain administrative access and code\nexecution on a SonicWall ES device. The adversary leveraged these vulnerabilities, with\nintimate knowledge of the SonicWall application, to install a backdoor, access files and\nemails, and move laterally into the victim organization’s network.\n\nThe vulnerabilities are being tracked in the following CVEs:\n\nCVE-2021-20021 9.8 Unauthorized administrative account creation\n\nCVE-2021-20022 7.2 Post-authentication arbitrary file upload\n\nCVE-2021-20023 4.9 Post-authentication arbitrary file read\n\nMandiant has been coordinating with the SonicWall Product Security and Incident Response\nTeam (PSIRT) for the responsible disclosure of this information. SonicWall advises all\ncustomers and partners to upgrade to the 10.0.9.6173 Hotfix for Windows users, and the\n10.0.9.6177 Hotfix for hardware and ESXi virtual appliance users. SonicWall Hosted Email\nSecurity product was automatically updated for all customers and no additional action is\nrequired for patching purposes. The hotfixes will also be superseded by the upcoming\nSonicWall ES 10.0.10 release.\n\n[More information can be found by visiting the KB article published by SonicWall.](https://www.sonicwall.com/support/product-notification/?sol_id=210416112932360)\n\n[All patches, upgrades, and hotfixes are available to download on the MySonicWall site.](https://www.mysonicwall.com/muir/login)\n\n**Overview**\n\n\n-----\n\nSonicWall Email Security ecosystem overview (via SonicWall)\n\n\n[Figure 1: SonicWall Email Security ecosystem overview (via SonicWall)](https://www.fireeye.com/blog/threat-research/2021/04/mysonicwall.com)\nSonicWall Email Security (ES) is an email security solution that “provides comprehensive\n[inbound and outbound protection, and defends against advanced email-borne threats such](https://www.sonicwall.com/products/secure-email/email-security-appliance/)\nas ransomware, zero-day threats, spear phishing and business email compromise (BEC).”\nThe solution can be deployed as a physical appliance, virtual appliance, software installation,\nor a hosted SaaS solution.\n\n\n-----\n\nSample SonicWall Email Security login page\n\n\nFigure 2: Sample SonicWall Email Security login page\nLike many appliances, the solution provides a rich, web-accessible administrative interface\nthat serves as the main avenue for product configuration. Depending on the customer’s\ndeployment method, this software is potentially capable of running under Windows or Unix\nbecause it heavily leverages OS-independent Apache Tomcat and Java. While the solution\ndoesn’t require that this interface be exposed to the internet, internet-wide scanning shows\napproximately 700 publicly reachable interfaces.\n\n**Investigation**\n\nIn March 2021, Mandiant Managed Defense identified post-exploitation web shell activity on\nan internet-accessible system within a customer’s environment. Managed Defense isolated\nthe system and collected evidence to determine how the system was compromised.\n\n\n-----\n\nThe system was quickly identified as a SonicWall Email Security (ES) application running on\na standard Windows Server 2012 installation. The adversary-installed web shell was being\nserved through the HTTPS-enabled Apache Tomcat web server bundled with SonicWall ES.\nDue to the web shell being served in the application’s bundled web server, we immediately\nsuspected the compromise was associated with the SonicWall ES application itself.\n\nWhen we contacted the customer, we learned that the installation of SonicWall ES was the\nlatest version available for download (10.0.9) and that there was no publicly available\ninformation pertaining to vulnerabilities or in-the-wild exploitation. To determine if a potential\napplication-level vulnerability was exploited to install the web shell, Mandiant collected\nendpoint telemetry data.\n\nWe soon identified post-exploitation activity aimed at destroying evidence on the system,\nexecuted in the context of the web shell. The adversary executed the following command,\nshortly after installing the web shell:\n\ncmd.exe /c \"echo \"\" > \"C:/Program Files (x86)/SonicWallES/logs/webUI/webui.json\n\nFigure 3: The Adversary clearing existing entries in the current “webui.json” log\n\nThis command deleted the most recent application-level log entries recorded by the\nSonicWall ES web application. While clearing log files is a standard anti-forensics technique,\nunderstanding the location of internal log files generated by applications is usually\noverlooked by most spray-and-pray attackers. This added fuel to our suspicion that we were\ndealing with an adversary who had intimate knowledge of how the SonicWall ES application\nworked.\n\nFortunately for us, additional log files and a previously created virtual server snapshot\nprovided enough evidence to track down the vulnerabilities and the adversary’s activities on\nthe host.\n\n**Vulnerabilities**\n\nCVE-2021-20021\n\n_Unauthenticated administrative access through improperly secured API endpoint_\n\nThe SonicWall Email Security application contains an authenticated control panel to provide\nadministration capabilities. One feature available allows application administrators to\nauthorize an additional administrator account from a separate Microsoft Active Directory\nOrganization Unit (AD OU).\n\nhttps://<SonicWall ES host>/createou?data=<XML HERE>\n\n\n-----\n\nFigure 4: A redacted example of the vulnerable endpoint associated with arbitrary user\ncreation\n\nRequests to this form, however, were not verified to require previous authentication to the\nappliance.\n\nDue to this vulnerability, an adversary with a well-crafted XML document could either GET or\nPOST their document to the application and create a “role.ouadmin” account (Figure 4). This\naccount could then be used to authenticate to the application as an administrator.\n\nCVE-2021-20022\n\n_Arbitrary file upload through post-authenticated “branding” feature_\n\nLike many enterprise products with a web-based user interface, SonicWall Email Security\nincludes a feature known as \"branding\" which gives administrators the ability to customize\nand add certain assets to the interface, such as company logos. These branding assets are\nmanaged via packages, and new packages can be created by uploading ZIP archives\ncontaining custom text, image files, and layout settings. A lack of file validation can enable\nan adversary to upload arbitrary files, including executable code, such as web shells.\n\nOnce uploaded, these branding package ZIP archives are normally expanded and saved to\nthe <SonicWall ES install path>\\data\\branding directory. However, an adversary could place\nmalicious files in arbitrary locations, such as a web accessible Apache Tomcat directory, by\ncrafting a ZIP archive containing a file within a sequence of directory traversal notations such\nas in Figure 5.\n\n\n-----\n\nExample ZIP archive containing a Zip Slip web shell\n\n\nFigure 5: Example ZIP archive containing a Zip Slip web shell\nIt is important to note that the lack of validation which enables Zip Slip attacks is not unique\n[to SonicWall Email Security. As detailed in Snyk's research on the topic, they exist within the](https://snyk.io/research/zip-slip-vulnerability)\nmany code libraries from which applications have been built.\n\nCVE-2021-20023\n\n_Directory-traversal leads to arbitrary file read in post-authenticated \"branding\" feature_\n\nMandiant confirmed another post-authentication vulnerability in the administrative panel’s\nbuilt-in \"branding\" feature which allowed an adversary to retrieve arbitrary files from the host\nby sending crafted HTTP GET requests to a particular resource. Figure 6 demonstrates the\nformatting of such request.\n\n\n-----\n\nhttps://<SonicWall ES host>/dload_apps?action=<any\nvalue>&path=..%2F..%2F..%2F..%2F..%2Fwindows%2Fsystem32%2Fcalc.exe&id=update\n\nFigure 6: An example web request which results in downloading the Windows calculator\n\nWhile the working directory of this branding feature is <SonicWall ES install\npath>\\data\\updates, a directory-traversal vulnerability allows an adversary to access files\nlocated outside of this directory. As the Apache Tomcat webserver handling this request is\noperating as the NT AUTHORITY\\SYSTEM account, any file on the operating system can be\naccessed.\n\nCombinations of all three exploits were leveraged interchangeably by the adversary to\nperform the following actions:\n\n1. Creation of a new Administrator account on the SonicWall ES device\n2. Exposure of the hashed passwords for existing, locally configured Administrative\n\naccounts\n3. The creation of a web shell in an arbitrary directory\n4. Real-time debugging of exploitation success and failure\n\n**Post-Exploitation**\n\nUpon obtaining administrative access to the appliance through CVE-2021-20021, an\nadversary sent crafted HTTP requests to the resource /dload_apps, a component of the\napplication's \"branding\" feature, exploiting CVE-2021-20023. These requests leveraged\ndirectory traversal attacks, enabling access to two sensitive XML configuration files located\nat <SonicWall ES install path>\\data\\multi_accounts.xml and <SonicWall ES install\npath>\\data\\multi_ldap.xml, respectively (Figure 7).\n\nGET /dload_apps?action=REDACTED&path=..%2Fmulti_accounts.xml&id=update\n\nGET /dload_apps?action=REDACTED&path=..%2Fmulti_ldap.xml&id=update\n\nFigure 7: HTTP GET requests exploiting CVE-2021-20023\n\nThese files contained details about existing accounts as well as Active Directory credentials\nused by the application.\n\nNext, the adversary uploaded a ZIP archive containing the BEHINDER JSP web shell from\nthe administrative panel's \"branding\" page. The crafted ZIP archive used a Zip Slip attack to\nexploit CVE-2021-20022, which caused the web shell to be written to the web-accessible\nApache Tomcat directory <SonicWall ES install path>\\Apache Software Foundation\\Tomcat\n9.0\\webapps\\SearchEngineRMIService\\.\n\n\n-----\n\nBEHINDER is a publicly available, multi-platform web shell that accepts encrypted command\nand control (C2) communications. In principle, BEHINDER operates similarly to CHINA\nCHOPPER, a popular web shell that has been previously detailed by FireEye. Like CHINA\nCHOPPER, an adversary operates a client-side application to pass commands to the web\nshell within the body of HTTP requests. As the core functionality of the backdoor is contained\nwithin the client-side application, BEHINDER—much like CHINA CHOPPER—has the added\nbenefit of being small, with the variant observed in this investigation weighing in at less than\n1 kilobyte (Figure 8).\n\nThe BEHINDER web shell observed by Mandiant, which executes AES encrypted\nand base64 encoded commands\n\n\nFigure 8: The BEHINDER web shell observed by Mandiant, which executes AES encrypted\nand base64 encoded commands\nWith the addition of a web shell to the server, the adversary had unrestricted access to the\ncommand prompt, with the inherited permissions of the NT AUTHORITY\\SYSTEM account.\n\n\n-----\n\nAfter clearing the SonicWall application webui.json log file, the adversary escalated their\nattack to credential harvesting in preparation of moving laterally into the victim's network. The\nadversary relied on “living off the land” techniques rather than bringing their own tools into\nthe environment, which often has the benefit of potentially avoiding detections from a\nsecurity product.\n\nWe observed the adversary executing the reg save command to dump the HKLM\\SAM,\nHKLM\\SYSTEM, and HKLM\\SECURITY registry hives, which contain vital information in\nrecovering password hashes and LSA secrets. Additionally, the adversary obtained inmemory sensitive credentials through the use of built-in memory dumping techniques. The\nadversary was observed invoking the MiniDump export of the Windows DLL comsvcs.dll to\ndump both the process memory for lsass.exe and the running instance of Apache Tomcat as\nseen in Figure 9.\n\nrundll32.exe C:\\windows\\system32\\comsvcs.dll, MiniDump <lsass PID>\nc:\\windows\\temp\\TS_LAS.dmp full\n\nrundll32.exe C:\\windows\\system32\\comsvcs.dll MiniDump <Tomcat PID>\nC:\\windows\\temp\\TS_FF9DG.dmp full\n\nFigure 9: The adversary acquiring process memory for lsass.exe (MITRE ATT&CK\nT1003.001) and Apache Tomcat\n\nMandiant typically observes adversaries employing short and easy-to-type filenames during\ntheir operations, simply for efficiency. As such, the aforementioned filenames initially stood\nout as being peculiar, as a mix of case and symbols would require more effort to type than is\noften necessary. While this could always be indicative of a tool being used, the slight\nvariations between the two commands—the absence of a comma before the DLL export and\nthe uppercase C:\\ drive in the second—suggest that they were manually typed. Considering\nthat the C:\\Windows\\Temp\\ directory on a Windows host also normally contains numerous\nsimilarly named temporary files, the adversary was likely taking extra care to evade\nsuspicion should the activity reach the screen of a security analyst.\n\nContinuing their effort to live off the land as much as possible, the adversary located a copy\nof the archiving utility 7-Zip already present on the host and used it to compress a\nsubdirectory of <SonicWall ES install path>\\data\\archive\\. This directory contains daily\narchives of emails processed by SonicWall ES—again demonstrating the adversary’s\nfamiliarity with the application.\n\nAfter a several-day lull in activity, the adversary returned to the host, presumably after\nworking to recover passwords from the registry hives and process memory that was dumped\nearlier. At the time of activity, the victim organization was using the same local Administrator\n\n\n-----\n\npassword across multiple hosts in their domain, which provided the adversary an easy\nopportunity to move laterally under the context of this account—highlighting the value of\nrandomizing passwords to built-in Windows accounts on each host within a domain.\n\n[We observed the adversary leveraging Impacket’s publicly available WMIEXEC.PY tool to](https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py)\naccess several internal hosts, which enabled remote command execution over Microsoft's\nDCOM protocol via Windows Management Instrumentation (WMI). The adversary managed\nto briefly perform internal reconnaissance activity prior to being isolated and removed from\nthe environment.\n\n**Attribution**\n\nMandiant currently tracks this activity as UNC2682. Ultimately, Mandiant prevented\nUNC2682 from completing their mission so their objectives of the attack currently remain\nunknown.\n\nEach investigation conducted by Mandiant includes analysts from our Advanced Practices\nteam who work to correlate activity observed in the thousands of investigations that Mandiant\nresponds to. At times, we do not have the data available to directly attribute intrusion activity\nto a previously known group. In these cases, we create a new UNC group to track the activity\nthat we observed. An UNC group is a cluster of related cyber intrusion activity, which\nincludes observable artifacts such as adversary infrastructure, tools, and tradecraft, that we\nare not yet ready to give a classification such as APT or FIN.\n\nFor more details on how Mandiant uses UNC groups, see our blog post: DebUNCing\nAttribution: How Mandiant Tracks Uncategorized Threat Actors.\n\n**Investigation & Monitoring Tips**\n\nMandiant recommends monitoring of the following endpoint telemetry indicators for potential\nevidence of compromise:\n\nChild processes of the web server process “tomcat” on SonicWall Email Security\nappliances, particularly cmd.exe\nThe creation or existence of web shells on a server hosting SonicWall Email Security\n\nIn addition to standard indicators, Mandiant recommends reviewing SonicWall-related\ninternal configuration files and logs for evidence of previous adversary activity.\n\nEvidence of malicious web requests and their values may be identifiable in the following log\nfiles:\n\n1. The Apache Tomcat logs:\n\nC:\\Program Files\\SonicWallES\\Apache Software Foundation\\Tomcat 9.0\\logs\n2. The SonicWall application logs:\n\nC:\\Program Files\\SonicWallES\\logs\\webUI\\webui.json\n\n\n-----\n\nEvidence of unauthorized modifications to SonicWall configuration settings can be confirmed\nin the following files:\n\n1. The administration user account file:\n\nC:\\Program Files\\SonicWallES\\data\\multi_accounts.xml\n2. Additional user account files that may have been created in the following directories:\n\nC:\\Program Files\\SonicWallES\\data\\perhost\nC:\\Program Files\\SonicWallES\\data\\perldap\nC:\\Program Files\\SonicWallES\\data\\perou\n3. Branding related zip files in any of the subdirectories of the following directory:\n\nC:\\Program Files\\SonicWallES\\data\\branding\n\n**Detecting the Techniques**\n\nFireEye detects this activity across our platforms. The following contains specific detection\nnames that provide an indicator of SonicWall ES exploitation or post-exploitation activities\nassociated with this adversary.\n\n**Product** **Signature**\n\nFireEye Endpoint Security RUNDLL32.EXE COMSVCS.DLL PROCESS\nMINIDUMP (METHODOLOGY)\nSUSPICIOUS REGISTRY EXPORTS\n(METHODOLOGY)\nWEB SERVER ECHO REDIRECT (METHODOLOGY)\nWEB SERVER CMD.EXE TYPE RECON\n(METHODOLOGY)\n\n\nFireEye Network Security\n\nFireEye Email Security\n\nFireEye Detection On\nDemand\n\nFireEye Malware File\nScanning\n\nFireEye Malware File\nStorage Scanning\n\n\nFE_PUP_Exploit_Linux_ZipSlip_1\nFE_Exploit_Win_ZipSlip_1\nFE_Trojan_ZIP_Generic_1\nFE_Webshell_JSP_BEHINDER_1\nFEC_Webshell_JSP_BEHINDER_1\nWebshell.JSP.BEHINDER\nWebshell.JSP.BEHINDER.MVX\n\n\nFireEye Helix METHODOLOGY - LFI [Null-Byte URI]\nWMIEXEC UTILITY [Args]\nWINDOWS METHODOLOGY [Unusual Web Server\nChild Process]\n\n\n-----\n\nAdditionally, SonicWall has deployed Intrusion Prevention System (IPS) signatures to\nSonicWall firewalls to help detect and block attacks that attempt to leverage the\naforementioned vulnerabilities. The following signatures have already been applied to\nSonicWall firewalls with active security subscriptions:\n\n**IPS Signature: 15520 WEB-ATTACKS SonicWall Email Security (CVE-2021-20022**\nVulnerability)\n**IPS Signature: 1067 WEB-ATTACKS Web Application Directory Traversal Attack 7**\n**IPS Signature: 15509 WEB-ATTACKS Web Application Directory Traversal Attack 7 -**\nc2\n\n**Mandiant Security Validation Actions**\n\nOrganizations can validate their security controls using the following actions with Mandiant\nSecurity Validation.\n\n**VID** **Name**\n\nA101-563 Malicious File Transfer - BEHINDER, Download, Variant #1\n\nA101-566 Web Shell Activity - BEHINDER, Basic Shell Interaction\n\nA101-564 Malicious File Transfer - Zip Slip, Download, EICAR Variant\n\nA101-565 Phishing Email - Malicious Attachment, Zip Slip, Generic Themed Lure\n\n**Vulnerability Disclosure**\n\nMandiant disclosed the vulnerabilities CVE-2021-20021 and CVE-2021-20022 to SonicWall\nProduct Security Incident Response Team (PSIRT) on March 26, 2021. The vulnerabilities\nwere acknowledged and validated on March 29, 2021 and a hotfix became available on April\n9, 2021. The patch was communicated to impacted SonicWall customers and partners on\nApril 9, 2021.\n\nMandiant disclosed the vulnerability CVE-2021-20023 to SonicWall PSIRT on April 6, 2021.\nThe vulnerability was acknowledged and validated on April 9, 2021 and a patch became\navailable April 19.\nTo mitigate the three CVEs, Mandiant and SonicWall recommend upgrading Email Security\nto version 10.0.9.6173 (Windows) or 10.0.9.6177 (Hardware & ESXi Virtual Appliances).\nOrganizations using SonicWall Hosted Email Security (HES) products were automatically\nupdated and no action is required for those customers.\n\n\n-----\n\n**Acknowledgements**\n\nSonicWall PSIRT, Charles Carmakal, Ben Fedore, Geoff Ackerman and Andrew Thompson.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-04-20 - Zero-Day Exploits in SonicWall Email Security Lead to Enterprise Compromise.pdf"
    ],
    "report_names": [
        "2021-04-20 - Zero-Day Exploits in SonicWall Email Security Lead to Enterprise Compromise.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535816,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1653698636,
    "ts_modification_date": 1653698636,
    "files": {
        "pdf": "https://archive.orkl.eu/04f7aa283d791c37ad4583e405755a28ef3604fb.pdf",
        "text": "https://archive.orkl.eu/04f7aa283d791c37ad4583e405755a28ef3604fb.txt",
        "img": "https://archive.orkl.eu/04f7aa283d791c37ad4583e405755a28ef3604fb.jpg"
    }
}