{
    "id": "f1e4df7f-27b4-4a1e-9f94-53a3f976a9fb",
    "created_at": "2022-10-25T16:48:13.943852Z",
    "updated_at": "2025-03-27T02:05:46.160526Z",
    "deleted_at": null,
    "sha1_hash": "8c629cb675335784dd319ac0f47822274b5d7858",
    "title": "The Ghost Dragon",
    "authors": "Cylance",
    "file_creation_date": "2016-10-19T13:52:42Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 164924,
    "plain_text": "**blog.cylance.com/the-ghost-dragon**\n\n[By Isaac Palmer April 22, 2016](https://blog.cylance.com/author/isaac-palmer)\n\nIntroduction\n\nCylance SPEAR™ has identified an APT group which deploys multiple customized malware implants, targeting\nmainly Chinese and Russian users. Cylance determined that the ‘Ghost Dragon’ group utilized specifically tailored\n[variants of Gh0st RAT, which the group modified from the 3.6 version of the source code released in 2008. Newly](https://en.wikipedia.org/wiki/Gh0st_RAT)\nimplemented security mechanisms in the altered malware makes identification of Gh0st RAT Command and Control\nnetwork traffic more difficult for both security products and researchers.\n\nThis write-up provides initial disclosure of a portion of the malware and infrastructure used by the Ghost Dragon\ngroup and covers the new security mechanisms in detail, as well as revealing how researchers were able to\ncommunicate with the custom implant by rebuilding and compiling a customized Gh0st RAT controller.\n\n## The Standard Gh0st RAT Protocol\n\nThe standard network protocol for Gh0st RAT 3.6 employs zlib compression, which utilizes ‘Gh0st’ as a static fivebyte packet flag that must be included in the first five bytes of initial transmission from the victim (as seen in Figure\n1). During the initial login request, the 3.6 version of Gh0st RAT enumerates system information and transmits that\ninformation to the controller. The proceeding eight bytes of the packet contain both compressed and uncompressed\nsize information followed by the zlib compressed data, starting with bytes 78 9C at offset 14 (shown in Figures 1 and\n2, below).\n\n**Figure 1: Standard Gh0st RAT 3.6 packet login request |**\n**Victim to controller**\n\nAfter a successful login, the controller returns an acknowledgment to the victim with the correct header using the\npacket flag which it is programmed to verify, as seen in Figure 2. The connection will be established only if the\npacket flags match.\n\n\n-----\n\n**_Figure 2: Standard Gh0st RAT 3.6 packet response | Controller to victim – 22 bytes_**\n\nFollowing the first five bytes, the packet then shows the full packet size and the uncompressed data size. The Gh0st\npacket header for version 3.6 uses the 13-byte format shown in Figure 3:\n\n**_Figure 3: Gh0st RAT 3.6 header format_**\n\nAfter the packet flag, packet length and unzip length have been verified, a working connection is created between\nthe victim and the controller. Subsequent keep-alive transmissions ensure a continuous connection.\n\nOnce Gh0st RAT is connected, the attacker has full remote administration tool (RAT) functionality via the controller.\nAvailable remote functionality includes:\n\n**• Fully functional remote desktop display, including the ability to remotely block user input**\n\n**• Fully functional file manager that lists local and network drives**\n\n**• Ability to interact with running processes**\n\n**• Ability to interact via the command console**\n\n**• Key logging**\n\n**• Audio capture**\n\n**• Webcam capture**\n\n**• Ability to send ‘Windows style’ alerts to the victim, which can display any text the attacker enters**\n**into the controller**\n\nThese features ensure complete remote control of the computer.\n\n## Changes to the Gh0st RAT Protocol\n\nIn an older version of the customized Gh0st RAT malware, the protocol packet flag is no longer represented by the\nstring ‘Gh0st’. The Ghost Dragon group modified the source code and changed the packet flag to ‘XYTvn’, as seen\nin Figure 4. The packet structure still implements the same 13-byte header format, including the starting zlib\ncompression bytes of ‘78 9C’:\n\n\n-----\n\n**_Figure 4: XYTvn static packet flag | Victim to controller login request_**\n\n**Sample: f9a669d22866cd041e2d520c5eb093188962bea8864fdfd0c0abb2b254e9f197**\n\nIn a more recent version of the modified Gh0st RAT malware, Ghost Dragon implemented dynamic packet flags\nwhich change the first five bytes of the header in every login request with the controller. This complicates identifying\nits network traffic, as the header bytes in the zlib compressed data section no longer start with ‘78 9C’, as shown in\nFigure 5.\n\nIn some cases this was achieved through a simple XOR obfuscation of the packet data, beginning with the zlib\nheader. SPEAR has observed numerous different XOR keys utilized by the group. No changes to the compression\nhave been found; however, it is trivial to implement a modified compression protocol.\n\n**_Figure 5: Dynamic packet flag | Victim to controller login request_**\n\n**Sample: 1be9c68b31247357328596a388010c9cfffadcb6e9841fb22de8b0dc2d161c42**\n\n(Note: At the time of this report, the C2 for the sample was active and the malware could still establish an active\nconnection to the Ghost Dragon controller at bbs.winupdate[dot]net. Currently, the domain bbs.winupdate[dot]net\nresolves to 122.10.18[dot]166).\n\nThe reply from the active command and control server can be seen in Figure 6:\n\n\n-----\n\n**_Figure 6: Dynamic packet flag | Controller to victim login reply_**\n\n**Sample: 1be9c68b31247357328596a388010c9cfffadcb6e9841fb22de8b0dc2d161c42**\n\n## Connecting to the Ghost Dragon Malware\n\nAfter successful identification of the malware as Gh0st RAT and confirmation of the modified command and control\nprotocol, the final step toward verification was to connect with the malware to ensure that it would parse the normal\nGh0st RAT commands.\n\nI was able to compile a custom controller from the source code for the purposes of testing the Ghost Dragon\nmalware. I bypassed the header checks looking for the ‘Gh0st’ packet flag, and reprogrammed the standard Gh0st\nRAT controller to reply with the packet flag sent from the victim.\n\nI used sample 6c7f8ba75889e0021c4616fcbee86ac06cd7f5e1e355e0cbfbbb5110c08bb6df for testing, which\nwas executed by f9a669d22866cd041e2d520c5eb093188962bea8864fdfd0c0abb2b254e9f197 during analysis\non Windows XP. This sample transmitted the static five byte packet flag ‘XYTvn’.\n\nI ran the victim malware and changed the host’s file to point the domain to a host-only IP address. I received a\nconnection attempt from the victim and a response from the controller returned the correct packet flag. Afterward,\nthe keep-alive packets between the victim and controller maintained the connection, which allowed me to test the\nfunctionality of 6c7f8ba75889e0021c4616fcbee86ac06cd7f5e1e355e0cbfbbb5110c08bb6df with the custom\nGh0st RAT controller.\n\nThe following screen shots were obtained while connected to the malware:\n\n**_Figure 7: Main connection view | Connected to_**\n**_6c7f8ba75889e0021c4616fcbee86ac06cd7f5e1e355e0cbfbbb5110c08bb6df_**\n\nThe HOSTNAME field shown in Figure 7 was programmed in my custom controller to display ‘Gh0st variant’, just in\ncase the incoming structure parsed from the victim did not match the format of the default ‘LOGININFO’ structure\nfrom Gh0st RAT 3.6.\n\nI attained full functionality using the Gh0st 3.6 protocol in the controller, despite the fact that the incoming structure\n\n\n-----\n\nsample f9a669d22866cd041e2d520c5eb093188962bea8864fdfd0c0abb2b254e9f197.\n\nFigure 8 demonstrates that some of the characters in the window are not in English and are not displayed properly\non the form. This is due to the fact that the characters were written in Mandarin in the original Gh0st RAT 3.6 source.\nI changed phrases in the main connection window (Figure 7) for demonstration purposes only.\n\n**_Figure 8: Remote shell | Adding admin user | Connected to_**\n**_6c7f8ba75889e0021c4616fcbee86ac06cd7f5e1e355e0cbfbbb5110c08bb6df_**\n\nThe remaining features of the Gh0st RAT protocol were tested successfully with the custom Gh0st RAT controller\nwhile connected to 6c7f8ba75889e0021c4616fcbee86ac06cd7f5e1e355e0cbfbbb5110c08bb6df.\n\nAdditional analysis into other samples is ongoing and more information will be forthcoming.\n\nNetwork IOCs and Infrastructure Overlap\n\n**A48f881f254dc8452561a8f13e2fb81933473ff22e549787f0ca67f19ba7fe67**\n**File name: Air China 2015 April TIMETABLE .xls**\n**Malware type: Initial Infection Vector/ XLS file**\n**Network Activity Summary: Drops the downloader**\n71a52058f6b5cef66302c19169f67cf304507b4454cca83e2c36151da8da1d97\n\n**71a52058f6b5cef66302c19169f67cf304507b4454cca83e2c36151da8da1d97**\n**File name: AdobeWpkReg.tmp**\n**Malware type: Downloader**\n**Network Activity Summary: Uses HEAD method (instead of GET) | Calls out to info.winupdate[dot]net/robots.txt |**\nUser-Agent: Mozilla/5.0 (compatible; MSIE 10.0; NULL[5(1)]Windows NT 6.1; Trident/6.0)\n**Note: User Agent is variable depending on the version info of the host**\n\n**1be9c68b31247357328596a388010c9cfffadcb6e9841fb22de8b0dc2d161c42**\n**File name: iconfig.exe**\n**Malware type: Gh0st RAT variant**\n**Network Activity Summary: bbs.winupdate[dot]net | Port 8080**\n**Packet flag: Dynamic**\n\n**f9a669d22866cd041e2d520c5eb093188962bea8864fdfd0c0abb2b254e9f197**\n\n\n-----\n\n**Network Activity Summary: ooxxxoo.gicp[dot]net | Port 8080 | Also connects to www.winupdate[dot]net on port**\n8080\n**Packet flag: Static: XYTvn**\n**Note: On Windows XP, may drop a replacement DLL for the AppMgmt service using ClimateVMain export**\nSVC_sha256: 6c7f8ba75889e0021c4616fcbee86ac06cd7f5e1e355e0cbfbbb5110c08bb6df. The hash of the\ndropped file may change on different versions of Microsoft Windows\n\n**99ee5b764a5db1cb6b8a4f62605b5536487d9c35a28a23de8f9174659f65bcb2**\n**File name: install.exe**\n**Malware type: Gh0st RAT variant**\n**Network Activity Summary: www.searchhappynews[dot]com | Port 80**\n**Packet flag: Static | XYTvn**\n\n**b803381535ac24ce7c8fdcf6155566d208dfca63fd66ec71bbc6754233e251f5**\n**File name: ExtensionManager.exe**\n**Malware type: Gh0st RAT variant**\n**Network Activity Summary: www.fhtd[dot]info | Port 1081**\n**Packet flag: Dynamic**\n\n**Infrastructure Overlap**\n\n**Domain                   |** **Previous IP resolution**\nbbs.winupdate[dot]net     | 122.10.18.166\nwww.fhtd[dot]info         | 122.10.18.166\n**info.winupdate[dot]net     | 122.10.36.94**\n\nDuring investigation into the infrastructure used by Ghost Dragon, an anonymous FTP server was discovered on\none of the IP addresses listed above, which hosted ‘info.winupdate[dot]net | 122.10.36.94’.\n\nUpon obtaining the files on the FTP server, an older Gh0st RAT variant was obtained with the file name\n‘operas.exe’. This variant sends the system info to the controller in clear text for the login request.\n\n**fb5a7cb34040b1e98b077edaf91cb59a446d8ff07263afe875cf6bd85bfb359d**\n**File name: operas.exe**\n**Malware type: Gh0st RAT variant**\n**Network Activity Summary: www.swgabeg[dot]com | Port 1080 | Clear text login request sent to controller**\n**Packet flag: Dynamic**\n\nAppendix A – IP and Domain Listing\n\n**IP addresses:**\n\n101.55.33.39\n103.232.215.144\n103.246.245.147\n111.68.8.130\n112.125.17.103\n113.10.148.161\n113.10.148.205\n122.10.18.166\n122 10 36 94\n\n\n-----\n\n122.10.85.35\n122.9.247.128\n122.9.247.134\n122.9.247.216\n122.9.247.56\n123.254.111.87\n142.4.103.90\n174.128.255.228\n175.45.192.234\n202.172.32.172\n202.174.130.116\n203.232.28.10\n209.85.84.165\n209.85.84.167\n31.170.179.179\n58.64.187.22\n60.215.128.246\n64.111.220.218\n\n**Domains:**\n\ninfo.winupdate[dot]net\nbbs.winupdate[dot]net\nooxxxoo.gicp[dot]net\nwww.winupdate[dot]net\nwww.searchhappynews[dot]com\nwww.fhtd[dot]info\nwww.swgabeg[dot]com\n\n[Tags: Gh0st Dragon, Gh0st RAT](https://blog.cylance.com/topic/gh0st-dragon)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/xr1ykgout1c9ho5rotpop09smkawg5me"
    ],
    "report_names": [
        "Cylance_The_Ghost_Dragon(04-22-2016)"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716493,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1476885162,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/8c629cb675335784dd319ac0f47822274b5d7858.pdf",
        "text": "https://archive.orkl.eu/8c629cb675335784dd319ac0f47822274b5d7858.txt",
        "img": "https://archive.orkl.eu/8c629cb675335784dd319ac0f47822274b5d7858.jpg"
    }
}