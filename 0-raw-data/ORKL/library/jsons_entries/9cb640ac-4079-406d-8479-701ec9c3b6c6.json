{
    "id": "9cb640ac-4079-406d-8479-701ec9c3b6c6",
    "created_at": "2023-01-12T15:02:38.711841Z",
    "updated_at": "2025-03-27T02:15:37.919306Z",
    "deleted_at": null,
    "sha1_hash": "5b232bc3d0b29ecc9c10e4f5bc8fdb0bbc9225c3",
    "title": "2019-07-09 - The 2019 Resurgence of Smokeloader",
    "authors": "",
    "file_creation_date": "2022-05-28T02:15:07Z",
    "file_modification_date": "2022-05-28T02:15:07Z",
    "file_size": 812918,
    "plain_text": "# The 2019 Resurgence of Smokeloader\n\n**[research.checkpoint.com/2019-resurgence-of-smokeloader/](https://research.checkpoint.com/2019-resurgence-of-smokeloader/)**\n\nJuly 9, 2019\n**A View into New Nasty Tricks and Actor Activity**\n\n**Research By: Israel Gubi**\n\n**Background**\n\n\nJuly 9, 2019\n\n\nSmokeloader is a popular bot and a veteran in its field – being sold on underground\ncybercriminal markets since 2011, this piece of malware is used mainly for loading other\nmalicious software, usually obtained from a third party. At the same time, it has the capability\nof loading its own modules, allowing it to conduct a variety of actions without the usage of\nexternal components. The seller of Smokeloader (which is known by the handle SmokeLdr)\nis active in providing this malware as a service to this date, and from what we can tell,\nrestricts access to it to only Russian speaking users.\n\nOn the same note, we can tell that the author of Smokeloader has kept changing the\nmalware throughout the years, and added multiple novel features to it. As an example, it was\nthe only malware to incorporate the Propagate DLL injection method at the time it was\nreleased as a PoC by researchers.\n\n\n-----\n\nAs a part of this constant renovation, we were able to spot another new version of the\nmalware a couple of weeks ago. This version employs new tricks for deception and selfprotection, which we will outline in the upcoming sections. Additionally, we will give some\ninsight into the activity of one of the actors that makes use of this recent version and shed\nlight on the campaigns it was involved in.\n\n**Updates from 2018’s Version**\n\n**New anti-hooking and anti-VM methods**\n\nSandboxes and other security solutions frequently use user-land hooking of ntdll functions,\nso as to trace all of the system calls invoked by an inspected sample (Cuckoo sandbox is\njust one example that employs this technique). One of the main goals of a generic malware\nloader is to remain undetected by such products, and evade this type of monitoring.\n\nIn order to do so, Smokeloader first creates a new copy of ntdll.dll as a temporary file with a\nhardcoded name in the %APPDATA%\\Local\\Temp directory and then loads it using\nLdrLoadDll. Following this, it resolves all the functions it requires for its own usage and\ninvokes them from the new copy of ntdll in its memory.\n\n\n-----\n\n[Copying and loading ntdll.dll]\n\nConsidering that the monitoring hooks were set on the original ntdll module loaded by the\noperating system, invoking the functions from the memory duplicate of it will not report the\nbehaviour of the malware to a third party security product, thus allowing Smokeloader to\nconduct code injection to explorer.exe that goes unnoticed. A similar evasion method was\n[observed in usage by Hancitor, as previously outlined by MalwareBytes.](https://blog.malwarebytes.com/threat-analysis/2018/03/hancitor-fileless-attack-with-a-copy-trick/)\n\nMoreover, Smokeloader conducts checks to determine if it runs in a virtual machine by\nreading the values of the following registry keys:\n\n**_System\\CurrentControlSet\\Services\\Disk\\Enum\\IDE_**\n\n**_System\\CurrentControlSet\\Services\\Disk\\Enum\\SCSI_**\n\nIt would use the wcsstr function from the untraced ntdll copy to find an instance of the\nfollowing substrings in the values of the keys above: qemu, virtio, vmware _vbox or xen, and_\nin the presence of either one would terminate its own execution.\n\n[Calling wcsstr from the copied ntdll.dll file]\n\n**New Anti-Debug Method**\n\n\n-----\n\nIn addition to the anti-debug checks used in the older version of Smokeloader, the author\nadded another method, which is rather well known. He made the malware call the API\nfunction NtQueryInformationProcess from the copy of ntdll, with an information class\nargument called ProcessDebugPort. The result provided by the function indicates if the\ndebug port is used in the malware’s process, i.e. a debugger is attached to it. In the case that\na non-null value is retrieved by this function, Smokeloader determines that it is indeed run by\na debugger (and likely by a researcher), hence aborts its execution.\n\n[NtQueryInformationProcess checking for ProcessDebugPort\ninformation]\n\n**Changed URL Decode Method**\n\nSmokeloader’s C2 domains are encoded using an algorithm based on a custom sequence of\narithmetic-logic operations.\n\nIn the new version, the malware authors changed the method by modifying a single\ninstruction in the sequence, replacing a ‘not’ operation with a ‘xor 0xe4’. This single\nmodification causes failure to automatic tools intended to extract the configuration of\nSmokeloader that relied on the old sequence for this purpose.\n\n\n-----\n\n[The changed Url decryption method – by one instruction]\n\n\n-----\n\n**Changed Connection Method**\n\nSmokeloader uses a particular struct (which we’ll refer to as the connection struct) for the\npurpose of conveying information on the victim machine to the attacker. This struct has\nremained mostly the same in the latest version, except for 2 changes:\n\n1. The magic value (2 bytes at the very beginning of it that identify the start of a message\n\nsent to the C&C) has now changed to 0x7e3(2019) from 0x7e2(2018), suggesting that\nthe latest version was released this year.\n\n2. The malware concatenates a random-size buffer (of at least 0x1f bytes) with random data\nto the connection struct, which is likely done in order to make it harder to uniquely sign its\ncommunication and avoid its interception by IDS/IPS products.\n\n\n-----\n\n[Changed magic value in the new version of Smokeloader]\n\n**New Persistence Methods**\n\nAs part of Smokeloader’s behaviour, it generates a unique ID for each victim machine, which\nis based on concatenation of the computer name, a hard coded static number (that differs\nbetween campaigns) and the volume serial number of the system drive. The ID is then\ngenerated as an MD5 hash of the concatenated string and appended again with the MD5 of\nthe volume serial number.\n\n\n-----\n\nThe malware uses this unique ID for several purposes, namely creating random file names\nfor 2 dropped files – the first is a copy of Smokeloader’s executable, and the second is an lnk\nwhich is invoked as a scheduled task. The latter is used just to run the former, thus allowing\nthe malware to persist on the machine after reboot using this pair of files.\n\nIn older versions, the random name of the copied malware executable was based on the last\neight characters of the ID described above. Those were all dependent on the volume serial\nnumber and would create the same file artifact for a single machine. In the new version,\nhowever, the name is generated from seven letters starting from the 30th letter, allowing it to\nalso depend on the hardcoded static value. As a result, samples with different hardcoded\nvalues will generate different file names on the same machine, allowing the malware to be\nless detectable by AV products.\n\nIn addition to the above, a few other modifications to persistence mechanisms were\nwitnessed in the new version. One of them is the creation of the aforementioned lnk file in\nthe %startup% folder with the name “Opera Scheduled Autoupdate <random_number>“.\nThe name of the scheduled task that invokes it is “NvNgxUpdateCheckDaily_{%08X-%04X**_%04X-%04X-%08X%04X}” (the hex values are hardcoded in the binary) and the task_**\nexecuted via the lnk runs the following script embedded in it:\n\n_“<?xml version=”1.0″?><scriptlet><registration classid=”{00000000-0000-0000-0000-_\n**_00000000%04X}”><script language=”jscript”><!_**\n\n**_[CDATA[GetObject(“winmgmts:Win32_Process”).Create(“%ls”,null,null,null);]]>_**\n**_</script></registration></scriptlet>“_**\n\nApart from this, there is a change in the way scheduled task is created, which is now\nregistered only when the explorer.exe process receives a WM_QUERYENDSESSION or\n**_WM_ENDSESSION window message. This allows the malware to conduct task scheduling_**\nonly when the computer is turned off (which is when the window messages are received).\nOnce again, this technique provides Smokeloader with the ability to evade AV solutions and\nremain under the radar. To better understand how this works you may reference the\n[explanation given here.](https://www.crowdstrike.com/blog/through-window-creative-code-invocation/)\n\n**The Actor Leveraging the New Smokeloader Variant**\n\nThe sample we analyzed is utilized in part by an actor that is using Smokeloader for a long\ntime.\n\nThe payload provided by our sample is using Smokloader’s FakeDNS and DDoS plugins to\nattack trezor.io (the site of a cryptocurrency hardware wallet product). The former causes the\nredirection of the site on a victim’s host to the IP 31.210.170[.]195, which seems to look like\na fake website mimicking the original trezor.io.\n\n\n-----\n\n[Trezor fake website main page]\n\nOther than that, the new variant of Smokeloader is downloading one more malware from the\nurl: fileboard[.]live/upd.exe.\n\nThis downloaded payload (D83F3025BA5B41775423A456BC4C19EF) turns out to be the\nAzorult infostealer, which in turn communicates to a URL under the same domain –\n**_fileboard[.]live/index.php._**\n\nThe campaign described above is connected to an actor we previously witnessed using\nSmokeloader, which was involved in several notorious campaigns. Those included a mass\ncampaign spreading Amadey Loader\n(8b1b2dee404f274e90bd87ff6983d2162abee16c4d9868a10b802bd9bcbdbec6), the\nAveMaria info stealer\n(88c47899f49dd25e5799fdcf892b990320c645475b612ac5324e635e2acf89dd) and most\ninterestingly ServHelper – a backdoor vastly used by TA505\n(20dd61fae49972323bb9c38a46ca4c93). The latter may suggest that in reality, the actor\nusing this new variant is in fact TA505.\n\nOur attribution to this actor is based on three clues that we were able to obtain from\ninvestigating the current campaign:\n\n1. Usage of a similar format for C2 domain names – (e.g. protest-0124.tk vs. protest\n01242505.tk in former activities)\n2. Usage of the same RC4 keys for encrypting communication and decrypting headers –\n\nthese keys are 0xaf03e678 and 0x78821544.\n\n\n-----\n\n3. No presence of an advertisement for the new version of the malware in the\n\nunderground forums in which it is sold. We believe this may indicate that so far the\nseller is distributing the new variant among known buyers so as to test and evaluate its\nquality, before another stable release.\n\nWe will keep monitoring Smokeloader’s development and threat actor activity and intend to\nupdate on any new variants of the malware as soon as they emerge in the wild.\n\nCheck Point protects against all variants of Smokeloader, both of previous versions and the\none described in this publication.\n\nThe relevant protections carry the names Smokeloader.TC.* and TrojanDownloader.Win32.Smokeloader.TC.*\n\n**IOCs**\n\n**MD5s**\n\n5FC6F24D43BC7CA45A81D159291955D1 – New Smokeloader variant\n20DD61FAE49972323BB9C38A46CA4C93 – ServHelper\nE7680155F86AEAC74B65DA38143F7E9F – Ave Maria Info Stealer\nAF93FD5C7810669D125EC9B0D6E28509 – Amadey Loader\n\n**Smokeloader C2s:**\n\nhxxp://protest-01242505[.]tk/\nhxxp://test-service012505[.]ru.com/\nhxxp://test-service012505[.]pw/\nhxxp://test-service012505[.]com/\nhxxp://test-service012505[.]site/\nhxxp://test-service012505[.]store/\nhxxp://test-service01242505[.]ru/\nhxxp://mytest-service012505[.]ru/\nhxxp://test-service012505[.]su/\nhxxp://test-service012505[.]info/\nhxxp://test-service012505[.]net/\nhxxp://test-service012505[.]tech/\nhxxp://test-service012505[.]online/\nhxxp://rutest-service012505[.]ru/\nhxxp://test-service01dom2505[.]ru/\nhxxp://test-service012505[.]website/\nhxxp://test-service012505[.]xyz/\nhxxp://test-service01pro2505[.]ru/\nhxxp://test-service01rus2505[.]ru/\nhxxp://test-service012505[ ]eu/\n\n\n-----\n\nhxxp://test-service012505[.]press/\nhxxp://protest-service012505[.]ru/\nhxxp://rustest-service012505[.]ru/\nhxxp://test-service012505[.]net2505[.]ru/\nhxxp://test-service012505[.]space/\nhxxp://domtest-service012505[.]ru/\nhxxp://mirtest-service012505[.]ru/\nhxxp://test-service012505[.]org2505[.]ru/\nhxxp://test-service012505[.]pp2505[.]ru/\nhxxp://test-service012505[.]pro/\nhxxp://test-service012505[.]host/\nhxxp://test-service012505[.]fun/\nhxxp://mostest-service012505[.]ru/\nhxxp://toptest-service012505[.]ru/\nhxxp://alltest-service012505[.]ru/\nhxxp://vsetest-service012505[.]ru/\nhxxp://newtest-service012505[.]ru/\nhxxp://biotest-service012505[.]ru/\nhxxp://test-service01shop2505[.]ru/\nhxxp://test-service01info2505[.]ru/\nhxxp://test-service01plus2505[.]ru/\nhxxp://test-service01club2505[.]ru/\nhxxp://test-service01torg2505[.]ru/\nhxxp://test-service01land2505[.]ru/\nhxxp://test-service01life2505[.]ru/\nhxxp://test-service01blog2505[.]ru/\nhxxp://megatest-service012505[.]ru/\nhxxp://infotest-service012505[.]ru/\nhxxp://besttest-service012505[.]ru/\nhxxp://shoptest-service012505[.]ru/\nhxxp://kupitest-service012505[.]ru/\nhxxp://proftest-service012505[.]ru/\nhxxp://clubtest-service012505[.]ru/\nhxxp://mytest-service01242505[.]ru/\nhxxp://rutest-service01242505[.]ru/\nhxxp://test-service01stroy2505[.]ru/\nhxxp://test-service01forum2505[.]ru/\nhxxp://supertest-service012505[.]ru/\nhxxp://protest-service01242505[.]ru/\nhxxp://protest-01252505[.]ml/\nhxxp://protest-01262505[.]ga/\nhxxp://protest-01272505[.]cf/\n\n\n-----\n\nhxxp://protest-01282505[.]gq/\nhxxp://protest-01292505[.]com/\nhxxp://protest-01302505[.]net/\nhxxp://protest-01312505[.]org/\nhxxp://protest-01322505[.]biz/\nhxxp://protest-01332505[.]info/\nhxxp://protest-01342505[.]eu/\nhxxp://protest-01352505[.]nl/\nhxxp://protest-01362505[.]mobi/\nhxxp://protest-01372505[.]name/\nhxxp://protest-01382505[.]me/\nhxxp://protest-01392505[.]garden/\nhxxp://protest-01402505[.]art/\nhxxp://protest-01412505[.]band/\nhxxp://protest-01422505[.]bargains/\nhxxp://protest-01432505[.]bet/\nhxxp://protest-01442505[.]blue/\nhxxp://protest-01452505[.]business/\nhxxp://protest-01462505[.]casa/\nhxxp://protest-01472505[.]city/\nhxxp://protest-01482505[.]click/\nhxxp://protest-01492505[.]company/\nhxxp://protest-01502505[.]futbol/\nhxxp://protest-01512505[.]gallery/\nhxxp://protest-01522505[.]game/\nhxxp://protest-01532505[.]games/\nhxxp://protest-01542505[.]graphics/\nhxxp://protest-01552505[.]group/\nhxxp://protest-02252505[.]ml/\nhxxp://protest-02262505[.]ga/\nhxxp://protest-02272505[.]cf/\nhxxp://protest-02282505[.]gq/\nhxxp://protest-03252505[.]ml/\nhxxp://protest-03262505[.]ga/\nhxxp://protest-03272505[.]cf/\nhxxp://protest-03282505[.]gq/\nhxxp://protest-05242505[.]tk/\nhxxp://protest-06242505[.]tk/\n\n**Trezor fake website:**\nhxxp://31.210.170[.]195\n\n**AZORult IOCs:**\n\n\n-----\n\nhxxp://fileboard[.]live/index.php\nhxxp://fileboard[.]live/upd.exe\n\n**Smokeloader DropZones:**\n\nhxxp://vinomag.pw/nsis.exe\nhxxp://mypromo.online/parapara.exe\nhxxps://babolgum.icu/cobal.exe\n\n**Amadey IOCs:**\n\nskcalladhellormi.xyz\n\n**Ave Maria IOCs:**\n\nhxxps://paste.ee/r/2zmfq/0\n\n**ServHelper IOCs:**\n\nhxxp://esupdate.icu/js/s.php\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-07-09 - The 2019 Resurgence of Smokeloader.pdf"
    ],
    "report_names": [
        "2019-07-09 - The 2019 Resurgence of Smokeloader.pdf"
    ],
    "threat_actors": [
        {
            "id": "99cb4e5b-8071-4f9e-aa1d-45bfbb6197e3",
            "created_at": "2023-01-06T13:46:38.860754Z",
            "updated_at": "2025-03-27T02:00:02.937438Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "SectorJ04 Group",
                "Dudear",
                "G0092",
                "ATK103",
                "Hive0065",
                "Spandex Tempest",
                "GRACEFUL SPIDER",
                "GOLD TAHOE",
                "CHIMBORAZO",
                "SectorJ04"
            ],
            "source_name": "MISPGALAXY:TA505",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5e6b31a6-80e3-4e7d-8b0a-d94897ce9b59",
            "created_at": "2024-06-19T02:03:08.128175Z",
            "updated_at": "2025-03-27T02:05:17.400394Z",
            "deleted_at": null,
            "main_name": "GOLD TAHOE",
            "aliases": [
                "SectorJ04 ",
                "Spandex Tempest ",
                "TA505 ",
                "FIN11 "
            ],
            "source_name": "Secureworks:GOLD TAHOE",
            "tools": [
                " Cobalt Strike",
                " FlawedAmmy",
                " Get2",
                " GraceWire",
                " Malichus",
                " SDBbot",
                " ServHelper",
                " TrueBot",
                "Clop"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75d4d6a9-b5d1-4087-a7a0-e4a9587c45f4",
            "created_at": "2022-10-25T15:50:23.5188Z",
            "updated_at": "2025-03-27T02:00:55.489882Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "TA505",
                "Hive0065",
                "Spandex Tempest",
                "CHIMBORAZO"
            ],
            "source_name": "MITRE:TA505",
            "tools": [
                "AdFind",
                "Azorult",
                "FlawedAmmyy",
                "Mimikatz",
                "Dridex",
                "TrickBot",
                "Get2",
                "FlawedGrace",
                "Cobalt Strike",
                "ServHelper",
                "Amadey",
                "SDBbot",
                "PowerSploit"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e447d393-c259-46e2-9932-19be2ba67149",
            "created_at": "2022-10-25T16:07:24.28282Z",
            "updated_at": "2025-03-27T02:02:10.159466Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "ATK 103",
                "Chimborazo",
                "Gold Evergreen",
                "Gold Tahoe",
                "Graceful Spider",
                "Hive0065",
                "Operation Tovar",
                "Operation Trident Breach",
                "SectorJ04",
                "Spandex Tempest",
                "TA505",
                "TEMP.Warlock"
            ],
            "source_name": "ETDA:TA505",
            "tools": [
                "Amadey",
                "AmmyyRAT",
                "AndroMut",
                "Azer",
                "Bart",
                "Bugat v5",
                "CryptFile2",
                "CryptoLocker",
                "CryptoMix",
                "CryptoShield",
                "Dridex",
                "Dudear",
                "EmailStealer",
                "FRIENDSPEAK",
                "Fake Globe",
                "Fareit",
                "FlawedAmmyy",
                "FlawedGrace",
                "FlowerPippi",
                "GOZ",
                "GameOver Zeus",
                "GazGolder",
                "Gelup",
                "Get2",
                "GetandGo",
                "GlobeImposter",
                "Gorhax",
                "GraceWire",
                "Gussdoor",
                "Jaff",
                "Kasidet",
                "Kegotip",
                "Kneber",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Locky",
                "MINEBRIDGE",
                "MINEBRIDGE RAT",
                "MirrorBlast",
                "Neutrino Bot",
                "Neutrino Exploit Kit",
                "P2P Zeus",
                "Peer-to-Peer Zeus",
                "Philadelphia",
                "Philadephia Ransom",
                "Pony Loader",
                "Rakhni",
                "ReflectiveGnome",
                "Remote Manipulator System",
                "RockLoader",
                "RuRAT",
                "SDBbot",
                "ServHelper",
                "Shifu",
                "Siplog",
                "TeslaGun",
                "TiniMet",
                "TinyMet",
                "Trojan.Zbot",
                "Wsnpoem",
                "Zbot",
                "Zeta",
                "ZeuS",
                "Zeus"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535758,
    "ts_updated_at": 1743041737,
    "ts_creation_date": 1653704107,
    "ts_modification_date": 1653704107,
    "files": {
        "pdf": "https://archive.orkl.eu/5b232bc3d0b29ecc9c10e4f5bc8fdb0bbc9225c3.pdf",
        "text": "https://archive.orkl.eu/5b232bc3d0b29ecc9c10e4f5bc8fdb0bbc9225c3.txt",
        "img": "https://archive.orkl.eu/5b232bc3d0b29ecc9c10e4f5bc8fdb0bbc9225c3.jpg"
    }
}