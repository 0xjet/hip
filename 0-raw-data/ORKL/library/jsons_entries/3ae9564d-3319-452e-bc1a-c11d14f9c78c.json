{
    "id": "3ae9564d-3319-452e-bc1a-c11d14f9c78c",
    "created_at": "2023-01-12T15:06:05.99758Z",
    "updated_at": "2025-03-27T02:05:44.188439Z",
    "deleted_at": null,
    "sha1_hash": "67f6e77946bfd5bed97543d3f6fac165afb74ff8",
    "title": "2015-07-07 - Dyre Banking Trojan Exploits CVE-2015-0057",
    "authors": "",
    "file_creation_date": "2022-05-28T19:33:33Z",
    "file_modification_date": "2022-05-28T19:33:33Z",
    "file_size": 231631,
    "plain_text": "# Dyre Banking Trojan Exploits CVE-2015-0057\n\n**[fireeye.com/blog/threat-research/2015/07/dyre_banking_trojan.html](https://www.fireeye.com/blog/threat-research/2015/07/dyre_banking_trojan.html)**\n\nNew variants of the Dyre Banking Trojan are exploiting a patched vulnerability in Microsoft\nWindows (CVE-2015-0057). We first observed these new variants on June 17 -- more thanth\n[4 months after Microsoft released the patch (MS15-010).](https://technet.microsoft.com/en-us/library/security/ms15-010.aspx)\nCVE-2015-0057 is a Use-After-Free vulnerability that exists in the win32k.sys component of\nthe Windows Kernel which can be exploited to perform local privilege escalation. The\nvulnerability was reported to Microsoft by Udi Yavo, and, after the patch was released, Udi\n[authored a short blog describing a few details of the vulnerability. However, it is important to](http://breakingmalware.com/vulnerabilities/one-bit-rule-bypassing-windows-10-protections-using-single-bit/)\nnote that the exploit code for CVE-2015-0057 has not yet been made public.\n\n\n-----\n\nIn addition to this, these new variants of Dyre also include an exploit for CVE-2013-3660 as a\nfallback in case the system is patched for CVE-2015-0057.\n\n**Initial Validation**\n\nInitally, the malware first checks its privilege level. If it already has administrator rights, it\ndecrypts the embedded resource FILE1 using a single byte XOR decryption. The decrypted\nbinary is then written to the file system and executed.\n\nIf the malware does not have administrator rights, it proceeds to perform the following\nsequence:\n\n1. If the NT version is 5.x (Windows XP/Windows 2000/Windows 2003), it scans the\nfollowing registry paths for the pattern \"3036220\":\n\nSOFTWARE\\Microsoft\\Updates\\Windows XP\\SP0\n\nSOFTWARE\\Microsoft\\Updates\\Windows XP\\SP10\n\nSOFTWARE\\Microsoft\\Updates\\Windows XP\\SP3\n\nSOFTWARE\\Microsoft\\Updates\\Windows XP\\SP4\n\n\n-----\n\nThis pattern is used to detect if the Microsoft Update (KB3036220 or MS-15-010) is installed\nand thus CVE-2015-0057 is patched. In this case, Dyre checks if  CVE-2013-3660 is\npatched as well by scanning the registry for the pattern: \"KB2850851\" which corresponds to\nthe security update for CVE-2013-3660. It looks for this pattern in the same registry paths as\nmentioned above. If it is not patched, then the exploit code corresponding to CVE-2013-3660\nis used for escalation of privileges.\n\n2. If the NT version is 6.0 or 6.1 (Windows Vista/Windows 7/Windows Server 2008), then it\nproceeds to scan the following path in the registry for the pattern \"3036220\":\n\nSOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Component Based Servicing\\Packages.\n\nNow, let us discuss in depth how this binary exploits the vulnerability from CVE-2015-0057.\n\n**Exploitation of CVE-2015-0057**\n\nThe main vulnerability is in the function: win32k!xxxEnableWndSBArrows which is used to\nmanage the Window scroll bars. The vulnerable code in xxxEnableWndSBArrows modifies\nthe cEntries field of a previously allocated tagPROPLIST structure which is used by the\nexploit to modify other critical data structures.\n\nBelow are the steps used by Dyre to exploit the use-after-free vulnerability present in\nwin32k!xxxEnableWndSBArrows:\n\n1. Allocate large numbers of contiguous kernel memory by calling the routine\nwin32k!CreateProp (to create tagPROPLIST structure of a particular size).\n\n2. Free some tagPROPLIST structures selectively, to create memory holes for the vulnerable\nstructure to fall into.\n\n3. Allocate SBINFO structure by calling the routine win32k!_InitPwSB. tagPROPLIST size\ncan be controlled from user mode.\n\nAn attacker would set the size of allocated tagPROPLIST to the size of SBINFO. After calling\n_InitPwSB, an SBINFO structure will fall into one of the holes in memory created in step 2.\n\n4. Within the function, win32k!xxxEnableWndSBArrows, the routine xxxDrawScrollBar\ninitiates a user mode callback.\n\na) In the process of the user mode callback (USER32!__ClientLoadLibrary), the attacker\ndestroys the window, which frees a block of memory.\n\nb) Before returning to xxxEnableWndSBArrows (in kernel mode), the attacker will invoke\nwin32k!NtUserSetProp (in user mode). This action will occupy the kernel memory previously\nfreed with a new tagPROPLIST structure, replacing the previously allocated SBINFO\nstructure.\n\n\n-----\n\n5. When the user mode callback returns to the kernel, the routine\nwin32k!xxxEnableWndSBArrows will cause a modification (OR Instruction) of the\ntagPROPLIST.cEntries field. This will increase the size of the tagPROPLIST.aprop array. The\nmain vulnerability is present here which is used by the exploit in the next steps.\n\nFigure 1 shows the modification of cEntries field of tagPROPLIST structure in\nwin32k!xxxEnableWndSBArrows:\n\nFigure 1: Modification of tagPROPLIST.cEntries field\n\n6. Using this corrupted tagPROPLIST object, an attacker is able to achieve arbitrary relative\nmemory writes. This primitive enables the exploit to overwrite a value within a critical GDI\nobject.\n\n7. Lastly, the attacker calls a function in win32k.sys which uses the above corrupted GDI\nobject and this results in arbitrary memory write of absolute addresses.\n\n8. The attacker is then able to modify a kernel function pointer to point to his shellcode\nbuffer in user mode, leading to escalation of privileges.\n\nFigure 2 summarizes the use-after-free memory overwrite and the sequence of arbitrary\nmemory writes:\n\n\n-----\n\nFigure 2: Sequence of Arbitrary Memory Writes\n\nThe technique used to redirect control flow to user mode shellcode and escalate the\nprivileges is as follows:\n\n1. HalDispatchTable+0x4 will be overwritten by the exploit as mentioned in step 7 above.\n\nFigure 3 shows the exact point when HalDispatchTable+0x4 is overwritten with the address\nof user mode shellcode.\n\nFigure 3: HalDispatchTable+0x4 Overwrite and User Mode Shellcode\n\n2. From user mode, it calls the API, ZwQueryIntervalProfile. In kernel mode, this transfers\ncontrol to HalDispatchTable+x04. Since the value at this location is overwritten with user\nmode shellcode, the control is transferred to privilege escalation shellcode.\n\nThis shellcode uses the standard method of copying the token field of the EPROCESS\nstructure of the SYSTEM process and storing it in the EPROCESS structure of the target\nprocess. The following steps describe this technique:\n\n1. Call PsLookupProcessByProcessId to get the pointer to EPROCESS structures of both\nvictim process and SYSTEM process.\n\n2. Call PsReferencePrimaryToken to get the token of both the processes.\n\n3. Iterate over the EPROCESS structure of victim process to find the offset where token is\nstored.\n\n4. Store the SYSTEM process token at that offset to escalate its privileges.\n\n\n-----\n\nSimilar shellcode was used in this binary for exploiting CVE-2013-3660 (used only if security\nupdate for CVE-2015-0057 is installed) however, we observed the following differences\nwhich indicate that these exploits were most likely written by 2 different authors or re-used\nfrom elsewhere.\n\n**CVE-2015-0057:**\n\nIt fetches the EPROCESS structure of SYSTEM process using\nPsLookUpProcessByProcessId.\n\nIt uses an iteration counter of 0x200 to scan the EPROCESS structure for offset of token.\n\n**CVE-2013-3660:**\n\nIt fetches the EPROCESS structure of SYSTEM process using PsInitialSystemProcess.\n\nIt uses an iteration counter of 0x300 to scan the EPROCESS structure for offset of token.\n\n**Kernel Mode Protections**\n\nIt is important to note that this exploit does not bypass SMEP since it performs a user mode\ncallback from kernel mode as described above. So, Windows 8.1 is not impacted by it.\n\nFor users of Win NT 5.x, Win NT 6.0 and Win NT 6.1, they are advised to install the update\nKB3036220 since this exploit is in the wild now.\n\n**Indicators of this Exploit Technique in User Mode**\n\nBelow are some of the indicators of this exploit in user mode:\n\n1. A Long sequence of calls to SetPropA/RemovePropA APIs.\n\n2. Creation of an array of Windows in a loop and setting the Property list of each Window\nusing SetPropA.\n\n3. Destroying few windows from the above created array to create holes.\n\n4. Calling EnableScrollBar with the parameters as shown below:\n\nEnableScrollBar(hWnd, SB_BOTH, ESB_DISABLE_BOTH);\n\n5. Calling ZwQueryIntervalProfile to perform the actual privilege escalation.\n\n**Conclusion**\n\nThe inclusion of this most recent privilege escalation exploit in the code of Dyre indicates the\nsophistication of the malware authors of banking trojans.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-07-07 - Dyre Banking Trojan Exploits CVE-2015-0057.pdf"
    ],
    "report_names": [
        "2015-07-07 - Dyre Banking Trojan Exploits CVE-2015-0057.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535965,
    "ts_updated_at": 1743041144,
    "ts_creation_date": 1653766413,
    "ts_modification_date": 1653766413,
    "files": {
        "pdf": "https://archive.orkl.eu/67f6e77946bfd5bed97543d3f6fac165afb74ff8.pdf",
        "text": "https://archive.orkl.eu/67f6e77946bfd5bed97543d3f6fac165afb74ff8.txt",
        "img": "https://archive.orkl.eu/67f6e77946bfd5bed97543d3f6fac165afb74ff8.jpg"
    }
}