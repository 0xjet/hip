{
    "id": "80b7c08d-fc57-4194-b948-4354ef094753",
    "created_at": "2022-10-25T16:48:21.366784Z",
    "updated_at": "2025-03-27T02:17:22.882369Z",
    "deleted_at": null,
    "sha1_hash": "f577c784cc04ad513072b1b02e4d3c9f9399c10a",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-04-20T10:29:25Z",
    "file_modification_date": "2021-04-20T10:29:25Z",
    "file_size": 5219821,
    "plain_text": "# Lazarus APT conceals malicious code within BMP image to drop its RAT\n\n**blog.malwarebytes.com/malwarebytes-news/2021/04/lazarus-apt-conceals-malicious-code-within-bmp-file-to-**\ndrop-its-rat\n\nThreat Intelligence Team April 19, 2021\n\n_This blog was authored by Hossein Jazi_\n\nLazarus APT is one of the most sophisticated North Korean Threat Actors that has been\nactive since at least 2009. This actor is known to target the U.S., South Korea, Japan and\nseveral other countries. In one of their most recent campaigns Lazarus used a complex\n[targeted phishing attack against security researchers.](https://blog.google/threat-analysis-group/new-campaign-targeting-security-researchers/)\n\nLazarus is known to employ new techniques and custom toolsets in its operations to\n[increase the effectiveness of its attacks. On April 13, we identified a document used by this](https://app.any.run/tasks/3208d567-82d9-4be3-8afc-3f87e3237e83/#)\nactor to target South Korea. In this campaign, Lazarus resorted to an interesting\ntechnique of BMP files embedded with malicious HTA objects to drop its Loader.\n\n## Process Graph\n\nThis attack likely started by distributing phishing emails that were weaponized with a\nmalicious document. The following figure shows the overall process of this attack. In the\nnext sections, we provide the detailed analysis of this process.\n\n\n-----\n\nFigure 1: Process graph\n\n## Document Analysis\n\nOpening the document shows a blue theme in Korean that asks the user to enable the\nmacro to view the document.\n\nFigure 2: Blue theme\n\nUpon enabling the macro, a message box will pop up and after clicking the final lure will\nbe loaded.\n\n\n-----\n\nFigure 3: Lure form\n\nThe document name is in Korean “참가신청서양식.doc” and it is a participation application\nform for a fair in one of the South Korean cities. The document creation time is 31 March\n2021 which indicates that the attack happened around the same time.\n\nThe document has been weaponized with a macro that is executed upon opening.\n\nFigure 4: Macro\n\n\n-----\n\nThe macro starts by calling MsgBoxOKCancel function. This function pops up a message\nbox to the user with a message claiming to be an older version of Microsoft Office. After\nshowing the message box, it performs the following steps:\n\nFigure 5: Document_Open\n\nDefines the required variables such as WMI object, Mshta and file extension in\nbase64 format and then calls Decode function to base64 decode them.\nGets the active document name and separates the name from extension\nCreates a copy of the active document in HTML format using\n_ActiveDocument.SaveAs with wDFormatHTML as parameter. Saving document as_\nHTML will store all the images within this document in FILENAME_files directory.\n\n\n-----\n\nFigure 6: SaveAs HTML\n\nCalls show function to makes document protected. By making document protected\nit makes sure users can not make any changes to the document.\n\nFigure 7: Protect the document\n\nGets the image file that has an embedded zlib object. (image003.png)\nConverts the image in PNG format into BMP format by calling WIA_ConvertImage.\nSince the BMP file format is uncompressed graphics file format, converting a PNG\nfile format into BMP file format automatically decompresses the malicious zlib\nobject embedded from PNG to BMP. This is a clever method used by the actor to\nbypass security mechanisms that can detect embedded objects within images. The\nreason is because the document contains a PNG image that has a compressed zlib\nmalicious object and since it’s compressed it can not be detected by static detections.\nThen the threat actor just used a simple conversion mechanism to decompress the\nmalicious content.\n\nFigure 8: Embedded objects within png and bmp file\n\n\n-----\n\nFigure 9: Embedded hta file within bmp\n\nGets a WMI object to call Mshta to execute the bmp file. The BMP file after\ndecompression contains a HTA file which executes Java Script to drop a payload.\nDeletes all the images in the directory and then removes the directory generated by\nthe SaveAs function.\n\n## BMP file analysis (image003.zip)\n\nThe macro added the extension zip to the BMP file during the image conversion process to\npretend it’s a zip file. This BMP file has an embedded HTA file. This HTA contains a\nJavaScript that creates “AppStore.exe” in the “C:\\Users\\Public\\Libraries\\AppStore.exe”\ndirectory and then populates its content.\n\nAt the start, it defines an array that contains the list of the functions and parameters\nrequired by the script: OpenTextFile, CreateTextFile, Close, Write, FromCharCode,\n_“C:/Users/Public/Libraries/AppStore.exe” and some junk values. When the script wants_\nto perform an action, it calls a second function with a hex value that is responsible for\nbuilding an index to retrieve the required value from the first array.\n\nFor example, at the first step it calls the second function with 0x1dd value. This function\nsubtracts 0x1dc from 0x1dd to get the index for the first array which would be 1. Then it\nuses this index to retrieve the first element of the first array which would be\n_“C:/Users/Public/Libraries/AppStore.exe”. Following the same process, it calls_\n_CreateTextFile to create AppStore.exe and then writes MZ into it. Then it converts the_\ndata in decimal format to string by calling fromCharCode function and uses the same\nprocedure it writes them into the AppStore.exe. At the end it calls Wscript.Run to execute\nthe dropped payload.\n\n\n-----\n\nFigure 10: Embedded HTA object\n\n## Payload analysis (AppStore.exe)\n\n_AppStore.exe loads a base64 encrypted payload that has been added to the end of itself._\nBefore the payload there is a string which is the decryption key (by7mJSoKVDaWg*Ub).\n\n\n-----\n\nFigure 11: Embedded payload\n\nTo decrypt the second stage payload, at first it writes itself into a buffer created by\nVirtualAlloc and then looks for the encrypted payload and copies it into another buffer.\n\n\n-----\n\nFigure 12: Allocate memory\n\nIn the next step, it has implemented its own base64 decoder to decode the allocated buffer\nand write it into another buffer using memset and memmove. At the end, this encoded\npayload gets decrypted via XOR using hardcoded decryption key to generate the second\nstage payload.\n\n\n-----\n\nFigure 13: XOR decryption\n\nAfter the decryption process has finished, it jumps to the start address of the second\npayload to execute it.\n\n## Second stage payload Analysis\n\nThis payload is loaded into memory by AppStore.exe and has not been written to disk. It\nstarts by performing an initialization process which includes the following steps:\n\n\n-----\n\nFigure 14: Initialization process\n\nCreate Mutex: Checks if a mutex with “Microsoft32” name exist on machine or not\nand if it exists, it exits. Otherwise, It means the machine has not been infected with\nthis RAT and it starts its malicious activities.\nResolve API calls: All important API calls have been base64 encoded and RC4\nencrypted which will be decoded and decrypted at run time. The key for RC4\ndecryption is “MicrosoftCorporationValidation@#$%^&*()!US”.\n\n\n-----\n\n-----\n\nFigure 15: API resolver\n\nMakes HTTP requests to command and control servers: The server addresses have\nbeen base64 encoded and encrypted using a custom encryption algorithm. You can\n[find the decoder/decryptor here. This custom encryption algorithm is similar to the](https://github.com/hackOtack/Malware/blob/main/lazerous_string_decoder.cpp)\nencryption algorithm used by BISTROMATH RAT associated to Lazarus reported by\n[US-CERT.](https://us-cert.cisa.gov/ncas/analysis-reports/ar20-045a)\n\nFigure 16: Custom decryption algorithm\n\n_http://mail.namusoft.kr/jsp/user/eam/board.jsp_\n\n_http://www.jinjinpig.co.kr/Anyboard/skin/board.php_\n\nAfter the initialization process has finished, it checks if the communications to C&C\nservers were successful or not and if they were successful it goes to the next step in which\nit receives the commands from the server and performs different actions based on the\ncommands.\n\nThe commands received from the C&C are base64 encoded and encrypted using its\ncustom encryption algorithm (Figure 16). After deobfuscation, it performs the following\ncommands based on the command codes. The communications to the server have been\ndone through send and recv socket functions.\n\n8888: It tries to execute the command it has received after command code in two\ndifferent ways. At first it tries to execute the command by creating a new thread\n(Figure 17). This thread gets the command after command code and executes it\nusing cmd.exe. This process has been done through using CreatePipe and\nCreateProcessA. Then it uses ReadFile to read the output of cmd.exe.\n\n\n-----\n\nFigure 17: Create thread\n\nOutput of cmd.exe has been encoded and encrypted and is sent to the server as test.gif\nusing an HTTP POST request (Figure 18).\n\n\n-----\n\n-----\n\nFigure 18: Send the output of cmd.exe as test.gif\n\nIf the CreateThread process was not successful, it executes the command by calling\n_WinExec and then sends the “”8888 Success!” message after encrypting it using its_\ncustom encryption and then encoding it using base64 to the server as test.gif.\n\nFigure 19: WinExec\n\n1234: It calls CreateThread to execute the buffer(third stage payload) it received\nfrom the server. At the end it encodes and encrypts “1234 Success!” and sends it to\nthe server as test.gif.\n2099: It creates a batch file and executes it and then exits. This batch file deletes the\n_AppStore.exe from the victim’s machine._\n\n\n-----\n\nFigure 20: Creates batch file\n\n8877: It stores the buffer received from server in a file.\n1111: It calls The shutdown function to disables sends or receives on a socket.\n\nThis second stage payload has used custom encoded user agents for its communications.\nAll of these user agents have been base64 encoded and encrypted using the same custom\nencryption algorithm used to encrypt the server addresses. Here is the list of the different\nuser agents used by this RAT.\n```\nMozilla/%d.0 (compatible; MSIE %d.0; Windows NT %d.%d; WOW64; Trident/%d.0;\nInfopath.%d)\nMozilla/18463680.0 (compatible; MSIE -641.0; Windows NT 1617946400.-858993460;\nWOW64; Trident/-858993460.0; Infopath.-858993460)\nMozilla/18463680.0 (compatible; MSIE -641.0; Windows NT 1617946400.-858993460;\nTrident/-858993460.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR\n3.0.30729; Media Center PC 6.0; Infopath.-858993460)\nMozilla/%d.0 (Windows NT %d.%d%s) AppleWebKit/537.%d (KHTML, like Gecko)\nChrome/%d.0.%d.%d Safari/%d.%d Infopath.%d\n\n## Attribution\n\n```\nThere are several similarities between this attack and past Lazarus operations and we\nbelieve these are strong indicators to attribute this attack to the Lazarus threat actor.\n\n\n-----\n\nThe second stage payload has used the similar custom encryption algorithm that has\nbeen used by BISTROMATH RAT associated to this APT.\nThe second stage payload has used a combination of base64 and RC4 for data\nobfuscation which is a common technique used by this APT.\nThe second stage payload used in this attack has some code similarities with some of\nknown Lazarus malware families including Destover.\nSending data and messages as a GIF to a server has been observed in past Lazarus\n[operations including AppleJeus,](https://securelist.com/operation-applejeus/87553/) _[Supply Chain attack against South Korea and the](https://www.welivesecurity.com/2020/11/16/lazarus-supply-chain-attack-south-korea/)_\n[DreamJob operation.](https://blogs.jpcert.or.jp/en/2021/01/Lazarus_malware2.html)\nThis phishing attack has targeted South Korea which is one of the main targets of\nthis actor.\nThe group is known to use Mshta.exe to run malicious scripts and download\nprograms which is similar to what has been used in this attack.\n\n## Conclusion\n\nThe Lazarus threat actor is one of the most active and sophisticated North Korean threat\nactors that has targeted several countries including South Korea, the U.S. and Japan in\nthe past couple of years. The group is known to develop custom malware families and use\nnew techniques in its operations. In this blog we documented a spear phishing attack\noperated by this APT group that has targeted South Korea.\n\nThe actor has used a clever method to bypass security mechanisms in which it has\nembedded its malicious HTA file as a compressed zlib file within a PNG file that then has\nbeen decompressed during run time by converting itself to the BMP format. The dropped\npayload was a loader that decoded and decrypted the second stage payload into memory.\nThe second stage payload has the capability to receive and execute commands/shellcode\nas well as perform exfiltration and communications to a command and control server.\n\n### Indicators of Compromise\n\n\n-----\n\n**Document**\n\nF1EED93E555A0A33C7FEF74084A6F8D06A92079E9F57114F523353D877226D72\n\n**Dropped executable**\n\nED5FBEFD61A72EC9F8A5EBD7FA7BCD632EC55F04BDD4A4E24686EDCCB0268E05\n\n**Command and control servers**\n\njinjinpig[.]co[.]kr\n\nmail[.]namusoft[.]kr\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2021/2021.04.19.Lazarus_APT_conceals_malicious_code_within_BMP_image_to_drop_its_RAT/2021.04.19.Lazarus_APT_conceals_malicious_code_within_BMP_image_to_drop_its_RAT.pdf"
    ],
    "report_names": [
        "2021.04.19.Lazarus_APT_conceals_malicious_code_within_BMP_image_to_drop_its_RAT"
    ],
    "threat_actors": [
        {
            "id": "a2b92056-9378-4749-926b-7e10c4500dac",
            "created_at": "2023-01-06T13:46:38.430595Z",
            "updated_at": "2025-03-27T02:00:02.831633Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Operation DarkSeoul",
                "APT38",
                "ATK117",
                "DEV-1222",
                "G0032",
                "APT 38",
                "Stardust Chollima",
                "APT-C-26",
                "ATK3",
                "Diamond Sleet",
                "Hidden Cobra",
                "Unit 121",
                "Subgroup: Bluenoroff",
                "NICKEL GLADSTONE",
                "DEV-0139",
                "Andariel",
                "Operation Troy",
                "COVELLITE",
                "TA404",
                "Lazarus group",
                "Dark Seoul",
                "G0082",
                "NewRomanic Cyber Army Team",
                "Bluenoroff",
                "Appleworm",
                "Nickel Academy",
                "COPERNICIUM",
                "Hastati Group",
                "Bureau 121",
                "Operation AppleJeus",
                "Whois Hacking Team",
                "Citrine Sleet",
                "Sapphire Sleet",
                "Group 77",
                "Labyrinth Chollima",
                "Operation GhostSecret",
                "BeagleBoyz"
            ],
            "source_name": "MISPGALAXY:Lazarus Group",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f32df445-9fb4-4234-99e0-3561f6498e4e",
            "created_at": "2022-10-25T16:07:23.756373Z",
            "updated_at": "2025-03-27T02:02:09.966155Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "APT-C-26",
                "ATK 3",
                "Appleworm",
                "Citrine Sleet",
                "DEV-0139",
                "Diamond Sleet",
                "Gleaming Pisces",
                "Gods Apostles",
                "Gods Disciples",
                "Group 77",
                "Guardians of Peace",
                "Hastati Group",
                "Hidden Cobra",
                "ITG03",
                "Jade Sleet",
                "Labyrinth Chollima",
                "Lazarus Group",
                "NewRomanic Cyber Army Team",
                "Operation 99",
                "Operation AppleJeus",
                "Operation AppleJeus sequel",
                "Operation Blockbuster: Breach of Sony Pictures Entertainment",
                "Operation CryptoCore",
                "Operation Dream Job",
                "Operation Dream Magic",
                "Operation Flame",
                "Operation GhostSecret",
                "Operation In(ter)caption",
                "Operation LolZarus",
                "Operation Marstech Mayhem",
                "Operation No Pineapple!",
                "Operation North Star",
                "Operation Phantom Circuit",
                "Operation Sharpshooter",
                "Operation Ten Days of Rain / DarkSeoul",
                "Operation Troy",
                "SectorA01",
                "Slow Pisces",
                "TA404",
                "TraderTraitor",
                "UNC2970",
                "UNC4034",
                "UNC4736",
                "UNC4899",
                "UNC577",
                "Whois Hacking Team"
            ],
            "source_name": "ETDA:Lazarus Group",
            "tools": [
                "3CX Backdoor",
                "3Rat Client",
                "3proxy",
                "AIRDRY",
                "ARTFULPIE",
                "ATMDtrack",
                "AlphaNC",
                "Alreay",
                "Andaratm",
                "AngryRebel",
                "AppleJeus",
                "Aryan",
                "AuditCred",
                "BADCALL",
                "BISTROMATH",
                "BLINDINGCAN",
                "BTC Changer",
                "BUFFETLINE",
                "BanSwift",
                "Bankshot",
                "Bitrep",
                "Bitsran",
                "BlindToad",
                "Bookcode",
                "BootWreck",
                "BottomLoader",
                "Brambul",
                "BravoNC",
                "Breut",
                "COLDCAT",
                "COPPERHEDGE",
                "CROWDEDFLOUNDER",
                "Castov",
                "CheeseTray",
                "CleanToad",
                "ClientTraficForwarder",
                "CollectionRAT",
                "Concealment Troy",
                "Contopee",
                "CookieTime",
                "Cyruslish",
                "DAVESHELL",
                "DBLL Dropper",
                "DLRAT",
                "DRATzarus",
                "DRATzarus RAT",
                "Dacls",
                "Dacls RAT",
                "DarkComet",
                "DarkKomet",
                "DeltaCharlie",
                "DeltaNC",
                "Dembr",
                "Destover",
                "DoublePulsar",
                "Dozer",
                "Dtrack",
                "Duuzer",
                "DyePack",
                "ECCENTRICBANDWAGON",
                "ELECTRICFISH",
                "Escad",
                "EternalBlue",
                "FALLCHILL",
                "FYNLOS",
                "FallChill RAT",
                "Farfli",
                "Fimlis",
                "FoggyBrass",
                "FudModule",
                "Fynloski",
                "Gh0st RAT",
                "Ghost RAT",
                "Gopuram",
                "HARDRAIN",
                "HIDDEN COBRA RAT/Worm",
                "HLOADER",
                "HOOKSHOT",
                "HOPLIGHT",
                "HOTCROISSANT",
                "HOTWAX",
                "HTTP Troy",
                "Hawup",
                "Hawup RAT",
                "Hermes",
                "HotCroissant",
                "HotelAlfa",
                "Hotwax",
                "HtDnDownLoader",
                "Http Dr0pper",
                "ICONICSTEALER",
                "Joanap",
                "Jokra",
                "KANDYKORN",
                "KEYMARBLE",
                "Kaos",
                "KillDisk",
                "KillMBR",
                "Koredos",
                "Krademok",
                "LIGHTSHIFT",
                "LIGHTSHOW",
                "LOLBAS",
                "LOLBins",
                "Lazarus",
                "LightlessCan",
                "Living off the Land",
                "MATA",
                "MBRkiller",
                "MagicRAT",
                "Manuscrypt",
                "Mimail",
                "Mimikatz",
                "Moudour",
                "Mydoom",
                "Mydoor",
                "Mytob",
                "NACHOCHEESE",
                "NachoCheese",
                "NestEgg",
                "NickelLoader",
                "NineRAT",
                "Novarg",
                "NukeSped",
                "OpBlockBuster",
                "PCRat",
                "PEBBLEDASH",
                "PLANKWALK",
                "POOLRAT",
                "PSLogger",
                "PhanDoor",
                "Plink",
                "PondRAT",
                "PowerBrace",
                "PowerRatankba",
                "PowerShell RAT",
                "PowerSpritz",
                "PowerTask",
                "Preft",
                "ProcDump",
                "Proxysvc",
                "PuTTY Link",
                "QUICKRIDE",
                "QUICKRIDE.POWER",
                "Quickcafe",
                "QuiteRAT",
                "R-C1",
                "ROptimizer",
                "Ratabanka",
                "RatabankaPOS",
                "Ratankba",
                "RatankbaPOS",
                "RawDisk",
                "RedShawl",
                "Rifdoor",
                "Rising Sun",
                "Romeo-CoreOne",
                "RomeoAlfa",
                "RomeoBravo",
                "RomeoCharlie",
                "RomeoCore",
                "RomeoDelta",
                "RomeoEcho",
                "RomeoFoxtrot",
                "RomeoGolf",
                "RomeoHotel",
                "RomeoMike",
                "RomeoNovember",
                "RomeoWhiskey",
                "Romeos",
                "RustBucket",
                "SHADYCAT",
                "SHARPKNOT",
                "SIGFLIP",
                "SIMPLESEA",
                "SLICKSHOES",
                "SORRYBRUTE",
                "SUDDENICON",
                "SUGARLOADER",
                "SheepRAT",
                "SierraAlfa",
                "SierraBravo",
                "SierraCharlie",
                "SierraJuliett-MikeOne",
                "SierraJuliett-MikeTwo",
                "SimpleTea",
                "SimplexTea",
                "SmallTiger",
                "Stunnel",
                "TAINTEDSCRIBE",
                "TAXHAUL",
                "TFlower",
                "TOUCHKEY",
                "TOUCHMOVE",
                "TOUCHSHIFT",
                "TOUCHSHOT",
                "TWOPENCE",
                "TYPEFRAME",
                "Tdrop",
                "Tdrop2",
                "ThreatNeedle",
                "Tiger RAT",
                "TigerRAT",
                "Trojan Manuscript",
                "Troy",
                "TroyRAT",
                "VEILEDSIGNAL",
                "VHD",
                "VHD Ransomware",
                "VIVACIOUSGIFT",
                "VSingle",
                "ValeforBeta",
                "Volgmer",
                "Vyveva",
                "W1_RAT",
                "Wana Decrypt0r",
                "WanaCry",
                "WanaCrypt",
                "WanaCrypt0r",
                "WannaCry",
                "WannaCrypt",
                "WannaCryptor",
                "WbBot",
                "Wcry",
                "Win32/KillDisk.NBB",
                "Win32/KillDisk.NBC",
                "Win32/KillDisk.NBD",
                "Win32/KillDisk.NBH",
                "Win32/KillDisk.NBI",
                "WinorDLL64",
                "Winsec",
                "WolfRAT",
                "Wormhole",
                "YamaBot",
                "Yort",
                "ZetaNile",
                "concealment_troy",
                "http_troy",
                "httpdr0pper",
                "httpdropper",
                "klovbot",
                "sRDI"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716501,
    "ts_updated_at": 1743041842,
    "ts_creation_date": 1618914565,
    "ts_modification_date": 1618914565,
    "files": {
        "pdf": "https://archive.orkl.eu/f577c784cc04ad513072b1b02e4d3c9f9399c10a.pdf",
        "text": "https://archive.orkl.eu/f577c784cc04ad513072b1b02e4d3c9f9399c10a.txt",
        "img": "https://archive.orkl.eu/f577c784cc04ad513072b1b02e4d3c9f9399c10a.jpg"
    }
}