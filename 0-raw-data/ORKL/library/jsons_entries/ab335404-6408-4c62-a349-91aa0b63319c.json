{
    "id": "ab335404-6408-4c62-a349-91aa0b63319c",
    "created_at": "2023-01-12T14:59:10.008783Z",
    "updated_at": "2025-03-27T02:05:42.346927Z",
    "deleted_at": null,
    "sha1_hash": "4a775657a5b0cb96f1745f46a649d77a68215855",
    "title": "2021-07-26 - OSX.XLoader hides little except its main purpose- What we learned in the installation process",
    "authors": "",
    "file_creation_date": "2022-05-28T17:59:39Z",
    "file_modification_date": "2022-05-28T17:59:39Z",
    "file_size": 199605,
    "plain_text": "# OSX.XLoader hides little except its main purpose: What we learned in the installation process\n\n**blog.malwarebytes.com/mac/2021/07/osx-xloader-hides-little-except-its-main-purpose-what-we-learned-in-the-**\ninstallation-process/\n\nThomas Reed July 26, 2021\n\nLast week, Check Point Research described a new Mac variant of malware they call\nXLoader. It was identified as being the successor of something called Formbook, a very\nprevalent threat in the Windows world. According to Check Point, the Mac version of the\nmalware is being “rented” as part of a malware-as-a-service program, at the price of $49 for\none month or $99 for three months.\n\nUnfortunately, Check Point was a bit vague on the details of how the Mac version behaves,\nleaving folks unsure of exactly how to protect themselves against this malware. Fortunately,\nmore details have since come to light.\n\n## How XLoader gets installed\n\nXLoader appears to be distributed within a .jar – or Java archive – file. Such a file contains\ncode that can be executed by Java, dropping the malware on the system. One major\nadvantage, for the attacker, of using Java is that the “dropper” (the file responsible for\ninstalling the malware) can be cross-platform.\n\n\n-----\n\nHowever, this file format has a very significant disadvantage for the attacker, which is that\nmacOS does not, by default, include Java, and has not for quite some time. Back around\n2011 to 2012, there was a flood of multiple different pieces of malware designed to infect\nMacs via vulnerabilities in Java, which at the time was installed on every Mac out of the box.\nThis meant that all Macs were vulnerable, and to make matters worse, despite updates from\nOracle (Java’s owner), more vulnerabilities kept being found and exploited.\n\nApple responded by ripping Java out of the system. Since then, the only way Java can be on\na system is if the user has installed it, which most users won’t. This means that Java is no\nlonger a very useful means of attack on modern macOS systems.\n\nThere can be a couple reasons why a JAR file might be used on macOS. One is unfamiliarity\nwith modern macOS, from a malware developer who has Java on their system but doesn’t\nunderstand this is non-standard for some reason. This is something often seen with more\namateurish malware, and there are definitely some indications of that with this malware.\n\nHowever, another reason is that the malware is targeted at specific individuals who are\nknown to have Java installed. These could be Java developers, for example, at a particular\ncompany, or perhaps employees at a company that uses Java-based tools. A source at\nESET reported that they had detected this malware back in January, with the JAR file being\ndistributed via email. This points to a targeted campaign.\n\n## The installation process\n\nThe dropper – named Statement SKBMT 09818.jar in this case – would need to be opened\nby the user. The good news is that, if it was downloaded from an email client or browser that\nuses modern file system code, it will be marked with a “quarantine” flag. This means that the\nGatekeeper feature of macOS will not allow it to execute by default.\n\nThere are ways that Mac users can bypass this and open the file anyway, but not without\nseeing a similar warning first.\n\n\n-----\n\nStill, a significant amount of Mac malware droppers in the last year or so have been\nunsigned, and have given users instructions on what to expect and how to open the file. In\nsuch cases, users can and do bypass these warnings and open the malicious installers\nsuccessfully.\n\nIn the event that the user downloads the JAR file using an email client that does not use the\nright file system code, and thus does not set a quarantine flag, the file will immediately open\nwhen double-clicked, without any complaints. The same will also be true if the file is copied\nonto a non-Mac drive before being opened, such as a Windows network share, where the\nquarantine flag will be lost.\n\nOnce opened, the JAR file will infect the system, and strangely, will also open a .ico (icon) file\ncontaining a Microsoft word icon image.\n\n\n-----\n\nIt s unknown why this is done. It s not uncommon for malware to open a decoy document.\nIn such cases, when the malware pretends to be a document (as in this case, where the\nmalware is pretending to be a statement of some kind), it will then open a document for the\nuser to look at, to assuage suspicions the user would have if no document ever opened,\nwhile it’s doing bad stuff behind the scenes.\n\nIs this a really badly botched attempt to open a decoy document? Or is it possible that this\nwasn’t meant as a public release, and the file being opened is a placeholder? Either would\nbe a reasonable explanation, but we don’t know which is true.\n\nWhile the user is looking in confusion at this wonderful icon, the JAR code will install the\nmalware in the background. On my test machine, the malware installed the following items:\n```\n~/._p1pxXl0Fz4/I8ppUnip.app\n~/kIbwf02l\n~/NVFFY.ico\n~/LaunchAgents/com._p1pxXl0Fz4.I8ppUnip.plist\n\n```\nThe launch agent .plist file is used to load the app from the hidden folder ( ._p1pxXl0Fz4 )\nfound in the user folder. The `kIbwf02l file is an exact copy of the Mac mach-o executable`\nfile found inside the app, but it’s unclear why this is left there, as it isn’t actually used. It’s a\nsuspiciously-named file that will be visible to the user and thus may raise suspicions, so its\npresence is odd.\n\nThe `NVFFY.ico file is the Microsoft Word icon file opened by the malware as a “decoy.”`\n\n## A closer look at the Java code\n\nExtracting the Java code from the JAR file was a painless task, and the code is not\nobfuscated in any way. The code is quite simple, but is able to drop a payload on either\nWindows or Mac. If you’re not interested in looking at code, feel free to skip ahead.\n\nThe filenames are hard-coded in the JAR file, as seen here.\n```\nprivate static String get_crypted_filename(final int pt) {\n  final String exe_ = \"fI4sWHkeeeee\";\n  final String mach_o = \"kIbwf02ldddd\";\n  final String display = \"NVFFYfffffff\";\n\n```\nIt’s a bit of a stretch to call these filenames “encrypted,” as the only thing that has been done\nto them is that a specific letter has been added to the end, repeating a varying number of\ntimes. (What letter is used depends on the string in question, and is also hard-coded.) These\ncharacters are stripped off to get the filenames, resulting in the mach-o filename of\n```\nkIbwf02l and the “display” document filename of NVFFY .\n\n```\nThe malware has quite simple code for determining the system it’s running on:\n\n\n-----\n\n```\npublic static int _GetOS() {\n  final String OS = System.getProperty(\"os.name\").toLowerCase();\n  if (OS.contains(\"mac\")) {\n    return 1;\n  }\n  if (OS.contains(\"win\")) {\n    return 2;\n  }\n  return 0;\n}\n\n```\nFrom there, the malware reads encrypted data from within the JAR file and writes it out to the\ndesired location on the system (in this case, the `kIbwf02l file).`\n```\nprivate byte[] getFileFromResource(final String name) throws Exception {\n  try (final InputStream in = this.getClass().getResourceAsStream(\"/resources/\" +\nname)) {\n    final byte[] data = new byte[16384];\n    final ByteArrayOutputStream buffer = new ByteArrayOutputStream();\n    int nRead;\n    while ((nRead = in.read(data, 0, data.length)) != -1) {\n      buffer.write(data, 0, nRead);\n    }\n    return buffer.toByteArray();\n  }\n}\n\n```\nFrom there, the malware launches the malicious process and opens the decoy document\n(aka “displayFile”).\n```\n    if (osFile != null && osFile.length != 0) {\n      final String absolutePath = userPath + osFilename + ((os == 1) ? \"\" :\n\".exe\");\n      stubClass.writeBufferToFile(decrpt_data(osFile), absolutePath);\n      if (os == 1) {\n        final File file = new File(absolutePath);\n        final Set<PosixFilePermission> perms = new\nHashSet<PosixFilePermission>();\n        perms.add(PosixFilePermission.OWNER_READ);\n        perms.add(PosixFilePermission.OWNER_WRITE);\n        perms.add(PosixFilePermission.OWNER_EXECUTE);\n        Files.setPosixFilePermissions(file.toPath(), perms);\n      }\n      processBuilder.command(absolutePath);\n      processBuilder.start();\n    }\n    final byte[] displayFile = stubClass.getFileFromResource(displayFilename);\n    if (displayFile != null && displayFile.length != 0) {\n      final String absolutePath2 = userPath + displayFilename +\ngetDisplayExt();\n      stubClass.writeBufferToFile(decrpt_data(displayFile), absolutePath2);\n      final File f = new File(absolutePath2);\n      Desktop.getDesktop().open(f);\n    }\n\n```\n\n-----\n\n## The malicious application\n\nThe malicious Mac application, dropped and executed by the JAR file, is heavily obfuscated,\n[making it hard to learn more about what it does. According to analysis done by SentinelOne,](https://www.sentinelone.com/blog/detecting-xloader-a-macos-malware-as-a-service-info-stealer-and-keylogger/)\none of the app’s main goals appears to be harvesting credentials.\n\nThe app itself is not code signed in any way. However, since it was created by the JAR and\nnot downloaded from anywhere, it can be executed without Gatekeeper examining it or\nasking for user consent to run it. The launch agent .plist file is used to ensure the app is\nlaunched at startup, but explicitly does not try to keep the process alive. This means that if\nanything terminates the malicious process, it will not re-open until the next reboot.\n\nThe app itself has been marked as an LSUIElement, which is done to prevent its icon from\nshowing on the Dock whenever it is running. This is a feature intended to be used by apps\nresponsible for managing some user interface element – such as a menu bar icon – but that\ndo not have a user interface of their own and thus can’t be interacted with directly. This\nprevents the Dock from being littered with these kinds of apps, but is a common technique\nused to prevent malicious apps from appearing in the Dock.\n\n## TL;DR\n\nTo sum up, this malware is likely to be used for targeted attacks against intended victims who\nare known to have Java installed. Attackers may also have knowledge that something in the\nvictims’ environment will enable users to easily open a JAR file without being blocked by\nGatekeeper.\n\nThe dropper itself is completely unsophisticated, with barely an attempt to hide anything,\nwhile the mach-o executable used in the malicious application installed on the system is\nquite well protected against prying eyes. This may be an indication that the two components\nof the malware were developed by different individuals.\n\nThis malware will be detected by Malwarebytes for Mac as OSX.XLoader. However, as of\nyet, data shows that Malwarebytes has not detected a single instance of this malware in the\nwild.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-26 - OSX.XLoader hides little except its main purpose- What we learned in the installation process.pdf"
    ],
    "report_names": [
        "2021-07-26 - OSX.XLoader hides little except its main purpose- What we learned in the installation process.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535550,
    "ts_updated_at": 1743041142,
    "ts_creation_date": 1653760779,
    "ts_modification_date": 1653760779,
    "files": {
        "pdf": "https://archive.orkl.eu/4a775657a5b0cb96f1745f46a649d77a68215855.pdf",
        "text": "https://archive.orkl.eu/4a775657a5b0cb96f1745f46a649d77a68215855.txt",
        "img": "https://archive.orkl.eu/4a775657a5b0cb96f1745f46a649d77a68215855.jpg"
    }
}