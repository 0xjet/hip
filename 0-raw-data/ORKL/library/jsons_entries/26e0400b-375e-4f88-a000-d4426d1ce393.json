{
    "id": "26e0400b-375e-4f88-a000-d4426d1ce393",
    "created_at": "2023-01-12T15:05:21.874683Z",
    "updated_at": "2025-03-27T02:05:42.269468Z",
    "deleted_at": null,
    "sha1_hash": "59d16ccbd0d14011b4fc33dd6dc70eba1b326810",
    "title": "2018-05-10 - TreasureHunter Point-of-Sale Malware and Builder Source Code Leaked",
    "authors": "",
    "file_creation_date": "2022-05-28T00:43:25Z",
    "file_modification_date": "2022-05-28T00:43:25Z",
    "file_size": 138780,
    "plain_text": "# TreasureHunter Source Code Leak Makes Payload, Builder Available to All\n\n**[flashpoint-intel.com/blog/treasurehunter-source-code-leaked/](https://www.flashpoint-intel.com/blog/treasurehunter-source-code-leaked/)**\n\n[Blogs](https://www.flashpoint-intel.com/blog)\n\nBlog\n\n\nMay 10, 2018\n\n\n## TreasureHunter Point-of-Sale Malware and Builder Source Code Leaked\n\nThe source code for a longstanding point-of-sale (PoS) malware family called\nTreasureHunter has been leaked on a top-tier Russian-speaking forum. Compounding the\nissue is the coinciding leak by the same actor of the source code for the malware’s graphical\nuser interface builder and administrator panel.\n\nThe source code for a longstanding point-of-sale (PoS) malware family called\nTreasureHunter has been leaked on a top-tier Russian-speaking forum. Compounding the\nissue is the coinciding leak by the same actor of the source code for the malware’s graphical\nuser interface builder and administrator panel.\n\nThe availability of both code bases lowers the barrier for entry for cybercriminals wishing to\ncapitalize on the leaks to build their own variants of the PoS malware.\n\n\n-----\n\nPoint-of-sale malware has been at the root of many breaches, including massive thefts at\nretailers Target in 2013 and Home Depot in 2014; in each case attackers were able to extract\nmore than 100 million payment card and customer records from point-of-sale terminals by\nscraping card data before it was encrypted and sent to the payment processor.\n\n## Industry Collaboration on Detection and Prevention\n\nTreasureHunter has been known and investigated since 2014, but until now investigators\nhave had to reverse-engineer its code in order to analyze it. Now with the full code available,\nanalysts have previously unseen insight into the malware’s operation. Flashpoint analysts,\nwho discovered the source code leak in March, proactively collaborated with researchers at\nCisco Talos, who reviewed and improved protections, and advanced-detection mechanisms,\nin an effort to disrupt potential copycats who may have their hands on the source code.\n\nIn the meantime, Russian-speaking cybercriminals have been observed on the vetted\nunderground discussing improvements and weaponization of the leaked TreasureHunter\nsource code. Notably, the original developer appears to be a Russian speaker who is\nproficient in English. Originally, this malware appears to have been developed for the\nnotorious underground shop dump seller “BearsInc,” who maintained presence on various\nlow-tier and mid-tier hacking and carding communities (below is a graphical representation of\nsuch an operation on the Deep & Dark Web). It’s unknown why the source code was leaked\nat this time.\n\nA graphical representation of a typical cybercrime dump shop ecosystem.Image 1: A\n_graphical representation of a typical cybercrime dump shop ecosystem._\n\n## One Leak Can Spawn Many Variants\n\nTreasureHunter behaves like many other point-of-sale malware samples. Once an attacker\nhas access to a Windows-based server and the point-of-sale terminal, the malware is\ninstalled and it establishes persistence by creating a registry key that runs the malware at\nstartup. It then enumerates running processes, and scans device memory looking for track\ndata, including primary account numbers (PANs), separators, service codes, and more. It\nthen establishes a connection with the attacker’s command and control server and sends the\nstolen data to the criminal.\n\nThe leak of the builder adds another dimension to the availability of the TreasureHunter\npayload and configurations. In the past, malware source code leaks such as the Zeus\nbanking Trojan have spawned numerous variants, including Citadel, which cost organizations\nhundreds of millions in losses. PoS malware leaks have had similar effects, most notably\nwith the 2015 leak of the Alina malware which led to the creation of the ProPoS and Katrina\nvariants. The actor behind the TreasureHunter leak said:\n\n\n-----\n\n_Besides alina, vskimmer and other sniffers, Treasure Hunter still sniffs ( not at a very high_\n_rate, but it still does ) and besides that, since now you have the source code, it can be_\n_update anytime for your own needs.”_\n\nFor researchers, the availability of the source code opens the door into new avenues of\nanalysis and proactive visibility into such activity on the underground. This affords\norganizations such as Flashpoint the ability to collaborate with others in the industry such as\nCisco Talos in this case to improve existing protections and force attackers back to the\ndrawing board.\n\n## Source-Code Level Insight\n\nThe code project appears to be called internally trhutt34C, and was written in pure C with no\nC++ features. It was compiled originally in Visual Studio 2013 on Windows XP. Based on\nanalysis, researchers believe the developer intended to improve and redesign various\nfeatures including anti-debugging, code structure improvement, and gate communication\nlogic. With the goal of additional features to be improved, the developer hoped frustrate\nmalware analysis and subsequent research; the actor left behind a note that said: “We want\n_the malware researchers screamin’!”_\n\nA snapshot of the TreasureHunter source code.Image 2: A snapshot of the\n_TreasureHunter source code._\nThe unfinished project included continued improvement code snippets, below:\n\nTO DO for the next version of the client (0.2 Beta): Replace all Unicode versions of\nfunctions with ANSI versions. Now why did I ever go for wide-char in the first place?..\nImprove the code structure: Replace all the if – else constructs that are rendered needless\nby return commands; Organize the includes; Give the code proper commenting so that I\nam able to modify and improve it after not having seen it for some time (if such a thing\nhappens). Make scan exceptions and service codes configurable. Add the following\ncommands to the gate communication logic: Download and execute for updating; Remote\nCMD command execution; Remote self-removal for emergency cases. Add antidebugging: Use self-debugging by creating a child process (may be improved later by\nreversing the tables); Improve the MD5 function and use it to find debuggers by signatures\n(maybe to be added in future versions); Use GetTickCount to detect parts of code being\nstepped through (maybe to be added in a “heuristical” joint algorithm with the\nabovementioned); Upon finding a debugger, destroy the critical section and/or start\ncreating new threads infinitely until the application crashes. Maybe also kill processes and\ndelete debuggers and/or decompilers permanently. We want the malware researchers\nscreamin’! Add better persistency and timeouts to gate communication. Add local saving of\ndata if the gate can’t be reached for a certain period of time. Add the option to run the\nprogram as a service on Windows XP. Improve the code structure and add comments to\navoid future confusion. Add error handling and backup restart in case of crash or heap\noverflow (malloc fail). Improve the Clingfish system (so that a clingfish thread doesn’t do\nthe same thing as the main thread right after being spawned). Debug the system\ninformation extraction mechanism further (on different OS versions). Improve the trackfinding algorithm to make it faster.\n\n\n-----\n\nThe stolen dump structure is as follows. The structure contains the following key elements\nused to collect and operate with stolen dumps, such as unique machine information and\nwhere scraped data is from:\n\ntypedef struct dumpsHolder {\nTCHAR *lpFileName;\nint lpFileNameLength;\nint procID;\nchar *trackArr;\nint trackArrLength;\n} dumpsHolder;\n\nThe credit card process scan works in exception mode:\n\nchar *scanExceptions[SCANEXCEPTIONSNUM] = {“System32”, “SysWOW64”,\n“\\Windows\\explorer.exe”};\n\nThe malware focuses on scraping credit card track data, focusing on the following service\ncodes:\n\nchar *serviceCodes[SERVICECODESNUM] = {“101”, “201”, “121”, “231”, “221”, “110”};\n\nRegistry persistence for autostart in HKLM\\Microsoft\\Windows\\CurrentVersion\\Run runs as\n“jucheck.”\n\nA registry key created by the malware for persistenceImage 3: A registry key created by\n_the malware for persistence._\nThe source code is consistent with the various samples that have been seen in the wild over\nthe last few years. TreasureHunter\\config.h shows definite signs of modification over the\nlifespan of the malware. Early samples filled all of the configurable fields with\nFIELDNAME_PLACEHOLDER to be overwritten by the builder. More recent samples, and\nthe source code, instead writes useful config values directly into the fields. This makes the\nsamples slightly smaller and uses fresh compiles to create reconfigured files.\n\n## Coverage and Detection with Cisco Talos\n\nCoverage provided by Cisco Talos already exists in Cisco FirePower and AMP solutions. It is\nbeing provided here:Cisco Threat Mitigation & Advanced Coverage:  Snort Ruleset\nIdentifier (available via Snort[.]org):\n\nSnort Identifier: 29884,38573, 38574  ClamAV Signatures (available via ClamAV[.]net)\n\nsignatures: Win.Trojan.TreasureHunter*\n\nBlock has been deleted or is unavailable.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-05-10 - TreasureHunter Point-of-Sale Malware and Builder Source Code Leaked.pdf"
    ],
    "report_names": [
        "2018-05-10 - TreasureHunter Point-of-Sale Malware and Builder Source Code Leaked.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e3492534-85a6-4c87-a754-5ae4a56d7c8c",
            "created_at": "2022-10-25T15:50:23.819113Z",
            "updated_at": "2025-03-27T02:00:55.552554Z",
            "deleted_at": null,
            "main_name": "Threat Group-3390",
            "aliases": [
                "Threat Group-3390",
                "Earth Smilodon",
                "TG-3390",
                "Emissary Panda",
                "BRONZE UNION",
                "APT27",
                "Iron Tiger",
                "LuckyMouse"
            ],
            "source_name": "MITRE:Threat Group-3390",
            "tools": [
                "Systeminfo",
                "gsecdump",
                "PlugX",
                "ASPXSpy",
                "Cobalt Strike",
                "Mimikatz",
                "Impacket",
                "gh0st RAT",
                "certutil",
                "China Chopper",
                "HTTPBrowser",
                "Tasklist",
                "netstat",
                "SysUpdate",
                "HyperBro",
                "ZxShell",
                "RCSession",
                "ipconfig",
                "Clambling",
                "pwdump",
                "NBTscan",
                "Pandora",
                "Windows Credential Editor"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "c63ab035-f9f2-4723-959b-97a7b98b5942",
            "created_at": "2023-01-06T13:46:38.298354Z",
            "updated_at": "2025-03-27T02:00:02.798255Z",
            "deleted_at": null,
            "main_name": "APT27",
            "aliases": [
                "TG-3390",
                "EMISSARY PANDA",
                "TEMP.Hippo",
                "Budworm",
                "Group 35",
                "BRONZE UNION",
                "Lucky Mouse",
                "Iron Taurus",
                "GreedyTaotie",
                "Red Phoenix",
                "ZipToken",
                "Iron Tiger",
                "G0027",
                "Earth Smilodon"
            ],
            "source_name": "MISPGALAXY:APT27",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "5c13338b-eaed-429a-9437-f5015aa98276",
            "created_at": "2022-10-25T16:07:23.582715Z",
            "updated_at": "2025-03-27T02:02:09.875151Z",
            "deleted_at": null,
            "main_name": "Emissary Panda",
            "aliases": [
                "APT 27",
                "ATK 15",
                "Bronze Union",
                "Budworm",
                "Earth Smilodon",
                "Emissary Panda",
                "Group 35",
                "Iron Taurus",
                "Iron Tiger",
                "LuckyMouse",
                "Operation DRBControl",
                "Operation Iron Tiger",
                "Operation PZChao",
                "Operation SpoiledLegacy",
                "Operation StealthyTrident",
                "Red Phoenix",
                "TEMP.Hippo",
                "TG-3390",
                "ZipToken"
            ],
            "source_name": "ETDA:Emissary Panda",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Agent.dhwf",
                "AngryRebel",
                "Antak",
                "CHINACHOPPER",
                "China Chopper",
                "Destroy RAT",
                "DestroyRAT",
                "FOCUSFJORD",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HTTPBrowser",
                "HTran",
                "HUC Packet Transmit Tool",
                "HighShell",
                "HttpBrowser RAT",
                "HttpDump",
                "HyperBro",
                "HyperSSL",
                "HyperShell",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "Nishang",
                "OwaAuth",
                "PCRat",
                "PlugX",
                "ProcDump",
                "PsExec",
                "RedDelta",
                "SEASHARPEE",
                "Sensocode",
                "SinoChopper",
                "Sogu",
                "SysUpdate",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Token Control",
                "TokenControl",
                "TwoFace",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Xamtrav",
                "ZXShell",
                "gsecdump",
                "luckyowa"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535921,
    "ts_updated_at": 1743041142,
    "ts_creation_date": 1653698605,
    "ts_modification_date": 1653698605,
    "files": {
        "pdf": "https://archive.orkl.eu/59d16ccbd0d14011b4fc33dd6dc70eba1b326810.pdf",
        "text": "https://archive.orkl.eu/59d16ccbd0d14011b4fc33dd6dc70eba1b326810.txt",
        "img": "https://archive.orkl.eu/59d16ccbd0d14011b4fc33dd6dc70eba1b326810.jpg"
    }
}