{
    "id": "0cfd1557-aeaa-4781-b28a-d98f44190bab",
    "created_at": "2023-02-18T02:08:19.24168Z",
    "updated_at": "2025-03-27T02:16:34.7238Z",
    "deleted_at": null,
    "sha1_hash": "d27141c535c6fa135e038d7dff1c55a25048453f",
    "title": "MS_Suzuka_Cybercrime Blog_v3",
    "authors": "",
    "file_creation_date": "0001-01-01T00:00:00Z",
    "file_modification_date": "2023-02-03T08:20:50Z",
    "file_size": 256308,
    "plain_text": "**CYBERATTACK REPORT**\n\n##### NOBELIUM MagicWeb exploit\n# Solving one of NOBELIUM’s most novel attacks\n\nThe combination of the ever-evolving adversary\nNOBELIUM, a security-conscious customer, and a\nnever-before-seen attack yielded one of the most\nmemorable cases in Microsoft Detection and\nResponse Team’s (DART) 15-year history. This report\ndescribes the first time a Global Assembly Cache\n(GAC) implant was seen in the wild. This new\nmalware, later dubbed MagicWeb, allows the\nattacker to authenticate as anyone in a targeted\nnetwork. Discover how the team identified what\nhappened and stopped this persistent bad actor,\nand learn best practices for protecting your business.\n\n\n###### MagicWeb attack flow\n\n\n###### How did it begin?\n\n\n###### How did Microsoft respond?\n\n\n###### What can organizations do?\n\n\n-----\n\n###### multiple industries, including government agencies, financial institutions, and technology companies.\n\n\n### MagicWeb attack flow\n\n\nThe backdoored DLL hooks into legitimate\n**AD FS methods to subvert the traditional**\ncertificate validation and authentication\nprocess by using threat actor-introduced\nmethods.\n\n**Threat actor presented**\n**the specially crafted user**\n**certificate with one of two**\nspecific Extended Key\nUsage (EKU) attributes to\nbypass traditional\nauthentication methods.\n\n\n**If the EKU attributes do**\n**not exist, the traditional**\nauthentication will carry on\nas expected.\n\n\n**Investigation began by**\ncollecting authenticationrelated data to triage\nwhat the customer had\nidentified as suspicious.\n\n|DART’s investigation post-event Investigation began by collecting authentication- related data to triage what the customer had|Additional auditing was enabled to capture the certificates presented by increasing CAPI2 Diagnostics to level 5.|Created certificateto validate discoveries of EKU and performed authentications in test environments to rule our product related issues.|This hooking method let the If the EKU attributes threat actor modify the exist in the presented AD FS code at runtime certificate, the allowing them to subvert authentication is the authentication process. detoured to use the malicious hook.|\n|---|---|---|---|\n\n\n**Analysis of available authentication**\n**data confirmed what the customer**\ninitially suspected, there was illicit\ncertificate-based authentications\noccurring for targeted users.\n\n\n**Captured the threat actor-presented**\n**certificates and performed data-stacking**\ntechniques, uncovering two specific EKU\nvalues not normal for the customer's\ncertificate template.\n\n\n**Implemented Claims Issuance**\n**Authorization policy as a**\n**tactical blocking method**\nto prevent threat actor presented\ncertificates with identified EKU\nvalues.\n\n\n**Studied authenticationflow**\nto filter down authorization\nscenarios and key into\nmechanism responsible\nfor authentication bypass.\n\n\n**Identified implanted**\n**backdoors in the GAC**\nresponsible for the\nunauthorized\nauthentication.\n\n\n**Reverse-engineered binaries to identify a backdoor DLL responsible for AD FS authentication that had been manipulated by NOBELIUM to subvert certificate validation and authentication**\n\n\n-----\n\n### How did it begin?\n\nMost attackers play an impressive game of checkers, but increasingly we see advanced persistent\nthreat actors playing a masterclass-level game of chess. NOBELIUM is perhaps most notorious for\nthe SolarWinds supply chain compromise in December 2020, which is widely regarded as the most\nsophisticated nation-state cyberattack in history. In fact, NOBELIUM remains highly active,\nexecuting multiple campaigns in parallel targeting government organizations, non-governmental\norganizations (NGOs), intergovernmental organizations (IGOs), and think tanks across the US,\nEurope, and Central Asia.\n\n\nNation-state attackers like NOBELIUM have seemingly\nunlimited monetary and technical support from their\nsponsor as well as access to unique, modern hacking\ntactics, techniques, and procedures. Unlike most bad\nactors, NOBELIUM changes their tradecraft on almost\nevery machine they touch. Our analysts note that this\nactor places a very high value on their operations and\nhave exceptional tradecraft, rarely making mistakes and\nconstantly changing tactics, which helps them remain\nundetected.\n\nIn August 2022, a Microsoft customer fell victim to a\npost-compromise capability now referred to as\nMagicWeb, which was used by NOBELIUM to maintain\npersistent access to the customer environment they had\ncompromised. After noticing strange authentication\nrequests, the customer contacted DART. The global\nteam quickly responded and traveled onsite to deliver a\nreal-time investigation.\n\nUpon arrival, DART assessed the situation and\nperformed various data-wrangling actions followed by\nin-depth data analysis to understand how the threat\nactor gained access to the environment, implanted the\nbackdoor, and later how the backdoor worked. This\nincluded a rapid response to target the removal of the\nbackdoor implants and execute a complete migration\noff Active Directory Federation Services (AD FS) to\nAzure Active Directory (Azure AD). Additional\nmonitoring techniques were then put in place to keep a\nclose eye on any actions performed by the threat actor.\n\n\n-----\n\n### How did Microsoft respond?\n\nThe incident response team with the support of Microsoft Threat Intelligence\nCenter (MSTIC) divided its resources into different lines of inquiry, focusing on\nthe authentication process and flow and separating the authentication scenario\ninto logical buckets. Following the authentication flow, the user presents a\ncertificate to the Web Application Proxy, a request is proxied to the AD FS Server\nfor the certificate-based authentication process, and then AD FS processes the\nauthentication based on the validity of the certificate and account details.\n\nThe incident response team moved ahead to provide evidence in support of the\nhypothesis made above. They accomplished this by using CAPI2 diagnostic\nlogging to collect the presented client certificates. Following a thorough\nexamination of the customer's certificate templates, the team examined the\ncertificates for irregularities.\n\nThe certificates weren't valid and chained up to a trusted issuing authority.\nAfter stacking the data, the incident response team discovered one specific\nfield in the captured client certs: two distinct hardcoded object identifiers in\nthe EKU attribute of the certificate. With the deltas in the actor certificate\nidentified, the team began to reverse-engineer the attack and duplicated the\nactivity with crafted certificates of their own. Our experts were back to tackling\nthe largest puzzle in the case: how did MagicWeb subvert authentication?\n\n\nConcluding that only AD FS and specially crafted certificates were the source of\ntrickery, the team zeroed in on the AD FS authentication processes and process\ndependencies. This led them to identify that NOBELIUM implanted a backdoored\ncopy of a DLL (Microsoft.IdentityServer.Diagnostics.dll) and a modified\nconfiguration file (Microsoft.IdentityServer.Servicehost.exe.config).\n\nDigging deeper into the identified binaries, analysts identified that the loading\nof NOBELIUM’s malicious (Microsoft.IdentityServer.Diagnostics.dll) into the AD\nFS process was made possible by editing the configuration file to specify a\ndifferent public token, thus loading the malicious DLL from the Global Assembly\nCache (GAC) upon reboot. This allowed the actor to intercept and manipulate\nthe claims pipeline through loading the backdoored DLL with added .NET\nclasses and static constructors that hooked into the legitimate AD FS methods.\n\nThe four main methods identified in the technical analysis of MagicWeb\nindicated that the X509 certificate passed checking for specific EKU attributes,\nand upon a match would effectively bypass certificate validation. This satisfied\nMultifactor Authentication (MFA) to authenticate the user based off the user\ncertificate details.\n\n\n##### What can organizations do to detect and respond to this threat and similar techniques?\n\n\n**Maintain AD FS and**\n**all Identity Service Providers**\n**(IdPs) as a Tier 0 asset.**\n\nIdentity-based attacks continue to rise so\nimplementing a “privilege access strategy“\ncan protect all identity providers.\n\n\n**Mandate MFA organization-**\n**wide, all the time.**\n\nWhere applicable, enforce Multifactor\nAuthentication (MFA), preferably with locationbased and number match requirements. Recent\nidentity-based attacks were initiated from MFA\nfatigue attacks or lack of MFA enforcement.\n\n\n**Identify, log, and audit your**\n**organization’s authentication flow.**\n\nDetecting identity-based attacks in your organization\nbegins with determining what identity platforms are\nresponsible for the authentication and authorization.\nOnce the authentication flow is identified,\ncentralizing logging and auditing to establish an\nauthentication baseline will increase your\norganization’s visibility and ability to react to unusual\nauthentication events\n\n\n**Increase the cost of threat**\n**actor’s operations.**\n\nBasic security hygiene still protects against most\nforms of cyberattack. Implement a “brilliance in the\nbasics” strategy for cybersecurity hygiene. With this,\norganizations can force threat actors to increase the\ncost of their operations by removing the\n“low-hanging fruit.” A foundational element of every\norganization’s security roadmap should include Asset\nDiscovery MFA Enforcement Device Management\n\n\n-----\n\n### Summary: MagicWeb\n\nEvicting the persistent attacker NOBELIUM required rearchitecting the customer’s\nentire environment. Here we detail moves made by NOBELIUM and the steps taken\nby the customer and Microsoft’s Detection and Response Team (DART) to null the\nthreat:\n\n\n###### NOBELIUM’s MagicWeb attack flow\n\n1. Accessed a vulnerable application through\n\nAzure AD App Proxy.\n\n2. Moved laterally to the AD FS servers using an\n\nActive Directory privilege escalation\nvulnerability.\n\n3. Added a modified DLL and config file to the\n\nGlobal Assembly Cache (GAC) on each AD FS\nserver.\n\n4. Crafted a certificate using a rogue certificate\n\nauthority containing a \"magic\" value.\n\n5. Presented the crafted certificate to AD FS \nthe modified DLL sees that magic value and\nstamps the Multifactor Authentication Claim\ninto the SAML assertion.\n\n\n###### Microsoft's investigation\n\n1. Systematically investigated possibilities –\n\nimplant, bug, stolen private keys, and configuration.\n\n2. Leveraged in-depth knowledge of AD FS to enable\n\nadditional logging to track actor activity and capture\nactor-presented certificates.\n\n3. Identified distinct differences in the actor-crafted\n\ncertificate compared to a legitimate certificate,\nuncovering a delta in the extended key usage (EKU)\nattributes.\n\n4. Recreated the attack leveraging a certificate crafted by\n\nthe team that contained the “magic” extended key\nusage attribute.\n\n5. Captured a memory dump from the AD FS server to\n\nidentify malicious code in memory.\n\n6. Leveraged Microsoft Defender for Endpoint to identify\n\nhow the malware was copied to the AD FS servers\nfrom another, unrelated system that was accessed via\nApp Proxy by the threat actor.\n\n\n###### Steps customers can take\n\n Maintain AD FS and all\n 1\n IdPs as a Tier 0 asset.\n\n Identify, log, and audit\n 2\n your organization’s authentication flow.\n\n Mandate multifactor\n 3 authentication (MFA)\n organization-wide, all the time.\n\n Keep up with basic\n 4\n security hygiene to force threat actors to increase the cost of their operations.\n\n\n-----\n\n## To learn more about Microsoft's specialized support before, during, and after an incident, please visit:\n\n#### https://aka.ms/SecurityServicesIncidentResponse\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        }
    ],
    "references": [
        "https://download.microsoft.com/download/4/6/5/4650b04f-7db6-4a87-bf82-8ed1ad1c001c/MS%20Security%20Experts%20Cyberattack%20MagicWeb%202023.pdf"
    ],
    "report_names": [
        "MS%20Security%20Experts%20Cyberattack%20MagicWeb%202023.pdf"
    ],
    "threat_actors": [
        {
            "id": "b43e5ea9-d8c8-4efa-b5bf-f1efb37174ba",
            "created_at": "2022-10-25T16:07:24.36191Z",
            "updated_at": "2025-03-27T02:02:10.1909Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "Dark Halo",
                "Nobelium",
                "SolarStorm",
                "StellarParticle",
                "UNC2452"
            ],
            "source_name": "ETDA:UNC2452",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "70872c3a-e788-4b55-a7d6-b2df52001ad0",
            "created_at": "2023-01-06T13:46:39.18401Z",
            "updated_at": "2025-03-27T02:00:03.01553Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "DarkHalo",
                "StellarParticle",
                "NOBELIUM",
                "Solar Phoenix",
                "Midnight Blizzard"
            ],
            "source_name": "MISPGALAXY:UNC2452",
            "tools": [
                "SNOWYAMBER",
                "HALFRIG",
                "QUARTERRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1d3f9dec-b033-48a5-8b1e-f67a29429e89",
            "created_at": "2022-10-25T15:50:23.739197Z",
            "updated_at": "2025-03-27T02:00:55.536417Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "UNC2452",
                "NOBELIUM",
                "StellarParticle",
                "Dark Halo"
            ],
            "source_name": "MITRE:UNC2452",
            "tools": [
                "Sibot",
                "Mimikatz",
                "Cobalt Strike",
                "AdFind",
                "GoldMax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "a241a1ca-2bc9-450b-a07b-aae747ee2710",
            "created_at": "2024-06-19T02:03:08.150052Z",
            "updated_at": "2025-03-27T02:05:17.409596Z",
            "deleted_at": null,
            "main_name": "IRON RITUAL",
            "aliases": [
                "Blue Dev 5 ",
                "BlueBravo ",
                "Cloaked Ursa ",
                "CozyLarch ",
                "Dark Halo ",
                "Midnight Blizzard ",
                "NOBELIUM ",
                "StellarParticle ",
                "UNC2452 ",
                "APT29"
            ],
            "source_name": "Secureworks:IRON RITUAL",
            "tools": [
                " Cobalt Strike",
                " EnvyScout",
                " GoldFinder",
                " GoldMax",
                " NativeZone",
                " RAINDROP",
                " SUNBURST",
                " Sibot",
                " TEARDROP",
                " VaporRage",
                "Brute Ratel C4"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "46b3c0fc-fa0c-4d63-a38a-b33a524561fb",
            "created_at": "2023-01-06T13:46:38.393409Z",
            "updated_at": "2025-03-27T02:00:02.822155Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "The Dukes",
                "Minidionis",
                "Grizzly Steppe",
                "G0016",
                "Blue Kitsune",
                "BlueBravo",
                "SeaDuke",
                "Cloaked Ursa",
                "YTTRIUM",
                "ATK7",
                "Nobelium",
                "UAC-0029",
                "Group 100",
                "COZY BEAR",
                "IRON HEMLOCK",
                "TA421",
                "ITG11"
            ],
            "source_name": "MISPGALAXY:APT29",
            "tools": [
                "QUARTERRIG",
                "SNOWYAMBER",
                "HALFRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f27790ff-4ee0-40a5-9c84-2b523a9d3270",
            "created_at": "2022-10-25T16:07:23.341684Z",
            "updated_at": "2025-03-27T02:02:09.74554Z",
            "deleted_at": null,
            "main_name": "APT 29",
            "aliases": [
                "APT 29",
                "ATK 7",
                "Blue Dev 5",
                "BlueBravo",
                "Cloaked Ursa",
                "CloudLook",
                "Cozy Bear",
                "Dark Halo",
                "Earth Koshchei",
                "Grizzly Steppe",
                "Group 100",
                "ITG11",
                "Iron Hemlock",
                "Iron Ritual",
                "Midnight Blizzard",
                "Minidionis",
                "Nobelium",
                "NobleBaron",
                "Operation Ghost",
                "Operation Office monkeys",
                "Operation StellarParticle",
                "SilverFish",
                "Solar Phoenix",
                "SolarStorm",
                "StellarParticle",
                "TEMP.Monkeys",
                "The Dukes",
                "UNC2452",
                "UNC3524",
                "Yttrium"
            ],
            "source_name": "ETDA:APT 29",
            "tools": [
                "7-Zip",
                "ATI-Agent",
                "AdFind",
                "Agentemis",
                "AtNow",
                "BEATDROP",
                "BotgenStudios",
                "CEELOADER",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobalt Strike",
                "CobaltStrike",
                "CosmicDuke",
                "Cozer",
                "CozyBear",
                "CozyCar",
                "CozyDuke",
                "Danfuan",
                "EnvyScout",
                "EuroAPT",
                "FatDuke",
                "FoggyWeb",
                "GeminiDuke",
                "Geppei",
                "GoldFinder",
                "GoldMax",
                "GraphDrop",
                "GraphicalNeutrino",
                "GraphicalProton",
                "HAMMERTOSS",
                "HammerDuke",
                "LOLBAS",
                "LOLBins",
                "LiteDuke",
                "Living off the Land",
                "MagicWeb",
                "Mimikatz",
                "MiniDionis",
                "MiniDuke",
                "NemesisGemina",
                "NetDuke",
                "OnionDuke",
                "POSHSPY",
                "PinchDuke",
                "PolyglotDuke",
                "PowerDuke",
                "QUIETEXIT",
                "ROOTSAW",
                "RegDuke",
                "Rubeus",
                "SNOWYAMBER",
                "SPICYBEAT",
                "SUNSHUTTLE",
                "SeaDaddy",
                "SeaDask",
                "SeaDesk",
                "SeaDuke",
                "Sharp-SMBExec",
                "SharpView",
                "Sibot",
                "Solorigate",
                "SoreFang",
                "TinyBaron",
                "WINELOADER",
                "WellMail",
                "WellMess",
                "cobeacon",
                "elf.wellmess",
                "reGeorg",
                "tDiscoverer"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1676686099,
    "ts_updated_at": 1743041794,
    "ts_creation_date": 0,
    "ts_modification_date": 1675412450,
    "files": {
        "pdf": "https://archive.orkl.eu/d27141c535c6fa135e038d7dff1c55a25048453f.pdf",
        "text": "https://archive.orkl.eu/d27141c535c6fa135e038d7dff1c55a25048453f.txt",
        "img": "https://archive.orkl.eu/d27141c535c6fa135e038d7dff1c55a25048453f.jpg"
    }
}