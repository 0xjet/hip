{
    "id": "5218f53d-fbd6-4bc8-a097-7a2867220968",
    "created_at": "2023-01-12T15:07:50.270007Z",
    "updated_at": "2025-03-27T02:16:59.325412Z",
    "deleted_at": null,
    "sha1_hash": "2a6a71577ef3c719f16191d972ae57cfebe0dc31",
    "title": "2022-04-06 - The Latest Remcos RAT Driven By Phishing Campaign",
    "authors": "",
    "file_creation_date": "2022-08-18T03:53:22Z",
    "file_modification_date": "2022-08-18T03:53:22Z",
    "file_size": 395332,
    "plain_text": "# The Latest Remcos RAT Driven By Phishing Campaign\n\n**[fortinet.com/blog/threat-research/latest-remcos-rat-phishing](https://www.fortinet.com/blog/threat-research/latest-remcos-rat-phishing)**\n\nApril 6, 2022\n\nRemcos RAT (Remote Access Trojan) was originally designed as a professional tool to\nremotely control computers. Remcos RAT is recognized as a malware family because it has\nbeen abused by hackers to secretly control victims’ devices since its first version was\npublished on July 21, 2016. Remcos RAT is commercial software that is sold online.\n\n**Affected platforms: Microsoft Windows**\n\n**Impacted parties: Microsoft Windows Users**\n\n**Impact: Controls victim’s device and collects sensitive information**\n\n**Severity level: Critical**\n\nFigure 1: Example of Remcos RAT being sold online\n\nOn this webpage, it provides two versions: professional edition (with all features included)\nand free edition (with restricted features).\n\n\n-----\n\nThis analysis is based on Remcos RAT being used by hackers to control victims devices\ndelivered by a phishing campaign, which was caught by Fortinet’s FortiGuard Labs recently.\n\nIn this analysis, you will learn:\n\nHow the phishing campaign delivers Remcos RAT onto the victim’s device\nHow Remcos executes on the device\nWhat sensitive information it could steal from a victim\nHow Remcos connects to its C2 server\nWhat commands this Remcos provides to control the victim’s device\n\n## The Phishing Email\n\nFigure 2: Screenshot of the phishing email content\n\nAs you can see from the email content shown in Figure 2, the hacker disguised the phishing\nemail as a payment notification from a trusted bank and asked the recipient to open the\nattached Excel file that is protected by a password.\n\n### Excel File Leads to Download of Remcos via VBS and PowerShell\n\nOnce the attached Excel document is opened in the Excel program, it asks for a password to\nview the document, which has already been provided in the email. It then shows the\ndocument in the Excel program like Figure 3. Because the file contains Macro code, it shows\na yellow security warning bar to warn the victim of the danger.\n\nFigure 3: Screen shown when the Excel document is opened in the Excel program\n\nThe file message lures the victim into clicking the Enable Content button to bypass the\nwarning and execute the malicious macro code.\n\nThe macro has a function called “Wookbook_Active()” that is called automatically when it\nopens. Its task is to extract VBS code from the cells into a file “%AppData%\\HobYQ.vbs” and\nthen execute it.\n\nTo protect the Remcos payload file, it uses a super sophisticated way to download it. In this\nway, it executes both VBS and PowerShell script codes.\n\n“HobYQ.vbs” runs a segment of dynamically spliced PowerShell code to download another\nVBS file (“flip.vbs”) from the attacker’s server and run it. Next, “flip.vbs” continues to\ndownload a file (called “mem.txt”) from the server, which is a piece of encoded VBS code\nthat will be executed later in “flip.vbs” to download the final file from the same server, which\nis called “faze.jpg”. In Figure 4, it shows the captured traffic for the three downloaded files,\n“flip.vbs,” “mem.txt,” and “faze.jpg.”\n\n\n-----\n\nFigure 4: HobYQ.vbs leads to downloading three files\n\nThe bottom of Figure 4 shows part of the response packet of “faze.jpg”. Of course, it is not\nimage file, but an obfuscated PowerShell code file. There are three pieces of encoded data\ndefined in three array variables, which have been simplified in Figure 5 in three red boxes.\nThe PowerShell code that is carried in “faze.jpg” is executed by “flip.vbs”.\n\nFigure 5: The simplified PowerShell code of “faze.jpg”\n\nLet me then explain how the PowerShell code works here.\n\nThe values for the two variables, $MNB and $IRjR, are both encoded GZIP compression\npayloads (they start with “1F 8B…”). After decompression, $MNB is .Net Framework Dll file\nand $IRjR is the Remcos payload file.\n\nThe binary value that is set to variable “$qgRf” is a dynamic method called tMCfkSD() for\ndecompression.\n\nIt calls tMCfkSD() to decompress the .Net Dll from $MNB into $byUsWxe. At last, it loads the\n.Net Dll into current PowerShell execution environment by calling “Load” and the function\n“Black()” from class “toooyou” is called with “RegAsm.exe” and compressed Remcos\nPayload ($IRjR).\n\n### .Net Framework Dll File Performs Process Hollowing\n\nFigure 6: Break on .Net Dll toooyou.Black()\n\nThe .Net Dll is named GC.dll as you can see in Figure 6. The two passed parameters are\nshown in “Locals”. Its code is obfuscated. According to my analysis, it first dynamically\nextracts another Dll from its resource section named lime.dll. Next, it decompresses the\nRemcos payload, which will be passed to a function called\n\"k78er0sdfffff.o70sdaf45gfg(System.String, Byte[])\" that is from lime.dll at the time the\nfunction is called. Actually, this Dll is used to perform the process hollowing that is injecting\nthe Remcos payload into a newly-created “RegAsm.exe” process. Once the function\n(k78er0sdfffff.o70sdaf45gfg()) is invoked, it finds “RegAsm.exe” from below locations on the\nvictim’s device. In case that it fails to find the file, it exits from PowerShell without running the\nRemcos.\n\nThe hardcoded location list:\n\narray[<Module>.C1790263187] = \"C:\\\\WINDOWS\\\\syswow64\\\\\";\n\narray[<Module>.C2710025604] = \"C:\\\\WINDOWS\\\\system32\\\\\";\n\narray[<Module>.C3326009313] = \"C:\\\\WINDOWS\\\\\";\n\n\n-----\n\narray[<Module>.C931285936] = C:\\\\WINDOWS\\\\syswow64\\\\WindowsPowerShell\\\\v1.0\\\\ ;\narray[<Module>.const_4] = \"C:\\\\WINDOWS\\\\system32\\\\WindowsPowerShell\\\\v1.0\\\\\";\n\narray[<Module>.C3873335087] = \"C:\\\\Windows\\\\Microsoft.NET\\\\Framework\\\\v4.0.30319\\\\\";\n\nIn my testing environment, it has this file at\n\"C:\\Windows\\\\Microsoft.NET\\Framework\\v4.0.30319\\RegAsm.exe\".\n\nAs you may know, it needs to call several APIs to finish the process hollowing, which are:\nCreateProcess() with CREATE_SUSPENDED flag, WriteProcessMemory(),\nGetThreadContext(), SetThreadContext() and so on. As shown in Figure 7, it is about to call\nAPI CreateProcessA() to create a suspended RegAsm.exe process from Lime.dll.\n\nFigure 7: Call CreateProcessA() with CREATE_SUSPENDED flag\n\nWhen the Remcos payload is injected and deployed onto the RegAsm.exe, API\nResumeThread() will be called to have RegAsm.exe resume to run the Remcos RAT on the\nvictim’s device.\n\n### Dive into Remcos Payload\n\nPer my analysis, Remcos was written in C++ language with templates. What we already\ncaptured is the latest version, 3.4.0 Pro, which was published on February 10, 2022. I\ndissected the Remcos payload file from this section to learn how it controls the victim’s\ndevice.\n\nFrom the analysis of its previous versions in the past years, Remcos used RC4 encryption to\nencrypt or decrypt both the local data and the traffic data between Remcos and C2 servers.\nFrom the version 3.0.0 Pro on, it has changed the encryption algorithm to AES-128 bit for\nencrypting or decrypting the traffic data. Therefore, it is now using both encryption\nalgorithms, RC4 for local data and AES for traffic data in this variant.\n\nFigure 8: Remcos configuration block encrypted in “SETTINGS” resource\n\nEvery Remcos contains an RC4 encrypted configuration block in its PE resource section,\nnamed “SETTINGS” as shown in Figure 8, where the first byte “B1” is the size of the\nfollowing RC4 key that is in a red box and the rest data is the encrypted Remcos\nconfiguration block.\n\nThe first thing Remcos does is to decrypt the configuration block, which will be referred to\nthroughout Remcos lifetime. It contains but not limited to the C2’s server information,\nRemcos assigned name for attacker to recognize the victim, Remcos sub-key name in\nregistry, the name of log file for recording victim’s keylogger and clipboard data, many flags\ntelling Remcos how to start its features in the victim’s device, as well as the authentication\ndata used to establish connection to the C2 server.\n\n\n-----\n\nThe workflow of Remcos is very clear that it starts many threads to perform auto-start work\naccording to the flags defined in the configuration block. It includes:\n\nAdding Remcos to the auto-run group in the system registry\nStarting a watchdog program (Remcos’ daemon program)\nRecording the victim’s audio input from an input device ( microphone)\nCapturing victim’s screenshots at startup\nDisabling UAC (User Account Control) on the victim’s device\nAnd so on\n\nRemcos is able to record the victim’s sensitive information in a log file (file name is from the\nconfiguration block) from time to time, like keyboard inputs (keylogger), data on the system\nclipboard, and the title of the topmost program that the victim’s typing in. In order to do so, it\nneeds to set a keyboard hook by calling API SetWindowsHookExA() and starts a thread to\ncheck every 500 microseconds. Figure 9 shows the ASM code snippet of setting such hook.\n\nFigure 9: Set keyboard Windows Hook\n\nBelow is an example of “logs.dat” with what Remcos has obtained from my test environment,\nsuch as recording date and time, topmost program titles, victim’s idle time, and clipboard\ndata.\n\nFigure: 10: Example of information saved in “log.dat”\n\nThe next step in the Remcos workflow is to connect to its C2 server per the information from\nthe configuration block.\n\n### Communicating with the C2 Server\n\nRemcos uses TLS v1.3 protocol to communicate with the C2 server, which is implemented\nby itself (not using Windows APIs) on the TLS handshake and authentication as I mentioned\nbefore.\n\nRemcos then collects the basic information from the victim’s system and submits it in the first\npacket to the C2 server. The packet number for the first packet is 4BH. The packet to go\nthrough AES encryption is shown below.\n\nFigure 11: 4BH packet plaintext content before AES encryption\n\nThe victim’s basic information is enclosed in this packet. Let’s take a look at the packet\nstructure.\n\nThe first “24 04 FF 00” is the packet magic ID that comes from the decrypted configuration\nblock, the subsequent dword “A1 02 00 00” (21AH) is the size of following data, the next\ndword “4B 00 00 00” (4BH) is the packet number. The entire rest data are the collected basic\n\n\n-----\n\ninformation of the victim s device, which includes but not limited to:\n\nRemcos assigned name “Shiesty” (from configuration block)\nVictim’s user name and computer name\nWindows edition information, total RAM (3757629400) in bytes\nRemcos version (3.4.0 Pro)\nThe full path of current RegAsm.exe, the title of the currently active program (the\nvictim’s using)\nVictim’s idle time\nThe system’s uptime\nCPU information\nC2 server host\nRemcos payload type (EXE or DLL)\n\nAll above value fields are split by a separator - “7C 1E 1E 1F 7C” (shown as “|…|” in string).\n\nAs long as the C2 server receives this 4BH packet, it shows the victim in the “Connection”\nsubtab, as shown in Figure 12. Since then the attacker can control the victim’s device by just\nright clicking on the item (red box) and selecting the commands they wanted.\n\nFigure 12: How C2 server looks when receiving a 4BH packet\n\nMeanwhile, Remcos registers a callback function that parses the C2’s commands and goes\nto an infinite loop to wait for the upcoming control commands from the attacker’s C2 server.\n\n## Control Commands\n\nFrom the registered callback function, we learned that this Remcos variant provides 87\ncontrol commands, which have been categorized in below groups:\n\n**System: Screen Capture, File Manager, File Search, Process Manager, etc.**\n**Surveillance: Webcam, Microphone, Keylogger, Screenlogger, etc.**\n**Network: Proxy, Downloader, Open Webpage, etc.**\n**Extra: Dll Loader, Logins Cleaner, Audio Player, etc.**\n**Remcos: Reconnect, Restart, Show, Update, Close, Uninstall, etc.**\n**Heartbeat packet**\n\nThe C2 server sends a heartbeat packet to Remcos every 40 seconds. Once Remcos has\nconnected to the C2 server, the heartbeat makes sure this Remcos is alive. The C2’s\ncommand packet has same format. I’ll take the heartbeat packet as an instance to explain,\nwhich looks like:\n\n24 04 FF 00 0C 00 00 00 01 00 00 00 30 7C 1E 1E 1F 7C 32 30\n\n\n-----\n\nAfter the packet magic ID ( 24 04 FF 00 ) and packet size (0x0C), 01 00 00 00 is heartbeat\ncommand number (0x01), and rest is command data being split by “7C 1E 1E 1F 7C” that\nare 30 (ASCII “0”) and 32 30 (ASCII “20”). Remcos then obtains the title of currently active\nwindow as well as a time value and sends them to the C2 server in packet number 4CH.\n\nThe following is a control command list:\n\n\n**Name** **C&C**\n**Number**\n\n\n**Description**\n\n\nHeartBeat 01H HeartBeat packet.\n\nScreen Capture 10H Control the victim’s device in a remote desktop.\n\nFile Manager 98H Manager file system on victim’s device.\n\nFile Search 8FH Search file on victim’s device.\n\nProcess Manager 06H Manager running process.\n\nService Manager 34H Manager victim’s system service.\n\nRegistry Editor 2FH View, Edit victim’s system registry.\n\nInstalled Program 03H List all installed software.\n\n\nWindows\nManager\n\nClipboard\nManager\n\n\n08H Open a Task Manager similar interface.\n\n28H View, Set, and Empty victim’s system clipboard.\n\n\nCommand Line 0EH Start a shell (cmd.exe) with command.\n\n\nExecute\nCommand\n\n\n0DH Execute a command in the victim’s device, like\nNotepad.\n\n\nRemote Scripting 2EH Execute JS, VBS, and Batch on the victim’s device.\n\n\n-----\n\nSet Wallpaper 92H Set the victim’s desktop wallpaper with a picture.\n\nPower Manager 27H Log off, Sleep, Hibernate, Shut down, and Restart.\n\nWebcam 1BH Control victim’s camera to work\n\nMicrophone 1DH Turn on the victim’s audio input device, like\nMicrophone.\n\nKeylogger 13H Start Keylogger.\n\nScreenlogger 10H Start Screenlogger.\n\nBrowser history 18H Clear browser’s history.\n\nProxy 32H Set proxy to victim’s device.\n\nOpen Webpage 0FH Open a URL with the victim’s default browser.\n\nChat 30H Pop up a chatting box to chat with the victim.\n\nMessageBox 26H Pop up a message to the victim.\n\nDownloader B2H Download and execute a file on the victim’s device.\n\nDll Loader 2CH Execute a Dll module on the victim’s device.\n\nAudio Player A3H Play an audio sound to the victim.\n\nLogins Cleaner 18H Clear browser’s logins and cookies.\n\nUpdate 24H Update Remcos.\n\nUninstall 22H Uninstall Remcos from the victim’s device.\n\nClose 21H Kill currently running Remcos.\n\n\n-----\n\nRestart 23H Restart Remcos.\n\nElevate 27H Elevate Remcos’ privileges.\n\nBesides the listed control commands, Remcos also has many sub-commands to support\nsome of the control commands in sub-connections, like Service Manager command 34H with\nsub-commands: 03H to stop a service, 04H to pause a service, 01H to restart a service.\n\n## Conclusion\n\nIn this analysis blog, I explained how a phishing email delivers an Excel document with\nmalicious Macro into the victim’s device.\n\nNext, we went through how it executes multiple VBS and Powershell scripts to download the\nRemcos payload as well as how the Remcos payload is deployed by a .Net Dll into the\n“RegAsm.exe” process via Process Hollowing.\n\nThen, I dissected Remcos’s workflow according to its code and how a configuration block is\ndecrypted from the PE resource section. I also explained how Remcos established\nconnection to its C2 server.\n\nFinally, through several examples, I elaborated the structure of the control and command\npackets in plaintext as well as what commands Remcos is able to use to control the victim’s\ndevice and the control command list.\n\n## Fortinet Protections\n\nFortinet customers are already protected from this malware by FortiGuard’s Web Filtering,\nAntivirus, FortiMail, FortiClient, FortiEDR services, IPS services, and CDR (Content Disarm\nand Reconstruction) services, as follows:\n\nAll relevant URLs have been rated as \"Malicious Websites\" by the FortiGuard Web Filtering\nservice.\n\nThe captured Excel sample and the downloaded Remcos payload files are detected as\n\"VBA/Remcos.REM!tr \" and \"W32/Rescoms.M!tr\" and are blocked by the FortiGuard\nAntivirus service.\n\nFortiEDR detects both the Excel file and Remcos payload file as malicious based on its\nbehavior.\n\nFortinet also released IPS signature “Remcos.Botnet” to detect and block Remcos’ C&C\ntraffic to protect our customers.\n\n\n-----\n\nFortiGuard Content, Disarm, and Reconstruction (CDR) can protect users from this attack by\nenabling the following option:\n\nEnable/disable stripping of linked objects in Microsoft Office documents.\n\nIn addition to these protections, Fortinet has multiple solutions designed to help train users to\nunderstand and detect phishing threats:\n\nThe [FortiPhish Phishing Simulation Service uses real-world simulations to help organizations](https://www.fortinet.com/products/phishing-simulation)\ntest user awareness and vigilance to phishing threats and to train and reinforce proper\npractices when users encounter targeted phishing attacks.\n\nIn addition to these protections, we suggest that organizations also have their end users go\n[through our FREE NSE training: NSE 1 – Information Security Awareness. It includes a](https://www.fortinet.com/products/phishing-simulation)\nmodule on Internet threats that is designed to help end users learn how to identify and\nprotect themselves from various types of phishing attacks.\n\n## IOCs\n\n### URLs:\n\nhxxp://209[.]127[.]19[.]101/flip.vbs\n\nhxxp://209[.]127[.]19[.]101/mem.txt\n\nhxxp://209[.]127[.]19[.]101/faze.jpg\n\nshiestynerd[.]dvrlists[.]com:10174\n\nmimi44[.]ddns[.]net:2405\n\nharveyautos110[.]ddns[.]net:2404\n\nharveyautos111[.]hopto[.]org:2404\n\nharveyautos112[.]ddns[.]net:2404\n\nharvey205[.]camdvr[.]org:2404\n\nharvey206[.]casacam[.]net:2404\n\nharvey207[.]accesscam[.]org:2404\n\n23[.]226[.]128[.]197:2404\n\nachimumuazi[.]hopto[.]org:2311\n\n\n-----\n\nxhangzhi[.]duckdns[.]org:2404\n\n### Sample SHA-256 Involved in the Campaign:\n\n[Excel Document]\n\nFBB0575DFD7C1CFE48FB3AA895FBE6C8A554F06899A7152D04CFC39D1D4744AD\n\n[Captured Remcos samples]\n\n8F6DD0DB9E799393A61D6C9CF6495C164E1B13CB8E6B153B32359D5F07E793D2\n\nDA609D3211D60D5B11FEAEAA717834CBE86E18103A1ED4FC09C2EE3E1CFF9442\n\n737E11913EFB64ACCF1B88532C7CE8606676684D8364DDD027926F9FFC6ECFFB\n\nB263876EBC01B310A8BFC58477523981184EB7E8F2DC955F0CF8E62124EB679A\n\n2C8B78FC6C4FE463DAC9D39FDE2871F1BB2605453BC0F2D57C7549CF5D07AA86\n\nA1A1395D0602A473FCC81BA7D1D90C3FB154321D1721E0069722B902B1057CB0\n\n6B816D84ACCC3E1EBCE3EF55B64B0C5E0485228790DF903E68466690E58B5009\n\n_Learn more about Fortinet’s_ _[FortiGuard Labs threat research and intelligence organization](https://www.fortinet.com/fortiguard/labs?utm_source=blog&utm_campaign=fortiguard-labs)_\n_[and the FortiGuard Security Subscriptions and Services portfolio.](https://www.fortinet.com/fortiguard/labs?tab=security-bundles&utm_source=blog&utm_campaign=security-bundles)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-06 - The Latest Remcos RAT Driven By Phishing Campaign.pdf"
    ],
    "report_names": [
        "2022-04-06 - The Latest Remcos RAT Driven By Phishing Campaign.pdf"
    ],
    "threat_actors": [
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536070,
    "ts_updated_at": 1743041819,
    "ts_creation_date": 1660794802,
    "ts_modification_date": 1660794802,
    "files": {
        "pdf": "https://archive.orkl.eu/2a6a71577ef3c719f16191d972ae57cfebe0dc31.pdf",
        "text": "https://archive.orkl.eu/2a6a71577ef3c719f16191d972ae57cfebe0dc31.txt",
        "img": "https://archive.orkl.eu/2a6a71577ef3c719f16191d972ae57cfebe0dc31.jpg"
    }
}