{
    "id": "1a7674c4-60cc-4b98-a8dc-88afe2f564a7",
    "created_at": "2023-01-12T15:01:17.773821Z",
    "updated_at": "2025-03-27T02:05:55.452632Z",
    "deleted_at": null,
    "sha1_hash": "64a2e03420dd738f9dbb162a5f5a0ba656e6c3fb",
    "title": "2021-05-04 - Detecting Lateral Movement via WinRM Using KQL",
    "authors": "",
    "file_creation_date": "2022-05-28T17:10:39Z",
    "file_modification_date": "2022-05-28T17:10:39Z",
    "file_size": 723527,
    "plain_text": "# Detecting Lateral Movement via WinRM Using KQL .\n\n**[in.security/detecting-lateral-movement-via-winrm-using-kql/](https://in.security/detecting-lateral-movement-via-winrm-using-kql/)**\n\nMay 3, 2021\n\nOver the past few months we’ve been looking a little more into the detection methods we\nmight use to identify strange activity within a given environment.\n\nA lot of this research stems from questions asked by our clients following a technical\n[engagement, or questions from students that have taken our Hacking Enterprises training.](https://in.security/hacking-enterprises/)\n[With the arrival of our new Defending Enterprises training this year where we look at](https://in.security/defending-enterprises/)\ndetection methods from our ‘Top 10 in-the-field attacks’, a lot of this research naturally\nevolved and we found this element particularly interesting.\n\n\n-----\n\n[Microsoft Azure Sentinel is fast becoming our go-to SIEM as it not only brings the](https://azure.microsoft.com/en-gb/services/azure-sentinel/)\naccessibility of cloud services, but a wealth of functionality at a relatively low price point. In\n[this blog we’re going to take a brief look at the power of the Kusto Query Language (KQL).](https://docs.microsoft.com/en-us/azure/data-explorer/kql-quick-reference)\n\n## Detecting Lateral Movement Through WinRM\n\nUnder the context of internal network monitoring, we wanted a quick and easy method to\nidentify when a WinRM or PowerShell Remoting session had been instigated, but we also\nwanted an idea of where the user both had originated from, and targeted. As PowerShell\nRemoting uses WinRM to establish connections, the same Indictor of Attack (IOA) could be\nused.\n\nWhen a WinRM connection is initialised EventID 6 will be recorded (the source host) and\nwhen a WinRM connection is received EventID 91 is recorded (the target host). Both events\nwill be logged in Microsoft-Windows-WinRM/Operational (Windows Remote\nManagement through the GUI).\n\n[Therefore, to chain together such events we can use a Time Window Join operation to map](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/join-timewindow)\n_source > target using a query such as the following:_\n\nIn short, this query will look for Event ID 6 in the Microsoft-Windows-WinRM log and, if\nfound, a second query is executed that looks for Event ID 91, again in the Microsoft_Windows-WinRM log, but the events have to occur within 1 minute of each other (in larger,_\nbusy environments this timing may need to be tuned). If both events are identified (matched\non username), details of the event are displayed, as shown in the example below.\n```\nEvent\n| where EventID == 6\n| where Source == \"Microsoft-Windows-WinRM\"\n| project SourceEvent = EventID, SourceTime=TimeGenerated, UserName, SourceComputer\n= Computer\n| join kind=inner\n  (\n  Event \n  | where EventID == 91\n  | where Source == \"Microsoft-Windows-WinRM\"\n  | project TargetEvent = EventID, TargetTime=TimeGenerated, UserName,\nTargetComputer = Computer\n  ) on UserName\n| where (TargetTime - SourceTime) between (0min .. 1min)\n| project SourceEvent, TargetEvent, SourceComputer, TargetComputer, UserName,\nSourceTime, TargetTime\n| sort by SourceTime desc\n\n```\n\n-----\n\n## Identifying Further Activity Through PowerShell Logging\n\nWe can further investigate any activities by collating EventID 91 (a WinRM connection has\nbeen received – i.e. the target host) with PowerShell logging EventID 4103 (Module\nLogging), to see what may have been executed after the connection was made.\n\nAs per the previous query, we’re using a join statement with much of the same underlying\nlogic. In this instance if Event ID 91 is identified, a second query is executed that looks for\n_Event ID 4103 within 1 minute of the initial connection. If both events are identified, details_\nare displayed, as shown in the example below.\n```\nEvent\n| where EventID == 91\n| where Source == \"Microsoft-Windows-WinRM\"\n| project SourceEvent = EventID, SourceTime=TimeGenerated, UserName, Computer\n| join kind=inner\n  (\n  Event \n  | where EventID == 4103\n  | where Source == \"Microsoft-Windows-PowerShell\"\n  | project TargetEvent = EventID, TargetTime=TimeGenerated, UserName, Computer,\nRenderedDescription\n  ) on Computer\n| where (TargetTime - SourceTime) between (0min .. 1min)\n| project SourceEvent, TargetEvent, Computer, RenderedDescription, UserName,\nSourceTime, TargetTime\n| sort by SourceTime desc\n\n```\nWe always recommend establishing a decent baseline to know what normal activity looks\nlike before diving into trying to identify the abnormal, otherwise it becomes a very difficult\ntask to spot the haystack let alone the needle!\n\n\n-----\n\nIf this has you interested, why not check out some of our other blue orientated posts below.\n\n[Detecting Pass-the-Ticket (PtT) Attacks](https://in.security/2022/04/25/detecting-pass-the-ticket-ptt-attacks/)\n[PsExec. I thought we were friends](https://in.security/2021/11/03/psexec-i-thought-we-were-friends/)\n[Getting Started with Sysmon for Linux](https://in.security/2021/10/18/getting-started-with-sysmon-for-linux/)\n[What the Heck PsExec!](https://in.security/2021/09/30/what-the-heck-psexec/)\n[Detecting Lateral Movement via WinRM Using KQL](https://in.security/2021/05/03/detecting-lateral-movement-via-winrm-using-kql%ef%bf%bc/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-04 - Detecting Lateral Movement via WinRM Using KQL.pdf"
    ],
    "report_names": [
        "2021-05-04 - Detecting Lateral Movement via WinRM Using KQL.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535677,
    "ts_updated_at": 1743041155,
    "ts_creation_date": 1653757839,
    "ts_modification_date": 1653757839,
    "files": {
        "pdf": "https://archive.orkl.eu/64a2e03420dd738f9dbb162a5f5a0ba656e6c3fb.pdf",
        "text": "https://archive.orkl.eu/64a2e03420dd738f9dbb162a5f5a0ba656e6c3fb.txt",
        "img": "https://archive.orkl.eu/64a2e03420dd738f9dbb162a5f5a0ba656e6c3fb.jpg"
    }
}