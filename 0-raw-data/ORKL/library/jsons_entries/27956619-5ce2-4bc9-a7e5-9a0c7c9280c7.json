{
    "id": "27956619-5ce2-4bc9-a7e5-9a0c7c9280c7",
    "created_at": "2022-10-25T16:48:19.842306Z",
    "updated_at": "2025-03-27T02:17:14.381044Z",
    "deleted_at": null,
    "sha1_hash": "e42a5389981236b65e5481d6985b2a63c544b2a8",
    "title": "apt10deob",
    "authors": "",
    "file_creation_date": "2019-09-30T09:49:21Z",
    "file_modification_date": "2019-09-30T09:49:21Z",
    "file_size": 2817012,
    "plain_text": "# Defeating APT10 Compiler-level Obfuscations\n\n###### Takahiro Haruyama\n\n Threat Analysis Unit\n\n Carbon Black\n\n\n-----\n\n## Who am I?\n\n###### • Takahiro Haruyama (@cci_forensics)\n\n\n###### � Principal Threat Researcher\n � Carbon Black’s Threat Analysis Unit (TAU) � Reverse-engineering cyber espionage malware\n\n\n###### � linked to PRC/Russia/DPRK � Past public research presentations\n � binary diffing, Winnti/PlugX malware research � forensic software exploitation, memory forensics\n\n\n-----\n\n## Overview\n\n###### • Motivation and Approach\n\n\n\n###### • Microcode\n\n • Opaque Predicates\n\n\n\n###### • Control Flow Flattening\n\n • IDA 7.2 Issues and 7.3 Improvements\n\n\n\n###### • Wrap-up\n\n\n-----\n\n# Motivation and Approach\n\n\n-----\n\n## Question\n\n\n###### This function just returns the value\n\n\n###### This function just returns the value\n\n\n-----\n\n###### Control Flow Flattening\n\n\n###### Control Flow Flattening\n\n\n-----\n\n## APT10 ANEL [1][2]\n\n###### • RAT program used by APT10\n\n\n###### � observed in Japan uniquely\n\n\n\n###### • ANEL version 5.3.0 or later are obfuscated with\n � opaque predicates � control flow flattening\n\n\n-----\n\n-----\n\n## Motivation and Approach\n\n###### • automate ANEL code de-obfuscations\n\n\n###### � The obfuscations looked similar to the ones described\n in Hex-Rays blog [3]\n\n � The IDA plugin HexRaysDeob [4] didn’t work\n\n\n###### � It was made for another variant of the obfuscations\n\n � I investigated the causes then modified\n HexRaysDeob to work for ANEL samples [8]\n\n\n-----\n\n# Microcode\n\n\n-----\n\n## Microcode\n\n\n###### low\n\n high\n\n\n\n###### • intermediate representation\n (IR) used by IDA Pro decompiler\n\n\n\n###### • optimized in 9 maturity levels\n � transformed from low-level to\n high-level IRs [3]\n\n\n-----\n\n## Microcode Explorer [4]\n\n\n###### over 150 instructions\n\n just 8 instructions\n\n\n-----\n\n## Microcode Explorer [4]\n\n\n###### over 150 instructions\n\n just 8 instructions\n\n\n-----\n\n## Key Structures [5]\n\n|tructures [5]|Col2|\n|---|---|\n|tructures [5]|HexRaysDeob installs two optimizer callbacks: optblock_t and optinsn_t|\n||o|\n\n\n###### minsn_t\n\n mop_t (left)\n\n mop_t (right)\n\n mop_t (dest)\n\n\n###### mblock_t\n\n\n###### minsn_t\n\n\n###### minsn_t\n\n\n-----\n\n### Microcode Explorer\n\n\n###### CFG (mblock_t) block number\n\n top-level instruction\n\n\n-----\n\n# Opaque Predicates\n\n\n-----\n\n## Opaque Predicates Summary\n\n###### • optinsn_t::func\n replaces an opaque predicate pattern with another expression\n\n\n###### � called from MMAT_ZERO to\n MMAT_GLBOPT2\n\n • ANEL samples require 2\n more patterns and data- flow tracking\n\n\n-----\n\n## Pattern1: x x ~( * ( - 1)) | -2\n\n###### • In the example below,\n � dword_745BB58C = either even or odd � dword_745BB58C * (dword_745BB58C - 1) = always\n even � the lowest bit of the negated value becomes 1 � OR by -2 (0xFFFFFFFE) will always produce the value -1\n\n\n\n###### • The pattern x * (x-1) will be replaced with 2\n\n\n-----\n\n### Pattern2: read-only global variable >= 10 or < 10\n\n###### • dword_72DBB588 is always 0\n � without a value (will be initialized with 0) � only read accesses\n\n\n\n###### • the pattern matching function replaces the global\n variable with 0\n\n • other variants\n � the variable - 10 < 0 � the immediate value can be different, not 10 (e.g., 9)\n\n\n-----\n\n### Data-flow tracking for the patterns\n\n###### • trace back the minsn_t / mblock_t linked lists\n\n\n-----\n\n### Data-flow tracking for the patterns (Cont.)\n\n###### • optinsn_t::func passes\n\n\n###### = read-only\n\n\n-----\n\n# Control Flow Flattening\n\n\n-----\n\n#### Control Flow Flattening: Summary\n\n\n-----\n\n### Control Flow Flattening: block comparison variable\n\n\n###### The unflattening code translates block comparison variables into block numbers (mblock_t::serial)\n\n|Col1|Col2|Col3|\n|---|---|---|\n||block comparison variable assignment||\n\n|block comparison variable comparison|Col2|Col3|\n|---|---|---|\n||||\n\n\n###### The unflattening code\n block comparison variable\n translates\n assignment\n variables into (mblock_t::serial\n\n block comparison variable comparison\n\n\n-----\n\n### Control Flow Flattening: Modifications\n\n###### • three main modifications\n\n\n###### � Unflattening in multiple maturity levels\n\n � Control flow handling with multiple dispatchers\n\n\n###### � Implementation for various jump cases\n\n\n-----\n\n### Unflattening in Multiple Maturity Levels\n\n###### • The original\n implementation works in MMAT_LOCOPT\n � due to \"Odd Stack\n Manipulations” obfuscation\n\n\n\n###### • I had to unflatten the\n ANEL code in later maturity levels\n � The block comparison\n variable heavily depends on opaque predicate conditions\n\n\n-----\n\n### Unflattening in Multiple Maturity Levels (Cont.)\n\n###### • The loop becomes simpler once opaque predicates are broken\n\n\n\n###### • Unflattening in later maturity levels makes another problem\n\n\n###### In MMAT_LOCOPT, The block comparison variable 0 4624F47C i t l t d i t bl k #9\n\n\n-----\n\n### Unflattening in Multiple Maturity Levels (Cont.)\n\n###### • The block will be eliminated in later maturity levels\n\n • The modified code\n � Links between block comparison variables and block\n addresses in MMAT_LOCOPT � Guesses the block numbers in later maturity levels by using\n each block and instruction addresses\n\n\n-----\n\n### Control Flow Handling with Multiple Dispatchers\n\n###### • The original implementation assumes an\n\n\n###### obfuscated function has only one control flow dispatcher\n\n\n\n###### • Some functions in the ANEL sample have\n multiple dispatchers\n\n\n###### � up to seven dispatchers in one function\n\n\n-----\n\n### Control Flow Handling with Multiple Dispatchers (Cont.)\n\n###### • The modified code\n\n\n###### � catches the hxe_prealloc event then calls the\n optblock_t::func\n\n\n###### � This event occurs several times in MMAT_GLBOPT1 and\n\n\n###### MMAT_GLBOPT2 � utilizes different algorithms\n � control flow dispatcher / first block detection � block comparison variable validation\n\n\n-----\n\n### Control Flow Handling with Multiple Dispatchers (Cont.)\n\n###### • The modified code detects block comparison variable\n duplications and applies the most likely variable\n\n\n-----\n\n### Implementation for Various Jump Cases: The Originals\n\n\n###### (1) goto case for normal block\n\n from conditional block\n\n\n###### (2) conditional jump case for flattened if-statement block\n\n endsWithJCC\n\n false\n flattened\n\n\n###### blocks\n\n\n###### dispatcher predecessor\n\n\n###### l fl di h\n\n\n-----\n\n##### Cases: The Originals (Cont.)\n\n###### (2)\n\n\n-----\n\n### Implementation for Various Jump Cases: The Additions\n\n###### (3) goto N predecessors case (4) (2)+(3) combination case\n\n\n-----\n\n##### Cases: The Additions (Cont.)\n\n\n###### (3)\n\n\n-----\n\n##### p p Cases: The Additions (Cont.)\n###### (4)\n\n\n-----\n\n#### Implementation for Various Jump Cases: The Additions (Cont.)\n\n###### block #1 will be • (5) Block the successor comparison\n variables are\n of block #7\n assigned in the first blocks\n � The modified code\n reconnects first blocks as successors of the flattened block\n\n\n\n###### • I saw up to three\n assignments of the case in one function\n\n\n###### block #1 will be the successor of block #7\n\n\n-----\n\n# IDA 7.2 Issues and 7.3 Improvements\n\n\n-----\n\n## Evaluation on IDA 7.2\n\n###### • Tested ANEL samples\n\n\n###### � 5.4.1 payload [1]\n � 3d2b3c9f50ed36bef90139e6dd250f140c373664984b97a97a5\n a70333387d18d � 5.5.0 rev1 loader DLL [6]\n\n\n###### � f333358850d641653ea2d6b58b921870125af1fe77268a6fdfed\n a3e7e0fb636d\n\n • The modified tool could deobfuscate 92% of the\n obfuscated functions that we encountered in the 5.4.1 payload\n\n\n-----\n\n### Evaluation on IDA 7.2 (Cont.)\n\n###### • The causes of the failures\n\n\n###### � The next block number guessing algorithm failed\n\n\n###### � Propagations of opaque predicates deobfuscation\n failed\n\n\n###### resolved in this case\n\n\n###### � No method to handle a conditional jump of a\n dispatcher predecessor with multiple predecessors\n\n\n###### resolved in IDA 7.3\n\n\n-----\n\n### IDA 7.3: Propagation of Opaque Predicates Deobfuscation\n\n\n###### aliased stack slots 7.2\n\n always 0xC1A18C30 (signed)\n\n\n-----\n\n#### IDA7.3: Handling a Conditional Jump of a Dispatcher Predecessor\n\n###### • All jump cases (1)-(5) can be conditional\n\n\n###### � (2)-(4) cases require a mblock_t duplication\n\n\n\n###### • IDA 7.3 provides the option\n � clear the flag MBA2_NO_DUP_CALLS � use mbl_array_t::insert_block API then copy\n instructions and other information � adjust destinations of the blocks passing a control to\n the exit block whose block type is BLT_STOP\n\n\n-----\n\n#### Conditional Jump Case (2)\n\n\n###### BLT_1WAY\n\n BLT_2WAY\n\n\n-----\n\n#### Conditional Jump Case (3)\n\n\n###### preds can be conditional too\n\n\n-----\n\n#### Conditional Jump Case (4)\n\n\n###### tested samples :-)\n\n\n###### preds can be conditional too\n\n\n-----\n\n### Workaround in Control Flow Unflattening Failure\n\n###### • The plugin execution with 0xdead deobfuscates\n only opaque predicates in the current selected function\n\n\n###### idc.load_and_run_plugin(\"HexRaysDeob\", 0xdead)\n\n\n###### idc.load_and_run_plugin(\"HexRaysDeob\", 0xf001)\n\n\n-----\n\n# Wrap-up\n\n\n-----\n\n## Wrap-up\n\n###### • The compiler-level obfuscations are starting to\n\n\n###### be observed in the wild\n � The automated deobfuscation is needed\n\n\n\n###### • The modified code is available publically [7]\n � 1570 insertions(+), 450 deletions(-) � It works for almost every obfuscated function of\n APT10 ANEL on IDA 7.3\n\n\n-----\n\n## Acknowledgement\n\n###### • Hex-Rays\n\n\n\n###### • Rolf Rolles\n\n • TAU members\n\n\n###### � especially Jared Myers and Brian Baskin\n\n\n-----\n\n## References\n\n###### • [1] https://www.fireeye.com/blog/threat-research/2018/09/apt10-targeting japanese-corporations-using-updated-ttps.html\n\n\n\n###### • [2] https://jsac.jpcert.or.jp/archive/2019/pdf/JSAC2019_6_tamada_jp.pdf\n\n • [3] http://www.hexblog.com/?p=1248\n\n\n\n###### • [4] https://github.com/RolfRolles/HexRaysDeob\n\n • [5] https://www.hexblog.com/?p=1232\n\n\n\n###### • [6] https://www.secureworks.jp/resources/at-bronze-riverside-updates-anel malware\n\n • [7] https://github.com/carbonblack/HexRaysDeob\n\n\n\n###### • [8] https://www.carbonblack.com/2019/02/25/defeating-compiler-level obfuscations-used-in-apt10-malware/\n\n\n-----\n\n## Questions?\n\n###### • [Q1] What’s the obfuscating compiler?\n\n\n###### � [A1] Not sure but it may be Obfuscator-LLVM\n\n • [Q2] This tool works for other samples with\n\n\n###### similar obfuscations?\n � [A2] Yes only if\n\n\n###### � Q1 is resolved � the compiler algorithm and implementation have been\n thoroughly investigated\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.virusbulletin.com/uploads/pdf/conference_slides/2019/VB2019-Haruyama.pdf"
    ],
    "report_names": [
        "VB2019-Haruyama.pdf"
    ],
    "threat_actors": [
        {
            "id": "ec14074c-8517-40e1-b4d7-3897f1254487",
            "created_at": "2023-01-06T13:46:38.300905Z",
            "updated_at": "2025-03-27T02:00:02.799108Z",
            "deleted_at": null,
            "main_name": "APT10",
            "aliases": [
                "TA429",
                "STONE PANDA",
                "POTASSIUM",
                "Red Apollo",
                "HOGFISH",
                "Cloud Hopper",
                "BRONZE RIVERSIDE",
                "ATK41",
                "G0045",
                "Menupass Team",
                "happyyongzi",
                "CVNX",
                "Granite Taurus"
            ],
            "source_name": "MISPGALAXY:APT10",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ba3fff0c-3ba0-4855-9eeb-1af9ee18136a",
            "created_at": "2022-10-25T15:50:23.298889Z",
            "updated_at": "2025-03-27T02:00:55.433541Z",
            "deleted_at": null,
            "main_name": "menuPass",
            "aliases": [
                "menuPass",
                "POTASSIUM",
                "Stone Panda",
                "APT10",
                "Red Apollo",
                "CVNX",
                "HOGFISH",
                "BRONZE RIVERSIDE"
            ],
            "source_name": "MITRE:menuPass",
            "tools": [
                "certutil",
                "FYAnti",
                "UPPERCUT",
                "SNUGRIDE",
                "P8RAT",
                "RedLeaves",
                "SodaMaster",
                "pwdump",
                "Mimikatz",
                "PlugX",
                "PowerSploit",
                "ChChes",
                "cmd",
                "QuasarRAT",
                "AdFind",
                "Cobalt Strike",
                "PoisonIvy",
                "EvilGrab",
                "esentutl",
                "Impacket",
                "Ecipekac",
                "PsExec",
                "HUI Loader"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "9e767b38-12ae-4ef7-9878-5ce1701066d7",
            "created_at": "2024-05-01T02:03:08.131819Z",
            "updated_at": "2025-03-27T02:05:17.413497Z",
            "deleted_at": null,
            "main_name": "NICKEL ACADEMY",
            "aliases": [
                "COVELLITE ",
                "CTG-2460 ",
                "Diamond Sleet ",
                "Guardians of Peace",
                "HIDDEN COBRA ",
                "High Anonymous",
                "Labyrinth Chollima ",
                "NNPT Group",
                "New Romanic Cyber Army Team",
                "Temp.Hermit ",
                "The Lazarus Group ",
                "UNC577 ",
                "Who Am I?",
                "Whois Team",
                "ZINC ",
                "Black Artemis "
            ],
            "source_name": "Secureworks:NICKEL ACADEMY",
            "tools": [
                " DarkMessenger",
                " Destover",
                " Duuzer",
                " HOPLIGHT",
                " Joanap",
                " KorHigh",
                " LiveJinx",
                " Volgmer",
                "Brambul"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "ba9fa308-a29a-4928-9c06-73aafec7624c",
            "created_at": "2024-05-01T02:03:07.981061Z",
            "updated_at": "2025-03-27T02:05:17.28602Z",
            "deleted_at": null,
            "main_name": "BRONZE RIVERSIDE",
            "aliases": [
                "CTG-5938 ",
                "CVNX ",
                "Hogfish ",
                "MenuPass ",
                "POTASSIUM ",
                "Red Apollo ",
                "Stone Panda ",
                "APT10 "
            ],
            "source_name": "Secureworks:BRONZE RIVERSIDE",
            "tools": [
                " ChChes",
                " Cobalt Strike",
                " PlugX",
                " PoisonIvy",
                " QuasarRAT",
                " QuasarRAT Loader",
                " RedLeaves",
                "ANEL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "4c68ccd0-caba-4189-9ead-86ac4c2d9b70",
            "created_at": "2024-05-01T02:03:07.930196Z",
            "updated_at": "2025-03-27T02:05:17.251237Z",
            "deleted_at": null,
            "main_name": "BRONZE ATLAS",
            "aliases": [
                "Axiom",
                "BARIUM ",
                "Blackfly ",
                "CTG-2633",
                "GREF",
                "Group 72 ",
                "Red Kelpie ",
                "TG-2633 ",
                "Wicked Panda ",
                "Winnti",
                "APT41 "
            ],
            "source_name": "Secureworks:BRONZE ATLAS",
            "tools": [
                " CCleaner v5.33 backdoor",
                " ChinaChopper",
                " Cobalt Strike",
                " Dicey MSDN",
                " ForkPlayground",
                " HUC Proxy Malware (Htran)",
                " Mimikatz",
                " PipeMon",
                " PlugX",
                " PortReuse",
                " Powershell Empire",
                " RCMD",
                " RbDoor",
                " SPEEDBOAT",
                " ShadowPad",
                " Sidewalk",
                " Speculoos",
                " TeamViewer",
                " Winnkit",
                " Winnti",
                " reg save",
                " vssadmin",
                "Acehash"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "04b07437-41bb-4126-bcbb-def16f19d7c6",
            "created_at": "2022-10-25T16:07:24.232628Z",
            "updated_at": "2025-03-27T02:02:10.146043Z",
            "deleted_at": null,
            "main_name": "Stone Panda",
            "aliases": [
                "APT 10",
                "ATK 41",
                "Bronze Riverside",
                "CTG-5938",
                "CVNX",
                "Cuckoo Spear",
                "Earth Kasha",
                "Granite Taurus",
                "Happyyongzi",
                "Hogfish",
                "ITG01",
                "Operation A41APT",
                "Operation Cache Panda",
                "Operation ChessMaster",
                "Operation Cloud Hopper",
                "Operation Cuckoo Spear",
                "Operation New Battle",
                "Operation Soft Cell",
                "Operation TradeSecret",
                "Potassium",
                "Red Apollo",
                "Stone Panda",
                "TA429",
                "menuPass",
                "menuPass Team"
            ],
            "source_name": "ETDA:Stone Panda",
            "tools": [
                "Agent.dhwf",
                "Agentemis",
                "Anel",
                "AngryRebel",
                "BKDR_EVILOGE",
                "BKDR_HGDER",
                "BKDR_NVICM",
                "BUGJUICE",
                "CHINACHOPPER",
                "ChChes",
                "China Chopper",
                "Chymine",
                "CinaRAT",
                "Cobalt Strike",
                "CobaltStrike",
                "DARKTOWN",
                "DESLoader",
                "DILLJUICE",
                "DILLWEED",
                "Darkmoon",
                "DelfsCake",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "Ecipekac",
                "Emdivi",
                "EvilGrab",
                "EvilGrab RAT",
                "FYAnti",
                "Farfli",
                "Gen:Trojan.Heur.PT",
                "Gh0st RAT",
                "Ghost RAT",
                "GreetCake",
                "HAYMAKER",
                "HEAVYHAND",
                "HEAVYPOT",
                "HTran",
                "HUC Packet Transmit Tool",
                "Ham Backdoor",
                "HiddenFace",
                "Impacket",
                "Invoke the Hash",
                "KABOB",
                "Kaba",
                "Korplug",
                "LODEINFO",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "MiS-Type",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "NBTscan",
                "NOOPDOOR",
                "Newsripper",
                "P8RAT",
                "PCRat",
                "PlugX",
                "Poison Ivy",
                "Poldat",
                "PowerSploit",
                "PowerView",
                "PsExec",
                "PsList",
                "Quarks PwDump",
                "Quasar RAT",
                "QuasarRAT",
                "RedDelta",
                "RedLeaves",
                "Rubeus",
                "SNUGRIDE",
                "SPIVY",
                "SharpSploit",
                "SigLoader",
                "SinoChopper",
                "SodaMaster",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Trochilus RAT",
                "UpperCut",
                "Vidgrab",
                "WinRAR",
                "WmiExec",
                "Wmonder",
                "Xamtrav",
                "Yggdrasil",
                "Zlib",
                "certutil",
                "certutil.exe",
                "cobeacon",
                "dfls",
                "lena",
                "nbtscan",
                "pivy",
                "poisonivy",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716499,
    "ts_updated_at": 1743041834,
    "ts_creation_date": 1569836961,
    "ts_modification_date": 1569836961,
    "files": {
        "pdf": "https://archive.orkl.eu/e42a5389981236b65e5481d6985b2a63c544b2a8.pdf",
        "text": "https://archive.orkl.eu/e42a5389981236b65e5481d6985b2a63c544b2a8.txt",
        "img": "https://archive.orkl.eu/e42a5389981236b65e5481d6985b2a63c544b2a8.jpg"
    }
}