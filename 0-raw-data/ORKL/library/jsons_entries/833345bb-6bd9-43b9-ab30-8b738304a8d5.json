{
    "id": "833345bb-6bd9-43b9-ab30-8b738304a8d5",
    "created_at": "2023-01-12T15:02:10.426247Z",
    "updated_at": "2025-03-27T02:09:18.632406Z",
    "deleted_at": null,
    "sha1_hash": "eaed55c546ef0e5c7f9bec6b0baa3e5f3e6cb49e",
    "title": "2022-03-16 - Cobalt Strike Analysis and Tutorial- How Malleable C2 Profiles Make Cobalt Strike Difficult to Detect",
    "authors": "",
    "file_creation_date": "2022-05-28T16:52:23Z",
    "file_modification_date": "2022-05-28T16:52:23Z",
    "file_size": 3433109,
    "plain_text": "# Cobalt Strike Analysis and Tutorial: How Malleable C2 Profiles Make Cobalt Strike Difficult to Detect\n\n**[unit42.paloaltonetworks.com/cobalt-strike-malleable-c2-profile/](https://unit42.paloaltonetworks.com/cobalt-strike-malleable-c2-profile/)**\n\nChris Navarrete, Durgesh Sangvikar, Andrew Guan, Yu Fu, Yanhui Jia, Siddhart Shibiraj March 16, 2022\n\nBy [Chris Navarrete,](https://unit42.paloaltonetworks.com/author/chris-navarrete/) [Durgesh Sangvikar,](https://unit42.paloaltonetworks.com/author/durgesh-sangvikar/) [Andrew Guan,](https://unit42.paloaltonetworks.com/author/andrew-guan/) [Yu Fu,](https://unit42.paloaltonetworks.com/author/yu-fu/) [Yanhui Jia and](https://unit42.paloaltonetworks.com/author/yanhui-jia/) Siddhart\nShibiraj\n\nMarch 16, 2022 at 3:00 PM\n\n[Category: Tutorial](https://unit42.paloaltonetworks.com/category/tutorial/)\n\nTags: [C2,](https://unit42.paloaltonetworks.com/tag/c2/) [Cobalt Strike,](https://unit42.paloaltonetworks.com/tag/cobalt-strike/) [malleable C2 profile](https://unit42.paloaltonetworks.com/tag/malleable-c2-profile/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/cobalt-strike-malleable-c2-profile/)\n\n## Executive Summary\n\nCobalt Strike is commercial threat emulation software that emulates a quiet, long-term\nembedded actor in a network. This actor, known as Beacon, communicates with an external\nteam server to emulate command and control (C2) traffic. Due to its versatility, Cobalt Strike\nis commonly used as a legitimate tool by red teams – but is also widely used by threat actors\nfor real-world attacks.\n\nCobalt Strike users control Beacon’s HTTP indicators through a profile, and can select either\nthe default profile or a customizable Malleable C2 profile\n\n\n-----\n\nIn this blog post, we will go through the concepts and definitions associated with these\nprofiles, and explore differences between default and customized Malleable C2 profiles used\nin the Cobalt Strike framework as well as in some true attacks in the wild. In doing so, we\ndemonstrate how the Malleable C2 profile lends versatility to Cobalt Strike, and why this\nversatility makes Cobalt Strike an effective emulator for which it is difficult to design\ntraditional firewall defenses.\n\nPalo Alto Networks customers receive protections against malicious uses of Cobalt Strike\nthrough Cortex XDR and the WildFire and Threat Prevention subscriptions for the NextGeneration Firewall.\n\nRelated Unit 42 Topics [Cobalt Strike,](https://unit42.paloaltonetworks.com/tag/cobalt-strike/) [C2,](https://unit42.paloaltonetworks.com/tag/C2/) [Tutorials](https://unit42.paloaltonetworks.com/tag/wireshark-tutorial/)\n\n## Table of Contents\n\nProfile Options for Cobalt Strike\n\nGlobal Options\n\nLocal Options\n\nCobalt Strike Default Profile\n\nCustomized Cobalt Strike Profiles\n\nCases in the Wild\n\nDefault Profile Sample\n\nCustomized Profile Sample\n\nCobalt Strike Beacon Configuration\n\nConclusion\n\nIndicators of Compromise\n\nAdditional Resources\n\n## Profile Options for Cobalt Strike\n\nThe Cobalt Strike tool’s primary configuration is specified using a profile file. The tool uses\nthe values present in the profile to generate the Beacon payload, and users create the profile\nand set its values with a Malleable Command and Control (C2) profile language.\n\nThe profile specifies how the beacon will transform and store data in a transaction.\n\nWithin a profile, options are divided into global options and local options. Global options\nupdate the global Beacon settings, while local options are transaction-specific. Local option\nchanges within one transaction do not affect the output from other transactions.\n\nThe profile is divided into multiple sections to specify the values for different parts of the C2\n[communications. An example of a generic structure of the profile is as follows:](https://trial.cobaltstrike.com/help-malleable-c2)\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\n# this is a comment\nset global_option \"value\";\n\nprotocol-transaction {\nset local_option \"value\";\n\nclient {\n# customize client indicators\n}\n\nserver {\n# customize server indicators\n}\n}\n\n\nDifferent parts of the profile are explained below.\n\n### Global Options\n\nGlobal options are global to C2 communications. Options such as sleeptime and jitter define\nthe frequency of Beacon’s check-in with the team server. Here is a list of a few global options\nwith example values:\n\n\n1\n2\n3\n4\n5\n\n\nset sample_name \"Profile Name\";\nset sleeptime \"30000\";\nset jitter  \"20\";\nset useragent \"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML,\nlike Gecko) Chrome/55.0.2883.87 Safari/537.36\";\nset host_stage \"false\";\n\n\nIf you are interested in a more comprehensive list of all the global options, refer to this Cobalt\nStrike user guide.\n\n### Local Options\n\nOn the other hand, the scope for local options is per transaction only. The options for one\ntransaction do not affect the other.\n\nExamples of Local options:\n\n\n1\n2\n3\n4\n\n\nset uri \"URI_For HTTP transaction\";\nset verb \"POST\";\nset uri_x86 \"StagetURI_for_x86\";\nset uri_x64 \"StagetURI_for_x64\";\n\n\n-----\n\nIn addition to these options, a profile can specify different protocol-transactions to carry out\ndifferent actions. Below are example transactions, as well as brief explanations of their\nusage:\n\n**http-stager: The Beacon is a staged payload. The stager downloads the file and**\ninjects it into memory. The values listed in this transaction are customizing the HTTP\ncommunication for downloading the beacon.\n**dns-beacon: After Cobalt Strike v4.3, DNS options became part of the dns-beacon**\ntransaction. This transaction modifies the DNS C2 communication. If you are interested\nin a more comprehensive list of all the dns-beacon options, refer to this Cobalt Strike\nuser guide.\n**http-get: The http-get transaction customizes the HTTP communication between the**\nBeacon and the team server. The Beacon starts by sending the HTTP request with\nmetadata about the compromised system. If the team server has tasks to execute, the\nserver sends an HTTP response.\n**http-post: Once the Beacon executes the tasks sent by the server, the output of the**\ntask is transferred in the http-post transaction. The values listed in this transaction\naffect the HTTP communication when the task output is sent over to the server.\n**https-certificate: If the Beacon is tasked to communicate over HTTPS, The team**\nserver generates a self-signed certificate. The team server uses http-get and http-post\ntransaction values to create actual HTTP requests and responses. This profile\ntransaction can help to specify the different parameters for SSL certificates. If you are\ninterested in a more comprehensive list of all the http-certificates options, refer to this\n[Cobalt Strike user guide.](https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2_self-signed-ssl-certificates.htm#_Toc65482846)\n\n\n-----\n\nFigure 1. Cobalt Strike default profile.\n\n## Cobalt Strike Default Profile\n\nThe default profile will be loaded if no other customized profiles are specified. Figure 1,\nabove, is the specification of the default profile, and Figure 2, below, is an example of traffic\ncapture from the default profile using the web drive-by-download option in a Cobalt Strike\nteam server.\n\n\n-----\n\nFigure 2. An example traffic capture from the default profile.\nFrom Figure 2, you can see that there are several HTTP transactions of GET and POST\nrequests and responses.\n\nFor GET requests, most of the request URIs are very short and have predefined\npatterns. The URIs are randomly chosen from the list of URIs specified under set uri in\nthe default profile in Figure 1 (see Table 1 below for the complete list). Malicious\nattackers can easily modify the URI to arbitrary strings if they use a customized profile\nwith set uri options inside the http-get section. This also explains why a pattern-based\nsignature might catch the Cobalt Strike traffic using default profiles very well, but fail to\ncapture any variations with customized profiles.\nFor POST requests, there is a predefined pattern – /submit.php?id= – in the URI. The\nID value is randomly generated. Similar to the possibilities for HTTP GET requests,\nmalicious attackers can easily modify the URIs to arbitrary strings if they use\ncustomized profiles with set uri options inside the http-post section.\n\nIndex URIs Index URIs Index URIs\n\n1 /ca 8 /fwlink 15 /push\n\n2 /dpixel 9 /cm 16 /ptj\n\n3 /__utm.gif 10 /cx 17 /j.ad\n\n4 /pixel.gif 11 /pixel 18 /ga.js\n\n5 /g.pixel 12 /match 19 /en_US/all.js\n\n6 /dot.gif 13 /visit.js 20 /activity\n\n7 /updates.rss 14 /load 21 /IE9CompatViewList.xml\n\nTable 1. Possible URIs specified in the Cobalt Strike default profile.\n\n## Customized Cobalt Strike Profiles\n\n\n-----\n\nPublic Malleable C2 profiles are available and can be downloaded in public repositories,\n[such as from the official profiles examples on GitHub. These profiles can be loaded by the](https://github.com/rsmudge/Malleable-C2-Profiles)\nteam server and used as a Beacon download for C2 communications.\n\n[As an example, we walk through the etumbot profile to explain in more detail below.](https://github.com/rsmudge/Malleable-C2-Profiles/blob/master/APT/etumbot.profile)\n\n1. Global Options.\n\nSleeptime: The sleep time for the beacon callback is 5,000 milliseconds (5s).\nJitter: The jitter to set % is 0. In this example, the Beacon will call back every 5s\nbecause of the jitter value 0.\nMaxdns: The maximum length of hostname is 255 when uploading data over DNS.\nUserAgent: Set the HTTP C2 request useragent as \"Mozilla/5.0 (compatible; MSIE 8.0;\nWindows NT 6.1; Trident/5.0)\"\n\nFigure 3. Global options in Etumbot profile.\n2. Beacon check-In to get task from teamserver with HTTP GET request.\n\nBelow the global options, we find the following option configurations about HTTP request and\nresponse. Figures 4 and 5, below, show this configuration, which include URI, header and\nmetadata information for both the client and the server.\n\n\n-----\n\nFigure 4. HTTP GET request options in Etumbot profile.\n\n\n-----\n\nFigure 5. HTTP GET request in live traffic.\n3. Beacon task execution result submission to teamserver with HTTP POST request.\n\nWe can find the following option configuration about HTTP response from Figure 6 below, as\nwell as what the POST C2 traffic looks like in Figure 7.\n\n\n-----\n\nFigure 6. HTTP POST request options in Etumbot profile.\n\n\n-----\n\nFigure 7. HTTP POST request options in live traffic.\n\n## Cases in the Wild\n\nThe following sections show two different cases of Cobalt Strike payloads used in the wild:\none using the default option (no profiles) and the other with a custom profile. Both samples\nhave no trigger on VirusTotal at the time of this writing, but Palo Alto Networks identified\nthem using static and dynamic analysis.\n\n### Default Profile Sample\n\nSHA256 Hash: 6a6e5d2faeded086c3a97e14994d663e2ff768cb3ad1f5a1aa2a2b5fd344dde2\n\n\n-----\n\nFigure 8. Cobalt Strike HTTP GET Beacon download request.\n\nFigure 9. Cobalt Strike HTTP GET heartbeat request.\n\n\n-----\n\nFigure 10. Cobalt Strike HTTP POST call-back request.\nAs seen in Figures 9 and 10, the GET and POST requests follow from the configuration\noptions specified in the default profile. The GET request URI is /load (Figure 9), which is one\nof the default options for GET requests, and the POST request URI is /submit.php (Figure\n10), which is the default option for POST requests. If all Cobalt Strike traffic used these\ndefault URIs, it would be much easier to write signatures to identify Cobalt Strike traffic;\nhowever, these signatures would not be able to identify traffic originating from customized\nprofiles, as shown in the next example.\n\n### Customized Profile Sample\n\nSHA256 Hash: fcdc426289dab0e5a73cd6fbac928ad48a8ff9b67e1d37df2794af6e7fa559e9\n\n\n-----\n\nFigure 11. Cobalt Strike HTTP GET Beacon download request.\n\nFigure 12. Cobalt Strike HTTP GET heartbeat request.\n\n\n-----\n\nFigure 13. Cobalt Strike HTTP POST call-back request.\nAs we can see in Figures 12 and 13, the GET and POST request URIs have changed from\nthe default profile. Both of these URIs are prepended with /MicrosoftUpdate in order to seem\nlike a legitimate HTTP request to Microsoft servers for regular Windows updates – but are\nactually request and response traffic from C2 servers. This is how Cobalt Strike traffic from\ncustomized profiles can be so flexible and difficult to detect.\n\n## Cobalt Strike Beacon Configuration\n\nIn addition to the differences in GET and POST request parameters mentioned previously,\nCobalt Strike Beacon configuration differs between default and custom profiles, and it\ncontains useful metadata according to the settings in a Malleable C2 profile, which includes\nencoding types, blog submission mechanisms, instructions used to perform data\ntransformations and other properties. By leveraging Didier Stevens’s [1768.py script, a](https://blog.didierstevens.com/2021/11/21/update-1768-py-version-0-0-10/)\nresearcher can decode and extract Cobalt Strike Beacon configurations. Didier is a security\nresearcher known for his development of several analysis tools and other security-related\ntopics.\n\n\n-----\n\nFigure 14. Custom profile Beacon configuration Metadata.\nFigure 14 shows extracted configuration metadata for a custom profile Beacon. The most\nvisible differences between a default profile and a custom profile Beacon configuration are\nthe number of instructions and data transformations, as well as the HTTP parameters used.\n\nThe table below shows the full list of differences between configuration metadata of the\ndefault and custom profile samples found in the wild that were previously discussed.\n\n**Default Profile (Beacon /Iya9)** **Custom Profile (Beacon /api/1)**\n\n\n-----\n\n0x000a post-uri\n\n0x0003 0x0040 '/submit.php'\n\n0x000b Malleable_C2_Instructions\n\n0x0003 0x0100\n\nTransform Input: [7:Input,4]\n\nPrint\n\n0x000c http_get_header\n\n0x0003 0x0200\n\nBuild Metadata:\n\n[7:Metadata,3,6:Cookie]\n\nBASE64\n\nHeader Cookie\n\n0x000d http_post_header\n\n0x0003 0x0200\n\nConst_header Content-Type:\napplication/octet-stream\n\nBuild SessionId: [7:SessionId,5:id]\n\nParameter id\n\nBuild Output: [7:Output,4]\n\nPrint\n\n\n0x000a post-uri\n\n0x0003 0x0040 '/MicrosoftUpdate/GetUpdate/KB'\n\n0x000b Malleable_C2_Instructions\n\n0x0003 0x0100\n\nTransform Input: [7:Input,4]\n\nPrint\n\n0x000c http_get_header\n\n0x0003 0x0100\n\nConst_header User-Agent: Mozilla/4.0\n(Compatible; MSIE 6.0;Windows NT 5.1)\n\nConst_header Accept: */*, ..., ......, .\n\nBuild Metadata: [7:Metadata,11,5:tmp]\n\nNETBIOS uppercase\n\nParameter tmp\n\n0x000d http_post_header\n\n0x0003 0x0100\n\nConst_header Content-Type: application/octetstream\n\nConst_header User-Agent: Mozilla/4.0\n(Compatible; MSIE 6.0;Windows NT 5.1)\n\nBuild SessionId: [7:SessionId,1:/default.asp,12]\n\nAppend /default.asp\n\nUri_append\n\nBuild Output: [7:Output,4]\n\nPrint\n\n\nTable 2. Default profile vs custom Profile configuration meta-data.\n\n## Conclusion\n\nCobalt Strike is a potent post-exploitation adversary emulator. The Malleable C2 profile\ndetailed above is elaborate and is designed to evade security detections. A single security\nappliance is not equipped to prevent a Cobalt Strike attack. Only a combination of security\nsolutions – firewalls, sandboxes, endpoints and software to integrate all these components\ncan help prevent this kind of attack.\n\nPalo Alto Networks customers are protected from this kind of attack by the following:\n\n[1. Next-Generation Firewalls (NGFWs) with](https://www.paloaltonetworks.com/network-security/next-generation-firewall) [Threat Prevention signatures 86445 and](https://www.paloaltonetworks.com/products/secure-the-network/subscriptions/threat-prevention)\n\n86446 identify HTTP C2 requests with default profiles.\n[2. WildFire, an NGFW security subscription identifies and blocks Cobalt Strike Beacon.](https://www.paloaltonetworks.com/products/secure-the-network/wildfire)\n[3. AutoFocus users can track this activity using the](https://www.paloaltonetworks.com/products/secure-the-network/subscriptions/autofocus) [CobaltStrike tags](https://autofocus.paloaltonetworks.com/#/tag/Unit42.Cobaltstrike)\n\n## Indicators of Compromise\n\n### CS Samples\n\n6a6e5d2faeded086c3a97e14994d663e2ff768cb3ad1f5a1aa2a2b5fd344dde2\n\n\n-----\n\nfcdc426289dab0e5a73cd6fbac928ad48a8ff9b67e1d37df2794af6e7fa559e9\n\n### CS Beacon Samples\n\n/Iya9\n\n08e901d4ed0b43b46e632158f5ec5e900f16015e18995a875f62903a3c1eb1f9\n/api/1\n\nd8b385d680bcdf7646f35df612712f7a3991f50a21cac8379630d05b3d2337ae\n\n### CS Team Server Domain\n\nwww.symantecav[.]xyz\n\n### CS Team Server IP addresses\n\n66.42.72[.]250\n146.0.77[.]110\n\n## Additional Resources\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-16 - Cobalt Strike Analysis and Tutorial- How Malleable C2 Profiles Make Cobalt Strike Difficult to Detect.pdf"
    ],
    "report_names": [
        "2022-03-16 - Cobalt Strike Analysis and Tutorial- How Malleable C2 Profiles Make Cobalt Strike Difficult to Detect.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535730,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653756743,
    "ts_modification_date": 1653756743,
    "files": {
        "pdf": "https://archive.orkl.eu/eaed55c546ef0e5c7f9bec6b0baa3e5f3e6cb49e.pdf",
        "text": "https://archive.orkl.eu/eaed55c546ef0e5c7f9bec6b0baa3e5f3e6cb49e.txt",
        "img": "https://archive.orkl.eu/eaed55c546ef0e5c7f9bec6b0baa3e5f3e6cb49e.jpg"
    }
}