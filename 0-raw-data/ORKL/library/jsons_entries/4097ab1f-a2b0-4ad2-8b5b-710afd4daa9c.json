{
    "id": "4097ab1f-a2b0-4ad2-8b5b-710afd4daa9c",
    "created_at": "2023-01-12T14:59:19.786385Z",
    "updated_at": "2025-03-27T02:15:35.651941Z",
    "deleted_at": null,
    "sha1_hash": "51184521f5d561620b7f2170ab7327bf7a9ed4c2",
    "title": "2020-08-28 - TERRACOTTA Android Malware- A Technical Study",
    "authors": "",
    "file_creation_date": "2022-05-28T22:06:21Z",
    "file_modification_date": "2022-05-28T22:06:21Z",
    "file_size": 6242382,
    "plain_text": "# TERRACOTTA Android Malware: A Technical Study\n\n**[whiteops.com/blog/terracotta-android-malware-a-technical-study](https://www.whiteops.com/blog/terracotta-android-malware-a-technical-study)**\n\nThe [White Ops Satori Threat Intelligence & Research team has been actively defending](https://www.whiteops.com/satori?hsLang=en-us)\nagainst an ad fraud botnet—which we’ve codenamed TERRACOTTA—since late last year.\nToday we are revealing the technical details of the malware campaign in an effort to broaden\n[awareness. As we stated in our blog post, in a single week in June 2020, the operation](https://www.whiteops.com/blog/the-shoe-is-a-lie-how-an-android-botnet-defrauded-advertisers-and-consumers?hsLang=en-us)\n**generated more than two billion fraudulent bid requests, infected upwards of 65,000**\n**unwitting devices, and spoofed more than 5,000 apps.**\n\n\n-----\n\nA spokesperson from Google stated, Due to our collaboration with White Ops investigating\nthe TERRACOTTA ad fraud operation, their critical findings helped us connect the case to a\npreviously found set of mobile apps and to identify additional bad apps. This allowed us to\nmove quickly to protect users, advertisers and the broader ecosystem – when we determine\npolicy violations, we take action.”\n\nThe TERRACOTTA malware offered Android users free goods in exchange for downloading\nthe app—including shoes, coupons, and concert tickets—which users never received. Once\nthe app was installed and the malware activated, the malware used the device to generate\nnon-human advertising impressions purporting to be ads shown in legitimate Android apps.\nThis technical report goes into detail on the TERRACOTTA malware, covering the initial\napplication code, subsequent payload activation via its Command and Control (C2) server,\nand the mechanism through which the advertising fraud was executed.\n\n## Initial Download: Free goods app, with obfuscated React Native module\n\nThe initial download for TERRACOTTA apps is straightforward. The main application code\n(i.e. the APK) is written using the React Native cross-platform development framework and\njust renders a form that the user fills in to receive their ‘free’ goods. This initial part of the app\ncontains no malicious functionality. However, the underlying maliciousness of the app is\nalready hinted at in its permissions (which need to be specified in the APK at compile time):\nthey include permission.WAKE_LOCK and permission.FOREGROUND_SERVICE,\npermissions the Satori team typically observes in ad fraud malware that runs continuously on\na user device.\n\nAnother eyebrow-raising snippet of code further consolidates the assumption that the app is\nmore than meets the eye. Most of the strings inside the app are obfuscated behind an\nalgorithm specifically intended to thwart malware analysis. At run-time when a string is\ndecoded, the algorithm analyzes its own call stack and is designed to fail when it identifies a\nmodified stack - which is what happens when an analyst tries to hook the decryption routine\n(see below).\n\n\n-----\n\n_(click on any image in this report to enlarge)_\n\n_Figure 1. Deobfuscation routine used for one of the strings inside the initial APK. The_\n_algorithm uses an element in its own stacktrace as a pseudo-decryption-key, meaning that_\n_when the function is hooked, the stack trace changes and the resulting output of the_\n_deobfuscation routine is incorrect._\n\n_Source: White Ops Satori Threat Intelligence & Research Team_\n\nThe relevant TERRACOTTA code and its hidden functionality is found in a file named\n**_index.android.bundle within the resources directory of the app. This file mostly contains_**\nbenign React Native modules which are commonly found in legitimate apps and provide the\ncore capabilities of a React Native app. However, one of the modules stored here contains\nheavily obfuscated code. Analysis shows that this module handles C2 communication, which\nis achieved through the use of the messaging capability of Firebase, a widely used mobile\napp platform.\n\nThe use of Firebase push-messaging as a C2 is of particular note because - as information\nabout the device is uploaded to Firebase on installation, even for legitimate use cases - it\ngives the attacker a way to understand their install base (and potentially exclude certain\nhosts from downloading subsequent payloads) without writing bespoke code to exfiltrate\ninformation from the infected device. A push-messaging setup also means that the app\ndoesn’t need to frequently poll the C2 to check for updates, another standard sign of\nmalware.\n\n\n-----\n\n_Figure 2. Screenshot of obfuscated React Native code responsible for communicating with_\n_the malware’s C2 and loading further fraud modules._\n\n_Source: White Ops Satori Threat Intelligence & Research Team_\n\nBesides establishing the C2 channel with Firebase, the most notable feature of this\nobfuscated module is the presence of multiple eval JavaScript statements. These statements\n—artifacts of dynamic code execution--are responsible for loading further malicious modules\npushed to the device and executing them as part of the React Native app.\n\nThe ad fraud capability is activated via a push message from Firebase that contains a further\nReact Native module—named RNVlCore—which is obfuscated similarly to the previous one\nand appears to do two things:\n\nProvide a base platform for any subsequent malicious modules that are downloaded.\nThe main responsibility of the base platform is to ensure that any exceptions or errors\nthrown by subsequent modules are caught and suppressed without resulting in any\nnotification to the device’s user.\nTransfer further C2 responsibility away from Firebase to a different C2 server, used for\ndownloading the ad-fraud-specific related modules.\n\nNotable in the RNVlCore module sent by Firebase is the occurrence of a package name,\nstarting with com.viking that features consistently in all of the modules downloaded\nthereafter, indicating a solid link between the threat actor controlling Firebase and the\ndeveloper of the subsequent modules downloaded from elsewhere.\n\n_Figure 3. Screenshot of source code from the RNVlCore, referencing a Java class in the_\n_same package._\n\n_Source: White Ops Satori Threat Intelligence and Research_\n\n## Activation: Ad Fraud Module and supporting modules\n\n\n-----\n\nAfter the initial setup mentioned above, the main module focused on performing ad fraud\nloads, which we call the Looper module. It consists of a main entry-point, starting a series of\nconcurrent loops which are responsible for requesting tasks from their specific C2 endpoint\nand executing the tasks that are returned (visually represented in the Chart 1 Flow Chart).\nThe table below shows the functionality of each task type as well as any conditions that are\napplied before initiating them:\n\n**Task** **Conditions** **Task Description**\n\n\n_Pop_ 3 days\nsince install\n\nRequests\ntasks from\nC2 only\nfrom 2pm\nto 10pm\n\nRuns once\na day\n\n\nIf conditions allow, the received URL attempts to load.\n\nThe URL can be a deep link too (i.e. to open the play store, other\nOS apps, or a third party app that registered a URL schema).\n\n\n_Push_ N/A Logic deactivated.\n\n_Web_ None An invisible custom webview of 0x0 size is spawned and\nconfigured as specified by the C2, including user agent, origin,\nshared resources, event listeners, and JS injections.\n\nThe received task URL is loaded and runs in the webview for a\ntask defined amount of time (30 seconds by default).\n\n\n-----\n\n_Banner_ None An invisible webview of the size specified by the C2 is requested\nfrom the webview manager (spawned as necessary) and\nconfigured as specified, including user agent, origin, spoofed app\nheader, shared resources, event listeners, blocked\ndomains/resources, and JS injections.\n\nThe task HTML is loaded in the webview (no network requests)\nwith a hardcoded referer (loopme[.]com), and potentially clicked\non.\n\nA new cycle is started after 30 secs or the time specified by the\nprevious task received from C2.\n\n_Video_ None An invisible webview of the size specified by the C2 is requested\nfrom the video player module and configured as specified\n(including user agent, origin, shared resources, event listeners\n(including VAST events), blocked domains/resources, and JS\ninjections).\n\nThe task URL is loaded in the webview and potentially clicked on.\n\nThe Video ad is run using Loopme video SDK, which is present in\nthe module logic.\n\n_Feed_ None An invisible webview is requested and configured as specified by\nthe C2 (including user agent, event listeners).\n\nThe feed task includes several URLs which are loaded in order:\nicon, image, pixel.\n\nIf the task includes an additional URL, it’s loaded and left to run for\nsome time.\n\n_Table 1. Functionality of main ad fraud Looper module_\n_Source: White Ops Satori Threat Intelligence and Research_\n\nEach task type has a set of modules on which it depends, and is responsible for checking\nthat those dependencies are satisfied before running. For instance, the Banner task,\nresponsible for the majority of the fraud, is dependent on the WebViewManager module, a\nmodule that provides functions for manipulating and controlling a series of customized\nwebviews loaded on the device.\n\n\n-----\n\nModules that support the various task types above are downloaded as self-contained APK\nbinaries and loaded by the “RNVlCore” base module.\n\n_Chart 1. Infection chain flow chart._\n\n_Source: White Ops Satori Threat Intelligence and Research_\n\nBelow is a full list of these modules:\n\n\n**Webview**\n**management**\n\n**Networking**\n**management**\n\n**Screen**\n**management**\n\n\nThis module is extensive. It manages the download and updating of a\nspecialized webview from a location controlled by the threat actor.\n\n(see below for In-depth: WebView)\n\nBroadcast listeners are installed to monitor for connection changes, and\nalso pulls data from the isActiveNetworkMetered() system Android API.\n\nBroadcast listeners are installed to monitor for device locking, screen on\nand off, and “user present” broadcasts.\n\n\n-----\n\n**Battery**\n**management**\n\n**Service**\n**management**\n\n**Intent**\n**management**\n\n**Push**\n**notification**\n**management**\n\n**Video**\n**management**\n\n\nBroadcast listeners are installed to monitor for battery level changes,\ncharger connection, and disconnection.\n\nManages a foreground service using lots of reflection, implements a\nknown hack, named meta-reflection, to access hidden API methods in\nAndroid 7+ (flipping the setHiddenApiExemptions setting to remove\nrestrictions). Service initiation is done by hooking MESSAGING_EVENT\nfrom Firebase, and by setting timer events in React Native. The service is\ninitiated by being hooked to a notification activity.\n\nThis module has capabilities to collect the victim’s data (including phone\nnumber, voice messaging number, and installed apps), perform actions on\nthe device (including opening the camera app, opening device settings,\nand sending SMS messages) and even sharing images to social media\nnetworks (Instagram and Line - an app developed by Naver).\n\nHas methods that allow it to download an icon and push a notification with\nit.\n\nThis package includes a full video ads SDK and the logic necessary to\nmanage it. The video player includes logic to manage VAST video playing\nand tracking requests. This module deploys the video player in a webview\nand includes logic to interact with the webview for fraud actions. These\nactions include clicking, modifying outbound requests, and blocking code\nfrom certain domains from being loaded.\n\n\n_Table 2. Various modules loaded by base module._\n\n_Source: White Ops Satori Threat Intelligence and Research_\n\nIn addition to these specific modules, the Satori team observed the download of two\nexecutables as part of TERRACOTTA’s activation. These are downloaded in .so native\nlibrary format and are SOCKS proxies. Our team didn’t observe ad fraud activity specifically\nfrom these proxies, though ad fraud activity often uses proxies. Our assessment is these\nproxies are registering the infected device as part of a residential / mobile proxy network\nwhich is a common monetization mechanism for developers with mobile installs.\n\n## In-depth: Webview Module & customized webview binary built for Fraud\n\nOf all the modules downloaded as part of TERRACOTTA, the package with the most\ncomplete functionality is the Webview manager module, which we examine in detail in this\nsection.\n\n\n-----\n\nLike the other modules, the webview manager is downloaded as a React Native module, a\nfull APK, as shown below.\n\n_Figure 4. Screenshot of the decompiled source code of the webview manager module. As_\n_with all of the modules downloaded by TERRACOTTA, it takes the form of an APK and code_\n_is located under the package com.viking._\n\n_Source: White Ops Satori Threat Intelligence and Research_\n\nIn addition to the Webview manager module, a customized chromium APK is independently\ndownloaded (from an independent server), unpacked and loaded for the Webview Manager\nmodule to use. This level of modularity is another indicator that multiple threat actors are\nprobably involved in its development, and the level of customisation present in the webview\nbinary itself showcases the sophistication of the operation.\n\nThe Webview Manager module manages a collection of webviews, which are spawned from\nthe chromium APK. The manager will set spoofed values in those webview instances using\nthe custom logic in the Chromium webview binary.\n\nIn order to replace the default webview on the user’s device, the Webview management\nmodule overrides internal Android API restrictions by using a hack known as meta-reflection.\nThe module will also enable unencrypted HTTP traffic using the\n**setCleartextTrafficPermitted method in the network security policy class.**\n\nThe webview management module exposes many functions, which can be broadly\ncategorized as follows:\n\n**Resource Control**\n\n_browserSetMaxAmount() and webViewSetMaxAmount() control the number of webview_\ninstances which can be activated in parallel, helping to ensure the malware doesn’t use\ntoo much of the infected device’s resources and become unusable by the device\nowner. There are two functions because the number of webviews and the number of\n‘browsers’ (webviews disguised as mobile browsers) are controlled independently. Also\nnotable is webViewSetPreset() which allows blocking of all content from a specific\ndomain. This allows the malware to avoid executing ad verification services’ code,\nreferred to as tag evasion\n\n\n-----\n\n**Javascript to Native Commands**\nThe Javascript code running in the webviews (injected or loaded from remote servers)\ncommunicates with the native modules using a custom mechanism. The webview will\nlisten to JavaScript alert() notifications, and look for a prefix in the text of the alert\nmessage. If the message starts with the prefix, then the rest of the message is treated\nas a command. The observed commands were: close and tap.\n**_close instructs the Looper fraud module to dispose of the webview. This action is used_**\nwhen something went wrong in the webview JS context and the impression did not\nwork as expected.\n**_tap is used to request a click action on an element, passing the coordinates of where_**\nthe element is.\n\n_Figure 5. Javascript executed in the webview including the prefix for native code to receive_\n_and act. Function wrapping the close command._\n\n_Source: White Ops Satori Threat Intelligence and Research_\n\n\n-----\n\n_Figure 6. Native code in Webview Module receiving the onAlert messages, checking for the_\n_prefix and triggering the requested commands (close and tap)._\n\n_Source: White Ops Satori Threat Intelligence and Research_\n\n**User interaction and Navigation**\n\nThe module contains various ways of opening URLs, such as webViewNavigateByUrl()\nand webViewNavigateByData() as well as faking clicks using webViewClick(), which\nsends click actions (complete with X,Y coordinates) received from the main module’s\nfraud code to the actual webview instance.\n**Parameter modification to simulate multiple devices**\n\nThe module exposes functions to get and set the webview’s user agent parameter\n(which is often used by third parties to determine the type of device) as well as to clear\ncookies browsing data. This means TERRACOTTA has fine-grained control of each of\nthe webviews created and can ensure that they appear to be from a variety of devices\nas opposed to all loaded on a single device.\n\n## Operation: Generating Fraudulent Ad Traffic\n\n\n-----\n\nWhile much of the traffic generated from an infected device is directed towards legitimate\nadvertising networks for the purposes of monetization, some network traffic was suspected\nby White Ops analysts to have purposes other than acquiring and manipulating advertising\nnetworks.\n\nA domain was observed through the network traffic of the infected devices with behaviors\nthat suggested it was the C2/task server for TERRACOTTA’s ad fraud module including\nhosting the customized Webview and requesting the /banner endpoint.\n\nIn addition to using parameters specified directly by the C2, the Webview management\nmodule selects certain parameters for the fake traffic it creates. For instance the HTTP UserAgent is generated from a template, with one of a set of specified Chrome versions selected\nat random and inserted into the user-agent for each ad request.\n\n_Figure 7. Screenshot of the source code from the malware payload responsible for launching_\n_the webview with a specific configuration. Note the logic in this snippet that modifies the user_\n_agent string._\n\n_Source: White Ops Satori Threat Intelligence and Research_\n\nThe randomization of the Chrome version supplied in the user agent is likely done with the\nintention of device magnification, that is, an attempt to make a single infected device look like\nmany different devices. However, in aggregate this randomization becomes easily\nidentifiable and can be used as an identifying characteristic (as shown in the next section).\n\n## Global impact: 2 billion fraudulent requests in a week\n\n\n-----\n\nThe scale and global impact of TERRACOTTA was impressive. In a single week in June\n2020, the malware’s ad fraud operation was responsible for more than 2 billion fraudulent bid\nrequests, had upwards of 65,000 unwitting participating devices and spoofed more than\n5,000 apps.\n\n### Faking Chrome versions with outdated values\n\nThe original lead that led the Satori team to the identification of the TERRACOTTA campaign\nwas a highly uniform browser distribution and the presence of outdated Chrome mobile\nsessions.\n\nWhite Ops identified rotation of different versions of Chrome for Android across several older\nversions of Chrome, and while older versions of Chrome for Android certainly remain in the\necosystem, it was evident that TERRACOTTA was lying about its browser engine. The figure\nbelow shows an example of TERRACOTTA adapting its user agent spoofing strategy for a\nperiod in February 2020 in an effort to evade detection.\n\n_Figure 8: A time series chart showing Terracotta faking 10 different browser version, before_\n_updating to report only one more recent version._\n\n_Source: White Ops Satori Threat Intelligence and Research_\n\n### Spoofed app and referrer values\n\nOne of the initial challenges in isolating TERRACOTTA traffic was that White Ops assessed\nearly on that many of the values in the suspected TERRACOTTA traffic were “spoofed,”\nmeaning threat actors supplied false values for several fields. Although the scale and\nsophistication were considerable, the spoofed values appeared intentionally placed.\nAccepting this, White Ops surmised that somewhere in the threat actor’s technical stack\n(malware binary or in the configuration of the malware), could be a presence of hardcoded\nvalues required for spoofing the fields.\n\n\n-----\n\nA big portion of the TERRACOTTA traffic possessed a single value in the Referrer field of\nthe HTTP GET headers to attribute the traffic to loopme[.]com. (We do not believe that\nLoopMe is involved in this scheme. However the threat actors' intentions behind using the\nloopme referrer domain are not clear at this time.) This spoofed referrer was not consistent\nwith the app ID values provided in the session, even though the app ID values were also\nbeing spoofed. Armed with this knowledge, the Satori team identified both the traffic and\nmalware binaries for the TERRACOTTA attack.\n\n### Use of residential and cellular IP space in the United States\n\nThe traffic White Ops Satori identified as TERRACOTTA originated almost exclusively from\nresidential and cellular IP addresses. This observation supported the White Ops theory that\nmobile phone users were the victims of the botnet, contributing to the attack likely without\ntheir knowledge. While we observed TERRACOTTA traffic originating from several countries,\nthe majority of traffic originated from IP addresses in the United States (US).\n\n## Indicators of Compromise\n\nAll of the TERRACOTTA apps, which have been removed from the Google Play Store, are\nbased on React Native (RN). Indicators can be identified to discriminate RN apps using\nFirebase, adding more specific indicators to this threat in particular:\n\n1. A registered service with the following identifier:\n\n_io.invertase.firebase.messaging.RNFirebaseBackgroundMessagingService_\n2. The following permissions specified in the manifest:\n\n1. android.permission.FOREGROUND_SERVICE\n2. android.permission.WAKE_LOCK\n3. The presence of the following file: assets/index.android.bundle\n4. Multiple occurrences of the string “eval(c(“ within assets/index.android.bundle\n\n## Appendix A: All Identified Terracotta Apps\n\nAll of the following TERRACOTTA apps have been removed from the Google Play Store.\n[The list of all identified TERRACOTTA apps is available as a PDF here.](https://f.hubspotusercontent30.net/hubfs/3400937/Appendix%20A%20TERRACOTTA.pdf)\n\n[Previous Post](https://www.whiteops.com/learn/blog/marketing-fraud-with-business-impacts-threats-to-brands?hsLang=en-us)\n[Next Post](https://www.whiteops.com/learn/blog/the-shoe-is-a-lie-how-an-android-botnet-defrauded-advertisers-and-consumers?hsLang=en-us)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-08-28 - TERRACOTTA Android Malware- A Technical Study.pdf"
    ],
    "report_names": [
        "2020-08-28 - TERRACOTTA Android Malware- A Technical Study.pdf"
    ],
    "threat_actors": [
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535559,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1653775581,
    "ts_modification_date": 1653775581,
    "files": {
        "pdf": "https://archive.orkl.eu/51184521f5d561620b7f2170ab7327bf7a9ed4c2.pdf",
        "text": "https://archive.orkl.eu/51184521f5d561620b7f2170ab7327bf7a9ed4c2.txt",
        "img": "https://archive.orkl.eu/51184521f5d561620b7f2170ab7327bf7a9ed4c2.jpg"
    }
}