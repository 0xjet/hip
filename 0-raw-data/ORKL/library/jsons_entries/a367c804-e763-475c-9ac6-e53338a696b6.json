{
    "id": "a367c804-e763-475c-9ac6-e53338a696b6",
    "created_at": "2023-01-12T15:02:17.856723Z",
    "updated_at": "2025-03-27T02:05:57.28622Z",
    "deleted_at": null,
    "sha1_hash": "694a139c861adafade19906c797c0145392c9f7c",
    "title": "2015-10-28 - Reversing the C2C HTTP Emmental communication",
    "authors": "",
    "file_creation_date": "2022-05-27T18:59:14Z",
    "file_modification_date": "2022-05-27T18:59:14Z",
    "file_size": 1282772,
    "plain_text": "# Reversing the C2C HTTP Emmental communication\n\n**blog.angelalonso.es/2015/10/reversing-c2c-http-emmental.html**\n\nIn last [post l explained how it was possible to decrypt the initial C&C communication from the data dumped from memory, with the support of a](http://blog.angelalonso.es/2015/10/decrypting-emmental-blowfish-and-base64.html)\npython script. In this post, I am going to follow the same approach, but using the information from the captured network traffic.\n\nFor that I will capture with Wireshark all the communication with the C&C while the malware is running. Then I can export all the 'objects' in the\nHTTP connection, which means the content of the HTTP request and response.\n\n\n-----\n\nNow, I have e in a folder all the files with the objects from the HTTP request:\n\n$ ls main\nmain(1).php  main(11).php main(13).php main(15).php main(3).php  main(5).php  main(7).php  main(9).php\nmain(10).php main(12).php main(14).php main(2).php  main(4).php  main(6).php  main(8).php  main.php\n\n$ more main.php\ni=McsZtRV7Bv7ZjMSzwk5aIyZEiijP8F38NJcxd5VNElaIVxctxxX9UWCGbUaOIYRxhMxTtA8nBYmT%0A%2FkgJOPilsUZZyvc2swCziOJC5ae17wU\n[As the HTTP request is URL encoded, I need first to decode it, so I will adapt the python script created in this post to do it automatically. This is](http://blog.angelalonso.es/2015/10/decrypting-emmental-blowfish-and-base64.html)\nthe script:\n\n#!/usr/bin/python\n\nfrom Crypto.Cipher import Blowfish\nfrom Crypto import Random\nfrom struct import pack\nfrom binascii import hexlify, unhexlify\nimport sys\nimport urllib\n\nfile1 = sys.argv[1]\nfile_out = sys.argv[2]\n\nblfs_key = open('/path/to/the/blfs.key','r')\n\nurl_encode = open(file1,'r')\nurl_encode_2 = url_encode.read()\n\nurl_decode = urllib.unquote(url_encode_2).decode('utf8')\n\nfile_ciphertext_base64 = url_decode\nfile_blfs_key = blfs_key.read()\nciphertext_raw = file_ciphertext_base64.decode(\"base64\")\n\nIV = \"12345678\"\n_KEY = file_blfs_key\nciphertext = ciphertext_raw\nKEY = hexlify(_KEY)[:50]\ncipher = Blowfish.new(KEY, Blowfish.MODE_CBC, IV)\nmessage = cipher.decrypt(ciphertext)\nconfig_plain = open(file_out,'w')\nconfig_plain.write(message)\n\nWith this script it is easy to run a shell command with a loop 'for' to decrypt all the files in the directory. Bare in mind than the HTTP response\nare not URL encoded, so I will not need to perform that step on some of the files.\n\nNow I should have decrypted all the information from each object. Looking at the first two HTTP POST requests I see this is the case, but for\nthe third one, this is not the case and the data is still encrypted. What's going on here?\n\n\n-----\n\nI am going to take a look to the HTTP response from the server, what information is being sent?\n\n**A Public Key!! really interesting stuff...**\n\nActually, if I look further in the second HTTP request from the screenshot above I can see the following:\n\n$ more \"main(3).php\"\na:4....\n.....\ncjogVGhlIEFuZHJvaWQgUHJvamVjdCB8IGphdmEudmVyc2lvbjogMA==\n\n\";s:3:\"cmd\";s:7:\"get_key\";s:3:\"rid\";s:2:\"25\";s:4:\"data\";s:0:\"\";}\n\nThis looks to me like the malware sends a request for a key and the server replies with the public key. So the only possibility is that the\nmalware is using that key to encrypt the data so only the C&C can decrypt it with the private key.\n\n[To confirm this is the case, I am going to check the source code of the malware with 'androguard' as I explained in previous post.](http://blog.angelalonso.es/2015/10/malware-analysis-with-androguad.html)\n\nLooking at the code, I see there is a method with the string 'get_key' and I can see which other method is calling it:\n\nIn [10]: d.CLASS_Lorg_thoughtcrime_securesms_h_c.METHOD_c.pretty_show()\n########## Method Information\nLorg/thoughtcrime/securesms/h/c;->c()V [access_flags=public]\n########## Params\nlocal registers: v0...v2\n\n- return: void\n####################\n***************************************************************************\nc-BB@0x0 :\n0 (00000000) const-string    v0, 'get_key'\n1 (00000004) const-string    v1, ''\n2 (00000008) invoke-virtual   v2, v0, v1, Lorg/thoughtcrime/securesms/h/c;->a(Ljava/lang/String; Ljava/lang/String;)Ljava/lang/String;\n3 (0000000e) move-result-object v0\n4 (00000010) iput-object     v0, v2, Lorg/thoughtcrime/securesms/h/c;->c Ljava/lang/String;\n5 (00000014) invoke-virtual   v2, Lorg/thoughtcrime/securesms/h/c;->b()Ljava/lang/Boolean;\n6 (0000001a) move-result-object v0\n7 (0000001c) invoke virtual v0 Ljava/lang/Boolean; >booleanValue()Z\n\n\n-----\n\n8 (000000 ) o e esu t 0\n9 (00000024) if-eqz       v0, 5 [ c-BB@0x28 c-BB@0x2e ]\n\nc-BB@0x28 :\n10 (00000028) invoke-direct    v2, Lorg/thoughtcrime/securesms/h/c;->d()V [ c-BB@0x2e ]\n\nc-BB@0x2e :\n11 (0000002e) return-void\n\n***************************************************************************\n########## XREF\nF: Lorg/thoughtcrime/securesms/h/i; b (Landroid/content/Context;)V be\nT: Lorg/thoughtcrime/securesms/h/c; b ()Ljava/lang/Boolean; 14\nT: Lorg/thoughtcrime/securesms/h/c; d ()V 28\nT: Lorg/thoughtcrime/securesms/h/c; a (Ljava/lang/String; Ljava/lang/String;)Ljava/lang/String; 8\n\n####################\n\nWhen decompiling the code I end up with some interesting Java methods:\n\nLooking tat the Java code I can see that the public key is used. But also, looking deeper into the code, I find another interesting method:\n\nprivate String a(String p9)\n{\nString v1_0 = 0;\nString v0_0 = \"\";\ntry {\njavax.crypto.Cipher v2_1 = javax.crypto.Cipher.getInstance(\"RSA/ECB/PKCS1PADDING\");\nv2_1.init(1, this.d);\nString[] v3_2 = this.a(p9, 100);\njava.util.ArrayList v4_2 = new java.util.ArrayList();\nint v5 = v3_2.length;\n} catch (String v1) {\nreturn this.a.c(v0_0);\n}\nwhile (v1_0 < v5) {\nv4_2.add(android.util.Base64.encodeToString(v2_1.doFinal(v3_2[v1_0].getBytes()), 0));\nv1_0++;\n}\nv0_0 = android.text.TextUtils.join(\".\", v4_2);\nreturn this.a.c(v0_0);\n\n}\n\nSo basically, one method is for encryption and the other for decryption, and both of them are using the same public key. This is really\ninteresting stuff.\n\nSo this is whats going on so far:\n\n1. The compromised device sends the information encrypted with blowfish to the C&C\n\n\n-----\n\ne C&C se e ep es t O\n3. The compromised device requests the public key\n4. The C&C server replies with the public key\n5. The compromised device encrypts the information with the public key and sends to the C&C\n6. The C&C server can decrypt with it's private key\n7. The C&C server sends data encrypted with the private key ->I need to verify this\n8. The compromised device can decrypt with the public key > I need to verify this\n\nTo verify step 6 and 7, and as very quick PoC, I have created some Java code which takes the public key sent by the C&C and try to decrypt\nthe successive messages sent by the C&C.\n\nBingo! When I run the code I clearly see it works and my 'guess' was right:\n\nWhat is the information sent by the C&C? it looks like a new config.xml with new C&C URL..\n\nVery interesting..\n\nLooking to the code again, I see methods which performs the request for a new configuration file:\n\nIn [7]: d.CLASS_Lorg_thoughtcrime_securesms_xservices_b.source()\npackage org.thoughtcrime.securesms.xservices;\n\nclass b extends android.os.AsyncTask {\n\nandroid.content.Context a;\n\nfinal synthetic org.thoughtcrime.securesms.xservices.XRepeat b;\n\n\n-----\n\npub c b(o g t oug tc e secu es s se ces epeat p, a d o d co te t Co te t p )\n{\nthis.b = p1;\nthis.a = p2;\nreturn;\n}\n\nprotected varargs String a(String[] p4)\n{\norg.thoughtcrime.securesms.h.i.a(this.a);\norg.thoughtcrime.securesms.h.i.c(\"CONF\", \"Check pull off urls\", this.a);\norg.thoughtcrime.securesms.h.i.b(this.a);\norg.thoughtcrime.securesms.h.i.c(this.a);\norg.thoughtcrime.securesms.h.i.c(\"CONF\", \"Get config data from server\", this.a);\norg.thoughtcrime.securesms.h.i.j(this.a);\norg.thoughtcrime.securesms.h.i.c(\"DATA\", \"Send data to server\", this.a);\nreturn \"OK\";\n}\n\nprotected void a(String p1)\n{\nsuper.onPostExecute(p1);\nreturn;\n}\n\nprotected synthetic Object doInBackground(Object[] p2)\n{\nreturn this.a(((String[]) p2));\n}\n\nprotected synthetic void onPostExecute(Object p1)\n{\nthis.a(((String) p1));\nreturn;\n}\n\n}\n\nAs the HTTP request to the C&C are encrypted with the Public key, I can't decrypt it. However, I could check in memory the information before\nis encrypted.\n\nAnd this is what I found:\n\na:2:{s:7:\"LogCode\";s:4:\"CONF\";s:7:\"LogText\";s:27:\"Get config data from server\";}\n\nWhich matches the methods I checked previously :)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-10-28 - Reversing the C2C HTTP Emmental communication.pdf"
    ],
    "report_names": [
        "2015-10-28 - Reversing the C2C HTTP Emmental communication.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535737,
    "ts_updated_at": 1743041157,
    "ts_creation_date": 1653677954,
    "ts_modification_date": 1653677954,
    "files": {
        "pdf": "https://archive.orkl.eu/694a139c861adafade19906c797c0145392c9f7c.pdf",
        "text": "https://archive.orkl.eu/694a139c861adafade19906c797c0145392c9f7c.txt",
        "img": "https://archive.orkl.eu/694a139c861adafade19906c797c0145392c9f7c.jpg"
    }
}