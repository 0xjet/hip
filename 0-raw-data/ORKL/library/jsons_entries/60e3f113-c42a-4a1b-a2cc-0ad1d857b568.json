{
    "id": "60e3f113-c42a-4a1b-a2cc-0ad1d857b568",
    "created_at": "2023-01-12T15:03:38.99759Z",
    "updated_at": "2025-03-27T02:05:30.147281Z",
    "deleted_at": null,
    "sha1_hash": "2851cad3878c9e26f5615aaada47493a2a8f7723",
    "title": "2021-02-04 - Abusing Google Chrome extension syncing for data exfiltration and C&C",
    "authors": "",
    "file_creation_date": "2022-05-29T10:39:13Z",
    "file_modification_date": "2022-05-29T10:39:13Z",
    "file_size": 352456,
    "plain_text": "# SANS ISC: InfoSec Handlers Diary Blog - SANS Internet Storm Center SANS Site Network Current Site SANS Internet Storm Center Other SANS Sites Help Graduate Degree Programs Security Training Security Certification Security Awareness Training Penetration Testing Industrial Control Systems Cyber Defense Foundations DFIR Software Security Government OnSite Training InfoSec Handlers Diary Blog\n\n**isc.sans.edu/diary/27066**\n\n## Abusing Google Chrome extension syncing for data exfiltration and C&C\n\n**Published: 2021-02-04**\n\n**Last Updated: 2021-02-04 10:04:27 UTC**\n\n**by** [Bojan Zdrnja (Version: 1)](https://isc.sans.edu/handler_list.html#bojan-zdrnja)\n\n[7 comment(s)](https://isc.sans.edu/forums/diary/Abusing+Google+Chrome+extension+syncing+for+data+exfiltration+and+CC/27066/#comments)\nI had a pleasure (or not) of working on another incident where, among other things, attackers\nwere using a pretty novel way of exfiltrating data and using that channel for C&C\ncommunication. Some of the methods observed in analyzed code were pretty scary – from a\ndefender’s point of view, as you will see further below in this diary.\n\nThe code that was acquired was only partially recovered, but enough to indicate powerful\nfeatures that the attackers were (ab)using in Google Chrome, so let us dive into it.\n\n**_Google Chrome extensions_**\n\nThe basis for this attack were malicious extensions that the attacker dropped on the\ncompromised system. Now, malicious extensions are nothing new – there were a lot of\nanalysis about such extensions and Google regularly removes dozens of them from Chrome\nWeb Store, which is the place to go to in order to download extensions.\n\nIn this case, however, the attackers did not use Chrome Web Store but dropped the\nextension locally in a folder and loaded it directly from Chrome on a compromised\nworkstation. This is actually a legitimate function in Chrome – you can access it by going to\n_More Tools -> Extensions and enabling Developer mode, after which you can load any_\nextensions locally, directly from a folder by clicking on \"Load unpacked\":\n\n\n-----\n\nThe attackers created a malicious addon which pretended to be Forcepoint Endpoint\nChrome Extension for Windows, as shown in the figure below. Of course, the extension had\nnothing to do with Forcepoint – the attackers just used the logo and the name:\n\nWhen creating Chrome extensions, configuration of an extension is stored in a file named\n_manifest.json, which defines what permissions the extension has and many other_\nparameters. The manifest.json file that was used by this malicious extension is shown below,\nwith some parts redacted:\n\n\n-----\n\nThere are many parameters that can be used here, but the most important ones are the\nfollowing:\n\ncontent_scripts defines JavaScript files which will be injected in web pages defined in\nthe matches object (redacted from screenshot). This can be used by an attacker to add\narbitrary code to target web pages (think about changing content and stealing data)\npermissions defines permissions that the extension requires – in this example it is set\nto storage, to allow the extension to use the storage API\nbackground defines JavaScript files that will run when extension is loaded. This is\nwhere the attacker had their exfiltration and C&C features embedded. Background files\nare extremely powerful and allow a script to receive a message (and send it) in\nbackground (as the name says)\n\nThe majority of further analysis was based on the background scripts so I will skip details\nwhich are not interesting for this particular case.\n\nThe background script used the jQuery library, so the extension contained a legitimate\nversion of jQuery (hey, everyone wants their life easy). But there were also some things that I\nsaw for the first time, which is why I think this particular exploitation is novel.\n\nBefore showing the code, I must explain the attack goal of this particular attacker – they\nwanted to manipulate data in an internal web application that the victim had access to. While\nthey also wanted to extend their access, they actually limited activities on this workstation to\nthose related to web applications, which explains why they dropped only the malicious\n\n\n-----\n\nChrome extension, and not any other binaries. That being said, it also makes sense – almost\neverything is managed through a web application today, be it your internal CRM, document\nmanagement system, access rights management system or something else (which is why I\n[love teaching SEC542).](https://www.sans.org/cyber-security-courses/web-app-penetration-testing-ethical-hacking/)\n\nWith that in mind, let’s take a look at a part of a background script that was dropped by the\nmalicious Chrome extension. Even if you are not a JavaScript developer, the code should be\nrelatively understandable (once we explain what specific methods are used for):\n\nThis is what the code does:\n\nFirst, the attacker used the chrome.runtime.onConnectExternal.addListener method.\nThis method is part of the chrome.runtime API that is provided by the Chrome browser\nto extensions.\n\nonConnectExternal.addListener method allows a developer to setup a listener which\nwill be fired when a connection is made from another extension. Interesting, so this\nallows for communication between extensions.\nThen the attacker calls the port.onMessage.addListener method. The Port object\nallows for two way communication, so our extensions can have a nice conversation.\nThe rest sets up a listener which will be called when the other extension calls\npostMessage() – that’s how messages are sent between extensions.\nAfter some debugging that was left there by the attacker (the console.log request),\nthere is a switch that checks the value of parameter type in the received message (this\nis just an excerpt from a bigger switch case).\nNow an interesting thing happens: if the value of the type parameter is\n“check_oauth_token_status”, the extension will verify if there is a key called\n“oauth_token” in Chrome’s storage. If it is there, it will send back (to the other\nextension) a message containing the value of the token with the status set to true, after\nwhich it will be deleted from Chrome’s storage.\n\n\n-----\n\nIf the value of the type parameter is save_mailhighlight_token, the extension will\ncreate a new key in Chrome’s storage called email, with the value of “highlight_token”\nassigned to it. This key will be saved in Chrome’s storage.\n\nThis is hopefully readable in the code, but wait the best thing is yet to come: since the\nextension is using chrome.storage.sync.get and chrome.storage.sync.save methods (instead\nof chrome.storage.local), all these values will be automatically synced to Google’s cloud\n**by Chrome, under the context of the user logged in in Chrome. In order to set, read or**\ndelete these keys, all the attacker has to do is log in with the same account to Google, in\nanother Chrome browser (and this can be a throwaway account), and they can communicate\nwith the Chrome browser in the victim’s network by abusing Google’s infrastructure!\n\nWhile there are some limitations on size of data and amount of requests, this is actually\nperfect for C&C commands (which are generally small), or for stealing small, but sensitive\ndata – such as authentication tokens!\n\nFor me, this was the first time I have seen something like this, so I naturally wanted to test it\nto see how things are working – and you can do the same thing.\n\nFor testing you can use any extension you have, as long as it requested the storage\npermission. For this demo I will be using the Google Docs Offline extension, something a lot\nof users might have installed in their browser (and I do as well). Select developer mode and\nin the extension click on the background page link:\n\nNow the DevTools console will open that will allow you to issue commands as this extension\ndirectly – normally an attacker would put code into files as described above, but for the test\nwe will be executing commands directly. Go to the Console tab and now you can use the\nAPI’s directly. Let’s store and sync a test message over Google’s infrastructure:\n\n\n-----\n\nThis will create a key called “SANS” with the value of “Hello from Internet Storm Center” and\nwill sync it to this account. The sync will not happen instantly, but in my tests it was synced\nusually in 10-15 seconds at the most. Now let me log in on my other machine, open the\nDevTools console same as above and read this key (notice this is done on a Mac):\n\nWoot! It worked! So we can use this to “have a chat” between these two machines, over\nGoogle’s infrastructure. As you can imagine, this can be used as both a C&C communication\nchannel, but also for slow exfiltration of data. It will be slow because Chrome and Google\nthrottle requests. Specifically, a key can be up to 8 KB (8192) bytes in size, with a maximum\nnumber of keys being 512, allowing us to transfer 4 MB at a time. Besides this, Chrome will\nallow 2 set, remove or clear operations per second or 1800 operations per hour. Hmm, when\nI think about it, it’s not that slow really.\n\nI was, of course, also interested into what this looks like on the wire and if it is possible to\nmaybe detect such abuse of Chrome’s extensions.\n\nAll requests Chrome is making are directed to clients4.google.com, over HTTPS. The\nrequest syncing the key I set previously is shown below:\n\n\n-----\n\nNow, if you are thinking on blocking access to clients4.google.com be careful – this is a very\nimportant web site for Chrome, which is also used to check if Chrome is connected to the\nInternet (among other things).\n\nIn the request shown in the figure above the body is GZIP compressed. It contains a\nserialized object which contains also the key that was set. In case you are intercepting your\nbrowser traffic on the edge (for example, with an interception proxy), this will make analysis\n(much) more difficult, but luckily the requests always appear to be going to the /chrome-sync/\nendpoint, so this is something you can block or alert on.\n\nBesides this, I would recommend that (depending on your environment) Chrome extensions\nare controlled; Google allows you to do that through group policies so you can define exactly\nwhich extensions are allowed/approved and block everything else.\n\nHope you enjoyed this little analysis of how scary web browser extensions can be!\n\n-Bojan\n[@bojanz](https://twitter.com/bojanz)\n[INFIGO IS](http://www.infigo.hr/)\n\n[Keywords: cc](https://isc.sans.edu/tag.html?tag=cc) [chrome](https://isc.sans.edu/tag.html?tag=chrome) [exfiltration](https://isc.sans.edu/tag.html?tag=exfiltration) [extension](https://isc.sans.edu/tag.html?tag=extension)\n[7 comment(s)](https://isc.sans.edu/forums/diary/Abusing+Google+Chrome+extension+syncing+for+data+exfiltration+and+CC/27066/)\n\nJoin us at SANS! Attend Web App Penetration Testing and Ethical Hacking with Bojan Zdrnja in\nOnline | Central European Summer Time starting Jul 25 2022\n\n\n-----\n\nTop of page\n×\n\n[Diary Archives](https://isc.sans.edu/diaryarchive.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-02-04 - Abusing Google Chrome extension syncing for data exfiltration and C&C.pdf"
    ],
    "report_names": [
        "2021-02-04 - Abusing Google Chrome extension syncing for data exfiltration and C&C.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535818,
    "ts_updated_at": 1743041130,
    "ts_creation_date": 1653820753,
    "ts_modification_date": 1653820753,
    "files": {
        "pdf": "https://archive.orkl.eu/2851cad3878c9e26f5615aaada47493a2a8f7723.pdf",
        "text": "https://archive.orkl.eu/2851cad3878c9e26f5615aaada47493a2a8f7723.txt",
        "img": "https://archive.orkl.eu/2851cad3878c9e26f5615aaada47493a2a8f7723.jpg"
    }
}