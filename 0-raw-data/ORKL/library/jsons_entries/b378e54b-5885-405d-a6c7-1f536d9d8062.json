{
    "id": "b378e54b-5885-405d-a6c7-1f536d9d8062",
    "created_at": "2023-01-12T14:59:32.756609Z",
    "updated_at": "2025-03-27T02:05:47.293733Z",
    "deleted_at": null,
    "sha1_hash": "6066531c85ed38d9d64bccece89fcf694f58ce1d",
    "title": "2021-07-01 - Mirai_ptea Botnet is Exploiting Undisclosed KGUARD DVR Vulnerability",
    "authors": "",
    "file_creation_date": "2022-05-29T01:21:03Z",
    "file_modification_date": "2022-05-29T01:21:03Z",
    "file_size": 1108078,
    "plain_text": "# Mirai_ptea Botnet is Exploiting Undisclosed KGUARD DVR Vulnerability\n\n**[blog.netlab.360.com/mirai_ptea-botnet-is-exploiting-undisclosed-kguard-dvr-vulnerability-en/](https://blog.netlab.360.com/mirai_ptea-botnet-is-exploiting-undisclosed-kguard-dvr-vulnerability-en/)**\n\nHui Wang July 1, 2021\n\n1 July 2021 / [nday](https://blog.netlab.360.com/tag/nday/)\n\n## Overview\n\nOn 2021-06-22 we detected a sample of a mirai variant that we named `mirai_ptea`\n[propagating through a new vulnerability targeting KGUARD DVR. Coincidently, a day later,](https://www.kguard.com.tw/)\non June 23, we received an inquiry from the security community asking if we had seen a new\nDDoS botnet, cross-referencing some data, it was exactly this botnet that we had just\ndiscovered.\n\n### Timeline\n\n2021-03-22 Our historical data indicates the first probe against this vulnerability\n2021-06-22 We observed the `mirai_ptea sample exploiting this vulnerability to`\nspread\n2021-06-23 We got a tip from the security community that this botnet was being used\nfor ongoing DDoS attacks.\n2021-06-25 `mirai_aurora, another mirai variant, starts to use this vulnerability to`\npropagate\n\n## Vulnerability analysis\n\nGiven that we have not found public information on this vulnerability, we will hide some of the\nkey information here to prevent the vulnerability from being further abused.\n\nOne program on the KGUARD DVR firmware listens on port `***** at` `0.0.0.0 to`\nremotely execute system commands without authentication. The firmware released after\n2017 seems to have this fixed by modifying the listening address to `127.0.0.1 . Some of`\nthe exploited payloads are as follows.\n\n\n-----\n\n### Analysis of affected devices\n\nWe have discovered at least 3,000 or so online devices still have the vulnerability. The\naffected devices are as follows:\n\n**DeviceType** **ProductType** **HardVersion** **DefDeviceName**\n\nD1004NR DVR4-1600 DM-268A DVR4-1600\n\nD1004NR HY-DVR DM-268 720P-HY04N\n\nD1004NR HY-DVR DM-268A 720P-HY04N\n\nD1004NR HY-DVR DM-274 720P-HY04N\n\nD1004NR HY-DVR DM-274B 720P-HY04N\n\nD1004NR NHDR DM-274 NHDR-3204AHD\n\nD1004NR RL-AHD4n DM-268 720P-HY04N\n\nD1008NR 1093/508N-DVRBM08H DM-292 720P-HY08N\n\nD1008NR DVR8-1600 DM-298 DVR8-1600\n\nD1008NR DVR8-HDA10L DM-292 DVR8-HDA10L\n\nD1008NR HD881 DM-292 HD881\n\nD1008NR HY-DVR DM-292 720P-HY08N\n\nD1008NR HY-DVR DM-298 720P-HY08N\n\nD1008NR NHDR DM-298 NHDR-3208AHD\n\nD1008NR RL-AHD8n DM-292 720P-HY08N\n\nD1016NR DVR16-HDA10L DM-303 DVR16-HDA10L\n\nD1016NR HD1681 DM-303 HD1681\n\nD1016NR HY-DVR DM-303A 720P-HY16N\n\nD1016NR HY-DVR DM-310 720P-HY16N\n\nD1016NR HY-DVR DM-310A 720P-HY16N\n\nD1016NR NHDR DM-310 NHDR-3216AHD\n\nD1016NR RL-MHD16n(21A) DM-310A 720P-HY16N\n\nD1104 HY-DVR DM-290A 1080P-HY04\n\n\n-----\n\n**DeviceType** **ProductType** **HardVersion** **DefDeviceName**\n\nD1104 NHDR DM-307 NHDR-5304AHD\n\nD1104NR HD1T4 DM-291A 1080P-04\n\nD1104NR HD481 DM-291 HD481\n\nD1104NR HRD-E430L DM-291A HRD-E430L\n\nD1104NR HY-DVR DM-284 1080P-HY04N\n\nD1104NR HY-DVR DM-291 \"Panda\n\nD1104NR HY-DVR DM-291 1080P-HY04N\n\nD1104NR HY-DVR DM-291A 1080P-HY04N\n\nD1104NR HY-DVR DM-291C LRA3040N\n\nD1104NR NHDR DM-307 NHDR-5104AHD\n\nD1104NR SDR-B73303 DM-291A SDR-B73303\n\nD1104NR SVR9204H DM-291A 1080P-HY04N\n\nD1108NR 1093/538P DM-290 1080P-HY08N\n\nD1108NR DVR8-4575 DM-290 DVR8-4575\n\nD1108NR DVR8-HDA10P DM-290 DVR8-HDA10P\n\nD1108NR HRD-E830L DM-290A HRD-E830L\n\nD1108NR HY-DVR DM-290 1080P-HY08N\n\nD1108NR HY-DVR DM-290A 1080P-HY08N\n\nD1108NR HY-DVR DM-290A LRA3080N\n\nD1108NR NHDR DM-307 NHDR-5108AHD\n\nD1108NR RL-AHD8p DM-290 1080P-HY08N\n\nD1108NR SDR-B74301 DM-290A SDR-B74301\n\nD1108NR SDR-B74303 DM-290A SDR-B74303\n\nD1116 HY-DVR DM-300 EHR-5164\n\nD1116NR HRD-E1630L DM-295 HRD-E1630L\n\n\n-----\n\n**DeviceType** **ProductType** **HardVersion** **DefDeviceName**\n\nD1116NR HY-DVR DM-295 1080P-HY16N\n\nD1116NR HY-DVR DM-295 LRA3160N\n\nD1116NR HY-DVR DM-299 1080P-HY16N\n\nD1116NR SDR-B75303 DM-295 SDR-B75303\n\nD1132NR HY-DVR DM-300 1080P-HY32\n\nD2116NR SDR-B85300 DM-300 SDR-B85300\n\nD973215U F9-DVR32 DM-195 F9-DVR32\n\nD9804AHD DVR DM-210 391115\n\nD9804NAHD AHD7-DVR4 DM-239 AHD7-DVR4\n\nD9804NAHD DVR DM-239 720P-DVR04ND\n\nD9804NAHD NHDR DM-239 NHDR-3104AHD-II\n\nD9808NRAHD AHD7-DVR8 DM-228 AHD7-DVR8\n\nD9808NRAHD DVR DM-228\n\nD9808NRAHD DVR DM-228 391116\n\nD9808NRAHD NHDR DM-228 NHDR-3108AHD-II\n\nD9808NRAHD NHDR DM-228 NHDR3108AHDII\n\nD9816NAHD DVR DM-233 720P-DVR016N\n\nD9816NAHD NHDR DM-233 NHDR3116AHDII\n\nD9816NRAHD AHD7-DVR16 DM-229 AHD7-DVR16\n\nD9816NRAHD DVR DM-229 720P-DVR016NB\n\nD9904 D9904 DM-237 1080P-DVR04\n\nD9904 DVR DM-237 1080P-DVR04\n\nD9904 NHDR DM-237 NHDR-5204AHD\n\nD9904NR DVR DM-244 1080P-DVR04N\n\nD9904NR DVR DM-244 BCS-VAVR0401M\n\n\n-----\n\n**DeviceType** **ProductType** **HardVersion** **DefDeviceName**\n\nD9904NR HY-DVR DM-244 CVD-AF04S\n\nD9904NR N420 DM-244 1080P-DVR04N\n\nD9904NR NHDR DM-244 NHDR-5004AHD-II\n\nD9904NR NHDR DM-244 NHDR5004AHDII\n\nD9908 DVR DM-245 BCS-VAVR0802Q\n\nD9908 NHDR DM-245 NHDR-5208AHD\n\nD9908AHD DVR DM-246 1080P-DVR08A\n\nD9908NR AHD10-DVR8 DM-237 AHD10-DVR8\n\nD9908NR DVR DM-237 1080P-DVR08N\n\nD9908NR DVR DM-237 SVR9008ATHD/C\n\nD9908NR HY-DVR DM-237 CVD-AF08S\n\nD9908NR N820 DM-237 1080P-DVR08N\n\nD9908NR NHDR DM-237 NHDR-5008AHD-II\n\nD9916NR DVR DM-245 1080P-DVR016NAT;UI\n\nD9916NR DVR DM-245 HR-31-211620;UI\n\nD9916NR HY-DVR DM-245 CVD-AF16S\n\nD9916NR NHDR DM-245 NHDR-5016AHD-II\n\nD9916NRAHD DVR DM-246 1080P-DVR016NA\n\nD9916NRAHD N1620 DM-246 1080P-DVR016NA\n\nH1104W SNR-73200W DM-339 SNR-73200W\n\nH1106W LHB806 DM-291B LHB806\n\nH1106W LHB906 DM-291B LHB906\n\n## Bot scale analysis\n\nWe are able to see a portion of the infected bots, the following is a daily active trend：\n\n\n-----\n\nThe geographic distribution of Bot source IPs is as follows, mainly concentrated in the United\nStates, Korea and Brazi：\n\n## Sample Analysis\n\nLet’s take a look a the the following samples\n\n\n-----\n\n```\nVerdict:mirai_ptea\nMD5:c6ef442bc804fc5290d3617056492d4b\nELF 32-bit LSB executable, ARM, version 1, statically linked, stripped \nPacker:No\nLib:uclibc\nc6ef442bc804fc5290d3617056492d4b is a variant of Mirai, which we call Mirai_ptea\n\n```\nbased on its use of Tor Proxy to communicate with C2 and the TEA algorithm (Tiny\nEncryption Algorithm) to hide sensitive resource information. When ptea runs, it prints out in\nthe Console: `come at me krebs rimasuta go BRRT .`\n\nThis sample is very similar to Mirai at the host behavior level, so we will not cover it here; At\nthe network traffic level, Tor proxy is used, with a large number of proxy nodes embedded in\nthe sample, and Tor-C2 is encrypted. In the following section we will focus on the encryption\nmethod and communication protocol.\n\n## Encryption algorithm\n```\nMirai_ptea encrypts all sensitive resource information and stores it in a certain order. The\n\n```\nstring information seen when the sample is opened in IDA is shown below, with almost no\nreadable information.\n\nThe following code snippet is from the decryption-related functions in the sample, which can\nbe determined to use the TEA algorithm by the constants `0xC6EF3720 & 0X61C88647 .`\n\n\n-----\n\nThe key is：\n```\n0xC26F6A52 0x24AA0006 0x8E1BF2C5 0x4BA51F8C\n\n```\nWe wrote a decryption script(see appendix), through which we can obtain all the decrypted\nsensitive resources and their table entry information, part of the resource information is\nshown below.\n\nMirai_ptea has two ways of operation when using encrypted resources\n\n\n-----\n\n**The traditional Mirai way: Decrypt an encrypted item, take the value, re-encrypt the**\ndecrypted item, i.e. `var_unlock-->var_get-->var_lock . For example, the console`\ninformation is taken by this method.\n\nThe value of table entry 0x11 is exactly: `come at me krebs rimasuta go BRRT .`\n\n**Mirai_ptea’s way: Decrypt multiple encrypted items, taking the value, and re-encrypt**\nthe decrypted items, i.e. `rangeVar_unlock-->var_get-->rangeVar_lock . For`\nexample, this method is used when getting the disguised process name.\n\nThe values of the table entries 0x2c to 0x2c+10 shown below are the exact 11 pseudoprocess names that can be chosen.\n```\nindex 0x2c, value = /bin/sh\nindex 0x2d, value = telnetd\nindex 0x2e, value = upnpc-static\nindex 0x2f, value = wsdd\nindex 0x30, value = proftpd\nindex 0x31, value = mini_httpd\nindex 0x32, value = udevd\nindex 0x33, value = /sbin/udhcpc\nindex 0x34, value = boa\nindex 0x35, value = /usr/sbin/inetd\nindex 0x36, value = dnsmasq\n\n## Communication Protocol\n\n```\n\n-----\n\nAn overview of the network traffic in Mirai_ptea is provided below.\n\nThe whole process can be divided into 3 steps as follows.\n\n1: Establishing a connection with the proxy node\n\n2: Establishing a connection with Tor C2\n\n3: Communicate with C2 via ptea's custom protocol to receive attack commands from C2.\n\n### 0x1.Establishing a connection with the proxy\n\nThe Mirai_ptea sample has two sets of proxies built into it, with table entries `0x2a and`\n```\n0x2b in the encrypted resource. When the Bot sample runs, one of the two sets of proxies is\n\n```\nselected at random, and then one proxy node of the selected sets is connected by the\nfollowing code snippet.\n\nThere are 38 proxy nodes in `0x2a in the format of` `ip:port`\n\n\n-----\n\nAnd there are 334 proxy nodes in `0x2b, in the format of` `ip, and the port of this group of`\nproxies is fixed at `9050 .`\n\nSee the appendix for a detailed list of proxies.\n\n### 0x2. Connecting to C2 via the Tor-Proxy protocol\n\nYou can see that C2 has the table entry `0xD in the encrypted resource, and after decrypting`\nit, get the following string.\n```\nrkz2f5u57cvs3kdt6amdku2uhly2esj7m2336dttvcygloivcgsmxjjnuickasbuatxajrovi4lvd2zjuejivz\n\n```\n\n-----\n\nExcluding the `.onion at the end of the above string and splitting it by length 16, then`\nsplicing it with the `.onion string at the end, we get the following 7 C2s.`\n```\nrkz2f5u57cvs3kdt.onion\n6amdku2uhly2esj7.onion\nm2336dttvcygloiv.onion\ncgsmxjjnuickasbu.onion\natxajrovi4lvd2zj.onion\nuejivzrb3vobuoez.onion\nbc6z3gtu6b3r5tce.onion\n\n### 0x3. Communicate with the C2s via custom protocols for registration, heartbeat, and attack as follows\n\n```\nRegistration\n```\nmsg parsing\n---------------------------------------------------------------3e c7 e3 1e 37 47 61 20  ----->hardcoded msg\nfrom Bot\nb1 2f de ce cb 89 e1 a0  ----->cmd from C2,ask\nBot to upload info\n3a 31 34 b5 02 00 ---->hardcoded 6 bytes msg from Bot\nb4 a3 e1 16 ---->ip of infected device\n04\n----->group string length\n74 65 73 74   ---->group string\n79                 ----->padding\n\n```\nHeartbeat\n```\nmsg parsing\n---------------------------------------------------------------2a 23 -----> random 2 bytes msg from Bot\n2a 23 -----> random 2 bytes msg from C2\n\n```\nAttack command The first 4 bytes of the attack command, `AD AF FE 7F are fixed`\nphantom numbers, and the rest of the attack command is similar to mirai's attack\ncommand format\n```\n00000000: AD AF FE 7F 1E 00 00 00 00 01 B9 98 42 65 20 00 ............Be .\n00000010: 42 65 20 00   \n\n```\n\n-----\n\n## DDoS attack activity\n\nThis botnet has been busy launching DDoS attacks, the following figure shows some DDoS\nattack instructions of the botnet that we observed.\n\n## Contact us\n\n[Readers are always welcomed to reach us on twitter, or email to](https://twitter.com/360Netlab) `netlabat[at]360.cn .`\n\n## IoC\n\n Tor-C2\n```\nbc6z3gtu6b3r5tce.onion:3742\ncgsmxjjnuickasbu.onion:992\nuejivzrb3vobuoez.onion:5353\nrkz2f5u57cvs3kdt.onion:280\natxajrovi4lvd2zj.onion:110\n6amdku2uhly2esj7.onion:513\nm2336dttvcygloiv.onion:666\n\n```\n\n-----\n\n## Sample MD5\n```\nc6ef442bc804fc5290d3617056492d4b\nf849fdd79d433e2828473f258ffddaab\n\n Downloader URL\nhttp://193[.177.182.221/boot\n\n Scanner IP\n205.185.117.21 AS53667|FranTech_Solutions United_States|Nevada|Las_Vegas\n205.185.114.55 AS53667|FranTech_Solutions United_States|Nevada|Las_Vegas\n68.183.109.6 AS14061|DigitalOcean,_LLC United_States|New_York|New_York_City\n67.205.163.141 AS14061|DigitalOcean,_LLC United_States|New_York|New_York_City\n165.227.88.215 AS14061|DigitalOcean,_LLC United_States|New_York|New_York_City\n\n Proxys\n\n```\n\n-----\n\n```\n     proxys at index 0x2a，count 38\n149.202.9.7:9898\n91.134.216.103:16358\n84.32.188.34:1157\n51.178.185.237:32\n65.21.16.80:23560\n149.202.9.14:19765\n146.59.11.109:5089\n195.189.96.61:29582\n84.32.188.37:1454\n51.195.209.80:26848\n5.199.174.242:27931\n95.179.158.147:22413\n146.59.11.103:1701\n185.150.117.10:29086\n149.56.154.210:24709\n135.148.11.151:3563\n51.195.152.255:25107\n45.79.193.124:7158\n135.148.11.150:5560\n185.150.117.41:20790\n135.125.250.120:14498\n172.106.70.135:692\n195.189.96.60:9700\n172.106.70.134:25054\n149.56.154.211:21299\n108.61.218.205:29240\n51.178.185.236:21685\n51.81.139.251:6255\n51.255.237.164:963\n51.81.139.249:32380\n139.162.45.218:5165\n65.21.16.94:28056\n207.148.74.163:32389\n172.104.100.78:1039\n45.32.8.100:19759\n141.164.46.133:2205\n172.105.36.167:10843\n172.105.180.239:19531\n---------proxys at index 0x2b，count=334，port=9050--------Too many, not list here, you can get them via the IDA script\n\n## Appendix（IDA Decrypt script）\n\n```\n\n-----\n\n```\n# IDAPYTHON SCRIPT for md5 c6ef442bc804fc5290d3617056492d4b only.\n# Tested at ida 7.0\nfrom ctypes import *\nimport struct\nprint \"-------------------decryption start------------------------\"\nkey=[0xC26F6A52,0x24AA0006,0x8E1BF2C5,0x4BA51F8C]\ndef tea_dec(buf,key):\n  rbuf=\"\"\n  fmt = '>' + str(len(buf)/4) + 'I'\n  tbuf= struct.unpack_from(fmt,buf)\n  j=0\n  for i in range(0,len(tbuf)/2):\n    v1=c_uint32(tbuf[i+j])\n    v2=c_uint32(tbuf[i+1+j])\n    sum=c_uint32(0xC6EF3720)\n    while(sum.value):\n      v2.value -= ((v1.value>>5)+key[3])  ^(v1.value+sum.value)^ \n((v1.value<<4)+key[2])\n      v1.value -= ((v2.value>>5)+key[1])  ^(v2.value+sum.value)^\n((v2.value<<4)+key[0])\n      sum.value+=0x61C88647\n    rbuf +=struct.pack(\">I\",v1.value)+struct.pack(\">I\",v2.value)\n    j+=1\n  return rbuf\ndef getbuff(addr):\n  buf = \"\"\n  while idc.get_bytes(addr, 2) != \"\\x00\\x00\":\n    buf += idc.get_bytes(addr, 1)\n    addr += 1\n  return buf\n# pay attention to function at 0x0000D074\na=getbuff(idc.get_wide_dword(0x00019C9C))\nbuf=[]\n#0x19c9c-0x199f0 --> 684\nfor i in range(0,684,12):\n  offset=idc.get_wide_word(0x000199F4+i)\n  length=idc.get_wide_word(0x000199F4+i+2)\n  buf.append(a[offset:offset+length])\nc2=[]\n#684/12 --> 57\nfor i in range(57):\n  decbuf=tea_dec(buf[i],key)\n\n```\n\n-----\n\n```\n  if( .onion in decbuf):\n    c2.append(decbuf)\n  print \"index %x, value = %s\" %(i,decbuf)  \nprint \"-------------------decryption end---------------\"\nproxya=tea_dec(buf[0x2a],key)\npacnt=struct.unpack(\"<H\",proxya[2:4])\nproxy=[]\nport=[]\ntmp=proxya[4:4+6*(pacnt[0])]\nprint \"------------proxys at index 0x2A, count= %d------------\" %(pacnt[0])\nfor i in range(0,len(tmp),6):\n  proxy.append(struct.unpack(\">I\",tmp[i:i+4])[0])\n  port.append(struct.unpack(\"<H\",tmp[i+4:i+6])[0])\nfor i in range(pacnt[0]):\n  a=struct.pack(\">I\",proxy[i])\n  ip=\"\"\n  for j in range(4):\n    ip+=str(ord(a[j]))\n    if j!=3:\n      ip+=\".\"\n  print\"%s:%d\" %(ip,port[i])\nproxyb=tea_dec(buf[0x2b],key)\npbcnt=struct.unpack(\"<H\",proxyb[2:4])\nfmt = '>' + str(pbcnt[0]) + 'I'\ntmp=proxyb[4:4*(pbcnt[0]+1)]\nprint \"------------proxys at index 0x2B, count= %d------------\" %(pbcnt[0])\nxxxxx=struct.unpack(fmt,tmp)\nfor i in xxxxx:\n  a=struct.pack(\">I\",i)\n  ip=\"\"\n  for i in range(4):\n    ip+=str(ord(a[i]))\n    if i!=3:\n      ip+=\".\"\n  print ip\nprint \"-------------------------onion info--------------\"  \nif len(c2)!=0:\n  for i in c2:\n    pos=i.find(\".onion\")\n    for j in range(0,pos,16):\n      print i[j:16+j]+\".onion\"\nelse:\n  print \"Don't find the onion c2\"\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-01 - Mirai_ptea Botnet is Exploiting Undisclosed KGUARD DVR Vulnerability.pdf"
    ],
    "report_names": [
        "2021-07-01 - Mirai_ptea Botnet is Exploiting Undisclosed KGUARD DVR Vulnerability.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535572,
    "ts_updated_at": 1743041147,
    "ts_creation_date": 1653787263,
    "ts_modification_date": 1653787263,
    "files": {
        "pdf": "https://archive.orkl.eu/6066531c85ed38d9d64bccece89fcf694f58ce1d.pdf",
        "text": "https://archive.orkl.eu/6066531c85ed38d9d64bccece89fcf694f58ce1d.txt",
        "img": "https://archive.orkl.eu/6066531c85ed38d9d64bccece89fcf694f58ce1d.jpg"
    }
}