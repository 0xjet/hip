{
    "id": "ed1bb511-5a2d-4247-a1ff-ff7bbb627281",
    "created_at": "2023-01-12T15:01:01.026777Z",
    "updated_at": "2025-03-27T02:05:29.30744Z",
    "deleted_at": null,
    "sha1_hash": "447db2649ac35b1ea66a9e4baaab8467825bd5b2",
    "title": "2021-03-24 - Anti-Analysis Techniques Used in Excel 4.0 Macros",
    "authors": "",
    "file_creation_date": "2022-05-28T17:37:43Z",
    "file_modification_date": "2022-05-28T17:37:43Z",
    "file_size": 1274663,
    "plain_text": "# Anti-Analysis Techniques Used in Excel 4.0 Macros\n\n**goggleheadedhacker.com/blog/post/23**\n\nJacob Pimental March 24, 2021\n\n### 24 March 2021\n\nI recently reversed another Excel document with 4.0 Macros that was similar to my previous\npost on the subject but had some added anti-analysis features that I wanted to share. I\n[recommend reading the previous post to learn more as this article will not be going step-by-](https://www.goggleheadedhacker.com/blog/post/21)\nstep through the analysis process. If you would like to follow along you can find the sample\n[here.](https://app.any.run/tasks/02091acd-264d-4614-b465-5082b4c19ef4)\n\n## New Obfuscation Style\n\nInstead of storing the encrypted data as a blob of characters in cells, the sample stores them\nas integers in `Sheet1 of the document. It will then loop through these and subtract them`\nfrom a stored key in `R50C3:R59:C3 . If the integer value at the current index of` `Sheet1 is`\ngreater than 1000, then the end of the string has been reached. This is very similar to the old\nsample, but the use of integer values seemed interesting to me.\n\n\n-----\n\n_Decryption function_\n\n_Integer arrays in_ `Sheet1`\n\n\n-----\n\n## Anti-Analysis Tricks\n\nLike the previous analysis, the document performs a lot of the same VM/Analysis checks\nsuch as: checking for the presence of a cursor, if macros are set to run by default, etc. This\nspecific sample, however, had a few more tricks.\n\n### Xlcall32\n\nThe sample will use the `=CALL macro to make a call to the` `Excel4 function from the`\n```\nXlcall32 library. This is a callback function that is used to continue running the macros at\n\n```\na defined cell. This is a good way to prevent an analyst from just debugging the macros\nsince this would spawn in a new process and wonâ€™t show in the debugger.\n\n_This will continue running the macros at_ `R106C1 and evade debugging`\n\nIn this sample, the call to `Excel4 is dynamically generated via the deobfuscation code from`\nearlier. When running the deobfuscation code, I will put a `=HALT() instruction at the end to`\nprevent further execution. Once the anti-analysis technique is bypassed, I will continue\nrunning the macros at the location passed as a parameter to `Excel4 . This gives the same`\nresults as calling the `Excel4 function except now I can see what the code is doing.`\n\n\n-----\n\n_Visualization of how I bypass the anti-analysis technique_\n\n### Alternate Data Streams (ADS)\n\nAlternate Data Streams (ADS) are a feature of the NT File System (NTFS) that allows a user\nto store additional content in a file apart from its original content. ADS is used legitimately for\nfile integrity and storing metadata; however, attackers can use it to hide malicious code. In\nolder versions of SQL Server, for example, the DBCC CHECKDB process would create\nalternate data streams to store information.\n\n\n-----\n\nWhen a file is downloaded from the internet, it will contain an ADS called\n```\nZone.Identifier which has data about where the file originated. In this case, the sample I\n\n```\ndownloaded was from Zoho Docs, therefore, it contained that URL in the stream. This\nparticular sample checks to see if the ADS is present by actually trying to delete the ADS\nitself. If this sample were run in a sandbox, there would be no ADS, thus triggering this antianalysis technique and halting the execution of the macros.\n\n_The alternate data stream of the sample_\n\n_Checking for_ `Zone.Identifier alternate data stream by trying to delete it`\n\n## C2s\n\nAs with the previous analysis, once all the checks are complete, the sample will reach out to\nC2s to try to grab the second stage payload and execute it. In this case, it appears to be a\nDLL that will be executed through `rundll32.exe calling` `DllRegisterServer . Both of the`\nC2s were down when I found the sample, so I could not get the second stage to continue the\nanalysis.\n\n_Downloading the second stage from C2_\n\n\n**_C2_**\n\n\nhttps://fernandogaleano[.]com/server.php\n\n\nhttps://catedraloor[.]com/server.php\n\n\n## Conclusion\n\n\n-----\n\nHopefully, this provided insight into a few anti-analysis techniques seen in the wild and can\nbe a good reference to other analysts in the future. The call to `Xlcall32 was new to me,`\nand I had not seen the alternate data stream check used before. If you have any questions\n[or comments on this analysis feel free to reach out to me on my Twitter or](https://twitter.com/jacob_pimental) [LinkedIn.](https://www.linkedin.com/in/jacobpimental/)\n\nThanks for reading and happy reversing!\n\n**Malware Analysis, Excel 4.0 Macros, Maldoc, XLS Document**\n\n## More Content Like This:\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-24 - Anti-Analysis Techniques Used in Excel 4.0 Macros.pdf"
    ],
    "report_names": [
        "2021-03-24 - Anti-Analysis Techniques Used in Excel 4.0 Macros.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535661,
    "ts_updated_at": 1743041129,
    "ts_creation_date": 1653759463,
    "ts_modification_date": 1653759463,
    "files": {
        "pdf": "https://archive.orkl.eu/447db2649ac35b1ea66a9e4baaab8467825bd5b2.pdf",
        "text": "https://archive.orkl.eu/447db2649ac35b1ea66a9e4baaab8467825bd5b2.txt",
        "img": "https://archive.orkl.eu/447db2649ac35b1ea66a9e4baaab8467825bd5b2.jpg"
    }
}