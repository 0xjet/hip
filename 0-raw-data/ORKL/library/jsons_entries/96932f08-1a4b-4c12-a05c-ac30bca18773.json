{
    "id": "96932f08-1a4b-4c12-a05c-ac30bca18773",
    "created_at": "2022-10-25T16:48:17.399269Z",
    "updated_at": "2025-03-27T02:17:11.494314Z",
    "deleted_at": null,
    "sha1_hash": "ee00fbe1a7e991856e9ef3da7601dc010aacdeba",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-04-20T10:34:22Z",
    "file_modification_date": "2021-04-20T10:34:22Z",
    "file_size": 2425565,
    "plain_text": "# A Deep Dive into Zebrocy’s Dropper Docs\n\n**[labs.sentinelone.com/a-deep-dive-into-zebrocys-dropper-docs](https://labs.sentinelone.com/a-deep-dive-into-zebrocys-dropper-docs/)**\n\nMarco Figueroa April 19, 2021\n\nSofacy is an APT threat actor that’s been around since 2008 and rose to prominence with\nthe election hacks of 2016. Better known as FancyBear or APT28, this threat actor targets\ngovernments, military, and private organizations and has been known to engage in hackand-leak operations. In the past couple of years, Sofacy has drastically retooled and\n[largely evaded analysts. One of the more consistent subgroups is known as Zebrocy. Their](https://securelist.com/zebrocys-multilanguage-malware-salad/90680/)\ntargeting appears primarily focused on former Soviet Republics and, more recently, Asia.\n\nIn March 2021, we observed a cluster of activities targeting Kazakhstan with Delphocy –\nmalware written in Delphi and previously associated with Zebrocy. The Word documents\nthat were observed purport to be from a Kazakhy company named Kazchrome, a mining\nand metal company and one of the world’s largest producers of chrome ore and\nferroalloys.\n\nIn total, we found six Delphocy Word documents that appear to be related to this cluster,\nall of which contain the same VBA script that drops a PE. Out of the six Word documents,\ntwo appear to be authentic uploads to VirusTotal by victims originating from Kazakhstan.\nThe uploaded files contain what appeared to be the original filenames Авансовый\nотчет(новый).doc and Форма докладной (служебной) записки.doc.\n\nIn this post, we take a deep dive into these samples and share some techniques other\nanalysts can employ to reverse engineer Delphocy dropper docs. We show how\nresearchers can bypass password-protected macros and describe both how to decompile\nDelphi using IDR (Interactive Delphi Reconstructor) and how to import the saved IDC file\ninto Ghidra using dhrake’s plugin.\n\n\n-----\n\nThe results of our analysis led us to discover further Zebrocy clusters; a list of IOCs and\nYARA detection rules are provided to enable threat hunters to search for these and related\nartifacts in their environments.\n\n## Bypassing VBA Macro Password Protection\n\nWhen analyzing Office documents with VBA macros, threat hunters have many different\ntools and techniques that do the job, but I’ve built a habit that I still use when I first\nstarted reversing malware to bypass password-protected macros manually.\n\n1. Open up your favorite hex editor. I use HxD.\n2. Load the Word Document.\n3. Search for the following text:\n\n1. `CMG=`\n2. `GC=`\n3. `DPB=`\n4. Add an `x to each of them:`\n\n1. `CMGx=`\n2. `GCx=`\n3. `DPBx=`\n5. Save the file with the changes.\n\n\n-----\n\nWhen opening the Word document and viewing the macro this time, you can see the\nscript as well as the Forms. When analyzing the function, what immediately sticks out is\nthe `ert.DataType = “bin.base64”, showing that the UserForm1 is encoded with`\n[base64.](https://www.sentinelone.com/blog/guide-encode-decoded-base64/)\n\n## Wininition UserForm\n\nWhen selecting on UserForm1, the textbox reveals a `base64 encoded string; we know`\nthis because of the function we discussed above. The next step is to copy the entire string\ninto a file so it can be decoded.\n\n\n-----\n\nNow we decode the binary from `base64 and save it to disk as` `wininition.exe .`\n\n[Following that, clean the headers using HxD, and then use PE-Bear to fix the sections](https://labs.sentinelone.com/top-15-essential-malware-analysis-tools/)\nheaders to move to the next phase of the analysis.\n\n\n-----\n\n[When triaging a binary, the go-to tool is Hiew to investigate and look for clues for a](https://labs.sentinelone.com/top-15-essential-malware-analysis-tools/)\ndeeper understanding. With `wininition, I notice the Embarcadero string, which means`\nthat this binary was written in Delphi. When reversing Delphi binaries I’ve always used\n[IDR (Interactive Delphi Reconstructor). IDR is a decompiler of executable files and](https://github.com/crypto2011/IDR)\ndynamic libraries (DLL) written in Delphi.\n\n\n-----\n\n## Reversing Delphi Binaries with Ghidra and dhrake\n\nWhen searching for the latest developments with IDR, I came across a fantastic plugin for\nGhidra, a collection of scripts for reverse engineering Delphi binaires in Ghidra using\nIDR’s output to IDC. It was published over a year ago, but it is a gem if threat hunters are\nusing Ghidra.\n\n[dhrake allows you to import the IDC file from IDR into Ghidra. This will import the](https://github.com/huettenhain/dhrake)\nSymbol names, function signatures and create structs for Delphi classes. This plugin\nextracts and applies the Delphi symbols from the IDC file, which is generated by IDR, and\nattempts to find cases where Ghidra has incorrectly determined the entry point of a\n[function. If you’ve never imported a plugin to Ghidra please read this post. I’ve saved the](https://labs.sentinelone.com/a-guide-to-ghidra-scripting-development-for-malware-researchers/)\nIDC to a selected folder. I then install the plugin in Ghidra and run the script it prompts\nfor the IDC file and then load it!\n\n\n-----\n\nIn the `wininition binary, the first function WinMain has` `SetWindowsHookExW`\nfunction, which is a hook procedure to monitor a system for certain types of events. The\nhook procedures low-level keyboard input events is `WH_KEYBOARD_LL, which is the`\nnumber 13 in the parameter. This hook is a mechanism that intercepts keystroke events.\nAll the events are then saved to a log file to be sent to a C2.\n\n\n-----\n\nThe C2 is obfuscated using hex that can be converted to ascii:\n```\n68747470733A2F2F7777772E786268702E636F6D2F646F6D696E61726772656174617369616E6F64797\nhxxps://www.xbhp[.]com/dominargreatasianodyssey/wpcontent/plugins/akismet/style.php\n68747470733A2F2F7777772E63346373612E6F72672F696E636C756465732F736F75726365732F66656\nhxxps://www.c4csa[.]org/includes/sources/felims.php\n\n```\n**Note: These appear to be compromised domains.**\n\n## Conclusion\n\nAnalysis of these documents led us to find other Zebrocy clusters. As Zebrocy continues to\nevolve its scope, organizations must have the proper visibilities and detection capabilities\nto find this threat actor. We hope the techniques discussed in this post will be useful to\nother researchers in analyzing Delphocy dropper docs in particular, and documents with\npassword-protected macros in general.\n\n\n-----\n\n## Indicators of Compromise\n\n**Word Documents**\n\n**SHA256**\n\n3b548a851fb889d3cc84243eb8ce9cbf8a857c7d725a24408934c0d8342d5811\n\n1dd03c4ea4d630a59f73e053d705185e27e2e2545dd9caedb26a824ac5d11466\n\n1e8261104cbe4e09c19af7910f83e9545fd435483f24f60ec70c3186b98603cc\n\nc213b60a63da80f960e7a7344f478eb1b72cee89fd0145361a088478c51b2c0e\n\n2bf088955007b4f47fe9187affe65fffea234ff16596313a74958a7c85129172\n\nd9e7325f266eda94bfa8b8938de7b7957734041a055b49b94af0627bd119c51c\n\n**SHA1**\n\nfc0b7ad2ae9347d6d2ababe2947ffb9f7cc73030\n\n71b4b9f105de94090fc36d9226faaa1db6d9f3d1\n\n6a8f63c4491adcf2cf7f76cd1481c5647615a6c9\n\na3ecf1fdc1206e9d3061530fa91775cf3d97f788\n\nae01ca2cf0dc07abb3a7bef9930e38c9212975d5\n\n66b39f4fd1dd51c2f548330e5818f732dad0aa28\n\n**VBA**\n\n**SHA256**\n\na442135c04dd2c9cbf26b2a85264d31a5ac4ec5d2069a7b63bc14b64a6dd82b7\n\n**SHA1**\n\n6ec4eb883752b70db134ac0f4e0d5b4a77196184\n\n**Wininition**\n\n**SHA256**\n\nee7cfc55a49b2e9825a393a94b0baad18ef5bfced67531382e572ef8a9ecda4b\n\n**SHA1**\n\nafbdb13d8f620d0a5599cbc7a7d9ce8001ee32f1\n\n**URLs**\n\nhxxps://www.xbhp[.]com/dominargreatasianodyssey/wpcontent/plugins/akismet/style.php\n\nhxxps://www.c4csa[.]org/includes/sources/felims.php\n\n**Yara Rules**\n\n\n-----\n\n```\nrule apt_RU_delphocy_encStrings {\n meta:\n  desc = \"Hex strings in Delphocy drops\"\n  author = \"JAG-S @ SentinelLabs\"\n  version = \"1.0\"\n  TLP = \"White\"\n  last_modified = \"04.09.2021\"\n  hash0 = \"ee7cfc55a49b2e9825a393a94b0baad18ef5bfced67531382e572ef8a9ecda4b\"\n  hash1 = \"07b2d21f4ef077ccf16935e44864b96fa039f2e88c73b518930b6048f6baad74\"\n strings:\n  $enc_keylogger2 = \"5B4241434B53504143455D\" ascii wide\n  $enc_keylogger3 = \"5B5441425D\" ascii wide\n  $enc_keylogger4 = \"5B53484946545D\" ascii wide\n  $enc_keylogger5 = \"5B434F4E54524F4C5D\" ascii wide\n  $enc_keylogger6 = \"5B4553434150455D\" ascii wide\n  $enc_keylogger7 = \"5B454E445D\" ascii wide\n  $enc_keylogger8 = \"5B484F4D455D\" ascii wide\n  $enc_keylogger9 = \"5B4C4546545D\" ascii wide\n  $enc_keylogger10 = \"5B55505D\" ascii wide\n  $enc_keylogger11 = \"5B52494748545D\" ascii wide\n  $enc_keylogger12 = \"5B444F574E5D\" ascii wide\n  $enc_keylogger13 = \"5B434150534C4F434B5D\" ascii wide\n  $cnc1 =\n\"68747470733A2F2F7777772E786268702E636F6D2F646F6D696E61726772656174617369616E6F6479\n ascii wide\n  $cnc2 =\n\"68747470733A2F2F7777772E63346373612E6F72672F696E636C756465732F736F75726365732F6665\n ascii wide\n condition:\n  uint16(0) == 0x5a4d and (any of ($cnc*) or all of ($enc_keylogger*))\n}\n\n```\n\n-----\n\n```\nrule apt_RU_Delphocy_Maldocs {\n meta:\n  desc = \"Delphocy dropper docs\"\n  author = \"JAG-S @ SentinelLabs\"\n  version = \"1.0\"\n  TLP = \"White\"\n  last_modified = \"04.09.2021\"\n  hash1 = \"3b548a851fb889d3cc84243eb8ce9cbf8a857c7d725a24408934c0d8342d5811\"\n  hash2 = \"c213b60a63da80f960e7a7344f478eb1b72cee89fd0145361a088478c51b2c0e\"\n  hash3 = \"d9e7325f266eda94bfa8b8938de7b7957734041a055b49b94af0627bd119c51c\"\n  hash4 = \"1e8261104cbe4e09c19af7910f83e9545fd435483f24f60ec70c3186b98603cc\"\n strings:\n  $required1 = \"_VBA_PROJECT\" ascii wide\n  $required2 = \"Normal.dotm\" ascii wide\n  $required3 = \"bin.base64\" ascii wide\n  $required4 = \"ADODB.Stream$\" ascii wide\n  $author1 = \"Dinara Tanmurzina\" ascii wide\n  $author2 = \"Hewlett-Packard Company\" ascii wide\n  $specific = \"Caption     =  \\\"\\\\wininition.exe\\\"\" ascii wide\n  $builder1 = \"Begin {C62A69F0-16DC-11CE-9E98-00AA00574A4F} UserForm1\" ascii\nwide\n  $builder2 = \"{02330CFE-305D-431C-93AC-29735EB37575}{33D6B9D9-9757-485A-89F44F27E5959B10}\" ascii wide\n  $builder3 = \"VersionCompatible32=\\\"393222000\\\"\" ascii wide\n  $builder4 = \"CMG=\\\"1517B95BC9F7CDF7CDF3D1F3D1\\\"\" ascii wide\n  $builder5 =\n\"DPB=\\\"ADAF01C301461E461EB9E2471E616F01D06093C59A7C4D30F64A51BDEDDA98EC1590C9B191FF\n ascii wide\n  $builder6 = \"GC=\\\"4547E96B19021A021A02\\\"\" ascii wide\n condition:\n  uint32(0) == 0xE011CFD0 and all of ($required*) and (all of ($author*) or\n$specific or 5 of ($builder*))\n}\n\n```\n[apt Macros Sophacy](https://labs.sentinelone.com/tag/apt/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2021/2021.04.19.A_Deep_Dive_into_Zebrocys_Dropper_Docs/2021.04.19.A_Deep_Dive_into_Zebrocys_Dropper_Docs.pdf"
    ],
    "report_names": [
        "2021.04.19.A_Deep_Dive_into_Zebrocys_Dropper_Docs"
    ],
    "threat_actors": [
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d2516b8e-e74f-490d-8a15-43ad6763c7ab",
            "created_at": "2022-10-25T16:07:24.212584Z",
            "updated_at": "2025-03-27T02:02:10.141001Z",
            "deleted_at": null,
            "main_name": "Sofacy",
            "aliases": [
                "APT 28",
                "ATK 5",
                "Blue Athena",
                "BlueDelta",
                "FROZENLAKE",
                "Fancy Bear",
                "Fighting Ursa",
                "Forest Blizzard",
                "Grey-Cloud",
                "Grizzly Steppe",
                "Group 74",
                "GruesomeLarch",
                "ITG05",
                "Iron Twilight",
                "Operation DealersChoice",
                "Operation Dear Joohn",
                "Operation Komplex",
                "Operation Pawn Storm",
                "Operation Russian Doll",
                "Operation Steal-It",
                "Pawn Storm",
                "SIG40",
                "Sednit",
                "Snakemackerel",
                "Sofacy",
                "Strontium",
                "T-APT-12",
                "TA422",
                "TAG-0700",
                "TAG-110",
                "TG-4127",
                "Tsar Team",
                "UAC-0028",
                "UAC-0063"
            ],
            "source_name": "ETDA:Sofacy",
            "tools": [
                "ADVSTORESHELL",
                "AZZY",
                "Backdoor.SofacyX",
                "CHERRYSPY",
                "CORESHELL",
                "Carberp",
                "Computrace",
                "DealersChoice",
                "Delphacy",
                "Downdelph",
                "Downrage",
                "Drovorub",
                "EVILTOSS",
                "Foozer",
                "GAMEFISH",
                "GooseEgg",
                "Graphite",
                "HATVIBE",
                "HIDEDRV",
                "Headlace",
                "Impacket",
                "JHUHUGIT",
                "JKEYSKW",
                "Koadic",
                "Komplex",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LoJack",
                "LoJax",
                "MASEPIE",
                "Mimikatz",
                "NETUI",
                "Nimcy",
                "OCEANMAP",
                "OLDBAIT",
                "PocoDown",
                "PocoDownloader",
                "Popr-d30",
                "ProcDump",
                "PythocyDbg",
                "SMBExec",
                "SOURFACE",
                "SPLM",
                "STEELHOOK",
                "Sasfis",
                "Sedkit",
                "Sednit",
                "Sedreco",
                "Seduploader",
                "Shunnael",
                "SkinnyBoy",
                "Sofacy",
                "SofacyCarberp",
                "SpiderLabs Responder",
                "Trojan.Shunnael",
                "Trojan.Sofacy",
                "USB Stealer",
                "USBStealer",
                "VPNFilter",
                "Win32/USBStealer",
                "WinIDS",
                "Winexe",
                "X-Agent",
                "X-Tunnel",
                "XAPS",
                "XTunnel",
                "Xagent",
                "Zebrocy",
                "Zekapab",
                "carberplike",
                "certutil",
                "certutil.exe",
                "fysbis",
                "webhp"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716497,
    "ts_updated_at": 1743041831,
    "ts_creation_date": 1618914862,
    "ts_modification_date": 1618914862,
    "files": {
        "pdf": "https://archive.orkl.eu/ee00fbe1a7e991856e9ef3da7601dc010aacdeba.pdf",
        "text": "https://archive.orkl.eu/ee00fbe1a7e991856e9ef3da7601dc010aacdeba.txt",
        "img": "https://archive.orkl.eu/ee00fbe1a7e991856e9ef3da7601dc010aacdeba.jpg"
    }
}