{
    "id": "c0ee516e-fb7e-408c-90a9-d12a6c3a2191",
    "created_at": "2023-01-12T14:59:28.606013Z",
    "updated_at": "2025-03-27T02:17:14.50436Z",
    "deleted_at": null,
    "sha1_hash": "e8da3154f286d128827bb3d7bd7263c91a5b38b8",
    "title": "2017-12-04 - New method of macro malware disguised as defense-related files",
    "authors": "",
    "file_creation_date": "2022-05-28T15:26:31Z",
    "file_modification_date": "2022-05-28T15:26:31Z",
    "file_size": 665537,
    "plain_text": "# 防衛関連のファイルを装うマクロマルウェアの新しい手口 - セキュリティ研究センターブログ\n\n**blog.macnica.net/blog/2017/12/post-8c22.html**\n\n[竹内](https://security.macnica.co.jp/blog/author/author31bfd/) 寛\n\n2017年12月 4日 14:01\n\n## 防衛関連のファイルを装うマクロマルウェアの新しい手口\n\n[APT](https://security.macnica.co.jp/blog/apt/)\n[トレンド](https://security.macnica.co.jp/blog/trend/)\n[マルウェア](https://security.macnica.co.jp/blog/malware/)\n\n[ツイート](https://twitter.com/share)\n\nマクロを悪用するマルウェアは、バラマキ型/標的型攻撃にて多く使われており特別珍しい\nものではありません。最近では金銭窃取が主目的であるバンキングマルウェアが、マクロか\nらPowerShellを起動して外部から新たなマルウェアをダウンロードするのを目にする事が多\nいです。\n\n今回、弊社が解析したマクロを悪用するマルウェアでは、過去見られなかった新しい手口が\n使われているのを観測しました。ここでその特徴について解説したいと思います。\n\n\n-----\n\n観測できた攻撃の流れは、以下になります。\n\n図1. 攻撃の流れ\n\n特徴1. マクロ パスワードロック\n\n今回の検体は、ユーザがファイルを開いて、マクロを有効にすると処理が発動するものでし\nた。\n\n最初にマクロの内容をExcelで確認しようとしましたが、マクロの編集にパスワードが掛か\nっていた為、アプリケーションからはマクロのコードを確認をする事ができませんでした。\n\nそこで、Philippe Lagadec氏が公開しているvbaをofficeファイルから抽出するolevba[1]を実\n行し、マクロのコードを抽出しました。\n\n解析や検出を妨げようとマクロのコードを難読化しているものは、よく観測しますが今回の\nようにマクロの編集にパスワードをかけてあるものは珍しいといえます。\n\n図2 検体のアイコン\n\n\n-----\n\n図3. パスワード入力を促すダイアログ\n\n図4. 抽出したマクロ\n\n特徴2. Windows付属ツールcertutilコマンドの利用\nダウンロードしたファイルをWindowsに付属している証明書関連の操作ができるcertutilコマ\nンドを使い、Base64デコードをします。\nダウンロードしてきたファイルの中身は、以下のように証明書に見えますが、実際は、CAB\n形式の圧縮ファイルでした。\n攻撃者の意図としては、証明書ファイルのダウンロードに見せかけて検出を回避する事が考\nえられます。\n\n\n-----\n\n図5. ダウンロードされたファイルの中身\n\n_\"certutil -decode %temp%\\\\HnftK.pHFj %temp%\\\\ThnjFY.cab\"_\n\n上記コマンドで%temp%配下にダウンロードしたファイルをBase64でデコードして、cabフ\nァイルとして保存します。\n\nその後にデコードしたCABファイルを解凍して、展開されたexeファイルを実行します。\n\n図6. CABファイルに含まれているファイル\n\n実行後の挙動\n\nCAB形式のファイルの中には、exeとdllファイルがあり、exeファイルを実行しますが、exe\nファイルはdllがエクスポートしているLiteFaxViewDlg関数を呼び出す事が主な役割で、マル\nウェアとしてのメイン処理は、dllに実装されていました。\ndllは、自身のコードを復号し新しく確保したメモリ上に展開して処理が進んでいきますが、\n主な処理はパーシステンスを確立するためにスタートアップにexeのショートカットリンク\nを作成する事とiexplorer.exeを起動してコードをインジェクションする事です。\n\nC2サーバとの通信はiexplorer.exeにインジェクションされたコードが行います。\n\nインジェクションされたコードの中には、MZ形式のデータがあり構造を確認すると\n\"stpeter0\" と \"stpeter1\" という独特のセクション名が付与されていました。\n\n残念ながら、このセクション名が意味する内容については特定ができていません。\n\n\n-----\n\n06section_2\n\n図7. MZファイルのセクション名\n\n今回、iexplorer.exeにインジェクションされたコードをファイルのコードをGene(遺伝子)と\n呼ぶ単位に分けて保有するデータベースと照合し、ファイルを判別する\"Intezar Analyze\" [2]\nで解析した所、APT10/menuPass/Stone Pandaと呼称されている攻撃者グループが使うとさ\nれているマルウェア RedLeavesが一番高い(共通しているコードが一番多い)結果となりまし\nた。\n弊社で以前解析したRedLeavesで見られた同じ文字列が今回のコードでも確認できており、\nこの検体は、RedLeavesと関連があるマルウェアの可能性があると考えています。\n\n[Intezar](http://blog.macnica.net/.shared/photos/uncategorized/2017/12/05/intezar.png)\n\n図8. Intezer Analyzeの照合結果\n\n図9. 過去解析したRedLeavesと今回の検体で共通して見られた文字列の一例\n\n痕跡 (Indicator of Compromise)\n\nファイル\n\nSHA256:\n3DC047A44D664D58204709662E76ADAC0AFE95CC95BD2505E175AACB1FEA3A25\n\nファイル名: 防衛省からの情報提供（最新版）2.docm\n\n%tempに展開されるファイル(CAB形式のファイルから解凍)\nSHA256:\n51461952833847467C126F071D3E6EDE9613FED564170E6386A4C2722E973E18\nファイル名: LW32.EXE\n\nSHA256:\n3938436AB73DCD10C495354546265D5498013A6D17D9C4F842507BE26EA8FAFB\nファイル名: VNTFXF32.dll\n\nパーシステンス\n\nスタートアップに作られるショートカットリンク: SjedERFtp.lnk\n\n\n-----\n\n通信先\n\nweb.casacam[.]net (HTTP:80)\n\ndiamond.ninth[.]biz (HTTPS:443)\n\n参考\n\n[1] http://www.decalage.info\n\n[2] https://analyze.intezer.com\n\n[ツイート](https://twitter.com/share)\n\nこの記事の筆者\n\n[竹内](https://security.macnica.co.jp/blog/author/author31bfd/) 寛\n\nリバースエンジニアリング（マルウェア解析）を担当。彼の手に渡ったマルウェアはまさ\nに“まな板の上の鯉”と同じ。あとは解析されるがまま。最近の楽しみは、ハイボールを片手\nに海外ドラマを鑑賞するか、マントノン侯爵夫人に会うこと。好きなマシン語は、EB FE。\n\n前へ\n\nブログサービスを悪用する最近の攻撃手口\n\n次へ\n\nマルウェア解析奮闘記: コマンド実行のエラー文が日本語でないと動作しないマルウェア\n\n\n-----",
    "language": "JA",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-12-04 - New method of macro malware disguised as defense-related files.pdf"
    ],
    "report_names": [
        "2017-12-04 - New method of macro malware disguised as defense-related files.pdf"
    ],
    "threat_actors": [
        {
            "id": "ec14074c-8517-40e1-b4d7-3897f1254487",
            "created_at": "2023-01-06T13:46:38.300905Z",
            "updated_at": "2025-03-27T02:00:02.799108Z",
            "deleted_at": null,
            "main_name": "APT10",
            "aliases": [
                "TA429",
                "STONE PANDA",
                "POTASSIUM",
                "Red Apollo",
                "HOGFISH",
                "Cloud Hopper",
                "BRONZE RIVERSIDE",
                "ATK41",
                "G0045",
                "Menupass Team",
                "happyyongzi",
                "CVNX",
                "Granite Taurus"
            ],
            "source_name": "MISPGALAXY:APT10",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ba3fff0c-3ba0-4855-9eeb-1af9ee18136a",
            "created_at": "2022-10-25T15:50:23.298889Z",
            "updated_at": "2025-03-27T02:00:55.433541Z",
            "deleted_at": null,
            "main_name": "menuPass",
            "aliases": [
                "menuPass",
                "POTASSIUM",
                "Stone Panda",
                "APT10",
                "Red Apollo",
                "CVNX",
                "HOGFISH",
                "BRONZE RIVERSIDE"
            ],
            "source_name": "MITRE:menuPass",
            "tools": [
                "certutil",
                "FYAnti",
                "UPPERCUT",
                "SNUGRIDE",
                "P8RAT",
                "RedLeaves",
                "SodaMaster",
                "pwdump",
                "Mimikatz",
                "PlugX",
                "PowerSploit",
                "ChChes",
                "cmd",
                "QuasarRAT",
                "AdFind",
                "Cobalt Strike",
                "PoisonIvy",
                "EvilGrab",
                "esentutl",
                "Impacket",
                "Ecipekac",
                "PsExec",
                "HUI Loader"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "ba9fa308-a29a-4928-9c06-73aafec7624c",
            "created_at": "2024-05-01T02:03:07.981061Z",
            "updated_at": "2025-03-27T02:05:17.28602Z",
            "deleted_at": null,
            "main_name": "BRONZE RIVERSIDE",
            "aliases": [
                "CTG-5938 ",
                "CVNX ",
                "Hogfish ",
                "MenuPass ",
                "POTASSIUM ",
                "Red Apollo ",
                "Stone Panda ",
                "APT10 "
            ],
            "source_name": "Secureworks:BRONZE RIVERSIDE",
            "tools": [
                " ChChes",
                " Cobalt Strike",
                " PlugX",
                " PoisonIvy",
                " QuasarRAT",
                " QuasarRAT Loader",
                " RedLeaves",
                "ANEL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "04b07437-41bb-4126-bcbb-def16f19d7c6",
            "created_at": "2022-10-25T16:07:24.232628Z",
            "updated_at": "2025-03-27T02:02:10.146043Z",
            "deleted_at": null,
            "main_name": "Stone Panda",
            "aliases": [
                "APT 10",
                "ATK 41",
                "Bronze Riverside",
                "CTG-5938",
                "CVNX",
                "Cuckoo Spear",
                "Earth Kasha",
                "Granite Taurus",
                "Happyyongzi",
                "Hogfish",
                "ITG01",
                "Operation A41APT",
                "Operation Cache Panda",
                "Operation ChessMaster",
                "Operation Cloud Hopper",
                "Operation Cuckoo Spear",
                "Operation New Battle",
                "Operation Soft Cell",
                "Operation TradeSecret",
                "Potassium",
                "Red Apollo",
                "Stone Panda",
                "TA429",
                "menuPass",
                "menuPass Team"
            ],
            "source_name": "ETDA:Stone Panda",
            "tools": [
                "Agent.dhwf",
                "Agentemis",
                "Anel",
                "AngryRebel",
                "BKDR_EVILOGE",
                "BKDR_HGDER",
                "BKDR_NVICM",
                "BUGJUICE",
                "CHINACHOPPER",
                "ChChes",
                "China Chopper",
                "Chymine",
                "CinaRAT",
                "Cobalt Strike",
                "CobaltStrike",
                "DARKTOWN",
                "DESLoader",
                "DILLJUICE",
                "DILLWEED",
                "Darkmoon",
                "DelfsCake",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "Ecipekac",
                "Emdivi",
                "EvilGrab",
                "EvilGrab RAT",
                "FYAnti",
                "Farfli",
                "Gen:Trojan.Heur.PT",
                "Gh0st RAT",
                "Ghost RAT",
                "GreetCake",
                "HAYMAKER",
                "HEAVYHAND",
                "HEAVYPOT",
                "HTran",
                "HUC Packet Transmit Tool",
                "Ham Backdoor",
                "HiddenFace",
                "Impacket",
                "Invoke the Hash",
                "KABOB",
                "Kaba",
                "Korplug",
                "LODEINFO",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "MiS-Type",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "NBTscan",
                "NOOPDOOR",
                "Newsripper",
                "P8RAT",
                "PCRat",
                "PlugX",
                "Poison Ivy",
                "Poldat",
                "PowerSploit",
                "PowerView",
                "PsExec",
                "PsList",
                "Quarks PwDump",
                "Quasar RAT",
                "QuasarRAT",
                "RedDelta",
                "RedLeaves",
                "Rubeus",
                "SNUGRIDE",
                "SPIVY",
                "SharpSploit",
                "SigLoader",
                "SinoChopper",
                "SodaMaster",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Trochilus RAT",
                "UpperCut",
                "Vidgrab",
                "WinRAR",
                "WmiExec",
                "Wmonder",
                "Xamtrav",
                "Yggdrasil",
                "Zlib",
                "certutil",
                "certutil.exe",
                "cobeacon",
                "dfls",
                "lena",
                "nbtscan",
                "pivy",
                "poisonivy",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535568,
    "ts_updated_at": 1743041834,
    "ts_creation_date": 1653751591,
    "ts_modification_date": 1653751591,
    "files": {
        "pdf": "https://archive.orkl.eu/e8da3154f286d128827bb3d7bd7263c91a5b38b8.pdf",
        "text": "https://archive.orkl.eu/e8da3154f286d128827bb3d7bd7263c91a5b38b8.txt",
        "img": "https://archive.orkl.eu/e8da3154f286d128827bb3d7bd7263c91a5b38b8.jpg"
    }
}