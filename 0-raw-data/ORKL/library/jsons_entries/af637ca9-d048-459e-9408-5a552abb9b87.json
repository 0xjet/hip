{
    "id": "af637ca9-d048-459e-9408-5a552abb9b87",
    "created_at": "2023-01-12T15:10:56.461735Z",
    "updated_at": "2025-03-27T02:10:17.901717Z",
    "deleted_at": null,
    "sha1_hash": "fd77950476cc8e647f4bdb396a05fba3beadf9cb",
    "title": "2016-03-11 - Cerber ransomware- new, but mature",
    "authors": "",
    "file_creation_date": "2022-05-28T02:30:26Z",
    "file_modification_date": "2022-05-28T02:30:26Z",
    "file_size": 890929,
    "plain_text": "# Cerber ransomware: new, but mature\n\n**[blog.malwarebytes.com/threat-analysis/2016/03/cerber-ransomware-new-but-mature/](https://blog.malwarebytes.com/threat-analysis/2016/03/cerber-ransomware-new-but-mature/)**\n\nhasherezade March 11, 2016\n\n[Ransomware authors seem to love mythological creatures. We have seen Chimera, now we](https://www.malwarebytes.com/ransomware)\nwill take a look at Cerber. Both are named after powerful beasts and both are prepared in a\nprofessional way. As [SenseCy states (source), Cerber is sold to distributors on underground](http://blog.sensecy.com/)\nRussian forums.\n\n[This malware is often distributed via Exploit Kits (read more here).](https://blog.malwarebytes.org/cybercrime/2016/04/magnitude-ek-malvertising-campaign-adds-fingerprinting-gate/)\n\n**UPDATE:** **[Checkpoint released a decryption tool working for some cases of Cerber](https://www.cerberdecrypt.com/RansomwareDecryptionTool/)**\n\n## Analyzed samples\n\n[f5146a3bbe6c71e5a0ef2f04f955b1a1](https://www.virustotal.com/en/file/2d08ffeba708fb833404d2c320ea4f29365c791d504181e08e3e9b529f5cf096/analysis/)\n[2f7059d7b1dda3080e391d99788fff18](https://www.virustotal.com/en/file/a5ff5f861bbb1ac7c6fd44f303f735fac01273ce2ae43a8acb683076192fcfcc/analysis/)\n\n[payload: 9a7f87c91bf7e602055a5503e80e2313 <- main focus of this analysis](https://www.virustotal.com/en/file/e8c6741d3d21068535fb6bb7fe676ecaa74eee06a655c7aa915fc39c0ee7ee16/analysis/1457032020/)\n\n## Behavioral analysis\n\nAfter being deployed it disappears and runs its dropped copy (renamed to [a random\nword].exe from the hidden folder created in %APPDATA%. Name of the folder is specific to a\nparticular sample – in the analyzed one it is: {BD674CFA-429A-0ACF-A3F2\n\n-----\n\n**C895D363964E}.**\n\nSome observed file names: csrstub.exe, dinotify.exe, ndadmin.exe, setx.exe, rasdial.exe,\n_RelPost.exe, ntkrnlpa.exe_\n\nThe dropped file has an edited creation timestamp.\n\nIt also creates a link to the dropped malware in: %APPDATA%/Microsoft/Windows/Start\n_Menu/Programs/Startup:_\n\nLooking via Process Explorer we can see the dropped sample deploying new instances (it is\nused in order to divide the work of encrypting files).\n\n### Registry keys\n\nThe malware makes changes in the Windows registry.\n\nTwo entries (Component_00, Component_01) are dropped in Printers\\Defaults:\n\n\n-----\n\nCompont_01 contains some binary data in base64:\n\nRegistry keys for the persistance are added in various places, i.e:\n\nHKEY_USERS -> [current user’s SID]:\n\n“Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run”\n“Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce”\n“Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer” -> “Run”\n“Software\\\\Microsoft\\\\Command Processor” -> “AutoRun”\n\nHowever, when the encryption finishes successfully, the dropped sample is deleted.\n\n### Encryption process\n\nCerber can encrypt files in offline mode – it means it doesn’t need to fetch the key from the\nCnC server. Files that have been encrypted are fully renamed and appended with the\nextension typical for this ransomware: .cerber. Pattern of the name: [0-9a-zA-Z_-]\n**{10}.cerber**\n\n\n-----\n\nThe encrypted content has a high level of entropy and no patterns are visible. Below:\nvisualization of bytes of square.bmp : left – original, right encrypted with Cerber:\n\nContent of the encrypted file is different on every encryption – probably keys are dynamically\ngenerated. After encryption size of the file content is increased about 384 bytes* – it may\nsuggest, that the RSA encrypted AES key is appended to the file (*depending on the file this\nvalue may vary a bit, probably because of various padding).\n\nAfter executing it displays a ransom note in two forms: HTML and TXT. The note is available\nonly in English. Example below:\n\n\n-----\n\n```\nC E R B E R\nYour documents, photos, databases and other important files have been encrypted!\n\n```\nAt the bottom of the ransom note attackers added a quote in Latin: «…Quod me non necat\nme fortiorem facit.» (“What doesn’t kill me, makes me stronger”). We can only speculate\nwhat they wanted to convey – to share their own motto, or to console the victim of the\nattack?\n\nIt comes also with a VB macro that is supposed to speak up the message with the help of a\nlocal text-to-speech emulator:\n```\nSet SAPI = CreateObject(\"SAPI.SpVoice\")\nSAPI.Speak \"Attention! Attention! Attention!\"\nFor i = 1 to 5\nSAPI.Speak \"Your documents, photos, databases and other important files have been\nencrypted!\"\nNext\n\n### Website for the victim\n\n```\nEach victim has a Web page that can be accessed via Tor. Although the ransom note is\navailable only in English, the Tor website can be customized to several languages:\n\n\n-----\n\nThese pages contain further instructions to the victim and support for managing payments.\nThe time to an increase in the ransom price is counted from the first access to this website.\n```\nTo decrypt your files you need to buy the special software - <<Cerber Decryptor>>.\n\n## Network communication\n\n```\n\n-----\n\nCerber can manage well without CnC and accomplish its task offline. However, if given\nopportunity, it can communicate with CnC in order to send statistics from encryption process.\n\nFirst, it fetches geolocation info (in JSON format) of the local computer by querying a\n[genuine service: http:/ipinfo.io/json](http://ipinfo.io/json)\n\nThen, we can observe sending UDP requests to a predefined range of IP addresses:\n\n## Inside\n\n[Cerber samples come packed by some crypters/FUDs, so the code is not readable at first.](https://blog.malwarebytes.org/development/2015/12/malware-crypters-the-deceptive-first-layer/)\n[Even when we unpack the core (i.e. 9a7f87c91bf7e602055a5503e80e2313), only a few](https://www.virustotal.com/en/file/e8c6741d3d21068535fb6bb7fe676ecaa74eee06a655c7aa915fc39c0ee7ee16/analysis/1457032020/)\nstrings are readable. It is caused by the fact that the authors decided to encrypt the strings\nand decrypt them just before the usage. Example:\n\nThe decrypting function takes the following parameters:\n```\ndecrypt_string(char* input_buffer, DWORD input_lenght, DWORD key, BOOL is_unicode)\n\n```\n\n-----\n\nOne of the few strings that hasn t been encrypted was a check against anti-malware vendors\n(one of them is Malwarebytes). The list of vendors is in JSON – this format have been used\nextensively by Cerber.\n\nAnother interesting unencrypted string was a log, showing the statistics from encryption (the\nfeature used if the malware is deployed in the debug mode):\n\n### Configuration file\n\nCerber comes with an encrypted resource, stored as RC Data. It is decrypted by a dedicated\nfunction:\n\n[After decryption, it turns out to be a configuration in JSON format (you can see it full here):](https://gist.github.com/hasherezade/628928248e8e6c8dae04)\n\n\n-----\n\nConfiguration is rich in options. Contains i.e:\n\na [blacklist used to exclude some countries, languages, file names and directories from](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L3)\nthe attack\na list of [attacked extensions](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L59)\n[environment checks that are enabled](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L52)\n[whether or not to deploy the sample in a debug mode](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L58)\n[encryption settings and output extension](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L444)\n[public RSA key in base64 (decoded).](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L452)\n[files with ransom note to be dropped](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L453)\n[list of services used to obtain geolocation](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L470)\n[range of IPs where to send statistics (compare with IPs described in the section](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L488)\n_‘Network communication’)_\n[format of statistics to be sent](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L487)\n\n**Distributors can customize many things with the help of the config file. Changing the full**\nlook-and-feel of the malware – attacked extensions, ransom note and even extension of\nencrypted files – can make it appear like a new product. This flexibility made me wonder if\nthe same package is not being distributed in a different campaign – not as a Cerber, but\nunder some other name.\n\n[The distributor of the analyzed sample decided to exclude several countries form the attack](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L5)\n(Armenia, Azerbaijan, Belarus, Georgia, Kyrgyzstan, Kazakhstan, Moldova, Russia,\nTurkmenistan, Tajikistan, Ukraine, Uzbekistan). It will also spare your default Windows\ndirectories, [Tor browser and](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L32) [Bitcoin wallet.](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L22)\n\n### Loading the key\n\n[The sample comes with a public RSA key shipped in the configuration file (described in the](https://gist.github.com/hasherezade/628928248e8e6c8dae04#file-config-json-L452)\nprevious section).\n\nBelow – decrypting public key from Base64:\n\n\n-----\n\n[Key is imported using function CryptImportPublicKeyInfo.](https://msdn.microsoft.com/en-us/library/windows/desktop/aa380209%28v=vs.85%29.aspx)\n\nConfiguration mentioned: “rsa_key_size“: 576 – but it turns out to be a 2048 bit key (BLOB\nsize – 276 bytes)\n\n### Installation\n\n\n-----\n\nA file name of the dropped sample is created in a pretty interesting way. It is not fully random,\nbut based on name of some file existing in the system, that is searched in the system using a\nrandom filter (format: “[random char]*[random char]. exe”, i.e “p*h.exe”):\n\nThe found file is compared with some built-in blacklist. When it pass the check, it is chosen\nas the new name of the dropped copy of the malware.\n\nIn order to prevent user from finding the malicious file by its creation timestamp it is changed\nto the timestamp of kernel32.dll existing on the local system.\n\nAfter the successful installation, the initial malware sample terminates and deploys the\ndropped copy instead.\n\n### UAC Bypass\n\n[Cerber uses tricks to bypass Windows User Account Controll (UAC) and deploy itself with](http://blog.cobaltstrike.com/2014/03/20/user-account-control-what-penetration-testers-should-know/)\nelevated privileges. It is achieved by the following steps:\n\n1. Search an executable in C:\\Windows\\system32, that can auto elevate it’s privileges.\n2. Search in it’s import table a DLL that can be hijacked\n3. Copy the DLL into %TEMP% folder and patch it – add a code in a new section and\n\npatch entry point in order to redirect execution there. It will be used in order to run the\n[cerber sample with elevated privileges. It uses: WinExec(“[cerber_path] -eval 2524“,](https://msdn.microsoft.com/en-us/library/windows/desktop/ms687393%28v=vs.85%29.aspx)\nSW_SHOWNORMAL)\n4. Inject the code into explorer.exe – it is responsible for executing the UAC bypass.\n\nCreates a new folder in C:\\Windows\\system32 and copy there both files – an EXE and\nthe patched DLL – under original names, then it deploys the EXE causing DLL to load\nand execute the malicious code.\n5. When the UAC bypass is executed successfully, it is signalized to the original cerber\n\nsample by setting a property cerber_uac_status – added to a Shell_TrayWnd. Then,\nthe original sample deletes dropped files and exits. Otherwise, it tries the same trick\nwith different pair of EXE + DLL.\n\n**See below how it looks in action:**\n\n\n-----\n\nFirst, it searches an application that can be used to elevate privileges. The check is based on\nthe fields in application manifest:\n```\n<autoElevate>true</autoElevate>\n<requestedExecutionLevel level=\"requireAdministrator\"/>\n\n```\nAmong it’s imported DLLs it searches a candidate suitable to be hijacked. This DLL is copied\ninto %TEMP% folder\n\nThen, it creates a suspended process of explorer.exe, allocates memory in it’s context and\ninjects there own code. Details given below.\n\nInjection into explorer is performed in several steps. First – malware is coping memory from\nthe context of current process into the context of explorer.exe. Current image of Cerber\nsample is replicated into a memory allocated in explorer at 0x70000. Similarly, the page\ncontaining filled data is copied at offset 0x91000 in explorer.\n\n\n-----\n\nIn order to run the injected code when the explorer.exe is resumed, malware performs\npatching of the carrier’s Entry Point:\n\nNow, Explorer’s execution starts from the call to injected code. It is a function of Cerber\nsample – at RVA 0x55E1, called with a parameter 0x91000 – pointer to the memory page\ncontaining various dynamically loaded data, like function’s handlers, paths of the files to be\nused, etc.\nFrom inside this code injected to explorer, the DLL patched for UAC bypass is copied under\nthe original name – along with the appropriate EXE. The executable is deployed (using\n[ShellExecuteExW) and along with it, the patched DLL also runs.](https://msdn.microsoft.com/pl-pl/library/windows/desktop/bb762154%28v=vs.85%29.aspx)\n\nThe d3d9.dll is used in order to run the Cerber sample with elevated privileges. Entry Point of\nthe DLL is patched with a jump to the new section.\n\n\n-----\n\nThe new section contains the code that is supposed to execute the Cerber sample:\n\nSuccessful UAC bypass is signalized by setting a property named “cerber_uac_status” in a\nfound window of the class “Shell_TrayWnd“. The initial Cerber sample waits for this status to\nchange. If the timeout passed and it didn’t changed it makes a new attempt of UAC bypass –\nusing a different pair (EXE+DLL). Otherwise it cleans up the environment and terminates.\nInfection proceeds from inside of the elevated sample.\n\n\n-----\n\nIn case if UAC level is set to default (or lower), Cerber can bypass it silently. However, in\ncase if it is set to the highest, the following alert pops up:\n\nIt keeps reappearing till the user click “Yes”:\n\n## Conclusion\n\nCerber is a pretty powerful ransomware written with attention to details. This analysis\nhighlighted only some of the elements. It has rich customization options and various tricks to\nmake analysis harder. Although this product appeared recently, for sure its authors are not\nnew in the field of malware development. We can expect it will be gaining popularity and may\ncarry some new tricks in the future\n\n\n-----\n\n## Appendix\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-03-11 - Cerber ransomware- new, but mature.pdf"
    ],
    "report_names": [
        "2016-03-11 - Cerber ransomware- new, but mature.pdf"
    ],
    "threat_actors": [
        {
            "id": "873a6c6f-a4d1-49b3-8142-4a147d4288ef",
            "created_at": "2022-10-25T16:07:23.455744Z",
            "updated_at": "2025-03-27T02:02:09.811933Z",
            "deleted_at": null,
            "main_name": "Chimera",
            "aliases": [
                "Operation Skeleton Key"
            ],
            "source_name": "ETDA:Chimera",
            "tools": [
                "Agentemis",
                "Cobalt Strike",
                "CobaltStrike",
                "SkeletonKeyInjector",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f88b16bc-df4b-48e7-ae35-f4117240ff24",
            "created_at": "2022-10-25T15:50:23.556699Z",
            "updated_at": "2025-03-27T02:00:55.499173Z",
            "deleted_at": null,
            "main_name": "Chimera",
            "aliases": [
                "Chimera"
            ],
            "source_name": "MITRE:Chimera",
            "tools": [
                "PsExec",
                "esentutl",
                "Mimikatz",
                "Cobalt Strike"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536256,
    "ts_updated_at": 1743041417,
    "ts_creation_date": 1653705026,
    "ts_modification_date": 1653705026,
    "files": {
        "pdf": "https://archive.orkl.eu/fd77950476cc8e647f4bdb396a05fba3beadf9cb.pdf",
        "text": "https://archive.orkl.eu/fd77950476cc8e647f4bdb396a05fba3beadf9cb.txt",
        "img": "https://archive.orkl.eu/fd77950476cc8e647f4bdb396a05fba3beadf9cb.jpg"
    }
}