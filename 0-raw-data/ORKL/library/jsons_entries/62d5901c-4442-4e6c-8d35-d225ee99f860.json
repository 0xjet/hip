{
    "id": "62d5901c-4442-4e6c-8d35-d225ee99f860",
    "created_at": "2023-01-12T14:59:12.193569Z",
    "updated_at": "2025-03-27T02:05:41.561343Z",
    "deleted_at": null,
    "sha1_hash": "a22d3fa63f3325d66d1f1b8ccf7315d7dec76ffe",
    "title": "2022-10-14 - Technical Analysis of BlueSky Ransomware",
    "authors": "",
    "file_creation_date": "2022-11-28T18:54:25Z",
    "file_modification_date": "2022-11-28T18:54:25Z",
    "file_size": 3039219,
    "plain_text": "# Technical Analysis of BlueSky Ransomware\n\n**cloudsek.com/technical-analysis-of-bluesky-ransomware/**\n\nAnandeshwar Unnikrishnan October 14, 2022\n\n**Author: Anandeshwar Unnikrishnan**\n\n**Co-author: Aastha Mittal**\n\n\n**Category:**\n**Malware Intelligence**\n\n\n**Type/Family:**\n**Ransomware**\n\n\n**Industry:**\n**Multiple**\n\n\n**Region:**\n**Global**\n\n\n## What is BlueSky Ransomware?\n\nBlueSky Ransomware is a modern malware using advanced techniques to evade security defences. It predominantly targets Windows hosts\nand utilizes the Windows multithreading model for fast encryption. It first emerged in late June 2022 and has been observed to spread via\nphishing emails, phishing websites, and trojanized downloads.\n\nThis deep-dive analysis of BlueSky Ransomware covers the following technical aspects:\n\nProcedure for privilege escalation\nPersistence\nEncryption mechanism\nEvasion techniques\n\n## Initial Phase\n\nThe modules required for the ransomware are dynamically loaded and addresses of interesting functions are stored in an array for later\nuse.\nThe addresses of the following list of APIs are resolved:\n\n**APIs Stored**\n\n**ntdll.RtlAllocateHeap** **kernel32.CreateFileW** **kernel32.SetFilePointer** **kernel32.CloseHandle** **kernel3**\n\n**ntdll.FreeHeap** **kernel32.FindClose** **kernel32.GetFileSizeEx** **kernel32.SetFileAttributesW** **kernel3**\n\n**kernel32.FindFirstFileExW** **kernel32.ReadFile** **kernel32.GetQueuedCompletionStatus** **kernel32.MoveFileWithProgress** **kernel3**\n\n**kernel32.FindNextFileW** **kernel32.WriteFile** **kernel32.PostQueuedCompletionStatus** **kernel32.lstrCatW** **kernel3**\n\n\n-----\n\nte oad g t e equ ed b a es, t e a so a e p oceeds to pe o t e o o g tas s\nChecks that the running process is 32 bit via kernel32.IsWow64Process\nDecrypts strings\nAdjust the privilege of the process to SE_DEBUG via ntdll.RtlAdjustPrivilege\nRetrieves the following:\n\n**MachineGUID from SOFTWARE\\\\Microsoft\\\\Cryptography**\n**DigitalProductID and InstallDate from SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion**\nHides the main thread from debugger by calling ntdll.ZwSetInformationThread by passing ThreadHideFromDebugger (0x11) as\nThreadInformationClass\nThe ransomware updates the status as “Completed” after the initial phase and the user data is locked.\n\nLocking of\n\nuser data after initial phase\n\n## Mutex Generation\n\nThe ransomware creates a global mutex by calling kernel32.CreateMutexA API.\n\nMutex Creation\n\n## String Decoding\n\nThe ransomware decodes all the strings at runtime. Listed below are various extensions avoided while locking, user data extensions locked,\nand directory names for file enumeration.\n\n### Blacklisted Extensions\n\nThe ransomware leaves the files with the following blacklisted extensions from locking.\n\n**Blacklisted Extensions**\n\n**“ldf”** **“icl”** **“bin”** **“spl”** **“diagcab”** **“ini”** **“theme”** **“hta”**\n\n**“scr”** **“386”** **“hlp”** **“ps1”** **“ico”** **“icns”** **“rtp”** **“diagpkg”**\n\n**“icl”** **“cmd”** **“shs”** **“msu”** **“lock”** **“prf”** **“msc”** **“rtp”**\n\n**“386”** **“ani”** **“drv”** **“ics”** **“ocx”** **“dll”** **“sys”** **“msstyles”**\n\n**“cmd”** **“adv”** **“wpx”** **“key”** **“mpa”** **“bluesky”** **“mod”** **“cab”**\n\n**“ani”** **“theme”** **“bat”** **“msp”** **“cur”** **“nomedia”** **“msi”** **“nls”**\n\n**“adv”** **“msi”** **“rom”** **“com”** **“cpl”** **“idx”** **“diagcfg”** **“exe”**\n\n**“lnk”**\n\n### User Data Extensions\n\nThe files with the following user data extensions are specifically targeted.\n\n**User Data Extensions**\n\n**“ckp”** **“dbs”** **“mrg”** **“qry”** **“wdb”** **“sqlite3”** **“dbc”**\n\n**“dwg”** **“dbt”** **“mwb”** **“sdb”** **“db”** **“sqlitedb”** **“mdf”**\n\n**“db3”** **“dbv”** **“myd”** **“sql”** **“sqlite”** **“db-shm”** **“dacpac”**\n\n**“dbf”** **“frm”** **“ndf”** **“tmd”** **“accdb”** **“db-wal”**\n\n### Directory Names\n\n\n-----\n\ne a so a e uses t ese d ecto y a es o e e u e at o pu pose\n\n**Directory Names**\n\n**“$recycle.bin”** **“boot”** **“windows”** **“perflogs”** **“appdata”**\n\n**“program files”** **“windows.old”** **“all users”** **” users”** **“programdata”**\n\n**“$windows.~ws”** **“system volume information”** **“$windows.~bt”** **“program files (x86)”**\n\n## Pre-Encryption\n\n### Cryptographic Algorithm\n\nCryptographic context is a type of additional authenticated data consisting of non-secret arbitrary name-value pairs. During the initialization\nphase, the ransomware acquires cryptographic context from advapi32.CryptAcquireContext API. The cryptographic provider used by the\nmalware is “Microsoft Enhanced Cryptographic Provider v1.0” and the encryption scheme selected is RSA.\n\nAcquiring cryptographic context\n\n### Recovery Data\n\nBefore the execution of the encryption function, the ransomware writes data needed for the recovery of the locked files in the registry. The\nfollowing data is written:\n\nRECOVERY BLOB\nX25519 public key\n\nWriting data needed for recovery of locked files\n\nUpdated view of the\n\nregistry\n\n### Ransom Note\n\nIf writing the decryption data fails, the ransomware will not execute the routine responsible for the encryption of user data. After a successful\nregistry operation, the ransomware generates a ransom note as the initial task in the function that performs the locking.\n\nRansom note generation\nThe following steps are performed:\n\nA random and unique recovery ID for the victim is generated and stored in the heap buffer.\nThe Bluesky ransomware creates ransom note in “.txt” and “.html” formats.\n\n\n-----\n\no b oc s o 000 ( 096) bytes o eap e o y a e a ocated to o d t e a a so otes\nTwo temporary buffers (txt_ransom_note_buffer and html_ransom_note_buffer) are allocated to hold encoded notes retrieved from the\nbinary.\nA place format string specifier is used as a placeholder for the recovery ID generated in the initial step.\nThe function “sub_2866E0” is responsible for formatting the note by replacing the “%s” with the recovery ID value which is 242\ncharacters long.\nThe result is then stored in memory, to be later used by the function responsible for writing the note to the filesystem.\n\nDecoded note in the buffer\n\n### Process Termination\n\nAfter creating the ransom note, the ransomware enumerates the processes running on the compromised system. The\n**ntdll.ZwQuerySystemInformation API is called by passing the SystemInformation class (0x5) to get the process list from the system. The list**\nis used by the ransomware to selectively kill the processes.\n\nEnumeration of processes running on the compromised system\n\nProcess Termination Task\nThe following steps are performed to terminate the running processes:\n\nThe ransomware starts to analyze the process structure to retrieve the image name and uses shlwapi.PathRemoveExtensionW API to\nremove the extension (.exe) from the name.\nOnce the name of the process without extension is retrieved, the ransomware calls sub_2869B0 to calculate the size of the process\nname.\nNext a call is made to sub_2868C0 to convert the characters to lowercase for uniformity.\nFinally, a custom byte encoding is used to convert the string to a hex value.\nThe generated hex value is checked against an array of encoded values of processes to be terminated.\n\n\n-----\n\nProcess names the threat actor wants to terminate\n\nAt the initial phase the handle to “Shell_Traywnd”, which is obtained using user32.FindWindowA, is passed to the\n**GetWindowThreadProcessId API in order to get the process ID of explorer.exe. (explorer.exe is responsible for creating**\n“Shell_Traywnd”). The process ID is stored in the memory.\nIf there is a match, the target process ID, obtained at the initial phase, is passed to sub_2910F0.\nThe malware checks if the process ID is of its own process or of explorer.exe. After the check, a handle to process is retrieved via\n**kernel32.OpenProcess API.**\nOnly “non-critical” processes are terminated to prevent bug check (Blue Screen of Death). If the passed process handle is not critical, it is\nterminated via kernel32.TerminateProcess.\n\nThe function sub_2910F0\n\nThe ransomware calls ntdll.NtQueryInformationProcess by passing ProcessBreakOnTermination (0x1d) as the InformationClass to\nidentify critical processes.\n\nCall to NtQueryInformationProcess Class\n\n### Empty Recycle Bin\n\nFollowing the process termination, the ransomware empties the recycle bin by calling shell32.SHEmptyRecycleBinA.\n\nEmptying the\n\nrecycle bin\n\n\n-----\n\n## Encryption\n\n### Threading Model: Windows IO Completion Ports in Nutshell\n\nThe Bluesky ransomware performs the encryption by utilizing IO completion ports. I/O completion ports provide an efficient threading\nmodel for processing multiple asynchronous input-output (I/O) requests on a multiprocessor system.\n\nThreading model using the IO ports\n\nThe main thread creates the IO completion port via CreateIOCompletionPort. The created port can be associated with many file\nhandles. When the asynchronous IO operation on one of the file handles is completed, an IO completion packet is queued in FIFO order\nto the associated port.\nThe worker thread performs a call to PostQueuedCompletionStatus to enqueue the associated data. In the case of ransomware, the\ndata will be the absolute path of the user files waiting in the queue to get encrypted.\nAnother worker thread performs GetQueuedCompletionStatus to dequeue the contents from the main queue. Usually, in ransomware,\nthis thread is responsible for performing encryption and ransom note generation.\nThe following section contains an depth description of each of the above-mentioned functions.\n\n### CreateIOCompletionPort\n\nThe call to CreateIOCompletionPort involves the following steps:\n\nThe main thread retrieves the processor count from the PEB (Process Environment Block) structure.\nA call to CreateIoCompletionPort is made by passing processor count as NumberOfConcurrentThreads parameter value.\nMultiple worker threads are created by calling kernel32.CreateThread.\nFor each thread, an affinity mask (a bit mask indicating what processor a thread should run on) is set by calling\n**kernel32.SetThreadAffinityMask.**\nThe main thread performs basic drive enumeration and calls PostQueuedCompletionStatus.\n\n\n-----\n\nCalling CreatIoCompletionPort\n\nRetrieving processor count from PEB\n\nPostQueuedCompletionStatus Function\nFollowing APIs are used for drive enumeration on the system:\n\nkernel32.GetLogicalDriveStringsW\nkernel32.GetDriveTypeW\n\nFurther enumeration of files is performed by creating worker thread for PostQueuedCompletionStatus.\n\nCreation of worker thread for PostQueuedCompletionStatus\nThe main thread calls mpr.WNetOpenEnumW for enumerating network resources and creates a worker thread same as above that performs\nthe PostQueuedCompletionStatus call.\n\nCalling\n\nmpr.WNetOpenEnumW function\n\n### Worker Thread: PostQueuedCompletionStatus\n\n\n-----\n\nThe worker thread that performs the PostQueuedCompletionStatus\nThe newly created thread for PostQueuedCompletionStatus leads to the following:\n\nThe files are enumerated via kernel32.FindFirstFileExW and kernel32.FindNextFileW.\nIf it is a directory, the thread function is recursively called to perform the file enumeration.\nIf it is a user file, then the absolute path is enqueued to the completion queue via PostQueuedCompletionStatus call.\nThis worker thread is responsible for gathering the files for encryption.\n\n### Worker Thread: GetQueuedCompletionStatus\n\nThis worker thread is responsible for doing the actual locking of the user files. The ransomware hides this thread from the debugger via\n**ntdll.ZwSetInformationThread by passing ThreadHideFromDebugger as the ThreadInformationClass.**\n\nCalling ntdll.ZwSetInformationThread function\nThe thread decodes the file extension “.bluesky” and proceeds to perform the encryption. The kernel32.GetQueuedCompletionStatus is\ncalled in an infinite loop to retrieve the absolute path of the user data.\n\n\n-----\n\nDecoding file extension “.bluesky”\nThe sub_288780 function is responsible for encrypting the data. The thread checks if the dequeued item is a directory or a file.\n\nIf it is a file then it proceeds to encrypt the data by using the following APIs:\n\nkernel32.CreateFileW\nkernel32.SetFilePointer\nkernel32.ReadFile\nkernel32.WriteFile\nIf the item is a directory then sub_28EDA0 is executed to dump the ransom note. The file name strings are decoded dynamically.\n\nFile name strings being decoded\n\nExecution of sub_28EDA0\n\nThe note content generated by the ransomware is written on the disk by calling:\n\nkernel32.CreateFileW\nkernel32.WriteFile\n\nRansom\n\nnote being written on the disk\n\n## Post Encryption\n\nOnce the user data is successfully locked, the ransomware performs the following operations:\n\nReleases the mutex created at the initial phase\nSets the thread state to ES_Continous\nDestroys the allocated heap\n\n\n-----\n\nts t e p ocess a e e 3 t ocess\n\nPost encryption functions\n\n## Indicators of Compromise(IoCs)\n\n**MD5**\n\n**961fa85207cdc4ef86a076bbff07a409**\n\n**53c95a43491832f50e96327c1d23da40**\n\n**5ef5cf7dd67af3650824cbc49ffa9999**\n\n**efec04688a493077cea9786243c25656**\n\n**d8a44d2ed34b5fee7c8e24d998f805d9**\n\n**848974fba78de7f3f3a0bbec7dd502d4**\n\n## Appendix\n\nRansom Note in .txt format\n\n\n-----\n\nRansom Note in .html format\n\nAuthor Details\n\n[Anandeshwar Unnikrishnan](https://cloudsek.com/author/anadeshwar-unnikrishnan/)\nThreat Intelligence Researcher, [CloudSEK](https://cloudsek.com/)\nAnandeshwar is a Threat Intelligence Researcher at CloudSEK. He is a strong advocate of offensive cybersecurity. He is fuelled by his passion\nfor cyber threats in a global context. He dedicates much of his time on Try Hack Me/ Hack The Box/ Offensive Security Playground. He\nbelieves that “a strong mind starts with a strong body.” When he is not gymming, he finds time to nurture his passion for teaching. He also likes\nto travel and experience new cultures.\n\n[Aastha Mittal](https://cloudsek.com/author/aastha-mittal/)\nTotal Posts: 0\nTechnical Writer at CloudSEK\n×\n\n\n-----\n\n[Anandeshwar Unnikrishnan](https://cloudsek.com/author/anadeshwar-unnikrishnan/)\nThreat Intelligence Researcher, [CloudSEK](https://cloudsek.com/)\nAnandeshwar is a Threat Intelligence Researcher at CloudSEK. He is a strong advocate of offensive cybersecurity. He is fuelled by his passion\nfor cyber threats in a global context. He dedicates much of his time on Try Hack Me/ Hack The Box/ Offensive Security Playground. He\nbelieves that “a strong mind starts with a strong body.” When he is not gymming, he finds time to nurture his passion for teaching. He also likes\nto travel and experience new cultures.\n\nLatest Posts\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-10-14 - Technical Analysis of BlueSky Ransomware.pdf"
    ],
    "report_names": [
        "2022-10-14 - Technical Analysis of BlueSky Ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "555e2cac-931d-4ad4-8eaa-64df6451059d",
            "created_at": "2023-01-06T13:46:39.48103Z",
            "updated_at": "2025-03-27T02:00:03.105297Z",
            "deleted_at": null,
            "main_name": "RomCom",
            "aliases": [
                "Storm-0978",
                "UAT-5647"
            ],
            "source_name": "MISPGALAXY:RomCom",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535552,
    "ts_updated_at": 1743041141,
    "ts_creation_date": 1669661665,
    "ts_modification_date": 1669661665,
    "files": {
        "pdf": "https://archive.orkl.eu/a22d3fa63f3325d66d1f1b8ccf7315d7dec76ffe.pdf",
        "text": "https://archive.orkl.eu/a22d3fa63f3325d66d1f1b8ccf7315d7dec76ffe.txt",
        "img": "https://archive.orkl.eu/a22d3fa63f3325d66d1f1b8ccf7315d7dec76ffe.jpg"
    }
}