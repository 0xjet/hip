{
    "id": "86d5204e-7a1c-405b-b81b-b59595458753",
    "created_at": "2023-01-12T15:08:05.107766Z",
    "updated_at": "2025-03-27T02:09:30.083202Z",
    "deleted_at": null,
    "sha1_hash": "0846d8bc1f6eeac20f551e009d1a0262eb6e1aa2",
    "title": "2022-02-24 - [QuickNote] Techniques for decrypting BazarLoader strings",
    "authors": "",
    "file_creation_date": "2022-05-28T15:24:09Z",
    "file_modification_date": "2022-05-28T15:24:09Z",
    "file_size": 1293654,
    "plain_text": "# [QuickNote] Techniques for decrypting BazarLoader strings\n\n**[kienmanowar.wordpress.com/2022/02/24/quicknote-techniques-for-decrypting-bazarloader-strings/](https://kienmanowar.wordpress.com/2022/02/24/quicknote-techniques-for-decrypting-bazarloader-strings/)**\n\n**1. Overview**\n\n\nFebruary 24, 2022\n\n\nUsually, to make it more difficult for analysts, malware authors will hide important strings and\n[only decrypt these strings during runtime. The famous malwares like Emotet,](https://blog.vincss.net/2021/01/re019-from-a-to-x-analyzing-some-real-cases-which-used-recent-Emotet-samples.html) [QakBot or](https://blog.vincss.net/2021/03/re021-qakbot-dangerous-malware-has-been-around-for-more-than-a-decade.html)\n[TrickBot often use the one or some functions to perform decrypting strings when needed.](https://blog.vincss.net/2021/10/re025-trickbot-many-tricks.html)\n\nHowever, on researching and analyzing some other malwares such as Conti, BlackMatter\nand BazarLoader, instead of using a separate function to decrypt strings, these malwares\nmake it more difficult by saving the encrypted strings on the stack as stack strings. Then,\nstrings are decrypted by XOR-ing with a key value (this value may not be fixed) or through\nquite complex computation. This technique consumes time of the analyst.\n\nThe images below are the pseudocode of the Conti and BlackMatter malware.\n\nThis article uses the BazarLoader samples as an example to demonstrate how to decrypt\nstrings with:\n\nAutomate resolving with IDAPython script.\nEmulate code with IDA uEmu plugin.\nDebugging with IDA Bochs plugin.\n\n\n-----\n\n**2. BazarLoader samples**\n\nBazarLoader was first discovered in April 2020. The malware loader has been continuously\nevolving, allowing attackers to install additional malware, often used for ransomware attacks,\ndropping Cobalt Strike, and stealing sensitive data. The common assumption is that the\ndistribution and post-exploitation activities of the loader are akin to the Trickbot malware.\n\nThese samples are all 64-bit Windows executable.\n\n[Unpacked sample 1: cc522400b3fed1d2c4dcca16666ddcff](https://www.virustotal.com/gui/file/74f19779e5a8ef2e459a9bf178cf35dc334a8ab97116d22c9e06d88ab3c5ef32/details)\n[Unpacked sample 2: 63c4bb3f1044f36632ce1759b62296dc](https://www.virustotal.com/gui/file/2465edb954ed8d6760c38481c0a9c1b34989dc9f009db059ddea9a0705f21492/details)\n\n**3. Decrypt strings**\n\n**3.1. Using IDApython script**\n\nAnalyzing the first sample of BazarLoader, we will see that it uses the same stack strings\ndecryption technique as in BlackMatter ransomware:\n\n[To decrypt these strings, you can use x64dbg to debug or extract the above values and use](https://x64dbg.com/)\n**[CyberChef to perform the following:](https://gchq.github.io/CyberChef/)**\n\n\n-----\n\nHowever, debugging with x64dbg or using CyberChef as above will take more time, to make\nstatic analysis easier, I will use IDAPython script to decrypt the strings. The code I use is as\nfollows:\n\nLoad this script into IDA, providing the relevant addresses to perform the decryption:\n\nFinally, by using the above script, the analysis process will be much more convenient:\n\n\n-----\n\n3.2. Using uEmu plugin\n\nIn the second sample of BazarLoader, the code that decrypt the stack strings is similar to the\nConti ransomware and quite complicated:\n\nWith the code as shown in the figure, the implementation of using IDApython script will be\ndifficult and not feasible. The most suitable solution for this case is to use an emulator to\n[emulate the code. Here, I will use uEmu, a tiny cute emulator plugin for IDA based on](https://github.com/alexhude/uEmu)\nunicorn engine.\n\nVery easy to emulate the decoding code with uEmu:\n\n\n-----\n\nFirst, set a breakpoint at the address after the string has been decrypted.\n\nGo to the beginning of the function and select the starting address of the function, then\nstart uEmu. The CPU Context Edit window will appear, click OK to continue. uEmu will\nnow initialize the emulator. Check the CPU context to see if the address of the\n```\nEIP/RIP register is pointed at the beginning of the function:\n\n```\n\n-----\n\nThen, through uEmu Control, you can trace the code by Step or Run to emulates\ninstructions until breakpoint is reached. During execution, uEmu will ask about\nunmapped memory, select No to continue.\n\n\n-----\n\nPress Step, to trace over the `lea` command. Then using uEmuâ€™s Show Memory\n**Range feature, enter the address of the** `rdx` register and select Add. The result will\nbe similar to the following:\n\n3.3. Debugging with IDA Bochs Plugin\n\n**IDA Bochs debugger plugin allows malware researchers to debug malicious code in a**\n[safe/emulated environment. For more information please visit [1], [2].](https://hex-rays.com/products/ida/support/idadoc/1329.shtml)\n\nIn order to debug the code that decrypt the string, we configure the Bochs plugin to work in\n**IDB mode. This mode is used to debug code snippets by simply selecting the code from the**\ndatabase.\n\n\n-----\n\nNext, select the position or code snippets to debug, then press F9 to start debugging:\n\nFrom here you can trace the code as usual or simply set a breakpoint at the address after\nfinished decryting the string and press F9. The resulting at `rdx` register will point to the\ndecrypted string as follows:\n\n\n-----\n\n4. References\n\nEnd.\n\n**m4n0w4r**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-24 - [QuickNote] Techniques for decrypting BazarLoader strings.pdf"
    ],
    "report_names": [
        "2022-02-24 - [QuickNote] Techniques for decrypting BazarLoader strings.pdf"
    ],
    "threat_actors": [
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536085,
    "ts_updated_at": 1743041370,
    "ts_creation_date": 1653751449,
    "ts_modification_date": 1653751449,
    "files": {
        "pdf": "https://archive.orkl.eu/0846d8bc1f6eeac20f551e009d1a0262eb6e1aa2.pdf",
        "text": "https://archive.orkl.eu/0846d8bc1f6eeac20f551e009d1a0262eb6e1aa2.txt",
        "img": "https://archive.orkl.eu/0846d8bc1f6eeac20f551e009d1a0262eb6e1aa2.jpg"
    }
}