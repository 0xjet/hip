{
    "id": "c5dacb23-ff49-40a6-8cf8-9f1d78730086",
    "created_at": "2023-01-12T15:10:57.515133Z",
    "updated_at": "2025-03-27T02:05:46.184814Z",
    "deleted_at": null,
    "sha1_hash": "ed734af51b88986d8ea114f16a0b6b6b873e3863",
    "title": "2020-02-20 - CSI- Evidence Indicators for Targeted Ransomware Attacks – Part II",
    "authors": "",
    "file_creation_date": "2022-05-27T21:27:31Z",
    "file_modification_date": "2022-05-27T21:27:31Z",
    "file_size": 1719947,
    "plain_text": "# CSI: Evidence Indicators for Targeted Ransomware Attacks – Part II\n\n**[mcafee.com/blogs/other-blogs/mcafee-labs/csi-evidence-indicators-for-targeted-ransomware-attacks-part-ii/](https://www.mcafee.com/blogs/other-blogs/mcafee-labs/csi-evidence-indicators-for-targeted-ransomware-attacks-part-ii/)**\n\nFebruary 20, 2020\n\nIn our [first article we discussed the growing pattern of targeted ransomware attacks where](https://www.mcafee.com/blogs/other-blogs/mcafee-labs/csi-evidence-indicators-for-targeted-ransomware-attacks/)\nthe first infection stage is often an info-stealer kind of malware used to gain\ncredentials/access to determine if the target would be valuable for a ransomware attack. In\nthis second part we will pick up where we left off: the attacker has a foothold on the network\nby controlling an infected host or has a valid account to access a remote service.\n\n\n-----\n\nFigure 1 Adversary has a beachhead\nWith either a valid account or having access towards a system in a company, the first two\nthings you want to figure out are:\n\n1. What kind of rights do I have from this machine?\n2. Where the heck am I in this network?\n\nOne of the first commands you would observe as a responder is “whoami/all”. The output of\nthis command will give the details of the account the attacker has on the machine with\nregards to group/privileges. A great way to detect suspicious activity in your network is to\nsetup a detection rule for the “whoami” command and assign it to the assets in use by\nexecutives or holders of key positions in the company. There might always be a techie\nexecutive in the company but most of them will never use command or use a command-line.\n\nIn the context of the targeted ransomware attacks, the attacker preferably wants to have\nlocal-admin/domain-admin and or system rights. Those will be the keys to the kingdom and\nopen all gates.\n\nIn the next step, mostly observe some variant from Mimikatz or other password-dumping\ntools that will dump the credentials from a machine. Either the tool Mimikatz is compiled in\nvarious formats or it is part of a remote PowerShell toolkit like Empire:\n\n\n-----\n\nFigure 2 Empire Mimikatz (source powershellempire.com)\nWe began this article series with the fact that every touch of a system will leave digital\nfootprints behind, in this example with Empire, the following is happening:\n\nAttacker has a connection to a system through usage of a ‘launch script’\nAttacker is using a C2 (command and control) to interact\nAttacker is using PowerShell to execute commands\n\nFrom a MITRE ATT&CK Techniques perspective we would look at this overview of\ntechniques and interaction:\n\n\n-----\n\nFigure 3 Attacker using Empire\nWhich stages and evidence sources will create visibility and early warning indicators?\n\nFor PowerShell usage there are several digital evidence locations available. Besides traces\nin memory, there can be traces discovered in the Windows Event logs, the Registry, on the\nfile-system like the Prefetch directory and there’s even a PowerShell command history file\navailable if a version of PowerShell v5 and above is used. That location can be found at:\n\n**_C:\\Users\\<username>\\AppData\\Roaming\\Microsoft\\Windows_**\n**_PowerShell\\PSReadline\\ConsoleHost_history.txt_**\n\nEmpire by design is encrypting its communications, makes infrequent and randomized\nconnections and, last but not least, is mirroring HTTP activity to stay hidden in the ‘normal’\ntraffic. If we look at the order of volatility from our first article, network traffic will change from\nseconds to minutes, giving us a very short window unless we do full packet capture and\ninspection of our network traffic.\n\nThe network activity might be challenging to notice, however there are possible indicators\nthat can help possible Empire traffic. To setup the C2 traffic, the attacker needs to configure\na ‘listener’ that contains all the settings for the C2 traffic interaction.\n\nFigure 4 Empire Listener setup\n\n\n-----\n\nIn the partial setup screen in Figure 4, we see three URI s being configured that will be\nfrequently requested and combined with an HTTP Header. A combination detection of the\nthree URI’s polled within x timeframe combined with the HTTP header could be a very good\nnetwork-indicator to detect Empire C2 traffic. As a responder, when you detect these\nindicators, look back at Figure 3 and start hunting backwards. You discovered the C2 activity,\nbut it means the hosts who are interacting with the C2 have PowerShell activity and time to\nsecure your evidence. This is how I like to apply the MITRE ATT&CK model: understand\nwhat you just discovered, and the implications then hunt for evidence or anticipate the\nattacker’s next step and act.\n\nKeep in mind this is a default setup and can be changed by the attacker. Experience\nsuggests that cyber-crime motivated actors are in a hurry for the cash and use a default\ninstallation of tools, whereas nation-state cyber-espionage operations are customizing since\nthey want to operate longer in a victim’s network.\n\nNow back to our scenario. The attacker has acquired the right privileges and has laterally\nmoved through the network to have an idea how large it is and have possibly identified\ncritical assets — they love shared folders with a lot of data in them.\n\nThe attacker will next prepare a custom version of the ransomware and could have tested it\non underground AV-testing services to make sure that it will be fully undetectable (FUD).\nDepending on skills and capabilities, the ransomware will either be uploaded to the victim’s\nnetwork or using scripts distributed and executed over the network. We have observed cases\nwhere a series of .bat scripts were used and where the payload was downloaded from\nPastebin and executed by PowerShell on hosts – enough variety and options. Once\nexecuted, the first calls will come into the Helpdesk reporting the ransom notes.\n\nA lot of the above techniques are available within post exploitation frameworks, of which\nthere are several options that attackers can choose from. With any of these, the tool is only a\nconduit and we should always focus on detecting techniques rather than implementation\nspecifics. Available options come in the form of both underground toolkits and penetration\ntest tools designed to build awareness around the attacks. Unfortunately, those designed as\nsecurity tools may also be used for nefarious purposes. This ‘chicken and egg’ situation is\noften the cause of heated debate since on one hand the tools can streamline attack\nscenarios, while on the other, without having them available to defenders, adequate testing\nof precautions is impossible.\n\nEmpire was mentioned above. This excellent PowerShell-based post-exploitation framework\nis no longer maintained or supported by its authors. Although forks exist, traction has slowed\n[but its use is still detected. Cobalt Strike, a commercial adversary simulation platform](https://attack.mitre.org/software/S0154/)\nregularly used by red teams to test infrastructural security measures and detection capacity,\n[is increasingly being adopted by](https://blog.fox-it.com/2019/02/26/identifying-cobalt-strike-team-servers-in-the-wild/) [criminal actors.” Although its license is strictly controlled,](https://attack.mitre.org/software/S0154/)\npirated and cracked trial versions are available in the criminal underworld. Cobalt Strike is\n\n\n-----\n\nupdated regularly to include the latest techniques and tools such as Mimikatz, while allowing\na lot of flexibility for addition of new and unique attack and bypass techniques. This can\nincrease the likelihood of success, even on the most recent operating system versions.\n\nThreat groups distributing GoGalocker, MegaCortex and Maze ransomware have been\nobserved utilizing Cobalt Strike. At this stage in our scenario, with a foothold on the network,\nCobalt Strike provides many options which can be used to complete their objective. These\ninclude T1075 Pass the Hash, T1097 Pass the Ticket, T1105 Remote File Copy, T1021\nRemote Services and the old reliable: T1077 Windows Admin Shares.\n\n[As detailed in part 1, this evidence remains on a system for differing time spans. By studying](https://www.mcafee.com/blogs/other-blogs/mcafee-labs/csi-evidence-indicators-for-targeted-ransomware-attacks/)\nprevious attacks, we can see a general mode of operation and a sequence in which these\ntechniques are executed. This can help guide us when choosing the timing and methods of\nevidence collection.\n\nDetection of these attacks is not an easy task. Exploitation frameworks are often open\nsource, in which case the attacker can modify code to manipulate IOC’s (indicators of\ncompromise). Alternatively, and as is the case for our example, Cobalt Strike, the framework\nwill provide specific configuration around the final form of binary droppers, network traffic\nformat, timing and specific parameters, etc. Therefore, generic signatures will only detect the\nmost basic of attacks and, as previously mentioned, focusing on techniques and behaviors\nrather than tools becomes critical. Creating a Cobalt Strike generic detection may miss the\npoint of its existence – education around malicious techniques and behaviors. However, we\ncan learn a lot about various indicator categories that can be monitored for functional outliers\nand unusual behaviors and, where the tool is merged into malware strains, the markers for\nthat specific instance can often become specific IOC’s.\n\nIn a lot of cases, understanding normal system behavior is crucial for uncovering outliers and\nhaving a baseline system for comparison can aid the analysis.\n\nA few examples of these include:\n\nMemory\n\nThe holy grail. Binary droppers may be modified to mask their true intentions,\nhowever in memory they can be visible in a decoded format.\nSearch for markers of functionality such as suspicious system calls or\nreads/writes of sensitive system locations (e.g. lsass memory).\nRunning Processes\n\nSimilarly, running processes can be very revealing.\nAlthough process ‘migration’ is often carried out, review for abnormal process\nhierarchies.\nDoes the process carry out functionality that is not expected? E.g. does notepad\nmake http requests to an external domain?\n\n\n-----\n\nNetwork Traffic\n\nDomains should match known-good.\nSpikes or regular timing patterns in traffic type or to specific servers.\nVariables used in unusual manner, e.g. http headers including encoded binary\ndata.\nDisk\n\nBinary and configuration files available for reverse engineering.\nThis static analysis is not as powerful as dynamic, running software.\nDebugging a malicious binary may help but beware of sandbox/debugger\ndetection.\nBackup / Log Files\n\nNever fully trust log files as attackers can easily falsify. External sources, e.g.\nsyslog going to an external db, can improve the reliability of log data if available.\nSearch for specific markers for malicious activity. Some useful items to include:\ncommand line logs, PowerShell script block logging, specific logs for network\napplications such as web servers, service installation, share accessed –\nparticularly C$, process launch, account login.\n\nAs we highlighted in the two articles, targeted ransomware attacks have increased massively\nover the past 8 months. Targeting MSPs to hit many at the same time, victims running critical\noperations, public services, etc. Many of them are all using a similar blueprint as we tried to\nhighlight.\n\nLearn from the articles, identify which technology can give you that visibility, what digital\nevidence sources do you have, and can you detect fast enough to preserve and respond? If\nthe ‘initial access stage’ is passed, where can you pick up in your line of defense and stop\nthe threat?\n\nStay tuned for part 3, where we discuss technical controls that are available to help your\norganization to react to these early warning signs within an acceptable timeframe.\n\n[Christiaan Beek Lead Scientist & Sr. Principal Engineer](https://www.mcafee.com/blogs/author/christiaan-beek/)\nChristiaan Beek is the Lead Scientist & Sr. Principal Engineer of the Enterprise Office of the\nCTO. He is leading the strategic threat intelligence research with a focus on inventing...\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-02-20 - CSI- Evidence Indicators for Targeted Ransomware Attacks – Part II.pdf"
    ],
    "report_names": [
        "2020-02-20 - CSI- Evidence Indicators for Targeted Ransomware Attacks – Part II.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "faa4a29b-254a-45bd-b412-9a1cbddbd5e3",
            "created_at": "2022-10-25T16:07:23.80111Z",
            "updated_at": "2025-03-27T02:02:09.985067Z",
            "deleted_at": null,
            "main_name": "LookBack",
            "aliases": [
                "FlowingFrog",
                "LookBack",
                "LookingFrog",
                "TA410",
                "Witchetty"
            ],
            "source_name": "ETDA:LookBack",
            "tools": [
                "FlowCloud",
                "GUP Proxy Tool",
                "SodomMain",
                "SodomMain RAT",
                "SodomNormal"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536257,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1653686851,
    "ts_modification_date": 1653686851,
    "files": {
        "pdf": "https://archive.orkl.eu/ed734af51b88986d8ea114f16a0b6b6b873e3863.pdf",
        "text": "https://archive.orkl.eu/ed734af51b88986d8ea114f16a0b6b6b873e3863.txt",
        "img": "https://archive.orkl.eu/ed734af51b88986d8ea114f16a0b6b6b873e3863.jpg"
    }
}