{
    "id": "41e8c762-53fd-4dc4-b761-8921cd770dec",
    "created_at": "2023-01-12T15:01:49.653911Z",
    "updated_at": "2025-03-27T02:08:23.177689Z",
    "deleted_at": null,
    "sha1_hash": "4108bf34304a9503a5e87e0b81f2abd584f6ed7d",
    "title": "2020-02-03 - Dissecting Emotet – Part 1",
    "authors": "",
    "file_creation_date": "2022-05-27T21:12:44Z",
    "file_modification_date": "2022-05-27T21:12:44Z",
    "file_size": 447659,
    "plain_text": "# Dissecting Emotet – Part 1\n\n**[telekom.com/en/blog/group/article/cybersecurity-dissecting-emotet-part-one-592612](https://www.telekom.com/en/blog/group/article/cybersecurity-dissecting-emotet-part-one-592612)**\n\nBlog.Telekom\n\n02‑03‑2020\n[Thomas Barabosch](https://www.telekom.com/en/blog/592636-592636)\n\n7 Comments\n\nShare Share\nTwo clicks for more data privacy: click here to activate the button and send your recommendation.\nData will be transfered as soon as the activation occurs.\n\nPrint\n[Read out](https://app-eu.readspeaker.com/cgi-bin/rsent?customerid=4779&lang=en&readid=readspeakercontent&url=https://www.telekom.com/en/blog/group/article/cybersecurity-dissecting-emotet-part-one-592612)\n\nI bet you've heard of Emotet, a modular botnet that is active at least since 2014. Since many years it is\n[considered one of the most costly and destructive malware family affecting the public and private sectors](https://www.us-cert.gov/ncas/alerts/TA18-201A)\nas well as individuals. For those who do not know the background to Emotet yet: It started off as a banking\n[Trojan but changed its modus operandi in 2017 to the distribution of third party malicious payloads.](https://www.symantec.com/blogs/threat-intelligence/evolution-emotet-trojan-distributor)\n[Recently, researchers have observed Emotet to deliver TrickBot and the ransomware Ryuk as secondary](https://www.cybereason.com/blog/one-two-punch-emotet-trickbot-and-ryuk-steal-then-ransom-data)\npayloads.\n\nThomas' path led from research to business. He regularly shares his findings in this blog.\n\nThis botnet comprises its own spreading mechanism. Most infections are achieved by sending out spam\nwith links to malicious documents. If the target actively interacts with such a document, Emotet's loader is\ninstalled. The loader is very limited in its capabilities from my point of view. Its main purpose is to persist\nEmotet on a target system, contact its Command & Control Servers, which steer the attack (C2 servers),\n\n\n-----\n\nand download as well as execute further payloads. These payloads are either Emotet modules or further\nsecondary payloads like TrickBot. The interesting functionality of Emotet is implemented in its modules\nsuch as spamming, lateral movement, or credential theft. This modular structure makes Emotet very\nflexible and effective.\n\nEmotet's modules do not persist on a target system. This has several consequences. First, it is forensically\nhard to tell what kind of data an Emotet infection stole. Since modules are distributed to a target system\nbased on an unknown selection algorithm, the number of modules that are deployed on a target system\nvaries. Second, there tends to be a delay of up to a couple of weeks in the emergence of such modules on\npublic online scan engines like VirusTotal. This results in a short period of time where these modules fly\nunder the radar.\n\nIn this multi part blog post, I will now dive deep into Emotet's modules internals. In the first part, I will give\nan overview of the currently distributed modules and the way how some of these modules encrypt their\npayloads. Then I will describe how and why some of these modules are constantly changing their hash\nvalues and I will discuss the evolution of Emotet's modules in the last couple of months.\n\n## Emotet - from the big picture to the detail\n\nThe Emotet loader downloads modules from its C2 server and executes them. These modules are\nimplemented as Windows libraries (PE DLLs). They do not export any functions besides a DLL entry point.\nThey may directly import additional functions from Windows libraries like 'kernel32.dll'. The Emotet loader\nexecutes a module in a new thread within its process space. In order to do so, it resolves any imported\nfunctions and applies relocations. Subsequently, it starts a new thread at the DLL's entry point. I found that\nmodules work independently of the main module and hence they are easy to debug in isolation.\n\nThe obfuscation techniques of Emotet's modules are equal to its loader: they dynamically resolve most of\nthe Windows API addresses via API hashing and they utilize a simple string encryption. Cafe Babe\n[described Emotet's API hashing and](https://medium.com/@0xd0cf11e/analyzing-emotet-with-ghidra-part-2-9efbea374b14) [string encryption in detail last year, which has not significantly](https://medium.com/@0xd0cf11e/analyzing-emotet-with-ghidra-part-1-4da71a5c8d69)\nchanged since then. Note that Emotet's modules do not come in packed form. However, many of them are\njust wrappers around another payload. For instance, there is a wrapper module around NirSoft's\nWebBrowserPassView, which is a recovery tool for passwords stored in web browsers. This module\ndecrypts WebBrowserPassView first and then it starts it in its own process.\n\nI observed that some of these wrappers carry a 32 bit and a 64 bit payload. Depending on the system's\narchitecture, the corresponding module gets decrypted and executed. The payloads are encrypted using a\nsimple eXclusive OR cipher (XOR) with a hard-coded key, which I will explain later on.\n\nTable 1 lists the payloads that I observed recently while tracking Emotet's infrastructure. Our findings are\n[congruent with other public sources like Lucy Nagy's VirusBulletin 2019 paper.](https://www.virusbulletin.com/virusbulletin/2019/10/vb2019-paper-exploring-emotet-elaborate-everyday-enigma/)\n\n\nRepresentative Hash\n\n\n**Module**\n\n\nIs\nWrapper\nModule?\n\n\n**spammer** No 54be4115e54b6dcb2986ff953b271202de0b3c64b4b18714f49e0febddba3c0c\n\n\n**administrative**\n\n**hare spreader**\n\n\nNo f8dd847ab1565aa460875c782f44a003a5b2c20b0e76a6672cfe3cd952a38727\n\n\n-----\n\n**network**\n**password**\n**bruteforcer**\n\n\n**WebBrowser-**\n**PassView**\n\n\nNo d714eca8a485b86cfa40dacfdedcd164877bf9d0e0d704ea325718b14498ba02\n\nYes 7f11dabe46bf0af8973ce849194a587bd0ba1452e165faf028983f85b2b624c2\n\n\n**[MailPassView](https://www.nirsoft.net/utils/mailpv.html)** Yes 400b411a9bffd687c5e74f51d43b7dc92cdb8d5ca9f674456b75a5d37587d342\n\n\n**Outlook**\n**contact**\n**harvester**\n\n\n**Outlook mail**\n**harvester**\n\n\nYes fb541624735a03a1a72aebf80847403aa68d7278f6fea101d2ea9afc568b3b46\n\nYes 404652e82de15d9c6436d49cd9a2b46bc8b3a66f0a6530574e50ae165a5619e1\n\nNo 902bac124f2926e6a345f393f292136a02b3cf523f9c156f40223a0343f0869c\n\n\n**C2 traffic**\n**proxy**\n\n\nThese modules keep the Emotet machinery running. The first three modules (spammer, administrative\nshare spreader, and network password bruteforcer) spread Emotet to other machines. The spammer\nmodule carries out the spreading via email on a global scale. The administrative share spreader and the\nnetwork password bruteforcer help to spread Emotet laterally within an infected organization. The\nadministrative share spreader tries to spread Emotet to network shares that are accessible to the local\nadministrator. The network password bruteforcer tries to brute force accounts of local network resources\nand subsequently execute the Emotet loader. Researchers observed this module to use a list of 10.000\n[passwords earlier this year. However, I found out that the latest known version from 2019-04-24 17:53:50](https://www.virusbulletin.com/virusbulletin/2019/10/vb2019-paper-exploring-emotet-elaborate-everyday-enigma/)\n[utilizes a brute force dictionary similar to the one reported to be used by QuackBot.](https://github.com/varonis/qbot-analysis/blob/master/brute-force-dictionary.txt)\n\nThe modules for credential harvesting (WebBrowserPassView and MailPassView) allow for monitarization\nof stolen account data. Furthermore, they feed the spam module with new mail accounts. The Outlook\ncontact harvester finds fresh target email addresses to be used by the spammer module. The Outlook mail\n[harvester is a targeted way of spreading Emotet by highjacking email threads. Finally, the C2 traffic proxy](https://www.kryptoslogic.com/blog/2018/10/emotet-awakens-with-new-campaign-of-mass-email-exfiltration/)\nmodule ensures resilience of the botnet. It accepts C2 traffic of other infected machines and sends it to the\nC2 server.\n\n## Wrapper Module Payload Decryption\n\nEarlier I stated that there are some modules that are wrappers around another payload. For instance, there\nis a wrapper that contains the Nirsoft tool WebBrowserPassView as payload. The wrapper decrypts this\npayload and injects it into another process in order to harvest credentials stored by local web browsers.\n\n[The payload decryption algorithm is actually very similar to the string decryption algorithm that Cafe Babe](https://medium.com/@0xd0cf11e/analyzing-emotet-with-ghidra-part-1-4da71a5c8d69)\ndescribed. In a nutshell, the decrypted payload is stored in a binary blob. Logically, this blob consists of four\nbyte blocks. The blocks are encrypted with an eXclusive OR cipher (XOR). The XOR key is hardcoded in\nthe binary. The first block contains the payload size. Therefore, this block must be decrypted first.\nAfterwards, the following blocks can be sequentially decrypted.\n\n\n-----\n\nA major difference between the payload decryption and string decryption as described by Cafe Babe is that\nthe payload decryption algorithm utilizes Intel's Streaming SIMD Extensions (SSE) to decrypt the blocks.\nBy doing so, Emotet can decrypt four blocks at a time, i.e. 128 bits or 16 bytes. First, it loads the key into\nthe XMM register 'xmm1'. The key repeats the same DWORD four times.\n\nNext, it repeatedly utilizes the instruction 'pxor' to decrypt four blocks at a time until there are less than four\nblocks left.\n\nEmotet can decrypt four blocks at a time.\n\nIt decrypts these remainder blocks with a sequential xor. Whether the usage of SSE is done due to\nemulation evasion or due to optimization considerations is unclear. However, I tend to believe that this\nshould yield performance improvement.\n\nThe following algorithm implements the payload decryption as pseudo code. Note that I do not need to\nimplement it using SSE because decrypting the blocks sequentially or in parallel is semantically equivalent.\n\nThat's how the payload decryption is implemented as pseudo code.\n\nSome wrapper modules like the WebBrowserPassView wrapper contain only one payload. But there are\nsome wrapper modules that contain two payloads: a 32 bit and 64 bit payload. Depending on the target\nsystem's architecture the corresponding payload gets decrypted. An example for such a wrapper module is\nthe Outlook mail harvester wrapper\n**(ebb9f0920f08ffd6d7a05da35ecf57a13d15fe9c79f1b39d48a53099794f4274). The first payload is the 32 bit**\nversion of the Outlook mail harvester\n**(404652e82de15d9c6436d49cd9a2b46bc8b3a66f0a6530574e50ae165a5619e1) and the second payload**\nis the 64 bit version of the Outlook mail harvester\n**(b074d13f218633803e419f4e72d134a129b15d5c21a9474d2f5665a3be194c9c).**\n\n## Conclusion\n\nIn this first blog post, I have discussed the heart of Emotet: its modular structure and its modules. I have\ngiven an overview of the eight modules that are currently distributed. These modules fall into three\ncategories: spreading (spammer, password bruteforcer, network spreader), data exfiltration (outlook contact\nharvester, outlook mail harvester, wrapper WebBrowserPassView, wrapper MailPassView), and botnet\nresilience (C2 traffic proxy).\n\nThe modules are implemented as PE DLLs and they are executed first in a new thread within the same\nprocess space as the Emotet loader. Some modules are just wrapper around another payload like Nirsoft's\nMailPassView. These wrappers may inject their payload into another process in order to execute them.\nEmotet's modules live only in memory and they are not persisted on a target system. Consequently, this\ndelays their appearance on public platforms like VirusTotal by up to a couple of weeks.\n\nFrom a botnet author's point of view, this modular structure makes sense: it makes its analysis harder, the\nbotnet more flexible and testable, and in the end, it also increases its efficiency. In our next blog post, I will\ninvestigate the rehashing of modules and the evolution of Emotet's modules within the last couple of\nmonths.\n\n© Deutsche Telekom AG\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-02-03 - Dissecting Emotet – Part 1.pdf"
    ],
    "report_names": [
        "2020-02-03 - Dissecting Emotet – Part 1.pdf"
    ],
    "threat_actors": [
        {
            "id": "81dde5cc-c29f-430d-8c6e-e5e92d5015e7",
            "created_at": "2022-10-25T16:07:23.704358Z",
            "updated_at": "2025-03-27T02:02:09.932453Z",
            "deleted_at": null,
            "main_name": "Harvester",
            "aliases": [],
            "source_name": "ETDA:Harvester",
            "tools": [
                "Agentemis",
                "Cobalt Strike",
                "CobaltStrike",
                "Graphon",
                "Metasploit",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535709,
    "ts_updated_at": 1743041303,
    "ts_creation_date": 1653685964,
    "ts_modification_date": 1653685964,
    "files": {
        "pdf": "https://archive.orkl.eu/4108bf34304a9503a5e87e0b81f2abd584f6ed7d.pdf",
        "text": "https://archive.orkl.eu/4108bf34304a9503a5e87e0b81f2abd584f6ed7d.txt",
        "img": "https://archive.orkl.eu/4108bf34304a9503a5e87e0b81f2abd584f6ed7d.jpg"
    }
}