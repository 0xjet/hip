{
    "id": "de5a5ee1-141e-4d2a-ab74-a96c1168cebc",
    "created_at": "2022-10-25T16:48:22.069027Z",
    "updated_at": "2025-03-27T02:05:29.424262Z",
    "deleted_at": null,
    "sha1_hash": "c6ac7b0a3ee46801869cb818527c42054be86652",
    "title": "A detailed analysis of Lazarus APT malware disguised as Notepad++ Shell Extension",
    "authors": "Cyber Geeks",
    "file_creation_date": "2022-02-04T13:22:11Z",
    "file_modification_date": "2022-02-04T13:22:11Z",
    "file_size": 3765993,
    "plain_text": "# A detailed analysis of Lazarus APT malware disguised as Notepad++ Shell Extension\n\n**[cybergeeks.tech/a-detailed-analysis-of-lazarus-malware-disguised-as-notepad-shell-extension](https://cybergeeks.tech/a-detailed-analysis-of-lazarus-malware-disguised-as-notepad-shell-extension/)**\n\nSummary\n\nLazarus has targeted its victims using job opportunities documents for companies such as LockHeed Martin, BAE Systems, and Boeing. In this\ncase, the threat actor has targeted people that are looking for jobs at Boeing using a document called Boeing BDS MSE.docx\n[(https://twitter.com/ShadowChasing1/status/1455489336850325519). The malware extracts the hostname, username, network information, a](https://twitter.com/ShadowChasing1/status/1455489336850325519)\nlist of processes, and other information that will be exfiltrated to one out of the four C2 servers. The data targeted for exfiltration is\ncompressed, XOR-encrypted and then Base64-encoded before being transmitted to the C2 server. The Trojan implements four actions that\ninclude downloading and executing a .exe or .dll file, loading a PE (Portable Executable) into the process memory, and executing shellcode.\n\nTechnical analysis\n\nSHA256: 803dda6c8dc426f1005acdf765d9ef897dd502cd8a80632eef4738d1d7947269\n\nThe file is a DLL that has 7 exports. Only one of these functions implements malicious activity (DllGetFirstChild):\n\nFigure 1\n\nThe malware retrieves the User Agent by calling the ObtainUserAgentString function. There is also a User Agent that is hardcoded in the binary\n“Mozilla / 5.0 (Windows NT 10.0; WOW64; Trident / 7.0; rv:11.0) li”, which is Internet Explorer on Windows 10:\n\nFigure 2\n\nThe binary extracts the current system date and time using the GetSystemTimeAsFileTime API:\n\nFigure 3\n\nGetModuleHandleW is utilized to retrieve a module handle for ntdll.dll:\n\nFigure 4\n\nThe process gets the address of the following export functions using the GetProcAddress routine: “RtlGetCompressionWorkSpaceSize”,\n“RtlCompressBuffer”, “RtlDecompressBuffer”, “RtlGetVersion”. An example of a function call is shown in figure 5:\n\n\n-----\n\nFigure 5\n\nThe NetBIOS name of the local computer is extracted via a function call to GetComputerNameW:\n\nFigure 6\n\nThe GetAdaptersInfo API is used to retrieve adapter information for the local machine:\n\nFigure 7\n\nThe MAC address extracted above is written to a buffer:\n\nFigure 8\n\nThe file extracts the command-line string for the current process:\n\nFigure 9\n\nCommandLineToArgvW is utilized to extract an array of pointers to the command-line arguments, along with a count of arguments (similar to\nargv and argc):\n\nFigure 10\n\nAccording to an article published at https[:]//zhuanlan.zhihu.com/p/453894016, the malware is supposed to run with the following\nparameters:\n\n“NTPR\nP6k+pR6iIKwJpU6oR6ZilgKPL7IxsitJAnpIYSx2KldSSRFFyUIzTBVFAwgzBkI2PS/+EgASBik/GgYBwBbRNy7pP+Xq4uTsxOXU6NPmudaEz7Xy5\n\nThe binary decrypts the above parameter using a custom algorithm displayed in figure 11. The list of resulting strings contains multiple C2\nservers:\n\n\n-----\n\nFigure 11\n\n\nFigure 12\n\nThe following URLs have been decrypted:\n\nhttps[:]//mante.li/images/draw.php\n\nhttps[:]//bmanal.com/images/draw.php\n\nhttps[:]//shopandtravelusa.com/vendor/monolog/monolog/src/Monolog/monolog.php\n\nhttps[:]//industryinfostructure.com/templates/worldgroup/view.php\n\nThe GetNetworkParams routine is used to retrieve network parameters for the local computer:\n\nFigure 13\n\nThe malicious process extracts the name of the DNS domain assigned to the local host (0x2 = ComputerNameDnsDomain):\n\nFigure 14\n\nThe following network information is written to a temporary buffer:\n\n\n-----\n\nFigure 15\n\nFigure 16\n\nThe process gets the username associated with the current thread by calling the GetUserNameW function:\n\nFigure 17\n\n\n-----\n\ne b a y ta es a s aps ot o a p ocesses t e syste us g t e C eate oo e p3 S aps ot (0 **3 CS_SN** **OC SS):**\n\nFigure 18\n\nThe file extracts information about the first process from the snapshot via a call to Process32FirstW:\n\nFigure 19\n\nThe malicious binary opens the process object using the OpenProcess routine (0x410 = PROCESS_QUERY_INFORMATION |\n**PROCESS_VM_READ):**\n\nFigure 20\n\nWhether the file doesn’t have enough rights to open a process, it copies “Unknown” along with the process name to a temporary buffer.\n\nThe binary takes a snapshot of the current process along with all its modules using the CreateToolhelp32Snapshot API (0x8 =\n**TH32CS_SNAPMODULE):**\n\nFigure 21\n\nModule32FirstW is utilized to retrieve information about the first module associated with the current process:\n\nFigure 22\n\nThe malicious DLL gets information about the next process recorded in the snapshot:\n\nFigure 23\n\nThe OpenProcessToken routine is used to open the access token associated with a process (0x8 = TOKEN_QUERY):\n\n\n-----\n\nFigure 24\n\nGetTokenInformation is utilized to extract the user account of the token (0x1 = TokenUser):\n\nFigure 25\n\nThe process retrieves the name of the account for a SID and the name of the first domain on which the SID is found via a function call to\nLookupAccountSidW:\n\nFigure 26\n\nGetTokenInformation is utilized to extract the Terminal Services session identifier associated with the token (0xC = TokenSessionId):\n\nFigure 27\n\nThe RtlGetCompressionWorkSpaceSize API is used to determine the correct size of the WorkSpace buffer for the RtlCompressBuffer function\n(0x102 = COMPRESSION_FORMAT_LZNT1 | COMPRESSION_ENGINE_MAXIMUM):\n\nFigure 28\n\nThe process compresses the buffers from figures 15 and 16 using the RtlCompressBuffer function (0x102 =\n**COMPRESSION_FORMAT_LZNT1 | COMPRESSION_ENGINE_MAXIMUM):**\n\n\n-----\n\nFigure 29\n\nThe DLL randomly chooses a C2 server from the list of four. It initializes the application’s use of the WinINet functions via a call to\nInternetOpenW:\n\nFigure 30\n\nInternetCanonicalizeUrlW is used to canonicalize the URL:\n\nFigure 31\n\nThe malware cracks the URL into its component parts by calling the InternetCrackUrlW API:\n\nFigure 32\n\nThe connect, send and receive timeouts are set to 150s using the InternetSetOptionW routine (0x2 =\n**INTERNET_OPTION_CONNECT_TIMEOUT, 0x5 = INTERNET_OPTION_SEND_TIMEOUT, 0x6 =**\n**INTERNET_OPTION_RECEIVE_TIMEOUT):**\n\nFigure 33\n\n\n-----\n\nFigure 34\n\nFigure 35\n\nThe DLL opens an HTTP session to the C2 server on port 443 (0x3 = INTERNET_SERVICE_HTTP):\n\nFigure 36\n\nThe binary creates a POST request handle to the URI extracted from the specified URL:\n\nFigure 37\n\nThe security flags for the handle are set using the InternetSetOptionW API (0x1F = INTERNET_OPTION_SECURITY_FLAGS, 0xF180 =\n**SECURITY_FLAG_IGNORE_REVOCATION | SECURITY_FLAG_IGNORE_UNKNOWN_CA |**\n**SECURITY_FLAG_IGNORE_CERT_CN_INVALID | SECURITY_FLAG_IGNORE_CERT_DATE_INVALID |**\n**SECURITY_FLAG_IGNORE_REDIRECT_TO_HTTP | SECURITY_FLAG_IGNORE_REDIRECT_TO_HTTPS):**\n\nFigure 38\n\nThe buffer (concatenation of two buffers) that was compressed earlier is encrypted using XOR (key = 32-byte array):\n\n\n-----\n\nThe encrypted buffer from above is encoded using Base64:\n\n\nFigure 39\n\nFigure 40\n\nFigure 41\n\n\n-----\n\nFigure 42\n\nThe binary constructs the following parameters “search=YOIPOUP&ei=6128&oq=<Base64-encoded buffer>”:\n\nFigure 43\n\nThe User Agent extracted earlier is added to the HTTP request handle using the HttpAddRequestHeadersW routine (0xA0000000 =\n**HTTP_ADDREQ_FLAG_REPLACE | HTTP_ADDREQ_FLAG_ADD):**\n\nFigure 44\n\nHttpSendRequestW is used to exfiltrate data to the C2 server:\n\nFigure 45\n\nIt’s worth mentioning that all C2 servers were down during our analysis. We’ve emulated network connections using FakeNet.\n\nThe size of the C2 response is retrieved by calling the HttpQueryInfoW routine (0x5 = HTTP_QUERY_CONTENT_LENGTH):\n\nFigure 46\n\nThe binary copies the C2 response to a buffer via a function call to InternetReadFile:\n\n\n-----\n\nFigure 47\n\nThe malicious process parses the data between the “<html></html>” and “<div></div>” tags:\n\nFigure 48\n\nThe malware performs a similar POST request with different parameter values “search=DOWPANY&ei=6128”:\n\nFigure 49\n\nThe C2 response is decoded using Base64, and then XOR decrypted. The malware implements 4 different actions that will be explained based\non the EAX register value:\n\nFigure 50\n\n\n-----\n\n**0** **oad a** **to t e cu** **e t p ocess** **e** **o y**\n\nGetNativeSystemInfo is utilized to retrieve information about the current system:\n\nFigure 51\n\nThe DLL performs multiple VirtualAlloc function calls that will allocate memory for the new executable (0x3000 = MEM_COMMIT |\n**MEM_RESERVE, 0x4 = PAGE_READWRITE):**\n\nFigure 52\n\nThe malware changes the memory protection depending on the segment (for example, the code segment’s memory protection is set to 0x20 =\n**PAGE_EXECUTE_READ):**\n\nFigure 53\n\nAfter a few more operations, the process passes the control flow to the new PE.\n\n**EAX = 1 – download and execute a .exe file**\n\nThe binary gets the AppData folder path by calling the SHGetFolderPathW routine (0x1c = CSIDL_LOCAL_APPDATA):\n\nFigure 54\n\nGetTickCount is used to extract the number of milliseconds that have elapsed since the system was started:\n\nFigure 55\n\nThe malware creates a file based on the above value (0x40000000 = GENERIC_WRITE, 0x1 = FILE_SHARE_READ, 0x2 =\n**CREATE_ALWAYS, 0x80 = FILE_ATTRIBUTE_NORMAL):**\n\n\n-----\n\nFigure 56\n\nThe newly created file is populated with content that is supposed to be transmitted by the C2 server:\n\nFigure 57\n\nThe malicious binary executes the file by calling the CreateProcessW API:\n\nFigure 58\n\n**EAX = 2 – download and execute a .dll file**\n\nThe execution flow is similar to the above case, and we only highlight the difference. Rundll32.exe is used to execute the DLL file (an export\nfunction can also be specified in the command line):\n\n\n-----\n\nFigure 59\n\n**EAX = 3 – copy and execute shellcode**\n\nThe process allocates memory using the VirtualAlloc routine (0x1000 = MEM_COMMIT, 0x40 = PAGE_EXECUTE_READWRITE):\n\nFigure 60\n\nThe DLL implements an anti-analysis check. It calls the isProcessorFeaturePresent API in order to determine whether _fastfail() is available. If\nthis feature is not supported, the current process is terminated by calling the GetCurrentProcess and TerminateProcess functions (0x17 =\n**PF_FASTFAIL_AVAILABLE):**\n\nFigure 61\n\nThe malware jumps to the shellcode and then frees the memory area allocated earlier:\n\n\n-----\n\nFigure 62\n\nAs we mentioned at the beginning of the analysis, the threat actor only added the export function explained above, and the others are\nlegitimate.\n\nWe’ve studied a legitimate Notepad++ shell extension (SHA256: f3e2e6f9e7aa065e89040a0c16d1f948489b3751e5eb5efac8106d5f7d65d98d\n64-bit) and compared the export functions between the 2 files. As we can see below, the functions are very similar:\n\nFigure 63\n\nFigure 64\n\nReferences\n\n\n-----\n\nS N: ttps://docs. c oso t.co [/e](https://docs.microsoft.com/en-us/windows/win32/api/) us/w dows/w 3 /ap /\n\nFakenet: [https://github.com/fireeye/flare-fakenet-ng](https://github.com/fireeye/flare-fakenet-ng)\n\nVirusTotal: [https://www.virustotal.com/gui/file/803dda6c8dc426f1005acdf765d9ef897dd502cd8a80632eef4738d1d7947269](https://www.virustotal.com/gui/file/803dda6c8dc426f1005acdf765d9ef897dd502cd8a80632eef4738d1d7947269)\n\nMalwareBazaar: [https://bazaar.abuse.ch/sample/803dda6c8dc426f1005acdf765d9ef897dd502cd8a80632eef4738d1d7947269/](https://bazaar.abuse.ch/sample/803dda6c8dc426f1005acdf765d9ef897dd502cd8a80632eef4738d1d7947269/)\n\nINDICATORS OF COMPROMISE\n\nC2 domains:\n\nmante.li\n\nbmanal.com\n\nshopandtravelusa.com\n\nindustryinfostructure.com\n\nSHA256: 803dda6c8dc426f1005acdf765d9ef897dd502cd8a80632eef4738d1d7947269\n\nURLs:\n\nhttps[:]//mante.li/images/draw.php\nhttps[:]//bmanal.com/images/draw.php\nhttps[:]//shopandtravelusa.com/vendor/monolog/monolog/src/Monolog/monolog.php\nhttps[:]//industryinfostructure.com/templates/worldgroup/view.php\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/0gxt5eqkmufgjev73f11zu3yx20yjlhk"
    ],
    "report_names": [
        "CyberGeeks_Lazarus-Malware-Notepad-Shell-Extension(01-31-2022)"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1666716502,
    "ts_updated_at": 1743041129,
    "ts_creation_date": 1643980931,
    "ts_modification_date": 1643980931,
    "files": {
        "pdf": "https://archive.orkl.eu/c6ac7b0a3ee46801869cb818527c42054be86652.pdf",
        "text": "https://archive.orkl.eu/c6ac7b0a3ee46801869cb818527c42054be86652.txt",
        "img": "https://archive.orkl.eu/c6ac7b0a3ee46801869cb818527c42054be86652.jpg"
    }
}