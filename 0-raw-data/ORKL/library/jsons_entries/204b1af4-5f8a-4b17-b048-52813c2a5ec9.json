{
    "id": "204b1af4-5f8a-4b17-b048-52813c2a5ec9",
    "created_at": "2023-01-12T14:59:47.195295Z",
    "updated_at": "2025-03-27T02:05:41.672963Z",
    "deleted_at": null,
    "sha1_hash": "ce07f28ea682c1e6b1a5fae65b5d4897931b0491",
    "title": "2021-12-16 - Inside the LockBit Arsenal - The StealBit Exfiltration Tool",
    "authors": "",
    "file_creation_date": "2022-05-28T16:05:31Z",
    "file_modification_date": "2022-05-28T16:05:31Z",
    "file_size": 3574956,
    "plain_text": "# THREAT ANALYSIS REPORT: Inside the LockBit Arsenal - The StealBit Exfiltration Tool\n\n**[cybereason.com/blog/threat-analysis-report-inside-the-lockbit-arsenal-the-stealbit-exfiltration-tool](https://www.cybereason.com/blog/threat-analysis-report-inside-the-lockbit-arsenal-the-stealbit-exfiltration-tool)**\n\nWritten By\nCybereason Global SOC Team\n\nDecember 16, 2021 | 20 minute read\n\n\n-----\n\nThe Cybereason Global Security Operations Center (GSOC) issues Cybereason Threat\nAnalysis reports to inform on impacting threats. The Threat Analysis reports investigate these\nthreats and provide practical recommendations for protecting against them.\n\nIn this Threat Analysis report, the GSOC investigates the StealBit malware, a data exfiltration\ntool that the LockBit threat group develops and maintains. The LockBit group provides\nStealBit to affiliates as part of the group’s ransomware affiliate program. Ransomware\noperators use StealBit to exfiltrate data from compromised systems for double extortion\npurposes.\n\nThis report provides an in-depth insight into the functionalities and architecture of StealBit as\nwell as the evolution of relevant configuration and implementation aspects of StealBit across\ndifferent samples. The detailed insight into how StealBit works and evolves is important for the\ntimely detection of ransomware attack operations that involve StealBit at the point when\nmalicious actors exfiltrate data before deploying ransomware.\n\n## StealBit Malware Key Points\n\n**Feature updates and widened target base: A comparative analysis between relatively older**\nand newer StealBit samples shows that StealBit has been undergoing improvement with new\nfeatures, especially evasion and hiding features. In addition, although older samples do not\nexecute on systems located in the former Soviet countries Russia, Ukraine, Belarus,\nTajikistan, Armenia, Azerbaijan, Georgia, Kazakhstan, Kyrgyzstan, Turkmenistan, Uzbekistan,\nand Moldova, newer StealBit samples do not implement this restriction and execute on any\nsystem.\n\n**Developed for maximum data exfiltration efficiency: StealBit implements the Microsoft**\ninput/output (I/O) completion port threading model to maximize the overall efficiency of data\nexfiltration activities. For example, StealBit parallelizes the exfiltration of the content of\nmultiple files to shorten the overall exfiltration timespan. This is important to ransomware\noperators, since fast data exfiltration reduces the chances of being discovered in the process.\n\n**Developed for maximum usage convenience and scalability: StealBit implements**\ninterprocess communication (IPC) between multiple StealBit processes that run on a single\ncompromised system to designate many files for exfiltration in a scalable manner. In addition,\nStealBit supports dragging and dropping of files or folders for exfiltration to StealBit windows\nin scenarios where the StealBit operators have access to the graphical user interface of\ncompromised systems. This feature enables StealBit operators to designate many files for\nexfiltration in a convenient and scalable manner.\n\n**Somewhat incomplete implementation: The implementation of some StealBit features that**\nwe analyzed is not complete. This includes features that the LockBit threat group advertises\nas advantageous to alternative exfiltration tools on the underground market, such as\ncompression of exfiltrated data and a hidden mode of operation. For example, a recent\n\n\n-----\n\nStealBit sample that we analyzed does not compress exfiltrated data and does not properly\nhide the windows that StealBit creates, making the malware visible in the graphical user\ninterface of the compromised system.\n\n**StealBit Malware Detected and prevented:** [The Cybereason XDR Platform effectively](https://www.cybereason.com/platform)\ndetects and prevents StealBit when the malware exfiltrates data, and also detects and\n[prevents the execution of the related LockBit ransomware, which LockBit affiliates may](https://www.cybereason.com/blog/cybereason-vs.-lockbit2.0-ransomware)\nexecute after they use StealBit to exfiltrate data for double extortion.\n\n**Cybereason Managed Detection and Response (MDR): The Cybereason GSOC has zero**\ntolerance towards attacks that involve ransomware and data exfiltration tools, such as\nStealBit, and categorizes such attacks as critical, high-severity incidents. The Cybereason\nGSOC MDR Team issues a comprehensive report to customers when such an incident\noccurs. The report provides an in-depth overview of the incident, which helps to scope the\nextent of compromise and the impact on the customer’s environment. In addition, the report\nprovides attribution information when possible as well as recommendations for mitigating and\nisolating the threat.\n\n## StealBit Malware Introduction\n\nThe traditional ransomware extortion tactic, where malicious actors demand payment for\ndecrypting data that the actors have encrypted using ransomware, does not always work as\nintended. Victims may not pay ransom for several reasons, such as lack of financial\nresources, concerns that ransomware operators may not decrypt the data, or the availability of\nbackups of the encrypted data.\n\nTherefore, many modern ransomware operators use a double extortion tactic: ransomware\noperators exfiltrate data from compromised systems before encrypting the data, and if the\nvictim refuses to pay ransom for data decryption, the malicious actors threaten to leak the\nexfiltrated data online or sell the data for profit.\n\nThe proliferation of double extortion on the ransomware scene marks a major turning point in\nthe evolution of the ransomware threat, with ransomware actors massively joining in on the\n[trend. For example, in June 2021, TrendMicro reported that it has observed 35 ransomware](https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/ransomware-double-extortion-and-beyond-revil-clop-and-conti)\nfamilies that use double extortion — with a growing tendency.\n\nSince the double extortion tactic relies on exfiltrated data, data exfiltration tools are crucial to\nransomware operators that use this tactic. Ransomware operators use publicly available tools\nfor data exfiltration, such as [Rclone, as well as custom data exfiltration tools that are intended](https://rclone.org/)\nspecifically for use in ransomware operations. Some custom data exfiltration tools are Ryuk\n[Stealer, the recently discovered Exmatter, and StealBit.](https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/blackmatter-data-exfiltration)\n\nThe StealBit malware is a data (file content) exfiltration tool that the LockBit threat group\ndevelops and maintains. StealBit exfiltrates file content to remote attacker-controlled\nendpoints for double extortion purposes. In addition to StealBit, the LockBit threat group\n\n\n-----\n\n[develops and maintains the LockBit ransomware, which has a strong presence on the](https://www.cybereason.com/blog/cybereason-vs.-lockbit2.0-ransomware)\nransomware threat scene.\n\n[As of June 2021, the LockBit group runs a ransomware affiliate program, LockBit 2.0, which](https://securityintelligence.com/posts/lockbit-ransomware-attacks-surge-affiliate-recruitment/)\nprovides access to the LockBit ransomware and the StealBit data exfiltration tool to affiliates.\nAs part of affiliate recruitment efforts, the LockBit group advertises the features of the LockBit\nransomware and StealBit by comparing the ransomware and StealBit to alternative solutions.\nThe LockBit group claims that StealBit is superior, especially in terms of data exfiltration\nspeed:\n\n_[The LockBit group advertises StealBit (source: KELA, Twitter)](https://twitter.com/intel_by_kela/status/1406905385580118017)_\n\nThis report discusses the implementation of StealBit and its internal working principles. In\naddition, this report provides an overview of the evolution of relevant configuration and\n[implementation aspects of StealBit across different StealBit samples. Previous research](https://yoroi.company/research/hunting-the-lockbit-gangs-exfiltration-infrastructures/)\ndocuments some aspects of the implementation of StealBit, with a focus on automating the\nde-obfuscation of relevant StealBit configuration: the IP addresses of the attacker-controlled\nendpoints to which StealBit exfiltrates file content.\n\nThis report provides an in-depth and comprehensive insight into the functionalities,\narchitecture, and evolution of StealBit. The detailed insight into how StealBit works and\nevolves is important to build proper detection and protection strategies against the malware.\nThis, in turn, is crucial for the timely detection of ransomware operations that involve StealBit\nat the point when malicious actors exfiltrate data before deploying ransomware.\n\n## StealBit Malware Analysis\n\n\n-----\n\nThe Deep Dive Analysis section discusses the implementation of StealBit and its internal\nworking principles. In this section, we focus on a recent StealBit sample with a Secure Hash\nAlgorithm (SHA)-256 hash of\n_6c9a92955402c76ab380aa6927ad96515982a47c05d54f21d67603814d29e4a5. The_\nComparative Analysis section compares different StealBit samples to provide an overview of\nthe evolution of relevant configuration and implementation aspects of StealBit across the\nsamples.\n\n### StealBit Malware Deep Dive Analysis\n\nStealBit first checks whether the StealBit process runs in the context of a debugger by\nevaluating the value of the NtGlobalFlag field of the Process Environment Block (PEB). If the\nvalue of NtGlobalFlag is 0x70, StealBit executes an empty infinite loop:\n\n_StealBit detects the presence of a debugger_\n\nStealBit then de-obfuscates the filenames of the dynamic-link libraries (DLLs) advapi32,\n_gdi32, gdiplus, shell32, ntdll, ole32,_ _user32, shlwapi, kernel32, and ws2_32 and loads the_\n[libraries by executing the LoadLibraryExA function. StealBit stores the XOR obfuscated](https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibraryexa)\nfilenames of these DLLs in the malware’s executable file:\n\n\n-----\n\n_StealBit loads DLLs_\n\nStealBit then decrypts RC4-encrypted strings that the malware stores in the malware’s\nexecutable file. StealBit uses these strings for different purposes throughout the malware’s\noperation. For example, one string specifies a Windows command that StealBit executes,\nanother string specifies the path to a named pipe file that StealBit creates, and StealBit\ndisplays some of the strings to the malware operator. We discuss these aspects of the\nStealBit operation in greater detail later in this section:\n\n\n-----\n\n_StealBit decrypts RC4-encrypted strings_\n\nStealBit then configures the process to not display certain Windows error messages by\ninvoking the NtSetInformationProcess function and parses the command line parameters that\nthe StealBit operator may have specified. The table below lists the command line parameters\nthat StealBit supports. We discuss the exact impact of these command line parameters on the\nexecution of StealBit in greater detail later in this section:\n\n\n-----\n\n**Command line parameter** **Description** **Required**\n**/**\n**optional**\n\n\n**Default**\n**value**\n\n\n_<path to file or folder>_ This parameter specifies the\nfilesystem path to the file or the\nfolder whose content StealBit is to\nexfiltrate. Setting this parameter\nconfigures StealBit to read and\nexfiltrate the content of the file, or\nthe content of the files placed in\nthe folder.\n\n_-hide/-h yes/y | no/n_ This parameter controls the\nvisibility of the graphical user\ninterface of StealBit—that is, this\nparameter hides (yes/y) or\ndisplays (no/n) windows that\nStealBit creates.\n\n_-delete/-d yes/y | no/n_ This parameter configures StealBit\nto self-delete (yes/y)—that is, to\ndelete the executable file that\nimplements StealBit from the\nfilesystem of the compromised\nsystem when StealBit is finished\nexecuting—or not to self-delete\n(no/n).\n\n\n_-net/-n <transfer rate>_\n\n_-once/-o <transfer rate>_\n\n\nThis parameter configures StealBit\nto exfiltrate file content at the\nspecified rate, where rate is an\namount of exfiltrated file content in\nKBs, MBs, or GBs, over 15\nseconds.\n\n\nRequired none\n\nOptional _no/n:_\nStealBit\ndisplays\nwindows\n\nOptional _no/n:_\nStealBit\ndoes not\nself-delete\n\nOptional _unlim:_\nthere is no\nfile\ncontent\nexfiltration\nrate\n\n\n-----\n\n_-skipfiles yes/y | no/n_ This parameter configures StealBit\nto not exfiltrate the content of files\nwith specific filename extensions\n(no/n).\n\n_-skipfolders yes/y | no/n_ This parameter configures StealBit\nto not exfiltrate the content of files\nthat are placed in specific folders\n(no/n).\n\n_-file/-f <file size>_ This parameter configures StealBit\nto exfiltrate the content of only\nthose files of a size equal to, or\nless than the specified file size in\nKBs, MBs, or GBs.\n\n**Examples**\n\n_stealbit.exe_\n_C:\\Users\\user\\Desktop\\file.db_\n_-hide y -skipfiles n_\n\n_stealbit.exe_\n_C:\\Users\\user\\Desktop\\ -net_\n_5MB -delete y -h y -_\n_skipfolders n -file 2GB_\n\n_The command line parameters that StealBit supports_\n\n\nOptional _yes/y:_\nStealBit\ndoes not\nconsider\nthe\nfilename\nextensions\nof files as\na criterion\nfor file\ncontent\nexfiltration\n\nOptional _yes/y:_\nStealBit\ndoes not\nconsider\nfolders as\na criterion\nfor file\ncontent\nexfiltration\n\nOptional _unlim:_\nthere is no\nmaximum\nfile size for\nfile\ncontent\nexfiltration\n\n\nAfter parsing command line parameters, StealBit creates or opens the named pipe file \\??\n_\\pipe\\STEALBIT-MASTER-PIPE. The path to the named pipe file is one of the strings that_\nStealBit has previously decrypted using the RC4 algorithm.\n\n\n-----\n\nIf the current StealBit instance is the first one that the malware s operator has executed on the\ncompromised system, StealBit creates the named pipe file STEALBIT-MASTER-PIPE by\ninvoking the NtCreateNamedPipeFile function and assumes the role of a named pipe server.\n\nWe refer to this StealBit instance as a StealBit named pipe server. If not, StealBit opens the\nnamed pipe file STEALBIT-MASTER-PIPE by invoking the NtCreateFile function and assumes\nthe role of a named pipe client. We refer to this StealBit instance as a StealBit named pipe\nclient.\n\nIn summary, StealBit implements named pipe-based IPC between multiple StealBit processes\nthat run on a single compromised system. We show later in this section that this enables\nStealBit operators to designate many files for exfiltration in a scalable manner by executing\nStealBit named pipe clients with the <path to file or folder> command line parameter set to the\npaths to the files. This makes the overall process for exfiltrating the content of multiple files\nconvenient and efficient for StealBit operators:\n\n_StealBit creates or opens the named pipe file STEALBIT-MASTER-PIPE_\n\n\n-----\n\nAt this point in the execution flow of StealBit, the execution of a StealBit instance that\nassumes the role of a named pipe server diverges from the execution of a StealBit instance\nthat assumes the role of a named pipe client. The StealBit Named Pipe Server section\ndiscusses the former and the StealBit Named Pipe Client section discusses the latter.\n\n**StealBit Named Pipe Server**\n\nAfter creating the named pipe file STEALBIT-MASTER-PIPE, the StealBit named pipe server\ncreates and starts two threads: one that creates two windows, and one that shows a message\nabout exfiltration progress.\n\n[The first thread creates two windows by invoking the CreateWindowExW function. The first](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-createwindowexw)\n[window is a top-level, parent window, with a title of StealBit 1.1. The second window is a child](https://docs.microsoft.com/en-us/windows/win32/winmsg/window-features)\nwindow of the top-level window and is therefore confined to the area of the parent window.\nThe child window can display formatted text, and this window displays the output of StealBit to\nthe malware operator.\n\nWe emphasize that setting the -hide/-h command line parameter to yes/y hides only the child\nwindow, while the parent window is still visible. This indicates that the implementation of the\nwindow hiding feature of StealBit—that is, of the -hide/-h command line parameter—is not\ncomplete, because it does not make StealBit invisible in the Windows graphical user interface\nby hiding all windows that StealBit creates. This contradicts the claim of the LockBit group that\nStealBit hides its presence on compromised systems:\n\n_[LockBit claims that StealBit hides its presence on compromised systems (source: KELA,](https://twitter.com/intel_by_kela/status/1406905385580118017)_\n_Twitter)_\n\n\n-----\n\n_StealBit displays windows when the malware operator sets the command line parameter -_\n_hide/-h to no/n (upper image) and yes/y (lower image)_\n\nThe parent StealBit window supports dragging and dropping files or folders and the F2 and\n_Shift+F2 hotkeys. Pressing the F2 key closes the parent and child window without terminating_\nexecution, which effectively makes StealBit invisible in the Windows graphical user interface.\n\nPressing the key combination Shift+F2 has no effect. Dragging and dropping a file or folder\ninto the parent StealBit window is equivalent to specifying the <path to file or folder>\ncommand line parameter. The drag and drop activity causes StealBit to read and exfiltrate the\ncontent of the dropped file, or the content of the files placed in the dropped folder, in a way\nthat we discuss later in this section.\n\nThe drag and drop feature enables malicious actors to conveniently provide many file or folder\npaths to StealBit for file content exfiltration in scenarios where the StealBit operators have\naccess to the graphical user interface of compromised systems, such as through an Remote\n\n\n-----\n\nDesktop Protocol (RDP) session. This makes the overall process for exfiltrating the content of\nmany files practically convenient and scalable for StealBit operators.\n\nThe second thread is active during the overall operation of StealBit and displays a message in\nthe StealBit window that informs the operator about the progress of file content exfiltration\nwhen exfiltration takes place. In the form of a format string, the message is: Stats: %I64d files\n_(size %S), read speed %S/sec (compression ratio %I64d%%), upload %S/sec. This format_\nstring is one of the strings that StealBit has previously decrypted using the RC4 algorithm.\n\nAfter creating and starting the two threads, StealBit displays the values of the configuration\nsettings that StealBit operators can configure by setting the values of the StealBit command\nline parameters. In addition, StealBit displays the computer name of the compromised system\nand the name of the domain to which the system belongs (if any; see the figure above).\n\nStealBit then initializes the Windows Socket networking library, which StealBit uses for\ncommunication with the attacker-controlled endpoints to which StealBit may exfiltrate file\ncontent. StealBit de-obfuscates five IP addresses of these endpoints, which the malware\nstores in XOR obfuscated form in the StealBit executable file. StealBit also stores a string that\nuniquely identifies the set of the endpoint IP addresses across StealBit samples, such as\n_DI0AN. We refer to this string as the StealBit configuration ID:_\n\n\n-----\n\n_StealBit de-obfuscates IP addresses of attacker-controlled endpoints to which StealBit may_\n_exfiltrate file content_\n\n**StealBit Malware Threading: I/O Completion Port**\n\nAfter initializing the Windows Socket library, StealBit establishes its core functionality: the\nMicrosoft I/O completion port threading model for processing multiple asynchronous I/O\nrequests in parallel. StealBit implements the I/O completion port threading model to maximize\nthe overall efficiency of file content exfiltration activities on compromised systems. For\nexample, as we show later in this section, StealBit parallelizes the exfiltration of the content of\nmultiple files to shorten the overall exfiltration timespan. This is important to ransomware\noperators, since fast data exfiltration reduces the chances of being discovered in the process.\n\nThe [I/O completion port threading model works by creating an I/O completion port and](https://docs.microsoft.com/en-us/windows/win32/fileio/i-o-completion-ports)\nassociating one or more file handles with that port. When an asynchronous I/O operation on\none of these file handles completes, the Windows operating system queues to the port an I/O\ncompletion packet:\n\nI/O completion packets carry information about the I/O operation. The application can then\nprocess I/O completion packets by removing them from the queue in a first-in-first-out (FIFO)\norder. In addition to a file handle, an application may associate a handle-specific I/O\n\n\n-----\n\ncompletion key with an I/O completion port. I/O completion keys can carry arbitrary data,\nwhich is typically data related to the handle. The figure below depicts the I/O completion port\nthreading model that StealBit implements:\n\n_StealBit implements the I/O completion port threading model_\n\nStealBit creates an I/O completion port by invoking the ZwCreateIoCompletion function.\nStealBit also creates threads for processing I/O completion packets that Windows queues to\nthe port, which we refer to as StealBit worker threads. StealBit creates as many worker\nthreads as processors are available on the compromised system. StealBit then associates\nthree file handles (and I/O completion keys) with the I/O completion port by invoking the\n_ZwSetInformationFile function:_\n\n\n-----\n\nA handle to the socket to an attacker-controlled endpoint to which StealBit\nexfiltrates file content: This assigns available worker threads to handle the\ncommunication with the attacker-controlled endpoint. StealBit attempts to connect\nto each of the five IP addresses that the malware has de-obfuscated. If StealBit\ncannot establish a connection to any of these IP addresses, the malware\nindefinitely attempts to establish a connection. If the connection to one of these IP\naddresses succeeds, StealBit opens a socket to the attacker-controlled endpoint\nand associates the socket handle and an I/O completion key with the I/O\ncompletion port. In addition, to make static analysis difficult, StealBit obtains an\n[address to the TransmitPackets function at runtime by invoking the WSAIoctl](https://docs.microsoft.com/en-us/windows/win32/api/mswsock/nc-mswsock-lpfn_transmitpackets)\nfunction. The TransmitPackets function is crucial to StealBit, since the malware\nuses this function to exfiltrate file content. WSAIoctl returns an address to\n_TransmitPackets if an application provides the globally unique identifier (GUID) of_\nthe TransmitPacket function, {0D689DA0-1F90-11D3-9971-00C04F68C876}, as a\nparameter to WSAIoctl:\n\n_StealBit obtains an address to the TransmitPackets function at runtime_\n\n\n-----\n\nA handle to the named pipe STEALBIT-MASTER-PIPE: This assigns available\nworker threads to handle the communication with StealBit named pipe clients. The\nsection StealBit Named Pipe Client discusses the activities that the worker threads\nconduct when StealBit named pipe clients send data to the StealBit named pipe\nserver.\nA handle to a file whose content StealBit is to exfiltrate: This assigns available\nworker threads to handle file content exfiltration upon successful file read\noperations on the file. This parallelizes file content exfiltration and shortens the\noverall timespan of file content exfiltration activities. In addition to exfiltrating read\nfile content, it is the StealBit named pipe server, and not the StealBit named pipe\nclient, that reads file content for exfiltration purposes.\n\n**StealBit Malware File Content Exfiltration**\n\nThe StealBit named pipe server reads and exfiltrates the content of the file or the folder,\nwhose file system path is either provided by a StealBit named pipe client or specified as the\nvalue of the <path to file or folder> command line parameter by the StealBit operator. Section\nStealBit Named Pipe Client discusses the communication between the StealBit named pipe\nserver and client in more detail.\n\nIf the StealBit operator has specified a file path as the value of the <path to file or folder>\ncommand line parameter, the StealBit named pipe server first evaluates whether the path\nleads to a file or a folder. If the path leads to a file, StealBit reads the content of the file only if\nthe file meets one or more of these requirements:\n\nThe length of the name of the file is less than, or equal to, four characters.\nThe filename extension of the file is not present in a list of filename extensions,\nwhich StealBit stores in hashed format in the malware’s executable file. StealBit\nenforces this criterion only if the StealBit operator has set the -skipfiles command\nline parameter to no/n.\n\nIn addition, the size of the file has to be less than or equal to 0.53 GB. The command line\nparameter -file/-f does not have an impact on the execution of the StealBit sample that we\nanalyzed. This indicates that the implementation of the -file/-f command line parameter is not\ncomplete.\n\nIf the path leads to a folder, StealBit iterates the folder recursively to enumerate files placed in\nthe folder and sub-folders. If the StealBit operator has set the -skipfolders command line\nparameter to no/n, StealBit enumerates files only from those folders that are not present in a\nlist of folders, which StealBit stores in hashed format in the malware’s executable file. After\nenumerating the files in a folder, StealBit reads the content of each file, except the content of\n[system files (FILE_ATTRIBUTE_SYSTEM), if the above conditions are fulfilled.](https://docs.microsoft.com/en-us/windows/win32/fileio/file-attribute-constants)\n\n\n-----\n\nBefore reading content from a file, StealBit opens the file and then associates the handle to\nthe file and an I/O completion key with the I/O completion port that StealBit has created.\n[StealBit invokes the ZwReadFile function to read the content of the file in equal-sized blocks.](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwreadfile)\nStealBit calculates the block size as a function of the total file size—the bigger the file, the\nbigger the block size.\n\nEach successful file content read operation issues an I/O completion packet to the I/O\ncompletion port. The available worker threads process this packet and exfiltrate the file\ncontent to an attacker-controlled endpoint using the TransmitPackets function, whose address\nStealBit has previously obtained.\n\nTo evade exfiltration detection mechanisms that monitor the amount of sent data to remote\nendpoints over time, StealBit operators can configure StealBit to exfiltrate file content at a\ngiven rate (amount of exfiltrated file content over 15 seconds) by configuring the -net/-n or _once/-o command line parameters. These parameters control the file content exfiltration rate_\nby controlling the rate at which StealBit reads file content.\n\nAs we mentioned earlier, the file read activity issues I/O completion packets to the StealBit I/O\ncompletion port and instructs available worker threads to exfiltrate the read content. StealBit\ncontrols the file content reading rate by delaying invocations of the ZwReadFile function for\ncontinuously adjusted time periods, such that the total amount of read file content over 15\nseconds does not exceed the exfiltration rate that the StealBit operator has specified.\n\nEvery time StealBit reads file content using the ZwReadFile function, available StealBit worker\nthreads exfiltrate the read file content by issuing the Hypertext Transfer Protocol 1.1 (HTTP\n1.1) PUT request to an attacker-controlled endpoint. StealBit stores exfiltrated file content on\nthe attacker-controlled endpoint as a resource that has a random name, which StealBit\ngenerates for each file whose content the malware exfiltrates (for example, 03E76A538… in\nthe figure below). The data that StealBit sends to the attacker-controlled endpoint includes:\n\nA Distributed Authoring and Versioning 2 (DAV2) header (DAV2... in the figure\nbelow)\nThe StealBit configuration ID (for example, DI0AN in the figure below)\nThe computer name of the compromised system and the name of the domain (if\nany) to which the system belongs (for example, NODOMAIN and DESKTOP_PUK8BTP in the figure below)_\nThe absolute path to the file whose content StealBit exfiltrates (for example,\n_C:\\Users\\<user>\\Desktop\\SB_6c9a\\testfile.txt in the figure below)_\nThe file content that StealBit exfiltrates (for example, Hello. This is a test file. in the\nfigure below).\n\nThe file content is not compressed. This contradicts the claim of the LockBit threat group that\nStealBit compresses exfiltrated file content:\n\n\n-----\n\n_[LockBit claims that StealBit compresses exfiltrated file content (source: KELA, Twitter)](https://twitter.com/intel_by_kela/status/1406905385580118017)_\n\n_StealBit exfiltrates uncompressed file content_\n\n\n-----\n\nThe StealBit sample that we analyzed does not execute indefinitely in order to keep the\nStealBit worker threads that handle I/O completion packets active in a typical server fashion.\nTo the contrary, after creating worker threads and establishing the I/O completion port\nthreading model, StealBit processes the <path to file or folder> command line parameter and\nexfiltrates file content if the StealBit operator has specified a valid parameter value.\n\nStealBit then waits until the worker threads have processed all I/O completion packets, and\nthen closes the named pipe file STEALBIT-MASTER-PIPE. Next, depending on the value of\nthe -delete/-d command line parameter, StealBit empties the content of its executable file and\n[deletes the file. StealBit conducts these activities by invoking the ShellExecuteExW function to](https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecuteexw)\nexecute these commands, where <file size> is the size of the StealBit executable file in bytes\nand <file path> is the path to the StealBit executable file:\n\n_ping 127.0.0.7 -n 7 > Nul_\n\n_fsutil file setZeroData offset=0 length=<file size> <file path>_\n\n_del /f /q <file path>_\n\nFinally, StealBit terminates its execution:\n\n_StealBit deletes its executable file_\n\n**StealBit Malware Named Pipe Client**\n\nAfter opening the named pipe file STEALBIT-MASTER-PIPE, the StealBit named pipe client\ndelegates file content reading and exfiltration to the StealBit named pipe server. To do this, the\nStealBit named pipe client communicates with the StealBit named pipe server by following a\ncommunication protocol.\n\n\n-----\n\nThe figure below depicts this protocol. When a StealBit named pipe client sends data to a\nStealBit named pipe server, this action issues an I/O completion packet to the I/O completion\nport that the StealBit named pipe server creates (see section StealBit Named Pipe Server).\nThe worker threads of the StealBit named pipe server then process this packet. The StealBit\nnamed pipe server uses the worker threads that handle the communication with StealBit\nnamed pipe clients to conduct the server's activities that are depicted in the figure below:\n\n_The StealBit named pipe client communicates with the StealBit named pipe server_\n\nAfter opening STEALBIT-MASTER-PIPE and therefore connecting to the StealBit named pipe\nserver, the StealBit named pipe client sends the four bytes 00 00 00 00 to the server to\nannounce the client's presence. The StealBit named pipe server keeps track of the state of\nthe connection. When the StealBit named pipe client announces itself, the server\nacknowledges the client's presence by updating the state of the connection to indicate\nsuccessful client connection.\n\nThe StealBit named pipe client then processes the value of the <path to file or folder>\ncommand line parameter in the same manner as the StealBit named pipe server (see section\nStealBit Named Pipe Server). However, in contrast to the StealBit named pipe server, the\n\n\n-----\n\nStealBit named pipe client does not read and exfiltrate file content, but delegates this task to\nthe server as follows:\n\nThe client sends the four bytes 01 00 00 00 to the server to indicate that the client\nis about to send a file path to the server. This file path is the path to the file whose\ncontent the server is to read and exfiltrate. The StealBit named pipe server\nacknowledges the communication by updating the state of the connection to\nindicate the incoming file path.\nThe client sends four bytes to the server such that the bytes specify the length of\nthe file path in a null-terminated Unicode string format. For example, the client\nsends the bytes 3E _00 00 00 to the server when the client is about to send the file_\npath C:\\Users\\user\\Desktop\\file.txt to the server (0x3E in hexadecimal format is 62\nin decimal format). The StealBit named pipe server updates the state of the\nconnection and allocates a virtual memory region of a size that is the same as the\nfile path length that the client has sent.\nThe client sends the file path to the server. The StealBit named pipe server\nupdates the state of the connection, stores the file path in the previously allocated\nmemory region, and then reads and exfiltrates the content of the file at the file path\n(see section StealBit Named Pipe Server).\nDelegating file content reading and exfiltration to the StealBit named pipe server\nenables malicious actors to designate many files for exfiltration in a scalable\nmanner by executing StealBit named pipe clients with the <path to file or folder>\ncommand line parameter set to the paths to the files.\n\nThe StealBit named pipe client then closes the connection to the server and, depending on\nthe value of the -delete/-d command line parameter, deletes its executable file in the same\nmanner as the StealBit named pipe server. The StealBit named pipe client then terminates its\nexecution. The command line parameters -hide/-h, -net/-n, and -once/-o do not have an\nimpact on the execution of the StealBit named pipe client.\n\n### StealBit Malware Comparative Analysis\n\nThe table below lists selected StealBit samples that represent StealBit samples that the\nsecurity community has observed at the time of writing of this report, in terms of the\nconfiguration and implementation aspects of StealBit that are in the scope of this report. For\nreferencing purposes, each sample has a codename with the prefix SB_ and a suffix that is\nthe first four hexadecimal numbers of the sample’s SHA-256 hash:\n\n**SB_3407**\n\n\n**SHA-256**\n**Hash**\n\n\n[3407f26b3d69f1dfce76782fee1256274cf92f744c65aa1ff2d3eaaaf61b0b1d](https://www.virustotal.com/gui/file/3407f26b3d69f1dfce76782fee1256274cf92f744c65aa1ff2d3eaaaf61b0b1d/details)\n\n\n-----\n\n**First**\n**submission**\n**to**\n**VirusTotal**\n\n**SB_107d**\n\n**SHA-256**\n**Hash**\n\n**First**\n**submission**\n**to**\n**VirusTotal**\n\n**SB_6c9a**\n\n**SHA-256**\n**Hash**\n\n**First**\n**submission**\n**to**\n**VirusTotal**\n\n**SB_6b9a**\n\n**SHA-256**\n**Hash**\n\n**First**\n**submission**\n**to**\n**VirusTotal**\n\n\n2021-08-06\n\n[107d9fce05ff8296d0417a5a830d180cd46aa120ced8360df3ebfd15cb550636](https://www.virustotal.com/gui/file/107d9fce05ff8296d0417a5a830d180cd46aa120ced8360df3ebfd15cb550636/detection)\n\n2021-09-09\n\n[6c9a92955402c76ab380aa6927ad96515982a47c05d54f21d67603814d29e4a5](https://www.virustotal.com/gui/file/6c9a92955402c76ab380aa6927ad96515982a47c05d54f21d67603814d29e4a5/details)\n\n2021-11-08\n\n[6b9aa479a5f9c6bfee52046c1afa579977dfcde868fdad3f18fdcd1779535068](https://www.virustotal.com/gui/file/6b9aa479a5f9c6bfee52046c1afa579977dfcde868fdad3f18fdcd1779535068)\n\n2021-11-26\n\n\n_Representative StealBit samples_\n\nThe tables below compare the selected StealBit samples (column ‘Sample’) considering the\nfollowing configuration and implementation aspects:\n\n\n-----\n\nIP addresses and geolocations of attacker-controlled endpoints to which StealBit\nexfiltrates data (column ‘IP addresses’ and ‘Location’).\nThe debugger detection method that StealBit implements as an anti-analysis\nmeasure (column ‘Debugger detection’).\nCommand line parameters and the respective malware features (column\n‘Command line parameters’).\nA named pipe IPC infrastructure that makes exfiltrating the content of multiple files\npractically convenient and efficient for StealBit operators (column ‘IPC’).\nThe I/O completion port threading model to maximize the overall efficiency of data\nexfiltration activities (column ‘I/O completion’).\n\nConditions for execution and file content exfiltration (column ‘Execution\nconditions’):\n\n**Sample** **IP addresses** **Location**\n\n\nSB_3407 88.80.147[.]102\n\n168.100.11[.]72\n\n139.60.160[.]200\n\n193.38.235[.]234\n\n174.138.62[.]35\n\nSB_107d 93.190.139[.]223\n\n168.100.11[.]72\n\n139.60.160[.]200\n\n193.38.235[.]234\n\n174.138.62[.]35\n\n\nBulgaria\n\nThe Netherlands\n\nUnited States\n\nRussia\n\nUnited States\n\nThe Netherlands\n\nThe Netherlands\n\nUnited States\n\nRussia\n\nUnited States\n\n\nSB_6c9a 185.182.193[.]120 The Netherlands\n\nSB_6b9a 185.182.193[.]120 The Netherlands\n\n_Comparison of StealBit samples: Attacker-controlled endpoints_\n\n\n-----\n\n**Sample** **Debugger detection** **Command**\n**line**\n**parameters**\n\nSB_3407 _NtGlobalFlag_ _<path to file_\n_or folder>_\n\nSB_107d _<path to file or folder>_ Location\n\n\n**IPC** **I/O**\n**completion**\n\n\n**Execution**\n**conditions**\n\n\nYes Yes Location\n\n\nSB_6c9a _<path to file or folder>, -hide/-_\n_h, -delete/d, -net/-n, -once/-o, -_\n_skipfiles, -skipfolders, -file/-f_\n\nSB_6b9a _<path to file or folder>, -hide/-_\n_h, -delete/-d, -net/-n, -once/-o,_\n_-skipfiles, -skipfolders, -file/-f_\n\n_Comparison of StealBit samples_\n\n\nNone\n\nNone\n\n\nThe majority of the attacker-controlled endpoints to which the StealBit samples that we\nanalyzed exfiltrate data are located in western countries, with the Netherlands and the United\nStates at the top of the list. All StealBit samples implement named pipe-based IPC and the I/O\ncompletion port threading model for maximum exfiltration efficiency, usage convenience, and\nscalability. In addition, all StealBit samples detect the presence of a debugger attached to the\nStealBit process by evaluating the value of the NtGlobalFlag field of the PEB and execute an\nempty infinite loop if a debugger is present.\n\n**Older Versus Newer Versions of StealBit Malware**\n\nA major difference between the StealBit samples that we analyzed is the command line\nparameters and the respective malware features that the samples support. Relatively older\nStealBit samples do not support the command line parameters -hide/-h, -delete/-d, -net/-n, _once/-o, -skipfiles, -skipfolders, and -file/-f and the features that these parameters configure,_\nsuch as self-deletion and data exfiltration rate.\n\nThis indicates that StealBit has been undergoing improvement with new features, especially\nevasion and hiding features. Another major difference is that relatively older samples do not\nexecute on systems located in the former Soviet countries of Russia, Ukraine, Belarus,\nTajikistan, Armenia, Azerbaijan, Georgia, Kazakhstan, Kyrgyzstan, Turkmenistan, Uzbekistan,\nand Moldova. StealBit determines the location of a compromised system based on the\nsystem’s default language. Relatively newer samples do not implement this restriction and\nexecute on any system.\n\n\n-----\n\n## Detection and Prevention of StealBit Malware\n\n### Cybereason XDR Platform\n\nThe [Cybereason XDR Platform detects and stops StealBit when the malware exfiltrates data,](https://www.cybereason.com/platform)\nusing multi-layer protection that employs threat intelligence, machine learning, and next-gen\nantivirus (NGAV) capabilities to detect and block malware. The Cybereason platform also\n[detects malicious actors that execute the related LockBit ransomware:](https://www.cybereason.com/blog/cybereason-vs.-lockbit2.0-ransomware)\n\n_The Cybereason XDR Platform detects StealBit based on threat intelligence_\n\n### Cybereason GSOC MDR\n\nCybereason GSOC recommends the following:\n\nEnable the Anti-Malware feature on the Cybereason NGAV, and enable the\n**Detect and** **[Prevent modes of this feature.](https://nest.cybereason.com/documentation/product-documentation/190/anti-malware-settings)**\nRegularly monitor outgoing network traffic for data exfiltration activities.\nThreat Hunting with Cybereason: The Cybereason MDR team provides its\ncustomers with custom hunting queries for detecting specific threats - to find out\n[more about threat hunting and Managed Detection and Response with the](https://www.cybereason.com/platform/managed-detection-response-mdr)\n[Cybereason Defense Platform, contact a Cybereason Defender here.](https://www.cybereason.com/services/managed-detection-response-mdr#form)\n\n[For Cybereason customers: More details available on the NEST including](https://nest.cybereason.com/knowledgebase/4580181)\ncustom threat hunting queries for detecting this threat.\n\nCybereason is dedicated to teaming with Defenders to end cyber attacks from endpoints to\nthe enterprise to everywhere. Learn more about Cybereason XDR powered by Google\n_Chronicle, check out our_ [Extended Detection and Response (XDR) Toolkit, or](https://www.cybereason.com/get-the-xdr-toolkit) schedule a\n[demo today to learn how your organization can benefit from an operation-centric approach to](https://www.cybereason.com/blog/the-cybereason-malop-achieving-operation-centric-security)\nsecurity.\n\n## Indicators of Compromise for StealBit Malware\n\n\n-----\n\n**Executables** SHA-256 hash:\n_3407f26b3d69f1dfce76782fee1256274cf92f744c65aa1ff2d3eaaaf61b0b1d_\n\nSHA-256 hash:\n_107d9fce05ff8296d0417a5a830d180cd46aa120ced8360df3ebfd15cb550636_\n\nSHA-256 hash:\n_6c9a92955402c76ab380aa6927ad96515982a47c05d54f21d67603814d29e4a5_\n\nSHA-256 hash:\n_6b9aa479a5f9c6bfee52046c1afa579977dfcde868fdad3f18fdcd1779535068_\n\n\n**Named pipe**\n**files**\n\n**IP**\n**addresses**\n\n\n_STEALBIT-MASTER-PIPE_\n\n_88.80.147[.]102_\n\n_168.100.11[.]72_\n\n_139.60.160[.]200_\n\n_193.38.235[.]234_\n\n_174.138.62[.]35_\n\n_93.190.139[.]223_\n\n_185.182.193[.]120_\n\n\n## MITRE ATT&CK Techniques for StealBit Malware\n\n**Execution** **Privilege Escalation** **Defense**\n**Evasion**\n\n\n**Discovery** **Exfiltration**\n\n\n[Native API](https://attack.mitre.org/techniques/T1106/) Abuse Elevation Control\n[Mechanism: Bypass User](https://attack.mitre.org/techniques/T1548/002/)\nAccount Control\n\nInter-Process\nCommunication\n\n\nIndicator\nRemoval on\nHost: File\nDeletion\n\nObfuscated\n[Files or](https://attack.mitre.org/techniques/T1027/)\nInformation\n\n\nFile and\n[Directory](https://attack.mitre.org/techniques/T1083/)\nDiscovery\n\nSystem\n[Information](https://attack.mitre.org/techniques/T1082/)\nDiscovery\n\n\nData\n[Transfer](https://attack.mitre.org/techniques/T1030/)\nSize Limits\n\nExfiltration\n[Over C2](https://attack.mitre.org/techniques/T1041/)\nChannel\n\n\n-----\n\nHide Artifacts:\nHidden Window\n\n\nSystem\n[Location](https://attack.mitre.org/techniques/T1614/)\nDiscovery\n\n\n## About the Researchers:\n\n**Aleksandar Milenkoski, Senior Malware and Threat Analyst,**\n\n**Cybereason Global SOC**\n\nAleksandar Milenkoski is a Senior Malware and Threat Analyst with the Cybereason Global\nSOC team. He is involved primarily in reverse engineering and threat research activities.\nAleksandar has a PhD in system security. For his research activities, he has been awarded by\nSPEC (Standard Performance Evaluation Corporation), the Bavarian Foundation for Science,\nand the University of Würzburg, Germany. Prior to Cybereason, his work focused on research\nin intrusion detection and reverse engineering security mechanisms of the Windows 10\noperating system.\n\n**Kotaro Ogino, Security Analyst, Cybereason Global SOC**\n\nKotaro Ogino is a Security Analyst with the Cybereason Global SOC team. He is involved in\nthreat hunting, administration of Security Orchestration, Automation, and Response (SOAR)\nsystems, and Extended Detection and Response (XDR). Kotaro has a bachelor of science\ndegree in information and computer science.\n\n\n-----\n\nAbout the Author\n\n**Cybereason Global SOC Team**\n\nThe Cybereason Global SOC Team delivers 24/7 Managed Detection and Response services\nto customers on every continent. Led by cybersecurity experts with experience working for\ngovernment, the military and multiple industry verticals, the Cybereason Global SOC Team\ncontinuously hunts for the most sophisticated and pervasive threats to support our mission to\nend cyberattacks on the endpoint, across the enterprise, and everywhere the battle moves.\n\n[All Posts by Cybereason Global SOC Team](https://www.cybereason.com/blog/authors/cybereason-global-soc-team)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-16 - Inside the LockBit Arsenal - The StealBit Exfiltration Tool.pdf"
    ],
    "report_names": [
        "2021-12-16 - Inside the LockBit Arsenal - The StealBit Exfiltration Tool.pdf"
    ],
    "threat_actors": [
        {
            "id": "cf7fc640-acfe-41c4-9f3d-5515d53a3ffb",
            "created_at": "2023-01-06T13:46:38.228042Z",
            "updated_at": "2025-03-27T02:00:02.775905Z",
            "deleted_at": null,
            "main_name": "APT1",
            "aliases": [
                "GIF89a",
                "G0006",
                "PLA Unit 61398",
                "Group 3",
                "TG-8223",
                "Comment Group",
                "ShadyRAT",
                "COMMENT PANDA",
                "Comment Crew",
                "Byzantine Candor",
                "Brown Fox"
            ],
            "source_name": "MISPGALAXY:APT1",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3aaf0755-5c9b-4612-9f0e-e266ef1bdb4b",
            "created_at": "2022-10-25T16:07:23.480196Z",
            "updated_at": "2025-03-27T02:02:09.826059Z",
            "deleted_at": null,
            "main_name": "Comment Crew",
            "aliases": [
                "APT 1",
                "BrownFox",
                "Byzantine Candor",
                "Byzantine Hades",
                "Comment Crew",
                "Comment Panda",
                "GIF89a",
                "Group 3",
                "Operation Oceansalt",
                "Operation Seasalt",
                "Operation Siesta",
                "Shanghai Group",
                "TG-8223"
            ],
            "source_name": "ETDA:Comment Crew",
            "tools": [
                "Auriga",
                "Cachedump",
                "Chymine",
                "CookieBag",
                "Darkmoon",
                "GDOCUPLOAD",
                "GLOOXMAIL",
                "GREENCAT",
                "Gen:Trojan.Heur.PT",
                "GetMail",
                "Hackfase",
                "Hacksfase",
                "Helauto",
                "Kurton",
                "LETSGO",
                "LIGHTBOLT",
                "LIGHTDART",
                "LOLBAS",
                "LOLBins",
                "LONGRUN",
                "Living off the Land",
                "Lslsass",
                "MAPIget",
                "ManItsMe",
                "Mimikatz",
                "MiniASP",
                "Oceansalt",
                "Pass-The-Hash Toolkit",
                "Poison Ivy",
                "ProcDump",
                "Riodrv",
                "SPIVY",
                "Seasalt",
                "ShadyRAT",
                "StarsyPound",
                "TROJAN.COOKIES",
                "TROJAN.FOXY",
                "TabMsgSQL",
                "Tarsip",
                "Trojan.GTALK",
                "WebC2",
                "WebC2-AdSpace",
                "WebC2-Ausov",
                "WebC2-Bolid",
                "WebC2-Cson",
                "WebC2-DIV",
                "WebC2-GreenCat",
                "WebC2-Head",
                "WebC2-Kt3",
                "WebC2-Qbp",
                "WebC2-Rave",
                "WebC2-Table",
                "WebC2-UGX",
                "WebC2-Yahoo",
                "Wordpress Bruteforcer",
                "bangat",
                "gsecdump",
                "pivy",
                "poisonivy",
                "pwdump",
                "zxdosml"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535587,
    "ts_updated_at": 1743041141,
    "ts_creation_date": 1653753931,
    "ts_modification_date": 1653753931,
    "files": {
        "pdf": "https://archive.orkl.eu/ce07f28ea682c1e6b1a5fae65b5d4897931b0491.pdf",
        "text": "https://archive.orkl.eu/ce07f28ea682c1e6b1a5fae65b5d4897931b0491.txt",
        "img": "https://archive.orkl.eu/ce07f28ea682c1e6b1a5fae65b5d4897931b0491.jpg"
    }
}