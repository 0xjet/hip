{
    "id": "da3b42f0-de7f-457c-9ab7-07b82ee79a51",
    "created_at": "2023-01-12T14:59:02.501571Z",
    "updated_at": "2025-03-27T02:05:37.454833Z",
    "deleted_at": null,
    "sha1_hash": "8828403b98102f765e77549daa32c55949579c38",
    "title": "2020-06-24 - Obfuscated VBScript Drops Zloader, Ursnif, Qakbot, Dridex",
    "authors": "",
    "file_creation_date": "2022-05-28T17:09:34Z",
    "file_modification_date": "2022-05-28T17:09:34Z",
    "file_size": 2266589,
    "plain_text": "# Obfuscated VBScript Drops Zloader, Ursnif, Qakbot, Dridex\n\n**blog.morphisec.com/obfuscated-vbscript-drops-zloader-ursnif-qakbot-dridex**\n\n[Tweet](https://twitter.com/share)\n\nThe Morphisec Labs team has tracked an obfuscated VBScript package in campaigns since March 2020. Initially, the malware\ncampaign was focused on targets within Germany, but has since moved on to additional targets--excluding any IP address within\nRussia or North Korea.\n\nThese VBscripts started in March with delivering Zloader, as previously identified, and have since evolved into a delivery\nmechanism for trojans like Ursnif, Qakbot, and Dridex in addition to Zloader.\n\nThe danger here is that VBScript interpreter comes pre-loaded onto every Windows operating system, and has done since\nWindows 98. Interpreted languages like VBScript, Javascript, or really any text-based script will always be difficult for scans to\ndetermine whether the code is malicious or not. The reason behind this is that there is an endless number of possibilities to\nrepresent the same command or result.\n\nThe campaign that Morphisec Labs has tracked starts with a zipped obfuscated VBScript file attached to an email. The rest of the\ntechnical details follow in this blog post.\n\n\n-----\n\n## Obfuscated VBScript Technical Overview\n\nThe email the target receives contains a ZIP attachment that appeared to be an invoice, specifying the amount of the transaction,\ndate, and transaction number. The goal here, as in most of these emails with false invoices, is that the target won’t pay careful\nattention to the email.\n\nFigure 1: Malspam ZIP attachment\n\nInside the zip file attachment is a heavily obfuscated Visual Basic Script file with a low detection rate.\n\nFigure 2: VirusTotal low detection rate\n\nThe VBScript employed several techniques to evade sandboxes and make the analysis quite difficult. It has many garbage\nvariables, comments, decoy functions, and all of the malicious functions are obfuscated.\n\n\n-----\n\nFigure 3: Heavily obfuscated VBScript\n\nTo simplify our analysis, we wrote a short Python script that removes all the garbage code, comments, and variables. The image\nbelow illustrates what remained after we ran our Python script.\n\n\n-----\n\nFigure 4 Obfuscated VBS\n\n\nFigure 4: After the removal of garbage code, comments, and variables.\n\nIt leaves us with just the Visual Basic Script code. ExecuteGlobal commands receive a string as an argument and execute the\ncommands in the string. In this case, the argument is in the form of an array that is being converted to a string using\nmathematical character manipulation. Those strings are functions that are later used by the script (lines 32-44). This obfuscation\nmethod can be easily extracted by replacing 'ExecuteGlobal' with 'Wscipt.Echo'.\n\n## Anti-VM and Anti-Analysis\n\nThe first function calls are used for anti-analysis and anti-virtual machine. If one of the following evasive checks detects that it is\nrunning under a virtual machine or analysis environment, the attacker logs the IP, deletes the script, and pops a fake error\nmessage.\n\n\n-----\n\nFigure 5: Fake error message.\n\nIn addition to checking if the environment is a virtual machine or a sandbox, the Visual Basic Script also performs the following\nactions:\n\nChecks if the amount of physical memory is lower than 1030MB.\nChecks if the amount of logical memory is lower than 60GB\nChecks if the number of files in the download folder is lower than 3. This same check is done for the temp folder.\nChecks if the last boot up time was lower than 10 minutes (some samples use 20 minutes as the time they check for).\nChecks if the number of cores is lower than 3.\nChecks if the video adapter memory is less than 1500MB.\nExtracts the geographical location identifier from the registry path \"HKEY_CURRENT_USER\\Control\nPanel\\International\\Geo\\Nation\" and checks against the excluded GEOID list. Germany was targeted in the previous\ncampaign, and more recent ones have excluded Russia and North Korea.\nChecks if one of the processes from the list is running on the system (the list changes between versions). Also, it checks if\nthe number of running processes is lower than 28.\n\nFigure 6: Process names evasion\n\n\n-----\n\nIn the previous campaign (April 2020, SHA 1: f4683dccf77a37dbba63c4f4088ce1bed5171ac2) the attacker created a shortcut in\nthe temp directory to mark an infected machine.\n\nFigure 7. First campaign infection mark.\n\nIn the latest campaign, it checks if the VBScript is running on an infected machine by checking if the artifact is there. If it detects\nthat it is running on an infected machine it will pop a fake error message, delete the script, and exit. If not, it will create a new\nshortcut to mark the infected machine with the new campaign.\n\nFigure 8: Checks if the machine is already infected\n\nIn the final phase (the last three function calls: line 42-44), the script drops a zip folder by using the same decoding technique as\nused for decoding the functions. The zip folder consists of one dll, which is the payload. The others are decoys to hamper\nanalysis.\n\n\n-----\n\nFigure 9: Dropped ZIP\n\nNext, it unzips the folder and runs the dll using rundll32 or regsvr32.\n\nFigure 10: Runs the script using rundll32\n\n## Conclusion\n\nSimple obfuscation, or even less-simple obfuscation, of interpreted languages like VBScript are just enough for attackers to\nbypass scanning solutions. The simple reason is that, because these are text-based languages, the amount of possibly\nsuspicious terms is endless.\n\nNo matter what obfuscation is used, however, Morphisec’s moving target defense technology prevents the execution of the\nevasive payload, such as Zloader, Ursnif, Qakbot, or Dridex, before any damage is done.\n\n**IOCs (SHA-1)**\n\nEmail:\n\n2a80a3357994b0ea24832d8aa7c18d4efdaf701b\na12e1fec7957efa07498649844ed26b91c1ef0d6\nba212c1819fef115142ba0ec545d376f8c998cea\n\nVBS:\n\nef3d638377e245d7f388b41aad5e3525a8ccd2ed\ndffea6584a9a89723ae81864cd7a68976b49e62c\nee29a9908064d1a6bd54898732e4f8c8606914ba\n3f8ddfac37a997a113e131984f189e151ec990b4\n14c1aa17661931bed55bdeebc7c3df8d2f03464c\n733fc14cfb234f5cd16e05909a5f02e56801d780\n62439824c1f73cce160b24ce2ecdc422637dad72\na8354753917ad5b417833a24eae8765fd8655f57\n\n\n-----\n\nDll:\n\n\n0275719274a656be9111408fa73c7145ad16b04d\nf13e44b026ad0e1bc08afbf25f17411bb20566e6\n809ec6d35efc2b64b85c85a6e26efe7e84bb6b7a\nd4b3f7334a8405c0458d86a5a7ac0c97619a93c0\n\n64c076da46b169c13d1e933f5f420856fe2072dc\n8eb9adde4c5f109f7c9a27285b5da091773ad4eb\nf89fc63457ce4914b5e41ed0b17af0a9e1ac6119\ne3e98f6f780c54a86af046a8612b984dbbe16a24\nefa00fb74bd6f635cfd4400df3c56fa35caae10f\nba6380216f7e62e3e32d129210a9f13f9bc4f3b5\n903019f30ae78d6052c14ecb875f4c35c2ae6404\n5a7d276a64bb12b1b312c77da71360b88f793985\neb992300f7fd49d3723737a39782bd4c46b4e566\ne8b3ec66c28dedaa18b968bcd267a2c912a92e87\n\n\n[Contact SalesInquire via Azure](http://10.10.0.46/mailto:sales@morphisec.com)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-24 - Obfuscated VBScript Drops Zloader, Ursnif, Qakbot, Dridex.pdf"
    ],
    "report_names": [
        "2020-06-24 - Obfuscated VBScript Drops Zloader, Ursnif, Qakbot, Dridex.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535542,
    "ts_updated_at": 1743041137,
    "ts_creation_date": 1653757774,
    "ts_modification_date": 1653757774,
    "files": {
        "pdf": "https://archive.orkl.eu/8828403b98102f765e77549daa32c55949579c38.pdf",
        "text": "https://archive.orkl.eu/8828403b98102f765e77549daa32c55949579c38.txt",
        "img": "https://archive.orkl.eu/8828403b98102f765e77549daa32c55949579c38.jpg"
    }
}