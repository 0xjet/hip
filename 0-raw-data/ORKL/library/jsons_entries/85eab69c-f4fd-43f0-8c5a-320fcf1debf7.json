{
    "id": "85eab69c-f4fd-43f0-8c5a-320fcf1debf7",
    "created_at": "2023-01-12T16:30:54.507559Z",
    "updated_at": "2025-03-27T02:05:25.316226Z",
    "deleted_at": null,
    "sha1_hash": "8079e48ec4e3d19635d7676016d20ea527b03fb4",
    "title": "2020-11-26 - Tracking Cryptocurrency Malware in The Homelab",
    "authors": "",
    "file_creation_date": "2022-05-27T19:57:16Z",
    "file_modification_date": "2022-05-27T19:57:16Z",
    "file_size": 870081,
    "plain_text": "# Tracking Cryptocurrency Malware in The Homelab\n\n**[archcloudlabs.com/projects/tracking_cryptominer_domains/](https://www.archcloudlabs.com/projects/tracking_cryptominer_domains/)**\n\nNovember 26, 2020\n\n## About the Project\n\n[Since July of 2020, I have been running a “honeypot” of sorts made by anthok to capture all](https://twitter.com/the_anthok)\nrequests coming in on specific ports. By listening on ports commonly used by databases\nsuch as Elasticsearch or Redis, we’ve been able to observe a lot of bot behavior. Most of the\nrequests resulted in trying to gain an initial foothold onto the environment to run a bash script\nto bring down their stage-1 malware. Additional domains were identified by searching for the\nsame curl one-liner within my dataset. Through this methodology I was able to identify\nadditional IPs over time, that either were compromised by a particular bot or is additional\ninfrastructure used by the malicious actors.\n\n## Logging Infrastructure\n\n[anthok’s](https://twitter.com/the_anthok) [listening server logs data in CSV format to a single directory where filebeat is](https://www.anthok.com/posts/threat-intel-budget/)\nleveraged to forward data to Arch Cloud Labs (ACL) Logstash. The CSV data contains a\ntimestamp, source IP, and the raw bytes of the data observed on the wire. This data is then\nshipped back to ACL’s core Elasticsearch server and visualized. By tracking data over time\nwe have identified multiple Cryptocurrency miners and other various malicious bots.\n\nWhile not particularly sophisticated, it has been successful in capturing data that has lent\nitself to some interesting research. The image below depicts how Arch Cloud Labs data\nfeeds enable side-project research. The CSV data format is defined with a Logstash filter to\nprovide an easy to search Elastic mapping.\n\n\n-----\n\nAs data comes in it’s possible to query on specific attributes such as source IP, message, or\nanything that contains the word “wget”. Most requests captured are trying to take advantage\nof a known vulnerability or exposed service. Often captured is what would appear to be a\nvery specific request against a specific service targeting a documented CVE followed by a\nwget, netcat, or curl command within the body of an HTTP request. For example, a POST\nrequest against an Elasticsearch server trying to take advantage of an old RCE vulnerability\nfollowed by a curl command that pipes the output to /bin/bash. This example was observed\n[and documented in a previous blog post.](https://www.archcloudlabs.com/projects/analysis_of_a_cryptocurrency_miner/)\n\nBy filtering on these command-line utilities, further investigation of potential malicious\ndomains is made trivial. At this point, probable malware-hosting domains can be identified\nallowing for remote resources to be downloaded and analyzed. By looking at trends over\ntime, it’s easy to see the same one-liners from the same C2 domains. Then by looking at\nwhat source IP address the requests are coming from it’s possible to start seeing either\ninfected hosts trying to further propagate or new infrastructure being stood up by malicious\nactors.\n\nBy filtering on these command-line utilities, further investigation of potential malicious\ndomains is made trivial. At this point, probable malware-hosting domains can be identified\nallowing for remote resources to be downloaded and analyzed. By looking at trends over\ntime, it’s easy to see the same one-liners from the same C2 domains. Then by looking at\nwhat source IP address the requests are coming from it’s possible to start seeing either\ninfected hosts trying to further propagate or new infrastructure being stood up by malicious\nactors.\n\n\n-----\n\nAt the start of this project, a domain called “powerofwish” stood out as it was connecting on\nthe default port Redis runs on. Most other connections at this time were either RDP brute\nforce or Elasticsearch requests. Analyzing the “powerofwish” domain over time resulted in\nidentifying a new domain “hearme[.]xyz” and spurred my interest in digging into domain\nrelated data. The image below shows IPs associated with these domains since July of 2020.\nThe image below shows IP addresses associated with a specific subset of domains that are\nhosting cryptocurrency mining malware. Over the course of four months, I have identified ten\nvarious IPs correlated to one known malicious domain hosting cryptocurrency mining\nmalware.\n\nOver time it is possible to see new hosts being associated with these particular domains and\nother hosts falling off. Two noticeable gaps exist in late September and mid-October of this\nyear. I am unable to pinpoint exactly why this may be. Shodan searches identified most of\nthese IP addresses exposing various databases or FTP servers. While not proven, it is likely\nthat some of these domains were victims of the original dropper samples and not themselves\nmaliciously spreading the cryptocurrency miner.\n\n## Cryptocurrency Miners - Skidmap\n\n\n-----\n\nThe vast majority of malicious samples identified from the data collection approach described\nabove happens to be cryptocurrency miners.\nAdversaries can quickly wrap a PoC of a CVE with an open-source cryptocurrency miner and\nbe on their way to illicit operations. The particularly interesting piece (to me anyway) comes\nin the form of how the end-point malware is delivered, engineered, and maintained. The\nparticular samples that will be discussed going forward are publicly documented by Trend\nMicro as Skidmap. [This Trend Micro blog goes in-depth of how some of the components](https://www.trendmicro.com/en_us/research/19/i/skidmap-linux-malware-uses-rootkit-capabilities-to-hide-cryptocurrency-mining-payload.html)\nwork, however other components are not discussed as in-depth or have been introduced\nsince the original blog post. Throughout the analysis of the various Skidmap samples, I\nreferred to the Trend Micro blog post to see what, if anything had changed.\n\n## Looking into Initial Malware Hosting Domains\n\n[SecurityTrails' historical DNS data provided insight into the initial bash one-liner seen in our](https://securitytrails.com/dns-trails)\n“sensor” infrastructure. Shared infrastructure was identified of other domains that were also\nused to host not only the bash dropper script but a variant of the stage-1 malware as well.\n\nThe subdomain of “a” was being used to serve the stage-1 dropper, whereas all stage-2\ncontent came from subdomain “d”. You’ll notice that Cloudflare is being leveraged for their\nCDN abilities to host the initial bash script. Pivoting on the subdomain of “d”, I was able to\nfurther identify another domain shared with this IP, “cpuminerpool[]com”.\n\nAn interesting artifact of the “pm” subdomain, is that the stage-1 dropper observed initially\nwithin Kibana was a pm[].sh script. By requesting the dropper script directly from both\npowerofwish and cpuminerpool domains, two variants were successfully downloaded. This\nleads me to believe some type of vhosting is in place. Something else I found interesting,\n\n\n-----\n\nwas that the cpuminerpool domain has recently been transitioned to multiple hosting\nproviders as well as IP addresses within the past year. Often not staying at a particular\nhosting providing for a short period.\n\nI thought it might have been getting reported for abuse. However, taking a gander at Virus\nTotal for all three domains showed very low scores across the board.\n\n\n-----\n\nLooking into hosting providers resulted in a very cheap VPS provider with a data center out\nin Las Vegas as well as a Russian owned provider operating out of Moscow. Perhaps all the\nmoving of domains is to keep costs low or just to consistently keep changing their footprint.\nCloudflare is being used for not only its uptime but also the low likelihood (if any at all) of a\nCDN being outright blocked. This way, the actors could go back and modify or update the\nstage-0 dropper to accommodate for infrastructure change.\n\n\n-----\n\n## Anatomy of the Crypto Currency Miner\n\n### The Flow of Execution\n\nThe flow of execution shown below shows what I observed in my analysis. The Trend Micro\nanalysis states that a cronjob was added to consistently execute the sample every minute.\nThe samples I obtained were set to execute every twenty minutes. Additionally, the file being\ndownloaded from the initial dropper (pm. sh) was an ELF file called “pc”. Within my dataset, it\nwas “CC” being downloaded. However, also observed was the hosting of “png”, “px” and\n“PC”. Each of these files during my analysis returned the same MD5 hash.\n\n\n-----\n\n### Stage-0 - Gaining Access\n\nUpon initial investigation, the domain “powerofwish”, was attempting to connect to exposed\nRedis instances and run commands to gain shell access. The exact command observed can\nbe seen below.\n\n### Stage-1 Dropper\n\n\n-----\n\nThe bash dropper and its variants are fairly straight forward. The flow of execution breaks\ndown as follows:\n\n1. Verify the hash of stage-2 executable if it exists, if not download the ELF executable.\n2. Download and install `unhide if not installed.`\n```\n      unhide : a forensic tool to list TCP/UDP ports outside of netstat/ss\n\n```\n3. Use unhide to list processes (hearme, cc, pc, xr) and kill them\n4. perform cleanup commands\n5. Download stage-2 via curl or wget if available.\n6. Launch downloaded\n\n[An interesting piece to note here, it appears the unhide package is being leveraged due to](https://www.cyberciti.biz/tips/linux-unix-windows-find-hidden-processes-tcp-udp-ports.html)\nmodified versions of ss, netstat, and even LKMs being deployed to hide connections. Out of\nthe three variations of the dropper identified (across three different domains), not all had this\n```\nunhide component.\n\n```\nThe stage-2 samples across all domains were UPX packed and stripped. However,\nunpacking them resulted in the original binary being full of symbols making it significantly\neasier for analysis. Unless otherwise stated, assume all symbols were named by the\ndeveloper and not I.\n\n### Stage-2 Persistence\n\nAt this point a binary titled “cc”, “px”, “pc”, or “png” has been downloaded and executed. I\nhave broken up key functionality into separate sections, but please keep in mind this is NOT\n**a complete analysis.**\n\n**Dropping SSH Keys**\n\nEach variant I analyzed of Skidmap dropped a public key to\n```\n/root/.ssh/authorized_keys . Each sample analyzed had a different public key. After\n\n```\ndropping the public key, the `chattr binary is moved to` `/usr/bin/t and then the root`\nuser’s authorized key file is given the immutable bit to prevent modifications. I also did not\nobserve any sample checking that root login via ssh was enabled. This is why I believe they\nalso drop a backdoored version of PAM.\n\n**Overwriting PAM**\n\n\n-----\n\nAfter SELinux is disabled on the host, an embedded SO variant of PAM is written to enable\nthe adversary to login with a hardcoded password.\n\nBy referencing that `binarypam8 offset, we see the good ol' ELF header awaiting us in the`\nDATA section with a cross reference to the intuitively named “ writepam ” function.\n\n\n-----\n\nAfter writing the new PAM shared object, SELinux is re-enabled (cropped from the image\nbelow). Extracting the embedded SO and throwing it in IDA, the hardcoded password is\nidentified. This is the same hardcoded password as identified in the Trend Micro blog post\nand it stayed the same across multiple variants downloaded from different hosting providers.\n\n**Downloading & Installing Further Components**\n\nIf the underlying host is CentOS a special function is called which downloads a passwordprotected tarball entitled “cos7.tar.gz”. The hardcoded command shown in IDA below\ndecrypts the tarball and reveals a directory of init service scripts and modified binaries.\n\nAn interesting component here was the hardcoded decrypt command. I could not replicate\nthis successfully unless I was on a CentOS 6 machine. I am assuming there is a bug with\nthis command and newer versions of tar on CentOS7 and greater.\n\n\n-----\n\nThe modified versions of common Linux utilities include `ss,` `rm,` `wtmp,` `scp,` `ssh,`\n```\nip6network, and kaudited . During my analysis, I could not find any other case where\n\n```\nthis file was downloaded unless the host was CentOS. The tar file’s kaudited binary contains\nseveral embedded files that end up being kernel modules. kaudited was then executed if an\nMD5 matched within the CC binary, otherwise no kernel modules were installed from my\nobservations.\n\nThe largest portion kaudited is responsible for besides kernel module installation was the\ninstallation and planting of other various files. This was achieved via the bash script listed\nbelow. Note that yet again, pam is being modified. This was a common observation\nthroughout the analysis. When in doubt, re-backdoor pam!\n\n\n-----\n\n**Kernel Modules**\n\nA check is made by the `kaudited utility to verify what kernel version the host has. After`\nthat, the appropriate embedded kernel module is written to disk, and installed via a C\n```\nsystem function call to insmod . The image below shows the branching statement\n\n```\nidentifying that 9 different LKMs are embedded within this particular sample. However, when\nextracting binaries more were identified but not analyzed further. It’s possible during\nextraction a mistake occurred or just like for LKM installation, there are several variations for\nother utilities.\n\nA quick look at the symbols within the kernel modules reveal functionality to hide outbound\nconnections to specific destination ports as well as the hiding of files.\n\n\n-----\n\n**Differences Between Samples**\n\nThe core functionality is largely the same between all of these variations of Skidmap. The\nonly differences I could identify were in the cryptocurrency mining pools and public ssh keys\nbeing dropped.\n\n### Stage-3 Miner\n\n[Hardcoded strings within the binary revealed that cpuminer-opt is the mining software being](https://github.com/JayDDee/cpuminer-opt)\nleveraged across each variant I found. Hardcoded command line arguments revealed the\nusername name’s sugar1qddpk0wgqtgufenz6z9zh4cjgrehk8ezu and\nsugar1q523af4pce0r4cfrq08eyjpjjesw943s8 being used across eight seaparate mining pools.\nThese mining pool URLs include sugar[.]ss[.]dxpool[.]com, stratum-eu[.]rplant[.]xyz, and\n[stratum-asia[.]rplant[.]xyz. Both variants are setup to mine on sugarchain. However, at the](https://sugarchain.org/)\ntime of this writing when leveraging sugarchain’s blockchain explorer I was unable to find any\ntransactions sucessfully completed by either username.\n\n\n-----\n\ncpuminer-opt is wrapped within a binary that contains similar functionality that the stage-1\nsample did. It also contains the ability to overwrite PAM and drops an ssh public key to\nenable access. In both instances, a public key was dropped into the root user’s authorized\nkeys file.\n\nNormally, one would be concerned with cryptocurrency miners spiking CPU usage bringing\nunwanted attention. I have observed other examples using the `renice utility to lower the`\namount of time a process would request on CPU. However, the developers of these\nparticular samples have taken care of that by introducing functionality into kernel modules to\nhide real CPU usage.\n\n### IoCs\n\n\n-----\n\n```\n// stage 1 droppers\n706a98254456810d3e849c3957af9d01 a-powerofwish-com-init\n706a98254456810d3e849c3957af9d01 a-powerofwish-com-pm\n1bd78e75628e240bca853ff7d03deb74 pm-cpuminterpool-pm\n2c158a431794607be9b63bccc8df22ea d-powerofwish-com-init\n// upx samples\n8f6e5795ab79d72b2a12f3069001eb60 a-powerofwish-com-pc-upx\n8f6e5795ab79d72b2a12f3069001eb60 a-powerofwish-com-png-upx\n2c158a431794607be9b63bccc8df22ea pm-cpuminerpool-cc-upx\n2c158a431794607be9b63bccc8df22ea pm-cpuminerpool-com-png-upx\n// un-upx samples\n9e6f454fd1ead5c0abcd4eec173d571e a-powerofwish-com-png\n0e7d7ac72e5dfee64d74b70a4e031183 a-powerofwish-miner2\n9e6f454fd1ead5c0abcd4eec173d571e cpuminerpool-cc\n1bd78e75628e240bca853ff7d03deb74 cpuminterpool-pm\n9e6f454fd1ead5c0abcd4eec173d571e d-powerofwish-com-png\nc5147da98446cae3648fcce55b4d26b7 hearme-xyz--miner2\n6f1496cf82f80259c68f58b06df6e22f hearme-xyz-cc\n36d70ab88e18ea4af9a0d5db46ae3e9e pm-hearme-xyz\ne7e2bf2df6a33e6617870e8dd78abd10 pm-power-of-wish\n9e6f454fd1ead5c0abcd4eec173d571e powerofwish-cc\n9e6f454fd1ead5c0abcd4eec173d571e powerofwish-com-pc\n9e6f454fd1ead5c0abcd4eec173d571e powerofwish-com-px\n9e6f454fd1ead5c0abcd4eec173d571e powerofwish-png\n// files below are from the cos7.tar.gz\n5840dc51673196c93352b61d502cb779 ip6network\na36f1439f54dfe41f199ce146cc46d52 kaudited\ne96d1a8be74bf00011f630444edd3574 network-7.0\ne5d05f3767a650ad5d534bdfd8ce2ffb network-7.1\n376016032e9b50120cc60c1651b1f242 network-7.2\n376016032e9b50120cc60c1651b1f242 network-7.3\n45cde38fe5f84078712f899603c1dcba network-7.4\n45cde38fe5f84078712f899603c1dcba network-7.5\nd44908e9849b1841272618bd51a40182 network-7.6\nd44908e9849b1841272618bd51a40182 network-7.7\nd44908e9849b1841272618bd51a40182 network-7.8\nb5a9c7bd8fdb2b6e5c4431a90b83010f pamdicks.org\nf3b14bcb2037a7a1baf44782f1f1811b pam_unix.so\ne0ddd18f9d61be95955e2723c72b913d rm\nad29ac2ab08d9087f3b5654187b0602d scp\n586e14bdeaa163831f24c60c970b595b ss\n4183a06943cf29c89b46e724af5fb101 ssh\na40ca6f5fe465d766f90c558e277aa42 wtmp\ncb1db36f2aca451200533d87007c6943 clear.sh\n8ddf91f48da357632920f51a6cecd878 install-net.sh\n9a8797fb49aa1765c4a2049980fb42bf install.sh\nbb9d49ade493c7c0538afdb25e0a61da install-ssh.sh\nd94c0adf178a0c540b287d2b7aad1787 last.sh\n08b38e9f77255bb2d4d5f6c21c580372 rctl.sh\n9d92a79392e2aa20d85fe53cb9b16da7 readme.txt\n\n```\n\n-----\n\n## Beyond The Blog\n\nAs previously said, this is not a complete analysis. I’ve listed the hashes of these samples in\nthe event anyone wants to take a deeper look.\n\nI really enjoy the threat intel & malware analysis piece of the InfoSec industry. If you have an\nopen position that you’re looking to fill - my DMs are open! While this particular data\ncollection approach is a bit rudimentary, I’m hoping this shows other home labbers how little\nyou do need to get started and on your way to uncovering some interesting things on the\ninternet. Thank you all for reading!\n\n[Special thanks to the_anthok and](https://twitter.com/the_anthok) [0x80O0oOverfl0w for helping along the way!](https://twitter.com/0x80O0oOverfl0w)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-26 - Tracking Cryptocurrency Malware in The Homelab.pdf"
    ],
    "report_names": [
        "2020-11-26 - Tracking Cryptocurrency Malware in The Homelab.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673541054,
    "ts_updated_at": 1743041125,
    "ts_creation_date": 1653681436,
    "ts_modification_date": 1653681436,
    "files": {
        "pdf": "https://archive.orkl.eu/8079e48ec4e3d19635d7676016d20ea527b03fb4.pdf",
        "text": "https://archive.orkl.eu/8079e48ec4e3d19635d7676016d20ea527b03fb4.txt",
        "img": "https://archive.orkl.eu/8079e48ec4e3d19635d7676016d20ea527b03fb4.jpg"
    }
}