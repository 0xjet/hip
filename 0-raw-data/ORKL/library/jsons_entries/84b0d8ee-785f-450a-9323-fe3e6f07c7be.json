{
    "id": "84b0d8ee-785f-450a-9323-fe3e6f07c7be",
    "created_at": "2023-01-12T15:03:51.558328Z",
    "updated_at": "2025-03-27T02:05:46.825556Z",
    "deleted_at": null,
    "sha1_hash": "e9bad56a83c590c1dc28b7281342d0608d7c074e",
    "title": "2020-06-18 - Maze ransomware continues to be a threat to the consumers",
    "authors": "",
    "file_creation_date": "2022-05-28T19:08:00Z",
    "file_modification_date": "2022-05-28T19:08:00Z",
    "file_size": 1951109,
    "plain_text": "# Maze ransomware continues to be a threat to the consumers\n\n**[blogs.quickheal.com/maze-ransomware-continues-threat-consumers/](https://blogs.quickheal.com/maze-ransomware-continues-threat-consumers/)**\n\nJune 18, 2020\n\nMaze is a recently highlighted ransomware among the ever-growing list of ransomware\nfamilies. The ransomware is active from the past one year, although it came into limelight\ndue to its new approach of publishing sensitive data of infected customers publicly.\n\nThe malware uses different techniques to gain entry like the use of exploit kits or email\nimpersonation. These phishing emails are having a Word document attachment that\ncontains macros to run the malware in the system.\n\nMaze uses CHA-CHA algorithm for encryption and its key is encrypted using the RSA\nalgorithm. Maze can run with or without mutex —it uses some Russian IPs for the\nwebserver to sends information from the victim system(s). It uses RSA encryption request\nfor CnC communication and it will not encrypt the system for the specific region by checking\nkeyboard type.\n\n**Stage – I**\n\n**VBA MACRO**\n\n\n-----\n\nThe attached document file has a form containing an input box in which the number array of\nencrypted URL and path is present. The document file contains an ActiveX object. When it\nis executed, URL and path are decrypted post which it calls URLDownloadToFileA() that\ndownloads an executable to the specified location.\n\n_Fig 1. URLDownloadToFileA() Call with their parameters_\n\nThe number array is read from text box then converted into characters and concatenated to\nform a URL and path where the file is downloaded. Sometimes it also uses PowerShell to\ndownload the file. In most of the cases, file is downloaded at “C:\\Windows\\temp” location.\n\n_Fig 2. Characters stored in Number Array_\n\n**Stage – II**\n\n\n-----\n\n**A. CRYPTER**\n\nThe first stage of Maze ransomware is custom cryptor. This cryptor is a packed one with\nfew imports. It loads libraries by calling LoadLibrary() and GetProcAddress() from\nkernel32.dll. In this cryptor, function names are stored with their adler32 checksum.\n\nThe cryptor is for anti-debugging, it passes junk strings to the function\nOutputDebugStringW().\n\n_Fig 3. Call to OutputDebugStringW()_\n\nIn the below code, it checks whether the file is present or not, if present it will terminate.\nSimilarly, it also checks specific command-line arguments if it is present it will change\nexecution flow. Then malware loads the resource where actual DLL is present. The loaded\nresource is encrypted and XOR operation is used with key 0x41. After decryption, we get\nbase64 encoded data.\n\n\n-----\n\n_Fig 4. Xor Loop and API resolution_\n\nAfter copying all data onto the stack, API names are formed and then it calls Loadlibrary()\nWin32 API. Then it decodes base64 data by calling CryptStringToBinaryA() API. The\ndecrypted buffer is again decrypted using CHA-CHA 20 algorithm which brings the actual\npayload of Maze ransomware. Along with payload (which is a DLL of Maze), it also decrypts\nshellcode. By using CreateThread() API, it executes the shellcode.\n\n\n-----\n\n_Fig 5. Call to CreateThread()_\n\nIn this payload code, it first loads the base address of kernel32 for PEB. The below code\nshows the loading of the address.\n\n_Fig 6. The address is loaded from PEB_\n\nThe shellcode allocates memory using VirtualAlloc() and copies DLL file to newly allocated\nspace. Then it creates a thread and executes code from DLL. This code changes bytes at\nthe original entry point and then jump to OEP.\n\n**B. MAZE PAYLOAD**\n\nIn decrypted payload, it first loads all the APIs and then does patching of\ndbgUiRemoteBreakin from ntdl.dll. It is one of the anti-debugging techniques it uses to\navoid attachment of debugger.\n\nFirst it calls VirtualProtect() on dbgUiRemoteBreakin with PAGE_EXECUTE_READWRITE\nas new flNewProtect. Then it replaces byte 6A with C3 by simple mov instruction. So, if\nsomeone tries to attach debugger it will get failed.\n\n_Fig 7. Copy 0xC3 at dbgUiRemoteBreakin Entry point_\n\n\n-----\n\n_Fig 8. Code before and after patching_\n\nThen it enumerates running processes using Process32First() and process32Next(). It calls\nAPIs using ‘je’ instruction and address is pushed onto the stack which is executed after API\ncall. The call is replaced with ‘push’ and ‘jz’ or ‘je’ instruction.\n\n_Fig 9. Call to Process32NextW () using jz instruction_\n\nAfter process enumeration, it will obfuscate all the names with its algorithm which uses\nXMM registers. Then it calculates the hash of this obfuscated string which is then compared\nwith some hardcoded hashes. Some of them are:\n\nProcmon64.exe: 0x776E0635\n\nProcexp64.exe: 0x78020640\n\nIda.exe: 0x33840485\n\nDumpcap.exe: 0x5FB805C5\n\nX32dbg.exe: 0x5062053\n\n_Fig 10: Compare hashes with running process hashes_\n\nWhen any of the process hash matches it calls TerminateProcess() and exits the running\nprocess.\n\n\n-----\n\nIt will not encrypt files for specific keyboard type. To get keyboard type it calls the function\nGetUserDefaultUILanguage(). For eg:\n\nRusssian : 0x419 // NOT Encrypt For this value\n\nUkrainian : 0x422 // NOT Encrypt For this value\n\nSerbian : 0x7C1A // NOT Encrypt For this value\n\nen_US : 0x409 // Encrypt For this value\n\n_Fig 11. Check value return by GetUserDefaultUILanguage()_\n\nThen It first communicates with CnC server where the IP list is hardcoded, all below\nmentioned IP seems to belong to Russia.\n\n91.218.114.4\n\n91.218.114.11\n\n91.218.114.25\n\n91.218.114.26\n\n91.218.114.32\n\n91.218.114.37\n\n91.218.114.38\n\n_Fig 12. Hardcoded Ip list_\n\n\n-----\n\nThen data is sent to CnC on the first request: Data which is sent is Username,\nComputername, OsVersion.\n\nMalware create mutex with unique ID unique ID is created using SHA(GetComputerName()\n+ VolumeID()) .\n\nFor the ransomware marker, it creates a unique file on root and each folder.\n\n**Maze Encryption Process:**\n\nMalware selects files for encryption based on the extension. It excludes the following\nextensions:\n\n- Exe\n\n- Dll\n\n- Sys\n\n- lnk\n\nIt also excludes the following files:\n\n- Decrypt-Files.txt\n\n- Autorun.inf\n\n- Boot.ini\n\n- Desktop.ini\n\n- Temp/000.bmp\n\nExcluded folders:\n\n%windows%, @gaming%, %programdata%, %tor Brower%, %local Settings%, %appdata%\netc\n\n_Fig 13. Checking folder names and if the same found it will not encrypt the folder._\n\n**Encryption process:**\n\n\n-----\n\nIt first creates key and then exports it in the c:\\programdata\\data1.tmp folder. Then it drops\na ransom note in each folder before encryption. Later it will just import the key from this file\nand call “CryptEncrypt()”.\n\nIt retrieves drive letters and then determine type of drive using GetDriveType(). Further it\nenumerates using API calls FindFirstFileA() and FindNextFileA().\n\nIt deletes shadow copy by creating a fake path for wmic and then calls delete recover by\ncalling CreateProcessW()It encrypts files using CHA-CHA algorithm and the key of chacha\nis encrypted using RSA. For this, it uses crypto APIs. Encrypted files are having a marker at\nthe end which is ‘66116166’.\n\n_Fig 14. Encrypted File by Maze ransomware_\n\nIt creates a thread for each drive, which then again call create thread function for each\nfolder which does the encryption. Encryption will start from the root of C: or D: and parallelly\nit also accesses the shared drive by using WNetShareEnum() API. The same encryption\nfunction is used for encrypting shared drive files. The first folder which is encrypted is\n“$Recycle Bin”.\n\n\n-----\n\nCreateThread() with following function for each folder. File is opened as follows. File is\nencrypted by calling CryptEncrypt() and it is renamed by calling moveFileEx() with\nextension.\n\n**Encrypted File:**\n\n_Fig 15. File After encryption_\n\n**Maze Malware uses many tactics for anti-Analysis:**\n\nAPIs are resolved at runtime.\nIndirect calling of API & functions using JE & JNE instructions.\nPatching DbgUiRemoteTracking to avoid attaching of debugger at runtime.\nChecking being debugged flag.\nChecking for VM.\nChecks RAM & hardware size by using API – GlobalMemoryStatusEx &\nGetDiskeSpaceW.\nCheck process names by calculating its hashes.\n\n**Prevention measures to stay away from ransomware**\n\nCommon infection vectors used by Maze Ransomware are phishing emails with MS Office\nattachments and fake/phishing websites laced with Exploit Kits. Hence, we advise our end\nusers to exercise caution while handling emails from unknown sources, downloading MS\nOffice attachments, enabling macros, and clicking on suspicious links.\n\n**Indicators of compromise**\n\n49B28F16BA496B57518005C813640EEB\n\nBD9838D84FD77205011E8B0C2BD711E0\n\n**Subject Matter Expert**\n\nPreksha Saxena | Quick Heal Security Labs\n\n\n-----\n\n**Preksha Saxena**\n\n[Follow @](https://twitter.com/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-18 - Maze ransomware continues to be a threat to the consumers.pdf"
    ],
    "report_names": [
        "2020-06-18 - Maze ransomware continues to be a threat to the consumers.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535831,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1653764880,
    "ts_modification_date": 1653764880,
    "files": {
        "pdf": "https://archive.orkl.eu/e9bad56a83c590c1dc28b7281342d0608d7c074e.pdf",
        "text": "https://archive.orkl.eu/e9bad56a83c590c1dc28b7281342d0608d7c074e.txt",
        "img": "https://archive.orkl.eu/e9bad56a83c590c1dc28b7281342d0608d7c074e.jpg"
    }
}