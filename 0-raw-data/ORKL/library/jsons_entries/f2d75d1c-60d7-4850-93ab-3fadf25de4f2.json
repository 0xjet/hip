{
    "id": "f2d75d1c-60d7-4850-93ab-3fadf25de4f2",
    "created_at": "2023-01-12T15:03:46.823682Z",
    "updated_at": "2025-03-27T02:05:52.168239Z",
    "deleted_at": null,
    "sha1_hash": "55be0b4aa8dfdff70512fd680f34f7511b46868b",
    "title": "2021-10-04 - How to Write a Hancitor Extractor in Go",
    "authors": "",
    "file_creation_date": "2022-05-28T02:45:23Z",
    "file_modification_date": "2022-05-28T02:45:23Z",
    "file_size": 81310,
    "plain_text": "# How to Write a Hancitor Extractor in Go\n\n**pid4.io/posts/how_to_write_a_hancitor_extractor/**\n\n3 minutes\n\n[Hancitor (AKA Chanitor) is a well known and old malware family. A number of great blogs](https://malpedia.caad.fkie.fraunhofer.de/details/win.hancitor)\nhave been posted on the topic of analyzing the loader. Recently [@herrcor](https://twitter.com/herrcore) [live streamed](https://twitter.com/herrcore/status/1445056161611493379)\nbuilding an extractor with Python. It was a great session and worth checking out.\n\nIt seems that a Python extractor is relatively straightforward. So you might ask: Can we build\nthe same extractor with Go, using only the standard libary? Well, Yes, but with some\ndrawbacks.\n\nHere’s the [Gist if you want to skip the comments and check out the code.](https://gist.github.com/JamesHovious/1d6adb1dd6623af88735eeb5eba08eba)\n\nLet’s see what can be done without importing any external code. Below we see that\n```\nExtract is the only exported function, and it returns a configuration struct .\n// Config represents a parsed malware configuration\ntype Config struct {\n     Url    []url.URL\n     CampaignID string\n     Family   string\n     Raw    json.RawMessage // any data that is not represented elsewhere in\nthe struct can be put here\n}\n// Extract extracts configuration a HANCITOR PE\nfunc Extract(mal *pe.File) (config.Config, error) {\n     if mal.Section(\".data\") == nil {\n          return config.Config{}, errors.New(\"invalid pointer to PE data\nsection\")\n     }\n     dataSection, err := mal.Section(\".data\").Data()\n     if err != nil {\n          return config.Config{}, err\n     }\n\n```\nThe `\"debug/pe\" library was certainly not intended for malware analysis, but it is sufficient`\nfor this task. The task being to parse out of the data the configuration material.\n\nThe disadvantage to using only the standard library is that `\"debug/pe\" does not offer the`\nability to do dynamic offset calculations. In lieu of using dynamic offsets as shown by herrcor,\n[CAPEv2 can be used as a template.](https://github.com/kevoreilly/CAPEv2/blob/master/modules/processing/parsers/mwcp/Hancitor.py/)\n\n\n-----\n\n```\n     // key material at 16:24 in the data section\n     hash := sha1.Sum(dataSection[16:24])\n     rc4Key := hash[:5]\n     // 24 == starting after the key material\n     // 2000 == total size of config\n     conf, err := decryptConfig(rc4Key, dataSection[24:2000])\n     if err != nil {\n          return config.Config{}, err\n     }\n\n```\nAfter the key material is parsed we can decrypt and parse the configuration values.\n```\n     cipher, err := rc4.NewCipher(rc4Key)\n     if err != nil {\n          return config.Config{}, err\n     }\n     // decrypt the config\n     cipher.XORKeyStream(ciphertext, ciphertext)\n     // start parsing into a Config struct\n     var conf config.Config\n     build := buildID(ciphertext)\n     r, err := json.Marshal(fmt.Sprintf(`{\"rc4_key\": \"%v\" }`, rc4Key))\n     if err != nil {\n          return config.Config{}, err\n     }\n\n```\nSo it is possible to write a full extractor in Go instead of Python. But there are some clear\ndrawbacks. On the other hand we didn’t take a trip through dependency hell to get to a\nstatically compiled CLI tool, which didn’t import a single third party library. So that was nice.\n\n[The full source code for the extractor can be found as Gist . Just call the exported function](https://gist.github.com/JamesHovious/1d6adb1dd6623af88735eeb5eba08eba)\nlike so: `config, err := hancitor.Extract(mal) in which` `mal is a parsed DLL parsed`\nas a [*pe.File .](https://pkg.go.dev/debug/pe#NewFile)\n\n[malware analysis](https://pid4.io/tags/malware-analysis/) [go](https://pid4.io/tags/go/) [programming](https://pid4.io/tags/programming/)\n\n454 Words\n\n2021-10-05\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-10-04 - How to Write a Hancitor Extractor in Go.pdf"
    ],
    "report_names": [
        "2021-10-04 - How to Write a Hancitor Extractor in Go.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535826,
    "ts_updated_at": 1743041152,
    "ts_creation_date": 1653705923,
    "ts_modification_date": 1653705923,
    "files": {
        "pdf": "https://archive.orkl.eu/55be0b4aa8dfdff70512fd680f34f7511b46868b.pdf",
        "text": "https://archive.orkl.eu/55be0b4aa8dfdff70512fd680f34f7511b46868b.txt",
        "img": "https://archive.orkl.eu/55be0b4aa8dfdff70512fd680f34f7511b46868b.jpg"
    }
}