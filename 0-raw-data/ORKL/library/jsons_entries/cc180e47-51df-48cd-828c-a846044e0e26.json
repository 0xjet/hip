{
    "id": "cc180e47-51df-48cd-828c-a846044e0e26",
    "created_at": "2023-01-12T15:07:26.158604Z",
    "updated_at": "2025-03-27T02:07:59.993662Z",
    "deleted_at": null,
    "sha1_hash": "22e67147f756c41681889842a051dcce3de2b9be",
    "title": "2021-04-22 - An Undersea Royal Road- Exploring Malicious Documents and Associated Malware",
    "authors": "",
    "file_creation_date": "2022-05-28T19:40:48Z",
    "file_modification_date": "2022-05-28T19:40:48Z",
    "file_size": 321138,
    "plain_text": "# An Undersea Royal Road: Exploring Malicious Documents and Associated Malware\n\n**[domaintools.com/resources/blog/an-undersea-royal-road-exploring-malicious-documents-and-associated-malware](https://www.domaintools.com/resources/blog/an-undersea-royal-road-exploring-malicious-documents-and-associated-malware)**\n\n## Background\n\nSince at least 2017, various threat actors, generally associated with or assessed to be\nlocated in the People’s Republic of China (PRC), utilized a malicious document builder\nreferred to as Royal Road as part of phishing activity. Observed in conjunction with multiple,\ndistinct threat actors, Royal Road provides a mechanism to embed malicious, encoded\nobjects within Rich Text Format (RTF) files. Code execution and object delivery relies on\n[exploiting one of several vulnerabilities in the Microsoft Equation Editor.](https://www.anomali.com/blog/multiple-chinese-threat-groups-exploiting-cve-2018-0798-equation-editor-vulnerability-since-late-2018)\n\nAs [documented by several researchers, multiple adversaries utilize Royal Road to target](https://nao-sec.org/2020/01/an-overhead-view-of-the-royal-road.html)\nvarious industries for the delivery of diverse payload types in victim environments.\n\nAs of this writing, over seven distinct threat groups are assessed to use Royal Road\ndocuments for initial access operations, with incidents primarily targeting East and\nSoutheast Asia as well as Russian entities.\n\nIn April 2021, DomainTools researchers identified a malicious document matching Royal\nRoad characteristics in a commercial malware database. Further research indicated initial\ndiscovery by researchers from Proofpoint. Aside from representing an evolution in Royal\nRoad-related documents and post-exploitation behaviors, available information indicates\ninteresting targeting emphasis for the identified campaign.\n\n## Email and Dropper Documents\n\nAlthough DomainTools initially discovered the activity in question via a malicious document,\nreview of various sources linked the document to an email as the delivery vector:\n\n\n-----\n\nWhile technically nondescript—the message is just a brief note with the malicious RTF\nattached—other contextual details are quite interesting. Examining the actual content and\naddressing, the following observations emerge:\n\nFor timing and context purposes, the email was sent on 01 April 2021.\nThe message sender uses a mail.ru address, but attempts to spoof the legitimate\n[Gridroprobor underwater technology and weapons research center associated with](https://www.gidropribor.ru/en/)\nmilitary research and development for the Russian Federation.\n[The message recipient is the general contact address for the Rubin Design Bureau,](http://ckb-rubin.ru/en/main/)\none of three submarine design bureaus supporting the Russian navy.\nAlthough sent to a general contact address, the message is addressed to General\n[Director “Igor Vladimirovich,” likely referring to Rubin’s current director Igor V. Vilnit.](http://ckb-rubin.ru/en/company_profile/management/director_general/)\nThe message subject and attachment name references Autonomous Underwater\nVehicles (AUVs).\nThe email signature references the address and contact information for Gridroprobor\nin Saint Petersburg.\n\nWhile all of these items could be identified via open source research and analysis, they\nrepresent a level of specificity in theme and likely targeting for the message. Based on the\navailable details, the entity responsible for constructing and sending this message went to\nsome effort to mimic an existing relationship between state-directed organizations\nresearching submarine and underwater weapons technologies on behalf of the Russian\nFederation. These themes carry over into the malicious RTF itself:\n\n\n-----\n\nThe document, “preliminary design results for the AUV,” is simple with a banner graphic and\nseveral perspectives of what appear to be an AUV design. The document has the following\nidentifying characteristics:\n```\nMD5: 027f5ae272bbb6bbc3e1fdf230a4e3f6\nSHA1: 57142832e5453cb0e2c3e6c1a3d7536131b3ed72\nSHA256: 774a54300223b421854d2e90bcf75ae25df75ba9f3da1b9eb01138301cdd258f\n\n```\nReviewing document metadata shows several interesting characteristics:\n\nAn original document creation timestamp of 25 May 2007, indicating either the use of\ndeliberate manipulation of timestamps or refreshing an existing template for malicious\nuse.\nAn “Author” value of “pc-1.”\nA primary document character set of Simplified Chinese.\n\n[Further examination of the document (using the OLEtools framework) reveals embedded](https://www.decalage.info/python/oletools)\nobjects following the same patterns (although with slightly different naming conventions) as\nhistorical Royal Road activity:\n\n\n-----\n\nThe first [OLE object is a file containing obfuscated code, while the second contains the](https://docs.microsoft.com/en-us/cpp/mfc/ole-background?view=msvc-160)\nMicrosoft Equation Editor exploit. When opened in a vulnerable version of Microsoft Word,\nthe document will write the first OLE object to disk to the following location:\n```\nC:\\Users\\[Executing User]\\AppData\\Local\\Temp\\e.o\n\n```\nNext, the Equation Editor will launch, decode the content of “e.o”, and write a Dynamic-Link\nLibrary (DLL) object in the form of a Microsoft Office add-in item to disk:\n```\nC:\\Users\\[Executing User]\\AppData\\Roaming\\Microsoft\\Word\\STARTUP\\winlog.wll\n\n```\nIn addition to writing the above file, the “e.o” object is also removed as part of this process.\nAt this point, behavior from the weaponized document ceases and no further, direct action\ntakes place from exploitation.\n\n## Identifying Malware Execution and Persistence Mechanisms\n\nThe penultimate action described above, writing the “winlog.wll” DLL to the Word STARTUP\nlocation, represents the next stage of execution as well as persistence within the victim\nenvironment. As [previously documented with respect to Royal Road, the use of WLL file](https://nao-sec.org/2020/01/an-overhead-view-of-the-royal-road.html)\ntypes—typically associated with Microsoft Word add-in objects—ensures the execution of\nthe malicious DLL every time Microsoft Word launches in the future.\n\nIn this specific case, winlog.wll is called via the following convention:\n```\nRundll32.exe winlog.wll,DllEntry28 [Current System Time in Unix Timestamp Format]\n\n```\nWhen analyzed, the DLL (specifically the “DllEntry28” export) contains a number of system\nand analysis checks, preventing execution in monitored environments. However, further\nanalysis of the file indicates that direct functionality can be triggered by calling export\n“DllEntry18” with no parameters. This combination of follow-on execution taking place the\n\n\n-----\n\nnext time Word is opened combined with the checks present in the default DLL export\ncalled during startup provide a relatively simple, if effective, mechanism to evade sandbox\nand behavioral analysis. Overall execution flow aligns with the following:\n\n\n-----\n\n## Malware Analysis and Infrastructure\n\nThe malicious DLL merits further investigation. The file appears compiled mere days before\nthe phishing email was sent (27 March 2021), and has the following characteristics:\n```\nMD5: 70da6872b6b2da9ddc94d14b02302917\nSHA1: b2da45913353bfc66d189455f9ad80ef26968143\nSHA256: 2d705f0b76f24a18e08163db2f187140ee9f03e43697a9ea0d840c829692d43c\n\n```\nWhile “DllExport18” and “DllExport28” are the only functional exports for the DLL, the DLL\nreferences a total of 34 exported functions (from “DllExport00” to “DllExport33”). Aside from\nthe two already discussed, the remainder have no associated functionality, and potentially\nrepresent a diversion or another anti-analysis technique.\n\nWhen executed via “DllExport18,” the malware sends a single beacon via TCP 443 to the\nfollowing IP address:\n```\n45.63.27[.]162\n\n```\nHosted in Australia and part of the Vultr or CHOOPA hosting service, a review of\nDomainTools Passive DNS (pDNS) data shows no active domain resolutions since\nNovember 2020.\n\n\n-----\n\nSince late 2020, the IP address appears to be dormant until incorporation into this\ncampaign in early 2021.\n\nExamining the DLL further identifies potential additional functionality through plaintext\nstrings. Specifically, there appear to be references for building HTTP headers, including\nitems such as hard-coded User Agent strings, for additional communication:\n```\nCONNECT %s:%d HTTP/1.0\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML,\nlike Gecko) Chrome/70.0.3538.102 Safari/537.36 Edge/18.18362\nProxy-Connection: Keep-Alive\nContent-Length: 0\nHOST: %s\nPragma: no-cache\n%s:%s\n\n```\nBased on analysis of the DLL, functionality appears to be determined by receiving a\nresponse to the initial beacon. The strings identified above indicate the DLL may then\nrespond via HTTP CONNECT methods for subsequent Command and Control (C2)\ncommunication.\n\n## Additional Document Files\n\n\n-----\n\nDomainTools researchers attempted to identify additional samples that might be indicative\nof a wider campaign with similar characteristics. While we were unable to identify any\nadditional samples of the malicious DLL, further searching on document metadata identified\ntwo additional documents with identical functionality:\n\n**SHA256** **File Name**\n\nb60c9b59e03101277196bce597701eab5cfb0fd6b37442a5029673a11ffb9295 Перспекти\n\naec6271de4436ddf0067e67c389cbddb82f73d749e4713f5c8b375ad0ee7da9c N/A\n\nWhile the documents have the same ultimate functionality (including identical embedded\nOLE objects), the presentation of the documents themselves is somewhat different. One\nfeatures just the diagram portion of the item originally analyzed in this report, while the other\nfeatures a limited text snippet.\n\nObservation dates indicate visibility after the construction and delivery of the original RTF\nanalyzed in this report (01 April 2021), this information only indicates when the items\nappeared in third-party datasets as opposed to their actual creation or construction. One\npossibility is that these less well-formed documents are testing or similar variants for the\nmore refined item delivered in the phishing campaign. How they ended up in a commercial\nmalware repository would be unknown, although we would also need to consider these\ndocuments being used in other, unidentified phishing campaigns as well. Irrespective of\norigin, these documents tentatively indicate a wider scope to this activity than a single\nphishing email attachment.\n\n## Conclusion\n\nThe identified activity represents an evolution of Royal Road malicious RTF functionality,\nincluding a new naming schema for embedded OLE objects and a DLL payload that\nappears noticeably different from previous objects delivered via this technique. From a\ndefender’s perspective, this campaign leverages a number of items that can be identified,\nprevented, or potentially forbidden via policy: using updated Microsoft Office software to\neliminate the vulnerability; tracking odd process execution chains such as rundll32.exe\nspawned from a Microsoft Office process; or identifying odd communication items such as a\ndirect-to-IP HTTP CONNECT observations.\n\nWhile defensive countermeasures to this campaign are within reach for many organizations,\nthe targeting and possible intent behind this document are curious. Given the email delivery\naddress, themes, and document contents, DomainTools concludes with high confidence\nthat this campaign targets underwater research and weapon development organizations in\n\n\n-----\n\nthe Russian Federation. Furthermore, the historical pattern of activity associated with Royal\nRoad operations combined with the observed language set used in the primary document\nanalyzed in this report would strongly suggest a relationship to at minimum Chinese\nlanguage entities, if not the PRC itself. However, insufficient evidence exists given paucity\nof samples and minimal observed targeting and communication to make such a link at\nanything greater than low confidence.\n\nIrrespective of attribution, the identified phishing instance shows the continued use and\nevolution of a malicious document framework widely deployed by many threat actors.\nCombined with the sensitive targeting and the attempts at hardening the ultimate payload, it\nappears the adversary went to some effort to evade analysis of their activity as well.\nAlthough this campaign appears specifically targeted to an entity in the Russian Federation,\nthe underlying behaviors of this campaign—from malicious document usage through binary\nexecution guardrails and controls—provide helpful insight into adversary tradecraft from\nwhich all defenders can learn valuable lessons.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-04-22 - An Undersea Royal Road- Exploring Malicious Documents and Associated Malware.pdf"
    ],
    "report_names": [
        "2021-04-22 - An Undersea Royal Road- Exploring Malicious Documents and Associated Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536046,
    "ts_updated_at": 1743041279,
    "ts_creation_date": 1653766848,
    "ts_modification_date": 1653766848,
    "files": {
        "pdf": "https://archive.orkl.eu/22e67147f756c41681889842a051dcce3de2b9be.pdf",
        "text": "https://archive.orkl.eu/22e67147f756c41681889842a051dcce3de2b9be.txt",
        "img": "https://archive.orkl.eu/22e67147f756c41681889842a051dcce3de2b9be.jpg"
    }
}