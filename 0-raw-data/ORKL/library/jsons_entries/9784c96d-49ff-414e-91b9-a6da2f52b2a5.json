{
    "id": "9784c96d-49ff-414e-91b9-a6da2f52b2a5",
    "created_at": "2023-06-05T02:07:18.530022Z",
    "updated_at": "2025-03-27T02:16:53.021563Z",
    "deleted_at": null,
    "sha1_hash": "5ba4030a7db9fc573874ae69e8b4082f22ec745a",
    "title": "2023-04-23 - in2al5dp3in4er Loader",
    "authors": "",
    "file_creation_date": "2023-06-04T12:24:19Z",
    "file_modification_date": "2023-06-04T12:24:19Z",
    "file_size": 297784,
    "plain_text": "# in2al5dp3in4er Loader\n\n**[research.openanalysis.net/in2al5dp3in4er/loader/analysis/sandbox/invalid printer/2023/04/23/in2al5dp3in4er.html](https://research.openanalysis.net/in2al5dp3in4er/loader/analysis/sandbox/invalid%20printer/2023/04/23/in2al5dp3in4er.html)**\n\nOALABS Research April 23, 2023\n\n## Overview\n\n#### This new? loader was exposed by Morphisec. According to the post, the loader is compiled with Embarcadero RAD Studio and employs a graphics card check to ensure it is not running in a sandbox before deploying its embedded payload (the loader). The loader is simply used to download and execute a final payload (main functionality).\n\n## References\n\n Samples\n\n`66383d931f13bcdd07ca6aa50030968e44d8607cf19bdaf70ed4f9ac704ac4d1` [UnpacMe](https://www.unpac.me/results/346236af-1c81-4cbf-88f3-514061ce1a40#/)\n\n## Analysis\n```\ndata = open('/tmp/blob.bin', 'rb').read()\n\nout = []\n\nfor i in range(len(data)):\n\n  tmp = data[i]\n\n  tmp = (tmp - 52) & 0xff\n\n  tmp ^= 0x55\n\n  tmp = (tmp + i - 18) & 0xff\n\n  out.append(tmp)\n\nout = bytes(out)\n\nout[:100]\n\nopen('/tmp/out.bin','wb').write(out)\n\n3168770\n\n### Aurora Stealer\n\n#### The extracted 2nd stage is the golang stealer sold as \"Aurora Stealer\" malpedia.\n21545028cac12fc9e8692a71247040718e6d640ee6117d1b19f4521f886586beUnpacMe\n\n## Packer ID\n\n#### We can make a simple yara rule based on the following\n\n```\n\n-----\n\n### riid for CreateDXGIFactory call\n```\nEC 66 71 7B C7 21 AE 44 B2 1A C9 AE 32 1A E3 69\n\n imports\nCreateDXGIFactory from DXGI.dll\n\n checks\ncmp   eax, 887A0002h\n\n3D 02 00 7A 88\n\n gfx whitelist ids\n{29 9? 01 00}\n\n Rule\nimport \"pe\"\n\nimport \"math\"\n\nrule riid_hunt {\n\n  strings:\n\n    $riid = { EC 66 71 7B C7 21 AE 44 B2 1A C9 AE 32 1A E3 69 }\n\n    $embarcadero = \"This program must be run under Win32\" ascii\n\n    $import = \"CreateDXGIFactory\" ascii wide\n\n  condition:\n\n    all of them and\n\n    for any i in (0..(pe.number_of_sections)-1) :   \n\n    (\n\n      pe.sections[i].name == \".data\" and\n\n      math.entropy(pe.sections[i].raw_data_offset,\npe.sections[i].raw_data_size) >= 7\n\n    )\n\n}\n\n## Unpacking\n\n```\n\n-----\n\n```\n48 8D 05  9A 94 16 00                     lea   rax, blob\n48 B9  EE EE DE DD CD CC BB 0A                mov   rcx,\n0ABBCCCDDDDEEEEEh\n\n48 BA  55 55 45 44 34 23 12 00                mov   rdx,\n12233444455555h\n\n49 B8  CC CC B3 BB A2 1A 00 00                mov   r8,\n1AA2BBB3CCCCh\n\n4C  63 4D E0                         movsxd r9,\n[rbp+var_20]\n48 8D 05  D1 93 16 00                     lea   rax, blob\n48 B9  81 FD A9 98 F6 50 00 00                mov   rcx,\n50F698A9FD81h\n\n48 BA  1B 06 AC 5D DE F8 ED 00                mov   rdx,\n0EDF8DE5DAC061Bh\n\n49 B8  04 68 7C AA 99 9D 0B 00                mov   r8,\n0B9D99AA7C6804h\n\n4C  63 4D E8                         movsxd r9,\n[rbp+var_18]\nimport re\n\nimport struct\n\nimport pefile\n\nfile_data = open('/tmp/pointer.bin', 'rb').read()\n\npe = pefile.PE(data=file_data)\n\ncrypto_egg =\nrb'\\x48\\x8D\\x05(....)\\x48\\xB9(.).......\\x48\\xBA(.).......\\x49\\xB8(.).......\\x4C'\n\nmatch = re.search(crypto_egg, file_data, re.DOTALL)\n\nassert match is not None\n\nmatch_offset = match.start()\n\npayload_offset = struct.unpack('<i', match.group(1))[0]\n\nmatch_rva = pe.get_rva_from_offset(match_offset)\n\nblob_rva = match_rva + 7 + payload_offset\n\nblob_offset = pe.get_offset_from_rva(blob_rva)\n\nadd_inc_key = struct.unpack('B', match.group(2))[0]\n\nxor_key = struct.unpack('B',match.group(3))[0]\n\nadd_key = struct.unpack('B',match.group(4))[0]\n\nprint(f\"add_inc_key: {hex(add_inc_key)}\")\n\nprint(f\"xor_key: {hex(xor_key)}\")\n\nprint(f\"add_key: {hex(add_key)}\")\n\nprint(f\"blob_rva: {hex(blob_rva)}\")\n\nprint(f\"blob_offset: {hex(blob_offset)}\")\n\n```\n\n-----\n\n```\nadd_inc_key: 0xee\n\nxor_key: 0x55\n\nadd_key: 0xcc\n\nblob_rva: 0x172ef0\n\nblob_offset: 0x171af0\n\ntmp_data = file_data[blob_offset:]\n\nblob_data = tmp_data.split(b'\\x00\\x00\\x00\\x00')[0]\n\nblob_data[:100].hex()\n\n'3e72298e788c7992939091868485858a0c8889dedfdcdde2a3e0e1d6d7d4d5dadbd8d9eeefecedf2f3f0f\ndef decrypt(data, key1, key2, key3):\n\n  out = []\n\n  for i in range(len(data)):\n\n    tmp = data[i]\n\n    tmp = (tmp + key1) & 0xff\n\n    tmp ^= key2\n\n    tmp = (tmp + i + key3) & 0xff\n\n    out.append(tmp)\n\n  out = bytes(out)\n\n  return out\n\nout = decrypt(blob_data, add_key, xor_key, add_inc_key)\n\n\ntmp_pe = pefile.PE(data=out)\n\npe_size = pe.sections[-1].PointerToRawData + pe.sections[-1].Misc_VirtualSize\n\nfinal_pe = out[:pe_size]\n\nopen('/tmp/testpe.bin', 'wb').write(final_pe)\n\n3114235\n\n```\n\n-----\n\n```\ndef extract(file_path):\n\n  file_data = open(file_path, 'rb').read()\n\n  pe = pefile.PE(data=file_data)\n\n  crypto_egg =\nrb'\\x48\\x8D\\x05(....)\\x48\\xB9(.).......\\x48\\xBA(.).......\\x49\\xB8(.).......\\x4C'\n\n  match = re.search(crypto_egg, file_data, re.DOTALL)\n\n  assert match is not None\n\n  match_offset = match.start()\n\n  payload_offset = struct.unpack('<i', match.group(1))[0]\n\n  match_rva = pe.get_rva_from_offset(match_offset)\n\n  blob_rva = match_rva + 7 + payload_offset\n\n  blob_offset = pe.get_offset_from_rva(blob_rva)\n\n  add_inc_key = struct.unpack('B', match.group(2))[0]\n\n  xor_key = struct.unpack('B',match.group(3))[0]\n\n  add_key = struct.unpack('B',match.group(4))[0]\n\n  tmp_data = file_data[blob_offset:]\n\n  blob_data = tmp_data.split(b'\\x00\\x00\\x00\\x00')[0]\n\n  out = decrypt(blob_data, add_key, xor_key, add_inc_key)\n\n  assert out[:2] == b'MZ'\n\n  tmp_pe = pefile.PE(data=out)\n\n  pe_size = pe.sections[-1].PointerToRawData + pe.sections[-1].Misc_VirtualSize\n\n  final_pe = out[:pe_size]\n\n  open(file_path+'_extracted.bin', 'wb').write(final_pe)\n\n# import required module\n\nimport os\n\n# assign directory\n\ndirectory = '/tmp/samples'\n\n# iterate over files in\n\n# that directory\n\nfor filename in os.listdir(directory):\n\n  f = os.path.join(directory, filename)\n\n  # checking if it is a file\n\n  if os.path.isfile(f):\n\n    try:\n\n      print(f)\n\n      extract(f)\n\n    except:\n\n      continue\n\n/tmp/samples/66383d931f13bcdd07ca6aa50030968e44d8607cf19bdaf70ed4f9ac704ac4d1\n\n/tmp/samples/.DS_Store\n\n/tmp/samples/a4cab01d61d8c18876d4b53d52de365fb9b512430371fd4217359159f3c507f6\n\n/tmp/samples/66383d931f13bcdd07ca6aa50030968e44d8607cf19bdaf70ed4f9ac704ac4d1_extracte\n\n/tmp/samples/5e4b6272dc2d955c5e52c755ea598f44e324b04466a4e3bacf6c9d845345322b\n\n/tmp/samples/cdb09a5df36fece23bc3c9df101fe65724327b827ec43aa9ce0b3b76bdcc3101\n\n/tmp/samples/2c540f5220b7ba3cd6efcd2fe8091fc24f8da11be4b1782c4e502261ef48da82\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-04-23 - in2al5dp3in4er Loader.pdf"
    ],
    "report_names": [
        "2023-04-23 - in2al5dp3in4er Loader.pdf"
    ],
    "threat_actors": [
        {
            "id": "cf7fc640-acfe-41c4-9f3d-5515d53a3ffb",
            "created_at": "2023-01-06T13:46:38.228042Z",
            "updated_at": "2025-03-27T02:00:02.775905Z",
            "deleted_at": null,
            "main_name": "APT1",
            "aliases": [
                "GIF89a",
                "G0006",
                "PLA Unit 61398",
                "Group 3",
                "TG-8223",
                "Comment Group",
                "ShadyRAT",
                "COMMENT PANDA",
                "Comment Crew",
                "Byzantine Candor",
                "Brown Fox"
            ],
            "source_name": "MISPGALAXY:APT1",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3aaf0755-5c9b-4612-9f0e-e266ef1bdb4b",
            "created_at": "2022-10-25T16:07:23.480196Z",
            "updated_at": "2025-03-27T02:02:09.826059Z",
            "deleted_at": null,
            "main_name": "Comment Crew",
            "aliases": [
                "APT 1",
                "BrownFox",
                "Byzantine Candor",
                "Byzantine Hades",
                "Comment Crew",
                "Comment Panda",
                "GIF89a",
                "Group 3",
                "Operation Oceansalt",
                "Operation Seasalt",
                "Operation Siesta",
                "Shanghai Group",
                "TG-8223"
            ],
            "source_name": "ETDA:Comment Crew",
            "tools": [
                "Auriga",
                "Cachedump",
                "Chymine",
                "CookieBag",
                "Darkmoon",
                "GDOCUPLOAD",
                "GLOOXMAIL",
                "GREENCAT",
                "Gen:Trojan.Heur.PT",
                "GetMail",
                "Hackfase",
                "Hacksfase",
                "Helauto",
                "Kurton",
                "LETSGO",
                "LIGHTBOLT",
                "LIGHTDART",
                "LOLBAS",
                "LOLBins",
                "LONGRUN",
                "Living off the Land",
                "Lslsass",
                "MAPIget",
                "ManItsMe",
                "Mimikatz",
                "MiniASP",
                "Oceansalt",
                "Pass-The-Hash Toolkit",
                "Poison Ivy",
                "ProcDump",
                "Riodrv",
                "SPIVY",
                "Seasalt",
                "ShadyRAT",
                "StarsyPound",
                "TROJAN.COOKIES",
                "TROJAN.FOXY",
                "TabMsgSQL",
                "Tarsip",
                "Trojan.GTALK",
                "WebC2",
                "WebC2-AdSpace",
                "WebC2-Ausov",
                "WebC2-Bolid",
                "WebC2-Cson",
                "WebC2-DIV",
                "WebC2-GreenCat",
                "WebC2-Head",
                "WebC2-Kt3",
                "WebC2-Qbp",
                "WebC2-Rave",
                "WebC2-Table",
                "WebC2-UGX",
                "WebC2-Yahoo",
                "Wordpress Bruteforcer",
                "bangat",
                "gsecdump",
                "pivy",
                "poisonivy",
                "pwdump",
                "zxdosml"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1685930838,
    "ts_updated_at": 1743041813,
    "ts_creation_date": 1685881459,
    "ts_modification_date": 1685881459,
    "files": {
        "pdf": "https://archive.orkl.eu/5ba4030a7db9fc573874ae69e8b4082f22ec745a.pdf",
        "text": "https://archive.orkl.eu/5ba4030a7db9fc573874ae69e8b4082f22ec745a.txt",
        "img": "https://archive.orkl.eu/5ba4030a7db9fc573874ae69e8b4082f22ec745a.jpg"
    }
}