{
    "id": "bd77f114-93f9-452b-a21a-c3a4aadf16a8",
    "created_at": "2023-01-12T14:59:20.665059Z",
    "updated_at": "2025-03-27T02:17:16.850658Z",
    "deleted_at": null,
    "sha1_hash": "a6f1e0e38ebc4110f5a7f3bb43891745e7f1cae6",
    "title": "2018-03-30 - BADFLICK is not so bad!",
    "authors": "",
    "file_creation_date": "2022-05-28T19:07:28Z",
    "file_modification_date": "2022-05-28T19:07:28Z",
    "file_size": 404864,
    "plain_text": "# BADFLICK is not so bad!\n\n**blog.amossys.fr/badflick-is-not-so-bad.html**\n\n\n-----\n\nWe present here an in-depth analysis of the BADFLICK backdoor, which is used by the\nTEMP.Periscope group also known as \"Leviathan\".\n\n## Overview\n\n[Recently the malware analysts from FireEye](https://www.fireeye.com/blog/threat-research/2018/03/suspected-chinese-espionage-group-targeting-maritime-and-engineering-industries.html) [1] detected a re-emerging threat targeting\nmaritime and engineering industries. Moreover, they made a connection between this\ncampaign and a group which they tracked since 2013 and which is also known as\n[\"Leviathan\"](https://www.proofpoint.com/us/threat-insight/post/leviathan-espionage-actor-spearphishes-maritime-and-defense-targets) [2] by the researchers of the ProofPoint security firm.\n\n## Description of the BADFLICK malware\n\n\n-----\n\nThe BADFLICK malware, as described in the FireEye s blog post seems to be a new\nbackdoor. Besides, we have not found a detailed description of the BADFLICK's inner\nmechanisms, so we propose to do it here in this blog post.\n\n## In-depth analysis of the BADFLICK backdoor\n\n Overview\n\nBADFLICK is a PE32 executable and no trace of any kind of obfuscation or anti-debug\ntechnique is present.\n\nAlso, the backdoor does not try to be persistent in any way. As its behaviour suggests,\nBADFLICK is just a temporary reverse shell, downloader and launcher for a potentially more\nadvanced backdoors or exploits.\n\n## An inoffensive threat\n\nSurprisingly, the historical BADFLICK sample referenced in the FireEye blogpost\n( bd9e4c82bf12c4e7a58221fc52fed705 ) is bugged and it crashes during an aPLib\ncompression routine.\n\nThe `aPsafe_pack function of the library needs a working buffer allocated by the caller.`\nBADFLICK allocates one global buffer, whose size is defined by a global variable. Besides,\nthis buffer can grow when needed.\n\nHowever on the sample given by FireEye, the global size is already set to the 0xA0000, but\nthe buffer is not allocated. Thus, the code considers the buffer as already allocated and gives\na wrong pointer to the `aPsafe_pack function.`\n\n\n-----\n\nTo proceed further our investigation, we patched these two global variables, setting them to\nzero to trigger the initial allocation. We also patched the malware's configuration IP address\nto redirect its traffic to our own local fake Command and Control (CC) server.\n\n## Description of BADFLICK's behaviour\n\nBADFLICK's behaviour is driven by a configuration string hard-coded in the data section of\nthe malware: `\"1|103.243.175.181|80|5|xxxxxxxxxxxxxxxxxxxxxxx\" .`\n\nEach option is separated by a \"|\" character. This string can be interpreted as:\n\n1: this number represents the current state of the backdoor. The statical analysis let us\nguess three different possible states (see below) ;\n103.243.175.181: IP address of the CC server ;\n80: the TCP port ;\n5: the number of minutes to wait between two connections.\n\nRegarding the 103.243.175.181 server, it resolved to the \"update.wsmcoff.com\" domain at\nthe beginning of 2018. \"wsmcoff.com\" extends other subdomains such as \"api.wsmcoff.com\",\n\"kc.wsmcoff.com\", \"info.wsmcoff.com\" or \"store.wsmcoff.com\", which all seem quite\nmalicious regarding their quite generic names. \"update.wsmcoff.com\" now resolves to\n185.174.173.157.\n\n### Default startup routine\n\nOnce its configuration is parsed, BADFLICK starts sending some information about the\nvictim computer to its CC server. This information contains: - the computer name; - its IP\naddress; - statistics about the CPU, the total size of the memory, etc.; - constant string\n```\n\"winMain static green\" .\n\n```\nBADFLICK uses a custom TCP-based protocol where data is compressed. Copyright strings\n[in the binary tell us that the aPLib library is embedded in BADFLICK's code and potentially](http://ibsensoftware.com/products_aPLib.html)\nused for this purpose.\n\naPLib copyright string\n\n### Description of the network protocol\n\n\n-----\n\nThis protocol is composed of three nested layers:\n\n\n-----\n\n-----\n\n**Format of each layer of the network protocol**\n\n**Layer 1**\n\nThe first layer starts with a header composed of nine bytes followed by an aPLib archive:\n\nthe first DWORD of the header is the archive's size;\nthe next DWORD is a dynamic value computed by BADFLICK, wich equals to\n0x2C0134FE minus the aPLib archive size and it is used later to unpack the next layer;\nthe 9th byte is used as a boolean to show if the data that follows is compressed or not.\n\nOur tests and our analysis of the code seems to show that all the data sent by BADFLICK is\ncompressed and thus this 9th byte always equals to 0x1.\n\n**Layer 2**\n\nThe second layer, which starts at the offset 9, is a compressed aPLib archive with its magic\nstring \"AP32\" altered.\n\nTo restore this archive and unpack it, BADFLICK computes a XOR between the first DWORD\nand the dynamic magic value stored in the layer 1. The result is therefore always\n0x32335041 which is \"AP32\" in ASCII.\n\nAt this point, the layer 2 is a valid aPLib archive. It starts with an header composed of six\nDWORDs:\n\n\"AP32\" magic value ;\nheader size (24);\ncompressed data size;\ncompressed data CRC32;\nuncompressed data size;\nuncompressed data CRC32.\n\nIn succession, there is the packed data.\n\nThe point of the alteration of the aPLib archive magic is to hide it because it would be a good\nfit for a network signature. However, our tests showed that the system information collected\nand send by BADFLICK are almost always smaller than 256 bytes. Therefore, even if the\n\"AP32\" magic string is altered with a value which depends on the size of the data sent, the\nthree higher bytes of the dynamic value are always the same: 34 01 2c.\n\nFurthermore, it also completely forgets to hide the header size of the aPLib compressed\nbuffer which is the constant 24, and the higher bytes of the compressed data size.\n\n\n-----\n\nWe can leverage the particularities of BADFLICK s network protocol to produce a snort rule\nto detect the exchanges between BADFLICK and its CC presented at the end of this blog\npost.\n\nTo obtain the last layer which is the uncompressed data, BADFLICK uses the\n```\naP_depack_safe function of the aPLib library.\n\n```\n**Layer 3**\n\nOnce uncompressed, the last layer also starts with a header of five bytes followed by the\ndata: - the first byte in the header represents the type of request sent; - the last 4 bytes are a\nDWORD value which is the data size.\n\nFinally, the data is copied in succession.\n\n## BADFLICK's capabilities\n\nBADFLICK's code is clear enough to guess the next operations when BADFLICK success to\nreach it.\n\nWhen the connection is established, the backdoor creates a new thread waiting for the\ncommands coming from the CC. In this loop, BADFLICK accepts three different commands.\nThe first byte (printable) in the layer 1 packet defines their types:\n\n\"/\" means that BADFLICK will send its current configuration to the CC;\n\"3\" sets up a reverse shell;\n\"8\" forces BADFLICK to create another thread that implements seven new commands\nrelated to file system manipulation.\n\nThe \"8\" commands are:\n\n\":\": listing drives;\n\">\": upload files to the CC server;\n\"@\": download files;\n\"K\": search files;\n\"L\": create directory;\n\"M\": delete a file or directory;\n\"N\": move a file.\n\nThe following scheme sums up the interaction between BADFLICK and its CC server:\n\n\n-----\n\n-----\n\n**Summary of all the exchanges between BADFLICK and its CC server**\n\n## Alternative configurations\n\nThe BADFLICK's code shows an alternative configuration mode different from \"1\", which\nenables a \"stealthier\" version of the backdor.\n\nThis configuration expects four arguments passed on the command line.\n\nIf only three parameters are passed on the command line, BADFLICK uses a well-known\nprocess hollowing technique, similar to the \"MockDLL\" tool used by the \"Leviathan\" group.\n\nThe purpose of MockDLL is to hide the execution of a process by changing its name. To do\nso, MockDll creates a mock process (defaulting to a `regsvr32 instance) and then unmaps`\nits address space to replace it with the code and data of another hidden executable.\n\nBADFLICK reuses this same principle to launch a new instance of itself with five arguments\nin a `regsvr32 instance. The first three parameters are the backdoor configuration (ip`\naddress, port number and time to wait between two connections). The fourth argument is the\nstring \"go\" and the last argument is the path of the BADFLICK binary.\n\nFour parameters configuration\n\nTherefore, the four arguments configuration is just the launcher stage for the \"stealthier\"\nvariant of the backdoor.\n\nWhen five arguments are passed on the command line, BADFLICK will also initialise a\ncommunication with the CC server. However, the string sent to the server is modified. The\nlast line `\"winMain static green\" is replaced by another message` `\"[Green] pid=%d`\n```\ntid=%d modulePath=%s|\" which contains also the current process id, thread id and module\n\n```\nname of the backdoor.\n\nBesides, BADFLICK takes two additional precautions before contacting the CC: 1. It checks\nthat the fourth parameters is indeed the string \"go\". 2. It deletes the files specified by the last\nparameter. Hence, BADFLICK removes itself from the file system of the victim.\n\nStealthier version of the backdoor\n\nBesides process hollowing artifacts (process with its main module memory section not\nbacked to an existing file/to its regular file), a running process with a \"go\" commandline\nargument folowed by a path might be a good system IOC.\n\n## Conclusion\n\n\n-----\n\nIt is not clear why this malware sample has gone public, as a simple test would have made\nclear that it cannot run and may trigger some alerts when crashing. However, it remains quite\nsimple to detect, either from memory or the network, and we believe it is only used as a first\nstage malware to recon and drop other and more advanced ones. We actually believe the\n\"wsmcoff.com\" subdomains are malicious and that outgoing connections to them should\ntrigger alarms.\n\n## Snort rule\n```\nalert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:\"BADFLICK First Packet\"; content:\n\"|00 00 00|\"; offset: 1; content: \"|34 01 2c 01|\"; offset: 5; content: \"|64 32 1e 18\n00 00 00|\"; offset: 10; sid:1;)\n\n References\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-03-30 - BADFLICK is not so bad!.pdf"
    ],
    "report_names": [
        "2018-03-30 - BADFLICK is not so bad!.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "16f2436b-5f84-44e3-a306-f1f9e92f7bea",
            "created_at": "2023-01-06T13:46:38.745572Z",
            "updated_at": "2025-03-27T02:00:02.907444Z",
            "deleted_at": null,
            "main_name": "APT40",
            "aliases": [
                "ISLANDDREAMS",
                "TEMP.Jumper",
                "BRONZE MOHAWK",
                "GADOLINIUM",
                "KRYPTONITE PANDA",
                "TA423",
                "MUDCARP",
                "Gingham Typhoon",
                "TEMP.Periscope",
                "G0065",
                "ATK29",
                "Red Ladon",
                "ITG09"
            ],
            "source_name": "MISPGALAXY:APT40",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "59be3740-c8c7-47aa-84c8-e80d0cb7ea3a",
            "created_at": "2022-10-25T15:50:23.481057Z",
            "updated_at": "2025-03-27T02:00:55.480695Z",
            "deleted_at": null,
            "main_name": "Leviathan",
            "aliases": [
                "MUDCARP",
                "Kryptonite Panda",
                "Gadolinium",
                "BRONZE MOHAWK",
                "TEMP.Jumper",
                "APT40",
                "TEMP.Periscope",
                "Gingham Typhoon"
            ],
            "source_name": "MITRE:Leviathan",
            "tools": [
                "Windows Credential Editor",
                "BITSAdmin",
                "HOMEFRY",
                "Derusbi",
                "at",
                "BLACKCOFFEE",
                "BADFLICK",
                "gh0st RAT",
                "PowerSploit",
                "MURKYTOP",
                "NanHaiShu",
                "Orz",
                "Cobalt Strike",
                "China Chopper"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "b9806584-4d82-4f32-ae97-18a2583e8d11",
            "created_at": "2022-10-25T16:07:23.787833Z",
            "updated_at": "2025-03-27T02:02:09.978883Z",
            "deleted_at": null,
            "main_name": "Leviathan",
            "aliases": [
                "APT 40",
                "ATK 29",
                "Bronze Mohawk",
                "Gadolinium",
                "Gingham Typhoon",
                "ISLANDDREAMS",
                "ITG09",
                "Kryptonite Panda",
                "Mudcarp",
                "Red Ladon",
                "TA423",
                "TEMP.Jumper",
                "TEMP.Periscope"
            ],
            "source_name": "ETDA:Leviathan",
            "tools": [
                "AIRBREAK",
                "Agent.dhwf",
                "Agentemis",
                "AngryRebel",
                "BADFLICK",
                "BlackCoffee",
                "CHINACHOPPER",
                "China Chopper",
                "Cobalt Strike",
                "CobaltStrike",
                "DADJOKE",
                "Dadstache",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "Farfli",
                "GRILLMARK",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEFRY",
                "Hellsing Backdoor",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "LUNCHMONEY",
                "Living off the Land",
                "MURKYTOP",
                "Moudour",
                "Mydoor",
                "NanHaiShu",
                "Orz",
                "PCRat",
                "PNGRAT",
                "PlugX",
                "RedDelta",
                "SeDLL",
                "Sensocode",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Xamtrav",
                "ZXShell",
                "ZoxPNG",
                "cobeacon",
                "gresim",
                "scanbox"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "83025f5e-302e-46b0-baf6-650a4d313dfc",
            "created_at": "2024-05-01T02:03:07.971863Z",
            "updated_at": "2025-03-27T02:05:17.278721Z",
            "deleted_at": null,
            "main_name": "BRONZE MOHAWK",
            "aliases": [
                "Flaccid Rose ",
                "GADOLINIUM ",
                "Kryptonite Panda ",
                "Leviathan ",
                "Nanhaishu ",
                "Pickleworm ",
                "Temp.Jumper ",
                "Temp.Periscope ",
                "APT40 "
            ],
            "source_name": "Secureworks:BRONZE MOHAWK",
            "tools": [
                " BlackCoffee",
                " China Chopper",
                " Cobalt Strike",
                " Derusbi",
                " Derusbi Trojan",
                " FUSIONBLAZE",
                " GreenCrash",
                " HOMEFRY",
                " MURKYTOP",
                " Metasploit",
                " Metasploit / Meterpreter",
                " Nanhaishu",
                " Orz",
                " ScanBox",
                " SeDll",
                "AIRBREAK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535560,
    "ts_updated_at": 1743041836,
    "ts_creation_date": 1653764848,
    "ts_modification_date": 1653764848,
    "files": {
        "pdf": "https://archive.orkl.eu/a6f1e0e38ebc4110f5a7f3bb43891745e7f1cae6.pdf",
        "text": "https://archive.orkl.eu/a6f1e0e38ebc4110f5a7f3bb43891745e7f1cae6.txt",
        "img": "https://archive.orkl.eu/a6f1e0e38ebc4110f5a7f3bb43891745e7f1cae6.jpg"
    }
}