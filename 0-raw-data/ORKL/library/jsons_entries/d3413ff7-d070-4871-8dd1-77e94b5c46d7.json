{
    "id": "d3413ff7-d070-4871-8dd1-77e94b5c46d7",
    "created_at": "2023-01-12T15:10:14.812377Z",
    "updated_at": "2025-03-27T02:09:18.672966Z",
    "deleted_at": null,
    "sha1_hash": "6e449d970e95bb5b082feeb1d2925be45ab2bb0e",
    "title": "2020-11-06 - Last, but Not Least- Defray777",
    "authors": "",
    "file_creation_date": "2022-05-28T23:47:33Z",
    "file_modification_date": "2022-05-28T23:47:33Z",
    "file_size": 434469,
    "plain_text": "# When Threat Actors Fly Under the Radar: Vatet, PyXie and Defray777\n\n**unit42.paloaltonetworks.com/vatet-pyxie-defray777/3**\n\nRyan Tracey, Drew Schmitt November 7, 2020\n\nBy [Ryan Tracey and](https://unit42.paloaltonetworks.com/author/ryan-tracey/) [Drew Schmitt](https://unit42.paloaltonetworks.com/author/drew-schmitt/)\n\nNovember 6, 2020 at 6:15 PM\n\n[Category: Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Ransomware,](https://unit42.paloaltonetworks.com/category/ransomware/) [Unit 42](https://unit42.paloaltonetworks.com/category/unit-42/)\n\nTags: [Defray777,](https://unit42.paloaltonetworks.com/tag/defray777/) [PyXie,](https://unit42.paloaltonetworks.com/tag/pyxie/) [Vatet](https://unit42.paloaltonetworks.com/tag/vatet/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/vatet-pyxie-defray777/)\n\n## Last, but Not Least: Defray777\n\n[Defray777 is an elusive family of ransomware also known as Ransom X and](https://www.bleepingcomputer.com/news/security/new-ransom-x-ransomware-used-in-texas-txdot-cyberattack/) [RansomExx. Although it has recently been covered in the news](https://www.bleepingcomputer.com/news/security/montreals-stm-public-transport-system-hit-by-ransomware-attack/?_hsenc=p2ANqtz--TMeD-DcOlE_JbE5-1DKkStefcr1qAFppJIfTyGcye3y_Z5SsaryNC0zrBu7qu5iPsiwx0&utm_campaign=Ad%20hoc%20social%20posts%20&utm_content=143516149&utm_medium=social&utm_source=twitter&hss_channel=tw-29175108)\nas a new family, it has been in use since at least 2018 and is responsible for a number of high-profile ransomware incidents -- as detailed in\nthe articles we linked to.\n\nDefray777 runs entirely in memory, which is why there have been so few publicly discussed samples to date. In several recent incidents,\nDefray777 was loaded into memory and executed by Cobalt Strike, which was delivered by the Vatet loader.\n\nDuring our research, we discovered multiple decryptors for this ransomware family, going back as early as 2018. Reviewing decryptors from\n2018 until present shows that there has been consistency in the ransomware’s encryption and decryption methodology, as well as the use of\n[Themida for packing their decryptors. Table 10 shows a list of Defray777 decryptors discovered in AutoFocus, with a list of organizations that](https://www.oreans.com/themida.php)\nsuffered ransomware attacks. This shows that Defray777 has been consistently active since 2018.\n\n**Date** **Victim**\n\n12/7/2018 Education Organization\n\n2/4/2019 Healthcare Organization\n\n3/1/2019 Technology Organization\n\n3/15/2019 Education Organization\n\n8/8/2019 Healthcare Organization\n\n8/25/2019 Education Organization\n\n8/28/2019 Transportation and Logistics Organization\n\n9/3/2019 Legal Organization\n\n\n-----\n\n9/6/2019 Education Organization\n\n9/26/2019 Healthcare Organization\n\n10/30/2019 Government Organization\n\n11/1/2019 Healthcare Organization\n\n2/4/2020 Technology Organization\n\n2/10/2020 Government Organization\n\n3/16/2020 Food Organization\n\n10/17/2020 Finance Organization\n\n_Table 10. Defray777 ransomware attacks listed by date and victim._\n\nFigure 21.\n\nDefray777 decryptor.\nWe have examined several recent Defray777 samples, including one sample that was obtained directly from memory during a recent incident.\nOur in-depth analysis resulted in the findings outlined below.\n\n**Decrypted Strings**\n\nThe string decryption process is the same as we saw with PyXie. The following strings were decrypted from a recent Defray777 sample:\n\n\n-----\n\nAlready active [%s]\n+%u (%u) files done [%s] [%u KB/s]\n\nStarted (PID: %u; Workers: %u; AES-%s) [%s]\n\nComplete (+%u (%u) files done) [%s]\n\nWork time: %d:%02d:%02d\n\nUnable to get computer name\n\nCryptoGuard\n\nkernel32.dll\n\nConvertStringSecurityDescriptorToSecurityDescriptorW\n\nadvapi32.dll\n\nIsWow64Process\n\nSystemDrive\n\nKiUserExceptionDispatcher\n\n_Table 11. Defray777 encrypted strings._\n\n**Prioritizing Defray777 on the Impacted System**\n\nWhile deep diving on a recovered Defray777 sample, we found that Defray777 exhibits the following notable characteristics regarding the\nprioritization of threads and processes:\n\nDuring execution, the ransomware uses SetProcessPriorityBoost to prioritize the threads of the Defray777 process.\nDefray777 additionally focuses on creating and prioritizing threads for encryption by calling SetThreadAffinityMask and\nSetThreadPriorityBoost.\nDefray777 uses multithreading to improve ransomware performance.\n\nFigure 22. Prioritization of\n\nDefray777 threads during execution.\n\n**Killing “Undesirable” Processes**\n\nAs part of the execution workflow, Defray777 creates threads that will be responsible for the killing of processes that the threat actors deem to\nbe “undesirable.” The execution continues by getting a listing of processes using CreateToolhelp32Snapshot before iterating through all active\nprocesses (with the exception of itself) and killing all “undesirable” processes. Defray777 specifically targets process that can be opened with\nthe desired access of SYNCHRONIZE | PROCESS_QUERY_INFORMATION | PROCESS_VM_WRITE | PROCESS_VM_READ |\nPROCESS_VM_OPERATION | PROCESS_CREATE_THREAD.\n\nDefray777 excludes all processes that contain the system file path in their full image path. Additionally, the ransomware will exclude the\nfollowing processes from being killed during execution:\n\npowershell.exe rundll32.exe\n\nwefault.exe explorer.exe\n\nvmnat.exe\n\n_Table 12. Excluded processes._\n\n**Stopping System Services**\n\nDuring execution, Defray777 stops the following services from running:\n\nAcronis VSS Provider MSExchangeADTopology MSSQLSERVER SQLAgent$PRACTT\n\nAcronisAgent MSExchangeAntispamUpdate MSSQLServerADHelper SQLAgent$PROD\n\nAcronixAgent MSExchangeEdgeSync MSSQLServerADHelper100 SQLAgent$PROFXE\n\n\n-----\n\nAcrSch2Svc MSExchangeES MSSQLServerOLAPService SQLAgent$SBSMON\n\nAntivirus MSExchangeFBA MySQL57 SQLAgent$SHAREP\n\nARSM MSExchangeFDS MySQL80 SQLAgent$SOPHOS\n\nAVP MSExchangeIS NetMsmqActivator SQLAgent$SQL_200\n\nBackupExecAgentAccelerator MSExchangeMailboxAssistants nginx SQLAgent$SQLEXP\n\nBackupExecAgentBrowser MSExchangeMailboxReplication ntrtscan SQLAgent$SYSTEM\n\nBackupExecDeviceMediaService MSExchangeMailSubmission OracleClientCache80 SQLAgent$TPS\n\nBackupExecJobEngine MSExchangeMGMT OracleServiceXE SQLAgent$TPSAMA\n\nBackupExecManagementService MSExchangeMTA OracleXETNSListener SQLAgent$VEEAMS\n\nBackupExecRPCService MSExchangeProtectedServiceHost PDVFSService SQLAgent$VEEAMS\n\nBackupExecVSSProvider MSExchangeRepl POP3Svc SQLBrowser\n\nbedbg MSExchangeRPC ReportServer SQLsafe Backup Se\n\nDbxSvc MSExchangeSA ReportServer$SQL_2008 SQLsafe Filter Servi\n\nDCAgent MSExchangeSearch ReportServer$SYSTEM_BGC SQLSafeOLRServic\n\nEhttpSrv MSExchangeServiceHost ReportServer$TPS SQLSERVERAGEN\n\nekrn MSExchangeSRS ReportServer$TPSAMA SQLTELEMETRY\n\nEnterprise Client Service MSExchangeThrottling RESvc SQLTELEMETRY$E\n\nEPSecurityService MSExchangeTransport sacsvr SQLWriter\n\nEPUpdateService MSExchangeTransportLogSearch SamSs SstpSvc\n\nEraserSvc11710 msftesql$PROD SAVAdminService svcGenericHost\n\nEsgShKernel MSOLAP$SQL_2008 SAVService swi_filter\n\nESHASRV MSOLAP$SYSTEM_BGC SDRSVC swi_service\n\nFA_Scheduler MSOLAP$TPS SepMasterService swi_update\n\nIISAdmin MSOLAP$TPSAMA ShMonitor swi_update_64\n\nIMAP4Svc MSSQL$BKUPEXEC Smcinst Symantec System R\n\nKAVFS MSSQL$ECWDB2 SmcService TmCCSF\n\nKAVFSGT MSSQL$PRACTICEMGT SMTPSvc tmlisten\n\nkavfsslp MSSQL$PRACTTICEBGC SNAC TrueKey\n\nklnagent MSSQL$PROD SntpService TrueKeyScheduler\n\nmacmnsvc MSSQL$PROFXENGAGEMENT Sophos Agent TrueKeyServiceHelp\n\nmasvc MSSQL$SBSMONITORING Sophos AutoUpdate Service UI0Detect\n\nMBAMService MSSQL$SHAREPOINT Sophos Clean Service Veeam Backup Cata\nService\n\nMBEndpointAgent MSSQL$SOPHOS Sophos Device Control Service VeeamBackupSvc\n\nMcAfeeEngineService MSSQL$SQL_2008 Sophos File Scanner Service VeeamBrokerSvc\n\nMcAfeeFramework MSSQL$SQLEXPRESS Sophos Health Service VeeamCatalogSvc\n\nMcAfeeFrameworkMcAfeeFramework MSSQL$SYSTEM_BGC Sophos MCS Agent VeeamCloudSvc\n\nMcShield MSSQL$TPS Sophos MCS Client VeeamDeploymentS\n\nMcTaskManager MSSQL$TPSAMA Sophos Message Router VeeamDeploySvc\n\nmfefire MSSQL$VEEAMSQL2008R2 Sophos Safestore Service VeeamEnterpriseMa\n\n\n-----\n\nmfemms MSSQL$VEEAMSQL2012 Sophos System Protection\nService\n\n\nVeeamHvIntegration\n\n\nmfevtp MSSQLFDLauncher Sophos Web Control Service VeeamMountSvc\n\nMMS MSSQLFDLauncher$PROFXENGAGEMENT sophossps VeeamNFSSvc\n\nMongoDB MSSQLFDLauncher$SBSMONITORING SQL Backups VeeamRESTSvc\n\nmozyprobackup MSSQLFDLauncher$SHAREPOINT SQLAgent$BKUPEXEC VeeamTransportSvc\n\nMsDtsServer MSSQLFDLauncher$SQL_2008 SQLAgent$CITRIX_METAFRAME W3Svc\n\nMsDtsServer100 MSSQLFDLauncher$SYSTEM_BGC SQLAgent$CXDB wbengine\n\nMsDtsServer110 MSSQLFDLauncher$TPS SQLAgent$ECWDB2 WRSVC\n\nMSExchangeAB MSSQLFDLauncher$TPSAMA SQLAgent$PRACTTICEBGC Zoolz 2 Service\n\n_Table 13. Services stopped by Defray777._\n\n**File Encryption**\n\nBased on a recent Defray777 sample recovered from memory, the ransomware will get a listing of all logical drives on the system using a call\nto GetLogicalDriveStringsW before iterating through each drive to encrypt files using the following process:\n\nTo begin, Defray777 checks for whether the processor feature PF_XMMI64_INSTRUCTIONS_AVAILABLE is present on the impacted\nsystem.\n\nIf enabled, Defray777 knows that SSE2 is supported and more complex mathematical operations are possible.\nDefray777 will also determine if the processor is capable of using AES-NI for improved encryption performance.\nAs encryption begins, a ransom note will be created in each directory where files will be encrypted.\n\nThe name of the ransom note will vary. However, from our research, the ransom notes most commonly contain a combination of\nexclamation points, the string “README,” and a reference to the victim name.\nExample: !!!_IMPACTED_Client_README_!!!.txt\nThe file contents will be encrypted using an on-the-fly generated AES key that gets encrypted with RSA-4096 and stored in the file footer\nin a 512-byte block.\nThe encrypted file will be renamed by appending an extension that consists of a unique victim identifier and a randomized eight-digit\nhexadecimal number.\n\nExample: .v1ct1m-1bc461ac\n\nFigure 23. Recent example of a\n\nDefray777 ransom note.\nSpecifically, the encryption mechanism consists of the following steps:\n\nDynamically generate a 32-byte AES key.\nEncrypt the file with AES-256 in ECB mode using 16-byte blocks.\nEncrypt the AES key with RSA-4096 and append the 0x200 byte cipher text to the end of the encrypted file.\n\n**Encryption Exclusions**\n\nDuring the encryption process, Defray777 aims to encrypt as many files as possible without impacting the system’s core functionality. To\naccomplish this, Defray777 uses a set of excluded folders, files and file extensions that will not be encrypted during execution.\n\nExcluded Folders:\n\n\\windows\\system32\\ \\windows\\syswow64\\ \\windows\\system\\\n\n\\windows\\winsxs\\ \\appdata\\roaming\\ \\appdata\\local\\\n\n\\appdata\\locallow\\ \\all users\\microsoft\\ \\inetpub\\logs\\\n\n\n-----\n\n:\\boot\\ :\\perflogs\\ :\\programdata\\\n\n:\\drivers\\ :\\wsus\\ :\\efstmpwp\\\n\n:\\$recycle.bin\\ :\\EFSTMPWP\\ crypt_detect\n\ncryptolocker ransomware\n\n_Table 14. Folders excluded from encryption by Defray777._\n\nExcluded files:\n\niconcache.db thumbs.db ransomware ransom\n\ndebug.txt boot.ini desktop.ini autorun.inf\n\nntuser.dat ntldr ntdetect.com bootfont.bin\n\nbootsect.bak\n\n_Table 15. Files excluded from encryption by Defray777._\n\nIt is also important to note that Defray777 adds the name of the ransom note into the excluded files list.\n\nExcluded extensions:\n\n.ani .cab .cpl .cur .diagcab\n\n.diagpkg .dll .drv .hlp .icl\n\n.icns .ico .iso .ics .lnk\n\n.idx .mod .mpa .msc .msp\n\n.msstyles .msu .nomedia .ocx .prf\n\n.rtp .scr .shs .spl .sys\n\n.theme .themepack .exe .bat .cmd\n\n.url .mui\n\n_Table 16. Extensions excluded from encryption by Defray777._\n\n**Searching for Unmapped File Shares**\n\nDuring execution, Defray777 uses WNetOpenEnumW and WNetEnumResourceW to search for file shares that may contain files that could be\nencrypted. This tactic has been seen amongst other ransomware variants in the wild to encrypt files that are accessible via unmapped file\nshares.\n\n\n-----\n\nFigure 24. Defray777 enumerating\n\nnetwork resources.\n\n**Anti-Forensic Measures**\n\nAfter all files are encrypted on the system, Defray777, like many other ransomware variants, implements common anti-forensics measures to\nremove as much evidence of the intrusion as possible and make it extremely difficult for the system to be recovered without a backup.\nAlthough these commands are common amongst other ransomware variants, Defray777 runs commands post-encryption, which means that\nwhen security tools alert or take action against Defray777, the files have already been encrypted.\n\nCommands executed by Defray777:\n\ncipher.exe /w:[DRIVE]\n\nfsutil.exe usn deletejournal /D [DRIVE]\n\nwbadmin.exe delete catalog -quiet\n\nbcdedit.exe /set {default} recoveryenabled no\n\nbcdedit.exe /set {default} bootstatuspolicy ignoreallfailures\n\nschtasks.exe /Change /TN \"\\Microsoft\\Windows\\SystemRestore\\SR\" /disable\n\nwevtutil.exe cl Application\n\nwevtutil.exe cl System\n\nwevtutil.exe cl Setup\n\nwevtutil.exe cl Security\n\nwevtutil.exe sl Security /e:false\n\n_Table 17. Anti-forensic commands executed by Defray777._\n\nRegistry keys modified:\n\n\\Software\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\\DisableConfig\n\\Software\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\\DisableSR\n\n\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore\\DisableSR\n\n\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore\\DisableConfig\n\n_Table 18. Registry Keys Modified by Defray777._\n\n**Defray777’s Port to Linux**\n\nDuring the course of our research, we found that Defray777 ransomware has been ported over to Linux. Before Defray777, ransomware that\nimpacted both Windows and Linux operating systems was limited to being written in Java or scripting languages such as Python. These\nransomware variants would be considered cross-functional since they were written in a single language that must be installed and supported\nby both operating systems. Defray777’s port to Linux ensures that the ransomware has standalone executables for each platform with no\nexternal dependencies.\n\nA ZIP archive was uploaded to a public malware repository on Oct. 17, 2020 that contained a Windows executable that was identified as a\nDefray777 decryptor. Additionally included in this ZIP archive was an ELF binary named decryptor64. Analysis of this binary determined it to be\nanother Defray777 decryptor that had been ported to Linux.\n\n\n-----\n\ned t t e dea t at t e e ay be u e s o s o e ay t e d, e bega u t g uto ocus a d qu c y u co e ed a\nversion of the ransomware encryptor.\n\nReviewing this sample further indicated that it was uploaded in August 2020. As of early October 2020, there appear to be zero detections by\nantivirus (AV) in VirusTotal for the Linux version of Defray777.\n\nA deeper review of the Linux and Windows variants of Defray777 determined that the encryption and decryption processes used were nearly\nidentical. In fact, by generating our own RSA key pair and modifying the binaries, we were able to confirm that the encryptors and decryptors\nfor both operating systems were interchangeable.\n\nUnlike the Windows versions, the developers didn’t seem to put any effort into protecting the Linux samples. To our surprise, the binaries we\nanalyzed still had their symbols intact, which made reversing them quite a bit easier.\n\nFigure 25. Named functions listing from ELF version of\n\nDefray777.\nOne of the biggest differences between the Windows and Linux variants is the logic that determines which files to encrypt. The Windows\nversion will recurse the file system and encrypt anything that isn’t explicitly excluded. In contrast, the Linux variant will only encrypt directories\nspecified in a command line argument.\n\n[Continue reading: Linking Vatet, PyXie and Defray777](https://unit42.paloaltonetworks.com/vatet-pyxie-defray777/4)\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-06 - Last, but Not Least- Defray777.pdf"
    ],
    "report_names": [
        "2020-11-06 - Last, but Not Least- Defray777.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8a33d3ac-14ba-441c-92c1-39975e9e1a73",
            "created_at": "2023-01-06T13:46:39.195689Z",
            "updated_at": "2025-03-27T02:00:03.01861Z",
            "deleted_at": null,
            "main_name": "Ghostwriter",
            "aliases": [
                "PUSHCHA",
                "Storm-0257",
                "DEV-0257",
                "UAC-0057",
                "UNC1151",
                "TA445"
            ],
            "source_name": "MISPGALAXY:Ghostwriter",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536214,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653781653,
    "ts_modification_date": 1653781653,
    "files": {
        "pdf": "https://archive.orkl.eu/6e449d970e95bb5b082feeb1d2925be45ab2bb0e.pdf",
        "text": "https://archive.orkl.eu/6e449d970e95bb5b082feeb1d2925be45ab2bb0e.txt",
        "img": "https://archive.orkl.eu/6e449d970e95bb5b082feeb1d2925be45ab2bb0e.jpg"
    }
}