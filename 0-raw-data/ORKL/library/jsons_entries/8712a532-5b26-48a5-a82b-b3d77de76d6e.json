{
    "id": "8712a532-5b26-48a5-a82b-b3d77de76d6e",
    "created_at": "2023-01-12T15:02:05.369746Z",
    "updated_at": "2025-03-27T02:15:38.186351Z",
    "deleted_at": null,
    "sha1_hash": "20e7fef020637af34df9a4aa47c23c9edd25ac6a",
    "title": "2020-09-18 - Reverse Engineering Dridex and Automating IOC Extraction",
    "authors": "",
    "file_creation_date": "2022-05-28T17:12:40Z",
    "file_modification_date": "2022-05-28T17:12:40Z",
    "file_size": 2838756,
    "plain_text": "# Reverse Engineering Dridex and Automating IOC Extraction\n\n**[appgate.com/blog/reverse-engineering-dridex-and-automating-ioc-extraction](https://www.appgate.com/blog/reverse-engineering-dridex-and-automating-ioc-extraction)**\n\nDridex[1] is a major banking trojan that appeared somewhere around 2011, continually\nevolving ever since.\n\n[2]\n\nThe APT (Advanced Persistence Threat) known as TA505 is associated to Dridex, as well\nas with other infamous malware such as TrickBot and Locky ransomware.\n\nOnce installed, Dridex can download additional files to provide more functionality to the\ntrojan. Simply put, there are four main components:\n\n\n-----\n\nIn the last few days, our team detected recent Dridex samples through our live hunting\nprocess and, after analyzing them, we’ve decided to publish an analysis of the main features\nimplemented by this threat that makes detection and analysis difficult.\n\nTherefore, in this post, we will focus on the second layer (Loader), showing the technical\ndetails regarding:\n\n1. Unpacking;\n2. Dynamic API Calls;\n3. Encrypted Strings;\n4. C2 Network Communication.\n\nIn addition, we are publishing a tool that statically extracts IOCs from the latest Dridex\nbinaries, as we believe that this can enable organizations to reduce analysis time spent\nduring incidents or prevent the malware family altogether.\n\n**1. Unpacking**\n\nUnpacking is an important step because Dridex doesn’t write the unpacked payload to disk,\ninstead, the custom packer loads it directly to memory and there it stays. First, to analyze\nand extract the IOCs, we must get the unpacked sample, and this is not a difficult task.\n\nYou can easily execute the packed sample and then run the amazing PE-sieve[3] tool, from\n[hasherezade, which will extract the payload from memory. However, if you are curious like us](https://twitter.com/hasherezade)\nand wants to understand how it works, the first step in the unpacking process is the\n\n\n-----\n\nallocation of an encrypted content into memory:\n\n_Encrypted DLL in Memory._\n\nThis data is an encrypted small DLL that is responsible for unpacking the Dridex loader. Also,\nwe noticed that the magic bytes (MZ) for the MS-DOS header was not present, probably to\navoid automatic filetype identifications.\n\n_Decrypted DLL in Memory._\n\nAfter the decryption process, the main executable transfers the execution to the allocated\nDLL, which unpacks the Dridex Loader and then replaces the main executable code with the\npayload’s code.\n\n\n-----\n\n_Dridex Payload in Memory._\n\n**2. Dynamic API Calls**\n\nDridex doesn’t have an import table like regular PE files. Instead, all the API calls are\ndynamically resolved by the malware using a custom technique to avoid detection by APIs\nand to make reverse engineering more difficult.\n\nTo resolve an API, it calls a “resolver” function passing two parameters, both custom hashes.\nThe first one is a hash for the DLL name that contains the API, and the second one is the\nhash of the API name that Dridex needs to resolve.\n\nThe way the API is resolved isn’t trivial, but in summary, if the API wasn’t already resolved by\nthe malware, it parses the DLL linked list, located in the process’ PEB (Process Environment\n\n\n-----\n\nBlock), generating a CRC32 hash for each DLL and API name and compares that with the\nones that was passed into the function. Aside from the CRC32 hash, the value is also\n“xored” with a custom key, making the values unique on each Dridex sample.\n\n_Dridex Searching for DLL Using Custom Hash._\n\nTherefore, in the example above, the first hash stands for “kernel32.dll”. Using this same\n[logic, we created a small IDA script which resolves API calls automatically and inserts a](https://github.com/appgate/labs/tree/master/dridex/ida)\ncomment where the function is called, so we can easily search where in the code certain\nDLLs or APIs are being used.\n\n_Block with Encrypted Strings._\n\nEach chunk contains one or more strings that are encrypted with RC4, where the key is the\nfirst 40 bytes (in little-endian format) of each block.\n\n\n-----\n\n_Decrypting Dridex Strings._\n\nAside from the encrypted strings, we also found plain text strings in this recent Loader that\nwere not present in older versions, which can be used for identification (Yara rule):\n\nbot\nvnc\nsocks\nuacme\nlist\ncve-2015-0057 (mod5)\nTrendMicro (mod9)\nNetChecker (mod10)\nrep: DllLoaded (dmod5)\nrep: DllStarted (dmod6)\nrep: NetGood (dmod7)\nrep: NetFail (dmod8)\nrep: NetPart (dmod9)\nrep: StartedInLo (dmod10)\nrep: StartedInHi (dmod11)\n\n**4. C2 Network Communication**\n\nThe loader is responsible for the initial C2 communication and for downloading additional\nfiles, such as the bot and the modules. Analyzing the function that does such\ncommunication, we could see that the command sent to the C2 is passed as a parameter,\nand it’s the CRC32 hash of the command string.\n\n\n-----\n\n_Function for C2 Communication._\n\nCuriously though, that despite using the hashes of the commands in the communication, this\nspecific sample has the same commands in the strings, as mentioned above, such as the\n\"list\" that requests a list of IPs to connect or the \"bot\" that is the command to download the\nnext stage.\n\nBefore doing the request, the botnet ID and the C2 addresses are parsed.\n\n_Dridex Parsing Command & Control IPs_\n\nThis information is stored in the PE “.data” section, represented in bytes, along with the\nDridex botnet ID.\n\n\n-----\n\n_Dridex C2 IPs._\n\nOnce these addresses are parsed, Dridex then sends a POST request to one of the C2\naddresses and, bypassing the SSL, we could see that the data is encrypted. If the server\ndoesn’t respond as expected, Dridex continues to send the same content to the other IPs.\n\n_Dridex POST Request to C2._\n\n\n-----\n\nAfter analyzing the function, we found that the malware uses the first 4 bytes as a checksum\nfor the encrypted bytes, with CRC32 hash.\n\n_Encrypted Network Data Checksum_\n\nIf the checksum matches, the data can be decrypted correctly. The algorithm used by Dridex\nis RC4 and the encryption/decryption key is stored among Dridex decrypted strings.\n\n_Decrypted Network Data._\n\nThe image below illustrates some of the main fields used in the first POST request made by\nthis Dridex sample.\n\n\n-----\n\n_Data Sent by Dridex to C2._\n\n**5. Automating IOC Extraction**\n\nAlong with this blog post, we are releasing a python script that automates the IOC extraction\nfrom the Dridex loader. These are the main features implemented by our “Dridex Analysis\nToolkit”:\n\nExtract Botnet ID;\nExtract C2 IP Addresses;\nDecrypt Strings;\nDecrypt Network Communication.\n\nFurthermore, since most Dridex payloads comes from memory dumps, the script also tries to\nunmap the PE file to disk, so it can get the right offsets to parse, example:\n\n\n-----\n\n_Extracting C2 Addresses from Dridex Payload Automatically._\n\nBy using the “-s” option, the script searches and decrypts the payload strings and prints any\npossible RC4 keys:\n\n\n-----\n\n_RC4 Keys Found by the Script._\n\nYou can then use these keys to decrypt any network communication by using the “-n” option:\n\n_Decrypted Network Data._\n\nThe script also writes the output data into a folder:\n\n_Script Output._\n\n**Conclusion**\n\nIn this post we show the main technical characteristics that makes Dridex a difficult malware\nto detect and analyze. By publishing this analysis and the automation script, our intention is\nto help analysts understand how key parts of Dridex work and to help organizations detect\nand extract Dridex IOCs as early as possible, so that appropriate actions are taken faster.\n\n**IOCs**\n\n**Packed Dridex Loader**\n\nd506f18f771ec417c27a6528c17f08ee9d180d40a0a9c6b6ef93b7a39304b96a\n\n**Unpacked Dridex Loader**\n\n756fa5527f4c564effbc69dd3b3d76e7196b869976eeae48c4b34f4ff25dfa5c\n\n**C2 Addresses**\n\n\n-----\n\n45.79.8[.]25:443\n\n185.201.9[.]197:9443\n\n217.160.78[.]166:4664\n\n108.175.9[.]22:33443\n\n**Botnet ID**\n\n12333\n\n**RC4 Keys**\n\nxrAuVcgsoW0BBPhAH5w5aQ1Q2UuZQidMhZYugaYvCPvgttsD9jQkM\n\nVTRBArv8sWNVqJ4WDs2rzCN2QMqXLb9fsEjtRZL6vW628p93i3iJe\n\n[1] [https://malpedia.caad.fkie.fra...](https://malpedia.caad.fkie.fraunhofer.de/details/win.dridex)\n\n[2] [https://malpedia.caad.fkie.fra...](https://malpedia.caad.fkie.fraunhofer.de/actor/ta505)\n\n[[3]](https://ag-staging.frb.io/admin/entries/blogs/32738-reverse-engineering-dridex-and-automating-ioc-extraction#_ftnref1) [https://github.com/hasherezade...](https://github.com/hasherezade/pe-sieve)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-09-18 - Reverse Engineering Dridex and Automating IOC Extraction.pdf"
    ],
    "report_names": [
        "2020-09-18 - Reverse Engineering Dridex and Automating IOC Extraction.pdf"
    ],
    "threat_actors": [
        {
            "id": "99cb4e5b-8071-4f9e-aa1d-45bfbb6197e3",
            "created_at": "2023-01-06T13:46:38.860754Z",
            "updated_at": "2025-03-27T02:00:02.937438Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "SectorJ04 Group",
                "Dudear",
                "G0092",
                "ATK103",
                "Hive0065",
                "Spandex Tempest",
                "GRACEFUL SPIDER",
                "GOLD TAHOE",
                "CHIMBORAZO",
                "SectorJ04"
            ],
            "source_name": "MISPGALAXY:TA505",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5e6b31a6-80e3-4e7d-8b0a-d94897ce9b59",
            "created_at": "2024-06-19T02:03:08.128175Z",
            "updated_at": "2025-03-27T02:05:17.400394Z",
            "deleted_at": null,
            "main_name": "GOLD TAHOE",
            "aliases": [
                "SectorJ04 ",
                "Spandex Tempest ",
                "TA505 ",
                "FIN11 "
            ],
            "source_name": "Secureworks:GOLD TAHOE",
            "tools": [
                " Cobalt Strike",
                " FlawedAmmy",
                " Get2",
                " GraceWire",
                " Malichus",
                " SDBbot",
                " ServHelper",
                " TrueBot",
                "Clop"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75d4d6a9-b5d1-4087-a7a0-e4a9587c45f4",
            "created_at": "2022-10-25T15:50:23.5188Z",
            "updated_at": "2025-03-27T02:00:55.489882Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "TA505",
                "Hive0065",
                "Spandex Tempest",
                "CHIMBORAZO"
            ],
            "source_name": "MITRE:TA505",
            "tools": [
                "AdFind",
                "Azorult",
                "FlawedAmmyy",
                "Mimikatz",
                "Dridex",
                "TrickBot",
                "Get2",
                "FlawedGrace",
                "Cobalt Strike",
                "ServHelper",
                "Amadey",
                "SDBbot",
                "PowerSploit"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e447d393-c259-46e2-9932-19be2ba67149",
            "created_at": "2022-10-25T16:07:24.28282Z",
            "updated_at": "2025-03-27T02:02:10.159466Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "ATK 103",
                "Chimborazo",
                "Gold Evergreen",
                "Gold Tahoe",
                "Graceful Spider",
                "Hive0065",
                "Operation Tovar",
                "Operation Trident Breach",
                "SectorJ04",
                "Spandex Tempest",
                "TA505",
                "TEMP.Warlock"
            ],
            "source_name": "ETDA:TA505",
            "tools": [
                "Amadey",
                "AmmyyRAT",
                "AndroMut",
                "Azer",
                "Bart",
                "Bugat v5",
                "CryptFile2",
                "CryptoLocker",
                "CryptoMix",
                "CryptoShield",
                "Dridex",
                "Dudear",
                "EmailStealer",
                "FRIENDSPEAK",
                "Fake Globe",
                "Fareit",
                "FlawedAmmyy",
                "FlawedGrace",
                "FlowerPippi",
                "GOZ",
                "GameOver Zeus",
                "GazGolder",
                "Gelup",
                "Get2",
                "GetandGo",
                "GlobeImposter",
                "Gorhax",
                "GraceWire",
                "Gussdoor",
                "Jaff",
                "Kasidet",
                "Kegotip",
                "Kneber",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Locky",
                "MINEBRIDGE",
                "MINEBRIDGE RAT",
                "MirrorBlast",
                "Neutrino Bot",
                "Neutrino Exploit Kit",
                "P2P Zeus",
                "Peer-to-Peer Zeus",
                "Philadelphia",
                "Philadephia Ransom",
                "Pony Loader",
                "Rakhni",
                "ReflectiveGnome",
                "Remote Manipulator System",
                "RockLoader",
                "RuRAT",
                "SDBbot",
                "ServHelper",
                "Shifu",
                "Siplog",
                "TeslaGun",
                "TiniMet",
                "TinyMet",
                "Trojan.Zbot",
                "Wsnpoem",
                "Zbot",
                "Zeta",
                "ZeuS",
                "Zeus"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535725,
    "ts_updated_at": 1743041738,
    "ts_creation_date": 1653757960,
    "ts_modification_date": 1653757960,
    "files": {
        "pdf": "https://archive.orkl.eu/20e7fef020637af34df9a4aa47c23c9edd25ac6a.pdf",
        "text": "https://archive.orkl.eu/20e7fef020637af34df9a4aa47c23c9edd25ac6a.txt",
        "img": "https://archive.orkl.eu/20e7fef020637af34df9a4aa47c23c9edd25ac6a.jpg"
    }
}