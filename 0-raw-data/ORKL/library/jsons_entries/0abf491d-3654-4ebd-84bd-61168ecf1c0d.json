{
    "id": "0abf491d-3654-4ebd-84bd-61168ecf1c0d",
    "created_at": "2022-10-25T16:48:15.132693Z",
    "updated_at": "2025-03-27T02:15:55.346351Z",
    "deleted_at": null,
    "sha1_hash": "30438e854db6bb43fb6629c746fb01ccfa8673b8",
    "title": "APT29 Domain Fronting With TOR",
    "authors": "FireEye",
    "file_creation_date": "2017-05-17T19:28:37Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 315570,
    "plain_text": "# g\n\n**[fireeye.com /blog/threat-research/2017/03/apt29_domain_frontin.html](https://www.fireeye.com/blog/threat-research/2017/03/apt29_domain_frontin.html)**\n\nMandiant has observed Russian nation-state attackers APT29 employing domain fronting techniques for stealthy\nbackdoor access to victim environments for at least two years. There has been considerable discussion about\n[domain fronting following the release of a paper detailing these techniques. Domain fronting provides outbound](http://www.icir.org/vern/papers/meek-PETS-2015.pdf)\nnetwork connections that are indistinguishable from legitimate requests for popular websites.\n\nAPT29 has used The Onion Router (TOR) and the TOR domain fronting plugin meek to create a hidden, encrypted\nnetwork tunnel that appeared to connect to Google services over TLS. This tunnel provided the attacker remote\naccess to the host system using the Terminal Services (TS), NetBIOS, and Server Message Block (SMB) services,\nwhile appearing to be traffic to legitimate websites. The attackers also leveraged a common Windows exploit to\naccess a privileged command shell without authenticating.\n\nWe first discussed APT29’s use of these techniques as part of our “No Easy Breach” talk at DerbyCon 6.0. For\n[additional details on how we first identified this backdoor, and the epic investigation it was part of, see the slides and](https://www.slideshare.net/MatthewDunwoody1/no-easy-breach-derby-con-2016)\n[presentation.](https://www.youtube.com/watch?v=Ldzr0bfGtHc)\n\n## Domain Fronting Overview\n\n[The Onion Router (TOR) is a network of proxy nodes that attempts to provide anonymity to users accessing the](https://www.torproject.org/about/overview.html.en)\nInternet. TOR transfers internet traffic through a series of proxy points on the Internet, with each node knowing only\nthe previous and next node in the path. This proxy network, combined with pervasive encryption, makes tracking the\nsource of TOR Internet activity extremely difficult. A TOR client can also use the TOR network to host services that\nare not accessible from the open Internet. These services are commonly used to host “dark web” sites such as the\ndefunct Silk Road.\n\nTypically network analysts can identify normal TOR traffic through signature analysis or the identification of\n[communication with TOR infrastructure. Meek is a publicly available obfuscation plugin for TOR and an](https://trac.torproject.org/projects/tor/wiki/doc/AChildsGardenOfPluggableTransports#meek)\nimplementation of the domain fronting technique. To hide TOR traffic, meek takes advantage of the way that Google\nand other Internet content delivery networks (CDNs) route traffic. CDNs often route traffic from IP addresses\nassociated with one service to servers associated with another service hosted on the same network. By hosting a\nmeek reflection server in one of these CDNs, meek can hide TOR traffic in legitimate HTTPS connections to wellknown services.\n\nMeek obfuscates traffic in several stages. First, it encodes TOR traffic into HTTP specifying the host name of the\nreflection server (for example, the default server meek-reflect.appspot.com). It then wraps that HTTP traffic in a\nlegitimate TLS connection to a server hosted in the same CDN cloud as the reflection server (in this example,\nGoogle). When the CDN server receives the connection, it decrypts the TLS traffic, identifies the hostname specified\nin the HTTP header and redirects the traffic to the reflection server. The reflection server then reconstructs the\noriginal TOR traffic from the HTTP stream and sends the traffic to the TOR network, which routes it to its destination.\nThis process creates an outbound network connection that appears to contain normal HTTPS POST requests for\ngoogle.com on a Google-owned IP address, while discretely passing the traffic through the reflection server to the\nTOR network. Meek can also use the TLS service and cipher suites used by Firefox to further obfuscate traffic.\nDifferentiating this traffic from legitimate connections is extremely difficult, and encryption of both on the initial TLS\nconnection and the TOR traffic makes meaningful analysis of the traffic impossible. Note: Google suspended the\nreflection server meek-reflect.appspot.com, but other servers, in the Google cloud or other supported CDNs, can\nfulfill the same function\n\n\n-----\n\nFigure 1: Meek traffic flow\n\n## Backdoor Overview\n\nMandiant discovered that APT29 enabled a TOR hidden service that forwarded traffic from the TOR client to local\nports 139, 445 and 3389 (NetBIOS, SMB and TS, respectively). This provided the attackers full remote access to the\nsystem from outside of the local network using the hidden TOR (.onion) address of the system.\n\nThe attackers created the following files and directories during the installation and execution of the backdoor:\n\nC:\\Program Files(x86)\\Google\\googleService.exe\n\nC:\\Program Files(x86)\\Google\\GoogleUpdate.exe\n\nC:\\Program Files(x86)\\Google\\core\n\nC:\\Program Files(x86)\\Google\\data\n\nC:\\Program Files(x86)\\Google\\data\\00\n\nC:\\Program Files(x86)\\Google\\data\\00\\hostname\n\nC:\\Program Files(x86)\\Google\\data\\00\\private_key\n\nC:\\Program Files(x86)\\Google\\debug.log\n\nC:\\Program Files(x86)\\Google\\lock\n\nC:\\Program Files(x86)\\Google\\cached-certs\n\nC:\\Program Files(x86)\\Google\\cached-microdescs\n\nC:\\Program Files(x86)\\Google\\cached-microdescs.new\n\n\n-----\n\nC:\\Program Files(x86)\\Google\\start.ps1\n\nC:\\Program Files(x86)\\Google\\install.bat\n\nThe file googleService.exe is the primary TOR executable, responsible for establishing and maintaining encrypted\nproxy connections. GoogleUpdate.exe is the meek-client plugin, which obfuscates the TOR connection. These files\nare publicly available and have the following hashes:\n\nFilename           SHA256\n\ngoogleService.exe   fe744a5b2d07de396a8b3fe97155fc64e350b76d88db36c619cd941279987dc5\nGoogleUpdate.exe   2f39dee2ee608e39917cc022d9aae399959e967a2dd70d83b81785a98bd9ed36\n\nThe file C:\\Program Files (x86)\\Google\\core contains configuration information for the TOR service\ngoogleService.exe. The service was configured to:\n\nCommunicate on ports 1, 80 and 443\n\nBridge traffic using the meek plugin to https://meek-reflect.appspot.com and obfuscate HTTPS and DNS\nrequests to appear destined for www.google.com\n\nForward traffic from ports 62304, 62305 and 62306 to ports 3389, 139 and 445, respectively\n\nFigure 2 displays the contents of the TOR configuration file core.\n\nFigure 2: Contents of TOR configuration file “C:\\Program Files(x86)\\Google\\core”\n\nThe C:\\Program Files (x86)\\Google\\data\\00\\hostname” file contained a single line with the TOR hostname for the\nsystem. This hostname was a pseudorandomly-generated 16 character alpha-numeric name, with the top-level\ndomain (TLD) .onion.\n\nThe C:\\Program Files(x86)\\Google\\data\\00\\private_key file contained the TOR client RSA private key. Figure 3\ndisplays the redacted contents of a sample private_key file.\n\n\n-----\n\nFigure 3: Redacted contents of sample private_key\n\nThe attackers used the scripts start.ps1 and install.bat to install the TOR service. After installation, the attackers\ndeleted these scripts from the system. Additional files in the directory C:\\Program Files(x86)\\Google contained\ncached data and logs from the operation of TOR.\n\n[Additional information on increasing visibility into PowerShell activity through enhanced logging is available here.](https://www.fireeye.com/blog/threat-research/2016/02/greater_visibilityt.html)\n\n## Installation and Persistence\n\nThe attacker executed the PowerShell script C:\\Program Files(x86)\\Google\\start.ps1 to install the TOR services and\nimplement the “Sticky Keys” exploit. This script was deleted after execution, and was not recovered.\n\nBy replacing the “Sticky Keys” binary, C:\\Windows\\System32\\sethc.exe, with the Windows Command Processor\ncmd.exe, the attackers then accessed a privileged Windows console session without authenticating to the system.\n“Sticky Keys” is an accessibility feature that allows users to activate Windows modifier keys without pressing more\nthan one key at a time. Pressing the shift key five times activates “Sticky Keys” and executes sethc.exe, which,\nwhen replaced with cmd.exe, opens a System-level command shell. From this shell, the attackers can execute\narbitrary Windows commands, including adding or modifying accounts on the system, even from the logon screen\n(pre-authentication). By tunneling RDP traffic to the system, the attackers could gain both persistent access and\nprivilege escalation using this simple and well-known exploit.\n\nThe installation script start.ps1 created a Windows service named Google Update to maintain persistence after a\nsystem reboot. Table 1 contains registry details for the “Google Update” service.\n\nTable 1: Registry details for the TOR Google Update Windows service\n\nThe script also modified the Terminal Server registry values fSingleSessionPerUser to allow multiple simultaneous\n\n\n-----\n\nTable 2: Registry modifications performed by start.ps1\n\n## Conclusion\n\nAPT29 adopted domain fronting long before these techniques were widely known. By employing a publicly available\nimplementation, they were able to hide their network traffic, with minimal research or development, and with tools\nthat are difficult to attribute. Detecting this activity on the network requires visibility into TLS connections and\neffective network signatures. However, when dealing with advanced threat groups who rapidly develop capabilities\nand invest in hiding network traffic, effective endpoint visibility is vital. Monitoring for potentially interesting events\nand attacker methodologies, like lateral movement and new persistence creation, can allow defenders to identify\nthese stealthy methodologies.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/8ytb4nym7whlldfvsaivnmsut9ole32h"
    ],
    "report_names": [
        "FireEye_APT29-Domain-Fronting-With-TOR(03-27-2017)"
    ],
    "threat_actors": [
        {
            "id": "5b748f86-ac32-4715-be9f-6cf25ae48a4e",
            "created_at": "2024-06-04T02:03:07.956135Z",
            "updated_at": "2025-03-27T02:05:17.407352Z",
            "deleted_at": null,
            "main_name": "IRON HEMLOCK",
            "aliases": [
                "ATK7 ",
                "Blue Kitsune ",
                "Cozy Bear ",
                "The Dukes",
                "UNC2452 ",
                "YTTRIUM ",
                "APT29 "
            ],
            "source_name": "Secureworks:IRON HEMLOCK",
            "tools": [
                " CozyCar",
                " CozyDuke",
                " DiefenDuke",
                " FatDuke",
                " HAMMERTOSS",
                " LiteDuke",
                " MiniDuke",
                " OnionDuke",
                " PolyglotDuke",
                " RegDuke",
                " RegDuke Loader",
                " SeaDuke",
                " Sliver",
                "CosmicDuke"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a241a1ca-2bc9-450b-a07b-aae747ee2710",
            "created_at": "2024-06-19T02:03:08.150052Z",
            "updated_at": "2025-03-27T02:05:17.409596Z",
            "deleted_at": null,
            "main_name": "IRON RITUAL",
            "aliases": [
                "Blue Dev 5 ",
                "BlueBravo ",
                "Cloaked Ursa ",
                "CozyLarch ",
                "Dark Halo ",
                "Midnight Blizzard ",
                "NOBELIUM ",
                "StellarParticle ",
                "UNC2452 ",
                "APT29"
            ],
            "source_name": "Secureworks:IRON RITUAL",
            "tools": [
                " Cobalt Strike",
                " EnvyScout",
                " GoldFinder",
                " GoldMax",
                " NativeZone",
                " RAINDROP",
                " SUNBURST",
                " Sibot",
                " TEARDROP",
                " VaporRage",
                "Brute Ratel C4"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "46b3c0fc-fa0c-4d63-a38a-b33a524561fb",
            "created_at": "2023-01-06T13:46:38.393409Z",
            "updated_at": "2025-03-27T02:00:02.822155Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "The Dukes",
                "Minidionis",
                "Grizzly Steppe",
                "G0016",
                "Blue Kitsune",
                "BlueBravo",
                "SeaDuke",
                "Cloaked Ursa",
                "YTTRIUM",
                "ATK7",
                "Nobelium",
                "UAC-0029",
                "Group 100",
                "COZY BEAR",
                "IRON HEMLOCK",
                "TA421",
                "ITG11"
            ],
            "source_name": "MISPGALAXY:APT29",
            "tools": [
                "QUARTERRIG",
                "SNOWYAMBER",
                "HALFRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716495,
    "ts_updated_at": 1743041755,
    "ts_creation_date": 1495049317,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/30438e854db6bb43fb6629c746fb01ccfa8673b8.pdf",
        "text": "https://archive.orkl.eu/30438e854db6bb43fb6629c746fb01ccfa8673b8.txt",
        "img": "https://archive.orkl.eu/30438e854db6bb43fb6629c746fb01ccfa8673b8.jpg"
    }
}