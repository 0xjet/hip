{
    "id": "f312b9ab-65ca-4861-bab1-65ec931c7bd3",
    "created_at": "2023-01-12T15:05:54.332072Z",
    "updated_at": "2025-03-27T02:08:42.812052Z",
    "deleted_at": null,
    "sha1_hash": "bf9a259cbec2d8bf103565e405cf6636df2e4106",
    "title": "2022-06-16 - Threat Thursday- Unique Delivery Method for Snake Keylogger",
    "authors": "",
    "file_creation_date": "2022-08-18T03:21:04Z",
    "file_modification_date": "2022-08-18T03:21:04Z",
    "file_size": 1903246,
    "plain_text": "# Threat Thursday: Unique Delivery Method for Snake Keylogger\n\n**[blogs.blackberry.com/en/2022/06/threat-thursday-unique-delivery-method-for-snake-keylogger](https://blogs.blackberry.com/en/2022/06/threat-thursday-unique-delivery-method-for-snake-keylogger)**\n\nThe BlackBerry Research & Intelligence Team\n\nA recently found downloader for Snake Keylogger brings several slippery evasion tactics\ntogether. It socially engineers its victims, targets organizations/users that failed to patch a\nknown exploit, and uses a variety of twists and turns in an effort to evade traditional\nantivirus (AV) products. In this blog, our team digs into this threat to find out exactly how it\nworks and what takeaways we can share with people to help protect them from this\nextremely stealthy threat.\n\nIn a recent threat campaign, the Snake Keylogger was delivered by a downloader that uses\nan unconventional file type as a lure, in addition to using embedded files within that lure,\nencrypted shellcode, and remote code execution exploits. The Snake Downloader uses\nthese techniques like tall grass to hide its path toward an intended target.\n\nBecause of the public’s familiarity with Microsoft® Office formats, DOC and XLS files tend to\nbe the lure documents of choice for threat actors. Because of this, it is far less common to\nsee a PDF file like the one used by this threat as the initial vector in an attack. We’ll\n\n\n-----\n\nexamine why the author of Snake Downloader chose this uncommon threat vector and what\nit reveals about the threat actor’s intentions and ultimate goals.\n\n### Operating System\n\n Risk & Impact\n\n Technical Analysis\n\nFor an initial understanding of how this attack is structured, let’s look at the different files\ninvolved in our analysis of the downloader and how they relate to each other.\n\nHere are the files used:\n\n“REMMITANCE INVOICE.pdf” – The original PDF attachment/lure document\n“has been verified. However pdf, jpeg, xlsx, .docx” – The DOCX file used to\ndownload the rich text format (RTF) file via macros. It is opened by the PDF lure after\nprompting the user.\n“f_document_shp.doc” – The RTF document downloaded by the DOCX file; it holds\nthe malformed objects.\n“00000000.ole” – The object linking and embedding (OLE) object extracted and\nreconstructed from “f_document_shp.doc”\n“00000000.bin” – The encrypted shellcode extracted from “00000000.ole”\n“fresh.exe” – Snake Keylogger\n\n[HP Wolf Security recently discovered this threat when they came across a PDF attachment](https://threatresearch.ext.hp.com/pdf-malware-is-not-yet-dead/)\nnamed “REMMITANCE INVOICE.pdf.” Running this file prompts the user to open a DOCX\nfile, which is deceptively named “has been verified. However PDF, Jpeg, xlsx, .docx.”\nThis strange choice of filename was chosen for a specific reason; at a casual glance, the\nfilename cleverly makes it appear as if the file has been automatically vetted and verified by\nthe victim’s machine, as shown in Figure 1.\n\n\n-----\n\nThis is a type of social engineering that relies heavily on the victim only giving the popup a\ncursory glance. The threat’s author hopes that the victim will be too busy or distracted to\nproperly read the “Open File” dialog, which means that many people working in a fastpaced office environment may fall victim to this threat.\n\n_Figure 1 – Prompt displayed after opening “REMMITANCE INVOICE.pdf”_\n\nIf this DOCX file is opened and macros are enabled by the victim, this triggers the download\nof an RTF file while displaying the strangely named document in Microsoft® Word. Users\nwho look closely will also see that Word reaches out to a certain URL while loading, as\nshown in Figure 2, coinciding with DNS requests to the same URL.\n\n_Figure 2 – URL displayed when loading Word_\n\nFor a closer look at the file, our team viewed the Office Open XML (OOXML) file contents\nand found the URL (vtaurl[.]com/IHytw) in the document’s relationships file. We can also\nsee that an OLE object is being loaded from this URL. Once the RTF document\n\n\n-----\n\n(f_document_shp.doc) is downloaded, we can check it for any OLE objects, such as the\ntwo malformed objects shown in Figure 3.\n\n_Figure 3 – Malformed OLE objects found in f_document_shp.doc_\n\nTo take a closer look at these OLE objects, we reconstructed them first, as seen in Figure 4.\nThen, using [oletools to view information about the objects, we find that one of them](https://github.com/decalage2/oletools)\n(00000000.ole) mentions the Microsoft Equation Editor in its description. This feature is\noften used by attackers to exploit known Word vulnerabilities to execute arbitrary code.\n\n\n-----\n\n_Figure 4 – Information about one of the reconstructed OLE objects_\n\nFollowing this information, we find shellcode in the OLE that exploits the Equation Editor’s\n[remote code execution vulnerability (CVE-2017-11882). This vulnerability was patched over](https://nvd.nist.gov/vuln/detail/CVE-2017-11882)\nfour years ago, but there are still many unpatched machines in the wild that remain\nvulnerable. The shellcode is shown being extracted from the OLENativeStream structure of\nthe object in Figure 5.\n\n\n-----\n\n_Figure 5 – Extracting encrypted shellcode from 00000000.ole_\n\nSince the shellcode is encrypted at first, we must look for the moment during execution\n[where it decrypts itself. To do so, we can use a tool like runsc to convert the extracted](https://github.com/edygert/runsc)\nshellcode into executable code (see Figure 6), then walk through the code with a debugger.\n\n_Figure 6 – Converting shellcode to attach to debugger_\n\nAs we step through the shellcode, after defining the correct offset, the file begins decrypting\nitself. In particular, the highlighted instruction shown in Figure 7 is quite revealing. For each\niteration of this decryption loop, it shows a specific register (ECX) getting multiplied by a\nstatic value and added. Mathematic operations like this can be typical for decryption\nroutines.\n\n\n-----\n\n_Figure 7 – Mathematic operations used in shellcode decryption_\n\nIf we follow the dump from register ECX, it reveals more and more with each iteration as the\nshellcode is decrypted. When finished, a reference for downloading fresh.exe can be seen,\nwhich is the Snake Keylogger itself. This keylogger is a prevalent information stealer, also\nknown as the 404 Keylogger, which has been in circulation since late 2020. This decrypted\nshellcode can be seen in Figure 8.\n\n\n-----\n\n_Figure 8 – Decrypted shellcode used to download Snake Keylogger_\n\nOnce the shellcode in the RTF file downloads the keylogger, the Snake Downloader has\ndone its job, and now it’s up to Snake Keylogger to continue from here. Keyloggers such as\nSnake lurk in the background on an infected machine and wait for the user to input any juicy\ninformation via the keyboard, particularly website logins, such as those used for banking or\na cryptocurrency wallet. That information then gets exfiltrated back to the threat actors and\nused for their own financial gain.\n\n### Conclusion\n\nAlthough it may be less common to see PDFs used as malicious file attachments, they\nshould still be taken just as seriously and handled with the same precautions as any other\npotentially infected attachments. In the case of Snake Downloader, the lure document is\nonly the first step in an array of tactics used to obfuscate the installation of the Snake\nKeylogger payload.\n\nFrom its use of embedded files, encrypted shellcode, and even remote code execution\nexploits, it’s clear that this downloader goes further than most to hide its initial execution on\nthe system. While the CVE-2017-11882 exploit had a patch created for it in 2017, it has\nbeen a slow process to get all affected machines patched, which means it’s still one of the\nmost common vulnerabilities that threat actors continue to exploit. This latest example\nspeaks to the prevalence of such attacks, and emphasizes the ongoing need for diligence\nwhen it comes to patching your organization’s endpoints, and distrusting attachments and\nfiles shared over the internet.\n\n### W­­ho is Affect­ed?\n\nThose with machines still vulnerable to CVE-2017-11882 could be infected by Snake\nDownloader/ Keylogger malware. The Snake Downloader threat is not confined to a\nparticular industry or sector, but rather takes advantage of busy or distracted individuals to\nperpetrate its malicious activity.\n\n### Mitigation Tips\n\nYou can take the following steps to reduce your exposure to this threat:\n\nAlways remain cautious when opening email attachments, regardless of file type.\nBe sure to carefully read all security popups when you’re being asked to manually\nenable something on your machine, particularly macros.\nEnsure you stay up to date with all Security Updates from Microsoft to stay protected\n[from exploits like CVE-2017-11882.](https://nvd.nist.gov/vuln/detail/CVE-2017-11882)\nMonitor accounts for unusual and unauthorized access that falls outside of the\n[baseline (MITRE D3FEND techniques D3-AZET,](https://d3fend.mitre.org/technique/d3f:AuthorizationEventThresholding/) [D3-LAM).](https://d3fend.mitre.org/technique/d3f:LocalAccountMonitoring)\n\n\n-----\n\n### YARA Rule\n\nThe following YARA rule was authored by the BlackBerry Research & Intelligence Team to\ncatch the threat described in this document:\n\n**rule Snake{**\n\n**meta:**\n**description = \"Detects Snake\"**\n\n**author = \"BlackBerry Threat Research Team\"**\n\n**date = \"2022-06-03-\"**\n\n**license = \"This Yara rule is provided under the Apache License 2.0**\n**(https://www.apache.org/licenses/LICENSE-2.0) and open to any user or**\n**organization, as long as you use it under this license and ensure originator credit**\n**in any derivative to The BlackBerry Research & Intelligence Team\"**\n\n**strings:**\n**$s1 = \"Game1Screen_Form_Load\"**\n\n**$s2 = \"get_KeyCode\"**\n\n**$s3 = \"Good luck mate\"**\n\n**condition:**\n\n**filesize < 1000KB and all of them**\n\n**}**\n\n### Indicators of Compromise (IoCs)\n\n**05dc0792a89e18f5485d9127d2063b343cfd2a5d497c9b5df91dc687f9a1341d**\n\n**250d2cd13474133227c3199467a30f4e1e17de7c7c4190c4784e46ecf77e51fe**\n\n**165305d6744591b745661e93dc9feaea73ee0a8ce4dbe93fde8f76d0fc2f8c3f**\n\n**f1794bfabeae40abc925a14f4e9158b92616269ed9bcf9aff95d1c19fa79352e**\n\n**20a3e59a047b8a05c7fd31b62ee57ed3510787a979a23ce1fde4996514fae803**\n\n### References\n\n_[https://threatresearch.ext.hp.com/pdf-malware-is-not-yet-dead/#](https://threatresearch.ext.hp.com/pdf-malware-is-not-yet-dead/)_\n\n_https://www.bleepingcomputer.com/news/security/pdf-smuggles-microsoft-word-doc-to-_\n_drop-snake-keylogger-malware/_\n\n_[https://www.socinvestigation.com/pdf-campaign-delivering-snake-keylogger/](https://www.socinvestigation.com/pdf-campaign-delivering-snake-keylogger/)_\n\n\n-----\n\n_https://www.zdnet.com/article/this-malware-spreading-pdf-uses-a-sneaky-file-name-to-trick-_\n_the-unwary/_\n\n### BlackBerry Assistance\n\nIf you’re battling this malware or a similar threat, you’ve come to the right place, regardless\nof your existing BlackBerry relationship.\n\n[The BlackBerry Incident Response team is made up of world-class consultants dedicated to](https://www.blackberry.com/us/en/services/incident-response)\nhandling response and containment services for a wide range of incidents, including\nransomware and Advanced Persistent Threat (APT) cases.\n\nWe have a global consulting team standing by to assist you, providing around-the-clock\nsupport where required, as well as local assistance. Please contact us\nhere: https://www.blackberry.com/us/en/forms/cylance/handraiser/emergency-incidentresponse-containment\n\n### Related Reading:\n\n## About The BlackBerry Research & Intelligence Team\n\nThe BlackBerry Research & Intelligence team examines emerging and persistent threats,\nproviding intelligence analysis for the benefit of defenders and the organizations they serve.\n\nBack\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-16 - Threat Thursday- Unique Delivery Method for Snake Keylogger.pdf"
    ],
    "report_names": [
        "2022-06-16 - Threat Thursday- Unique Delivery Method for Snake Keylogger.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "dcba8e2b-93e0-4d6e-a15f-5c44faebc3b1",
            "created_at": "2022-10-25T16:07:23.816991Z",
            "updated_at": "2025-03-27T02:02:09.991944Z",
            "deleted_at": null,
            "main_name": "Lurk",
            "aliases": [],
            "source_name": "ETDA:Lurk",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535954,
    "ts_updated_at": 1743041322,
    "ts_creation_date": 1660792864,
    "ts_modification_date": 1660792864,
    "files": {
        "pdf": "https://archive.orkl.eu/bf9a259cbec2d8bf103565e405cf6636df2e4106.pdf",
        "text": "https://archive.orkl.eu/bf9a259cbec2d8bf103565e405cf6636df2e4106.txt",
        "img": "https://archive.orkl.eu/bf9a259cbec2d8bf103565e405cf6636df2e4106.jpg"
    }
}