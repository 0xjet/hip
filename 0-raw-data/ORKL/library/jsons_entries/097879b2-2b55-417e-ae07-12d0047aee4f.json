{
    "id": "097879b2-2b55-417e-ae07-12d0047aee4f",
    "created_at": "2023-05-06T02:08:32.542071Z",
    "updated_at": "2025-03-27T02:05:51.688604Z",
    "deleted_at": null,
    "sha1_hash": "ce30a4d7f09acb95e0defe9316935518d999c8f8",
    "title": "2023-04-19 - ‘AuKill’ EDR killer malware abuses Process Explorer driver",
    "authors": "",
    "file_creation_date": "2023-05-05T02:01:11Z",
    "file_modification_date": "2023-05-05T02:01:11Z",
    "file_size": 753166,
    "plain_text": "# ‘AuKill’ EDR killer malware abuses Process Explorer driver\n\n**[news.sophos.com/en-us/2023/04/19/aukill-edr-killer-malware-abuses-process-explorer-driver/](https://news.sophos.com/en-us/2023/04/19/aukill-edr-killer-malware-abuses-process-explorer-driver/)**\n\nAndreas Klopsch April 19, 2023\n\nOver the past several months, Sophos X-Ops has investigated multiple incidents where\nattackers attempted to disable EDR clients with a new defense evasion tool we’ve dubbed\n**AuKill. The AuKill tool abuses an outdated version of the driver used by version 16.32 of the**\nMicrosoft utility, Process Explorer, to disable EDR processes before deploying either a\nbackdoor or ransomware on the target system.\n\nThe tool was used during at least three ransomware incidents since the beginning of 2023 to\nsabotage the target’s protection and deploy the ransomware: In January and February,\nattackers deployed Medusa Locker ransomware after using the tool; in February, an attacker\nused AuKill just prior to deploying Lockbit ransomware.\n\nThis is not the first time we and other vendors reported on multiple threat groups\nsimultaneously deploying software designed to kill EDR agents that protect computers. In\n[December 2022, Sophos, Microsoft, Mandiant, and SentinelOne reported that a number of](https://news.sophos.com/en-us/2022/12/13/signed-driver-malware-moves-up-the-software-trust-chain/)\nattackers had used custom-built drivers to disable EDR products.\n\n\n-----\n\nIn contrast, the AuKill tool abused a legitimate, but out-of-date and exploitable, driver. This\ntechnique is commonly referred to as a “bring your own vulnerable driver” (BYOVD) attack.\n\nThe method of abusing the Process Explorer driver to bypass EDR systems isn’t new; it was\n[implemented in the open-source tool Backstab, first published in June 2021. In fact, Sophos](https://github.com/Yaxser/Backstab)\nand other security vendors have previously reported on multiple incidents where either\nBackstab, or a version of this driver, was used for malicious purposes.\n\n[Last November, for example, Sophos X-Ops reported that a threat actor working for the](https://news.sophos.com/en-us/2022/11/30/lockbit-3-0-black-attacks-and-leaks-reveal-wormable-capabilities-and-tooling/)\nLockBit ransomware group used Backstab to disable EDR processes on an infected\n[machine. Three months later, Sentinel One published a report about a tool they called](https://www.sentinelone.com/labs/malvirt-net-virtualization-thrives-in-malvertising-attacks/)\nMalVirt, which uses the same Process Explorer driver to disable security products before\ndeploying the final payload on the target machine.\n\nThrough analysis and threat hunting, Sophos has collected six different variants of the AuKill\nmalware. We have found multiple similarities between the open-source tool Backstab and\nAuKill. Some of these similarities include similar, characteristic debug strings, and nearly\nidentical code flow logic to interact with the driver.\n\nAuKill entries (highlighted) in the list of Windows Services\nSophos believes the author of AuKill used multiple code snippets from, and built their\nmalware around, the core technique introduced by Backstab.\n\n\n-----\n\n### Legitimate Driver Abuse and Procexp.sys\n\nThreat actors increasingly have been relying on abusable drivers to disable security tools.\nDrivers are low-level system components that can access critical security structures in kernel\nmemory. As a security mechanism, Windows by default employs a feature called Driver\nSignature Enforcement that ensures kernel-mode drivers have been signed by a valid code\nsigning authority before Windows will permit them to run. This signature serves as a sign of\ntrust to verify the identity of the software and to protect a user’s system.\n\nTo get around this security measure, adversaries need to either contrive a way to get a\nmalicious driver signed by a trusted certificate (like we discussed in our December research),\nor (as is more common) abuse a legitimate commercial software driver to reach their goal, in\na BYOVD attack.\n\nIn this case, the attackers took advantage of a driver both created by and signed by\nMicrosoft. The Process Explorer driver, part of their suite of administration tools produced by\nthe [Sysinternals team, implements a variety of features to interact with running processes.](https://learn.microsoft.com/en-us/sysinternals/)\n\nAuKill drops a driver named PROCEXP.SYS (from the release version 16.32 of process\nExplorer) into the C:\\Windows\\System32\\drivers path. The legitimate Process Explorer driver\nis named PROCEXP152.sys, and normally is found in the same location. Both drivers can be\npresent on a machine that has a copy of Process Explorer running. The AuKill installer also\ndrops an executable copy of itself to either the System32 or the TEMP directory, which it runs\nas a service.\n\nThe maliciously installed Process Explorer driver, highlighted in red, in the Drivers folder\nalongside the legitimate Process Explorer driver, proxexp152.sys\n\n\n-----\n\nFor example, the driver can receive the IO control code IOCTL_CLOSE_HANDLE from usermode applications, which commands the driver to close a protected process handle,\nresulting in terminating a process.\n\nAbusing this process requires the attacker to use administrative privileges on the system.\nNormally, when an attacker obtains administrative privileges, it means that they have full\ncontrol over the machine.\n\nHowever, critical processes on Windows, such as endpoint clients, are under additional\nprotection features to prevent attackers from disabling them once they escalate privileges.\nAn example of an additional protection feature is the Protected Antimalware Services\nconcept introduced in Windows 8.1.\n\nTo circumvent such features, attackers need to go one level deeper — to run a driver in\nkernel-mode. In this case, AuKill abuses the legitimate driver behind Process Explorer to\novercome these features.\n\nThe AuKill tool requires administrative privileges to work, but it cannot give the attacker those\nprivileges. The threat actors using AuKill took advantage of existing privileges during the\nattacks, when they gained them through other means.\n\n### Technical analysis of AuKill’s evolution\n\nOver the last three months, we collected six different versions and tracked the functionality\nchanges from version to version. For simplicity, we dubbed the oldest version of the malware\nas AuKill V1, the most recent version as AuKill V6.\n\nNotably, the compiler and targeted security components changed. Figure 1 displays a\ntimeline of the following events:\n\nThe compilation time stamp of the AuKill version. The first event for example displays\nthat the binary AuKill V1 contains a compilation timestamp of the date 2022-11-13.\nThe date of when a corresponding sample was scanned the first time in our internal\nsystems. On 2022-11-17 for example, the first time AuKill V1 appeared in our internal\nsystems.\nFor correlation, we also added the timestamps when we were able to link this malware\nto specific ransomware attacks. On 2023-01-18, we were unable to obtain the AuKill\nsample used in the incident. However, on the 2023-02-14, we linked AuKill V1 to\nanother incident, where the threat actors tried to deploy Medusa Locker.\n\nWhile the compilation time stamp of a PE file can indeed be faked, if we reconstruct the time\ndelta between the moment the file was compiled and the time it initially appeared in our\nsystems, it seems likely the compilation time stamps are the actual ones.\n\n\n-----\n\nTimeline of compilation timestamps, “first seen” dates, and attribution events\n\n\n**Compilation**\n**timestamp**\n\n2022-11-13\n09:07:47\n\n2022-11-29\n05:58:14\n\n2022-12-14\n10:19:33\n\n2023-02-06\n18:09:19\n\n2023-02-10\n21:59:47\n\n2023-02-11\n13:43:12\n\n\n**SHA1** **Version** **Targeted**\n**vendors**\n\nf7b0369169dff3f10e974b9a10ec15f7a81dec54 V1 Sophos\n\n23b531ae8ca72420c5b21b1a68ff85524f36203a V2 Sophos\n\n7f93f934b570c8168940715b1d9836721021fd41 V3 ElasticSearch,\nSophos\n\nff11360f6ad22ba2629489ac286b6fdf4190846e V4 Microsoft,\nSophos,\nSplashtop\n(Remote\nAccess Tools)\n\nfdfc977c1e679da8147cbbab037e523aa3fe65ef V5 Microsoft,\nSophos,\nAladdin HASP\nSoftware\n\nbbfe4487f7fd02a085b83a10884487ad01cf62f7 V6 Microsoft,\nSophos,\nSplashtop\n(Remote\nAccess Tools)\n\n\n-----\n\nCompilation timestamps, hashes, and targets of each version we analyzed\n\nOur analysis focuses primarily on the samples labeled AuKill V1 and AuKill V6. V1 was seen\nin most incidents, however AuKill V6 seems to be an experimental version that introduces\ninteresting changes. In the upcoming sections we refer to V6 as the debug (or experimental)\nversion. (Full indicators-of-compromise for this malware are posted to the SophosLabs\nGithub.)\n\nA comparison between these two versions gives interesting insights into the possible\ndirection of future updates.\n\n### Phase 1: Installing The Service\n\n\n-----\n\nHigh\n\n\nlevel overview of phase 1\n\n\n-----\n\nWhen executed, the malware first checks if it has administrator privileges. It also requires\nthat the attacker runs the file with a keyword (or password) as the first argument on the\ncommand line. The execution aborts if either of these requirements are not fulfilled. (The\nattacker needs to acquire administrative rights before they can run the tool.)\n\nFor both samples covered in this analysis section (and all six samples listed in the IOCs),\nattackers need to pass the string startkey as the first command line argument.\n\nHow the AuKill variants map to service and process names\nThe malware validates the password/keyword using a simple arithmetic sum calculation. It\niterates a process where it derives the decimal value of the ASCII code for each character,\ndoubles the value, then adds it to the next character’s decimal value, which is then doubled,\nand so on.\n\nAfter the calculation is finished, the sum result is returned and compared against a\nhardcoded expected value, in this case 57502 (represented as the hexadecimal value\n**0xE09E). The python implementation of the algorithm is displayed below.**\n```\npwd = \"startkey\"\n\n  # val end result = 0xE09E\n\nval = 0x0\n\nfor ch in pwd:\n\n  val += ord(ch)\n\n  val *= 2\n\n```\nFigure 4: Python pseudocode representation of the password-checking algorithm\n\nIf the sample does not run with SYSTEM privileges, it continues by attempting to elevate its\nrights by impersonating the security context of TrustedInstaller exe\n\n\n-----\n\nFirst, AuKill starts the Trusted Installer service. Then it duplicates the token of\nTrustedInstaller.exe using the DuplicateTokenW WINAPI function, and passes the token to\n**CreateProcessWithTokenW to elevate itself to SYSTEM once the process restarts.**\n\nFinally, it copies itself to C:\\Windows\\system32, installs itself as a service, and starts the\nservice.\n\n### Phase 2: Disabling Security\n\nHigh level overview of phase 2\nOnce the malware establishes persistence by creating the service entry, it drops procexp.sys\nonto disk. The driver is embedded in AuKill as a resource. Both versions covered in this\nanalysis drop procexp.sys into C:\\Windows\\System32\\drivers. The figure below shows\ndecompiled code of V1, where the malware reads procexp.sys from resources and writes it\nto disk.\n\n\n-----\n\nDropping PROCEXP.SYS into System32/drivers\nNotably, the debug version also tries to connect to a driver named\n**WindowsKernelExplorer.sys as a fallback, in case it fails to drop and load procexp.sys.**\nHowever, the fallback driver is not embedded in the resources like procexp.sys. It expects\nthat this driver, part of, already exists in the System32\\drivers folder.\n\nBuilding the file path for WindowsKernelExplorer.sys\nAt this point we can’t confirm that the driver in the linked repository is the one being abused\nhere.\n\n### AuKill prevents services from restarting\n\n\n-----\n\nAn EDR client usually consists of multiple components that work in conjunction. A\ncomponent could be (for example) an installed service or running process, each with its own\nfunctionality. Therefore, if one crashes or terminates, it usually restarts as soon as possible.\n\nTo prevent these components from restarting, AuKill starts several threads to ensure that\nthese EDR processes and services stay disabled. Each thread targets a different component\nand continuously probes if the targeted processes or services are running. If any of them are,\nAuKill disables or terminates it. The initialization of these threads can be seen in figure 6.\n\nThe targeted vendors and services vary from sample to sample. Below figure 6, we also\nshare an analysis of the different functions used to disable EDR components we found\nthrough reverse engineering.\n\nRoutine to start threads responsible for keeping security processes disabled\n\n**1 – Terminate Via Procexp**\n\nThe first type of function takes a list of process names as input and is called\n**TerminateViaProcexp in the image above.**\n\nIt iterates through all running processes. If a process name is included in the list, AuKill\nsends IO control code IOCTL_CLOSE_HANDLE to procexp.sys to close the process handle.\nThis results in terminating the targeted process.\n\n\n-----\n\nAuKill V6 starts two threads running this function. The first thread targets a list of Microsoft\nrelated security processes and the second one a list of various vendors. Most process\nnames are related to security vendors. However, the creator also included a list of names for\nremote access tools in the target list.\n\n**2 – Terminate Forcefully**\n\nThe second type of function takes a list of vendors’ related process names as an argument\nand runs in a separate thread again. The malware iterates through all running processes and\nif a process name is included in this list, AuKill attempts to forcefully terminate it via\nTerminateProcess.\n\nThis thread was removed in the debug version but is included in other versions such as the\nversion V2 of AuKill.\n\n**3 – Disable Services**\n\nThe third function type is called DisableServices in the image above, and takes a\nhardcoded list of service names as input.\n\nFor each service name in the list, AuKill checks if it exists, and if it does, disables it by calling\nChangeServiceConfigW and passing SERVICE_DISABLED for dwStartType.\n\nAgain, in AuKill V6 we see two threads being instanced running this function.\n\n**4 – Unload Drivers**\n\nThe final function type is called Unload Driver in figure 6 and takes a list of hardcoded driver\nnames as an input.\n\nFor each driver name, AuKill tries to unload it via calling NtUnloadDriver and deleting the\ncorresponding registry key in the hive System\\CurrentControlSet\\Services\\[DRIVER_NAME].\n\nWe’ve only observed this function in AuKill V6.\n\n## Driver Abuse Continues To Rise In 2023\n\nDisabling EDR clients using drivers, whether they are legitimate and abused for malicious\n[purposes (BYOVD), or signed by a stolen/leaked certificate, continues to be popular among](https://news.sophos.com/en-us/2022/12/13/signed-driver-malware-moves-up-the-software-trust-chain/)\nadversaries who want to disable defense mechanisms.\n\nLast year, the security community reported about multiple incidents, where drivers have been\nweaponized for malicious purposes. The discovery of such a tool confirms our assumption\nthat adversaries continue to weaponize drivers, and we expect even more development in\nthis area the upcoming months.\n\n\n-----\n\n### Detection guidance\n\nCurrently, Sophos detects AuKill variants as ATK/BackStab-D. Additionally, we protect\ncustomers with behavioral detections (such as the Priv_5a behavioral rule) against the\nattack scenario explained in this article. These protections do not inhibit users from running\nlegitimate copies of Process Explorer, nor do Sophos products detect or remove the\nlegitimate Process Explorer driver when it is used normally.\n\nSophos has notified Microsoft about this abuse of the deprecated Process Explorer driver.\n\nFinally, businesses and people can take additional steps to defend computers they own\nagainst driver abuse:\n\nIt is highly suggested to check if your endpoint security product implements and\nenables tamper protection. This feature provides a strong layer against such type of\nattacks. If you use Sophos products but don’t currently have Sophos tamper protection\n[enabled, turn it on today.](https://docs.sophos.com/esg/enterprise-console/5-5/help/en-us/esg/Enterprise-Console/tasks/tamper_02_enable.html)\nPractice strong Windows security roles hygiene. This attack is only possible if the\nattacker escalates privileges they control, or can obtain administrator rights. Separation\nbetween user and admin privileges can help prevent attackers from easily loading\ndrivers.\nKeep your system updated. As we discussed in our December research, Windows\nmaintains a list of drivers for which Microsoft has revoked certificates, or deprecated\ndrivers that have been historically abused, and updates that list through the Windows\nUpdate mechanism.\nIn addition to your operating system, it’s also important to check, periodically, whether\nthere are updates for applications and other tools on your computer, and to remove\nolder tools if they are no longer required or used.\nLegitimate driver abuse can also happen if a vulnerable driver already exists on the\nsystem. Having a strong vulnerability management program can aid in closing such\nprotection gaps.\n\n[IOCs for files referenced in this post have been shared to the SophosLabs Github.](https://github.com/sophoslabs/IoCs/blob/master/atk-backstab-d.csv)\n\n### Acknowledgments\n\nSophosLabs wishes to recognize Michael Wood and Felix Weyne for their assistance with\nthe technical review of this post.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-04-19 - ‘AuKill’ EDR killer malware abuses Process Explorer driver.pdf"
    ],
    "report_names": [
        "2023-04-19 - ‘AuKill’ EDR killer malware abuses Process Explorer driver.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1683338912,
    "ts_updated_at": 1743041151,
    "ts_creation_date": 1683252071,
    "ts_modification_date": 1683252071,
    "files": {
        "pdf": "https://archive.orkl.eu/ce30a4d7f09acb95e0defe9316935518d999c8f8.pdf",
        "text": "https://archive.orkl.eu/ce30a4d7f09acb95e0defe9316935518d999c8f8.txt",
        "img": "https://archive.orkl.eu/ce30a4d7f09acb95e0defe9316935518d999c8f8.jpg"
    }
}