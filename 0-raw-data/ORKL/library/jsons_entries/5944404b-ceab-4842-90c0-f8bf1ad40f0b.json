{
    "id": "5944404b-ceab-4842-90c0-f8bf1ad40f0b",
    "created_at": "2023-01-12T15:04:45.376783Z",
    "updated_at": "2025-03-27T02:08:40.490758Z",
    "deleted_at": null,
    "sha1_hash": "e9793279ecff87688fa3a2691511ed9ee5f7cbd3",
    "title": "2021-12-09 - A closer look at Qakbot’s latest building blocks (and how to knock them down)",
    "authors": "",
    "file_creation_date": "2022-05-28T23:18:43Z",
    "file_modification_date": "2022-05-28T23:18:43Z",
    "file_size": 2155439,
    "plain_text": "# A closer look at Qakbot’s latest building blocks (and how to knock them down)\n\n**[microsoft.com/security/blog/2021/12/09/a-closer-look-at-qakbots-latest-building-blocks-and-how-to-knock-them-down/](https://www.microsoft.com/security/blog/2021/12/09/a-closer-look-at-qakbots-latest-building-blocks-and-how-to-knock-them-down/)**\n\nDecember 9, 2021\n\nMultiple Qakbot campaigns that are active at any given time prove that the decade-old\nmalware continues to be many attackers’ tool of choice, a customizable chameleon that\nadapts to suit the needs of the multiple threat actor groups that utilize it. Since emerging in\n2007 as a banking Trojan, Qakbot has evolved into a multi-purpose malware that provides\nattackers with a wide range of capabilities: performing reconnaissance and lateral\nmovement, gathering and exfiltrating data, or delivering other payloads on affected devices.\n\nIts modular nature allows Qakbot to persist in today’s computing landscape because it\nenables attackers to pick and choose the “building blocks” they need for each attack chain\ndepending on the network environment the malware lands on. In many cases, the attackers\nwho deliver Qakbot also sell access to affected devices to other threat actors, who use the\nsaid access for their own goals. For example, Qakbot infections have been known to lead to\nhuman-operated ransomware, including Egregor or Conti. Its impact, therefore, is farreaching: based on our threat data, recent Qakbot activities are seen in several countries\nand territories across almost all the continents: Africa, Asia, Europe, and the Americas.\n\n\n-----\n\nQakbot s modularity and flexibility could pose a challenge for security analysts and defenders\nbecause concurrent Qakbot campaigns could look strikingly different on each affected\ndevice, significantly impacting how these defenders respond to such attacks. Therefore, a\ndeeper understanding of Qakbot is paramount in building a comprehensive and coordinated\ndefense strategy against it.\n\nBased on our research and analysis of three recent notable Qakbot campaigns, we break\ndown a Qakbot attack chain into several distinct building blocks. Within each campaign,\nsome of these building blocks are consistent, although not all will be observed. Knowing\nthese details allows defenders to correctly identify related threats and attacks, regardless of\ntheir source. Such intelligence and insights also feed into Microsoft’s multi-layer protection\n[technologies, like those delivered through Microsoft 365 Defender, to detect and block these](https://www.microsoft.com/security/business/threat-protection/microsoft-365-defender)\nthreats at various stages of the attack chain.\n\nThis blog post provides technical details of each of the building blocks that comprise Qakbot\ncampaigns. It also includes mitigation recommendations and advanced hunting queries to\nhelp defenders proactively surface this threat.\n\n## From email to ransomware: Breaking down a Qakbot campaign\n\nLike other modular malware, Qakbot infections may look differently on each affected device,\ndepending on the operator using the said malware and their deployment of the threat\ncampaign. However, based on our analysis, one can break down a Qakbot-related incident\ninto a set of distinct “building blocks,” which can help security analysts identify and respond\nto Qakbot campaigns. Figure 1 below represents these building blocks. From our\nobservation, each Qakbot attack chain can only have one block of each color. The first row\nand the macro block represent the email mechanism used to deliver Qakbot.\n\n_Figure 1. Qakbot attack chain “building blocks” observed_\n\n\n-----\n\nCertain building blocks within each campaign are consistent, but not all of them are observed\non each affected device. As seen in a sample Qakbot campaign below (Figure 2), the top\ntwo rows represent the mechanisms adopted to deliver the malware on the three devices,\nwhile the succeeding ones are the activities it performs once running on each device. For\ninstance, notice that Devices A and C were seen to have email exfiltration, while Device B\nwas not:\n\n_Figure 2. Sample differences among devices affected by a single Qakbot campaign_\n\nTherefore, from an analyst’s viewpoint, what Figure 2 implies is that even if email exfiltration\nwas not observed in one device, it doesn’t mean that this routine didn’t happen at all in their\norganization’s network.\n\nFrom our research, we identified ten building blocks, which we will discuss in the succeeding\nsections.\n\n### Email delivery\n\n\n-----\n\nQakbot is delivered via one of three email methods: malicious links, malicious attachments,\nor, more recently, embedded images.\n\nThe messages in these email campaigns typically consist of one- or two-sentence lures (for\nexample, “please see attached” or “click here to view a file”). Such brevity provides sufficient\ninformation and a call to action for the target users but little for content security solutions to\ndetect.\n\n_Figure 3. Sample Qakbot campaign email message_\n\n**Malicious links**\n\nThe email campaigns we observed delivering Qakbot typically include the URLs that\ndownload the malware on target devices in the message body. Earlier this year, we began to\nobserve that some of these URLs were missing the HTTP or HTTPS protocol, rendering\nthem unclickable in most email clients. Therefore, to download the malware, target recipients\nhad to manually enter the link into a browser.\n\n\n-----\n\n_Figure 4. Sample Qakbot campaign email containing an unclickable URL and fake-reply lure_\n\nAlthough the missing protocol poses a challenge for some email security solutions that\ndetonate links through sandboxing, the extra step needed from targets to copy and paste the\nURL hinders the attack’s success rate. However, it should also be noted that what the\nmessages sometimes lack in formatting, they make up for in the content by using fake-reply\nlures.\n\nThis fake-reply technique, which has already been seen in previous Qakbot and other major\nmalware delivery campaigns, uses stolen subject lines and message content to construct a\nmalicious reply to appear as part of a prior email thread. Qakbot is also known for reusing\nemail threads exfiltrated from prior infections to create new templates for their next email\ncampaign runs, allowing an attacker to use an actual subject line and message content to\nconstruct the spoofed reply. This increases the likelihood of target users clicking or copypasting the link because the message they receive from this campaign feels more expected.\nAt the same time, attackers benefit from growing entropy among messages because no two\nemails in the same campaign will be alike. Unfortunately, such entropy also makes it more\ndifficult for security analysts and defenders to fully scope a campaign.\n\n**Malicious attachments**\n\nSome Qakbot-related emails sent by attackers may include a ZIP file attachment. Within the\nZIP is a spreadsheet containing Excel 4.0 macros.\n\n\n-----\n\nThe attachment name is meant to appear as an official corporate document to trick a target\nrecipient into opening it. For example, between September and November this year, the\nnaming patterns we observed for the attachment included but were not limited to the\nfollowing:\n\n_CMPL-[digits]-[month]-[day].zip_\n_Compensation_Reject-[digits]-[mmddyyyy].zip_\n_Document_[digits]-[mmddyyyy].zip_\n_Document_[digits]-Copy.zip_\n_PRMS-[digits].zip_\n_Rebate-[digits]-[mmddyyyy].zip_\n_REF-[digits]-[month]-[day].zip_\n_TXN-[digits].zip_\n\n_Figure 5. Sample Qakbot campaign email containing a ZIP attachment_\n\n**Embedded images**\n\nIn its third and most recent evolution, Qakbot arrives via an email message that only contains\nan embedded image in its body, a stark contrast to its previous delivery methods that used\n[file attachments or direct hyperlinks. We uncovered this Qakbot campaign while investigating](https://twitter.com/MsftSecIntel/status/1455676282835021830)\nmalware infections from malicious Excel files associated with emails that abuse Craigslist’s\n[email messaging system to deliver malicious files—a routine first reported by INKY.](https://www.inky.com/blog/urgency-mail-relay-serve-phishers-well-on-craigslist)\n\n\n-----\n\nThis campaign is more involved than previous Qakbot email campaigns because, unlike its\nprevious delivery methods, the malicious components in the email (in this case, the malicious\nURL) are not in the message body as text but are contained instead within an image\ndesigned to look like the message body. The image instructs recipients to type the URL\ndirectly in their browser to download an Excel file that eventually leads to Qakbot.\n\nThe said image is a screenshot of text formatted to impersonate an automated Craigslist\nnotification, and it informs the target recipient of a supposed policy infraction on their\nCraigslist posting. The said fake notification further instructs the user to enter a URL into a\nbrowser to access a form for more detailed information, threatening to delete their account if\nthey don’t follow.\n\n_Figure 6 Craigslist campaign email luring targets with an embedded image_\n\n\n-----\n\nAttackers crawl Craigslist ad posts to harvest email relay addresses, where they then send\ncustom-crafted messages directly. The email relay receives the sent messages and removes\npersonal data—including the sender’s actual email address, appends original post details to\nthe end of the message, then forwards it through Craigslist infrastructure to mask the original\nsender. As a result, the ad owner will receive an anonymized email sent from the legitimate\n_craigslist.org domain._\n\nThe attackers’ abuse of the email relay system allows them to remain anonymous and\nimpersonate Craigslist. It also adds a sense of legitimacy to the messages because it comes\nfrom a popular domain that is generally deemed safe by traditional security solutions.\n\nBased on our observation, this email campaign replies to job-related ads, which we believe is\nthe attackers’ attempt to target recipients who open such types of messages while connected\nto a corporate network. However, based on our threat data, users’ success rate accessing\nthe related malicious domains is relatively low. Such a result is likely because the campaign\nrequires the target recipients to perform the additional step of typing a URL.\n\n### Macro enablement\n\nDespite the varying email methods attackers are using to deliver Qakbot, these campaigns\nhave in common their use of malicious macros in Office documents, specifically Excel 4.0\nmacros. It should be noted that while threats use Excel 4.0 macros as an attempt to evade\ndetection, this feature is now disabled by default and thus requires users to enable it\nmanually for such threats to execute properly.\n\nOnce the user downloads and opens the malicious Excel file, the text in the document\nattempts to lure them into enabling the macro. The said text claims that the file is “protected”\nby a service such as Microsoft or DocuSign, and that the user must enable the macro to view\nthe document’s actual content.\n\n\n-----\n\n_Figure 7. XLS file with a DocuSign lure urging targets to enable macros_\n\nIf the user goes ahead and enables the macro, Excel immediately checks if there is a\nsubprocedure predefined in the macro to run automatically once the document opens; in this\ncase, auto_open(). The Visual Basic for Applications (VBA) code written within this\nsubprocedure creates a new macrosheet and then writes Excel 4.0 formulas in several of its\ncells. Next, it jumps to one cell in this sheet by calling the Application.Run method. In this\nway, the VBA code starts the Excel 4.0 macro code that was just written to the macrosheet.\n\n\n-----\n\n_Figure 8. Example of an Excel 4.0 macro generated by the VBA script._\n\nGenerating and calling Excel 4.0 macro from VBA is an evasion technique to prevent static\nanalysis tools from decoding the macro. When the user closes the document, the\n_auto_close() function launches to clean up and remove the malicious macrosheet created by_\nthe VBA macro.\n\n### Qakbot delivery\n\nOnce macros are enabled, the next phase of the attack begins. First, the macro connects to\na predefined set of IP addresses or domains to download the malicious files. Some macros\nare designed to connect to three domains simultaneously, downloading a file of the same\nname. This is likely done for one of two reasons: first, as a redundancy measure to ensure\nthat the malware is still delivered even if one or two of the domains have been blocked or\ntaken down; and second, to enable the attacker to deliver multiple payloads if desired.\n\n_Figure 9. Portion of the generated Excel 4.0 macro that shows its attempts to download three_\n_payloads from three locations._\n\nIn most cases, the downloaded file is a Portable Executable (PE) file renamed with either an\n_.htm or .dat file extension, in order to bypass web filtering systems that prevent certain file_\ntypes. Depending on the specific campaign, the naming of these files varies greatly. For\nexample, a recent campaign using .htm files named them with simple letters and numbers,\n\n\n-----\n\nsuch as goh[1].htm or j[1].htm. However, a separate campaign that used an invoice theme\nand used .dat files named them with an extremely long string of numbers, such as\n_44494.4409064815[1].dat. Again, these differences from campaign to campaign highlight_\nthat Qakbot is used simultaneously by different threat actors, which can make concurrent\ncampaigns of the same malware look strikingly different.\n\nOnce this file is downloaded onto the device, the file is promptly renamed to a different file\nname with a nonexistent file name extension. Some examples include test.test and\n_good.good (derived from .htm files), or GiCelod.waGic and Celod.wac (derived from .dat_\nfiles). In many of the incidents involving .htm files, a folder called C:\\Datop is created, and\nthe files are saved in that location. Meanwhile, the incidents with .dat files are saved in the\n_C:\\Users\\AppData\\Local\\Temp location._\n\n### Process injection for discovery\n\nWhichever file the user ends up with is loaded using regsvr32.exe, which injects into a\nlegitimate process. Both MSRA.exe and Mobsync.exe have been used for this process\ninjection behavior in recent Qakbot-related campaigns.\n\nThe injected process is then used for a series of discovery commands, including the\nfollowing:\n\n### Scheduled tasks\n\nThe injected process from the previous building block then creates a .dll file with a randomly\ngenerated name. This DLL is used to query existing scheduled tasks for a specific ID, and if\nthat scheduled task does not already exist, the DLL creates the task. The scheduled task is\n\n\n-----\n\nto run a predefined task as a means of persistence, as outlined in the following command\nline:\n\nThis scheduled task is created with the /F flag, which is used to suppress warnings if the\nspecified task already exists, even though the malware has already queried for a specific\nscheduled task.\n\n### Credential and browser data theft\n\nQakbot attempts to steal credentials from multiple locations. First, the injected MSRA.exe or\n_Mobsync.exe process loads the Vault Credential Library file to enumerate credentials._\nAdditionally, this process injects into ping.exe and attempts to read credentials from\nCredMan using the passport.net\\* parameter.\n\nQakbot also targets browser data. The injected process launches the esentutl.exe process.\nBrowser data, including cookies and browser history, are recovered from the web cache\nusing the following commands:\n\nThese commands specifically look for log files, system files, and database files (/l, /s, and /d).\n\n### Email exfiltration\n\nAs mentioned in a previous section, many of the emails delivering Qakbot use the fake-reply\ntechnique. To do this, Qakbot is also designed to exfiltrate emails from affected devices.\n\nTo exfiltrate emails, the injected process launches into the ping.exe process and launches a\ncommand to ping localhost:\n\nFrom there, ping.exe is used to copy dozens of email message files and save them in an\n“Email Storage” folder. These email messages are saved with sequential naming schema,\nstarting with 1.eml and increasing by one for as many email messages as the attacker\n\n\n-----\n\ncopies. We have identified instances where the attacker copied out over 100 message files\nfrom a single device.\n\nOnce the copied email files are exfiltrated, the evidence of the action is deleted by removing\nthe “Email Storage” folder using the rmdir command.\n\n### Additional payloads, lateral movement, and ransomware\n\nAs is the case with many malware variants today, getting Qakbot onto a device is frequently\njust the first step in what ends up being a larger attack. Attackers can use the access from\nQakbot infections to deliver additional payloads or sell access to other threat actors who can\nuse the purchased access for their objectives.\n\nIn many cases, attackers will expand the scope of their attack by using credentials obtained\nin earlier stages of the attack to move laterally throughout the network. In several instances,\nattackers would move laterally using Windows Management Instrumentation (WMI) and drop\na malicious DLL on the newly accessed device. From there, the attacker will run the same\nseries of discovery commands as they did on the initial access device and will conduct\nfurther credential theft.\n\nIn other instances, other malicious files are dropped in conjunction with the malicious DLL.\nFor example, several BAT files that were specifically designed to turn off security tools on the\naffected device were dropped before dropping the malicious DLL. These slight differences in\nthe attack chain are evidence of multiple actors using Qakbot for lateral movement.\n\nIn addition to lateral movement, attackers frequently drop additional payloads on affected\ndevices, especially Cobalt Strike. Qakbot has a Cobalt Strike module, and actors who\npurchase access to machines with prior Qakbot infections may also drop their own Cobalt\nStrike beacons and additional payloads. Using Cobalt Strike lets attackers have full handson-keyboard access to the affected devices, enabling them to perform additional discovery,\nfind high-value targets on the network, move laterally, and drop additional payloads,\nespecially human-operated ransomware variants such as Conti and Egregor.\n\n## Resurging and evolving threats require coordinated threat defense\n\nQakbot’s continued prevalence in the threat landscape demands comprehensive protection\ncapable of detecting and stopping this malware, its components, and other similar threats at\nevery stage of the attack chain: email delivery, network activity, endpoint behavior, and\n[follow-on attacker activities. Microsoft 365 Defender provides coordinated defense using](https://www.microsoft.com/security/business/threat-protection/microsoft-365-defender)\nmultiple layers of dynamic protection technologies —including machine learning-based\nprotection—and correlating threat data from email, endpoints, identities, and cloud apps. It is\nalso backed by a global network of threat experts who continuously monitor the threat\nlandscape for new, resurging, and evolving attacker tools and techniques.\n\n\n-----\n\n[Microsoft Defender for Office 365 detects and blocks emails that attempt to deliver Qakbot.](https://www.microsoft.com/security/business/threat-protection/office-365-defender)\n[Safe Links and](https://docs.microsoft.com/microsoft-365/security/office-365-security/safe-links?view=o365-worldwide) [Safe Attachments provide real-time protection by leveraging a built-in](https://docs.microsoft.com/microsoft-365/security/office-365-security/safe-attachments?view=o365-worldwide)\nsandbox that examines and detonates links and attachments in messages before they get\ndelivered to target recipients. However, for those messages without such artifacts, Microsoft\nDefender SmartScreen in Microsoft Edge and other web browsers that support it blocks the\nmalicious websites and prevents downloading the malicious Excel file on devices.\n\nOn endpoints, [attack surface reduction rules detect and block common attack techniques](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/attack-surface-reduction?view=o365-worldwide)\nused by Qakbot and subsequent threats that may result from its activities. Endpoint detection\nand response (EDR) capabilities detect malicious files, malicious behavior, and other related\n[events before and after execution. Network protection also blocks subsequent attempts by](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/network-protection?view=o365-worldwide)\n[Qakbot to connect to malicious domains and IP addresses, and Advanced hunting lets](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/advanced-hunting-overview?view=o365-worldwide)\ndefenders create custom detections to proactively find this malware and other related\nthreats.\n\nDefenders can also do the following mitigation steps to reduce the impact of Qakbot in their\norganizations:\n\nCheck your Office 365 email filtering settings to ensure you block spoofed emails,\n[spam, and emails with malware. Use Office 365 security for enhanced phishing](https://docs.microsoft.com/office365/securitycompliance/office-365-atp)\nprotection and coverage against new threats and polymorphic variants. Configure\n[Office 365 to recheck links on click.](https://docs.microsoft.com/en-us/office365/securitycompliance/atp-safe-links)\n[Enable Zero-hour auto purge (ZAP) in Exchange Online, which is an email protection](https://docs.microsoft.com/microsoft-365/security/office-365-security/zero-hour-auto-purge)\ncapability that retroactively detects and neutralizes malicious messages that have\nalready been delivered in response to newly acquired threat intelligence.\nEncourage users to use Microsoft Edge and other web browsers that support\n[SmartScreen, which identifies and blocks malicious websites, including phishing sites,](https://docs.microsoft.com/windows/security/threat-protection/microsoft-defender-smartscreen/microsoft-defender-smartscreen-overview)\nscam sites, and sites that contain exploits and host malware. Enable network\nprotection to prevent applications or users from accessing malicious domains and other\nmalicious content on the internet.\n[Stop malicious XLM or VBA macros by ensuring runtime macro scanning by Windows](https://www.microsoft.com/security/blog/2021/03/03/xlm-amsi-new-runtime-defense-against-excel-4-0-macro-malware/)\nAntimalware Scan Interface (AMSI) is on. This feature—enabled by default—is on if the\nGroup Policy setting for Macro Run Time Scan Scope is set to Enable for All Files or\n**Enable for Low Trust Files.**\nTurn on [cloud-delivered protection in Microsoft Defender Antivirus or the equivalent for](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/configure-block-at-first-sight-microsoft-defender-antivirus?view=o365-worldwide)\nyour antivirus product to cover rapidly evolving attacker tools and techniques. Cloudbased machine learning protections block a huge majority of new and unknown\nvariants.\nTurn on [tamper protection features to prevent attackers from stopping security](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/prevent-changes-to-security-settings-with-tamper-protection?view=o365-worldwide)\nservices.\n\n\n-----\n\n[Run EDR in block mode so that](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/edr-in-block-mode?view=o365-worldwide) [Microsoft Defender for Endpoint can block malicious](https://www.microsoft.com/security/business/threat-protection/endpoint-defender)\nartifacts, even when your non-Microsoft antivirus doesn’t detect the threat or when\nMicrosoft Defender Antivirus is running in passive mode. EDR in block mode works\nbehind the scenes to remediate malicious artifacts that are detected post-breach.\n[Enable investigation and remediation in full automated mode to allow Microsoft](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/automated-investigations?view=o365-worldwide)\nDefender for Endpoint to take immediate action on alerts to resolve breaches,\nsignificantly reducing alert volume.\nUse [device discovery to increase your visibility into your network by finding unmanaged](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/device-discovery?view=o365-worldwide)\ndevices on your network and onboarding them to Microsoft Defender for Endpoint.\nUse multi-factor authentication (MFA) to mitigate credential theft and prevent attacker\naccess. Keep MFA always-on for privileged accounts and apply risk-based MFA for\nnormal accounts. Consider transitioning to a passwordless primary authentication\nmethod, such as Azure MFA, certificates, or Windows Hello for Business.\nRun realistic, yet safe, simulated phishing and password attack campaigns in your\n[organization using Attack Simulator for Microsoft Defender for Office 365. Run spear-](https://docs.microsoft.com/microsoft-365/security/office-365-security/attack-simulator?view=o365-worldwide)\nphishing (credential harvest) simulations to train end users against clicking URLs in\nunsolicited messages and disclosing their credentials.\nEducate end users about identifying lures in spear-phishing emails and watering hole\nattacks, protecting personal and business information in social media, and filtering\nunsolicited communication. Encourage users to report reconnaissance attempts and\nother suspicious activity.\n\nLearn how you can stop attacks through automated, cross-domain security with Microsoft\n365 Defender.\n\n**_Microsoft 365 Defender Threat Intelligence Team_**\n\n## Appendix\n\n[Microsoft researchers published the following threat analytics reports, which are available to](https://docs.microsoft.com/windows/security/threat-protection/microsoft-defender-atp/threat-analytics)\n[Microsoft 365 Defender customers through the Microsoft 365 security center:](https://security.microsoft.com/)\n\n[Malware profile: Qakbot provides additional information about Qakbot’s building blocks](https://securitycenter.windows.com/threatanalytics3/1675bab9-2b2f-44e4-babc-2de9e62754bb/overview)\ndiscussed in this blog post, including references to previously monitored campaigns\nand detailed mitigation steps\n[Threat Insights: Qakbot abuses Craigslist email relay provides more technical details](https://securitycenter.windows.com/threatanalytics3/d0411ea8-1ba8-40cb-ab33-cbe1a1c6660c/overview)\nabout the Craigslist email abuse campaign that was recently seen delivering Qakbot\n\nThese reports serve as a good starting point for organizations to understand these active\n[attacks, determine if they are affected, and investigate related incidents and alerts. The](https://docs.microsoft.com/microsoft-365/security/defender/investigate-incidents?view=o365-worldwide)\nreports provide and consolidate real-time data aggregated from across Microsoft 365\nDefender, indicating the all-up impact of the threat to the organization.\n\n\n-----\n\nThe following sections provide the specific Microsoft 365 Defender detections that can help\nsurface Qakbot and related threats.\n\n### Antivirus\n\nMicrosoft Defender Antivirus detects Qakbot installers as the following malware:\n\n**Qakbot downloader**\n\n[TrojanDownloader:O97M/Qakbot](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=TrojanDownloader:O97M/Qakbot)\n\n**Qakbot implant**\n\n[Trojan:Win32/QBot](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Trojan:Win32/Qbot)\n[Trojan:Win32/Qakbot](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Trojan:Win32/Qakbot)\n[TrojanSpy:Win32/Qakbot](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=TrojanSpy:Win32/Qakbot)\n\n**Qakbot behavior**\n\n[Behavior:Win32/Qakbot.A](https://www.microsoft.com/en-us/wdsi/threats/threat-search?query=Behavior:Win32/Qakbot.A)\n\n**Additional detections based on activity group behavior**\n\nDue to Qakbot’s high likelihood of transitioning to human-operated attack behaviors including\ndata exfiltration, lateral movement, and ransomware by multiple actors, the detections seen\nafter infection can vary widely. During the activity described in this report, at least one major\nactivity group was provided Qakbot access after initial infection, but other groups have been\nknown to purchase access so any initial infection indicated by advanced hunting queries,\nbehavior, or Qakbot infection should be fully investigated.\n\n### Endpoint detection and response (EDR)\n\nAlerts with the following titles in the security center can indicate threat activity on your\nnetwork related directly to the material in this report covering Qakbot initial infection and\nfuture human operated or ransomware activity:\n\nQakbot malware\nQakbot credential stealer\nQakbot download URL\nQakbot network infrastructure\n\n### Email security\n\nMicrosoft Defender for Office 365 offers enhanced solutions for blocking and identifying\n[malicious emails. In the email entity page, administrators can get enhanced information on](https://docs.microsoft.com/microsoft-365/security/office-365-security/mdo-email-entity-page)\nemails in a unified view. Administrators can view known campaigns impacting inboxes and\n\n\n-----\n\ninvestigate malicious emails by drilling down to view all attachments or URL detonation\ndetails from dynamic analysis.\n\nThe following dynamic detonation signature may indicate threat activity associated with\nQakbot. By utilizing email Campaigns view, you can filter based on campaign subtype for\nthe following signals. These signals, however, can be triggered by unrelated threat activity:\n\nDownloader_Macro_Donoff_ZGA\n\n### Advanced hunting\n\nThe following Advanced Hunting Queries are accurate as of this writing. For the most up-to[date queries, visit aka.ms/QakbotAHQ.](https://aka.ms/QakbotAHQ)\n\nTo locate possible exploitation activity, run the following queries in Microsoft 365 Defender.\n\n**Craigslist impersonation domains lead to XLS download**\n\nUse this query to locate devices connecting to malicious domains registered to impersonate\nCraigslist.org. These domains act as redirectors which direct the target to a malicious XLS\ndownload.\n\n```\nDeviceNetworkEvents\n\n```\n```\n| where RemoteUrl matches regex @\"abuse\\.[a-zA-Z]\\d{2}-craigslist\\.org\"\n\n```\n\n**Qakbot-favored process execution after anomalous Excel spawning**\n\nUse this query to find Excel launching anomalous processes congruent with Qakbot\npayloads which contain additional markers from recent Qakbot executions. The presence of\nsuch anomalous processes indicate that the payload was delivered and executed, though\nreconnaissance and successful implantation hasn’t been completed yet.\n```\nDeviceProcessEvents\n| where InitiatingProcessParentFileName has \"excel.exe\" or\nInitiatingProcessFileName =~ \"excel.exe\"\n| where InitiatingProcessFileName in~ (\"excel.exe\",\"regsvr32.exe\")\n| where FileName in~ (\"regsvr32.exe\", \"rundll32.exe\")\n| where ProcessCommandLine has @\"..\\\"\n\n```\n**Qakbot reconnaissance activities**\n\nUse this query to find reconnaissance and beaconing activities after code injection occurs.\nReconnaissance commands are consistent with the current version of Qakbot and occur\nautomatically to exfiltrate system information. This data, once exfiltrated, will be used to\nprioritize human operated actions.\n\n\n-----\n\n```\nDeviceProcessEvents\n| where InitiatingProcessFileName == InitiatingProcessCommandLine\n| where ProcessCommandLine has_any (\n\"whoami /all\",\"cmd /c set\",\"arp -a\",\"ipconfig /all\",\"net view\n/all\",\"nslookup -querytype=ALL -timeout=10\",\n\"net share\",\"route print\",\"netstat -nao\",\"net localgroup\")\n| summarize dcount(FileName), make_set(ProcessCommandLine) by\nDeviceId,bin(Timestamp, 1d), InitiatingProcessFileName,\nInitiatingProcessCommandLine\n| where dcount_FileName >= 8\n\n```\n**Qakbot email stealing by ping.exe**\n\nUse this query to find email stealing activities ran by Qakbot that will use “ping.exe -t\n127.0.0.1” to obfuscate subsequent actions. Email theft that occurs might be exfiltrated to\noperators and indicates that the malware completed a large portion of its automated activity\nwithout interruption.\n```\nDeviceFileEvents\n| where InitiatingProcessFileName =~ 'ping.exe'\n| where FileName endswith '.eml'\n\n```\n**General attempts to access local email store**\n\nUse this query to find attempts to access files in the local path containing Outlook emails.\n```\nDeviceFileEvents\n| where FolderPath hasprefix \"EmailStorage\"\n| where FolderPath has \"Outlook\"\n| project FileName, FolderPath, InitiatingProcessFileName,\nInitiatingProcessCommandLine, DeviceId, Timestamp\n\n```\n**Email collection for exfiltration**\n\nUse this query to find attempts to copy and store emails for later exfiltration.\n```\nDeviceFileEvents\n| where InitiatingProcessFileName =~ 'ping.exe' and\nInitiatingProcessCommandLine == 'ping.exe -t 127.0.0.1'\nand InitiatingProcessParentFileName in~('msra.exe', 'mobsync.exe') and\nFolderPath endswith \".eml\"\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-09 - A closer look at Qakbot’s latest building blocks (and how to knock them down).pdf"
    ],
    "report_names": [
        "2021-12-09 - A closer look at Qakbot’s latest building blocks (and how to knock them down).pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bfded1cf-be73-44f9-a391-0751c9996f9a",
            "created_at": "2022-10-25T15:50:23.337107Z",
            "updated_at": "2025-03-27T02:00:55.445946Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "FIN7",
                "GOLD NIAGARA",
                "ITG14",
                "Carbon Spider",
                "ELBRUS",
                "Sangria Tempest"
            ],
            "source_name": "MITRE:FIN7",
            "tools": [
                "Mimikatz",
                "AdFind",
                "JSS Loader",
                "HALFBAKED",
                "REvil",
                "PowerSploit",
                "CrackMapExec",
                "Carbanak",
                "Pillowmint",
                "Cobalt Strike",
                "POWERSOURCE",
                "RDFSNIFFER",
                "SQLRat",
                "Lizar",
                "TEXTMATE",
                "BOOSTWRITE"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "bb8702c5-52ac-4359-8409-998a7cc3eeaf",
            "created_at": "2023-01-06T13:46:38.405479Z",
            "updated_at": "2025-03-27T02:00:02.82533Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "JokerStash",
                "ATK32",
                "G0046",
                "Coreid",
                "Carbanak",
                "Sangria Tempest",
                "CARBON SPIDER",
                "GOLD NIAGARA",
                "G0008",
                "ELBRUS",
                "Carbon Spider"
            ],
            "source_name": "MISPGALAXY:FIN7",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d85adfe3-e1c3-40b0-b8bb-d1bacadc4d82",
            "created_at": "2022-10-25T16:07:23.619566Z",
            "updated_at": "2025-03-27T02:02:09.890982Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "APT-C-11",
                "ATK 32",
                "Gold Niagara",
                "ITG14",
                "TAG-CR1"
            ],
            "source_name": "ETDA:FIN7",
            "tools": [
                "7Logger",
                "Agentemis",
                "Anunak",
                "Astra",
                "BIOLOAD",
                "BIRDWATCH",
                "Bateleur",
                "Boostwrite",
                "CROWVIEW",
                "Carbanak",
                "Cobalt Strike",
                "CobaltStrike",
                "DICELOADER",
                "DNSMessenger",
                "FOWLGAZE",
                "HALFBAKED",
                "JSSLoader",
                "KillACK",
                "LOADOUT",
                "Lizar",
                "Meterpreter",
                "Mimikatz",
                "POWERPLANT",
                "POWERSOURCE",
                "RDFSNIFFER",
                "SQLRAT",
                "Sekur",
                "Sekur RAT",
                "TEXTMATE",
                "Tirion",
                "VB Flash",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535885,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1653779923,
    "ts_modification_date": 1653779923,
    "files": {
        "pdf": "https://archive.orkl.eu/e9793279ecff87688fa3a2691511ed9ee5f7cbd3.pdf",
        "text": "https://archive.orkl.eu/e9793279ecff87688fa3a2691511ed9ee5f7cbd3.txt",
        "img": "https://archive.orkl.eu/e9793279ecff87688fa3a2691511ed9ee5f7cbd3.jpg"
    }
}