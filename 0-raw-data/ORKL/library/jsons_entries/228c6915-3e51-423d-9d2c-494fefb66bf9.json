{
    "id": "228c6915-3e51-423d-9d2c-494fefb66bf9",
    "created_at": "2023-01-12T15:07:48.330212Z",
    "updated_at": "2025-03-27T02:06:02.416303Z",
    "deleted_at": null,
    "sha1_hash": "22bea9eca63ecd2c2ad8db42b6bfa726a1fa1bc1",
    "title": "2018-05-17 - Analyzing an AZORult Attack – Evasion in a Cloak of Multiple Layers",
    "authors": "",
    "file_creation_date": "2022-05-27T21:36:26Z",
    "file_modification_date": "2022-05-27T21:36:26Z",
    "file_size": 573133,
    "plain_text": "# Analyzing an AZORult Attack – Evasion in a Cloak of Multiple Layers\n\n**[blog.minerva-labs.com/puffstealer-evasion-in-a-cloak-of-multiple-layers](https://blog.minerva-labs.com/puffstealer-evasion-in-a-cloak-of-multiple-layers)**\n\n[Tweet](https://twitter.com/share)\n\nAZORult is an info-stealing malware, that has evolved over time to become a multi layered\nfeature, that improves its chance not to get caught.\n\nDarwin’s theory of evolution by natural selection is over 150 years old, but evolution may\nalso occur as a result of artificial selection (also called selective breeding).\n\nIn our InfoSec universe the same biological principal applies to malware evolution. Attackers\nconstantly check the effect of specific features of their offensive tools in relation to its\nsurvivability and “genetically engineer” the malware to improve its functionality.\n\nIn the following post, we will go through the features of an information stealing malware.\nEach of the layers hiding its functionality is a feature carefully selected by its “breeders” to\nimprove its chances of surviving in the wild.\n\nUnpacking and Analyzing The Attack\n\n\n-----\n\nLast week Minerva prevented an attack at one of our customers sites. It was a classic\nmalicious email titled “Quotation Request – EP”. It was allegedly sent from an email account\nof an African energy company and just like countless similar attacks it had a malicious\nattachment. In this case, it was a RAR archive containing two files – a benign text file and a\n[Microsoft Word document weaponized with a DDE object. Once opened it downloaded an](https://blog.minerva-labs.com/prevented-by-minerva-labs-new-evasive-malware-technique-exploits-microsoft-dynamic-exchange?hsLang=en-us)\nMSI file from a compromised website:\n\n_The DDEAUTO object_\n\nThis file is an installer created from a regular executable using a free tool called msi2exe,\nwrapping the “plain” malicious Windows executable as an installer. That is only one of the\nfirst layers out of the many hiding the true essence of this malicious piece of code.\n\n[To obtain and analyze the executable, it can be extracted easily, using 7-Zip for example to](https://www.7-zip.org/download.html)\nopen the MSI as an archive:\n\n_An executable, hidden inside aksu.msi_\n\n\n-----\n\nIn our case the culprit is the resource named\n_Binary._D7D112F049BA1A655B5D9A1D0702DEE5, a normal Windows executable packed_\n[within the MSI. When taking a closer look at the file using PEStudio we see that this is not](https://www.winitor.com/)\nthe case:\n\n_Opening the executable in PEStudio, showing indicators of a compiled AutoIt script_\n\nIt turns out that this is a compiled AutoIt script – yet another layer wrapping the actual\n[payload. Luckily, there are free tools such as Exe2Aut which will decompile the executable.](http://domoticx.com/autoit3-decompiler-exe2aut/)\nHowever, the decompiled script is still obfuscated:\n\n\n-----\n\n_The decompiled script, fully obfuscated_\n\nAfter a quick analysis, it turns out that the obfuscation was not too sophisticated and relied\nmainly on a single string obfuscation function. Minerva’s team created a Python script for\ndeobfuscation which is freely available at:\n\nhttps://github.com/MinervaLabsResearch/BlogPosts/blob/master/ObfuscatedAutoItDecrypter/\nAutoIt_dec.py\n\nNow it is possible to go through the script and rename the variables with some manual labor:\n\n_The same snippet as above following the deobfuscation, in green – the deobfuscated strings_\n\nLooking at the deobfuscated script, it is now clear that a “classic” process hollowing\ntechnique was implemented entirely in AutoIt:\n\nThe malware creates a second suspended instance of the original process:\n\n\n-----\n\nIt allocates writable, executable memory:\n\nThe script writes the payload it wishes to execute to the remote process:\n\nAfter the next stage of the attack is located within the memory of the remote process,\nthe malware sets the main thread’s state to run the injected code and resume the\nprocess’ execution:\n\nThe injected payload itself was obfuscated using the same routine as the strings, so after we\nexecuted our deobfuscation script it was easier to observe it directly:\n\n_The injected payload, starting with MZ_\n\nThe first couple of bytes 4D and 5A which are the ASCII string MZ – the magic string in the\nbeginning of Windows executables. This is a strong indicator that the injected buffer is yet\nanother payload(!), and dumping it using another Python script proved that this is indeed the\ncase. Although the headers were partially corrupted it was possible to use PEstudio once\n\n\n-----\n\nagain to have a closer look at the binary file. Surprisingly, it turned out that the attacker didn t\nthink that all of the different techniques used so far are sufficient so UPX was used as well to\ncompress the executable, concealing itself even more:\n\n_Using PEStudio you may observe evidence for the fact that this file was compressed using_\n_UPX_\n\nSince the PE is corrupted it can’t be executed on its own, but there’s no need to do so. Even\nin its UPX-compressed form we found evidence of the fact that this is one of the final layers\nhiding the payload and did not bother fixing its structure. Observing the file using a hex editor\nshows multiple strings suggesting its goal is to steal passwords stored in the browser:\n\n_Some of the strings showing the ultimate goal of the attack_\n\nA quick Google search validates that this is part of a common SQL query for stealing\ncredentials stored in Google chrome:\n\n\n-----\n\n_Code snippet containing the same query for stealing passwords, shared in a public forum_\n\nSniffing the malware’s network activity proves that this is the functionality of the malware, as\nit first asks its C2 server for instructions, then receives instructions to steal passwords and\nsends it back:\n\n_“getconfig” signals the server to provide orders, the ‘steal passwords’ comand_\n_“IS_G_PWDS:1” is sent back_\n\n\n-----\n\n_A fingerprint of the machine is sent alongside the stolen data_\n\n[Following more in-depth hunting Minerva’s research team tracked down a builder which](https://www.virustotal.com/#/file/329030c400932d06642f9dbc5be71c59588f02d27d9f3823afa75df93407027b/detection)\ncreates almost the same payload. It enabled us to generate the injected payload as a noncorrupted binary, verifying our analysis conclusions. For example, now we were able to\nobserve the same SQL query for extracting passwords stored in Google Chrome alongside\nother similar techniques:\n\n\n-----\n\n_The same SQL query we’ve seen before, in a sample we’ve built using the builder_\n\nAs our friendly malware research community pointed out, this payload turned out to be\nAZORult – a well-known info-stealing malware which is offered for sale in different forums at\nleast since 2016.\n\nArtificial Selection in Practice\n\n\n-----\n\n_The general flow of the attack_\n\nThe packed AZORult malware in this campaign employs half a dozen techniques to evade\ndetection, demonstrating how its creators selectively “bred” it by trial and error their strain of\nstealer:\n\n**Using RAR archive**\n\n\n-----\n\nThe file was packed during its delivery as a compressed file archive, trying to overcome\nsome static scans and restrictions on “dangerous” filetype attachments.\n\n**Multiple layers**\n\nUsing multiple layers to conceal the final info-stealer functionlity may fool some security\nproducts unable to look “deep enough”, while others will fail to understand the context of\neach layer.\n\n**Using an MSI file to deliever the payload**\n\nSurprisingly many machine-learning antivirus solutions overlook this file type. However there\nwere some vendors that detected the file in a late stage since the binary payload is saved to\nthe temporary files folder but in other cases it might not be as simple and could be missed.\n\n**AutoIt**\n\nUsing a non-conventional scripting language, obfuscated and compiled, results in a binary\nfile which is significantly different than a more conventional C\\C++ executable. Products\nseeking patterns in the file itself will find it more difficult to detect the malware.\n\n**Injecting code**\n\nThis malware decrypts its payload in-memory, and only after a few layers of obfuscation\ntricks are employed.\n\n**DDE**\n\nInstead of relying upon old VBA macros, the attackers took advantage of the DDE “feature” –\nallowing them to embed their payload in the less suspicious docx format as macros can be\nused only in doc or docm formats.\n\nWe were able to track down previous attempts from the same actors showing the course of\nartificial selection they went through, distilling their latest ultimate survivor. For example,\nearlier variants opted for the SCR extensions instead of MSI. In a different case, the delivery\nmechanism was different and relied on a link to download the infected docx file directly from\nthe compromised website.\n\nEvasive Malware? Prevented by Minerva.\n\nMinerva’s [Anti-Evasion Platform prevents evasive threats. All that is required is that the](https://minerva-labs.com/minerva-anti-evasion-platform)\nmalware will use a single evasion technique for Minerva to prevent the attack. AZORult\ncampaigns evolve over time – adding more evasive features to bypass security products.\n\n\n-----\n\nMinerva s Anti-Evasion Platform has multiple modules that reinforce each other to prevent\n[different evasive techniques. In this case, the Malicious Document Prevention module breaks](https://minerva-labs.com/malicious-document-prevention)\nor otherwise disarms malicious document files that try to evade detection via macros,\nPowerShell and other scripts. By deceiving the malware regarding its ability to run scripts\nusing these advanced document capabilities, employees can safely enable macros and\nremain productive.\n\nThe attack is prevented at a very early stage when the DDE-weaponized document tries to\ndownload and execute the malicious MSI file:\n\n_Minerva prevents the download and execution of aksu.msi_\n\nMoreover, even if it was delivered in a non-evasive way Minerva would have blocked the\nattack with its [Memory Injection Prevention module, foiling the execution of AZORult.](https://minerva-labs.com/memory-injection)\n\n[Request a test drive today to see all this and more in action.](https://l.minerva-labs.com/test-drive?hsLang=en-us)\n\nIOC\n\n## URLs\n\nhxxp://ipool[.]by/bitrix/css/8/DOC71574662-QUOTATION[.]doc\nhxxp://ipool[.]by/bitrix/css/8/aksu[.]msi\nhxxp://www[.]sckm[.]Krakow[.]pl/aksu[.]msi\nhxxp://aksuperstore[.]com/fh8nzhme/gate[.]php\n\n## Files (SHA-256)\n\nAnalyzed DDE docx:\n\nac342e80cbdff7680b5b7790cc799e2f05be60e241c23b95262383fd694f5a7a\n\nAnalyzed MSI Installer:\n\n\n-----\n\ne7a842f67813a47bece678a1a5848b4722f737498303fafc7786de9a81d53d06\n\nUnzipped executable:\n\n717db128de25eec80523b36bfaf506f5421b0072795f518177a5e84d1dde2ef7\n\nDecompiled obfuscated AutoIt:\n\n31f807ddfc479e40d4d646ff859d05ab29848d21dee021fa7b8523d2d9de5edd\n\nDeobfuscated AutoIt:\n\nb074be8b1078c66106844b6363ff19226a6f94ce0d1d4dd55077cc30dd7819c5\n\nSimilar DDE document downloaded directly from a compromised website:\n\ndc3fac021fae581bf086db6b49f698f0adc80ebe7ca7a28e80c785673065a127\n\nThe builder (Trojanized):\n\n329030c400932d06642f9dbc5be71c59588f02d27d9f3823afa75df93407027b\n\nSimilar MSI installers:\n\nefa6af034648f8e08098ea56445ccab1af67376ca45723735602f9bdd59e5b5d\n9d7a10fa3e5fd2250e717d359fcff881d9591e0fe17795bab7aac747e8514247\ndc3fac021fae581bf086db6b49f698f0adc80ebe7ca7a28e80c785673065a127\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-05-17 - Analyzing an AZORult Attack – Evasion in a Cloak of Multiple Layers.pdf"
    ],
    "report_names": [
        "2018-05-17 - Analyzing an AZORult Attack – Evasion in a Cloak of Multiple Layers.pdf"
    ],
    "threat_actors": [
        {
            "id": "20bc5b83-9ea0-4e60-a23e-19bf203dc9fb",
            "created_at": "2022-10-25T16:07:24.432777Z",
            "updated_at": "2025-03-27T02:02:10.220082Z",
            "deleted_at": null,
            "main_name": "xHunt",
            "aliases": [
                "Cobalt Katana",
                "Hive0081",
                "Hunter Serpens",
                "SectorD01"
            ],
            "source_name": "ETDA:xHunt",
            "tools": [
                "CASHY200",
                "COLDTRAIN",
                "Gon",
                "Hisoka",
                "Killua",
                "Netero",
                "SHELLSTING",
                "Sakabota",
                "Snugy",
                "TriFive"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536068,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1653687386,
    "ts_modification_date": 1653687386,
    "files": {
        "pdf": "https://archive.orkl.eu/22bea9eca63ecd2c2ad8db42b6bfa726a1fa1bc1.pdf",
        "text": "https://archive.orkl.eu/22bea9eca63ecd2c2ad8db42b6bfa726a1fa1bc1.txt",
        "img": "https://archive.orkl.eu/22bea9eca63ecd2c2ad8db42b6bfa726a1fa1bc1.jpg"
    }
}