{
    "id": "43f38bfb-dca7-4674-9c6c-a2437d4637f4",
    "created_at": "2023-01-12T15:09:36.433134Z",
    "updated_at": "2025-03-27T02:17:05.687987Z",
    "deleted_at": null,
    "sha1_hash": "44c6dff1f7f5ad0c568066a6a68ab728cdf6ac3f",
    "title": "2022-11-16 - Inside the Mind of a ‘Rat’ - Agent Tesla Detection and Analysis",
    "authors": "",
    "file_creation_date": "2022-12-29T00:17:21Z",
    "file_modification_date": "2022-12-29T00:17:21Z",
    "file_size": 6628982,
    "plain_text": "# Inside the Mind of a ‘Rat’ - Agent Tesla Detection and Analysis\n\n**[splunk.com/en_us/blog/security/inside-the-mind-of-a-rat-agent-tesla-detection-and-analysis.html](https://www.splunk.com/en_us/blog/security/inside-the-mind-of-a-rat-agent-tesla-detection-and-analysis.html)**\n\nNovember 16, 2022\n\nBy [Splunk Threat Research Team November](https://www.splunk.com/en_us/blog/author/secmrkt-research.html)\n\n16, 2022\nAgent Tesla is a remote access trojan (RAT) written for the .NET framework that has\nknowingly been in operation since 2014. Threat actors behind this malware have leveraged\nmany different methods to deliver their payload over time including macro enabled Word\ndocuments, Microsoft Office vulnerabilities, OLE objects and most recently, compiled HTML\nhelp files. Agent Tesla has been in the top 10 most submitted samples in known open\nmalware source repositories in cyber security communities like Malware Bazaar and Any.run.\nIt is a full-featured RAT with multiple ways to exfiltrate organization data through keylogging,\nscreen captures, credential stealing and much more.\n\nIn this blog post, the Splunk Threat Research Team (STRT) describes the different tactics,\ntechniques and procedures mapped to the ATT&CK framework leveraged by this remote\naccess trojan. Additionally, we will highlight the detection analytics we released that can help\ncyber defenders in identifying signs of compromise.\n\n## Analysis\n\n### Identification of Samples\n\n\n-----\n\n[For this analysis, the STRT started the journey with a sample uploaded by JAMESWT_MHT](https://twitter.com/JAMESWT_MHT/status/1564978411436736512?s=20&t=c6HRwWIpc2WYV9ld6S_62g)\non August 31st to [Malware Bazaar. This sample led us to the “ftp-boloni-ma” tag that](https://bazaar.abuse.ch/)\ncompiles several samples of a campaign leveraging the Agent Tesla malware. Specifically,\nthis campaign used a malicious compiled HTML (.CHM) file as a delivery method to drop and\nexecute its first and second stages and load the remote access trojan.\n\n[High level flow of process execution for this sample is shown on Figure 1:](https://app.any.run/tasks/803bc852-0431-41b2-8270-9c7635ed9cf6/)\n\nFigure 1.1 shows the list of hashes that have this tag.\n\nSecurity teams that would like to understand how the execution of compiled HTML files looks\nlike against their prevention or detection controls, we recommend having a look at the\n[AtomicTestHarness for](https://github.com/redcanaryco/AtomicTestHarnesses) [CHM and the Atomic Red Team technique T1218.001 built by the](https://github.com/redcanaryco/AtomicTestHarnesses/tree/master/Windows/TestHarnesses/T1218.001_CompiledHTMLFile)\nRed Canary team.\n\n### T1566.001 - Spear Phishing Attachment\n\n\n-----\n\nThis Agent Tesla variant uses a compiled HTML file (.chm) to conceal its malicious code and\ngain an initial foothold on the victim endpoint. The file has an embedded and obfuscated\nJavaScript script that invokes PowerShell to download a second stage.\n\nFigure 1.1 shows the .chm file loading upon execution.\n\nFigure 1.2 shows the obfuscated and deobfuscated versions of the embedded Javascript\ncode. Once executed, it will invoke PowerShell.exe to download extra content from the\n[Internet using the System.Net WebClient class and the DownloadString method.](https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net)\n\n\n-----\n\n### The Loader\n\n**T1059.001 - Command and Scripting Interpreter: PowerShell**\n\nThe downloaded file, disguised as a text .txt file, is in reality a PowerShell script shown on\nFigure 2. This obfuscated second stage script is the one responsible for loading the actual\nAgent Tesla malware in memory.\n\nThe variable named $TzbW contains a string that when deobfuscated, implements the\ntMCfkSD function also shown on Figure 2. This function will in turn deobfuscate and\ndecompress the array of bytes stored in the variable named $zmOo. This deobfuscated and\ndecompressed version is the actual .NET assembly Agent Tesla malware that will be\nexecuted in memory using PowerShell reflection.\n\nFigure 2 shows the main parts of this second stage component and the gzip decompression\nfunction.\n\n\n-----\n\nFigure 2.1 shows a screenshot of a simple python script we wrote to deobfuscate the\nPowerShell function Agent Tesla’s second stage uses to decompress and deobfuscate the\nbinary stored in the $zmOo array byte variable. The python script can be found on Github\n[agent_function_loader_deobfus.py](https://github.com/tccontre/KnowledgeBase/blob/main/malware_re_tools/AgentTesla-%20Loader/agent_function_loader_deobfus.py)\n\nThis loader will deobfuscate and load the Agent Tesla malware in memory stream using\n.NET Reflection. This part of its execution can be considered as fileless malware since it\ndoesn't drop the AgentTesla malware on the disk but executes it in memory stream.\n\nFigure 2.2 shows the python script we wrote to extract the actual AgentTesla malware binary.\nThis python script will drop the Agent Tesla malware as agent_unpack.bin in the current\nworking directory. The script can be found on Github [agent_function_loader_deobfus2.py.](https://github.com/tccontre/KnowledgeBase/blob/main/malware_re_tools/AgentTesla-%20Loader/agent_function_loader_deobfus2.py)\n\n\n-----\n\n## Agent Tesla Analysis\n\n### Packer/ Obfuscator\n\nThe Agent Tesla sample extracted in the second stage component is a .NET compiled binary\n[obfuscated with the opensource Obfuscar .NET obfuscator. Using the DIE tool we can](https://github.com/obfuscar/obfuscar)\nidentify the obfuscation method and the compilation type of this file in Figure 3. Adversaries\nwill pack or obfuscate their payloads in hope that it evades critical controls like mail\ngateways, sandboxes and anti-virus software.\n\n\n-----\n\n### Discovery - TA0007\n\n**T1033 - System Owner/User Discovery**\n\nOn every check in to the command and control server (via the FTP, HTTP or SMTP\nprotocols), this Agent Tesla sample parses and submites the user name, computer name,\noperating system version and total physical memory of the compromised endpoint.\n\n\n-----\n\n_Figure 4_\n\n### Execution - TA0002\n\n**T1204.002 - Malicious File**\n\nThis particular Agent Tesla sample includes the ability to download a remote file from one of\nits C2 servers and save it to the hardcoded path “%temp%\\LUU”. The final step of the\nfunction will also execute the downloaded file. Unfortunately the URL was inaccessible as of\nwriting.\n\n\n-----\n\nFigure 4 shows the code snippet of how it captures the system information of the\ncompromised machine as part of its C2 communication.\n\n### Persistence - TA0003\n\n**T1547.001 - Registry Run / Startup Folder**\n\nIf enabled, Agent Tesla has two built in persistence mechanisms to be able to load itself upon\nboot. It is either by dropping a copy of itself in the %startup folder% or by adding registry run\nkeys.\n\nFigure 5.1 and Figure 5.2 shows a short code snippet how it can create Registry Run Keys\nand possible entry on startup folder for its persistence(T1547.001).\n\n_Figure 5.1_\n\n\n-----\n\n_Figure 5.2_\n\n### Credential Access - TA0006\n\nAgent Tesla implements several techniques to collect sensitive information on the\ncompromised endpoint.\n\n**T1555.003 - Credentials from Web Browsers**\n\nThe first technique is parsing credentials or sensitive browser data. Agent Tesla includes a\nlist of targeted browsers to parse the login credentials, browser cookies, browser profiles and\ngrab browser .sqlite database files. Figure 6 shows a short code snippet of the function\nrenamed as “mw_parsing_browser_db” that contains the list of browsers that Agent Tesla\nattempts to parse or copy the “cookies.sqlite” database file.\n\nBelow is a complete table list of targeted browsers.\n\n**Targeted Browsers (Browser Name, Browsers Target Directory)**\n\n\"Firefox\", \"%APPDATA%\\\\Mozilla\\\\Firefox\\\\\"\n\"IceCat\", \"%APPDATA%\\\\Mozilla\\\\icecat\\\\\"\n\"PaleMoon\", \"%APPDATA%\\\\Moonchild Productions\\\\Pale Moon\\\\\"\n\"SeaMonkey\", \"%APPDATA%\\\\Mozilla\\\\SeaMonkey\\\\\"\n\"Flock\", \"%APPDATA%\\\\Flock\\\\Browser\\\\\"\n\"K-Meleon\", \"%APPDATA%\\\\K-Meleon\\\\\"\n\"Postbox\", \"%APPDATA%\\\\Postbox\\\\\"\n\"Thunderbird\", \"%APPDATA%\\\\Thunderbird\\\\\"\n\n\n-----\n\nIceDragon, %APPDATA%\\\\Comodo\\\\IceDragon\\\\\n\"WaterFox\", \"%APPDATA%\\\\Waterfox\\\\\"\n\"BlackHawk\", \"%APPDATA%\\\\NETGATE Technologies\\\\BlackHawk\\\\\"\n\"CyberFox\", \"%APPDATA%\\\\8pecxstudios\\\\Cyberfox\\\\\"\n\"Opera Browser\", \"%APPDATA%\\\\Opera Software\\\\Opera Stable\"\n\"Yandex Browser\", \"%APPDATA%\\\\Yandex\\\\YandexBrowser\\\\User Data\"\n\"Iridium Browser\", \"%APPDATA%\\\\Iridium\\\\User Data\"\n\"Chromium\", \"%APPDATA%\\\\Chromium\\\\User Data\"\n\"7Star\", \"%APPDATA%\\\\7Star\\\\7Star\\\\User Data\"\n\"Torch Browser\", \"%APPDATA%\\\\Torch\\\\User Data\"\n\"Cool Novo\", \"%APPDATA%\\\\MapleStudio\\\\ChromePlus\\\\User Data\"\n\"Kometa\", \"%APPDATA%\\\\Kometa\\\\User Data\"\n\"Amigo\", \"%APPDATA%\\\\Amigo\\\\User Data\"\n\"Brave\", \"%APPDATA%\\\\BraveSoftware\\\\Brave-Browser\\\\User Data\"\n\"CentBrowser\", \"%APPDATA%\\\\CentBrowser\\\\User Data\"\n\"Chedot\", \"%APPDATA%\\\\Chedot\\\\User Data\"\n\"Orbitum\", \"%APPDATA%\\\\Orbitum\\\\User Data\"\n\"Sputnik\", \"%APPDATA%\\\\Sputnik\\\\Sputnik\\\\User Data\"\n\"Comodo Dragon\", \"%APPDATA%\\\\Comodo\\\\Dragon\\\\User Data\"\n\"Vivaldi\", \"%APPDATA%\\\\Vivaldi\\\\User Data\"\n\"Citrio\", \"%APPDATA%\\\\CatalinaGroup\\\\Citrio\\\\User Data\"\n\"360 Browser\", \"%APPDATA%\\\\360Chrome\\\\Chrome\\\\User Data\"\n\"Uran\", \"%APPDATA%\\\\uCozMedia\\\\Uran\\\\User Data\"\n\"Liebao Browser\", \"%APPDATA%\\\\liebao\\\\User Data\"\n\"Elements Browser\", \"%APPDATA%\\\\Elements Browser\\\\User Data\"\n\"Epic Privacy\", \"%APPDATA%\\\\Epic Privacy Browser\\\\User Data\"\n\"Coccoc\", \"%APPDATA%\\\\CocCoc\\\\Browser\\\\User Data\"\n\"Sleipnir 6\", \"%APPDATA%\\\\Fenrir\nInc\\\\Sleipnir5\\\\setting\\\\modules\\\\ChromiumViewer\"\n\"Opera\", \"%APPDATA%\\\\Opera Software\\\\Opera Stable\"\n\"Comodo Dragon\", \"%APPDATA%\\\\\"Comodo\\\\Dragon\\\\User Data\"\n\"Chrome\", \"%APPDATA%\\\\Google\\\\Chrome\\\\User Data\"\n\"Yandex\", \"%APPDATA%\\\\\"Yandex\\\\YandexBrowser\\\\User Data\"\n\"SRWare Iron\", \"%APPDATA%\\\\\"Chromium\\\\User Data\"\n\"Torch Browser\", \"%APPDATA%\\\\\"Torch\\\\User Data\"\n\"Brave Browser\", \"%APPDATA%\\\\\"BraveSoftware\\\\Brave-Browser\\\\User Data\"\n\"CoolNovo\", \"%APPDATA%\\\\\"MapleStudio\\\\ChromePlus\\\\User Data\"\n\"7Star\", \"%APPDATA%\\\\\"7Star\\\\7Star\\\\User Data\"\n\"Epic Privacy Browser\", \"%APPDATA%\\\\\"Epic Privacy Browser\\\\User Data\"\n\"Amigo\", \"%APPDATA%\\\\\"Amigo\\\\User Data\"\n\"CentBrowser\", \"%APPDATA%\\\\\"CentBrowser\\\\User Data\"\n\"CocCoc\", \"%APPDATA%\\\\\"CocCoc\\\\Browser\\\\User Data\"\n\"Chedot\", \"%APPDATA%\\\\\"Chedot\\\\User Data\"\n\"Elements Browser\", \"%APPDATA%\\\\\"Elements Browser\\\\User Data\"\n\"Kometa\", \"%APPDATA%\\\\\"Kometa\\\\User Data\"\n\"Citrio\", \"%APPDATA%\\\\\"CatalinaGroup\\\\Citrio\\\\User Data\"\n\"Coowon\", \"%APPDATA%\\\\\"Coowon\\\\Coowon\\\\User Data\"\n\"Liebao Browser\", \"%APPDATA%\\\\\"liebao\\\\User Data\"\n\"QIP Surf\", \"%APPDATA%\\\\\"QIP Surf\\\\User Data\"\n\"QQ Browser\", \"%APPDATA%\\\\\"Tencent\\\\QQBrowser\\\\User Data\"\n\"UC Browser\", \"%APPDATA%\\\\\"UCBrowser\\\\\"\n\"Orbitum\", \"%APPDATA%\\\\\"Orbitum\\\\User Data\"\n\n\n-----\n\nSputnik, %APPDATA%\\\\ Sputnik\\\\Sputnik\\\\User Data\n\"uCozMedia\", \"%APPDATA%\\\\\"uCozMedia\\\\Uran\\\\User Data\"\n\"Vivaldi\", \"%APPDATA%\\\\\"Vivaldi\\\\User Data\"\n\"QIP Surf\", \"%APPDATA%\\\\QIP Surf\\\\User Data\"\n\"Coowon\", \"%APPDATA%\\\\Coowon\\\\Coowon\\\\User Data\"\n\n### T1555.005 - Password Managers\n\nAside from stealing browser secrets, it also attempts to steal passwords from commonly\nused applications like OpenVpn, FileZilla and Mailbird. It accomplishes this by reading\nregistry entries, decrypting/decoding or parsing local databases or by reading configuration\nfiles. The table below is the list of the targeted applications that are related to this data\ncollection.\n\n\nOPEN VPN\n\nFLASHFXP\n\nWINSCP\n\nNORDVPN\n\nIE EDGE\n\nPALE MOON\n\nFTP CMDER\n\nICECAT\n\nINCREDIMAIL\n\nPIA\n\n\nCYBERFOX\n\nPOC MAIL\n\nPOSTBOX\nOUTLOOK\n\nFTP GETTER\n\nRimArts\n\nMAILBIRD\n\nFLOCK BROWSER\n\nOPERA\n\nQQBROWSER\n\nWS_FTP\n\nMS CREDENTIALS\n\nManagerMULTI-VNC\n\n\nTHUNDERBIRD\n\nUC BROWSERS\n\nMYSQL WORKBENCH\n\nFALKON\n\nAPPLE KEYCHAIN\n\nWATERFOX\n\nJDOWNLOADER DB\n\nSMARTFTP\n\nTRILLIAN\n\nCOREFTPCLAWS MAIL\n\n\nFILEZILLA\n\nAEROFOX\n\nBLACKHAWK\n\nEM CLIENT\nSEA MONKEY\n\nICE DRAGON\nPSI\n\nDOWNLOADMGR\n\nK-MELEON\n\nFTP NAVI\n\nUBATMAILBIRD\n\n\n**T1056.001 - KeyLogging**\n\nThis Agent Tesla sample is also capable of installing a Keylogger on the compromised host.\nIt uses the SetWindowsHookEx Windows API to install a hook procedure that monitors lowlevel keyboard input events. Figure 7 shows the code snippet where it setup the windows\nhook procedure for keyboard events.\n\n\n-----\n\n_Figure 7_\n\n### Command And Control - TA0011\n\n**T1090.003 - TOR Proxy**\n\nAgent Tesla also uses TOR proxy for its HTTP requests. It tries to download a TOR\napplication on a specific TOR website. Figure 8 shows its function that downloads the TOR\nbrowser that will be saved as “tor.zip” file in the%appdata% folder.\n\n_Figure 8_\n\n### Collection - TA0009\n\n**T1113 - Screen Capture**\n\nFigure 9 shows the code snippet of how Agent Tesla software captures the desktop\nscreenshot of the compromised machine and it will be saved in the memory stream and later\nsent to its C2 server.\n\n\n-----\n\n_Figure 9_\n\n### Exfiltration - TA0010\n\n**T1041 - Exfiltration Over C2 Channel**\n\nDuring analysis of this Agent Tesla sample it was identified to have 3 ways to exfiltrate stolen\nsensitive information of the compromised host. The exfiltrated data may be either sent via\nFTP, SMTP and HTTP command and control server. Figure 10 shows the code snippet on\nhow the agent will set up each method to exfiltrate data.\n\n\n-----\n\nThe remote C2 server was down during the analysis of this sample. STRT experimented with\nits SMTP communication to be able to see how the exfiltrated data looks like on the attacker\n[side. We used a fake SMTP server by rnwood (smtp4dev) to forward all the exfiltrated data](https://github.com/rnwood/smtp4dev)\nof this sample.\n\n### Attacker Perspective\n\n**Data Exfiltration**\n\nFigure 11 shows the email sent by the Agent Tesla to the fake SMTP server containing a .zip\nfile attachment with the filename format “CO_<username>/<ComputerName>\n<DateTime>.zip”.\n\nThis .zip file contains the collected browser data, which in our case is the cookie.sqlite file.\n\n\n-----\n\nIn addition, it includes the basic system information which is the UserName, ComputerName,\nOSFullName, CPU and RAM.\n\n_Figure 11_\n\nFigure 12 shows the email sent by the Agent Tesla malware related to the desktop\nscreenshots of the compromised machine. We can see that it has same format email body\nthat contain system information, except that the format of the desktop screenshot .jpeg file is\n“SC_<username>/<ComputerName><DateTime>.jpeg”\n\n_Figure 12_\n\n\n-----\n\nLastly Figure 13.1 (notepad++) and 13.2 (firefox) shows the email sent by this sample during\nour testing related to its keylogging feature. This malware checks if the log.tmp (keylog file)\nin %temp% exists; if not, it will directly send the keystroke that keylogs in its C2, in this case\nvia SMTP.\n\nBelow shows the couple of keys typed by the user and the process related to that keystroke.\n\n_Figure 13.1_\n\n\n-----\n\n_Figure 13.2_\n\nFor this type of exfiltration the subject of the email has a format of\n“KL_<username>/<ComputerName>”.\n\n## Detections\n\nBelow is the table list for detections that the STRT developed to identify possible Agent Tesla\nbehavior and malicious .chm behavior.\n\n\n**Type** **Name** **Technique**\n**ID**\n\n\n**Tactic** **Description**\n\n\nTTP Detect Html Help\n[Spawn Child](https://research.splunk.com/endpoint/723716de-ee55-4cd4-9759-c44e7e55ba4b/)\nProcess\n\nAnomaly Excessive Usage\nOf Taskkill\n\n\n[T1218.001](https://attack.mitre.org/techniques/T1218/001/) Defense\nEvasion\n\n[T1562.001](https://attack.mitre.org/techniques/T1562/001/) Defense\nEvasion\n\n\nThe following analytic\nidentifies hh.exe (HTML Help)\nexecution of a Compiled\nHTML Help (CHM) that\nspawns a child process.\n\nThis analytic identifies\nexcessive usage of\ntaskkill.exe application.\n\n\n-----\n\nTTP Executables Or\n[Script Creation In](https://research.splunk.com/endpoint/a7e3f0f0-ae42-11eb-b245-acde48001122/)\nSuspicious Path\n\nAnomaly Non Chrome\nProcess\n[Accessing](https://research.splunk.com/endpoint/81263de4-160a-11ec-944f-acde48001122/)\nChrome Default\nDir\n\nAnomaly Non Firefox\n[Process Access](https://research.splunk.com/endpoint/e6fc13b0-1609-11ec-b533-acde48001122/)\nFirefox Profile Dir\n\nTTP Office Application\nDrop Executable\n\nTTP Office Application\n[Spawn Rundll32](https://research.splunk.com/endpoint/958751e4-9c5f-11eb-b103-acde48001122/)\nProcess\n\nTTP Office Document\n[Executing Macro](https://research.splunk.com/endpoint/b12c89bc-9d06-11eb-a592-acde48001122/)\nCode\n\nHunting Powershell\nConnect To\nInternet With\nHidden Window\n\n\n[T1036](https://attack.mitre.org/techniques/T1036/) Defense\nEvasion\n\n[T1555.003](https://attack.mitre.org/techniques/T1555/003/) Credential\nAccess\n\n[T1555.003](https://attack.mitre.org/techniques/T1555/003/) Credential\nAccess\n\n[T1566.001](https://attack.mitre.org/techniques/T1566/001/) Initial\nAccess\n\n[T1566.001](https://attack.mitre.org/techniques/T1566/001/) Initial\nAccess\n\n[T1566.001](https://attack.mitre.org/techniques/T1566/001/) Initial\nAccess\n\n\n[T1059](https://attack.mitre.org/techniques/T1059/) [Execution](https://attack.mitre.org/tactics/TA0002) The following hunting analytic\nidentifies PowerShell\ncommands utilizing the\nWindowStyle parameter to\nhide the window on the\ncompromised endpoint.\n\n\nThis analytic will identify\nsuspicious executable or\nscripts (known file extensions)\nin a list of suspicious file paths\nin Windows.\n\nThis search is to detect an\nanomaly event of a nonchrome process accessing the\nfiles in chrome user default\nfolder.\n\nThis search is to detect an\nanomaly event of a non-firefox\nprocess accessing the files in\nthe profile folder.\n\nThis search is to detect a\nsuspicious MS office\napplication that drops or\ncreates executables or scripts\nin a Windows Operating\nSystem.\n\nThis detection was designed\nto identify suspicious spawned\nprocesses of known MS office\napplications due to macro or\nmalicious code.\n\nthis detection was designed to\nidentifies suspicious office\ndocuments\n\nthat using macro code.\n\n\n-----\n\nTTP Scheduled Task\n[Deleted Or](https://research.splunk.com/endpoint/d5af132c-7c17-439c-9d31-13d55340f36c/)\nCreated Via Cmd\n\nTTP Suspicious\nProcess File Path\n\nTTP Detect Html Help\n[Spawn Child](https://research.splunk.com/endpoint/723716de-ee55-4cd4-9759-c44e7e55ba4b/)\nProcess\n\nTTP Registry Keys\n[Used For](https://research.splunk.com/endpoint/c9f4b923-f8af-4155-b697-1354f5bcbc5e/)\nPersistence (mod)\n\nHunting Windows Iso Lnk\nFile\nCreation (mod)\n\nHunting Windows\nPhishing Recent\nIso Exec\nRegistry (mod)\n\nTTP Powershell\nLoading Dotnet\nInto Memory Via\nReflection (mod)\n\n\n[T1053.005](https://attack.mitre.org/techniques/T1053/005/) [Execution,](https://attack.mitre.org/tactics/TA0002)\n[Persistence,](https://attack.mitre.org/tactics/TA0003)\nPrivilege\nEscalation\n\n[T1543](https://attack.mitre.org/techniques/T1543/) [Execution,](https://attack.mitre.org/tactics/TA0002)\n[Persistence,](https://attack.mitre.org/tactics/TA0003)\nPrivilege\nEscalation\n\n[T1218.001](https://attack.mitre.org/techniques/T1218/001/) Defense\nEvasion\n\n[T1546.012](https://attack.mitre.org/techniques/T1546/012/) [Persistence,](https://attack.mitre.org/tactics/TA0003)\nPrivilege\nEscalation\n\n[T1566.001](https://attack.mitre.org/techniques/T1566/001/) Initial\nAccess\n\n[T1566.001](https://attack.mitre.org/techniques/T1566/001/) Initial\nAccess\n\n\n[T1059.001](https://attack.mitre.org/techniques/T1059/001/) [Execution](https://attack.mitre.org/tactics/TA0002) The following analytic utilizes\nPowerShell Script Block\nLogging (EventCode=4104) to\nidentify suspicious PowerShell\nexecution.\n\n\nThe following analytic\nidentifies the creation or\ndeletion of a scheduled task\nusing schtasks.exe with flags create or delete being passed\non the command-line.\n\nThe following analytic will\ndetect a suspicious process\nrunning in a file path where a\nprocess is not commonly seen\nand is most commonly used\nby malicious software.\n\nThe following analytic\nidentifies hh.exe (HTML Help)\nexecution of a Compiled\nHTML Help (CHM) that\nspawns a child process.\n\nThis search looks for\nmodifications to registry keys\nthat can be used to elevate\nprivileges.\n\nThe following analytic\nidentifies the use of a\ndelivered ISO file that has\nbeen mounted and the\naforementioned lnk or file\nopened within it.\n\nThe following hunting analytic\nidentifies registry artifacts\nwhen an ISO container is\nopened, clicked or mounted\non the Windows operating\nsystem.\n\n\n-----\n\nHunting Windows File\nTransfer Protocol\n[In Non Common](https://research.splunk.com/endpoint/0f43758f-1fe9-470a-a9e4-780acc4d5407/)\nProcess\nPath(new)\n\nAnomaly Windows Mail\nProtocol In Non\nCommon Process\nPath (new)\n\nAnomaly Windows Multi\nHop Proxy Tor\nWebsite\nQuery (new)\n\n\n[T1071.003](https://attack.mitre.org/techniques/T1071/003/) Command\nand Control\n\n[T1071.003](https://attack.mitre.org/techniques/T1071/003/) Command\nand Control\n\n[T1071.003](https://attack.mitre.org/techniques/T1071/003/) Command\nand Control\n\n\nThe following analytic\nidentifies a possible windows\napplication having a FTP\nconnection in a non common\ninstallation path in windows\noperating system.\n\nThe following analytic\nidentifies a possible windows\napplication having a SMTP\nconnection in a non common\ninstallation path in windows\noperating system.\n\nThe following analytic\nidentifies a dns query to a\nknown TOR proxy website.\n\n\n## Automate with SOAR Playbooks\n\nAll of the previously listed detections create entries in the risk index by default, and can be\n[used seamlessly with risk notables and the Risk Notable Playbook Pack. The community](https://docs.splunk.com/Documentation/ESSOC/3.51.0/user/Useplaybookpack?_gl=1*1exyg5h*_ga*MTI4MTM3OTkzNi4xNjI2MDI5MzQx*_gid*MTA5MjE4ODYwMi4xNjY3MjM1MTk1*_ga_5EPM2P39FV*MTY2NzIzNTE5NS43OS4xLjE2NjcyMzUyMTAuNDUuMC4w&_ga=2.84261913.1092188602.1667235195-1281379936.1626029341)\nSplunk SOAR playbooks below can also be used in conjunction with some of the previously\ndescribed analytics:\n\n**Playbook** **Description**\n\n\nInternal\n[Host SSH](https://research.splunk.com/playbooks/internal_host_ssh_investigate)\nInvestigate\n\nInternal\nHost\nWinRM\nInvestigate\n\nDelete\n[Detected](https://research.splunk.com/playbooks/delete_detected_files/)\nFiles\n\n\nInvestigate an internal *nix host using SSH. This pushes a bash script to the\nendpoint and runs it, collecting generic information about the processes, user\nactivity and network activity. This includes the process list, login history, cron\njobs and open sockets. The results are zipped up in .csv files and added to\nthe vault for an analyst to review.\n\nPerforms a general investigation on key aspects of a windows device using\nwindows remote management. Important files related to the endpoint are\ngenerated, bundled into a zip, and copied to the container vault.\n\nThis playbook acts upon events where a file has been determined to be\nmalicious (ie webshells being dropped on an end host). Before deleting the\nfile, we run a “more” command on the file in question to extract its contents.\nWe then run a delete on the file in question.\n\n\n-----\n\n## Why Should You Care?\n\nWith this article the Splunk Threat Research Team (STRT) enables security analysts, blue\nteamers and [Splunk customers to identify the Agent Tesla tactics, techniques and](https://www.splunk.com/en_us/customers.html)\nprocedures. By understanding its behaviors, we were able to generate telemetry and\ndatasets to develop and test Splunk detections designed to defend and respond against this\ntype of threats.\n\n## Learn More\n\n[You can find the latest content about security analytic stories on GitHub and in Splunkbase.](https://github.com/splunk/security-content/releases/tag/v3.12.0)\n[Splunk Security Essentials also has all these detections now available via push update.](https://splunkbase.splunk.com/app/3435/)\n\nFor a full list of security content, check out the [release notes on](https://docs.splunk.com/Documentation/ESSOC/3.21.0/RN/Enhancements) [Splunk Docs.](https://docs.splunk.com/Documentation/ESSOC)\n\n## Feedback\n\nAny feedback or requests? Feel free to put in an issue on Github and we’ll follow up.\nAlternatively, join us on the [Slack channel #security-research. Follow these instructions if you](https://splunk-usergroups.slack.com/)\nneed an invitation to our Splunk user groups on Slack.\n\n## Contributors\n\n[We would like to thank Teoderick Contreras,](https://twitter.com/tccontre18) [Michael Haag,](https://twitter.com/M_haggis) [Mauricio Velazco and](https://twitter.com/mvelazco) [Lou Stella](mailto:lstella@splunk.com)\nfor their contributions to this post.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-11-16 - Inside the Mind of a ‘Rat’ - Agent Tesla Detection and Analysis.pdf"
    ],
    "report_names": [
        "2022-11-16 - Inside the Mind of a ‘Rat’ - Agent Tesla Detection and Analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "75455540-2f6e-467c-9225-8fe670e50c47",
            "created_at": "2022-10-25T16:07:23.740266Z",
            "updated_at": "2025-03-27T02:02:09.955585Z",
            "deleted_at": null,
            "main_name": "Iridium",
            "aliases": [],
            "source_name": "ETDA:Iridium",
            "tools": [
                "CHINACHOPPER",
                "China Chopper",
                "LazyCat",
                "Powerkatz",
                "SinoChopper",
                "reGeorg"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "eb3f4e4d-2573-494d-9739-1be5141cf7b2",
            "created_at": "2022-10-25T16:07:24.471018Z",
            "updated_at": "2025-03-27T02:02:10.24394Z",
            "deleted_at": null,
            "main_name": "Cron",
            "aliases": [],
            "source_name": "ETDA:Cron",
            "tools": [
                "Catelites",
                "Catelites Bot",
                "CronBot",
                "TinyZBot"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "0661a292-80f3-420b-9951-a50e03c831c0",
            "created_at": "2023-01-06T13:46:38.928796Z",
            "updated_at": "2025-03-27T02:00:02.953963Z",
            "deleted_at": null,
            "main_name": "IRIDIUM",
            "aliases": [],
            "source_name": "MISPGALAXY:IRIDIUM",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a66438a8-ebf6-4397-9ad5-ed07f93330aa",
            "created_at": "2022-10-25T16:47:55.919702Z",
            "updated_at": "2025-03-27T02:05:17.412024Z",
            "deleted_at": null,
            "main_name": "IRON VIKING",
            "aliases": [
                "ATK14 ",
                "BlackEnergy Group",
                "Blue Echidna ",
                "CTG-7263 ",
                "ELECTRUM ",
                "FROZENBARENTS ",
                "Hades/OlympicDestroyer ",
                "IRIDIUM ",
                "Qudedagh ",
                "Sandworm Team ",
                "Seashell Blizzard ",
                "TEMP.Noble ",
                "Telebots ",
                "Voodoo Bear ",
                "APT44 "
            ],
            "source_name": "Secureworks:IRON VIKING",
            "tools": [
                " BlackEnergy",
                " GCat",
                " GreyEnergy",
                " Industroyer",
                " KillDisk",
                " NotPetya",
                " PSCrypt",
                " TeleBot",
                " TeleDoor",
                " xData",
                "BadRabbit"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b3e954e8-8bbb-46f3-84de-d6f12dc7e1a6",
            "created_at": "2022-10-25T15:50:23.339976Z",
            "updated_at": "2025-03-27T02:00:55.446795Z",
            "deleted_at": null,
            "main_name": "Sandworm Team",
            "aliases": [
                "Sandworm Team",
                "ELECTRUM",
                "Telebots",
                "IRON VIKING",
                "BlackEnergy (Group)",
                "Quedagh",
                "Voodoo Bear",
                "IRIDIUM",
                "Seashell Blizzard",
                "FROZENBARENTS",
                "APT44"
            ],
            "source_name": "MITRE:Sandworm Team",
            "tools": [
                "Bad Rabbit",
                "Mimikatz",
                "Exaramel for Linux",
                "Exaramel for Windows",
                "GreyEnergy",
                "PsExec",
                "Prestige",
                "P.A.S. Webshell",
                "VPNFilter",
                "Cyclops Blink",
                "SDelete",
                "AcidRain",
                "Industroyer",
                "Industroyer2",
                "BlackEnergy",
                "Cobalt Strike",
                "NotPetya",
                "KillDisk",
                "PoshC2",
                "Impacket",
                "Invoke-PSImage",
                "Olympic Destroyer"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8941e146-3e7f-4b4e-9b66-c2da052ee6df",
            "created_at": "2023-01-06T13:46:38.402513Z",
            "updated_at": "2025-03-27T02:00:02.824555Z",
            "deleted_at": null,
            "main_name": "Sandworm",
            "aliases": [
                "G0034",
                "IRIDIUM",
                "Blue Echidna",
                "FROZENBARENTS",
                "Seashell Blizzard",
                "IRON VIKING",
                "ELECTRUM",
                "TeleBots",
                "UAC-0113",
                "UAC-0082",
                "APT44",
                "Quedagh",
                "VOODOO BEAR",
                "TEMP.Noble"
            ],
            "source_name": "MISPGALAXY:Sandworm",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "7bd810cb-d674-4763-86eb-2cc182d24ea0",
            "created_at": "2022-10-25T16:07:24.1537Z",
            "updated_at": "2025-03-27T02:02:10.126127Z",
            "deleted_at": null,
            "main_name": "Sandworm Team",
            "aliases": [
                "APT 44",
                "ATK 14",
                "BE2",
                "Blue Echidna",
                "CTG-7263",
                "FROZENBARENTS",
                "IRIDIUM",
                "Iron Viking",
                "Quedagh",
                "Sandworm",
                "Sandworm Team",
                "Seashell Blizzard",
                "TEMP.Noble",
                "UAC-0082",
                "UAC-0113",
                "UAC-0125",
                "UAC-0133",
                "Voodoo Bear"
            ],
            "source_name": "ETDA:Sandworm Team",
            "tools": [
                "AWFULSHRED",
                "ArguePatch",
                "BIASBOAT",
                "Black Energy",
                "BlackEnergy",
                "CaddyWiper",
                "Colibri Loader",
                "Cyclops Blink",
                "CyclopsBlink",
                "DCRat",
                "DarkCrystal RAT",
                "Fobushell",
                "GOSSIPFLOW",
                "Gcat",
                "IcyWell",
                "Industroyer2",
                "JaguarBlade",
                "JuicyPotato",
                "Kapeka",
                "KillDisk.NCX",
                "LOADGRIP",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "ORCSHRED",
                "P.A.S.",
                "PassKillDisk",
                "Pitvotnacci",
                "PsList",
                "QUEUESEED",
                "RansomBoggs",
                "RottenPotato",
                "SOLOSHRED",
                "SwiftSlicer",
                "VPNFilter",
                "Warzone",
                "Warzone RAT",
                "Weevly"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536176,
    "ts_updated_at": 1743041825,
    "ts_creation_date": 1672273041,
    "ts_modification_date": 1672273041,
    "files": {
        "pdf": "https://archive.orkl.eu/44c6dff1f7f5ad0c568066a6a68ab728cdf6ac3f.pdf",
        "text": "https://archive.orkl.eu/44c6dff1f7f5ad0c568066a6a68ab728cdf6ac3f.txt",
        "img": "https://archive.orkl.eu/44c6dff1f7f5ad0c568066a6a68ab728cdf6ac3f.jpg"
    }
}