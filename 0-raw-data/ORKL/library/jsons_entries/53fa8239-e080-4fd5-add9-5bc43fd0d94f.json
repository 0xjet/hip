{
    "id": "53fa8239-e080-4fd5-add9-5bc43fd0d94f",
    "created_at": "2023-01-12T15:09:04.614742Z",
    "updated_at": "2025-03-27T02:17:01.896594Z",
    "deleted_at": null,
    "sha1_hash": "b18f56f6ec1eff244737d8fa18e538f11dc8d41f",
    "title": "2020-06-19 - Microcin is here With asynchronous sockets, steganography, GitLab ban and a sock",
    "authors": "",
    "file_creation_date": "2022-05-28T15:09:24Z",
    "file_modification_date": "2022-05-28T15:09:24Z",
    "file_size": 915823,
    "plain_text": "# Microcin is here\n\n**securelist.com/microcin-is-here/97353/**\n\nAuthors\n\n[Denis Legezo](https://securelist.com/author/denislegezo/)\n\n## With asynchronous sockets, steganography, GitLab ban and a sock\n\nIn February 2020, we observed a Trojan injected into the system process memory on a particular host. The\ntarget turned out to be a diplomatic entity. What initially attracted our attention was the enterprise-grade APIlike (application programming interface) programming style. Such an approach is not that common in the\nmalware world and is mostly used by top-notch actors.\n\nDue to control server reuse (Choopa VPS service), target profiling techniques and code similarities, we\nattribute this campaign with high confidence to the SixLittleMonkeys (aka Microcin) threat actor. Having said\nthat, we should note that they haven’t previously applied the aforementioned coding style and software\narchitecture. During our analysis we didn’t observe any similar open source tools, and we consider this to be\nthe actor’s own custom code.\n\n\n-----\n\n**_To deliver a new network module with a coding style that we consider enterprise-grade, Microcin used_**\n**_steganography inside photos, including this one of a sock (payload removed here)_**\n\nSixLittleMonkeys’ sphere of interest remains the same – espionage against diplomatic entities. The actor is\nstill also using steganography to deliver configuration data and additional modules, this time from the\nlegitimate public image hosting service cloudinary.com. The images include one related to the notorious\nGitLab [hiring ban on Russian and Chinese citizens. In programming terms, the API-like architecture and](https://about.gitlab.com/blog/2019/11/12/update-on-hiring/#)\nasynchronous work with sockets is a step forward for the actor.\n\n## Why we consider the current software architecture interesting\n\nBy “enterprise-grade API-like programming style” we mean, firstly, asynchronous work with sockets. In terms\nof Windows user-space entities, it was I/O completion ports. In the OS kernel space, this mechanism is\nactually a queue for asynchronous procedure calls (APC). We believe there’s a reason for using it in backend\napplications on the high-loaded server-side. Obviously, however, neither client-side software nor Trojans of\nthis kind need this server-side programming approach. So, it looks to us like the developers have applied\nsome habits from server-side programming.\n\nSecondly, the exported function parameters in the injected library look more like an API: the arguments are\ntwo callback functions – encryptor/decryptor and logger. So, if the authors decide to change encryption or\nlogging algorithms, they could do so easily without even touching the network module. Once again, even\ntargeted malicious samples rarely take such architectural issues into consideration.\n\nAnother injected library’s exported function parameter is the host name. If the caller doesn’t pass the infected\nhost name as this parameter, the following commands will not be executed. It filters out all messages to other\nhosts.\n\n### Initial infection\n\n**Module features** **File name** **Detection time**\n\nBackdoor sideloaded by legit GoogleCrashHandler version.dll 2019.12.31\n\nDownloader/decryptor inside spoolsv.exe address space spoolsv.dll 2020.01.16\n\nBitmap picture with steganography inside Random .bmp name 2020.01.16\n\n\n-----\n\nNetwork module in the same spoolsv.exe address space Module.dll 2020.01.16\n\n_Infection timeline_\n\nThe backdoor is started by GoogleCrashHandler.exe, due to .dll search order hijacking (version.dll). Bitmap\nfiles with a steganography downloader and decryptor (spoolsv.dll), injected into the spoolsv.exe API-like\nnetwork module, are injected into the same system process.\n\nLet’s cover the modules one at a time. Our telemetry shows that another Microcin backdoor was already on\nthe host before this new network module. It’s most probably a reinfection with newer malware.\n\n**Backdoor MD5** **File name** **Compilation timestamp** **Size**\n\nc9b7acb2f7caf88d14c9a670ebb18c62 version.dll 2020.05.20 02:37:58 407552\n\nThis UPX packed .dll was executed with the legitimate GoogleCrashHandler.exe (very common library search\norder hijacking) just before the New Year. The compilation timestamp is obviously spoofed. In this case we\ndon’t know how the backdoor, along with the legitimate application, was delivered.\n\nWe won’t concentrate on this backdoor in this report, because it’s fairly typical for Microcin. We just want to\nemphasize that the timeline above shows it existed on the host before the analyzed module.\n\n\n-----\n\n### Downloader/decryptor\n\n\n-----\n\nThe campaign in question starts with the 64-bit spoolsv.dll downloader/decryptor module that has to be loaded\nby spoolsv.exe into its address space.\n\n**Downloader/decryptor MD5** **Modified time** **Size** **Build** **Target ID**\n\nc7e11bec874a088a088b677aaa1175a1 2020.03.04 12:20:13 155291 20200304L02f @TNozi96\n\nef9c82c481203ada31867c43825baff4 2019.10.15 11:46:04 145233 20200120L03o @TNozi96\n\n1169abdf350b138f8243498db8d3451e 2019.01.25 04:58:15 150195 20191119L 123456\n\nSo far, we have registered three samples of this module. The file tails contains the following encrypted\nconfiguration data.\n\n\n**Parameter** **Length**\n**(bytes)**\n\n\n**Possible values**\n\n\n.bmp URL\nlen\n\n\n4 82\n\n\n.bmp URL .bmp\nURL\nlen\n\n\nhttp://res.cloudinary.com/ded1p1ozv/image/upload/v1579489581/<random_name>.bmp\n\n\nSleep time 2 17211 and other non-round random numbers\n\n\nModule\nbuild\nlength\n\nModule\nbuild\n\nTarget ID\nlength\n\n\n4 15\n\n\nModule\nbuild\nlength\n\n\nDate based on the previous table\n\n\n4 9\n\n\nTarget ID Target\nID\nlength\n\n\nReadable strings from the previous table\n\n\nRandom\nASCII\nchars\n\nHardcoded\ncanary\n\n\n16 Randomly generated on host\n\n4 0x5D3A48B6\n\n\nWe have published the source code of our decryptor for Microcin’s configuration and steganography at\n[https://github.com/dlegezo/common.](https://github.com/dlegezo/common)\n\nThe bitmap URL serves to download the image (like the one with the sock shown above) with the next stage\nnetwork module. The module build, target ID and random ASCII chars are for the next network module, which\nincludes them in the control server communications.\n\nTo get the bitmap, the downloader sends an HTTP GET request to cloudinary.com. The steganography is\ninside the color palette part of the .bmp file. A typical decryption algorithm includes four stages:\n\n\n-----\n\n1. Combine neighboring half bytes into one byte\n2. Decrypt data length with custom XOR-based algorithm\n3. Decrypt six-byte XOR key for main data\n4. Decrypt data itself using decrypted length and key\n\nBesides the configuration data and steganography, the same algorithm is used for the C2 traffic. As we\nmentioned, due to the malware architecture, the latter can easily be changed. Encryption is XOR-based, but\nthe key scheduling is quite specific and tricky. In the corresponding appendix we provide the part of the\ndecryptor containing the algorithm.\n\n### Bitmap images and steganography\n\n**_Besides the sock image, the campaign operators use more social-oriented photos (payload removed_**\n**_here). The background here is the GitLab hiring ban on Russian and Chinese citizens_**\n\nSo far, we have registered four different images. The encrypted content in all cases are PE files with the\nfollowing network module and C2 domain for the files. This is the only parameter that comes from bitmap; all\nothers are provided by the downloader.\n\n**Image content** **C2 domain** **Network module MD5**\n\nSock in washing machine apps.uzdarakchi[.]com 445b78b750279c8059b5e966b628950e\n\nTwo people in hoodies forum.mediaok[.]info 06fd6b47b1413e37b0c0baf55f885525\n\nGitLab hiring ban forum.uzdarakchi[.]com 06fd6b47b1413e37b0c0baf55f885525\n\nWoman with child, militaries owa.obokay[.]com 06fd6b47b1413e37b0c0baf55f885525\n\n### Network in-memory module\n\nThe downloader decrypts the configuration data and C2 domain from the bitmap and then everything is ready\nto start the last stage inside the same spoolsv.exe virtual address space. We consider the architectural\napproach in this module to be the most interesting part of the chain.\n\nThe network module’s entry point is the exported function SystemFunction000() with multiple arguments. As a\nbeacon, the Trojan prepares an HTTP POST request with the target’s fingerprinting data. And a lot of the\nparameters become part of the request.\n\n\n-----\n\n**Exported function**\n**argument**\n\n\n**Parameter meaning**\n\n\nTarget host name This has to be the same as the infected machine host name. Only then will the Trojan\nstart and receive commands. Initialized by the downloader\n\nTarget ID We already enumerated these readable ASCII strings from the decrypted\ndownloader’s config, e.g., @TNozi96\n\nBuild version Inside these readable ASCII strings the dates are clearly mentioned. The C2 uses\nthem to understand which build it’s currently working with\n\n\nWORD field of\nfingerprint structure\n\nC2 IP address and\nport number\n\nASCII string in\nfingerprint structure\n\nBYTE to fingerprint\nstructure\n\nHalf of maximum\nsleep time\n\n\nInitialized with 0x4004 by the downloader. We don’t have enough data to describe\nthis field’s meaning\n\nThe coordinates of the C2, initialized from the decrypted bitmap image\n\nUnique random string generated by the downloader\n\nInitialized with 0x4004 by the downloader. We don’t have enough data to describe\nthis field’s meaning\n\nSleep time before the working cycle. Half because the full time is counted <this arg>\n+ <random>%<this arg>. It’s effectively a maximum of a maximum sleep time\n\n\nLogger address First callback function address. In this case it’s a logger function inside the\ndownloader\n\n\nEncryptor/decryptor\naddress\n\n\nSecond callback function address. In this case it’s an encryptor/decryptor function\ninside the downloader\n\n\nThe last two arguments illustrate why we call the network module API-like: any encryption and logging routine\ncould be used without even touching the module code. We consider this programming approach as scalable\nand useful for large systems. Let’s take a look at these two callback arguments.\n\n**Callback and its arguments** **Callback features**\n\nLogger takes ASCII string as a log message Logger function whose parameter is the message\ntext. In this module all the messages are\nshortenings like “LIOO”, “RDOE”, etc.\n\n\nEncryptor/decryptor to deal with the traffic between\nhost and C2, takes its length, encryption key, and the\nflag (0 to encrypt and 1 to decrypt) as argument data\n\n\nEncryptor/decryptor function first used to encrypt\nbeacon with target’s fingerprint. It then decrypts C2\ncommand structures and encrypts replies to them\n\n\nThe module uses the Windows API function WSAIoctl() – something rarely seen in malware – to get the\nConnectEx() address and sends a prepared request. Another Windows API function,\nGetQueuedCompletionStatus(), is in charge of asynchronous work with I/O. In other words, the malware uses\nI/O completion ports for Windows user-space entities, which is effectively an APC queue in the OS kernel.\n\nThe same data structure is used for both sides of the communication: from host to C2 and back. Let’s\ndescribe its main fields here.\n\n**Field** **Features**\n\n\n-----\n\nCommand\ncode\n\n\nOne byte in the structure is the command code, which could vary from 0x00 to 0x16 (22). We\ndescribe the main network module commands in the table below\n\n\nError code Another byte is used for the error code\n\n\nCommand\nargument\n\n\nThe main command field that takes all the necessary strings, etc. and also keeps\nfingerprinting data in the case of the beacon\n\n\nSo far, we have described the infection chain, module architecture, custom encryption and HTTP POSTbased C2 communication protocol. Last, but not least, is the command set shown in the table below.\n\n**Command code** **Command features**\n\n3 Check if target’s ID meets the parameter\n\n4 List logical drives\n\n5 List files\n\n6 Create directory\n\n7 Remove directory\n\n8 Copy file\n\n9 Move file\n\n10 Delete file\n\n11 Execute PE\n\n12 Execute Windows shell command\n\n14 Terminate program\n\n15 File download\n\n16 Read from downloaded file\n\n17 File upload\n\n18 Write to file\n\n19 Stop\n\n20 Sleep\n\n### Infrastructure\n\n**Domain** **IP** **First seen** **ASN**\n\napps.uzdarakchi[.]com 95.179.136[.]10 November 11, 2019 20473\n\nforum.uzdarakchi[.]com 172.107.95[.]246 February 7, 2020 40676\n\nforum.mediaok[.]info 23.152.0[.]225 March 19, 2020 8100\n\nowa.obokay[.]com N/A (now parked)\n\n\n-----\n\n## To sum up\n\nThis time the Microcin campaign has made an interesting step forward, not in terms of a fancy initial infection\nvector, but as programmers. The API-like network module is much easier to support and update. This\nimprovement is not only about anti-detection or anti-analysis; it’s about software architecture and a step\ntowards a normal non-monolithic framework implementation.\n\n## IoC\n\n**Downloader**\n\nef9c82c481203ada31867c43825baff4\n\n1169abdf350b138f8243498db8d3451e\n\nc7e11bec874a088a088b677aaa1175a1\n\n**Network module**\n\nf464b275ba90b3ba9d0a20b8e27879f5\n\n9320180ef6ee8fa718e1ede01f348689\n\n06fd6b47b1413e37b0c0baf55f885525\n\n625a052ddc80efaab99efef70ba8c84f\n\n**Domains and IPs**\n\n95.179.136.10\n\napps.uzdarakchi[.]com\n\nforum.uzdarakchi[.]com\n\nforum.mediaok[.]info\n\nowa.obokay[.]com\n\n[Malware Descriptions](https://securelist.com/tag/malware-descriptions/)\n[Malware Technologies](https://securelist.com/tag/malware-technologies/)\n[Steganography](https://securelist.com/tag/steganography/)\n[Targeted attacks](https://securelist.com/tag/targeted-attacks/)\n[Trojan](https://securelist.com/tag/trojan/)\n\nAuthors\n\n[Denis Legezo](https://securelist.com/author/denislegezo/)\n\nMicrocin is here\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-19 - Microcin is here With asynchronous sockets, steganography, GitLab ban and a sock.pdf"
    ],
    "report_names": [
        "2020-06-19 - Microcin is here With asynchronous sockets, steganography, GitLab ban and a sock.pdf"
    ],
    "threat_actors": [
        {
            "id": "3c7097f4-849b-4bc0-a7e6-ba2b510722b6",
            "created_at": "2022-10-25T16:07:23.869951Z",
            "updated_at": "2025-03-27T02:02:10.003542Z",
            "deleted_at": null,
            "main_name": "Mikroceen",
            "aliases": [
                "SixLittleMonkeys"
            ],
            "source_name": "ETDA:Mikroceen",
            "tools": [
                "AngryRebel",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "Microcin",
                "Mikroceen",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "PCRat",
                "logon.dll",
                "logsupport.dll",
                "pcaudit.bat",
                "sqllauncher.dll"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "6e79c98d-c678-4f28-b869-5723a78e71f4",
            "created_at": "2023-01-06T13:46:39.422441Z",
            "updated_at": "2025-03-27T02:00:03.08607Z",
            "deleted_at": null,
            "main_name": "Vicious Panda",
            "aliases": [
                "SixLittleMonkeys"
            ],
            "source_name": "MISPGALAXY:Vicious Panda",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536144,
    "ts_updated_at": 1743041821,
    "ts_creation_date": 1653750564,
    "ts_modification_date": 1653750564,
    "files": {
        "pdf": "https://archive.orkl.eu/b18f56f6ec1eff244737d8fa18e538f11dc8d41f.pdf",
        "text": "https://archive.orkl.eu/b18f56f6ec1eff244737d8fa18e538f11dc8d41f.txt",
        "img": "https://archive.orkl.eu/b18f56f6ec1eff244737d8fa18e538f11dc8d41f.jpg"
    }
}