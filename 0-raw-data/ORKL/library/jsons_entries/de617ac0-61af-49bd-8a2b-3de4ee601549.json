{
    "id": "de617ac0-61af-49bd-8a2b-3de4ee601549",
    "created_at": "2022-10-25T16:48:13.825545Z",
    "updated_at": "2025-03-27T02:14:04.114651Z",
    "deleted_at": null,
    "sha1_hash": "af91b2a5704db61cc3b02fd1850b9d0f5eb605c9",
    "title": "VMware Brochure Template US Letter",
    "authors": "",
    "file_creation_date": "2022-10-03T17:31:27Z",
    "file_modification_date": "2022-10-03T17:31:50Z",
    "file_size": 12441696,
    "plain_text": "|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n|||E|m|o|te|t||E|x|p|o|s|e|d:|||||||||||||||\n||||||||||||||||||||||||||||||\n|||A|L|o|o|k||I|n|si|d|e|||||||||||||||||\n||||||||||||||||||||||||||||||\n||t|h|e|C|y|b||e|r|cr|i|m|in|a|l||||||||||||||\n||||||||||||||||||||||||||||||\n|||Su|p|p|l|y||C|h|a|in||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||\n\n\n# A Look Inside  the Cybercriminal  Supply Chain\n\n\n-----\n\n## Table of contents\n\nEXECUTIVE SUMMARY 4\n\nEMOTET: HISTORY AND BACKGROUND 6\n\nNEW EMOTET WAVES 8\n\nUNDERSTANDING EXECUTION CHAINS 16\n\nMAPPING THE EMOTET INFRASTRUCTURE 22\n\nEncryption keys and Epoch distribution 23\n\nIP address:port analysis 24\n\nIP count distribution 24\n\nIP address:port pair set distribution 25\n\nNetwork infrastructure reuse across payloads 26\n\nNetwork infrastructure reuse across time 26\n\nIP geographic distribution 28\n\nPort distribution 28\n\nJARM fingerprint distribution 29\n\nAS number distribution 31\n\nExecution chains and infrastructure 32\n\nEMOTET RELOADED 34\n\nVMWARE RECOMMENDATIONS 39\n\nBIBLIOGRAPHY 43\n\nAPPENDIX 45\n\nIoCs 45\n\nEmotet activity timeline notes 45\n\nExtracting the Emotet configuration 46\n\nStep 1: Decrypting and dumping the internal DLL 46\n\nStep 2: C2 configuration extraction 49\n\nDownloading updates and plug-in modules 60\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|T|a|Col24|b|le|Col27|Col28|o|f|c|Col32|o|n|t|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n\n\n-----\n\nEXECUTIVE SUMMARY\n\n### Emotet is one of the most evasive and destructive malware delivery systems ever deployed.\n\nThroughout its eight-year history, Emotet has caused substantial damage. Now it has\nresurrected itself following a takedown by law enforcement. Emotet is the very definition of an\nadvanced persistent threat, causing substantial damage during its earlier reign and continuing\nto pose a danger to organizations everywhere. As such, the VMware Threat Analysis Unit[™] is\nreleasing insights learned from Emotet’s most recent resurgence in hopes that organizations\nwill be able to better understand and defend themselves against this resilient risk.\n\nWith telemetry from VMware Contexa[™] cloud-delivered threat intelligence, the VMware\nThreat Analysis Unit first observed the newest waves of Emotet attacks in January 2022. By\nanalyzing Emotet’s software development lifecycle, we were able to dissect how it quickly\nchanges its command and control (C2) infrastructure, obfuscates its configuration, adapts and\ntests its evasive execution chains, deploys different attack vectors at different stages, laterally\npropagates, and continues to evolve using numerous tactics and techniques.\n\n\nThis report covers these findings,\nproviding comprehensive information\non the exploitation chains and the inner\nworkings of the malware deployed by the\nmost recent Emotet attacks.\n\nThe report also provides the samples and\nnetwork indicators of compromise (IoCs)\n(see the IoCs section of the Appendix) that\nwere observed, including the samples'\nconfigurations and any additional\ncomponents related to our research. The\nreport reveals never-before-exposed\ninsights into Emotet, including large-scale,\ndetailed analysis of:\n\n\n\n- The modules Emotet delivers\n\n- Emotet’s execution chains and\ntheir evolution\n\n- Emotet’s multiple attack waves, campaigns,\nand network infrastructure\n\n- How to create an Emotet sock puppet to\nfetch modules\n\n- How to extract the recently updated\nEmotet configuration\n\n- How infection techniques and Emotet’s\nnetwork infrastructure are correlated,\nrevealing the agile-like software\ndevelopment lifecycle of Emotet\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|if|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n\n\n-----\n\nEXECUTIVE SUMMARY\n\n### Key highlights and takeaways from the report\n\n\nEmotet’s attack patterns are in continuous\nevolution: Awareness at initial stages is key.\nThe VMware Threat Analysis Unit clustering\nanalysis, based on a new similarity metric,\nwas able to identify various stages of Emotet\nattacks with a number of initial infection\nwaves that change the way in which the\nmalware is delivered. The ongoing\nadaptation of Emotet’s execution chain is\none reason the malware has been successful\nfor so long. This report is the first to\ncharacterize Emotet’s different execution\nchains, describing infection techniques and\ncharacterizing the evolution of Emotet’s\ntactics, techniques and procedures (TTPs) to\nmake them easier to identify in\nyour environment.\n\nEmotet can serve a number of attack\nobjectives. This report details an analysis of\nEmotet's updates and additional modules, in\nterms of the functionality they provide, their\nsources, and their evolution through time.\nThey demonstrate just how expansive\nEmotet attacks can be. For instance, the\nVMware Threat Analysis Unit intercepted\ntwo recently updated modules: The first\ntargets Google Chrome browsers and is\ndesigned to steal credit card information,\nwhile the second leverages the SMB\nprotocol and is designed to spread laterally.\n\n\nEmotet authors try hard to hide their C2\ninfrastructure. The actors behind Emotet go\nto great lengths to make the information\nabout the malware’s C2 infrastructure\ndifficult to extract. The VMware Threat\nAnalysis Unit developed a tool to bypass the\nanti-analysis techniques employed by\nEmotet's authors. Consequently, this new\ntool is capable of obtaining the same\nupdates that are pushed to infected hosts.\nWe found there were two separate ways that\nEmotet used to try to obfuscate this\ninformation. In this report, the VMware\nThreat Analysis Unit shares how to extract\nthe IP addresses and ports of the C2 servers\nfrom Emotet samples, so that you can\nunderstand the attack’s infrastructure.\n\nEmotet's infrastructure is constantly\nshifting. The VMware Threat Analysis Unit\ndeveloped techniques and tools to extract\nthe configuration files used by Emotet\nsamples to better understand the C2\ninfrastructure of the Emotet botnets. By\nanalyzing the network endpoints involved in\nthis C2 infrastructure, the VMware Threat\nAnalysis Unit was able to track and\ndocument the Emotet botnets’ evolution.\nHistorically, Emotet has had several\ninfrastructures, called Epochs. Prior to the\nlaw enforcement takedown in January 2021,\nEpochs 1, 2 and 3 were the infrastructures\nmostly used by attackers, while Epochs 4\nand 5 are the infrastructures that have\nsurfaced in Emotet’s resurgence.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|Col36|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||t t a||||||||||g||||||||||||\n\n\n-----\n\nEMOTET: HISTORY AND BACKGROUND\n\n### Emotet is one of the most notorious and long-lived botnets  in existence.\n\n\nIt is controlled by a group called Mummy\nSpider, also known as MealyBug or TA542.[1]\nEmotet first appeared on the threat\nlandscape in 2014 as a banking Trojan.[2]\nInstead of injecting content into the\nwebpages of financial institutions, which was\nthe standard approach to data theft at the\ntime, it monitored and stole the raw network\ntraffic directed at financial institutions.\n\nSince its emergence, Emotet has evolved\ninto one of the largest malware-as-a-service\n(MaaS) infrastructures. The threat actors\nbehind Emotet are behind a series of attack\nwaves that delivered a variety of different\npayloads, including IcedID, TrickBot,\nUmbreCrypt and QakBot, along with\nadditional threats, such as the Ryuk\nransomware. Often, periods of inactivity are\ninterspersed within the waves, which help it\nto remain undiscovered and persist.\n\nIn Emotet’s first years, the authors focused\non improving Emotet's evasion techniques\nand expanding its targets beyond the DACH\nregion (Germany, Austria, Switzerland) to be\nmore global, including an emphasis on North\nAmerica and China.[3] Around 2017, the\nauthors of Emotet fully embraced their role\nof malware distributor, focusing more on\n\n\nadvancing initial infection techniques to\nimprove their success rates.\n\nOften, Emotet attacks rely on waves of spam\nemails designed to entice readers to open\nmalicious documents or click malicious links.\nOnce a target is infected, access to the\ncompromised machine is sold to one of the\ngroups within Emotet’s ecosystem, who then\nmonetizes the access. Typically, these\ngroups leverage this access to steal valuable\ninformation or deploy ransomware for\nfinancial gain.[4]\n\nWhile there were unexplained periods of\ninactivity (such as summer 2019),[5] Emotet\nwas active[6] until early 2021. During this time,\nEmotet used three Epochs (e.g., Epochs 1, 2\nand 3).\n\nIn January 2021, the botnet’s infrastructure\nwas targeted by law enforcement in a\ncoordinated takedown effort called\nOperation Ladybird. Authorities from the\nNetherlands, Germany, the United States,\nthe United Kingdom, France, Lithuania,\nCanada and Ukraine, under the coordination\nof Europol,[7] all participated in the operation,\nwhich for a time successfully halted\nEmotet’s operations.[8]\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|i|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n\n\n-----\n\nEMOTET: HISTORY AND BACKGROUND\n\nUkraine’s law enforcement apprehended\ntwo individuals who were responsible for\ndeploying and managing Emotet’s network\ninfrastructure. In addition, the takedown\nteam hijacked the controlling hosts and\npushed a new update that would uninstall\nEmotet on a specific date. For a while, the\nvoid left by Emotet was filled by other\nmalware distributors, such as BazarLoader\nand IcedID,[9] but it was only temporary.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|Col36|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||i r m||||||||||t o b 11||||||||||||\n\n\nSince then, the botnet has been operating\nwith two new infrastructures: Epochs 4 and\n5. Figure 1 shows a timeline of Emotet’s\nactivity (see the Emotet activity timeline\nnotes in the Appendix for more details).\n\n\nDeploys TrickBot,\nIcedID and\nUmbreCrypt\n\n\nHumboldt COVID-19Univ. attack themed emails\n\n\n**Figure 1: Emotet activity timeline.**\n\n\n-----\n\nNEW EMOTET WAVES\n\nIn early 2022, the VMware Threat Analysis Unit observed waves of new Emotet attacks in\nVMware Contexa (Figure 2). We investigated each wave to identify the infection mechanisms,\nmap the attack’s C2 infrastructure, and document the components that were delivered to\ncomprehensively understand the latest reincarnation of this dangerous threat.\n\n\n5,000\n\n4,500\n\n4,000\n\n3,500\n\n3,000\n\n2,500\n\n2,000\n\n1,500\n\n1,000\n\n500\n\n\n0\n\n\n2022-01-01 2022-02-01 2022-03-01 2022-04-01 2022-05-01 2022-06-01\nutc_timestamp per day\n\n\n**Figure 2: Recent Emotet attack waves in VMware Contexa.**\n\nThe general workflow of the recent Emotet infections is fairly standard: Spam emails deliver\nMicrosoft documents with malicious macros to target users. The documents lure the user into\nenabling macro execution, which results in a series of PowerShell commands being launched\nand used to download the Emotet payload. Emotet, in turn, downloads additional module\nupdates or other threats, such as TrickBot and QakBot. Figure 3 shows a typical Emotet\npayload delivery chain.\n\n\n**Documents**\n\nA Word or Excel document with social\nengineering texts shown on the\nopening page to entice users to\nenable macro execution.\n\n\n**PowerShell**\n\nHighly obfuscated malicious\nPowerShell scripts get executed\nto download payload(s) for\nfurther malicious actions.\n\n\n**Spam emails**\n\nTypical examples such as\nshipment/invoice themed\nspam emails with malicious\nattachments or links.\n\n\n**Figure 3: Typical Emotet payload delivery chain.**\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|Col36|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n||B is|A or ena mac|Ex bled ro c|||||||||||||||||||||||||||||||||\n|||||M cel 4. , the ode i|ac 0 (X em n the|ros L4) bedd doc|macr ed m ume|o ex alic nt g|ecuti ious ets||on||Th a|E e Em dow mal|mot otet nload ware|et Troj er t such|pay an c o spr as|l an e ba||||||||||||||||||\n|e|x li|ecut ke in|ed f vok|or fu ing P|rther owe|mal rShe|iciou ll ex|s ac ecut|tions ion.||||T a|rojan nd t|s Tri he R|kBo yuk|t and rans|o|Qa mw|kbot, are.||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|d|d|eliv|ery|ch|ain.|||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n\n\nmalware such as banking\nTrojans TrikBot and Qakbot,\nand the Ryuk ransomware.\n\n\n-----\n\nNEW EMOTET WAVES\n\nNote that this infection chain is not the only one the VMware Threat Analysis Unit observed;\nwe also saw that Emotet uses malicious URLs embedded in emails to infect its victims.\nHowever, for the purposes of this report, we will mainly focus on the attack waves that relied\non Microsoft documents as the initial infection vector.\n\n\nIn January 2022, the VMware Threat Analysis Unit observed new waves that used Excel\nattachments containing Excel macros.[12, 13]\n\n800 **A** **B**\n\n600\n\n400\n\n200\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||a s w||||||||||||||||||||\n\n\n0\n\n|A B|C|\n|---|---|\n\n\n2022-01-11 00:00 2022-01-13 00:00 2022-01-15 00:00 2022-01-17 00:00 2022-01-19 00:00 2022-01-21 00:00 2022-01-23 00:00 2022-01-25 00:00\n\n\n**utc_timestamp per 12 hours**\n\n**Figure 4: Emotet attack waves observed in January 2022.**\n\n\nThe VMware Threat Analysis Unit classified these attacks into three waves (Figure 4):\n\n- A – Emotet payload via an XL4 macro directly\n\n\n\n- B – Emotet payload via an XL4 macro with PowerShell\n\n- C – Emotet payload via a Visual Basic Application (VBA) macro with PowerShell\n\n\nThe rest of this section discusses waves A and B. More details on these waves, including wave\nC, can be found in our previous reports.[12, 13]\n\nThe samples analyzed from wave A are all Microsoft Office 97–2003 Excel documents, with a\nrelatively small file size (between 110KB and 120KB). This is an old version of Office documents,\nas compared to more recent versions, such as the Microsoft Office 2007 file format.\n\nThe samples in this wave of attacks have some peculiarities: First, instead of using VBA\nmacros, these files use XL4 macros, which is an older format that allows for more direct access\nto the underlying operating system.[14,15] Second, the malicious XL4 macros use some antianalysis techniques to try to avoid detection. They employ environmental fingerprinting, which\nallows them to detect if they are being analyzed in a sandbox, and several obfuscation\ntechniques to prevent static analysis. Figure 5 shows the macro contained in sample\n7c0d0a80e7ebb3af7ce549df78a5a68cbd5debb5.\n\n**Figure 5: A highly obfuscated XL4 macro.**\n\n\n-----\n\nNEW EMOTET WAVES\n\nFortunately, the VMware Threat Analysis Unit has a tool at its disposal, called Symbexcel, that\napplies symbolic execution techniques to the analysis of Excel macros.[16] Using this tool, we\ncan automatically de-obfuscate the XL4 macros and identify the additional components being\ndownloaded (see Figure 6).\n\n**Figure 6: A de-obfuscated XL4 macro.**\n\nThe functionality of the macro is threefold:\n\n1. Download the next stage payload from one of the payload hosts. The attackers may\nchoose to use multiple hosts to increase the chances to download the payload and\nimprove success rates in the event that one or more hosts are taken down.\n\n2. Execute the downloaded payload by running rundll32.exe.\n\n3. Gain registry persistence by running DllRegisterServer (the de-obfuscated version of D\"&\"l\n\"&\"lR\"&\"egister\"&\"Serve\"&\"r from the EXEC command line is shown Figure 6).\n\nThe payload is a DLL file, which (unsurprisingly) is the main Emotet DLL. In the case of the\nExcel document with hash 7c0d0a80e7ebb3af7ce549df78a5a68cbd5debb5, the DLL is\n88cf39a587aeb8f075aa0ae23a42e16ce3656e71. When we explored both the Excel sample\nand the DLL payload on VirusTotal, it revealed that similar files and URLs were used from the\nsame campaign (shown in Figure 7).\n\n\n-----\n\nNEW EMOTET WAVES\n\n**Figure 7: The correlation of IoCs from this attack, created with VirusTotal Graph, visualizes the relationships**\nbetween similar samples and the contacted hosts. Explore the graph to see the meaning of each node.\n\n\nA new Emotet wave (B in Figure 4) was\nobserved in late January 2022.[13] This new\nwave introduced the use of the mshta.exe\napplication to carry out the infection.\n\nThe mshta tool is a Windows-native utility\nthat executes Microsoft HTML Application\n(HTA) files. Tools such as mshta and\nPowerShell, which are sometimes referred to\nas living-off-the-land binaries (LOLBINs), are\nvery popular among threat actors because\nthey are signed by Microsoft and trusted by\nWindows. This allows the attacker to\n\n\nperform a confused deputy attack, in which\nlegitimate tools are fooled into executing\nmalicious actions. The MITRE ATT&CK\nFramework[17] lists two techniques, namely\nT1218: System Binary Proxy Execution and\nT1216: System Script Proxy Execution, that\ndetail how trusted components can be used\nto perform malicious actions.\n\nIn this new wave, mshta is used to execute\nan HTA file that was delivered from a remote\nlocation (see Figure 8).\n\n\n-----\n\nNEW EMOTET WAVES\n\n**Figure 8: An HTA file downloaded to a local directory.**\n\nAt first glance, the HTA file (sha1: 2615f7aa2141cc1cb5d0c687bc3396981c2c68dc) does not\nappear to contain anything. It is empty when opened in a common editor because of the use\nof newlines and whitespace that hide the file’s contents from a casual viewer. An attacker can\n[use tools, such as js-beautify, to remove the empty lines and “prettify” the script inside. Figure](https://github.com/beautify-web/js-beautify)\n9 shows the first and last parts of the prettified JScript code contained in the HTA file.\n\n\n-----\n\nNEW EMOTET WAVES\n\n**Figure 9: The JScript code contained in the HTA file.**\n\nThis JScript code is highly obfuscated. To see what we are dealing with, we called the\nunescape() and eval() functions (highlighted in Figure 9) to decode and execute the\nobfuscated script. When we executed the JScript sample within the VMware NSX® Sandbox[™],\nwe observed that it spawned a new process to invoke PowerShell execution.\n\n\n-----\n\nNEW EMOTET WAVES\n\nOur analysis revealed the PowerShell process delivers the final Emotet payload in two stages:\n\n1. The PowerShell script contained in the HTA file downloads an additional PowerShell\npayload from a remote URL.\n\n2. The second downloaded PowerShell script downloads the Emotet DLL payload.\n\nFigure 10 shows the PowerShell payload contained in the HTA file.\n\n**Figure 10: The PowerShell script extracted from the HTA file.**\n\nAfter removing the obfuscating strings, the purpose of the script becomes more obvious: The\nexecuted PowerShell script attempts to download another payload using the .NET WebClient.\nDownloadString method (highlighted in Figure 11). The IEX command (shown at the end of\n[Figure 11) is an alias for the Invoke-Expression cmdlet, which evaluates and runs the string](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-7.2)\nspecified by the $JI variable. You can ignore the backticks as they are just used to obfuscate\nthe command.\n\n**Figure 11: The de-obfuscated, first-stage PowerShell script.**\n\nWhile the payload (sha1: dcc120c943f78a76ada9fc47ebfdcecd683cf3e4) downloaded from the\nprevious stage has an image file extension (PNG), it is actually another PowerShell script but\n[without obfuscation (see Figure 12). This script calls the .NET WebClient.DownloadFile](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfile?view=net-6.0)\nmethod to download the Emotet DLL payload from one of 10 hosts and save it to C:\\Users\\\nPublic\\Documents\\ssd.dll (sha1: e597f6439a01aad82e153e0de647f54ad82b58d3).\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|o|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|ut|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||os 64|t 7f|s a 5|nd 4ad|sa 82|ve b5|it t 8d|o C 3).|:\\U||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n\n\n-----\n\nNEW EMOTET WAVES\n\n**Figure 12: The second-stage PowerShell script.**\n\nAt the end, the process pauses for four seconds by running Sleep -s 4. This is to make sure\nthe payload is properly saved before calling cmd.exe to launch rundll32.exe and execute the\nEmotet DLL payload.\n\nThese waves are examples of how the Emotet actors continuously change the way in which\nthey download and install their main component, which is the DLL responsible for contacting\nthe C2 server and downloading additional modules.\n\nThe following section presents an analysis of the various tools and techniques used to deliver\nthe Emotet payload in the thousands of samples analyzed by the VMware Threat Analysis\nUnit. Following this analysis, the focus will revolve around what C2 information can be\nextracted from the main Emotet DLL and how the C2 infrastructure of this complex botnet\nevolves over time.\n\n\n-----\n\nUNDERSTANDING EXECUTION CHAINS\n\n### The process of compromising a machine very seldom involves a single step.\n\nIn most cases, it is a series of events that results in the installation and execution of a malicious\npayload. These multiple, intermediate steps are used to make it more difficult to identify the\nmalicious actions involved.\n\nEmotet infections are not substantially different from other infection processes. However, it is\ninteresting to observe how different techniques are used across waves, so one can better\ncharacterize the threat actors’ TTPs and support more effective detection.\n\nIn this section, the VMware Threat Analysis Unit provides an analysis of execution chains,\nwhich represent how various components are executed to achieve the final infection.\nFor example:\n\n- The opening of a malicious attachment might result in the execution of Excel.\n\n- A spreadsheet loaded into Excel might contain a malicious macro that executes\nusing the Windows Script Host executable (wscript.exe).\n\n- The script may invoke a PowerShell script, using cmd.exe, which in turn\ninvokes powershell.exe.\n\n- This script may download a DLL component, which is executed by the Excel\nmacro using rundll32.exe, invoked through cmd.exe.\n\nThe NSX Sandbox can capture execution chains, such as the one shown in Figure 13,\npresenting them to the user in a visual flow.\n\nCharacterizing the evolution\nof execution chains requires\nbeing able to model how\ndifferent execution chains\nare similar to one another.\nBecause execution chains\nare technically execution\ntrees, with a component\nspawning or executing\nmultiple subcomponents,\nthe VMware Threat Analysis\nUnit developed an executionchain-similarity metric\n\n**Figure 13: The execution chain for an Emotet sample.**\n\nbased on the edit distance\nbetween trees.\n\nThe edit distance between two trees is the number of changes that must be applied to one\ntree to make it identical to another tree. For example, if considering trees (a) and (b) in\nFigure 14, one would only need to change a single element in tree (a) to make it\nidentical to tree (b), and vice versa. On the other hand, tree (c) is made up of a\nnumber of different operations that would need to be changed to make it\nidentical to either tree (a) or (b). Therefore, trees (a) and (b) are considered\nmore similar than trees (a) and (c) or trees (b) and (c).\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|m t n|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|ne|ed|to|cha|ng|e a|si|ngl|e e|le|me|nt i|n t|ree||(a|) to|m|ak|e it||||||||||||||||\n|ce|ver|sa.|O|n t|he|oth|er|ha|nd,|tr|ee|(c)|is|m|a|de|up|of|a||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n|ion|s t|hat|w|oul|d n|ee|d t|o b|e|cha|ng|ed|to||m|ake|it||||||||||||||||||\n|r (|b).|Th|ere|fo|re,|tre|es|(a)|an|d (|b)|are|co||ns|ide|re|d|||||||||||||||||\n|an|d (|c) o|r t|ree|s (|b)|and|(c|).||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n\n\n-----\n\nUNDERSTANDING EXECUTION CHAINS\n\nexcel.exe excel.exe excel.exe\n\ncmd.exe\n\ncmd.exe cmd.exe cmd.exe cmd.exe\n\nrundll32.exe powershell.exe rundll32.exe regsvr32.exe ping .exe timeout .exe mshta.exe\n\npowershell.exe\n\ncmd.exe\n\nrundll32.exe\n\n(a) (b) (c)\n\n**Figure 14: The execution-chain-similarity metric based on tree edit distance.**\n\nWhen looking at execution chains, one may limit the analysis to the program being used (e.g.,\nrundll32.exe), or one may consider the parameters being passed to the program (e.g.,\nrundll32.exe ‘C:\\Users\\Public\\Documents\\ssd.dll’,Install). The first execution chains are\nreferred to as program chains, while the latter are invocation chains.\n\nOur dataset includes 19,791 samples with non-trivial execution chains, which is a subset of the\nVMware Threat Analysis Unit dataset of 47,240 samples. We chose this subset to understand\nthe execution chains because final Emotet DLLs made up the rest of the samples, so they\ndidn’t have the associated malicious document(s) used to distribute them.\n\nIn the dataset, we identified 139 unique program chains and 20,955 unique invocation chains.\nThis is not surprising because samples often make minor changes to the invocation\nparameters to make each infection process unique. This makes detection via static signatures\nalone more challenging. The reason why the number of invocation chains is bigger than the\ntotal number of samples with non-trivial execution chains is because a sample might produce\ndifferent chains whether it is executed in Windows 7 or in Windows 10.\n\nFigure 15 shows the percentage of samples that belong to the top program chains. Each\nprogram chain is characterized by a unique hash that is the result of applying a hashing\nfunction to the string representations of the programs involved and their subsequent\nrelationships. In essence, this is the tree structure in canonical format. Note that the\ndistribution shows the top four execution chains account for approximately 80 percent of\nthe samples.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||||\n||||H cm ll||AIN e .exe .exe||||exe r3||||||||||||||||||||||||||\n\n\n-----\n\nUNDERSTANDING EXECUTION CHAINS\n\n000e7...b23e1\n\n00041...652eb\n\n00242...75a72 17.60%\n\n00412...ee8d8 9.30%\n\n000a1...651e0 2.60%\n\n00c1a...fcae0 2.30%\n\n00b45...f3c91 2.20%\n\n004c3...abb67 2.20%\n\n00092...d79cb 1.60%\n\n00363...b975f 1.50%\n\n03539...2cc54 1.50%\n\n0517a...92adc 0.60%\n\n0308d...6a518 0.40%\n\n003f9...a4e42 0.40%\n\n00dc4...c5560 0.30%\n\n05b2f...70c48 0.30%\n\n06df6...ab816 0.30%\n\n007d3...5c6f4 0.30%\n\n07a2f...1aa5c 0.30%\n\n00b60...8f600 0.20%\n\n07a0e...89c77 0.20%\n\n092be...78334 0.20%\n\n17e10...27c56 0.10%\n\n06897...d301b 0.10%\n\nOthers 0.10%\n\n**Figure 15: The distribution of samples across the top program chains.**\n\n\nFigures 16, 17 and 18 show that the\ncomplexity of the program chains\nare inversely proportional to the\ndistribution in the dataset. For\nexample, the most popular chain\nshows a simple three-stage attack\ninvolving the execution of Excel and\nregsvr32.exe. The second most\npopular chain shows the same attack\nchain as the first but with an additional\nstage (regsvr32.exe). Finally,\nexamining the fifth most popular chain\nshows a much more complex attack.\n\n\n**Figure 16: The most popular program chain.**\n\n|regsvr32.exe. The second popular chain shows the s chain as the first but with a stage (regsvr32.exe). Final examining the fifth most p shows a much more comp|mo am n a ly, opu lex|st e a dd lar att|tta itio ch ac|ck na ain k.|l|F|igu|re 1|7: T|he|sec|ond|m|ost|pop|ula|r pr|og|ram|ch|ain.|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||tio|n|ch|ai|ns|ac|c|ou|nt|fo|r|||||||||||||||||||||||\n||e|rce|n|t o|f t|he|s|am|p|les|.|||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n\n\n-----\n\nUNDERSTANDING EXECUTION CHAINS\n\n**Figure 18: The fifth most popular program chain.**\n\nTo highlight the clusters of program chains, the VMware Threat Analysis Unit used a sampling\nmechanism to make sense of the large sample size.\n\n19a. 19b.\n\n**Figure 19: The confusion matrix and clustering dendrogram for the program chains (a) and invocation chains (b)**\nof a random sampling of Emotet samples.\n\nIn Figure 19, (a) shows that there are large clusters of similar program chains with only small\nchanges between the major clusters. It is interesting to notice the size of the cluster shown in\nFigure 19 is directly proportional to the distribution of the program chains shown in Figure 15.\nMore specifically, clusters a1, a2 and a3 correspond to the first, second and third most popular\nprogram chains, respectively.\n\nIf we take into account the parameters passed to the various programs, the analysis shows a\nmore diverse set of patterns, as expected (see (b) in Figure 19). For example, within cluster a1,\nthere are two subclusters (b1 and b2) that show the same program chain but with slightly\ndifferent invocation chains. In particular, the payload executed by regsvr32.exe differs within\nthe two subclusters.\n\n\n-----\n\nUNDERSTANDING EXECUTION CHAINS\n\nIf we look at the execution chains and their appearance in chronological order (see Figure 20),\nwe notice a similar pattern of clusters, showing the evolution of the infection techniques\nthrough time.\n\n20a. 20b.\n\n**Figure 20: The confusion matrix of the program chains (a) and invocation chains (b) of a random sampling of the**\ndataset, in chronological order.\n\nIt is interesting to notice that just by ordering the program and invocation chains produced by\nthe samples over time, various patterns emerged without having to resort to clustering. The\ntemporal relationship between clusters is better captured with a diagram that shows the\nappearance of samples belonging to the identified clusters.\n\n\n-----\n\nUNDERSTANDING EXECUTION CHAINS\n\n-1\n0\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n\nFeb 2022 Mar 2022 Apr 2022 May 2022 Jun 2022 Jul 2022\n\n**Figure 21: The timeline of samples observed from the top clusters of execution chains.**\n\nFigure 21 shows that, in the second half of January, there was a very diverse set of execution\nchains, which means that Emotet was pushing samples with very different execution\nbehaviors. This might be an attempt to evade detection by diversifying the exploitation\nprocess, or it could be the result of a vast affiliate program that has many different actors\nspreading Emotet via various techniques.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||\n|||NS||||||||||||||||||||||\n\n\n-----\n\nMAPPING THE EMOTET INFRASTRUCTURE\n\n### To track the evolution of Emotet’s C2 infrastructure,  the VMware Threat Analysis Unit developed techniques and tools to extract the configuration files used by the samples.18\n\n\nWe also programmatically queried the\nmalware distributors for updates and\nadditional samples, which is detailed later.\n\nHistorically, Emotet has had several\ninfrastructures, called Epochs. Epochs 1,\n2 and 3 were mostly seen before the\nJanuary 2021 takedown. Epochs 4 and 5\nwere introduced after Emotet resurfaced.\nThe Epoch number of a sample is typically\nidentified by the public encryption keys\ncontained in the C2 configuration of\nthe sample.\n\nThough Emotet samples of different\nEpochs keep their configuration data in\ndifferent formats, they all share one common\napproach: They all store their configuration\nin an encrypted DLL (the internal DLL).\nThis internal DLL is embedded into the\nexecutable payload.\n\nEmotet uses a number of techniques to\nresist analysis, both static and dynamic,\nas well as to prevent the extraction of\nthe configuration file, which contains the\nendpoints that are going to be used to\nupload information about the compromised\nhosts and receive updates with the threats\nto be installed.\n\n\nIn the Extracting Emotet configuration\nsection of the Appendix, the VMware Threat\nAnalysis Unit presents the technical details\non how to extract the Emotet configuration\ndata. During the analysis period (January 1,\n2022–June 30, 2022), Emotet radically\nchanged the way in which the configuration\ndata was obfuscated. We have provided the\nanalysis in the Appendix that covers\nboth techniques.\n\nThe ability to de-obfuscate the configuration\ndata allowed us to perform an analysis of the\nendpoints used by Emotet to control and\nupdate its botnet. The evaluation dataset\nwe used for the analysis contained 24,276\nunique Emotet DLL payloads. In this dataset,\n26.7 percent of the payloads were dropped\nby Excel documents, which we observed in\nthe VMware Contexa customer telemetry\n(see (A) in Figure 22). The rest of the\npayloads were manually submitted by\ncustomers using the NSX Sandbox API.\nWe also looked at the instruction set\narchitecture (ISA) of the DLLs; the dataset\ncomprises both 32-bit and 64-bit payloads\n(see (B) in Figure 22). As we reported\nearlier,[19] Emotet started to migrate to 64-bit\nmodules in April 2022.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|b|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|Col36|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n\n\n-----\n\nMAPPING THE EMOTET INFRASTRUCTURE\n\n(A): DLL Origin (B): DLL Target ISA\n\nDLL by doc, 26.7% (6493) 32bit, 23.0% (5574)\n\n22a. DLL direct, 73.3% (17783) 22b. 64bit, 77.0% (18702)\n\n\n**Figure 22: (A) shows the DLL payload origin breakdown: 26.7 percent of the evaluated DLLs were dropped by**\nExcel documents that were observed in the VMware Contexa customer telemetry, and 73.3 percent were\nsubmitted by customers through the NSX Sandbox API. (B) shows the ISA distribution of the DLLs.\n\nUsing the VMware Threat Analysis Unit C2 configuration extraction tool, we successfully\nextracted the C2 configuration data from 24,276 Emotet DLL payloads (98 percent of the\ndataset shown in Figure 22). The C2 configuration data extracted from each DLL payload\nsample comprises a pair of encryption keys and a list of IP address:port pairs.\n\n##### Encryption keys and Epoch distribution\n\nPrior to its takedown,[8] Emotet had three sub-botnets: Epochs 1, 2 and 3. All of them leveraged\na single hard-coded RSA public key. This key was used to encrypt an AES encryption key that\nwas generated on-the-fly to encrypt the network traffic between an infected machine and the\nC2 servers. In the samples from recent attacks, we found the attackers evolved the\narchitecture to use two keys in the communication protocols, labeled ECK1 and ECS1.\nAccording to an early report,[20] these are two elliptic curve cryptography (ECC) public keys\nused for asymmetric encryption. ECK1 is a hard-coded elliptic-curve Diffie-Hellman (ECDH)\npublic key for encryption, and ECS1 is a hard-coded elliptic-curve digital signature algorithm\n(ECDSA) public key for data validation. There are two distinct pairs of such public keys\nextracted from our dataset, which correspond to Epoch 4 and 5 botnets:*\n\n\nEpoch 4\n\nECK1: RUNLMSAAAADzozW1Di4r9DVWzQ\npMKT588RDdy7BPILP6AiDOTLYMH\nkSWvrQO5slbmr1OvZ2Pz+AQWzRM\nggQmAtO6rPH7nyx2\n\nECS1: RUNTMSAAAABAX3S2xNjcDD0fBn\no33Ln5t71eii+mofIPoXkNFOX1Meiw\nCh48iz97kB0mJjGGZXwardnDXKxI8\nGCHGNl0PFj5\n\n*ECK1/ECS1 keys are Base64 encoded\n\n\nEpoch 5\n\nECK1: RUNLMSAAAADYNZPXY4tQxd/N4\nWn5sTYAm5tUOxY2ol1ELrI4MNhH\nNi640vSLasjYTHpFRBoG+o84vtr7A\nJachCzOHjaAJFCW\n\nECS1: RUNTMSAAAAD0LxqDNhonUYwk8s\nqo7IWuUllRdUiUBnACc6romsQoe1Y\nJD7wIe4AheqYofpZFucPDXCZ0z9i+\nooUffqeoLZU0\n\n\n-----\n\nMAPPING THE EMOTET INFRASTRUCTURE\n\nFigure 23 shows the breakdown of IP addresses, DLL payloads, and corresponding\ndocuments for Epochs 4 and 5. There were 328 unique IP addresses extracted from the DLL\npayloads. 60.8 percent of them belong to the Epoch 4 botnet, while 38.6 percent belong to\nthe Epoch 5 botnet. There is only one IP address (217.182.143[.]207, with port 443) that\nappears in both botnets (see (A) in Figure 23). This largely confirms the findings of a Bleeping\nComputer report stating that each Epoch has different C2 servers.[21] A distinct C2 infrastructure\nused by each Epoch not only greatly increases the overall redundancy, it also makes its\ntracking more challenging. For instance, if one Epoch is taken down or is under maintenance,\nthe Emotet actors can keep the other Epoch running. They can even move bots from one\nEpoch to another, according to the Bleeping Computer report.\n\n\n(A): IP\n\n\n(B): DLL (C): Document\n\n\nepoch4\n\nepoch5\n\n\nepoch4, 43.2% (10295)\n\nepoch5, 56.8% (13516)\n\n\nepoch4, 80.8% (15967)\n\nepoch5, 19.2% (3804)\n\n\n23a. IP 23b. DLL 23c. Document\n\n**Figure 23: The IP address distribution between Epochs.**\n\nThe IP address distribution shown in (A) in Figure 23 suggests that the Epoch 4 botnet has\nmore C2 servers than Epoch 5. (B) in Figure 23 shows the DLL distribution based on different\nEpochs, which implies that nearly 57 percent of the Emotet DLLs were associated with Epoch\n5. Of the DLLs dropped by Excel documents (26.7 percent of all evaluated DLLs, as shown in\n(A) in Figure 22), more than 80 percent of the documents were associated with the Epoch 4\nbotnet (see (C) in Figure 23).\n\n##### IP address:port analysis\n\nIP count distribution\n\nThe VMware Threat Analysis Unit analyzed the number of IP address:port pairs extracted from\nthe C2 configuration data of the DLL payloads and found it varies from 20 to 63. This means\n47 IP address:port pairs were generated on average per DLL.\n\nIn terms of IP address count distribution among all the DLL payloads, the top count goes to IP\naddress 217.182.143[.]207, which appeared nearly 14,000 times out of the 23,811 DLLs. This\nis the same IP address seen in Epochs 4 and 5, as discussed earlier. According to RiskIQ’s\nIP address lookup,[22] there are currently no hostnames resolving to this IP address.\nThough we don’t know the underlying reason why this IP address has been included\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|e f a e o|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|o s o|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|Col36|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|u|nde|rly|ing|re|as|on|wh|y t|his|IP|ad|dr|ess||ha|s b|ee|n i|ncl|ude|d|||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n\n\n-----\n\nMAPPING THE EMOTET INFRASTRUCTURE\n\nin so many DLLs, it could be that this host remained compromised during all the attacks, or it\nmay have been added by accident to both Epoch botnets. Figure 24 shows the full distribution\nof the 328 IP addresses contained in the 23,811 DLL payloads.\n\n\nIP address:port pair set distribution\n\nApart from analyzing the distribution of individual IP addresses, the VMware Threat Analysis\nUnit also examined how often a full set of C2 server IP address:port pairs within a DLL payload\nappeared across all DLL payloads. We did this by linking the sorted IP address:port pairs\nextracted from the DLL payload as a string and then hashing the string. There were 89 unique\nhashes of the IP address:port strings.\n\n5000\n\n12000\n\n4000\n\n10000\n\n8000 3000\n\n6000\n\n2000\n\n4000\n\n1000\n\n2000\n\n0 IP address 0 Hash of C2 IP-port set string\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||\n||||||||||i ti is||n||||||||||\n\n\n**Figure 24: IP address distribution.**\n\n\n**Figure 25: The distribution of hashes of C2 IP address**\nset strings.\n\n\nAs Figure 25 shows, there are four sets of IP address:port pairs that appeared more than\n1,000 times in all DLL payloads. The most common set, which has been used more than 4,500\ntimes, contains the following 44 IP address:port pairs:\n\n\n203.153.216.46:443\n68.183.93.250:443\n5.56.132.177:8080\n118.98.72.86:443\n54.37.228.122:443\n195.154.146.35:443\n202.29.239.162:443\n110.235.83.107:7080\n103.42.58.120:7080\n66.42.57.149:443\n159.69.237.188:443\n\n\n103.85.95.4:8080\n175.126.176.79:8080\n59.148.253.194:443\n207.148.81.119:8080\n85.25.120.45:8080\n103.8.26.17:8080\n54.38.242.185:443\n51.68.141.164:8080\n54.38.143.246:7080\n194.9.172.107:8080\n190.90.233.66:443\n\n\n185.148.168.220:8080\n210.57.209.142:8080\n104.248.225.227:8080\n103.133.214.242:8080\n116.124.128.206:8080\n45.71.195.104:8080\n88.217.172.165:8080\n78.46.73.125:443\n78.47.204.80:443\n37.59.209.141:8080\n54.37.106.167:8080\n\n\n93.104.209.107:8080\n178.62.112.199:8080\n202.28.34.99:8080\n196.44.98.190:8080\n217.182.143.207:443\n134.122.119.23:8080\n37.44.244.177:8080\n103.56.149.105:8080\n103.41.204.169:8080\n139.196.72.155:8080\n68.183.91.111:8080\n\n\n-----\n\nMAPPING THE EMOTET INFRASTRUCTURE\n\nNetwork infrastructure reuse across payloads\n\nTo get a better understanding of how IP addresses are recycled across different payloads and\ncampaigns, the VMware Threat Analysis Unit clustered all DLL payloads by the list of\nembedded network IoCs using a TF-IDF vectorizer, DBSCAN, and a cosine distance metric.\nWe also kept track of the time when each sample was seen in the wild to better understand\nthe duration of each single campaign. As Table 1 shows, there are 13 clusters. The largest one\n(cluster 0) contains 10,235 samples, which is more than 40 percent of the whole dataset, and\nspans a time horizon of almost three months. The two smallest clusters (11 and 12) contain only\na handful of payloads (three and four, respectively). They likely represent early attempts to\nresurrect both Epochs, as the earliest time stamp was November 15, 2021.\n\n\nCluster Epoch Number of payloads First time stamp Last time stamp\n\n\n0 5 10,235 March 15, 2022 June 18, 2022\n\n1 5 1,289 Jan. 11, 2022 May 23, 2022\n\n2 4 7,387 Jan. 11, 2022 May 23, 2022\n\n3 4 2,511 June 3, 2022 June 30, 2022\n\n4 5 661 June 27, 2022 June 30, 2022\n\n5 5 433 June 2, 2022 June 13, 2022\n\n6 5 795 June 13, 2022 June 29, 2022\n\n7 4 188 May 17, 2022 May 20, 2022\n\n8 4 201 May 20, 2022 May 23, 2022\n\n9 5 100 Jan. 26, 2022 Feb. 4, 2022\n\n10 4 4 May 20, 2022 May 22, 2022\n\n11 4 3 Nov. 15, 2021 Dec. 7, 2021\n\n12 4 4 Nov. 15, 2021 Jan. 4, 2022\n\n**Table 1: Payloads and clusters by IP addresses.**\n\nNetwork infrastructure reuse across time\n\nThe VMware Threat Analysis Unit further explored the time dimension by assigning each\nnetwork indicator the set of time stamps when a DLL payload was seen in the wild. This gave\nus an approximation of the period during which a given network indicator was active.\n\nFor example, if a given IP address was included in the configuration data used by three\ndifferent samples in January, February and March, it is fair to assume that the host was indeed\ncompromised during this time.\n\nWe used this approach to determine a liveliness timeline. We then sorted and plotted the\nresulting liveliness timelines into clusters of DLL payloads (see Table 1) that included a\nspecific IP address. IP addresses that were included in the same DLL payloads are also\ndisplayed, juxtaposed and colored with the same hue, so we could observe how the\nparticipation of network indicators lived and died during different campaigns.\nFigures 26 and 27 show the timelines for Epochs 4 and 5, respectively.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|s n o n b D|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|v e|Col26|d|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|Col36|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|co|lor|ed|wit|h t|he|sa|me|hu|e,|so|we|co|ul|d|o|bs|erv|e h|ow|th|e|||||||||||||||\n|dic|ato|rs|live|d|and|di|ed|du|rin|g|diff|ere|nt|c|a|mp|aig|ns|.|||||||||||||||||\n|e ti|me|lin|es|for|Ep|oc|hs|4 a|nd|5,|re|spe|cti|v|el|y.||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n\n\n-----\n\nMAPPING THE EMOTET INFRASTRUCTURE\n\n**Figure 26: Timeline of liveliness of network indicators belonging to Epoch 4 samples.**\n\n**Figure 27: Timeline of liveliness of network indicators belonging to Epoch 5 samples.**\n\n\n-----\n\nMAPPING THE EMOTET INFRASTRUCTURE\n\nIP geographic distribution\n\nThe VMware Threat Analysis Unit analyzed the geographic distribution of the 328 IP addresses\n(see Figure 28) to understand which countries were used to host the Emotet infrastructure.\nThe analysis shows that more than 18 percent of the IP addresses were in the U.S., followed\nby Germany and France. Other popular regions included South Asia, Brazil, Canada, and the\nUnited Kingdom.\n\nPercentage (%)\n\n18 The most common\n\n16\n\n#### port was 8080, which\n\n14\n\n12 accounted for more\n\n108 than 50 percent of\n\n6\n\n#### all the ports counted,\n\n42 followed by port 443\n\n#### (HTTPS).\n\n**Figure 28: IP distribution map.**\n\nPort distribution\n\nEvery C2 server IP address comes with a specific\nport number. There were four commonly used\nports found in the 329 IP address:port pairs of\nthe 328 unique IP addresses (see Figure 29).\n\nThe most common port was 8080, which\naccounted for more than 50 percent of all the\nports counted, followed by port 443 (HTTPS).\nPort 8080 is commonly used as a proxy port,\nsuggesting that most of the C2 servers\nassociated with the IP addresses were likely to\nbe compromised legitimate servers used to\nproxy traffic to the real C2 servers. Using proxies\nto hide actual C2 servers is common in Emotet\n\nport 8080, 54.1% (178)\n\nattacks. According to the findings of a report port 443, 33.7% (111)\npublished in 2017,[23] Emotet actors run an Ngnix port 7080, 8.5% (28)\nreverse proxy on a secondary port (e.g., 8080) port 80, 3.6% (12)\nof a compromised server, which then relays\nrequests to the actual sever. There was only one **Figure 29: Port distribution.**\nIP address (185.244.166[.]137) associated with\ntwo different ports: 443 and 8080.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Por|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||p p p p|ort 8 ort 4 ort 7 ort 8|08 43, 080 0, 3|0, 5 33. , 8. .6%|4.1% 7% ( 5% (12|(17 111) (28) )|8)|||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n||||||||||||||||t di|strib|uti|on.||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n\n\n-----\n\nMAPPING THE EMOTET INFRASTRUCTURE\n\nJARM fingerprint distribution\n\nThe Joint Architecture Reference Model (JARM) is an active Transport Layer Security (TLS)\nserver fingerprinting tool used to identify and cluster servers based on their TLS\nconfiguration.[24] The VMware Threat Analysis Unit examined the distribution of JARM\nfingerprint hashes for the Emotet C2 server IP addresses.\n\nAt the time of this report, we were able to obtain JARM fingerprints for 297 of the 328 IP\naddresses by querying the IP addresses on VirusTotal. The remaining 31 IP addresses were\nmissing the JARM fingerprint. The likely reason is that those C2 servers were offline at the time\nwhen VirusTotal checked their JARM fingerprints.\n\nWe assume that the JARM fingerprint hashes obtained from VirusTotal were based on the C2\nservers’ default HTTPS port (443). To verify this assumption, we scanned one of the C2 IP\naddress:port pairs, 135.148.121[.]246:8080, with the JARM fingerprinting tool[25] (see Figure 30).\nThe tool allows you to specify a specific port (with option -p) when fingerprinting a server. If a\nport is not specified, it uses the default port of the server.\n\n**Figure 30: JARM fingerprinting IP address 135.148.121[.]246 with different ports.**\n\nAs you can see from the Figure 30, the fingerprint hash\n15d3fd16d29d29d00042d43d0000009ec686233a4398bea334ba5e62e34a01 is the same\nwhen scanning with the default port and port 443. This is the same JARM hash returned from\nVirusTotal when querying for the IP address.\n\nHowever, when scanning the IP address with port 8080 (as highlighted in Figure 30), JARM\nfailed to fingerprint the server (the fingerprint hash string was all zeros). In essence, the server\nrefused to respond to JARM fingerprinting messages on port 8080, which we inferred to\nmean the port typically used for proxy service was closed. We confirmed this assumption with\nNmap port scanning (see Figure 31).\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||p d s||||||||||||||||||||\n\n\n-----\n\nMAPPING THE EMOTET INFRASTRUCTURE\n\n**Figure 31: Port scanning with Nmap.**\n\nBy using the RiskIQ Community tool, the VMware Threat Analysis Unit determined the IP\naddress belongs to OVH (highlighted in Figure 32). OVH is a European internet service\nprovider (ISP) that delivers server rental services. This ISP is not well known for abuse.\nAs we can see from Figure 32, there are a few domains currently pointing to the IP address\nsince July 2021, which existed before Emotet resurfaced. So, we have a good reason to\nbelieve that this is probably a legitimate web server that has been compromised.\n\n**Figure 32: The RiskIQ lookup on IP 135.148.121[.]246.**\n\nThe findings from the investigation in Figure 32 show that using JARM to fingerprint a server\nwithout specifying a port number can generate misleading results. Different services running\non the same server but with different ports can lead to different JARM fingerprints. This\nreinforces how important it is to specify the corresponding port numbers identified from the\nC2 configuration when using JARM in threat hunting (such as hunting for C2 servers).\n\nBecause of these limitations, we only used the subset of C2 IP address:port pairs that\nreferenced port 443 when analyzing the JARM fingerprints obtained from VirusTotal.\nAccording to the port distribution in Figure 29, there were 111 such IP addresses, with 92\nhaving JARM fingerprints from VirusTotal. As Figure 33 shows, there are 14 unique JARM\nfingerprint hashes in total, and 75 IP addresses with port 443 that share the same hash:\n2ad2ad0002ad2ad0002ad2ad2ad2ade1a3c0d7ca6ad8388057924be83dfc6a.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|A . A u ti d e h e s 4|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|er g e|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n\n\n-----\n\nMAPPING THE EMOTET INFRASTRUCTURE\n\n70\n\n\n60\n\n50\n\n\n40\n\n30\n\n\n20\n\n10\n\n\n0\n\n\nIP JARM fingerprint hash\n\n**Figure 33: The JARM fingerprint hash distribution for IP addresses with port 443.**\n\n\nIt is worth noting that although JARM can be used to identify and cluster servers, including\nmalware C2 servers, it can lead to false positives (FPs) if not combined with other intelligence,\nsuch as IP address/domain history and reputation. For instance, a report from Cobalt Strike\nfound the JARM fingerprint of a Cobalt Strike server was the same as a Java server.[26]\nIn addition, JARM fingerprinting can be evaded by changing the server-side configuration\nusing a proxy,[27] so it should be used with caution.\n\nAS number distribution\n\n\nAn autonomous system (AS), which is identified by a unique number, refers to a large network\nor group of networks typically operated by a single large organization, such as an ISP or a\nlarge enterprise. For example, OVH’s AS number is 16276, as shown in Figure 32. Therefore,\nby examining the distribution of AS numbers of the C2 IP addresses, the VMware Threat\nAnalysis Unit tried to reveal the organizations that own or operate the corresponding servers\nused in the attacks.\n\nThere are 144 unique AS numbers associated with the 328 IP addresses in our dataset (see\nFigure 34). As the distribution shows, the most common AS number (14061 – DigitalOcean) is\nrelated to 44 IP addresses, and most of the AS numbers only have one IP address each. The\ndetailed AS numbers for all IP addresses can be found in the IoCs section of the Appendix.\n\n\n-----\n\nMAPPING THE EMOTET INFRASTRUCTURE\n\n40\n\n\n30\n\n20\n\n\n10\n\n\n0\n\n**Figure 34: IP address AS number distribution.**\n\n\nAS number\n\n\nExecution chains and infrastructure\n\nIn the previous sections, the VMware Threat Analysis Unit observed that both execution chains\nand C2 IP addresses changed over time as new DLL updates were distributed. In both cases,\nthe underlying reason was often an external event. For example, in the case of execution\nchains, the main drivers for change were the advent of new infection vectors and the need to\nevade detection. In the case of C2 IP addresses, changes occur often because compromised\nhosts are ephemeral, as ISPs continuously identify, disinfect and restore (or just denylist)\naffected hosts.\n\nTo explore the relationship between these two types of updates, Figure 35 shows the\nintersections between execution chain clusters and C2 IP address clusters. While we see many\nmore execution chain clusters than C2 IP address clusters, some of the mappings are\nremarkably injective. For example, network cluster 4 maps almost entirely to DLL cluster 0,\nmeaning that a specific set of network indicators was always used by samples exercising a\nvery specific infection chain (in this example, excel.exe -> regsvr32.exe -> regsvr32.exe ->\nregsvr32.exe). Similarly, we see the C2 IP addresses in clusters 1, 5 and 7 are (almost) uniquely\nused by DLL payloads using yet another unique infection chain (DLL cluster 3): excel.exe ->\nregsvr32.exe -> regsvr32.exe.\n\n\nThe VMware Threat Analysis Unit speculates this is an artifact of the software development\nlifecycle adopted by Emotet. It increasingly resembles how modern applications are\ndeveloped with new features or with updates implemented as needed, and releases\nissued periodically.\n\n\n-----\n\nMAPPING THE EMOTET INFRASTRUCTURE\n\n**Figure 35: The relationships between execution chain clusters and network infrastructure.**\n\n\n-----\n\nEMOTET RELOADED\n\n### To map the evolution of the Emotet threat, the VMware Threat Analysis Unit created an analysis pipeline.\n\nThis pipeline continuously analyzes new samples observed in our telemetry, extracts the\nC2 configuration, and uses a modified Emotet sample to connect to the C2 endpoints to\nobtain updates.\n\nIn the Downloading updates and plug-in modules section of the Appendix, we provide a\ndetailed analysis of how Emotet updates its components and distributes plug-ins with\nspecific functionality. This is how we were able to collect various artifacts through time.\n\nEmotet has been known to use a few modules during its infection chain, most notably:\n\n- The core module (the Emotet payload) downloads additional modules or\nmalware from a C2 server.\n\n- Credential stealing modules, specifically MailPassView and\nWebBrowserPassView, are legitimate third-party tools from NirSoft that threat\nactors use to steal credentials from web browsers and mail clients.[28]\n\n- The spam module spreads malware.[28]\n\n- The email harvesting module exfiltrates email credentials, contact lists,\nand email contents from infected PCs to the C2 server.[29]\n\nOther modules seen in early versions of Emotet included a distributed denial-of-service\n(DDoS) module and a banking module, but neither are active anymore.[30]\n\nDuring our analysis window, we observed eight different modules:\n\n\n1. The core module\n(the Emotet payload)\n\n2. A spamming module\n\n3. A Thunderbird email client\naccount stealer\n\n4. An Outlook email client\naccount stealer\n\n\n5. A credit card information stealer[31]\n\n6. A spreader that leverages the\nSMB protocol[32]\n\n7. A module with an embedded\nMailPassView application\n\n\nIn addition to known modules and functionality seen in the past, the list highlights two\nupdated modules that we were able to intercept. These were a module that steals credit\ncard information, specifically targeting Google Chrome browsers, and a spreading module\nthat leverages the SMB protocol. Other researchers have validated they have seen similar\nmodules in recent Emotet attacks (see the references in the previous lists).\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|a a h o d o|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n\n\n-----\n\nEMOTET RELOADED\n\n**Figure 36: Emotet updates with unique builds grouped by color.**\n\n\nFigure 36 aggregates update information\npulled from the Emotet network\ninfrastructure. Every record represents\nan update that was distributed by a C2\nserver to a bot (the system on which the\nbot is running is uniquely identified by the\ncorresponding C: volume serial number and\ncomputer name).\n\nIt is worth noting that the builds that are\ndelivered to different compromised hosts\nhave different file hashes. However, updates\nof the same type have the same conceptual\nhash. This concept was introduced when the\nVMware Threat Analysis Unit noticed the\nbuilds of the same type, delivered on the\nsame day, were almost identical except for\nthe 32 bytes of data stored within the .rdata\nsection of the file. By eliminating the .rdata\nsection from the SHA1 hash calculation, it is\npossible to track unique builds of the\nupdates. For example, in Figure 36, we\ngroup unique builds by color to show how\ngroups of samples with different SHA1\nhashes have an identical conceptual hash.\n\n\nDuring our analysis window (Figure 37),\nwe made the following observations:\n\n- The first update delivered to a newly\ninstalled bot of any Epoch is always (with\na very few exceptions) the core update.\n\n- There were deliveries of the packed version\nof the core update on June 3, 2022 and\nJune 7, 2022 (Epoch 5), and June 15, 2022\n(Epoch 4). This is the same DLL that is\ndropped by an Excel document in the initial\ninfection chain. It is unusual because the\nupdates are normally not packed.\n\n- The core update is almost always\naccompanied in both Epochs by\nMailPassView, WebBrowserPassView,\nOutlookStealer, and ThunderbirdStealer.\n\n- The spam module was introduced on\nMay 26, 2022 by the Epoch 5 botnet, but\nthen a new version was delivered on June\n8, 2022 to the bots of the Epoch 4 botnet\nfor testing.\n\n- CreditCardStealer was introduced on June\n7, 2022 by the Epoch 4 botnet for testing.\nAlmost a week later on June 13, 2022, the\ncomponent was delivered to the bots of the\nEpoch 5 botnet.\n\n\n-----\n\nEMOTET RELOADED\n\n- SMBSpreader was introduced on June 13,\n2022 in both the Epoch 4 and 5 botnets.\nSince then, they have been pushing it to\nevery bot of both botnets.\n\n\n\n- Since mid-May 2022, Emotet samples have\nstarted transitioning to a new method of\nstoring the configuration data within the\nbinary. This broke our analysis pipeline for\napproximately two weeks (between May\n12–26, 2022), during which we were not\nable to collect any updates.\n\nCore\n\n\n\n- Short gaps in the charts represent when\nour analysis broke down due to other\nfactors, including failures in the\nconfiguration extraction pipeline or\nbroken VPN links.\n\nIn conclusion, Epochs 4 and 5 deliver the\nsame payloads, but early updates tend to\nreach Epoch 4 first, confirming that Emotet\ndevelopers are using Epoch 4 as their test\nbotnet before deploying things more widely\nthrough Epoch 5.\n\n\nCore Packed\n\nCreditCardStealer\n\n\nMailPassView\n\nOutlookStealer\n\nSMBSpreader\n\n\nSpam\n\nThunderbirdStealer\n\n\nWebBrowserPassView\n\nCore\n\n\nApril 29 May 2 May 4 June 4-8 June 13-18 June 20-22 June 25 June 28-29\n\n\nCore Packed\n\nCreditCardStealer\n\n\nMailPassView\n\nOutlookStealer\n\nSMBSpreader\n\nSpam\n\n\nThunderbirdStealer\n\nWebBrowserPassView\n\n\nMay 2 May 5-6 May 9 May 12 May 26 May 30-31 June 3-8 June 13-17 June 21-22 June 25 June 28-30\n\n**Figure 37: The timeline of the distribution of Emotet modules for Epoch 4 (top) and Epoch 5 (bottom).**\n\n\n-----\n\nEMOTET RELOADED\n\nFigure 38 shows the network origin of the\nEmotet modules. The y-axis represents the\nautonomous systems of the IP addresses of\nthe servers hosting the Emotet modules,\nwhile the x-axis represents the percentage of\nthe modules pushed from that AS (on the\nleft) and the count of these modules (on the\nright). For example, AS52772 pushed 10\nmodules in total: one MailPassView, one\nWebBrowserPassView, four spam, and four\nThunderbirdStealer.\n\nOf note, AS14061 was the most active AS,\ntotaling 1,198 delivered modules, which\n\nAS46606\nAS60781\nAS141147\nAS62904\nAS47330\nAS137114\nAS48275\nAS52772\nAS327814\nAS4621\nAS135161\nAS14061\nAS4766\nAS9318\nAS131293\nAS16276\nAS30083\nAS9123\nAS51582\nAS9269\nAS37963\nAS51167\nAS197695\nAS24940\nAS34119\nAS12876\nAS45291\nAS16284\nAS10143\nAS7713\nAS45293\nAS24961\nAS133496\nAS269468\nAS63949\nAS61635\nAS27951\nAS53667\nAS133296\n\n0 20 40 60 80 100\n\nPercentage\n\n\ncovered all known types. Overall, the most\ndelivered module was OutlookStealer; it\nwas delivered 1,093 times by 15 different\nautonomous systems (out of 39). The rarest\nmodule was the core module packed, which\nwas only delivered 17 times and only\ndelivered by six of the autonomous systems.\nThe most popular module was the core\nmodule (unpacked), which was delivered by\n31 autonomous systems. Nine autonomous\nsystems delivered only one module, six\ndelivered only the core module, and three\ndelivered only the spam module.\n\nCore\nCore packed\nCreditCardStealer\nMailPassView\nOutlookStealer\nSMBSpreader\nSpam\nThunderbirdStealer\nWebBrowserPassView\n\n0 200 400 600 800 1000 1200\n\nCount\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||||\n||||||||||||||w e 0 t e||||||||||st s ic||||||||||||\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|\n|---|---|---|---|---|---|---|---|\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||||||\n|||||Core||||\n|||||Core p|acked|||\n|||||||||\n|||||Credit|CardSte|aler||\n|||||||||\n|||||MailPa|ssView|||\n|||||||||\n|||||Outloo|kSteale|r||\n|||||||||\n|||||SMBS|preader|||\n|||||||||\n|||||Spam||||\n|||||||||\n|||||Thund|erbirdSt|ealer||\n|||||WebB|rowserP|assView||\n|||||||||\n\n\n**Figure 38: Network origin distribution (autonomous system) of Emotet modules (percentages on the left, count**\non the right).\n\n\n-----\n\nEMOTET RELOADED\n\nThe VMware Threat Analysis Unit\nalso analyzed the geographic\ndistribution of the IP addresses\nof the servers (see Figure 39) to\nreveal which countries were used\nto host the Emotet modules.\n\nThe analysis shows that most of\nthe modules were hosted in India\n(more than 26 percent), followed by\nKorea, Thailand, and Ghana. Other\npopular regions included France\nand Singapore.\n\n\n**Figure 39: Geographic distribution of the Emotet modules.**\n\n\nIt is worth noting that the IP addresses of the servers hosting the Emotet modules can be\ndifferent from the IP addresses extracted from the initial Emotet payload configuration (see\nFigures 28 and 29). As previously discussed, most of the IP addresses extracted from the\nconfiguration were likely to be compromised legitimate servers used to proxy the actual\nservers that hosted the Emotet modules.\n\n\n-----\n\nVMWARE RECOMMENDATIONS\n\nThe VMware Threat Analysis Unit recommends organizations implement the following\ntechnologies, programs and processes to create a strong security foundation that can better\nprotect against Emotet and other nefarious malware strains.\n\nAwareness and training programs Segment the network\n\n\nEnsure everyone in the organization is aware\nof the phishing and social engineering tactics\nattackers use to try to deliver their malware,\nand knows what to do (and what not to do)\nto make sure the attack tactics don’t work.\n\nNetwork detection and response (NDR)\n\nProvide signature-based detection as well\nas identification capabilities, and counter\nsystem-wide network threats with no\nprevious signature.\n\nEmail security\n\nProvide a prevention, detection and\nresponse framework for protecting email\naccounts, content and communications.\nThreat actors commonly use email to\nproliferate malware, spam and phishing\nattacks, so it’s important to protect email\nprivacy and integrity.\n\nNext-generation firewalls\n\nEnable traffic inspection at critical control\npoints, and leverage threat intelligence to\nblock traffic to and from known malicious\nand C2 IP addresses.\n\nIntrusion detection and prevention\nsystems (IDS/IPS)\n\nTurn on IDS/IPS controls to detect and\nblock attacks using the signatures of known\nmalicious network activity.\n\nEndpoint detection and response (EDR)\n\nProvide malware protection that analyzes\nand detects attacks, based on rule sets\n(signatures) or heuristics (anomalies), and\nthen alerts and triages threats on endpoints.\n\n\nMicro-segment the network, which splits the\nnetwork into multiple subnetworks designed\naround business needs and technology\nrequirements, to contain threats that may\nhave already made it inside the network and\nprevent their spread.\n\nInspect east-west traffic\n\nUtilize east-west network traffic analysis to\nidentify patterns and abnormal behaviors\nthat could be indicators of compromise.\n\nScan network artifacts\n\nDynamically analyze file behaviors for threats\nby using AI and machine learning (ML) to\ndetect malicious code.\n\nLog aggregation\n\nCollect logs from all critical devices, security\ncontrols, and endpoints in a central location\nfor correlation and analysis that can uncover\nTTPs.\n\nApply Zero Trust principles\n\nImplement policy and technical controls that\nenforce a Zero Trust model to restrict access\nto all networks, systems, applications and\nprocesses. Allow only the minimal access\nrequired to perform assigned functions.\n\nImplement robust password policies and\nbest practices\n\nRemove all default, shared and hard-coded\nauthentication processes in place of stronger\nauthentication mechanisms. Encourage the\nuse of multifactor authentication practices\nwhere feasible.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|Col36|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||l t t||||||||||er t||||||||||||\n\n\n-----\n\nVMWARE RECOMMENDATIONS\n\nPatch management\n\nApply security updates to the operating\nsystems, software, hardware and plug-ins\nof your infrastructure in a regular, timely\nmanner to address vulnerabilities that\nattackers could exploit to get into your\nnetwork.\n\nPenetration and vulnerability testing\n\nConduct regular penetration testing and\nvulnerability assessments to understand\nand reduce your potential attack surface.\n\n##### How VMware can help\n\nIt is anticipated that Emotet will continue to\nevolve its TTPs over time to remain pervasive\nand evade detection. VMware can help by\ndelivering security as a built-in distributed\nservice to protect your users, devices,\nworkloads and networks. VMware Security\ncan help effectively detect, mitigate and\ncontain Emotet and its permutations, as well\nas other polymorphic threats. The portfolio\nincludes full-fidelity telemetry collection,\nsophisticated threat intelligence, and\nanomaly detection capabilities paired with\nsecurity controls for endpoints, workloads\nand networks.\n\nWith VMware, you can also implement a\nZero Trust strategy with fewer tools and\nsilos. You can scale responses to threats with\nconfidence, speed and accuracy to minimize\nand prevent attack impacts. When you\n\n\nActive threat hunting\n\nMonitor everyday activities and traffic across\nthe network, and investigate possible\nanomalies to find any yet-to-be-discovered\nthreats that could lead to a security breach.\n\nLateral security\n\nSecure end-to-end connectivity for\napplications, including end users,\nmicroservices, APIs and data, to reduce the\nspread and lateral movement of threats.\n\nembed security within the hypervisor, you\ndecrease your attack surface to reduce\nsecurity risks, ensure compliance, and\nsimplify security operations.\n\nYou can operationalize more of your security\nthrough your IT and development teams\nwith VMware, dramatically increasing your\ncapacity to protect and defend your\ninfrastructure. The authoritative context\nfrom the visibility, depth and accuracy of\nVMware’s data collection enables security\nteams to confidently respond to events\noccurring within your organization’s assets.\nThis allows you to focus on high-value\nactivities, knowing VMware’s intelligent\nrisk correlation with proactive prevention,\ndetection and response capabilities is\nprotecting your assets and operations.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|w a|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|,|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n\n\n-----\n\nVMWARE RECOMMENDATIONS\n\nVMware Security provides many capabilities to protect you from the advanced threats\ntargeting your multi-cloud environments, such as Emotet.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||||\n|||||||||||||||h h e|||||||||||||||||||||\n\n\n-----\n\nCONTRIBUTORS\n\nEthem Bagci\n\nOleg Boyarchuk\n\nSebastiano Mariani\n\nStefano Ortolani\n\nGiovanni Vigna\n\nJason Zhang\n\n\n-----\n\nBIBLIOGRAPHY\n\n1 Malpedia. “Mummy Spider.” July 2022.\n\n2 SecurityWeek. “‘Emotet’ Banking Malware Steals Data Via Network Sniffing.” Eduard Kovacs. June 30, 2014.\n\n3 U.S. Department of Health and Human Services. “The Return of Emotet and the Threat to the Health Sector.” June 2,\n2022.\n\n4 VMware. “Defeat Emotet Attacks with Behavior-Based Malware Protection.” Jason Zhang. November 5, 2020.\n\n5 Cisco Talos Intelligence Group. “Emotet is back after a summer break.” Colin Grady, William Largent, and Jaeson Schultz.\nSeptember 17, 2019.\n\n6 VMware. “COVID-19 Cyberthreats and Malware Updates.” Jason Zhang, Subrat Sarkar, and Stefano Ortolani. November\n9, 2020.\n\n7 Europol. “World’s most dangerous malware EMOTET disrupted through global action.” January 27, 2021.\n\n8 VMware. “Death of Emotet: The Takedown of The Emotet Infrastructure.” Stefano Ortolani and Giovanni Vigna. February\n22, 2021.\n\n9 Digital Shadows. “The Emotet Shutdown Explained.” April 22, 2021.\n\n10 Cyber.wtf. “Guess who’s back.” Luca Ebach. November 15, 2021.\n\n11 Bleeping Computer. “Emotet botnet comeback orchestrated by Conti ransomware gang.” Ionut Ilascu. November 19,\n2021.\n\n12 VMware. “Emotet Is Not Dead (Yet).” Jason Zhang. January 21, 2022.\n\n13 VMware. “Emotet Is Not Dead (Yet) – Part 2.” Jason Zhang. February 7, 2022.\n\n14 VMware. “Evolution of Excel 4.0 Macro Weaponization.” James Haughom and Stefano Ortolani. June 2, 2020.\n\n15 VMware. “Evolution of Excel 4.0 Macro Weaponization – Part 2.” Baibhav Singh. October 14, 2020.\n\n16 VMware. “Symbexcel: Bringing the Power of Symbolic Execution to the Fight Against Malicious Excel 4 Macros.” Giovanni\nVigna and Stefano Ortolani. September 30, 2021.\n\n17 MITRE. “ATT&CK Framework.” June 2022.\n\n18 VMware. “Emotet C2 Configuration Extraction and Analysis.” Oleg Boyarchuk and Jason Zhang. March 29, 2022.\n\n19 VMware. “Emotet Moves to 64 bit and Updates its Loader.” Oleg Boyarchuk, Jason Zhang, and Stefano Ortolani. May 16,\n2022.\n\n20 Intel 471. “How the new Emotet differs from previous versions.” December 8, 2021.\n\n21 Bleeping Computer. “Emotet Trojan Evolves Since Being Reawakend, Here is What We Know.” Lawrence Abrams.\nSeptember 19, 2019.\n\n22 RiskIQ. “217.182.143.207.” June 2022.\n\n23 MalwareTech. “Investigating Command and Control Infrastructure (Emotet).” November 13, 2017.\n\n24 Salesforce. “Easily Identify Malicious Servers on the Internet with JARM.” John Althouse. November 17, 2020.\n\n25 Salesforce. “salesforce / jarm.” October 2021.\n\n26 Cobalt Strike. “A Red Teamer Plays with JARM.” Raphael Mudge. December 8, 2020.\n\n27 Netskope. “JARM Randomizer.” May 2021.\n\n28 CERT Polska. “Analysis of Emotet v4.” Paweł Srokosz. May 24, 2017.\n\n29 Kryptos Logic. “Emotet Awakens With New Campaign of Mass Email Exfiltration.” October 31, 2018.\n\n30 Proofpoint. “Threat Actor Profile: TA542, From Banker to Malware Distribution Service.” May 15, 2019.\n\n31 Bleeping Computer. “Emotet malware now steals credit cards from Google Chrome users.” Sergiu Gatlan. June 8, 2022.\n\n32 Reversing.fun. “Emotet SMB spreader overview.” June 20, 2022.\n\n33 Kaspersky. “The Banking Trojan Emotet: Detailed Analysis.” Alexey Shulmin. April 9, 2015.\n\n34 SecurityWeek. “New Emotet Variant Targets Banking Credentials of German Speakers.” Eduard Kovacs. January 7, 2015.\n\n35 Symantec. “The Evolution of Emotet: From Banking Trojan to Threat Distributor.” July 18, 2018.\n\n36 Infosecurity. “Allentown Struggles with $1 Million Cyber-Attack.” Tara Seals. February 21, 2018.\n\n37 BlackBerry. “Threat Spotlight: Panda Banker Trojan Targets the US, Canada and Japan.” October 9, 2018.\n\n38 Heise. “Trojan infestation: Emotet at Heise.” Jürgen Schmidt. June 6, 2019.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Oc|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|Col36|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||O vi 9, e ul r p||||||||||2 0||.||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n\n\n-----\n\nBIBLIOGRAPHY\n\n39 Malwarebytes. “Let’s talk Emotet malware.” November 2021.\n\n40 Der Tagesspiegel. “Emotet warning ignored for days.” Robert Kiesel. February 12, 2020.\n\n41 Archyde. “‘Emotet’ in Berlin: computer virus also affects Humboldt University – Berlin.” November 10, 2019.\n\n42 ZDNet. “Frankfurt shuts down IT network following Emotet infection.” Catalin Cimpanu. December 19, 2019.\n\n43 Check Point. “January 2020’s Most Wanted Malware: Coronavirus-themed spam spreads malicious Emotet malware.”\nFebruary 13, 2020.\n\n44 ESET. “Emotet strikes Quebec’s Department of Justice: An ESET Analysis.” Gabrielle Ladouceur Despins. September 16,\n2020.\n\n45 Bleeping Computer. “Emotet starts dropping Cobalt Strike again for faster attacks.” Lawrence Abrams. December 15,\n2021.\n\n46 Bleeping Computer. “Emotet malware campaign impersonates the IRS for 2022 tax season.” Lawrence Abrams. March\n16, 2022.\n\n47 VMware. “Emotet Config Redux.” Oleg Boyarchuk and Stefano Ortolani. May 25, 2022.\n\n48 QEMU. “QEMU: A generic and open source machine emulator and virtualizer.” June 2022.\n\n49 Qiling. “Qiling Framework.” April 2022.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|Col36|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||2 rl a pr ll||||||||||” r||,||||||||||\n\n\n-----\n\nAPPENDIX\n\n##### IoCs\n\nThe indicators of compromise identified from this report (including DLL samples,\n[configuration, and payload updates) can be found on the VMware Threat Analysis Unit-](https://github.com/vmware-samples/tau-research/tree/emotet-report/2022-H2-Emotet-Resurrection)\n[Research GitHub repository.](https://github.com/vmware-samples/tau-research/tree/emotet-report/2022-H2-Emotet-Resurrection)\n\n##### Emotet activity timeline notes\n\nJune 2014 Emotet first emerged as a banking Trojan. The malware was initially\ndesigned to steal banking credentials from banks mainly located\nin Germany.[2 ]\n\nSeptember 2014 Emotet version 2 (v2). Emotet began to leverage a so-called automatic\ntransfer system (ATS) technology to automate money transfers from\nvictims’ bank accounts mainly from German and Austrian banks.[33]\n\nJanuary 2015 Emotet v3. The malware became stealthier as compared to its previous\nversions to avoid being detected by antivirus scanners. It expanded its\ntargets to Swiss banks.[33,34]\n\n2016 Emotet evolved into a loader, making it capable to download\nsecond-stage payloads.\n\n2017 Emotet began to deploy TrickBot, IcedID and UmbreCrypt (ransomware).[35]\n\nSeptember 2017 Emotet v4. This variant used a 128-bit AES algorithm instead of RC4 (used\nin its previous releases) to encrypt communications between infected\nmachines and C2 servers.[28]\n\nFebruary 2018 Attack on Allentown, Pennsylvania, costing nearly $1 million to mitigate\nthe damage.[36]\n\nOctober 2018 Emotet began to deploy the Panda banking Trojan.[37]\n\nMay 2019 Attack against Heise, Germany.[38]\n\nJuly 2019 Attack against Lake City, Florida.[39]\n\nSeptember 2019 Attack against Berlin Superior Court, Germany.[40]\n\nOctober 2019 Attack against Humboldt University, Germany.[41]\n\nDecember 2019 Attack against City of Frankfurt, Germany.[42 ]\n\nJanuary 2020 Emotet uses COVID-19-themed emails to spread.[43]\n\nSeptember 2020 Attack against Quebec’s Department of Justice, Canada.[44]\n\nJanuary 2021 Emotet is taken down (Operation Ladybird).[8]\n\nNovember 2021 Emotet comes back.[10]\n\nDecember 2021 Emotet starts dropping Cobalt Strike.[45]\n\nMarch 2022 Emotet used IRS-themed emails to spread.[46]\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n||||||||||||inc V|lud Mw|in are|g|D T|LL hre|sa at|mp An|les aly|, sis|Un|it-||||||||||||\n||||||||||||oja|n.|The||m|alw|ar|e w|as|ini|tial|ly||||||||||||\n\n\n-----\n\nAPPENDIX\n\n##### Extracting the Emotet configuration\n\nThe process of extracting the C2 configuration from an Emotet sample has two main steps:\n\n1. Decrypting and dumping the internal DLL from the initial DLL payload.\n\n2. Scanning the decrypted internal DLL to extract the C2 configuration data, namely the C2\nservers’ IP address:port pairs and the public encryption key(s).\n\nUsing manual analysis, we looked at these two steps.\n\nStep 1: Decrypting and dumping the internal DLL\n\nTo demonstrate this step, we analyzed the Emotet sample with hash\n63996a39755e84ee8b5d3f47296991362a17afaaccf2ac43207a424a366f4cc9.\n\nThe DllMain function of this sample (and many others) used the following algorithm to:\n\n\n\n- Allocate approximately 100MB of memory\nwith malloc and fill it with random data.\nThis stops the analysis of weak emulators\nnot willing to allocate large amounts\nof memory.\n\n- Find the base address of kernel32.dll by\nparsing the TEB, PEB, PEB_LDR_DATA,\nand the like. While normally this method is\nused to make the reverse engineering\nprocess more difficult, statically imported\nfunctions are still used later in the code.\nWe speculate this is a trick to also break\nemulation, as references to internal OS\nstructures are seldom fully handled\nby emulators.\n\n- Find VirtualAlloc and VirtualAllocExNuma\nwith the help of an ad hoc version\nof GetProcAddress.\n\n- Allocate memory with either\nVirtualAllocExNuma or VirtualAlloc,\ndepending on which one is available.\nVirtualAlloc is supported starting with\nWindows XP, whereas VirtualAllocExNuma\nis supported starting with Windows Vista.\nThis looks like another trick to stop weak\nemulators that do not support the\ncomplete set of Windows APIs.\n\n\n\n- Copy the internal DLL into the allocated\nmemory and then decrypt it.\n\n- Map the sections of the internal DLL in\nmemory, and then fix relocations and\nimports. This is achieved with the help\nof the statically imported functions\nVirtualAlloc, LoadLibrary,\nand GetProcAddress.\n\nTo be able to decrypt and dump the internal\nDLL, it is first necessary to load the original\nDLL payload into a debugger, set\nbreakpoints on the invocation of\nVirtualAllocExNuma and VirtualAlloc, and\nthen start execution. When the execution\nreaches the breakpoint, you need to trace\nthe code until it returns a pointer to the\nallocated memory.\n\n\n-----\n\nAPPENDIX\n\nIn Figure 40, the address of the newly allocated memory is 0x00E7000.\n\n**Figure 40: Memory allocated with VirtualAllocExNuma.**\n\nThe next step is to trace the code of DllMain until it copies the encrypted DLL into the allocated\nmemory. Figure 41 shows that the data of the Dump tab has changed from all zeros to\nrandom bytes.\n\n**Figure 41: Embedded DLL copied into the allocated memory.**\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\nNext, the code of DllMain can be traced a bit further until the data of the Dump tab updates to\na PE file with the MZ signature at the very beginning and the text “This program cannot be run\nin DOS mode” (see Figure 42).\n\n**Figure 42: Decrypted embedded DLL in allocated memory.**\n\nAt this point, it is possible to dump the decrypted internal DLL.\n\n\n-----\n\nAPPENDIX\n\nStep 2: C2 configuration extraction\n\nThe next step is to locate the configuration\ndata. The DLL is supposed to be executed\nwith the help of rundll32. The following\ncommand line can be used when debugging\nthis artifact:\n```\n\"C:\\Windows\\system32\\rundll32.exe\"\n\"Path\\to\\dumped.dll\",\nDllRegisterServer\n\n```\nThe internal DLL does not import any\nfunction. Instead, it retrieves pointers to\nthe Windows API functions dynamically.\nIn addition, some of the core functionality\nis obfuscated, which makes static analysis\nchallenging. Under the hood, the code\nobfuscation includes mathematical\noperations performed multiple times\n(see Figure 43).\n\nThe result of such calculations is passed\nto a function and then never used (see\nFigure 44).\n\nAs Figure 45 shows, the obfuscation\nalso includes multiple conditional jumps\nthat break the control flow of the\ndecompiled code.\n\n\n**Figure 43: Mathematical operations on a number in**\nthe obfuscated code.\n\n**Figure 44: The result of the mathematical operations**\npassed as the sixth parameter to a function.\n\n\n**Figure 45: Conditional jumps in the obfuscated code.**\n\n\n-----\n\nAPPENDIX\n\nThe abundance of jumps is translated into nested while loops in the decompiled\nobfuscated code (see Figure 46).\n\n**Figure 46: Nested while loops in the obfuscated code.**\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n||n th|e o|bfu|sca|ted|co|de.|||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\nEach API function has a wrapper that is\ncalled by the core functionality. For\nexample, Figure 47 shows how DllMain\ncalls the wrapper around the\nExitProcess API.\n\nFigure 48 shows the implementation\nof the ExitProcess wrapper. It calls\nFindProcAddress, which is also called\nby every other API wrapper to retrieve\nthe API function address by hash.\n\nBy setting a breakpoint on\nFindProcAddress, all the API wrappers\ncan be extracted and named. The\nVMware Threat Analysis Unit was\nparticularly interested in the API\nfunctions that work with memory.\nThey will help us find the key function\nresponsible for memory allocation.\nThis function is shown in Figure 49.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n\n\n**Figure 47: DllMain of the embedded DLL with highlighted**\nwrapper over ExitProcess.\n\n**Figure 48: Wrapper over the ExitProcess API in the**\nembedded DLL.\n\n**Figure 49: Memory allocation function of the embedded**\nDLL.\n\n\n-----\n\nAPPENDIX\n\nAllocateMemory is called by many functions, but we wanted to see its use within a function\nthat resembled a decoding cycle. Using manual analysis, the VMware Threat Analysis Unit\nidentified the function in Figure 50.\n\n**Figure 50: Config decryption function of the embedded DLL.**\n\n|nct|ion|of t|he|em|bed|de|d D|LL.|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\nBy setting a breakpoint on this function, we can identify all the encrypted configs, which are\npassed in ECX (see Figure 51).\n\n**Figure 51: Pointer to the encrypted config passed to the decryption function in ECX.**\n\nOnce the execution of this function ends, it returns a pointer to the decrypted config. In this\ncase, we have the public key that is used in C2 communication, as highlighted in Figure 52.\n\n**Figure 52: A decrypted C2 public key.**\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||||\n|||||||||||||||c||||||||||e|||||||||||\n\n\n-----\n\nAPPENDIX\n\nThe encrypted data is stored in the format shown in Table 2 (this format was found in samples\nbelonging to Epochs 4 and 5).\n\nField Offset Size Description\n\nKey 0 4 Decryption key, little endian\n\nLength 4 4 Length of data, little endian\n\nData 8 Variable Encrypted data, split into DWORDs, little endian\n\n**Table 2: Encrypted data storage format**\n\nThe length of the encrypted data can be retrieved by XORing the first DWORD of the\nencrypted data blob with the second one. To decrypt the data with the retrieved data length,\nyou need to split the data into DWORDs and then XOR them with the same first DWORD.\n\nThis way, the network keys can be decrypted, which are stored in the .text section of the\nextracted DLL. The keys we extracted from the sample under analysis\n63996a39755e84ee8b5d3f47296991362a17\nafaaccf2ac43207a424a366f4cc9 belonged to Epoch 4:\n\n- ECK1 (base64 encoded):\nRUNLMSAAAADzozW1Di4r9DVWzQpMKT588RDdy7BPILP6AiDOTLYMHkSWvrQO5slbmr1O\nvZ2Pz+AQWzRMggQmAtO6rPH7nyx2\n\n- ECS1 (base64 encoded):\nRUNTMSAAAABAX3S2xNjcDD0fBno33Ln5t71eii+mofIPoXkNFOX1MeiwCh48iz97kB0mJjGGZ\nXwardnDXKxI8GCHGNl0PFj5\n\n\n-----\n\nAPPENDIX\n\nThe configuration containing the C2 IP addresses and ports is normally stored at the very\nbeginning of the .data section of the extracted DLL (see Figure 53). This configuration is\nencrypted with the same method described previously.\n\n**Figure 53: Encrypted list of IP address:port pairs is stored at the beginning of .data section of the embedded DLL.**\n\nThe decrypted configuration consists of an array of 8-byte elements, each with the format\nshown in Table 3.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n||ng ion et|the o ho|C f th d d|2 IP e e es|a xtr crib|ddr ac ed|es ted pr|ses D ev|an LL iou|d (se sly|por e F .|ts ig|is n ure|or 53||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n\n\nField Offset Size Description\n\n\nIP 0 1 First part of the IP address\n\n1 1 Second part of the IP address\n\n2 1 Third part of the IP address\n\n3 1 Fourth part of the IP address\n\nPort 4 2 Corresponding port, little endian\n\nValid 6 2 Always 1, presumably valid flag, little endian\n\n**Table 3: Element format.**\n\n\n-----\n\nAPPENDIX\n\nFigure 54 shows the decrypted IP address:port pairs.\n\n**Figure 54: The decrypted list of IP address:port pairs in binary format.**\n\nThe following is a complete list of the extracted IP address:port pairs from the sample:\n\n\n212.237.56.116:7080\n216.158.226.206:443\n173.212.193.249:8080\n50.116.54.215:443\n138.185.72.26:8080\n41.76.108.46:8080\n212.237.5.209:443\n107.182.225.142:8080\n195.154.133.20:443\n162.214.50.39:7080\n110.232.117.186:8080\n\n\n131.100.24.231:80\n209.59.138.75:7080\n103.8.26.103:8080\n51.38.71.0:443\n212.237.17.99:8080\n9.172.212.216:8080\n207.38.84.195:8080\n104.168.155.129:8080\n178.79.147.66:8080\n46.55.222.11:443\n103.8.26.102:8080\n192.254.71.210:443\n45.176.232.124:443\n\n\n203.114.109.124:443\n51.68.175.8:8080\n58.227.42.236:80\n45.142.114.231:8080\n217.182.143.207:443\n178.63.25.185:443\n45.118.115.99:8080\n103.75.201.2:443\n104.251.214.46:8080\n158.69.222.101:443\n81.0.236.90:443\n45.118.135.203:7080\n176.104.106.96:8080\n\n\nSince mid-May 2022, Emotet samples started to transition to a new method of storing the\nconfiguration data within the binary. This new approach does not store the information as a\nsingle blob of data but as a split collection of fragments, each obfuscated separately.[47] These\nnew samples now feature an accumulator function (see Figure 55) that returns a pointer to an\narray of function pointers, each returning to a single C2 IP address and port (see Figure 56).\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|1 1 w s u ) s|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|se a ).|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|Col36|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\n**Figure 55: The C2 accumulator function from the new wave (sample**\nb409ca9851fecca61e6cb0aaaa56fdaafc7242f5).\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\n**Figure 56: The obfuscated C2 function from the new wave, which returns 212.24.98.99:8080**\n(b409ca9851fecca61e6cb0aaaa56fdaafc7242f5).\n\nA straightforward approach to deal with this kind of obfuscation is to use code decompilers\n(for example, Hex-Rays). An often-underestimated advantage of decompilers is the ability to\nalso reduce code complexity as a by-product of lifting the binary code to a higher-level\nrepresentation. Figure 57 shows an example of a decompiled and de-obfuscated code\nfragment. While ideal for manual analysis, decompilers are not guaranteed to work in the\ngeneral case (de-obfuscation tends to be unreliable).\n\n|unc 56f h t n ity ho an on|tion daa o d oft as ws ua te|fro fc72 eal en- a b an l a nds|m t 42f wi un y- ex nal to|he 5). th der pro am ysi b|new thi es du pl s, d e u|w s ki tim ct e o ec nre|ave nd ate of l f a om lia|, wh of d ifti de pil ble|ich ob adv ng co ers ).|ret fus an the mp ar|urn ca tag bi ile e n|s 21 tio e nar d a ot|2.2 n is of y c nd gu|4.9 to dec od de ara|8.9 us om e t -o nt|9:8 e c pi o a bfu ee|080 od ler hi sc d to|e d s is gh ate w|ec th er- d c ork|om e a lev od in|pil bili el e th|ers ty t e|o|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\n**Figure 57: The C2 function from the new wave de-obfuscated by Hex-Rays**\n(b409ca9851fecca61e6cb0aaaa56fdaafc7242f5).\n\nRunning the code in a code emulator, such as QEMU[48] or Qiling[49] (both are free for\ncommercial use), is often a more reliable way to extract the required data. This is because\nthey can emulate both the CPU and the underlying OS environment.\n\nIn this scenario, the starting point needs to be the inner DLL extracted as shown in Figures 40,\n41 and 42. Once that is done, static analysis can be used to identify the accumulator function\nand obtain the full list of functions used to decode the C2 data. The last step is to compute the\nphysical offset within the module and feed it to the emulator as a starting instruction. Figure 58\ncontains a quick implementation we wrote to decode the C2 data from the function that was\nshown in Figure 57 (i.e., sub_7FFA1B6AEAA4). In this case, the physical offset was 0x1DEA4.\n\n**Figure 58: A small program to decode a single network indicator given a physical offset.**\n\nThe new method of storing the config was described in a report the VMware Threat Analysis\nUnit published recently.[47]\n\nThe steps of the extraction pipeline we’ve discussed are based on manual analysis. As our\nanalysis shows, even though it is possible to extract the decrypted payload and configuration\ndata statically, this process is not efficient and does not scale. Therefore, the VMware Threat\nAnalysis Unit decided to fully automate the process for both steps.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|Figure 57: The C2 function from|th|e ne|w|wav|e d|e-o|bfu|sca|ted|by|He|x-R|ays|||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\nWe did this by leveraging the NSX Sandbox,[18] which extracts and dumps the internal DLL\nartifact from the original Emotet DLL payload during execution. (It is possible to use other\ncontrolled environments, as well.) The dumped DLL can then be fed into the C2 configuration\nextractor for scanning. The extractor supports different configuration formats seen\nin various Epochs.\n\n##### Downloading updates and plug-in modules\n\nThe VMware Threat Analysis Unit developed a tool to regularly connect to the Emotet\ninfrastructure to download updates and plug-in modules. We started by determining how the\nupdates were uploaded and executed.\n\nAs detailed in the Extracting Emotet configuration section of the Appendix, by setting a\nbreakpoint on FindProcAddress, you can extract all API wrappers of the sample and name\nthem. This helped us to find out that Emotet relies heavily on functions from wininet.dll and\nbcrypt.dll to establish network communications and encrypts the traffic by performing API\ncalls in the following order:\n```\nbcrypt!BCryptCreateHash\nbcrypt!BCryptHashData\nbcrypt!BCryptFinishHash\nbcrypt!BCryptDestroyHash\nbcrypt!BCryptCloseAlgorithmProvider\nbcrypt!BCryptEncrypt\nbcrypt!BCryptEncrypt\n…\nwininet!InternetOpenW\nwininet!InternetConnectW\nwininet!HttpOpenRequestW\nwininet!InternetSetOptionW\nwininet!InternetQueryOptionW\nwininet!InternetSetOptionW\nwininet!HttpSendRequestW\nwininet!HttpQueryInfoW\nwininet!InternetReadFile\n…\nbcrypt!BCryptDecrypt\n\n```\nInvestigating the updates delivered to the infected machine requires executing the DLL\nsample in a controlled environment. The key here is to intercept BCryptDecrypt and monitor\nevery decryption a sample might attempt. To achieve this, it is necessary to run a sample with\nthe help of regsvr32.dll in a debugger with a breakpoint set on BCryptDecrypt. Because this\nfunction is also used by other DLLs to decrypt the TLS traffic, it might take some number of\niterations to get to the code of the sample that calls BCryptDecrypt to decrypt the data\nreceived from the C2 server.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|r c i p|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|or it is f|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|Col36|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|r.||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\nThe prototype of this function looks like this:\n```\nNTSTATUS BCryptDecrypt(\n [in, out]      BCRYPT_KEY_HANDLE hKey,\n [in]        PUCHAR      pbInput,\n [in]        ULONG       cbInput,\n [in, optional]   VOID       *pPaddingInfo,\n [in, out, optional] PUCHAR      pbIV,\n [in]        ULONG       cbIV,\n [out, optional]   PUCHAR      pbOutput,\n [in]        ULONG       cbOutput,\n [out]        ULONG       *pcbResult,\n [in]        ULONG       dwFlags\n);\n\n```\nThe seventh parameter, pbOutput, is a pointer to the buffer receiving the decrypted message\n(see Figure 59). By following the address stored in the pbOutput parameter and then\nexecuting BCryptDecrypt until return, we were able to get the actual answer of the C2 server,\nwhich includes the delivered PE payload (see Figure 60).\n\n**Figure 59: Sample 4c92984f9ebbfac6c40c8fd775c3a357139944c9 calls BCryptDecrypt to decrypt the data**\ncoming from the C2 server. The value of pbOutput is stored at rsp+7*8.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\n**Figure 60: The result of the execution of BCryptDecrypt on the delivered PE payload (highlighted) called by**\nsample 4c92984f9ebbfac6c40c8fd775c3a357139944c9.\n\nThe Emotet actors likely implemented some anti-analysis techniques because after a series of\nconnections to the C2 servers in the infrastructure, the back-end stopped replying with updates\n(as shown in Figure 61). We assumed this anti-analysis technique was based on both the\nconfiguration of the host and the source IP address of the connection, which we verified by\nrunning the same sample with the same VPN output node on different virtual machines (VMs).\nInitially, we found that the same C2 server immediately replied with a fresh update. However,\nafter a few changes in the VM configuration, the VPN address was denylisted by the\nbotnet’s leaders.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|bfa|c6c|40|c8fd|77|5c3|a35|713|994|4c9|, b|eing|ex|ecu|t|ed|on|a|||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\ndenylisted VM, receives only the header (highlighted) of the answer without the PE payload.\n\nEmotet forms the bot ID out of two components: the computer name returned by\nthe GetComputerNameA API and the C: volume serial number returned by the\nGetVolumeInformationW API. The ID is sent by the bot to the C2 server to identify\nitself during every communication. This ID can be denylisted by the botnet leaders.\n\nFor the purpose of automation, the VMware Threat Analysis Unit built a tool that intercepts\nGetComputerNameA and GetVolumeInformationW, and returns random values. This helps to\nbypass the denylisting mechanisms used by the botnet leaders. In addition to that, the tool\nhooks many other functions for logging purposes, including BCryptDecrypt, to intercept the\nPE files in the delivered updates (see Figure 62).\n\n**Figure 62: Dumping the core update delivered by the C2 server.**\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||e t s||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\n**Figure 63: Dumping additional updates delivered by the C2 server.**\n\nThese PE files are also DLLs but feature a custom entry point. While normal DLLs perform\ntheir initialization during the DLL_PROCESS_ATTACH call and free their resources during the\nDLL_PROCESS_DETACH call, the 32-bit DLLs distributed by the botnet (before the end of\nApril 2022) were different. They executed the initialization routine only when a custom value\n(fdwReason=16) was given as an input (see Figure 64). Furthermore, the loading routine\nrequired that custom data structures be passed via the lpReserved pointer. Failure to comply\nwith any of these requirements (e.g., loading the DLL using rundll32.exe) will either crash the\nsample or make it skip the initialization routine. The updated 64-bit DLLs (after the end of\nApril 2022) retained this specific loading mechanism but now correctly initialize only when a\ndifferent value (i.e., 100) is given as an input (see Figure 65).\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|d 3 i e|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|pl h a|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\n**Figure 64: Entry point of a 32-bit update (7d3f067f4b135a4a4d4b717bc7f7f4dd8e3a7ff8).**\n\n**Figure 65: Entry point of a 64-bit update (3c729151d9d2d326a4a3772ee18a1c0ca5db55ce).**\n\nThe VMware Threat Analysis Unit was able to partially reconstruct the data structure the core\nmodule is passing to the custom entry point, consisting of 64-bit DLL updates. The purpose of\nthe Unk fields is still to be determined:\n```\ntypedef struct {\n  PCHAR pID;       // Bot ID, e.g. \"DESKTOPXHO47NFZ_1E62B7B\" for\ncomputer name \"DESKTOP-HO47NFZ\" and C: volume serial number 0x1E62B7B\n  PBYTE pECK1;          // ECK1 key in binary form\n  ULONG64 ECK1_Size;   // Size of the ECK1 key, always 0x48\n  PBYTE pECS1;          // ECS1 key in binary form\n  ULONG64 ECS1_Size;   // Size of the ECS1 key, always 0x48\n  ULONG  Unk1;\n  ULONG  Unk2;\n  ULONG64 Unk3;\n  ULONG64 Unk4;\n} EMOTET_LOADER_DATA;\n\n```\nThe module with the core functionality (the Emotet DLL) is always pushed first by the C2\nserver, as shown in Figure 62. Once the core module is successfully updated, it downloads\nadditional plug-ins with various functionality. They are given with some delay, as shown in\nFigure 63.\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n|||||||||||||||||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\nWhen the plug-ins are downloaded, they are not saved to disk, which helps them avoid being\ndetected by file system monitors. Instead, the core module allocates memory for the plug-in,\nmaps the PE sections, resolves the API imports (if any), and completes the load of the\nexecutable in memory without involving the standard loading mechanism that might attract\nthe attention of anti-malware tools.\n\nEvery update the DLL makes contains its own C2 config but not the ECK1-ECS1 key pair. The\nencryption keys are passed to the update during the DllEntryPoint in the EMOTET_LOADER_\nDATA structure described earlier.\n\nUpdates may contain embedded executables in the .text section. Figure 66 shows that they\nare encrypted.\n\n**Figure 66: The encrypted payload embedded into an old update, before mid-May 2022**\n(879868bf68f231bf68abf1c7cc7adbf958a90e3a).\n\nThe encryption method used to obfuscate the embedded payloads in the old updates (prior to\nmid-May 2022) was the same encryption method of the C2 config described in the C2\nconfiguration extraction section.\n\nFor example, consider the first three DWORDs of the encrypted payload from\nFigure 66: 0x5F3A4D6A (encryption key), 0x5F3FE76A (encrypted payload length),\nand 0x5FAA1727 (first encrypted DWORD of the payload). 0x5F3A4D6A XOR-ed\nwith 0x5F3FE76A gives 0x5AA00, which is the PE payload size.\n\n|ad dbf ed me cti fir|em 958 to en on. st t|bed a9 ob cr hre|de 0e3 fus ypt e|d in a). cat ion DW|to a e t m O|n o he eth RD|ld u em od s o|pd be of f th|ate, dd th e e|be ed e C nc|for pa 2 c ryp|e m ylo on te|id- ad fig d p|May s i de ayl|20 n th scr oa|22 e ibe d f|old d i rom|up n t|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n|nc|ryp|tio|n k|ey|), 0|x5|F3|FE|76|A (|enc|ry|pte|d p|ay|loa|d l|en|gth|),|||||||||||||\n|yp|ted|D|W|OR|D o|f t|he|pa|ylo|ad)|. 0|x5|F3|A4|D6|A X|OR|-e|d||||||||||||||\n|5A|A0|0,|wh|ich|is|th|e P|E p|ay|loa|d s|ize|.||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||\n\n\n-----\n\nAPPENDIX\n\n0x5F3A4D6A XOR-ed with 0x5FAA1727 gives 0x905A4D, which is the beginning of a PE file\n(bytes 0x4D and 0x5A are the M and Z characters, respectively, which are the first two bytes\nof any PE file).\n\nThe encryption method used to obfuscate the embedded payloads in the new updates (after\nmid-May 2022) is the same as in the old ones, but the encryption key is much harder to\nretrieve. The payload is stored in the .data section of the update, as shown in Figure 67. The\ndecryption key is passed to the decryption routine as a parameter (see Figure 68).\n\nFor example, Figure 68 shows the fifth parameter of DecryptPayload has a value of\n0x997E6BCA. The decryption key is XORed with the first DWORD of the payload 0x99EE3187\n(highlighted in Figure 67), resulting in the value 0x905A4D, which is the beginning of a PE file,\nas described previously.\n\nIn Figure 69, we see the encryption key is obfuscated through a series of mathematical\noperations. Note that because the beginning of any PE file is always 4D 5A 90 00 or 4D 5A\n00 00, XORing the first DWORD of the obfuscated data with 0x00905A4D or 0x00005A4D\nwill reveal the encryption key and de-obfuscate the rest of the embedded file, making it\nunnecessary to emulate the code to extract the payload from the update.\n\n**Figure 67: The encrypted payload embedded into a new update, after mid-May 2022**\n(b5388c6aebbe6b125c4530e94ce7373e1aa06868).\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||||\n|||||||||||||||s k||||||||||e s e|||||||||||\n\n\n-----\n\nAPPENDIX\n\n**Figure 68: Payload decryption routines in a new update, after mid-May 2022**\n(b5388c6aebbe6b125c4530e94ce7373e1aa06868).\n\n**Figure 69: The obfuscated function that returns the embedded payload in a new update,**\nafter mid-May 2022 (b5388c6aebbe6b125c4530e94ce7373e1aa06868).\n\n|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|Col23|Col24|Col25|Col26|Col27|Col28|Col29|Col30|Col31|Col32|Col33|Col34|Col35|\n|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||tion|th|at r|etur|ns|the|em|bed|de|d p|aylo|ad|in a|ne|w u|pd|ate,||||||||||||||||||\n||bb|e6b|125|c45|30|e94|ce7|373|e1a|a06|86|8).|||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n||||||||||||||||||||||||||||||||||||\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        },
        {
            "id": "4e039bf8-7239-4999-8ec0-eb202d1465af",
            "created_at": "2022-12-04T11:19:36.52593Z",
            "updated_at": "2022-12-04T11:19:36.52593Z",
            "deleted_at": null,
            "name": "ORKL",
            "url": "https://github.com/ORKL/library",
            "description": "ORKL Community Contributed Content",
            "reports": null
        }
    ],
    "references": [
        "https://www.vmware.com/content/dam/learn/en/amer/fy23/pdf/1669005_Emotet_Exposed_A_Look_Inside_the_Cybercriminal_Supply_Chain.pdf"
    ],
    "report_names": [
        "1669005_Emotet_Exposed_A_Look_Inside_the_Cybercriminal_Supply_Chain.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e8e18067-f64b-4e54-9493-6d450b7d40df",
            "created_at": "2022-10-25T16:07:24.515213Z",
            "updated_at": "2025-03-27T02:02:10.267637Z",
            "deleted_at": null,
            "main_name": "Mummy Spider",
            "aliases": [
                "ATK 104",
                "Gold Crestwood",
                "Mummy Spider",
                "TA542"
            ],
            "source_name": "ETDA:Mummy Spider",
            "tools": [
                "Emotet",
                "Geodo",
                "Heodo"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "506404b2-82fb-4b7e-b40d-57c2e9b59f40",
            "created_at": "2023-01-06T13:46:38.870883Z",
            "updated_at": "2025-03-27T02:00:02.939775Z",
            "deleted_at": null,
            "main_name": "MUMMY SPIDER",
            "aliases": [
                "TA542",
                "GOLD CRESTWOOD"
            ],
            "source_name": "MISPGALAXY:MUMMY SPIDER",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2f07a03f-eb1f-47c8-a8e9-a1a00f2ec253",
            "created_at": "2022-10-25T16:07:24.277669Z",
            "updated_at": "2025-03-27T02:02:10.157972Z",
            "deleted_at": null,
            "main_name": "TA428",
            "aliases": [
                "Operation LagTime IT",
                "Operation StealthyTrident",
                "ThunderCats"
            ],
            "source_name": "ETDA:TA428",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Agent.dhwf",
                "Albaniiutas",
                "BlueTraveller",
                "Chymine",
                "Cotx RAT",
                "CoughingDown",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Gen:Trojan.Heur.PT",
                "Kaba",
                "Korplug",
                "LuckyBack",
                "PhantomNet",
                "PlugX",
                "Poison Ivy",
                "RedDelta",
                "RoyalRoad",
                "SManager",
                "SPIVY",
                "Sogu",
                "TIGERPLUG",
                "TManger",
                "TVT",
                "Thoper",
                "Xamtrav",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "2ac83159-1d9d-4db4-a176-97be6b7b07c9",
            "created_at": "2024-06-19T02:03:08.024653Z",
            "updated_at": "2025-03-27T02:05:17.348806Z",
            "deleted_at": null,
            "main_name": "GOLD CRESTWOOD",
            "aliases": [
                "TA542 ",
                "Mummy Spider "
            ],
            "source_name": "Secureworks:GOLD CRESTWOOD",
            "tools": [
                "Emotet"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1666716493,
    "ts_updated_at": 1743041644,
    "ts_creation_date": 1664818287,
    "ts_modification_date": 1664818310,
    "files": {
        "pdf": "https://archive.orkl.eu/af91b2a5704db61cc3b02fd1850b9d0f5eb605c9.pdf",
        "text": "https://archive.orkl.eu/af91b2a5704db61cc3b02fd1850b9d0f5eb605c9.txt",
        "img": "https://archive.orkl.eu/af91b2a5704db61cc3b02fd1850b9d0f5eb605c9.jpg"
    }
}