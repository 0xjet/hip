{
    "id": "d0c598b1-aa11-4b9b-8021-657fd4e9ce15",
    "created_at": "2023-01-12T15:01:55.367502Z",
    "updated_at": "2025-03-27T02:06:11.091612Z",
    "deleted_at": null,
    "sha1_hash": "bac45564cdcbdd0b9d94fdd4e7b8e98089cce31c",
    "title": "2016-02-09 - DMA Locker Strikes Back",
    "authors": "",
    "file_creation_date": "2022-05-28T02:30:20Z",
    "file_modification_date": "2022-05-28T02:30:20Z",
    "file_size": 613567,
    "plain_text": "# DMA Locker Strikes Back\n\n**[blog.malwarebytes.com/threat-analysis/2016/02/dma-locker-strikes-back/](https://blog.malwarebytes.com/threat-analysis/2016/02/dma-locker-strikes-back/)**\n\nhasherezade February 9, 2016\n\nA few days ago we published a post about a new ransomware – DMA Locker (read more\n**[here). At that time, it was using a pretty simple way of storing keys. Having the original](https://blog.malwarebytes.org/intelligence/2016/02/draft-dma-locker-a-new-ransomware-but-no-reason-to-panic/)**\nsample was enough to recover files. Unfortunately, the latest version (discovered February 8)\ncomes with several improvements and RSA key. Let’s take a look at the changes.\n\n_DMA Locker in recent campaigns have been found installed by the attackers via Remote_\n_[Desktop (similar distribution method was used by LeChiffre ransomware).](https://blog.malwarebytes.org/threat-analysis/2016/01/lechiffre-a-manually-run-ransomware/)_\n\n**[[UPDATE] READ ABOUT THE LATEST VERSION OF DMA LOCKER: 4.0](https://blog.malwarebytes.org/threat-analysis/2016/05/dma-locker-4-0-known-ransomware-preparing-for-a-massive-distribution/)**\n\n**UPDATE: version 3.0 (discovered 22-th Feb) fixed the bug in the cryptography**\n**implementation. Due to this fact, encrypted files cannot be recovered by external tools**\n**(although it was possible in case of the earlier version, described in this article). Sorry,**\n**but our decryptor can no longer help!**\n\n**_PREVENTION TIP: Create these files to protect yourself from this version of DMA Locker._**\n_Content doesn’t matter. In presence of these files, the program will go by other path of_\n_execution and display the red message only – but not deploy the encryption._\n\n_C:\\Documents and Settings\\All Users\\decrypting.txt_\n\n\n-----\n\n_C:\\Documents and Settings\\All Users\\start.txt_\n_C:\\ProgramData\\decrypting.txt_\n_C:\\ProgramData\\start.txt_\n\n_This trick works only as a PREVENTION – once your files are encrypted, it is not going_\n_to help. For more info about why it happens, please read this post._\n\n## Analyzed sample\n\n[28b44669d6e7bc7ede7f5586a938b1cb](https://www.virustotal.com/en/file/b7eeb0746b8e5df88c9937463db3f12a07ed3cf62ff720c6c91b8610080f2d9c/analysis/)\n\n## Behavioral analysis\n\nAgain we are alerted by a red window – almost identical like before, only the locker image is\nadded:\n\nThis time the key necessary to decrypt files must be supplied not as a text, but as RSA key\nfile. Author added also key validation.\n\n\n-----\n\nSimilarly, it drops files in C:\\ProgramData\\ (or C:\\Documents and Settings\\All Users\\).\nNow, the dropped copy is named svchosd.exe.\n\nAnd created registry keys to autorun the file and to autodisplay ransom note via notepad at\nsystem startup.\n\nEncrypted files again have unchanged extensions – they can be only recognized by 8 byte\nlong prefix at the beginning of the content. In the previous edition it was “ABCXYZ11“, in\ncurrent it is “!DMALOCK“:\n\n## Experiment\n\nLet’s compare how the encrypted files look\n\nFrom the left we can see visualizations of raw bytes of following files: original, encrypted by\nprevious DMA Locker, encrypted by current DMA Locker\n\n\n-----\n\nPrevious DMA Locker(middle picture) was encrypting files by AES-256 ECB mode, applied\non 16 byte long chunks of input. Now (last picture), also repetitive patterns exist – so\nprobably AES-256 ECB mode was used again.\n\nHowever, pay attention to the strips in the BMP – in a new file they are shifted a bit more. It\nwould suggest that the header is longer than previously. Let’s visualize the same files with a\ndifferent width, to make sure that this impression is right. The header of the file is visualized\nas a line at the top left corner – it ends where the vertical line starts.\n\nNow it is visible clearly – the header is really longer. Why? To answer this question, code\nanalysis is required – but it can signify, that some additional data have been stored there (it\ncan be for example the AES key encrypted by RSA)\n\n\n-----\n\n## Inside\n\n### When does the encryption start?\n\nAt the beginning of execution, (as in the previous version) the malware terminates\napplications used for backups. Also, adds registry keys for its persistence.\n\nThen, execution of the main function may follow 3 alternative paths.\n\nif system is already infected -> do not deploy encryption, only display the red window\nwith ransom note\nsystem is not yet infected, malware is not yet installed (current file name is different\nthan the expected one – svchosd.exe) -> install the malware in ProgramData and\nthen deploy again the dropped file\nsystem is not yet infected, but malware is installed -> deploy encryption, after\nfinishing display the red window with ransom note\n\nThe recognition, in which state is the system, is performed basing on the presence of some\npredefined files. Presence of file decrypting.txt informs that system is already infected. File\n**start.txt informs that encrypting started (and no need to start it again):**\n\nKnowing this fact, we can easily drop those files by our own and fake that our system is\ninfected. It will prevent this version of DMA Locker from attacking our system (it will display\nthe ransom note but not touch our files).\n\n### How does the encryption work?\n\n\n-----\n\nThis time the author decided to practice what he preached and really used RSA key\n(previous version supplied to the encrypting function just a text key, read from the end of the\noriginal sample).\n\nIn contrast to the previous edition, where one AES key was used for all the files, here a new\nrandom key is generated per every file.\n\nAs you can see – in example below the randomly generated key was\n**MRNW9KSC5JRCeT4uJVmI2AOS7JUjPQc6**\n\nThen, the key is used in the same way like the previous one – to encrypt 16 byte long chunk\nwith AES ECB mode.\n\nBelow – buffer before encryption (fragment of the input is selected on the hex dump – it is a\nheader of a PNG file):\n\n\n-----\n\nThe same chunk encrypted (result in bytes -> “55 0F 94 4C B0 98 81 DB F4 57 8A 98 92 2C\n09 14”)\n\nAfter use, the random AES key is RSA encrypted:\n\n\n-----\n\nand then, appended to the beginning of the AES encrypted file (just after the “!DMALOCK”\nsignature):\n\nWe can see that now the AES encrypted content starts with offset 0x88 (compare the\nselected part with the above example showing AES encryption result):\n\n\n-----\n\n### What is attacked?\n\nAs previous, attacked are logical disks as well as network shares.\n\n[This sample introduced also check against Floppy and CD using QueryDosDeviceA (floppy](https://msdn.microsoft.com/en-us/library/windows/desktop/aa365461%28v=vs.85%29.aspx)\nand CD are skipped):\n\nLike in the previous version, skipped are some predefined folders:\n\n\n-----\n\n…and file extensions:\n\n## Conclusion\n\nThe author of this malware, despite appearing inexperienced in programming, seems to be\nvery determined to gradually improve the quality of the product. The disparity between the\n[quality of the first edition, second (described in the previous article) and the third (current) is](https://blog.malwarebytes.org/intelligence/2016/02/draft-dma-locker-a-new-ransomware-but-no-reason-to-panic/)\nsignificant. We will keep eye on the evolution of this malware family and provide you with\nupdates and possible tips on dealing with this threat.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-02-09 - DMA Locker Strikes Back.pdf"
    ],
    "report_names": [
        "2016-02-09 - DMA Locker Strikes Back.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535715,
    "ts_updated_at": 1743041171,
    "ts_creation_date": 1653705020,
    "ts_modification_date": 1653705020,
    "files": {
        "pdf": "https://archive.orkl.eu/bac45564cdcbdd0b9d94fdd4e7b8e98089cce31c.pdf",
        "text": "https://archive.orkl.eu/bac45564cdcbdd0b9d94fdd4e7b8e98089cce31c.txt",
        "img": "https://archive.orkl.eu/bac45564cdcbdd0b9d94fdd4e7b8e98089cce31c.jpg"
    }
}