{
    "id": "0fa307c9-9f1e-4b9a-9f96-aa50918c2c28",
    "created_at": "2022-10-25T16:48:18.615781Z",
    "updated_at": "2025-03-27T02:05:50.333406Z",
    "deleted_at": null,
    "sha1_hash": "bc9559486d50da1b8b146b9e79eac54a3f687ad9",
    "title": "",
    "authors": "",
    "file_creation_date": "2019-03-28T11:17:34Z",
    "file_modification_date": "2019-03-28T11:17:34Z",
    "file_size": 678491,
    "plain_text": "# Threat Actor Group using UAC Bypass Module to run BAT File\n\n**[threatrecon.nshc.net/2019/03/28/threat-actor-group-using-uac-bypass-module-to-run-bat-file](https://threatrecon.nshc.net/2019/03/28/threat-actor-group-using-uac-bypass-module-to-run-bat-file/)**\n\nby Aesol Kim March 28, 2019\n\n## Overview\n\nOur Threat Recon team continues to collect and analyze activity-related data from multiple APT groups. We\nanalyzed malware used in hacking activities targeting organizations located in South Korea, the US, and\nEast Asia earlier this year. They use a CAB file that compresses the malware, separate configuration files\nand a specific User Access Control (UAC) bypass module. This article briefly describes the infection\nmethod of the malware that they were using at the time and the UAC bypass module used.\n\n## Infection Method\n\nThe attackers used quite a few steps to generate their malware, and the initial infection comes from\nmalicious documents attached to spear phishing emails. When a user executes a file attached to the email,\na batch file for downloading a base64-encoded CAB file from a remote site is downloaded through a script\nincluded in the document.\n\n_Infection method using CAB file_\n\nThe following is the sequence of the infection method that they use.\n\n1. Download base64 encoded data 1.txt via script embedded in malicious documents\n2. Decode “1.txt” to create “1.bat” and run “1.bat”\n3. “1.bat” downloads 2.txt (32-bit) or 3.txt (64-bit) according to the Windows platform environment (32bit\n\n/ 64bit)\n4. Decode “2.txt” or “3.txt” to create “setup.cab”\n\nEach file looks like an SSL certificate using the string “—– BEGIN CERTIFICATE —–“, but this is actually a\nbase64 encoded cab and bat file.\n\n\n-----\n\n_Left: The 1.bat file used to decompress the CAB file and run the main payload_\n\n_Right: The 2.txt CAB file for 32-bit Windows systems_\n\nThe CAB file is created according to the Windows platform environment through the following files:\n\n1. BAT file for main payload file execution\n2. INI file containing attacker server address\n3. DLL file for UAC bypass\n4. Main EXE payload\n\n### Why does UAC Run?\n\nThis malware’s first batch file (1.bat) executes a second batch file which installs the main payload. A UAC\npop-up will normally be shown to the user and this is caused by the code in the BAT file that installs the\nmain payload. It copies the INI configuration file and the main payload EXE into the System32 folder.\n\nIn general, when files are copied to the System32 folder, a UAC pop-up will run for security reasons. This\nfolder should not be modified in normal situations because it contains important files used to operate the\nsystem.\n\nWhy UAC runs\n\n### BAT File Details\n\n\n-----\n\nThe first batch file\n\n(1.bat) downloads the file from a remote server and uses the “net\n\nsession> nul” command to verify the current user rights and perform the\n\nfollowing actions:\n\nIf admin : Delete UAC bypass DLL, execute main payload and BAT file\nIf not admin : Execute the following command using rundll32.exe\n\nCommand : “[UAC Bypass Module], EntryPoint [Main Payload execution BAT file]”.\n\nBatch Code\n\nThe batch file used to install the main payload copies the main payload executable and INI configuration\nfiles into the System32 folder, and then runs the main payload which was moved to the System32 folder.\n\n_BAT file running Main Payload Code_\n\n## About UAC\n\nUser Account Control (UAC) is a Windows operating system security control function based on the concept\nof access tokens. It displays a screen informing the user when a program requires administrator level\nprivileges, acting as a warning prompt for user consent of unknown privileged activity.\n\n\n-----\n\n_UAC popped up on screen_\n\n### How it works\n\nWhen a user logs into Windows, each user is given an access token. This access token has information on\nthe security identifier (SID), the Windows operating system privilege, and the access level granted to the\nuser, and the Windows system uses the access token to verify the user’s privilege. The access tokens\ngenerated at login are:\n\nstandard user : Generates a standard user access token\nadministrator : Generate standard user access token, administrator access token\n\nThe system allocates the following integrity levels according to the token privileges of the logged-in user.\nSystem performs access control by comparing the access rights of the security descriptor of the object with\nthe user’s SID.\n\nProcesses that run at Medium Level\n\nIssued tokens are used for events such as\nprocess creation. The important thing here is that\nwhen a process is created after issuing a token, the administrator also executes the new process using the\nstandard user access token.\n\nGenerally, explorer.exe which is the parent process of most user processes operates at medium integrity\nlevel, so most processes run at the same level to explorer.exe. But when a process requires a high integrity\nlevel, processes can obtain an elevated privilege if the user approves it.\n\nThis basically means that a process typically uses a standard user access token and uses the UAC to get\nthe user’s authorization if an administrator access token is needed.\n\nThe following such actions are examples of events which trigger UAC:\n\nRunning an Application as an Administrator\n\nChanges to system-wide settings\n\nChanges to files in folders that standard users don’t have permissions for (such as %SystemRoot% or %ProgramFiles%\nin most cases)\n\nChanges to an access control list (ACL), commonly referred to as file or folder permissions\n\nInstalling device drivers\n\nInstalling ActiveX controls\n\nChanging settings for Windows Firewall\n\nChanging UAC settings\n\nConfiguring Windows Update\n\nAdding or removing user accounts\n\nChanging a user’s account type\n\nTurning on Guest account (Windows 7 and 8.1)\n\nTurning on file sharing or media streaming\n\nConfiguring Parental Controls\n\n\n-----\n\n## UAC Bypass Module\n\nHowever, the attackers in this case use a particular DLL module for bypassing UAC. It seems to have been\ncreated by referring to the source code of a file named UAC-TokenMagic.ps1 which is open source on\n[GitHub.](https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/UAC-TokenMagic.ps1)\n\nFirst, it creates a wusa.exe process (an auto-elevatable process) that runs at a High Integrity Level. This\nprocess is the Windows Update Standalone installer, and it has an auto-elevate attribute so it does not pop\nup UAC if the system UAC popup setting is “Notify me only when programs / apps try to make changes to\nmy computer”.\n\nAfter creating wusa.exe, it copies that token and run the cmd.exe process via CreateProcessWithLogonW\nusing the copied token. Finally, cmd.exe runs at a High Integrity Level and executes “/c EntryPoint”\n%Temp%\\[bat file install main payload]” and this batch file inherits the elevated privilege of cmd.exe.\n\n_Part of the UAC Bypass module code_\n\nIf the attacker is using the UAC bypass module, the batch file that runs the main payload will work through\nthe cmd.exe generated by copying the access token from wusa.exe. In conclusion, the UAC will not pop up\neven if the code that moves the file into the System32 folder in batch file is executed.\n\n## Summary\n\n\n-----\n\nThe attackers compress the UAC Bypass Module with other components and distributes them in a CAB file\nformat. We have seen this threat actor group mainly use decoy documents written in Russian, English and\nKorean and used the BABYFACE, SYSCON malware variants as the main payload. Such activity may be\nrelated in part to the activities of the previously known threat actor groups. Our Threat Recon team will\ncontinue to monitor these Cyber Threat.\n\n## Indicators of Compromise\n\n### Hashes(SHA-256)\n\n2b94c694a6279eaa08ce4a17fb848c8431c14beb9f811f1b2732b778c1703fbf\n\n1df5cd85693dc2ce2ba5f7f251785b00b542d93f8e067539cadb550aa673759d\n\nafdf1960a5c372b815475807ff1ad1d16874d2802ce4ee71da484d61220f7a65\n\n4b825d310a305728b7a57d9eb6731db87e8da9cef4bc7917fca7f4503bcb3272\n\ndd9bb177732197539bdb9167fb3dd784df10d6746a9b77255d62dfaccb092640\n\n036567c36aaaabefcd222456b536bffee1ce4ccf279593048d62c9ef42b57472\n\n4b825d310a305728b7a57d9eb6731db87e8da9cef4bc7917fca7f4503bcb3272\n\n5c9773c3b4cf58839a476d469c6a705d66df95a2a8cc6ad72a3d914beff2eff5\n\n### IP Addresses\n\n103[.]249[.]31[.]159\n\n88[.]99[.]13[.]69\n\n154[.]16[.]201[.]104\n\n## References\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2019/2019.03.28.UAC_Bypass_BAT_APT/Threat%20Actor%20Group%20using%20UAC%20Bypass%20Module%20to%20run%20BAT%20File.pdf"
    ],
    "report_names": [
        "Threat Actor Group using UAC Bypass Module to run BAT File"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716498,
    "ts_updated_at": 1743041150,
    "ts_creation_date": 1553771854,
    "ts_modification_date": 1553771854,
    "files": {
        "pdf": "https://archive.orkl.eu/bc9559486d50da1b8b146b9e79eac54a3f687ad9.pdf",
        "text": "https://archive.orkl.eu/bc9559486d50da1b8b146b9e79eac54a3f687ad9.txt",
        "img": "https://archive.orkl.eu/bc9559486d50da1b8b146b9e79eac54a3f687ad9.jpg"
    }
}