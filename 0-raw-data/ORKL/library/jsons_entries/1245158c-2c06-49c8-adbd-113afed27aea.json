{
    "id": "1245158c-2c06-49c8-adbd-113afed27aea",
    "created_at": "2022-10-25T16:48:14.620805Z",
    "updated_at": "2025-03-27T02:09:55.044099Z",
    "deleted_at": null,
    "sha1_hash": "1e4c8aef818d7d0e950974b6c9d2a792969e3a94",
    "title": "Unveiling Careto - The Masked Apt",
    "authors": "Kaspersky",
    "file_creation_date": "2014-02-10T17:08:52Z",
    "file_modification_date": "2014-02-10T17:08:52Z",
    "file_size": 1914067,
    "plain_text": "#  Unveiling “Careto” - The Masked APT\n\n#### Version 1.0    February 2014\n\n\n#### TLP: GREEN 1\n\n\n-----\n\n-----\n\n### Table of contents\n\n#### 1. Executive Summary .................................................................................................................... 4 2. Analysis ........................................................................................................................................... 5\n 2.1. Campaign: The Mask attacks .......................................................................................... 5 2.2. Backdoor components ...................................................................................................... 8\n 2.2.1. Overview ........................................................................................................................ 9 2.2.2. The Careto backdoor .............................................................................................. 10 2.2.3. The SGH backdoor ................................................................................................... 18 2.2.4. The SBD backdoor ................................................................................................... 22 2.2.5. The OSX SBD backdoor .......................................................................................... 23 2.3. Digital certificates ............................................................................................................ 25 2.4. Exploit for Kaspersy´s products ................................................................................. 26 2.5. Communication ................................................................................................................ 27 2.6. C&C Servers ........................................................................................................................ 29 2.7. Exploits ................................................................................................................................ 34 2.8. Victims.................................................................................................................................. 43 3. Attribution .................................................................................................................................. 46 4. Conclusions ................................................................................................................................. 47 Special thanks ................................................................................................................................. 47 APPENDIX 1: Indicators of compromise .............................................................................. 48 APPENDIX 2: SGH Modules – detailed analysis ................................................................. 51 APPENDIX 3: C&C registration information ....................................................................... 64\n Contact information\n For any inquires please contact intelreports@kaspersky.com\n\n\n#### TLP: GREEN 3\n\n\n-----\n\n### 1. Executive Summary\n\nThe Mask is an advanced threat actor that has been involved in cyber-espionage\noperations since at least 2007. The name \"Mask\" comes from the Spanish slang\nword \"Careto\" (\"Ugly Face\" or “Mask”) which the authors included in some of the\nmalware modules.\n\n**Figure 1. Careto strings**\n\nThe main targets of Careto fall into several categories:\n\n   - Government institutions\n\n   - Diplomatic / embassies\n\n   - Energy, oil and gas\n\n   - Private companies\n\n   - Research institutions\n\n   - Private equity firms\n\n   - Activists\n\nMore than 380 unique victims in 31 countries have been observed to date.\n\nWhat makes “The Mask” special is the complexity of the toolset used by the\nattackers. This includes an extremely sophisticated malware, a rootkit, a bootkit, 32and 64-bit Windows versions, Mac OS X and Linux versions and possibly versions\nfor Android and iPad/iPhone (Apple iOS).\n\nThe Mask also uses a customized attack against older versions of Kaspersky Lab\nproducts to hide in the system, putting them above Duqu in terms of sophistication\nand making it one of the most advanced threats at the moment. This and several\nother factors make us believe this could be a nation-state sponsored campaign.\n\nWhen active in a victim system, The Mask can intercept network traffic, keystrokes,\nSkype conversations, PGP keys, analyse WiFi traffic, fetch all information from Nokia\ndevices, screen captures and monitor all file operations.\n\nThe malware collects a large list of documents from the infected system, including\nencryption keys, VPN configurations, SSH keys and RDP files. There are also\nseveral extensions being monitored that we have not been able to identify and could\nbe related to custom military/government-level encryption tools.\n\nBased on artifacts found in the code, the authors of the Mask appear to be speaking\nthe Spanish language.\n\n\n-----\n\n### 2. Analysis\n\nWe initially became aware of Careto when we observed attempts to exploit a\nvulnerability in our products to make the malware “invisible” in the system.\n\nAlthough we fixed this vulnerability sometime ago, the attackers were probably still\nusing it because users may not have updated to the newest products (product\nupdates are free during the subscription period).\n\nOf course, this raised our interest and we decided to investigate further. In other\nwords, the attackers attracted our attention by attempting to exploit Kaspersky Lab\nproducts.\n\n#### 2.1. Campaign: The Mask attacks\n\nThe Mask campaign we discovered relies on spear-phishing e-mails with links to a\nmalicious website. The malicious website contains a number of exploits designed to\ninfect the visitor. Upon successful infection, the malicious website redirects the user\nto a benign website, which can be a Youtube movie or a news portal.\n\nDuring our research, we observed the following exploit websites:\n\n  - **linkconf.net**\n\n  - **redirserver.net**\n\n  - **swupdt.com**\n\nIt's important to note that the exploit websites do not automatically infect visitors;\ninstead, the attackers host the exploits at specific folders on the website, which are\nnot directly referenced anywhere, except in malicious e-mails. Sometimes, the\nattackers use subdomains on the exploit websites, to make them appear more\ngenuine.\n\nFor instance, the following subdomains the for exploit site \"linkconf.net\" have been\nobserved:\n\n  - **negocios.iprofesional.linkconf.net/**\n\n  - **www.internacional.elpais.linkconf.net/**\n\n  - **politica.elpais.linkconf.net/**\n\n  - **cultura.elpais.linkconf.net/**\n\n  - **economia.elpais.linkconf.net/**\n\n  - **test.linkconf.net/**\n\n  - **soc.linkconf.net/**\n\n  - **sociedad.elpais.linkconf.net/**\n\n  - **world.time.linkconf.net/**\n\n  - **internacional.elpais.linkconf.net/**\n\n  - **elpais.linkconf.net/**\n\n  - **www.elespectador.linkconf.net/**\n\n  - **blogs.independent.linkconf.net/**\n\n  - **www.elmundo.linkconf.net/**\n\n  - **www.guardian.linkconf.net/**\n\n  - **www.washingtonsblog.linkconf.net/**\n\n  - **www.publico.linkconf.net/**\n\n\n#### TLP: GREEN 5\n\n\n-----\n\nMost of these subdomains simulate subsections of the main newspapers in Spain\nplus some international ones like The Guardian\" and Washington Post.\n\nTo minimize the chances of detection, the malware is digitally signed with a valid\ncertificate (since 2010) from an unknown or fake company, called TecSystem Ltd:\n\n**Figure 2: Digital signature**\n\nWe can estimate the duration of the campaign analyzing the compilation time of the\nsamples. In some of them, the older ones, we are not so sure this data is very\nreliable:\n\n\n-----\n\n**Figure 3: Compilation time of samples**\n\n\n#### TLP: GREEN 7\n\n\n-----\n\n#### 2.2. Backdoor components\n\n“The Mask” leverages three separate backdoors. One of them is an extremely\nsophisticated malware, while there are also a rootkit, bootkit, 32 and 64 bits Windows\nversions and Mac OS X versions.\n\nWe have detected traces of Linux versions, and possibly versions for iPad/iPhone\nand Android, however we have not been able to retrieve the samples.\n\nTraces of components for MacOS and iPad versions found in one of the C&C\nservers:\n\n<h1>REPORT</h1>\n<b>Trace ID:</b> 13xxx_0_mcga<br />\n<b>Date: </b>Wed, 15 May 2013 23:34:01 +0000<br />\n<b>Remote IP Address:</b> 200.x.x.x<br /><br /><h2>\n** User Agent</h2><strong>Browser User Agent String:</strong> Mozilla/5.0 (iPad; CPU\nOS 6_1_3 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko)\nMobile/10B329<br/><br/>\n<strong>Browser Name:</strong> iPad<br/>\n\n<strong>Platform:</strong> MacOS<br/>\n<strong>Platform Version:</strong>10.7.5<br/>\n<strong>Architecture:</strong> 32<br/><br />\n<h2>** Environment Variables</h2>\n<h3>*** Environment Variables</h3><code>\n<b>REMOTE_ADDR:</b> 88.x.x.x<br />\n<b>HTTP_USER_AGENT:</b> Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_5)\nAppleWebKit/536.26.17 (KHTML, like Gecko) Version/6.0.2 Safari/536.26.17<br />\n\nThe Mask’s implants can intercept network traffic, keystrokes, Skype conversations,\nanalyse WiFi traffic, PGP keys, fetch all information from Nokia devices, screen\ncaptures and monitor all file operations.\n\nThe malware collects a large list of documents from the infected system, including\nencryption keys, VPN configurations, SSH keys and RDP files. There are also\nseveral unknown extensions being monitored that we have not been able to identify\nand could be related to custom military/government-level encryption tools.\n\nFull list of stolen files extensions:\n\n*.AKF,*.ASC,*.AXX,*.CFD,*.CFE,*.CRT,*.DOC,*.DOCX,*.EML,*.ENC,*.GMG,\n*.GPG,*.HSE,*.KEY,*.M15,*.M2F,*.M2O,*.M2R,*.MLS,*.OCFS,*.OCU,*.ODS,\n*.ODT,*.OVPN,*.P7C,*.P7M,*.P7Z,*.PAB,*.PDF,*.PGP,*.PKR,*.PPK,*.PSW,*.\nPXL,*.RDP,*.RTF,*.SDC,*.SDW,*.SKR,*.SSH,*.SXC,*.SXW,*.VSD,*.WAB,*.\nWPD,*.WPS,*.WRD,*.XLS,*.XLSX,\n\nInside the main Careto binaries there is a CAB file with two modules - 32 and 64-bit.\n\nshlink32.dll\nshlink64.dll\n\n\n#### TLP: GREEN 8\n\n\n-----\n\nThe malware extracts one of them depending on the system architecture and installs\nit as \"objframe.dll\".\n\nInside the backdoor there are three executable files, once again, packed with CAB\nand having the .jpg extension:\n\ndinner.jpg\nwaiter.jpg\nchef.jpg.\n\nThe attackers call the more sophisticated malware SGH. We discovered the\nattackers trying to install multiple plugins for it.\n\nAlso we have found traces of lateral movement tools, such as a module for\nMetasploit with the “win7elevate” artifact.\n\n#### 2.2.1. Overview\n\nThe attackers use two software packages and several related utilities. The main\nsoftware packages are named “Careto” and “SGH”.\n\nThe backdoor package called “Careto” is a general purpose backdoor that consists of\nuser-level components. It collects system information and executes arbitrary code\nprovided by the C&C infrastructure.\n\nThe backdoor package called “SGH” is more advanced and primarily works in kernel\nmode. It contains rootkit components and interceptor modules for system events and\nfile operations. It steals files and maintains its own connection to C&C servers.\n\nIn addition to “Careto” and “SGH”, we observed the usage of a custom compiled\nbackdoor based on the “sbd” open source “netcat” clone\n[(https://www.freshports.org/net/sbd/). This “sbd” clone has been observed in variants](https://www.freshports.org/net/sbd/)\nfor Win32, Mac OS X and Linux. During the investigation, we were able to obtain the\nWin32 and Mac OS X versions; the Linux variant was badly damaged and could not\nbe recovered.\n\nWhile Careto and SGH can also work as a “standalone” implant, we observed the\nC&C installing one package using the other one - for instance, a victim infected with\nCareto would get the SGH as well. Additionally, several utilities like the uninstaller\nmodule “knows” about both of them, meaning they are commonly used together,\nalthough they may have been designed separately.\n\nFiles from the backdoor packages used by the “Mask” are signed using the same\ncertificate, belonging to a (fake?) Bulgarian company named “TecSystem Ltd.”.\n\n\n#### TLP: GREEN 9\n\n\n-----\n\n#### 2.2.2. The Careto backdoor\n\nCareto is the name given by the attackers to one of the two main implants used on\nvictims’ machines. Careto is a Spanish slang term, meaning “ugly face” or “mask”.\n\n**Installation module - Microsoft Windows version**\n\nThe “Careto” software package is installed using a standalone executable installer.\nOnce the installer is delivered and executed on the victim machine, it extracts the\ncomponents and sets them up.\n```\nFile type: PE32, Windows Executable file\nCompilation timestamp: 2007.08.14 01:45:14 (GMT) - (all known variants)\nFile sizes: 320.328, 320.904 bytes.\n\n```\nTechnical details\n\nThe files are compiled with Visual Studio 2005.\n\nThere are several known versions of the installer module that contain a correct but\nexpired digital signature:\n```\nName of signer: TecSystem Ltd., Sofia, BG\nSerial: 36BE4AD457F062FA77D87595B8CCC8CF\nValid: 2011.06.28 – 2013.06.28\n\n```\nDigital signature\n\nAll the important strings and the payload are encrypted. When started, the module\nchecks for the presence of “BaseNamedObject” EVENT with “*” in the data. If found,\nit exits.\n\nThe module contains three encrypted blocks in its body. The biggest one (first block)\nis 205.638 bytes long and is an encrypted CAB file that contains the actual payload\nto be installed. The second one is a 96-byte long configuration block that controls the\nfilename to be used during the installation and the file description. In our case, the\nname was “objframe.dll”.\n\nTo decrypt the payload’s and installer’s configuration, the attackers use a fixed RC4\nkey: \"!$7be&.Kaw-12[}\".\n\nThe third block is 880 bytes long and contains the configuration of the payload itself.\nIt is written in the body of the installed binary and decrypted by that binary during\noperation.\n\nTo write this configuration block, the module searches for a magic binary string and\ncopies an encrypted configuration block by the marker. The resulting file is then\ninstalled into the system. The magic markers are expected to be located 0x10 bytes\nbefore the configuration block and 0x10 bytes after that block.\n\n\n#### TLP: GREEN 10\n\n\n-----\n\nThe CAB archive that holds the payloads contains two files:\n\n**Name** **File Size** **Compilation Time**\nShlink64.dll 144384 bytes 14.07.2009 01:16:44\nShlink64.dll 106496 bytes 14.07.2009 01:16:44\n\nThe installer is 64-bit aware and extracts the file for the appropriate system\narchitecture: “shlink32.dll” for a 32-bit system and “Shlink64.dll” for 64-bit one,\nrespectively.\n\nInstallation is also Microsoft Windows version-aware. For Windows Vista and higher\nwithout administrator privileges, it installs into %APPDATA%. For previous Windows\nversions with administrator privileges, it installs in the %system% directory.\n\nThe installer also verifies the system configuration and makes sure it works well\nunder all situations. For instance, it checks if the value of the registry key\n\n_\"HKLM\\Software\\Microsoft\\Windows\\Current Version\\Policies\\System\"_\n\nis set to \"EnableLUA\" to determine if UAC enabled. If UAC is enabled, it defaults to\nuser installation to evade any notification to the user.\n\nIn the case that it failed to install to system directory, the module also falls back to\nuserland installation. The userland installation path is: “%APPDATA%\\Microsoft”.\n\nIn order to make the infection less obvious, it assigns itself the same file timestamp\nas of “kernel32.dll” during installation. Also it modifies the resources of the EXE being\ninstalled, so all its Version Information strings are taken from Kernel32 DLL except\nthe filename and file description. These are taken from the encrypted configuration\nblock, i.e.:\n\nFile name: \"objframe.dll\".\nFile description\" \"Microsoft® Object frame manager\"\n\nThe payload is also registered as a COM object via registry entry:\n\n_[HKCU\\Software\\Classes\\\\CLSID\\{ECD4FC4D-521C-11D0-B792-_\n_00A0C90312E1}\\InprocServer32 ]_\n\n_%default%=%path to the installed payload file%_\n\nThe original registry value is saved in the following registry key:\n\n_[HKLM\\Software\\Classes\\CLSID\\{E6BB64BE-0618-4353-9193-_\n_0AFE606D6F0C}\\InprocServer32]_\n\n_%default%=%original registry value%_\n\n|Name|File Size|Compilation Time|\n|---|---|---|\n|Shlink64.dll 144384 bytes 14.07.2009 01:16:44 Shlink64.dll 106496 bytes 14.07.2009 01:16:44|||\n\n\n#### TLP: GREEN 11\n\n\n-----\n\n**Main module**\n\nWe were able to locate several versions of the main module. As with the Installation\nModule, the files are compiled with Visual Studio 2005.\n```\nFile type: PE32/PE32+ DLL\nCompilation timestamps: \n    2004.08.04 07:54:15 (GMT),\n    2008.04.14 02:33:02 (GMT), \n    2009.07.14 01:09:01 (GMT),\n    2012.04.25 21:05:48 (GMT), \n    2012.10.03 04:58:02 (GMT),\n    2013.01.04 04:49:18 (GMT)\nFile sizes: 110.592, 106.496, 144.384 bytes\n\n```\nTechnical details\n\nThe main module is activated in every application that requests for the COM object\nreferenced by the class ID it has overtaken:\n\n{ECD4FC4D-521C-11D0-B792-00A0C90312E1}\n\nWindows Explorer appears to be the primary target of this COM object hijacking. The\nname of the hijacked class is called “Shell Rebar BandSite”.\n\nThe module uses an interesting evasion technique to hide its presence in the system.\nOnce activated, it first reads the registry value that points to the dynamic library that\nexports the original COM object:\n\n_HKEY_CLASSES_ROOT\\CLSID\\{E6BB64BE-0618-4353-9193-_\n_0AFE606D6F0C}\\InprocServer32_\n\nIt loads the original library and modifies the module list of the process, first replacing\nits own entry with a copy of the data from the hijacked DLL, and then completely\nremoves all references to itself in PEB LDR linked lists.\n\nNext, it loads one of the system libraries that is not currently loaded by the current\nprocess, from the following list:\n\n\nCHTBRKR.DLL\nCLICONFG.DLL\nDMCONFIG.DLL\nMFC42.DLL\nMFWMAAEC.DLL\nMSJET40.DLL\nNTDSA.DLL\nOAKLEY.DLL\nOPENGL32.DLL\nPIDGENX.DLL\n\n\nPNPUI.DLL\nQMGR.DLL\nQUARTZ.DLL\nVERIFIER.DLL\nWMDRMDEV.DLL\nWMDRMNET.DLL\nWMICMIPLUGIN.DLL\nWMNETMGR.DLL\nWPDSP.DLL\n\n\n#### TLP: GREEN 12\n\n\n-----\n\nAfter the system library is loaded, its contents are overwritten with the malicious\nlibrary, but the module path and other data are kept intact. So, to someone looking\nwith a process analysis tool, the malicious library appears as a clean system DLL in\nthe module list of the top process. It can be only identified by inspecting the actual\ncontents of the memory allocated to the system library.\n\nThe module transfers control to its copy by calling its DllMain function with\nDLL_THREAD_ATTACH parameter and a custom lpReserved value that points to a\nconfiguration structure containing a valid magic number. When DllMain is called with\nthese parameters, it proceeds to execute its main functionality.\n\nFirst, it decrypts the CAB file from its body using the same RC4 key as in the installer\nmodule, and checks its contents.\n\n**Name** **File Size** **Compilation Time**\ndinner32.jpg 25088 bytes 14.07.2009 01:16:44\n\n8192 bytes 14.07.2009 01:16:44\n\nchef32.jpg 94208 bytes 14.07.2009 01:16:44\nwaiter32.jpg\n\n**Figure 4. CAB contets for shlink32.dll**\n\n**Name** **File Size** **Compilation Time**\ndinner64.jpg 18432 bytes 14.07.2009 01:16:44\nchef64.jpg 14.07.2009 01:16:44\nwaiter64.jpg 10240 bytes 14.07.2009 01:16:44\ndinner32.jpg 97280 bytes 14.07.2009 01:16:44\n\n25088 bytes\n\nchef32.jpg 8192 bytes 14.07.2009 01:16:44\nwaiter32.jpg 94208 bytes 14.07.2009 01:16:44\n\n**Figure 5. CAB contets for shlink64.dll**\n\nThe module searches for a file named “waiter32.jpg” or “waiter64.jpg”, depending on\nthe platform. It loads this module the same way as its own copy, replacing another\nsystem DLL in memory and executes its DllMain function in DLL_THREAD_ATTACH\nmode and passes the configuration structure as the lpReserved parameter. The\n“waiter” module is called in the “explorer” mode of operation (see “Waiter module”).\n\nIt then intercepts the “CreateProcessW” function in libraries “shell32.dll” and\n“ieframe.dll” with its own routine. That routine modifies the process creation flags,\nforcing the process to start in suspended mode, and performs additional processing if\nthe process being launched belongs to the list of browser’s filenames:\n“IEXPLORE.EXE, FIREFOX.EXE, CHROME.EXE”.\n\nThe module infects the intercepted browser processes by injecting all the three\nmodules from the CAB archive in its memory: “dinner”, “chef” and “waiter”. These\nmodules are created in memory of the target process and execution is passed to the\n“dinner” module by queueing an APC call to its main function. The main module\nnotifies its “waiter” module about the injected modules and connects them using\nanonymous pipes.\n\n|Name|File Size|Compilation Time|\n|---|---|---|\n|dinner32.jpg 25088 bytes 14.07.2009 01:16:44 8192 bytes 14.07.2009 01:16:44 chef32.jpg 94208 bytes 14.07.2009 01:16:44 waiter32.jpg|||\n\n|Name|File Size|Compilation Time|\n|---|---|---|\n|dinner64.jpg 18432 bytes 14.07.2009 01:16:44 chef64.jpg 14.07.2009 01:16:44 waiter64.jpg 10240 bytes 14.07.2009 01:16:44 dinner32.jpg 97280 bytes 14.07.2009 01:16:44 25088 bytes chef32.jpg 8192 bytes 14.07.2009 01:16:44 waiter32.jpg 94208 bytes 14.07.2009 01:16:44|||\n\n\n#### TLP: GREEN 13\n\n\n-----\n\n**“Dinner” module**\n\nThis module is compiled as an executable, but its entry point function is only\nexecuted via an APC remote call and it accepts a single parameter.\n```\nFile type: PE32/PE32+ EXE\nCompilation timestamps: \n    2012.04.25 21:05:20 (GMT),\n    2012.04.25 21:05:40 (GMT), \n    2013.01.15 00:30:03 (GMT),\n    2013.01.15 20:18:55 (GMT), \n    2013.05.21 20:40:45 (GMT)\nFile sizes: 25088, 18432 bytes\n\n```\nTechnical details\n\nIt Loads the library “iertutil.dll” and patches its import in “advapi32.dll”,\n“GetSidSubAuthority”. Then, it executes the command:\n\n_iexplore.exe shell.{3F9F6D47-FE76-4B11-8B70-780ED19091B1}_\n\nand also patches the “OpenEvent” and “CreateProcessW” API in “URLMON” library.\n\nAfter applying patches to the system libraries, the module reloads the “chef” and\n“waiter” modules in system DLLs the same way as the main module and invokes the\n“waiter” module in the “internet” mode (See “Waiter module”).\n\n**“Chef” module**\n\nThis module implements network connectivity features for the package.\n```\nFile type: PE32/PE32+ DLL\nCompilation timestamps: \n    2012.04.25 21:02:09 (GMT),\n    2012.04.25 21:02:43 (GMT), \n    2013.01.15 00:27:54 (GMT),\n    2013.01.15 20:16:55 (GMT), \n    2013.05.21 20:38:23 (GMT)\nFile sizes: 8192, 10240 bytes\n\n```\nTechnical details\n\nWhen loaded by the “dinner” module, it returns a structure that contains pointers to\nfour functions. These functions can send HTTP/HTTPS “GET” and “POST” requests\nusing a given URL. The addresses of these functions are passed to the “waiter”\nmodule.\n\n\n#### TLP: GREEN 14\n\n\n-----\n\nThe module uses the following fixed User-Agent string for all HTTP requests:\n\nMozilla/4.0 (compatible; MSIE 4.01; Windows NT)\n\n**“Waiter” module**\n\nThis module implements all the logic of the “Careto” package.\n```\nFile type: PE32/PE32+ DLL\nCompilation timestamps: \n    2012.04.25 21:02:02 (GMT),\n    2012.04.25 21:02:37 (GMT), \n    2013.01.15 00:27:54 (GMT),\n    2013.01.15 20:17:09 (GMT), \n    2013.05.21 20:38:36 (GMT)\nFile sizes: 94208, 97280 bytes\n\n```\nTechnical details\n\nThe encrypted configuration block is either loaded from the registry or taken from the\ncaller and saved to the registry. The exact location of the registry key is read from the\nconfiguration block. Known locations are:\n\n_HKCU/HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\WindowsUpdate_\n_CISCNF4654_\n_CISCNF0654_\n\n**Figure 6. Decrypted configuration block**\n\nIn “explorer” mode, it stores the handles of loaded modules and monitors the process\ntermination to free unused handles. This is another example of careful the Careto\n\n\n-----\n\nauthors were to make sure the infected machine is stable and un-noticed by the\nvictims.\n\nWhen executed in the “explorer” mode, it waits 60 seconds for the dinner/chef pair to\nbe properly loaded in the browser’s process. Once there is such a process, it sends a\ncommand to its instance injected in the browser activating the connection to the C&C\nserver.\n\nWhen running in the browser’s process (“internet” mode), it enters an infinite loop\nwaiting for commands from the anonymous pipe provided by its “explorer” mode\ninstance and handles all C&C communication when requested.\n\nThe C&C server provides the commands inside CAB files, one archive per request.\nThe archive is expected to contain a text file named “Meta.inf”. This file contains\nvarious configuration parameters and commands to be executed by the module.\n```\n#Wed Oct 09 14:55:09 BST 2013\nAIT_PARAMS=-s -h -n -t -p -w 0\nDLL32_FILE_NAME=CDllAIT32.dll\nDLL64_FILE_NAME=CDllAIT64.dll\nDATE_GENERATION=20131009T145509.009\nTYPE=CMD\nCLIENT_ID=Client0650\nCMD_SEQ=0001\nINST_ID=4499149305321491\nSUB_TYPE=CANNEDDLL\nTARGET_PROCESS=explorer\nPRODUCT_CODE=C314\nW=0\n\n```\n**Sample Meta.inf file**\n\nThe commands can be executed either in the module injected in browser, or by the\noriginal instance loaded via COM spoofing. The “TARGET_PROCESS” values are\n“internet” and “explorer”, determining the operation mode.\n\n\n#### TLP: GREEN 16\n\n\n-----\n\nBelow is the full list of implemented commands:\n\n|UPLOAD|Write a file from the CAB archive to the infected machine. The location can be relative to a CSIDL or environment variable.|\n|---|---|\n|EXEC|Launch the specified executable with parameters|\n|UPLOADEXEC|Write a file from the CAB archive to the infected machine and then run it with the given parameters|\n|SYSTEMREPORT|Compile a system report and upload it to C&C: ● main module's file name ● proxy server settings ● list of installed programs ● OS version, type, Service Pack version ● list of network adapters' MAC addresses ● availability of direct connection to www.microsoft.com:80 ● values of environmental variables ● list of users|\n|SETLATENCY|Modify the delay before operation in the configuration block and update the registry. Report back in “SetLatencyLog.txt”|\n|CANNEDDLL|Load the executable module from the CAB archive and execute it in memory.|\n|SETCFG|Modify the data of the encrypted configuration block: primary or secondary URL of the C&C server, number of attempts to try for each of them.|\n\n\n#### TLP: GREEN 17\n\n\n-----\n\n#### 2.2.3. The SGH backdoor\n\nThe SGH backdoor is a lot more sophisticated than the Careto implant. It is designed\nto perform a large amount of surveillance functions, on a highly modular platform that\ncan be easily extended.\n\n**Installation module**\n\nThis module installs the complete SGH software package using a custom installation\nscript that is encrypted in its body.\n```\nFile type: PE32 EXE\nCompilation timestamps: \n    2013.05.09 11:20:08 (GMT), \n    2013.06.19 11:17:45 (GMT)\nFile sizes: 348264, 359936 bytes\n\n```\nTechnical details\n\nThe files are compiled with Visual Studio 2005.\n\nOne version of the installer module is signed by a certificate from the same (fake?)\ncompany TecSystem Ltd from Bulgaria:\n```\nName of signer: TecSystem Ltd., Sofia, BG\nSerial: 0E808F231515BC519EEA1A73CDF3266F\nValidity: 2013.04.18 – 2016.07.18\n\n```\nDigital Certificate\n\nThe SGH package is somehow special and it is what originally attracted our attention\nto this cyberespionage operation. When started, it first tries to exploit a vulnerability\nin older Kaspersky products.\n\nThe way the attack works is the following: first, it tries to open the handle of the\nKaspersky system driver, “\\\\.\\KLIF” and sends a custom DeviceIoControl code. If the\ncall succeeds, the module and all processed named “services.exe” are no longer\nchecked by the antivirus engine. This method theoretically allows the attacker to\nsurvive the addition of signatures for the malware components, as the product won’t\nbe able to detect them because they have been “whitelisted”. In practice, we can say\nthe attack is only half baked, because detection for the other top modules will\nprecede SGH and kill it before it loads. Nevertheless, it was this attack against our\nolder products that brought our attention to Careto and allowed us to discover it in\nthe first place.\n\nThe SGH module is relatively complex and has many functionalities, but in essence it\nis an infinitely extensible attack platform. In addition to the default plugins available in\nthe installation module, the attackers can also deploy other extensions to perform\nmore complex tasks. To operate, SGH uses encrypted virtual file systems that store\nextensions and activity logs.\n\n\n#### TLP: GREEN 18\n\n\n-----\n\nOn startup, the module locates a PE section with name “.inf” in its own file. This\nsection contains the encrypted and compressed binary installation script. The section\nis decrypted with RC4 using a hardcoded key and then unpacked with “zlib”’s inflate\nfunction. The installer parses the script, executes all the commands and then deletes\nits own file and exits.\n\nThe installation script is a list of binary tagged entries of variable length. Entries can\nbe of one of the following types:\n\n1, 19 Depending on the additional parameter, operate in one of the following\nmodes:\n\n1. Install the file into the victim's system\n2. Download a file from a given URL (http, https, ftp, gopher) and either\ninstall it or treat as an additional installation script.\n\nThe file can be installed into a directory of choice:\n\n      - system directory\n\n      - temporary directory\n\n      - system drivers directory\n\n      - other location specified in the installation entry\n\n2 Remove a previously installed file\n\n3 Write a registry value. Create the key if necessary.\n\n4 Delete a registry value or a complete registry key, recursively.\n\n5 Copy data from one registry value to another\n\n6 Compare a registry value's date with the specified value. Abort the\ninstallation if the values are not equal.\n\n7 Create a new system service\n\n8 Delete a system service by name\n\n9 Start a system service by name\n\n10 Stop a system service by name\n\n11 No operation\n\n12 Create a process with given arguments\n\n13 Show a message box\n\n14 Append an existing registry value\n\n15 Add an USB device filter via Windows Setup API\n\n16 Remove an USB device filter via Windows Setup API\n\n17 Add a certificate to the system Certificate Storage\n\n18 Delete a certificate from the system Certificate Storage\n\n20 Exit if the installer is NOT running in a virtual machine\n\n21 Exit if the installer is running in a virtual machine\n\n22 Infect the system “bootmgr” file with provided code\n\n23 Write the buffer to a temporary file with prefix “___” and execute it\n\n|1, 19|Depending on the additional parameter, operate in one of the following modes: 1. Install the file into the victim's system 2. Download a file from a given URL (http, https, ftp, gopher) and either install it or treat as an additional installation script. The file can be installed into a directory of choice: - system directory - temporary directory - system drivers directory - other location specified in the installation entry|\n|---|---|\n|2|Remove a previously installed file|\n|3|Write a registry value. Create the key if necessary.|\n|4|Delete a registry value or a complete registry key, recursively.|\n|5|Copy data from one registry value to another|\n|6|Compare a registry value's date with the specified value. Abort the installation if the values are not equal.|\n|7|Create a new system service|\n|8|Delete a system service by name|\n|9|Start a system service by name|\n|10|Stop a system service by name|\n|11|No operation|\n|12|Create a process with given arguments|\n|13|Show a message box|\n|14|Append an existing registry value|\n|15|Add an USB device filter via Windows Setup API|\n|16|Remove an USB device filter via Windows Setup API|\n|17|Add a certificate to the system Certificate Storage|\n|18|Delete a certificate from the system Certificate Storage|\n|20|Exit if the installer is NOT running in a virtual machine|\n|21|Exit if the installer is running in a virtual machine|\n|22|Infect the system “bootmgr” file with provided code|\n|23|Write the buffer to a temporary file with prefix “___” and execute it|\n\n\n#### TLP: GREEN 19\n\n\n-----\n\nThe installer module can detect if it is being executed in a VMWare or Microsoft\nVirtual PC virtual machine.\n\nWe have discovered two different installation scripts so far. The decoded versions of\nthese scripts look like the following:\n\n#### Script 1:\n```\nInstall file(SystemDir, awdcxc32.dll, 8192 bytes)\nInstall file(SystemDir, mfcn30.dll, 17920 bytes)\nInstall file(SystemDir, vchw9x.dll, 20992 bytes)\nInstall file(SystemDir, awcodc32.dll, 24576 bytes)\nInstall file(SystemDir, jpeg1x32.dll, 31744 bytes)\nInstall file(SystemDir, bootfont.bin, 122912 bytes)\nInstall file(DriversDir, scsimap.sys, 14464 bytes)\nWriteRegistry(80000002\\SYSTEM\\CurrentControlSet\\Control\\Session\nManager\\Memory Management\\PrefetchParameters, EnablePrefetcher)\nCreateService(scsimap, System32\\DRIVERS\\scsimap.sys)\nWriteRegistry(80000002\\SYSTEM\\CurrentControlSet\\Services\\scsimap\\Params,\nValue)\nStartService(scsimap)\nWriteTempExecute(9320 bytes)\n Script 2:\nInstall file(SystemDir, awdcxc32.dll, 8192 bytes)\nInstall file(SystemDir, mfcn30.dll, 17920 bytes)\nInstall file(SystemDir, vchw9x.dll, 20992 bytes)\nInstall file(SystemDir, awcodc32.dll, 24576 bytes)\nInstall file(SystemDir, jpeg1x32.dll, 31744 bytes)\nInstall file(SystemDir, bootfont.bin, 126880 bytes)\nInstall file(DriversDir, scsimap.sys, 14464 bytes)\nWriteRegistry(80000002\\SYSTEM\\CurrentControlSet\\Control\\Session\nManager\\Memory Management\\PrefetchParameters, EnablePrefetcher)\nCreateService(scsimap, System32\\DRIVERS\\scsimap.sys)\nWriteRegistry(80000002\\SYSTEM\\CurrentControlSet\\Services\\scsimap\\Params,\nValue)\nStartService(scsimap)\nWriteTempExecute(10344 bytes)\nInstall file(SystemDir, siiw9x.dll, 15360 bytes)\nStartService(ipfilterdriver)\nWriteRegistry(80000002\\SYSTEM\\CurrentControlSet\\Services\\IpFilterDriver,\nStart)\n\n```\nIt’s important to point that the file names used for the DLLs during installation are not\nunique and are also used by legitimate software. For instance, the driver named\n“scsimap.sys” was present in older versions of Windows.\n\nIf the installation script was executed successfully the infected machine now has a\nnew system service named “scsimap” that loads the main SGH's driver “scsimap.sys”.\n\n\n#### TLP: GREEN 20\n\n\n-----\n\n**SGH plugin modules**\n\nThe following table provides the full list of plugin modules and a brief description of\ntheir functionality.\n\n**Module name** **Functionality**\n\nScsimap Orchestrator module for the platform components\n\nConfig Operates configuration data in registry\n\nStorage Used to store activity logs in the system\n\nCipher Provides cryptographic functions to other modules\n\nCmprss Provides compression functions to other modules\n\nLoaddll Injects DLL payloads into processes\n\nPGPsdkDriver Keylogger\n\nFileflt Intercepts file operations and collects content\n\nStopsec Implements an attack against Kaspersky products\n\nTdiFlt, TdiFlt2 Intercept network traffic\n\nawdcxc32 Interacts with scsimap driver from user mode\n\nawcodc32 Interacts with C&C server via vchw9x module\n\nmfcn30 Provides a framework to extend the malware with new\nplugins\n\nvchw9x Provides network connectivity functions\n\njpeg1x32 Used for uninstalling the malware\n\nsiiw9x Screen saver module\n\nSkypeIE6Plugin Intercepts and records Skype conversations\n\nNmwcdlog Gathers information from Nokia devices\n\nd3dx8_20 Takes screenshots of victim´s desktop\n\nWifiScan Retrieves the list of WiFi networks\n\nawview32 Collects victim´s email messages\n\nCDllUninstall Uninstalls malware\n\nFor a detailed description of the modules, please check APPENDIX 2: SGH Modules.\n\n|Module name|Functionality|\n|---|---|\n|Scsimap Orchestrator module for the platform components Config Operates configuration data in registry Storage Used to store activity logs in the system Cipher Provides cryptographic functions to other modules Cmprss Provides compression functions to other modules Loaddll Injects DLL payloads into processes PGPsdkDriver Keylogger Fileflt Intercepts file operations and collects content Stopsec Implements an attack against Kaspersky products TdiFlt, TdiFlt2 Intercept network traffic awdcxc32 Interacts with scsimap driver from user mode awcodc32 Interacts with C&C server via vchw9x module mfcn30 Provides a framework to extend the malware with new plugins vchw9x Provides network connectivity functions jpeg1x32 Used for uninstalling the malware siiw9x Screen saver module SkypeIE6Plugin Intercepts and records Skype conversations Nmwcdlog Gathers information from Nokia devices d3dx8_20 Takes screenshots of victim´s desktop WifiScan Retrieves the list of WiFi networks awview32 Collects victim´s email messages CDllUninstall Uninstalls malware||\n\n\n#### TLP: GREEN 21\n\n\n-----\n\n#### 2.2.4. The SBD backdoor\n\nIn addition to Careto and SGH, the “Mask” attackers use another backdoor based on\nthe public, open source “netcat” clone “sbd”.\n\n“sbd” stands for “Shadowinteger's Backdoor” and has been available at least since\n2004.\n\n**Figure 7: Original sdb copyright notice**\n\nThis backdoor has been observed for Win32, OS X and Linux.\n\nThe Linux variant gets installed from the exploit server “linkconf[dot]net” through the\nFirefox plugins. Unfortunately, the plugins we retrieved from the server were badly\ndamaged and could not be recovered. Nevertheless, they do seem to exist and are in\nuse by the Mask attackers.\n\nThe Mozilla Firefox plugin which installs the Linux “SBD” backdoor:\n\nArchive: af_l_addon.xpi\n\n**Name** **Length** **Method** **Size** **Ratio** **Date** **Time** **CRC 32**\nchrome.manifest 183 Defl:N   101 45%  10-07-13 14:30  cc37d585\ninstall.rdf 1274 Defl:N   443 65%  10-07-13 14:30  add50a10\nbootstrap.js 1798 Defl:N   695 61%  10-07-13 14:30  52eecaba\ncontent/browser.xul 166 Defl:N   134 19%  10-07-13 14:30  74e9bad7\ncontent/icon.png 66793 Defl:N   66664  0% 10-07-13 14:30  27609d6e\nplugins/sbd-linux 26020 Defl:N   22406 14%  10-07-13 14:30  a02b2e21\n\nThe Mozilla Firefox plugin that installs the “SBD” OS X backdoor:\n\nArchive: af_m_addon.xpi\n\n**Name** **Length** **Method** **Size** **Ratio** **Date** **Time** **CRC 32**\nchrome.manifest 183 Defl:N   102 44%  10-07-13 14:30  aeac29ae\ninstall.rdf 1274 Defl:N   443 65%  10-07-13 14:30  f5ee7026\nbootstrap.js 1796 Defl:N   695 61%  10-07-13 14:30  d5fc6c9b\ncontent/browser.xul 166 Defl:N   134 19%  10-07-13 14:30  74e9bad7\ncontent/icon.png 66793 Defl:N   66664  0% 10-07-13 14:30  27609d6e\nplugins/sbd-mac 42720 Defl:N   37072 13%  10-07-13 14:30  12d19684\n\nWe were able to recover a working copy of the OS X “sbd” backdoor, which we\ndescribe below.\n\n|Name|Length|Method|Size|Ratio|Date|Time|CRC 32|\n|---|---|---|---|---|---|---|---|\n|chrome.manifest 183 Defl:N 101 45% 10-07-13 14:30 cc37d585 install.rdf 1274 Defl:N 443 65% 10-07-13 14:30 add50a10 bootstrap.js 1798 Defl:N 695 61% 10-07-13 14:30 52eecaba content/browser.xul 166 Defl:N 134 19% 10-07-13 14:30 74e9bad7 content/icon.png 66793 Defl:N 66664 0% 10-07-13 14:30 27609d6e plugins/sbd-linux 26020 Defl:N 22406 14% 10-07-13 14:30 a02b2e21||||||||\n\n|Name|Length|Method|Size|Ratio|Date|Time|CRC 32|\n|---|---|---|---|---|---|---|---|\n|chrome.manifest 183 Defl:N 102 44% 10-07-13 14:30 aeac29ae install.rdf 1274 Defl:N 443 65% 10-07-13 14:30 f5ee7026 bootstrap.js 1796 Defl:N 695 61% 10-07-13 14:30 d5fc6c9b content/browser.xul 166 Defl:N 134 19% 10-07-13 14:30 74e9bad7 content/icon.png 66793 Defl:N 66664 0% 10-07-13 14:30 27609d6e plugins/sbd-mac 42720 Defl:N 37072 13% 10-07-13 14:30 12d19684||||||||\n\n\n-----\n\n#### 2.2.5. The OSX SBD backdoor\n\nThe original OS X dropper found on the exploit server has the following identification\ninformation:\n```\nFile name: banner.jpg\nType: Mach-O x86 32 bit binary\nMD5: 02e75580f15826d20fffb43b1a50344c\nSize: 46876 bytes\n\n```\nIdentification details\n\nThis is a dropper for the main SBD backdoor.\n\nFirst, it copies the standard Safari application to “ /Applications/.DS_Store.app”.\nNext, it creates the file “\"/Applications/.DS_Store.app/Contents/MacOS/Update” and\nunpacks the main backdoor code into there. The installer carefully copies the\ntimestamp from the original Safari “Contents/Info.plist” for the backdoor, to make it\nharder to notice.\n\nFor persistence, it modifies the “/Applications/.DS_Store.app/Contents/Info.plist” file\nwith a reference to the main backdoor body, also carefully setting the timestamp on\nthe “.plist” file, then it registers it in the system via\n“Library/LaunchAgents/com.apple.launchport.plist”.\n\nThe “.plist” and main backdoor body are stored in the dropper in compressed\n(“bzip2”) format. They have the following identification information:\n\nMain “SBD” backdoor, OS X:\n```\nType: Mach-O x86 32 bit binary\nMD5: 1342ac151eea7a03d51660bb5db018d9\nSize: 89828 bytes\n\n```\n“.plist” data:\n```\nSize: 582 bytes\nMD5: 4dae42d1b80c85b396546ed02a00e328\n\n```\nThe Mask’ version of the “sbd” backdoor has a hardcoded C&C server, to which it\nconnects on port 443. The attackers can then directly access the victim’s machine\nthrough a shell.\n\nAll important strings in the backdoor are encrypted with a simple XOR - for even\npositions, it is XOR 0x7f, for odd positions it is XOR 0x10.\n\nThe C&C communication is encrypted with AES and uses SHA1 for crossauthentication. The encryption key used for communication is the following string\n\n\n#### TLP: GREEN 23\n\n\n-----\n\n“/dev/null strdup() setuid(geteuid())”. The server address is encoded in the binary as\nfollows:\n\n**Figure 8: Encoded C&C address**\n\nAfter applying th decryption algorithm, we get the real C&C address:\n\nitunes212.appleupdt[dot]com\n\nBy means of passive DNS fingerprinting, we identified two other domains used by the\nattackers as C&C’s.\n\nHere’s a full list of the C&C servers for the OS X backdoor:\n\n**Host name** **IP** **Server location**\n\nitunes212.appleupdt.com 200.46.107.115 Panama, Net2net Corp.\n\nitunes214.appleupdt.com 200.46.107.116 Panama, Net2net Corp.\n\nitunes311.appleupdt.com 200.46.107.117 Panama, Net2net Corp.\n\nAs of Feb 6th, 2014, the OS X “SBD” backdoor C&C domains have been suspended\nby Apple.\n\n|Host name|IP|Server location|\n|---|---|---|\n|itunes212.appleupdt.com 200.46.107.115 Panama, Net2net Corp. itunes214.appleupdt.com 200.46.107.116 Panama, Net2net Corp. itunes311.appleupdt.com 200.46.107.117 Panama, Net2net Corp.|||\n\n\n-----\n\n#### 2.3. Digital certificates\n\nMost Careto samples we obtained are signed by two different digital certificates\nbelonging to the same company TecSystem Ltd, from Bulgaria. We don´t know if this\ncompany is legitimate.\n\n**Certificate 1:**\n```\n    e  l  36 be 4a d4 57 f0 62 fa 77 d8 75 95 b8 cc c8 cf\n     m  71 a4 ee 9d 5d 6a 26 85 1e 35 25 60 93 69 22 ee b6 d5 9a 1f\n\n```\n**Certificate 2:**\n```\n    e  l  0e 80 8f 23 15 15 bc 51 9e ea 1a 73 cd f3 26 6f\n     m  34 10 f8 cf 77 e1 7a 51 36 45 16 18 0c 3e 6d 46 b6 6c 93 c4\n\n```\nThe first certificate was valid between 28.Jun.2011 - 28.Jun.2013.\nThe second certificate was valid from 18.Apr.2013 - 18.Jul.2016.\n\n**Figure 9: Digital certificate used**\n\nThe second valid certificate has been blacklisted by Verisign.\n\n\n-----\n\n#### 2.4. Exploit for Kaspersy´s products \n\nWe initially became aware of Careto when we observed attempts to exploit a\nvulnerability in our products to make the malware “invisible” in the system. This\nvulnerability was solved in 2008, when all this module was remade from scratch and\nthe communication protocol changed, including additional security checks.\n\nThe attackers could have used this exploit for avoiding detection in some\nWorkstation products prior version 6.0.4.*, and KAV/KIS 8.0 versions not updated\nproperly (it was fixed during this release).\n\nOf course, this raised our interest and our research team decided to investigate\nfurther. In other words, the attackers attracted our attention by attempting to exploit\nKaspersky Lab products.\n\nWe have no knowledge of any other malware exploiting this vulnerability.\n\n\n#### TLP: GREEN 26\n\n\n-----\n\n#### 2.5. Communication \n\nThe communication between the C&Cs and the victims uses an encrypted protocol\nover HTTP or HTTPs.\n\nIn case of the Careto implant, the C&C communication channel is protected with two\nlayers of encryption. The data received from the C&C server is encrypted using a\ntemporary AES key, which is also passed with the data and is encrypted with an RSA\nkey. The same RSA key is used to encrypt the data that is sent back to the C&C\nserver. This double encryption is uncommon and shows the high level of protection\nimplemented by the authors of the campaign.\n\nSo far, we observed two version of command and control modules, named\n“index.cgi”, “main.cgi” and “commcgi.cgi”. These are used by the generations of the\nmalicious modules to communicate with the attackers.\n\nThe Careto implant uses “main.cgi”, “index.cgi” and “commcgi.cgi”. SGH uses\nexclusively “index.cgi”.\n\nDuring C&C connections, the “Install” or “Inst” parameters contain the unique ID\nassigned to the victim. Here’s how a typical C&C query looks like:\n```\nhttp(s)://SERVER/cgi-bin/commcgi.cgi?\n    Group=XXX==\n    &Install=VICTIMID\n    &Ver=BACKDOORVERSION\n    &Ask=BOOLEAN\n    &Bn=NUMBER\n\n```\nKnown parameters for “commcgi.cgi” and “index.cgi”:\n\n|Parameter|Explanation|\n|---|---|\n|Group|Base-64 encoded hash of the first 16 bytes of the victim identifier|\n|Install|Unique victim identifier|\n|Ver|Implant version; C for Careto, S for SGH.|\n|Ask|Request mode: “1” - requesting commands, “0” - reporting results|\n|CmdId|Command id|\n|Ack|Acknowledge on successful command execution on victim’s machine|\n|Bn|Hardcoded value, i.e. “3”|\n\n\n#### TLP: GREEN 27\n\n\n-----\n\n|File|Filename for exfiltrated data|\n|---|---|\n|Offset|Offset to write exfiltrated data|\n\n\nBased on the “Ver” parameter, we extracted the list of unique implant versions\nconnecting to our sinkhole for the past weeks. Although most of the connections\ncome from the Careto implant, there are some which indicate the possible presence\nof unknown versions.\n\n**Figure 10: Sinkholed requests by version**\n\nC314, the most popular ID, is used by the Careto module. C316 is the second most\npopular Careto module version.\n\nThe “L” version of the implant is a mystery. We associate it with a version of Careto\nwhich we haven’t been able to locate so far, perhaps the Linux variant. The C&C\ncommunication is also different from other modules. The “L” version communicates\nexclusively with the “index.cgi” script.\n\nFinally, the “AND1.0.0.0” version identifier is the most interesting. The only known\nvictim in the world running this version of the implant appears to be connecting\nthrough a 3G link, possibly indicating a mobile device. Also, there is no user agent\nstring, as in other versions of Careto. The most likely explanation for the version\nname would be “AND(DROID)”, indicating a version of the implant for Google’s\nAndroid OS. The “AND” implant communicates exclusively with the “commcgi.cgi”.\n\n\n-----\n\n#### 2.6. C&C Servers\n\nThe backdoor modules communicates with command and control via HTTP or\nHTTPS, depending on the malware configuration. In all the cases we observed, the\nC&C expose a CGI based frontend via modules named “index.cgi” and\n“commcgi.cgi”.\n\nA list of collected C&C URLs from known modules is included below, together with\nserver location.\n\n|C&C URL|Server IP, location|\n|---|---|\n|hxxp://202.75.56.231/cgi-bin/index.cgi|Malaysia, Kuala Lumpur, “Tm Vads Dc Hosting”|\n|hxxp://202.75.58.153/cgi-bin/commcgi.cgi|Malaysia, Kuala Lumpur, “Tm Vads Dc Hosting”|\n|hxxp://cherry1962.dyndns.org/cgi-bin/index.cgi|202.75.56.231 Malaysia, Kuala Lumpur, “Tm Vads Dc Hosting”|\n|hxxps://196.40.84.94/num|Costa Rica, San Jose, “Servicio Co- location Racsa”|\n|hxxps://202.150.214.50/cgi-bin/commcgi.cgi|Singapore, “Benwu”|\n|hxxps://carrus.gotdns.com/cgi-bin/commcgi.cgi|202.75.56.123 Malaysia, Kuala Lumpur, “Tm Vads Dc Hosting”|\n|hxxps://dfup.selfip.org/cgi-bin/commcgi.cgi|37.235.63.127 Austria, Graz, “Edis Gmbh”|\n|hxxps://redirserver.net/num|196.40.84.94, 190.10.9.209 Costa Rica, San Jose, “Servicio Co- location Racsa”|\n|hxxps://wwnav.selfip.net/cgi-bin/commcgi.cgi|190.105.232.46 Argentina, Buenos Aires, “Nicolas Chiarini”|\n|hxxps://81.0.233.15/cgi-bin/index.cgi|Czech Republic, Prague, Casablanca Int|\n|hxxps://helpcenter1it6238.cz.cc/cgi- bin/commcgi.cgi|82.208.40.11 Czech Republic, Prague, Casablanca Int|\n|hxxps://helpcenter2br6932.cc/cgi- bin/commcgi.cgi|n/a|\n|hxxps://223.25.232.161/cgi-bin/commcgi.cgi|Singapore, “Sg 8 To Sg”|\n|hxxps://oco-231-ms.xns01.com/cgi- bin/commcgi.cgi|223.25.232.161 Singapore, “Sg 8 To Sg”|\n\n\n#### TLP: GREEN 29\n\n\n-----\n\n|hxxps://75.126.146.114/cgi-bin/index.cgi|United States, Dallas, “Softlayer Technologies Inc.”|\n|---|---|\n|hxxps://services.serveftp.org/cgi-bin/main.cgi|75.126.146.114 United States, Dallas, “Softlayer Technologies Inc.”|\n|hxxps://ricush.ath.cx/cgi-bin/commcgi.cgi|75.126.146.114 United States, Dallas, “Softlayer Technologies Inc.”|\n|hxxps://nthost.shacknet.nu/cgi-bin/index.cgi|190.105.232.46 Argentina, Buenos Aires, “Nicolas Chiarini”|\n\n\nWe were able to obtain a copy of a C&C through one of our partners in Latin America,\nwhich allowed us to analyse how it works.\n\n**C&C server structure**\n\nA typical C&C server has the following structure:\n```\n/var/www\n       index.html < blank page\n       /html  <  l nk o “Cl en D ec o y”\n       /cgi-bin    \n       /secure\n\n```\nThe /cgi-bin and /secure folders are described below.\n\n####  CGI-BIN Folder:\n```\n/cgi-bin\n       commcgi.cgi  < C&C module\n       file.cgi    < tool used by the attackers to retrieve logs\n       index.cgi    < C&C module\n       kitkat.cgi   < same file as index.cgi\n       main.cgi    < same file as index.cgi\n       /ClientsDirectory < used to store victim’ information\n/ClientsDirectory\n       log.txt      < debug logfile with victim’ requests\n       /dataang    < empty\n       /CmdData  < empty\n       /data      < empty\n       /fb        < empty\n       /bkp       < Co ld e  o  fo “ ck p”. Seve l\n                  small old logfiles\n       /in        < probably inbox folder for stolen files\n       /img       < encrypted files with .gif extension\n\n```\n\n#### TLP: GREEN 30\n\n\n-----\n\nIn the case of the “/in” folder, we can find many encrypted small files with the same\nsize (512 bytes) and the following naming schema:\n\n**in.instVICTIMID.cmd000X.get000Y**\n\nApparently these files are the result of executing the command X in VICTIMID. Small\npackets with the same size mean that the communication is fragmented, probably Y\nrepresents the packet sequence. VICTIMID is always a 16 digit number.\n\nIn the case of the /img folder, all files are encrypted data files of 929 bytes. The\nformat is:\n\n**VICTIMID.000N.gif**\n**or**\n**VICTIMID.000N.000X**\n\nThese are chunks of stolen data for a given VICTIMID, X being the sequence\nnumber and N the file identifier. The files in the second format don´t have the same\nsize, reinforcing the hypothesis of last file’s chunk of data.\n\n####  Secure Folder:\n```\n/Secure\n       getlogs.php \n           Parses log files from apache and copies content into\n           /usr/local/share/messages/log. \n           Securely deletes the original log files using the  \n           “  ed –z” comm nd.\n       module.php\n           Allows to upload, delete and move modules into \n           var/www/html\n       test.php\n          A “Hello wo ld” ppl c  on\n       upload.php\n           Uploads file into \n           /usr/local/share/messages/authdata/auth\n\n```\nAdditionally a Perl script (launchMessages.pl) inside “/usr/local/share/messages” is\nused for the users to communicate between them. The script copies messages from\none user to the receiver using the data in the /home/user/auth subdirectory, in the\nformat $adfile, $login $passwd $auth $secure $port\\n.\n\n\n#### TLP: GREEN 31\n\n\n-----\n\nFinally, we observe interesting data inside “.htaccess” files. Clearly the attackers\nwanted to keep their infrastructure hidden from undesired visitors. For this, they\nblacklisted a number of IPs used by security researchers. Some of these IPs include\ncomments about the owners against the Careto attackers want to hide. Notably,\nKaspersky Lab IPs are included in the list.\n\n**/var/www/cgi-bin/.htaccess:**\n\ndeny from 72.52.91.30 < Hurricane Electric, Inc.\ndeny from 217.115.10.132 < Chaos Computer Club e.V.\ndeny from 213.61.149.100 < SOPRADO GmbH\ndeny from 62.213.110.0/26 < Kaspersky Lab\ndeny from 23.20.44.92                  < Amazon.com\ndeny from 38.105.71.0/24              < Cyveillance Inc\ndeny from 66.150.14.0/24              < Internap Network Services\ndeny from 150.70.0.0/16               < TrendMicro\ndeny from 194.72.238.0/24 < Netcraft Ltd\n# evuln.com\ndeny from 78.158.11.0/24              < evuln.com\n# cambridge computer laboratory\ndeny from 128.232.0.0/16              < cambridge computer laboratory\n# softlayer\ndeny from 174.36.0.0/15               < softlayer\ndeny from 174.122.254.42             < softlayer\n# segurança virtua\ndeny from 187.122.176.14             < segurança virtua\n# worldstream\ndeny from 217.23.0.0/24               < worldstream\n# bluecoat\ndeny from 8.28.16.254                  < bluecoat\ndeny from 103.246.38.0/24 < bluecoat\ndeny from 199.19.248.0/21 < bluecoat\ndeny from 199.91.132.0/22 < bluecoat\n# eset\ndeny from 195.168.53.0/24 < eset\n\nA second .htaccess file was found in the home folder of the only user in the system.\n\n#order deny,allow\nOrder allow,deny\ndeny from 23.20.44.92                  < Amazon EC2\ndeny from 38.105.71.0/24              < Cyveillance Inc\ndeny from 66.150.14.0/24              < Internap Network Services\ndeny from 150.70.0.0/16               < TRENDMICRO\ndeny from 194.72.238.0/24 < Netcraft Ltd\ndeny from 78.158.11.0/24              < evuln.com\ndeny from 128.232.0.0/16              < cambridge computer laboratory\ndeny from 174.36.0.0/15               < softlayer\ndeny from 174.122.254.42             < softlayer\ndeny from 187.122.176.14             < segurança virtua\ndeny from 217.23.0.0/24               < worldstream\ndeny from 8.28.16.254                  < bluecoat\n\n\n#### TLP: GREEN 32\n\n\n-----\n\ndeny from 103.246.38.0/24 < bluecoat\ndeny from 199.19.248.0/21 < bluecoat\ndeny from 199.91.132.0/22 < bluecoat\ndeny from 195.168.53.0/24 < eset\nallow from all\n\n# Workaround for Apache Killer\n# http://seclists.org/fulldisclosure/2011/Aug/241\nRewriteEngine On\nRewriteCond %{REQUEST_METHOD} ^(HEAD|GET) [NC]\nRewriteCond %{HTTP:Range} ([0-9]*-[0-9]*)(\\s*,\\s*[0-9]*-[0-9]*)+ [OR]\nRewriteCond %{HTTP:Request-Range} ([0-9]*-[0-9]*)(\\s*,\\s*[0-9]*-[0-9]*)+\nRewriteRule .* - [F]\n\nThese files demonstrate the attackers are carefully protecting their infrastructure and\ntry to avoid any monitoring attempts from security companies, including Kaspersky\nLab and ESET.\n\nCommand and control domains registration can be accessed in APPENDIX 3.\n\n\n#### TLP: GREEN 33\n\n\n-----\n\n#### 2.7. Exploits\n\nThe spear phishing attacks we have observed lured the victims into URLs with\nresources in Spanish, such as videos related to political subjects or even food\nrecipes (“recetas”).\n\nAll the e-mails include a link to the malicious server that was used for infecting the\nvictim. After the infection, the visitor was redirected to another, clean URL.\n\nThe following links have been observed in the attacks:\n\n- hxxp://bit.linkconf[dot]net/jupd/w/frame-index.htm?url=hxxp://bit.ly/{censored}\n\n- hxxp://bit.linkconf[dot]net/jm/frame-redirect.htm?url=hxxp://bit.ly/{censored}\n\n- hxxp://www.recetas.linkconf[dot]net/jupd/w/frameindex.htm?url=hxxp://www.recetas.net/receta.asp?ID=1208GL\n\nThe exploit pack was hosted on a server at “linkconf [dot] net”. We have found many\nsubdomains pretending to be newspapers, perfect for the spear phishing attacks.\nMost of them simulate spanish newspapers:\n\n  - negocios.iprofesional.linkconf[dot]net/\n\n  - www.internacional.elpais.linkconf[dot]net/\n\n  - politica.elpais.linkconf[dot]net/\n\n  - cultura.elpais.linkconf[dot]net/\n\n  - economia.elpais.linkconf[dot]net/\n\n  - test.linkconf[dot]net/\n\n  - soc.linkconf[dot]net/\n\n  - sociedad.elpais.linkconf[dot]net/\n\n  - world.time.linkconf[dot]net/\n\n  - internacional.elpais.linkconf[dot]net/\n\n  - elpais.linkconf[dot]net/\n\n  - www.elespectador.linkconf[dot]net/\n\n  - blogs.independent.linkconf[dot]net/\n\n  - www.elmundo.linkconf[dot]net/\n\n  - www.guardian.linkconf[dot]net/\n\n  - www.washingtonsblog.linkconf[dot]net/\n\n  - www.publico.linkconf[dot]net/\n\nThe server has the typical structure of an exploit server including Javascript code for\nprofiling the victim (browser, plugins, operating system, MS-Office version, etc).\n\nThe attack is designed to handle all possible cases and potential victim types.\nDepending on the operating system, browser and installed plugins, the user is\nredirected to different subdirectories, which contain specific exploits for the user’s\nconfiguration that are most likely to work.\n\n\n#### TLP: GREEN 34\n\n\n-----\n\nUnfortunately, we couldn’t obtain any of the observed live exploits from the server as\nthe attack URLs were removed, presumably after a successful hit on the victims. We\ndid find however older exploits in various folder names.\n\nOverall, we have found exploits for Java, SWF (CVE-2012-0773), as well as\nmalicious plugins for Chrome and Firefox, on Windows, Linux and OS X. The names\nof the subdirectories give some information about the kind of attack they launch, for\ninstance we can find “/jupd” where “JavaUpdate.jar” downloads and executes\n“javaupdt.exe”.\n\nSeveral attacks against browsers supporting Java have been observed.\nUnfortunately, we weren’t able to retrieve all the components from these attacks, as\nthey were no longer available on the server at the time of checking.\n\nThe first known method (“”/jr/” folder) uses an HTML (“frame-index.htm”) file that\nattempts to load and run a signed applet.\n\n**Figure 11: JavaUpdate.jar**\n```\nFile name: JavaUpdate.jar\nMD5: da1ad4e088ba921c0420428b1f73d5ca\nFile size: 273639 bytes\n\n```\nThe JavaUpdate.jar contains an exploit for CVE-2011-3544, a vulnerability in the\nJava Runtime Environment (JRE) component in Oracle JAVA SE JDK and JRE 7, 6\nUpdate 27 and earlier. Both the Java archive and the malicious Windows payload\ncode appears to have been compiled on Nov 7, 2013.\n\n\n-----\n\nArchive: JavaUpdate.jar\n\n**Name** **Length** **Method** **Size** **Ratio** **Date** **Time** **CRC 32**\n`META-INF/MANIFEST.MF` `620` Defl:N `400` `36%` `11-08-13` `08:57` `8ded95ba`\n`META-INF/ORACLE.SF` `782` Defl:N `494` `37%` `11-08-13` `08:57` `a50eb589`\n`META-INF/ORACLE.DSA` `922` Defl:N `774` `16%` `11-08-13` `08:57` `1adab24b`\n`META-INF/` `0` Defl:N `2` `0%` `11-08-13` `08:57` `00000000`\n```\nMETA-INF/\n\n```\n`applet.properties` `37` Defl:N `36` `3%` `11-08-13` `08:57` `bfd6b431`\n`icon.jpg` `278329` Defl:N `2574` `8%` `11-08-13` `08:57` `fd085c57`\n`javaupdt` `19784` Defl:N `83` `49%` `11-08-13` `08:57` `58d365de`\n```\ncom/ 0  Stored 0  0%  11-08-13 08:57  00000000\ncom/java/ 0  Stored 0   0%  11-08-13 08:57 00000000\ncom/java/\n\n```\n`UpdateAbstract.class` `1914` Defl:N `1079` `44%` `11-08-13` `08:57` `3e6f4e02`\n```\ncom/java/\n\n```\nDefl:N\n```\nWindowsUpdate.class 2825  1555 45%  11-08-13 08:57 372c40f3 \ncom/java/\n\n```\nDefl:N\n```\nUpdate.class 1221   735  40%   11-08-13  08:57  0c3ad05f  \n\n```\nThe exploit’s Windows payload:\n```\n    File name: javaupdt\n    Type: Windows PE executable\n    MD5: 302fd970cf413afe50e6a829386e6e43\n    File size: 19784 bytes\n\n```\nThe “javaupdt” executable decrypts and runs the main backdoor installer from a file\nnamed “icon.jpg” in the Java archive. The installer is encrypted with a 12 bytes XOR\nkey. Interestingly, the exploit payload is compiled with GCC, unlike other modules\nwhere the attackers used MSVC 2005.\n\nThe second attack against Java users leverages Java Web Start / JNLP - Java\nNetwork Launch Protocol files. It claims to be a Java update from Oracle and asks\nthe user to install it.\n\nThe spearphished URLs reference “http://linkconf[dot]net/jn/w/file.jnlp”.\n\n|Name|Length|Method|Size|Ratio|Date|Time|CRC 32|\n|---|---|---|---|---|---|---|---|\n|META-INF/MANIFEST.MF 620 Defl:N 400 36% 11-08-13 08:57 8ded95ba META-INF/ORACLE.SF 782 Defl:N 494 37% 11-08-13 08:57 a50eb589 META-INF/ORACLE.DSA 922 Defl:N 774 16% 11-08-13 08:57 1adab24b META-INF/ 0 Defl:N 2 0% 11-08-13 08:57 00000000 META-INF/ applet.properties 37 Defl:N 36 3% 11-08-13 08:57 bfd6b431 icon.jpg 278329 Defl:N 2574 8% 11-08-13 08:57 fd085c57 javaupdt 19784 Defl:N 83 49% 11-08-13 08:57 58d365de com/ 0 Stored 0 0% 11-08-13 08:57 00000000 com/java/ 0 Stored 0 0% 11-08-13 08:57 00000000 com/java/ UpdateAbstract.class 1914 Defl:N 1079 44% 11-08-13 08:57 3e6f4e02 com/java/ Defl:N WindowsUpdate.class 2825 1555 45% 11-08-13 08:57 372c40f3 com/java/ Defl:N Update.class 1221 735 40% 11-08-13 08:57 0c3ad05f||||||||\n\n\n#### TLP: GREEN 36\n\n\n-----\n\n**Figure 12: Java Update**\n\nThe “index.jnlp” has the following content:\n\n**Figure 13: Index jnlp**\n\nIts main function is to load “JavaUpdate.jar”, which contains a signed dropper that\ninstalls the SGH implant into the system.\n\nA Java version profiler which loads another JAR file named\n“sSunJavaRealTimeSystem.jar” was also found on the server, in a folder named “m”\nthat might suggest it was used for OS X visitors, considering the attacker’s folder\nnaming scheme.\n\n**Name** **Length** **Method** **Size** **Ratio** **Date** **Time** **CRC 32**\n```\ncom/ 0  Stored 0 0%  10-07-13 16:20 00000000 \ncom/java/ 0  Stored 0 0%  10-07-13 16:20  00000000 \ncom/java/\n        400  Def1:N 281  0%  10-07-13 16:20  3f8cb4bf \nUpdate.class\n\n```\nThis class simply prints a message which says “Updated!”.\n\n|Name|Length|Method|Size|Ratio|Date|Time|CRC 32|\n|---|---|---|---|---|---|---|---|\n|com/ 0 Stored 0 0% 10-07-13 16:20 00000000 com/java/ 0 Stored 0 0% 10-07-13 16:20 00000000 com/java/ 400 Def1:N 281 0% 10-07-13 16:20 3f8cb4bf Update.class||||||||\n\n\n-----\n\nThe other observed attack methods relies on a Flash Player exploit.\nCVE-2012-0773 has an interesting history. It was originally discovered by French\ncompany VUPEN and used to win the “pwn2own” contest in 2012. This was the first\nknown exploit to escape the Chrome sandbox. VUPEN refused to share the exploit\nwith the contest organizers, claiming that it plans to sell it to its customers. As a side\nnode, VUPEN exploits are commonly seen in high end nation state level attacks; for\ninstance we have commonly observed them with HackingTeam’s DaVinci / Remote\nControl System attacks.\n\n**Figure 14: CVE-2012-0773 staging script**\n\n\n-----\n\n**Figure 15: Heapspray class inside the action script**\n\nThe SWF exploit for CVE-2012-0773 appears to have been fine-tuned for Flash\nPlayer versions 10.3.x. Although these have become obsolete (current version is\n12.0.0.38), there is no point in implementing / showcasing such a complex exploit\nunless the attackers were leveraging it around the time it was discovered. It is also\npossible that the exploit was still on the server because some users still have old\nFlash Player versions, and for those, it’s a perfectly good attack method.\n\nWe believe “/m” subdirs are for Mac users, and the “/l” subdirs for Linux. In these we\nhave found traces of Firefox plugins, but unfortunately they were broken.\n\nLinux plugin:\n\nArchive: af_l_addon.xpi\n\n**Name** **Length** **Method** **Size** **Ratio** **Date** **Time** **CRC 32**\nchrome.manifest 183 Defl:N   101 45%  10-07-13 14:30  cc37d585\ninstall.rdf 1274 Defl:N   443 65%  10-07-13 14:30  add50a10\nbootstrap.js 1798 Defl:N   695 61%  10-07-13 14:30  52eecaba\ncontent/browser.xul 166 Defl:N   134 19%  10-07-13 14:30  74e9bad7\ncontent/icon.png 66793 Defl:N   66664  0% 10-07-13 14:30  27609d6e\nplugins/sbd-linux 26020 Defl:N   22406 14%  10-07-13 14:30  a02b2e21\n\n|Name|Length|Method|Size|Ratio|Date|Time|CRC 32|\n|---|---|---|---|---|---|---|---|\n|chrome.manifest 183 Defl:N 101 45% 10-07-13 14:30 cc37d585 install.rdf 1274 Defl:N 443 65% 10-07-13 14:30 add50a10 bootstrap.js 1798 Defl:N 695 61% 10-07-13 14:30 52eecaba content/browser.xul 166 Defl:N 134 19% 10-07-13 14:30 74e9bad7 content/icon.png 66793 Defl:N 66664 0% 10-07-13 14:30 27609d6e plugins/sbd-linux 26020 Defl:N 22406 14% 10-07-13 14:30 a02b2e21||||||||\n\n\n#### TLP: GREEN 39\n\n\n-----\n\nMac / OSX plugin:\n\nArchive: af_m_addon.xpi\n\n**Name** **Length** **Method** **Size** **Ratio** **Date** **Time** **CRC 32**\nchrome.manifest 183 Defl:N   102 44%  10-07-13 14:30  aeac29ae\ninstall.rdf 1274 Defl:N   443 65%  10-07-13 14:30  f5ee7026\nbootstrap.js 1796 Defl:N   695 61%  10-07-13 14:30  d5fc6c9b\ncontent/browser.xul 166 Defl:N   134 19%  10-07-13 14:30  74e9bad7\ncontent/icon.png 66793 Defl:N   66664  0% 10-07-13 14:30  27609d6e\nplugins/sbd-mac 42720 Defl:N   37072 13%  10-07-13 14:30  12d19684\n\nBoth attack plugins appear to have been compiled on October 7, 2013.\n\nSamples of a malicious Chrome (Win32) plugin have also been located in the “/ag”\nfolder:\n```\nFile name: plugin.crx\nMD5: 1f40751f3db07f88c2ffe95b6a5fde86\nFile size: 256596 bytes\n\n```\nThe malicious Chrome plugin has the following structure:\n\n**Name** **Length** **Method** **Size** **Ratio** **Date** **Time** **CRC 32**\ncontent/ 0 Defl:N   2 0% 00-00-80 00:00  00000000\nmanifest.json 305 Defl:N   165 46%  00-00-80 00:00  b500a493\nplugins/ 0 Defl:N   2 0% 00-00-80 00:00  d5fc6c9b\n\n16384 Defl:N   7358 55%  00-00-80 00:00  3bd3e8bb\n\nplugins/\nnpplugin.dll\n\ncontent/icon.jpg 266948  Defl:N   245924  8% 00-00-80 00:00  b07ab7ee\ncontent/icon.png 2184 Defl:N   2189 0% 00-00-80 00:00  276fc4e2\n\nThe plugin is loaded via Javascript from the HTML index via a file named “plugin.js”:\n\n|Name|Length|Method|Size|Ratio|Date|Time|CRC 32|\n|---|---|---|---|---|---|---|---|\n|chrome.manifest 183 Defl:N 102 44% 10-07-13 14:30 aeac29ae install.rdf 1274 Defl:N 443 65% 10-07-13 14:30 f5ee7026 bootstrap.js 1796 Defl:N 695 61% 10-07-13 14:30 d5fc6c9b content/browser.xul 166 Defl:N 134 19% 10-07-13 14:30 74e9bad7 content/icon.png 66793 Defl:N 66664 0% 10-07-13 14:30 27609d6e plugins/sbd-mac 42720 Defl:N 37072 13% 10-07-13 14:30 12d19684||||||||\n\n|Name|Length|Method|Size|Ratio|Date|Time|CRC 32|\n|---|---|---|---|---|---|---|---|\n|content/ 0 Defl:N 2 0% 00-00-80 00:00 00000000 manifest.json 305 Defl:N 165 46% 00-00-80 00:00 b500a493 plugins/ 0 Defl:N 2 0% 00-00-80 00:00 d5fc6c9b 16384 Defl:N 7358 55% 00-00-80 00:00 3bd3e8bb plugins/ npplugin.dll content/icon.jpg 266948 Defl:N 245924 8% 00-00-80 00:00 b07ab7ee content/icon.png 2184 Defl:N 2189 0% 00-00-80 00:00 276fc4e2||||||||\n\n\n#### TLP: GREEN 40\n\n\n-----\n\n**Figure 16: Loading plugin**\n\nThe “plugin.js” has the following content:\n\n**Figure 17: Plugin.js**\n\nWhen an unsuspecting user visits the page with Google Chrome, they get a warning\nindicating that “Extensions, Apps and Themes” can harm their computer:\n\n**Figure 18: Chrome warning**\n\n\n#### TLP: GREEN 41\n\n\n-----\n\nThe user has to choose “Continue” in order to activate the malicious plugin. The\nplugin installation from the exploit site works for Chrome versions prior to 21, which\nwas released in Mid-2012.\n\nThe “npplugin.dll” acts as a loader for the main malware installer, which is encoded /\nobfuscated in “content/icon.jpg”. Its compilation timestamp is Thu Nov 07 11:00:03\n**2013.**\n```\nFile name: npplugin.dll\nMD5: 3299415710a29ffb55e53044fc191450\nFile size: 16384 bytes\n\n```\nAll the exploits on the server work with multi-component artifacts, some of them\ndisguised into “.jpg” files. Also, the communication to javascript functions is through\ncookies (“end_cookie_18a27”), a quite unusual method.\n\n\n#### TLP: GREEN 42\n\n\n-----\n\n#### 2.8. Victims\n\nDuring the investigation we were able to sinkhole some of the C&C servers. All\nsinkholed domains have been redirected to the Kaspersky Sinkhole server. This\nprovided detailed information regarding the location of the victims.\n\nAdditionally, some of the Command and control servers maintain a debug log which\nincludes information about the victims such as IPs and timestamps. This debug log\nfile is stored in a folder named “ClientsDirectory” and is named “log.txt”. By collecting\n“log.txt” files from various Careto C&C servers, it was possible to make a more\ndetailed map of the IPs for victims of these attacks.\n\n**Figure 19: Victims’ IPs by country**\n\nIn total, we observed over 1,000 victims’ IPs in 31 countries. We have also found\ntraces of at least 380 different victim´s IDs according to attackers´ naming schema\nboth in logs and sinkholed requests.\n\nThe following charts correspond only to sinkholed data and ignores the historical one\nretrieved in log files. This data is fresher, showing the current interest of the attackers.\n\n\n-----\n\nThe first chart shows the geographical distribution of the victim´s IDs:\n\n**Figure 20: Geographical distribution by unique ID – sinkholed data**\n\nIn this case there is a clear outlier. The reason is that there is a big cluster of victims\nin Cuba corresponding to very few IP addresses, all belonging to the same institution.\n\nThe followin chart provides the geographical location of victim´s IPs instead of Ids\nusing only sinkholed data:\n\n**Figure 21: Geographical distribution by victims' IPs - sinkholed data**\n\nIn this chart we see the opposite effect than in the previous one, in this case with\nVenezuela, where few victims use multiple IPs.\n\n\n#### TLP: GREEN 44\n\n\n-----\n\nSpain, France and Morocco are the only countries appearing in the top 5 in all cases.\n\nThe main targets of Careto fall into the following categories:\n\n  - Government institutions\n\n  - Diplomatic / embassies\n\n  - Energy, oil and gas companies\n\n  - Research\n\n  - Private equity firma\n\n  - Activists\n\n\n#### TLP: GREEN 45\n\n\n-----\n\n### 3. Attribution\n\nDifferent malware components include language artifacts from the authors,\nsuggesting they are proficient in the Spanish language. Some slang words used\nwould be very uncommon in a non native Spanish speaker.\n\nFor instance, the “appleupdt[dot]com” C&C domain has been registered by one\n“Victoria Gomez” from Argentina. The registration data appears fake, though.\n\nSpanish language artifacts include:\n\n- \"Careto - GetSystemReport v1.0\" - in the \"waiter32/64\" module\n\n- \"Unistalling Careto\" - in the CDlUninstallSGH32 module\n\n“Careto” is a Spanish slang word for “face”.\n\n- \"Caguen1aMar\" - an RC4 encryption key stored in the configuration data. Used\nfor all communications with the command and control servers.\n\nThis would be the contraction of “Me cago en la mar”, a Spanish expression meaning\n“fuck”.\n\n- \"Accept-Language: es Accept-Encoding: gzip\" - in the configuration data\n\nThe authors did a number of mistakes as well. For instance, they forgot debug\ninformation in a SGHTesterCmd module which contains a path on the developer’s\nmachine:\n\n- c:\\Dev\\CaretoPruebas3.0\\release32\\CDllUninstall32.pdb\n\n“Pruebas” means “tests” in Spanish.\n\nAlso there are some small mistakes in some English comments:\n\n//Attempt to move the uploaded file to it's new place\nUnistalling Careto\nUinstalling SGH\n\nIn the exploiting server we have found most of the subdomains simulating\nnewspapers from Spain.\n\nIt should be noted that Spanish is spoken in 21 countries, where it is either a national\nlanguage or de facto official language. We should also not exclude the possibility of a\nfalse flag operation, where the attackers intentionally planted Spanish words in order\nto confuse analysis.\n\n\n#### TLP: GREEN 46\n\n\n-----\n\n### 4. Conclusions\n\nWith Careto, we describe yet another sophisticated cyberespionage operation that\nhas been going on undiscovered for more than 5 years. In terms of sophisticated, we\nput Careto above Duqu, Gauss, RedOctober or Icefog, making it one of the most\ncomplex APT we observed.\n\nFor Careto, we observed a very high degree of professionalism in the operational\nprocedures of the group behind this attack, including monitoring of their infrastructure,\nshutdown of the operation, avoiding curious eyes through access rules, using wiping\ninstead of deletion for log files and so on. This is not very common in APT operations,\nputting the Mask into the “elite” APT groups section.\n\nThe attacks rely on a combination of social engineering, for instance impersonating\nwebsites from The Guardian and Washington Post. These are coupled with at least\none exploit that according to media report has been sold to governments as a 0-day\nby French company VUPEN.\n\nThe targeting of Linux and Mac users by the attackers indicates another important\ntrend in the world of APTs. We previously observed this and described it with Icefog;\nwe can now say with a good degree of confidence that high end APT actors are now\nexpanding their toolkits to include Linux and Mac “support”. Also, there is evidence\nthe attackers may have deployed Android and iOS backdoors as well. Unfortunately,\nwe could not locate these samples yet nor do we know how they were implanted,\nespecially considering iOS’ security model.\n\nThe fact that the Careto attackers appear to be speaking the Spanish language is\nperhaps the most unusual feature. While most of the known attacks nowadays are\nfilled with Chinese comments, languages such as German, French or Spanish\nappear very rarely in APT attacks.\n\n### Special thanks\n\nWe would like to thank OpenDNS for providing passive DNS information on the C&C\ndomains used by the attackers and support with sinkholing.\n\n\n#### TLP: GREEN 47\n\n\n-----\n\n### APPENDIX 1: Indicators of compromise\n\n#### Filenames:\n\n%system%\\objframe.dll\n%system%\\shlink32.dll\n%system%\\shlink64.dll\ncdllait32.dll\ncdllait64.dll\ncdlluninstallws32.dll\ncdlluninstallws64.dll\ncdlluninstallsgh32.dll\ncdlluninstallsgh64.dll\n%system%\\c_50225.nls\n%system%\\c_50227.nls\n%system%\\c_50229.nls\n%system%\\c_51932.nls\n%system%\\c_51936.nls\n%system%\\c_51949.nls\n%system%\\c_51950.nls\n%system%\\c_57002.nls\n%system%\\c_57006.nls\n%system%\\c_57008.nls\n%system%\\c_57010.nls\n%system%\\cdgext32.dll\n%system%\\cfgbkmgrs.dll\n%system%\\cfgmgr64.dll\n%system%\\comsvrpcs.dll\n%system%\\d3dx8_20.dll\n%system%\\dllcomm.dll\n%system%\\drivers\\wmimgr.sys\n%system%\\drvinfo.bin\n%system%\\FCache.bin\n%system%\\FFExtendedCommand.dll\n%system%\\gpktcsp32.dll\n%system%\\HPQueue.bin\n%system%\\LPQueue.bin\n%system%\\mdwmnsp.dll\n%system%\\rpcdist.dll\n%system%\\scsvrft.dll\n%system%\\sdptbw.dll\n%system%\\slbkbw.dll\n%system%\\skypeie6plugin.dll\n%system%\\wmspdmgr.dll\n%temp%\\~DF01AC74D8BE15EE01.tmp\n%temp%\\~DF23BF45A473C42B56.tmp\n%temp%\\~DFA0528CD81300F372.tmp\n%temp%\\~DF8471938479DA49221.tmp\n\n\n#### TLP: GREEN 48\n\n\n-----\n\n%appdata%\\microsoft\\c_27803.nls\n%appdata%\\microsoft\\objframe.dll\n%appdata%\\microsoft\\shmgr.dll\n\n#### Registry keys:\n\n[HKLM\\Software\\Classes\\CLSID\\{E6BB64BE-0618-4353-91930AFE606D6F0C}\\InprocServer32]\n\n#### C&C and exploit staging server IPs:\n\n190.10.9.209\n190.105.232.46\n196.40.84.94\n200.122.160.25\n202.150.211.102\n202.150.214.50\n202.75.56.123\n202.75.56.231\n202.75.58.153\n210.48.153.236\n223.25.232.161\n37.235.63.127\n75.126.146.114\n81.0.233.15\n82.208.40.11\n62.149.227.3\n75.126.146.114\n\n#### Domains and hostnames:\n\nnthost.shacknet.nu\ntunga.homedns.org\nprosoccer1.dyndns.info\nprosoccer2.dyndns.info\nnav1002.ath.cx\npininfarina.dynalias.com\nwqq.dyndns.org\npl400.dyndns.org\nservices.serveftp.org\nsv.serveftp.org\ncherry1962.dyndns.org\ncarrus.gotdns.com\nricush.ath.cx\ntakami.podzone.net\ndfup.selfip.org\nwwnav.selfip.net\nfast8.homeftp.org\n\n\n#### TLP: GREEN 49\n\n\n-----\n\nctronlinenews.dyndns.tv\nmango66.dyndns.org\ngx5639.dyndns.tv\nservices.serveftp.org\n*.redirserver.net\n*.swupdt.com\n*.msupdt.com\n*.appleupdt.com\n*.linkconf.net\n\n\n#### TLP: GREEN 50\n\n\n-----\n\n### APPENDIX 2: SGH Modules – detailed analysis\n\n**i) The “Scsimap” driver**\n\nThis driver is started by the system automatically as a service. It is responsible for\nloading the rest of the malware's components and providing communication facilities\nbetween them. It acts as a framework that glues together all the parts of the malware.\n```\nFile type: Win32 driver\nCompilation timestamp: 2013.04.09 14:15:03 (GMT)\nFile size: 14464 bytes\n\n```\nTechnical details\n\nThe file was compiled using Microsoft Visual Studio 2003.\n\nThe driver exports three functions that provide the API for the malware's kernel-mode\ncomponents:\n```\n 0001086C: IopQueryInterface\n 00010840: IopRegisterInterface\n 00010888: IopSetDeviceStatusChange\n\n```\nCreates a device: \\Device\\{E07DB02C-387E-43b2-A6F2-C59B4934B7D6}\n\nAlso creates a symbolic link to this device: \\DosDevices\\{E07DB02C-387E-43b2A6F2-C59B4934B7D6}\n\nThe “Scsimap” driver loads other modules from\n“\\SystemRoot\\System32\\bootfont.bin”, which is an encrypted virtual file system. It\ndecrypts it on the fly using RC4 and loads and executes all the additional modules\nwhich are present in that file.\n\nThe module receives commands via DeviceIoControl function. It can be commanded\nto load a binary from the “bootfont.bin” file, to write a new “bootfont.bin” configuration,\nto return the contents of that file and overwrite its contents.\n\nA typical “bootfont.bin” virtual file system contains the following driver modules:\n```\n    Module config, 8272 bytes\n    Module storage, 12240 bytes\n    Module cipher, 7248 bytes\n    Module cmprss, 2640 bytes\n    Module loaddll, 14032 bytes\n    Module PGPsdkDriver, 7504 bytes\n    Module fileflt, 32080 bytes\n    Module stopsec, 2768 bytes\n    Module TdiFlt, 17616 bytes\n    Module TdiFlt2, 18512 bytes\n\n```\n\n#### TLP: GREEN 51\n\n\n-----\n\nThe modules interact with each other by exporting and importing function pointers.\n\nEach function is identified by a numeric value. The module that provides the function\nfirst calls the function “IopRegisterInterface” exported by “scsimap”, and the\nconsumer function can request the function pointer by calling the function\nIopQueryInterface with a proper function number.\n\n**ii) Config module**\n\nThis modules operates the SGH's unified configuration data that is used by all other\ncomponents.\n\nExports the following functions:\n\n0x00 ReadConfig\n\n0x01 WriteConfig\n\nThe data is stored in the registry key:\n\n_HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\scsimap\\Params,_\n_Value_\n\nThe configuration block is encrypted with a hardcoded key using the RC4 algorithm.\n\n**iii) Storage module**\n\nThis module maintains two storage files:\n```\n    \\SystemRoot\\System32\\c_50229.nls\n    \\SystemRoot\\System32\\c_50227.nls\n\n```\nThe module receives information collected by other modules and stores them in a\nsystem activity log. Entries in the activity log are prepended with timestamps and text\nlabels (see below). These label correspond to internal and system events, i.e. writing\ncollected information to a file, starting a new process, etc.\n\nExported functions:\n\n|0x00|ReadConfig|\n|---|---|\n|0x01|WriteConfig|\n\n|0x08|Store a log entry with a label “GET”|\n|---|---|\n|0x09|Store a log entry with a label “DEL”|\n|0x0A|Store a log entry with a label “PUT” (new data collected)|\n|0x0B|Create an additional activity log file \\SystemRoot\\System32\\~{7 hex digits}.tmp|\n|0x0C|Not implemented|\n\n\n#### TLP: GREEN 52\n\n\n-----\n\n0x20 Store a log entry with a label “STOP” (system shutdown)\n\n**iv) Storage module**\n\nThis module maintains two storage files:\n```\n    \\SystemRoot\\System32\\c_50229.nls\n    \\SystemRoot\\System32\\c_50227.nls\n\n```\nThe module receives information collected by other modules and stores them in a\nsystem activity log. Entries in the activity log are prepended with timestamps and text\nlabels (see below). These label correspond to internal and system events, i.e. writing\ncollected information to a file, starting a new process, etc.\n\nExported functions:\n\n0x08 Store a log entry with a label “GET”\n\n0x09 Store a log entry with a label “DEL”\n\n0x0A Store a log entry with a label “PUT” (new data collected)\n\n0x0B Create an additional activity log file\n\\SystemRoot\\System32\\~{7 hex digits}.tmp\n\n0x0C Not implemented\n\n0x0D Not implemented\n\n0x0E Not implemented\n\n0x0F Not implemented\n\n0x15 Get internal storage state\n\n0x16 Get internal storage state\n\n0x18 Get internal storage state\n\n0x19 Store a log entry with a label “PURGE”\n\n0x1F Store a log entry with a label “START” (system startup)\n\n0x20 Store a log entry with a label “STOP” (system shutdown)\n\n|0x0D|Not implemented|\n|---|---|\n|0x0E|Not implemented|\n|0x0F|Not implemented|\n|0x15|Get internal storage state|\n|0x16|Get internal storage state|\n|0x18|Get internal storage state|\n|0x19|Store a log entry with a label “PURGE”|\n|0x1F|Store a log entry with a label “START” (system startup)|\n|0x20|Store a log entry with a label “STOP” (system shutdown)|\n\n|0x08|Store a log entry with a label “GET”|\n|---|---|\n|0x09|Store a log entry with a label “DEL”|\n|0x0A|Store a log entry with a label “PUT” (new data collected)|\n|0x0B|Create an additional activity log file \\SystemRoot\\System32\\~{7 hex digits}.tmp|\n|0x0C|Not implemented|\n|0x0D|Not implemented|\n|0x0E|Not implemented|\n|0x0F|Not implemented|\n|0x15|Get internal storage state|\n|0x16|Get internal storage state|\n|0x18|Get internal storage state|\n|0x19|Store a log entry with a label “PURGE”|\n|0x1F|Store a log entry with a label “START” (system startup)|\n|0x20|Store a log entry with a label “STOP” (system shutdown)|\n\n\n#### TLP: GREEN 53\n\n\n-----\n\n**v) Cipher module**\n\nProvides cryptographic functions for other modules.\n\nExported functions:\n\n0x10 Encrypt data with AES-128\n\n0x11 Encrypt data with AES-128\n\n0x12 Encrypt data with RC4\n\n0x13 Encrypt data with RC4\n\n**vi) Cmprss module**\n\nProvides compression functions for other modules.\n\nExported functions:\n\n0x1A Compress data with LZNT1 using the system\nRtlCompressBuffer function.\n\n0x1B Decompress data with LZNT1 using the system\nRtlDecompressBuffer function.\n\n**vii) LoadDll module**\n\nRegisters handler function for process-creation and image-load events. The module\nreads the list of DLL loading rules from the configuration block and checks them\nwhen a new process is created or a module is loaded. These rules specify the\nlocation of the DLL to be injected and the list of target process names to inject. An\nexample list of rules follows.\n```\n    DLL: System32\\vchw9x.dll targets:\n    IEXPLORE.EXE:FIREFOX.EXE:MOZILLA.EXE:OPERA.EXE:NETSCAPE.EXE:EMULE.E\n    XE:CHROME.EXE\n    DLL: none targets: @1:*SVCHOST.EXE\n    DLL: System32\\awcodc32.dll targets: EXPLORER.EXE\n    DLL: System32\\SkypeIE6Plugin.dll targets: SKYPE.EXE\n    DLL: System32\\nmwcdlog.dll targets: PCSUITE.EXE:NOKIAOVISUITE.EXE\n    DLL: System32\\awview32.dll targets: OUTLOOK.EXE\n\n```\nExported functions:\n\n0x05 Update the list of DLL loading rules in the configuration\nblock\n\n|0x10|Encrypt data with AES-128|\n|---|---|\n|0x11|Encrypt data with AES-128|\n|0x12|Encrypt data with RC4|\n|0x13|Encrypt data with RC4|\n\n|0x1A|Compress data with LZNT1 using the system RtlCompressBuffer function.|\n|---|---|\n|0x1B|Decompress data with LZNT1 using the system RtlDecompressBuffer function.|\n\n|0x05|Update the list of DLL loading rules in the configuration block|\n|---|---|\n\n\n#### TLP: GREEN 54\n\n\n-----\n\n**viii) PGPsdkDriver module**\n\nThis module is a kernel mode keylogger. It accesses the “\\Driver\\Kbdclass” object\nand intercepts the IRP_MJ_READ and IRP_MJ_PNP request handlers.\n\nOn IRP_MJ_READ requests, it reports information about pressed keys as custom\nactivity records named “KEYS”\n\n**ix) Fileflt module**\n\nIntercepts file operations and collects information and their content if they match the\nfiltration rules.\n\nMaintains the file activity log file: “\\SystemRoot\\System32\\c_50225.nls”\n\nSample filtration rules follow:\n```\n    File mask: \\ *.PAB;*.WAB\n    File mask: \\ *.WRD\n    File mask: \\ *.SKR;*.PKR;*.PGP;*.GPG;*.KEY;*.PPK;*.RDP;*.ASC\n    File mask: \\ *.DOC;*.XLS;*.RTF\n    File mask: \\ *.PDF\n    File mask: \\ *.DOCX;*.XLSX;*.WPS;*.ODT;*.WPD\n    File mask: \\ *.GMG\n    File mask: \\ *.AXX;*.CFE;*.CFD;*.AKF\n    File mask: \\ *.ENC;*.MLS;*.HSE;*.P7M;*.P7C;*.P7Z\n    File mask: \\ *.OCFS;*.M2O;*.M2R;M2F;*.M15;*.OCU\n    File mask: \\ *.VSD;*.OVPN;*.SSH;*.CRT\n    File mask: \\ *.SXW;*.SDW;*.PSW;*.ODS;*.SXC;*.SDC;*.PXL\n    File mask: \\ *.MDDATA\n    File mask: \\ *.EML\n    File mask: *\\WINNT\\ *.*\n    File mask: *\\WINDOWS\\ *.*\n    File mask: *\\PROGRAM FILES\\ *.DOC;*.XLS;*.PDF;*.RTF\n    File mask: *\\PROGRAM FILES\\ *.DOCX;*.XLSX;*.WPS;*.ODT;*.WPD\n    File mask: *\\PROGRAM\n    FILES\\ *.SXW;*.SDW;*.PSW;*.ODS;*.SXC;*.SDC;*.PXL\n    File mask: *\\HARDDISKVOLUMESHADOWCOPY *.*\n    File mask: *\\ARCHIVOS DE PROGRAMA\\ *.DOC;*.XLS;*.PDF;*.RTF\n    File mask: *\\ARCHIVOS DE PROGRAMA\\ *.DOCX;*.XLSX;*.WPS;*.ODT;*.WPD\n    File mask: *\\ARCHIVOS DE\n    PROGRAMA\\ *.SXW;*.SDW;*.PSW;*.ODS;*.SXC;*.SDC;*.PXL\n\n```\nExported functions:\n\n0x14 Update the file filtration rules\n\n0x1E Append the activity log with a new data record\n\n0x21 Append the activity log with a new data record\n\n|0x14|Update the file filtration rules|\n|---|---|\n|0x1E|Append the activity log with a new data record|\n|0x21|Append the activity log with a new data record|\n\n\n#### TLP: GREEN 55\n\n\n-----\n\n**x) Stopsec module**\n\nInteracts with the driver of Kaspersky products (“KLIF”) and tries to make own\nprocesses invisible to the anti-virus.\n\nExported functions:\n\n0x1C Try to make the process with given PID invisible to\nKaspersky Anti-Virus\n\n0x1D Not implemented, only checks input parameters\n\n**xi) TdiFlt and TdiFlt2 modules**\n\nThese modules provide facilities for intercepting network traffic. The “TdiFlt” driver\nuses the IPFILTER driver while the “TdiFlt2” uses the Windows Filtering Platform API.\n\nExported functions:\n\n0x17 Return a pointer to the instance of the main class that\nmanages the driver\n\nAlthough main components of the SGH package operate in kernel mode, there are\nseveral components injected as DLLs in user mode. It is worth noting that we have\nonly discovered a 32-bit version of the driver components while the DLL modules\nhave corresponding 64-bit counterparts.\n\n**xii) awdcxc32 module**\n\nThis library is injected into the “EXPLORER.EXE” prcess by the\nLoadDLL driver component.\n```\nFile type: PE32/PE32+ DLL\nFile location: %windows%\\System32\\awcodc32.dll\nCompilation timestamps: \n    2012.07.03 19:53:02 (GMT), \n    2012.07.03 19:55:22 (GMT), \n    2013.03.22 11:55:12 (GMT)\nFile sizes: 22016, 24576, 27136 bytes\nExports:\n 79002822: DllCanUnloadNow\n 7900282B: DllGetClassObject\nC e e m ex “{649B015F-A15F-c56b-494B-550BB6237F51}_631345_221507”\n\n```\nTechnical details\n\n|0x1C|Try to make the process with given PID invisible to Kaspersky Anti-Virus|\n|---|---|\n|0x1D|Not implemented, only checks input parameters|\n\n|0x17|Return a pointer to the instance of the main class that manages the driver|\n|---|---|\n\n\n#### TLP: GREEN 56\n\n\n-----\n\nAll the functionality is implemented in the DllMain function.\n\nConnects to the “vchw9x” component using a pipe by name taken from the\nconfiguration block (“\\\\.\\pipe\\{807BF02B-3F5F-4570-970A-8AADBAA55AC1}”) and\ncommunicates with the C&C server using that component.\n\nAll communication between the component and the server is encrypted using the\nRC4 encryption algorithm. The encryption key is read from the configuration block\nand equals to the string “Caguen1aMar” in all the configurations we discovered. It\nalso loads additional libraries specified in the configuration, i.e. “mfcn30”.\n\nThe module can execute the following commands provided by the C&C server:\n\n2 Write a new executable file to disk and optionally start it\n\n110 Update the configuration block with new C&C data: URLs, encryption\nkey\n\n113 Update the configuration block with new file filtration rules\n\n120 Write a new DLL file to disk and load it\n\nThe files received from the C&C server can be saved to the default Windows,\nTemporary or System directories, or any other location specified in the command.\n\n**xiii) mfcn30 module**\n\nThis library is loaded by “awcodc32”. It provides a framework for extending the\nmalware with additional plugins and sending the results of their data collection\nroutines to the C&C server.\n```\nFile type: PE32/PE32+ DLL\nFile location: %windows%\\System32\\mfcn30.dll\nCompilation timestamps: \n    2012.07.03 19:53:03 (GMT), \n    2012.07.03 19:55:23 (GMT), \n    2013.03.22 11:55:12 (GMT)\nFile sizes: 15872, 17920 bytes\nExports:\n    77001295: DllCanUnloadNow\n    7700129E: DllGetClassObject\n\n```\nTechnical details\n\nAll the functionality is implemented in the DllMain function.\n\nConnects to the “vchw9x” component using a pipe name from the\nconfiguration block\n\n\\\\.\\pipe\\{807BF02B-3F5F-4570-970A-8AADBAA55AC1}\n\nfor interacting with C&C server.\n\n|2|Write a new executable file to disk and optionally start it|\n|---|---|\n|110|Update the configuration block with new C&C data: URLs, encryption key|\n|113|Update the configuration block with new file filtration rules|\n|120|Write a new DLL file to disk and load it|\n\n\n#### TLP: GREEN 57\n\n\n-----\n\nThe module reads a list of additional plugin DLLs from the configuration block, loads\nthese libraries and then periodically queries them for collected information. The\nresults are sent to the C&C server via the pipe interface provided by “vchw9x”.\n\n**Figure 22: Sample list of additional plugins**\n\n**xiv) vchw9x module**\n\nThis module implements network connectivity features for the SGH\ncomponents.\n```\nFile type: PE32/PE32+ DLL\nFile location: %windows%\\System32\\vchw9x.dll\nCompilation timestamps: 2012.07.03 19:53:02 (GMT), 2012.07.03 19:55:21\n(GMT), 2013.03.22 11:55:11 (GMT)\nFile sizes: 18432, 20992, 22528 bytes\nExports:\n 78001977: DllCanUnloadNow\n 78001980: DllGetClassObject\n\n```\nTechnical details\n\nThis library is injected by the LoadDLL driver into processes from the following list:\n\nIEXPLORE.EXE NETSCAPE.EXE\nFIREFOX.EXE EMULE.EXE\nMOZILLA.EXE CHROME.EXE\nOPERA.EXE\n\nAll the functionality is implemented in the DllMain function.\n\nCreates the pipe:\n\n\\\\.\\pipe\\{807BF02B-3F5F-4570-970A-8AADBAA55AC1}\n\nand processes commands sent via this pipe by other modules.\n\nOnce a command is received, it passes the network request to Wininet functions\nand returns the results to the caller module via the same pipe.\n\n\n-----\n\n**xv) jpeg1x32 module**\n```\nFile type: PE32 DLL\nFile location: %windows%\\System32\\jpeg1x32.dll\nCompilation timestamps: 2013.04.09 14:15:17 (GMT)\nFile sizes: 31744 bytes\nExports:\n 79002656: fnProcess\n\n```\nTechnical details\n\nAll the functionality is implemented in the fnProcess function. The function receives 4\nparameters that define the module's behavior. Depending on the parameters, it can:\n\n  - Delete the SGH components specified in the configuration block, effectively\n\nuninstalling it\n\n  - Delete the registry keys corresponding to the components of SGH\n\n  - Compile a complete system report, including directory locations, hardware\n\nparameters, list of users, processes, installed programs, MAC addresses of\nnetwork adapters\n\n  - Call various functions of the “awdcxc32” module\n\n**xvi) siiw9x module**\n```\nFile type: PE32 DLL\nFile location: %windows%\\System32\\siiw9x.dll\nCompilation timestamps: 2013.03.22 11:55:13 (GMT)\nFile sizes: 15360 bytes\nExports: \n 78002078: DllEnumClass\n\n```\nTechnical details\n\nMain functionality is implemented in the DllMain function. The module waits until a\ndesktop named “screen-saver” appears and when that desktop becomes available it\ncreates another desktop named “DZ9PADXF” and launches the default browser\napplication there. This functionality may be useful for stable operation of the “vchw9x”\nmodule on rarely used computers since that module is activated only in browser\nprocesses.\n\nThe “DllEnumClass” function deletes the module or removes its name from the\nconfiguration block, depending on the Windows version.\n\n\n#### TLP: GREEN 59\n\n\n-----\n\n**xvii) SkypeIE6Plugin**\n\nIntercepts and records audio streams from Skype. We have discovered only a 32-bit\nversion of this plugin so far.\n```\nFile type: PE32 DLL\nFile location: %windows%\\System32\\SkypeIE6Plugin.dll\nCompilation timestamps: 2011.01.17 14:30:23 (GMT)\nFile sizes: 73728 bytes\n\n```\nTechnical details\n\nThe library has no exports, its functionality is implemented in the DllMain function.\nThe library hides itself by modifying the list of loaded DLL files to that its own module\nname appears to be “%windows%\\System32\\authz.dll”. It intercepts several functions\nexported by system libraries to capture sound from the infected system:\n\nkernel32.dll CreateFileW\n\ndsound.dll DirectSoundCreate, DirectSoundCreate\n\nole32.dll CoCreateInstance\n\nwinmm.dll waveInOpen, waveInClose, waveOutOpen, waveOutClose\n\nThe module uses an additional library, “%windows%\\System32\\lame_enc.dll” to\ncompress recorded audio data. The location of recorded data is specified in the\nconfiguration block.\n\n**xviii) nmwcdlog module**\n\nGathers information from Nokia mobile devices using the Nokia OVI/PC Suite API.\n```\nFile type: PE32 DLL\nFile location: %windows%\\System32\\nmwcdlog.dll\nCompilation timestamps: 2011.04.26 15:07:26 (GMT)\nFile sizes: 106496 bytes\nC e e even o jec  “Glo l\\9D14093C-8B2C-49aa-A328-35C1BDB2BC15”,\n“Glo l\\8427ACED-9495-4cb7-A13D-B98012DF6654”.\n\n```\nTechnical details\n\nThe library has no exports, its functionality is implemented in the DllMain function. It\nloads the Nokia Connectivity API libraries “ConnAPI.dll”, “DAAPI.dll” and tries to\nextract data from all available devices.\n\n|kernel32.dll|CreateFileW|\n|---|---|\n|dsound.dll|DirectSoundCreate, DirectSoundCreate|\n|ole32.dll|CoCreateInstance|\n|winmm.dll|waveInOpen, waveInClose, waveOutOpen, waveOutClose|\n\n\n#### TLP: GREEN 60\n\n\n-----\n\nThe module collects the following information:\n\n- device name\n\n- manufacturer name\n\n- model\n\n- serial number\n\n- list of contacts\n\n- calendar\n\n- bookmarks\n\n- SMS and MMS messages\n\n**xix) d3dx8_20 module**\n\nThis data collection plugin makes screenshots of the victim's desktop.\n```\nFile type: PE32/PE32+ DLL\nFile location: %windows%\\System32\\d3dx8_20.dll\nCompilation timestamps: 2011.03.25 10:49:57 (GMT), 2011.03.29 13:40:06\n(GMT)\nFile sizes: 130560, 145920 bytes.\n\n```\nTechnical details\n\nThe library has no exports, its functionality is implemented in the DllMain function. It\nmakes screenshots of the desktop and marks the position of the mouse cursor.\nAdditionally, it captures the title of the foreground window. Collected data is stored in\nmulti-volume ZIP archives and then delivered to the C&C server.\n\n**xx) WifiScan module**\n\nRetrieves the list of available Wi-Fi networks. We have discovered only a 64-bit version of\nthis plugin so far.\n```\nFile type: PE32+ DLL\nFile location: %windows%\\System32\\WifiScan.dll\nCompilation timestamps: 2011.03.23 08:04:43 (GMT)\nFile sizes: 62464 bytes.\n\n```\nTechnical details\n\nThe library has no exports, its functionality is implemented in the DllMain function. It\nuses the API provided by the library “wlanapi.dll” to retrieve information about the\nwireless networks visible to the infected machine's Wi-Fi interfaces.\n\n\n#### TLP: GREEN 61\n\n\n-----\n\n**xxi) awview32 module**\n\nThis module is injected in Microsoft Outlook processes. Collects victim's email messages.\n```\nFile type: PE32/PE32+ DLL\nFile location: %windows%\\System32\\awview32.dll\nCompilation timestamps: 2011.06.10 12:27:40 (GMT), 2011.06.10 16:46:57\n(GMT)\nFile sizes: 26624, 45056 bytes.\n\n```\nTechnical details\n\nThe library has no exports, its functionality is implemented in the DllMain function.\nThe module implements the Microsoft Outlook add-in interface and ensures it is\nrequested by hooking the OLE2 API. It receives events from the Outlook application,\ncollects the e-mail messages and writes them to the temporary directory.\n\n**xxii) CDllUninstall module**\n```\nFile type: PE32/PE32+ DLL\nFile location: non, is executed in memory\nCompilation timestamps: 2013.06.20 11:58:03 (GMT), 2013.06.20 11:58:08\n(GMT)\nFile sizes: 11264, 13824 bytes\n\n```\nTechnical details\n\nHaving its filename related to the SGH package, this module is actually a command\npackage for Careto. It is transmitted by the C&C servers as a CAB archive containing\n32-bit and 64-bit versions of its DLL and the accompanying “Meta.inf” file. The\ncontents of the archive follow:\n\n**Name** **File Size** **Date Time**\nMeta.inf 548 bytes 28.10.2013 17:20:12\nCDllUninstallSGH64.dll 13824 bytes 28.10.2013 17:20:12\nCDllUninstallSGH32.dll 11264 bytes 28.10.2013 17:20:12\n\nThe “Meta.inf” instructs the Careto instance to load the DLL appropriate for the\nsystem architecture:\n```\n#Mon Oct 28 17:20:14 GMT 2013\nDLL32_FILE_NAME=CDllUninstallSGH32.dll\nDLL64_FILE_NAME=CDllUninstallSGH64.dll\nDATE_GENERATION=20131028T172014.101\nTYPE=CMD\nCLIENT_ID=%client id%\nCMD_SEQ=0002\nINST_ID=%installation id%\nSUB_TYPE=CANNEDDLL\nTARGET_PROCESS=EXPLORER\nPRODUCT_CODE=C316\n\n```\n|Name|File Size|Date Time|\n|---|---|---|\n|Meta.inf 548 bytes 28.10.2013 17:20:12 CDllUninstallSGH64.dll 13824 bytes 28.10.2013 17:20:12 CDllUninstallSGH32.dll 11264 bytes 28.10.2013 17:20:12|||\n\n\n#### TLP: GREEN 62\n\n\n-----\n\nThe module uninstalls both Careto and SGH from the infected computer. Its internal\nname is “CDllUninstall v1.0.0\". It explicitly names the software packages with their\noriginal names by writing the following strings in the uninstallation log:\n```\n1. Unistalling SGH\n...\n2. Unistalling Careto\n\n```\nThe module contains hardcoded locations of the files that are removed and registry\nkeys to be removed or restored. For SGH, these are:\n\n_HKLM\\SYSTEM\\*ControlSet*\\Services\\scsimap_\n_%systemroot%\\System32\\bootfont.bin_\n_c:\\Windows\\System32\\bootfont.bin_\n_%systemroot%\\System32\\drivers\\scsimap.sys_\n_c:\\Windows\\System32\\drivers\\scsimap.sys_\n\nFor Careto, it first determines the location of the main module by reading the registry\nvalue from:\n\n_HKLM/HKCU\\SOFTWARE\\CLASSES\\CLSID\\{ECD4FC4D-521C-11D0-B792-_\n_00A0C90312E1}_\n\nThe main module is removed and the original registry value is restored from the\nregistry key:\n\n_SOFTWARE\\CLASSES\\CLSID\\{E6BB64BE-0618-4353-9193-_\n_0AFE606D6F0C}\\InprocServer32_\n\n\n#### TLP: GREEN 63\n\n\n-----\n\n### APPENDIX 3: C&C registration information\n\nMost of the Careto C&C hosts were registered through the free service DYN.COM.\nSome of the domains however are stand-alone .COM and .NET registration. The\nregistration data is partly visible in a few cases:\n\nDomain Name: APPLEUPDT[dot]COM\nRegistrar WHOIS Server: whois.publicdomainregistry.com\nRegistrar URL: www.publicdomainregistry.com\nUpdated Date:\nCreation Date: 25-Feb-2009\nRegistrar Registration Expiration Date: 25-Feb-2019\nRegistrar: PDR Ltd. d/b/a PublicDomainRegistry.com\nRegistrar IANA ID: 303\n[Registrar Abuse Contact Email: abuse-contact@publicdomainregistry.com](https://reversewhois.domaintools.com/?email=b753ee475870c3e09055ead90c044880)\nRegistrar Abuse Contact Phone: +1-2013775952\nDomain Status: OK\nRegistry Registrant ID: DI_9419517\nRegistrant Name: Victoria Gomez\nRegistrant Organization: N/A\nRegistrant Street: CL Esmeralda No 1332\nRegistrant City: Buenos Aires\nRegistrant State/Province: Buenos Aires\nRegistrant Postal Code: C1007A\nRegistrant Country: AR\nRegistrant Phone: +541.141311903\n[Registrant Email: victoriag150@googlemail.com](https://reversewhois.domaintools.com/?email=c3c6c3bb94c5ba815d25041eb9f90560)\n\nDomain Name: MSUPDT[dot]COM\nRegistry Domain ID: 1080338848_DOMAIN_COM-VRSN\nRegistrar WHOIS Server: whois.publicdomainregistry.com\nRegistrar URL: www.publicdomainregistry.com\nUpdated Date: 18-Jun-2013\nCreation Date: 11-Jul-2007\nRegistrar Registration Expiration Date: 11-Jul-2017\nRegistrar: PDR Ltd. d/b/a PublicDomainRegistry.com\nRegistrar IANA ID: 303\n[Registrar Abuse Contact Email: abuse-contact@publicdomainregistry.com](https://reversewhois.domaintools.com/?email=b753ee475870c3e09055ead90c044880)\nRegistrar Abuse Contact Phone: +1-2013775952\nDomain Status: clientTransferProhibited\nRegistry Registrant ID: DI_6819375\nRegistrant Name: Anne Rasmussen\nRegistrant Organization: msupdt.com\nRegistrant Street: Storgatan 21\nRegistrant City: Goteborg\nRegistrant State/Province:\nRegistrant Postal Code: 41296\n\n\n#### TLP: GREEN 64\n\n\n-----\n\nRegistrant Country: SE\nRegistrant Phone: +46.318831056\nRegistrant Phone Ext:\nRegistrant Fax: +46.318831056\n[Registrant Email: anne30@vfemail.net](https://reversewhois.domaintools.com/?email=99ec5b74165233d5e49e48eda905d55b)\nRegistry Admin ID: DI_6819375\n\nDomain Name: linkconf[dot]net\nRegistry Domain ID: 1710052877_DOMAIN_NET-VRSN\nRegistrar WHOIS Server: whois.gandi.net\nRegistrar URL: http://www.gandi.net\nUpdated Date: 2013-10-23T18:46:03Z\nCreation Date: 2012-03-30T12:12:52Z\nRegistrar Registration Expiration Date: 2017-03-30T12:12:52Z\nRegistrar: GANDI SAS\nRegistrar IANA ID: 81\n[Registrar Abuse Contact Email: abuse@support.gandi.net](https://reversewhois.domaintools.com/?email=5349ebc5d0f514a93f68574c1a646458)\nRegistrar Abuse Contact Phone: +33.170377661\nDomain Status: clientTransferProhibited\nRegistry Registrant ID:\nRegistrant Name: JOAQUIM COSTA\nRegistrant Organization:\nRegistrant Street: Rua do Carmo 26\nRegistrant City: Braga\nRegistrant State/Province:\nRegistrant Postal Code: 4700-309\nRegistrant Country: PT\nRegistrant Phone: +351.253204804\n[Registrant Email: 531becdfa3836a9be267950583190dbc-](https://reversewhois.domaintools.com/?email=0c9462fab2e55438f1a5446cea297f67)\n[1471114@contact.gandi.net](https://reversewhois.domaintools.com/?email=0c9462fab2e55438f1a5446cea297f67)\n\n\n#### TLP: GREEN 65\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        },
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        },
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        },
        {
            "id": "6825b8cb-7d82-43d2-b0b0-d51c7e255b42",
            "created_at": "2023-01-06T13:46:37.642134Z",
            "updated_at": "2023-01-06T13:46:37.642134Z",
            "deleted_at": null,
            "name": "MISPGALAXY",
            "url": "https://www.misp-project.org/galaxy.html",
            "description": "MISP Galaxy Clusters",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/aepgdq5vc2dxd2m9t0ab2v28rtwbhjua",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2014/2014.02.11_Careto_APT/unveilingthemask_v1.0.pdf",
        "https://d2538mqrb7brka.cloudfront.net/wp-content/uploads/sites/43/2018/03/20133638/unveilingthemask_v1.0.pdf"
    ],
    "report_names": [
        "unveilingthemask_v1.0",
        "unveilingthemask_v1.0.pdf"
    ],
    "threat_actors": [
        {
            "id": "67bf0462-41a3-4da5-b876-187e9ef7c375",
            "created_at": "2022-10-25T16:07:23.44832Z",
            "updated_at": "2025-03-27T02:02:09.806007Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "Careto",
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "ETDA:Careto",
            "tools": [
                "Careto"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "5d9dfc61-6138-497a-b9da-33885539f19c",
            "created_at": "2022-10-25T16:07:23.720008Z",
            "updated_at": "2025-03-27T02:02:09.944484Z",
            "deleted_at": null,
            "main_name": "Icefog",
            "aliases": [
                "ATK 23",
                "Dagger Panda",
                "Icefog",
                "Red Wendigo"
            ],
            "source_name": "ETDA:Icefog",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Dagger Three",
                "Fucobha",
                "Icefog",
                "Javafog",
                "POISONPLUG.SHADOW",
                "RoyalRoad",
                "ShadowPad Winnti",
                "XShellGhost"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "1aead86d-0c57-4e3b-b464-a69f6de20cde",
            "created_at": "2023-01-06T13:46:38.318176Z",
            "updated_at": "2025-03-27T02:00:02.803684Z",
            "deleted_at": null,
            "main_name": "DAGGER PANDA",
            "aliases": [
                "IceFog",
                "RedFoxtrot",
                "Red Wendigo",
                "PLA Unit 69010"
            ],
            "source_name": "MISPGALAXY:DAGGER PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f5bf6853-3f6e-452c-a7b7-8f81c9a27476",
            "created_at": "2023-01-06T13:46:38.677391Z",
            "updated_at": "2025-03-27T02:00:02.889755Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "MISPGALAXY:Careto",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716494,
    "ts_updated_at": 1743041395,
    "ts_creation_date": 1392052132,
    "ts_modification_date": 1392052132,
    "files": {
        "pdf": "https://archive.orkl.eu/1e4c8aef818d7d0e950974b6c9d2a792969e3a94.pdf",
        "text": "https://archive.orkl.eu/1e4c8aef818d7d0e950974b6c9d2a792969e3a94.txt",
        "img": "https://archive.orkl.eu/1e4c8aef818d7d0e950974b6c9d2a792969e3a94.jpg"
    }
}