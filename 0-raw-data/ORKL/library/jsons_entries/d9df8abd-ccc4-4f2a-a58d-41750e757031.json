{
    "id": "d9df8abd-ccc4-4f2a-a58d-41750e757031",
    "created_at": "2023-01-12T15:09:24.693433Z",
    "updated_at": "2025-03-27T02:16:26.220345Z",
    "deleted_at": null,
    "sha1_hash": "f417e3ddc497dcd1954a5b254f9102a32e226bdd",
    "title": "2021-08-27 - Anubis Android Malware Analysis",
    "authors": "",
    "file_creation_date": "2022-05-25T14:17:51Z",
    "file_modification_date": "2022-05-25T14:17:51Z",
    "file_size": 6190576,
    "plain_text": "# Anubis Android Malware Analysis\n\n**0x1c3n.tech/anubis-android-malware-analysis**\n\n[<- Home](https://0x1c3n.tech/)\n\n27 August 2021\n\n## PDF version\n\n Introduction\n\n\nAugust 27, 2021\n\n\nAnubis is one of the most well-known malware in the Android Malware family. It’s still\npopular for threat actors today, given its capabilities and the damage it has done to andorid\nusers in the past. On the other hand, it offers many Malware Developers the opportunity to\nsample their abilities to create a new malware.\n\nIt is possible to find thousands of different Anubis samples produced to date on platforms\nsuch as Koodous and Abuse.ch. Basically, we can say that Anubis consist of 2 stages. Let’s\ntake a look at these stages and what they do.\n\n## Two Stages Of Anubis\n\nThreat actors, if they plan to present the Anubis through a legit application such as Google\nPlay, they use the application we will call Dropper at this point. Dropper’s task is to download\nand install the real Anubis malware on the device from the moment it starts working. On the\nother hand, in scenarios where threat actors plan to spread Anubis through websites, fake\ncampaigns or fake gifts, we can see that they share the Anubis application directly without\nusing Dropper.\n\n## Droppers\n\nAs it seems, Droppers try to mislead their targets by imitating other popular legitimate apps\non Google Play.\n\nDropper apps should attract as little attention and be silent as possible to evade Google Play\nsecurity services. For this reason, Droppers’ abilities are very limited. It will be more than\nenough for threat actors to install Anubis on the target device in the safest way possible. So\nhow can Dropper applications install Anubis on the device? Let’s take a look at this together.\n```\nREQUEST_INSTALL_PACKAGES, the first red lights that appear with the sunrise, our hero who\n\n```\nfirst greeted us when we started our story.\n\n\n-----\n\nWith this permission Android applications can obtain the ability to install an external\napplication on the device.\n\nAnd thus, Anubis malware is successfully installed on the device. As we mentioned above,\nDroppers imitate legitimate apps on Google Play to hide themselves and gain trust. On the\nother hand, Anubis do nearly same things with Droppers. It uses the current pandemic\nprocess and the impact of this process on society in order to hide itself and gain trust.\nApplication names such as Pandemic Support, COVID-19 Support, 2000 Turkish\n**_Lira Support, Pandemic Support Application and emblems of official ministries are_**\nwidely used at this point.\n\n\n-----\n\n## Checksums\n\n\n**App**\n**Name**\n\n\nHer Aile’ye 2000 TL Pandemi Devlet Desteği\n\n\n**MD5** 9e2ebf224ef23e5d01a88e6bd06d6ad0\n\n**SHA-1** defb1558ddc36fd10050f2cd65617dce7274dc01\n\n**SHA-256** a0eb4e0e7346422d18d3421d1f185fcb2b01ac3080ab3b3bc68d67aab1f4477d\n\n## Static Analysis\n\nThe first thing we need to look at in the static analysis section will of course be the\npermissions requested by the application in `AndroidManifest.xml .`\n\n\n-----\n\nFrankly, many mobile malwares are giving themselves away at this point, we can say that\napplication permissions are just one of the cornerstones of this business. Likewise, Anubis\ngives us the chance to guess what it can do with so much power it wants, but in the following\nparts of our article, we will see that Anubis is actually a Malware that contains more than we\nthink. If we need to give an example, we can make a few statements on\n```\nRECEIVE_BOOT_COMPLETED among the permissions requested. Thanks to this reciever\n\n```\npermission, android applications can run in the background while the device is starting up\nand ensure its continuity on the device, and in the scenario we see, we realize that this\npermission is also on the list of requests by Anubis.\n\nOne of the features we are used to seeing in many mobile malware is runtime class loading.\nWhen we continue to examine our `AndroidManifest.xml file, it is possible to see that the`\nclasses that are not in the activity section are listed. From now on, it is certain that Anubis\nwill do something to load the lost classes as it starts up.\n\nThere are multiple ways to access our classes that will be loaded later, in our report we will\nrefer to class loader function hooking and manual unpacking methods. For our static\nanalysis, we will reach our classes that will be loaded later by hooking the\n```\ndalvik.system.DexClassLoader function, but in the last section, we will aim to reach\n\n```\nthese classes with manual unpacking.\n\n**BINGO!!! Our dex file, which is wanted to be loaded using the** `DexClassLoader function,`\nis right here, and the classes it contains are the lost classes that appear in the\n```\nAndroidManifest.xml we mentioned above.\n\n```\n\n-----\n\nIn fact, when we first open the hLc.json file, we realize that there are dozens of unnecessary\n```\nenum classes added for obsfucation purposes, but eybisi’s jadx fork allows us to easily\n\n```\neliminate this problem with its Hide Enum Classes feature.\n\nWhen we examine our loaded dex file and the classes in it, we are faced with many strings\nencrypted in the `parrot.ski.frog.a class.`\n\n### String Decryption\n\nLooking at our encrypted strings, we see that they all go to the `a(String str) function`\nbefore being defined to any variable. When we examine this function and code flow, we are\nfaced with a process that we are familiar with.\n\n\n-----\n\n**_RC4+BASE64_**\n\nWith our decryptor function, our encrypted string is first divided into 2 parts, the first 12\ncharacters of these parts are used as the decryption key and the remaining expression is used\nas chipertext.\n\nAfter our string, which is divided into 2 parts, is converted to the appropriate format, it is\nsent to our RC4 function.\n\nAnddd Here Is The Our RC4 Implementation Function\n\n\n-----\n\nAnubis uses these ecrytped strings that we see in runtime by decrypting them. Come on now,\nlet’s look at the contents using the script I wrote to decrypt all the strings here and when we\nlook at the outputs, we can reach more detailed information about the capabilities of Anubis,\neach of our decrypted strings here are very important, but I marked a few of the first ones\nthat caught my attention.\n\n\n-----\n\nWhen I examined the strings we decrypted, I realized that some of them were just defined\nand never used again. First, I thought that the variable that the string is connected to would\nbe a decryption result. But I couldn’t find any function of this type, then I came across\n```\nDexClassLoader in strings :D\nString str2 = this.a.du; // this.a.du = DexClassLoader\n\n```\nThe sample we examined loads the module it received from the C&C Panel with the\n```\naction=getModule&data= request in runtime using DexClassLoader and runs the class\n\n```\nit loaded with `com.example.modulebot.mod, which I encountered in strings. There are`\nmultiple unused strings inside, including those with the package names of applications such\nas Telegram, Whatsapp, Tencent, Ubercrab, Viber, Snapchat, Instagram,\n**_Twitter._**\n\n\n-----\n\nSince C&C Panel is not active, I could not examine the module to be loaded in runtime, but\nthere are many harmful activities that can be mentioned in the classes we have. To mention\nthem in order;\n\nAnubis can steal 2FA code with using Accessibility events `getText() function.`\n\nIn addition, with Accessibility privileges, Anubis can also give itself any permission it wants.\n\nHere I would like to point out a few things about the `performAction(16) function. Thanks`\nto the accessibility permission, Android applications can click the buttons that appear on the\nscreen.\n\n\n-----\n\nAfter the application starts working, it makes the necessary preparations to convert the basic\ninformation about the device and critical information such as statBanks, statCard into\nJson format.\n\nWhile examining `AndroidManifest.xml file, we saw the permissions such as` `SEND_SMS,`\n```\nREAD_SMS, RECEIVE_SMS in its content, but it seems that Anubis does not want to be\n\n```\ncontent with them. It is thought that the purpose of Anubis, which wants to be the SMS\napplication of the device, at this point is to delete the incoming messages in order not to leave\nany evidence behind.\n\n\n-----\n\nWhen Anubis first runs, it uses Shared Preferences to reuse the encrypted strings in its\ncontent.\n\n\n-----\n\nAs can be seen above, certain information is kept in the key-value data format for later\nuse.\n\nWith many functions and endless loops in Anubis content, it causes a workload on the device\nwhere it is constantly loaded. Since one of the results of this workload is high energy\nconsumption, Anubis’ developers aimed to overcome this problem with the\n```\nREQUEST_IGNORE_BATTERY_OPTIMIZATIONS permission.\n\n```\n\n-----\n\nThe application can reveal multiple amazing abilities with Accessibility permissions on the\ntarget device. For example, it can turn off Play Prottec to avoid being caught and prevent any\nattempt to delete itself from the device, again thanks to Accessibility.\n\n\n-----\n\nIn the code block we saw above, it can perform operations with 1 and 2 constants from the\n```\na() function and the performGlobalAction function. Well, if you were to ask what\n\n```\noperation these 1 and 2 correspond to, here is the answer;\n\nIn addition, we need to mention that the developers of Anubis paid attention to important\ndetails such as the Build SDK version and implemented the escape function separately for\n**lower SDK versions.**\n\n\n-----\n\nAnubis uses this code block against any deletion attempts of the user and returns the user\ndirectly to the main menu from where they are :D, it must be very annoying.\n\nAs an example, let’s examine the code block below\n\n**cE = com.android.vending:id/toolbar_item_play_protect_settings**\n**cD = com.android.vending:id/play_protect_settings**\n\n**cF = com.google.android.gms.security.settings.verifyappssettingsactivity**\n\nThanks to its accessibility ability, Anubis can infer what the user is doing on the screen at\nthat moment, and runs the `a() function directly in any scenario that will harm it. As we can`\nsee in our example code block, if it detects any of the cE / cD / cF string constants, the\nescape function `a() will run directly.`\n\n## Dynamic Analysis\n\nIn our sample, we come across the application under the name of 2000 TL Pandemic\n**_State Support for Each Family and using the emblem of the Ministry of Health of the_**\nRepublic of Turkey.\n\nWith Anubis running on the target system, we see that the first thing it wants from the user is\n**_Accessibility privileges. Because many simple but effective abilities (Clicking Buttos,_**\n**_Scorlling Pages, Reading Windows Context) that the malware basically possesses are_**\nhidden behind these powers. On the other hand, we see at the beginning of our analysis that\nAnubis also uses a way to hide its icon from the app launcher in order to make it difficult to\nremove it from the device when it starts running\n\n\n-----\n\nLet s give all permissions and examine what Anubis sent to C&C.\nSince our C&C Panel is not active during the analysis process,\nAnubis cannot receive any response from the C&C Panel.\n\n\n-----\n\nWe talked about the JSON files created during the initialization phase in static analysis.\nAnother detail I noticed during the static analysis was that Anubis encrypts the JSON files it\nprepares to send to the C&C Panel using Base64 and RC4. But I thought it would be more\n\n\n-----\n\naccurate to mention this part here. Let s see what kind of code block Anubis uses for this\nprocess.\n\nWhen I looked at the places where the RC4 implementation in the application is used, I\nnoticed that it is used in an additional place, not just for hard-coded strings. Then I started to\nexamine this structure.\n\nDo you think it is a coincidence that it is so close to JSON data :D ?\n\nAs we can see the function takes 2 Strings (str,str2). While `str2 is used as encryption key,`\n```\nstr has data in JSON format.\n\n```\n\n-----\n\n**Request Encryption RC4 Key =** `CRViysGgKzt6i`\n\n**YAY !!!**\n\n## Manual Unpacking\n\nAt the beginning of our report, we mentioned that the sample we examined loads a class in\nruntime. We hooked the `DexClassLoader function to find this loaded class. But we can`\nalso do this manually. In this way, we will discover how packers, which are used extensively\nin the Android Malware world, do this job. First, let’s look at our `AndroidManifest.xml`\nfile.\n\n\n-----\n\nAs we can see, all activities including `MAIN are called under the` `parrot package, but we`\ndon’t have the `parrot package in sight. How is this possible?`\n\nThis packer, which is widely used among Android Malwares, loads all the lost classes by\nusing the class under the application tag.\n\nAlthough it appears to be full of classes that we do not have, we actually have the first class\nthat runs and takes on the unpacking task.\n\n```\npigeon.theme.earth.IUhUkAkGfQxFbEwMiUtWuIuBrReSmPjPqEiWkAcJiSq\n\n```\n\n-----\n\nThe function 2 above the `attachBaseContext(Context context) function is the unpack`\nfunction used in this common packer :D\n\nIn addition, in this common packer type, the `PPpYrMnQwArZqXpLlNsNj variable I marked in`\nthe image above contains the name of the file to be decrypted.\n\n\n-----\n\n-----\n\n**Name Of Encryted Dex =**\n```\nhLc.json ( filename.py )\n\n```\n\n-----\n\n**_RC4 is used when decrypting the class to be loaded in this packer type. So it s time to find_**\nthe RC4 key. When we go to the class with the `liftnorth function, our goal is to find the`\n**_RC4 implementation waiting for us. It would be a reasonable idea to call 256% for this, but_**\nit tried to hide this process with a variable that holds 256 in the sample we examined.\n\nThe integer array built before the `for loop starts contains our decryption key.`\n\n\n-----\n\n-----\n\n**RC4 KEY FOR LOADED CLASS =**\n```\nfCiUMm ( rc4.py )\n\n```\n**GG !!!**\n\n\n-----\n\n## Conclusion\n\nAnubis is a malware that is worth examining in every aspect and is really impressive, this\napplication that harms tens of thousands of android users with thousands of samples around\nthe world, is a source for future android malware. I hope you liked my post, thanks for\n[reading. If you have any question, feel free to ask me on twitter 0x1c3N](https://twitter.com/0x1c3N)\n\n## References\n\n[https://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/](https://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/)\n\n[https://pentest.blog/n-ways-to-unpack-mobile-malware/](https://pentest.blog/n-ways-to-unpack-mobile-malware/)\n\nhttps://www.trendmicro.com/en_us/research/19/a/google-play-apps-drop-anubisbanking-malware-use-motion-based-evasion-tactics.html\n\nhttps://securityintelligence.com/anubis-strikes-again-mobile-malware-continues-toplague-users-in-official-app-stores/\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-27 - Anubis Android Malware Analysis.pdf"
    ],
    "report_names": [
        "2021-08-27 - Anubis Android Malware Analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536164,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653488271,
    "ts_modification_date": 1653488271,
    "files": {
        "pdf": "https://archive.orkl.eu/f417e3ddc497dcd1954a5b254f9102a32e226bdd.pdf",
        "text": "https://archive.orkl.eu/f417e3ddc497dcd1954a5b254f9102a32e226bdd.txt",
        "img": "https://archive.orkl.eu/f417e3ddc497dcd1954a5b254f9102a32e226bdd.jpg"
    }
}