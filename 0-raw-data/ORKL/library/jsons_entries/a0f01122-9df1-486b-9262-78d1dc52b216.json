{
    "id": "a0f01122-9df1-486b-9262-78d1dc52b216",
    "created_at": "2022-10-25T16:48:23.204901Z",
    "updated_at": "2025-03-27T02:06:12.975758Z",
    "deleted_at": null,
    "sha1_hash": "37a5778b1e22d7b8a585ed3458cdb244aa8e84bd",
    "title": "Microsoft Word - Blackhat Asia 2014 - A Mac OS X Rootkit uses the tricks you havent known yet - Sung-ting Tsai, Ming-chieh Pan (paper) v0.1.docx",
    "authors": "",
    "file_creation_date": "2014-03-11T20:54:44Z",
    "file_modification_date": "2014-03-11T20:54:44Z",
    "file_size": 1108499,
    "plain_text": "# You \r can’t \r see \r me: \r  A \r Mac \r OS \r X \r Rootkit \r uses \r the \r tricks \r you \r haven't \r  known yet.\n\n**Ming-­‐chieh \r Pan, \r Sung-­‐ting \r Tsai. \r Team \r T5.**\n\nContact: \r (nanika|tt)@teamt5.org\n\n## Abstract \r \n\nAttacking \r Mac \r OS \r X \r has \r become \r a \r trend \r as \r we \r see \r more \r and \r more \r malware \r with \r advanced\nattack \r techniques \r on \r Mac \r OS \r X. \r In \r order \r to \r gain \r persistent \r control \r and \r avoid \r detection,\nmalware \r have \r started \r to \r adopt \r rootkit \r tricks.\n\nWe \r will \r quickly \r review \r existing \r rootkit \r on \r Mac \r OS \r X, \r including \r both \r user \r and \r kernel \r mode, \r and\napproaches \r to \r detect \r them. \r In \r the \r major \r part \r of \r the \r presentation, \r we \r will \r disclose \r several \r new\nand \r advanced \r rootkit \r techniques \r by \r digging \r into \r more \r kernel \r objects \r and \r data \r structures. \r And\nwe \r will \r demonstrate \r how \r to \r evade \r existing \r detection \r and \r memory \r forensics \r tools, \r such \r as\nVolatility.\n\nNot \r only \r hiding \r things, \r tricks \r to \r gaining \r permission \r will \r also \r be \r discussed. \r It \r is \r not \r necessary \r to\nbe \r root \r to \r get \r into \r kernel. \r And \r also, \r we \r will \r introduce \r techniques \r to \r start \r rootkit, \r special \r way \r to\nload \r kernel \r modules, \r and \r anti-­‐tracing \r techniques.\n\nThe \r techniques \r we \r introduced \r have \r been \r tested \r on \r Mac \r OS \r X \r 10.9. \r There \r are \r new \r security\nfeatures \r to \r verify \r 3rd \r party \r kernel \r modules \r in \r OS \r X \r 10.9, \r and \r we \r will \r tell \r you \r how \r do \r we \r bypass.\n\n1\n\n\n-----\n\n### Table \r of \r Contents \r \nAbstract \r .......................................................................................................................................... \r 1\n\n1. Advanced \r Process \r Hiding \r ........................................................................................................ \r 3\n\n1.1 The \r rubilyn \r Rootkit \r ............................................................................................................ \r 3\n\n1.2 Detecting \r rubilyn \r Process \r Hiding \r ...................................................................................... \r 4\n\n1.3 Volatility \r and \r Bypass \r Volatility \r .......................................................................................... \r 4\n\n1.4 Launchd \r Magic \r .................................................................................................................. \r 5\n\n1.5 Unlink \r a \r job \r in \r Launchd \r ..................................................................................................... \r 5\n\n2. A \r Privileged \r Normal \r User \r ........................................................................................................ \r 6\n\n2.1 Running \r Privileged \r Tasks \r as \r a \r Normal \r User \r ...................................................................... \r 6\n\n2.2 Host \r Privilege \r .................................................................................................................... \r 6\n\n2.3 How \r to \r Get \r Host \r Privilege \r ................................................................................................. \r 8\n\n3. Direct \r Kernel \r Task \r Access \r (Read/Write) \r .................................................................................. \r 9\n\n3.1 Access \r Tasks \r Objects \r in \r Kernel \r from \r User \r Mode \r .............................................................. \r 9\n\n4. Bypass \r Kernel \r Module \r Verification \r in \r 10.9 \r ........................................................................... \r 10\n\n4.1 Loading \r a \r Kernel \r Module \r ................................................................................................ \r 10\n\n4.2 kext_request() \r ................................................................................................................. \r 10\n\n5. A \r Trick \r to \r Gain \r Root \r Permission \r ............................................................................................ \r 11\n\n6. Conclusion \r ............................................................................................................................. \r 12\n\n2\n\n\n-----\n\n## 1. Advanced \r Process \r Hiding \r \n\n#### 1.1 The \r rubilyn \r Rootkit \r \n\nThe \r rubilyn \r rootkit \r was \r released \r on full disclosure \r in \r 2012, \r and \r claimed \r the \r following\ncapabilities:\n\n     - It \r works \r across \r multiple \r kernel \r versions \r (tested \r 11.0.0+)\n\n     - Give \r root \r privileges \r to \r pid.\n\n     - Hide \r files \r / \r folders\n\n     - Hide \r a \r process\n\n     - Hide \r a \r user \r from \r 'who'/'w'\n\n     - Hide \r a \r network \r port \r from \r netstat\n\n     - sysctl \r interface \r for \r userland \r control\n\n     - execute \r a \r binary \r with \r root \r privileges \r via \r magic \r ICMP \r ping\n\nAlthough \r it \r is \r already \r 2 \r years \r old, \r it \r is \r still \r the \r most \r famous \r rootkit \r on \r Mac \r OS \r X.\n\nHere \r is \r the \r process \r structure \r in \r kernel:\n\nRubilyn \r uses \r a \r simple \r DKOM \r (direct \r kernel \r object \r modification) \r to \r hide \r processes. \r It \r just \r unlinks\np_list \r to \r hide \r process, \r so \r it \r is \r not \r difficult \r to \r detect \r rubilyn \r process \r hiding.\n\n3\n\n\n-----\n\n#### 1.2 Detecting \r rubilyn \r Process \r Hiding \r \n\nThere \r is \r a \r corresponding \r task \r to \r each \r process, \r and \r tasks \r are \r also \r a \r linked-­‐list \r like \r process \r list.\n\nSo \r we \r can \r easily \r detect \r rubilyn \r process \r hiding \r by \r listing \r tasks \r and \r comparing \r with \r process \r list.\nActually \r rubilyn \r can \r only \r hide \r process \r from \r ‘ps’ \r command, \r however \r using \r Active \r Monitor \r can\nsee \r process/task \r that \r hided \r by \r rubilyn.\n\n#### 1.3 Volatility \r and \r Bypass \r Volatility \r \n\nVolatility \r is \r a \r well-­‐know \r memory \r forensic \r tool. \r New \r version \r of \r Volatility \r can \r detect \r rubilyn\nrootkit.\n\nAfter \r some \r study \r on \r Volatility, \r we \r found \r that \r it \r checks \r p_list, \r p_hash, \r p_pglist, \r and \r task. \r So \r we\ncan \r unlink \r p_list, \r p_hash, \r p_pglist, \r and \r task \r list, \r then \r Volatility \r cannot \r detect \r us.\n\nDemonstration \r video: https://www.youtube.com/watch?v=_QD5YVSZz4U\n\n4\n\n\n-----\n\n#### 1.4 Launchd \r Magic \r \n\nIn \r previous \r chapters, \r we \r did \r lots \r of \r hard \r works \r in \r kernel \r in \r order \r to \r hide \r process. \r However,\nthere \r is \r a \r trick \r that \r we \r can \r easily \r find \r an \r invisible \r process \r from \r user \r mode!\n\nLaunchd \r is \r monitoring \r all \r process \r creation \r and \r termination. \r It \r maintains \r a \r job \r list \r in \r user \r mode.\n‘launchctl’ \r is \r the \r tool \r to \r communicate \r with \r launchd. \r It \r can \r easily \r list \r jobs \r like \r this:\n\n#### 1.4.1 Unlink \r a \r job \r in \r Launchd \r \n\nHere \r are \r the \r steps \r to \r unlink \r a \r job \r in \r launchd:\n\n- Get \r root \r permission.\n\n- Enumerate \r process \r launchd \r and \r get \r launchd \r task.\n\n- Read \r launchd \r memory \r and \r find \r data \r section\n\n5\n\n\n-----\n\n- Find \r root_jobmgr\n� Check \r root_jobmgr-­‐>submgrs \r and \r submgrs-­‐>parentmgr\n\n- Enumerate \r jobmgr \r and \r get \r job\n\n- Enumerate \r job \r and \r find \r the \r target \r job\n\n- Unlink \r the \r job\n\n## 2. A \r Privileged \r Normal \r User \r \n\n#### 2.1 Running \r Privileged \r Tasks \r as \r a \r Normal \r User \r \n\nFollowing \r picture \r shows \r that \r we \r can \r do \r privileged \r tasks \r as \r normal \r user:\n\nAs \r a \r normal \r user \r vm \r (uid:501), \r we \r successfully \r loaded \r a \r kernel \r module \r ‘nanika.true’. \r How \r did\nwe \r do \r this?\n\n#### 2.2 Host \r Privilege \r \n\nIn \r Mac \r OS \r X, \r when \r a \r process \r performing \r a \r task \r that \r requires \r permission, \r it \r doesn’t \r check \r uid \r of\nthe \r process, \r instead, \r it \r checks \r if \r the \r task \r is \r granted \r the \r Host \r Privilege.\n\n6\n\n\n-----\n\nHere \r is \r a \r list \r of \r the \r things \r we \r can \r do \r with \r host \r privilege:\n\nAnd \r actually \r it \r can \r have \r permission \r to \r control \r a \r tasks \r via \r these \r API:\n\n- processor_set_default\n\n- host_processor_set_priv\n\n7\n\n\n-----\n\n- processor_set_tasks\n\nHost \r privilege \r gives \r a \r process \r power \r to \r do \r a \r lot \r of \r things. \r That’s \r the \r reason \r why \r we \r can \r load \r a\nkernel \r module \r as \r a \r normal \r user.\n\n#### 2.3 How \r to \r Get \r Host \r Privilege \r \n\nThere \r are \r 3 \r ways \r to \r grant \r host \r privilege \r to \r a \r regular \r process:\n\n- Assign \r host \r privilege \r to \r a \r task\n� Parse \r mach_kernel \r and \r find \r _realhost\n� Find \r task \r structure\n� Assign \r permission: \r task-­‐>itk_host \r = \r realhost-­‐>special[2]\n� Then \r the \r task/process \r can \r do \r privilege \r things.\n\n- Hook \r system \r call \r (Global)\n� When \r process \r is \r retrieving \r the \r task \r information, \r make \r it \r return \r with \r host \r privilege.\n� Patch \r code \r (Global, \r good \r for \r rootkit)\n� Here \r is \r the \r code \r we \r are \r going \r to \r patch: \r (host_self_trap)\n\n� Patch \r code:\n\n8\n\n\n-----\n\ncall \r _host_self\nmov \r rax, \r [rax+0x20]\nmov \r rdi, \r rax\n\n## 3. Direct \r Kernel \r Task \r Access \r (Read/Write) \r \n\n#### 3.1 Access \r Tasks \r Objects \r in \r Kernel \r from \r User \r Mode \r \n\nSince \r Mac \r OS \r X \r 10.6, \r it \r restricted \r task \r access \r for \r kernel \r task. \r According \r to \r this report:\n\nHowever, \r we \r discovered \r a \r way \r to \r direct \r access \r kernel \r task \r memory. \r We \r don’t \r use\ntask_for_pid(), \r instead \r we \r use \r processor_set_tasks().\n\n- processor_set_tasks(p_default_set_control, \r &task_list, \r &task_count);\n\n- then, \r task_list[0] \r is \r the \r kernel \r task!\n\n**We \r can \r control \r all \r of \r tasks \r and \r read \r / \r write \r memory, \r even \r use \r thread_set_state() \r to \r inject**\n**dynamic \r libraries.**\n\n9\n\n\n-----\n\n## 4. Bypass \r Kernel \r Module \r Verification \r in \r 10.9 \r \n\n#### 4.1 Loading \r a \r Kernel \r Module \r \n\nIn \r Mac \r OS \r 10.9, \r if \r you \r want \r to \r load \r a \r kernel \r module \r you \r have \r to:\n\n- Put \r the \r kernel \r module \r file \r into \r /System/Library/Extensions/\n\n- Run \r kextload \r to \r load \r the \r file\n\n- If \r the \r kernel \r module \r is \r not \r signed, \r OS \r will \r pop \r up \r a \r warning \r message.\n\nYou \r can \r see \r there \r are \r many \r limitations.\n\nSurprisingly, \r we \r found \r a \r way \r to \r break \r these \r limitations. \r We \r can:\n\n- Load \r a \r kernel \r module \r from \r any \r path.\n\n- Load \r a \r kernel \r module \r on \r the \r fly, \r from \r a \r memory \r buffer, \r etc. \r File \r is \r not \r required.\n\n- Load \r a \r kernel \r module \r without \r verification. \r (no \r warning \r message)\n\n- No \r need \r to \r patch \r kextd.\n\n#### 4.2 kext_request() \r \n\nUsing \r kext_reqest() \r to \r load \r kernel \r module, \r we \r can \r bypass \r many \r verifications. \r Following \r are\nsteps \r to \r use \r kext_request():\n\n- Get \r kext \r data \r ready. \r You \r need \r to \r know \r mkext\n\n10\n\n\n-----\n\n- Get \r your \r host \r privilege. \r It \r checks \r the \r privilege.\n\n- Call \r kext_request() \r to \r load \r the \r kernel \r module.\n\n- Then \r you \r won’t \r get \r any \r problems.\n\n## 5. A \r Trick \r to \r Gain \r Root \r Permission \r \n\nWe \r mentioned \r many \r techniques \r that \r could \r be \r used \r in \r a \r rootkit. \r However, \r all \r of \r these \r tricks\nrequire \r the \r permission. \r We \r noticed \r a \r design \r problem \r that \r could \r be \r leveraged \r by \r malware \r to\ngain \r root \r permission.\n\n11\n\n\n-----\n\nAuthorization \r rights \r are \r a \r core \r part \r of \r Mac \r OS \r X's \r security. \r Rights \r determine \r who \r can \r and\ncannot \r access \r specific \r functionality. \r This \r is \r controlled \r by \r securityd. \r It \r provides \r a \r mechanism \r for\napplications \r to \r gain \r root \r permission.\n\nWhen \r an \r application \r requires \r root \r permission, \r it \r could \r send \r request \r to \r get \r specific \r right. \r For\nexample:\n\n- system.privilege.admin\n\n- system.privilege.taskport\n\n- com.apple.ServiceManagement.daemons.modify\n\n- com.apple.ServiceManagement.blesshelper\n\nThen \r user \r will \r see \r a \r pop \r up \r window \r and \r ask \r for \r password \r to \r confirm.\n\nHowever, \r one \r of \r right \r is \r interesting: \r com.apple.SoftwareUpdate.scan\n\nNo \r matter \r who \r request \r this \r right, \r user \r will \r see \r a \r window \r like \r this:\n\n“security_auth \r is \r trying \r to \r check \r for \r new \r APPLE-­‐PROVIDED \r software”. \r We \r think \r most \r of \r users\nwill \r type \r the \r password \r and \r won’t \r feel \r anything \r wrong. \r After \r typed \r the \r password, \r we \r can \r gain\nroot \r permission.\n\n## 6. Conclusion \r \n\nIn \r this \r paper, \r we \r introduced \r several \r tricks \r that \r could \r be \r used \r by \r rootkit.\n\n- Advanced \r Process \r Hiding: \r it \r could \r hide \r processes \r and \r bypass \r detection \r by \r all \r existing\nsecurity \r software.\n\n12\n\n\n-----\n\n- A \r Privileged \r Normal \r User: \r rootkit \r can \r use \r this \r trick \r to \r create \r a \r ‘normal’ \r power \r user. \r It\nwon’t \r be \r noticed \r easily.\n\n- Direct \r Kernel \r Task \r Access: \r easier \r to \r access \r process \r memory.\n\n- Loading \r Kernel \r Module \r Without \r Warnings: \r more \r flexible \r way \r to \r load \r rootkit \r modules.\n\n- A \r Trick \r to \r Gain \r Root \r Permission: \r the \r trick \r might \r be \r used \r by \r malware \r to \r gain \r the \r 1[st]\npermission.\n\n13\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "http://www.blackhat.com/docs/asia-14/materials/Tsai/WP-Asia-14-Tsai-You-Cant-See-Me-A-Mac-OS-X-Rootkit-Uses-The-Tricks-You-Havent-Known-Yet.pdf"
    ],
    "report_names": [
        "WP-Asia-14-Tsai-You-Cant-See-Me-A-Mac-OS-X-Rootkit-Uses-The-Tricks-You-Havent-Known-Yet.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716503,
    "ts_updated_at": 1743041172,
    "ts_creation_date": 1394571284,
    "ts_modification_date": 1394571284,
    "files": {
        "pdf": "https://archive.orkl.eu/37a5778b1e22d7b8a585ed3458cdb244aa8e84bd.pdf",
        "text": "https://archive.orkl.eu/37a5778b1e22d7b8a585ed3458cdb244aa8e84bd.txt",
        "img": "https://archive.orkl.eu/37a5778b1e22d7b8a585ed3458cdb244aa8e84bd.jpg"
    }
}