{
    "id": "415d99a8-d5b9-47c0-93c2-2cc4e86fbe3e",
    "created_at": "2023-01-12T15:00:06.183701Z",
    "updated_at": "2025-03-27T02:09:18.717441Z",
    "deleted_at": null,
    "sha1_hash": "93b5720c288727ec770e91f6787ca00b8d26d5eb",
    "title": "2021-11-11 - Threat Thursday- SquirrelWaffle Takes a Bite Out of Victim's Bank Accounts",
    "authors": "",
    "file_creation_date": "2022-05-28T23:17:54Z",
    "file_modification_date": "2022-05-28T23:17:54Z",
    "file_size": 1704745,
    "plain_text": "# Threat Thursday: SquirrelWaffle Takes a Bite Out of Victim's Bank Accounts\n\n**[blogs.blackberry.com/en/2021/11/threat-thursday-squirrelwaffle-loader](https://blogs.blackberry.com/en/2021/11/threat-thursday-squirrelwaffle-loader)**\n\nThe BlackBerry Research & Intelligence Team\n\n### Summary\n\nThe SquirrelWaffle loader is a relatively new piece of malware that has been delivered\nthrough malspam (malicious spam) campaigns. An unpatched vulnerability (as of Oct. 12,\n[2021) in Microsoft® Exchange Servers is being exploited by SquirrelWaffle in order to](https://www.itpro.co.uk/security/ransomware/361417/microsoft-exchange-servers-distribute-squirrelwaffle-malware)\ndistribute these emails.\n\nThis threat has been distributed in phishing campaigns via weaponized Microsoft® Office\ndocuments and Excel® sheets containing embedded malicious macros. Upon enabling\nmacros, the victim’s machine will leverage a script to reach out to a hardcoded commandand-control (C2) server in order to retrieve the malicious loader.\n\n[The malware loader has been observed distributing both the Qakbot banking Trojan and](https://blogs.blackberry.com/en/2017/05/cylance-vs-qakbot-malware)\n[Cobalt Strike stagers.](https://blogs.blackberry.com/en/2021/10/blackberry-shines-spotlight-on-evolving-cobalt-strike-threat-in-new-book)\n\n### Operating System\n\n\n-----\n\n### Risk & Impact\n\n Technical Analysis\n\nThe attack chain begins when the victim receives a phishing email pretending to be from a\nlegitimate source. The email contains a ZIP file which, when unzipped, will drop a\nMicrosoft® Word document weaponized with VBA macros.\n\n_Figure 1 - Weaponized Word document contained within ZIP file_\n\nThe Word document prompts the user to enable macros, which begins the execution chain.\nLooking at the macros contained within the OLE file, we can see that there are two:\n“AutoOpen\" and \"eFile.\"\n\n\n-----\n\n_Figure 2 - Malicious macros contained within Word document_\n\nThe presence of an AutoOpen macro is typically a red flag for potential malicious activity.\nThe AutoOpen functionality is launched immediately when macro content is enabled, rather\nthan needing to be run manually.\n\nIn this case, from analyzing the macro we can see that the AutoOpen function is being used\nto point to the eFile macro.\n\n_Figure 3 - AutoOpen function pointed at malicious macro eFile_\n\nContained within the Word doc is a UserForm object called “t2.” A UserForm object is a\nwindow or dialog box that makes up part of an application's user interface. This object t2 is\nthe DocuSign image; however, within the caption field we can see that the malicious script\n\"pin.vbs\" is stored.\n\n\n-----\n\n_Figure 4 - UserForm t2 stores VBS script in caption field of image_\n\nAs seen in Figure 5 below, the code \"bxh\" within the eFile macro is being used to extract\nthe VBS file pin.vbs, mentioned above from the UserForm object t2. Once extracted, it will\nthen write the VBS to disk in \"C:\\ProgramData\\pin.vbs.”\n\nThe eFile macro code also uses string reversal in an attempt to impede analysis. The code\ncontains a reversed copy of the string command \"cmd /k cscript.exe\nC:\\ProgramData\\pin.vbs,” which is used to launch this malicious VBS script after it has been\nextracted from the UserForm.\n\n_Figure 5 - eFile macro which is used to drop and launch malicious VBS_\n\n### SquirrelWaffle Loader\n\n\n-----\n\nThe SquirrelWaffle loader analyzed in this report is a Windows® 32-bit DLL file with the\nSHA256 of 00d045c89934c776a70318a36655dcdd77e1fedae0d33c98e301723f323f234c.\nThe malware is retrieved and loaded using the VBS script mentioned above.\n\n_Figure 6 – VBS Script containing rundll32 functionality along with commands to run_\n_SquirrelWaffle payloads_\n\nThe VBS script contains very minimal obfuscation, as can be seen in Figures 6 and 7. It\nuses a loop function and the method \"(New-Object Net.WebClient).Download” to reach out\nto five different C2 addresses in order to retrieve the malicious payload.\n\n\n-----\n\n_Figure 7 - VBS script containing C2s used to retrieve the SquirrelWaffle loader payload_\n\nRundll32 is a legitimate Windows utility that is used by this sample to connect to its C2\nservers, to download and execute the next stage payloads. This technique is known as\nliving-off-the-land (LoL), as it uses legitimate binaries already on a victim’s machine to\nperform malicious activities.\n\nThe loader uses a custom packer to hide the main payload. In order to unpack itself, the file\nexecutes a shellcode that decompresses the payload into a new location in memory, and it\nexecutes the malware. The malware is loaded using the command \"cmd/c rundll32.exe\nC:\\ProgramData\\ww1.dll,ldr.”\n\nThe goal of SquirrelWaffle is to retrieve and execute additional payloads from remote C2\nservers. This list of IP addresses and C2 URLs are encrypted using an XOR algorithm and\nstored in the \".rdata” section of the loader, along with the decryption key.\n\nAt the time of analysis, the loaders’ requests to the C2 servers did not result in further\ninfection, as these particular C2 servers are no longer active. However, the intention of the\nloader analyzed in this sample was to load a Cobalt Strike beacon called\n“RVOgDko8fnP.txt” into the %AppData%Temp folder.\n\n_Figure 8 - Cobalt Strike Beacon Loader dropped into AppData\\Temp_\n\nA copy of this file was obtained from malware-traffic-analysis.com for analysis. The file uses\nthe .TXT file extension as a measure to remain undetected on the victim’s machine. This is\nnot a text file but a PE DLL file that contains a Cobalt Strike stager.\n\nThis DLL file is used to create an HTTP connection with the C2 server 213[.]227[.]154[.]92\nover port 8080.\n\n\n-----\n\n_Figure 9 - Cobalt Stager creating connection with C2 server over port 8080_\n\nWithin the strings we can see further evidence of this functionality. The Cobalt Strike stager\nsends an HTTPS GET request to 213[.]227[.]154[.]92 with the path /jquery-3.3.1.slim.min.js.\nThe server returns a jQuery file, which contains an embedded Cobalt Strike beacon.\n\n_Figure 10 - Strings contained in Cobalt stager_\n\n### Conclusion\n\nWhile SquirrelWaffle is relatively new, it presents a lot of potential to become a mainstay in\n[the threat landscape. With the recent takedown of the Emotet botnet, there is a gap to be](https://www.wired.com/story/emotet-botnet-takedown/)\nfilled by threat actors spreading their creations via malspam.\n\nThe SquirrelWaffle loader’s versatility offers attackers an initial foothold onto the victim’s\nmachine and allows them the freedom to choose how to monetize their attack. This threat\nhas been observed delivering Cobalt Strike Beacons such as the one that was loaded by\nthe sample analyzed above, as well as Qakbot banking Trojan, as has been observed by\n[other researchers.](https://cyware.com/news/squirrelwaffle-a-new-malware-loader-in-town-35b497c4)\n\n### YARA Rule\n\nThe following YARA rule was authored by the BlackBerry Research & Intelligence Team to\ncatch the threat described in this document:\n\n\n-----\n\nimport \"pe\"\n\nrule SquirrelWaffle_Loader {\n\nmeta:\ndescription = \"Detects SquirrelWaffle Loader\"\n\nauthor = \"BlackBerry Threat Research Team\"\n\ndate = \"2021-11-01\"\n\nlicense = \"This Yara rule is provided under the Apache License 2.0\n(https://www.apache.org/licenses/LICENSE-2.0) and open to any user or organization, as\nlong as you use it under this license and ensure originator credit in any derivative to The\nBlackBerry Research & Intelligence Team\"\n\nstrings:\n\n$s1 = \"true.dll\"\n\n$s2 = \"Teachhear\"\n\n$s3 = \"RSDSpz\"\n\n$s4 = \"Actcause\"\n\n$s5 = \"c:\\\\equal\\\\True\\\\bird_Select\\\\780\\\\true.pdb\"\n\n$s6 = \"AppPolicyGetProcessTerminationMethod\"\n\n$s7 = \"LocaleNameToLCID\"\n\n$s8 = \"DHCPSAPI.DLL\"\n\ncondition:\n\n(\n\n//PE File\n\nuint16(0) == 0x5a4d and\n\n// dll\n\npe.DLL and\n// PE Sections\n\npe.number_of_sections == 5 and\n\n// Checksum is not set and does not match\n\npe.checksum != pe.calculate_checksum() and\n\n//All Strings\n\nall of ($s*) and\n\n// Imphash\n\npe.imphash() == \"1b8854882478e8ab7439d9dedeec9966\" )\n\n}\n\n### Indicators of Compromise (IoCs)\n\n\n-----\n\n**Hashes**\n\n263C3C63E2355A8B784660BF0A25EC349B1270C68F53617BD73B65DFC10EECC8\n(email zip)\n\n449FC42C5403C4F26FD123065A0FC2B834161514086A274F477D3C18D88F4238\n(doc)\n\nA71FE2BCBB17E7CCCCA5A4A7016189421147FA87646AE8C1D9599C31D9B10E79\n(VBS)\n\n00D045C89934C776A70318A36655DCDD77E1FEDAE0D33C98E301723F323F234C\n(dll)\n\n3C280F4B81CA4773F89DC4882C1C1E50AB1255E1975372109B37CF782974E96F\n(Cobalt)\n\n**C2 Servers Used to Host SquirrelWaffle Loader**\n\nhttps://priyacareers[.]com/u9hDQN9Yy7g/pt.html\nhttps://perfectdemos[.]com/Gv1iNAuMKZ/pt.html\nhttps://bussiness-z[.]ml/ze8pCNTIkrIS/pt.html\nhttps://cablingpoint[.]com/ByH5NDoE3kQA/pt.html\nhttps://bonus.corporatebusinessmachines[.co.in]/1Y0qVNce/pt.html\n\n**Domains used by the Loader for C2**\n\nperfectdemos[.]com\nbonusvulkanvegas[.]srdm[.]in\ndashboard[.]adlytic[.]ai\ncelulasmadreenmexico[.]com[.]mx\ncablingpoint[.]com\npriyacareers[.]com\nebrouteindia[.]com\nafrizam[.]360cyberlink[.]com\ntest[.]dirigu[.]ro\nassurant[.]360cyberlink[.]com\nsig[.]institutoacqua[.]org[.]br\nifiengineers[.]com\ngiasuphire[.]tddvn[.]com\ngerencial[.]institutoacqua[.]org[.]br\nbussiness-z[.]ml\n\n**File System**\n\nDiagram-721.doc (Weaponized Doc)\nPin.vbs (Malicious VBS Script)\nRVOgDko8fnP.txt (Cobalt Strike Payload)\nwww1.dll (SquirrelWaffle Payload)\nwww2.dll (SquirrelWaffle Payload)\nwww3.dll (SquirrelWaffle Payload)\nwww4.dll (SquirrelWaffle Payload)\nwww5.dll (SquirrelWaffle Payload)\n\n\n-----\n\n### BlackBerry Assistance\n\nIf you’re battling this malware or a similar threat, you’ve come to the right place, regardless\nof your existing BlackBerry relationship.\n\n[The BlackBerry Incident Response team is made up of world-class consultants dedicated to](https://www.blackberry.com/us/en/services/incident-response)\nhandling response and containment services for a wide range of incidents, including\nransomware and Advanced Persistent Threat (APT) cases.\n\nWe have a global consulting team standing by to assist you providing around-the-clock\nsupport, where required, as well as local assistance. Please contact us\nhere: https://www.blackberry.com/us/en/forms/cylance/handraiser/emergency-incidentresponse-containment\n\n### References\n\n_https://www.itpro.co.uk/security/ransomware/361417/microsoft-exchange-servers-distribute-_\n_squirrelwaffle-malware_\n\n_https://cyware.com/news/squirrelwaffle-a-new-malware-loader-in-town-35b497c4_\n\n## About The BlackBerry Research & Intelligence Team\n\nThe BlackBerry Research & Intelligence team examines emerging and persistent threats,\nproviding intelligence analysis for the benefit of defenders and the organizations they serve.\n\nBack\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-11 - Threat Thursday- SquirrelWaffle Takes a Bite Out of Victim's Bank Accounts.pdf"
    ],
    "report_names": [
        "2021-11-11 - Threat Thursday- SquirrelWaffle Takes a Bite Out of Victim's Bank Accounts.pdf"
    ],
    "threat_actors": [
        {
            "id": "e7d03ac8-7d6f-4ea0-83a9-10dff2ea1486",
            "created_at": "2022-10-25T16:07:24.158325Z",
            "updated_at": "2025-03-27T02:02:10.127249Z",
            "deleted_at": null,
            "main_name": "Scarab",
            "aliases": [
                "UAC-0026"
            ],
            "source_name": "ETDA:Scarab",
            "tools": [
                "Scieron"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9099912b-a00a-4afb-8294-c6d35af421a1",
            "created_at": "2023-01-06T13:46:39.338108Z",
            "updated_at": "2025-03-27T02:00:03.054726Z",
            "deleted_at": null,
            "main_name": "Scarab",
            "aliases": [],
            "source_name": "MISPGALAXY:Scarab",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535606,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653779874,
    "ts_modification_date": 1653779874,
    "files": {
        "pdf": "https://archive.orkl.eu/93b5720c288727ec770e91f6787ca00b8d26d5eb.pdf",
        "text": "https://archive.orkl.eu/93b5720c288727ec770e91f6787ca00b8d26d5eb.txt",
        "img": "https://archive.orkl.eu/93b5720c288727ec770e91f6787ca00b8d26d5eb.jpg"
    }
}