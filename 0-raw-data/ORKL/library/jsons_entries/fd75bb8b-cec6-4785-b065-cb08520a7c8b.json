{
    "id": "fd75bb8b-cec6-4785-b065-cb08520a7c8b",
    "created_at": "2023-01-12T15:09:50.738833Z",
    "updated_at": "2025-03-27T02:05:44.117707Z",
    "deleted_at": null,
    "sha1_hash": "b592774ec7c715df8c9d3f92903ef8184b2cdf80",
    "title": "2018-05-14 - A Deep Dive Into RIG Exploit Kit Delivering Grobios Trojan",
    "authors": "",
    "file_creation_date": "2022-05-28T16:15:57Z",
    "file_modification_date": "2022-05-28T16:15:57Z",
    "file_size": 91930,
    "plain_text": "# A Deep Dive Into RIG Exploit Kit Delivering Grobios Trojan\n\n**[fireeye.com/blog/threat-research/2018/05/deep-dive-into-rig-exploit-kit-delivering-grobios-trojan.html](https://www.fireeye.com/blog/threat-research/2018/05/deep-dive-into-rig-exploit-kit-delivering-grobios-trojan.html)**\n\nThreat Research\n\nIrshad Muhammad, Shahzad Ahmed, Hassan Faizan, Zain Gardezi\n\nMay 14, 2018\n\n7 mins read\n\nMalware\n\n[As discussed in previous blogs, exploit kit activity has been on the decline since the latter half of 2016. However,](https://www.fireeye.com/blog/threat-research/2017/10/magniber-ransomware-infects-only-the-right-people.html)\nwe do still periodically observe significant developments in this space, and we have been observing interesting\nongoing activity involving RIG Exploit Kit (EK). Although the volume of its traffic observed in-the-wild has been on\nthe decline, RIG EK remains active, with a wide range of associated crimeware payloads.\n\nIn this recent finding, RIG EK was observed delivering a Trojan named Grobios. This blog post will discuss this\nTrojan in depth with a focus on its evasion and anti-sandbox techniques, but first let’s take a quick look at the\nattack flow. Figure 1 shows the entire infection chain for the activity we observed.\n\nInfection chain\n\nFigure 1: Infection chain\n\nWe first observed redirects to RIG EK on Mar. 10, 2018, from the compromised domain, latorre[.]com[.]au, which\nhad a malicious iframe injected to it (Figure 2).\n\n\n-----\n\nMalicious Iframe injected in latorre[.]com\n\nFigure 2: Malicious Iframe injected in latorre[.]com\n\nThe iframe loads a malvertisement domain, which communicates over SSL (certificate shown in Figure 3) and\nleads to the RIG EK landing page that loads the malicious Flash file (Figure 4).\n\nMalicious SSL flow\n\nFigure 3: Malicious SSL flow\n\nRIG EK SWF download request\n\nFigure 4: RIG EK SWF download request\n\nWhen opened, the Flash file drops the Grobios Trojan. Figure 5 shows the callback traffic from the Grobios\nTrojan.\n\nGrobios callback\n\nFigure 5: Grobios callback\n\n**Analysis of the Dropped Malware**\n\nGrobios uses various techniques to evade detection and gain persistence on the machine, which makes it hard\nfor it to be uninstalled or to go inactive on the victim machine. It also uses multiple anti-debugging, anti-analysis\nand anti-VM techniques to hide its behavior. After successful installation on the victim machine, it connects to its\ncommand and control (C2) server, which responds with commands.\n\nIn an effort to evade static detection, the authors have packed the sample with PECompact 2.xx. The unpacked\nsample has no function entries in the import table. It uses API hashing to obfuscate the names of API functions it\ncalls and parses the PE header of the DLL files to match the name of a function to its hash. The malware also\nuses stack strings. Figure 6 shows an example of the malware calling WinApi using the hashes.\n\nAn example of calling WinAPI using their hashes.\n\nFigure 6: An example of calling WinAPI using their hashes.\n\n**Loading**\n\nThe malware sample starts a copy of itself, which further injects its code\ninto svchost.exe or IEXPLORE.EXE depending on the user privilege level. Both parent and child quit after\ninjection is complete. Only svchost.exe/IEXPLORE.EXE keeps running. Figure 7 shows the process tree.\n\nProcess tree of the malware\n\nFigure 7: Process tree of the malware\n\n**Persistence**\n\nThe malware has an aggressive approach to persistence. It employs the following techniques:\n\nIt drops a copy of itself into the %APPDATA% folder, masquerading as a version of legitimate software\ninstalled on the victim machine. It creates an Autorun registry key and a shortcut in the\nWindows Startup folder. During our analysis, it dropped itself to the following path:\n\n\n-----\n\n%APPDATA%\\Google\\v2.1.13554\\<RandomName>.exe.\n\nThe path can vary depending on the folders the malware finds in %APPDATA%.\n\nIt drops multiple copies of itself in subfolders of a program at the path\n%ProgramFiles%/%PROGRAMFILES(X86)%, again masquerading as a different version of the installed\nprogram, and sets an Autorun registry key or creates a scheduled task.\nIt drops a copy itself in the %Temp% folder, and creates a scheduled task to run it.\n\nOn an infected system, the malware creates two scheduled tasks, as shown in Figure 8.\n\nScheduled tasks created by the malware\n\nFigure 8: Scheduled tasks created by the malware\n\nThe malware changes the file Created, Modified, and Accessed times of all of its dropped copies to the Last\nModified time of ntdll.dll. To bypass the “File Downloaded from the Internet” warning, the malware\nremoves the :Zone.Identifier flag using DeleteFile API, as shown in Figure 9.\n\nCall to DeleteFileW to remove the :Zone.Identifier Flag from the dropped copy\n\nFigure 9: Call to DeleteFileW to remove the :Zone.Identifier Flag from the dropped copy\n\nAn interesting behavior of this malware is that it protects its copy in the %TEMP% folder using EFS (Windows\nEncrypted File System), as seen in Figure 10.\n\nCipher Command Shows the Malware Copy Protected by EFS\n\nFigure 10: Cipher Command Shows the Malware Copy Protected by EFS\n\n**Detecting VM and Malware Analysis Tools**\n\nJust before connecting to the C2, the malware does a series of checks to detect the VM and malware analysis\nenvironment. It can detect almost all well-known VM software, including Xen, QEMU, VMWare, Virtualbox,\nHyper-V, and so on. The following is the list of checks it performs on the victim system:\n\nUsing the FindWindowEx API, it checks whether any of the analysis tools in Table 1 are running on the\nsystem.\n\n**Analysis Tools**\n\nPacketSniffer\n\nFileMon\n\nWinDbg\n\nProcess Explorer\n\nOllyDbg\n\n\n-----\n\nSmartSniff\n\ncwmonitor\n\nSniffer\n\nWireshark\n\nTable 1: Analysis tools detected by malware\n\nThe malware contains a list of hashes of blacklisted process names. It checks whether the hash of any of\nrunning process matches a hash on the blacklist, as shown in Figure 11.\n\n\nCheck for blacklisted processes\n\n\nFigure 11: Check for blacklisted processes\n\nWe were able to crack the hashes of the blacklisted processes shown in Table 2.\n\n**Hash** **Process**\n\n283ADE38h vmware.exe\n\n8A64214Bh vmount2.exe\n\n13A5F93h vmusrvc.exe\n\n\n-----\n\n0F00A9026h vmsrvc.exe\n\n0C96B0F73h vboxservice.exe\n\n0A1308D40h vboxtray.exe\n\n0E7A01D35h xenservice.exe\n\n205FAB41h joeboxserver.exe\n\n6F651D58h joeboxcontrol.exe\n\n8A703DD9h wireshark.exe\n\n1F758DBh Sniffhit.exe\n\n0CEF3A27Ch sysAnalyzer.exe\n\n6FDE1C18h Filemon.exe\n\n54A04220h procexp.exe\n\n0A17C90B4h Procmon.exe\n\n7215026Ah Regmon.exe\n\n788FCF87h autoruns.exe\n\n0A2BF507Ch\n\n0A9046A7Dh\n\nTable 2: Blacklisted processes\n\nThe malware enumerates registry keys in the following paths to see if they contain the words xen or VBOX:\n\nHKLM\\HARDWARE\\ACPI\\DSDT\nHKLM\\HARDWARE\\ACPI\\FADT\nHKLM\\HARDWARE\\ACPI\\RSDT\nIt checks whether services installed on the system contain any of the keywords in Table 3:\n\nvmmouse vmdebug vmicexchange vmicshutdown vmicvss\n\nvmicheartbeat msvmmouf VBoxMouse vpcuhub vpc-s3\n\n\n-----\n\nvpcbus vmx86 vmware VMMEMCTL VMTools\n\nXenVMM xenvdb xensvc xennet6 xennet\n\nxenevtchn VBoxSF VBoxGuest\n\nTable 3: Blacklisted service names\n\nIt checks whether the username contains any of these words: MALWARE, VIRUS, SANDBOX, MALTEST\nIt has a list of hashes of blacklisted driver names. It traverses the windows\ndriver directory %WINDIR%\\system32\\drivers\\ using FindFirstFile/FindNextFile APIs to check if the hash of\nthe name of any drivers matches with that of any blacklisted driver's name, as shown in Table 4.\n\n**Hash** **Driver**\n\n0E687412Fh hgfs.sys\n\n5A6850A1h vmhgfs.sys\n\n0CA5B452h prleth.sys\n\n0F9E3EE20h prlfs.sys\n\n0E79628D7h prlmouse.sys\n\n68C96B8Ah prlvideo.sys\n\n0EEA0F1C2h prl_pv32.sys\n\n443458C9h vpcs3.sys\n\n2F337B97h vmsrvc.sys\n\n4D95FD80h vmx86.sys\n\n0EB7E0625h vmnet.sys\n\nTable 4: Hashes of blacklisted driver names\n\nIt calculates the hash of ProductId and matches it with three blacklisted hashes to detect public sandboxes,\nshown in Table 5.\n\n**Hash** **Product Id** **Sandbox Name**\n\n\n-----\n\n4D8711F4h 76487-337-8429955-22614 Anubis Sanbox\n\n7EBAB69Ch 76487-644-3177037-23510 CWSandbox\n\nD573F44D 55274-640-2673064-23950 Joe Sandbox\n\nTable 5: Blacklisted product IDs\n\nThe malware calculates the hash of loaded module (DLL) names and compares them with the list of\nhashes of blacklisted module names shown in Table 6. These are the DLLs commonly loaded into the\nprocess being debugged, such as dbhelp.dll and api_log.dll.\n\n6FEC47C1h 6C8B2973h 0AF6D9F74h 49A4A30h 3FA86C7Dh\n\nTable 6: Blacklisted module names hashes\n\nFigure 12 shows the flow of code that checks for blacklisted module hashes.\n\nCode checks for blacklisted module hashes\n\nFigure 12: Code checks for blacklisted module hashes\n\nIt checks whether Registry keys present at\nthe path HKLM\\SYSTEM\\CurrentControlSet\\Services\\Disk\\Enum and\nHKLM\\SYSTEM\\ControlSet001\\Services\\Disk\\Enum contain any of these words: QEMU, VBOX, VMWARE,\nVIRTUAL\nIt checks whether registry keys at the path HKLM\\SOFTWARE\\Microsoft, HKLM\\SOFTWARE contain\nthese words: VirtualMachine, vmware, Hyber-V\nIt checks whether the system bios version present at registry\npath HKLM\\HARDWARE\\DESCRIPTION\\System\\SystemBiosVersion contains these words: QEMU,\nBOCHS, VBOX\nIt checks whether the video bios version present at\nregistry path HKLM\\HARDWARE\\DESCRIPTION\\System\\VideoBiosVersion contains VIRTUALBOX substring.\nIt checks whether the registry key at path HKLM\\HARDWARE\\DEVICEMAP\\Scsi\\Scsi Port 0\\Scsi Bus\n0\\Target Id 0\\Logical Unit Id 0\\Identifier contains any of these words: QEMU,vbox, vmware\nIt checks whether the registry key HKLM\\SOFTWARE\\Oracle\\VirtualBox Guest Additions exists on the\nsystem.\n\n**Network Communication**\n\nThe malware contains two hardcoded obfuscated C2s. After de-obfuscating the C2 URLs, it generates a random\nstring of 20 characters, appends it to the end of URL, and sends the request for commands. Before it executes\nthe commands, the malware verifies the identity of the C2. It calculates the hash of 4 bytes of data using the\nCALG_MD5 algorithm. It then uses the Base64 data from the CERT command as a Public\nKey in CryptVerifySignature to verify the hash signature (Figure 13). If the signature is verified, the malware\nexecutes the commands.\n\nMalware verifies the C2 hash\n\nFigure 13: Malware verifies the C2 hash\n\n\n-----\n\nDuring our initial analysis, we found that the malware supports the commands shown in Table 7.\n\n**Command** **Description**\n\nCERT <Base64 data> Contains the data used to verify the identity of the C2\n\nCONNECT <IP:Port> Connect to given host for further commands\n\nDISCONNECT Close all the connections\n\nWAIT <Number of seconds> Wait for the number of seconds before executing the next commands\n\nREJECT Kind of NOP. Move on to next command after waiting for 5 second\n\nTable 7: Commands supported by malware\n\nFigure 14 shows commands being issued by the C2 server.\n\nCommands issued by the C2 server\n\nFigure 14: Commands issued by the C2 server\n\n**Conclusion**\n\nDespite the decline in activity, exploit kits still continue to put users at risk – especially those running older\nversions of software. Enterprises need to make sure their network nodes are fully patched.\n\nAll FireEye products detect the malware in our MVX engine. Additionally, [FireEye Network Security blocks](https://www.fireeye.com/solutions/nx-network-security-products.html)\ndelivery at the infection point.\n\n**Indicators of Compromise (IOCs)**\n\n30f03b09d2073e415a843a4a1d8341af\n99787d194cbd629d12ef172874e82738\n169.239.129[.]17\ngrobiosgueng[.]su\n\n**Acknowledgments**\n\nWe acknowledge Mariam Muntaha for her contribution to the blog regarding malicious traffic analysis.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-05-14 - A Deep Dive Into RIG Exploit Kit Delivering Grobios Trojan.pdf"
    ],
    "report_names": [
        "2018-05-14 - A Deep Dive Into RIG Exploit Kit Delivering Grobios Trojan.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536190,
    "ts_updated_at": 1743041144,
    "ts_creation_date": 1653754557,
    "ts_modification_date": 1653754557,
    "files": {
        "pdf": "https://archive.orkl.eu/b592774ec7c715df8c9d3f92903ef8184b2cdf80.pdf",
        "text": "https://archive.orkl.eu/b592774ec7c715df8c9d3f92903ef8184b2cdf80.txt",
        "img": "https://archive.orkl.eu/b592774ec7c715df8c9d3f92903ef8184b2cdf80.jpg"
    }
}