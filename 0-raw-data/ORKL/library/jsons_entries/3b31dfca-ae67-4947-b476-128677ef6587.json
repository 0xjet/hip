{
    "id": "3b31dfca-ae67-4947-b476-128677ef6587",
    "created_at": "2023-01-12T15:04:16.191578Z",
    "updated_at": "2025-03-27T02:09:18.216078Z",
    "deleted_at": null,
    "sha1_hash": "d25d509648e239d79112505bc58226626732ad4a",
    "title": "2022-03-29 - From the Front Lines - Hive Ransomware Deploys Novel IPfuscation Technique To Avoid Detection",
    "authors": "",
    "file_creation_date": "2022-05-28T02:33:38Z",
    "file_modification_date": "2022-05-28T02:33:38Z",
    "file_size": 3489651,
    "plain_text": "# From the Front Lines | Hive Ransomware Deploys Novel IPfuscation Technique To Avoid Detection\n\n**[sentinelone.com/blog/hive-ransomware-deploys-novel-ipfuscation-technique/](https://www.sentinelone.com/blog/hive-ransomware-deploys-novel-ipfuscation-technique/)**\n\nMarch 29, 2022\n\n**By James Haughom, Antonis Terefos, Jim Walter, Jeff Cavanaugh, Nick Fox, and Shai**\n**_Tilias_**\n\n## Overview\n\nIn a recent IR engagement, our team happened upon a rather interesting packer (aka crypter\nor obfuscator) that was ultimately utilized to construct and execute shellcode responsible for\ndownloading a Cobalt Strike Beacon. The sample at the end of this chain is not necessarily\nsophisticated or particularly novel, but it does leverage an interesting obfuscation technique\nthat we have dubbed “IPfuscation”.\n\nIn this post, we describe this novel technique as it is used across several variants of malware.\nAlong with the IPfuscation technique, we have identified a number of markers which have\nallowed us to pivot into additional discoveries around the actor or group behind this campaign.\n\n\n-----\n\n## Technical Details\n\nThe samples in question are 64-bit Windows Portable Executables, each containing an\nobfuscated payload used to deliver an additional implant. The obfuscated payload\nmasquerades itself as an array of ASCII IPv4 addresses. Each one of these IPs is passed to\nthe [RtlIpv4StringToAddressA function, which will translate the ASCII IP string to binary. The](https://docs.microsoft.com/en-us/windows/win32/api/ip2string/nf-ip2string-rtlipv4stringtoaddressa)\nbinary representation of all of these IPs is combined to form a blob of shellcode.\n\nThe general flow is:\n\n1. Iterate through “IPs” (ASCII strings)\n2. Translate “IPs” to binary to reveal shellcode\n3. Execute shellcode either by:\n\n[Proxying execution via callback param passed to EnumUILanguagesA](https://docs.microsoft.com/en-us/windows/win32/api/winnls/nf-winnls-enumuilanguagesa)\nDirect SYSCALLs\n\nUsing byte sequences, sequences of WinAPI calls, and some hardcoded metadata affiliated\nwith the malware author, we were able to identify a handful of other variants of this loader\n(hashes provided below with the IOCs), one of which we have dubbed “UUIDfuscation” and\n[was also recently reported on by Jason Reaves. A Golang Cobalt Strike loader was also](https://medium.com/walmartglobaltech/cobaltstrike-uuid-stager-ca7e82f7bb64)\ndiscovered during the investigation, which had a hardcoded source code path similar to what\nwe have already seen with the ‘IPfuscated’ samples, suggesting that the same author may be\nresponsible for both.\n\n## Tools, COTS, LOLBINs and More\n\n\n-----\n\nThe TTPs uncovered during the incident align with previous reporting of the Hive\nRansomware Affiliate Program, with the attackers having a preference for publicly available\nPenetration Testing frameworks and tooling (see TTPs table). Like many other ransomware\ngroups, pre-deployment Powershell and BAT scripts are used to prepare the environment for\ndistribution of the ransomware, while ADFind, SharpView, and BloodHound are used for\nActive Directory enumeration. Password spraying was performed with SharpHashSpray and\nSharpDomainSpray, while Rubeus was used to request TGTs. Cobalt Strike remains their\nimplant of choice, and several different Cobalt Strike loaders were identified including:\n_IPfuscated loader, Golang loader, and a vanilla Beacon DLL. Finally, GPOs and Scheduled_\nTasks are used to deploy digitally signed ransomware across the victim’s network.\n\n## IPfuscated Cobalt Strike Loader\n\nOur team discovered and analyzed a 64-bit PE\n(4fcc141c13a4a67e74b9f1372cfb8b722426513a) with a hardcoded PDB path matching the\nproject structure of a Visual Studio project.\n```\nC:\\Users\\Administrator\\source\\repos\\ConsoleApplication1\\x64\\Release\\ConsoleApplication1\n\n```\nThis particular sample leverages the IPfuscation technique. Within the binary is what appears\nto be an array of IP addresses.\n\n\n-----\n\nEach of these “IP addresses” is passed to `RtlIpv4StringToAddressA and then written to`\nheap memory.\n\n\n-----\n\nWhat is interesting is that these “IP addresses” are not used for network communication, but\ninstead represent an encoded payload. The binary representation of these IP-formatted\nstrings produced by `RtlIpv4StringToAddressA is actually a blob of shellcode.`\n\nFor example, the first hardcoded IP-formatted string is the ASCII string “252.72.131.228”,\nwhich has a binary representation of 0xE48348FC (big endian), and the next “IP” to be\ntranslated is “240.232.200.0”, which has a binary representation of 0xC8E8F0. Together, they\ncreate the below sequence of bytes.\n\nDisassembling these “binary representations” shows the start of shellcode generated by\ncommon pentesting frameworks.\n\n\n-----\n\nOnce the shellcode has finished being deobfuscated in this manner, the malware proxies\ninvocation of the shellcode by passing its address to the `EnumUILanguagesA WinAPI`\nfunction. This is achieved by supplying the shellcode address as the `UILanguageEnumProc,`\nwhich is a callback routine to be executed.\n\nThe shellcode is the common Cobalt Strike stager to download and execute Beacon. Here is\na look at the PEB traversal to find one of the modules lists, followed by the ROT13 hash being\ncalculated for target WinAPIs to execute.\n\n## Hell’s Gate Variant\n\n\n-----\n\nA handful of additional samples were found with a similar sequence of functions and static\nproperties, including the same error message. The Hell’s Gate variant\n(d83df37d263fc9201aa4d98ace9ab57efbb90922) is different from the previous sample in that\nit uses [Hell’s Gate (direct SYSCALLs) rather than](https://github.com/am0nsec/HellsGate) `EnumUILanguagesA to execute the`\ndeobfuscated shellcode. This sample’s PDB path is:\n```\nE:\\Users\\PC\\source\\repos\\HellsGate+ipv4\\x64\\Release\\HellsGate+ipv4.pdb\n\n```\nIn this variant, the IP-formatted strings are procedurally placed in local variables, rather than\nbeing looped through as seen previously.\n\n\n-----\n\n-----\n\nOnce all the IP strings have been defined within the scope of this function, memory is\nallocated with `NtAllocateVirtualMemory via a direct SYSCALL, and the deobfuscation`\nloop commences.\n\n\n-----\n\nFollowing the loop, a few SYSCALLs are made to pass control flow to the deobfuscated\nshellcode.\n\n## IPfuscation Variants\n\nAmong the discovered variants were three additional obfuscation methods using techniques\nvery similar to IPfuscation. Rather than using IPv4 addresses, the following were also found\nbeing used to hide the payload:\n\nIPfuscation – IPv6 addresses\nUUIDfuscation – UUIDs & base64 encoded UUIDs\nMACfuscation – MAC addresses\n\nHere we can see the original IPfuscated sample versus the UUID variant being translated via\n```\nUuidFromStringA .\n\n```\n\n-----\n\nThe UUID variant stores the obfuscated payload in the same manner as IPfuscated samples.\n\nThe MAC address variant translates the shellcode via `RtlEthernetStringToAdressA and`\nthen uses a callback function, a parameter to `EnumWindows, to pass control flow to the`\nshellcode. Again, the MAC addresses forming the payload are stored the same as with\nprevious variants.\n\n\n-----\n\nThe IPv6 variants operate almost identically to the original IPfuscated sample. The only\ndifference is that IPv6-style address are used, and `RtlIpv6StringToAddressA is called to`\ntranslate the string to binary data.\n\n## Golang Cobalt Strike Loader\n\nAmong other samples discovered during the incident was a Golang-compiled EXE\n(3a743e2f63097aa15cec5132ad076b87a9133274) with a reference to a source code Golang\nfile that follows the same syntax as one of the identified IPfuscated samples.\n```\n[0x0045d2c0]> iz~go~Users\n4542 0x000d62e9 0x004d78e9 27  28  .rdata ascii  \nC:/Users/76383/tmp/JzkFF.go\n\n```\n\n-----\n\n```\nGetProcAddress is called repeatedly, with 8 byte stack strings being used to form the\n\n```\nWinAPI names to be located in memory.\n\n\n-----\n\n-----\n\nThe shellcode is stored as a cleartext hexadecimal string in the `.rdata section.`\n\nThis string is read into a buffer and translated into binary, somewhat similar to the IPfuscated\nflow.\n\n\n-----\n\n-----\n\nBefore translation into binary:\n\nAfter translation into binary:\n\nControl flow is then passed to the shellcode, which is yet another Cobalt Strike stager\nattempting to download Beacon.\n\n## Conclusion\n\nOur incident response team is constantly intercepting early-use tactics, techniques and\nartifacts, with IPfuscation just the latest such technique deployed by malware authors. Such\ntechniques prove that oftentimes a creative and ingenious approach can be just as effective\nas a highly sophisticated and advanced one, particularly when enterprise defense is based on\nsecurity tools that rely on [static signatures rather than on behavioral detection.](https://www.sentinelone.com/blog/what-is-a-malware-file-signature-and-how-does-it-work/)\n\nIf you would like to learn how SentinelOne can help protect your organization regardless of\nthe attack vector, [contact us or request a](https://www.sentinelone.com/contact/) [free demo.](https://www.sentinelone.com/request-demo/)\n\n\n-----\n\n## Indicators of Compromise\n\n**SHA1** **Description**\n\nd83df37d263fc9201aa4d98ace9ab57efbb90922 IPfuscated Cobalt Strike stager (Hell’s\nGate variant)\n\n49fa346b81f5470e730219e9ed8ec9db8dd3a7fa IPfuscated Cobalt Strike stager\n\nfa8795e9a9eb5040842f616119c5ab3153ad71c8 IPfuscated Cobalt Strike stager\n\n6b5036bd273d9bd4353905107755416e7a37c441 IPfuscated Cobalt Strike stager\n\n8a4408e4d78851bd6ee8d0249768c4d75c5c5f48 IPfuscated Cobalt Strike stager\n\n49fa346b81f5470e730219e9ed8ec9db8dd3a7fa IPfuscated Cobalt Strike stager\n\n6e91cea0ec671cde7316df3d39ba6ea6464e60d9 IPfuscated Cobalt Strike stager\n\n24c862dc2f67383719460f692722ac91a4ed5a3b IPfuscated Cobalt Strike stager\n\n415dc50927f9cb3dcd9256aef91152bf43b59072 IPfuscated Cobalt Strike stager\n\n2ded066d20c6d64bdaf4919d42a9ac27a8e6f174 IPfuscated Cobalt Strike stager (Hell’s\nGate variant)\n\n27b5d056a789bcc85788dc2e0cc338ff82c57133 IPfuscated Cobalt Strike stager\n\n**SHA 256** **Description**\n\n065de95947fac84003fd1fb9a74123238fdbe37d81ff4bd2bff6e9594aad6d8b UUID\nvariant\n\n0809e0be008cb54964e4e7bda42a845a4c618868a1e09cb0250210125c453e65 UUID\nvariant\n\n12d2d3242dab3deca29e5b31e8a8998f2a62cea29592e3d2ab952fcc61b02088 UUID\nvariant\n\n130c062e45d3c35ae801eb1140cbf765f350ea91f3d884b8a77ca0059d2a3c54 UUID\nvariant\n\n39629dc6dc52135cad1d9d6e70e257aa0e55bd0d12da01338306fbef9a738e6b UUID\nvariant\n\n5086cc3e871cf99066421010add9d59d321d76ca5a406860497faedbb4453c28 UUID\nvariant\n\n56c5403e2afe4df8e7f98fd89b0099d0e2f869386759f571de9a807538bad027 UUID\nvariant\n\n\n-----\n\n60cfce921a457063569553d9d43c2618f0b1a9ab364deb7e2408a325e3af2f6f UUID\nvariant\n\n6240193f7c84723278b9b5e682b0928d4faf22d222a7aa84556c8ee692b954b0 UUID\nvariant\n\n6a222453b7b3725dcf5a98e746f809e02af3a1bd42215b8a0d606c7ce34b6b2b UUID\nvariant\n\n6bdd253f408a09225dee60cc1d92498dac026793fdf2c5c332163c68d0b44efd UUID\nvariant\n\n9c90c72367526c798815a9b8d58520704dc5e9052c41d30992a3eb13b6c3dd94 UUID\nvariant\n\n9cd407ea116da2cda99f7f081c9d39de0252ecd8426e6a4c41481d9113aa523e UUID\nvariant\n\na586efbe8c627f9bb618341e5a1e1cb119a6feb7768be076d056abb21cc3db66 UUID\nvariant\n\nc384021f8a68462348d89f3f7251e3483a58343577e15907b5146cbd4fa4bd53 UUID\nvariant\n\nc76671a06fd6dd386af102cf2563386060f870aa8730df0b51b72e79650e5071 UUID\nvariant\n\ne452371750be3b7c88804ea5320bd6a2ac0a7d2c424b53a39a2da3169e2069e9 UUID\nvariant\n\ne9bb47f5587b68cd725ab4482ad7538e1a046dd41409661b60acc3e3f177e8c4 UUID\nvariant\n\ne9da9b5e8ebf0b5d2ea74480e2cdbd591d82cd0bdccbdbe953a57bb5612379b0 UUID\nvariant\n\nefbdb34f208faeaebf62ef11c026ff877fda4ab8ab31e99b29ff877beb4d4d2b UUID\nvariant\n\nf248488eedafbeeb91a6cfcc11f022d8c476bd53083ac26180ec5833e719b844 UUID\nvariant\n\ne61ecd6f2f8c4ba8c6f135505005cc867e1eea7478a1cbb1b2daf22de25f36ce MAC\nAddress\nVariant\n\nf07a3c6d9ec3aeae5d51638a1067dda23642f702a7ba86fc3df23f0397047f69 MAC\nAddress\nVariant\n\n7667d0e90b583da8c2964ba6ca2d3f44dd46b75a434dc2b467249cd16bf439a0 IPv6 Variant\n\n\n-----\n\n75244059f912d6d35ddda061a704ef3274aaa7fae41fdea2efc149eba2b742b3 x86 IPv4\nVariant\n\n7e8dd90b84b06fabd9e5290af04c4432da86e631ab6678a8726361fb45bece58 x86 IPv4\nVariant\n\n**C2** **Description**\n\n103.146.179.89 Cobalt Strike server\n\nservice-5inxpk6g-1304905614.gz.apigw.tencentcs[.]com Cobalt Strike server\n\nservice-kibkxcw1-1305343709.bj.apigw.tencentcs[.]com:80 Cobalt Strike server\n\n103.146.179.89 Cobalt Strike server\n\n1.15.80.102 Cobalt Strike server\n\n175.178.62.140 Cobalt Strike server\n\n84.32.188.238 Cobalt Strike server\n\n## YARA Rules\n\n\n-----\n\n```\nimport pe \nrule IPfuscatedCobaltStrike\n{\n     meta:\n          description = \"IPfuscated Cobalt Strike shellcode\" \n          author = \"James Haughom @ SentinelLabs\"\n          date = \"2022-3-24\"\n          hash = \"49fa346b81f5470e730219e9ed8ec9db8dd3a7fa\"\n          reference = \"https://s1.ai/ipfuscation\"\n     strings:\n          /*\n              This rule will detect IPfuscated Cobalt Strike shellcode\n              in PEs.\n              For example:\n                   IPfuscated    | binary representation | instruction\n                   ++++++++++++++++++++++++++++++++++++++++++++++++++++++\n                   \"252.72.131.228\" | 0xE48348FC      | CLD ...\n                   \"240.232.200.0\" | 0xC8E8F0       | CALL ... \n          */\n          $ipfuscated_payload_1 = \"252.72.131.228\"\n          $ipfuscated_payload_2 = \"240.232.200.0\"\n          $ipfuscated_payload_3 = \"0.0.65.81\"\n          $ipfuscated_payload_4 = \"65.80.82.81\"\n          $ipfuscated_payload_5 = \"86.72.49.210\"\n          $ipfuscated_payload_6 = \"101.72.139.82\"\n          $ipfuscated_payload_7 = \"96.72.139.82\"\n          $ipfuscated_payload_8 = \"24.72.139.82\"\n          $ipfuscated_payload_9 = \"32.72.139.114\"\n          $ipfuscated_payload_10 = \"80.72.15.183\"\n          $ipfuscated_payload_11 = \"74.74.77.49\"\n          $ipfuscated_payload_12 = \"201.72.49.192\"\n          $ipfuscated_payload_13 = \"172.60.97.124\"\n          $ipfuscated_payload_14 = \"2.44.32.65\"\n          $ipfuscated_payload_15 = \"193.201.13.65\"\n          $ipfuscated_payload_16 = \"1.193.226.237\"\n          $ipfuscated_payload_17 = \"82.65.81.72\"\n          $ipfuscated_payload_18 = \"139.82.32.139\"\n          $ipfuscated_payload_19 = \"66.60.72.1\"\n          $ipfuscated_payload_20 = \"208.102.129.120\"\n     condition:\n          // sample is a PE\n          uint16(0) == 0x5A4D and uint32(uint32(0x3C)) == 0x00004550 and\n          5 of ($ipfuscated_payload_*)\n}\nrule IPfuscationEnumUILanguages\n{\n     meta:\n          description = \"IPfuscation with execution via EnumUILanguagesA\"\n          author = \"James Haughom @ SentinelLabs\"\n          date = \"2022-3-24\"\n          hash = \"49fa346b81f5470e730219e9ed8ec9db8dd3a7fa\"\n\n```\n\n-----\n\n```\n          reference https://s1.ai/ipfuscation \n     strings:\n          // hardcoded error string in IPfuscated samples\n          $err_msg = \"ERROR!\"\n     condition:\n          // sample is a PE\n          uint16(0) == 0x5A4D and uint32(uint32(0x3C)) == 0x00004550 and\n          $err_msg and\n          // IPfuscation deobfuscation\n          pe.imports(\"ntdll.dll\", \"RtlIpv4StringToAddressA\") and\n          // shellcode execution\n          pe.imports (\"kernel32.dll\", \"EnumUILanguagesA\")\n}\nrule IPfuscationHellsGate\n{\n     meta:\n          description = \"IPfuscation with execution via Hell's Gate\"\n          author = \"James Haughom @ SentinelLabs\"\n          date = \"2022-3-24\"\n          hash = \"d83df37d263fc9201aa4d98ace9ab57efbb90922\"\n          reference = \"https://s1.ai/ipfuscation\"\n     strings:\n          $err_msg = \"ERROR!\"\n          /*\n              Hell's Gate / direct SYSCALLs for calling system routines\n              4C 8B D1        mov   r10, rcx\n              8B 05 36 2F 00 00   mov   eax, cs:dword_140005000\n              0F 05         syscall       \n              C3           retn\n          */\n          $syscall = { 4C 8B D1 8B 05 ?? ?? 00 00 0F 05 C3 }\n          /*\n              SYSCALL codes are stored in global variable\n              C7 05 46 2F 00 00 00 00 00 00   mov   cs:dword_140005000,\n0\n              89 0D 40 2F 00 00         mov   cs:dword_140005000,\necx\n              C3                 retn\n          */\n          $set_syscall_code = {C7 05 ?? ?? 00 00 00 00 00 00 89 0D ?? ?? 00 00\nC3}\n     condition:\n          // sample is a PE\n          uint16(0) == 0x5A4D and uint32(uint32(0x3C)) == 0x00004550 and\n          all of them and\n          // IPfuscation deobfuscation\n          pe imports(\"ntdll dll\" \"RtlIpv4StringToAddressA\")\n\n```\n\n-----\n\n```\n}\nrule IPfuscatedVariants\n{\n  meta:\n     author = \"@Tera0017/@SentinelOne\"\n     description = \"*fuscation variants\"\n     date = \"2022-3-28\"\n     hash = \"2ded066d20c6d64bdaf4919d42a9ac27a8e6f174\"\n     reference = \"https://s1.ai/ipfuscation\"\n  strings:\n     // x64 Heap Create/Alloc shellcode\n     $code1 = {33 D2 48 8B [2-3] FF 15 [4] 3D 0D 00 00 C0}\n     // x64 RtlIpv4StringToAddressA to shellcode\n     $code2 = {B9 00 00 04 00 FF [9] 41 B8 00 00 10 00}\n  condition:\n     any of them\n}\n\n## MITRE ATT&CK – Hive Ransomware Gang\n\n```\n**TTP** **Description** **MITRE ID**\n\nBAT/Powershell scripts Automate pre-ransomware deployment actions T1059\n\nScheduled Tasks Execute the ransomware payload T1053\n\nCobalt Strike Primary implant / backdoor S0154\n\nADFind Active Directory enumeration S0552 /\nT1087\n\nSharpHashSpray Password spraying T1110.003\n\nDomainHashSpray Password spraying T1110.003\n\nBloodhound/SharpHound Active Directory enumeration S0521 /\nT1087\n\nSigned Ransomware Ransomware payload is digitally signed T1587.002\n\nDomain Policy GPO Deploy ransomware via GPO T1484\n\n\nNet-GPPPassword Steal cleartext passwords from Group Policy\nPreferences\n\n\nT1552.006\n\n\nRubeus Request Kerberos Ticket Granting Tickets T1558\n\nSharpview Active Directory enumeration T1087\n\nRDP Lateral movement via RDP T1021.001\n\n\n-----\n\nSAM Dump Credential theft T1003.002\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-29 - From the Front Lines - Hive Ransomware Deploys Novel IPfuscation Technique To Avoid Detection.pdf"
    ],
    "report_names": [
        "2022-03-29 - From the Front Lines - Hive Ransomware Deploys Novel IPfuscation Technique To Avoid Detection.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535856,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653705218,
    "ts_modification_date": 1653705218,
    "files": {
        "pdf": "https://archive.orkl.eu/d25d509648e239d79112505bc58226626732ad4a.pdf",
        "text": "https://archive.orkl.eu/d25d509648e239d79112505bc58226626732ad4a.txt",
        "img": "https://archive.orkl.eu/d25d509648e239d79112505bc58226626732ad4a.jpg"
    }
}