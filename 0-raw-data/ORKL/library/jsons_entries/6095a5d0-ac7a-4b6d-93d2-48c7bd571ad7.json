{
    "id": "6095a5d0-ac7a-4b6d-93d2-48c7bd571ad7",
    "created_at": "2022-10-25T16:48:16.002752Z",
    "updated_at": "2025-03-27T02:05:59.534179Z",
    "deleted_at": null,
    "sha1_hash": "9e3057bfa16352f56a7d026fac330e3a1487b861",
    "title": "Metamorfo Campaigns Targeting Brazilian Users « Metamorfo Campaigns Targeting Brazilian Users | FireEye Inc",
    "authors": "",
    "file_creation_date": "2018-04-25T15:23:10Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 2063110,
    "plain_text": "[Home](https://www.fireeye.com/)  [FireEye Blogs](https://www.fireeye.com/blog.html)  [Threat Research](https://www.fireeye.com/blog/threat-research.html)  Metamorfo Campaigns Targeting Brazilian Users\n\n\n# Metamorfo Campaigns Targeting Brazilian Users\n\n[April 24, 2018 | by Edson Sierra, Gerardo Iglesias](https://www.fireeye.com/blog/threat-research.html/category/etc/tags/fireeye-blog-authors/edson-sierra)\n\nFireEye Labs recently identified several widespread malspam (malware spam)\n\ncampaigns targeting Brazilian companies with the goal of delivering banking Trojans.\n\nWe are referring to these campaigns as Metamorfo. Across the stages of these\n\ncampaigns, we have observed the use of several tactics and techniques to evade\n\ndetection and deliver the malicious payload. In this blog post we dissect two of the main\n\ncampaigns and explain how they work.\n\n## Campaign #1\n\nThe kill chain starts with an email containing an HTML attachment with a refresh tag that\n\nuses a Google URL shortener as the target. Figure 1 shows a sample email, and Figure 2\n\nshow the contents of the HTML file.\n\n\n-----\n\nFigure 1: Malicious Email with HTML Attachment\n\nFigure 2: Contents of HTML File\n\nWhen the URL is loaded, it redirects the victim to a cloud storage site such as GitHub,\n\nDropbox, or Google Drive to download a ZIP file. An example is shown in Figure 3.\n\nFigure 3: URL Shortener Redirects to Github Link\n\nThe ZIP archive contains a malicious portable executable (PE) file with embedded HTML\n\napplication (HTA). The user has to unzip the archive and double-click the executable for\nthe infection chain to continue. The PE file is a simple HTA script compiled into an\n\nexecutable. When the user double-clicks the executable, the malicious HTA file is\nextracted to %temp% and executed by mshta.exe.\n\nThe HTA script (Figure 4) contains VBS code that fetches a second blob of VBS code\nencoded in base64 form from hxxp://<redacted>/ilha/pz/logs.php.\n\n\n-----\n\nFigure 4: Contents of HTA File\n\nAfter the second stage of VBS is decoded (Figure 5 and Figure 6), the script downloads\n\nthe final stage from hxxp://<redacted>/28022018/pz.zip.\n\n\n-----\n\nFigure 6: More Contents of Decoded VBS\n\nThe downloaded ZIP file contains four files. Two are PE files. One is a legitimate\nWindows tool, pvk2pfx.exe, that is abused for DLL side-loading. One is the malicious\n\nbanking Trojan as the DLL.\n\nThe VBS code unzips the archive, changes the extension of the legitimate Windows tool\nfrom .png to .exe, and renames the malicious DLL as cryptui.dll. The VBS code also\ncreates a file in C:\\Users\\Public\\Administrador\\car.dat with random strings. These\nrandom strings are used to name the Windows tool, which is then executed. Since this\ntool depends on a legitimate DLL named cryptui.dll, the search order path will find the\n\nmalicious Trojan with the same name in the same directory and load it into its process\nspace.\n\nIn Q4 of 2017, a similar malspam campaign delivered the same banking Trojan by using\nan embedded JAR file attached in the email instead of an HTML attachment. On\nexecution, the Java code downloaded a ZIP archive from a cloud file hosting site such as\nGoogle Drive, Dropbox, or Github. The ZIP archive contained a legitimate Microsoft tool\nand the malicious Trojan.\n\n### Banking Trojan Analysis\n\nThe Trojan expects to be located in the hardcoded directory\nC:\\\\Users\\\\Public\\Administrador\\\\ along with three other files to start execution. As\nseen in Figure 7, these files are:\n\ncar.dat (randomly generated name given to Windows tool)\n\n\n-----\n\nFigure 7: Contents of ZIP Archive\n\n### Persistence\n\nThe string found in the file C:\\\\Users\\\\Public\\\\Administrador\\\\car.dat is extracted and\nused to add the registry key Software\\Microsoft\\Windows\\CurrentVersion\\Run\\<string\nfrom car.dat> for persistence, as shown in Figure 8.\n\nFigure 8: Reading from car.dat File\n\n\n-----\n\nFigure 9: Persistence Keys\n\nThe VBS code in this file (Figure 10) has the ability to recreate the whole chain and\ndownload the same ZIP archive.\n\nFigure 10: Contents of VBS Script\n\nNext, the Trojan searches for several folders in the Program Files directories, including:\n\nC:\\\\Program Files\\\\AVG\nC:\\\\Program Files\\\\AVAST Software\nC:\\\\Program Files\\\\Diebold\\\\Warsaw\nC:\\\\Program Files\\\\Trusteer\\\\Rapport\nC:\\\\Program Files\\\\Java\nC:\\\\Program Files (x86)\\\\scpbrad\n\n\n-----\n\nformat shown in Figure 11. The value of AT is <host_name+OS&MD> <list of folders\nfound>”.\n\nFigure 11: Network Traffic for Host Enumeration\n\nThe sample iterates through the running processes, kills the following, and prevents them\nfrom launching:\n\nmsconfig.exe\nTASKMGR.exe\nregedit.exe\n\nccleaner64.exe\ntaskmgr.exe\nitauaplicativo.exe\n\nNext, it uses GetForegroundWindow to get a handle to the window the user is viewing\nand GetWindowText to extract the title of the window. The title is compared against a\n\nhardcoded list of Brazilian banking and digital coin sites. The list is extensive and\nincludes major organizations and smaller entities alike.\n\nIf any of those names are found and the browser is one of the following, the Trojan will\nterminate that browser.\n\nfirefox.exe\nchrome.exe\nopera.exe\n\n\n-----\n\n(Figure 12). The screenshots are continuously saved as .jpg images.\n\nFigure 12: Malware Capturing Mouse Clicks\n\n### Command and Control\n\nThe command and control (C2) server is selected based on the string in the file “id”:\n\nal -> '185.43.209[.]182'\ngr -> '212.237.46[.]6'\n\npz -> '87.98.146[.]34'\nmn -> ’80.211.140[.]235'\n\nThe connection to one of the hosts is then started over raw TCP on port 9999. The\ncommand and control communication generally follows the pattern <|Command |>, for\n\nexample:\n\n'<|dispida|>logs>SAVE<' sends the screenshots collected in gh.txt.\n\n'<PING>' is sent from C2 to host, and '<PONG>' is sent from host to C2, to keep the\nconnection alive.\n\n'<|INFO|>' retrieves when the infection first started based on the file timestamp\n\n\n-----\n\nthis particular campaign.\n\nFigure 13: Command and Control Server Open Directories\n\nInside the open directories, we were able to get the following directories corresponding\nto the different active campaigns. Inside each directory we could find statistics with the\n\nnumber of victims reporting to the C2. As of 3/27/2018, the numbers were:\n\nal – 843\n\nap – 879\ngr – 397\n\nkk – 2,153\nmn – 296\n\npz – 536\n\ntm – 187\n\nA diagram summarizing Campaign #1 is shown in Figure 14.\n\n\n-----\n\nFigure 14: Infection Chain of Campaign #1\n\n## Campaign #2\n\nIn the second campaign, FireEye Labs observed emails with links to legitimate domains\n\n(such as hxxps://s3-ap-northeast1.amazonaws[.]com/<redacted>/Boleto_Protesto_Mes_Marco_2018.html) or\n\ncompromised domains (such as hxxps://curetusu.<redacted>-industria[.]site/) that use a\n\nrefresh tag with a URL shortener as the target. The URL shortener redirects the user to an\nonline storage site, such as Google Drive, Github, or Dropbox, that hosts a malicious ZIP\n\nfile. A sample phishing email is shown in Figure 15.\n\n\n-----\n\nFigure 15: Example Phishing Email\n\nThe ZIP file contains a malicious executable written in AutoIt (contents of this executable\nare shown in Figur 16). When executed by the user, it drops a VBS file to a randomly\n\ncreated and named directory (such as C:\\mYPdr\\TkCJLQPX\\HwoC\\mYPdr.vbs) and\nfetches contents from the C2 server.\n\nFigure 16: Contents of Malicious AutoIt Executable\n\nTwo files are downloaded from the C2 server. One is a legitimate Microsoft tool and the\nother is a malicious DLL:\n\nhttps[:]//panel-dark[.]com/w3af/img2.jpg\nhttps[:]//panel-dark[.]com/w3af/img1.jpg\n\nThose files are downloaded and saved into random directories named with the following\n\npatterns:\n\n<current user dir>\\<5 random chars>\\<8 random chars>\\<4 random chars>\\<5\n\nrandom chars>.exe\n\n<current user dir>\\<5 random chars>\\<8 random chars>\\<4 random\n\nchars>\\CRYPTUI.dll\n\nThe execution chain ensures that persistence is set on the affected system using a .lnk file\n\nin the Startup directory The lnk file shown in Figure 17 opens the malicious VBS dropped\n\n\n-----\n\nFigure 17: Persistence Key\n\nThe VBS file (Figure 18) will launch and execute the downloaded legitimate Windows\ntool, which in this case is Certmgr.exe. This tool will be abused using the DLL side loading\n\ntechnique. The malicious Cryptui.dll is loaded into the program instead of the legitimate\none and executed.\n\nFigure 18: Contents of Dropped VBS File\n\n### Banking Trojan Analysis\n\nLike the Trojan from the first campaign, this sample is executed through search-order\n\nhijacking. In this case, the binary abused is a legitimate Windows tool, Certmgr.exe, that\nloads Cryptui.dll. Since this tool depends on a legitimate DLL named cryptui.dll, the\n\nsearch order path will find the malicious Trojan with the same name in the same directory\nand load it into its process space.\n\nThe malicious DLL exports 21 functions. Only DllEntryPoint contains real code that is\n\nnecessary to start the execution of the malicious code. The other functions return\n\nhardcoded values that serve no real purpose.\n\n\n-----\n\nsuccessful, it sends a request to hxxp://api-api[.]com/json in order to detect the\n\nexternal IP of the victim. The result is parsed and execution continues only if the country\ncode matches “BR”, as shown in Figure 19.\n\nFigure 19: Country Code Check\n\nThe malware creates an empty file in %appdata%\\Mariapeirura on first execution, which\n\nserves as a mutex lock, before attempting to send any collected information to the C2\n\nserver. This is done in order to get only one report per infected host.\n\nThe malware collects host information, base64 encodes it, and sends it to two C2\nservers. The following items are gathered from the infected system:\n\nOS name\nOS version\n\nOS architecture\nAV installed\n\nList of banking software installed\nIP address\n\nDirectory where malware is being executed from\n\nThe information is sent to hxxp://108.61.188.171/put.php (Figure 20).\n\nFigure 20: Host Recon Data Sent to First C2 Server\n\n\n-----\n\nFigure 21: Host Recon Data Sent to Second C2 Server\n\nThe malware alters the value of registry key\nSoftware\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\ExtendedUIHoverTime\n\nto 2710 in order to change the number of milliseconds a thumbnail is showed while\nhovering on the taskbar, as seen in Figure 22.\n\n\n-----\n\nLike the Trojan from the first campaign, this sample checks if the foreground window s\n\ntitle contains names of Brazilian banks and digital coins by looking for hardcoded\nstrings.\n\nThe malware displays fake forms on top of the banking sites and intercepts credentials\n\nfrom the victims. It can also display a fake Windows Update whenever there is nefarious\n\nactivity in the background, as seen in Figure 23.\n\nFigure 23: Fake Form Displaying Windows Update\n\nThe sample also contains a keylogger functionality, as shown in Figure 24.\n\n\n-----\n\nFigure 24: Keylogger Function\n\n### Command and Control\n\nThe Trojan’s command and control command structure is identical to the first sample.\n\nThe commands are denoted by the <|Command|> syntax.\n\n<|OK|> gets a list of banking software installed on the host.\n'<PING>' is sent from C2 to host, and '<PONG>' is sent from host to C2, to keep\n\nconnection alive.\n\n<|dellLemb|> deletes the registry key \\Software\\Microsoft\\Internet\n\nExplorer\\notes.\n\nEXECPROGAM calls ShellExecute to run the application given in the command.\n\nEXITEWINDOWS calls ExitWindowsEx.\n\nNOVOLEMBRETE creates and stores data sent with the command in the registry\n\nkey \\Software\\Microsoft\\Internet Explorer\\notes.\n\n\n-----\n\nFigure 25: Partial List of Victims\n\nThis sample contains most of the important strings encrypted. We provide the following\nscript (Figure 26) in order to decrypt them.\n\n\n-----\n\nFigure 26: String Decryption Script\n\n## Conclusion\n\nThe use of multi-stage infection chains makes it challenging to research these types of\ncampaigns all the way through.\n\nAs demonstrated by our research, the attackers are using various techniques to evade\n\ndetection and infect unsuspecting Portuguese-speaking users with banking Trojans. The\nuse of public cloud infrastructure to help deliver the different stages plays a particularly\n\nbig role in delivering the malicious payload. The use of different infection methods\n\ncombined with the abuse of legitimate signed binaries to load malicious code makes\n\nthese campaigns worth highlighting.\n\n### Indicators of Compromise\n\n#### Campaign #1\n\n**TYPE** **HASH** **DESCRIPTION**\n\nMD5 860fa744d8c82859b41e00761c6e25f3 PE with Embedded HTA\n\nMD5 3e9622d1a6d7b924cefe7d3458070d98 PE with Embedded HTA\n\nMD5 f402a482fd96b0a583be2a265acd5e74 PE with Embedded HTA\n\n|TYPE|HASH|DESCRIPTION|\n|---|---|---|\n|MD5|860fa744d8c82859b41e00761c6e25f3|PE with Embedded HTA|\n|MD5|3e9622d1a6d7b924cefe7d3458070d98|PE with Embedded HTA|\n\n\n-----\n\n|MD5|68f818fa156d45889f36aeca5dc75a81|PE with Embedded HTA|\n|---|---|---|\n|MD5|c2cc04be25f227b13bcb0b1d9811e2fe|cryptui.dll|\n|MD5|6d2cb9e726c9fac0fb36afc377be3aec|id|\n|MD5|dd73f749d40146b6c0d2759ba78b1764|i4.dt|\n|MD5|d9d1e72165601012b9d959bd250997b3|VBS file with commands to create staging directories for malware|\n|MD5|03e4f8327fbb6844e78fda7cdae2e8ad|pvk2pfx.exe [Legit Windows Tool]|\n|URL||hxxp://5.83.162.24/ilha/pz/logs.php|\n|URL||hxxp://5.83.162.24/28022018/pz.zip|\n|C2||ibamanetibamagovbr[.]org/virada/pz/logs.php|\n|URL||sistemasagriculturagov[.]org|\n|URL||hxxp://187.84.229.107/05022018/al.zip|\n\n\n#### Campaign #2\n\n**TYPE** **HASH** **DESCRIPTION**\n\nMD5 2999724b1aa19b8238d4217565e31c8e AutoIT Dropper\n\nMD5 181c8f19f974ad8a84b8673d487bbf0d img1.jpg [lLegit Windows Tool]\n\nMD5 d3f845c84a2bd8e3589a6fbf395fea06 img2.jpg [Banking Trojan]\n\nMD5 2365fb50eeb6c4476218507008d9a00b Variants of Banking Trojan\n\n|TYPE|HASH|DESCRIPTION|\n|---|---|---|\n|MD5|2999724b1aa19b8238d4217565e31c8e|AutoIT Dropper|\n|MD5|181c8f19f974ad8a84b8673d487bbf0d|img1.jpg [lLegit Windows Tool]|\n|MD5|d3f845c84a2bd8e3589a6fbf395fea06|img2.jpg [Banking Trojan]|\n\n\n-----\n\n|MD5|d9682356e78c3ebca4d001de760848b0|Variants of Banking Trojan|\n|---|---|---|\n|MD5|330721de2a76eed2b461f24bab7b7160|Variants of Banking Trojan|\n|MD5|6734245beda04dcf5af3793c5d547923|Variants of Banking Trojan|\n|MD5|a920b668079b2c1b502fdaee2dd2358f|Variants of Banking Trojan|\n|MD5|fe09217cc4119dedbe85d22ad23955a1|Variants of Banking Trojan|\n|MD5|82e2c6b0b116855816497667553bdf11|Variants of Banking Trojan|\n|MD5|4610cdd9d737ecfa1067ac30022d793b|Variants of Banking Trojan|\n|MD5|34a8dda75aea25d92cd66da53a718589|Variants of Banking Trojan|\n|MD5|88b808d8164e709df2ca99f73ead2e16|Variants of Banking Trojan|\n|MD5|d3f845c84a2bd8e3589a6fbf395fea06|Variants of Banking Trojan|\n|MD5|28a0968163b6e6857471305aee5c17e9|Variants of Banking Trojan|\n|MD5|1285205ae5dd5fa5544b3855b11b989d|Variants of Banking Trojan|\n|MD5|613563d7863b4f9f66590064b88164c8|Variants of Banking Trojan|\n|MD5|3dd43e69f8d71fcc2704eb73c1ea7daf|Variants of Banking Trojan|\n|C2||https[:]//panel- dark[.]com/w3af/img2.jpg|\n|C2||https[:]//panel- dark[.]com/w3af/img1.jpg|\n\n\n[This entry was posted on Tue Apr 24 11:00 EDT 2018 and filed under Trojan, Malware,](https://www.fireeye.com/blog/threat-research.html/category/etc/tags/fireeye-blog-tags/trojan)\n\n\n-----\n\n## Sign up for email updates\n\nGet information and insight on\n\ntoday's advanced threats from the\n\nleader in advanced threat\n\nprevention.\n\nFirst Name Last Name\n\nEmail Address\n\nCompany Name\n\nThreat Research Blog\n\nProducts and Services\nBlog\n\nExecutive Perspectives\nBlog\n\nSUBSCRIBE\n\n\n-----\n\n[About FireEye](https://www.fireeye.com/company/why-fireeye.html)\n\n[Customer Stories](https://www.fireeye.com/customers.html)\n\n[Careers](https://www.fireeye.com/company/jobs.html)\n\n[Partners](https://www.fireeye.com/partners.html)\n\n[Investor Relations](http://investors.fireeye.com/)\n\n[Supplier Documents](https://www.fireeye.com/company/supplier.html)\n\n\n[Newsroom](https://www.fireeye.com/company/newsroom.html)\n\n[Press Releases](https://www.fireeye.com/company/press-releases.html)\n\n[Webinars](https://www.fireeye.com/company/webinars.html)\n\n[Events](https://www.fireeye.com/company/events.html)\n\n[Awards and Honors](https://www.fireeye.com/company/awards.html)\n\n[Email Preferences](https://www2.fireeye.com/manage-your-preferences.html)\n\n\n[Incident?](https://www.fireeye.com/company/incident-response.html)\n\n[Report Security Issue](https://www.fireeye.com/company/security.html)\n\n[Contact Support](https://www.fireeye.com/support/contacts.html)\n\n[Customer Portal](https://csportal.fireeye.com/secur/login_portal.jsp?orgId=00D3000000063LS&portalId=06030000000pSNE)\n\n[Communities](https://community.fireeye.com/welcome)\n\n[Documentation Portal](https://docs.fireeye.com)\n\n\n[Threat Research](https://www.fireeye.com/blog/threat-research.html)\n\n[Products and Services](https://www.fireeye.com/blog/products-and-services.html)\n\n[Executive Perspectives](https://www.fireeye.com/blog/executive-perspective.html)\n\nThreat Map\n\n[View the Latest Threats](https://www.fireeye.com/cyber-map/threat-map.html)\n\n\n1 877 347 3393\n\nStay Connected\n\n## \n\n\n## \n\n\nCopyright © 2018 FireEye, Inc. All rights reserved.\n[Privacy & Cookies Policy | Privacy Shield | Legal Documentation](https://www.fireeye.com/company/privacy.html)\n\n\nSite Language\n\nEnglish \n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2018/2018.04.24.metamorfo-campaign/metamorfo-campaign-targeting-brazilian-users_html.pdf"
    ],
    "report_names": [
        "metamorfo-campaign-targeting-brazilian-users_html"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716496,
    "ts_updated_at": 1743041159,
    "ts_creation_date": 1524669790,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/9e3057bfa16352f56a7d026fac330e3a1487b861.pdf",
        "text": "https://archive.orkl.eu/9e3057bfa16352f56a7d026fac330e3a1487b861.txt",
        "img": "https://archive.orkl.eu/9e3057bfa16352f56a7d026fac330e3a1487b861.jpg"
    }
}