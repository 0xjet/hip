{
    "id": "b778e946-8cf5-42ab-b363-763d4ac7b488",
    "created_at": "2023-01-12T15:07:47.269811Z",
    "updated_at": "2025-03-27T02:06:02.51929Z",
    "deleted_at": null,
    "sha1_hash": "e19e49330e668a2694f92bfa758d0c31f401f559",
    "title": "2016-08-22 - VB Dropper and Shellcode for Hancitor Reveal New Techniques Behind Uptick",
    "authors": "",
    "file_creation_date": "2022-05-29T01:28:27Z",
    "file_modification_date": "2022-05-29T01:28:27Z",
    "file_size": 454514,
    "plain_text": "# VB Dropper and Shellcode for Hancitor Reveal New Techniques Behind Uptick\n\n**researchcenter.paloaltonetworks.com/2016/08/unit42-vb-dropper-and-shellcode-for-hancitor-reveal-new-techniques-**\nbehind-uptick/\n\nJeff White August 22, 2016\n\nBy [Jeff White](https://unit42.paloaltonetworks.com/author/jeff-white/)\n\nAugust 21, 2016 at 5:00 PM\n\n[Category: Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [hancitor](https://unit42.paloaltonetworks.com/tag/hancitor/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/unit42-vb-dropper-and-shellcode-for-hancitor-reveal-new-techniques-behind-uptick/)\n\nThe Hancitor downloader has been relatively quiet since a major campaign back in June\n2016. But over the past week, while performing research using Palo Alto Networks\nAutoFocus, we noticed a large uptick in the delivery of the Hancitor malware family as they\nshifted away from H1N1 to distribute Pony and Vawtrak executables. In parallel, we received\nreports from other firms and security researchers seeing similar activity, which pushed us to\nlook into this further.\n\n_Figure 1 AutoFocus view of new sessions of Hancitor since July 2016_\n\nThe delivery method for these documents remained consistent to other common malicious email campaigns. Lures contained subjects related to recent invoices, or other matters\nrequiring the victim’s attention, such as an overdue bill. These lures were expected, until we\nstarted digging into the actual documents attached and saw an interesting method within the\nVisual Basic (VB) macros in the attached documents used for dropping the malware.\n\nThis blog will review in detail the dropping technique, which isn’t technically new, but this was\nthe first time we’ve seen it used in this way. The end goal is to identify where the binary was\nembedded but we’ll cover the macro and the embedded shellcode throughout this post\n\n\n-----\n\n## The Word Document\n\nFor this section, we’ll be looking at the file with a SHA256 hash of\n‘03aef51be133425a0e5978ab2529890854ecf1b98a7cf8289c142a62de7acd1a’, which is a\ntypical MS Office OLE2 Word Document with your standard ploy to ‘Enable Content’ and run\nthe malicious macro.\n\n_Figure 2 The ploy used by the malicious document_\n\nOpening the Visual Basic editor up, we can see two forms and a module for this particular\nsample.\n\n_Figure 3 VBProject components_\n\n## The Malicious Macro\n\nVisual Basic can directly execute Microsoft Windows API calls, which allows it perform a\nnumber of interesting functions -- exactly what this VB code is doing.\n\n\n-----\n\n_Figure 4 Microsoft Windows API calls within VB code_\n\nAs we can see, the macro includes logic to determine the architecture of the system it’s\nrunning on and has the ability to execute correctly on either 32-bit or 64-bit platforms. The\nprimary calls of interest for us will be VirtualAlloc(), RtlMoveMemory(), and\nCallWindowProcA().\n\nWhen we originally started looking at this sample, we were mainly interested in where the\npayload was being stored, so we began debugging the macro to understand how it functions.\nThe payload in question is base64-encoded and embedded within a form in the VBProject as\na value of the ‘Text’ field on the ‘choline’ TextBox.\n\nAs a side note, what is really interesting is that the authors went through the trouble to\nactually write their own base64 decoder purely in VB. We’ll leave that as an exercise for the\nreader to dig into that but it’s a good overview of how base-N encoding works; the entire\n‘maria’ module within this macro is the base64 decoder.\n\nThe macro base64 decodes the payload into a local byte-array and then we come to our first\nAPI call, VirtualAlloc().\n\n_Figure 5 Memory page being allocated_\n\nThe call commits specific pages of memory with read, write, and executable (RWX)\npermissions at 0x59B0000.\n\n\n-----\n\n_Figure 6 New memory page with RWX permissions_\n\nAfterwards, the VB macro continues to setup the next call to RtlMoveMemory and then calls\nit with the location of the memory from the previous call and our base64 decoded byte array.\n\n_Figure 7 Base64-decoded byte array_\n\nWe can quickly validate by dumping that region of memory in our WINWORD.EXE process\nand comparing transferred bytes.\n\n_Figure 8 Confirming bytes match from dumped memory_\n\nNow that our code has been copied to in executable memory, the macro sets up the last API\ncall for CallWindowProcA(). The first value supplied to this call is our memory offset +2214,\nwhich is a function pointer within this code, and the second is a string of the path to our file\nfor a handle. These actions redirect code execution to shellcode.\n\n\n-----\n\n_Figure 9 Passing execution to the shellcode_\n\n## The Shellcode\n\nIf we attach to WINWORD.EXE and break on the offset of our memory location +2214\n(0x8A6), the entry point of the shellcode, we can validate program execution shifts to this\ncode path.\n\n_Figure 10 Validating shellcode is executing_\n\nFrom here, the shellcode gets the address for LdrLoadDLL() function, which is similar to\nLoadLibraryEx(), by enumerating the Process Environment Block (PEB) and then begins to\nhunt for the functions it will use within kernel32.dll.\n\nThe values for the functions it’s looking for, along with other values, are embedded into the\nshellcode and built on the stack for later usage.\n\n\n-----\n\n_Figure 11 Embedded data in shellcode_\n\nFollowing these sets of encoded names, we can see the shellcode is interested in the\nfollowing syscalls: CloseHandle(), ReadFile(), GetFileSize(), VirtualFree(), VirtualAlloc(), and\nCreateFileA(). For each API call, it looks up the address of the function and stores it on the\nstack.\n\nNext, the shellcode calls CreateFileA() on the Word document and receives a handle back,\nwhich it passes to GetFileSize() for the file size, that is then subsequently passed to\nVirtualAlloc() to create a section of memory for the file contents (0x2270000). Finally, it reads\nin the file to that memory location and closes the handle.\n\n\n-----\n\n_Figure 12 Egg hunting by the shellcode_\n\nOnce it has the copy loaded into memory, it begins a process of hunting through memory for\nthe magic bytes 0x504F4C41, which we can see is located at 0x022836F3 in our new\nmemory page.\n\n\n-----\n\n_Figure 13 Egg located_\n\nNow that we’ve found what’s likely to be our binary, the last step is to just decode it. Looking\nat the shellcode, we can see that it will add 0x3 to each byte starting at 0x22836FF, in our\nexample, and then XOR it by 0x13, as shown below.\n\n_Figure 14 XOR decrypting_\n\nOnce the counter reaches 0x13AAC (80556), it begins a series of sub-routines to manipulate\neach byte and decrypt the binary. If we set a breakpoint after the decryption routine and\ncheck our memory location, we can see that the binary is decoded and can now be dumped\nfor further analysis. The MZ and PE headers can be seen in the following dumped memory.\n\n\n-----\n\n_Figure 15 Decoded binary_\n\nFor this particular campaign run with this dropper, it places the binary in the %TMP%\ndirectory before launching it, which then ends up writing itself to\n‘%SYSTEMROOT%/system32/WinHost.exe’.\n\nAt this point, the Hancitor downloader has been fully loaded on the victim’s machine, where it\nwill proceed to perform additional malicious activities.\n\n## Conclusion\n\nMacro-based techniques are quite common, but the technique being used here with the\nmacro dropper is an interesting variation. From the encoded shellcode within the macro and\nusing native API calls within VB code to pass execution to carving out and decrypting the\nembedded malware from the Word document, it’s a new use of Hancitor that we’ll be\nfollowing closely. .\n\nPalo Alto Networks customers are protected from the dropper detailed throughout this blog\nand its contained Hancitor payload. You can continue to track this threat through the\n[AutoFocus Hancitor tag. Additionally, all Hancitor downloader samples are identified as](https://autofocus.paloaltonetworks.com/#/tag/Unit42.Hancitor)\nmalicious in WildFire. Domains used by Hancitor are also categorized as malicious.\n\n## Acknowledgements\n\n[For more analysis of the Hancitor payload, please see this write-up by Minerva Labs.](http://www.minerva-labs.com/post/new-hancitor-pimp-my-downloader)\n\n## Indicators of Compromise\n\nBelow are some of the most common observed e-mail subjects and file names seen in the\nlatest campaign this week from over 380,000 sessions. Patterns substituted with regex or\nrepresentation.\n\n\n-----\n\n## Email Subjects\n\n<domain> invoice for <month>\n\nlevi.com invoice for august\n\n<domain> bill\n<domain> deal\n<domain> receipt\n<domain> contract\n<domain> invoice\n\nmetlife.com bill\nmetlife.com deal\nmetlife.com receipt\nmetlife.com contract\nmetlife.com invoice\n\n## File Names\n\nartifact[0-9]{9}.doc\n\nbcbsde.com_contract.doc\n\ncontract_[0-9]{6}.doc\n\ngeneric.doc\n\nprice_list.doc_[0-9]{6}.doc\n\nreport_[0-9]{6}.doc\n\nIn addition, we observed these C2 calls out during analysis, which can be detected at your\nperimeter by the use of ‘/(sl|zaopy)/gate.php’.\n\nhxxp://betsuriin[.]com/sl/gate.php\n\nhxxp://callereb[.]com/zapoy/gate.php\n\nhxxp://evengsosandpa[.]ru/ls/gate.php\n\nhxxp://felingdoar[.]ru/sl/gate.php\n\nhxxp://gmailsign[.]info/plasma/gate.php\n\nhxxp://hecksafaor[.]com/zapoy/gate.php\n\nhxxp://heheckbitont[.]ru/sl/gate.php\n\nhxxp://hianingherla[.]com/sl/gate.php\n\nhxxp://hihimbety[.]ru/sl/gate.php\n\nhxxp://meketusebet[.]ru/sl/gate.php\n\nhxxp://mianingrabted[.]ru/zapoy/gate.php\n\nhxxp://moatleftbet[.]com/sl/gate.php\n\nhxxp://mopejusron[.]ru/sl/gate.php\n\nhxxp://muchcocaugh[.]com/sl/gate.php\n\n\n-----\n\nhxxp://ningtoparec[.]ru/sl/gate.php\nhxxp://nodosandar[.]com/ls/gate.php\nhxxp://nodosandar[.]com/zapoy/gate.php\nhxxp://ritbeugin[.]ru/ls/gate.php\nhxxp://rutithegde[.]ru/sl/gate.php\nhxxp://surofonot[.]ru/sl/gate.php\nhxxp://uldintoldhin[.]com/sl/gate.php\nhxxp://unjustotor[.]com/sl/gate.php\nhxxp://wassuseidund[.]ru/sl/gate.php\n\nThe below Yara rule can be used to detect this particular dropper and technique described\nthroughout this blog.\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nrule hancitor_dropper : vb_win32api\n{\nmeta:\nauthor = \"Jeff White - jwhite@paloaltonetworks @noottrak\"\ndate  = \"18AUG2016\"\nhash1 =\n\"03aef51be133425a0e5978ab2529890854ecf1b98a7cf8289c142a62de7acd1a\"\nhash2 =\n\"4b3912077ef47515b2b74bc1f39de44ddd683a3a79f45c93777e49245f0e9848\"\nhash3 =\n\"a78972ac6dee8c7292ae06783cfa1f918bacfe956595d30a0a8d99858ce94b5a\"\n\nstrings:\n$api_01 = { 00 56 69 72 74 75 61 6C 41 6C 6C 6F 63 00 } // VirtualAlloc\n$api_02 = { 00 52 74 6C 4D 6F 76 65 4D 65 6D 6F 72 79 00 } // RtlMoveMemory\n$api_04 = { 00 43 61 6C 6C 57 69 6E 64 6F 77 50 72 6F 63 41 00 } //\nCallWindowProcAi\n$magic = { 50 4F 4C 41 } // POLA\n\ncondition:\nuint32be(0) == 0xD0CF11E0 and all of ($api_*) and $magic\n}\n\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-08-22 - VB Dropper and Shellcode for Hancitor Reveal New Techniques Behind Uptick.pdf"
    ],
    "report_names": [
        "2016-08-22 - VB Dropper and Shellcode for Hancitor Reveal New Techniques Behind Uptick.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536067,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1653787707,
    "ts_modification_date": 1653787707,
    "files": {
        "pdf": "https://archive.orkl.eu/e19e49330e668a2694f92bfa758d0c31f401f559.pdf",
        "text": "https://archive.orkl.eu/e19e49330e668a2694f92bfa758d0c31f401f559.txt",
        "img": "https://archive.orkl.eu/e19e49330e668a2694f92bfa758d0c31f401f559.jpg"
    }
}