{
    "id": "ed514148-16a9-4f8e-baa4-c509a51aeb32",
    "created_at": "2023-01-12T15:10:03.377957Z",
    "updated_at": "2025-03-27T02:05:56.929319Z",
    "deleted_at": null,
    "sha1_hash": "c584846ff49bc7caa47bf3231ccbf2438c7c6994",
    "title": "2020-06-12 - Trickbot Malspam Leveraging Black Lives Matter as Lure",
    "authors": "",
    "file_creation_date": "2022-05-28T04:51:33Z",
    "file_modification_date": "2022-05-28T04:51:33Z",
    "file_size": 993611,
    "plain_text": "# Trickbot Malspam Leveraging Black Lives Matter as Lure\n\n**[hornetsecurity.com/en/security-information/trickbot-malspam-leveraging-black-lives-matter-as-lure/](https://www.hornetsecurity.com/en/security-information/trickbot-malspam-leveraging-black-lives-matter-as-lure/)**\n\nSecurity Lab June 12, 2020\n\n## Summary\n\nThe Hornetsecurity Security Lab has observed a malspam campaign distribution TrickBot [1] that uses the Black Lives\nMatter movement as a lure to entice victims to open a malicious attachment. The TrickBot downloader document first\ninjects shellcode into the `WINWORD.EXE process. From that shellcode, it then spawns a` `cmd.exe process into which`\nit again injects more of the same shellcode. This `cmd.exe process then downloads the TrickBot DLL and executes it`\nvia `rundll32.exe .`\n\n## Background\n\nThe initial emails claim to be from a `State office,` `Country authority, or` `Country administration :`\n\n\n-----\n\nThe email tells the recipient they can `Vote confidentially about \"Black Lives Matter\" or` `Tell your`\n```\ngovernment your opinion, Give your opinion, and Speak out confidentially about \"Black Lives\nMatter\" .\n\n```\nAttached is a file named `e-vote_form_0000.doc, further suggesting the email to be some sort of official means of`\nvoting.\n\nHowever, the document only displays an image announcing a fake Office update and instructions to “Enable Editing”\nas well as to “Enable Content”:\n\n\n-----\n\nIf the instructions are followed, the malicious VBA macro in the document is executed and it downloads the TrickBot\nmalware.\n\n## Technical Analysis\n\nThe initial portion of the infection chain (until the TrickBot malware is deployed) is depicted in this flow graph:\n\nIn the following analysis we will walk through each stage of this chain.\n\n\n-----\n\n### VBA macro\n\nThe VBA macro is protected against viewing in Word:\n\nHowever, this “protection” only prevents Word from showing the VBA macro without a password. The VBA macro code\nis still accessible.\n\nThe first thing the VBA macro does is to display a fake error message:\n```\nPrivate Sub Document_Open()\n  MsgBox \"Error #80013123\"\n\n```\nThis results in the following pop-up:\n\n\n-----\n\nThis is likely an attempt to prompt user interaction in order to bypass sandbox detections. It could also be an attempt to\nhide the fact that there is no document. A victim may be satisfied by receiving this error and assume the document to\nbe broken.\n\nThe macro uses `VirtualProtectEx and` `CreateThread to inject shellcode into the` `WINWORD.EXE process. To this`\nend, the code assembles one large string:\n```\n  uriSubscriber = \"i-j-[...]-a-a-a-\"\n  uriSubscriber = uriSubscriber & \"i-l-[...]-a-a-\"\n  uriSubscriber = uriSubscriber & \"g-k-a-a-p-p-h-f-p-i-[...]-o-g-c-c-p-k-h-c-g-j-h-d\"\n\n```\nThis string contains the encoded shellcode. It is then decoded via the following function:\n```\n  Dim f() As Byte\n  ReDim f(0 To Len(uriSubscriber) / 2 - 1) As Byte\n  Dim sSmart As Long, regOptimize As Long\n  For Each destEnd In Split(uriSubscriber, \"-\")\n    If sSmart Mod 2 Then\n      regOptimize = sSmart - 1\n      regOptimize = regOptimize / 2\n      f(regOptimize) = (CByte(Asc(destEnd)) - CByte(Asc(\"a\"))) + f((sSmart - 1) / 2)\n    Else\n      regOptimize = sSmart / 2\n      f(regOptimize) = (CByte(Asc(destEnd)) - CByte(Asc(\"a\"))) * 16\n    End If\n    sSmart = sSmart + 1\n  Next\n\n```\nFinally, the decoded shellcode is set to `PAGE_EXECUTE_READWRITE using` `VirtualProtectEx, which was previously`\naliased to `extensionsComment, and then a thread is started with the address of the shellcode as its start address`\nusing `CreateThread, previously aliased to` `sMail :`\n\n\n-----\n\n```\n                                                    (\n    iMail As Long, _\n    bConsole As Long, _\n    regFunction As Long, _\n    tablePosition As Long, _\n    colMail As Long) As Long\n  Private Declare Function sMail Lib \"kernel32\" Alias \"CreateThread\" ( _\n    textTimer As Long, _\n    uriMail As Long, _\n    m As Long, _\n    dateMembers As Long, _\n    textTimer0 As Long, _\n    lServer As Long) As Long\n[...]\n  sConsole = destN_ - angleTexture + UBound(f)\n  q = extensionsComment(ByVal ipFunction, ByVal angleTexture, ByVal sConsole, ByVal PAGE_EXECUTE_READWRITE,\nByVal VarPtr(extensionsComment0))\n  adsLogon = sMail(ByVal 0&, ByVal 0&, ByVal destN_, ByVal 2&, ByVal 0, ByVal 0&)\n  adsScr 5000\n\n```\nThe shellcode can most easily be extracted by breaking on `CreateThread in a debugger:`\n\n### Shellcode WINWORD.EXE\n\nThe shellcode running in the `WINWORD.EXE process first resolves several library functions. Then uses`\n```\nCreateProcessA to run a cmd.exe with the pause command, causing the cmd.exe to idle:\n\n```\n\n-----\n\nNext, the shellcode uses a classic `OpenProcess,` `VirtualAllocEx,` `WriteProcessMemory, and`\n```\nCreateRemoteThread sequence to do shellcode injection into the paused cmd.exe process:\n\n```\nThe `cmd.exe /c pause process is likely used to avoid detection. A common technique used in process injection is to`\ncreate a suspended (i.e., paused) process by setting the `CREATE_SUSPENDED flag during process creation, to then`\ninject code into the created process, and resume it afterwards. In the case of the discussed shellcode, the code is\ninjected as a thread into the paused `cmd.exe instead.`\n\nThe injected shellcode is the same shellcode that was injected into the `WINWORD.EXE process. However, the entry`\npoint passed to `CreateRemoteThread is different, resulting into a different execution flow for the shellcode within the`\n```\ncmd.exe process.\n\n### Shellcode cmd.exe\n\n```\nThe shellcode in the `cmd.exe process also resolves several library functions. Additionally, it decodes the TrickBot`\ndownload URLs.\n\nNext, the shellcode queries `GetSystemMetrics(SM_CXSCREEN) and` `GetSystemMetrics(SM_CYSCREEN) to get the`\ndisplay resolution. Then, `GetCursorPos is queried twice, with a call to` `Sleep(0x1388) in between causing a 5`\nsecond delay.\n\nThis is likely done to verify mouse movement and thus avoid sandboxes.\n\nThe data is then encoded as a HTTP query string as follows: `&scr=1280x1024&cur1=604x250&cur2=622x310`\n\n\n-----\n\nAn ID query string `&id=00000000 and the above system metrics query string are then appended to a URL to form the`\nfinal download URL which is then queried via `InternetOpenUrlA :`\n\nIn case the download is successful, the downloaded file is written to `C:\\\\Users\\\\`\n```\n<username>\\\\AppData\\\\Local\\\\system.rre and executed via rundll32.exe\n%userprofile%/system.rre,Initialize using ShellExecuteA . The system.rre file is the TrickBot DLL.\n\n```\nIn case the download is not successful, the downloader sleeps and then a second download URL is tried.\n\n## Conclusion and Remediation\n\nThe double shellcode injection is likely used to avoid behavioral detection as `WINWORD.EXE does not usually`\ndownload files from the Internet or execute `rundll32.exe . Hence, such anomalous behavior is more likely to be`\ndetected than `cmd.exe spawning the` `rundll32.exe process. The query for the systems display resolution as well`\nas the double query of the cursor position is also likely done to avoid delivering the TrickBot DLL to sandbox systems.\n\nHornetsecurity’s [Spam Filtering Service with the highest detection rates on the market, has already detected and](https://www.hornetsecurity.com/en/services/spam-filter/)\nblocked the malicious TrickBot document based on a detection signature.\n\nIn case the basic detection signatures would not have blocked the emails, Hornetsecurity’s Advanced Threat\nProtection (ATP) would not have been impacted by the various anti-sandboxing mechanisms either. The human\ninteraction simulation of the ATP sandbox successfully clicks the fake error message away for a complete execution of\nthe malicious document:\n\n\n-----\n\nIt detects the processes being created by the document, as well as the process injections:\n\n\n-----\n\nThe human interaction simulation also results in the two queried cursor positions, sent as `cur1 and` `cur2 to the`\nTrickBot download server, to differ:\n\nThis way, Hornetsecurity’s ATP sandbox is not fooled by the various anti-sandboxing techniques.\n\n## References\n\n[1] [https://malpedia.caad.fkie.fraunhofer.de/details/win.trickbot](https://malpedia.caad.fkie.fraunhofer.de/details/win.trickbot)\n\n## Indicators of Compromise (IOCs)\n\n### Hashes\n\n**SHA256** **Filename** **Description**\n\n\n-----\n\n**SHA256** **Filename** **Description**\n\n`d6a44f6460fab8c74628a3dc160b9b0f1c8b91b7d238b6b4c1f83b3b43a0463d` `e-` TrickBot\n`vote_form_1967.doc` downloader\n\ndocument\n\n### URLs\n```\n   hxxps[:]//ppid.indramayukab.go[.]id/may.php?omz=1&pic=b&id=[0-9]{8}&scr=[0-9]{3,4}x[0-9]\n   {3,4}&cur1=[0-9]{3,4}x[0-9]{3,4}&cur2=[0-9]{3,4}x[0-9]{3,4}\n   hxxps[:]//www.inspeclabeling[.]com/wp-content/themes/processing/may.php?omz=1&pic=b&id=[0-9]\n   {8}&scr=[0-9]{3,4}x[0-9]{3,4}&cur1=[0-9]{3,4}x[0-9]{3,4}&cur2=[0-9]{3,4}x[0-9]{3,4}\n\n DNSs\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-12 - Trickbot Malspam Leveraging Black Lives Matter as Lure.pdf"
    ],
    "report_names": [
        "2020-06-12 - Trickbot Malspam Leveraging Black Lives Matter as Lure.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536203,
    "ts_updated_at": 1743041156,
    "ts_creation_date": 1653713493,
    "ts_modification_date": 1653713493,
    "files": {
        "pdf": "https://archive.orkl.eu/c584846ff49bc7caa47bf3231ccbf2438c7c6994.pdf",
        "text": "https://archive.orkl.eu/c584846ff49bc7caa47bf3231ccbf2438c7c6994.txt",
        "img": "https://archive.orkl.eu/c584846ff49bc7caa47bf3231ccbf2438c7c6994.jpg"
    }
}