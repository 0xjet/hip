{
    "id": "805d27c5-6acb-4710-a253-1d6bccf3fee8",
    "created_at": "2022-10-25T16:48:13.621333Z",
    "updated_at": "2025-03-27T02:05:59.165485Z",
    "deleted_at": null,
    "sha1_hash": "c2858ffd02ad542ed014c93de03d1dda17a65ca9",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-01-07T08:09:42Z",
    "file_modification_date": "2021-01-07T08:09:42Z",
    "file_size": 117298,
    "plain_text": "# PlugX: some uncovered points\n\n**[airbus-cyber-security.com/plugx-some-uncovered-points](https://airbus-cyber-security.com/plugx-some-uncovered-points/)**\n\nJanuary 6, 2014\n\n_by Fabien Perigaud_\nPlugX (or Korplug, or Gulpix) is a well-known RAT involved in many APT cases. Some\n[excellent write-ups about this malware have already been published by the CIRCL,](https://www.circl.lu/pub/tr-12/)\n[Sophos and AlienVault. Since we met it on an incident response case back in 2012, we](http://nakedsecurity.sophos.com/2013/05/20/inside-the-plugx-malware-with-sophoslabs-a-fascinating-journey-into-a-malware-factory/)\nfollowed its evolution to improve our knowledge, rules and tools. We’re planning to\nrelease details about this malware in a small serie of blog posts, to cover some points\nwhich have not been published yet.\n\nThis first post will cover some internals of the original PlugX malware and we’ll deal with\nits evolution in the next one.\n\n## Internal Versions\n\nSome PlugX samples found in the wild are debug releases, still containing the full path to\nthe “XPlug.h” file. This full path allows to identify several versions of PlugX, ranging from\n2.0 to 8.0. This kind of information has been used by AlienVault to identify the potential\nauthor of the RAT, via the leaked username. Here is a list of all the debug paths we found\nin the wild:\n\n\n-----\n\n```\ni:\\work\\plug2.0(......)\\shellcode\\shellcode\\\ni:\\work\\plug2.0\\shellcode\\shellcode\\\nd:\\work\\plug2.0\\shellcode\\shellcode\\\nd:\\work\\plug2.5\\shellcode\\shellcode\\\nc:\\users\\whg\\desktop\\plug2.5(nzqk)\\shellcode\\shellcode\\\nc:\\users\\whg\\desktop\\plug2.5(rose)\\shellcode\\shellcode\\\nc:\\users\\whg\\desktop\\plug3.0\\shellcode\\shellcode\\\nd:\\work\\plug3.0(gf)\\shellcode\\shellcode\\\nd:\\work\\plug3.0(gf)udp\\shellcode\\shellcode\\\nd:\\work\\plug3.0(lyt)\\shellcode\\shellcode\\\nd:\\work\\plug3.0\\shellcode\\shellcode\\\nd:\\work\\plug3.1(icesword)\\shellcode\\shellcode\\\nd:\\work\\plug4.0(....)(......)\\shellcode\\shellcode\\\nd:\\work\\plug4.0(cammute)\\shellcode\\shellcode\\\nd:\\work\\plug4.0(msidb)(lyt)\\shellcode\\shellcode\\\nd:\\work\\plug4.0(nvsmart)(....)(7.0)\\shellcode\\shellcode\\\nd:\\work\\plug4.0(nvsmart)(hrb)\\shellcode\\shellcode\\\nd:\\work\\plug4.0(nvsmart)(mrxy)(675960)\\shellcode\\shellcode\\\nd:\\work\\plug4.0(nvsmart)(sxl)\\shellcode\\shellcode\\\nd:\\work\\plug4.0(nvsmart)\\shellcode\\shellcode\\\nd:\\work\\plug4.0(shellcode)(....)\\shellcode\\shellcode\\\nd:\\work\\plug4.0(shellcode)(hrb)(gf)\\shellcode\\shellcode\\\nd:\\work\\plug4.0(shellcode)(hrb)\\shellcode\\shellcode\\\nd:\\work\\plug4.0\\shellcode\\shellcode\\\nd:\\work\\plug5.0(3f)(zxf)(360)(9022863)(scldr3.0)\\shellcode\\shellcode\\\nd:\\work\\plug5.0(hrb)\\shellcode\\shellcode\\\nd:\\work\\plug5.0\\shellcode\\shellcode\\\nd:\\work\\plug6.0(360)(gadget)(....)\\shellcode\\shellcode\\\nd:\\work\\plug6.0(360)(gadget)(........)(....)\\shellcode\\shellcode\\\nd:\\work\\plug6.0(360)(hkcmd)(xts)(scldr3.0)\\shellcode\\shellcode\\\nd:\\work\\plug6.0(360)(hkcmd)(xts)\\shellcode\\shellcode\\\nd:\\work\\plug6.0(360)(mcinsupd)(....)\\shellcode\\shellcode\\\nd:\\work\\plug6.0(360)(mcinsupd)(48846669)\\shellcode\\shellcode\\\nd:\\work\\plug6.0(360)(mcoemcpy)(hhhtwy)(scldr3.0)\\shellcode\\shellcode\\\nd:\\work\\plug6.0(360)(minidownloader)\\shellcode\\shellcode\\\nd:\\work\\plug6.0\\plug6.0(minidownloader)\\shellcode\\shellcode\\\nd:\\work\\plug6.0\\plug6.0(rstray)\\shellcode\\shellcode\\\nd:\\work\\plug7.0(....)(3..)\\plug7.0(oleview)(....3)(........)\\shellcode\\shellcode\\\nd:\\work\\plug7.0(arotutorial)(ykcai)(2)\\shellcode\\shellcode\\\nd:\\work\\plug7.0(bdreinit)(....)(360)\\shellcode\\shellcode\\\nd:\\work\\plug7.0(mcappcfg)(gf)(....)\\shellcode\\shellcode\\\nd:\\work\\plug7.0(mcvsmap)(fking)(....)\\shellcode\\shellcode\\\nd:\\work\\plug8.0(hkcmd)(....)\\plug6.0(360)(mcoemcpy)(hhhtwy)\n(scldr3.0)\\shellcode\\shellcode\\\nd:\\work\\plug8.0(mcoemcpy)(lyt)\\shellcode\\shellcode\\\n\n```\nAs you can see, it seems that PlugX has evolved quite fast, upgrading from “version” 2.0 to\n8.0 in a few months (compilation dates from 03/2012 to 04/2013).\n\nHowever, we also found that there is an internal version number in the malware’s code,\nused in the hello packet sent to the C&C. This version number is a dword which\nhexadecimal representation seems to be a date. More interestingly, we only found 4\ndifferent internal version numbers for all the aforementioned debug strings:\n\n\n-----\n\n```\n20120123\n20121016\n20121107\n20121203\n\n```\nFor the record, Destory, which is supposed to be PlugX ancestor, has a similar version\nnumber. In all the samples we collected, it is set to 20100921.\n\nWhile one could think these different versions could indicate different communication\nprotocols, the various HTTP headers and requests used could not be directly linked to a\nspecific version…\n\n## Network Communications\n\nIn 90% of the samples we collected, the HTTP request matches the following pattern\n(request and headers):\n```\nPOST /update?id=%8.8x\nX-Session / X-Status / X-Size / X-Sn\n\n```\nHowever, some samples exhibited a different HTTP communication protocol. Here are\nthe other variants we observed:\n```\nPOST /%p/%p/%p\nX-Session / X-Status / X-Size / X-Sn \nPOST /%p\nX-Session / X-Status / X-Size / X-Sn \nPOST /%p%p/%p\nCLR / CLA / CLC / CLX \nPOST /%p%p/\nX801 / X824 / X851 / X879 \nPOST /%d?%d?%d\nAndrioA / AndrioB / AndrioC / AndrioD \nPOST /%p/%p/%p\nHNS1 / HNS2 / HNS3 / HNS4 \nPOST /%p/%p/%p\nH0 / H1 / H2 / H3 \nGET /%8.8x/\nXSID / XSTATE / XSIZE / XSN\n\n```\nThe cipher algorithm has not changed through all these versions (more to come in the\nnext post). For all the possible communication protocols (TCP/UDP/HTTP), the data is\nsent encrypted and/or compressed (using LZNT1 algorithm), with a 10-bytes header\ncontaining:\n\n\n-----\n\n```\nCipher Key\nFlags (encryption/compression enabled)\nCommand ID\nSizes of payload (compressed and uncompressed)\nError code\n\n## Configuration\n\n```\nThe various versions can have a different configuration blob length. Versions before 3.0\n(according to the debug string) have a configuration length of 0xbe4, whereas later ones\nare bigger (0x150c). This change is only due to the space expansion for storing strings\n(such as the name of the created service) from 0x80 to 0x200. Samples with the\n“20121107” internal version have even bigger configurations (0x1d18) because of new\nfeatures in the malware (as Run key persistence and process injection).\n\nThe configuration is ciphered using the well-known PlugX algorithm (the key lies in the 4\nfirst bytes):\n```\nv1=v2=v3=v4=key\ni=0\nout=\"\"\nwhile i<len(buff):\n   v1 = (v1 + (v1 >> 3) - 0x11111111)&0xffffffff;\n   v2 = (v2 + (v2 >> 5) - 0x22222222)&0xffffffff;\n   v3 = (v3 + 0x33333333 - (v3 << 7))&0xffffffff;\n   v4 = (v4 + 0x44444444 - (v4 << 9))&0xffffffff;\n   mysum=(v1+v2+v3+v4)&0xff\n   out=out+chr(ord(buff[i])^mysum)\n   i=i+1\n\n```\nLet’s focus on the 0x150c length configuration, as it is the most widespread one. The\nfollowing information is available:\n\n**Flags (Offset 0x8, Length 0x2c)**\n\nThere are 11 different flags available, but some of them are not currently\nimplemented/used. Each flag is a DWORD which value can be 0 (disabled) or 0xffffffff\n(enabled). Some of these flags are:\n\nUAC bypass\nSelf deletion\nDemo mode (the famous “THIS IS A DEMO VERSION!!!” message box)\nHide service\n\n**Timers (Offset 0x34, Length 0x8)**\n\nTwo timers are configurable, each one stored on a DWORD (4 bytes: days, hours, minutes\nand seconds):\n\nTime between two connection attempts to the C&C\nSleep time\n\n**Timetable (Offset 0x3c Length 0x2a0)**\n\n\n-----\n\nThis timetable defines when the malware is allowed to contact its C&C. There are 672\nbytes, each one representing fifteen minutes, from Monday 00:00 AM to Sunday 11:45\nPM. The malware is only allowed to communicate when the byte value is not zero.\n\nThis is a very interesting feature to hide malicious traffic under the amount of legitimate\ntraffic during a normal working day, by allowing the malware to only communicate\nbetween 08:00 AM and 05:00 PM from Monday to Friday.\n\nPractically, a function is called before any attempt to reach the C&C, and waits until the\ngood time slot is reached.\n\n**Custom DNS servers (Offset 0x2dc, Length 0x10)**\n\nFour custom DNS servers can be provided in the configuration to resolve the C&C domain\nnames instead of the system configured DNS. Various samples we encountered contained\nthe following four DNS addresses, which seem to be a default value in the builder:\n\n8.8.8.8 (Google)\n61.139.2.69 (ChinaNet)\n202.98.96.68 (ChinaNet)\n205.252.144.228 (Beyond the Network America)\n\n**C&C Servers (Offset 0x2ec, Length 0x110)**\n\nFour different C&C servers can be configured, each one represented by the following\nstructure:\n```\nstruct cc {\n     WORD type;\n     WORD port;\n     CHAR address[0x40];\n}\n\n```\n\n-----\n\nThe type is a bit field indicating which protocols to use for the communication (Raw TCP /\nRaw UDP / HTTP).\n\n**URLs (Offset 0x3fc, Length 0x200)**\n\nFour URLs are available to provide a fallback mechanism in case the four C&C servers are\nnot available anymore. These URLs are therefore joined by the malware, which will parse\nthe web page, looking for DZKS and DZJS patterns. The string between these patterns is\nin fact a structure describing a new C&C server, each nibble being encoded in base16\n(using characters from A to P).\n\nLet’s take the following string as an example:\n```\nDZKSHAAAJDADBDCDHDOCADOCADOCBDDZJS\n\n```\nThe encoded string is HAAAJDADBDCDHDOCADOCADOCBD. The decoding can be\nperformed by taking the characters as pairs and substracting 0x41 to each ascii value. The\ndecoded structure is:\n```\n07 00 39 30 31 32 37 2e 30 2e 30 2e 31       ..90127.0.0.1\nType = 0x7\nPort = 0x3039 (12345)\nC&C = 127.0.0.1 \n\n```\n**Proxys (Offset 0x5fc, Length 0x310)**\n\nFour proxys can also be configured to ensure the RAT can reach its C&C servers. The\nfollowing structure is used:\n```\nstruct proxy {\n     WORD type;\n     WORD port;\n     BYTE proxy[0x40];\n     BYTE user[0x40];\n     BYTE passwd[0x40];\n}\n\n```\n**Persistence (Offset 0x90c, Length 0x800)**\n\nThe following four parameters are present (strings of 0x200 bytes):\n\nInstallation directory\nService name\nService display name\nService description\n\n**Currently unused strings (Offset 0x110c, Length 0x400)**\n\nTwo currently unused strings are present in each configuration file. In all the samples we\nfound, these two strings were set to “1234”. We’ll describe these strings more precisely in\nan upcoming blog post.\n\n\n-----\n\n**Evolution**\n\nThe PlugX RAT has not evolved so much from early 2012 to Q1 2013. However, a new\nversion has been spotted in the wild since Q2 2013, and this will be the topic of my next\nblog post. Stay tuned\n\n[Back to Blog](https://airbus-cyber-security.com/blog)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2014/2014.01.06.PlugX/airbus-cyber-security.com-PlugX%20some%20uncovered%20points.pdf"
    ],
    "report_names": [
        "airbus-cyber-security.com-PlugX some uncovered points"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716493,
    "ts_updated_at": 1743041159,
    "ts_creation_date": 1610006982,
    "ts_modification_date": 1610006982,
    "files": {
        "pdf": "https://archive.orkl.eu/c2858ffd02ad542ed014c93de03d1dda17a65ca9.pdf",
        "text": "https://archive.orkl.eu/c2858ffd02ad542ed014c93de03d1dda17a65ca9.txt",
        "img": "https://archive.orkl.eu/c2858ffd02ad542ed014c93de03d1dda17a65ca9.jpg"
    }
}