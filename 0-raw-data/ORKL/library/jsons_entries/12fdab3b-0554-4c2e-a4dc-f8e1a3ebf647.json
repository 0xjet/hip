{
    "id": "12fdab3b-0554-4c2e-a4dc-f8e1a3ebf647",
    "created_at": "2023-05-06T02:09:33.102353Z",
    "updated_at": "2025-03-27T02:16:14.133013Z",
    "deleted_at": null,
    "sha1_hash": "13134bf84cf14025c278d060ad47e5e2cfd6fa12",
    "title": "2023-04-21 - MuddyWaters back with DarkBit",
    "authors": "",
    "file_creation_date": "2023-05-05T02:05:50Z",
    "file_modification_date": "2023-05-05T02:05:50Z",
    "file_size": 2469308,
    "plain_text": "# MuddyWater Back with DarkBit\n\n**[labs.k7computing.com/index.php/muddywater-back-with-darkbit/](https://labs.k7computing.com/index.php/muddywater-back-with-darkbit/)**\n\nBy Sudeep April 21, 2023\n\nRecently, we came across a [tweet about DarkBit ransomware. An Iranian APT group,](https://twitter.com/h2jazi/status/1638923200527474691)\nnamed MuddyWater, is reportedly behind the DarkBit ransomware. In this blog we will\nexplore the ransomware’s initial access method, the use of Cobalt Strike and the final\nransomware payload.\n\n## Initial Access Method\n\nThe initial lure was delivered as an ISO file.\n\nFigure 1 – ISOFile\nThe payload included a shortcut file (with a .doc extension) and a zip file.\n\n\n-----\n\nFigure 2 – Contents Inside ISO File\nThe shortcut was using PrintBrm.exe to unpack the HR-Update.zip and run it as shown\n[below. PrintBrm.exe is a windows inbuilt command line tool.](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj134237(v=ws.11))\n\nFigure 3 – Shortcut File\n```\ncmd.exe /c xcopy .\\HR-Update.zip %TEMP% /h /y && PrintBrm.exe -r -f %TEMP%\\HRUpdate.zip -d %TEMP%\\unzip & %TEMP%\\unzip\\HR-Update.exe\n\n```\nFigure 4 – HR-Update.exe Running\nHR-Update.exe was a Cobalt Strike beacon. Cobalt Strike, a penetration testing tool, can\nalso be used by attackers for gaining a foothold in the system. The final ransomware\npayload is downloaded with the help of Cobalt Strike.\n\n\n-----\n\nAt the time of writing the blog, we were unable to get the exact DarkBit ransomware\npayload. So we are using another available sample that belonged to the same campaign.\n\n## Analysis of Ransomware\n\nThis DarkBit ransomware sample is written in GoLang. It contains command line\narguments.\n\nFigure 5 – Ransomware Features\n\nIt also contains an inbuilt configuration file as shown in Figure 6.\n\n\n-----\n\nFigure 6 – InBuilt Config\nFurther analysis revealed that they had obfuscated some dll names like advapi32.dll and\nfunctions like SystemFunction036.\n\nFigure 7- Obfuscation\n\nIts dynamically resolving API at this address. Malware authors tend to dynamically resolve\nAPI to avoid static detections.\n\n\n-----\n\nFigure 8 –\n\nDynamically Resolving API\nCreateMutexW API is being used to check if an instance of the malware is already\nrunning. As can be seen in Figure 5 previously, they are also using multithreading.\n\nAs the customary prelude to file encryption, they are using vssadmin.exe to delete all the\nshadow copies.\n\nFigure 9 – Delete\n\nShadow all\n[Here they are using SystemFunction036 (documented in MSDN as RtlGenRandom) to](https://learn.microsoft.com/en-us/windows/win32/api/ntsecapi/nf-ntsecapi-rtlgenrandom)\ngenerate a random key as shown in Figure 10.\n\n\n-----\n\nFigure 10 – SystemFunction036\nSystemFunction036 is accessed multiple times in the code with varying buffer sizes\npassed to it.\n\nFigure 11 – Call To Dynamically Resolve API and\n\nThen SystemFunction036\nHere we can see that the buffer size of 80 is made available for SystemFunction036.\n\n\n-----\n\nFigure 12 – Encrypting Key\n\nLater-on, the key used for encrypting the files is itself encrypted and attached to the\nencrypted files.\n\nFigure 13 – EncryptionAlgorithm\n\nFrom Figure 13, we can see that It’s encrypting. It is likely using AES to encrypt the files,\nas strings related to the same functions can be found elsewhere in this same sample.\n\nFindFirstFileW, FindNextFileW are used to iterate through the file system, to find the\nappropriate file and then encrypt it.\n\nAt that point it was observed that its writing file in chunks and not as a whole. For doing the\nsame it’s using SetFilePointerEx API to move the file pointer to a specific address.\n\n\n-----\n\nFigure 14 – SetFilePointerEx\nIt’s then using the WriteFile API.\n\nFigure 15 – WriteFile\nAll these functions are called one after another, till all the files are encrypted.\n\nAfter encrypting the file, the key is stored at the end of the file.\n\n\n-----\n\nFigure 16 – Ransomware key\nThe encrypted files are given ‘.darkbit’ extension and also a ransom note is dropped in the\nrespective folders.\n\nFigure 17 – Ransomware Note\n\n\n-----\n\nFigure 18 – Tweet on\n\nDarkBit\nMuddyWaters uses different types of attacks for initial access like phishing email\ncampaigns, using tools like MimiKatz to break into the system, etc. In this case,\nMuddyWaters made use of Cobalt Strike to get initial access into the system. From the\nransomware note, we figured out that it was a politically motivated attack.\n\nWe at K7 Labs provide detection for DarkBit ransomware and all the latest threats. Users\nare advised to use a reliable security product such as “K7 Total Security” and keep it up-todate to safeguard their devices.\n\n## Indicators of Compromise (IOCs)\n\n**File Name** **Hash** **Detection Name**\n\nDarkBit.exe 9880FAE6551D1E9EE921F39751A6F3C0 Trojan (0058e3dd1)\n\nhr-update.iso 1219A8880DEBDD10D081195E27A2A016 Trojan (0001140e1)\n\n### References\n\n[https://attack.mitre.org/groups/G0069/](https://attack.mitre.org/groups/G0069/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-04-21 - MuddyWaters back with DarkBit.pdf"
    ],
    "report_names": [
        "2023-04-21 - MuddyWaters back with DarkBit.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2ed8d590-defa-4873-b2de-b75c9b30931e",
            "created_at": "2023-01-06T13:46:38.730137Z",
            "updated_at": "2025-03-27T02:00:02.903261Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "Boggy Serpens",
                "Mango Sandstorm",
                "TEMP.Zagros",
                "Static Kitten",
                "G0069",
                "TA450",
                "Earth Vetala",
                "Seedworm",
                "COBALT ULSTER",
                "ATK51"
            ],
            "source_name": "MISPGALAXY:MuddyWater",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "31e69945-6c1e-40c3-ba8e-a77e81dd142a",
            "created_at": "2024-05-01T02:03:08.047377Z",
            "updated_at": "2025-03-27T02:05:17.326452Z",
            "deleted_at": null,
            "main_name": "COBALT ULSTER",
            "aliases": [
                "ENT-11 ",
                "ITG17 ",
                "MERCURY ",
                "Mango Sandstorm ",
                "MuddyWater ",
                "STAC 1171 ",
                "Seedworm ",
                "Static Kitten ",
                "TEMP.Zagros ",
                "UNC3313 ",
                "Yellow Nix ",
                "Earth Vetala "
            ],
            "source_name": "Secureworks:COBALT ULSTER",
            "tools": [
                " Canopy",
                " CrackMapExec",
                " CredNinja",
                " Empire",
                " FORELORD",
                " Koadic",
                " LaZagne",
                " Ligolo",
                " MKL64",
                " Metasploit",
                " Mimikatz",
                " MiniDump",
                " Mori",
                " MuddyC2Go",
                " MuddyC3",
                " PhonyC2",
                " Plink",
                " PowGoop",
                " PowerStats",
                " RemoteUtilities",
                " Revsocks",
                " ScreenConnect",
                " SimpleHelp",
                " Small Sieve",
                " Syncro",
                " Venom Proxy",
                " WMIExec",
                "AnyDesk"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "02e1c2df-8abd-49b1-91d1-61bc733cf96b",
            "created_at": "2022-10-25T15:50:23.308924Z",
            "updated_at": "2025-03-27T02:00:55.437268Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "MuddyWater",
                "Earth Vetala",
                "Static Kitten",
                "Seedworm",
                "TEMP.Zagros",
                "Mango Sandstorm",
                "TA450"
            ],
            "source_name": "MITRE:MuddyWater",
            "tools": [
                "STARWHALE",
                "POWERSTATS",
                "Out1",
                "PowerSploit",
                "Small Sieve",
                "Mori",
                "Mimikatz",
                "LaZagne",
                "PowGoop",
                "CrackMapExec",
                "ConnectWise",
                "SHARPSTATS",
                "RemoteUtilities",
                "Koadic"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3c430d71-ab2b-4588-820a-42dd6cfc39fb",
            "created_at": "2022-10-25T16:07:23.880522Z",
            "updated_at": "2025-03-27T02:02:10.010443Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "ATK 51",
                "Boggy Serpens",
                "Cobalt Ulster",
                "ITG17",
                "Mango Sandstorm",
                "MuddyWater",
                "Operation BlackWater",
                "Operation Earth Vetala",
                "Operation Quicksand",
                "Seedworm",
                "Static Kitten",
                "T-APT-14",
                "TA450",
                "TEMP.Zagros",
                "Yellow Nix"
            ],
            "source_name": "ETDA:MuddyWater",
            "tools": [
                "Agentemis",
                "BugSleep",
                "CLOUDSTATS",
                "ChromeCookiesView",
                "Cobalt Strike",
                "CobaltStrike",
                "CrackMapExec",
                "DELPHSTATS",
                "EmPyre",
                "EmpireProject",
                "FruityC2",
                "Koadic",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "MZCookiesView",
                "Meterpreter",
                "Mimikatz",
                "MuddyC2Go",
                "MuddyRot",
                "Mudwater",
                "POWERSTATS",
                "PRB-Backdoor",
                "PhonyC2",
                "PowGoop",
                "PowerShell Empire",
                "PowerSploit",
                "Powermud",
                "QUADAGENT",
                "SHARPSTATS",
                "SSF",
                "Secure Socket Funneling",
                "Shootback",
                "Smbmap",
                "Valyria",
                "chrome-passwords",
                "cobeacon",
                "prb_backdoor"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1683338973,
    "ts_updated_at": 1743041774,
    "ts_creation_date": 1683252350,
    "ts_modification_date": 1683252350,
    "files": {
        "pdf": "https://archive.orkl.eu/13134bf84cf14025c278d060ad47e5e2cfd6fa12.pdf",
        "text": "https://archive.orkl.eu/13134bf84cf14025c278d060ad47e5e2cfd6fa12.txt",
        "img": "https://archive.orkl.eu/13134bf84cf14025c278d060ad47e5e2cfd6fa12.jpg"
    }
}