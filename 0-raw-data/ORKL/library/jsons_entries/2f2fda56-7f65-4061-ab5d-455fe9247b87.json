{
    "id": "2f2fda56-7f65-4061-ab5d-455fe9247b87",
    "created_at": "2023-01-12T15:06:45.937992Z",
    "updated_at": "2025-03-27T02:16:28.785359Z",
    "deleted_at": null,
    "sha1_hash": "6568b7547682f1607dd85afc661f984734338a5f",
    "title": "2020-12-02 - APT32 Multi-stage macOS Trojan Innovates on Crimeware Scripting Technique",
    "authors": "",
    "file_creation_date": "2022-05-28T19:55:58Z",
    "file_modification_date": "2022-05-28T19:55:58Z",
    "file_size": 3078835,
    "plain_text": "# APT32 Multi-stage macOS Trojan Innovates on Crimeware Scripting Technique\n\n**[labs.sentinelone.com/apt32-multi-stage-macos-trojan-innovates-on-crimeware-scripting-technique/](https://labs.sentinelone.com/apt32-multi-stage-macos-trojan-innovates-on-crimeware-scripting-technique/)**\n\nPhil Stokes\n\n[In the same week as Microsoft disclosed the Vietnamese-linked APT32 (aka “OceanLotus”,](https://www.microsoft.com/security/blog/2020/11/30/threat-actor-leverages-coin-miner-techniques-to-stay-under-the-radar-heres-how-to-spot-them/)\n“Bismuth”, “SeaLotus”) group deploying Cryptominer software like a common crimeware\nadversary, [researchers at Trend Micro released details of an update to an APT32 macOS](https://www.trendmicro.com/en_us/research/20/k/new-macos-backdoor-connected-to-oceanlotus-surfaces.html)\nbackdoor that also appears to have been taking lessons from commodity malware authors.\nThe backdoor uses a novel method of delivery that echoes other threat actor techniques as\nwell as adds some interesting new behaviour. In this post, we’ll review some of the details in\nthe earlier report but also add some new IoCs and observations that have not yet been\nmentioned.\n\n## Disguised App Bundle Used for Delivery\n\nThe malware is delivered as an application disguised as an MS Office Word doc.\n\n\n-----\n\nThe previous research noted that the malware deploys a novel trick to prevent MS Office\nattempting to launch the disguised app as a doc by embedding a unicode character in the file\nname. This causes launch services to call “open” on the file rather than the default program\nfor “.doc”.\n\nOn launch, the malware switches out the malicious application bundle for an actual MS\nOffice doc: the same file name is used but now minus the hidden Unicode character. After\nthe bait and switch, this doc is launched and presented to the user.\n\n\n-----\n\nThe whole trick is invisible to the user, who only sees a document appearing with the same\nname as the one they double-clicked on. Meanwhile, the second stage payload has been\ndeposited in the `/tmp folder and begins its run to install a hidden persistence agent and the`\nthird stage malicious executable.\n\n## Shell Executable Contains Base64-encoded Mach-O\n\n[That trick is accompanied by the borrowing of a technique that has become popular among](https://www.sentinelone.com/blog/2020/01/29/scripting-macs-with-malice-how-shlayer-and-other-malware-installers-infect-macos/)\ncommodity adware and malware distributors; namely, using a shell script both as the main\nexecutable inside the app bundle and also as a vehicle to drop an embedded base64encoded payload.\n\nNote line 4, which defines a variable with around 850Kb of base64-encoded data. At line 40,\nthat data is piped through the base64 utility for decoding, dropped in a subfolder in the\n```\n/tmp directory, given executable permissions via chmod, and then launched as the 2nd\n\n```\nstage payload.\n\nImportantly, prior to line 40, the script takes measures to deal with two macOS security\nfeatures: [App Translocation and](https://developer.apple.com/documentation/fileprovider/nsfileprovidererror/3554437-providertranslocated) [file quarantine. The former was a security feature brought in](https://www.sentinelone.com/blog/2019/04/17/how-to-reverse-malware-on-macos-without-getting-infected-part-3/)\nby Apple to prevent executables accessing external resources via relative paths and\nbypassing Gatekeeper checks. However, like Gatekeeper itself, App Translocation relies on\n[the executable being tagged with the com.apple.quarantine bit.](https://www.sentinelone.com/blog/2019/01/03/how-malware-bypass-macos-gatekeeper/)\n\n\n-----\n\nIn this case, the script agressively attempts to remove all quarantine bits and, in the event\nany of those fail and the malware finds itself translocated to a read-only filepath, it then\nundertakes a hunt for the original downloaded file via its MD5 hash and attempts to execute\nit from its non-translocated path on disk.\n\n## Second Stage Payload’s Hidden Persistence Mechanism\n\nThe second stage payload, once dumped from the encoded base64, is a universal FAT\nbinary containing Mach-Os for i386 and x86_64 architectures. The source code was written\nin C++.\n\nAs earlier research pointed out, this stage is responsible for dropping a persistence agent\nwith the label of “com.apple.marcoagent.voiceinstallerd” and its program argument,\n“mount_devfs”.\n\nHowever, we also note that this stage has code for testing the UID and determining whether\nthe executable is being run as root or not. If so, the persistence mechanism is now written to\n/Library/LaunchDaemons instead of the user’s Library LaunchAgents folder.\n\n\n-----\n\nIn either case, the program argument is the same, pointing to a custom subfolder in the\nLibrary folder called “User Photos” and an executable, `mount_devfs, which is similarly a`\nuniversal FAT binary containing Mach-Os written in C++.\n\nA further point not mentioned in the earlier research is that the Launch Agent or Launch\nDaemon is written using the “Hidden” flag so that users won’t see it in the Finder by default.\n\n## Third Stage Payload and Hard-coded Calling Card\n\nAccording to the earlier research, the malicious “mount_devfs” file provides the actors with\nbackdoor capabilities, which include the ability to exfiltrate information as well as download\nfiles to the target machine.\n\nFor downloading, the actors make use of the same built-in dylib as we’ve seen used by\nLazarus APT, `libcurl.4.dylib .`\n\n\n-----\n\nThe third stage payload has the ability to collect data regarding the device and its\nenvironment, including the computer host name.\n\nCuriously, the sample has two hardcoded strings that presumably are meant as a “calling\ncard” or have some internal meaning to the malware developers:\n```\n\"JasyndurtheHandoftheKing\"\n\"CagliostrothePrecise\"\n\n```\n\n-----\n\n## Detection and Mitigation\n\nAlthough these samples were unknown to static signature engines prior to the publication of\nthis week’s research, the malware was already detectable through behavioral means.\n\nThe first stage attempts to remove the quarantine bit on every file starting from both the\nUser’s Home directory, `~/, and from` `/ . This is incredibly “noisy” from a detection point of`\nview, as no legitimate process is likely to have such behavior.\n\n[The 2nd stage payload can trigger detections on MITRE TTPs T1150 and](https://attack.mitre.org/techniques/T1150) [T1160 as it](https://attack.mitre.org/techniques/T1160)\nattempts to achieve persistence.\n\n\n-----\n\nThe samples’ code signatures have now been revoked by Apple, although it is still possible\n[to execute the malware either by removing the signature or re-signing it with a different](https://www.sentinelone.com/blog/2020/03/09/macos-malware-researchers-how-to-bypass-xprotect-on-catalina/)\ndeveloper ID or ad hoc signature.\n\nDefenders can hunt both for the Team Identifier used to sign the malware, “UD9UN593Z4”,\nand the bundle identifier of the initial malicious application, “com.apple.files”. The persistence\nmechanism’s label “com.apple.marcoagent.voiceinstallerd” and executable path\n“[~]/Library/User Photos/mount_devfs” should also be included in the IoCs for threat hunting.\n\nIn our tested sample, the malware C2 was a URL hosted at the domain\n```\nmihannevis[.]com :\nhttp[:]//mihannevis.com/joes/NAZALgEyGj7b3jNYzbypYX8a/manifest[.]js\n\n```\n\n-----\n\nThe third stage payload is not well-known to static reputation engines as yet, so defenders\nshould look to behavioural indicators to ensure detection.\n\n## Conclusion\n\nWhile much macOS malware is often very simply or inexpertly written, the actors behind this\nmulti-stage backdoor trojan have both deployed some novel tricks and improved upon\n[techniques seen in commodity malware such as Shlayer and adware like bundlore. This](https://www.sentinelone.com/blog/2020/09/08/coming-out-of-your-shell-from-shlayer-to-zshlayer/)\nindicates that they have both the skills and the resources to imitate and innovate in order to\nachieve their objectives.\n\n## Indicators of Compromise\n\n\n-----\n\n**SHA1**\nc2e0b35fd4f24e9e98319e10c6f2f803b01ec3f1  – Application Bundle Zip\n9f84502cb44b82415bcf2b2564963613bdce1917 – Stage 2 Mach-O\n4f6d34cf187c10d72fb3a2cd29af7e3cb25bc3aa – Stage 3 Mach-O\n\n**SHA256**\ncfa3d506361920f9e1db9d8324dfbb3a9c79723e702d70c3dc8f51825c171420 – Application\nBundle Zip\n05e5ba08be06f2d0e2da294de4c559ca33c4c28534919e5f2f6fc51aed4956e3 – Stage 2\nMach-O\nfd7e51e3f3240b550f0405a67e98a97d86747a8a07218e8150d2c2946141f737 – Stage 3\nMach-O\n\n**FilePaths**\n\n[~]/Library/User Photos/mount_devfs\n/Library/LaunchDaemons/com.apple.marcoagent.voiceinstallerd.plist\n~/Library/LaunchAgents/com.apple.marcoagent.voiceinstallerd.plist\n\n**C2 Servers**\nmihannevis[.]com\nmykessef[.]com\nidtpl[.]org\n\n**Code Signature**\n```\nIdentifier=com.apple.files\nFormat=app bundle with generic\nCodeDirectory v=20200 size=159 flags=0x0(none) hashes=1+3 location=embedded\nHash type=sha1 size=20\nCandidateCDHash sha1=3c6c754b58f4450505494f1b68104d0154d19296\nCandidateCDHashFull sha1=3c6c754b58f4450505494f1b68104d0154d19296\nHash choices=sha1\nCMSDigest=eee562155af89168a52d306f11facca999d84505df789a1d8124d8446c726bc5\nCMSDigestType=2\nCDHash=3c6c754b58f4450505494f1b68104d0154d19296\nSignature size=8576\nAuthority=(unavailable)\nInfo.plist=not bound\nTeamIdentifier=UD9UN593Z4\nSealed Resources version=2 rules=12 files=2\nhost => identifier \"com.apple.bash\" and anchor apple\ndesignated => anchor apple generic and identifier \"com.apple.files\" and (certificate\nleaf[field.1.2.840.113635.100.6.1.9] /* exists */ or certificate\n1[field.1.2.840.113635.100.6.2.6] /* exists */ and certificate\nleaf[field.1.2.840.113635.100.6.1.13] /* exists */ and certificate leaf[subject.OU] =\nUD9UN593Z4)\n\n```\n\n-----\n\n**MITRE ATT&CK TTPs**\n[Process achieved persistency through launchd job. T1150](https://attack.mitre.org/techniques/T1150)\nProcess dropped a hidden suspicious plist to achieve persistency. [T1160](https://attack.mitre.org/techniques/T1160)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-12-02 - APT32 Multi-stage macOS Trojan Innovates on Crimeware Scripting Technique.pdf"
    ],
    "report_names": [
        "2020-12-02 - APT32 Multi-stage macOS Trojan Innovates on Crimeware Scripting Technique.pdf"
    ],
    "threat_actors": [
        {
            "id": "3f86085e-95c5-4007-8bd7-86ad330ce4eb",
            "created_at": "2022-10-25T16:07:24.457008Z",
            "updated_at": "2025-03-27T02:02:10.238521Z",
            "deleted_at": null,
            "main_name": "Bismuth",
            "aliases": [
                "Canvas Cyclone"
            ],
            "source_name": "ETDA:Bismuth",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "870f6f62-84f5-48ca-a18e-cf2902cd6924",
            "created_at": "2022-10-25T15:50:23.303818Z",
            "updated_at": "2025-03-27T02:00:55.435309Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "APT32",
                "SeaLotus",
                "OceanLotus",
                "APT-C-00",
                "Canvas Cyclone"
            ],
            "source_name": "MITRE:APT32",
            "tools": [
                "Mimikatz",
                "ipconfig",
                "Kerrdown",
                "Cobalt Strike",
                "SOUNDBITE",
                "OSX_OCEANLOTUS.D",
                "KOMPROGO",
                "netsh",
                "RotaJakiro",
                "PHOREAL",
                "Arp",
                "Denis",
                "Goopy"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "af509bbb-8d18-4903-a9bd-9e94099c6b30",
            "created_at": "2023-01-06T13:46:38.585525Z",
            "updated_at": "2025-03-27T02:00:02.866727Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "TIN WOODLAWN",
                "OceanLotus Group",
                "OceanLotus",
                "Sea Lotus",
                "G0050",
                "Cobalt Kitty",
                "SeaLotus",
                "ATK17",
                "Ocean Lotus",
                "Ocean Buffalo",
                "POND LOACH",
                "Canvas Cyclone",
                "APT-C-00",
                "APT-32",
                "APT 32"
            ],
            "source_name": "MISPGALAXY:APT32",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f1518ac1-4710-4dd1-a422-e3801e4806cb",
            "created_at": "2024-05-01T02:03:08.147856Z",
            "updated_at": "2025-03-27T02:05:17.421275Z",
            "deleted_at": null,
            "main_name": "TIN WOODLAWN",
            "aliases": [
                "Cobalt Kitty",
                "OceanLotus",
                "WOODLAWN ",
                "APT32 "
            ],
            "source_name": "Secureworks:TIN WOODLAWN",
            "tools": [
                " Denis",
                " Goopy",
                " JEShell",
                " KerrDown",
                " Mimikatz",
                " Ratsnif",
                " Remy",
                " Rizzo",
                " RolandRAT",
                "Cobalt Strike"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "2439ad53-39cc-4fff-8fdf-4028d65803c0",
            "created_at": "2022-10-25T16:07:23.353204Z",
            "updated_at": "2025-03-27T02:02:09.749502Z",
            "deleted_at": null,
            "main_name": "APT 32",
            "aliases": [
                "APT 32",
                "APT-C-00",
                "APT-LY-100",
                "ATK 17",
                "Lotus Bane",
                "Ocean Buffalo",
                "OceanLotus",
                "Operation Cobalt Kitty",
                "Operation PhantomLance",
                "Pond Loach",
                "SeaLotus",
                "SectorF01",
                "Tin Woodlawn"
            ],
            "source_name": "ETDA:APT 32",
            "tools": [
                "Agentemis",
                "Android.Backdoor.736.origin",
                "AtNow",
                "Backdoor.MacOS.OCEANLOTUS.F",
                "BadCake",
                "CACTUSTORCH",
                "CamCapture Plugin",
                "CinaRAT",
                "Cobalt Strike",
                "CobaltStrike",
                "Cuegoe",
                "DKMC",
                "Denis",
                "Goopy",
                "HiddenLotus",
                "KOMPROGO",
                "KerrDown",
                "METALJACK",
                "MSFvenom",
                "Mimikatz",
                "Nishang",
                "OSX_OCEANLOTUS.D",
                "OceanLotus",
                "PHOREAL",
                "PWNDROID1",
                "PhantomLance",
                "PowerSploit",
                "Quasar RAT",
                "QuasarRAT",
                "RatSnif",
                "Remy",
                "Remy RAT",
                "Rizzo",
                "Roland",
                "Roland RAT",
                "SOUNDBITE",
                "Salgorea",
                "Splinter RAT",
                "Terracotta VPN",
                "Yggdrasil",
                "cobeacon",
                "denesRAT",
                "fingerprintjs2"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536005,
    "ts_updated_at": 1743041788,
    "ts_creation_date": 1653767758,
    "ts_modification_date": 1653767758,
    "files": {
        "pdf": "https://archive.orkl.eu/6568b7547682f1607dd85afc661f984734338a5f.pdf",
        "text": "https://archive.orkl.eu/6568b7547682f1607dd85afc661f984734338a5f.txt",
        "img": "https://archive.orkl.eu/6568b7547682f1607dd85afc661f984734338a5f.jpg"
    }
}