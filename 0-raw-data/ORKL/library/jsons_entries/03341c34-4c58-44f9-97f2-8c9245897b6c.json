{
    "id": "03341c34-4c58-44f9-97f2-8c9245897b6c",
    "created_at": "2023-01-12T15:07:32.9106Z",
    "updated_at": "2025-03-27T02:13:37.146829Z",
    "deleted_at": null,
    "sha1_hash": "a435b312832ae2ba2fce2c72b40890aee85eb729",
    "title": "2021-08-20 - New variant of Konni malware used in campaign targetting Russia",
    "authors": "",
    "file_creation_date": "2022-05-28T03:32:51Z",
    "file_modification_date": "2022-05-28T03:32:51Z",
    "file_size": 5053082,
    "plain_text": "# New variant of Konni malware used in campaign targetting Russia\n\n**[blog.malwarebytes.com/threat-intelligence/2021/08/new-variant-of-konni-malware-used-in-campaign-targetting-russia/](https://blog.malwarebytes.com/threat-intelligence/2021/08/new-variant-of-konni-malware-used-in-campaign-targetting-russia/)**\n\nThreat Intelligence Team August 20, 2021\n\n_This blog post was authored by Hossein Jazi_\n\nIn late July 2021, we identified an ongoing spear phishing campaign pushing Konni Rat to target\nRussia. Konni was first observed in the wild in 2014 and has been potentially linked to the North\nKorean APT group named APT37.\n\nWe discovered two documents written in Russian language and weaponized with the same\nmalicious macro. One of the lures is about the trade and economic issues between Russia and\nthe Korean Peninsula. The other one is about a meeting of the intergovernmental RussianMongolian commission.\n\nIn this blog post we provide on overview of this campaign that uses two different UAC bypass\ntechniques and clever obfuscation tricks to remain under the radar.\n\n## Attack overview\n\nThe following diagram shows the overall flow used by this actor to compromise victims. The\nmalicious activity starts from a document that executes a macro followed by a chain of activities\nthat finally deploys the Konni Rat.\n\n\n-----\n\nFigure 1: Overall Process\n\n## Document analysis\n\nWe found two lures used by Konni APT. The first document “Economic relations.doc” contains a\n12 page article that seems to have been published in 2010 with the title: “The regional economic\n_contacts of Far East Russia with Korean States (2010s)“. The second document is the outline of_\na meeting happening in Russia in 2021: “23th meeting of the intergovernmental Russian_Mongolian commission on Trade, Economic, scientific and technical operation“._\n\nFigure 2: Lures used by Konni APT\n\nThese malicious documents used by Konni APT have been weaponized with the same simple\nbut clever macro. It just uses a Shell function to execute a one-liner cmd command. This one\nliner command gets the current active document as input and looks for the `\"^var\" string using`\n```\nfindstr and then writes the content of the line staring from “var” into y.js . At the end it calls\nWscript Shell function to executes the Java Script file ( y js )\n\n```\n\n-----\n\nThe clever part is that the actor tried to hide its malicious JS which is the start of its main\nactivities at the end of the document content and did not put it directly into the macro to avoid\nbeing detected by AV products as well as hiding its main intent from them.\n\nFigure 3: Macro\nThe y .js file is being called with the active document as its argument. This javascript looks for\ntwo patterns encoded within the the active document and for each pattern at first it writes that\ncontent starting from the pattern into `temp.txt file and then base 64 decodes it using its built-`\nin base64 decoder function, `function de(input), and finally writes the decoded content into`\nthe defined output.\n```\nyy.js is used to store the data of the first decoded content and y.ps1 is used to store the\n\n```\ndata of the second decoded content. After creating the output files, they are executed using\n```\nWscript and Powershell .\n\n```\nFigure 4: y.js\nThe Powershell script ( y.ps1 ), uses `DllImport function to import` `URLDownloadToFile`\nfrom `urlmon.dll and` `WinExec from` `kernel32.dll . After importing the required functions`\nit defines the following variabbles:\n\nURL to download a file from it\nDirectory to store the downloaded file (%APPDATA%/Temp)\nName of the downloaded file that will be stored on disk.\n\n\n-----\n\nIn the next step it calls `URLDownloadToFile to download a cabinet file and stores it in the`\n```\n%APPDATA%Temp directory with the unique random name created by GetTempFileName . At the\n\n```\nend it uses `WinExec to execute a cmd command that calls` `expand to extract the content of`\ncabinet file and delete the cabinet file. The `y.ps 1 is deleted at the end using` `Winexec .`\n\nFigure 5: y.ps1\nThe extracted cabinet file contains 5 files: `check.bat,` `install.bat,` `xmlprov.dll,`\n```\nxmlprov.ini and xwtpui.dll . The yy.js is responsible to execute check.bat file that\n\n```\nextracted from the cabinet file and delete itself at the end.\n\nFigure 6: yy.js\n\n## Check.bat\n\n\n-----\n\nThis batch file checks if the command prompt is launched as administrator using `net session`\n```\n> nul and if that is the case, it executes install.bat . If the user does not have the\n\n```\nadministrator privilege, it checks the OS version and if it is Windows 10 sets a variable named\n```\nnum to 4, otherwise it sets it to 1. It then executes xwtpui.dll using rundll32.exe by\n\n```\npassing three parameters to it: `EntryPoint (The export function of the DLL to be executed),`\n```\nnum (the number that indicated the OS version) and install.bat .\n\n```\nFigure 7:\n\ncheck.bat\n\n## Install.bat\n\nthe malware used by the attacker pretends to be the xmlprov Network Provisioning Service. This\nservice manages XML configuration files on a domain basis for automatic network provisioning.\n```\nInstall.bat is responsible to install xmlprov.dll as a service. To achieve this goal, it\n\n```\nperforms the following actions:\n\nStop the running `xmlprov service`\nCopy dropped `xmlprov.dll and` `xmlrov.ini into the system32 directory and delete`\nthem from the current directory\nCheck if `xmlProv service is installed or not and if it is not installed create the service`\nthrough `svchost.exe`\nModify the `xmlProv service values including` `type and` `binpath`\nAdd `xmlProv to the list of the services to be loaded by` `svchost`\nadd `xmlProv to the` `xmlProv registry key`\nStart the `xmlProv service`\n\n\n-----\n\nFigure 8:\n\nInstall.bat\n\n## xwtpui.dll\n\nAs we mentioned earlier if the victim’s machine does not have the right privilege, `xwtpui.dll`\nis being called to load `install.bat file. Since` `install.bat is creating a service, it should`\nhave the high integrity level privilege and `\"xwtpui.dll\" is used to bypass UAC and get the`\nright privilege and then loads `install.bat .`\n```\nEntryPoint is the main export function of this dll. It starts its activities by resolving API calls.\n\n```\nAll the API call names are hard coded and the actor has not used any obfuscation techniques to\nhide them.\n\n\n-----\n\nFigure 9: EntryPoint\nIn the next step, it checks privilege level by calling the `Check_Priviledge_Leve l function. This`\nfunction performs the following actions and returns zero if the user does not have the right\nprivilege or UAC is not disabled.\n\nCall `RtlQueryElevationFlags to get the elevation state by checking` `PFlags value. If`\nit sets to zero, it indicates that UAC is disabled.\n\n\n-----\n\nGet the access token associated to the current process using `NtOpenProcessToken and`\nthen call `NtQueryInformationToken to get the` `TokenElevationType and check if it’s`\nvalue is 3 or not (If the value is not 3, it means the current process is elevated). The\nTokenElevationType can have three values:\n\nTokenElevationDefault (1): Indicates that UAC is disabled.\nTokenElevationTypeFull (2): Indicates that the current process is running elevated.\nTokenElevationTypeLimited (3): Indicates that the process is not running elevated.\n\nFigure 10: Check privilege\n\nlevel\nAfter checking the privilege level, it checks the parameter passed form `check.bat that`\nindicates the OS version and if the OS version is Windows 10 it uses a combination of a\n[modified version of RPC UAC bypass reported by Google Project Zero and Parent PID Spoofing](https://googleprojectzero.blogspot.com/2019/12/)\nfor UAC bypass while for other Windows versions it uses “ Token Impersonation technique ”\ntechnique to bypass UAC.\n\n### Token Impersonation UAC Bypass (Calvary UAC Bypass)\n\nCalvary is a token impersonation/theft privilege escalation technique that impersonates the\ntoken of the Windows Update Standalone Installer process ( wusa.exe ) to spawn `cmd.exe`\nwith highest privilege to execute `install.bat . This technique is part of the US CIA toolsets`\nleak known as Vault7.\n\n\n-----\n\n[The actor has used this method on its 2019 campaign as well. This UAC bypass starts by](https://e.cyberint.com/hubfs/Cyberint_Konni%20Malware%202019%20Campaign_Report.pdf)\nexecuting `wusa.exe using` `ShellExecuteExw and gets its access token using`\n```\nNtOpenProcessToken . Then the access token of wusa.exe is duplicated using\nNtDuplicatetoken . The DesiredAccess parameter of this function specifies the requested\n\n```\naccess right for the new token. In this case the actor passed `TOKEN_ALL_ACCESS as`\n```\nDesiredAccess value which indicates that the new token has the combination of all access\n\n```\nrights of this current token. The duplicated token is then passed to\n```\nImpersonateLoggedOnUser and then a cmd instance is spawned using\nCreateProcessWithLogomW . At the end the duplicated token is assigned to the created thread\n\n```\nusing `NtSetINformationThread to make it elevated.`\n\n\n-----\n\nFigure 11: Cavalry PE\n\n### Windows 10 UAC Bypass\n\nThe UAC bypass used for Windows 10 uses a combination of a modified version of RPC based\n[UAC bypass reported by Google project Zero and Parent PID spoofing to bypass UAC. The](https://googleprojectzero.blogspot.com/2019/12/)\nprocess is as follows:\n\nStep 1: Creates a string binding handle for interface id “201ef99a-7fa0-444c-9399**19ba84f12a1a” and returns its binding handle and sets the required authentication,**\nauthorization and security Quality of service information for the binding handle.\n\n\n-----\n\nFigure 12: RPC Binding\n\nStep 2: Initializes an RPC_ASYNC_STATE to make asynchronous calls and creates a new\nnon-elevated process (it uses `winver.exe as non-elevated process)`\nthrough `NdrAsyncClientCall .`\n\n\n-----\n\nFigure 13: RPC AsyncCall\n\nStep 3: Uses `NtQueryInformationProcess to Open a handle to the debug object by`\npassing the handle of the created process to it. Then detaches the debugger from the\nprocess using `NtRemoveProcessDebug and terminates this created process using`\n\n\n-----\n\nFigure 14: Detach the process\n\nStep 4: Repeats the step 1 and step 2 to create a new elevate process: `Taskmgr.exe .`\nStep 5: Get full access to the `taskmgr.exe process handle by retrieving its initial debug`\nevent. At first It issues a wait on the debug object using `WaitForDebugEvent to get the`\ninitial process creation debug event and then uses `NtDuplicateObject to get the full`\naccess process handle.\n\nFigure 15: Create Auto elevated process (TaskMgr.exe)\n\n\n-----\n\nStep 6: After obtaining the fully privileged handle of `Taskmgr.exe, the actor uses this`\nhandle to execute cmd as high privilege process to execute `install.bat . To achieve`\nthis, the actor has used Parent PID Spoofing technique to spawn a new cmd process\nusing `CreateProcessW and handle of` `Taskmgr.exe which is an auto elevated process`\nis assigned as its parent process using `UpdateProcThreadAttribute .`\n\nFigure 16: Parent PID Spoofing\n\n## Xmlprov.dll (Konni Rat)\n\n\n-----\n\nThis is the final payload that has been deployed as a service using `svchost.exe . This Rat is`\nheavily obfuscated and is using multiple anti-analysis techniques. It has a custom section\nnamed “ qwdfr0 ” which performs all the de-obfuscation process. This payload register itself as\na service using its export function `ServiceMain .`\n\nFigure 17: ServiceMain\nEven though this sample is heavily obfuscated its functionality has not changed much and it is\n[similar to its previous version. It seems the actor just used a heavy obfuscation process to](https://e.cyberint.com/hubfs/Cyberint_Konni%20Malware%202019%20Campaign_Report.pdf)\nhinder all the security mechanisms. VirusTotal detection of this sample at the time of analysis\nwas 3 which indicates that the actor was successful in using obfuscation and bypass most of the\nAV products.\n\nThis RAT has an encrypted configuration file “xmlprov.ini” which will be loaded and decrypted at\nthe start of the analysis. The functionality of this RAT starts by collecting information from the\nvictim’s machine by executing the following commands:\n```\n   cmd /c systeminfo: Uses this command to collect the detailed configuration\n\n```\ninformation about the victim’s machine including operation system configurations, security\ninformation and hardware data (RAM size, disk space and network cards info) and store\nthe collected data in a tmp file.\n```\n   cmd /c tasklist : Executes this command to collect a list of running processes on\n\n```\nvictim’s machine and store them in a tmp file.\n\n\n-----\n\nIn the next step each of the the collected tmp files is being converted into a cab file using `cmd`\n```\n/c makecab and then encrypted and sent to the attacker server in an HTTP POST request\n\n```\n( http://taketodjnfnei898.c1.biz/up.php?name=%UserName% ).\n\nFigure 18:\n\nUpload data to server\nAfter sending data to server it goes to a loop to receive commands from the server\n( http://taketodjnfnei898.c1.biz/dn.php?name=%UserName%&prefix=tt ). At the time of\nthe analysis the server was down and unfortunately we do not have enough information about\nthe next step of this attack. The detail analysis of this payload will be published in a follow up\nblog post.\n\n## Campaign Analysis\n\nKonni is a Rat that potentially is used by APT37 to target its victims. The main victims of this Rat\nare mostly political organizations in Russia and South Korea but it is not limited to these\ncountries and it has been observed that it has targeted Japan, Vietnam, Nepal and Mongolia.\n\nThere were several operations that used this Rat but specifically the campaigns reported by\n[ESTsecurity and](https://blog.alyac.co.kr/2474) [CyberInt in 2019 and 2020 are similar to what we reported here. In those](https://e.cyberint.com/hubfs/Cyberint_Konni%20Malware%202019%20Campaign_Report.pdf)\ncampaigns the actor used lures in Russian language to target Russia. There are several\ndifferences between past campaigns of this actor and what we documented here but still the\nmain process is the same: in all the campaigns the actor uses macro weaponized documents to\ndownload a cab file and deploy the Konni RAT as a service.\n\nHere are the some major differences between this new campaign and older ones:\n\nThe macros are different. In the old campaign the actor used TextBoxes to store its data\nwhile in the new one the content has been base64 encoded within the document content.\nIn the new campaign JavaScript files have been used to execute batch and PowerShell\nfiles.\nThe new campaign uses Powershell and URLMON API calls to download the cab file while\nin the old campaign it used `certutil to download the cab file.`\n\n\n-----\n\nThe new campaign has used two different UAC bypass techniques based on the victim s\nOS while in the old one the actor only used the Token Impersonation technique.\nIn the new campaign the actor has developed a new variant of Konni RAT that is heavily\nobfuscated. Also, its configuration is encrypted and is not base64 encoded anymore. It\nalso does not use FTP for exfiltration.\n\nMalwarebytes customers are protected against this campaign.\n\n## IOCs\n\nname Sha256\n\nN/A fccad2fea7371ad24a1256b78165bceffc5d01a850f6e2ff576a2d8801ef94fa\n\n\neconomics\nrelations.doc\n\n\nd283a0d5cfed4d212cd76497920cf820472c5f138fd061f25e3cddf65190283f\n\n\ny.js 7f82540a6b3fc81d581450dbdf7dec7ad45d2984d3799084b29150ba91c004fd\n\nyy.js 7a8f0690cb0eb7cbe72ddc9715b1527f33cec7497dcd2a1010def69e75c46586\n\ny.ps1 617f733c05b42048c0399ceea50d6e342a4935344bad85bba2f8215937bc0b83\n\ntmpBD2B.tmp 10109e69d1fb2fe8f801c3588f829e020f1f29c4638fad5394c1033bc298fd3f\n\ncheck.bat a7d5f7a14e36920413e743932f26e624573bbb0f431c594fb71d87a252c8d90d\n\n\n-----\n\ninstall.bat 4876a41ca8919c4ff58ffb4b4df54202d82804fd85d0010669c7cb4f369c12c3\n\nxwtpui.dll 062aa6a968090cf6fd98e1ac8612dd4985bf9b29e13d60eba8f24e5a706f8311\n\nxmlprov.dll f702dfddbc5b4f1d5a5a9db0a2c013900d30515e69a09420a7c3f6eaac901b12\n\nxmlprov.dll 80641207b659931d5e3cad7ad5e3e653a27162c66b35b9ae9019d5e19e092362\n\nxmlprov.ini 491ed46847e30b9765a7ec5ff08d9acb8601698019002be0b38becce477e12f6\n\n**Domains:**\n\ntakemetoyouheart[.]c1[.]biz\n\ntaketodjnfnei898[.]ueuo[.]com\n\ntaketodjnfnei898[.]c1[.]biz\n\nromanovawillkillyou[.]c1[.]biz\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-20 - New variant of Konni malware used in campaign targetting Russia.pdf"
    ],
    "report_names": [
        "2021-08-20 - New variant of Konni malware used in campaign targetting Russia.pdf"
    ],
    "threat_actors": [
        {
            "id": "23dfc9f5-1862-4510-a6ae-53d8e51f17b1",
            "created_at": "2024-05-01T02:03:08.146025Z",
            "updated_at": "2025-03-27T02:05:17.420497Z",
            "deleted_at": null,
            "main_name": "PLATINUM TERMINAL",
            "aliases": [
                "Longhorn ",
                "The Lamberts ",
                "Vault7 ",
                "APT-C-39 "
            ],
            "source_name": "Secureworks:PLATINUM TERMINAL",
            "tools": [
                " Assassin",
                " Marble Framework",
                "AfterMidnight"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b43c8747-c898-448a-88a9-76bff88e91b5",
            "created_at": "2024-02-02T02:00:04.058535Z",
            "updated_at": "2025-03-27T02:00:03.302832Z",
            "deleted_at": null,
            "main_name": "Opal Sleet",
            "aliases": [
                "OSMIUM",
                "Konni",
                "Vedalia"
            ],
            "source_name": "MISPGALAXY:Opal Sleet",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "bbe36874-34b7-4bfb-b38b-84a00b07042e",
            "created_at": "2022-10-25T15:50:23.375277Z",
            "updated_at": "2025-03-27T02:00:55.457787Z",
            "deleted_at": null,
            "main_name": "APT37",
            "aliases": [
                "APT37",
                "InkySquid",
                "ScarCruft",
                "Group123",
                "TEMP.Reaper",
                "Ricochet Chollima"
            ],
            "source_name": "MITRE:APT37",
            "tools": [
                "BLUELIGHT",
                "CORALDECK",
                "KARAE",
                "SLOWDRIFT",
                "ROKRAT",
                "SHUTTERSPEED",
                "POORAIM",
                "HAPPYWORK",
                "Final1stspy",
                "Cobalt Strike",
                "NavRAT",
                "DOGCALL",
                "WINERACK"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "552ff939-52c3-421b-b6c9-749cbc21a794",
            "created_at": "2023-01-06T13:46:38.742547Z",
            "updated_at": "2025-03-27T02:00:02.906537Z",
            "deleted_at": null,
            "main_name": "APT37",
            "aliases": [
                "ScarCruft",
                "Venus 121",
                "Moldy Pisces",
                "Group 123",
                "APT 37",
                "Group123",
                "Operation Daybreak",
                "Operation Erebus",
                "Red Eyes",
                "TA-RedAnt",
                "InkySquid",
                "Reaper Group",
                "Ricochet Chollima",
                "ATK4",
                "G0067"
            ],
            "source_name": "MISPGALAXY:APT37",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b9458777-d970-4e89-b2d2-e532140a390f",
            "created_at": "2024-05-01T02:03:08.140328Z",
            "updated_at": "2025-03-27T02:05:17.41728Z",
            "deleted_at": null,
            "main_name": "NICKEL JUNIPER",
            "aliases": [
                "OSMIUM ",
                "Opal Sleet ",
                "Konni"
            ],
            "source_name": "Secureworks:NICKEL JUNIPER",
            "tools": [
                "KONNI"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "f0bccc3d-ad77-49c4-8dfd-8a8a8d6fba26",
            "created_at": "2024-05-01T02:03:08.134022Z",
            "updated_at": "2025-03-27T02:05:17.415028Z",
            "deleted_at": null,
            "main_name": "NICKEL FOXCROFT",
            "aliases": [
                "Group 123 ",
                "Moldy Pisces ",
                "RICOCHET CHOLLIMA ",
                "Reaper ",
                "ScarCruft ",
                "APT37 "
            ],
            "source_name": "Secureworks:NICKEL FOXCROFT",
            "tools": [
                "ROKRAT"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536052,
    "ts_updated_at": 1743041617,
    "ts_creation_date": 1653708771,
    "ts_modification_date": 1653708771,
    "files": {
        "pdf": "https://archive.orkl.eu/a435b312832ae2ba2fce2c72b40890aee85eb729.pdf",
        "text": "https://archive.orkl.eu/a435b312832ae2ba2fce2c72b40890aee85eb729.txt",
        "img": "https://archive.orkl.eu/a435b312832ae2ba2fce2c72b40890aee85eb729.jpg"
    }
}