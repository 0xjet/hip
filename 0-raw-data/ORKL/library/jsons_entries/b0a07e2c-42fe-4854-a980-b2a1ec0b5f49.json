{
    "id": "b0a07e2c-42fe-4854-a980-b2a1ec0b5f49",
    "created_at": "2023-01-12T15:08:08.229023Z",
    "updated_at": "2025-03-27T02:05:35.245704Z",
    "deleted_at": null,
    "sha1_hash": "852cbc9f3cd2b83d40be7eb65339db471061dbe9",
    "title": "2017-02-14 - Sage 2.0 analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T03:33:07Z",
    "file_modification_date": "2022-05-28T03:33:07Z",
    "file_size": 916288,
    "plain_text": "# Sage 2.0 analysis | CERT Polska\n\n**cert.pl/en/news/single/sage-2-0-analysis/**\n\n## Introduction\n\nSage is a new ransomware family, a variant of CryLocker. Currently it’s distributed by the\nsame actors that are usually distributing Cerber, Locky and Spora.\n\nIn this case malspam is the infection vector. Emails from the campaign contain only\nmalicious zip file without any text. Inside zip attachment there is malicious Word document\nwith macro that downloads and installs ransomware.\n\nAfter starting the ransomware, Windows UAC window is shown repeatedly until the user\nclicks yes.\n\nAt the end the encryption process is started and all files are encrypted:\n\n\n-----\n\nRansom message directs us to panel in the Tor network, but before we can log in we have to\nsolve a captcha:\n\nAnd finally we are greeted with “user-friendly” panel:\n\n\n-----\n\nWe can even chat with malware creators:\n\n\n-----\n\nInterestingly, this ransomware doesn’t remove itself after encryption, but copies itself to\n%APPDATA%\\Roaming directory and re-encrypts all files after every reboot (until the ransom\nis paid).\n\n## Technical analysis\n\nAfter this short introduction, We’ll focus on the technical side (because Sage 2.0 is not\ncompletely a generic ransomware, few things are rather novel).\n\nMain function of binary looks like this:\n\nAs we see, there is a lot of fingerprinting and checks, though most of them are quite\nstandard. More interesting features include:\n\n### Debug switch\n\n\n-----\n\nProbably something didn t work on the first try, so there is a debug command line parameter\nto test that configuration data is set correctly:\n\nAnd surely enough, this debug parameter does what it should:\n\nSomeone probably forgot to remove this from the final version, because this is clearly a\ndebugging feature.\n\n### Locale Check\n\nSage 2.0 creators like some nations more than others:\n\nThis checks user keyboard layouts:\n\nnext == 0x23 -> Belarussian\nnext == 0x3F -> Kazakh\nnext == 0x19 -> Russian\nnext == 0x22 -> Ukrainian\nnext == 0x43 -> Uzbek\nnext == 0x85 -> Sakha\n\nWe’re a bit disappointed that Polish didn’t make it on the exception list (If Sage creators are\nreading this: our locale is 0x15).\n\n### Location fingerprinting\n\nSage is trying to get it’s host location by querying maps.googleapis.com with current SSID\nand MAC:\n\n### Canary file\n\nBefore encryption Sage checks for existence of a special debug file:\n\nThanks to this, malware creators don’t have to worry about accidentally running the\nexecutable and encrypting their own files.\n\nFinally, if the file is not found, encryption is initiated.\n\n### Extension whitelist\n\nOf course, not every file is encrypted – only files with whitelisted extension are touched:\n\n\n-----\n\n## Encryption\n\nAs usual, this is the most interesting thing in ransomware code. Sage 2.0 is especially\nunusual because it encrypts files with elliptic curve cryptography.\n\nThe curve used for encryption is y^2 = x^3 + 486662x^x + x over the prime field defined by\n2^255 – 19, with base point x=9. These values are not arbitrary – this curve is also called\nCurve25519 and is the state of the art in modern cryptography. Not only it’s one of the fastest\nECC curves, it’s also less vulnerable to weak RNG, designed with side-channel attacks in\nmind, avoids many potential implementation pitfalls, and (probably) not backdoored by any\nthree-letter agency.\n\nCurve25519 is used with hardcoded public key for shared secret generation. The exact code\nlooks like this (with structures and function names by us):\n\nThis looks like properly implemented Elliptic Curve Diffie-Hellman (ECDH) protocol, but\nwithout private keys saved anywhere (they are useful only for decryption and malicious\nactors can create them anyway using their private key).\n\nThis may look complicated, but almost all those functions are just wrappers for ECC primitive\n– named CurveEncrypt by us. For example, computing matching public key is\ncurve25519(secretKey, basePoint) – where basePoint is equal to 9 (one 9 and 31 zeroes).\n\nShared key computation is very similar, but instead of using constant base point we use\npublic key:\n\nDue to the design of Curve25519, converting between any sequence of random bytes and a\nsecret key is very easy – it’s enough to mask few bits:\n\nAnd, also because of this, secret key generation is completely trivial (it’s enough to generate\n32 random bytes and convert them to the secret key):\n\nThat’s all for the key generation. What about file encryption? Files are encrypted with\nChaCha (unconventional algorithm, again) and key is appended to output file – but after\nbeing encrypted with Curve25519:\n\nAppendFileKeyInfo fucntion appends sharedKey and pubKey to the file:\n\nChaCha is not very popular algorithm among ransomware creators. It’s very closely related\nto Salsa20 which was used in Petya ransomware. We don’t know why AES is not good\nenough for Sage – probably it’s only trying to be different.\n\nIn other words, there are two sets of keys + one key pair for every encrypted file:\n\nAfter ransomware finishes we know only my_public, sh_public, fl_shared, but we need\nchachakey to actually decrypt the file.\n\n\n-----\n\nThis encryption scheme is quite solid because it makes offline encryption possible – there is\nno need to bother connecting with C&C and negotiating encryption keys – the public key is\nhardcoded in binary and because of asymmetric cryptography decryption is impossible.\nAssuming that malware creators didn’t make any drastic implementation mistakes (and we\nhave no reason to suspect that they did), recovery of encrypted files is impossible. Of\ncourse, it’s always possible that master encryption key will eventually be leaked or released.\n\n## Additional information\n\nYara rules:\n\nHashes (sha256):\n\nsample 1,\n362baeb80b854c201c4e7a1cfd3332fd58201e845f6aebe7def05ff0e00bf339\nsample 2,\n3b4e0460d4a5d876e7e64bb706f7fdbbc6934e2dea7fa06e34ce01de8b78934c\nsample 3,\nccd6a495dfb2c5e26cd65e34c9569615428801e01fd89ead8d5ce1e70c680850\nsample 4,\n8a0a191d055b4b4dd15c66bfb9df223b384abb75d4bb438594231788fb556bc2\nsample 5,\n0ecf3617c1d3313fdb41729c95215c4d2575b4b11666c1e9341f149d02405c05\n\nAdditional information:\n\nhttps://www.govcert.admin.ch/blog/27/saga-2.0-comes-with-ip-generationalgorithm-ipga – short, but very condensed analysis performed by Swiss CERT.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-02-14 - Sage 2.0 analysis.pdf"
    ],
    "report_names": [
        "2017-02-14 - Sage 2.0 analysis.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536088,
    "ts_updated_at": 1743041135,
    "ts_creation_date": 1653708787,
    "ts_modification_date": 1653708787,
    "files": {
        "pdf": "https://archive.orkl.eu/852cbc9f3cd2b83d40be7eb65339db471061dbe9.pdf",
        "text": "https://archive.orkl.eu/852cbc9f3cd2b83d40be7eb65339db471061dbe9.txt",
        "img": "https://archive.orkl.eu/852cbc9f3cd2b83d40be7eb65339db471061dbe9.jpg"
    }
}