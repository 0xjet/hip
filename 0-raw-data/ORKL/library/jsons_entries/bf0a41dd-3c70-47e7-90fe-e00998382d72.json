{
    "id": "bf0a41dd-3c70-47e7-90fe-e00998382d72",
    "created_at": "2023-01-12T15:05:11.47914Z",
    "updated_at": "2025-03-27T02:06:04.661772Z",
    "deleted_at": null,
    "sha1_hash": "0f26f0c897129dcd6ae92363d31c8c2ac3268eb5",
    "title": "2019-01-11 - The “AVE_MARIA” Malware",
    "authors": "",
    "file_creation_date": "2022-05-28T00:37:54Z",
    "file_modification_date": "2022-05-28T00:37:54Z",
    "file_size": 155073,
    "plain_text": "# The “AVE_MARIA” Malware\n\n**blog.yoroi.company/research/the-ave_maria-malware/**\n\n01/11/2019\n\n\nJanuary 11, 2019\n\n\nThe Cybaze-Yoroi ZLab researchers analyzed phishing attempts spreading in the last days of the past year\nagainst an italian organization operating in the Oil&Gas sector. The malicious emails try to impersonate a\nsupplier’s sales office sending invoices and shipping orders confirmations. As usual, the mail conveys\n[malicious Excel files exploiting the popular CVE-2017-11882 vulnerability to run an executable retrieved from](https://blog.yoroi.company/warning/vulnerabilita-microsoft-office-skeleton-in-the-closet/)\na malicious website, previously compromised by the attackers.\n\nThe domains used to vehicle the malicious messages remained active only for few days in the middle of\nDecember, just the time needed to spread phishing emails.\n\n_Figure 1. The sender’s domains were active_\n\n_from 12 to 14 Dec 18_\nThe Cybaze-Yoroi ZLab analyzed and dissected the payload delivered during these days.\n\n## Technical analysis\n\n\n-----\n\nThe actual infection chain starts from the self-extracting archive (SFX) dropped by after the opening of the\nmalicious Office document. The sample contains the image of Kagamine Rin as icon, a character belonging\nto the singing voice synthesizer software dubbed VOCALOID.\n\nThe file is a WinRAR self-extractor configured to unpack its contents into the temporary folder\n“%TEMP%\\04505187” and then silently run a specific setup routine:\n\n_Figure 2. Configuration of the SFX extractor_\nThe timestamp of the compressed files shows the attacker weaponized the archive at 22:56 of 13th\nDecember 2018, within the domain activation time-span.\n\n_Figure 3. Files extracted by SFX executable_\nAll the files have misleading extension to confuse the analysis and most of them are text files containing junk\ndata. But three of these files deserve further attention:\n\n_xfi.exe: a legit AutoIt interpreter; it is able to execute a specified AutoIt script._\n_hbx=lbl: the first AutoIt script; it is obfuscated hiding the instructions among an huge number of_\ncomments.\n_uaf.icm: file containing all the malware settings such as the installation folder, the interpreter name and_\nother parameters used in the next stages; it is structured according to the “INI file format”.\n\n_Figure 4. Appearance of the first AutoIt script (called “hbx-lbl”)._\n_Figure 5. uaf.icm’s structure._\n[Similar packing of AutoIT code have been observed even by Juniper back in 2016, where SFX files were](https://forums.juniper.net/t5/Threat-Research/A-Walk-Through-AutoIT-Malware/ba-p/299843)\nabused this way to deliver scripts used as first stage of the malware. As shown in the configuration in Figure\n2, the sample able to run the first script using the command:\n\n**$> xfi.exe hbx=lbl**\n\nAt this point, using the encoded data contained into “uaf.icm” between the string pattern “[sData]” and\n_“[esData]”, the first script creates a second one, with a random name (es. “ZZQLZ”), and runs it using_\n“xfi.exe” engine.\n\n_Figure 6.The second script is binary-encoded and hidden into the uaf.icm file between “[sData]” and_\n_“[esData]”._\nThe second script is heavily obfuscated using binary-encoding. After deobfuscation, it reveals interesting\ncapabilities. First of all, there are different evasion techniques, such as a check about the current running\nprocesses: if there is a process related to some virtualization software, like Virtualbox, the malware kills\nitself.\n\n_Figure 7.Example of malware evasion._\nThe main purpose of the second script is to decrypt and execute the final payload hidden inside “[Data]” and\n_“[eData]” delimiter strings of the “uaf.icm” file. The data is decrypted using the “Advapi32.dll!CryptDecrypt”_\n[Microsoft function, which is dynamically invoked into the AutoIt script through the high-level API “DllCall”.](https://www.autoitscript.com/autoit3/docs/functions/DllCall.htm)\nThe decryption key is retrieved from the usual settings file.\n\nIt is interesting the way used by the AutoIt script to run the just extracted payload. In the first instance, the\nmalware creates a copy of legit Regsvcs.exe, the .NET Services Installation Tool, into %TEMP% folder and\nruns it. Then, it performs a process injection in order to start the malicious payload behind the Regsvcs\nprocess.\n\n\n-----\n\nIn the following figure, it is shown the routine to extract, decrypt and inject the malicious binary stored into\n_“uaf.icm” settings file._\n\n_Figure 8.Example of malware evasion._\nThe malware uses the CallWindowProcW Windows function as process injection technique, through DllCall\nAutoIt API.\n\n_Figure 9.Function to decrypt and inject malicious payload into legit process._\nThe malware author used a custom shellcode stored into $ASM variable to correctly inject the binary\npayload into the running regsvcs process.\n\nFinally, the second AutoIt script provides to set persistence onto the victim’s machine writing the registry key\n_HKLM\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Run._\n\n_Figure 10.Registry key set by the malware._\nThe registry key’s name corresponds to the value extracted from “uaf.icm” settings file at the section “Key”.\n\n### The Payload: AVE_MARIA Stealer\n\nThe payload injected into legit .NET process shows a typical bot behavior: it contacts a C2 hosted on\n_anglekeys.warzonedns[.]com and retrieves the next action to perform. The attacker’ server is currently_\ndown, so it is not possible to obtain further stages of the commands.\n\nA static investigation shows the malware looks for the installed e-mail client, like Microsoft Exchange Client\nor Outlook, to exfiltrate victim’s credentials.\n\n_Figure 11.Research of the installed email client software._\nMoreover, the bot is able to decrypt all the credentials stored by Firefox browser. These sensitive data are\nprotected using PK11 encryption from Mozilla Network Security Services, so the malware is weaponized with\nall the necessary functions decrypt them.\n\nThe malware writer re-used publicly available code to implement this functionality. The following screen\nshows part of the execution flow (on the left) and a piece of code belonging to a KeePass plugin (on the\n[right) published on github; these two flows are very similar.](https://github.com/JanisEst/KeePassBrowserImporter/blob/master/Firefox.cs)\n\n_Figure 12.Malware’s piece of code (on the left); KeePass plugin’s piece of code (on the right)._\nIn addition, the malware embeds an utility able to bypass the User Access Control within the resource\nsection. It abuses a vulnerability of the “pkgmgr.exe” Windows tool; many resources related to this exploit\nare publicly available on the internet.\n\n_Figure 13.Workflow of the UAC bypass utility._\nDespite the wide malware’s capabilities, the writer left some evidences referring to his environment into the\nmalicious code.\n\n_Figure 14.Probable address path of the malware writer’s workspace._\nFinally, another strange string is emerged from the executable: “AVE_MARIA”. Which is used as HELLO\nmessage when the malware correctly contacts the C2. This particular string has been elected as common\nmalware name by many researchers of the InfoSec community.\n\n_Figure 15.The characteristic string sent by the malware._\n\n## Conclusion\n\n\n-----\n\nThe first stages of the malware, including the AutoIt scripts, are very similar to another malware waves\nanalyzed few years ago by third party security researchers: the malware logic, based on an INI settings file,\nand some pieces of AutoIt code are the same but the final payload is different.\n\nIt’s possible the author of these malware is the same, showing an increasing complexity of implant, or also\nthe first stage of the malware may have been purchased in the dark markets and the author of the\n“AVE_MARIA” malware composed a new stealer using publicly available code, forgetting to wipe the\ninformation related to him.\n\n## Indicator of Compromise\n\n**FileName** **sha256** **description**\n\nDSK.exe 4576d9940db9a748378a7e7d8c0edc048529ed72ef5161ed4a75c5612da3d5d9 SFX dropper\n\nhbx=lbl 6fff30ad7d09e11e85614de11ea3607ed39c2c6ed2cca481d7e54b506c423707 AutoIt script\ndropper 1\n\nxfi.exe 237d1bca6e056df5bb16a1216a434634109478f882d3b1d58344c801d184f95d Legit AutoIt\nengine\n\nuaf.icm 7b5a8198138abc2436d92dfcd16f0be26e8783a51e42d2a4ad5334686f4c9140 Malware\nsettings file\n\nZZQLZ 02cb295e95881abca2fe85fadc4228a932a12ea0d1fa6b961a38d789e7b8287f AutoIt script\ndropper 2\n\npayload 81043261988c8d85ca005f23c14cf098552960ae4899fc95f54bcae6c5cb35f1 AveMaria\npayload\n\nuac_bypass 021d01fe3793879f57a2942664fc7c096710e94e87ad13dc21467c12edf61546 UAC_bypass\nutility\n\nMalspam\n\nSending domains\n\nsentinelx[.tk\nxinchingho[.ml\nDroprul\n\nhxxps://www.masaimaranationalparkkenya[.com/wp-admin/js/jsk/DSK.exe\nC2:\n\nanglekeys.warzonedns[.com\n192.3.162[.161\n\n### Yara Rules\n\n\n-----\n\n```\n     _ _ pp _ _ _ {\n  meta:\n   description = \"Yara Rule for SFX dropper\"\n   author = \"Cybaze Zlab_Yoroi\"\n   last_updated = \"2019_01_09\"\n   tlp = \"white\"\n   category = \"informational\"\n  strings:\n     $a1 = \"CryptProtectMemory\"\n     $a2 = {2A 3F ?? ?? ?? ?? 72 61 72}\n     $b = {4D 5A}\n     $c = {CE E8 DC F8 FF FF 56 E8 A3 80 FF FF 59 33 C0 5E}\n     $d = \"publicKeyToken=\\\"6595b64144ccf1df\\\"\"\n     $e = {7B 65 32 30 31 31 34 35 37 2D 31 35 34 36}\n  condition:\n    $b and $c and $d and $e and 1 of ($a*) \n}\nrule AveMaria_infostealer_09_01_2019{\n  meta:\n   description = \"Yara Rule for AveMaria infostealer\"\n   author = \"Cybaze Zlab_Yoroi\"\n   last_updated = \"2019_01_09\"\n   tlp = \"white\"\n   category = \"informational\"\n  strings:\n     $a1 = \"PK11SDR_Decrypt\"\n     $a2 = {70 69 6E 67 2E 65 78 65}\n     $a3 = {4D 5A}\n     $a4 = {31 32 37 2E 30 2E 30 2E 32}\n     $a5 = {4D D0 8B 46 08 33 C2 23 C7 C1 CF}\n     $a6 = \"AVE_MARIA\"\n  condition:\n    all of them\n}\n\n```\n_This blog post was authored by Antonio Farina, Luca Mella, Antonio Pirozzi of Cybaze-Yoroi Z-LAB_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-01-11 - The “AVE_MARIA” Malware.pdf"
    ],
    "report_names": [
        "2019-01-11 - The “AVE_MARIA” Malware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535911,
    "ts_updated_at": 1743041164,
    "ts_creation_date": 1653698274,
    "ts_modification_date": 1653698274,
    "files": {
        "pdf": "https://archive.orkl.eu/0f26f0c897129dcd6ae92363d31c8c2ac3268eb5.pdf",
        "text": "https://archive.orkl.eu/0f26f0c897129dcd6ae92363d31c8c2ac3268eb5.txt",
        "img": "https://archive.orkl.eu/0f26f0c897129dcd6ae92363d31c8c2ac3268eb5.jpg"
    }
}