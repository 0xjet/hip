{
    "id": "d3c5edc4-e477-4485-9a79-1aac5df2cf4c",
    "created_at": "2023-01-12T15:01:51.101677Z",
    "updated_at": "2025-03-27T02:10:17.911371Z",
    "deleted_at": null,
    "sha1_hash": "4ed0d16eba95e4bd76d40882e7bf4a3bfd095b95",
    "title": "2016-05-19 - Petya and Mischa – Ransomware Duet (Part 1)",
    "authors": "",
    "file_creation_date": "2022-05-28T02:30:36Z",
    "file_modification_date": "2022-05-28T02:30:36Z",
    "file_size": 1013079,
    "plain_text": "# Petya and Mischa – Ransomware Duet (Part 1)\n\n**[blog.malwarebytes.com/threat-analysis/2016/05/petya-and-mischa-ransomware-duet-p1/](https://blog.malwarebytes.com/threat-analysis/2016/05/petya-and-mischa-ransomware-duet-p1/)**\n\nhasherezade May 19, 2016\n\n[After being defeated about a month ago,](https://blog.malwarebytes.org/threat-analysis/2016/04/recovery-from-petya-ransomware/) [Petya comes back with new tricks. Now, not as a](https://blog.malwarebytes.org/threat-analysis/2016/04/petya-ransomware/)\n[single ransomware, but in a bundle with another malicious payload – Mischa. Both are](https://www.malwarebytes.com/ransomware)\n[named after the satellites from the GoldenEye movie.](http://jamesbond.wikia.com/wiki/Satellites)\n\nThey deploy attacks on different layers of the system and are used as alternatives. That’s\nwhy, we decided to dedicate more than one post to this phenomenon. Welcome to part one!\n**The main focus of this analysis is Petya (the Green version).**\n\n[The second part (about Mischa) you can read about it here.](https://blog.malwarebytes.org/threat-analysis/2016/06/petya-and-mischa-ransomware-duet-p2/)\n\n**UPDATE: Improved version of Green Petya is out.** **More details given in the new**\n**article.**\n\nLet’s start with some background information.\n\nThis time authors also deployed a page with information for potential clients of their\nRansomware-As-A-Service:\n\n\n-----\n\n[Just like in the case of Chimera, the authors use bitmessage for communication with the new](https://blog.malwarebytes.org/threat-analysis/2015/12/inside-chimera-ransomware-the-first-doxingware-in-wild/)\nrecruits of the criminal cooperation:\n\nAnd post [doxing threats, also known from Chimera:](https://blog.malwarebytes.com/101/2016/02/explained-doxing/)\n\n## Analyzed samples\n\n[8a241cfcc23dc740e1fadc7f2df3965e – main executable](https://virustotal.com/en/file/d4b6524315d5de727a8af3e4e73e8b28dab27c62fd0a6a7a891460061c2f3d60/analysis/)\n\n[f7596666d8080922d786f5892dd70742– main executable (from a different campaign)](https://virustotal.com/en/file/40a30c28d47496811450e8cd07ad3640dbba7cc270ce89b5da13312121e7d7ab/analysis/)\n\n## Execution flow\n\nThe [main executable – a dropper](https://malwr.com/analysis/MGNhNzU3MjA0OGE4NDYyZmE1NTljMjY1OTU0ZTIxZTc/share/74f8bff5078a450cb636e920e3c58343) [protected by a crypter/FUD:](https://blog.malwarebytes.org/threat-analysis/2015/12/malware-crypters-the-deceptive-first-layer/)\n\n[unpack and deploy: Setup.dll](https://virustotal.com/en/file/13f5b7aeb4fc4e29dbb1d32d75d5f731f820dbd684d0341524dbd2c87281d7a4/analysis/1464333212/)\n\ninstall: Petya\nalternatively – deploy: Mischa.dll\n\n\n-----\n\n## Behavioral analysis\n\nJust like the previous version, it is distributed via cloud storage and pretends to be a job\napplication:\n\nThe executable is again packed with an icon of a PDF document:\n\nAfter deploying it, it can drop one of the two payloads – Petya – that works similarly to the\npreviously described version, or Mischa – that has features of a typical ransomware. The\ndecision which payload to deploy is based on privileges with which the sample runs – that\nimplies accessibility to write to the MBR. If writing there is not possible, authors decided not\nto miss the chance of infecting the system and deploy more typical userland attack with\nMischa.\n\nFrom the point of view of the user – your decision taken on UAC pop-up will result in\ndeploying one out of the two payloads. If you choose “No” – you get Mischa. If you choose\n“Yes” – you get Petya.\n\n\n-----\n\n### Petya\n\n[The infection process looks exactly the same as in the previous verison of Petya. User](https://blog.malwarebytes.org/threat-analysis/2016/04/petya-ransomware/)\nAccount Control notification pops up, and in case the user accepts it, Petya installs itself in\nthe MBR and crashes the system. Stage 2 of the infection also looks almost the same. First it\nruns the fake CHKDSK, that in reality encrypts the disc. Then, the user can see the ASCII art\nwith the blinking skull and the ransom note. Only the color theme changed – instead of red,\nwe have a black background with green text:\n\n\n-----\n\nThis theme is consistent for the full ransomware – the same colors we can find on the page\nfor the victim, and on the HTML with the ransom note dropped by Mischa.\n\nPage for the victim:\n\n\n-----\n\n## Inside\n\nThe new version of Petya uses exactly the same bootloader – again it loads 32 sectors\nstarting from the sector 34 to the memory at 0x8000 and then jumps there.\n\nKernel start:\n\nAgain, checking if the data is already encrypted is performed, using a one byte flag that is\nsaved at the beginning of sector 54. If this flag is unset (the value of first byte is 0), program\nproceeds to the fake CHKDSK scan. Otherwise (if the value of the byte is 1), it displays the\nmain green screen.\n\nThe key used for the encryption is again generated by the dropper and stored in the binary.\nThat’s why if we catch Petya at Stage 1 – before the fake CHKDSK run and erase it,\nrecovering system is still easy. A live CD to support Stage 1 key recovery has been already\n[released (here).](https://hshrzd.wordpress.com/2016/04/20/anti-petya-live-cd-the-fastest-stage1-key-decoder/)\n\n**Key verification**\n\nKey verification is performed in the following steps:\n\n\n-----\n\n1. Input (key) from the user is read.\n\nAccepted\ncharset: 123456789abcdefghijkmnopqrstuvwxABCDEFGHJKLMNPQRSTUVWX\n– if the character outside of this charset occurred, it is skipped.\nOnly the first 16 bytes are stored\n2. Data from sector 55 (512 bytes) is read into memory // it will be denoted as\n\n**_verification buffer_**\n3. The value stored at physical address 0x6c21 (just before the Tor address) is read into\n\nmemory. It is an 8 byte long array, unique for a specific infection. // it will be denoted as\n**_nonce_**\n[4. The verification buffer is encrypted by Salsa20 with the 16 byte long](https://github.com/alexwebr/salsa20) **_key and the_**\n\n**_nonce_**\n5. If, as a result of the applied procedure, verification buffer is fully filled with 0x7 – it\n\nmeans the supplied key is correct.\n\n### What changed in the new Petya?\n\n**Storing the Salsa key (stage1)**\n\nThis time it the key is saved differently, without scrambling. Probably the authors realized that\nscrambling does not provide them any protection, so they gave up this idea completely:\n\n**Length of Salsa key**\n\nIn the Red Petya authors used 16 byte long key – however, they were scrambling it and used\nit to make a 32 bit long key. Now they gave it up and they just use the 16 byte long key as it\nis. That’s why, instead of functions expand32 we will see in the new Petya the function\n**expand16:**\n\n\n-----\n\n**Salsa implementation**\n\nAlso this time, [Salsa20 is used in several places in Petya’s code – for encryption, decryption](https://github.com/alexwebr/salsa20)\nand key verification. See the diagram below:\n\n\n-----\n\nWe made a comparison of Salsa implementation fragments, that have been found vulnerable\nin the previous implementation.\n\n**salsa20_rol**\n\n[See below the original version of this function – copied from](https://github.com/alexwebr/salsa20/blob/master/salsa20.c#L6) [Salsa20 implementation:](https://github.com/alexwebr/salsa20/blob/master/salsa20.c)\n```\nstatic uint32_t rotl(uint32_t value, int shift)\n{\n return (value << shift) | (value >> (32 - shift));\n}\n\n```\nCode comparison – old one vs the new one:\n\n\n-----\n\nThat s how it has been implemented in the Red Petya:\n\nThe old version of this function was taking 2 arguments and it was an almost exact clone of\nthe original function – the only difference was that it was using 16 bit variables.\nReconstruction of the code:\n```\nstatic uint16_t rotl(uint16_t value, int16_t shift)\n{\n  return (value << shift) | (value >> (32 - shift));\n}\n\n```\nAnd the new version – from Green Petya:\n\nThe new version is more complex – it takes 3 arguments and uses calls to additional helper\nfunctions. To achieve the functionality of shifting a DWORD, two WORD-sized parameters\n\n\n-----\n\nhave been used (one representing the lower part of the DWORD and another representing\nthe higher):\n```\nstatic uint16_t rotl(uint16_t value_word1, uint16_t value_word2, int16_t shift)\n{\n  return (shr(value_word1, value_word2, (32 - shift)) | shl(value_word1,\nvalue_word2, shift));\n}\n\n```\n**s20_hash**\n\n[original version: https://github.com/alexwebr/salsa20/blob/master/salsa20.c#L59](https://github.com/alexwebr/salsa20/blob/master/salsa20.c#L59)\n\nCode comparison – old one vs the new one:\n\n\n-----\n\n-----\n\n[First changed fragment corresponds to this part of the original Salsa20 implementation:](https://github.com/alexwebr/salsa20/blob/master/salsa20.c#L69)\n```\n for (i = 0; i < 16; ++i)\n  x[i] = z[i] = s20_littleendian(seq + (4 * i));\n\n```\nThat’s how it has been implemented in the Red Petya:\n\nAnd the new version – from the Green Petya:\n\n\n-----\n\n**s20_littleendian also changed, but very slightly – a bit extension has been added:**\n\n[Second changed fragment corresponds to this part of the original Salsa20 implementation:](https://github.com/alexwebr/salsa20/blob/master/salsa20.c#L75)\n```\n for (i = 0; i < 16; ++i) {\n  z[i] += x[i];\n  s20_rev_littleendian(seq + (4 * i), z[i]);\n }\n\n```\n\n-----\n\nThat s how it has been implemented in the Red Petya:\n\nAnd the new version – from Green Petya:\n\nFull reconstruction and comparison of implementations of this function:\n[https://gist.github.com/hasherezade/f59939f5d20ebdfd36343dfcae66bfa9](https://gist.github.com/hasherezade/f59939f5d20ebdfd36343dfcae66bfa9)\n\n**New Petya, new bug**\n\nAs we can see, the authors tried to fix the bug of using 16 bit long units where the 32 bit long\nunits were required. The new implementation of Salsa looks almost correct… However, due\nto just one bug, it still needs only 8 valid characters of the key, out of 16!\n\nThe bug lies in invalid implementation of the function s20_littleendian. That’s how this\nfunction looks in the origial Salsa20:\n\n\n-----\n\n```\nstatic uint32_t s20_littleendian(uint8_t b)\n{\n return b[0] +\n     (b[1] << 8) +\n     (b[2] << 16) +\n     (b[3] << 24);\n}\n\n```\nAnd that’s how the Petya’s version looks:\n```\nstatic int16_t s20_littleendian(uint8_t *b)\n{\n return b[0] +\n     (b[1] << 8);\n}\n\n```\nIn the previous, Red Petya every second character of the key had no importance to the\nencryption/decryption. The pattern was: c?c?c?c?c?c?c?c? – where the c means a valid\ncharacter and ? means any random character from the set.\n\n[Valid key – hpLehdbjdcVaMDGj (revealed at Stage 1 by Antipetya Live CD)](https://hshrzd.wordpress.com/2016/04/20/anti-petya-live-cd-the-fastest-stage1-key-decoder/)\n\nAccepted key hxLxhxbxdxVxMxGx :\n\n\n-----\n\nIn the current case, the pattern is a bit different (and more difficult to exploit): cc??cc??cc??\n**cc??. See example below:**\n\n[Valid key – sHbGrSTkpCrhoKRt (revealed at Stage 1 by Antipetya Live CD)](https://hshrzd.wordpress.com/2016/04/20/anti-petya-live-cd-the-fastest-stage1-key-decoder/)\n\nAccepted key – sHxxrSxxpCxxoKxx :\n\n**Verification buffer**\n\nSimilar to the previous version, a verification buffer is used in order to check whether or not\nthe provided key is valid. However, values expected in the verification buffer changed. In the\ngreen Petya, a key was passed as valid if the verification buffer got filled by ASCII character\n‘7’ (that is byte 0x37). Now, the byte 0x7 has been used.\n\nChecking characters of the validation buffer:\n\nin red Petya:\n\n\n-----\n\nin green Petya\n\n**Stability**\n\nIn the Red Petya, interrupting the fake CHKDSK caused real problems. Even after having a\ncorrect key full disk was not decrypted correctly – because Petya didn’t check which sectors\nare encrypted and which are not, and was applying Salsa again on everything. In the Green\nedition authors improved it.\n\nYet, some victims of Petya reported to us, that they encountered the situation, where they\nbought a valid key but still the disk wasn’t decrypted properly. That’s why we recommend\nmaking a dump of the full disk as soon as you notice that you are infected with Petya (before\ntrying any decryption methods).\n\nFragment of the talk between the victim and the attackers. Till now, user didn’t got either his\ndata or his bitcoins back:\n\n## Conclusion\n\nThe new Petya comes with significant improvements. The authors realized the weakness\nand tried to make appropriate fixes in the code. However, they left another flaw that weakens\nthe encryption. Unfortunately, [the previous approach, based on genetic algorithm will not](https://github.com/leo-stone/hack-petya)\nwork this time – due to the different specifics of the generated output. The remaining solution\nseems to be only bruteforce of the 8 characters. Further research about the possibility of\nwriting a decryptor is in progress.\n\n\n-----\n\nThe idea of making a bundle of two completely different ransomwares is new and creative.\nThe group of cybercriminals who released it seems to do everything in order to gain clients\n[on the black market. Probably the same group released other ransomware before: Chimera](https://blog.malwarebytes.org/threat-analysis/2015/12/inside-chimera-ransomware-the-first-doxingware-in-wild/)\n[and Rokku. The main method of distribution used by them is via targeted campaigns of](https://blog.malwarebytes.org/threat-analysis/2016/04/rokku-ransomware/)\nmalicious e-mails. That’s why we recommend to pay more attention on the received\nattachments and be very cautious. We can expect, that they will come with some new ideas\nin the future.\n\n## Appendix\n\nhttp://www.bleepingcomputer.com/news/security/petya-is-back-and-with-a-friend-namedmischa-ransomware/ – Bleeping Computer about Mischa\n\n**About the previous (red) version of Petya:**\n\nhttps://blog.malwarebytes.org/threat-analysis/2016/04/petya-ransomware/\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-05-19 - Petya and Mischa – Ransomware Duet (Part 1).pdf"
    ],
    "report_names": [
        "2016-05-19 - Petya and Mischa – Ransomware Duet (Part 1).pdf"
    ],
    "threat_actors": [
        {
            "id": "873a6c6f-a4d1-49b3-8142-4a147d4288ef",
            "created_at": "2022-10-25T16:07:23.455744Z",
            "updated_at": "2025-03-27T02:02:09.811933Z",
            "deleted_at": null,
            "main_name": "Chimera",
            "aliases": [
                "Operation Skeleton Key"
            ],
            "source_name": "ETDA:Chimera",
            "tools": [
                "Agentemis",
                "Cobalt Strike",
                "CobaltStrike",
                "SkeletonKeyInjector",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f88b16bc-df4b-48e7-ae35-f4117240ff24",
            "created_at": "2022-10-25T15:50:23.556699Z",
            "updated_at": "2025-03-27T02:00:55.499173Z",
            "deleted_at": null,
            "main_name": "Chimera",
            "aliases": [
                "Chimera"
            ],
            "source_name": "MITRE:Chimera",
            "tools": [
                "PsExec",
                "esentutl",
                "Mimikatz",
                "Cobalt Strike"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535711,
    "ts_updated_at": 1743041417,
    "ts_creation_date": 1653705036,
    "ts_modification_date": 1653705036,
    "files": {
        "pdf": "https://archive.orkl.eu/4ed0d16eba95e4bd76d40882e7bf4a3bfd095b95.pdf",
        "text": "https://archive.orkl.eu/4ed0d16eba95e4bd76d40882e7bf4a3bfd095b95.txt",
        "img": "https://archive.orkl.eu/4ed0d16eba95e4bd76d40882e7bf4a3bfd095b95.jpg"
    }
}