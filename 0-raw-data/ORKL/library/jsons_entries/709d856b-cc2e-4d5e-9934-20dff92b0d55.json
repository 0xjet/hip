{
    "id": "709d856b-cc2e-4d5e-9934-20dff92b0d55",
    "created_at": "2023-04-05T02:08:32.293841Z",
    "updated_at": "2025-03-27T02:05:53.315627Z",
    "deleted_at": null,
    "sha1_hash": "3b35aca0319a552b01382d7c0abd5a014d16311c",
    "title": "2023-03-27 - AsyncRAT Crusade- Detections and Defense",
    "authors": "",
    "file_creation_date": "2023-04-03T08:59:38Z",
    "file_modification_date": "2023-04-03T08:59:38Z",
    "file_size": 2636671,
    "plain_text": "# AsyncRAT Crusade: Detections and Defense\n\n**[splunk.com/en_us/blog/security/asyncrat-crusade-detections-and-defense.html](https://www.splunk.com/en_us/blog/security/asyncrat-crusade-detections-and-defense.html)**\n\nSECURITY\n\n\nMarch 27, 2023\n\n\nBy [Splunk Threat Research Team March 27,](https://www.splunk.com/en_us/blog/author/secmrkt-research.html)\n\n2023\nIn January 2019 AsyncRAT was released as an open source remote administration tool\nproject on [GitHub. AsyncRAT is a popular malware commodity and tools used by attackers](https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp)\n[and APT groups. Threat actors and adversaries used several interesting script loaders and](https://malpedia.caad.fkie.fraunhofer.de/details/win.asyncrat)\nspear phishing attachments to deliver AsyncRAT to targeted hosts or networks in different\ncampaigns.\n\nOne prevalent campaign in the wild with this remote access trojan is the use of a Microsoft\nOneNote spear phishing attachment to load a .HTA file that downloads and runs an\nobfuscated batch script to execute the actual AsyncRAT code.\n\nOf the many features of AsyncRAT, it encrypts C2 communication protocol and contains\nseveral features via plugin including:\n\nChat Communication\nFile Search\nKeylogger\nProcess Manager (Process list)\nExtract Browser Credentials\nView and Record Desktop Screen\nRun Miner\n\n\n-----\n\nSend Files\nRemote Camera\nFile Manager\n\nGet drivers list\nUpload files\nDelete folders and files\nCopy files\nRename files and folders\n7z archiving files\n\nWatch the video below to learn more about AsyncRAT OneNote campaign.\n\nFigure 1 shows a short summary infection chain of OneNote campaigns that are discussed\nfurther in this article, including other interesting phishing campaigns that load different scripts\nto execute AsyncRAT.\n\n\n-----\n\n_Figure 1_\n\n_[(For a larger resolution of this diagram visit this link)](https://imgur.com/a/NkbQ3Ea)_\n[AsyncRAT has also been in the weekly TOP 10 malware trends tracker on app.any.run for](https://any.run/malware-trends/?utm_source=twitter&utm_medium=post&utm_campaign=statistics&utm_content=300123)\nthe past few months.\n\n_[Reference (tweet)](https://twitter.com/anyrun_app/status/1617401778240102400?s=20&t=ED5KEvCMTz8_F2IjR61j8Q)_\n\n\n-----\n\nIn the following sections, we explore a recent OneNote campaign, how to extract the\nAsyncRAT configuration, dive into common behaviors and review additional AsyncRAT script\nloaders.\n\n## Technical Analysis\n\n### OneNote Campaign\n\n T1566.004 - Phishing: Spear Phishing Attachment\n\n**Malicious OneNote Attachment**\n\nThe [Splunk Threat Research Team (STRT) found several phishing email campaigns that](https://www.splunk.com/en_us/blog/author/secmrkt-research.html)\ncontain malicious .one (OneNote) attachments. The malicious OneNote document will lure\nthe targeted user to click through the warning to view the document as seen in Figure 2.\n\nAs soon as the user clicks, it will automatically load a malicious .HTA file to download the\nsecond stage of this infection chain.\n\n_Figure 2_\n\n### T1218.005 - System Binary Proxy Execution: Mshta\n\n**.HTA Downloader**\n\n\n-----\n\nThe .HTA file embedded to the .one file is responsible for downloading a .bat script that will\ndecode the actual AsyncRAT malware. Simultaneously, another .one file will act as a decoy\ndocument to hide the execution of the malicious .bat script from the compromised user.\nFigure 3 is the code snippet of the .HTA file using a PowerShell cmdlet Invoke-Webrequest\nto download both the decoy .one file (%temp%\\\\invoice.one) and the .bat script stager\n(%temp%\\\\system32.bat)\n\n_Figure 3_\n\n### T1059.003 - Command and Scripting Interpreter: Windows Command Shell\n\n**.BAT Script Stager**\n\nThe .bat script dropped in the%temp% folder is obfuscated to evade antivirus or other\nsecurity products. The .bat script initializes a series of environment variables containing a\nstring that will be concatenated at the end of its code to generate the PowerShell script that\nwill decode, decrypt and load the actual payload. Figure 4 shows the last part of the .bat\nscript code where it concatenates and executes the string initialized in several environment\nvariables to generate the PowerShell script loader.\n\n_Figure 4_\n\n### T1059.001 - Command and Scripting Interpreter: PowerShell\n\n**PowerShell Loader**\n\nFigure 5.2 shows a screenshot of the commented portion of the .bat script, which is the\nencoded and encrypted payload. The PowerShell script generated and executed by the .bat\nscript mentioned earlier performs the following steps to extract and execute the actual\n\n\n-----\n\nmalware payload.\n\n1. It decodes the BASE64 encoded comment string shown in Figure 5.2\n2. It uses AES cryptography namespace as well as the BASE64 encoded AES key and\n\nAES IV to decrypt the decoded chunk data.\n3. Finally after decryption, it decompresses it using the GZIP algorithm to extract the\n\nmalware executable and load it using the .NET Reflection library.\n\nFigure 5.1 is a simple flow diagram of how the PowerShell script executed by .bat script will\ndecrypt AsyncRAT malware\n\n_Figure 5.1_\n\n_Figure 5.2_\n\n_Figure 5.3_\n\n### BAT Crypter AsyncRAT Extractor Tool\n\nThe .batch script shown earlier is not only designed for AsyncRAT malware to load its code,\nbut other malware groups such as QuasarRAT, DCRAT, Redline, Qakbot and more use this\n[batch script, which can be found in Malware Bazaar. In order to decrypt multiple malicious](https://bazaar.abuse.ch/browse.php?search=tag%3Abat)\nbatch scripts and extract the actual payload automatically, the Splunk Threat Research Team\n[created a simple Python script “asyncrat_bat_extractor.py” that will accept a file or folder](https://github.com/tccontre/KnowledgeBase/blob/main/malware_re_tools/asyncrat-bat-crypter-extractor/asyncrat_bat_extractor.py)\ncontaining several batch files that need to be extracted as a parameter. Figure 6 shows a\nsimple execution example of this tool and how it decrypts several batch files in the “test”\nfolder and places all the extracted payloads in the “extracted_payload” folder.\n\n\n-----\n\n_Figure 6_\n\nNow let's look at the AsyncRAT TTP’s to recognize its behavior and for analytics\ndevelopment.\n\n### AsyncRAT Common Checks\n\nAsyncRAT is a .NET RAT that is being used by several threat actors to compromise\norganizations. During our research, the STRT found common behaviors that assist with\ndetecting AsyncRAT on the endpoint.\n\n**Persistence**\n\nAsyncRAT client will check if its code runs with administrative privileges. If yes, it will add\nWindows Scheduled Tasks using SchTasks.exe with highest runlevel privileges to execute\nthe copy of itself in %appdata%. Figure 7.1 shows one of the STRT analytics to detect\nAsyncRAT Scheduled Tasks.\n\n\n-----\n\n```\n| tstats security_content_summariesonly count min(_time) as firstTime max(_time) as\nlastTime from datamodel=Endpoint.Processes\n\n where Processes.process_name = \"schtasks.exe\" Processes.process = \"*/rl *\"\nProcesses.process = \"* highest *\"\n\n by Processes.process_name Processes.parent_process_name Processes.parent_process\nProcesses.process Processes.process_guid Processes.dest Processes.user\n\n | `drop_dm_object_name(Processes)`\n\n | `security_content_ctime(firstTime)`\n\n | `security_content_ctime(lastTime)`\n\n```\n_Figure 7.1_\n\n[If AsyncRAT is not running with administrative privileges, it will use Registry Run Key](https://attack.mitre.org/techniques/T1547/001/)\n```\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\n\n\n```\nfor its persistence. Figure 7.2 shows the code snippet of AsyncRAT function that creates its\npersistence on a compromised host.\n\n_Figure 7.2_\n\n\n-----\n\n**Privilege Escalation**\n\nIt will also adjust its process token privileges with the “SeDebugPrivilege” token to gain more\nprivileges and control over other processes. Figure 8 shows the code adjusting its current\nprocess token to gain debug privilege escalation.\n\n_Figure 8_\n\n**Defense Evasion**\n\nAsyncRAT has several defensive features to evade sandbox analysis or remote debugging\nof its code. The following features can be seen in Figure 9 with short descriptions below:\n\n**Functions** **Functionality**\n\nantiVM Check if its process is running in VirtualBox or VMware\nby running WMIC query “Select * from\nWin32_ComputerSystem”\n\nantiSandoxSbieDLL Check if Sbiedll.dll is loaded, which is a module of\nsandboxie sandbox\n\nCheckRemoteDebuggerPresent Check if remote debugger exist\n\ncheckDriveSize Check if the size of the disk drive of the compromised\nhost is small to recognize if it's running in a malware\nlab or sandbox\n\n\n-----\n\ncheckIFOSIsXP Check if its process is running in XP Windows\nOperating System\n\n_Figure 9_\n\nFigure 10 is the code that drops a .bat script in the %temp% folder to delete itself as part of\nits defense evasion technique to clear its track after the execution and drop a copy of itself in\nthe compromised host.\n\n_Figure 10_\n\n**Command and Control**\n\nThe last part is how communication is set up to the command and control server to download\nplugins or other payloads to the compromised host. AsyncRAT will decrypt its AES encrypted\nconfiguration data including the port (6606) and c2 ip-address (43.138[.]160.55) that will be\nused for C2 communication. Figure 11.1 is a screenshot of the decrypted config data of the\nAsyncRAT we analyzed, while Figure 11.2 is the code snippet for C2 server communication\nand C2 downloads.\n\n_Figure 11 1_\n\n\n-----\n\n_Figure 11.2_\n\n## Other AsyncRAT Script Loader\n\nAside from the ongoing OneNote campaign, the STRT has also noticed another way threat\nactors deliver AsyncRAT malware using a phishing link campaign, ISO or via another\nmalware downloader.\n\n**Abusing .rels xml - Template Injection**\n\nIn February [2022, Microsoft pushed an update to disable macros by default in Office](https://www.bleepingcomputer.com/news/microsoft/microsoft-starts-blocking-office-macros-by-default-once-again/)\nproducts. Because of this, many threat actors and adversaries worked to find another way to\nweaponize Microsoft Office documents. One of those techniques is abusing .rels file\ncontaining properties that define how the document is constructed. These properties can be\nused to reference remote resources via URLs. Figure 12.1 shows a screenshot of what this\ndocument looks like and how it abuses the footer2.xml rels properties of this Office document\nto connect to a malicious link to download another .xll, which then downloads AsyncRAT.\n\n_Figure 12.1_\n\n\n-----\n\nFigure 12.2 shows one of our AsyncRAT hunting analytics that detect this malicious Office\ndocument connecting to non-Microsoft Office domains.\n```\n`sysmon` EventCode=22 Image IN\n(\"*\\\\winword.exe\",\"*\\\\excel.exe\",\"*\\\\powerpnt.exe\",\"*\\\\mspub.exe\",\"*\\\\visio.exe\",\"*\\\\w\n\n \"*\\\\OneNotem.exe\",\"*\\\\OneNoteviewer.exe\",\"*\\\\OneNoteim.exe\")\n\n AND NOT(QueryName IN (\"*.office.com\", \"*.office.net\"))\n\n | stats count min(_time) as firstTime max(_time) as lastTime by Image QueryName\nQueryResults QueryStatus Computer\n\n | `security_content_ctime(firstTime)`\n\n | `security_content_ctime(lastTime)`\n\n\n```\n_Figure 12.2_\n\n**.VBS DynamicWrapperX Loader**\n\nWe also found a .vbs script loader that writes dynwrapx.dll to disk to be able to use\nDynamicWrapperX Object to inject or execute the actual payload. This .vbs script was also\nanalyzed in detail by the STRT in our previous blog “Detecting Malware Script Loaders using\nRemcos”. Figure 13 shows a short code snippet of the .vbs script that uses dynwrapx.dll to\nload a shellcode that executes the actual AsyncRAT.\n\n\n-----\n\n_Figure 13_\n\n**More PowerShell Script Loader**\n\nAnother instance we found was an obfuscated PowerShell script being used by AsyncRAT to\nload its actual code. The PowerShell script will convert a large hex string to binary bytes\nwhich is the .NET compiled AsyncRAT that will be executed through .NET reflection Load\nAssembly Library.\n\nFigure 14 shows the code snippet of this PowerShell script highlighting the part of the hex\nstring that will be converted to binary bytes of AsyncRAT.\n\n_Fi_ _14_\n\n\n-----\n\nThis article shows the infection chain of a malicious OneNote Microsoft Office document.\ncampaign that is rampant and widely used by different threat actors or APT’s to deliver a\nmalicious payload or to gain initial access to the targeted host. This blog may help the SOC\nand security analysts to see how this OneNote Microsoft Office document. is being abused\nand how to add defensive measures against it.\n\n## IOCs\n\nHashes of samples we’ve analyzed in this article.\n\n**Description** **SHA256**\n\n.bat script [2421e2d7ed44911ce2d2f2d288a33c8650a2e5847d81b02911e3da31c292d03a](https://www.virustotal.com/gui/file/37563d85d00f66f27dfbdea1978227cccb739702aca826a9bdf671fd26d6b6a4)\n\n[37563d85d00f66f27dfbdea1978227cccb739702aca826a9bdf671fd26d6b6a4](https://www.virustotal.com/gui/file/37563d85d00f66f27dfbdea1978227cccb739702aca826a9bdf671fd26d6b6a4)\n\n[3d5e76babb87991d4abec7c048b34074ccc7c680f49639e0c55e5be0ee6df33d](https://www.virustotal.com/gui/file/37563d85d00f66f27dfbdea1978227cccb739702aca826a9bdf671fd26d6b6a4)\n\n[8ee8a12754f344d0a1249f2de4d11044ebba8ba354df769d8d5019a639bb69c6](https://www.virustotal.com/gui/file/37563d85d00f66f27dfbdea1978227cccb739702aca826a9bdf671fd26d6b6a4)\n\n[92dabfde91df07a3b2105e5972fbd2f5acf64b53465b60165a53e0795c1be8ba](https://www.virustotal.com/gui/file/37563d85d00f66f27dfbdea1978227cccb739702aca826a9bdf671fd26d6b6a4)\n\n[bce00edede51b68cbf740e51b9f184bfd003d6ccb682cdcc661ecaa82dd67e42](https://www.virustotal.com/gui/file/37563d85d00f66f27dfbdea1978227cccb739702aca826a9bdf671fd26d6b6a4)\n\n[c4952d905a0fb0466d45a58606635f0a2ac3b7c5cbb7e517118a9b695e3012e2](https://www.virustotal.com/gui/file/37563d85d00f66f27dfbdea1978227cccb739702aca826a9bdf671fd26d6b6a4)\n\n[f1a126ea617a045454badfb230b3bc86ee5c1ad5698c1285472f71fc8497cbfc](https://www.virustotal.com/gui/file/37563d85d00f66f27dfbdea1978227cccb739702aca826a9bdf671fd26d6b6a4)\n\nAsyncRAT [3d8c723ceeaf346e9ea31d5449f4cbc37cf58993296a689d471c1e617a19d046](https://bazaar.abuse.ch/browse.php?search=sha256%3A3d8c723ceeaf346e9ea31d5449f4cbc37cf58993296a689d471c1e617a19d046)\n\n[8d0c4f891f01840c2a9c6483554d661440bb6a81fe86f10d546c697fb9e958a5](https://bazaar.abuse.ch/browse.php?search=sha256%3A8d0c4f891f01840c2a9c6483554d661440bb6a81fe86f10d546c697fb9e958a5)\n\n[774e4d4af9175367bc3c7e08f4765778c58f1c66b46df88484a6aa829726f570](https://bazaar.abuse.ch/browse.php?search=sha256%3A774e4d4af9175367bc3c7e08f4765778c58f1c66b46df88484a6aa829726f570)\n\nOneNote [482a4763c8cf9c448fc851e6fe4554cc48abc563c49847ed040cdaee8a12003c](https://bazaar.abuse.ch/browse.php?search=sha256%3A482a4763c8cf9c448fc851e6fe4554cc48abc563c49847ed040cdaee8a12003c)\n\n\nDocx\nabuses .rels\n\n\n[1e862e875511f28643f75cb7a59e2d4ad642bd9aed4a328a9cbb5304d12aa83e](https://bazaar.abuse.ch/browse.php?search=sha256%3A1e862e875511f28643f75cb7a59e2d4ad642bd9aed4a328a9cbb5304d12aa83e)\n\n\n.HTA [819448a878bbdc0658257296ab0f4951f1536ec7a1e20f1fd3b19ed716cada88](https://bazaar.abuse.ch/browse.php?search=sha256%3A819448a878bbdc0658257296ab0f4951f1536ec7a1e20f1fd3b19ed716cada88)\n\n[3652342b1e8b67e1700c3ed428dcc7b7f9f32984ea296f7dcf544b7b50493dc3](https://bazaar.abuse.ch/browse.php?search=sha256%3A3652342b1e8b67e1700c3ed428dcc7b7f9f32984ea296f7dcf544b7b50493dc3)\n\n\n.vbs\ndynawrapx\nloader\n\nPowerShell\nloader\n\n## Detections\n\n\n[c62ef09ac5b47ea517047fd3719bb2e93b37b97f4c7477198c4b4d2383c227b6](https://bazaar.abuse.ch/browse.php?search=sha256%3Ac62ef09ac5b47ea517047fd3719bb2e93b37b97f4c7477198c4b4d2383c227b6)\n\n[4dc5cd716d199967111e2a35aa260f336ea63d9f56619ca468ac80145f2fbe15](https://bazaar.abuse.ch/browse.php?search=sha256%3A4dc5cd716d199967111e2a35aa260f336ea63d9f56619ca468ac80145f2fbe15)\n\n\nThe Splunk Threat Research Team has curated relevant detections and tagged them to the\n**AsyncRAT Analytic Story to help security analysts detect adversaries leveraging the**\n[AsyncRAT malware. This analytic story introduces 23 detections across MITRE ATT&CK](https://research.splunk.com/stories/asyncrat/)\n\n\n-----\n\ntechniques.\n\nFor this release, we used and considered the relevant data endpoint telemetry sources such\nas:\n\nProcess Execution & Command Line Logging\nWindows Security Event Id 4688, Sysmon, or any Common Information Model\ncompliant EDR technology\nWindows Security Event Log\nWindows System Event Log\nWindows PowerShell Script Block Logging\n\n## Automating with SOAR Playbooks\n\nAll of the detections associated with this analytic story create entries in the Splunk Enterprise\nSecurity risk index by default and can be used seamlessly with risk notables and the Risk\nNotable Playbook Pack. The following community Splunk SOAR playbooks can also be used\nin conjunction with some of the previously described analytics:\n\n**Playbook** **Description**\n\n\nInternal\nhost\nWinRM\nInvestigate\n\nActive\nDirectory\nReset\nPassword\n\n\nThis playbook performs a general investigation on key aspects of a Windows\ndevice using Windows Remote Management. Important files related to the\nendpoint are generated, bundled into a zip, and copied to the container\nvault.\n\nThis playbook resets the password of a potentially compromised user\naccount. First, an analyst is prompted to evaluate the situation and choose\nwhether to reset the account. If they approve, a strong password is\ngenerated and the password is reset.\n\n\n## Why Should You Care?\n\nWith this article, the Splunk Threat Research Team (STRT) enables security analysts, blue\nteamers and Splunk customers to identify AsyncRAT malware. This article helps the\ncommunity discover AsyncRAT tactics, techniques and procedures that are being used by\nseveral threat actors and adversaries (APT). By understanding its behaviors, we were able to\ngenerate telemetry and datasets to develop and test Splunk detections designed to defend\nand respond against this threat.\n\n## Learn More\n\n[You can find the latest content about security analytic stories on GitHub and in Splunkbase.](https://github.com/splunk/security-content/releases/tag/v3.12.0)\n[Splunk Security Essentials also has all these detections available via push update.](https://splunkbase.splunk.com/app/3435/)\n\n\n-----\n\nFor a full list of security content, check out the [release notes on](https://docs.splunk.com/Documentation/ESSOC/3.21.0/RN/Enhancements) [Splunk Docs.](https://docs.splunk.com/Documentation/ESSOC)\n\n## Feedback\n\nAny feedback or requests? Feel free to put in an issue on GitHub and we’ll follow up.\nAlternatively, join us on the [Slack channel #security-research. Follow these instructions If you](https://splunk-usergroups.slack.com/)\nneed an invitation to our Splunk user groups on Slack.\n\n## Contributors\n\n[We would like to thank Teoderick Contreras for authoring this post and the entire Splunk](https://twitter.com/tccontre18)\n[Threat Research Team for their contributions: Michael Haag,](https://twitter.com/M_haggis) [Mauricio Velazco,](https://twitter.com/mvelazco) [Lou Stella,](https://twitter.com/ljstella)\n[Bhavin Patel,](https://twitter.com/hackpsy) [Rod Soto,](https://twitter.com/rodsoto) [Eric McGinnis, and](https://twitter.com/SnekCharmerr) [Patrick Bareiss.](https://twitter.com/bareiss_patrick)\n\nPosted by\n\n**[Splunk Threat Research Team](https://www.splunk.com/en_us/blog/author/secmrkt-research.html)**\n\nThe Splunk Threat Research Team is an active part of a customer’s overall defense strategy\nby enhancing Splunk security offerings with verified research and security content such as\nuse cases, detection searches, and playbooks. We help security teams around the globe\nstrengthen operations by providing tactical guidance and insights to detect, investigate and\nrespond against the latest threats. The Splunk Threat Research Team focuses on\nunderstanding how threats, actors, and vulnerabilities work, and the team replicates attacks\n[which are stored as datasets in the Attack Data repository.](https://github.com/splunk/attack_data/)\n\nOur goal is to provide security teams with research they can leverage in their day to day\noperations and to become the industry standard for SIEM detections. We are a team of\n\n\n-----\n\nindustry-recognized experts who are encouraged to improve the security industry by sharing\nour work with the community via conference talks, open-sourcing projects, and writing white\npapers or blogs. You will also find us presenting our research at conferences such as\nDefcon, Blackhat, RSA, and many more.\n\n[Read more Splunk Security Content.](https://github.com/splunk/security_content)\n\n**Related Posts**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-03-27 - AsyncRAT Crusade- Detections and Defense.pdf"
    ],
    "report_names": [
        "2023-03-27 - AsyncRAT Crusade- Detections and Defense.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1680660512,
    "ts_updated_at": 1743041153,
    "ts_creation_date": 1680512378,
    "ts_modification_date": 1680512378,
    "files": {
        "pdf": "https://archive.orkl.eu/3b35aca0319a552b01382d7c0abd5a014d16311c.pdf",
        "text": "https://archive.orkl.eu/3b35aca0319a552b01382d7c0abd5a014d16311c.txt",
        "img": "https://archive.orkl.eu/3b35aca0319a552b01382d7c0abd5a014d16311c.jpg"
    }
}