{
    "id": "249a0329-8edd-4c4d-a5ce-10201f61edc4",
    "created_at": "2023-01-12T15:05:04.108646Z",
    "updated_at": "2025-03-27T02:06:09.316573Z",
    "deleted_at": null,
    "sha1_hash": "28fc7a2fe83e694e0f5042baba7d26eea8072ed2",
    "title": "2021-07-20 - Security Researchers’ Hunt to Discover Origins of the Kaseya VSA Mass Ransomware Incident",
    "authors": "",
    "file_creation_date": "2022-05-28T02:25:20Z",
    "file_modification_date": "2022-05-28T02:25:20Z",
    "file_size": 1620918,
    "plain_text": "# The Hunt to Find Origins of Kaseya's VSA Mass Ransomware Incident\n\n**[huntress.com/blog/security-researchers-hunt-to-discover-origins-of-the-kaseya-vsa-mass-ransomware-incident](https://www.huntress.com/blog/security-researchers-hunt-to-discover-origins-of-the-kaseya-vsa-mass-ransomware-incident)**\n\nKaseya has a customer base of roughly 35,000 businesses and organizations. These consist\nof approximately 17,000 managed service providers, 18,000 direct/VAR customers and a\nsignificant number of end users at the organizations they support. There is certainly a large\nattack surface offered to threat actors who might compromise the Kaseya VSA software.\n\nIn the [recent ransomware incident that occurred in July 2021, the industry learned that 50-60](https://www.huntress.com/blog/rapid-response-kaseya-vsa-mass-msp-ransomware-incident)\nMSPs and their managed customers were encrypted by the REvil ransomware gang through\nthe Kaseya VSA remote monitoring and management software.\n\nWith just 50-60 MSPs affected out of a potential 17,000 or 35,000, that leaves us with a large\nlingering question… “Why weren’t there more victims?”\n\nThat is to say, in a more pointed manner, “Shouldn’t there have been more carnage?”\n\n## But Didn't Kaseya Shut Everything Down?\n\nImmediately after recognizing the attack, Kaseya took action to shut down their VSA SaaS\nplatform and instructed customers to shut down all on-prem servers around 1400 ET. This\nshutdown could be used as an explanation for why such a small number of VSA customers\nwere affected by such a serious and widespread vulnerability. However, there are two\nimportant things to consider here.\n\n\n-----\n\nFirst, according to Kaseya, the SaaS platform was not vulnerable to the exploited\nvulnerabilities. The shutdown of the SaaS platform was a reactionary measure taken out of\nan abundance of caution but should not have directly impacted the number of exploited\nvictims.\n\nSecond, the threat actors synchronized this attack to occur at 1230 ET on July 2. This means\nthat initial exploitation of VSA servers took place prior to the shutdown. We observed\nsuspicious Kaseya procedure execution as early as 0109 ET on July 2. By the time VSA\ncustomers shut down their servers, any exploitation would have already been complete, and\nattacks would have happened as planned. Anecdotally, we have received reports of some\ncustomers finding remnants of the malicious stored procedures when bringing VSA servers\nback online; however, any order to shut down after 1230 ET would not have minimized the\nnumber of compromised MSPs.\n\n## The Attack Chain\n\nHuntress, in addition to other industry players, has observed that the ransomware incident\nused an attack chain consisting of (1) an authentication bypass, (2) arbitrary file upload and\n(3) remote code execution.\n\n**What we and others still wonder is how did the hackers get the necessary information**\n**to bypass authentication?**\n\nFollowing the exploitation steps, the first malicious request was to the public-facing file\n/dl.asp.\n\nThis file contained a logic flaw in the authentication process. If a password was not supplied,\nbut a valid unique Kaseya agent identifier (an Agent GUID) was, the end user would be\nlogged in successfully. At that point, the actor could access other functionality that required\nauthentication—all without a traditional password.\n\nIn the analysis of the attack, we have seen and confirmed malicious access by just providing\na unique agent GUID. We had not seen any indicators that the threat actors brute-forced\nagent GUIDs; they simply knew these prior. There were no failed attempts present in any\nlogs.\n\nBut still, there are lingering questions: How did the threat actors have a unique Agent\n**_GUID?_**\n\nWe believe there are a few potential options.\n\n### The Options\n\n**1. Threat actors predicted a valid Agent GUID or Display Name.**\n\n\n-----\n\n/dl.asp can accept either an Agent GUID or a Display Name. However, the Display Name\n(e.g. vsahost.root.kserver) is not the actual hostname, varies from organization to\norganization (with no standard across Kaseya VSA usage) and does not appear to be\npredictable. As for the Agent GUID, it is a randomly generated 15-character string that is also\nnot based on the hostname in any way. Based on the logs we observed from the incident, we\ndid not see any indication of attempted brute-forcing of the Agent GUID or Display Name.\n\nExcerpt from /dl.asp showing acceptance of either Agent GUID or Display Name\n\nExcerpt from agent creation showing random generation of new Agent GUID\n\n\n-----\n\nBased on these details, we have low confidence that the attackers were able to\n**repeatedly predict a valid Agent GUID or Display Name on their first attempt.**\n\n**2. Threat actors created a new “rogue” agent and used that new Agent GUID.**\n\nThe intended purpose of the original /dl.asp file is to create and download a new agent\ninstaller. The default agent installer is available for download without authentication. After\nsuccessful installation, the user will have access to a new and valid Agent GUID for the\nnewly registered device.\n\nIn the logs we have, we identified a suspicious agent that registered at ~0100 ET, which\ncould have been the malicious agent. However, we didn’t have the content of the requests or\na packet capture to verify how that agent was used. This mysterious agent was also deleted\nfrom the database we received, which is also suspicious. It seems unlikely that an MSP\nwould register an agent at 0100 ET on the Friday of a holiday weekend.\n\nAlthough the Huntress ThreatOps team could not find definitive proof that a “rogue” agent\nwas registered, we feel this option is a plausible scenario. However, it’s worth asking “Why\ndidn’t the threat actor compromise more VSA customers?” if this method was (ab)used.\n\n**3. Threat actors compromised a host running a VSA agent and used that Agent GUID.**\n\nIf the threat actor already had access to a host managed by VSA, they could have retrieved\nits Agent GUID from the registry and then used that for the authentication bypass.\n\nLocating Agent GUID via Local Registry\n\nAlthough we haven’t discovered evidence to support this theory, this option is certainly\npossible and could explain the relatively small blast radius we observed during the attack.\nRequiring initial access to a compromised host running a VSA agent is an interesting\ndependency which would make this a much more sophisticated and organized attack.\n\n**4. Other known/unknown vulnerabilities were used to leak an Agent GUID.**\n\n\n-----\n\nWhile there are seven vulnerabilities that were disclosed by DIVD and Kaseya has publicly\npatched, there is still a potential for more.\n\nWith that said, even the publicly identified vulnerabilities could include capabilities that might\noffer a valid Agent GUID.\n\nNotably, these are the interesting vulnerabilities that might leak information:\n\nCredentials leak and business logic flaw: CVE-2021-30116\nSQL injection vulnerability: CVE-2021-30117\n\nWhile strict SQL injection was not observed in the logs, just as with the other possibilities, it\ncould have been done long before the actual exploitation and potentially from different IP\naddresses.\n\n**5. Agent GUIDs or Display Names were already publicly accessible information.**\n\nIt is no secret that in recent years, Kaseya VSA has fallen victim to security incidents. There\nhave been dumps shared on Tor Hidden Services and the corners and crevices of the “dark\nweb,” and while we have not been able to confirm this, there is the potential that Agent\nGUIDs were already out and about.\n\nIf this were the case, there would need to be a mapping between the Agent GUID and the\nrespective organization. If that information were included in a leak, that could provide all the\ninformation necessary for the authentication bypass. If that mapping was not present and the\nthreat actor had access to just solely Agent GUIDs, correlating them to the specific\norganization would be much harder to do.\n\n## So Now What?\n\nWe acknowledge this is purely discussion and speculation. Considering the gravity of this\nwidespread ransomware attack, we have to ask “Why was this constrained to only 50-60\naffected MSPs, and why not more?”\n\nWe hope that outlining these potential ideas on the origins of this attack showcase the level\nof exploration and understanding vendors and customers should be seeking—but also raise\nthe notion that this could have been much worse.\n\nWere there other vulnerabilities we were unaware of? Was there missing intelligence in\nScreenshot.jpg that might tell more of the big picture? Were multiple agent GUIDs previously\nleaked or already public information? Did threat actors learn from previous incidents (like\nColonial Pipeline) that a much larger impact might invite government intervention? We just\ndon’t know.\n\n\n-----\n\n**If any organizations have a full copy of this malicious Screenshot.jpg, please**\n**share your findings and the file with us at support[at]huntress.com.**\n\nWhat we do know, however, is that the blast radius for this incident was significantly smaller\nthan what it could have been. When headlines and news articles fly claiming this is the\n“biggest ransomware attack so far,” the industry has to hone in on that key component: \"so\n_far.”_\n\nWe can be thankful that this attack was relatively limited, but we can’t lose sight and not dig\ndeeper to understand why so we can be better prepared for whatever the next threat is.\nWhat’s lurking around the corner might just be worse…\n\n_[* Special thanks to fellow Huntress Security Researchers Caleb Stewart and](https://www.linkedin.com/in/calebjstewart/)_ _Dave_\n_Kleinatland for their input and help in preparing this article._\n\n**John Hammond**\n\nThreat hunter. Education enthusiast. Senior Security Researcher at Huntress.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-20 - Security Researchers’ Hunt to Discover Origins of the Kaseya VSA Mass Ransomware Incident.pdf"
    ],
    "report_names": [
        "2021-07-20 - Security Researchers’ Hunt to Discover Origins of the Kaseya VSA Mass Ransomware Incident.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535904,
    "ts_updated_at": 1743041169,
    "ts_creation_date": 1653704720,
    "ts_modification_date": 1653704720,
    "files": {
        "pdf": "https://archive.orkl.eu/28fc7a2fe83e694e0f5042baba7d26eea8072ed2.pdf",
        "text": "https://archive.orkl.eu/28fc7a2fe83e694e0f5042baba7d26eea8072ed2.txt",
        "img": "https://archive.orkl.eu/28fc7a2fe83e694e0f5042baba7d26eea8072ed2.jpg"
    }
}