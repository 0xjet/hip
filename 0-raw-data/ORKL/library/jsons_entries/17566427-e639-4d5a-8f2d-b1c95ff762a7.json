{
    "id": "17566427-e639-4d5a-8f2d-b1c95ff762a7",
    "created_at": "2022-12-10T18:58:29.452416Z",
    "updated_at": "2025-03-27T02:06:01.693314Z",
    "deleted_at": null,
    "sha1_hash": "75de9f2b163a88f2e66c768a5ea35e6aa0e883ec",
    "title": "PFD-20-030-New Malware Samples Identified in POS Compromises",
    "authors": "",
    "file_creation_date": "2020-10-02T12:51:51Z",
    "file_modification_date": "2020-10-02T14:02:49Z",
    "file_size": 424740,
    "plain_text": "Visa Public\nVisa Payment Fraud Disruption\n\n# Visa Security Alert       SEPTEMBER 2020\n\n## NEW MALWARE SAMPLES IDENTIFIED IN POINT-OF-SALE\n\n COMPROMISES\n\n**Distribution: Public**\n\n**Summary:**\n\nIn May and June 2020, respectively, Visa Payment Fraud Disruption (PFD) analyzed malware samples recovered\nfrom the independent compromises of two North American merchants. In these incidents, criminals targeted the\nmerchants’ point-of-sale (POS) terminals in an effort to harvest and exfiltrate payment card data. Subsequent to\nanalysis, the first attack was attributed to the malware variant [TinyPOS, and the second to a mix of POS malware](https://www.carbonblack.com/blog/tau-technical-report-new-attack-combines-tinypos-with-living-off-the-land-techniques-for-scraping-credit-card-data/)\nfamilies including [RtPOS, MMon (aka Kaptoxa), and](https://www.boozallen.com/c/insight/blog/new-point-of-sale-malware-family-uncovered.html) [PwnPOS. The recent attacks exemplify threat actors’](https://secure.visaonline.com/_layouts/GVOL/GVOLStream.aspx?filename=%5Croot%5Ccontent%5Cdam%5Cgvol%5Cen%5Crisk%5Cmore-risk%5Cpayment-systems-intelligence%5Cvisa-security-alert-pwnpos-file-in-multiple-na-pos-breaches-25-jan-2019.pdf&contenttype=application/pdf)\ncontinued interest in targeting merchant POS systems to harvest card present payment account data. PFD is\nproviding the analysis of these malware variants and the corresponding indicators of compromise (IOCs) to\nassist in the identification, prevention, and mitigation of attacks using the malware.\n\n**Threat Assessment:**\n\nIn the first compromise, threat actors targeted a North American hospitality merchant with the POS malware\nvariant TinyPOS. Initial access to the merchant network was obtained through a phishing campaign that targeted\nemployees at the merchant. Legitimate user accounts, including an administrator account, were compromised as\npart of this phishing attack and were used by the threat actors to login to the merchant’s environment. The\nactors then used legitimate administrative tools to access the cardholder data environment (CDE) within the\nmerchant’s network.\n\nOnce access to the CDE was established, the actors deployed a memory scraper to harvest track 1 and track\n**2 payment account data, and later used a batch script to mass deploy the malware across the merchant’s**\nnetwork to target various locations and their respective POS environments. The memory scraper harvested the\npayment card data and output the data into a log file. At the time of analysis, no network or exfiltration\nfunctions were present within the sample. Therefore, the actors would likely remove the output log file from the\nnetwork using other means.\n\nIn the second compromise, the threat actors again targeted a North American hospitality merchant with POS\nmalware. Subsequent to analysis, it was determined the threat actors used the malware variants RtPOS, MMon\n(aka Kaptoxa), and PwnPOS. While less is known about the tactics used by the threat actors in this attack, there is\nevidence to suggest that the actors employed various remote access tools and credential dumpers to gain initial\naccess, move laterally, and deploy the malware in the POS environment. The malware utilized in these stages of\n\n1\nPFD-20-030 Visa Public\n\n\n-----\n\nVisa Public\nVisa Payment Fraud Disruption\n\nthe compromise was not recovered. The POS malware variants used in this attack targeted track 1 and track 2\n**payment account data.**\n\nThe indicators of compromise associated with the two respective compromises are included below.\n\n#### 1. IOCs associated with the first compromise:\n\n**Sample Pair #1**\n\n**Filename** MahjongMCE.bat\n**MD5** 9e56cd1c62a11b3f6f789da56cfe581d\n**SHA1** ef2466cb91adf7f39f4ec4186009e028b6a86eb3\n**SHA256** 15712752daf007ea0db799a318412478c5a3a315a22932655c38ac6485f8ed00\n**SSdeep** 96:R23qOfh3rYq3fEQcTvKVD3W7T+LMr2EuQsRjgbrl/Om0ltnedUiA5dUi3DRI6QT\nj:R2H53rY+zoiW7CZ0sFgbrlmm0TeqiA54\n**Note** **PowerShell Loader**\n\nThe batch file contains a call to powershell.exe and a provided base64 encoded command. The command is a\nstandard implementation of reflective injection using PowerShell that is prevalent in many open source\nframeworks. Of particular interest, this sample loads the MahjongMCE.png from the C:\\temp\\ folder.\n\n**Filename** MahjongMCE.png\n**MD5** 2146d62b2be5b4ec04cd297c4e3094d1\n**SHA1** 453a1d728582aa76d429dacfa2c6022af8bb7abe\n**SHA256** e48af0380d51eff554d56aabeeb5087bba37fa8fb02af1ccd155bb8b5079edae\n**SSdeep** 768:sAl096SK1r4t3yqvekDqvIj0HLXLz+LILwhgK:sAkK18t3d2xOI0hp\n**Note** **PNG Image File with Shellcode**\n\nThe attackers appended raw shellcode after the end of file (EOF) marker for the PNG file. This is an old tactic that\nallows the file to be properly rendered by an image viewer, while still concealing the appended data. This\nshellcode is called and executed in memory by the PowerShell Loader.\n\n**Filename** MahjongMCE.png.sc\n**MD5** 182edcde38a433f3d965ad8e939315d3\n**SHA1** 09d3c289e7039fe8010ae7fc979749d57653f8a0\n**SHA256** bdd978a91dad7a201274956098d0e6612e3f9e6a009fc4f24a362c19b1813218\n**SSdeep** 96:SaVljuVPqX9wFbpLo1NAxo5fQkv8rC23caapfvcGqGTgiEKuHeDEHJ5N5hIzGtr9:\nSamSa+QSSSpfcGeeDEp5x6Gl01ogjxli\n**Note** **Extracted Shellcode - TinyPOS Point-of-Sale (POS) Malware**\n\nThe shellcode is an evolution of the TinyPOS Point-of-Sale (POS) Malware family. Initially the shellcode will\nexecute a small stub which is responsible for decoding the remaining portion of the shellcode. The shellcode is\nultimately responsible for scraping the credit card information and preparing it for exfiltration.\n\n2\nPFD-20-030 Visa Public\n\n\n-----\n\nVisa Public\nVisa Payment Fraud Disruption\n\n**Filename** MahjongMCE.png_decoded.sc\n**MD5** da4b2e4f1e6964960ed76c351d81abef\n**SHA1** aa61f6034ba53802e4c6a97bd33a850313dc57f9\n**SHA256** 5bc41cde297936199bd145098727905b75762dd85ff2e4caddb93e2370ff8fbc\n**SSdeep** 96:cs9SV3V9X62twyKGKJ1AjD4tF/gyN87S4n7OF7vQdQoNio+QPZodkWCbBt:cH\nZv01AotHO7S47O9HFKPI0t\n**Note** **Extracted Shellcode (Decoded) - TinyPOS Point-of-Sale (POS) Malware**\n\n**Process List Scan**\nThe shellcode will then enumerate the processes running on the system and specifically look for process names\nwhich contain partial names of specific POS software.\n\n**Memory Scraper & Log File**\nOnce a target process has been located the shellcode parses the memory for credit card track data (specifically\nTrack 1 & 2 data), by completing a series of checks on the string data to ensure that it is formatted to track data\nstandards. The shellcode then completes a Luhn algorithm check on the data to determine if it contains a valid\ncredit card number. Once these steps are completed, the shellcode XOR encodes the scraped data and saves it\nto the following output log file:\n\n#### • Log File = C:\\temp\\sys_temp.log\n • XOR Key (Hex) = fdaa0f49c2beac9f\n\n**Sample File #2**\n\n**Filename** CGLPT64.bat\n**MD5** c66c23e8574cec3eb785e5d32c4af253\n**SHA1** adf576aa3a1a01ea4b3f7ad35736068c60646317\n**SHA256** cb7b7c6e37c4edd8bf9c2baaf3d97c895b705565aac7110ba3e7799d9e501172\n**SSdeep** 96:yfCdgNhrQkl4rYq3fEQ7S4LlxSTK8sZGQsaxabrl/OmLuw7+vjwNZh4AA3T7u4ev\n:yqW3Ekl4rY+zu4JMxsnsaxabrlmmqwuI\n**Note** **PowerShell Loader**\n\nThe batch file contains a call to powershell.exe and a provided base64 encoded command. The command is a\nstandard implementation of reflective injection using PowerShell that is prevalent in many open source\nframeworks. Of particular interest, this sample loads the cloud_Thumbnail.bmp from the C:\\journal\\ folder.\n\n**Filename** cloud_Thumbnail.bmp\n**MD5** b5b4ae0cc7302a9cb039f65bb4ac71da\n**SHA1** 2c695af125c6f6b484ab984f95fab1cf764cdc4f\n**SHA256** e2f9cb1fcdc531583c82f40c7325118bbc671f4d33ea639f2d575fec96dbbd86\n**SSdeep** 96:aZqgKTLhRb83gg+ruWmjgwX6m/TaXuK9yt27/AtPd6GmQ8RX:aZUhRb83gg+\nr1mjJHbII2MtV6Gm9p\n**Note** **BMP Image File w/ Shellcode**\n\n3\nPFD-20-030 Visa Public\n\n\n-----\n\nVisa Public\nVisa Payment Fraud Disruption\n\nThe attackers append raw shellcode after the end of file (EOF) marker for the BMP file. This is an old tactic that\nallows the file to be properly rendered by an image viewer, while still concealing the appended data. This\nshellcode is called and executed in memory by the PowerShell Loader.\n\n**Filename** cloud_Thumbnail.bmp.sc\n**MD5** eab5d0b9d90bcbfa7af5d10b401f73b3\n**SHA1** 32567d0b59bc20c2207b286eaef1df6f67d8c002\n**SHA256** 59adc06ae5a9504313229f252322d8a8e7826999ba1deb036172afd22c0a7774\n**SSdeep** 96:GRb83gg+ruWmjgwX6m/TaXuK9yt27/AtPd6GmQ8RX:GRb83gg+r1mjJHbII2\nMtV6Gm9p\n**Note** **Extracted Shellcode - TinyPOS Point-of-Sale (POS) Malware**\n\nThe shellcode is an evolution of the TinyPOS Point-of-Sale (POS) Malware family. Initially the shellcode\nexecutes a small stub which is responsible for decoding the remaining portion of the shellcode. The shellcode is\nultimately responsible for scraping the credit card information and preparing it for exfiltration.\n\n**Filename** cloud_Thumbnail.bmp_decoded.sc\n**MD5** 4362ee278835a5a4ee112e90c490ed05\n**SHA1** 38968d44a1870cf4c4177da08532f556f97c3b8a\n**SHA256** 663c69d8bb372487ca9bd8f3b6c983bf7388e79d2ecdb1713718a779f74b11d5\n**SSdeep** 96:DKos9SV3V9X62twyKGKJ1GZSjD4tF/KyNs1S4n7Ov7vQdQwNioOQPZodkWCb\n6MB:3HZv01G0otB21S47OzHNGPIkB\n**Note** **Extracted Shellcode (Decoded) - TinyPOS Point-of-Sale (POS) Malware**\n\n**Process List Scan**\nThe shellcode will then enumerate the processes running on the system and specifically looking for process\nnames which contain partial names of specific POS software.\n\n**Memory Scraper & Log File**\nOnce a target process has been located the shellcode parses the memory for credit card track data (specifically\nTrack 1 & 2 data), by completing a series of checks on the string data to ensure that it is formatted to track data\nstandards. The shellcode then completes a Luhn algorithm check on the data, to determine if it contains a valid\ncredit card number. Once these steps are completed, the shellcode XOR encodes the scraped data and saves it\nto the following output log file:\n\n#### • Log File = C:\\journal\\history_0.dat\n • XOR Key (Hex) = fdaa0f49c2beac9f\n\n4\nPFD-20-030 Visa Public\n\n\n-----\n\nVisa Public\nVisa Payment Fraud Disruption\n\n#### 2. IOCs associated with second compromise:\n\n**File #1**\n\n**Filename** alohae.exe\n**Source** [Virus Total](https://www.virustotal.com/gui/file/fb749c32b58fd1238f21d48ba1deb60e6fb4546f3a74e211f80a3ed005f9e046/detection)\n**MD5** 9443861a644029b7092a6b7bf98939fb\n**SHA1** a3c81c9e3d92c5007ac2ef75451fe007721189c6\n**SHA256** fb749c32b58fd1238f21d48ba1deb60e6fb4546f3a74e211f80a3ed005f9e046\n**SSdeep** 3072:3cAmkDTgWpRT+fAv6Qeyt+TdY5ilY9OBkHTLNVBjBNvOv86NEAg0Fujopm\nDFF369:3R3g8T+foBWlCOBkHtAOXZE0N4\n**Note** **RtPOS Point-of-Sale (POS) Malware**\n\n**Persistence - Create or Modify System Process: Windows Service (T1543.003)**\nThe RtPOS Point-of-Sale (POS) Malware accepts only two arguments “/install” and “/remove” which are\nresponsible for installing and removing the service on the victim’s machine. When supplied with the \"/install\"\nargument, the malware installs itself as a service for persistence and auto execution during Windows startup:\n\n#### • Service Name: WinLogOn\n • Service Description: Windows Logon Service \n\n**Credit Card Scraping Function**\nFollowing installation, RtPOS then iterates the available/running processes on the compromised machine. This is\ncarried out in two steps; first RtPOS uses CreateToolhelp32Snapshot to obtain a process list, and finally uses\nProcess32FirstW to begin iteration of the process list. Finally, RtPOS uses the ReadProcessMemory function to\ngain access to the compromised system’s memory space. When Track1 and Track2 data is found, the captured\ninformation is passed to a Luhn algorithm for validation. The Track1 and Track2 data that pass this verification\nare then saved to the following file for later exfiltration:\n\n#### • %SYSTEMROOT%\\SysWOW64\\sql8514.dat\n\n**File #2**\n\n**Filename** mmon.exe\n**Source** [Virus Total](https://www.virustotal.com/gui/file/86dd21b8388f23371d680e2632d0855b442f0fa7e93cd009d6e762715ba2d054/detection)\n**MD5** 255daa6722de6ad03545070dfbef3330\n**SHA1** 80aedf2eddc9e2f39306cbaa63e59c7a08468699\n**SHA256** 86dd21b8388f23371d680e2632d0855b442f0fa7e93cd009d6e762715ba2d054\n**SSdeep** 3072:ikmVcWhCz7cruMlg+PtBxp3bTsZiVXBeN/2KD2VD:/muoCz7cyUP9dbTYipB\nGG\n**Note** **MMon (aka Kaptoxa) Point-of-Sale (POS) Malware**\n\n**MMon-Derivative POS Malware Families**\nMMon is believed to be short for \"memory monitor\" and is believed to be called Картоха in the underground.\nThe project dates back to at least 2010 and contains the \"Kaptoxa\" string. The code has been repurposed into\n\n5\nPFD-20-030 Visa Public\n\n\n-----\n\nVisa Public\nVisa Payment Fraud Disruption\n\nmultiple point-of-sale (POS) scraping threats including JavalinPOS, BlackPOS, POSRAM, and others. The\nmmon.exe utility provides command-line memory scraping and nothing more. However, it is simple for other\nmalware authors to incorporate the tool into their own projects, and this accounts for most of the\nMMon-derivative POS malware. The mmon.pdb code debug information file is present in all the derivatives of\nthe MMon code base. Many of these related codes have been incorrectly lumped under the BlackPOS label at\ntimes by media sources and cyber security publications.\n\n**File #3**\n\n**Filename** wnhelp.exe\n**Source** [Virus Total](https://www.virustotal.com/gui/file/088f40a7a52635ff19e80c62883977d94dd5835e85739e19504f7437d296760b/detection)\n**MD5** c86327222d873fb4e12900a5cadcb849\n**SHA1** b1983db46e0cb4687e4c55b64c4d8d53551877fa\n**SHA256** 088f40a7a52635ff19e80c62883977d94dd5835e85739e19504f7437d296760b\n**SSdeep** 6144:5GM9f8BHPlmg2XR2j0mYHLptiVK0LZV3C5:5x98HPlmg6R2j0mYF4VRLZtq\n**Note** **PwnPOS Point-of-Sale (POS) Malware**\n\n**During execution, the malware drops a copy of itself to the following locations:**\n\n#### • %SYSTEMROOT%\\System32\\wnhelp.exe\n\n**Persistence - Create or Modify System Process: Windows Service (T1543.003)**\nDuring execution, the malware installs itself as a service for persistence and auto execution during Windows\nstartup:\n\n#### • Service Name: Windows Media Help\n • Service Path: \"%SYSTEMROOT%\\wnhelp.exe\" –service\n\n**General Log File**\nDuring execution, the malware creates a log file used to log its own general behavior. The malware checks for\nadministrator privilege and if it determines the user session does not have administrator privilege, then it\noutputs an error \"ERRLOG:error: not admin user\" into the log file.\n\n#### • %TEMP%\\DebugConsole.log\n\n**Credit Card Scraping Function**\nThe scraping function scans process memory and uses the Luhn algorithm to identify credit card data which is\nwritten to a log file in plain text. The first record in the log file consists of a date and timestamp, process ID (PID),\nand the word \"START\". Subsequent records of the log consist of a date and timestamp, the process path, the\nprocess ID (PID), and Track1 and Track2 credit card data.\n\n#### • %SYSTEMROOT%\\System32\\perfb419.dat\n\n6\nPFD-20-030 Visa Public\n\n\n-----\n\nVisa Public\nVisa Payment Fraud Disruption\n\n### 3. Recommendations for Issuers, Acquirers and Merchants\n\nVisa recommends the following best practices to reduce the risk of exposure:\n\n    - **Employ the IOCs contained in this report to detect, remediate, and prevent attacks using the POS**\nmalware variant.\n\n    - **Secure remote access with strong passwords, ensure only the necessary individuals have**\npermission for remote access, disable remote access when not in use, and use two-factor\nauthentication for remote sessions.\n\n    - **Enable EMV technologies for secure in-person payments (chip, contactless, mobile and QR code).**\n\n    - **Provide each Admin user with their own user credentials. User accounts should also only be**\nprovided with the permissions vital to job responsibilities.\n\n    - **Turn on heuristics (behavioral analysis) on anti-malware to search for suspicious behavior, and**\nupdate anti-malware applications.\n\n    - **Monitor network traffic for suspicious connections, and log system and network events.**\n\n    - **Implement Network Segmentation,** where possible, to prevent the spread of malicious software\nand limit an attacker’s foothold.\n\n    - **Maintain a patch management program and update all software and hardware firmware to most**\ncurrent release to limit the attack surface for zero-day vulnerabilities.\n\n    - **In the event of a confirmed or suspected breach, refer to Visa’s** _[What to do if Compromised](https://usa.visa.com/dam/VCOM/download/merchants/cisp-what-to-do-if-compromised.pdf)_\n_(WTDIC),_ **published October 2019.**\n\nFor more information, please contact **[paymentintelligence@visa.com](mailto:paymentintelligence@visa.com)**\n\n**_Disclaimer:_**\n_This report is intended for informational purposes only and should not be relied upon for operational, marketing, legal, technical, tax, financial_\n_or other advice. Visa is not responsible for your use of the information contained in this report (including errors, omissions, or non-timeliness of_\n_any kind) or any assumptions or conclusions you may draw from it._\n_All Visa Payment Fraud Disruption Situational Intelligence Assessment content is provided for the intended recipient only, and on a need-to-_\n_know basis. PFD reporting and intelligence are intended solely for the internal use of the individual and organization to which they are_\n_addressed. Dissemination or redistribution of PFD products without express permission is strictly prohibited_\n\n7\nPFD-20-030 Visa Public\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        },
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://usa.visa.com/dam/VCOM/global/support-legal/documents/new-pos-malware-samples.pdf",
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-09-25 - Visa Security Alert New Malware Samples  identified in Point-of-Sale Compromises.pdf"
    ],
    "report_names": [
        "new-pos-malware-samples.pdf",
        "2020-09-25 - Visa Security Alert New Malware Samples  identified in Point-of-Sale Compromises.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1670698709,
    "ts_updated_at": 1743041161,
    "ts_creation_date": 1601643111,
    "ts_modification_date": 1601647369,
    "files": {
        "pdf": "https://archive.orkl.eu/75de9f2b163a88f2e66c768a5ea35e6aa0e883ec.pdf",
        "text": "https://archive.orkl.eu/75de9f2b163a88f2e66c768a5ea35e6aa0e883ec.txt",
        "img": "https://archive.orkl.eu/75de9f2b163a88f2e66c768a5ea35e6aa0e883ec.jpg"
    }
}