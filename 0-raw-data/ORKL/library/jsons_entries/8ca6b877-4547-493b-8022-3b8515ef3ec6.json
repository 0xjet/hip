{
    "id": "8ca6b877-4547-493b-8022-3b8515ef3ec6",
    "created_at": "2023-01-12T14:59:26.043761Z",
    "updated_at": "2025-03-27T02:10:04.292848Z",
    "deleted_at": null,
    "sha1_hash": "61b1c24632a4ad5d6396dbad8dfeb35f2501c910",
    "title": "2016-11-09 - Tricks of the Trade- A Deeper Look Into TrickBot’s Machinations",
    "authors": "",
    "file_creation_date": "2022-05-28T03:51:32Z",
    "file_modification_date": "2022-05-28T03:51:32Z",
    "file_size": 1194584,
    "plain_text": "# A Deeper Look Into TrickBot's Machinations\n\n**[securityintelligence.com/tricks-of-the-trade-a-deeper-look-into-trickbots-machinations/](https://securityintelligence.com/tricks-of-the-trade-a-deeper-look-into-trickbots-machinations/)**\n\n[Home&nbsp/](https://securityintelligence.com/) [Advanced Threats](https://securityintelligence.com/category/x-force/threats/)\nTricks of the Trade: A Deeper Look Into TrickBot’s Machinations\n\n\nNovember 9, 2016\n\n\n-----\n\n[Advanced Threats November 9, 2016](https://securityintelligence.com/category/x-force/threats/)\nBy [Lior Keshet 6 min read](https://securityintelligence.com/author/lior-keshet/)\nTrickBot is a new banking Trojan. It appears to be a Dyre successor that emerged in the wild\n[in October 2016. TrickBot’s code has been in progressive testing since August 2016. It](http://www.threatgeek.com/2016/10/trickbot-the-dyre-connection.html)\n[continues to see ongoing updates and, now, actual infection campaigns and fraud attacks.](https://www.ibm.com/software/products/en/trusteer-fraud-protection-suite)\n\nInternally, there is more to [TrickBot than meets the eye. In this research post, we’ll cover](https://securityintelligence.com/an-aggressive-launch-trickbot-trojan-rises-with-redirection-attacks-in-the-uk/)\nsome of the most notable points about this malware’s capabilities, including:\n\nAn uncommon method of performing man-in-the-browser (MitB) attacks;\n\nTrickBot’s buggy webinjection mechanism;\n\nThe developer’s elegant application program interface (API) obfuscation, borrowed\nfrom Carberp; and\n\nOur two cents about the suspected TrickBot-Dyre connection.\n\nFor analysis, the sample we used was:\n[5e363a42d019fc6535850a2867548f5b968d68952e1cddd49240d1f426debb73.](https://www.virustotal.com/en/file/5e363a42d019fc6535850a2867548f5b968d68952e1cddd49240d1f426debb73/analysis/)\n\n## An Unusual Man-in-the-Browser Technique\n\nNowadays, most modern financial malware families are capable of injecting malicious code\ninto ongoing browser sessions (e.g., MitB or a webinjection attack). The most common way\nmalware developers implement injections is by setting them up locally at the victim’s\nmachine. The malware keeps a local configuration file for the injections, specifying exactly\nwhen and how the malware will modify the contents of targeted bank webpages.\n\n\n-----\n\n[Learn more about how to outsmart Fraudsters with Cognitive Fraud Detection](https://www-01.ibm.com/marketing/iwm/dre/signup?source=mrs-form-9451&S_PKG=ov54550)\n\nA more advanced and less common method to achieve the same result is to fetch the\ninjection instructions from the attacker’s server in real time. This is the method TrickBot’s\ndevelopers opted to use. It is also known as serverside injections.\n\nFor this purpose, and much like other advanced banking Trojans, TrickBot deploys a\nbrowser-hooking engine designed to intercept communications to and from the victim’s\ninternet browser. With the real-time fetching trick, the malicious code injections themselves\nare kept securely on the attacker’s server, not in a file on the victim’s endpoint.\n\nWhen a victim browses one of TrickBot’s target URLs, this is what actually happens:\n\n1. TrickBot’s financial module intercepts the original HTTP response before it is rendered\n\nto the victim. The browser does not display the “clean” response.\n2. TrickBot sends a multipart HTTP packet to its C2 with the following sections:\n\n1. “sourcelink,” the complete URL that triggered the attack;\n2. “sourcequery,” the browser’s complete HTTP query; and\n3. “sourcehtml,” the original HTML as would be displayed by an uninfected browser.\n3. C2 replies with full HTML content to be rendered by the victim’s browser, including\n\ninjected parts.\n4. Finally, TrickBot’s financial module replaces the original response that would normally\n\ncome from the bank with the C2’s response, and the injected page is displayed on the\nvictim’s end.\n\nThe serverside injection method has advantages over the standard, local mechanism used\nby most financial malware today. Notably, it allows for enhanced obscurity and flexibility. The\nmalware’s author can keep the injection code out of sight until it is needed. The actor can\nturn the webinjections on or off on the fly, easily modify the injections and then push an\nupdate to some or all the infected victims instantaneously.\n\n_Figure 1: TrickBot hooking FireFox’s network functions to enable MitB interception._\n\n_Figure 2: TrickBot’s Server Side Web-Injects — Top Level Flow._\n\n## An Elegant Choice for API Obfuscation\n\nWhen it comes to keeping malware alive longer, it is common practice for malware authors to\nadd protection layers to their code to ward off reverse engineering. As expected, we\nidentified one such technique employed by TrickBot: API obfuscation.\n\n\n-----\n\nHaving analyzed TrickBot s obfuscation method, we found it very similar to — and likely\nborrowed from — the Carberp Trojan’s API obfuscation. Carberp’s source code was leaked\nin 2013, giving rise to other malware based on its sophisticated DNA.\n\nWe found that TrickBot does not apply the API obfuscation to all the APIs; it only applies it to\nthe more sensitive APIs that the developer wants to be hidden. This is a sneaky method,\nsince researchers may believe they already know all the APIs being used, when in reality\nmore APIs are covertly part of the game.\n\nThe obfuscation process here is based on precalculated hash values of the APIs. Calling an\nAPI function only includes a hash value instead of the function name, making static analysis\nharder unless the researcher applies an additional method to resolve the APIs.\n\n_Figure 3: WSAStartup hash from Carberp’s source code._\n\n_Figure 4: Resolving an API by hash — WSAStartup._\n\nA simple way of overcoming this obfuscation is by using an Interactive Disassembler (IDA)\nPython script, especially since the hashed values themselves are already available within\nCarberp’s leaked source code.\n\n## A Bug in the Wild\n\nTrickBot has been in testing since summer 2016, even before it was equipped with financial\nmalware features. Initially, TrickBot’s developers appeared to struggle with the malware’s\nwebinjection mechanism, since we found a few TrickBot samples in the wild that presented\nstrangely erratic behavior. At first, we suspected TrickBot was up to some anti-research\nwiles, but in reality, it was just bugged.\n\nPer our analysis, TrickBot’s webinjection malfunction caused the malware to constantly inject\nthe same code over and over again, sabotaging the malware’s own functionality. As this\nbehavior was inconsistent across some samples, we had to manually apply a fix to continue\nresearching the mechanism.\n\nWe won’t get into further detail at this point, since this bug actually prevented TrickBot from\nperforming fraud. We will say, however, that since the malware is under constant\ndevelopment, the developers may have already addressed the bug and fixed it in the newer\nsamples, enabling TrickBot to operate more smoothly.\n\n## The TrickBot-Dyre Connection\n\n\n-----\n\n[Speculation over the TrickBot-Dyre connection emerged as soon as the malware was](https://securityintelligence.com/news/trickbot-malware-resurrects-the-ghost-of-dyre/)\ndiscovered and has been the source of much debate ever since. Even though this subject\n[was mentioned in several other TrickBot analysis blogs, we would like to contribute several](http://www.threatgeek.com/2016/10/trickbot-the-dyre-connection.html)\nkey points from our own research into this new threat:\n\nTrickBot’s serverside webinjection method is uncommon in today’s malware. The other\nmalware family that used it, as you can guess, was Dyre.\n\nPackets sent to the attack server during the serverside webinjects consist of three\nparts, titled “sourcelink,” “sourcequery” and “sourcehtml.” These exact names were\nalso used in Dyre’s webinjection mechanism.\n\n_Figure 5: TrickBot and Dyre both use “sourcelink” and “sourcequery” for their_\n_communications._\n\nTargeted URLs and command-and-control (C&C) addresses are kept encrypted on the\n[infected machine. Dyre did the same. While the encryption schemes for TrickBot are](https://securityintelligence.com/dyre-straights-group-behind-the-dyre-trojan-busted-in-moscow/)\nnot identical, they appear to be too similar to be a mere coincidence.\n\nTrickBot passes the target URLs list to its financial module, which is injected into the\nbrowser using pipes communication. This, again, is a Dyre hallmark.\n\nThe structure of the targeted URLs in the configuration is typically consistent for each\nmalware, and TrickBot’s target specification — you guessed it — sure looks a lot like\nDyre’s.\n\n**Related:** [An Aggressive Launch: TrickBot Trojan Rises With Redirection Attacks in the UK](https://securityintelligence.com/an-aggressive-launch-trickbot-trojan-rises-with-redirection-attacks-in-the-uk/)\nAlthough the similarities are there, keep in mind that most of them are relatively simply to\nimitate. For example, even though the serverside webinjection technique is common to both\nTrojans, the code implementing this capability and the coding style itself are actually\ndifferent.\n\nThis point is important because we can see how rapidly and effectively new and advanced\nmalware is being developed, either by the same actors or by newcomers inspired by one of\nthe most nefarious gangs in cybercrime history.\n\n## A Last-Minute Update: Redirection Attacks!\n\nTrickBot’s developers must be hard at work these days, pushing to enhance the malware for\na live campaign targeting banks. Just as we were about to publish this post, we detected a\nnew infection campaign with a new configuration targeting U.K. banks. Until now, TrickBot\n\n\n-----\n\nonly targeted banks in Australia. Furthermore, some of these new U.K. targets are set up for\nredirection attacks, while TrickBot only employed the serverside webinjection attack\ndescribed above until now.\n\nA redirection attack, in short, means that instead of injecting malicious code into the original\nwebpage, the victim is now redirected to a new site forged by the fraudsters. This site looks\nand feels exactly like the original website, and the browser indicates a Secure Sockets Layer\n(SSL) connection based on the original site’s certificate.\n\n[To learn more about redirection attacks and their purpose, read our blogs about Dridex and](https://securityintelligence.com/dridex-launches-dyre-like-attacks-in-uk-intensifies-focus-on-business-accounts/)\n[GozNym.](https://securityintelligence.com/time-is-money-goznym-launches-redirection-attacks-in-poland/)\n\n## A Newcomer to the Malware Arena\n\nTrickBot is undoubtedly the work of professionals who have been around the banking Trojan\nscene for some time. These experienced fraudsters are apparently well-versed in the\nmodern features common to the types of malware banks reckon with nowadays. We expect\nto see this Trojan evolve its anti-security and anti-research techniques and pop up in more\ninfection campaigns as the year comes to a close.\n\n[Read the white paper: Outsmarting Fraudsters with Cognitive Fraud Detection](https://www-01.ibm.com/marketing/iwm/dre/signup?source=mrs-form-9451&S_PKG=ov54550)\n\n[Lior Keshet](https://securityintelligence.com/author/lior-keshet/)\nMalware Research Technical Lead, IBM Trusteer\n\nLior is a malware research technical lead at IBM Security's Trusteer's group. He has been a\ncore member of the Trusteer cybercrime labs for the past four yea...\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-11-09 - Tricks of the Trade- A Deeper Look Into TrickBot’s Machinations.pdf"
    ],
    "report_names": [
        "2016-11-09 - Tricks of the Trade- A Deeper Look Into TrickBot’s Machinations.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b753c6a8-a83d-47bc-829d-45e56136eb7d",
            "created_at": "2023-01-06T13:46:38.97802Z",
            "updated_at": "2025-03-27T02:00:02.967861Z",
            "deleted_at": null,
            "main_name": "GozNym",
            "aliases": [],
            "source_name": "MISPGALAXY:GozNym",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535566,
    "ts_updated_at": 1743041404,
    "ts_creation_date": 1653709892,
    "ts_modification_date": 1653709892,
    "files": {
        "pdf": "https://archive.orkl.eu/61b1c24632a4ad5d6396dbad8dfeb35f2501c910.pdf",
        "text": "https://archive.orkl.eu/61b1c24632a4ad5d6396dbad8dfeb35f2501c910.txt",
        "img": "https://archive.orkl.eu/61b1c24632a4ad5d6396dbad8dfeb35f2501c910.jpg"
    }
}