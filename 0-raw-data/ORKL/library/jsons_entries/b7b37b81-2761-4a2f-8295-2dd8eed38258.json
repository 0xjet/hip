{
    "id": "b7b37b81-2761-4a2f-8295-2dd8eed38258",
    "created_at": "2022-10-25T16:48:12.49154Z",
    "updated_at": "2025-03-27T02:05:54.477482Z",
    "deleted_at": null,
    "sha1_hash": "cd1679b297d1649491047771ba3a048192e577c7",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-08-16T04:53:54Z",
    "file_modification_date": "2021-08-16T04:53:54Z",
    "file_size": 2500603,
    "plain_text": "# Uncovering Tetris – a Full Surveillance Kit Running in your Browser\n\n**imp0rtp3.wordpress.com/2021/08/12/tetris**\n\nBy imp0rtp3 August 12, 2021\n\n## Executive Summary\n\nA Chinese state sponsored threat actor is targeting Chinese-speaking opposition through waterholed websites.\nThe Campaign uses a modular and custom JS surveillance framework, dubbed “Tetris”, implementing a wide range of browser feature.\nAlmost all of Tetris’ components have zero AV detections.\nTetris exploits vulnerabilities is 58 widely used websites, including Baidu, QQ, Tmall and the NYT.\nTwo different waterholed websites have been found, there are indications to at least 5 more..\n\n## IntroductionLatest from the Blog\n\nThis report is based on exemplary work by @felixaime, who found 2 waterholed websites which triggered all this research.\n\nAs of the time of this writing, all the components of the framework are undetected by AV, except a 2nd stage detected by “Ikarus”. This report includes several detection and prevention ideas and\nindicators, for the web users and for developers.\n\n\n-----\n\n## Tetris Attack Chain\n\n### Waterholed sites\n\n\n-----\n\nFelix has found two sites containing links to the malicious domain googledrivers[.]com. The sites both appear to be independent newsblogs. Both are focused on China, one site on its actions against\nTaiwan and Hong-Kong written in Chinese and still updated and the other about general atrocities done by the Chinese government, written in Swedish and last updated 2016.\n\n1st site waterhole link\n\n2nd site waterhole script\n\nAs seen in the code snippets, the waterhole is embedded differently in each site. Moreover, while the first site has every page infected with the script, The second has the waterhole only on its homepage. I\nbelieve this difference stems from the first site being managed by WordPress and thus enabling the attackers to inject their script tag in the default heading.\n\n301 redirection response to /s/02Bl\n\nBoth links redirect to a second path in the same domain (Status 301 redirection). The path is the same except the value of ‘ver’ GET argument, which I later discovered is called Project ID by the Tetris\ndevelopers.\n\n\n-----\n\n### Jetriz\n\nJetriz is a Javascript script which has undergone massive obfuscation. After deobfuscation(see Appendix D), it turns out most of the script is an obfuscated version of the known JS frameworks “fetch.js”\nand “core.js”. Each time the script is requested from the server a different uid variable is set for it, so there is no common hash.\n\n**[Update 13/08/21 – Arkbird introduced me to a public obfuscation framework named plainly “Javascript obfuscator” available here. The framework has different options which allow the attacker to](https://twitter.com/Arkbird_SOLG)**\nchoose the sophistication of the obfuscated script. It is highly likely this framework was used to obfuscate the Tetris scripts.\n\nThe custom functions of the script are simple:\n\n1. Anti-debugging (the script detects if the developer tools sidebar is opened).\n2. Basic browser information extraction.\n3. Sending of the browser information, the current time and the sid back to the server.\n\n1 `{`\n2 `device:` `\"PC\"` `,`\n3 `language:` `\"zh_CN\"` `,`\n```\n   engine: \"Blink\",\n```\n4\n```\n   browser: \"Chrome\",\n```\n5\n```\n   os: \"Windows\",\n```\n6\n```\n   osVersion: \"10.0\",\n```\n7 `version:` `\"91.0.4472.124\"`\n8 `}`\n9\n\nJetriz before deobfuscation, not much fun to read:(\n\n\n-----\n\nThe response to the request depends on whether the browsers’ language is Chinese. If it’s not then “<h1>Not Found</h1>” is returned. If it is Chinese then the server responses with Swid.\n\n### Swid\n\nOn First sight, Swid looks exactly like Jetriz – same obfuscation, similar size and it even shared functionality. A closer look reveals that although it shares the anti-debug and redirection functions of\nJetriz, its main logic is different. Moreover, it depends on environment variables set in Jetriz – the browser information object and the projId. Interestingly, the sid is no longer regarded.\n\nThe Script has two main functions:\n\n1. Injecting itself to any new page opened\n2. Loading, managing and running plugins\n\n**Link Hijacker**\n\nThe mechanism used by the script is pretty simple: it registers a callback for every link of the same domain clicked. Once a user clicks a link the callback neutralizes the original browser event that should\nhave occurred (redirecting the user to a new path) and instead performs the same mechanism itself. Before loading the next page, it appends to it a <script> tag with Jetriz’s url as source. That way, as\n**long as the user stays in the same website, the attacker can run its code.**\n\nLink hijacking mechanism\n\n\n-----\n\n[Of course, if it were up to the attackers, they would have hijacked all links, and not just links to the same website. Unfortunately for them, CORS prevents that. Cross-Origin Resource Sharing is a](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)\nmechanism implemented in every browser and enables servers to decide which (if any) other domains can access their content. This way, the attacker cannot implant a script in a web page in which he\nwasn’t given access to.\n\n**Plugin Manager**\n\nSwid contains a quite impressive plugin manager, built in a modular way and even giving an API for the plugins to use. Although very easy to implement, the manager can’t run the plugins periodically,\nand they only run once.\n\n**communications**\n\nThe plugin manager initiates a websocket connection to the server using the public socket.io framework ver. 2.2.0. The client also uses a specific namespace in the socket named “/zSocket”. The\nwebsocket connection is based on the current http(s) connection – so a long as the http connection to the server is encrypted so is the websocket.\n\nOnce connected, the client sends every 5 seconds a “heartbeat” message, which contains the projId and the browser information collected by Jetriz. Because websockets are asynchronous the client\ndoesn’t have to wait for any response and can send a message while still handling the other.\n\nPlugin Loading\n\nThe main client message callback is “task”. A “task” message contains a plugin that the plugin manager should run. Each task contains:\n\npluginId – 24 characters long hex string\ndata – javascript code of the plugin\npluginType – always 0\nrun – always empty\n\nInterestingly, “data” is run immediately when getting a new task. it does not run the plugin itself but rather returns a function which is called to run the plugin. The function is called with 3 parameters –\nThe plugin managers’ context, the “run” argument and a dictionary containing the pluginId and pluginType.\n\n“task” message parsing and running\n\nPlugin API\n\nThe plugin managers create a dictionary of 29 functions to be used by the plugins easily by referencing the plugin managers’ context. Many of the functions are not used by any of the plugins I found.\nPlease See Appendix C for the complete function list.\n\nMoreover, the manager enables the different plugins to use a unified way to send information back to the server. By calling the “callback” function the plugins can send back the data they collected to the\nserver. The callback message contains 6 fields:\n\n1. userSocketId (internal ID of socket.io, doesn’t work in version 2.2.0)\n2. data – response data\n3. msg – always empty\n4. status – always true\n\n\n-----\n\n5. type – type of data, “string” (for json) or “object”\n6. save – always true\n\n### Plugins\n\nOnce the server gets the first heartbeat, it sends between 11 to 15 different plugins at once.\n\nThe plugins are generally much lighter obfuscated but the degree of obfuscation varies. All plugin have the same class creation mechanism. This plugin class has always at least 2 functions: “run” which\nruns the main logic of the plugin and “callback” or “report” which, well, report back to the server. The numbering of the plugins was done by me randomly, and doesn’t have to do with the order of arrival\n(which wasn’t consistent since the protocol is asynchronous).\n\nPlugins 0-7\n\n[These plugins use a known but not a widely used technique called JSONP-hijacking. The technique enables exfiltrating the logged-in user account information from vulnerable sites. While it doesn’t give](http://capec.mitre.org/data/definitions/111.html)\nthe attacker a password or any authentication token, it enables him to identify the victims and to assess his interest in them.\n\nThe Implementation is quite easy – the attacker needs to load the relevant JSONP address as a script ($.getScript()) and to set the name of the callback function inside the url of the JSONP. The callback\nfunction will be called once the JSONP is loaded and will get as argument the user data.\n\nPlugin 0 gathers information from 58 different sites. 57 of those sites are very popular Chinese sites, like qq and baidu. There are approximately 30 different attributes the attacker tries to exfiltrate,\nwhich differ from site to site. The common attributes are userid, real name and phone number. A complete list of the sites and attributes is available in APPENDIX C.\n\nNYT JSONP callback function\n\nA site that stands out is the New York Times. The JSONP vulnerability in the site enables the attacker to get the user id and the name of the logged-in reader.\n\nI reported the vulnerability to the NYT via a 3rd party platform. while I am unable share their response as per their code of conduct, I will say the plugin’s effectiveness remains the same.\n\nPlugins 1-7 are used to exfiltrate user data specifically from one specific website each, using the same technique. While all the domains in those plugins appear and are already queried in plugin 0, the\nplugins use more complicated techniques and site-specific vulnerabilities to access more comprehensive user data.\nThe sites queried by the plugins are:\n\nP1 – 163.com basic user info query\nP2 – employer.58.com – get “enterpriseinfo“\nP3 – jd.com JSONP request embedded in iframe\nP4 – sohu.com JSONP request embedded in iframe\nP5 – **_hupu.com JSONP request embedded in iframe_**\n\n\n-----\n\nP6 – qq.com – JSONP exploiting music access API of qq that leaks comprehensive user data.\nP7 – baidu.com – complicated JSONP request utilizing a vulnerability enabling the attacker to run code in the context of the iframe. The plugin had also additional obfuscation (possibly because\nit used a newer version of the obfuscator).\n\nPlugin 8\n\nThe plugin collects geolocation data. The collection happens through regular browser query, so the accuracy can vary depending on the type of network access and whether the device has GPS. The\nbrowser gives some value representing accuracy.\nIt is worth noting that this plugin would cause the browser to request permission from the victim unless the victim has granted the waterholed website that permission before.\n\nPlugin 9\n\nThe plugin gets the internal IP(s) of the victim through the use of WebRTC api.\n\nPlugin 10\n\nThe plugin attempts to take one photo of the victim using the webcam of the device, if present. Similarly to plugin 8, this could make the browser request permission from the victim.\n\nPlugin 11\n\nThe plugin uses the public javascript library fingerprint2. The result, excluding pixel ration, memory information and devices information is hashed and sent back to the server. Additionally, it loads\nicons of 11 Chinese security research sites, the purpose of that is unclear.\n\nPlugin 12\n\nThe plugin is used to capture anything the user types in the waterholed domain.\nThe plugin does that by registering a callback on any <input> and <textarea> tags in the document and reports their textual data back to the server.\n\nPlugin 13\n\nThe plugin checks if the victim is using TOR by trying to access a favicon with an onion address. It is worth mentioning that on a victim not running TOR this could trigger a DNS request to an onion\naddress (see detection).\n\nPlugin 14\n\n\n-----\n\nThe plugin tries to connect to websockets at localhost. If the connection succeeds all data transferred through the socket is forwarded to the attackers’ server. This known but relatively new technique\n[allows Tetris to exfiltrate developer information and even API secrets. This article is an excellent explanation of the technique.](https://hackernoon.com/how-to-steal-secrets-from-developers-using-websockets-dw3p3zgk)\nThe Following table shows the ports tried by the plugin and their default use:\n\nPort Service\n\n3000 webpack-dev server, core component in React.js development\n\n3001 socket.io secure websocket common port\n\n7000 [Used in eventletexamples, Default in RSocket – binary protocol able to run on WS](http://eventlet.net/doc/examples.html)\n\n8000 Used in many examples, likely to be used by several frameworks\n\n9856 [reload (node module)](https://www.npmjs.com/package/reload)\n\nPlugin 15\n\nThe plugin collects very comprehensive OS information, including battery status, ad blocker status, hardware concurrency support and browser plugins. Additionally, it requests the localstorage for the\ncurrent site.\n\n## Additional Attack chains\n\n### Discovery\n\nThe two links used in the waterholed sites were very similar: /s/02Bl & /s/02Bn. This prompted me to try similar combinations. Through this basic approach I was able to find 7 additional redirection\nURIs:\n\n**original URI** **Redirected path**\n\n/s/02Bi /public/jquery.min.js?ver=607fd694d0dfb600379f3bb9\n\n/s/02Bj /public/jquery.min.js?ver=6085111875349500318504f6\n\n/s/02Bk /public/x/jquery.min.js?ver=6085111875349500318504f6\n\n/s/02Bl /public/jquery.min.js?ver=60851543c3baea002ff24ff4\n\n/s/02Bm /public/x/jquery.min.js?ver=60851543c3baea002ff24ff4\n\n/s/02Bn /public/jquery.min.js?ver=60878220c25fbf0035f9876c\n\n/s/02Bo /public/x/jquery.min.js?ver=60878220c25fbf0035f9876c\n\n/s/02Bp public/jquery.min.js?ver=609351de045c15003a22361c\n\n/s/02Bq /public/x/jquery.min.js?ver=609351de045c15003a22361c\n\nAs you can see, the redirection links alternate between public/x/jquery and public/jquery, and keep the same projId between them. while all the public/jquery links lead to exactly the same Jetriz script,\nthe public/x/jquery lead to a different script, which I named Jineva.\n\n\n-----\n\n### Jineva\n\nJineva is a weird combination of Jetriz and Swid. Judging by its design, shared code and obfuscation it was developed by the same team. It has 2 main differences:\n\n1. No link hijacking logic\n2. No dynamic Plugin manager, but rather a websocket client with 3 functions.\n\n**Websocket Client**\n\nCommunications\n\nThe Client uses the same socket.io version as Swid. Unlike Swid, its namespace is “/sSocket“.\n\nThe connection request contains 4 parametrs: projId, baseurl (current URL base64 encoded), cookie (document.cookie), isRender (boolean argument, purpose unclear).\n\nOnce connected, the client sends a heartbeat containing the projId every 5 seconds (unlike Swid which also includes device information and language).\n\nFunctionality\n\nThere are 3 functions the server can execute on the client :\n\n– processGET: performs a GET request to a url given by the server using the native JS Fetch call (or the fetchjs polyfill if the native is not available). The response is sent back to the server. The request to\nthe url includes credentials. in this way, the attacker can steal NTLM credentials, cookies and authorization headers of the victim.\n\n– processPOST: Same as processGET but sends a POST fetch request, with parameters set by the server.\n\n– setLS : Gets a dictionary from the server and sets Items in the locastorage according to it.\n\nAdditionally, without regards to server request, the client sends a copy of the localstorage of the current website (window.localStorage) every 5 seconds (independently of the heartbeat)\n\n### Why A Parallel attack chain?\n\nThere are several possible explanations for the use of different chains:\n\n1. Different Targets – Jineva is ideal for exfiltration of data from on-premise web servers and credential stealing, While Jetriz and Swid serve more for surveillance of individuals\n2. Different stages of attack – It is possible the TA uses Jineva as a second stage designed to be used in case it deems Swid’s victim interesting. It is possible that the Jineva link is injected into\n\nsubpages of the watehole so to infect only more “interested users”. Unfortunately I have not found any indication of that in the 2 waterholed sites I know. I think this is less likely that Swid redirects\nto Jineva using the plugins, because Jineva is accessible via a short link, which was used by the TA only for the waterholed sites.\n\nThe use of the same projID for different attack chains is also interesting, as the projID looked at first like a unique ID per waterholed site. I see two possible explanations:\n\n1. The TA has a number conversion system like “1” -> “60851..”, “2” ->”60935″ etc. This hypothesis is strengthened by the fact that the projIDs all start with “60” and move up from “607” to “609”. It\n\ncould explain why the attacker would have the same IDs, as the same ID can mean “2nd Jetriz site” and “2nd Jineva site” depending on the path.\n2. Each time the attacker creates a new wateholed website instance the server automatically creates two links, for Jetriz and Jineva, regardless what the attacker chooses.\n\nBased on these hypotheses, I assess with medium confidence that there are at least 3 more infected domains we don’t know about.\n\n### Infrastructure\n\nI am only aware of one domain used by the group. The domain and the HTTPS certificate were bought in April. The certificate (by “Let’s Encrypt”) was valid only for 3 months from April 20 until Julyth\n19, was not updated and is still the server’s certificate. The attackers used the common “openresty” web server.th\n\n\n-----\n\nWhile it makes sense For a TA to change domains frequently, not taking it down and leaving all scripts there is quite surprising. Moreover, the waterholed websites are not highly visited and thus the\nshort term benefit from the waterhole doesn’t seem substantial.\n\n## Detection & prevention\n\n**Detection**\n\nSOC & Security Researchers\n\n1. In some browsers, plugin 13 would cause a DNS request for an onion address. This can be easily detected if DNS is monitored.\n2. Please See Appendix B for YARA rules.\n\n**Prevention&mitigation**\n\nWeb Users\n\n[1. Noscript is an excellent add-on which would have prevented a user visiting such waterholed site prevent infection. This method comes with its problems, as it can prevent legitimate sites from](https://noscript.net/)\n\nloading correctly.\n2. Visiting less-known or less-trusted sites in incognito mode can mitigate the effect an infection has and the amount of data it can harvest, but would not prevent it.\n3. Using proxy, VPN or TOR can also make it harder for the threat actor to target or identify you, but would not prevent an infection.\n\nWeb Developers\n\n[1. The TA was able to use the waterholed sites only because their Access-control list was set to “*”. Changing that setting and verifying it periodically would prevent that. This is a great resource](https://enable-cors.org/server.html)\n\ncontaining explanations about it.\n\n## Attribution\n\nI asses with high confidence that the TA is working on behalf of the Chinese government. This assessment is based on several reasons:\n\n1. Victimology – Based on the type of waterholed websites and the fact that the attackers search for Chinese keyboard it is reasonable that the TA is interested in Chinese opposition movements,\n\nactivists and supporters. Naturally, this interest is almost exclusive to China.\n2. Language – There are several occurrences of short sentences written in Chinese in the plugins. While this could be a false flag, its presence specifically in the plugins, where there is also no\n\ncomplicated obfuscation, raises doubts about that, as it looks like the TA did not foresee any researcher accessing these scripts. Moreover, there are several places with bad English – sometimes in a\nway that is unlikely to be intentional – instead of accessing the “dependencies” folder, the server has a “dependence” folder. More similar errors are seen in the plugins.\n[3. Similarity – plugin 0 used by the TA has a strong resemblance to a report published by AlienVault in 2015 . While the report doesn’t include samples, the use of wide JSONP-hijacking against a](https://cybersecurity.att.com/blogs/labs-research/watering-holes-exploiting-jsonp-hijacking-to-track-users-in-china)\n\nsubset of the Chinese sites used in plugin 0 hints at some connection between both operations. The report attributes this attack to china.\n\n## Conclusion\n\nAn Analysis and comparison of the different techniques used by the actor lead to 3 interesting conclusions:\n\n1. Separation between teams – Some parts of the attack chain are done quite professionally – several stages, obfuscation anti-debugging, generic URL path with a unique GET argument and a\n\nmodular plugin manager. Other parts seem to be done unprofessionally – “dependece” path, huge dead code, invalid certificate, the sending of 15 plugins at once, plugins that cause permission\nrequests from the user and redirection links that enable brute forcing. I believe these inconsistencies show us that there is a strong separation between the team developing the code infrastructure\n(Jetriz and Swid) and the team operating the specific server and writing some of the plugins..\n2. Experience with public discoveries – The obfuscation used by the TA, randomization of some paths and multi-stage design hint that the TA had several encounters with AV detections or\n\npublications in the past. It is possible that the TA learnt from mistakes of colleagues or reports by the cybersecurity industry alone.\n\n\n-----\n\n3. Type of use – It is unclear why the TA chose to keep the server running with an invalid certificate. I see 2 possible explanations:\n\n_a) The TA had been denied access by the cloud provider but the provider didn’t care to take down its server._\n_b) This specific campaign wasn’t effective and thus the team didn’t actively continue it. They did not take down the server because they either did not care for the code to be found (because it was_\nwritten by another team, or didn’t see this as a risk), or that they thought that it still could have some value in the future.\n\n## Summary\n\nTetris accomplishes to take the most out of the browser sandbox, and illustrates its almost inherent vulnerability. As browser implement more and more capabilities, which were reserved for executables,\nIt’s likely we will see more similar frameworks.\n\nA state spying on its citizens and dissidents is not new – for some states that is even their top priority. Still, the amount of such cyber-espionage campaigns published is relatively low. From lack of\ntelemetry, to the nonexistent incentive of most of the private and public sector to prevent it, many campaigns remain hidden and serve as a powerful tool for authoritarian governments.\n\nThis research is based alone on the finding of the two waterholed sites by Felix.. There are still several open questions: How widespread are infections? Are there more sophisticated plugins? Does the\nactor utilize a sanbdox-escape exploit at some point? What are the other waterholed sites?\n\nI believe that by collaboration we can answer some of these questions. As cybersecurity experts, we have the ability to contribute to those who do not have the privilege to live in a democratic and liberal\nstate, and providing them with a little more freedom.\n\nYou are welcome contact me if you have any new finding or questions regarding Tetris.\n\n## Appendix A – Mitre ATT&CK® Techniques\n\n### Matrix\n\n\n-----\n\n[The Techniques are also available as JSON and Excel in my git repository.](https://github.com/imp0rtp3/Research/tree/master/2021-08-12%20Tetris)\n\n## Notable Techniques\n\n**Hide Atrifacts (T1564)**\n**Network Service Scanning (T1046) – plugin 14 Tries to connect to 5 different ports of the host to discover services and exfiltrate their traffiic.**\n**Software Discovery (T1518) – Plugin 15 discovers browser plugins and adblockers installed by the user.**\n**System Network Configuration Discovery (T1016) – Plugin 13 checks whether the system is configured to connect through TOR, Plugin 9 discovers the internal IP.**\n**Data From local System (T1005) – Plugin 15 exfiltrates localstorage and cookies of the waterholed website from the browser.**\n\n## Appendix B – Detection\n\n### Yara Rules\n\n\n-----\n\n[Rule detecting Tetris components.](https://github.com/imp0rtp3/yara-rules/blob/main/2021-08-12%20Tetris/tetris.yar)\n[Rule detecting the fingerprint2 library – can be used for legitimate purposes.](https://github.com/imp0rtp3/yara-rules/blob/main/2021-08-12%20Tetris/fingerprint2.yar)\n\nAs written before, I have more comprehensive and sophisticated rules which I will be happy to send upon request under TLP:green restriction, both for commercial and non-commercial use. The reason I\ndo not publish them is that their effectiveness will diminish drastically once known to the TA. Although I do prefer to give everyone access, that would not serve the purpose of detecting and preventing\nthe TA as long as possible.\n\n### IOCs\n\ngoogledrivers[.]com\n\n45.77.103[.]201\n\n**Samples & Hashes**\n\n[The hashes of the various components of the framework all depend on projId and some on sid, except the plugins. I have uploaded the raw scripts to virustotal and to my repository both the raw and](https://github.com/imp0rtp3/Research/tree/master/2021-08-12%20Tetris/samples)\ndeobfuscated versions of them (with some of my comments and more readable variables).\nI have not uploaded plugins 0-7 to any platform, as I believe their value for more threat actors is bigger than their value for security researchers.\n\nAny company that was targeted by the plugins can contact me directly and once verified I would send the relevant code used to exploit their site.\n\nVirusTotal Links\n\n[Jetriz](https://www.virustotal.com/gui/file/bfcd10ca12d04cb1cc14e7a7a1c1a040faea6e22a914a1a3386d77f2bf97b755/detection)\n[Swid](https://www.virustotal.com/gui/file/a43ecad9d65ac298e1409d75ed6414f90c1543850002997aedf6e4e78cbeedcc/detection)\n[Jeniva](https://www.virustotal.com/gui/file/bfcd10ca12d04cb1cc14e7a7a1c1a040faea6e22a914a1a3386d77f2bf97b755/detection)\n\nPlugins Hashes\n\n0e10230dacf24c762c5b931fbb9d7f810b3761cacc06823b0422338f818235b4 – plugin 0\n22a36d03806d4db34654aba285585e1a76459cd41e3c109a9f24738533710634 – plugin 1\nced981f8f9b321949d880df65142d7a6931ed862b02b72ffe36b1ebed4c848a2 – plugin 2\n1491de46915a6781a3fe82b371d3236a616d89da213f77e2d07c780ca7e65da5 – plugin 3\nd1b87b6de14091a70291e04541ecb07a0b6ca4cb848cb8906fcf6059a0ae15e4 – plugin 4\n6ea2189452b9fcb072bd2d09c9a03ba3c43118382b5687c010783defc27f4b62 – plugin 5\ncd2795f34c37ff5b7dac60e8f618631bdf14f88d017f0073eb8133068e21d150 – plugin 6\n78a0b96ca39944a04a7981a13cff76a9f9a3bc285f347ebeae1274c128358ea7 – plugin 7\nb1b50a18e8a166f47416a73a5e19351ea042bf2c7fb4e3088a5e457d7b8ff05b – plugin 8\nf3ab3203289c30e4e137f73696ab46d7434769c6965583d69b8b297845f9aefc – plugin 9\n8b623691edc5ba724405acac4e2f446c977670dca4488b6526852101dca76e52 – plugin 10\n4dfa39a06ea81d0a80df2002c643ae07f1bb8a4c608133741d972589a9f874f0 – plugin 11\ncae143b302ce23c361bc6cb0ff612ad44cb47e1d15fadc64991d3cec89e42892 – plugin 12\n46e47db6175296c2768d13779173684d742a702caa7e71d7bb998f5ef1f29467 – plugin 13\nc7653aa63e5c1723c4bd63b7a78f2219e84495502c97313b287f95877064df96 – plugin 14\n88f45be2b5117e8d554261e31e02c0e5812c87cfa664472fd43558c3f5603258 – plugin 15\n\nURIs\n\n/public/jquery.min.js?ver=607fd694d0dfb600379f3bb9\n/public/jquery.min.js?ver=6085111875349500318504f6\n\n\n-----\n\n/public/jquery.min.js?ver=60878220c25fbf0035f9876c\n/public/jquery.min.js?ver=609351de045c15003a22361c\n/public/jquery.min.js?ver=60851543c3baea002ff24ff4\n/public/x/jquery.min.js?ver=6085111875349500318504f6\n/public/x/jquery.min.js?ver=60851543c3baea002ff24ff4\n/public/x/jquery.min.js?ver=60878220c25fbf0035f9876c\n/public/x/jquery.min.js?ver=609351de045c15003a22361c\n/s/02Bi\n/s/02Bj\n/s/02Bk\n/s/02Bl\n/s/02Bm\n/s/02Bn\n/s/02Bo\n/s/02Bp\n/s/02Bq\n/zSocket\n/sSocket\n/public/dependence/jquery/3.1.1/jquery.min.js\n/public/dependence/fingerprint2.min.js\n/public/dependence/jquery/1.12.4/jquery.min.js\n\n## Appendix C – Plugins\n\n### Plugins API calls\n\n_addIEMeta – Add an Internet Explorer Compatible Meta tag._\n**_addNoRefererMeta – Set any page request or redirection to be without Referer._**\n_ajaxPromise – Perform basic Ajax request._\n_base64Decode – Decode buffer from base64 to string._\n**_base64Encode – Encode buffer to base64._**\n**_createElement – Create a DOM element in the <body> of a document of the attackers choosing._**\n**_createHiddenElement – Create element with no visibility and 0 dimensions._**\n_crossOriginJsonp – See noRefererJsonp._\n**_debounce – Common function used in JS to prevent fast numerous repetitious running of same function._**\n_SwidIframe – Create an Iframe with the dimensions of the windows, overshadowing any other element_\n_getHighestZindex – Get highest Z-Index in the document, used to calculate how to create an element in the foreground._\n_getLang – Get browser language the function distinguishes between two “types” of Chinese – mainland Chinese and Hong Kong, Taiwan or Mongol Chinese_\n_hasJquery – Check whether window has jquery with Minor version above 8. (Maybe used when older jquery ver. 1 were used by the TA)._\n**_hiddenIframe – Create invisible iframe with zero dimensions._**\n**_hiddenImg – Create invisible img with zero dimensions._**\n**_iframe – Create an iframe element with attacker controlled parameters._**\n**_img – Create an img element with attacker controlled parameters. if projId is not present in the img URL the function appends it as ?ver=<projId>._**\n_ipec – See xsrf._\n_isIE – Check for ActiveXObject in the windows_\n\n\n-----\n\n_loadCSS – Load a css file._\n**_loadJS – Load a JS file._**\n**_noRefererJsonp – Create hiddenIframe and loads a script URl in it. crossOriginJsonp does the same except it sets the iframe‘s referrerPolicy as ‘origin‘._**\n**_random – Return random number._**\n_removeCSS – Remove all CSS from windows._\n_rewriteLink – Rewrite all links in the document to a URL of the attackers’ choosing._\n_scriptViaIframe – Embed a script in a an Iframe of the attackers’ choosing. if projId is not present in the img URL the function appends it as ?ver=<projId>._\n_scriptViaWindow – Same as scriptViaIframe but the script is embedded in a windows of the attackers choosing._\n_xsrf – Perform a CSRF\\XSRF attack by submitting an invisible form with attacker controlled parameters. ipec does the same except it uses textarea instead of input and works only with POST_\nrequests.\n\n*Calls in bold are used directly or indirectly by the plugins I know.\n\n### JSONP-vulnerable Sites Accessed by Plugin 0\n\nSites in bold are also queried by Plugin 1-7.\n\n\n-----\n\nDomain Attributes Global Alexa Rank Chinese Rank\n\ntmall.com isLogin 3 1\n\n**qq.com** userId,nickName,headURL,userHome 4 2\n\nbaidu.com userId,userName 5 3\n\n**sohu.com** nickName,headURL,userHome,profile,userName 6 4\n\ntaobao.com isLogin 8 5\n\n**jd.com** userName,headURL 10 7\n\nweibo.com userId 14 8\n\ntianya.cn userName 42 17\n\naliexpress.com isLogin 44 –\n\ngome.com.cn userId,nickName,headURL 89 26\n\n163.com nickName,headURL 97 27\n\nnytimes.com uid,name 113 –\n\nzol.com.cn userId 310 50\n\niqiyi.com userinfo,qiyi_vip_info 390 53\n\noutbrain.com userName 419 –\n\n**58.com** userName,userId,phone 468 58\n\nzhibo8.cc userId,nickName,background,headURL 482 69\n\ndianping.com userId,nickName 619 93\n\nrenren.com userId,nickName,userName,headURL,birth 696 94\n\nyouku.com userId,userName,sex,headURL 710 104\n\ndangdang.com ddoy,loginTime 799 109\n\nanjuke.com userId,userName,lastUser,profileURL 844 119\n\nsmzdm.com userId,nickName,headURL 1489 207\n\nifeng.com isLogin,isLogin 1607 218\n\n7k7k.com userId,userName,nickName,headURL,level 1902 216\n\nzhaopin.com userName 2587 289\n\n4399.com isLogin,gameInfos 2764 254\n\n\n-----\n\nctrip.com userName,level 3185 346\n\n10086.cn userName 4047 383\n\n**hupu.com** userId,userName 4440 543\n\nvip.com level,lastLogin 6074 1519\n\npconline.com.cn userId,nickName 7303 773\n\nxunlei.com nickName,payName,userName 8680 2126\n\nxcar.com.cn headURL,userName,userName 10868 1157\n\nqunar.com isLogin 11185 1708\n\npcauto.com.cn userId 11410 2117\n\njumei.com nickName,userId 14264 1726\n\n37.com userName,lastLoginIP,lastLoginTime 14905 1548\n\nhexun.com userId,userName,headURL,sex 20653 2480\n\nsuning.com phone,headURL,level 28883 2845\n\nlu.com userId,sex,realName,userName,mobile 29184 2985\n\ntiexue.net userId,userName 31430 3235\n\nbaihe.com userId,nickName,gender,age,headURL,cityID 36791 –\n\nbbs.360safe.com userName,userId,email,adminId,lastVisit,group 39660 –\n\nqyer.com username,userid 43347 –\n\n56.com userHome 48982 –\n\nzongheng.com level,headURL 59346 –\n\nziroom.com userName 74364 3702\n\nbitauto.com userId,userName 84849 –\n\nchinaiiss.com userName 119808 –\n\n2144.cn userId,userName,nickName 199953 –\n\nyhd.com userName,headURL 343737 –\n\nletv.com userId 671069 –\n\nreadnovel.com userName,headURL 1167917 –\n\nduoshuo.com userId,userName,userHome,headURL,social_uid,email – –\n\n\n-----\n\naliyun.com userId – –\n\nhuihui.com uid,userName – –\n\ndaijun.com userName – –\n\n### Icons loaded by plugin 11\n\nhttps[:]//www.seebug[.]org/static/images/favicon.ico\nhttps[:]//www.vulbox[.]com/static/web/img/favicon.ico\nhttps[:]//www.secfree[.]com/favicon.ico\nhttps[:]//www.secpulse[.]com/favicon.ico\nhttps[:]//zhongce.360[.]cn/favicon.ico\nhttps[:]//bbs.ichunqiu[.]com/favicon.ico\nhttps[:]//www.cnvd.org[.]cn/favicon.ico\nhttp[:]//cnnvd.org[.]cn/favicon.ico\nhttps[:]//xz.aliyun[.]com/static/icon/favicon.ico\nhttps[:]//www.t00ls.net/favicon.ico\nhttps[:]//bbs.pediy[.]com/view/img/favicon.ico\nhttps[:]//www.freebuf[.]com/favicon.ico\nhttps[:]//www.zoomeye[.]org/favicon.ico\nhttps[:]//fofa[.]so/favicon.ico\n\n### TOR URL Accessed by Plugin 13\n\nhttp[:]//bn6kma5cpxill4pe[.]onion/static/images/tor-logo1x.png – Legitimate official TOR browser website for onion v2 (Deprecated).\n\n## APPENDIX D — Deobfuscation\n\nEach obfuscated script starts with setting an array which consists of base64 encoded strings. The array is then rotated. Next, a string access function is initialized, which serves throughout the script for\nany string used.\n\n[I wrote a python script to automatically deobfuscate scripts obfuscated in that way.](https://github.com/imp0rtp3/Research/blob/master/2021-08-12%20Tetris/deobfuscate.py)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2021/2021.08.12.Full-Surveillance-Kit-China/Uncovering%20Tetris%20%E2%80%93%20a%20Full%20Surveillance%20Kit%20Running%20in%20your%20Browser%20%E2%80%93%20imp0rtp3.pdf"
    ],
    "report_names": [
        "Uncovering Tetris – a Full Surveillance Kit Running in your Browser – imp0rtp3"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "c39b0fe6-5642-4717-9a05-9e94265e3e3a",
            "created_at": "2022-10-25T16:07:24.332084Z",
            "updated_at": "2025-03-27T02:02:10.175452Z",
            "deleted_at": null,
            "main_name": "Tonto Team",
            "aliases": [
                "Bronze Huntley",
                "CactusPete",
                "Earth Akhlut",
                "HartBeat",
                "Karma Panda",
                "LoneRanger",
                "Operation Bitter Biscuit",
                "TAG-74",
                "Tonto Team"
            ],
            "source_name": "ETDA:Tonto Team",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Bioazih",
                "Bisonal",
                "CONIME",
                "Dexbia",
                "Korlia",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "POISONPLUG.SHADOW",
                "RoyalRoad",
                "ShadowPad Winnti",
                "XShellGhost"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716492,
    "ts_updated_at": 1743041154,
    "ts_creation_date": 1629089634,
    "ts_modification_date": 1629089634,
    "files": {
        "pdf": "https://archive.orkl.eu/cd1679b297d1649491047771ba3a048192e577c7.pdf",
        "text": "https://archive.orkl.eu/cd1679b297d1649491047771ba3a048192e577c7.txt",
        "img": "https://archive.orkl.eu/cd1679b297d1649491047771ba3a048192e577c7.jpg"
    }
}