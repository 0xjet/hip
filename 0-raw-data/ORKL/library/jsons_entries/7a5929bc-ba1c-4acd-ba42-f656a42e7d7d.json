{
    "id": "7a5929bc-ba1c-4acd-ba42-f656a42e7d7d",
    "created_at": "2023-01-12T15:06:59.647778Z",
    "updated_at": "2025-03-27T02:16:50.918904Z",
    "deleted_at": null,
    "sha1_hash": "0f214d8fea349c4fab869a6798abd6a767e037a7",
    "title": "2015-10-09 - Beta Bot Analysis- Part 1",
    "authors": "",
    "file_creation_date": "2022-05-28T00:37:37Z",
    "file_modification_date": "2022-05-28T00:37:37Z",
    "file_size": 689900,
    "plain_text": "# Beta Bot Analysis: Part 2\n\n**[resources.infosecinstitute.com/beta-bot-analysis-part-1/](http://resources.infosecinstitute.com/beta-bot-analysis-part-1/#gref)**\n\nMalware analysis\nOctober 1, 2015 by Ayoub Faouzi\n\n## Extracting the Botnet Configuration:\n\nThe bot configuration is encrypted inside the bot and decrypted while the bot is running. In\n1.0.2.5, 1.5 and 1.6 versions, BetaBot uses RC4 and some XOR encryption; you can easily\nlocate the encrypted configuration by looking at the magic 0x0D46 which if the start of the\nconfiguration header. However, in version 1.7, BetaBot uses another layer of encryption\nlocated at VA 004476F3.\n\nSecond layer of encryption:\n\n\n-----\n\nNotice that the host is still not fully de-obfuscated:\n\n\n-----\n\nThen, after tracing over this routine, CnC found: notchangeme.su/luck/order.php\n\n## Process Creation\n\nBetabot attempts to launch explorer.exe and if that fails it uses wuaudclt.exe. For this\nwalkthrough, Explorer.exe is used. The process is launched by making a direct call to\nCreateProcessInteralW.\n\n\n-----\n\n## AV-Checks:\n\nBetaBot check for the following anti-virus programs and disables them if found from the\nregistry key, leaving computers vulnerable to compromise and without receiving AV updates.\n\n## Parsing Commands:\n\n**int**\n**__cdecl**\n**Parse_Commands()**\n\n{\n\n**const WCHAR *szCommandline; // esi@1**\n\n**int dwCommandLen; // edi@2**\n\nLPWSTR *argv; // eax@3\n\n\n-----\n\n**int v3; // edi@6**\n\n**const WCHAR *v4; // esi@7**\n\n**int v5; // eax@12**\n\n**int v6; // eax@27**\n\n**int v7; // eax@37**\n\n**char v9; // [sp+0h] [bp-458h]@0**\n\n**const WCHAR szCommand[522]; // [sp+10h] [bp-448h]@1**\n\n**char v11; // [sp+424h] [bp-34h]@15**\n\n**char v12; // [sp+438h] [bp-20h]@44**\n\n**int v13; // [sp+44Ch] [bp-Ch]@6**\n\n**int v14; // [sp+450h] [bp-8h]@5**\n\n**int iNumArgs; // [sp+454h] [bp-4h]@1**\n\n_// BetaBot Parsing Commands_\n\nszCommandline = GetCommandLineW();\n\niNumArgs =\n\n0;\n\nmemset(szCommand, 0, 1040);\n\n\n-----\n\n**if ( szCommandline )**\n\n{\n\ndwCommandLen = wcslen((int)szCommandline);\n\n**if ( (unsigned**\n**int**\n\n)dwCommandLen >=\n\n3 )\n\n{\n\nlstrcpynW((LPWSTR)szCommand, szCommandline, 519);\n\nCharLowerBuffW((LPWSTR)szCommand, dwCommandLen);\n\nargv = CommandLineToArgvW(szCommand, &iNumArgs);\n\n**if ( iNumArgs >**\n\n0 )\n\n{\n\n**if ( argv )**\n\n{\n\nv14 =\n\n0;\n\n**if ( iNumArgs >**\n\n0 )\n\n{\n\nv3 = (int\n\n\n-----\n\n)(argv +\n\n1);\n\nv13 = (int\n\n)(argv +\n\n1);\n\n**do**\n\n{\n\nv4 = (const WCHAR *)(*(_DWORD *)(v3 –\n\n4\n\n) +\n\n2);\n\n**if ( lstrcmpiW((LPCWSTR)(*(_DWORD *)(v3 –**\n4) +\n2), L”cp”) )\n\n{\n\n**if ( lstrcmpiW(v4, L”testme”) )**\n\n{\n\n**if ( lstrcmpiW(v4, L”ssp”) )**\n\n{\n\n**if ( lstrcmpiW(v4, L”suac”) )**\n\n{\n\n**if ( lstrcmpiW(v4, L”uac”) && lstrcmpiW(v4, L”puac”) )**\n\n\n-----\n\n{\n\n**if ( lstrcmpiW(v4, L”nuac”) )**\n\n{\n\n**if ( lstrcmpiW(v4, L”ron”) )**\n\n{\n\n**if ( lstrcmpiW(v4, L”task”) && lstrcmpiW(v4, L”un”) && lstrcmpiW(v4, L”dbg”) )**\n\n{\n\n**if ( lstrcmpiW(v4, L”ins”) )**\n\n{\n\n**if ( lstrcmpiW(v4, L”ext”) )**\n\n{\n\n**if ( !lstrcmpiW(v4, L”upd”) )**\n\n***(_DWORD *)(large_buffer +**\n10) |=\n0x1000u;\n\n}\n\n**else**\n\n{\n\nExitProcess(0);\n\n**else**\n\n\n-----\n\n{\n\nv6 =\n***(_DWORD *)(large_buffer +**\n10);\n\n**if ( !(v6 &**\n\n4) )\n\n***(_DWORD *)(large_buffer +**\n10\n\n) = v6 |\n\n4;\n\n**else**\n\n{\n\n***(_DWORD *)(large_buffer +**\n10) |=\n0x100u;\n\n}\n\n**goto LABEL_49;**\n\n}\n\n**if ( *(_BYTE *)(large_buffer +**\n10) &\n0x20 )\n\n{\n\nsub_40DFDA(0, 0);\n\nSleep(0x64u);\n\n\n-----\n\nsub_423C88();\n\nsub_407EF8();\n\nSleep(0x384u);\n\n**else**\n\n{\n\n**if ( *(_BYTE *)(large_buffer +**\n10) &\n0x20 )\n\n{\n\nsub_40DFDA(0, 0);\n\n**if ( iNumArgs >= v14 +**\n1\n**&&**\n****(_WORD **)v3 )**\n\nlstrcpynW((LPWSTR)&unk_43EC98, *(LPCWSTR *)v3, 259);\n\nsub_407FD8(0);\n\nv7 =\n***(_DWORD *)(large_buffer +**\n18);\n\n**if ( v7 &**\n0x200\n\n**|| v7 &**\n\n2 )\n\nZwTerminateProcess(–1, 0);\n\nSleep(0xC8u);\n\n\n-----\n\n**if ( lstrcmpiW(v4, L”puac”) )**\n\nsub_423C88();\n\n**else**\n\nsub_423BFE(large_buffer +\n5702, 1);\n\n**if ( !(*(_BYTE *)(large_buffer +**\n18\n\n) &\n\n1) )\n\n{\n\nsub_407EF8();\n\nsub_407C19(&v12);\n\n}\n\n**if ( sub_403145(off_438A40, “LSF”) &**\n0x400 )\n\nsub_40494B();\n\nsub_4079DF();\n\nv3 = v13;\n\n**else**\n\n{\n\nsub_40DFDA(0, 0);\n\nSleep(0xFA0u);\n\nsub_407FD8(0);\n\n\n-----\n\nv5 =\n***(_DWORD *)(large_buffer +**\n18);\n\n**if ( v5 &**\n0x200\n\n**|| v5 &**\n\n2 )\n\nZwTerminateProcess(–1, 0);\n\nsub_407EF8();\n\nsub_407C19(&v11);\n\n}\n\nZwTerminateProcess(–1, 0);\n\n**else**\n\n{\n\nPathFindFileNameW((LPCWSTR)(large_buffer +\n5054));\n\nsub_40227A(L”Works! PID: %d, Name: %s”, dwProcessId);\n\nsub_40227A(L”Betabot (c) 2012-2014, coded by Userbased”, v9);\n\nLABEL_49:\n\n**++v14;**\n\nv3 +=\n\n4;\n\nv13 = v3;\n\n}\n\n\n-----\n\n**while ( v14 < iNumArgs );**\n\n**return**\n\n0;\n\n}\n\n## Dropped Files:\n\nBetaBot takes a copy of the binary that created the initial process from earlier and moves it\nto “C:Program Filescommon files<owner><filename>”.\n\nIn addition, it creates the registry key:\n\n**SOFTWAREMicrosoftWindows NTCurrentVersionImage File Execution**\n**Optionsupiucdlve.exe”)**\n\n## API Hook and Code Injection:\n\nThe malware applies the Ring 3 hook in two ways. First, the malware adds a pre-operation\nfilter for each of the following Zw* APIs:\n\n\n-----\n\nZwCreateFile\n\n\nZwOpenFile\n\nZwDeleteFile\n\nZwSetInformationFile\n\nZwQueryDirectoryFile\n\nZwCreateKey\n\nZwOpenKey\n\nZwSetValueKey\n\nZwOpenProcess\n\nZwTerminateProcess\n\nZwCreateThread\n\n\n-----\n\nZwCreateThreadEx\n\nZwResumeThread\n\nZwSuspendThread\n\nZwSetContextThread\n\nZwOpenThread\n\nZwUnmapViewOfSection\n\nZwDeviceIoControlFile\n\nZwQueueApcThread\n\nThe malware creates a section by calling ZwCreateSection procedure. The purpose of this is\nto create a section (of memory) object and to return a handler. This section object represents\nan area of memory that can be shared. It is accessed through the returned handler. .\n\nThis handler is used to map views of the memory sections using ZwMapViewOfSection\nprocedure. This procedure maps a view of the memory section in a process. This procedure\nis called twice using the same handler. Once is for the current process and once is for the\nremote process (explorer.exe). Now once the memory is mapped it is now possible to\nread/write to that section.\n\nUsing the same section handler allows for simultaneous writing to both sections of memory.\nThis means that writing to the section of memory in the local process will also write to the\nremote process. This avoids the use of functions that raise red flags for anybody that is\nanalyzing the sample.\n\nThe Betabot code is written to the mapped section of memory in the local process, thus\nwriting it to explorer.exe. Of course, this isn’t enough; something needs to be done to have\nthis code executed in the process. To get code execution ntdll.dll is hooked in the\nexplorer.exe process using the same method.\n\n## Conclusion:\n\nThis write-up highlighted some of the methods that BetaBot is using to both obfuscate and\ninject code. It also covered how to extract the configuration details. There is a broad range of\nfunctionality that was not covered (UAC Bypass, Skype stuff, CnC communication, etc.). If\nwe can come back around to this sample, I’d like to highlight those as well.\n\n## Credits and References:\n\nPosted: October 1, 2015\n\n\n-----\n\nAuthor\n\n**Ayoub Faouzi**\n\n**VIEW PROFILE**\nAyoub Faouzi is interested to computer viruses and reverse engineering, In the first hand, he\nlikes to study PE packers and protectors, and write security tools. In the other hand, he\nenjoys coding in python and assembly.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-10-09 - Beta Bot Analysis- Part 1.pdf"
    ],
    "report_names": [
        "2015-10-09 - Beta Bot Analysis- Part 1.pdf"
    ],
    "threat_actors": [
        {
            "id": "e7d03ac8-7d6f-4ea0-83a9-10dff2ea1486",
            "created_at": "2022-10-25T16:07:24.158325Z",
            "updated_at": "2025-03-27T02:02:10.127249Z",
            "deleted_at": null,
            "main_name": "Scarab",
            "aliases": [
                "UAC-0026"
            ],
            "source_name": "ETDA:Scarab",
            "tools": [
                "Scieron"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "adfbe698-24b2-41fc-a701-781fef330b16",
            "created_at": "2024-01-09T02:00:04.17648Z",
            "updated_at": "2025-03-27T02:00:03.274931Z",
            "deleted_at": null,
            "main_name": "GREF",
            "aliases": [],
            "source_name": "MISPGALAXY:GREF",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "0a03e7f0-2f75-4153-9c4f-c46d12d3962e",
            "created_at": "2022-10-25T15:50:23.453824Z",
            "updated_at": "2025-03-27T02:00:55.473216Z",
            "deleted_at": null,
            "main_name": "Ke3chang",
            "aliases": [
                "Ke3chang",
                "APT15",
                "Vixen Panda",
                "GREF",
                "Playful Dragon",
                "RoyalAPT",
                "Nylon Typhoon"
            ],
            "source_name": "MITRE:Ke3chang",
            "tools": [
                "Okrum",
                "Systeminfo",
                "netstat",
                "spwebmember",
                "Mimikatz",
                "Tasklist",
                "MirageFox",
                "Neoichor",
                "ipconfig"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "9099912b-a00a-4afb-8294-c6d35af421a1",
            "created_at": "2023-01-06T13:46:39.338108Z",
            "updated_at": "2025-03-27T02:00:03.054726Z",
            "deleted_at": null,
            "main_name": "Scarab",
            "aliases": [],
            "source_name": "MISPGALAXY:Scarab",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "4c68ccd0-caba-4189-9ead-86ac4c2d9b70",
            "created_at": "2024-05-01T02:03:07.930196Z",
            "updated_at": "2025-03-27T02:05:17.251237Z",
            "deleted_at": null,
            "main_name": "BRONZE ATLAS",
            "aliases": [
                "Axiom",
                "BARIUM ",
                "Blackfly ",
                "CTG-2633",
                "GREF",
                "Group 72 ",
                "Red Kelpie ",
                "TG-2633 ",
                "Wicked Panda ",
                "Winnti",
                "APT41 "
            ],
            "source_name": "Secureworks:BRONZE ATLAS",
            "tools": [
                " CCleaner v5.33 backdoor",
                " ChinaChopper",
                " Cobalt Strike",
                " Dicey MSDN",
                " ForkPlayground",
                " HUC Proxy Malware (Htran)",
                " Mimikatz",
                " PipeMon",
                " PlugX",
                " PortReuse",
                " Powershell Empire",
                " RCMD",
                " RbDoor",
                " SPEEDBOAT",
                " ShadowPad",
                " Sidewalk",
                " Speculoos",
                " TeamViewer",
                " Winnkit",
                " Winnti",
                " reg save",
                " vssadmin",
                "Acehash"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "17b1b76b-16da-4c4f-8b32-f6fede3eda8c",
            "created_at": "2022-10-25T16:07:23.750796Z",
            "updated_at": "2025-03-27T02:02:09.961401Z",
            "deleted_at": null,
            "main_name": "Ke3chang",
            "aliases": [
                "APT 15",
                "BackdoorDiplomacy",
                "Bronze Davenport",
                "Bronze Idlewood",
                "Bronze Palace",
                "CTG-9246",
                "GREF",
                "Ke3chang",
                "Metushy",
                "Nylon Typhoon",
                "Operation Ke3chang",
                "Operation MirageFox",
                "Playful Dragon",
                "Playful Taurus",
                "Red Vulture",
                "Royal APT",
                "Social Network Team",
                "Vixen Panda"
            ],
            "source_name": "ETDA:Ke3chang",
            "tools": [
                "Agentemis",
                "Anserin",
                "BS2005",
                "BleDoor",
                "CarbonSteal",
                "Cobalt Strike",
                "CobaltStrike",
                "DarthPusher",
                "DoubleAgent",
                "EternalBlue",
                "GoldenEagle",
                "Graphican",
                "HenBox",
                "HighNoon",
                "IRAFAU",
                "Ketrican",
                "Ketrum",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "MS Exchange Tool",
                "Mebroot",
                "Mimikatz",
                "MirageFox",
                "NBTscan",
                "Okrum",
                "PluginPhantom",
                "PortQry",
                "ProcDump",
                "PsList",
                "Quarian",
                "RbDoor",
                "RibDoor",
                "Royal DNS",
                "RoyalCli",
                "RoyalDNS",
                "SAMRID",
                "SMBTouch",
                "SilkBean",
                "Sinowal",
                "SpyWaller",
                "Theola",
                "TidePool",
                "Torpig",
                "Turian",
                "Winnti",
                "XSLCmd",
                "cobeacon",
                "nbtscan",
                "netcat",
                "spwebmember"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536019,
    "ts_updated_at": 1743041810,
    "ts_creation_date": 1653698257,
    "ts_modification_date": 1653698257,
    "files": {
        "pdf": "https://archive.orkl.eu/0f214d8fea349c4fab869a6798abd6a767e037a7.pdf",
        "text": "https://archive.orkl.eu/0f214d8fea349c4fab869a6798abd6a767e037a7.txt",
        "img": "https://archive.orkl.eu/0f214d8fea349c4fab869a6798abd6a767e037a7.jpg"
    }
}