{
    "id": "0981c7d7-41c2-4e8f-99fa-8b0f8be0337e",
    "created_at": "2023-01-12T15:06:57.740431Z",
    "updated_at": "2025-03-27T02:14:39.259523Z",
    "deleted_at": null,
    "sha1_hash": "7cdf141a140bc8e4241ed3b117f3ddbfbe059067",
    "title": "2017-04-06 - Diamond Fox – part 2- let’s dive in the code",
    "authors": "",
    "file_creation_date": "2022-05-28T04:56:29Z",
    "file_modification_date": "2022-05-28T04:56:29Z",
    "file_size": 955009,
    "plain_text": "# Diamond Fox – part 2: let’s dive in the code\n\n**[blog.malwarebytes.com/threat-analysis/2017/04/diamond-fox-p2/](https://blog.malwarebytes.com/threat-analysis/2017/04/diamond-fox-p2/)**\n\nMalwarebytes Labs April 6, 2017\n\nIn a [previous post we made an initial analysis of a Diamond Fox bot delivered by the Nebula](https://blog.malwarebytes.com/threat-analysis/2017/03/diamond-fox-p1/)\n[Exploit Kit (more about the campaign can be found here). We described the way to unpack](http://malware-traffic-analysis.net/2017/03/02/index.html)\nthe protection layer in order to get the core, written in Visual Basic, that can be decompiled.\nIn this second part of the series, we will take a deeper look into the code and analyze the\nbot’s features and code design.\n\n## Analyzed samples\n\n[988e9fa903cc2fbb80e7221072fb2221 – Diamond Fox Crystal (final VB payload)](https://www.virustotal.com/en/file/92b449d5932fd42a5040b26e2a849aea3deb04ae0c4e400e6ddf13acd12a94e3/analysis/1489424899/)\n\n[3ef960da3e4bc4bc7c05d02fbf121d4e – old Diamond Fox (final VB payload)](https://virustotal.com/en/file/8e27def9169a918c279ed328b9d93b76d43295023dff9798c1cbb64fd8957b56/analysis/1491043692/)\n\n## Changelog\n\nIn the release that is sold on the black market, the authors included a changelog describing\nall versions up to the current one (codenamed Crystal). Below, you can see the related\nfragment:\n\n\n-----\n\n```\nCrystal Version\n[+] Loader core recoded\n[+] Improved Size: 17.5 kb\n[+] Added unlimited panel list\n[+] Added domain generation algorithm\n[+] Added RunOne startup\n[+] Added Polices startup\n[+] Added auto-screenshots\n[+] added Install redirects\n[+] Added Anti-WinPcap\n[+] Added Anti-Virustotal VM\n[+] Added Anti-Emulation\n[-] Removed Anti-Wine\n[-] Moved Startup Persistance to Persistance\n[+] Added Botkiller\n[+] Added Anti-Avast Sandbox\n[+] Added PE configuration storage\n[+] Improved Configuration preview\n[+] Added optional usb spread on lite bot\n[+] Added RDP plugin\n[+] Added VNC Grabber\n[+] Added remote shell\n[+] Added Close bot command\n[+] Added Shutdown PC command\n[+] Improved web panel installer\n[+] Added Restart PC command\n[+] Added more bot selection options on tasks\n[+] Improved task manager\n[+] Added search on reports\n[+] Improved panel settings\n[+] Added Layer7 DDoS\n[+] Added reports bars statistics\n[+] Added New/dead bots per week statistics\n[+] Updated Geodata\n[+] Added Bot remover tool\n[+] Added DGA tool\n[+] Improved real-time notifications on panel\n[+] Added Desktop/Laptop Detection\n[+] Added administrator detection\n[+] Improved bot full information\n[+] Added mark as favorite\n[-] removed %PROGRAMFILES% installation path\n[+] added %USERPROFILE% installation path\n[-] removed %WINDIR% installation path\n[+] added %LOCALAPPDATA% installation path\n[-] Removed winlogon startup\n[+] Added schtaks startup\n[-] Removed Anti-apateDNS\n[-] Removed Anti-Norman\n[-] Removed Anti-wiresshark\n[-] Removed Xor Encryption\n[+] Added captcha on web panel login\n[+] Added antibruter forcer on web panel login\n[+] Added new panel logo\n[+] Improved Crypto wallet stealer (+24)\n\n```\n\n-----\n\n```\n[+] Improved Homepage changer (added internet explorer)\n[+] Improved Keylogger(added clipboard detector and window title trigger)\n[+] Improved bot speed\n[+] Improved bot compatibility\n[+] Improved bot stability\n[-] Removed Services tab on web panel\n[+] Added protected folder on installation\n[+] Now the webpanel can be installed on windows without errors\n\n## Decompiling\n\n```\nAs we mentioned in the previous post, Diamond Fox is written in Visual Basic and after\nunpacking it can be decompiled by VB Decompiler. Unfortunately, the results of the\ndecompilation are not fully accurate and some parts of the code are difficult to analyze.\nHowever, we can still figure out the most important actions performed by the malware.\n\nWe provided a partially cleaned version of the decompiled code:\n[https://gist.github.com/hasherezade/79de1509c8565ec7496cd554092df6f8#file-module1-vb.](https://gist.github.com/hasherezade/79de1509c8565ec7496cd554092df6f8#file-module1-vb)\n\n## Execution flow\n\nDiamond Fox starts its execution from decrypting and parsing the configuration – in this\nedition, it is stored in the section “L!NK“. Then, depending on the configuration, some further\nfeatures are enabled or disabled. For example, it may deploy defensive checks – against\nsandboxes and Virtual Machines.\n\nThe stored parameters are encrypted and they are decrypted at runtime – however, the\ndecryption function is no longer a simple XOR known from the previous versions:\n\n\n-----\n\n_(see a partially cleaned version of this function:_\n_[https://gist.github.com/hasherezade/79de1509c8565ec7496cd554092df6f8#file-decrypt-vb )](https://gist.github.com/hasherezade/79de1509c8565ec7496cd554092df6f8#file-decrypt-vb)_\n\nAlong with the features that can be enabled or disabled depending on the configuration,\nDiamond Fox offers features that are controlled from the CnC.\n\nReading response from the CnC:\n\n\n-----\n\nParsing commands and executing appropriate actions (commands are identified by numbers\n– from 0 to 25):\n\n## Features\n\nLet’s have a look inside the code and follow the features mentioned by the authors.\n```\n[+] Loader core recoded\n\n```\nThe code of the malware has been reorganized and its big portions have been rewritten. It\ncan be noticed at first sight if we decompile the new version and compare it versus the old\none. In the current version everything is in one module, while in the previous cases the code\nwas subdivided into various modules.\n\nOld Diamond Fox decompiled (fragment):\n\n\n-----\n\nWe can see the code subdivided on modules with descriptive names, making analysis\neasier. In the new version, we will not find this familiar layout.\n\nDecompiled code of Diamond Fox Crystal (the new one):\n\nThe new version introduced a different way of storing the configuration. Now, the encrypted\nconfiguration is in the dedicated section named “L!NK“.\n```\n[+] Added domain generation algorithm\n\n```\nIn the analyzed sample this feature was not enabled and the CnC address was static.\nHowever, looking at the code we can find a domain generation algorithm (DGA) is based on\nthe current date:\n\n\n-----\n\n_(see a partially cleaned version of this function:_\n_https://gist.github.com/hasherezade/79de1509c8565ec7496cd554092df6f8#file-_\n_domain_generate-vb)_\n```\n[+] Added Anti-Emulation\n\n```\nChecking if the sample is not running in a VM or sandbox by attempting to load DLLs\nassociated with the virtual environment:\n\nvboxmrxnp\nSbieDll\nsnxhk\npthreadVC\n\nIt comes also with a set of blacklisted volume serial numbers, identifying popular sandboxes:\n\nAC79B241\n70144646\n6C78A9C3\n```\n[+] Added Desktop/Laptop Detection\n\n```\nChecking if it is running on the laptop by testing battery presence:\n\n\n-----\n\n```\n[+] Added PE configuration storage\n\n```\nThe section L!NK is used not only to store initial configuration, but also some fetched data.\n\nThe random ID of the bot is generated and stored:\n```\n[+] Improved Crypto wallet stealer (+24)\n\n```\n\n-----\n\nWe can find in the code strings used to search several crypto wallets:\n```\nMultiBit, Armory, Electrum, digital, -LTC, MultiDoge, BitcoinDark, \nUnobtanium, Dash, Bit, Lite, Name, PP, Feather, Nova, Prime, Terra, \nDev, Anon, Pay, World, Quark, Infinite, Doge, Asic, Lotto, Dark, Mona\n\n```\nAnalyzing the code deeper, we find that first the .wallet files are searched:\n\nThe found data is grabbed and passed into another function:\n\n\n-----\n\nThat function is responsible for posting the grabbed content to the CnC server:\n```\n[+] Added captcha on web panel login\n\n```\nWe can observe it if we try to follow the address of the CnC captured during the behavioral\nanalysis. Indeed, near to the credential fields we can see a very simple captcha:\n\n\n-----\n\n```\n[+] Added new panel logo\n\n```\nThe authors of Diamond Fox put a lot of effort to make a graphic design attractive for the\nuser. This time, the panel comes with a set of logos that are randomly changing on page\nrefresh. This feature may seem fancy and redundant in a malware; however, it shows the\neffort put on the user experience.\n```\n[+] Improved Keylogger(added clipboard detector and window title trigger)\n\n```\nAs we saw during behavioral analysis, Diamond Fox generates neatly formatted reports\nabout captured users’ activities. They include Clipboard content and the title of the main\nwindow, where the particular text was typed:\n\n## Conclusion\n\nDiamond Fox Crystal has been solidly refactored in comparison to the older versions.\nRemoving descriptive modules’ names made analysis more difficult. Due to the change in the\nmethod of encrypting configuration, now retrieving its content is not as trivial.\n\nOverall, Diamond Fox comes with typical features that we can expect from the stealer. In\nspite of some improvements, the code quality is still nothing impressive.\n\n\n-----\n\n## Appendix\n\n[https://www.cylance.com/a-study-in-bots-diamondfox – about an elder version of Diamond](https://www.cylance.com/a-study-in-bots-diamondfox)\nFox\n\n_This was a guest post written by Hasherezade, an independent researcher and programmer_\n_with a strong interest in InfoSec. She loves going in details about malware and sharing threat_\n_[information with the community. Check her out on Twitter @hasherezade and her personal](https://twitter.com/hasherezade)_\n_[blog: https://hshrzd.wordpress.com.](https://hshrzd.wordpress.com/)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-04-06 - Diamond Fox – part 2- let’s dive in the code.pdf"
    ],
    "report_names": [
        "2017-04-06 - Diamond Fox – part 2- let’s dive in the code.pdf"
    ],
    "threat_actors": [
        {
            "id": "a66438a8-ebf6-4397-9ad5-ed07f93330aa",
            "created_at": "2022-10-25T16:47:55.919702Z",
            "updated_at": "2025-03-27T02:05:17.412024Z",
            "deleted_at": null,
            "main_name": "IRON VIKING",
            "aliases": [
                "ATK14 ",
                "BlackEnergy Group",
                "Blue Echidna ",
                "CTG-7263 ",
                "ELECTRUM ",
                "FROZENBARENTS ",
                "Hades/OlympicDestroyer ",
                "IRIDIUM ",
                "Qudedagh ",
                "Sandworm Team ",
                "Seashell Blizzard ",
                "TEMP.Noble ",
                "Telebots ",
                "Voodoo Bear ",
                "APT44 "
            ],
            "source_name": "Secureworks:IRON VIKING",
            "tools": [
                " BlackEnergy",
                " GCat",
                " GreyEnergy",
                " Industroyer",
                " KillDisk",
                " NotPetya",
                " PSCrypt",
                " TeleBot",
                " TeleDoor",
                " xData",
                "BadRabbit"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b3e954e8-8bbb-46f3-84de-d6f12dc7e1a6",
            "created_at": "2022-10-25T15:50:23.339976Z",
            "updated_at": "2025-03-27T02:00:55.446795Z",
            "deleted_at": null,
            "main_name": "Sandworm Team",
            "aliases": [
                "Sandworm Team",
                "ELECTRUM",
                "Telebots",
                "IRON VIKING",
                "BlackEnergy (Group)",
                "Quedagh",
                "Voodoo Bear",
                "IRIDIUM",
                "Seashell Blizzard",
                "FROZENBARENTS",
                "APT44"
            ],
            "source_name": "MITRE:Sandworm Team",
            "tools": [
                "Bad Rabbit",
                "Mimikatz",
                "Exaramel for Linux",
                "Exaramel for Windows",
                "GreyEnergy",
                "PsExec",
                "Prestige",
                "P.A.S. Webshell",
                "VPNFilter",
                "Cyclops Blink",
                "SDelete",
                "AcidRain",
                "Industroyer",
                "Industroyer2",
                "BlackEnergy",
                "Cobalt Strike",
                "NotPetya",
                "KillDisk",
                "PoshC2",
                "Impacket",
                "Invoke-PSImage",
                "Olympic Destroyer"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3a0be4ff-9074-4efd-98e4-47c6a62b14ad",
            "created_at": "2022-10-25T16:07:23.590051Z",
            "updated_at": "2025-03-27T02:02:09.878211Z",
            "deleted_at": null,
            "main_name": "Energetic Bear",
            "aliases": [
                "ATK 6",
                "Blue Kraken",
                "Crouching Yeti",
                "Dragonfly",
                "Electrum",
                "Energetic Bear",
                "Ghost Blizzard",
                "Group 24",
                "ITG15",
                "Iron Liberty",
                "Koala Team",
                "TG-4192"
            ],
            "source_name": "ETDA:Energetic Bear",
            "tools": [
                "Backdoor.Oldrea",
                "CRASHOVERRIDE",
                "Commix",
                "CrackMapExec",
                "CrashOverride",
                "Dirsearch",
                "Dorshel",
                "Fertger",
                "Fuerboos",
                "Goodor",
                "Havex",
                "Havex RAT",
                "Hello EK",
                "Heriplor",
                "Impacket",
                "Industroyer",
                "Karagany",
                "Karagny",
                "LightsOut 2.0",
                "LightsOut EK",
                "Listrix",
                "Oldrea",
                "PEACEPIPE",
                "PHPMailer",
                "PsExec",
                "SMBTrap",
                "Subbrute",
                "Sublist3r",
                "Sysmain",
                "Trojan.Karagany",
                "WSO",
                "Webshell by Orb",
                "Win32/Industroyer",
                "Wpscan",
                "nmap",
                "sqlmap",
                "xFrost"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8941e146-3e7f-4b4e-9b66-c2da052ee6df",
            "created_at": "2023-01-06T13:46:38.402513Z",
            "updated_at": "2025-03-27T02:00:02.824555Z",
            "deleted_at": null,
            "main_name": "Sandworm",
            "aliases": [
                "G0034",
                "IRIDIUM",
                "Blue Echidna",
                "FROZENBARENTS",
                "Seashell Blizzard",
                "IRON VIKING",
                "ELECTRUM",
                "TeleBots",
                "UAC-0113",
                "UAC-0082",
                "APT44",
                "Quedagh",
                "VOODOO BEAR",
                "TEMP.Noble"
            ],
            "source_name": "MISPGALAXY:Sandworm",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536017,
    "ts_updated_at": 1743041679,
    "ts_creation_date": 1653713789,
    "ts_modification_date": 1653713789,
    "files": {
        "pdf": "https://archive.orkl.eu/7cdf141a140bc8e4241ed3b117f3ddbfbe059067.pdf",
        "text": "https://archive.orkl.eu/7cdf141a140bc8e4241ed3b117f3ddbfbe059067.txt",
        "img": "https://archive.orkl.eu/7cdf141a140bc8e4241ed3b117f3ddbfbe059067.jpg"
    }
}