{
    "id": "639ce46e-42b2-4bff-a114-4182d0817c8d",
    "created_at": "2023-01-12T15:01:32.143629Z",
    "updated_at": "2025-03-27T02:06:02.042355Z",
    "deleted_at": null,
    "sha1_hash": "49bd22f842a3a8fb1fd13f3b8726c5b26d1d28f2",
    "title": "2021-07-19 - Shlayer Malvertising Campaigns Still Using Flash Update Disguise",
    "authors": "",
    "file_creation_date": "2022-05-28T15:14:44Z",
    "file_modification_date": "2022-05-28T15:14:44Z",
    "file_size": 1550594,
    "plain_text": "# Shlayer Malware: Continued Use of Flash Updates\n\n**[crowdstrike.com/blog/shlayer-malvertising-campaigns-still-using-flash-update-disguise/](https://www.crowdstrike.com/blog/shlayer-malvertising-campaigns-still-using-flash-update-disguise/)**\n\nAspen Lindblom - Joseph Goodwin - Chris Sheldon July 19, 2021\n\nMalvertising campaigns delivering Shlayer malware for macOS are still ongoing, despite the patching of a critical\nzero-day vulnerability (CVE-2021-30657) abused for months to compromise victims by dodging built-in OS\nprotections such as Gatekeeper and also bypassing File Quarantine and Application Notarization. Recent\n[Shlayer malvertising campaigns have gone back to using fake Flash updates and social engineering tactics to](https://www.crowdstrike.com/cybersecurity-101/social-engineering-attacks/)\ntrick victims into manually installing the macOS malware and compromising their systems.\n\nAlthough Flash Player reached end of life for macOS as of Dec. 31, 2020, this has not stopped Shlayer\noperators from continuing to abuse it. Shlayer operators may not be using a zero-day vulnerability anymore, but\nthey’re still resourceful.\n\n## Malvertising and How It Works\n\nAs the internet has grown, so have the avenues it can be used to abuse end users. Websites now exist whose\nsole purpose is to redirect the end user to advertisements. Attackers have taken advantage of this by\naggressively redirecting users to malicious content. Although these domains are often taken down very quickly,\nsome attackers have found ways to stay under the radar by serving both legitimate and malicious\n[advertisements, also known as malvertisements.](https://www.crowdstrike.com/cybersecurity-101/malware/malvertising/)\n\nIn these cases, the attacker can decide whether you are redirected to malicious or non-malicious sites\ndepending on a few factors such as your user-agents, IP address and whether this is your first visit to the site.\nYour user-agent is a way of identifying the browser, browser version and operating system. This allows the web\nserver to render the site differently based on the browser and operating system you are using.\n\n\n-----\n\nFor example, if you re on macOS using Chrome you could be sent to non malicious websites associated with\nthe attacker’s ad network, further generating ad revenue by falsely clicking on ad links through redirects.\nHowever, if you visit the same initial domain on a different browser (e.g., Safari) you will be redirected to the\nmalicious website. In most cases, after the initial visit to the malicious domain, any additional visits will redirect\nto a parked domain. Domain parking allows for monetization to occur while the domain is “under construction,”\ngiving the domain owner the ability to display links from ad affiliates.\n\nThese schemes range from attempting to trick you into calling “Technical Support” to remove a virus to tricking\nyou into installing “Adobe Flash Player” after it “detects” that your machine is running an out-of-date version.\n\n## Meet the macOS Shlayer\n\nShlayer, discovered in 2018, is constantly maintained and also evolving. The graph below is representative of\nShlayer continually being a go-to piece of malware that attackers use to compromise the victim’s machine. We\nobserved an uptick in Shlayer detections occurring before the release of CVE-2021-30657 (the Gatekeeper\nbypass) that was being exploited by Shlayer. This vulnerability was subsequently patched on April 26, 2021.\n\n[However, even without exploiting a zero-day, the data suggests that Shlayer is still a popular tool used to infect](https://www.crowdstrike.com/cybersecurity-101/zero-day-exploit/)\na machine. Although our telemetry registered a drop in detections after the vulnerability was addressed, Shlayer\noperators resumed their campaigns days after, driving home the fact that it continues to evolve and it is\nconstantly maintained.\n\nFigure 1. Shlayer detections, April-June 2021\n\nThe largest number of Shlayer detections started in the second half of April 2021, with peaks on April 13, April\n15 and April 21, coinciding with Shlayer using the CVE-2021-30657 vulnerability. The release of a patch for\nCVE-2021-30657 led to an immediate drop in Shlayer detections. However, in less than one month, Shlayer\noperators quickly adapted to overcome the patch addressing the exploited vulnerability and have gone back to\nold habits (fake Flash updates and social engineering tactics).\n\nThe most common method of Shlayer’s distribution is through malvertisements that redirect Safari users to sites\ndisplaying an alert about an out-of-date Adobe Flash Player. An example of a recent and ongoing malvertising\ncampaign involves `approvedfornext[.]com, which redirects Safari users to a site that displays this out-of-`\ndate Adobe Flash Player alert (see below).\n\n\n-----\n\nFigure 2. Fake Adobe Flash Player update popup\n\nOnce the user clicks on this fake software update popup, Shlayer is then downloaded and mounted on the\nvictim’s machine. However, it still needs to be installed, which is where the attacker relies on the user’s inability\nto spot the threat by leveraging social engineering tactics. To help increase the chances that the user will install\nthis on the machine, the .dmg file displays easy-to-follow, step-by-step instructions on how they can do this, as\nshown in the image below.\n\nFigure 3. Social engineering the user into installing Shlayer\n\n\n-----\n\nThis is actually an image file that is hidden in the .dmg, and the Install icon is an alias. The image attempts to\nhide that from the unsuspecting user, but taking a peek under the hood will reveal this information.\n\nFigure 4. Using “ls -la” command to display hidden files and folders in the .dmg\n\nThe Install alias is pointing to `Install.command, a script located in a hidden folder conveniently named`\n.hidden. `Install.command will execute as the user follows the instructions. To understand what occurs during`\nthe installation, the contents of the .hidden folder and `Install.command files will need to be reviewed. The`\ncontents of this .hidden folder can be seen below.\n\nFigure 5. Using “ls -la” command to display files in the .hidden folder\n\nThere is another file in the .hidden folder. Looking at the script provides clues as to what will happen next.\n\n\n-----\n\nFigure 6. Contents of `Install.command script`\n\nThe script contains a simple substitution cipher with Base64 encoding and AES encryption. Breaking down the\nscript will make it easier to understand what actions will be performed by the script:\n\nThe first line of the script initializes and assigns letters to 10 variables that will be used by the substitution\ncipher to decode part of the command seen in the `decryptedFommand variable and nohup command.`\nThe `appDir variable will be set to /Volumes/Install/.hidden.`\nThe `tmpDir variable will be set to the temporary directory in /tmp created by mktemp -d.`\nThe `binFile variable will be set to the name of the only other file located in the .hidden directory,`\n```\n   uaQf9bkKsOGo, but will be reversed to oGOsKkb9fQau .\n\n```\nThe archive variable will be set to `uaQf9bkKsOGo .`\nThe `commandArgs variable contains a Base64-encoded and AES-encrypted command.`\n```\n   decryptedFommand will echo commandArgs and pipe it to openssl in order to decode and decrypt the\n\n```\ncommand. The decrypted command will be:\n\nFigure 7. `decryptedFommand decrypted`\n\nThe decrypted command is then passed to `nohup, a utility that will invoke a command immune to hangup`\nsignals, with a substitution cipher that decodes to the following:\n\n\n-----\n\nFigure 8. `Nohup decrypted`\n\nThis will allow the decrypted command to continue to run until it is completed, even if the user logs off. Breaking\ndown the command, it will decode and decrypt `uaQf9bkKsOGo, saving it the temporary directory created in`\n```\n/tmp as oGOsKkb9fQau . The “ xattr -c ” command will clear all extended attribute flags from the temporary\n\n```\ndirectory, including the `com.apple.quarantine flag that is added to all downloaded files. Clearing the`\nquarantine flag allows the file to avoid notarization and Gatekeeper. The `chmod command will grant read, write`\nand execute permissions to the file, followed by the file getting executed and the temporary folder getting\ndeleted. Lastly, the `Install.command script will terminate all running Terminal processes.`\n\nThe file dropped from Shlayer’s `Install.command script,` `oGOsKkb9fQau, is a Mach-O executable file known`\nas Bundlore — adware that, amongst other things, will drop more adware families on the infected machine\naffecting your device’s performance and security.\n\n## Falcon Coverage\n\nThe CrowdStrike Falcon® sensor takes a layered approach to detect Shlayer using machine learning (ML) and\nbehavioral-based detections (i.e., indicators of attack, or IOAs) to protect customer endpoints. Here are the\nrecommend prevention policies that offer protection against Shlayer:\n\nEnhanced Visibility: Script-Based Execution Monitoring\nCloud Machine Learning\nSensor Machine Learning\nQuarantine\nExecution Blocking: Suspicious Processes\nExecution Blocking: Intelligence-Sourced Threats\n\n## IOCs\n\n\n**Indicator**\n**Type**\n\n\n**Value** **Description**\n\n\n-----\n\nDOMAIN `approvedfornext[.]com`\n```\n      sports-stream[.]net\n\n```\n```\nsyncuber-bestadvancedfile[.]best\n\n```\n\nDomains seen in\nmalvertisement\ncampaigns\ndistributing\nShlayer\n\n```\nloadgreatlynewestthefile[.]vip\n\n```\n```\nloadgreatlyprogressivethefile[.]vip\n\n```\n```\nloadgreatlyoriginalthefile[.]vip\n\n```\n```\nloadprogressivegreatlythefile[.]vip\n\n```\n```\nloadgreatlyrenewedthefile[.]vip\n\n```\n```\nloadfree-bestheavilyfile[.]best\nboot-upuber-bestfreefile[.]best\n\n```\n```\nboot-upcompletely-bestprecisefile[.]best\n\n```\n```\nbestp-upuber-bestfreefile[.]best\n\n```\n```\nboot-upfree-bestuberfile[.]best\n\n```\n```\nboot-upcompletely-bestsophisticatedfile[.]best\n\n```\n\nSHA256 `9ceea14642a1fa4bc5df189311a9e01303e397531a76554b4d975301c0b0e5c8` `Install.dmg`\n\nSHA256 `ea86178a3c0941fd6c421c69f3bb0043b768f68ed84ecb881ae770d7fb8e24ed` `Install.command`\nscript\n\nSHA256 `f3400c0a90d0abdff49cfe61804eb0ca80325bf84bbce4dc6e2796843ccebb0f` `uaQf9bkKsOGo ;`\nEncrypted\nBundlore\nexecutable\n\nSHA256 `bb947b2d55580e9e4593957a58163049b0f27313ba5df363801698fadde63426` `oGOsKkb9fQau ;`\nDecrypted\nBundlore\nexecutable\n\n## MITRE ATT&CK Framework\n\nThe following table maps reported Shlayer and Bundlore TTPs to the MITRE ATT&CK framework.®\n\n**Tactic** **Technique** **Description**\n\nInitial Access Phishing (T1566) Shlayer uses social engineering to trick\nusers into running the installer.\n\n\nInitial Access Hidden Files and Directories\n(T1564.001)\n\nInitial Access User Execution: Malicious File\n(T1204.002)\n\nExecution Hide Artifacts: Hidden Files and\nDirectories (T1059.004)\n\n\nShlayer installer contains hidden files and\nfolders.\n\nShlayer relies on users mounting and\nexecuting a malicious .dmg file.\n\nShlayer executes a Bash script located in\na hidden folder that contains a hidden\nbinary file.\n\n\n-----\n\nDefense Evasion Masquerading: Match Legitimate\nName or Location (T1036.005)\n\n\nShlayer masquerades as Adobe Flash\ninstaller.\n\n\nDeobfuscate/Decode\nFiles or Information\n(T1140)\n\nFile and Directory\nPermissions Modification\n(T1222.002)\n\nSubvert Trust Controls:\nGatekeeper Bypass\n(T1553.001)\n\n**Additional Resources**\n\n\nShlayer uses Base64 and AES to\ndecrypt and decode payloads to\n/tmp folder.\n\nShlayer uses `chmod and` `xattr`\nto change file and folder\npermissions.\n\nNewer variants of Shlayer exploit\nCVE to bypass Gatekeeper.\n\n\n_[See how the powerful, cloud-native CrowdStrike Falcon® platform protects customers from DarkSide and](https://www.crowdstrike.com/endpoint-security-products/)_\n_REvil ransomware in these blogs: DarkSide Goes Dark: How CrowdStrike Falcon Customers Were_\n_Protected and_ _[How CrowdStrike Falcon Stops REvil Ransomware Used in the Kaseya Attack.](https://www.crowdstrike.com/blog/how-crowdstrike-stops-revil-ransomware-from-kaseya-attack/)_\n_[Get a full-featured free trial of CrowdStrike Falcon Prevent™ and learn how true next-gen AV performs](https://go.crowdstrike.com/try-falcon-prevent.html)_\n_against today’s most sophisticated threats._\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-19 - Shlayer Malvertising Campaigns Still Using Flash Update Disguise.pdf"
    ],
    "report_names": [
        "2021-07-19 - Shlayer Malvertising Campaigns Still Using Flash Update Disguise.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535692,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1653750884,
    "ts_modification_date": 1653750884,
    "files": {
        "pdf": "https://archive.orkl.eu/49bd22f842a3a8fb1fd13f3b8726c5b26d1d28f2.pdf",
        "text": "https://archive.orkl.eu/49bd22f842a3a8fb1fd13f3b8726c5b26d1d28f2.txt",
        "img": "https://archive.orkl.eu/49bd22f842a3a8fb1fd13f3b8726c5b26d1d28f2.jpg"
    }
}