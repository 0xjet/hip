{
    "id": "bb0d3db8-840f-4e83-ad0b-ac3c118a2832",
    "created_at": "2022-10-25T16:48:18.761199Z",
    "updated_at": "2025-03-27T02:06:12.071701Z",
    "deleted_at": null,
    "sha1_hash": "4873e2465fc56fca681074f5069788baa80841fb",
    "title": "Carbon Black TAU & ThreatSight Analysis: GandCrab and Ursnif Campaign",
    "authors": "",
    "file_creation_date": "2019-01-29T09:44:34Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 1636725,
    "plain_text": "# Carbon Black TAU & ThreatSight Analysis: GandCrab and Ursnif Campaign\n\n**[carbonblack.com/2019/01/24/carbon-black-tau-threatsight-analysis-gandcrab-and-ursnif-campaign/](https://www.carbonblack.com/2019/01/24/carbon-black-tau-threatsight-analysis-gandcrab-and-ursnif-campaign/)**\n\nJanuary 24, 2019\n\nJanuary 24, 2019 / Carbon Black Threat Analysis Unit\n\n# Summary\n\n_(Analysis conducted by Andrew Costis, Cathy Cramer, Emily Miner and Jared Myers.)_\n\nThe Carbon Black ThreatSight team observed an interesting campaign over the last month.\nThreatSight worked with the Threat Analysis Unit (TAU) to research the campaign. This report\nis being released to help researchers and security practitioners combat this campaign as new\nsamples are being discovered in the wild daily. This attack, if successful, can infect a\ncompromised system with both Ursnif malware and GandCrab ransomware. The overall\nattack leverages several different approaches, which are popular techniques amongst red\nteamers, espionage focused adversaries, and large scale criminal campaigns.\n\n\n-----\n\ndocument with embedded macros, Carbon Black located roughly 180 variants in the wild. The\nmacro would call an encoded PowerShell script and then use a series of techniques to\ndownload and execute both a Ursnif and GandCrab\n\n[variant. This campaign has been discussed at a high level by other researchers publicly. The](https://twitter.com/malware_traffic/status/1075522550862626817)\nimage below provides a high level overview of the attack chain. Carbon Black product specific\ncontent can be located in the User Exchange.\n\n_Figure 1: Attack Overview_\n\n# Technical Findings\n\n## Carrier File\n\nIn this campaign the attackers used a MS Word document (.doc format) to deliver the initial\nstages. It should be noted that out of the roughly 180 Word variants that were located by\nCarbon Black, the biggest difference in the documents was the metadata and junk data\nlocated in the malicious macros. However the metadata clearly showed that the documents\nprepared for this campaign were initially saved on December 17, 2018 and have continued to\nbe updated through January 21, 2019. Several metadata fields (specifically title, subject,\n\n\n-----\n\ncommon first name (like Utah Erick or Tennessee Dayna). For this post the following sample\nwas analyzed.\n\nFile Name    : Richard_Johnson.doc\n\nFile Size    : 102,400 bytes\n\nMD5       : 878e4e8677e68aba918d930f2cc67fbe\n\nSHA256     : 0a3f915dd071e862046949885043b3ba61100b946cbc0d84ef7c44d77a50f080\n\n_Table 1: Sample Analyzed_\n\nThe document contained a VBS macro that once decompressed was approximately 650 lines\nof code. The vast majority of that was junk code, the below images represent a high level\nvisualization the script itself.\n\n_Figure 2: VBScript Overview_\n\nOnce the junk code was removed from the VBScript, there are\napproximately 18 lines of relevant code, which ultimately call a\nshape box in the current document. The variable names\nthemselves are not relevant, however the methods in bold\nbelow will retrieve the AlternativeText field from the specified\nshape, which is then executed.\n\n**Sub AutoOpen()**\n\nSet QWxwqfqgHttm = ThisDocument\n\nSet FXpVcBPxzVsJ = QWxwqfqgHttm.Shapes(“4obka2etp1318a”)\n\nfaaQXNtRqmxB = FXpVcBPxzVsJ.AlternativeText\n\nnpNsCwDavJ = Array(HpTNHpSpmZgp, BlmmaRvZMLP,\ntRzpZFwJWJcCj, tPJRanNbKWZPrd,\n**Interaction@.Shell(CleanString(faaQXNtRqmxB), 231 * 2 + -462),**\nRfjXGpzMtcrz, hfbZCRXCJQPJQ)\n\n_Table 2: Relevant VBScript code_\n\nThe alternate text can easily be observed in the body of the office document. The area\nhighlighted in blue is the shape name that is being located, while the text itself is highlighted\nin red. It is clear that the text is a base64 encoded command, that is then executed by the\nabove VBScript.\n\n\n-----\n\n-----\n\n_Figure 3: Alternative Text_\n\n## Second Stage\n\nThe PowerShell script will first create an instance of the .Net Webclient class and then\nenumerate the available methods using the GetMethods() call (highlighted in the image in\nred). The enumerated methods are stored, then a for loop looks first for the method named\nDownloadString (highlighted in blue).\n\nIf the DownloadString method is located it will contact the hard coded C2 requesting a file,\nwhich is downloaded and then invoked (highlighted in blue). It should be noted that because\nthe requested resource is being stored as a string and executed, this all occurs in memory.\nAdditional Analysis of the downloaded string is provided in the Gandcrab cradle section\nbelow.\n\nThe loop then looks for the method name DownloadData, and if located will download a\nresource from a second C2. This request is then stored in the CommonApplicationData\ndirectory (C:\\ProgramData in Vista and later) as the hard coded file name (highlighted in\ngreen). The script will utilize the hard coded DCOM object C08AFD90-F2A1-11D1-8455_00A0C91F3880, which is the ClassID for the ShellBrowserWindow. A previous_ [blog post by](https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/)\nenigma0x3, detailed how this CLSID can be leveraged to instantiate the ShellBrowserWindow\nobject and call the ShellExecute method, which is the same approach that was taken by the\n[attackers. This approach has also been used in different Empire modules.](https://github.com/EmpireProject/Empire/blob/master/data/module_source/lateral_movement/Invoke-DCOM.ps1)\n\n\n-----\n\n_Figure 4: PowerShell Script_\n\n## Payloads\n\nThe payloads that are downloaded in the above steps are then executed on the system.\n\n### GandCrab Cradle\n\nThe first payload that is downloaded via the DownloadString method highlighted above, is a\nPowerShell one-liner that uses an IF statement to evaluate the architecture of the\ncompromised system, and then downloads a additional payload from pastebin.com. This\nadditional payload is then executed in memory. The image below depicts the contents of the\no402ek2m.php file. It should be noted that the contents of o402ek2m.php were updated by\nthe attackers to reference different pastebin uploads throughout this campaign. Also updated\nwas the function name that is invoked, in the example below it was\n_CJOJFNUWNQKRTLLTMCVDCKFGG, however this was dynamically changed to match the_\nname of the function that would be present in pastebin file that was being downloaded.\n\n\n-----\n\nexecuted in memory. In the variants that were obtained during this campaign the file\ncontained a PowerShell script that was approximately 2800 lines. This PowerShell script is a\n[version of the Empire Invoke-PSInject module, with very few modifications. The majority if the](https://github.com/EmpireProject/PSInject/blob/master/Invoke-PSInject.ps1)\nmodifications are of removing comments and renaming variables. The script will take an\nembedded PE file that has been base64 encoded and inject that into the current PowerShell\nprocess. The image below is the main function that is being called which in turns calls the\nfunction responsible for injecting the embedded PE file.\n\n_Figure 6: PowerShell reflective injection script_\n\nThe base64 encoded PE file that can be seen in line 2760 of the image above is a GandCrab\nVariant. This variant (the metadata for which is listed below) is Gandcrab version 5.0.4.\n\nFile Name    : krab5\n\nFile Size    : 133,632 bytes\n\nMD5       : 0f270db9ab9361e20058b8c6129bf30e\n\nSHA256     : d6c53d9341dda1252ada3861898840be4d669abae2b983ab9bf5259b84de7525\n\nFuzzy      :\n1536:7S/0t4vMd+uEkJd4a7b+KqeaiMGFzj92URuVSuKhsWjcdRIJXNhoJwyvZaX:m/fMb7t/JqNi5+VSuKORIJXmaX\n\nCompiled Time  : Mon Oct 29 17:39:23 2018 UTC\n\nPE Sections (5) : Name    Size MD5\n\n.text 73,728  019bc7edf8c2896754fdbdbc2ddae4ec\n\n.rdata 27,136  d6ed79624f7af19ba90f51379b7f31e4\n\n.data 26,112  1ec7b57b01d0c46b628a991555fc90f0\n\n.rsrc 512  89b7e19270b2a5563c301b84b28e423f\n\n.reloc 5,120  685c3c775f65bffceccc1598ff7c2e59\n\nOriginal DLL  : krab5.dll\n\nDLL Exports (1) : Ordinal Name\n\n1 _ReflectiveLoader@0\n\nMagic      : PE32 executable for MS Windows (DLL) (GUI) Intel 80386 32-bit\n\n\n-----\n\n### Ursnif\n\nThe second payload, downloaded via the DownloadData method highlighted in Figure 4, is a\nUrsnif executable. In this instance it is saved to the C:\\ProgramData directory with a pseudo\nrandom name. It should be noted that the file name was changed throughout this campaign.\nOnce executed the Ursnif sample will conduct the typical actions observed in Ursnif samples,\nlike credential harvesting, gathering system and process information, and deploying\nadditional malware samples. The information for this specific sample is listed below.\nHowever, numerous Ursnif variants were hosted on the bevendbrec.com site during this\ncampaign. Carbon Black was able to discover approximately 120 different Ursnif variants that\nwere being hosted from the domains iscondisth.com and bevendbrec.com.\n\nFile Name    : irongreen.exe\n\nFile Size    : 265,728 bytes\n\nMD5       : 404d25e3a18bda19a238f77270837198\n\nSHA256     : c064f6f047a4e39014a29c8c95526c3fe90d7bcea5ef0b8f21ea306c27713d1f\n\nFuzzy      : 6144:l2BrJZHpYjthdeDBriFX8gN7Fcp4bxKXKFpqKx:cBxYjNqBuSo504bxKXcp1x\n\nCompiled Time  : Sun Dec 18 11:04:31 2011 UTC\n\nPE Sections (5) : Name    Size MD5\n\n.text 219,648  85aa9117c381eae3d181ab63daab335e\n\n.rdata 27,648  3e1c774bc4e0ffc2271075e621aa3f3d\n\n.data 6,656  6c389e5e301564f65dcad4811dbded8b\n\n.rsrc 1,024  efba623cc62ffd0ccbf7f3fbf6264905\n\n.reloc 9,728  6cf46599a57a6cbc5d18fbb2883620ce\n\nMagic      : PE32 executable for MS Windows (GUI) Intel 80386 32-bit\n\n_Table 4: Ursnif metadata_\n\n## Campaign details\n\nWhile researching this campaign approximately 180 variants were located in the wild. Using\nthe VirusTotal Graph functionality these variants could be organized into several groups that\nwere commonly associated by either metadata or document structures like macros or\nembedded image files (depicted in the image below). The variants directly related to this\nanalysis was extracted and expanded in Figure 8.\n\n\n-----\n\n_Figure 7: Campaign related Word documents_\n\nThe image below highlights the nodes associated with the samples analyzed in this report.\n[The graph can also be viewed in the VTGraph Console for additional exploration. The graph](https://www.virustotal.com/graph/g1956d2776c244df390b8f92b95ace9ce83d4901dd4bd49019ac2886bf19c1989)\nhighlights the at least 3 different variants of Ursnif that were being hosted on the\nbevendbrec[.]com site. As well as the PowerShell cradle and PS Empire script that would\ninject the Gandcrab sample into memory can be observed in the graph below.\n\n\n-----\n\n_Figure 8: Analyzed document isolated relationships_\n\nThe Ursnif variants that were located in the wild are highlighted in the image below. The\nvariants were primarily grouped by C2 infrastructure. The large grouping on the right of the\ndiagram are direct variants of the sample referenced in this write up. Samples in this\ngrouping were all hosted on sites that were called by the second stage. The samples had\nminor changes, and were presumably changed by the attackers to avoid detection by hash.\n\n\n-----\n\n_Figure 9: Campaign related Ursnif samples_\n\n# IOCs\n\nThe IOCs for this blog post can be found on Carbon Blacks Github repo. [IOCs here and Yara](https://github.com/carbonblack/tau-tools/blob/master/threat_hunting/IOCs/IOCs_2019_Q1_Ursnif-GandCrab.csv)\nSigs here.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2019/2019.01.24.GandCrab_and_Ursnif/GandCrab%20and%20Ursnif%20Campaign.pdf"
    ],
    "report_names": [
        "GandCrab and Ursnif Campaign"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716498,
    "ts_updated_at": 1743041172,
    "ts_creation_date": 1548755074,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/4873e2465fc56fca681074f5069788baa80841fb.pdf",
        "text": "https://archive.orkl.eu/4873e2465fc56fca681074f5069788baa80841fb.txt",
        "img": "https://archive.orkl.eu/4873e2465fc56fca681074f5069788baa80841fb.jpg"
    }
}