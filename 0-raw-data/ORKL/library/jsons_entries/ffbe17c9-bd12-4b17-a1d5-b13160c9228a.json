{
    "id": "ffbe17c9-bd12-4b17-a1d5-b13160c9228a",
    "created_at": "2023-01-12T15:07:31.839603Z",
    "updated_at": "2025-03-27T02:16:47.156874Z",
    "deleted_at": null,
    "sha1_hash": "6815f2b88789229638306db8e04b6baa2a14cd4e",
    "title": "2022-11-30 - Evolution of the PlugX loader",
    "authors": "",
    "file_creation_date": "2022-12-29T00:19:48Z",
    "file_modification_date": "2022-12-29T00:19:48Z",
    "file_size": 1132225,
    "plain_text": "# PlugXローダーの進化\n\n**engineers.ffri.jp/entry/2022/11/30/141346**\n\n[マルウェア](https://engineers.ffri.jp/archive/category/%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2)\n\n[Tweet](https://twitter.com/share)\n\n## はじめに\n\n\n2022-11-30\n\n\nＦＦＲＩセキュリティ ソフトウェアエンジニアの松本です。\nPlugX というバックドアは非\n常に古くから存在しており、現在でも利用されています。 今回はその PlugX のローダーの\n変遷について見ていきます。\n\n## PlugXの概要\n\nPlugX は標的型攻撃に利用されている Remote Access Tool(以下 RAT と記載)であり、主に\n政府機関などを狙う標的型攻撃に利用されるツールです。 機能としては情報収集・窃取、\n侵入後の PC のコントロールなどがあります。\n\n2012 年には既に TrendMicro の記事[1]があるほど PlugX は古くから存在します。 その一\n方、ここ数か月の間にも TA416 (通称 Mustang Panda[2]) というグループが利用していると\nいう報告[3]が上がっております。\n\n\n-----\n\n日本国内では株式会社 JTB が PlugX に感染し情報漏洩したという事例が存在します[5][6]。\nまた、株式会社ジャストシステムのワープロソフトである一太郎の脆弱性を利用し感染を狙\nう事例もありました[7][9]。\n\nPlugX ローダーは世代に関わらず以下のような流れで動作しています。\n\n1. ドロッパーを添付したメール経由などにより、対象組織内部でドロッパーを実行して\n\nもらう\n2. ドロッパーが①正規 exe、②マルウェア dll、③バイナリファイルの 3 つを生成する\n3. ドロッパーが①正規 exe を実行する\n4. ②マルウェア dll は①正規 exe が利用する正規 dll を偽装しており、①正規 exe はその\n\nまま②マルウェア dll を読み込む\n5. ②マルウェア dll が③バイナリファイルを読み込む\n6. ③バイナリファイルが子プロセスを生成し、次の段階に移る\n\n読み込まれるバイナリファイルの内部に暗号化されたコードなどが入っているため、実際に\nはその複合など更に細かい動作が存在しますが、動作の流れは以下の概要図のようになりま\nす。\n\n\n-----\n\n図1 PlugX動作の概要図\n実際にドロップされる具体例としては下の図のようになります。 この図では RasTls.exe は\n正規の exe であり、RasTls.dll へのリンクが存在しています。 マルウェアバイナリにもアイ\nコンが付いていますが、これは本来 msc が Microsoft 管理コンソールに紐付けられている拡\n張子であるためです。 実際の中身は全く関係無いバイナリファイルとなっています。\n\n\n-----\n\n図2 PlugX動作例\n\nexe が不正な dll を読み込んでしまう理由は、exe が dll を読み込む際に同じディレクトリの\ndll を優先する仕様のためです。\n\n図3 正規\n\nexe のロードにより読み込まれる例\n次の図は、LoadLibraryW 関数で同ディレクトリの dll を動的に読み込む箇所です。\n\nこのような動的な dll 読み込みの際、通称 exe は自身の現在のパスから読み込みたい dll の\nパスを生成しますが、\nPlugX は同ディレクトリ内にファイルを生成するため、結局すり替\nえられた dll を読み込むことになります。\n\n図4 正\n\n規 exe から LoadLibraryW 関数で読み込まれる例\n\n\n-----\n\nこの手法は DLL Side-Loading[4]と呼ばれ、デジタル署名された正規の exe を利用すること\nで、アンチウイルスソフトの検知回避によく利用されます。\n\n一般に dll 内部の悪意のあるコードは entry 関数か、exe から必ず呼ばれる export 関数のど\nちらかに実装されていますが、PlugX は entry 関数に悪意のあるコードが実装されていま\nす。 ここで dll における entry 関数は DllMain 関数であり、リンクなどで読み込まれた段階\nで必ず呼ばれる処理です。 そのため、exe の初期化処理である dll 読み込みの段階で PlugX\nローダーが動作します。\n\n次の段階では、子プロセスもしくはサービス登録によるサービスプロセスを生成します。\n実行プロセスに管理者権限が付与されているときには、サービスプロセスを生成し、管理者\n権限がない時には、子プロセスを生成します。\n\nさて、ここまでは全世代の PlugX 共通な動作の流れについて説明しましたが、次に世代に\nよって変化してきた内容を説明します。\n\n## PlugXの変化\n\nPlugX は時間と共に進化していきました。 その流れを簡潔に纏めると以下のようになりま\nす。\n\n年代 世代 追加機能の例 引用\n\n2012 第一世代 RAT [1]\n\n2013 第二世代 自己解凍書庫の利用開始 [8][9]\n\n2015 第三世代 P2P機能の追加による、感染端末間の通信 [10]\n\n2017 第四世代 PoisonIvyのコード流用 [11]\n\n\n現状 第五世代 Go言語の利用、ローダーの多様化\nC2 サーバーからドロップ検体をダウンロード\n\n### 第一世代\n\n\n\n[3][12]\n\n\nPlugX では前述通り、まずは正規 exe から dll が読み込まれ、dll からバイナリを読み込んだ\n上で次のプロセスを生成するという動作をします。 まず注目すべきは、マルウェアバイナ\nリのコード内部でスタック上に文字列を生成する stack strings という手法が利用されている\n点です。 この手法はバイナリに文字列を直接埋め込まないため、解析をより困難にしま\nす。\n\n\n-----\n\n図5 stack strings が利用されている\n\n箇所\nstack strings は x86 の mov 命令や lea 命令を利用してスタック上に文字列を手動で生成す\nる方法です。\n\n図6 stack strings の例\n上の図であれば、4 byte 長の mov 命令を利用することでスタック上に文字列を構築できま\nす。 構築後に esp レジスタが指している箇所を文字列として扱えば Windows API などで認\n識できる文字列になります。 上記の例では char 型でしたが、wchar_t 型でも同様に作成可\n能です。\n\n\n-----\n\nLoadLibraryA を 4 byte ずつ生成\n\n\n図7\n\n図8 スタック上の\n\n\nGetProcAddress を 1 byte ずつ確認\nスタック上に生成された文字列はバイナリ内部で利用する API のアドレスを動的に取得する\nために利用されます。\n\nここで LZNT1 復号に利用する RtlDecompressBuffer という関数も動的解決しています。 こ\nこで得た LZNT1 復号と XOR 復号により、子プロセスの生成に進みます。\n\n\n-----\n\n図9 バイナリをメモリ内部で復号\n\n\n図10 XOR 復号関数\n\n図\n\n11 RtlDecompressBuffer 呼び出しによる LZNT1 復号\nこの復号により、メモリ内部に PE ヘッダーを持つコード領域を展開することが確認できま\nす。\n\n\n-----\n\n図12\n\nマジックナンバーである MZ が確認できる\n\n### 第二世代\n\n第二世代は機能面の変化の他、メモリ内部で復号される PE ファイルのマジックナンバーが\nPE ではなくなっているといった変更点が報告されています[8][9]。 ドロッパーに自己解凍書\n庫が利用されているパターンもこの辺りから出てきます。 ここではローダー部分の変化に\nついて見ていきます。\n\nマルウェア dll には上から順番にディスアセンブルすると、実際に実行される命令とは異な\nってしまうという難読化が施された関数も追加されています。\n\n図13 不要な分岐\n\n赤枠は以下のような役割を担っています。\n\n1. 二行続けて同じ所にジャンプするように指定されているため、無条件ジャンプと同等\n2. その直後の call 命令は、直前のジャンプを無条件ジャンプと解釈できなかった為に発\n\n生\n3. e8 から命令を開始することで、意図的にコード外にジャンプする不正な call 命令と解\n\n釈させる\n\n他にも、不要な XOR なども追加されており、処理を追いかけにくい構造になっています。\n\n\n-----\n\n図14 不要な XOR\n\nこれらの難読化処理は Ghidra のデコンパイル結果にも影響しますが、除去整理することで\n以下のようにデコンパイル結果が綺麗になります。 デコンパイル結果から dll 内部のバイナ\nリを復号するコードが出てきたことが確認できます。\n\n図15\n\nデコンパイル結果\nこの処理以降は第一世代と同じ stack strings を利用した API 動的解決の処理に入ります。\nRtlDecompressBuffer も LZNT1 復号に利用されており、XOR 復号のコードは変わっている\nもののこの辺りのローダーとしての処理は第一世代と同じと見て良いでしょう。\n\n第一世代と同じく PE ヘッダーを持つバイナリが復号されメモリに展開されますが、マジッ\nクナンバーが改変されている物となっております。\n\n\n-----\n\n図\n\n16 XV ヘッダー\n\n### 第三世代\n\n第三世代の機能面における変化は P2P 機能の搭載などが報告されています[10]。\n\nしかし、ローダー部分に関しては XV というマジックナンバーの出現個数の変化などの変更\nはあるものの、\nXOR 復号はもちろん大まかな流れには変化が無いように見受けられまし\nた。\n\n### 第四世代\n\nPoisonIvy のコードを一部流用している[11]ということで第四世代として分類されるこの世\n代では、 ドロッパー自体は第三世代から引き続き自己解凍書庫であるものの、ローダー部\n分にも多くの変更が入っています。 例えば、簡単なものであればマルウェア dll の entry 関\n数から早速 NOP、DEC、INC 命令を使った無駄な処理を大量に配置しています。\n\n\n-----\n\n図17 entry 関数の NOP\n\nただし、Ghidra のデコンパイル結果には影響しておらず、比較的除去が簡単な処理になっ\nています。\n\n図18 entry 関数のデ\n\nコンパイル結果\nまた、今までの世代では VirtualAlloc で取得したメモリへの展開は memcpy を利用していま\nしたが、この世代からはバイナリファイルを直接 ReadFile で読み込む処理に変わっていま\nす。\nReadFile 経由の読み込みはユーザーランドにおける WinDbg のハードウェアブレーク\nポイントでは止まらないので、 メモリアドレスへの書き込みイベントで止めることが出来\nず、より解析が困難になっています。\n\nWinDbg のクエリ結果から見ても、突然メモリに 0x3f の値が出てきていることが確認でき\nます。\n\n\n-----\n\n図\n\n19 Time Travel Debugging で確認できるメモリ操作\n上記のクエリ結果の中にある Write は復号処理であることが確認できます。\n\n図20 ReadFile で読み込んだメ\n\nモリ領域を復号する箇所\nまた、子プロセス生成までに必要な API の取得において stack strings は利用しなくなり、\n代わりに随時ハッシュ値から関数アドレスを復元する形になっています。\n\n図21 CreateServiceA の呼び出し例\nこの関数アドレス取得の手法は子プロセス生成後にも沢山利用されております。 この手法\nは Poison Ivy と酷似していることが報告されています[11]。\n\nAPI 解決に必要なモジュールのアドレス解決においては、対象のモジュール名がメモリ上に\nそのまま存在しています。\n\n図22 メモリ上にある kernel32\n\n### 現在\n\nPlugX と呼ばれる検体は現在も変化し続けていますが、 基本的に正規 exe、マルウェアであ\nる dll、そしてバイナリファイルを同じディレクトリに配置するというドロップ方式は変わ\nっていないようです。\n\n\n-----\n\n方で解析をより困難にするため C2 サーバーと接続出来なければ次の段階に進まないよう\nな改良が見られるようになりました。\n\n図23 検\n\n体の C2 サーバーへの接続試行\nまた、Go 言語製の PlugX ローダーが存在していることも報告されています[11]。 この dll\nのインポート関数からも確認できます。\n\n図24 イン\n\nポート関数の一部\nこの Go 言語製の dll も C2 サーバーと接続できなければ動作しないようになっていたた\nめ、 現在の主流は解析を困難にするため、 C2 サーバー側にドロップさせたい物を配置する\n形式になってきたと思われます。\n\n## 終わりに\n\nPlugX は長い活動期間を通して、機能の高度化以外にもローダー部分における難読化も施し\nていることが確認できました。 こうした変化によりマルウェア解析用のスクリプトが正常\nに動作しないこともあり、検知を回避し、解析の妨害に一役買っています。\n\n今回調査した PlugX の検体など多くのマルウェアは、以上のような検知回避や難読化など\nを行っておりますが、FFRI yarai は検知エンジンの新規開発や改善などを継続的に行うこと\nで、検知可能となっておりますのでご安心ください。\n(※ただし、全ての PlugX が検出でき\nることを保証するものではありません)。\n\n## エンジニア募集\n\nＦＦＲＩセキュリティではマルウェアの解析などセキュリティの研究開発を行っています。\n採用に関しては [こちら](https://www.ffri.jp/recruit/index.htm) をご覧ください。\n\n\n-----\n\n## 参考文献\n\n[1] [標的型攻撃に利用されるPlugXの脅威とは | トレンドマイクロ](https://www.trendmicro.com/vinfo/jp/threat-encyclopedia/web-attack/112/pulling-the-plug-on-plugx) 脅威データベース\n\n[2] Mustang Panda, TA416, RedDelta, BRONZE PRESIDENT, Group G0129 | MITRE\nATT&CK®\n\n[3] The Good, the Bad, and the Web Bug: TA416 Increases Operational Tempo Against\nEuropean Governments as Conflict in Ukraine Escalates | Proofpoint US\n\n[4] Hijack Execution Flow: DLL Side-Loading, Sub-technique T1574.002 - Enterprise | MITRE\nATT&CK®\n\n[5] JTB、約793万人分の個人情報流出の恐れ - 有効パスポート番号4,300件含む | マイナビニ\nュース\n\n[6] 「PlugX」はどんなマルウェア? JTBを狙った標的型攻撃をファイア・アイが解説 | マイ\nナビニュース\n\n[7] 一太郎の脆弱性を突くマルウェア、人事情報装うメールで日本に「着弾」 | ITmedia エン\nタープライズ\n\n[8] [PlugX - The Next Generation | Sophos](https://www.sophos.com/en-us/medialibrary/pdfs/technical%20papers/plugx-thenextgeneration.pdf)\n\n[9] [From the Labs: New PlugX malware variant takes aim at Japan | Naked Security](https://nakedsecurity.sophos.com/2013/12/04/new-plugx-malware-variant-takes-aim-at-japan/)\n\n[10] マルウエアPlugXの新機能 (2015-01-22) - JPCERT/CC Eyes | JPCERTコーディネーシ\nョンセンター公式ブログ\n\n[11] Poison Ivyのコードを取り込んだマルウエアPlugX(2017-01-12) - JPCERT/CC Eyes |\nJPCERTコーディネーションセンター公式ブログ\n\n[12] TA416 Goes to Ground and Returns with a Golang PlugX Malware Loader | Proofpoint\nUS\n\n\n-----",
    "language": "JA",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-11-30 - Evolution of the PlugX loader.pdf"
    ],
    "report_names": [
        "2022-11-30 - Evolution of the PlugX loader.pdf"
    ],
    "threat_actors": [
        {
            "id": "b5449533-0ff1-4048-999d-7d4bfd8e6da6",
            "created_at": "2022-10-25T16:07:24.114365Z",
            "updated_at": "2025-03-27T02:02:10.111256Z",
            "deleted_at": null,
            "main_name": "RedDelta",
            "aliases": [
                "Operation Dianxun",
                "TA416"
            ],
            "source_name": "ETDA:RedDelta",
            "tools": [
                "Agent.dhwf",
                "Agentemis",
                "Chymine",
                "Cobalt Strike",
                "CobaltStrike",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Gen:Trojan.Heur.PT",
                "Kaba",
                "Korplug",
                "PlugX",
                "Poison Ivy",
                "RedDelta",
                "SPIVY",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Xamtrav",
                "cobeacon",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa90ad17-8852-4732-9dba-72ffb64db493",
            "created_at": "2023-07-11T02:00:10.067957Z",
            "updated_at": "2025-03-27T02:00:03.134199Z",
            "deleted_at": null,
            "main_name": "RedDelta",
            "aliases": [],
            "source_name": "MISPGALAXY:RedDelta",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1691c25f-1aa4-4168-8ce2-7aa8f23246e7",
            "created_at": "2024-06-04T02:03:07.724221Z",
            "updated_at": "2025-03-27T02:05:17.284601Z",
            "deleted_at": null,
            "main_name": "BRONZE PRESIDENT",
            "aliases": [
                "Mustang Panda ",
                "Red Lich ",
                "Temp.Hex ",
                "HoneyMyte "
            ],
            "source_name": "Secureworks:BRONZE PRESIDENT",
            "tools": [
                " Cobalt Strike",
                " ORat",
                " PlugX",
                " RCSession",
                "China Chopper"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b69037ec-2605-4de4-bb32-a20d780a8406",
            "created_at": "2023-01-06T13:46:38.790766Z",
            "updated_at": "2025-03-27T02:00:02.919758Z",
            "deleted_at": null,
            "main_name": "MUSTANG PANDA",
            "aliases": [
                "TEMP.HEX",
                "TA416",
                "TANTALUM",
                "Twill Typhoon",
                "Earth Preta",
                "Stately Taurus",
                "LuminousMoth",
                "Polaris",
                "BRONZE PRESIDENT",
                "HoneyMyte",
                "Red Lich"
            ],
            "source_name": "MISPGALAXY:MUSTANG PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9baa7519-772a-4862-b412-6f0463691b89",
            "created_at": "2022-10-25T15:50:23.354429Z",
            "updated_at": "2025-03-27T02:00:55.45162Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Mustang Panda",
                "TA416",
                "RedDelta",
                "BRONZE PRESIDENT"
            ],
            "source_name": "MITRE:Mustang Panda",
            "tools": [
                "Cobalt Strike",
                "RCSession",
                "NBTscan",
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2ee03999-5432-4a65-a850-c543b4fefc3d",
            "created_at": "2022-10-25T16:07:23.882813Z",
            "updated_at": "2025-03-27T02:02:10.0116Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Bronze President",
                "Camaro Dragon",
                "Earth Preta",
                "HoneyMyte",
                "Mustang Panda",
                "Operation SMUGX",
                "Operation SmugX",
                "PKPLUG",
                "Red Lich",
                "Stately Taurus",
                "TEMP.Hex"
            ],
            "source_name": "ETDA:Mustang Panda",
            "tools": [
                "9002 RAT",
                "AdFind",
                "Agent.dhwf",
                "Agentemis",
                "CHINACHOPPER",
                "China Chopper",
                "Chymine",
                "ClaimLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "DCSync",
                "DOPLUGS",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Farseer",
                "Gen:Trojan.Heur.PT",
                "HOMEUNIX",
                "Hdump",
                "HenBox",
                "HidraQ",
                "Hodur",
                "Homux",
                "HopperTick",
                "Hydraq",
                "Impacket",
                "Kaba",
                "Korplug",
                "LadonGo",
                "MQsTTang",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "NBTscan",
                "NetSess",
                "Netview",
                "Orat",
                "POISONPLUG.SHADOW",
                "PUBLOAD",
                "PVE Find AD Users",
                "PlugX",
                "Poison Ivy",
                "PowerView",
                "QMAGENT",
                "RCSession",
                "RedDelta",
                "Roarur",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TONEINS",
                "TONESHELL",
                "TVT",
                "TeamViewer",
                "Thoper",
                "TinyNote",
                "WispRider",
                "WmiExec",
                "XShellGhost",
                "Xamtrav",
                "Zupdax",
                "cobeacon",
                "nbtscan",
                "nmap",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536051,
    "ts_updated_at": 1743041807,
    "ts_creation_date": 1672273188,
    "ts_modification_date": 1672273188,
    "files": {
        "pdf": "https://archive.orkl.eu/6815f2b88789229638306db8e04b6baa2a14cd4e.pdf",
        "text": "https://archive.orkl.eu/6815f2b88789229638306db8e04b6baa2a14cd4e.txt",
        "img": "https://archive.orkl.eu/6815f2b88789229638306db8e04b6baa2a14cd4e.jpg"
    }
}