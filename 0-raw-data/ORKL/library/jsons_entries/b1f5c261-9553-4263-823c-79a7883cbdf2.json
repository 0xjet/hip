{
    "id": "b1f5c261-9553-4263-823c-79a7883cbdf2",
    "created_at": "2022-10-25T16:48:23.868723Z",
    "updated_at": "2025-03-27T02:16:57.986083Z",
    "deleted_at": null,
    "sha1_hash": "c88964f86dee3dddad544afaa958f19d5b078700",
    "title": "",
    "authors": "",
    "file_creation_date": "2017-11-02T04:17:46Z",
    "file_modification_date": "2017-11-02T04:17:46Z",
    "file_size": 1565531,
    "plain_text": "### Night of the Devil: Ransomware or wiper? A look into targeted attacks in Japan using MBR-ONI\n\nPOST BY: ASSAF DAHAN\n\n##### For several months Cybereason has been following the concerning rise of ONI, a family\n\n of ransomware involved in targeted attacks against Japanese companies. We suspect\n\n that the ONI ransomware was used as a wiper to cover up an elaborate hacking operation. These targeted attacks lasted between three to nine months and all ended\n\n with an attempt to encrypt hundreds of machines at once. Forensic artifacts found on\n\n the compromised machines show that the attackers made a significant attempt to cover\n their operation. \n\n During our investigation, Cybereason discovered a new bootkit ransomware dubbed “MBR-ONI” used by the same threat actor in conjunction with ONI. This bootkit\n ransomware is based on DiskCryptor, a legitimate disk encryption utility, the very same tool whose code was found in the recently discovered Bad Rabbit ransomware. \n\n While the ransomware discussed in this report is specific to Japan, targeted attacks\n involving ransomware/wipers have been on the rise across the world in recent years, which is why we’re releasing this research. We believe that sharing information on this\n operation can benefit the entire security community.\n\n## ONI and MBR-ONI\n\n\n-----\n\n##### suspicions were raised that it might be involved in targeted attacks, no further context was provided at the time. Cybereason researchers, though, were able to link ONI to\n\n targeted attacks in Japan and provide more context around the ransomware. \n\n In addition, Cybereason discovered MBR-ONI, a bootkit ransomware, which modifies the MBR and encrypts disk partitions. We concluded that both ONI and MBR-ONI stem\n\n from the same threat actor since they were used in conjunction in the same targeted attacks and their ransom note contains the same email address.\n\n Screenshot of ransom-note taken from a machine infected with MBR-ONI:\n\n Screenshot of ransom-note taken from a machine infected with ONI:\n\n# Autopsy of ONI targeted attacks\n\n##### Cybereason Japan analyzed a few instances of attacks that used the ONI ransomware against Japanese companies across different industries. These attacks share a very\n\n\n-----\n\n##### 1. Penetration vector: Spear-phishing emails carrying weaponized Office documents, which ultimately drop the Ammyy Admin RAT.\n\n 2. Reconnaissance, credential theft and lateral movement: Using the Ammyy Admin RAT and other hacking tools, the attackers mapped out the internal networks, harvested credentials and moved laterally, ultimately compromising critical assets, including the\n\n domain controller (DC), to gain full control over the network.\n\n 3. Scorched earth policy: Log deletion and distribution of ONI via rogue GPO: During the attack’s last stage, a rogue group policy was created and pushed across the organization. Using autorun persistence, the group policy would fetch a batch script from the DC server, which would wipe Windows’ event logs clean in attempt to cover\n\n the attackers’ tracks and avoid log-based detection. In addition, the ONI binary file was also copied from the DC and executed, encrypting a large array of files.\n\n 4. MBR-ONI used against critical assets: While ONI was used against most of the endpoints, MBR-ONI was used on only a handful of endpoints. These endpoints were critical assets such as an AD server and file servers. We suspect that MBR-ONI was\n\n used as a wiper to conceal the operation’s true motive.\n\n### Penetration vector: Spear-phishing drops Ammyy Admin RAT\n\n##### The penetration vector used in the observed attacks consisted of spear-phishing emails that carried password-protected zip files containing weaponized Office documents.\n\n\n-----\n\n##### Once the victims extracted the zip file and opened the document, they were lured into enabling a macro. That launched a VBScript that downloaded and executed the Ammyy Admin RAT.\n\n Once installed, Ammyy Admin runs as a service (“Time service”) with SYSTEM privileges:\n\n\n-----\n\n##### The hash of the Ammyy Admin binary is unknown to VirusTotal and other threat intel engines (6abfb50b0657e87d8aec594ccc95f2e1b13f355e):\n\n The earliest indication of the Ammyy Admin RAT on the compromised environment dates back to December 2016. The RAT was used in some instances until September 2017. This indicates that the attack were carried over a period at least nine months:\n\n\n-----\n\n##### Ammyy Admin is a legitimate remote administration tool that attackers have hijacked\n\n and used for malicious activity, including attacks on financial institutions by a threat actor believed to be related to the Carbanak group. Additionally, Ammyy Admin was involved in a supply-chain attack. In that incident, threat actors compromised Ammyy Admin’s website and replaced the installer with a trojanized version of the RAT.\n\n### Lateral movement and DC takeover\n\n##### Once the attackers gained foothold in the victim’s environment, their next step was to compromise critical assets including file servers, application servers and the DC. The attackers managed to move laterally within the internal network through shared network\n\n drives and other techniques. \n\n We suspect that the threat actor used the NSA-leaked exploit EternalBlue, in conjunction with other tools to spread throughout the network. Due to the data corruption and robust log wiping, it cannot be confirmed with absolute certainty, however, it was found that the MS17-010 security update (released in March 2017) was not installed on the compromised machines at the time that attacks took place (July- September 2017). As shown in the example below, SMBv1 was still enabled across the compromised environments:\n\n\n-----\n\n##### ONI shares a lot of its code with GlobeImposter ransomware variants. While GlobeImposter variants are not known to spread via Eternal Blue, it has been reported that GlobeImposter was also used in targeted attacks that involved EternalBlue and other NSA-leaked exploits in the past.\n\n Eventually, the attackers gained domain admin and successfully compromised the DC and Active Directory servers, which enabled them to obtain full control over the network.\n\n### Covering tracks: Logs deletion and ONI distribution via Group Policy Scripts\n\n##### Using GPO, the attackers deployed “wiping” scripts that resided on the compromised DC. The purpose of those scripts was to delete event and security logs from the compromised machines and distribute the ONI ransomware as the last step of the operation.\n\n Autorun persistence of the group policy scripts used in the attack:\n\n Registry Value Purpose Entry\n\n\n-----\n\n##### Domain Policy\n\n\n\n##### [REDACTED].local\\Policies\\ {REDACTED}\\Machine\\Script\\Startup\\test.bat\n\n\n##### the DC 2. Copy batch called\n “clean.bat” / “cleaner.bat” script from the DC 3. Batch file execution deletes\n\n Windows’ event logs. 4. Executes ONI\n\n\n##### The content of the “clean.bat” clearly indicates the deletion of more than 460 logs using the wevtutil command along with the “cl” flag, which clears events from the specified event log:\n\n\n-----\n\n##### Observed execution of test.bat script spawning xcopy.exe to copy ONI:\n\n ONI (“srvupd.exe”, in some instances named “oni.exe”) is copied from the compromised DC:\n\n\n-----\n\n## ONI ransomware observations\n\n##### ONI received its name based on the file extension that it appends to the files it encrypts.\n The name ONI can mean “devil” in Japanese (鬼), and it also appears in the email address found in its ransom note. “Oninoy0ru” translates into “Night of the Devil” in Japanese (鬼の夜). Cybereason observed other versions of ONI’s ransom note that contained other email addresses whose username also included the string “ONI”.\n\n ONI seems to share code with GlobeImposter ransomware variants. Some routines are identical, as shown below:\n\n Example of one of the identified ONI ransomware samples\n\n SHA-1 hash: b7d33751d118fab6aedabfdf6a4ddf627e6cab02\n\n E l f d i il it\n\n\n-----\n\n##### GlobeImposter ransomware variant\n\n SHA-1 hash: 4a850136af93b9918fb4290a2bf665c4f28201d1\n\n Example of code similarity\n\n Aside from encrypting files on the infected machines, ONI can encrypt files on removable media and network drives, as seen below:\n\n\n-----\n\n##### Interestingly, the resources section found in ONI’s PE file shows Russian language traces.\n\n While this type of evidence could have been left there on purpose by the attackers as decoy, it can also suggest that the attacks were carried out by Russian speakers or, at\n\n the very least, that the ransomware was written by Russian speakers.\n\n## MBR-ONI: Under the hood\n\n##### While most of the infected machines were infected with ONI, MBR-ONI has been observed only on a handful of machines. These machines consisted of the Active\n\n Directory server as well as other carefully selected critical assets. The machines infected by MBR-ONI all exhibited the same ransom note, which contained the same\n\n message and same ID for all the infected machines, as opposed to ONI, which generates a unique ID per machine:\n\n\n-----\n\n##### When examining the MBR of the infected machine, it is clear that the MBR-ONI modified the original MBR, as the first instructions consist of the familiar NOP-NOP\n JMP, also used by DiskCryptor, which can be found on GitHub:\n\n Further analysis of MBR-ONI confirms that the attackers used a modified version of a legitimate open-source tool called DiskCryptor. The tool, according to DiskCryptor’s\n\n website, “is an open encryption solution that offers encryption of all disk partitions, including the system partition.”\n\n For example, when comparing the strings found in the MBR-ONI bootkit ransomware\n\n with the ones of the publicly-available DiskCryptor, the resemblance is quite evident, as this screenshot shows:\n\n\n-----\n\n##### https://github.com/legiar/diskcryptor/blob/master/boot/boot_load.c\n\n\n##### Unlike the notorious wiper NotPetya, MBR-ONI’s code does allow for the recovery of the encrypted disk, given that the attackers supply the right decryption key. From a\n\n technical perspective, we classify this specimen as ransomware rather than a wiper. That being said, we suspect that the attackers never intended to provide recovery for\n\n the encrypted machines. Instead, the program was meant to be used as a wiper to cover the attackers’ footprints and conceal the attack’s motive.\n\n The legitimate encryption utility, DiskCryptor, was recently abused by the threat actors\n\n behind Bad Rabbit. Another example of a well-known ransomware that was also used in targeted attacks is the Mamba / HDDCryptor ransomware, which also uses\n\n DiskCryptor’s open-source code. \n\n This example demonstrates the fine line between a legitimate disk encryption tool and malware. How the tool is implemented changes its original purpose and gives the tool a\n\n different context, such as a bootkit ransomware or even a destructive wiper.\n\n## Ransomware or wiper?\n\n##### Classifying ONI and MBR-ONI merely as ransomware leaves some open questions\n\n\n-----\n\n##### by destroying data instead of a ransomware attack that encrypted files. \n\n\n##### There are a couple of points worth raising in the context of these attacks: \n\n 1. Why use two types of ransomware in the same operation?\n\n 2. Why did the attackers use MBR-ONI only on a few machines, while ONI was used on the majority of the infected machines?\n\n 3. Why does ONI use unique IDs on each machine while MBR-ONI uses the same ID\n\n across all the machines it infects? This inconsistency between the two ransomware programs is very peculiar. It is very unlikely that an attacker would not be interested in\n\n distinguishing between infected machines. That also supports our suspicion that there was never an intention to recover the encrypted disk partitions.\n\n 4. In addition to the ransomware, the attackers used a batch file whose purpose was to\n\n thoroughly clear more than 460 Windows’ event logs. This robust log-wiping action shows that the attackers wanted to destroy evidence that could potentially lead to the\n\n discovery of their methods as well as the motive behind the attack.\n\n 5. Why spend three to nine months in the environment without a sure plan to make money? From a cost-effectiveness perspective, there is no guarantee the attacker will\n\n be rewarded with a ransom payment at the end of this long operation, despite sustaining an active operation and risking detection.\n\n# Conclusion\n\n##### In this blog, we showed that ONI and the newly discovered MBR-ONI stem from the\n\n same threat actor, shed light on the threat actor’s modus operandi and gave context that can better explain these supposed ransomware attacks. While both ONI and MBR\n ONI clearly exhibit all the characteristics of ransomware, we provided arguments that support our suspicion that the attackers might have intended to use them as wipers\n\n rather than ransomware. We do not dismiss the possibility that financial gain was the motive behind these attacks. However, given the nature of the attacks and the profile of\n\n the targeted companies, other motives should not be dismissed lightly. \n\n While the ONI attacks presented in this blog are specific to Japan, we believe they also\n\n point to a concerning global trend. Using ransomware in targeted hacking operations is\n\n\n-----\n\n##### ransomware and wipers used in targeted attacks carried out by cybercriminals and nation-states. Examples of these ransomware and/or wipers include: PetWrap, Mamba,\n\n SamSam, NotPetya, Shamoon and Bad Rabbit. \n\n We also discussed how threat actors abuse legitimate tools like DiskCryptor and\n\n Ammyy Admin and use them for malicious purposes. This further emphasizes the fine line between publicly available tools and malware. In many cases, this distinction can\n\n only be determined by figuring out the operator’s intent. For instance, MBR-ONI borrows a large portion of its code from DiskCryptor. With some code modification, a\n\n legitimate disk encryption utility can be turned into ransomware or even a destructive wiper.\n\n Research by: Assaf Dahan, Kohei Fujikawa, Tomonori Sawamura.\n\n Special thanks to Uri Sternfeld, Philip Tsukerman and Niv Yona for their insights.\n\n Learn how Cybereason can help your security team gain deeper attack insight while\n\n significantly reducing analysis times.\n\n\n**[GET A DEMO](https://cta-service-cms2.hubspot.com/ctas/v2/public/cs/c/?cta_guid=8a2dff6e-c987-4e14-9fd4-2a9944d5e3f2&placement_guid=16910f9d-ec9f-479f-9ee5-ace38d78fa80&portal_id=3354902&redirect_url=APefjpF4eVVfT4Ygad8TRGuKzXpew8ZTY2Mzyl1UF8_TX9B_4KOVaDNPrzte47lhxyd0YaH9NXYqes2yNNjFJ4Ge4Ilsok2se4whGJif9nC6kaTHBReGRaF253-QiYrOT7_B5wFxQI57&hsutk=f80b1c6200b7b92baacaf581bc6c9499&canon=https%3A%2F%2Fwww.cybereason.com%2Fblog%2Fnight-of-the-devil-ransomware-or-wiper-a-look-into-targeted-attacks-in-japan&click=1c256b54-f0ce-4c0a-9c2c-fe63fcecd639&utm_referrer=https%3A%2F%2Ft.co%2FRHI69yp09b&pageId=5402931240&__hstc=85683782.f80b1c6200b7b92baacaf581bc6c9499.1509593769427.1509593769427.1509593769427.1&__hssc=85683782.1.1509593769427&__hsfp=3889571807)**\n\n\n[ransomware, cyber attack, Cyber Security, Cybereason, wiper, Oni, MBR-Oni](https://www.cybereason.com/blog/topic/ransomware)\n\n#### ← See all blog posts\n\n[日本語](https://www.cybereason.co.jp/) [Contact](https://www.cybereason.com/contact-us) [Blog](https://www.cybereason.com/blog) [Labs](https://www.cybereason.com/labs-blog)\n\n**[Products](https://www.cybereason.com/hunting-platform/)**\n\n[DEEP Detect & Respond](https://www.cybereason.com/deep-detect-and-respond/)\n\n[DEEP Prevent](https://www.cybereason.com/deep-prevent/)\n\n\n-----\n\n[Demos](https://www.cybereason.com/resources-demos/)\n\n\n**[Services](https://www.cybereason.com/services-main/)**\n\n[Deep Monitoring](https://www.cybereason.com/deep-monitoring/)\n\n[Deep Hunting](https://www.cybereason.com/deep-hunting/)\n\n[Deep Incident Response](https://www.cybereason.com/deep-incident-response/)\n\n**[Insights](https://www.cybereason.com/research/)**\n\n[Case Studies](https://www.cybereason.com/case-studies/)\n\n[White Papers](https://www.cybereason.com/whitepapers/)\n\n[Research](https://www.cybereason.com/research/)\n\n[Videos](https://www.cybereason.com/videos/)\n\n[Webinars](https://www.cybereason.com/webinars/)\n\n**[Company](https://www.cybereason.com/our-company/)**\n\n[Who We Are](https://www.cybereason.com/our-company/)\n\n[Management](https://www.cybereason.com/management/)\n\n[News](https://www.cybereason.com/resources-news/)\n\n[Press Releases](https://www.cybereason.com/press-release/)\n\n[Awards](https://www.cybereason.com/awards/)\n\n[Careers](https://www.cybereason.com/careers/)\n\n**[Partners](https://hi.cybereason.com/partnerships)**\n\n[Become a Partner](https://hi.cybereason.com/partnerships)\n\nSubscribe to the Blog\n\nS U B M I T\n\n**[RansomFree](https://ransomfree.cybereason.com/)**\n\n[Free ransomware protection for your PC](https://ransomfree.cybereason.com/)\n\n[NotPeyta Ransomware Protection](https://ransomfree.cybereason.com/)\n\n© 2017 Cybereason Inc. All rights reserved\n\n\nSubscribe to the Blog\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2017/2017.10.31.MBR-ONI.Japan/Night_of_the_Devil.pdf"
    ],
    "report_names": [
        "Night_of_the_Devil"
    ],
    "threat_actors": [
        {
            "id": "c9617bb6-45c8-495e-9759-2177e61a8e91",
            "created_at": "2022-10-25T15:50:23.405039Z",
            "updated_at": "2025-03-27T02:00:55.462193Z",
            "deleted_at": null,
            "main_name": "Carbanak",
            "aliases": [
                "Carbanak",
                "Anunak"
            ],
            "source_name": "MITRE:Carbanak",
            "tools": [
                "Carbanak",
                "Mimikatz",
                "PsExec",
                "netsh"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3b046db2-f60e-49ae-8e16-0cf82a4be6fb",
            "created_at": "2022-10-25T16:07:23.427162Z",
            "updated_at": "2025-03-27T02:02:09.79482Z",
            "deleted_at": null,
            "main_name": "Buhtrap",
            "aliases": [
                "Buhtrap",
                "Operation TwoBee",
                "Ratopak Spider",
                "UAC-0008"
            ],
            "source_name": "ETDA:Buhtrap",
            "tools": [
                "AmmyyRAT",
                "Buhtrap",
                "CottonCastle",
                "FlawedAmmyy",
                "NSIS",
                "Niteris EK",
                "Nullsoft Scriptable Install System",
                "Ratopak"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "dcba8e2b-93e0-4d6e-a15f-5c44faebc3b1",
            "created_at": "2022-10-25T16:07:23.816991Z",
            "updated_at": "2025-03-27T02:02:09.991944Z",
            "deleted_at": null,
            "main_name": "Lurk",
            "aliases": [],
            "source_name": "ETDA:Lurk",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f4f16213-7a22-4527-aecb-b964c64c2c46",
            "created_at": "2024-06-19T02:03:08.090932Z",
            "updated_at": "2025-03-27T02:05:17.387119Z",
            "deleted_at": null,
            "main_name": "GOLD NIAGARA",
            "aliases": [
                "Carbanak",
                "Carbon Spider ",
                "FIN7 ",
                "Navigator ",
                "Sangria Tempest ",
                "TelePort Crew ",
                "Calcium "
            ],
            "source_name": "Secureworks:GOLD NIAGARA",
            "tools": [
                " Carbanak",
                " Cobalt Strike",
                " DICELOADER",
                " DRIFTPIN",
                " GGLDR",
                " GRIFFON",
                " JSSLoader",
                " Meterpreter",
                " OFFTRACK",
                " PILLOWMINT",
                " POWERTRASH",
                " SUPERSOFT",
                " TAKEOUT",
                " TinyMet",
                "Bateleur"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "bb8702c5-52ac-4359-8409-998a7cc3eeaf",
            "created_at": "2023-01-06T13:46:38.405479Z",
            "updated_at": "2025-03-27T02:00:02.82533Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "JokerStash",
                "ATK32",
                "G0046",
                "Coreid",
                "Carbanak",
                "Sangria Tempest",
                "CARBON SPIDER",
                "GOLD NIAGARA",
                "G0008",
                "ELBRUS",
                "Carbon Spider"
            ],
            "source_name": "MISPGALAXY:FIN7",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ed3810b7-141a-4ed0-8a01-6a972b80458d",
            "created_at": "2022-10-25T16:07:23.443259Z",
            "updated_at": "2025-03-27T02:02:09.801771Z",
            "deleted_at": null,
            "main_name": "Carbanak",
            "aliases": [
                "Anunak",
                "Carbanak",
                "Carbon Spider",
                "ELBRUS",
                "Gold Waterfall",
                "Sangria Tempest"
            ],
            "source_name": "ETDA:Carbanak",
            "tools": [
                "AVE_MARIA",
                "Agentemis",
                "AmmyyRAT",
                "Antak",
                "Anunak",
                "Ave Maria",
                "AveMariaRAT",
                "BABYMETAL",
                "BIRDDOG",
                "Backdoor Batel",
                "Batel",
                "Bateleur",
                "BlackMatter",
                "Boostwrite",
                "Cain & Abel",
                "Carbanak",
                "Cl0p",
                "Cobalt Strike",
                "CobaltStrike",
                "DNSMessenger",
                "DNSRat",
                "DNSbot",
                "DRIFTPIN",
                "DarkSide",
                "FOXGRABBER",
                "FlawedAmmyy",
                "HALFBAKED",
                "JS Flash",
                "KLRD",
                "MBR Eraser",
                "Mimikatz",
                "Nadrac",
                "Odinaff",
                "POWERPIPE",
                "POWERSOURCE",
                "PsExec",
                "SQLRAT",
                "Sekur",
                "Sekur RAT",
                "SocksBot",
                "SoftPerfect Network Scanner",
                "Spy.Agent.ORM",
                "TEXTMATE",
                "TeamViewer",
                "TiniMet",
                "TinyMet",
                "Toshliph",
                "VB Flash",
                "WARPRISM",
                "avemaria",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716503,
    "ts_updated_at": 1743041817,
    "ts_creation_date": 1509596266,
    "ts_modification_date": 1509596266,
    "files": {
        "pdf": "https://archive.orkl.eu/c88964f86dee3dddad544afaa958f19d5b078700.pdf",
        "text": "https://archive.orkl.eu/c88964f86dee3dddad544afaa958f19d5b078700.txt",
        "img": "https://archive.orkl.eu/c88964f86dee3dddad544afaa958f19d5b078700.jpg"
    }
}