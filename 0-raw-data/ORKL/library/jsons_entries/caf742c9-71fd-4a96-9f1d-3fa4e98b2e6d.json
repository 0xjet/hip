{
    "id": "caf742c9-71fd-4a96-9f1d-3fa4e98b2e6d",
    "created_at": "2023-01-12T14:59:44.351856Z",
    "updated_at": "2025-03-27T02:11:55.110089Z",
    "deleted_at": null,
    "sha1_hash": "af58d377ac2b6a4eda39d9e31d89d9674bdbd0ad",
    "title": "2018-08-17 - Prince of Persia- The Sands of Foudre",
    "authors": "",
    "file_creation_date": "2022-05-28T18:28:47Z",
    "file_modification_date": "2022-05-28T18:28:47Z",
    "file_size": 2554748,
    "plain_text": "# Prince of Persia: The Sands of Foudre\n\n**intezer.com/prince-of-persia-the-sands-of-foudre/**\n\nWritten by Jay Rosenberg - 17 August 2018\n\n## Get Free Account\n\nJoin Now\n\n**Introduction**\n\n\nAugust 17, 2018\n\n\nIn the past couple years, Palo Alto Networks reported on the “Prince of Persia” malware\ncampaign which is believed to be of Iranian origin and ongoing for more than 10 years. The\n[original research, published in 2016, called the malware Infy and their second report,](https://researchcenter.paloaltonetworks.com/2016/05/prince-of-persia-infy-malware-active-in-decade-of-targeted-attacks/)\n[published in 2017, named the upgraded malware Foudre. The name “Foudre” comes from a](https://researchcenter.paloaltonetworks.com/2017/08/unit42-prince-persia-ride-lightning-infy-returns-foudre/)\nstring in the binary used to check if the computer is already infected. At the time of their\nblog post, Palo Alto Networks stated the version of Foudre they observed were versions 1\nand 2. We have found new evidence of the Prince of Persia campaign active by finding a\nnew version of the Foudre malware, version 8.\n\n\n-----\n\nIn this blog post, we are only going to focus on the new, unique, interesting features of the\nnew version of Foudre, and its related campaign\n\n(Internal version name of Foudre v8)\n\n**No to The Forced Hijab**\n\nSimilarly to the samples noted in previous reports, this new malware also comes packaged\nin a WinRAR SFX archive including multiple malicious binaries and a media file. The media\nfile in this case is a video in the MP4 format showing a woman in Iran walking around and at\nthe end pulling off her hijab. In the video, there is text written in Farsi with a hashtag, ﺑﻨﻪ ﺑﻪ\nﺣﺠﺎب اﺟﺒﺎری#, literally translating to “no to the forced hijab.” This hashtag is in reference to\nprotesters in Iran who are protesting the mandatory use of the hijab for women and the\nvideo is meant to distract the victim while the Foudre malware gets installed in the\nbackground.\n\n\n-----\n\n(Screenshot from the video bundled in the malware)\n\nFoudre is a remote access tool and has the ability to remotely execute commands, steal\ninformation about the infected target (such as keystrokes, process information, etc), and\nauto-update itself. Most of the code and functionality from the previous versions of Foudre\nand Infy was reused and can be read about in the reports linked above, so we are only\ngoing to focus on the new, unique, interesting features and the linkage of code reuse from\nprevious versions.\n\n**Code Reuse**\n\n[After uploading the WinRAR SFX to Intezer Analyze™, the files inside were statically](https://analyze.intezer.com/#/analyze)\nextracted which reveals 3 binaries, a lockbox3 signature, and the video mentioned above.\n\n[(https://analyze.intezer.com/#/analyses/115debab-ca0a-423a-983a-c40c7d751109)](https://analyze.intezer.com/#/analyses/115debab-ca0a-423a-983a-c40c7d751109)\n\nUsing our new Show Code feature, we can see code overlapping with Foudre and Infy.\n\n\n-----\n\n(Code overlap with Foudre)\n\n(Code overlap with Infy)\n\n**New Features/Changes**\n\nFirst of all, the main binary of the upgraded Foudre malware is mostly undetected on\nVirusTotal with only 3/67 detections.\n\n\n-----\n\n[(VirusTotal)](https://www.virustotal.com/#/file/c7279a32329ebb1ab5c1cdbfbddb5a167e1505340c3ca72e837a222ff92665a6/detection)\n\nIn the latest version of Foudre, there are 2 modules. One of the modules (i7234.dll) has the\nexport “D1” and the other module (d388) exports “D2” as a function. We are going to refer to\nthe different binaries based on their exports, D1 and D2. The third binary never gets\nlaunched and is still under investigation. We will release more details about it on a further\ndate. The WinRAR SFX and D1 module only get executed once. The following\nfeatures/changes are spread across the WinRAR SFX, D1, and D2:\n\nWinRAR SFX Dropper\n\n1. WinRAR SFX has icon of girl with hijab from video\n2. Extracts files\n3. Launches D1 ( i7234.dll) with rundll32 and executes export D1\n\nD1\n\n1. D1 executes the mp4 file\n2. Checks if finds a window “TNRRDPKE2” means it’s already running\n3. Copies D2 and key to %APPDATA% with filenames a.n and p.k and creates a shortcut\n\nin the folder named “an.lnk” C:\\WINDOWS\\system32\\rundll32.exe a.n D2 838238125\n\n\n-----\n\n4. Deletes these files from TEMP folder\n5. Stores name of D2 (a.n) in HKEY_CURRENT_USER\\Software\\temp in key called\n\n“ran2”\n6. Checks HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\n\nfor SnailDriver\n7. Creates autorun for an.lnk\n8. Checks for %PROGRAMFILES%\\Kaspersky Lab\n9. Launches D2 with rundll32 “C:\\WINDOWS\\system32\\rundll32.exe a.n D2 838238125”\n\nD2 has mostly the same features as reported in the older versions of Foudre but this table\nshows the main changes:\n\nFoudre Version 2 Version 8\n\n\nBrowser\nStealer\nSupport\n\nDomain\nGeneration\nAlgorithm\n\nVirusTotal\nDetections\n\nString\nEncryption\n\nAlready\nRunning\nDetection\nString\n\n\nMicrosoft Edge, Internet\nExplorer, Mozilla Firefox and,\nGoogle Chrome\n\n\nOpera, Microsoft Edge, Internet\nExplorer, Mozilla Firefox and,\nGoogle Chrome\n\n\nYes Yes, different (see below)\n\n41/66 3/67\n\nYes No\n\nTNRRDPKE TNRRDPKE2\n\n\n**Domain Generation Algorithm (DGA)**\n\nThe DGA used by version 8 of Foudre has only changed slightly from the previous versions.\n\nIn the previous versions, the DGA algorithm was calculated by the following algorithm\n(credit to [Esmid Idrizovic):](https://twitter.com/xedi25)\n\nToHex(CRC32(“NRV1” + year + month + week_number)) + (“.space”|”.net”|”.top”)\n\nThere are two minor differences now when calculating the C2. NRV1 was replaced with\nNRTV1 and .dynu.net was added as suffix to the domain making the algorithm now:\n\nToHex(CRC32(“NRTV1” + year + month + week_number)) +\n(“.space”|”.net”|”.top”|”.dynu.net”)\n\n\n-----\n\nA few of the calculated domains were added to the bottom of the report in the IoCs section.\nThe domains up to week of September 9, 2018 (week 35) have been registered in Panama\nand resolve to the same IP address 185[.]61[.]154[.]26. The oldest domain using this\nalgorithm we could find that was registered was registered for the week of November 5,\n2017.\n\n**Conclusion**\n\nDue to the content of the video and the information from the reports on previous versions of\nFoudre, we believe the targets are mostly Iranian citizens. We have registered some of the\nfuture generated domains to prevent the attack, and will update the post with information in\nregards to the infected victims.\n\n**IoCs**\n\nFiles:\n\nWinRAR SFX\nc38533b85e4750e6f649cc407a50031de0984a8f3d5b90600824915433a5e218\n\nD1 DLL a02ce6768662ef250d248c158f26129dd4dfab30845d07962fbfe7aa19b16db9\n\nD2 DLL c7279a32329ebb1ab5c1cdbfbddb5a167e1505340c3ca72e837a222ff92665a6\n\nUnknown Binary\ncef161a220e019acc9ae79924a477c64aac2d6cc04126bb3f4a9f8452515f40f\n\nMP4 dbed2ca2e9c53dd72c3ed3ce60e603c6c91c80152f924d97d8514781e6d9e26f\n\nlockbox3 signature\nd2645d16e869addd099727c3c58438c2f6935d92c00f9e4b237ef498de1dad87\n\nC&Cs:\n\n\n-----\n\n185[.]61[.]154.26\n\nns1[.]cf75d89b[.]space\n\nns2[.]cf75d89b[.]space\n\nWeek 32 (Aug 5) – fe19f97f[.]space\n\nWeek 33 (Aug 12) – 891ec9e9[.]space\n\nWeek 34 (Sept 2) – 177a5c4a[.]space\n\nWeek 35 (Sept 9) – 607d6cdc[.]space\n\nWeek 36 (Sept 16) – f8b65751[.]space\n\nWeek 37 (Sept 23) – 8fb167c7[.]space\n\nWeek 38 (Sept 30) – 1f0e7a56[.]space\n\nWeek 39 (Oct 7) – 68094ac0[.]space\n\nWeek 40 (Oct 14) – 1d8bfc20[.]space\n\n**Jay Rosenberg**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-08-17 - Prince of Persia- The Sands of Foudre.pdf"
    ],
    "report_names": [
        "2018-08-17 - Prince of Persia- The Sands of Foudre.pdf"
    ],
    "threat_actors": [
        {
            "id": "59c9f31b-e032-44b9-bf3b-4f2cb3d17e39",
            "created_at": "2022-10-25T16:07:23.734244Z",
            "updated_at": "2025-03-27T02:02:09.952685Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "APT-C-07",
                "Infy",
                "Operation Mermaid",
                "Prince of Persia"
            ],
            "source_name": "ETDA:Infy",
            "tools": [
                "Foudre",
                "Infy",
                "Tonnerre"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f763fd1f-f697-40eb-a082-df6fd3d13cb1",
            "created_at": "2023-01-06T13:46:38.561288Z",
            "updated_at": "2025-03-27T02:00:02.861874Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "Operation Mermaid",
                "Prince of Persia",
                "Foudre"
            ],
            "source_name": "MISPGALAXY:Infy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535584,
    "ts_updated_at": 1743041515,
    "ts_creation_date": 1653762527,
    "ts_modification_date": 1653762527,
    "files": {
        "pdf": "https://archive.orkl.eu/af58d377ac2b6a4eda39d9e31d89d9674bdbd0ad.pdf",
        "text": "https://archive.orkl.eu/af58d377ac2b6a4eda39d9e31d89d9674bdbd0ad.txt",
        "img": "https://archive.orkl.eu/af58d377ac2b6a4eda39d9e31d89d9674bdbd0ad.jpg"
    }
}