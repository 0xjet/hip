{
    "id": "45ceed2e-026a-45b7-a8be-3187f65960bf",
    "created_at": "2023-01-12T15:04:29.788471Z",
    "updated_at": "2025-03-27T02:06:02.728007Z",
    "deleted_at": null,
    "sha1_hash": "96c0ec5351c7c10c8db0b9bf0f769a7e3571919f",
    "title": "2013-03-30 - Fooled by Andromeda",
    "authors": "",
    "file_creation_date": "2022-05-25T14:19:15Z",
    "file_modification_date": "2022-05-25T14:19:15Z",
    "file_size": 222888,
    "plain_text": "# Fooled by Andromeda\n\n**0xebfe.net/blog/2013/03/30/fooled-by-andromeda**\n\n0xEBFE\n\nThere is a malware with name “Andromeda”, that recently started to spread again.\n\nLet’s listen to the experts from Trend Micro:\n\n[Full blog entry](http://blog.trendmicro.com/trendlabs-security-intelligence/andromeda-botnet-resurfaces/)\n\nHm, it is strange behavior for mass-spreading malware, isn’t it? Someone should explain\nwhat’s really going on - and this “someone” will be me :)\n\nAndromeda has several anti-debugging or anti-reversing tricks:\n\n\n-----\n\nIt checks the names of processes by comparing CRC32-hashes:\n\nIt checks for Sandboxie dll:\n\n\n-----\n\nIt checks 0 -value in registry key\nHKLM\\SYSTEM\\CurrentControlSet\\Services\\Disk\\Enum for “vmwa”, “vbox”,\n“qemu”-strings. Obviously, this is an anti-vm trick:\n\nAnd finally it checks the elapsed time between “rdtsc”-instructions:\n\nPassing all these checks makes Andromeda avoid address 0x00401E8C, where an\nACCESS_VIOLATION exception would occur. If some anti-reversing checks pass, the\npayload is loaded at 0x402413.\n\nThis is what the Andromeda payload header structure looks like:\n\n\n-----\n\npayload_header.cpp\n```\n   #pragma pack(push, 1)\n   typedef struct _ANDROMEDA_PAYLOAD\n   {\n     BYTE rc4Key[16];       // 0x000\n     DWORD encryptedSize;     // 0x010\n     DWORD unknown;        // 0x014 probably\n   CRC32\n     DWORD unpackedSize;     // 0x018\n     DWORD offsetEntryPoint;   // 0x01C\n     DWORD offsetRelocAndImport; // 0x020\n     DWORD relocsAndImportSize;  // 0x024\n     BYTE encryptedPayload[];   // 0x028\n   } ANDROMEDA_PAYLOAD;\n   #pragma pack(pop, 1)\n\n```\nThis is the header of default-payload at 0x402413 address:\n\nAndromeda uses RC4 for decryption and aPLib-library for decompression. I made an\nIDAPython script that decrypts the payload and recovers the relocations and imports. My\n[script is based on the great kabopan scripts by Ange Albertini.](http://code.google.com/p/kabopan/)\n\n[You can find my script here: https://github.com/0xEBFE/Andromeda-payload](https://github.com/0xEBFE/Andromeda-payload)\n\nI decrypted the payload at 0x402413 and it does several operations:\n\n\n-----\n\nCopies itself to %ALLUSERSPROFILE%\\svchost.exe\nWrites itself to “SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run” registry key as\n“SunJavaUpdateSched”.\n\nAnd also (sorry for the big picture, but you have to see this):\n\n\n-----\n\n-----\n\nIn this screenshot you can see that Andromeda:\n\nOpens port 8000 — ✔ check :)\nRuns new instance of “cmd.exe” — ✔ check :)\n\nIt does not have any code to process commands from remote computer, but since standard\nhandles (StdInput and StdOutput) are redirected to socket it’s possible to execute commands\nremotely. Obviously it’s a fake payload - someone got fooled :)\n\nLet’s check the SEH-handler of Andromeda:\n\nAs you can see Andromeda basically changes execution flow when an exception occurs at the\nspecified address Andromeda passes the execution flow to the “load_payload”-function\nwith address 0x00402058 as argument. In this real payload, the malware injects itself to\n“msiexec.exe” or “svchost.exe”.\n\nIf you check more closely you can spot a third payload that runs in “msiexec.exe” or\n“svchost.exe”:\n\n\n-----\n\n[This payload contains the C&C url. However this url is also a fake, thanks to @aaSSfxxx for](https://twitter.com/aaSSfxxx)\npointing me out.\n\nYou might ask the question: “How do cyberterrorists test their cyberweapons if it’s not\npossible to run them in Virtual Machines?”. And the answer is:\n\nAndromeda checks the CRC32 of the %SYSTEMDRIVE% volume name, and if equal to\n**0x20C7DD84 (for example “CKF81X”), the real payload is executed.**\n\n[Thanks to this great forum for supplying the sample: http://www.kernelmode.info/](http://www.kernelmode.info/)\n\nMD5-hash of analyzed sample: 2C1A7509B389858310FFBC72EE64D501\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2013/2013-03-30 - Fooled by Andromeda.pdf"
    ],
    "report_names": [
        "2013-03-30 - Fooled by Andromeda.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535869,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1653488355,
    "ts_modification_date": 1653488355,
    "files": {
        "pdf": "https://archive.orkl.eu/96c0ec5351c7c10c8db0b9bf0f769a7e3571919f.pdf",
        "text": "https://archive.orkl.eu/96c0ec5351c7c10c8db0b9bf0f769a7e3571919f.txt",
        "img": "https://archive.orkl.eu/96c0ec5351c7c10c8db0b9bf0f769a7e3571919f.jpg"
    }
}