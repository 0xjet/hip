{
    "id": "07f4face-bb0a-40d5-a574-c5483ff777e5",
    "created_at": "2023-01-12T15:05:28.926679Z",
    "updated_at": "2025-03-27T02:16:47.021808Z",
    "deleted_at": null,
    "sha1_hash": "4b5db316be6f7cb9d6fdf033f32f2e6a3c45a79c",
    "title": "2020-07-20 - Reverse Engineering the New Mustang Panda PlugX Downloader",
    "authors": "",
    "file_creation_date": "2022-05-28T17:08:03Z",
    "file_modification_date": "2022-05-28T17:08:03Z",
    "file_size": 2743508,
    "plain_text": "# oR10n Labs\n\n**[or10nlabs.tech/reverse-engineering-the-new-mustang-panda-plugx-downloader/](https://or10nlabs.tech/reverse-engineering-the-new-mustang-panda-plugx-downloader/)**\n\nBy oR10n\n\n2020-07-20\n[HomeReverse EngineeringReverse Engineering the New Mustang Panda PlugX Downloader](https://or10nlabs.tech/)\n\n## Reverse Engineering the New Mustang Panda PlugX Downloader\n\nHello everyone! Recently, I came across this tweet by a security researcher known as\n@Arkbird_SOLG mentioning a targeted campaign using a Vatican themed lures by an APT\ngroup known as Mustang Panda.\n\n**Note: For those of you who are not yet familiar with Mustang Panda, security vendors like**\n[Crowdstrike,](https://www.crowdstrike.com/blog/meet-crowdstrikes-adversary-of-the-month-for-june-mustang-panda/) [Avira, and](https://insights.oem.avira.com/new-wave-of-plugx-targets-hong-kong/) [Anomali have released detailed reports about this threat group in the](https://www.anomali.com/blog/china-based-apt-mustang-panda-targets-minority-groups-public-and-private-sector-organizations)\n[past. You can also check some of my earlier blog posts about reverse engineering the loader](https://or10nlabs.tech/reverse-engineering-the-mustang-panda-plugx-loader/)\nand parts of the actual [RAT.](https://or10nlabs.tech/reverse-engineering-the-mustang-panda-plugx-rat-extracting-the-config/)\n\n[TLP:White] The [#APT Mustang Panda group targets the Vatican state with lures. This](https://twitter.com/hashtag/APT?src=hash&ref_src=twsrc%5Etfw)\nuses the TTPs already used for pushing the payloads as vulnerable Word version\n[(office 2007) by side-loading method for execute a dll. pic.twitter.com/48ScU5hfu0](https://t.co/48ScU5hfu0)\n\n[— Arkbird (@Arkbird_SOLG) July 14, 2020](https://twitter.com/Arkbird_SOLG/status/1283000270151208960?ref_src=twsrc%5Etfw)\n\n**[Note: More IOCs related to the campaign are published on this GIthub repo.](https://github.com/StrangerealIntel/DailyIOC/blob/master/2020-07-14/Mustang%20Panda/IOC-Mustang-Panda-2020-07-14.csvhttp://)**\n\nThe tweet mentioned the use of vulnerable version of Microsoft word and a malicious DLL\n[that gets executed via DLL side-loading. Based from this ANY.RUN task posted by](https://app.any.run/tasks/6c5cff49-df4e-4edf-86bc-b68ae8cd507b/)\n@Arkbird_SOLG, it seems like the malicious DLL file has a downloader functionality and\nfetches a .dat file from hxxp://103.85.24[.]190/qum.dat, which in turn leads to the delivery of\nPlugX on the target system.\n\nSo for this post, we will take a look into the inner workings of this new downloader to further\nunderstand how this campaign works.\n\n### Sample Details\n\n**Filename** **MD5** **Description**\n\n\nQUM, IL VATICANO\nDELL’ISLAM.exe\n\n\nceaa5817a65e914aa178b28f12359a46 Legitimate MS\nWord\nexecutable\n\n\n-----\n\n**Filename** **MD5** **Description**\n\nwwlib.dll c6206b8eacabc1dc3578cec2b91c949a Malicious DLL\n\n### Static Analysis\n\n[Tossing the DLL file to DiE, we can immediately note down some important details like:](https://github.com/horsicq/Detect-It-Easy)\n\n– Export Names\n\n– Imports indicating that this sample dynamically resolves addresses of Win32 API functions\nat runtime via LoadLibrary and GetProcAddress\n\n– Presence of PE resources named SCRDLL and SCRDAT\n\n– No packer signature identified and low file entropy which indicates that this file is likely not\npacked\n\n\n-----\n\n-----\n\n-----\n\nChecking the PE resources and extracing SCRDLL shows us that the DLL file contains a\n.docx file as it resource.\n\n\n-----\n\n[Running FLOSS on the sample shows us some interesting strings that indicates potential](https://github.com/fireeye/flare-floss)\ncapabilities such as:\n\n– Communicating via HTTP\n\n– Utilizing the embedded resource\n\n– Executing OS commands\n\n– Loading something in memory for execution\n\n\n-----\n\n```\nwininet\nConnectA\nInternetOpenA\nInternetConnectA\nInternetSetOptionA\nHttpOpenRequestA\nHttpQueryInfoA\nHttpSendRequestA\nInternetCrackUrlA\nInternetCloseHandle\nMozilla/5.0 (compatible; MSIE 6.0; Windows NT 10.1);\nMicrosoft Internet Explorer\nFindResourceA\nLoadResource\nSizeofResource\nLocalAlloc\nLocaRtlDecompressBuffer\nVirtualProtect\nSetFileAttributesA\nShellExecuteA\nlstrlenA\n\n```\nAdditionally, we can see a big blob with repeating pattern of “123456789“.\n\nIf you’ve seen my partial analysis of Mustang Panda’s [PlugX RAT, you can immediately tell](https://or10nlabs.tech/reverse-engineering-the-mustang-panda-plugx-rat-extracting-the-config/)\nthat this probably contains some malware configuration.\n\nNow, to confirm some of this hypothesis we can use the newly released open-source tool by\nFireEye’s FLARE team called [capa. As a short overview, capa recognize capabilities of](https://github.com/fireeye/capa)\nprograms from repetitive patterns of API calls, strings, constants, and other features. In basic\nterms, you can simply run it against a sample and it will tell you the capabilities based on\nrules crafted by RE experts from the FLARE team. The best thing about this is now that it’s\nopen-sourced, anyone can contribute on crafting rules and extending the capability of the\n[capa itself. For a detailed overview of capa, you can check out this blog post released by](https://www.fireeye.com/blog/threat-research/2020/07/capa-automatically-identify-malware-capabilities.html)\nFIreEye.\n\n\n-----\n\nRunning capa on the sample tells us that it:\n– contains obfuscated stackstrings\n– encodes data using XOR\n– contains a resource section\n– link functions at runtime\n\n**Tip: You can utilize -v or -vv argument in capa to see specific offsets where a rule matched.**\nThis is extremely helpful when disassembling and labeling functions with IDA.\n\n### Dynamic Analysis\n\nRunning this sample on a VM with monitoring tools and proper setup will give us a ton of\nuseful information.\n\n**Note: I downloaded hxxp://103.85.24[.]190/qum.dat and placed it on C:\\Python27\\Lib\\site-**\n[packages\\fakenet\\defaultFiles\\ in order to allow Fakenet to serve this file and fully simulate](https://github.com/fireeye/flare-fakenet-ng)\nthe infection chain.\n\n\n-----\n\nAs you can see from the ProcMon and Fakenet outputs above, the infection chain looks like\nthis:\n– Sample drops a .docx file in the current directory. This is the same .docx file in the resource\nsection\n\n– Sample sets the file attributes of the .docx file to HN (Hidden / Not Indexed)\n\n– Sample opens the .docx file. I took a quick look on this .docx file and it seems that this is\njust a decoy file to masquerade the true purpose of the sample\n\n– Sample connects to hxxp://103.85.24[.]190/qum.dat to fetch a next stage payload. This\ndoesn’t seem to create a new file on disk so this is probably executed in memory\n\n– Sample creates qum.exe, hex.dll, and adobeupdate.dat on %temp%. These are PlugX\ncomponents\n\n– Sample executes qum.exe\n\n– qum.exe creates a copy of the PlugX components (AAM Updates.exe, hex.dll, nad\nadobeupdate.dat) to %programdata%\\AAM UpdatesmKD\\\n\n– qum.exe obtains persistence for AAM Updates.exe on the system via the registry Run key\n\n– qum.exe executes AAM Updates.exe\n\n– AAM Updates.exe periodically connects to www.systeminfor[.]com using various ports for\nC2\n\nNow that we have these information, we can use these as a guide while doing in-depth\nanalysis on the sample.\n\n### In-depth Analysis\n\nSince we almost have a full picture of the infection chain, I will breeze through some of the\ntedious parts of the disassembly and focus on important ones.\n\n**Dropping the decoy .docx file**\n\nAs we’ve seen on our earlier analysis, we know that the sample has a decoy .docx file on the\nresource section and is dropped at the current directory upon execution. We also know that\nthe file attribute of decoy .docx file is set to hidden and that the file is opened afterwards to\nfool the users into thinking that executed file is just a normal .docx file. This is achieved via a\nseries of calls to LocalAlloc, FindResourceA, LoadResource, SizeofResource,\n**CreateFile, WriteFile, GetCurrentDirectoryA, SetFileAttribute, and ShellExecuteA. As**\nexpected from Mustang Panda, these Win32 API functions are stored in the sample as\nstackstrings and the address of the functions are dynamically resolved at runtime via\n**LoadLibrary and GetProcAddress**\n\n\n-----\n\nThis is a recurring technique through out the disassembly and the following snippet is a good\nexample:\n\n**Decrypting the malware config**\n\nAfter dropping and opening the decoy .docx file, the sample proceeds to decrypt the malware\nconfiguration. The function responsible for this is called on offset 10002EAD.\n\nAs you can the following values were pushed onto the stack before the function is called – an\noffset unk_10005000, 1002h (4098), an address pointing to the string “123456789”, and\nresult of strlen(“123456789”).These are the adrress for the encrypted config, the length of the\nencrypted config, the address for the key, and the length of key respectively.\n\n\n-----\n\nIf we check unk_10005000, we can see that it points to offset 0 of the .data section.\n\nTaking a closer look on the decryption function (sub_10001450), we can immediately\ndetermine that it implements XOR decryption with multi-byte key.\n\n\n-----\n\n-----\n\n[This is very similar to how the configuration for the PlugX RAT is stored.](https://or10nlabs.tech/reverse-engineering-the-mustang-panda-plugx-rat-extracting-the-config/)\n\nHere’s how the decrypted configuration looks like:\n\nThe URL for the next stage payload is located at offset 0 of the config file. Which allows us to\ndo a quick-and-dirty python script to decrypt the config and extract the URL for the next\nstage payload:\n\n**Fetching the next stage payload**\n\nAfter decrypting the config file, the sample proceeds to fetch the next stage payload. This is\nachieved through a series of calls to InternetCrackUrlA, InternetOpenA,\n**InternetOpenUrlA, HttpQueryInfoA, and InternetReadFileA located in the function**\n**sub_100020F0.**\n\nThe payload is stored directly to a memory buffer initiated through a call to LocalAlloc.\n\n\n-----\n\nThe following is a sample HTTP request used to fetch the next stage payload:\n\nIt’s also worth noting that there is a backup function at sub_10001490 used to fetch the next\nstage payload with a slightly different implementation. One of the glaring difference\nnoticeable in a network packet capture is the use of a different user agent string “Mozilla/5.0\n**(compatible; MSIE 6.0; Windows NT 10.1);” as opposed to “Microsoft Internet**\n**Explorer”**\n\n\n-----\n\n**Decrypting and executing the next stage payload**\n\nAfter successfully fetching the payload, the sample proceeds to decrypt and execute the next\nstage payload. The call to the responsible function (sub_10001110) can be found at offset\n**1000269D.**\n\nLooking closer at the function, we can see a series of call to LocalAlloc,\n**RtlDecompressBuffer, the multi-byte XOR function (sub_10001450), and VirtualProtect**\nprior to a call to the next stage payload.\n\nLooking closer at the call to RtlDecompressBuffer, we can see a PUSH 2 prior to the call\n[which indicates that the next stage payload is compressed with LZNT1 algorithm aside from](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-xca/5655f4a3-6ba4-489b-959f-e1f407c52f15)\nbeing encrypted with XOR using a multi-byte key.\n\n\n-----\n\nLooking closer at the call to the multi-byte XOR function (10001372), we can see that the\nXOR key is actually the first string in the decompressed payload itself.\n\nThis is something similar to what we observed previously, on how the PlugX loader decrypts\nthe encrypted payload.\n\nAgain, we can create a quick-and-dirty python script to automate the decryption of the next\nstage payload.\n\nThe next stage payload is actually never created on disk but is directly loaded into a memory\nbuffer initiated through LocalAlloc.\n\n\n-----\n\nSeveral lines of disassembly after the call to the multi-byte XOR function, we can see a call\nto VirtualProtect to change the access protection of the memory buffer containing the\ndecrypted next stage payload to 0x40 (PAGE_EXECUTE_READWRITE). Immediately after,\na CALL ESI is made to execute it.\n\nFollowing the call on a debugger, we can see a small shellcode right after 0x5a4d which will\neffectively call an Export function on the next stage payload named Loader.\n\nFor the sake of brevity, we won’t go through the next stage payload in detail but it’s\nessentially a dropper responsible for dropping and executing the PlugX components on the\nsystem.The components are actually embedded as PE resources.\n\n\n-----\n\nTo quickly extract the PlugX indicators, we can dump the encrypted payload from the PE\nresource of the dropper and use the scripts mentioned on my earlier blog posts about\n[reverse engineering the loader and](https://or10nlabs.tech/reverse-engineering-the-mustang-panda-plugx-loader/) [extracting the config from the PlugX RAT.](https://or10nlabs.tech/reverse-engineering-the-mustang-panda-plugx-rat-extracting-the-config/)\n```\n$ plugx_decrypt.py plugx_payload\nIdentified Key: 454f4961444d71716941\nPayload decrypted at plugx_payload-decrypted!\n$ plugx_extract_config.py plugx_payload-decrypted\nFile: plugx_payload-decrypted\nXOR key: 313233343536373839\nFolder name: AAM UpdatesmKD\nMutex name: KvcpmvXXtltWtOLoYreI\nC2 servers:\n  www.systeminfor.com:110\n  www.systeminfor.com:995\n  www.systeminfor.com:25\n\n```\nConfig extraction successful!!!\n\n\n-----\n\nThere you have it folks! I really hope this blog post helps the community in further\nunderstanding this malware and the associated TTPs of the Mustang Panda group. As\nalways, thank you for taking the time to read my blog and I hope you can re-share this to the\ncommunity for awareness.\n\n[Tags:Downloader,](https://or10nlabs.tech/tag/downloader/) [Malware,](https://or10nlabs.tech/tag/malware/) [Mustang Panda,](https://or10nlabs.tech/tag/mustang-panda/) [PlugX,](https://or10nlabs.tech/tag/plugx/) [Reverse Engineering](https://or10nlabs.tech/tag/reverse-engineering/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-07-20 - Reverse Engineering the New Mustang Panda PlugX Downloader.pdf"
    ],
    "report_names": [
        "2020-07-20 - Reverse Engineering the New Mustang Panda PlugX Downloader.pdf"
    ],
    "threat_actors": [
        {
            "id": "1691c25f-1aa4-4168-8ce2-7aa8f23246e7",
            "created_at": "2024-06-04T02:03:07.724221Z",
            "updated_at": "2025-03-27T02:05:17.284601Z",
            "deleted_at": null,
            "main_name": "BRONZE PRESIDENT",
            "aliases": [
                "Mustang Panda ",
                "Red Lich ",
                "Temp.Hex ",
                "HoneyMyte "
            ],
            "source_name": "Secureworks:BRONZE PRESIDENT",
            "tools": [
                " Cobalt Strike",
                " ORat",
                " PlugX",
                " RCSession",
                "China Chopper"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b69037ec-2605-4de4-bb32-a20d780a8406",
            "created_at": "2023-01-06T13:46:38.790766Z",
            "updated_at": "2025-03-27T02:00:02.919758Z",
            "deleted_at": null,
            "main_name": "MUSTANG PANDA",
            "aliases": [
                "TEMP.HEX",
                "TA416",
                "TANTALUM",
                "Twill Typhoon",
                "Earth Preta",
                "Stately Taurus",
                "LuminousMoth",
                "Polaris",
                "BRONZE PRESIDENT",
                "HoneyMyte",
                "Red Lich"
            ],
            "source_name": "MISPGALAXY:MUSTANG PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9baa7519-772a-4862-b412-6f0463691b89",
            "created_at": "2022-10-25T15:50:23.354429Z",
            "updated_at": "2025-03-27T02:00:55.45162Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Mustang Panda",
                "TA416",
                "RedDelta",
                "BRONZE PRESIDENT"
            ],
            "source_name": "MITRE:Mustang Panda",
            "tools": [
                "Cobalt Strike",
                "RCSession",
                "NBTscan",
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2ee03999-5432-4a65-a850-c543b4fefc3d",
            "created_at": "2022-10-25T16:07:23.882813Z",
            "updated_at": "2025-03-27T02:02:10.0116Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Bronze President",
                "Camaro Dragon",
                "Earth Preta",
                "HoneyMyte",
                "Mustang Panda",
                "Operation SMUGX",
                "Operation SmugX",
                "PKPLUG",
                "Red Lich",
                "Stately Taurus",
                "TEMP.Hex"
            ],
            "source_name": "ETDA:Mustang Panda",
            "tools": [
                "9002 RAT",
                "AdFind",
                "Agent.dhwf",
                "Agentemis",
                "CHINACHOPPER",
                "China Chopper",
                "Chymine",
                "ClaimLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "DCSync",
                "DOPLUGS",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Farseer",
                "Gen:Trojan.Heur.PT",
                "HOMEUNIX",
                "Hdump",
                "HenBox",
                "HidraQ",
                "Hodur",
                "Homux",
                "HopperTick",
                "Hydraq",
                "Impacket",
                "Kaba",
                "Korplug",
                "LadonGo",
                "MQsTTang",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "NBTscan",
                "NetSess",
                "Netview",
                "Orat",
                "POISONPLUG.SHADOW",
                "PUBLOAD",
                "PVE Find AD Users",
                "PlugX",
                "Poison Ivy",
                "PowerView",
                "QMAGENT",
                "RCSession",
                "RedDelta",
                "Roarur",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TONEINS",
                "TONESHELL",
                "TVT",
                "TeamViewer",
                "Thoper",
                "TinyNote",
                "WispRider",
                "WmiExec",
                "XShellGhost",
                "Xamtrav",
                "Zupdax",
                "cobeacon",
                "nbtscan",
                "nmap",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535928,
    "ts_updated_at": 1743041807,
    "ts_creation_date": 1653757683,
    "ts_modification_date": 1653757683,
    "files": {
        "pdf": "https://archive.orkl.eu/4b5db316be6f7cb9d6fdf033f32f2e6a3c45a79c.pdf",
        "text": "https://archive.orkl.eu/4b5db316be6f7cb9d6fdf033f32f2e6a3c45a79c.txt",
        "img": "https://archive.orkl.eu/4b5db316be6f7cb9d6fdf033f32f2e6a3c45a79c.jpg"
    }
}