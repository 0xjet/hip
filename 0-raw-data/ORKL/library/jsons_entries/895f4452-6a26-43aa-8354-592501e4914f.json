{
    "id": "895f4452-6a26-43aa-8354-592501e4914f",
    "created_at": "2023-01-12T15:01:44.037192Z",
    "updated_at": "2025-03-27T02:06:06.560603Z",
    "deleted_at": null,
    "sha1_hash": "4fb5fbd95ecda300de1dacaf40aa5a93d74355ca",
    "title": "2017-03-08 - RawPOS Malware Rides Again",
    "authors": "",
    "file_creation_date": "2022-05-28T21:53:48Z",
    "file_modification_date": "2022-05-28T21:53:48Z",
    "file_size": 587021,
    "plain_text": "# RawPOS Malware Rides Again\n\n**[threatvector.cylance.com/en_us/home/rawpos-malware.html](https://threatvector.cylance.com/en_us/home/rawpos-malware.html)**\n\nThe BlackBerry Cylance Threat Research Team\n\n## Summary\n\nAs part of a recent forensics investigation by the Cylance Consulting Services team, we\nuncovered some new RawPOS malware. This family of POS malware has been widely\n[documented in operation since 2008. Numerous retail operations of various](http://www.securityweek.com/cybercriminals-use-rawpos-malware-target-hotels-casinos) [sizes have been](http://www.securityweek.com/hackers-compromised-goodwill-vendor-more-year)\ncompromised with this malware and its variants.\n\nRather than rehash old malware, our intent is to discuss ‘signature fidelity’ and explain\nthrough technical detail why poorly-written signatures give people a false sense of security.\nThis ‘antivirus is dead’ argument is often presented, but with little technical detail to highlight\nspecifically why this is the case.\n\nIn our example below, the RawPOS variant went undetected for well over 30 days by a\nlegacy antivirus (AV) vendor. By the time the vendor deployed custom DAT files, the only\nsamples identified were in the quarantine directory of CylancePROTECT®. Fortunately, this\ncustomer deployed CylancePROTECT in time and prevented any data exfiltration.\n\nAt the end of this post, we’ll provide an updated yara file for identifying all variants of the\nRawPOS dumper, as well as some sha256 hashes of the new variant.\n\n## RawPOS Overview\n\n[RawPOS is documented rather extensively across the web – for example, here and](https://www.alienvault.com/blogs/security-essentials/a-newer-variant-of-rawpos-in-depth) [here.](http://sjc1-te-ftp.trendmicro.com/images/tex/pdf/RawPOS%20Technical%20Brief.pdf)\nThe variant we found is slightly updated, and we’ll focus on the memory dumper component:\n(0ca08c10a79cddbb359354f59ba988e77892e16dce873b5ba8e20eb053af8a18).\n\n\n-----\n\nThere also appears to be three open source signatures located on Github:\n\n[https://raw.githubusercontent.com/mattulm/sfiles_yara/master/pos/rawpos_POS.yar](https://raw.githubusercontent.com/mattulm/sfiles_yara/master/pos/rawpos_POS.yar)\nhttps://raw.githubusercontent.com/mattulm/sfiles_yara/master/pos/RawPOS2015_dumper_ol\nd.yar\n[https://github.com/mattulm/sfiles_yara/blob/master/pos/RawPOS2015_dumper.yar](https://github.com/mattulm/sfiles_yara/blob/master/pos/RawPOS2015_dumper.yar)\n\n\n-----\n\nFig1-RawPOS\n\n\n-----\n\n_Figure 1_\n\nThe above signature relies mostly on string literals and requires little developmental effort to\nadjust to evade, as we’ll see later.\n\n## Code Diff Analysis\n\nThis level of analysis will explore the functional changes to the code itself. We’ll highlight\ndifferences between two variants of the same memory dump component. One sample was\ncompiled in March 2015, and the updated variant was compiled in January 2017. The\nresulting diff analysis shows little functional change. The new variant is largely similar to the\n2015 variant.\n\nThis program has an updated naming scheme for where it places the dumped memory files.\nIt also removes the ‘help’ text from the binary. As of writing, this file was undetected by the\nlegacy AV vendor we used in this instance. Let’s compare this version with the previous\nversion that was documented in March 2015\n(252C13FE7A7E4F1E9E9227678C7156630A9D15AA457ADD2FF8EA5BCDB3403CD4) to\nsee what changed.\n\nWe’ll use binary diffing to compare the code changes between the two variants to show the\ndevelopmental effort the author used to create the new variant. Often when malware is\nupdated, small changes will be added to the code base to enable new functionality or to\n[evade legacy AV signatures. The tool we’ll use is diaphora, which is a great open-source](https://github.com/joxeankoret/diaphora)\nresource. Diaphora takes an IDA database as input and compares against a second IDA\ndatabase to determine what code regions are similar. Some screenshots highlighting some\nof the analysis between the two hashes are listed below.\n\nOf the 454 functions identified within this binary, 445 are 100% matches with the 2015\n(252C13FE7A7E4F1E9E9227678C7156630A9D15AA457ADD2FF8EA5BCDB3403CD4)\nvariant.\n\nThe remaining nine functions are partial matches.\n\n\n-----\n\nFig2-RawPOS\n\n\n-----\n\n_Figure 2_\n\nThree functions appear in the older variant only:\n\n\n-----\n\nFig3-RawPOS\n\n\n-----\n\n_Figure 3_\n\nOnly three unmatched functions are missing in the new variant. 0040146E is the original\nfunctional version of the snapshotting module that has been removed (as discussed below).\n004013EC is contained within the new variant at location 004012C9, but has no crossreferences to this code from within the binary per the IDA disassembly. 004013A0 has been\nremoved completely in the new version, as this was the calling function to 004012C9 in the\n2015 variant.\n\nTwo new functions appear only in the newer variant:\n\nFig4-RawPOS\n\n_Figure 4_\n\nThe two unmatched functions are a statically-linked strcpy and a snapshot by pid function\nlocated at 00401A6C. The disassembly of the snapshot by pid function is pictured below.\nThis allows the memory dumper to take a snapshot if you provide a pid function. This\nfunctionality was contained within the 2015 version and is located at 0x40146E. The\ndisassembly is below.\n\n\n-----\n\nFig5-RawPOS\n\n\n-----\n\n_Figure 5_\n\nThe similarity between the two functions is pretty close, and can further be illustrated with the\ncontrasting graph layout from the 2015 variant of this function at 0x40146E:\n\n\n-----\n\nFig6-RawPOS\n\n\n-----\n\n_Figure 6_\n\nFig7-RawPOS\n\n_Figure 7_\n\nIn summary, this variant has roughly no new functionality. It has even removed some\nfunctionality, which is rare considering developers code to add features. The big question is,\nwhy would a malware author remove code from their newer variant? This is most likely an\nattempt to evade signatures, as evidenced on the code areas that changed. With this in\nmind, we’ll now compare the string layout between the two different files.\n\n## String Diff\n\nCapturing a string diff between the two samples is accomplished by using the following code\nsnippet in python. The first and second arguments are output from strings tools (strings.exe\nfrom sysinternals on windows boxes was used as input). Piping this string output to a file,\nand then supplying each of those files as command line arguments to the python script, will\ngive you some differential analysis of the strings:\n\n_import sys_\n\n_with open(sys.argv[1], 'r') as f:_\n\n_rawpos_newvar_txt = f.readlines()_\n\n_with open(sys.argv[2], 'r') as f2:_\n\n_rawpos_315_txt = f2.readlines()_\n\n_#print(\"Common strings\\nF1:{}\\nF2:{}:\\n{}\".format(sys.argv[1], sys.argv[2],_\n_\"\".join(set(rawpos_newvar_txt) & set(rawpos_315_txt))))_\n\n_#print(\"New Variant only strings\\nF1:{}\\nF2:{}:\\n{}\".format(sys.argv[1], sys.argv[2], \"\".join(_\n_set(rawpos_newvar_txt) - set(rawpos_315_txt))))_\n\n_print(\"Old Variant only strings\\nF1:{}\\nF2:{}:\\n{}\".format(sys.argv[1], sys.argv[2],_\n_\"\".join(set(rawpos_315_txt) - set(rawpos_newvar_txt) )))_\n\n[This will take strings output from the two binaries and compare them using Python sets.](https://docs.python.org/3/tutorial/datastructures.html#sets)\nAnalyzing the differences/similarities between these two sample sets, we can observe how\nthe string literal composition has changed between variants. The print lines will give you\nstrings that are common to both old/new variants, strings that are in the new variant only, and\n[strings that are only in the old variant. Comparing this output between the open](https://github.com/lukaszbb/Loki/blob/master/optional_signatures/public_crime_win_rawpos_POS.yar) [source](https://github.com/mattulm/sfiles_yara/blob/master/pos/RawPOS2015_dumper_old.yar)\nsignatures released for this family we notice the following differences:\n\n\n-----\n\n**The regex portion seems to have changed slightly based on the open source**\n**signatures:**\n\n“((B(([0-9]{13,16})” (oldver)\n\n“(B(([0-9]{13,16})” (newvar)\n\n**The string literal for the track data has changed:**\n\n\"Found track data at %s with PID %d\" (oldver)\n\n“Found some data at %s with process id %d!” (newver)\n\n**The prompt for which PID to dump has changed:**\n\n“Enter Process Id:” (oldver)\n\n“Enter PID:” (newver)\n\n**The how to help strings have been removed:**\n\n“\" Dump private process memory by PID\" (oldver)\n\n**The extra info has been removed as well. This string was contained in the 004103A0**\n**code that is no longer there:**\n\n“Dumping private memory for pid %s to %s.dmp...\" (oldver)\n\n**The how to help strings have been removed:**\n\n“Full private dump of all running processes” (oldver)\n\n**The naming convention of the dump has changed:**\n\n“memdump\\\\%s-%d.dmp” (oldver)\n\n“memdump\\quota.prNam-%s-pID-%d.dmp” (newver)\n\n**The command string has also been elongated to avoid this signature:**\n\n“mkdir memdump >NUL 2>NUL” (oldver)\n\n“mkdir memdump >NUL 2>NUL” (newver)\n\nLast, but not least, we have the presence of the following string in the new variant. It’s a\nsurprising positive note to the security community:\n\n**iknowyouwatchingthisandilikeyou.exe**\n\nThe effort required to evade these signatures that were built on string literals is rather low.\nChanging the amount of prints used in 40146E (old variant), removal of the help banner, and\nsome simple string manipulation was all that was required to evade these signatures. The\nsecond open source signature has the right idea by using $_main to generate a signature off\n\n\n-----\n\nthe function that performs time-check, which has not changed. This still misses the mark as\nthe function has changed, however, the signature needs adjustment to catch this version that\nhas the time-check.\n\n## Conclusion\n\n**The above analysis shows how little effort has to be invested to bypass signature-**\n**based technologies. This shows that malware with roughly the same functional capabilities**\ncan adopt minor tweaks and evade legacy AV vendors.\n\nRelying on signature-based detection mechanisms as a core component of your security\nstack can lull one into a false sense of security. The alerts will be generated on variants that\nare known/documented and won’t be future-proofed for any similar familial variants post\nsignature deployment. The level of development effort that this author had to commit to avoid\nthis signature has been shown to be pretty low.\n\n## Yara File:\n\nrule RawPOS_dumper\n\n{\n\nmeta:\n\nauthor = \"Cylance Inc.\"\n\ndate = \"2017-01-24\"\n\ndescription = \"Used to detect all RawPOS RAM dumper(s)\"\n\nstrings:\n\n$time_func = { 55 8b ec 81 c4 ?? ?? ?? ?? 53 56 57 8b ?? ?? 8b ?? ?? 6a\n00 e8 ?? ?? ?? ?? 59 a3 ?? ?? ?? ?? 6a 00 e8 ?? ?? ?? ?? 59 3d ?? ?? ?? ?? 7e ?? 33 c0\ne9 ?? ?? ?? ??}\n\n$enum_proc_func = { 55 8b ec 81 c4 ?? ?? ?? ?? 50 81 c4 ?? ?? ?? ?? 53 56 57 be c8 b9\n42 00 8d ?? ?? ?? ?? ?? b9 41 00 00 00 f3 ?? 8d ?? ?? 50 68 a0 0f 00 00 8d ?? ?? ?? ?? ??\n52 e8 ?? ?? ?? ?? 85 c0 0f ?? ?? ?? ?? ??}\n\n$open_proc_func = { 8b f0 85 f6 0f ?? ?? ?? ?? ?? 8d ?? ?? 50 6a 04 8d ?? ?? 52 56 e8 ??\n?? ?? ?? 85 c0 74 ?? 68 04 01 00 00 8d ?? ?? ?? ?? ?? 51 ff ?? ?? 56 e8 ?? ?? ?? ?? 56 e8\n?? ?? ?? ??}\n\ncondition:\n\n\n-----\n\n$enum_proc_func or $time_func or $open_proc_func\n\n}\n\n## SHA256’s of New Variant:\n\na2e720a2c538347144aee50ae85ebfdaf3fdffcfc731af732be5d3d82cd08b18\n\nfe8637ef9be609951aa218942d46a535ba771236668a49a84512b18b02e9fbee\n\n0ca08c10a79cddbb359354f59ba988e77892e16dce873b5ba8e20eb053af8a18\n\n4bd1cc0a38117af7d268c29592ef754e51ce5674e26168c6bb613302f3c62fb8\n\n967fcbc7abcb328afb1dbfd72d68636c478d7369e674d622799b8dfd66230112\n\nThe other function is for _strcpy, which has been statically linked in the new variant where\nthe old variant chose to use _strncpy. Why did the malware authors implement this change?\nIf we look at some open source signatures for this specific variant of RawPOS, we may\nuncover the answer. Below are some signatures that are available:\n\n[https://github.com/mattulm/sfiles_yara/blob/master/pos/rawpos_POS.yar (good, but still fails)](https://github.com/mattulm/sfiles_yara/blob/master/pos/rawpos_POS.yar)\n[https://github.com/mattulm/sfiles_yara/blob/master/pos/RawPOS2015_dumper_old.yar](https://github.com/mattulm/sfiles_yara/blob/master/pos/RawPOS2015_dumper_old.yar)\n\n(bad, online)\n\n_[If you use our endpoint protection product, CylancePROTECT®, you were already protected](https://www.cylance.com/en_us/products/our-products/protect.html)_\n_from this attack. If you don't have CylancePROTECT,_ _[contact us to learn how our AI based](https://www.cylance.com/en_us/contact-us.html)_\n_solution can predict and prevent unknown and emerging threats._\n\nThe BlackBerry Cylance Threat Research Team\n\n## About The BlackBerry Cylance Threat Research Team\n\nThe BlackBerry Cylance Threat Research team examines malware and suspected malware\nto better identify its abilities, function and attack vectors. Threat Research is on the frontline\nof information security and often deeply examines malicious software, which puts us in a\nunique position to discuss never-seen-before threats.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-03-08 - RawPOS Malware Rides Again.pdf"
    ],
    "report_names": [
        "2017-03-08 - RawPOS Malware Rides Again.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535704,
    "ts_updated_at": 1743041166,
    "ts_creation_date": 1653774828,
    "ts_modification_date": 1653774828,
    "files": {
        "pdf": "https://archive.orkl.eu/4fb5fbd95ecda300de1dacaf40aa5a93d74355ca.pdf",
        "text": "https://archive.orkl.eu/4fb5fbd95ecda300de1dacaf40aa5a93d74355ca.txt",
        "img": "https://archive.orkl.eu/4fb5fbd95ecda300de1dacaf40aa5a93d74355ca.jpg"
    }
}