{
    "id": "1efcdf19-5ad7-4648-9053-dac885cbdcca",
    "created_at": "2023-01-12T15:04:27.554835Z",
    "updated_at": "2025-03-27T02:05:47.69246Z",
    "deleted_at": null,
    "sha1_hash": "530047e40a1bbe6e55ab2d867538e88ffac45bd2",
    "title": "2022-01-20 - Buer Loader Analysis, a Rusted malware program",
    "authors": "",
    "file_creation_date": "2022-05-28T23:31:50Z",
    "file_modification_date": "2022-05-28T23:31:50Z",
    "file_size": 1888018,
    "plain_text": "# Buer Loader Analysis, a Rusted malware program\n\n**[tehtris.com/en/blog/buer-loader-analysis-a-rusted-malware-program](https://tehtris.com/en/blog/buer-loader-analysis-a-rusted-malware-program)**\n\nJanuary 20, 2022\n\nMalware analysis is part of the CTI team’s daily routine. This article presents the analysis of a Rust\nstrain of Buer Loader from the reception of the samples to the writing of a stage2* extraction script.\nDespite several protection mechanisms, it was possible to extract all the samples in different ways.\nTEHTRIS provides the code for such an extraction.\n\n**Summary**\n\n## Introduction\n\nThe Rust language [1] is more and more used [2] by developers. Indeed, the philosophy of this\nlanguage is to maximize security while offering performances close to C++ in a pleasant syntax.\nMany ambitious projects like Kerla [3] aim at offering an operating system that is compatible with any\nLinux binary, without modification. This gives Rust a lot of credibility and explains its adoption by\ndevelopers. From a low-level point of view, this language generates a more complex binary code to\nsign and analyze compared to C by offering more instructions and adding obfuscation at low cost,\nwhich is of interest to malware authors.\n\nIf still few adopt it, it is however not surprising to note that this language is starting to make a name\nfor itself in the malware bestiary, as shown by Buer Loader [3] which includes variants developed in\nthis language.\n\n\n-----\n\nIf this malware program has already been analyzed [3], it remains interesting to study its stage1 to\nidentify the protection mechanisms and the evolutions concerning its obfuscation over time. Indeed,\nsandbox bypass techniques [5] and memory loading of offended binaries [6] by an unknown\nmechanism have been observed. This was enough to trigger the interest of a retro-analysis of the\nloader in question.\n\nThe goal is to characterize and extract the main load of the malware that was specifically spotted in\ncomputing environments between July and August 2021.\n\nAn emulation-based extraction method was presented at the Hack-It-N conference in December\n2021. A replay of the presentation is available on Youtube [16].\n\n## Analysis\n\nThe retrieved samples work on the same model, i.e. a base in Rust loading in memory a stage2,\nitself written in Rust. Here is the list of these samples:\n\n\n**Sha256** **Compile**\n**time**\n\n001405ded84e227092bafe165117888d423719d7d75554025ec410d1d6558925 2021-0728\n17:59:19\n\n4421dbc01ddc5ed959419fe2a3a0f1c7b48f92b880273b481eb249cd17d59b91 2021-0811\n15:35:55\n\n52d8316b0765c147558aecbda686d076783f3a08b2741b8c9e3e717cc56e8a92 2021-0719\n13:57:22\n\n580d55f1e51465b697d46e67561f3161d4534a73e8aa47e18b9bae344d46bcf4 2021-0719\n13:57:22\n\n578dc62dfa0203080da262676f28c679114d6b1c90a4ab6c07b736d9ce64e43e 2021-0715\n16:28:54\n\n5ac6766680c8c06a4b0b4e6a929ec4f5404fca75aa774f3eb986f81b1b30622b 2021-0805\n14:47:25\n\n\n**Size**\n\n3.4\nMB\n\n6.6\nMB\n\n7.3\nMB\n\n7.3\nMB\n\n7.1\nMB\n\n4.9\nMB\n\n\n-----\n\n64dd547546394e1d431a25a671892c7aca9cf57ed0733a7435028792ad42f4a7 2021-0816\n18:54:29\n\n88689636f4b2287701b63f42c12e7e2387bf4c3ecc45eeb8a61ea707126bad9b 2021-0803\n15:46:42\n\nafb5cbe324865253c7a9dcadbe66c66746ea360f0cd184a2f4e1bbf104533ccd 2021-0625\n17:49:48\n\nc425264f34fa8574c7e4321020eb374b9364a094cda9647e557b97d5e2b8c17b 2021-0816\n18:54:29\n\nd3a486d3b032834b1203adefd25d0bf0b36fae7f9e72071c21ccc266e1e1f893 2021-0719\n14:14:54\n\n\n4.1\nMB\n\n3.3\nMB\n\n7.1\nMB\n\n4.1\nMB\n\n4.3\nMB\n\n\nThe compilation dates seem consistent with each other. Indeed, they match approximately the\nsubmission dates on Virus Total [15] (with a small delay). The binaries are stripped (i.e. symbols\nunnecessary for the binary to work have been removed, especially function names and debugging\nsymbols) but still contain information about the used source code:\n\nUnfortunately, BinDiff [7] is not able to compare binaries. The control flow is too complex for it.\nTherefore, the code comparisons were done manually by our experts.\n\nBinDiff error\n\nOur analysis determined that there seem to be only 2 source files outside of the open source (mainly\ncryptographic) libraries used. A first anti-sandbox technique consists in wasting time by performing\nan unnecessary loop. The order of magnitude of the time needed (and lost) is about one minute with\na 100% occupied CPU.\n\n\n-----\n\n-----\n\nAnti-sandbox by waste of time\nAfter passing through this loop, we arrive at the decryption function of stage2. This one contains a\nlarge number of successive calls to useless functions, among which we find:\n\n**GetCommandLineA;**\n**GetCurrentProcess;**\n**GetEnvironmentStrings;**\n**GetLastError;**\n**GetProcessHeap;**\n**GetTickCount;**\n\nIt is probably a saturation mechanism using calls (call to a Windows library) and not taking any\nargument to override possible sandboxes, which complicates code emulation. It seems that a script\ngenerates all the calls. This technique also has the advantage of adding a credible call/instruction\nratio compared to a legitimate program. Counting the calls sometimes allows to find decryption or\nunpacking routines:\n\n\n-----\n\nDecoys variant 1\n\n\n-----\n\n-----\n\n-----\n\n-----\n\nDecoys variant 2\nThese calls are repeated throughout the desobfuscation routine. The data are successively pushed\non the stack, then in the heap with the help of kernel32 !HeapAlloc, in the form of DWORD:\n\nStage2 buffer reconstruction\nThe call graph is very different across samples, reinforcing our hypothesis that the code is generated\nfrom a script. The mix of calls and desobfuscation involves a special effort to blend in a behavior that\nappears to be legitimate.\n\n\n-----\n\nControl flow Variant1\n\n\n-----\n\nControl flow Variant2\n\n\n-----\n\nControl flow Variant3\n\nThis technique allows to include binary data by limiting the entropy between 0.5 and 0.8, very close\nto what one would expect from legitimate instructions.\n\n\n-----\n\nEntropy of the malware program\nThis data, once reconstituted, is placed in a buffer which is decrypted. We then recognize a Key\nSchedule type mechanism, followed by a generator reminiscent of RC4:\n\nKSA block\n\nRC4 Random generator\n\n\n-----\n\nThe Rust paradigm makes these decryption routines difficult to identify. Tools such as findcrypt [8] do\nnot detect them. The following check identifies the entire desobfuscation chain:\n\nDecryption in python\nThe decompression is performed by the version 0.1.3 of the lzma-rs library [9], and the decryption\nkeys are easily visible in the code. The following script allows its extraction:\n\nKey extraction script\nThe list of RC4 keys for the samples is as follows:\n\n**YDVHHCYTCH ;**\n**DQOQHMLGYU ;**\n**BWSCVQZXOB ;**\n**SIMHIDVSCR ;**\n**RGZPMAAQRP ;**\n**YVMOOVSIOF ;**\n**KSQKGUUTXZ ;**\n**EUWPUQYDTT ;**\n**KHBXNNHKNN ;**\n\nUnfortunately, the number of keys is insufficient to evaluate the quality of the PRNG [10]. Note that\nthe charset is very small, which does not matter since the key is in plain text in the “.rdata” section.\nGiven the extremely variable and complex call graph, writing a generic data extraction script that\nworks for all samples is tedious. Now that we know the key (cf. previous extraction script), we need\nto find the encrypted data. These, once desobfuscated, have a header with invariant data:\n\n3 blocks of encrypted buffer header\nThe following script then allows to find the extracted data in memory, provided that the program has\nperformed the decryption phase by carrying out an Egg-hunting search:\n\n\n-----\n\nEncrypted data recovery script\nThe only thing missing to automate the extraction is to find an address or to set a breakpoint, which\nis done in a fairly logical way by finding the references to the RC4 key:\n\nMalware launching script\nAnd the script works on the first try for all samples. The source code of the tool is available on the\nTEHTRIS github [19].\n\nAn alternative method was presented at the Hack-it-N conference [16]. It consists in extracting the\nstage2 by emulation using the unicorn lib [17]. The source code is available on the TEHTRIS github\n\n[18].\n\nThe extraction of stage2 from the studied samples gives the following list:\n\n\n**Sha256** **Stage1**\n**compile**\n**time**\n\nedc3b5f8d45d7a1cceee144e57fc5ddfaf8c0c7407a1514d2f3bab4f3c9f18b8 202107-28\n17:59:19\n\nd7ec38c0e89a749a7727e5644328835b50e19302e9f3a4688809403ebcbd03d2 202108-11\n15:35:55\n\n\n**Stage 2**\n\n**compile**\n**time**\n\n202107-28\n17:39:31\n\n202108-11\n15:30:38\n\n\n-----\n\n6578db32dc78ef7f41213557cf894d03b97ed6974ae7a72bec9b7c7ac08c4ba9 202107-19\n13:57:22\n\nd48d91451b9594eadc0d1ef6e379bbce9a6033bd337e06d46613a70187c9c5ef 202107-15\n16:28:54\n\n54109b12cbbd223f5ad79a9f87bfe50ef05a80e5551a3c1931748c3698900496 202108-05\n14:47:25\n\n2d8a2bcc45daedd343eadb4222885d12a221bebbf7f1d98f92cb233df0a4c1d4 202108-16\n18:54:29\n\n16feaed6222ce4a1941ae0c32eabaf0ecf68c33c49544f71d431d1b70c4247fd 202108-03\n15:46:42\n\n7af554fb260817350d33b801d9f0b8a638b831992f4b1b31c2bbdab875b211df 202106-25\n17:49:48\n\n2d8a2bcc45daedd343eadb4222885d12a221bebbf7f1d98f92cb233df0a4c1d4 202108-16\n18:54:29\n\n039d63a07372e6e17f9779ccffbafbf9a06a9402ade58fbec3b0b2f8d2038175 202107-19\n13:57:22\n\nThe timestamps seem coherent between themselves and we note that the compilation dates\ncorrespond with a gap of 5 to 10 minutes, suggesting a manual packing step.\n\nWe note that stage2 verifies the presence of a virtual machine by testing the presence of the\nfollowing executables:\n\n**> vboxservice.exe ;**\n\n**> vboxtray.exe ;**\n\n**> vmtoolsd.exe ;**\n\n**> vmwaretray.exe ;**\n\n**> vmwareuser.exe ;**\n\n**> vmacthlp.exe ;**\n\n**> vmsrvc.exe ;**\n\n**> vmusrvc.exe ;**\n\n\n202107-19\n13:44:11\n\n202107-15\n16:20:18\n\n202108-05\n14:38:43\n\n202108-16\n18:45:22\n\n202108-03\n15:38:18\n\n202106-25\n17:43:23\n\n202108-16\n18:45:22\n\n202107-19\n13:46:46\n\n\n-----\n\n**> prl_cc.exe ;**\n\n**> prl_tools.exe ;**\n\n**> xenservice.exe ;**\n\n**> qemu-ga.exe ;**\n\n**> windanr.exe.**\n\nOnce the desobfuscation step is done, the binary is no longer obfuscated and easily delivers its\nsecrets. For example C2 [11]:\n\nList of C2 URLs\nOr encrypts list of files constituting the source code:\n\nSource code metadata\nThe analysis of the stage2 has already been done, however, and we will not describe it here.\n\n## Conclusion\n\nEvading automated malware detection systems is a balancing act between binary entropy, hiding\nencryption functions, slowing down the analysis time, obtaining a consistent call/instruction ratio…\n\n\n-----\n\nThe use of Rust adds a machine code overlay which is however much less than what a Go [12],\ndelphi [13], cython [14], etc. compiler would do, making a manual analysis quite reasonable.\n\nHowever, these techniques are no match for a reverser or a well-configured sandbox. The manual\nanalysis of the most known and least traceable threats is a plus in the continuous improvement of\nour sandbox and EDR products. It is very likely that in the future, more and more malware programs\nwill be developed in Rust.\n\n- The use of stageN consists in separating the malware program into several specialized sub-parts in\norder to escape antivirus detection. In this case, stage1 is the malware program as sent to victims\nand stage2 is the payload encapsulated in stage1.\n\n## BIBLIOGRAPHY\n\n[1] [https://www.rust-lang.org/](https://www.rust-lang.org/)\n\n[2] [https://www.tiobe.com/tiobe-index/rust/](https://www.tiobe.com/tiobe-index/rust/)\n\n[3] [https://github.com/nuta/kerla](https://github.com/nuta/kerla)\n\n[4] [https://www.proofpoint.com/us/blog/threat-insight/new-variant-buer-loader-written-rust](https://www.proofpoint.com/us/blog/threat-insight/new-variant-buer-loader-written-rust)\n\n[5] [https://fr.wikipedia.org/wiki/Sandbox_(s%C3%A9curit%C3%A9_informatique)](https://fr.wikipedia.org/wiki/Sandbox_(s%C3%A9curit%C3%A9_informatique))\n\n[6] [https://fr.wikipedia.org/wiki/Offuscation](https://fr.wikipedia.org/wiki/Offuscation)\n\n[7] [https://www.zynamics.com/bindiff.html](https://www.zynamics.com/bindiff.html)\n\n[8] [https://github.com/you0708/ida/tree/master/idapython_tools/findcrypt](https://github.com/you0708/ida/tree/master/idapython_tools/findcrypt)\n\n[9] [https://github.com/gendx/lzma-rs](https://github.com/gendx/lzma-rs)\n\n[10] https://fr.wikipedia.org/wiki/G%C3%A9n%C3%A9rateur_de_nombres_pseudoal%C3%A9atoires\n\n[11] [https://www.trendmicro.com/vinfo/us/security/definition/command-and-control-server](https://www.trendmicro.com/vinfo/us/security/definition/command-and-control-server)\n\n[12] [https://golang.org/](https://golang.org/)\n\n[13] [https://www.embarcadero.com/fr/products/delphi](https://www.embarcadero.com/fr/products/delphi)\n\n[14] [https://cython.org/](https://cython.org/)\n\n[15] [https://www.virustotal.com](https://www.virustotal.com/)\n\n[16] [https://www.youtube.com/watch?v=4Lux_0IROMY](https://www.youtube.com/watch?v=4Lux_0IROMY)\n\n[17] [https://www.unicorn-engine.org/](https://www.unicorn-engine.org/)\n\n[18] [https://github.com/tehtris-hub/MalwareTool/blob/main/Buer/extract_buer.py](https://github.com/tehtris-hub/MalwareTool/blob/main/Buer/extract_buer.py)\n\n\n-----\n\n[19] [https://github.com/tehtris-hub/MalwareTool/blob/main/Buer/extract_buer_debug.py](https://github.com/tehtris-hub/MalwareTool/blob/main/Buer/extract_buer_debug.py)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-20 - Buer Loader Analysis, a Rusted malware program.pdf"
    ],
    "report_names": [
        "2022-01-20 - Buer Loader Analysis, a Rusted malware program.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535867,
    "ts_updated_at": 1743041147,
    "ts_creation_date": 1653780710,
    "ts_modification_date": 1653780710,
    "files": {
        "pdf": "https://archive.orkl.eu/530047e40a1bbe6e55ab2d867538e88ffac45bd2.pdf",
        "text": "https://archive.orkl.eu/530047e40a1bbe6e55ab2d867538e88ffac45bd2.txt",
        "img": "https://archive.orkl.eu/530047e40a1bbe6e55ab2d867538e88ffac45bd2.jpg"
    }
}