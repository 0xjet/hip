{
    "id": "eb91d9f9-1a84-47a8-a1ef-b40e5b3c3b59",
    "created_at": "2023-01-12T15:05:12.981712Z",
    "updated_at": "2025-03-27T02:15:38.047375Z",
    "deleted_at": null,
    "sha1_hash": "274788554c210509b3f5943338a74b4175845cc0",
    "title": "2018-08-16 - New modular downloaders fingerprint systems, prepare for more - Part 1- Marap",
    "authors": "",
    "file_creation_date": "2022-05-28T19:51:19Z",
    "file_modification_date": "2022-05-28T19:51:19Z",
    "file_size": 1259169,
    "plain_text": "# New modular downloaders fingerprint systems, prepare for more - Part 1: Marap\n\n**[proofpoint.com/us/threat-insight/post/new-modular-downloaders-fingerprint-systems-prepare-more-part-1-marap](https://www.proofpoint.com/us/threat-insight/post/new-modular-downloaders-fingerprint-systems-prepare-more-part-1-marap)**\n\nAugust 16, 2018\n\nAugust 16, 2018 Proofpoint Staff\n\n**Overview**\n\nProofpoint researchers recently discovered a new downloader malware in a fairly large campaign (millions of\nmessages) primarily targeting financial institutions. The malware, dubbed “Marap” (“param” backwards), is\nnotable for its focused functionality that includes the ability to download other modules and payloads. The\nmodular nature allows actors to add new capabilities as they become available or download additional modules\npost infection. To date, we have observed it download a system fingerprinting module that performs simple\nreconnaissance.\n\n\n-----\n\n**Campaign Analysis**\n\nOn August 10, 2018, we observed several large email campaigns (millions of messages) leading to the same\n“Marap” malware payload in our testing. They shared many features with previous campaigns attributed to the\nTA505 actor [1]. The emails contained various attachment types:\n\nMicrosoft Excel Web Query (“.iqy”) files\nPassword-protected ZIP archives containing “.iqy” files\nPDF documents with embedded “.iqy” files\nMicrosoft Word documents containing macros\n\nThe campaigns are outlined below:\n\n”sales” “.iqy” attachment campaign: Messages purporting to be from '\"sales\" <[random address]>' with the\nsubject \"REQUEST [REF:ABCDXYZ]\" (random letters) and attachment \"REP_10.08.iqy\" (campaign’s date)\n\n_Figure 1: “Sales” example email message with “.iqy” attachment_\n\n“Major bank” “.iqy” attachment campaign: Messages purporting to be from '\"[recipient name]\"\n<random_name@[major bank].com>' with subject \"IMPORTANT Documents - [Major Bank]\" and attachment\n\"Request 1234_10082018.iqy\" (random digits, campaign's date); note that this campaign abuses the brand and\nname of a major US bank and has been obscured throughout the example.\n\n\n-----\n\n_Figure 2: “Major bank” sample message with “.iqy” attachment; bank branding obscured_\n\nPDF attachment campaign: Messages purporting to be from '\"Joan Doe\" <netadmin@[random domain]>'\n(random display name) with subject \"DOC_1234567890_10082018\" (random digits, campaign’s date; also\n\"PDF\", \"PDFFILE\", \"SCN\") and matching attachment \"DOC_1234567890_10082018.pdf\" (with embedded .iqy\nfile)\n\n\n-----\n\n_Figure 3: Message sample with PDF attachment with embedded .iqy file_\n\nPassword-protected ZIP campaign: Messages purporting to be from '\"John\" <John@[random company]>'\n(random name) with subject \"Emailing: PIC12345\" (random digits) and matching attachment \"PIC12345.zip\"\n\n\n-----\n\n_Figure 4: Message sample with password-protected zip attachment that contains a .iqy file_\n\nMicrosoft Word attachment campaign: Messages purporting to be from '\"Joan\" <Joan@[random domain]>'\n(random name) with subject \"Invoice for 12345.10/08/2018\" (random digits, today's date) with matching\nattachment \"Invoice_ 12345.10_08_2018.doc\"\n\n\n-----\n\n_Figure 5: Message sample with Microsoft Word attachment (incorrectly described as “PDF format” in the_\n_message body) with malicious macros_\n\n**Malware Analysis**\n\nAs noted, Marap is a new downloader, named after its command and control (C&C) phone home parameter\n“param” spelled backwards. The malware is written in C and contains a few notable anti-analysis features.\n\nAnti-Analysis Features\n\nMost of the Windows API function calls are resolved at runtime using a hashing algorithm. API hashing is\ncommon in malware to prevent analysts and automated tools from easily determining the code’s purpose. This\nalgorithm appears to be custom to Marap. Our implementation of the hashing algorithm in Python is available on\nGithub [3]. It is likely that the XOR keys used in our code will be different in other samples.\n\n\n-----\n\nThe second anti analysis technique is the use of timing checks at the beginning of important functions (Figure\n6). These checks can hinder debugging and sandboxing of the malware. If the calculated sleep time is too short,\nthe malware exits.\n\n_Figure 6: Anti-analysis timing checks_\n\nMost of the strings in the malware are obfuscated using one of three methods:\n\n1. Created on the stack (stack strings)\n2. Basic XOR encoding (0xCE was the key used in the analyzed sample, but it is likely this will change from\n\nsample to sample)\n3. A slightly more involved XOR-based encoding (An IDA Pro script implementing the decryption is available\n\non Github [4])\n\nThe last anti-analysis check compares the system’s MAC address to a list of virtual machine vendors. If a virtual\nmachine is detected and a configuration flag is set, the malware may exit.\n\nConfiguration\n\nMarap’s configuration is stored in an encrypted format in the malware binary and/or in a file named “Sign.bin” in\nthe malware’s working directory (e.g., C:\\Users\\[username]\\AppData\\Roaming\\Intel\\Sign.bin). It is DESencrypted in CBC mode using an IV of “\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00”. The key is generated using the\nfollowing process:\n\n164 bytes of data are generated using a linear congruential generator (LCG) and two hardcoded seeds (it\nis likely the seeds are different in other samples). An implementation of the LCG in Python is available on\nGithub [5].\nThe data is hashed with SHA1\nAn 8-byte DES key is created using CryptDeriveKey and the hash\n\nAn example decrypted configuration looks like:\n\n15|1|hxxp://185.68.93[.]18/dot.php|hxxp://94.103.81[.]71/dot.php|hxxp://89.223.92[.]202/dot.php\n\nIt is pipe-delimited and contains configuration parameters for:\n\nSleep timeout between C&C communications\nFlag indicating whether the malware should exit if it detects that it is running on a virtual machine\nUp to three C&C URLs\n\nCommand and Control\n\nMarap uses HTTP for its C&C communication but first it tries a a number of legitimate WinHTTP functions to\ndetermine whether it needs to use a proxy and if so what proxy to use. An example C&C beacon is shown in\nFigure 7 below.\n\n\n-----\n\n_Figure 7: Example C&C beacon_\n\nThe request contains one parameter -- “param” -- and its data is encrypted using the same method as used for\nthe configuration, with the addition of base64 encoding. An example of the plaintext request looks like:\n\n62061c6bcdec4fba|0|0\n\nIt is pipe-delimited and contains the following:\n\nBot ID (generated by hashing the hostname, username, and MAC address with the same hashing\nalgorithm used with API function hashing described above)\nHardcoded to “0”\nHardcoded to “0”\n\nThe response is encrypted similarly and an example decrypted response looks like:\n\n319&1&0&hxxp://89.223.92[.]202/mo.enc\n\nIt is “&”-delimited and contains the following:\n\nCommand ID\nCommand\nFlag controlling response type\nCommand arguments (there can be two arguments separated by a “#”)\n\nIdentified commands:\n\n\n-----\n\n0: Sleep and beacon again\n1: Download URL, DES decrypt, and manually load the MZ file (allocate a buffer, copy the PE header and\nsections, reallocate, and resolve the import table). This command can pass back data from the\ndownloaded module to the C&C\n2: Update configuration and write a DES-encrypted version to the file “Sign.bin”\n3: Download URL, DES decrypt, save the MZ file to “%TEMP%/evt”, and execute with a command line\nargument\n4: Download URL, DES decrypt, create/hollow out a process (same executable as malware), and inject the\ndownloaded MZ file\n5: Download URL, DES decrypt, save the MZ file as “%TEMP%/zvt”, and load it with the LoadLibrary API\n6: Download URL, DES decrypt, and manually load the MZ file\n7: Remove self and exit\n8: Update self\n\nAfter command execution a response message can be sent back to the C&C. It is pipe delimited and contains\nthe following:\n\nBot ID\nHardcoded “1”\nCommand ID\nCommand\nFlag controlling response type\nCommand return value\nCommand status code (various error codes)\nResponse data\n\nEither a simple status message\nOr verbose “#” delimited data from modules\n\nSystem Fingerprinting Module\n\nAt the time of publication, we have only seen a system fingerprinting module being sent from a C&C server. It\nwas downloaded from “hxxp://89.223.92[.]202/mo.enc” and contained an internal name of “mod_Init.dll”. The\nmodule is a DLL written in C and gathers and sends the following system information to the C&C server:\n\nUsername\nDomain name\nHostname\nIP address\nLanguage\nCountry\nWindows version\nList of Microsoft Outlook .ost files\nAnti-virus software detected\n\n**Conclusion**\n\nAs defenses become more adept at catching commodity malware, threat actors and malware authors continue\nto explore new approaches to increase effectiveness and decrease the footprint and inherent “noisiness” of the\nmalware they distribute. We have observed ransomware distribution drop dramatically this year while banking\nTrojans, downloaders, and other malware have moved to fill the void, increasing opportunities for threat actors to\nestablish persistence on devices and networks. This new downloader, along with another similar but unrelated\n\n\n-----\n\nmalware that we will detail next week, point to a growing trend of small, versatile malware that give actors\nflexibility to launch future attacks and identify systems of interest that may lend themselves to more significant\ncompromise.\n\n**References**\n\n[1] [https://www.proofpoint.com/us/threat-insight/post/ta505-shifts-times](https://www.proofpoint.com/us/threat-insight/post/ta505-shifts-times)\n\n[2] [https://www.proofpoint.com/us/threat-insight/post/leaked-source-code-ammyy-admin-turned-flawedammyy-rat](https://www.proofpoint.com/us/threat-insight/post/leaked-source-code-ammyy-admin-turned-flawedammyy-ratxxx)\n\n[3] [https://github.com/tildedennis/malware/blob/master/marap/func_hashes.py](https://github.com/tildedennis/malware/blob/master/marap/func_hashes.py)\n\n[4] [https://github.com/tildedennis/malware/blob/master/marap/str_decrypt3.py](https://github.com/tildedennis/malware/blob/master/marap/str_decrypt3.py)\n\n[5] [https://github.com/tildedennis/malware/blob/master/marap/lcg.py](https://github.com/tildedennis/malware/blob/master/marap/lcg.py)\n\n**Indicators of Compromise (IOCs)**\n\n\n**IOC** **IOC**\n**Type**\n\n\n**Description**\n\n\nbea0276c51bd6dbccb64110a8655fd623cbb9ebf6e0105c57f62e53e209361b6 SHA256 “REP_10.08.iqy”\nattachment\n\n1c6661cc19d071df75ef94c58829f223b8634c00a03d1dadcde222c25475fa05 SHA256 “Request [random\ndigits]_10082018.iqy”\nattachment\n\n2c5729e17b64cd4e905ccfeabbc913ed945e17625c35ec1d6932194aae83d7c6 SHA256 PDF attachment\n\n8a03144025cd2804a714cd4e3833c341b02edf0c745c810c88efd053cc813233 SHA256 Password-protected\nZIP attachment\n\nhxxp://i86h[.]com/data1.dat URL Remote Excel cell\ncontent\n\nhxxp://i86h[.]com/data2.dat URL Intermediate\nPowershell script\n\nhxxp://i86h[.]com/data3.dat URL Payload\n\nhxxp://r53x[.]com/1.rar URL Remote Excel cell\ncontent\n\nhxxp://r53x[.]com/1.zip URL Intermediate\nPowershell script\n\nhxxp://r53x[.]com/a3.dat URL Payload\n\nbc1fc69f9747dc034ece7d9bb795c5e596d9be6ca71efe75c6c0fd18f3cbfbf5 SHA256 Marap\n\n\n-----\n\nhxxp://185.68.93[.]18/dot.php URL Marap C&C\n\nhxxp://94.103.81[.]71/dot.php URL Marap C&C\n\nhxxp://89.223.92[.]202/dot.php URL Marap C&C\n\nSign.bin File Marap’s encrypted\nconfiguration file\n\nhxxp://89.223.92[.]202/mo.enc URL Encrypted Marap\nsystem fingerprinting\nmodule download\nURL\n\na6a31f6b6ac73131a792daa255df88d71ba8c467abfa2a5580221a694c96c2cc SHA256 Encrypted Marap\nsystem fingerprinting\nmodule\n\n1b9f592fcf8b0f1349db7f49f3061396f21d38728eb0d84e1c90ad39e5ddb3ab SHA256 Marap system\nfingerprinting module\nDLL\n\n**ET and ETPRO Suricata/Snort Signatures**\n\n2832142 || ETPRO TROJAN Win32/Marap CnC Beacon\n\n2832143 || ETPRO TROJAN Win32/Marap CnC Beacon Response\n\nSubscribe to the Proofpoint Blog\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-08-16 - New modular downloaders fingerprint systems, prepare for more - Part 1- Marap.pdf"
    ],
    "report_names": [
        "2018-08-16 - New modular downloaders fingerprint systems, prepare for more - Part 1- Marap.pdf"
    ],
    "threat_actors": [
        {
            "id": "99cb4e5b-8071-4f9e-aa1d-45bfbb6197e3",
            "created_at": "2023-01-06T13:46:38.860754Z",
            "updated_at": "2025-03-27T02:00:02.937438Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "SectorJ04 Group",
                "Dudear",
                "G0092",
                "ATK103",
                "Hive0065",
                "Spandex Tempest",
                "GRACEFUL SPIDER",
                "GOLD TAHOE",
                "CHIMBORAZO",
                "SectorJ04"
            ],
            "source_name": "MISPGALAXY:TA505",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5e6b31a6-80e3-4e7d-8b0a-d94897ce9b59",
            "created_at": "2024-06-19T02:03:08.128175Z",
            "updated_at": "2025-03-27T02:05:17.400394Z",
            "deleted_at": null,
            "main_name": "GOLD TAHOE",
            "aliases": [
                "SectorJ04 ",
                "Spandex Tempest ",
                "TA505 ",
                "FIN11 "
            ],
            "source_name": "Secureworks:GOLD TAHOE",
            "tools": [
                " Cobalt Strike",
                " FlawedAmmy",
                " Get2",
                " GraceWire",
                " Malichus",
                " SDBbot",
                " ServHelper",
                " TrueBot",
                "Clop"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75d4d6a9-b5d1-4087-a7a0-e4a9587c45f4",
            "created_at": "2022-10-25T15:50:23.5188Z",
            "updated_at": "2025-03-27T02:00:55.489882Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "TA505",
                "Hive0065",
                "Spandex Tempest",
                "CHIMBORAZO"
            ],
            "source_name": "MITRE:TA505",
            "tools": [
                "AdFind",
                "Azorult",
                "FlawedAmmyy",
                "Mimikatz",
                "Dridex",
                "TrickBot",
                "Get2",
                "FlawedGrace",
                "Cobalt Strike",
                "ServHelper",
                "Amadey",
                "SDBbot",
                "PowerSploit"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e447d393-c259-46e2-9932-19be2ba67149",
            "created_at": "2022-10-25T16:07:24.28282Z",
            "updated_at": "2025-03-27T02:02:10.159466Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "ATK 103",
                "Chimborazo",
                "Gold Evergreen",
                "Gold Tahoe",
                "Graceful Spider",
                "Hive0065",
                "Operation Tovar",
                "Operation Trident Breach",
                "SectorJ04",
                "Spandex Tempest",
                "TA505",
                "TEMP.Warlock"
            ],
            "source_name": "ETDA:TA505",
            "tools": [
                "Amadey",
                "AmmyyRAT",
                "AndroMut",
                "Azer",
                "Bart",
                "Bugat v5",
                "CryptFile2",
                "CryptoLocker",
                "CryptoMix",
                "CryptoShield",
                "Dridex",
                "Dudear",
                "EmailStealer",
                "FRIENDSPEAK",
                "Fake Globe",
                "Fareit",
                "FlawedAmmyy",
                "FlawedGrace",
                "FlowerPippi",
                "GOZ",
                "GameOver Zeus",
                "GazGolder",
                "Gelup",
                "Get2",
                "GetandGo",
                "GlobeImposter",
                "Gorhax",
                "GraceWire",
                "Gussdoor",
                "Jaff",
                "Kasidet",
                "Kegotip",
                "Kneber",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Locky",
                "MINEBRIDGE",
                "MINEBRIDGE RAT",
                "MirrorBlast",
                "Neutrino Bot",
                "Neutrino Exploit Kit",
                "P2P Zeus",
                "Peer-to-Peer Zeus",
                "Philadelphia",
                "Philadephia Ransom",
                "Pony Loader",
                "Rakhni",
                "ReflectiveGnome",
                "Remote Manipulator System",
                "RockLoader",
                "RuRAT",
                "SDBbot",
                "ServHelper",
                "Shifu",
                "Siplog",
                "TeslaGun",
                "TiniMet",
                "TinyMet",
                "Trojan.Zbot",
                "Wsnpoem",
                "Zbot",
                "Zeta",
                "ZeuS",
                "Zeus"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535912,
    "ts_updated_at": 1743041738,
    "ts_creation_date": 1653767479,
    "ts_modification_date": 1653767479,
    "files": {
        "pdf": "https://archive.orkl.eu/274788554c210509b3f5943338a74b4175845cc0.pdf",
        "text": "https://archive.orkl.eu/274788554c210509b3f5943338a74b4175845cc0.txt",
        "img": "https://archive.orkl.eu/274788554c210509b3f5943338a74b4175845cc0.jpg"
    }
}