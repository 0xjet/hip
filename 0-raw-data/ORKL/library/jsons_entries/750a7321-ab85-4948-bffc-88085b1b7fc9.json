{
    "id": "750a7321-ab85-4948-bffc-88085b1b7fc9",
    "created_at": "2023-01-12T15:03:38.758568Z",
    "updated_at": "2025-03-27T02:09:17.844346Z",
    "deleted_at": null,
    "sha1_hash": "43f9a70b1054194c1e192f67b8a7d8dd1365e90e",
    "title": "2021-09-29 - FormBook Adds Latest Office 365 0-Day Vulnerability (CVE-2021-40444) to Its Arsenal",
    "authors": "",
    "file_creation_date": "2022-05-29T10:37:00Z",
    "file_modification_date": "2022-05-29T10:37:00Z",
    "file_size": 1084375,
    "plain_text": "# FormBook Adds Latest Office 365 0-Day Vulnerability (CVE-2021-40444) to Its Arsenal\n\n**[trendmicro.com/en_us/research/21/i/formbook-adds-latest-office-365-0-day-vulnerability-cve-2021-404.html](https://www.trendmicro.com/en_us/research/21/i/formbook-adds-latest-office-365-0-day-vulnerability-cve-2021-404.html)**\n\nSeptember 29, 2021\n\nExploits & Vulnerabilities\n\nTrend Micro detected a new campaign using a recent version of the known FormBook infostealer. Newer FormBook variants used the recent\nOffice 365 zero-day vulnerability, CVE-2021-40444.\n\nBy: Aliakbar Zahravi, Kamlapati Choubey, Peter Girnus, William Gamazo Sanchez September 29, 2021 Read time: ( words)\n\nTrend Micro detected a new campaign using a recent version of the known FormBook malware, an infostealer that has been around since\n2016. Several analyses have been written about FormBook in the last few years, including the expanded support for macOS. FormBook is\n[famous for highly obfuscated payloads and the use of document CVE exploitation. Until recently, FormBook mostly exploited CVE- 2017-0199,](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2017-0199)\n[but newer FormBook variants used the recent Office 365 zero-day vulnerability,](https://www.trendmicro.com/en_us/research/21/i/remote-code-execution-zero-day--cve-2021-40444--hits-windows--tr.html) [CVE-2021-40444.](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-40444)\n\n**Exploit description**\n\n[FormBook authors did some rewrites on the original exploit, taking as their initial codebase the one that we and](https://www.trendmicro.com/en_us/research/21/i/remote-code-execution-zero-day--cve-2021-40444--hits-windows--tr.html) [Microsoft observed as](https://www.microsoft.com/security/blog/2021/09/15/analyzing-attacks-that-exploit-the-mshtml-cve-2021-40444-vulnerability/)\ndeploying Cobalt Strike beacons. The exploited vulnerability is CVE-2021-40444. However, since the vulnerability itself has been analyzed\nalready, here we focus on describing some of the unique changes made by FormBook.\n\nFormBook utilizes a different “Target” format inside “document.xml.rels.” Figure 1 shows the new format on the right side. This is possible\nbecause the options “mhtml” and “!x-usc” are not required to exploit the vulnerability. The new format is intended to bypass detections using\nthe mentioned “Target” options as indicators of exploitation.\n\nFigure 1. The “Target” URL format: The previous samples are on the left, while those used by FormBook are on the right.\n\n\n-----\n\ne e t e U s sc a b ed us g d ecto y t a e sa pat s a d e pty opt o s o a get (t e co secut e a e e pty opt o s), t e\nvulnerability is exploited, and Word will send a request to the server as the network capture. This is shown by the selected packet in Figure 2.\n\nFigure 2. Network capture of a FormBook document sample\nOne of the changes introduced to the exploit by FormBook was an obfuscation mechanism. Figure 3 shows an obfuscated section of the\nFormBook exploit.\n\nFigure 3. FormBook exploit obfuscation\n\n\n-----\n\ns p e ous y e t o ed, o oo c eato s d d so e e tes o t e o g a e p o t, c as based o t e code d sc osed by us a d\nMicrosoft. FormBook added two calls to a function implementing an anti-debugging behavior commonly used to protect JavaScript code from\nbeing reverse-engineered. Figure 4 displays the mentioned function.\n\nFigure 4. FormBook exploit JavaScript anti debugging\nWhen the developer tools of a browser are open, the execution of the f() function will open a new virtual machine (VM) window that contains an\nanonymous function with a debugger statement. This will shift the focus from the source code window to the new VM window containing the\nanonymous function. Stepping through the JavaScript code will continuously execute the anonymous function. This prevents the debugging of\nthe JavaScript code because stepping through the JavaScript code executes the debugger statement in a loop.\n\n**Attack chain description**\n\nBased on our analysis, the campaign used an email with a malicious Word document attachment as the entry vector. In this attack, two layers\nof PowerShell scripts were used to deliver the known FormBook malware. This version of FormBook is the same as previous versions;\nhowever, some specific changes were introduced in the attack chain. The final FormBook malware delivered in this campaign matched the\nones that were used in earlier campaigns and analyzed by other researchers. That sample also corresponds to FormBook version 4.1, which\nwe found after decrypting the command-and-control (C&C) channel information. This can be seen in Figure 5.\n\nFigure 5. FormBook\n\ndecrypted beacon\nFor this specific campaign, the attack chain is depicted in Figure 6.\n\n\n-----\n\nFigure 6. Simplified attack chain diagram\nFigure 6 shows how FormBook implemented two PowerShell script stages. The first stage downloads the second one, which is stored as an\nattachment hosted on Discord. We have recently noticed an increase in the malicious use of files uploaded to this service, with the intent of\nbypassing network protection.\n\nFigure 7 shows an example of the PowerShell script in the first stage:\n\n\n-----\n\nFigure 7. PowerShell stage one\nThe example in Figure 6 downloads the next stage from Discord (with the URL itself being obfuscated). The URL is in the following format:\n\nhxxps://cdn[.]discordapp[.]com/attachments/889336010087989260/889336402121199686/avatar.jpg\n\nThe attachment from Discord is the second PowerShell layer formatted in Base64. This layer contains all required samples to run the\nFormBook malware.\n\nFigure 8 shows an example of the second PowerShell layer.\n\n\n-----\n\nFigure 8. PowerShell second stage.\nAs Figure 8 shows, the value of the variable “$decompressedByteArray” has the “.NET” injector, and the value of the variable “$INICAYLA” has\nthe FormBook malware itself. In this campaign, the method of injecting the malware into the Calculator process is different from previous\nanalyses, but this is because the result of the obfuscation was applied over the “.NET” injector.\n\nThe samples of the FormBook malware we obtained are identical to previous incidents, so we do not discuss them here.\n\n**Conclusions**\n\nOver the last couple of years, we have seen an increase in the use of public services to host malware. Nowadays, there are infinite ways to\nestablish a malware infrastructure simply by using public services. There are multiple benefits for the attackers when using public services:\n\nExtra service rentals and maintenance are not required.\nThe URLs look like normal URLs to any scanning device or software.\nIn some cases, it is possible to generate practically “random” URLs.\nThere is encrypted traffic (HTTPS) by default.\nAutomatic resources (such as samples and files) access protection.\n\nAt the same time, we have seen an increase in the quality of tools for the automatic generation of obfuscated samples implemented in different\nand available malware as a service (MaaS).\n\nThe combination of those two factors makes the attacker very resilient to detection in the initial delivery days of reusing previously discovered\nzero-day vulnerabilities, as in this case. This incident also highlights the importance of patching zero-day vulnerabilities urgently. Notably,\n[Microsoft already released a fix for this vulnerability as part of the September 2021 Patch Tuesday cycle.](https://www.trendmicro.com/en_us/research/21/i/september-patch-tuesday--66-bulletins--only-3-critical.html)\n\n[For increased protection, Trend Micro Vision One™ spots suspicious behaviors that might seem insignificant when observed from only a single](https://www.trendmicro.com/en_us/business/products/detection-response.html)\n[layer. Meanwhile, Trend Micro Apex One™ protects endpoint devices through automated threat detection and response against ransomware,](https://www.trendmicro.com/en_us/business/products/user-protection/sps.html)\nfileless threats, and other advanced concerns.\n\nIndicators of Compromise\n\n**Filename/Description** **Hash** **Trend Micro De**\n\nExploit Html bb1e9ce455898d6b4d31b2219ff4a5ca9908f7ea0d8046acf846bf839bce1e56 Trojan.HTML.C\n\npayload.cab a20abef4eecea05b3f3ab64e9f448159e683cf82f1e87a37372c1cacb976052c Trojan.Win32.C\n\navatar.ps1 6f11be4822381543eb9dd99a9354575c96a50a5720ee38ee1c1b2ad323a03f04 Trojan.PS1.POW\n\n\n-----\n\npayload_TNICAYLA.exe_ f7c5f885f712adb553ee0de0d935869cc9c5627c01b15a614d748acb72b11c74 Trojan.Win32.F\n\ninjector_ncrypt_decompressedByteArray.exe_ eab5dc8f37459f2f329afa63b1f8e8569ad229dc88497ab86e7c6a91be4d9264 Trojan.Win32.C\n\n**Exploit chain IOCs:**\n\nhxxp://0x6B[.]0254.0113.0244:8090/payload.cab\nhxxp://107[.]172.75.164:8090/microsoftonline.html\nhxxps://cdn[.]discordapp.com/attachments/889336010087989260/889336402121199686/avatar.jpg\n\n**URLs**\n\nhxxp://www.code-nana.com/pjje/?\nt8LP2P=Mf6ydddwV/QU6mZ4nnZxMBdzDcAr2xsvfTgD82WAzYYrxOcjLRrG5mXLygKxYmvGqlzJAQ==&kPq8=K4Nh-6\nhxxp://www.rajuherbalandspicegarden.com/pjje/?\nt8LP2P=DltNRLklEPawWuNnsQXifEZmZKsLvkDXv3cKYhiC/0Bh3Q72JrrE/8woD25qq/vxSOxjNQ==&kPq8=K4Nh-6\n\nhxxp://www.swaplenders.com/pjje/?\nt8LP2P=TQtLDRoafbQM4/pEtdovke1/MPx0w24gCyByZx68z3lV5KTK6L4nUj2UtH2v2BgU+KkBhg==&kPq8=K4Nh-6\nhxxp://www.thechiropractor.vegas/pjje/?\nt8LP2P=rpNmzTsgN3WrlTJLsfA2BlL5A0hwTnOMjBBWuUAz4iRkWF3ty9m96ejMesY0+5JvVxns9g==&kPq8=K4Nh-6\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-29 - FormBook Adds Latest Office 365 0-Day Vulnerability (CVE-2021-40444) to Its Arsenal.pdf"
    ],
    "report_names": [
        "2021-09-29 - FormBook Adds Latest Office 365 0-Day Vulnerability (CVE-2021-40444) to Its Arsenal.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535818,
    "ts_updated_at": 1743041357,
    "ts_creation_date": 1653820620,
    "ts_modification_date": 1653820620,
    "files": {
        "pdf": "https://archive.orkl.eu/43f9a70b1054194c1e192f67b8a7d8dd1365e90e.pdf",
        "text": "https://archive.orkl.eu/43f9a70b1054194c1e192f67b8a7d8dd1365e90e.txt",
        "img": "https://archive.orkl.eu/43f9a70b1054194c1e192f67b8a7d8dd1365e90e.jpg"
    }
}