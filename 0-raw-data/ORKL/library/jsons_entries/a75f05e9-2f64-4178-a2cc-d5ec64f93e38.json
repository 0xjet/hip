{
    "id": "a75f05e9-2f64-4178-a2cc-d5ec64f93e38",
    "created_at": "2023-04-05T02:08:48.778055Z",
    "updated_at": "2025-03-27T02:06:14.014588Z",
    "deleted_at": null,
    "sha1_hash": "7cae6e6e170ab34abb83d3911c29810e44359301",
    "title": "2023-02-01 - Uncovering LockBit Black’s Attack Chain and Anti-forensic activity",
    "authors": "",
    "file_creation_date": "2023-04-03T08:26:29Z",
    "file_modification_date": "2023-04-03T08:26:29Z",
    "file_size": 479199,
    "plain_text": "# Uncovering LockBit Black’s Attack Chain and Anti- forensic activity\n\n**[seqrite.com/blog/uncovering-lockbit-blacks-attack-chain-and-anti-forensic-activity/](https://www.seqrite.com/blog/uncovering-lockbit-blacks-attack-chain-and-anti-forensic-activity/)**\n\nSathwik Ram Prakki February 1, 2023\n\n01\nFebruary\n2023\nWritten by [Sathwik Ram Prakki](https://www.seqrite.com/blog/author/sathwik/)\n\n[Ransomware](https://www.seqrite.com/blog/category/ransomware/)\n\nEstimated reading time: 6 minutes\nSince the infamous Conti ransomware group disbanded due to source code leaks during the\nRussia-Ukraine war, the LockBit group has claimed dominance. The group has adopted new\nextortion techniques and added a first-of-its-kind bug-bounty program, along with many\nfeatures, to advance their new leak site. Upon investigation and analysis, we have\ndetermined that the new LockBit 3.0 variant has a high infection vector and attack chain\nexhibiting substantial anti-forensic activity.\n\n## Attack Overview\n\nLockBit’s new Black variant showed anti-forensic activities which cleared event logs, killed\nmultiple tasks, and deleted services simultaneously. It obtains initial access to the victim’s\nnetwork via SMB brute forcing from various IPs.\n\n\n-----\n\n**_Fig. 1 – Attack Chain_**\n\nThe sys-internal tool PSEXEC is used to execute malicious BAT files on a single system\nwhich were later cleaned off. These files indicate activity related to modifying RDP &\nauthentication settings while disabling antivirus at the same time:\n\nC:\\Windows\\system32\\cmd.exe /c “”openrdp.bat” “\nC:\\Windows\\system32\\cmd.exe /c “”mimon.bat” “\nC:\\Windows\\system32\\cmd.exe /c “”auth.bat” “\nC:\\Windows\\system32\\cmd.exe /c “”turnoff.bat” “\n\nPSEXEC is also used to spread laterally across the victim’s network to execute the\nransomware payload. The encryption is done using a multi-threaded approach where only\nshared drives got encrypted. The executed payload must have a valid key passed along with\nthe command-line option ‘-pass.’ The encrypted files are appended with the .zbzdbs59d\nextension, which suggests that the builder generates each payload with a random static\nstring.\n\n## Payload Analysis\n\nThe ransomware payload is dropped inside the Windows directory, where every variant\nrequires a unique key to be passed as an argument. This feature was previously known to be\nused by other ransomware groups like BlackCat and Egregor. Even if the name of the\npayload is changed from ‘Lock.exe’ to anything else or put in any other directory, it does not\nrun. The pass key used in this case is 60c14e91dc3375e4523be5067ed3b111.\n\nLet us look at a few stages of the payload below:\n\n### Decrypting Sections\n\n\n-----\n\n**_Fig. 2 – Pseudo code for decrypting PE Sections_**\n\nThe key passed in the argument is taken from the command line and verified. If it passes\nverification, this key is further processed to obtain a 1-byte key to decrypt specific sections\nobtained by traversing the PEB structure. The three sections decrypted in memory are –\nTEXT, DATA, and PDATA.\n\n### Resolving Obfuscated APIs\n\nBeing packed and having only a few imports, Win32 APIs are resolved by decrypting the\nobfuscated string with XOR using the key 0x3A013FD5, which is again unique to each\npayload.\n\n**_Fig. 3 – Resolving APIs_**\n\n### Privilege Escalation\n\n\n-----\n\nWhen Admin privileges are not present during execution, it uses CMSTPLUA COM to\nbypass the UAC prompt, a legitimate Windows Connection Manager Service. This elevates\nthe rights from the user to the administrator level with another instance of the ransomware\npayload, terminating the current process.\n\n**_Fig. 4 – UAC Bypass using CMSTPLUA_**\n\n### Anti-Debugging Technique\n\nThreads used for file encryption are hidden from the debugger by calling\n**NtSetInformationThread Win32 API via ThreadInformationClass with an undocumented**\nvalue 0x11 that denotes ThreadHideFromDebugger. This hinders dynamic analysis by not\nallowing debug information from the current ransomware’s thread to reach the attached\ndebugger.\n\n**_Fig. 5 – Anti-Debugging technique to hide threads_**\n\n### Anti-Forensic Activity\n\nAs part of wiping out its traces, lots of anti-forensic activity is observed where Windows\nEvent Logs are disabled by setting multiple registry subkeys to value 0.\n\n\n-----\n\n**HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\WINEVT\\Channels\\**\n\n[Specifically, Windows Defender is disabled for evasion. An exhaustive list of Events Cleared.](https://sebsauvage.net/paste/?b0443b90f3fc5ffc#UomoaFa+vkJS9tcLpJwcH1X38YjfbBZDDf3BBk1abPE=)\n\n**Service Deletion and Process Termination**\n\nProcess terminated included SecurityHealthSystray.exe and the mutex created during\nexecution was 13fd9a89b0eede26272934728b390e06. Services were enumerated using a\npre-defined list and deleted or killed if found on the machine:\n\n1. Sense\n2. Sophos\n3. Sppsvc\n4. Vmicvss\n5. Vmvss\n6. Vss\n7. Veeam\n8. Wdnissvc\n9. Wscsvc\n10. EventLog\n\nA few of the services deleted:\n\nsc stop “Undelete”\nsc delete “LTService”\nsc delete “LTSvcMon”\nsc delete “WSearch”\nsc delete “MsMpEng”\nnet stop ShadowProtectSvc\nC:\\Windows\\system32\\net1 stop ShadowProtectSvc\n\n**Tasks Killed**\n\nScheduled tasks are enumerated and deleted, some of which are shown below. An\nexhaustive list of [Tasks Killed.](https://sebsauvage.net/paste/?8531b9e9ff63f646#2I+OdDt1RxWVhkUJ1HFTCj9g8boqMcrpkfU0ESMJ03Y=)\n\nIBM* PrnHtml.exe* DriveLock.exe* MacriumService.exe*\n\nsql* PAGEANT.EXE* CodeMeter.exe* ReflectMonitor.exe*\n\nvee* firefox.exe* DPMClient.exe* Atenet.Service.exe*\n\nsage* ngctw32.exe* ftpdaemon.exe* account_server.exe*\n\nmysql* omtsreco.exe mysqld-nt.exe* policy_manager.exe*\n\n\n-----\n\nbes10* nvwmi64.exe* sqlwriter.exe* update_service.exe*\n\nblack* Tomcat9.exe* Launchpad.exe* BmsPonAlarmTL1.exe*\n\npostg* msmdsrv.exe* MsDtsSrvr.exe* check_mk_agent.exe*\n\n**Shadow Volume Copies Deleted**\n\nVolume shadow copies are enumerated using a WMI query and then deleted to prevent\nsystem restoration\n\nvssadmin.exe Delete Shadows /All /Quiet\n\n**Removal of all Active Network Connections**\n\nnet use * /delete /y\n\n**Registry Activity**\n\nreg add\n“HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System”\n/v legalnoticecaption /t REG_SZ /d “ATTENTION to representatives!!!! Read before you log\non” /f\n\nreg add\n“HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System”\n/v legalnoticetext /t REG_SZ /d “Your system has been tested for security and unfortunately\nyour system was vulnerable. We specialize in file encryption and industrial (economic or\ncorporate) espionage. We don’t care about your files or what you do, nothing personal – it’s\njust business. We recommend contacting us as your confidential files have been stolen and\nwill be sold to interested parties unless you pay to remove them from our clouds and auction,\nor decrypt your files. Follow the instructions in your system” /f\n\nreg add “HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server” /v\nfDenyTSConnections /t REG_DWORD /d 0 /f\n\nreg add HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\LSA /v RunAsPPL /t\nREG_DWORD /d 0 /f\n\nreg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest /v\nUseLogonCredential /t REG_DWORD /d 1 /f\n\n### Ransom Note\n\nBefore encryption, the ransom note is created in every directory except the Program Files\nand the Windows directory, which aren’t encrypted. We can see that they have moved the\nnaming convention of ransom notes from ‘Restore-My-Files.txt’ to a static string format\n“zbzdbs59d.README.txt”.\n\n\n-----\n\n**_Fig. 6 – Ransom Note_**\n\nThe ransom note contains instructions to install the TOR browser, links for a chat, and the\npersonal ID unique to the victim to communicate with the attackers. It also includes the threat\nmessage to leak the stolen data if the ransom amount is not paid and ends with the warnings\nas usual. Multiple TOR mirrors for their leak site can be seen in the ransom note, which is\nused to reduce redundancy.\n\n### File Encryption\n\nBefore starting file encryption, a registry key for DefaultIcon is created to associate an icon to\nall the encrypted files. Along with this ICO file (zbzdbs59d.ico), a BMP file is also dropped in\nthe C:\\ProgramData directory. Files are encrypted by creating multiple threads where each\nfilename is replaced with a random string generated and appending the extension to them.\nWith full encryption completed under 2 minutes it still has the fastest encryption process\nsince LockBit 2.0.\n\n\n-----\n\n**_Fig. 7 – Encrypted Filenames_**\n\n### Changing Wallpaper\n\nFinally, the desktop background (different from 2.0 variant) of the victim machine is changed\nwith the systemparametersinfoW win32 API, and displays LockBit Black, and instructions to\nbe followed for decryption.\n\n**_Fig. 8 – Modified Wallpaper_**\n\n\n-----\n\n## Conclusion\n\nUnprotected systems in the network were brute-forced to run the PSEXEC tool for lateral\nmovement across the systems. This was done to execute LockBit’s latest Black ransomware\nvariant. With LockBit 3.0 introducing its bug bounty program and adopting new extortion\ntactics, it is mandatory to take precautions like downloading applications only from trusted\nsources, using antivirus for enhanced protection, and avoiding clicking on any links received\nthrough email or social media platforms. As threat actors create their own variants from the\nleaked LockBit Black’s builder, [proactive measures must be taken to stay protected.](https://blogs.quickheal.com/proactive-measures-to-safeguard-against-the-ransomware-menace/)\n\n### IOCs\n\n**MD5** **Protection**\n\n7E37F198C71A81AF5384C480520EE36E Ransom.Lockbit3.S28401281\nHEUR:Ransom.Win32.InP\n\n### IPs\n\n3.220.57.224\n\n72.26.218.86\n\n71.6.232.6\n\n172.16.116.149\n\n78.153.199.241\n\n72.26.218.86\n\n5.233.194.222\n\n27.147.155.27\n\n192.168.10.54\n\n87.251.67.65\n\n71.6.232.6\n\n64.62.197.182\n\n43.241.25.6\n\n31.43.185.9\n\n\n-----\n\n194.26.29.113\n\nJumpsecuritybusiness[.]com\n\n**Subject Matter Experts**\n\nTejaswini Sandapolla\nUmar Khan A\nParag Patil\nSathwik Ram Prakki\n\nSathwik Ram Prakki is working as a Security Researcher in Security Labs at Quick Heal. His\nfocus areas are Threat Intelligence, Threat Hunting, and writing about...\n\n[Articles by Sathwik Ram Prakki »](https://www.seqrite.com/blog/author/sathwik/)\n\n### No Comments\n\nLeave a Reply.Your email address will not be published.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-02-01 - Uncovering LockBit Black’s Attack Chain and Anti-forensic activity.pdf"
    ],
    "report_names": [
        "2023-02-01 - Uncovering LockBit Black’s Attack Chain and Anti-forensic activity.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1680660528,
    "ts_updated_at": 1743041174,
    "ts_creation_date": 1680510389,
    "ts_modification_date": 1680510389,
    "files": {
        "pdf": "https://archive.orkl.eu/7cae6e6e170ab34abb83d3911c29810e44359301.pdf",
        "text": "https://archive.orkl.eu/7cae6e6e170ab34abb83d3911c29810e44359301.txt",
        "img": "https://archive.orkl.eu/7cae6e6e170ab34abb83d3911c29810e44359301.jpg"
    }
}