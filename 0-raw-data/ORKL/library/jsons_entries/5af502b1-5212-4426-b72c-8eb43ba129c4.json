{
    "id": "5af502b1-5212-4426-b72c-8eb43ba129c4",
    "created_at": "2023-01-12T15:05:18.144341Z",
    "updated_at": "2025-03-27T02:08:33.360183Z",
    "deleted_at": null,
    "sha1_hash": "7e734130a8a2f5687fc2d47404cc3f8800222a76",
    "title": "2021-02-17 - Targeting Process for the SolarWinds Backdoor",
    "authors": "",
    "file_creation_date": "2022-05-28T02:39:18Z",
    "file_modification_date": "2022-05-28T02:39:18Z",
    "file_size": 148388,
    "plain_text": "# Targeting Process for the SolarWinds Backdoor\n\n**netresec.com/**\n\nErik Hjelmvik\n\n,\n\nWednesday, 17 February 2021 20:22:00 (UTC/GMT)\n\n\nFebruary 17, 2021\n\n\nThe SolarWinds Orion backdoor, known as SUNBURST or Solorigate, has been analyzed by\nnumerous experts from Microsoft, FireEye and several anti-virus vendors. However, we have\nnoticed that many of the published reports are either lacking or incorrect in how they\n[describe the steps involved when a client gets targeted by the threat actors. We have](https://netresec.com/?b=2113a6a)\ntherefore decided to publish this writeup, which is based on the analysis we did of the\n[SolarWinds backdoor when creating our SunburstDomainDecoder tool.](https://netresec.com/?b=20C0f71)\n\n**UPDATE March 1, 2021**\n\nFixed errors in the Stage 2 beacon structure and added a CyberChef recipe link.\n\n**avsvmcloud.com DNS queries are not DGA related**\n\nThe DNS communication between the backdoored SolarWinds Orion clients and the\nauthoritative name server for avsvmcloud.com is not caused by a Domain Generation\nAlgorithm (DGA), it's actually a fully functional two-way communication C2 channel. The\nclients encode information, such as the internal AD domain and installed security\napplications into the DNS queries and the DNS responses from the name server are used to\ninstruct the clients to continue beaconing, stop beaconing or to target a client by proceeding\nto what we call [Stage 2 operation. Thus, the authoritative name server for avsvmcloud.com](https://netresec.com/?b=2113a6a)\nwas actually the C2 server for Stage 1 and 2 operation of the SolarWinds backdoor.\n\n\n-----\n\n_Image: SolarWinds Backdoor State Diagram_\n\n**Command: Continue Beaconing**\n\nThe default response from the name server is the \"Continue Beaconing\" command, which\nindicates that the threat actors have not yet decided if the SolarWinds client is of interest for\nfurther activity. Receiving a DNS A record in any of the following net ranges instructs the\nSolarWinds backdoor to continue beaconing:\n\n8.18.144.0/23\n71.152.53.0/24\n87.238.80.0/21\n199.201.117.0/24\n\nIn \"Stage 1\" operation the SUNBURST client starts out in the \"New\" mode where it exfiltrates\nthe internal AD domain name. The AD domain data is often split into multiple DNS queries to\nreduce the length of each DNS query. The client later proceeds to the \"Append\" mode when\nthe full AD domain has been exfiltrated. In \"Append\" mode the client transmits a list of\ninstalled or running security applications to the DNS C2 server, as we have described in our\n[Extracting Security Products from SUNBURST DNS Beacons blog post. The client remains](https://netresec.com/?b=20C1c3b)\nin Append mode until it gets either terminated or targeted.\n\n_Note: It is also possible to reset a client back to the \"New\" mode with a so-called \"Ipx\"_\n_command, but that is out of scope for this blog post._\n\n**Command: Stop Beaconing**\n\nThe stop beaconing command terminates the DNS beaconing, so that the client no longer\nretrieves any commands from the C2 server. The C2 communication is stopped after\nreceiving a DNS DNS A or AAAA record in any of the following ranges:\n\n20.140.0.0/15\n96.31.172.0/24\n\n\n-----\n\n131.228.12.0/22\n144.86.226.0/24\n10.0.0.0/8\n172.16.0.0/12\n192.168.0.0/16\n224.0.0.0/3\nfc00:: - fe00::\nfec0:: - ffc0::\nff00::\n\n**Command: Target Client**\n\n[A SUNBURST client that has been \"targeted\" will change a flag called rec.dnssec in the](https://github.com/cadosecurity/MalwareAnalysis/blob/3daecfaa9c8f3257a9da2ab13006b1ebb3a82329/OrionImprovementBusinessLayer.cs#L3525)\nsource code from false to true. We call this flag the \"Stage 2\" flag, which must be set in order\nfor the client to accept a CNAME record and proceed to Stage 3. Symantec [refer to the](https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/solarwinds-unique-dga)\nStage 2 flag as \"a bit flag representing whether the previous DNS response successfully\ncontained partial or full instructions to start the secondary HTTP communication channel\".\n\nA DNS A record in any of the following three IP ranges can be used to set the \"Stage 2\" flag:\n\n18.130.0.0/16\n99.79.0.0/16\n184.72.0.0/15\n\nThe state of the Stage 2 flag is actually signaled in the avsvmcloud.com DNS queries, which\n[is how we managed to identify the AD domains of 23 targeted organizations just by analyzing](https://netresec.com/?b=211cd21)\nSUNBURST DNS queries.\n\n**Stage 2 DNS Request Structure**\n\n[The structure of the SUNBURST DNS queries in Stage 1 is pretty well described by Prevasio](https://blog.prevasio.com/2020/12/sunburst-backdoor-part-iii-dga-security.html)\n[and Symantec, so we will not cover those in this blog post. Instead we will focus specifically](https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/solarwinds-unique-dga)\non the structure of the DNS queries transmitted in Stage 2 operation, where the clients\nrequest a CNAME record from the name server.\n\n[As we have explained previously the exfiltrated data gets base32 encoded, using the custom](https://netresec.com/?b=20C0f71)\nalphabet \"ph2eifo3n5utg1j8d94qrvbmk0sal76c\", in order to ensure that only valid domain\nname characters are used in the DNS beacons.\n\nThe structure of the Stage 2 request, before it gets base32 encoded and appended as an\navsvmcloud.com subdomain, looks like this:\n\n**Field** **Size** **Description**\n\n\n-----\n\nXOR Key 8 bits A value between 0x01 and 0x7F used to XOR encrypt the rest of\nthe data.\n\nGUID 64 bits Client ID encrypted using 16 bit rotating XOR with the last 15 bits\nof Timestamp and the Stage 2 flag.\n\nPacket Type 4 bits A value of 0x1, could in theory be 0x2 but that's very unlikely.\n\nTimestamp 19 bits Number of 30 minute periods since start of 2010 (UTC).\n\nStage 2 Flag 1 bit A flag set to \"1\" in Stage 2 operation, otherwise \"0\".\n\n_Image: Stage 2 beacon structure of the SolarWinds backdoor_\n\nThe base32 encoding not only uses a custom alphabet, it also employs a reversed\nendianess and byte order compared to \"normal\" implementations. We have created a\n[CyberChef recipe that performs this custom base32 decoding, so that the structure can be](https://gchq.github.io/CyberChef/#recipe=Pad_lines('End',4,'p')Reverse('Character')From_Base32('ph2eifo3n5utg1j8d94qrvbmk0sal76c',false)Take_bytes(3,12,false)Swap_endianness('Raw',12,true)To_Hex('Space',4)&input=N3NidmFlbXNjczBtYzkyNXRiOTk)\nverified more easily. A list with 45 different Stage 2 avsvmcloud.com subdomains can be\n[found in our Finding Targeted SUNBURST Victims with pDNS blog post. Feel free to replace](https://netresec.com/?b=2113a6a)\nthe input to our CyberChef recipe with any of those subdomains.\n\n**Sleep Timers**\n\nThe DNS responses from the name server not only controls how the SolarWinds backdoor\nshould transition between the various stages, it also controls for how long the backdoor\nshould wait before sending the next DNS beacon.\n\nThe delay is assigned by AND-ing the last octet of the received IP address with bitmask\n0x54. The result from the AND operation is then used to select a sleep interval in the table\nbelow, within which the client picks a random number of minutes to sleep.\n\n**AND Result** **Name** **Sleep Interval**\n\n0x00 1 hour 30-120 minutes\n\n\n-----\n\n0x04 4 hours 240-300 minutes\n\n0x10 8 hours 480-600 minutes\n\n0x14 1 day 1440-1560 minutes\n\n0x40 3 days 4320-5760 minutes\n\n0x44 1 week 10020-10140 minutes\n\n0x50 2 weeks 20100-20220 minutes\n\n0x54 1 month 43140-43260 minutes\n\nAn exception to the table above is clients that have entered Stage 2, which will only wait one\nto three minutes before requesting a CNAME.\n\n**Example DNS C2 for a Non-Targeted Client**\n\nBelow is an example of DNS queries and responses from a SUNBURST client that wasn't\n[targeted by the threat actors. These particular queries and responses come from a post on](https://thwack.solarwinds.com/t5/NPM-Discussions/SUNBURST-HF1-Mitigation-Details/m-p/612582/highlight/true#M150761)\nSolarWinds' community forum.\n\n2020-07-04 00:03 UTC\nQuery: if9prvp9o36mhihw2hrs260g12eu1 ⇒ AD domain \"omeros.local\"\nResponse: 8.18.145.139 ⇒ sleep 1h, then Continue\n2020-07-04 01:08 UTC\nQuery: hnhb3v1b37dvv09icg0edp0 ⇒ Carbon Black is running\nResponse: 8.18.145.62 ⇒ sleep 1 day, then Continue\n2020-07-05 01:15 UTC\nQuery: ea99hr2sfen95nkjlc5g ⇒ Nothing new to report\nResponse: 8.18.144.150 ⇒ sleep 1 day, then Continue\n2020-07-06 02:42 UTC\nQuery: 707gigk9vbc923hf27fe ⇒ Nothing new to report\nResponse: 8.18.145.151 ⇒ sleep 1 day, then Continue\n2020-07-07 03:52 UTC\nQuery: 6eivqct649pcg0g16ol4 ⇒ Nothing new to report\nResponse: 20.140.84.127 ⇒ **Stop DNS beacon**\n\n_Note: Queried domain names in this list are subdomains of appsync-api.eu-west-_\n_1.avsvmcloud.com._\n\n**Example DNS C2 for a Targeted Client**\n\n\n-----\n\n_Disclaimer: We have very few DNS queries and responses for targeted victims, hence the_\n_[transactions below are improvised based on data from VriesHd,](https://twitter.com/VriesHd/status/1339673992307892224)_ _[Joe Słowik and](https://twitter.com/jfslowik/status/1338321984527228928)_ _[FireEye.](https://github.com/fireeye/sunburst_countermeasures/blob/main/indicator_release/Indicator_Release_NBIs.csv)_\n_Please view these transactions as an example of what the communication might look like for_\n_a targeted victim rather than what actually happened to this particular target._\n\n2020-06-11 04:00 UTC\nQuery: r8stkst71ebqgj66ervisu10bdohu0gt ⇒ AD domain, part 1 \"central.pima.g\"\nResponse: 8.18.144.1 ⇒ Sleep 1h, then Continue\n2020-06-11 05:00 UTC\nQuery: ulfmcf44qd58t9e82w ⇒ AD domain, part 2 \"ov\"\nResponse: 8.18.144.2 ⇒ Sleep 1h, then Continue\n2020-06-11 06:00 UTC\nQuery: p50jllhvhmoti8mpbf6p2di ⇒ Nothing to report\nResponse: 8.18.144.16 ⇒ Sleep 8h, then Continue\n2020-06-11 14:00 UTC\nQuery: (?) ⇒ Nothing new to report\nResponse: 8.18.144.17 ⇒ Sleep 8h, then Continue\n2020-06-11 22:35 UTC\nQuery: j5uqlssr1hfqnn8hkf172mp ⇒ Nothing to report\nResponse: 184.72.181.52 ⇒ **Target client for Stage 2 operation (1-3 minutes sleep)**\n2020-06-11 22:37 UTC\nQuery: 7sbvaemscs0mc925tb99 ⇒ Client in Stage 2 operation, requesting CNAME\nResponse: deftsecurity.com ⇒ **CNAME for Stage 3 HTTPS C2 server**\n\n_Note: Queried domains in this list are subdomains of appsync-api.us-west-_\n_2.avsvmcloud.com._\n\n**Conclusions**\n\nWe hope this blog post clears up any misunderstandings regarding the targeting process of\nthe SolarWinds backdoor and highlights the significance of the Stage 2 flag.\n\nWe warmly welcome any feedback or questions you might have regarding this writeup,\n[please feel free to contact us or reach out to us through Twitter.](https://www.netresec.com/?page=AboutNetresec)\n\nPosted by Erik Hjelmvik on Wednesday, 17 February 2021 20:22:00 (UTC/GMT)\n\n[Tags: #SolarWinds #backdoor #SUNBURST #Solorigate #FireEye #Microsoft #CNAME](https://netresec.com/?page=Blog&tag=SolarWinds)\n[#STAGE2 #Stage 2 #DNS #avsvmcloud.com #C2 #CyberChef #ASCII-art](https://netresec.com/?page=Blog&tag=STAGE2)\n\n## Recent Posts\n\n» [Real-time PCAP-over-IP in Wireshark](https://netresec.com/?page=Blog&month=2022-05&post=Real-time-PCAP-over-IP-in-Wireshark)\n\n» [Emotet C2 and Spam Traffic Video](https://netresec.com/?page=Blog&month=2022-05&post=Emotet-C2-and-Spam-Traffic-Video)\n\n\n-----\n\n» [Industroyer2 IEC-104 Analysis](https://netresec.com/?page=Blog&month=2022-04&post=Industroyer2-IEC-104-Analysis)\n\n» [NetworkMiner 2.7.3 Released](https://netresec.com/?page=Blog&month=2022-04&post=NetworkMiner-2-7-3-Released)\n\n» [PolarProxy in Windows Sandbox](https://netresec.com/?page=Blog&month=2022-01&post=PolarProxy-in-Windows-Sandbox)\n\n» [PolarProxy 0.9 Released](https://netresec.com/?page=Blog&month=2022-01&post=PolarProxy-0-9-Released)\n\n## Blog Archive\n\n» [2022 Blog Posts](https://netresec.com/?page=Blog&year=2022)\n\n» [2021 Blog Posts](https://netresec.com/?page=Blog&year=2021)\n\n» [2020 Blog Posts](https://netresec.com/?page=Blog&year=2020)\n\n» [2019 Blog Posts](https://netresec.com/?page=Blog&year=2019)\n\n» [2018 Blog Posts](https://netresec.com/?page=Blog&year=2018)\n\n» [2017 Blog Posts](https://netresec.com/?page=Blog&year=2017)\n\n» [2016 Blog Posts](https://netresec.com/?page=Blog&year=2016)\n\n» [2015 Blog Posts](https://netresec.com/?page=Blog&year=2015)\n\n» [2014 Blog Posts](https://netresec.com/?page=Blog&year=2014)\n\n» [2013 Blog Posts](https://netresec.com/?page=Blog&year=2013)\n\n» [2012 Blog Posts](https://netresec.com/?page=Blog&year=2012)\n\n» [2011 Blog Posts](https://netresec.com/?page=Blog&year=2011)\n\n[List all blog posts](https://netresec.com/?page=Blog&blogPostList=true)\n\n## NETRESEC on Twitter\n\nFollow [@netresec on twitter:](http://twitter.com/netresec)\n\n» [twitter.com/netresec](http://twitter.com/netresec)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-02-17 - Targeting Process for the SolarWinds Backdoor.pdf"
    ],
    "report_names": [
        "2021-02-17 - Targeting Process for the SolarWinds Backdoor.pdf"
    ],
    "threat_actors": [
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535918,
    "ts_updated_at": 1743041313,
    "ts_creation_date": 1653705558,
    "ts_modification_date": 1653705558,
    "files": {
        "pdf": "https://archive.orkl.eu/7e734130a8a2f5687fc2d47404cc3f8800222a76.pdf",
        "text": "https://archive.orkl.eu/7e734130a8a2f5687fc2d47404cc3f8800222a76.txt",
        "img": "https://archive.orkl.eu/7e734130a8a2f5687fc2d47404cc3f8800222a76.jpg"
    }
}