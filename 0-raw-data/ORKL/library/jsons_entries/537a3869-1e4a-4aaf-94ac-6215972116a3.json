{
    "id": "537a3869-1e4a-4aaf-94ac-6215972116a3",
    "created_at": "2023-01-12T15:00:33.200416Z",
    "updated_at": "2025-03-27T02:05:32.94395Z",
    "deleted_at": null,
    "sha1_hash": "5c986cf4f1bd683ae543fb3d7cefa732dade7694",
    "title": "2022-07-24 - A DGA Seeded by the Bitcoin Genesis Block",
    "authors": "",
    "file_creation_date": "2022-08-18T03:53:54Z",
    "file_modification_date": "2022-08-18T03:53:54Z",
    "file_size": 868139,
    "plain_text": "# The Domain Generation Algorithm of Orchard v3\n\n**bin.re/blog/a-dga-seeded-by-the-bitcoin-genesis-block/**\n\nA DGA Seeded by the Bitcoin Genesis Block\n\nTable of Contents\nDisclaimer\nThese are just unpolished notes. The content likely lacks clarity and structure; and the\nresults might not be adequately verified and/or incomplete.\n\nChanges\n\n2022-08-08 07:27:13: fixed the regex for version 1.63\n\nMalpedia\n[For more information about the malware in this blog post see the Malpedia entry on Orchard.](https://malpedia.caad.fkie.fraunhofer.de/details/win.orchard)\n\nVirusTotal\n\n\n-----\n\n[The IOCs in this blog post are summarized in this VirusTotal Collection. .](https://www.virustotal.com/gui/collection/a027d14bee2a97dddd656b8d008c9f97426e599dff72fd09af95c1d32c2c6289)\n\nCover Image Photo by [Dmitry Demidko on](https://unsplash.com/@wildbook) [Unsplash](https://unsplash.com/)\n**[Edit 2022-08-08: Two weeks after this blog post, 360 Netlab published a detailed report on](https://blog.netlab.360.com/orchard-dga/)**\nthe malware, whose DGA version 3 I have described below. Please read Netlab’s post for\ngeneral informations about the malware and two older DGA’s that is uses. I have adopted the\nname “Orchard” that they have given to the malware.\n\nXMRig is an open-source software for mining cryptocurrencies like Monero or Bitcoin. It is\nalso frequently used by cryptojacking malware to mine cryptocurrencies on victims’\ncomputers. These malwares are a dime a dozen and are mostly unremarkable — to the point\nthat they remain unnamed by AV vendors. Orchard is no exception. What sets the sample\napart, however, is its Domain Generation Algorithm (DGA) which uses two different sources\nfor seeding:\n\n1. the current date — which is deterministic of course\n2. balance of the Bitcoin genesis block (the first block on the Bitcoin blockchain) — which\n\nis not deterministic\n\nFor both seeds the same algorithm is used to generate the domains. The first 16 domains\nare derived from the current date, while the next 16 domains are based on the Bitcoin block:\n\n\n-----\n\nFigure\n\n1DNS traffic related to the DGA. The first 16 domains are seeded with the date, and the last\n16 domains with the genesis block, whose current balance is retrieved from blockchain.info\n[(larger version).](https://bin.re/blog/a-dga-seeded-by-the-bitcoin-genesis-block/assets/cap1-fs.png)\nI analyzed the following sample:\n\n**File type**\nPE32 executable (GUI) Intel 80386, for MS Windows\n\n**MD5**\n\n\n-----\n\n077b6b101cccb3d77a98e2cc02003526\n\n**SHA1**\n9e4f04d513ef119d7872c7ce0af6ffbdf4f42a7c\n\n**SHA256**\n2e63bbbbbb11c21445885f85fc8ef398737184c603f365c8e77a8cbf7523cac9\n\n**Size**\n507 KB (519680 Bytes)\n\n**Compile Timestamp**\n2022-06-19 16:47:27 UTC\n\n**Links**\n[MalwareBazaar,](https://bazaar.abuse.ch/sample/2e63bbbbbb11c21445885f85fc8ef398737184c603f365c8e77a8cbf7523cac9/) [Cape,](https://www.capesandbox.com/analysis/293424/) [Dropping_sha256,](https://bin.re/blog/a-dga-seeded-by-the-bitcoin-genesis-block/ad1e39076212d8d58ff45d1e24d681fe0c600304bd20388cddcf9182b1d28c2f) [Dropping_md5,](https://bin.re/blog/a-dga-seeded-by-the-bitcoin-genesis-block/5c13ee5dbe45d02ed74ef101b2e82ae6) [VirusTotal](https://www.virustotal.com/gui/file/2e63bbbbbb11c21445885f85fc8ef398737184c603f365c8e77a8cbf7523cac9)\n\n**Filenames**\nuAAAACCCGGGJ.exe (VirusTotal )\n\n**Detections[**\n**Virustotal: 53/73 as of 2022-07-22, nothing specific**\n\nThe sample unpacks to this binary, which — like the original — can be downloaded from\nMalwareBazaar:\n\n**File type**\nPE32 executable (GUI) Intel 80386, for MS Windows\n\n**MD5**\n5c13ee5dbe45d02ed74ef101b2e82ae6\n\n**SHA1**\nbdc36bc233675e7a96faa2c4917e9b756cc2a2a0\n\n**SHA256**\nad1e39076212d8d58ff45d1e24d681fe0c600304bd20388cddcf9182b1d28c2f\n\n**Size**\n400 KB (409600 Bytes)\n\n**Compile Timestamp**\n2022-06-19 19:59:36 UTC\n\n**Links**\n[MalwareBazaar,](https://bazaar.abuse.ch/sample/ad1e39076212d8d58ff45d1e24d681fe0c600304bd20388cddcf9182b1d28c2f/) [Dropped_by_md5,](https://bin.re/blog/a-dga-seeded-by-the-bitcoin-genesis-block/077b6b101cccb3d77a98e2cc02003526) [Dropping_sha256,](https://bin.re/blog/a-dga-seeded-by-the-bitcoin-genesis-block/2e63bbbbbb11c21445885f85fc8ef398737184c603f365c8e77a8cbf7523cac9) [Cape,](https://www.capesandbox.com/analysis/293425/) [Dropped_by_sha256,](https://bin.re/blog/a-dga-seeded-by-the-bitcoin-genesis-block/2e63bbbbbb11c21445885f85fc8ef398737184c603f365c8e77a8cbf7523cac9)\n[VirusTotal](https://www.virustotal.com/gui/file/ad1e39076212d8d58ff45d1e24d681fe0c600304bd20388cddcf9182b1d28c2f)\n\n**Detections**\n**Virustotal: 53/74 as of 2022-07-22, nothing specific.**\n\n\n-----\n\nMany more samples that feature the DGA can be found on VirusTotal since June 22, 2022,\n[with a clear cluster on July 6 and 7. The hashes are summarized in this VT Collection.](https://www.virustotal.com/gui/collection/a027d14bee2a97dddd656b8d008c9f97426e599dff72fd09af95c1d32c2c6289/)\n\n## Seeding\n\nThe first seed is calculated by taking the current date and formatting it as `YYYY-mm-dd,`\ne.g., `2022-07-23 . Then a hardcoded domain name is appended. In the examined sample,`\nthe domain is “ ojena.duckdns.org ” so the resulting seed string would be “ 2022-07```\n23ojena.duckdns.org ”.\n\n```\nThe second seed is obtained by making a GET request to the following URL:\n\n```\nhttps://blockchain.info/balance?active=1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa\n\n```\n\nThis url returns the current balance of the Bitcoin genesis block. The response is the seed for\nthe DGA, for example:\n```\n{\"1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa\":\n{\"final_balance\":6854870116,\"n_tx\":3389,\"total_received\":6854870116}}\n\n\n```\nDue to the fame of the genesis account, it receives many transactions, which all result in a\nchanged seed string and therefore different domains. The time between transactions varies\ngreatly, but there was only about a 20% chance last year that a domain would have been\nvalid for more than 2 days.\n\n[Figure 2Lifespan of DGA domains seeded by the Bitcoin genesis block (larger version).](https://bin.re/blog/a-dga-seeded-by-the-bitcoin-genesis-block/assets/lifespan-fs.png)\nDGAs that use undeterministic sources for seeding are rare: Bedep used the foreign\nexchange reference rates published by the European Central Bank and Torpig Twitter trends.\nUnlike for these two examples, the seed in our case can be changed by anyone with a\n\n\n-----\n\npredictable outcome. This allows domains to be registered before they are used by Orchard,\nsomething which is not possible for Bedep and Torpig whose seeds can’t be influenced.\n\n## Domain Generation\n\nThe DGA itself is very simple: The seed string is MD5-hashed, then the hex representation of\nthe hash is split into 4 strings of 8 characters to form the second level domains (sld). These 4\nslds are then combined with 4 hardcoded top level domains to form 16 domains:\n\nFigure 3Illustration of the DGA [(larger version)](https://bin.re/blog/a-dga-seeded-by-the-bitcoin-genesis-block/assets/dga-fs.png)\n\n## Reimplementation\n\nThe following script is a reimplementation of the DGA in Python. It can generate the first set\nof domains for arbitrary dates, but if you like to generate the second set of domains seeded\nby the genesis block, you need to request it with the `-b command line argument. This will`\ncheck if the date is covered by a local database of transactions of the Bitcoin genesis block.\nIf necessary, this database will be updated by downloading transactions from blockchain.info.\nYou find the DGA on my Github 1, along with a database of transactions until July 2022.\n\n\n-----\n\n```\nimport argparse\n\nimport hashlib\n\nimport itertools\n\nimport json\n\nimport os\n\nimport time\n\nfrom datetime import date, datetime\n\nfrom typing import Iterator, Union\n\nimport requests\n\nLIMIT = 100\n\nDB_PATH = \"db.json\"\n\nBLOCK = \"1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa\"\n\nPATTERN = '{\"1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa\":\n{\"final_balance\":FB,\"n_tx\":NTX,\"total_received\":FB}}'\n\n\ndef refresh_blockchain_db():\n\n  offset = 0\n\n  if os.path.exists(DB_PATH):\n\n    with open(DB_PATH) as r:\n\n      db = json.load(r)\n\n  else:\n\n    db = {}\n\n  while True:\n\n    url = f\"https://blockchain.info/multiaddr?active={BLOCK}&limit=\n{LIMIT}&offset={offset}\"\n\n    r = requests.get(url)\n\n    data = r.json()\n\n    error = data.get('error')\n\n    if error:\n\n      print(f\"error updating blockchain balance: {data}\")\n\n      quit()\n\n    txs = data[\"txs\"]\n\n    for tx in txs:\n\n      h = tx['hash']\n\n      if h in db:\n\n        break\n\n      db[h] = tx\n\n    else:\n\n      time.sleep(1)\n\n      offset += LIMIT\n\n      continue\n\n    break\n\n  with open(DB_PATH, \"w\") as w:\n\n    json.dump(db, w, indent=2)\n\n\ndef get_blockchain_seed(when, updated: bool = False) -> str:\n\n```\n\n-----\n\n```\n  if when > datetime.now():\n\n    raise ValueError(\n\n      \"you can't generate the blockchain domains for the future!\")\n\n  with open(DB_PATH) as r:\n\n    transactions = json.load(r)\n\n  transactions = sorted(\n\n    transactions.values(),\n\n    key=lambda x: x['time'],\n\n    reverse=True\n\n  )\n\n  ntx = len(transactions) + 1\n\n  for i, transaction in enumerate(transactions):\n\n    tt = transaction[\"time\"]\n\n    time = datetime.fromtimestamp(tt)\n\n    if when < time:\n\n      continue\n\n    if i == 0 and not updated:\n\n      \"\"\" if the desired date is later than the latest transaction,\n\n        then update the transaction database to make sure it is\n\n        the current transaction you like to access \"\"\"\n\n      refresh_blockchain_db()\n\n      return get_blockchain_seed(when, updated=True)\n\n    balance = transaction['balance']\n\n    return PATTERN.replace(\"FB\", str(balance)).replace(\"NTX\", str(ntx-1))\n\n  raise ValueError(\"the provided date is before the first transaction\")\n\n\ndef dga(when: Union[date, datetime], blockchain: bool = False) -> Iterator[str]:\n\n  for i in range(2):\n\n    if i and not blockchain:\n\n      return\n\n    if i == 0:\n\n      magic = when.strftime(\"%Y-%m-%d\")\n\n      seed = f\"{magic}ojena.duckdns.org\"\n\n    else:\n\n      magic = get_blockchain_seed(when)\n\n      seed = f\"{magic}\"\n\n    md5 = hashlib.md5(seed.encode(\"ascii\")).hexdigest()\n\n    slds = [md5[i:i+8] for i in range(0, len(md5), 8)]\n\n    tlds = [\".net\", \".com\", \".org\", \".duckdns.org\"]\n\n    for sld, tld in itertools.product(slds, tlds):\n\n      yield f\"{sld}{tld}\"\n\n\ndef date_parser(s):\n\n```\n\n-----\n\n```\n  return datetime.strptime(s, %Y %m %d )\n\n\nif __name__ == \"__main__\":\n\n  now = datetime.now().strftime(\"%Y-%m-%d\")\n\n  parser = argparse.ArgumentParser(\n\n    description=\"DGA based on Bitcoin Genesis Block\"\n\n  )\n\n  parser.add_argument(\n\n    \"-d\", \"--date\",\n\n    help=\"date for which to generate domains, e.g., 2022-05-09\",\n\n    default=now,\n\n    type=date_parser\n\n  )\n\n  parser.add_argument(\n\n    \"-b\", \"--blockchain\",\n\n    help=\"also generate blockchain domains, requires blockchain db\",\n\n    action='store_true'\n\n  )\n\n  args = parser.parse_args()\n\n  for domain in dga(args.date, args.blockchain):\n\n    print(domain)\n\n## Characteristics of the DGA\n\n```\nThe following table summarizes the properties of the DGA\n\n**property** **value**\n\ntype TDD-H and TDN-H\n\nseeding time-dependent deterministic and indeterministic\n\ngeneration scheme hash\n\nseed current date\n\ndomain change frequency every day / arbitrary\n\nunique domains per day 32\n\nsequence sequential\n\nwait time between domains none\n\ntop level domain .com, .net, .org, .duckdns.org\n\nsecond level characters 0-9a-f\n\nregex `[0-9a-f]{8}\\.(com|net|org|duckdns\\.org)`\n\n\n-----\n\n**property** **value**\n\nsecond level domain length 8\n\n## C2 Communication\n\nThe DGA domains — along with the hardcoded domain ( ojena.duckdns.org ) — are used\nto control XMRig. First, the client sends some fingerprinting information like the following to\nthe C2. The data is sent unencrypted to a hardcoded port, in my sample to port 25654:\n```\n{\n\n \"Active_Window\": \"*internet\",\n\n \"Antivirus\": [\"Windows Defender\"],\n\n \"Authenticate_Type\": 0,\n\n \"CPU_Model\": \"12th Gen Intel(R) Core(TM) i9-12900K\",\n\n \"Camera\": false,\n\n \"Elevated\": false,\n\n \"GPU_Models\": [\n\n  {\n\n   \"Name\": \"-\",\n\n   \"Type\": 2\n\n  }\n\n ],\n\n \"Identity\": \"F12C8A2E\\Username\\DESKTOP-XYZ\",\n\n \"Operating_System\": \"\n{\\\"BuildNumber\\\":19044,\\\"MajorVersion\\\":10,\\\"MinorVersion\\\":0,\\\"ProductType\\\":false}\",\n\n \"Ram_Size\": 17179332608,\n\n \"System_Architecture\": 1,\n\n \"Threads\": 4,\n\n \"Version\": 2\n\n}\n\n\n```\nAfter that, the XMRig JSON RPC communication is also sent — again unencrypted — to the\nC2. For example the login:\n\n\n-----\n\n```\n{\n\n \"id\": 1,\n\n \"jsonrpc\": \"2.0\",\n\n \"method\": \"login\",\n\n \"params\": {\n\n  \"login\": \"CPU\",\n\n  \"pass\": \"x\",\n\n  \"agent\": \"XMRig/6.15.2 (Windows NT 10.0; Win64; x64) libuv/1.38.0 msvc/2019\",\n\n  \"algo\": [\"cn/0\", \"cn/1\", \"cn/2\", \"cn/r\", \"cn/fast\", \"cn/half\", \"cn/xao\",\n\n   \"cn/rto\", \"cn/rwz\", \"cn/zls\", \"cn/double\", \"cn/ccx\", \"cn-lite/0\",\n\n   \"cn-lite/1\", \"cn-heavy/0\", \"cn-heavy/tube\", \"cn-heavy/xhv\", \"cn-pico\",\n\n   \"cn-pico/tlo\", \"cn/upx2\", \"rx/0\", \"rx/wow\", \"rx/arq\", \"rx/graft\",\n\n   \"rx/sfx\", \"rx/keva\", \"argon2/chukwa\", \"argon2/chukwav2\", \"argon2/ninja\",\n\n   \"astrobwt\"]\n\n }\n\n}\n\n```\nThese JSON RPC connections of XMRig will be detected by many Suricata rules.\n\n## Detection\n\nSpeaking of detections: there are many YARA rule hits you will see both on VirusTotal and\nMalwareBazaar:\n\nUnfortunately, all these rules by The DFIR Report are non functional 2. I wrote the following\nYARA rule, but it only matches on the unpacked sample, e.g., on memory dumps:\n\n\n-----\n\n```\nrule win_bitcoin_genesis_b9 {\n\n  meta:\n\n    author   = \"Johannes Bader @viql\"\n\n    date    = \"2022-07-22\"\n\n    description = \"detects a downloader with a DGA based on the Bitcoin Genesis\nBlock\"\n\n    tlp     = \"TLP:WHITE\"\n\n    version   = \"v1.0\"\n\n    hash_md5  = \"5c13ee5dbe45d02ed74ef101b2e82ae6\"\n\n    hash_sha1  = \"bdc36bc233675e7a96faa2c4917e9b756cc2a2a0\"\n\n    hash_sha256 =\n\"ad1e39076212d8d58ff45d1e24d681fe0c600304bd20388cddcf9182b1d28c2f\"\n\n  strings:\n\n    $str_json_1 = \"\\\"bytes\\\": [\"\n\n    $str_json_2 = \"\\\"subtype\\\": \"\n\n    $str_json_3 = \"{\\\"bytes\\\":[\"\n\n    $str_json_4 = \"],\\\"subtype\\\":\"\n\n    $str_json_5 = \"null}\"\n\n    $str_json_6 = \"<discarded>\"\n\n    $str_json_7 = \"[json.exception.\"\n\n    /*\n\n      mov   dl, [ebp+var_14]\n\n      mov   [eax+ecx], dl\n\n      mov   byte ptr [eax+ecx+1], 0\n\n      jmp   short loc_3CBF9F\n\n    */\n\n    $split_hash_1 = {8A 55 ?? 88 14 08 C6 44 08 01 00 EB}\n\n    /*\n\n      inc   ebx\n\n      cmp   ebx, 10h\n\n      jl   loc_3CBF10\n\n    */\n\n    $split_hash_2 = {43 83 FB 10 0F 8C}\n\n    /*\n\n      push  0\n\n      push  0\n\n      mov   [ebp-14h], edx\n\n      mov   [ebp-18h], eax\n\n    */\n\n    $format_the_date = {6A 00 6A 00 89 55 EC 89 45 E8}\n\n  condition:\n\n    uint16(0) == 0x5A4D and\n\n    all of ($str_json_*) and\n\n    all of ($split_hash_*) and\n\n    $format_the_date\n\n}\n\n```\n\n-----\n\n1. [https://github.com/baderj/domain_generation_algorithms/tree/master/xmrig_genesis](https://github.com/baderj/domain_generation_algorithms/tree/master/xmrig_genesis) ↩︎\n\n2. [https://github.com/The-DFIR-Report/Yara-Rules/issues/2](https://github.com/The-DFIR-Report/Yara-Rules/issues/2) ↩︎\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-07-24 - A DGA Seeded by the Bitcoin Genesis Block.pdf"
    ],
    "report_names": [
        "2022-07-24 - A DGA Seeded by the Bitcoin Genesis Block.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535633,
    "ts_updated_at": 1743041132,
    "ts_creation_date": 1660794834,
    "ts_modification_date": 1660794834,
    "files": {
        "pdf": "https://archive.orkl.eu/5c986cf4f1bd683ae543fb3d7cefa732dade7694.pdf",
        "text": "https://archive.orkl.eu/5c986cf4f1bd683ae543fb3d7cefa732dade7694.txt",
        "img": "https://archive.orkl.eu/5c986cf4f1bd683ae543fb3d7cefa732dade7694.jpg"
    }
}