{
    "id": "1d9e4053-d57e-4a6f-8791-b676e0f0d121",
    "created_at": "2023-01-12T15:01:42.549796Z",
    "updated_at": "2025-03-27T02:05:59.919393Z",
    "deleted_at": null,
    "sha1_hash": "2d711cb84c7054ed6b9048ef92a9d9dda140cb47",
    "title": "2018-04-17 - Reversing the Bandios - Colony Malware",
    "authors": "",
    "file_creation_date": "2022-05-28T19:14:14Z",
    "file_modification_date": "2022-05-28T19:14:14Z",
    "file_size": 1050392,
    "plain_text": "# Reversing Bandios/Colony Malware\n\n**secrary.com/ReversingMalware/Colony_Bandios/**\n\n[cd ../reverse_engineering_malware 7 minutes read](https://secrary.com/ReversingMalware)\n[SHA256: 59c662a5207c6806046205348b22ee45da3f685fe022556716dbbd6643e61834](https://www.virustotal.com/#/file/59c662a5207c6806046205348b22ee45da3f685fe022556716dbbd6643e61834)\n\n[I found the sample on the ANY.RUN sandbox.](https://app.any.run/tasks/1aff9ff2-0b76-45b4-9e3d-b51796b637ad)\n\nOn the `ANY.RUN sandbox we see that it spawns the child process with` `-install`\nargument, the child process creates several files under `%SYSTEM_DIRECTORY% :`\n\n\n-----\n\n[If we run the same executable on hybrid-analysis we get almost nothing, it executes](https://www.hybrid-analysis.com/sample/59c662a5207c6806046205348b22ee45da3f685fe022556716dbbd6643e61834?environmentId=100)\nrecursively and never ends:\n\nLet’s dive in deep and see what happens.\n\n```\nNOTE: I've renamed functions after analysis\n\n```\n\nAfter getting the necessary privileges it checks if `-install argument is there. if not, it`\nexecutes `copy_tmp_with_install_arg and` `collect_encrypt_send, otherwise`\n\n\n-----\n\nInside `copy_tmp_with_install_arg it copies itself to` `%TEMP% directory and executes`\nwith the `-install argument:`\n\n\n-----\n\nA very interesting fact is that there are two ways to execute application using the\n```\nCreateProcess function:\nCreateProcess(exePath, nullptr, ...); and CreateProcess(nullptr, exePath,\n...);, if we run the program via the first method we get command line string with quotation\n\n```\nmarks, otherwise we get one without it:\n\n\n-----\n\nThe sample calls the second variant and at the beginning of the process it checks the\narguments without quotation marks, in the normal environment it works as expected but not\non the `hybrid-analysis sandbox. Most likely,` `hybrid-analysis hooks`\n```\nCreateProcess at some level and after checking parameters it changes something and\n\n```\npasses arguments to lower functions, so, at the end, we get a different command line string,\nwhich causes infinite recursion in case of the sample.\n\nWe can use this simple technique to bypass `hybrid-analysis sandbox ( any.run is`\nimmune):\n\n\n-----\n\nThat s the reason why `hybrid-analysis fails. Let s back to our analysis.`\n\n```\nUPDATE 17.04.2018: The bypass on hybrid-analysis is fixed now\n\n```\n\nAfter executing child process with `-install parameter, it calls` `collect_encrypt_send`\nfunction and starts collection information about the system:\n\nWindows version:\n\nInstalled browser:\n\n\n-----\n\n```\nNOTE: A clean version of Windows 10 contains\nHKEY_CURRENT_USER\\Software\\Google\\Chrome key, even if there is no Chrome\ninstalled, so this method is not reliable\n\n```\nInstalled AV via checking `HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\%AV_NAME% key:`\n\n\n-----\n\nMAC address of the adapter and system language:\n\n\n-----\n\nIt passes the collected information to the `machine_info_AES_base64 function, which`\nencrypts the content with `AES and encodes with` `base64 :`\n\n\n-----\n\nInside `machine_info_AES_base64 it calls` `CoCreateGuid to generate 8 bytes of random`\ndata and adds another 8 bytes hardcoded value `1Q2a3k79 :`\n\nThe sample uses `MD5 functions from` `advapi32.dll to calculate the` `md5 hash of the`\nabovementioned 16 bytes string ( 8_rand_bytes_8_hard_coded )\n\n\n-----\n\nAfter that, it uses the hash as the key to encrypt the system information using `AES`\nalgorithm and encodes the encrypted content via `base64 :`\n\n\n-----\n\n```\nNOTE : IDAScope plugin for IDA Pro is very useful to detect which cryptography algorithms\n\n```\nare used in a sample.\n\nIt sends the encrypted and encoded data to `iostream.system.band/dump/io/time.php :`\n\n\n-----\n\nThe first 8 bytes are generated by the `CoCreateGuid call. There is simple code to decrypt`\nthe traffic content:\n\nAfter sending system information, the parent process dies, but the child process continues\nexecution with the `-install argument, and in this case, it executes the`\n```\niaStorE_and_files function.\n\n```\nAfter calling the `GetNativeSystemInfo function, it extracts 32-bit or 64-bit executables`\nbased on the `SYSTEM_INFO.dwOemId field`\n\n\n-----\n\nAfter checking the system architecture it calls `write_spoolsr_and_MSdat and there it`\ndecrypts `PE from` `byte_443870 (in case of a` `0x64-bit system) using` `0xDD as the key,`\ngenerates random `0x40 bytes and appends to the decrypted file, it saves the decrypted file`\nas `%SYS_DIR%\\\\spoolsr.exe and the encrypted file as` `%SYS_DIR%\\\\MS.dat :`\n\nSimilarly, `KeyHook_usp20_n_dats extract, decrypt and creates following files:`\n```\nKeyHook64.dll, KH.dat, usp20.dll and UP.dat :\n\n```\n\n-----\n\n```\nKeyHook64.dll is decrypted KH.dat, spoolsr.exe is decrypted MS.dat and\nusp20.dll is decrypted UP.dat .\n\n```\nAfter that, it extracts the data from resources ( 0x110 in case of `0x64 system and` `0x108`\notherwise) of the sample and seems like it’s encrypted or compressed data:\n\n\n-----\n\nAnd it calls `decompress_ with extracted data and length of the data,` `IDAscope tells us`\nthat the function uses `ZLIB -related constants:`\n\nSeems like it’s a driver, saved under `C:\\Windows\\System32\\drivers as` `iaStorE.sys :`\n\n\n-----\n\nOn a `0x64 system it installs the driver as a crash dump filter by simply adding the drive`\nname to the registry key\n```\n\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\CrashControl\\DumpFilters,\n\n```\non the next reboot, crashdmp.sys will load the filter driver into the dump stack, for more\ninformation about `Dump Filer Drivers, click` [here:](https://crashdmp.wordpress.com/components/dump-filter-drivers/)\n\n\n-----\n\nOn a `0x32 system it installs the driver via creating a service called` `iaStorE :`\n\nAfter extracting files and installing the driver, the sample exits.\n\n\n-----\n\nAll files are signed, including drivers, certificates are revoked by its issuer, but that s not a\nproblem for Windows:\n\nThank you for your time.\n\nDiscuss on [Reddit](https://www.reddit.com/r/ReverseEngineering/comments/8cfjum/reversing_bandioscolony_malware_part_1/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-04-17 - Reversing the Bandios - Colony Malware.pdf"
    ],
    "report_names": [
        "2018-04-17 - Reversing the Bandios - Colony Malware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535702,
    "ts_updated_at": 1743041159,
    "ts_creation_date": 1653765254,
    "ts_modification_date": 1653765254,
    "files": {
        "pdf": "https://archive.orkl.eu/2d711cb84c7054ed6b9048ef92a9d9dda140cb47.pdf",
        "text": "https://archive.orkl.eu/2d711cb84c7054ed6b9048ef92a9d9dda140cb47.txt",
        "img": "https://archive.orkl.eu/2d711cb84c7054ed6b9048ef92a9d9dda140cb47.jpg"
    }
}