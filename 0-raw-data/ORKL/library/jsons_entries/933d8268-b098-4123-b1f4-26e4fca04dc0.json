{
    "id": "933d8268-b098-4123-b1f4-26e4fca04dc0",
    "created_at": "2023-01-12T15:05:22.38864Z",
    "updated_at": "2025-03-27T02:05:50.604331Z",
    "deleted_at": null,
    "sha1_hash": "5e58118b36c2644838b359ec1e57a6c1d797c29f",
    "title": "2022-04-16 - Qakbot Series- Process Injection",
    "authors": "",
    "file_creation_date": "2022-06-01T12:26:31Z",
    "file_modification_date": "2022-06-01T12:26:31Z",
    "file_size": 467086,
    "plain_text": "# Qakbot Series: Process Injection\n\n**[malwarology.com/2022/04/qakbot-series-process-injection/](https://www.malwarology.com/2022/04/qakbot-series-process-injection/)**\n\n2022-04-16\n\n\nApril 16, 2022\n\n\n[Malware Analysis,](https://www.malwarology.com/categories/malware-analysis) [Qakbot](https://www.malwarology.com/categories/qakbot)\nIn late March 2022, I was requested to analyze a software artifact. It was an instance of\nQakbot, a modular information stealer known since 2007. Differently to other analyses I do\nas part of my daily job, in this particular case I can disclose wide parts of it with you readers.\nI’m addressing them in a post series. Here, I’ll discuss about the Qakbot process injection\n[techinque based on this specific sample.](https://www.virustotal.com/gui/file/8565e3e213572cbd7c3df45ae3fadd094831aef7b63d3b389e57097c1b8602d6/detection)\n\n**Figure 1**\n\nThe API trace shows that Qakbot scans the process names on the infected system\n\nThe API logs for the sample show an interesting pattern. The malware seems to enumerate\nall the processes running on the infected system and compare their name with the name of\nsome security processes. Figure 15 reports an excerpt from the API log that I gathered by\nrunning the malware in a controlled environment. You can see that the Chrome process\nname is compared with the name of several security processes.\n\nI investigated the malware to find a motivation for that observed behavior and I realized that\nit is doing a security assessment of the just infected system. The aim of such an assessment\nconsists in understanding if there are security products running in the system and what are\n\n\n-----\n\nthose products. As I will discuss in a while, the malware decides what process to inject\nbased on the outcome of this security assessment.\n\n**Flag** **Process(es)**\n\n0x1 ccSvcHst.exe\n\n0x2 avgcsrvx.exe, avgsvcx.exe, avgcsrva.exe\n\n0x4 MsMpEng.exe\n\n0x8 mcshield.exe\n\n0x10 avp.exe, kavtray.exe\n\n0x20 egui.exe, ekrn.exe\n\n0x40 bdagent.exe, vsserv.exe, vsservppl.exe\n\n0x80 AvastSvc.exe\n\n0x100 coreServiceShell.exe, PccNTMon.exe, NTRTScan.exe\n\n0x200 SAVAdminService.exe, SavService.exe\n\n0x400 fshoster32.exe\n\n0x800 WRSA.exe\n\n0x1000 vkise.exe, isesrv.exe, cmdagent.exe\n\n0x2000 ByteFence.exe\n\n0x4000 MBAMService.exe, mbamgui.exe\n\n0x8000 fmon.exe\n\n0x10000 dwengine.exe, dwarkdaemon.exe, dwwatcher.exe\n\n**Table 1**\n\nMapping between security processes and boolean flags used during the security assessment\nof the infected system\n\nThe sample groups security processes mostly by vendor. As an example, I observed that the\nmalware developers defined a group containing some processes related to the Dr.Web\nvendor: dwengine.exe, dwarkdaemon.exe and dwwatcher.exe. This group has been recently\nincluded since it isn’t documented in a detailed analysis of a similar specimen published in\n[2021 (Trung Kien - 2021). A flag is assigned to each group. The flag for a given group is true](https://blog.vincss.net/2021/03/re021-qakbot-dangerous-malware-has-been-around-for-more-than-a-decade.html)\n\n\n-----\n\nif and only if at least one of the processes belonging to that group has been found on the\ninfected system. The security state of a system is defined by the disgiunction of all the flags.\nWhat i call security assessment is implemented in a function located at 0xb2f3a9. This\nfunction defines the mapping between groups and flags. As you may notice from Table 1,\nreporting the mapping between groups and flags, a group is represented as a string\ncomposed of comma-separated process names. However, those strings are obfuscated as\n[discussed in the first post of the Qakbot series.](https://www.malwarology.com/2022/04/qakbot-series-string-obfuscation/)\n\n**Figure 2**\n\nProcess enumeration function to update the security state of the system\n\n\n-----\n\nThe core of the security assessment algorithm is implemented in a function located at\n_0xb2dad3. As you may notice from the listing of Figure 2, that function is responsible for the_\nprocess scan observed in the API calls logs. The malware invokes\nCreateToolhelp32Snapshot, Process32First, Process32Next to iterate across the processes\nrunning on the system. Those API calls are protected by an API hashing technique I’ll\ndiscuss about in a dedicated post. The function update_security_state is responsible for\nchecking if the name of a process on the infected system is included in some group. If that is\nthe case, then it activates the flag for that specific group. The security state is updated by oring itself with the flag of the active group.\n\nQakbot scans the processes on the infected system to understand if there are security\nproducts among them. This assessment is crucial for the malware because it influences the\nprocesses chosen as targets for the injection. The function implementing the target selection\nlogic is located at 0xb2d84b and it always return three targets according to some rules. As an\nexample, consider the following list of processes: coreServiceShell.exe, PccNTMon.exe,\nNTRTScan.exe, SAVAdminService.exe, SavService.exe, bdagent.exe, vsserv.exe,\nvsservppl.exe, avp.exe, kavtray.exe, avgcsrvx.exe, avgsvcx.exe, and avgcsrva.exe. If any of\nthose processes is running on the infected system, then the second decision driver is\nwhether the malware is running on an x64 processor (or under the WOW64 Microsoft\nsubsystem). If that is the case, then the target processes are:\n\n%SystemRoot%\\SysWOW64\\mobsync.exe\n%SystemRoot%\\SysWOW64\\explorer.exe\n%ProgramFiles(x86)%\\Internet Explorer\\iexplore.exe\n\nOtherwise, if at least one of the processes has been found and the malware is running on an\nx86 processor, then the targets become:\n\n%SystemRoot%\\System32\\mobsync.exe\n%SystemRoot%\\explorer.exe\n%ProgramFiles%\\Internet Explorer\\iexplore.exe\n\n[The fact that Qakbot targets mobsync and explorer is well known (Trung Kien - 2021). What I](https://blog.vincss.net/2021/03/re021-qakbot-dangerous-malware-has-been-around-for-more-than-a-decade.html)\ndiscovered with this sample is that now Qakbot may also target msra and OneDriveSetup.\nThat happens, for example, if none of the processes listed before are running on the system\nand the malware is running on a x86 processor. Indeed, given those conditions, the targets\nbecome:\n\n%SystemRoot%\\explorer.exe\n%SystemRoot%\\System32\\msra.exe\n%SystemRoot%\\System32\\OneDriveSetup.exe\n\n\n-----\n\nOnce obtained the targets, the sample attempts to inject code into them. The overall injection\nprocess is implemented in the function located at 0xb2d6c4. That function iterates over the\ndesignated targets and for each of them tries to spawn a new process in suspended state by\nusing the target path as the application name. If the creation succeeds then the function\nlocated at 0xb2d976 is invoked. That function is responsible for the actual injection. The\ninjection prologue is implemented in function 0xb2d446 and it follows the following pattern:\nNtCreateSection, NtMapViewOfSection on the malware process, NtMapViewOfSection1 on\nthe target process, and NtWriteProcessMemory to copy the Qakbot payload into the newly\ncreated memory area. Next, the sample tries to insert a trampoline to the payload at the\nentry point of the targeted process. To do so, it invokes GetThreadContext,\nNtProtectVirtualMemory, and NtWriteVirtualMemory. Finally, the malware awakens the\nprocess in suspended state.\n\nAs always, if you want to share comments or feedbacks (rigorously in broken Italian or\nbroken English) do not esitate to drop me a message at admin[@]malwarology.com.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-16 - Qakbot Series- Process Injection.pdf"
    ],
    "report_names": [
        "2022-04-16 - Qakbot Series- Process Injection.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535922,
    "ts_updated_at": 1743041150,
    "ts_creation_date": 1654086391,
    "ts_modification_date": 1654086391,
    "files": {
        "pdf": "https://archive.orkl.eu/5e58118b36c2644838b359ec1e57a6c1d797c29f.pdf",
        "text": "https://archive.orkl.eu/5e58118b36c2644838b359ec1e57a6c1d797c29f.txt",
        "img": "https://archive.orkl.eu/5e58118b36c2644838b359ec1e57a6c1d797c29f.jpg"
    }
}