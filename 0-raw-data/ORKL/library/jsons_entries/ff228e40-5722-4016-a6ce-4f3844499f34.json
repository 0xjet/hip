{
    "id": "ff228e40-5722-4016-a6ce-4f3844499f34",
    "created_at": "2023-03-03T02:06:16.046022Z",
    "updated_at": "2025-03-27T02:08:40.940469Z",
    "deleted_at": null,
    "sha1_hash": "d636bec7befa191dccca49e2672e261c16108ecd",
    "title": "2023-02-07 - Hide your Hypervisor- Analysis of ESXiArgs Ransomware",
    "authors": "",
    "file_creation_date": "2023-03-01T09:13:37Z",
    "file_modification_date": "2023-03-01T09:13:37Z",
    "file_size": 1353767,
    "plain_text": "# Hide your Hypervisor: Analysis of ESXiArgs Ransomware\n\n**[secuinfra.com/en/techtalk/hide-your-hypervisor-analysis-of-esxiargs-ransomware/](https://www.secuinfra.com/en/techtalk/hide-your-hypervisor-analysis-of-esxiargs-ransomware/)**\n\n07.02.2023\n\n**In this blog post we will be analyzing the recent “ESXiArgs” Ransomware variant,**\n**which spread to a large number of outdated, internet-exposed ESXi Servers around**\n**the world.**\n\n## Attack Vectors\n\nIn the past Ransomware targeting ESXi Hypervisors was largely human-operated as a later\nstage of general Ransomware attack, where other Assets (Clients, Servers) are encrypted\nfirst. Accessing these virtualization systems usually involves acquiring credentials first and\nchanging configuration options to allow for remote access to the Hypervisor, where the\n[ransomware is executed by the attacker through a “hands-on-keyboard” attack.](https://learn.microsoft.com/en-us/security/compass/human-operated-ransomware#human-operated-ransomware-attacks)\n\n[This changed in late 2022 when Juniper Threat Labs first discovered a novel Backdoor](https://blogs.juniper.net/en-us/threat-research/a-custom-python-backdoor-for-vmware-esxi-servers)\ntargeting ESXi Hypervisors. A few weeks later this Backdoor script would be the first postexploitation component of an automated Ransomware campaign named “ESXiArgs” (after\nthe targeted systems and the file extension .args). The spread of ESXiArgs Ransomware\nsurged starting on February 2nd 2023 when automated exploitation of the Vulnerability CVE[2021-21974 hit many internet-facing ESXi deployments hosted with e.g. OVH, Hetzner and](https://blog.ovhcloud.com/ransomware-targeting-vmware-esxi/)\nother Hosters around the world. The OpenSLP (Service Location Protocol) on Port 427/tcp is\nexploited through a Heap-Overflow leading to Remote Code Execution on the ESXi system.\n[Public exploitation tools have been available since June 2021. According to the warning](https://packetstormsecurity.com/files/162957/VMware-ESXi-OpenSLP-Heap-Overflow.html)\nissued by [CERT-FR the vulnerability affects unpatched systems running the following ESXi](https://www.cert.ssi.gouv.fr/alerte/CERTFR-2023-ALE-015/)\nversions:\n\nESXi versions 7.x before ESXi70U1c-17325551\nESXi versions 6.7.x before ESXi670-202102401-SG\nESXi versions 6.5.x before ESXi650-202102101-SG\n\nAt the time of writing there are nearly 2500 ESXi systems exposed to the Internet that are\n[affected by ESXiArgs Ransomware as found by the search engine Censys (based on the](https://search.censys.io/search?resource=hosts&sort=RELEVANCE&per_page=25&virtual_hosts=EXCLUDE&q=services.http.response.body%3A+%22How+to+Restore+Your+Files%22+and+services.http.response.html_title%3A%22How+to+Restore+Your+Files%22&ct=1)\nRansomnote being present on the ESXi Web Interface).\n\n\n-----\n\nFigure 1: Censys Search for ESXiArg victims\n\n## Analysis of ESXiArgs Ransomware\n\nFigure 2: Ransomnote displayed on the ESXi Webinterface of a compromised system\n\nAfter the initial exploitation of CVE-2021-21974 the threat actors persist the “vmtools.py”\nBackdoor script that was previously analyzed by Juniper Threat Labs. The Web Shell\nconsists of a HTTP Server on Port 8008 that accepts post requests with a specified\n\n\n-----\n\ncommand structure. Requests with the action local run commands on the Hypervisor\nsystem and output to the web shell. Using the “remote” action the attackers can open a\nreverse shell to the specified host IP and port.\n\nFigure 3: vmtools.py Script – used for a Web Shell\n\nOnce persistence on the Hypervisor is achieved the threat actors transfer the Ransomware\ncomponents to the system through an archive file called “archieve.zip”, which contains the\nRansomnotes for the Web Interface and SSH Message of the Day as well as a Bash script\nand an ELF binary for the file encryption.\n\nESXiArgs Ransomware is implemented in the Bash script while the supplied ELF binary is\nonly used for the encryption process. Let’s look at the script first:\n\nFirst ESXiArgs collects a list of disk and swap files for the configured VMs on the Hypervisor\nand renames them. In contrast to many other ESXi Ransomware implementations ESXiArgs\ndoes not use utilities like “esxcli”, “vmware-cmd” or “vim-cmd” to power down running VMs to\n\n\n-----\n\nbe able to encrypt them, but rather it just terminates the vmx process. This action could\npotentially lead to errors or corruption of VM data.\n\nFigure 4: Information Gathering and killing vmx\n\nWhen encrypting VM data ESXiArgs iterates through a list of volumes and tries to encrypt\nVM storage and configuration files using intermitted encryption blocks. The information which\nfile to encrypt is passed as arguments to the “encrypt” binary which we will analyze shortly.\n\nFigure 5: File Encryption Routine\n\nAfter encrypting the VM files the Ransomware drops two Ransomnotes: The first one will\noverwrite the vSphere Web Interface (see Figure 2) and the second one will overwrite the\nSSH Message of the Day to be displayed on Login.\n\nTo cover their tracks and make following investigations more difficult ESXiArgs deletes LogFiles from the system.\n\n\n-----\n\nFigure 6: Dropping the Ransomnote and deleting Log files\n\nLastly ESXiArgs will remove it’s persistence (e.g. via /etc/rc.local.d/local.sh) and delete all\nartifacts used for the encryption process to act as an Anti-Analysis measure.\n\nFigure 7: Deletion of artifacts and persistence\n\nThe ESXiArgs “encrypt” binary is a 64bit LSB ELF file with the debug information still intact.\nStill it only handles the actual file encryption it is relatively small with a file size of 48KB.\n\n\n-----\n\nFigure 8: Information on the “encrypt” binary\n\nThe binary features a usage dialog and requires the RSA Public Key, the file path and values\nfor the intermitted encryption to be passed as arguments.\n\nFigure 9: Help menu for the “encrypt” binary\n\nThe file encryption is done through a combination of asymmetric RSA and symmetric\nSosemanuk algorithms. Sosemanuk is part of the eSTREAM portfolio and a relatively rare\nsight in Ransomware. From the debug information contained in the binary we suspect that\n[the threat actors may have based their implementation on this Github repository.](https://github.com/cchcc/SOSEMANUK/blob/master/C/SOSEMANUK.C)\n\nFigure 10: Sosemanuk and RSA encryption routines\n\n## Recovery Options\n\nBefore any recovery of virtual machines in attempted the ESXi Hypervisor should be secured\nand backed up. In some cases, the encryption may have failed to encrypt the VM data\ncorrectly and therefore some can be recovered. Enes Sonmez & Ahmet Aykac from\n[YoreGroup Tech Team have documented a recovery workflow here, which might help victims](https://enes.dev/)\nto restore their VMs in a timely manner. It seems that this process only applies to VM with\n\n\n-----\n\nthin provisioned storage though.\nUpdate (2023-02-08): CISA released a recovery script for affected Hypervisors, you can find\nit on [GitHub.](https://github.com/cisagov/ESXiArgs-Recover)\n\n## Steps to protect your Hypervisor\n\n1 – Keep your Hypervisor up-to-date: Affected ESXi versions should be upgraded to the\nlatest patch immediately. Versions that reached the End-of-Life in terms of vendor support\nshould be decommissioned and migrated to a more recent version.\n\n2 – Do not expose your Hypervisor to the public Internet: This includes all management\ninterfaces (LAN, IPMI) but also protocols and features such as SSH, OpenSLP, SNMP and\nvSphere (which should all be disabled by default). Network access to the Hypervisor should\nbe restricted through a firewall.\n\n3 – Back up your Hypervisor: As with any other system affected by Ransomware, keeping\nBackups is a key step in restoring the service in a timely manner. This includes Virtual\nHarddisk files as well as VMware configuration data for the VMs.\n\n4 – Use Syslog to retain Logs: ESXiArgs and many other Hypervisor-specific Ransomware\ntarget Log files on the system for deletion to prevent further investigation, so it is important to\nexport and store these logs safely.\n\n5 – Disable the execution of unsigned software: The configuration option\n_execInstalledOnly restricts the ESXi to only execute so-called vSphere Installable Bundles_\n(VIB) which refers to ESXi software components or VMware-approved third party\napplications. Any unsigned Ransomware binaries could therefore not be run on the system.\nIt is important to understand that this configuration option should be persisted through UEFI\nSecureBoot (which requires a supported Hardware TPM) to defend against human-operated\n[Ransomware. More information about this feature can be found here.](https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-9047A43D-BB1F-4878-A971-EEFCAC183C86.html)\n\n6 – Review user authentication: User authentication should not be done through Active\nDirectory to prevent Lateral Movement to the Hypervisor in case of a Domain Controller\ncompromise. Local user accounts should be restricted to a Password Policy, limited\nauthentication attempts and temporary lockouts if they fail to authenticate.\n\n## Yara rules\n\nYara rules for the Python, Bash and Binary files utilized by ESXiArgs Ransomware can be\n[found in our Github repository.](https://github.com/SIFalcon/Detection/tree/main/Yara/Malware)\n\n## Indicators of Compromise\n\n\n-----\n\n### Samples\n\nThe Ransomware samples were procured through an affected victim on the\nBleepingComputer Forum.\n\n11b1b2375d9d840912cfd1f0d0d04d93ed0cddb0ae4ddb550a5b62cd044d6b66 encrypt\n\n10c3b6b03a9bf105d264a8e7f30dcab0a6c59a414529b0af0a6bd9f1d2984459 encrypt.sh\n\n773d147a031d8ef06ee8ec20b614a4fd9733668efeb2b05aa03e36baaf082878 vmtools.py\n\n### Filenames\n\nvmtools.py\n\nencrypt\n\n/tmp/tmpy_8th_nb\n\nnohup.out\n\npublic.pem\n\narchieve.zip\n\nmotd\n\n## MITRE ATT&CK Mapping\n\n**Tactic** **Technique** **Description** **Observable**\n\n\nReconnaissance Active Scanning:\nVulnerability\nScanning\n(T1595.002)\n\nInitial Access Exploit PublicFacing Application\n(T1190)\n\nExecution Command and\nScripting\nInterpreter: Python\n(T1059.006)\n\nPersistence Boot or Logon\nInitialization\nScripts: RC Scripts\n(T1037.004)\n\n\nThreat Actors behind\nESXiArgs are actively\nscanning for vulnerable\nESXi Servers\n\n\nCVE-2021-21974\nartifacts\n\n\nExplotation of OpenSLP CVE-2021-21974\nartifacts\n\n\nvmtools.py\n\n/etc/rc.local.d/local.sh\n\nHTTP Post Server on\nPort 8008\n\n\nCommand and\nControl\n\n\nNon-Standard Port\n(T1571)\n\n\nBackdoor/Web Shell\nimplemented in Python\n\nPersisting the Python\nbackdoor\n\nWeb Shell implemented\nin vmtools.py\n\n\n-----\n\nCommand and\nControl\n\n\nNon-Standard Port\n(T1571)\n\n\nReverse Shell\nimplemented in\nvmtools.py\n\nRansomware\nfunctionality is\nimplemented in Bash\n\nVM data is encrypted via\nRSA+Sosemanuk\n\nEnding a process to\npower down VMs\n\nDefacement of the\nvSphere Web Interface\n\nDefacement of the SSH\nMOTD\n\n\nReverse Shell via\nspecified port; default\nfallback: 427\n\nencrypt.sh\n\nencrypt binary\n\nKilling the vmx\nprocess in encrypt.sh\n\nOverwriting\nindex.html with the\nRansomnote\n\nOverwriting motd\nwith the Ransomnote\n\n\nExecution Command and\nScripting\nInterpreter: Unix\nShell (T1059.004)\n\nImpact Data Encrypted for\nImpact (T1486)\n\nImpact Service Stop\n(T1489)\n\nImpact Defacement:\nExternal\nDefacement\n(T1491.002)\n\nImpact Defacement:\nInternal\nDefacement\n(T1491.001)\n\n\nDefense\nEvasion\n\n\nIndicator Removal:\nClear Linux or Mac\nSystem Logs\n(T1070.002)\n\n\nLog file deletion Deleting all .log files\n\n\n[SECUINFRA Falcon Team · Author](https://www.secuinfra.com/en/author/si_falcon_tm/)\n\nDigital Forensics & Incident Response Experten\n\nNeben den Tätigkeiten, die im Rahmen von Kundenaufträgen zu verantworten sind, kümmert\nsich das Falcon Team um den Betrieb, die Weiterentwicklung und die Forschung zu diversen\nProjekten und Themen im DF/IR Bereich.\n\nDas SECUINFRA Falcon Team ist auf die Bereiche Digital Forensics (DF) und Incident\nResponse (IR) spezialisiert. Hierzu zählen die klassische Host-Based Forensik, aber auch\nThemen wie Malware Analysis oder Compromise Assessment gehören zu diesem\nAufgabengebiet.\nNeben den Tätigkeiten, die im Rahmen von Kundenaufträgen zu\nverantworten sind, kümmert sich das Falcon Team um den Betrieb, die Weiterentwicklung\nund die Forschung zu diversen Projekten und Themen im DF/IR Bereich. Dazu zählen\nbeispielsweise Threat Intelligence oder die Erstellung von Erkennungsregeln auf Basis von\nYara.\nDigital Forensics & Incident Response experts\n\n\n-----\n\nIn addition to the activities that are the responsibility of customer orders, the Falcon team\ntakes care of the operation, further development and research of various projects and topics\nin the DF/IR area.\n\nThe SECUINFRA Falcon Team is specialized in the areas of Digital Forensics (DF) and\nIncident Response (IR). This includes classic host-based forensics, but also topics such as\nmalware analysis or compromise assessment.\nIn addition to the activities for which we are\nresponsible within the scope of customer orders, the Falcon team is also responsible for the\noperation, further development and research of various projects and topics in the DF/IR area.\nThese include, for example, threat intelligence or the creation of detection rules based on\nYara.\n- [All posts](https://www.secuinfra.com/en/author/si_falcon_tm/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-02-07 - Hide your Hypervisor- Analysis of ESXiArgs Ransomware.pdf"
    ],
    "report_names": [
        "2023-02-07 - Hide your Hypervisor- Analysis of ESXiArgs Ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1677809176,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1677662017,
    "ts_modification_date": 1677662017,
    "files": {
        "pdf": "https://archive.orkl.eu/d636bec7befa191dccca49e2672e261c16108ecd.pdf",
        "text": "https://archive.orkl.eu/d636bec7befa191dccca49e2672e261c16108ecd.txt",
        "img": "https://archive.orkl.eu/d636bec7befa191dccca49e2672e261c16108ecd.jpg"
    }
}