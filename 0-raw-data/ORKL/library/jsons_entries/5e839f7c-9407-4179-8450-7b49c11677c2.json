{
    "id": "5e839f7c-9407-4179-8450-7b49c11677c2",
    "created_at": "2023-01-12T15:00:31.723781Z",
    "updated_at": "2025-03-27T02:15:35.491921Z",
    "deleted_at": null,
    "sha1_hash": "4b29d5713eb166d3c6b73ddb1ebf51a77c0f09a9",
    "title": "2022-05-21 - Deep Analysis of Mars Stealer",
    "authors": "",
    "file_creation_date": "2022-05-27T20:58:47Z",
    "file_modification_date": "2022-05-27T20:58:47Z",
    "file_size": 5021589,
    "plain_text": "# Deep Analysis of Mars Stealer\n\n**x-junior.github.io/malware analysis/MarsStealer/**\n\n### Mohamed Ashraf\n\nMalware Analysis & Reverse Engineering & Cryptography\n\n28 minute read\n\n## Introduction\n\n\nMay 21, 2022\n\n\nMars Stealer is an improved copy of Oski Stealer. I saw alot of tweets recently about it so i decided to write an analysis of the\nnewer version V8. Enjoy reading!\n\nDiffrences from the previous version:\n\n1. Anti analysis technique\n2. Diffrent encryption algoithm\n3. Introudcing new anti debug technique\n4. New configuration format\n5. External dlls are in one zip file\n\n## Overview\n\n\n-----\n\n## Anti-Analysis\n\nOpening mars stealer in ida we can see an anti-analysis trick called Opaque Predicates it’s a commonly used technique in\nprogram obfuscation, intended to add complexity to the control flow.\n\nThis obfuscation simply takes an absolute jump (JMP) and transforms it into two conditional jumps (JZ/JNZ). Depending on the\nvalue of the Zero flag (ZF), the execution will follow the first or second branch.\n\nHowever, disassemblers are tricked into thinking that there is a fall-through branch if the second jump is not taken (which is\nimpossible as one of them must be taken) and tries to disassemble the unreachable instructions (often invalid) resulting in\ngarbage code.\n\n\n-----\n\nthe deobfuscation is simple, we just need to patch the first conditional jump to an absolute jump and nop out the second jump,\nwe can use IDAPython to achieve this:\n```\nimport idc\nea = 0\nwhile True:\n  ea = min(ida_search.find_binary(ea,idc.BADADDR, \"74 ? 75 ?\",16,idc.SEARCH_NEXT | idc.SEARCH_DOWN), # JZ / JNZ\n  ida_search.find_binary(ea,idc.BADADDR, \"75 ? 74 ?\",16, idc.SEARCH_NEXT | idc.SEARCH_DOWN)) # JNZ / JZ\n  if ea == idc.BADADDR:\n    break\n  idc.patch_byte(ea, 0xEB)\n  idc.patch_byte(ea+2, 0x90)\n  idc.patch_byte(ea+3, 0x90)\n  idc.patch_byte(ea+4, 0x90)\n\n```\nAfter Running the Script\nnow we can see a clear view, after reversing and renaming\n\nFirst Mars get a handle to kernel32.dll by parsing `InLoadOrderModuleList then it passes the handle to a fucntion that loops`\nover the exported functions of the DLL to get the address of the `LocalAlloc() and` `VirtualProtect() functions.`\n\n\n-----\n\n## String Encryption\n\nAfter that it decrypts some strings used for some checks, the decryption is a simple xor function\n\n\n-----\n\nWe can although see that the xor function is refrenced in another function which i renamed as Decrypt_String_2 if the malware\npasses the checks which we will see soon it decrypt those string which contanis strings needed for the malware to steal\nsensitive data .\n\nWe use idapython script to get those strings and rename the variables to make reversing easier\n\n\n-----\n\n```\n p g\ndef sanitize_string(name):\n    return \"\".join([c for c in name if c in string.ascii_letters])[:20].capitalize()\ndef X0r(key, data, length):\n  res = \"\"\n  for i in range(length):\n    res += chr(key[i] ^ data[i])\n  return res\nstart_Addrs = [0x00401770,0x00401990 ]\nend_Addrs = [0x00401967,0x0405444 ]\nstring_list = []\ndectypred_data = b''\naddrs = []\nfor i in range(len(start_Addrs)):\n  ea = start_Addrs[i]\n  end = end_Addrs[i]\n  while ea <= end:\n    if idc.get_operand_type(ea, 0) == idc.o_imm:\n      addrs.append((idc.get_operand_value(ea, 0)))\n    if len(addrs) == 3:\n      length = addrs[0]\n      data = idc.get_bytes(addrs[1], length)\n      key = idc.get_bytes(addrs[2], length)\n      dectypred_data = X0r(key, data, length)\n      string_list.append(dectypred_data)\n      addrs = []\n    if idc.print_insn_mnem(ea) == \"call\":\n      idc.set_cmt(ea, dectypred_data, 1)\n    if idc.print_insn_mnem(ea) == \"mov\" and (idc.get_operand_type(ea, 0) == idc.o_mem) and (\n        idc.get_operand_type(ea, 1) == idc.o_reg):\n      global_var = idc.get_operand_value(ea, 0)\n      idc.set_name(global_var, \"Str\" + sanitize_string(dectypred_data), SN_NOWARN)\n    ea = idc.next_head(ea, end)\n\n```\nHere is a list of the decrypted strings :\n\nExpand to see more\nLoadLibraryA\nGetProcAddress\nExitProcess\nadvapi32.dll\ncrypt32.dll\nGetTickCount\nSleep\nGetUserDefaultLangID\nCreateMutexA\nGetLastError\nHeapAlloc\nGetProcessHeap\nGetComputerNameA\nVirtualProtect\nGetCurrentProcess\nVirtualAllocExNuma\nGetUserNameA\nCryptStringToBinaryA\n\nHAL9TH\n\n\n-----\n\nJohnDoe\n6Ê§È/2022 20:00:00\nhttp://\n194.87.218.39\n92550737836278980100\n/RyC66VfSGP.php\nDefault\n%hu/%hu/%hu %hu:%hu:%hu\nopen\nsqlite3.dll\nC:\\ProgramData\\sqlite3.dll\nfreebl3.dll\nC:\\ProgramData\\freebl3.dll\nmozglue.dll\nC:\\ProgramData\\mozglue.dll\nmsvcp140.dll\nC:\\ProgramData\\msvcp140.dll\nnss3.dll\nC:\\ProgramData\\nss3.dll\nsoftokn3.dll\nC:\\ProgramData\\softokn3.dll\nvcruntime140.dll\nC:\\ProgramData\\vcruntime140.dll\n.zip\nTag:\nIP: IP?\nCountry: Country?\nWorking Path:\nLocal Time:\nTimeZone:\nDisplay Language:\nKeyboard Languages:\nIs Laptop:\nProcessor:\nInstalled RAM:\nOS:\n(\nBit)\nVideocard:\nDisplay Resolution:\nPC name:\nUser name:\nDomain name:\nMachineID:\nGUID:\nInstalled Software:\nsystem.txt\nGrabber\\%s.zip\n%APPDATA%\n%LOCALAPPDATA%\n%USERPROFILE%\n%DESKTOP%\nWallets\\\nEthereum\n\\Ethereum\\\nkeystore\nElectrum\n\n\\Electrum\\wallets\\\n\n\n-----\n\n.\nElectrumLTC\n\\Electrum-LTC\\wallets\\\nExodus\n\\Exodus\\\nexodus.conf.json\nwindow-state.json\n\\Exodus\\exodus.wallet\\\npassphrase.json\nseed.seco\ninfo.seco\nElectronCash\n\\ElectronCash\\wallets\\\ndefault_wallet\nMultiDoge\n\\MultiDoge\\\nmultidoge.wallet\nJAXX\n\\jaxx\\Local Storage\\\nfile__0.localstorage\nAtomic\n\\atomic\\Local Storage\\leveldb\\\n000003.log\nCURRENT\nLOCK\nLOG\nMANIFEST-000001\n0000*\nBinance\n\\Binance\\\napp-store.json\nCoinomi\n\\Coinomi\\Coinomi\\wallets\\\n*.wallet\n*.config\n*wallet*.dat\nGetSystemTime\nlstrcatA\nSystemTimeToFileTime\nntdll.dll\nsscanf\nmemset\nmemcpy\nwininet.dll\nuser32.dll\ngdi32.dll\nnetapi32.dll\npsapi.dll\nbcrypt.dll\nvaultcli.dll\nshlwapi.dll\nshell32.dll\ngdiplus.dll\nole32.dll\ndbghelp.dll\nCreateFileA\nWriteFile\n\nCloseHandle\n\n\n-----\n\nGetFileSize\nlstrlenA\nLocalAlloc\nGlobalFree\nReadFile\nOpenProcess\nSetFilePointer\nSetEndOfFile\nGetCurrentProcessId\nGetLocalTime\nGetTimeZoneInformation\nGetUserDefaultLocaleName\nLocalFree\nGetSystemPowerStatus\nGetSystemInfo\nGlobalMemoryStatusEx\nIsWow64Process\nGetTempPathA\nGetLocaleInfoA\nGetFileSizeEx\nGetFileAttributesA\nFindFirstFileA\nFindNextFileA\nFindClose\nGetCurrentDirectoryA\nCopyFileA\nDeleteFileA\nlstrcmpW\nGlobalAlloc\nFreeLibrary\nSetCurrentDirectoryA\nCreateFileMappingA\nMapViewOfFile\nUnmapViewOfFile\nFileTimeToSystemTime\nGetFileInformationByHandle\nGlobalLock\nGlobalSize\nWideCharToMultiByte\nGetWindowsDirectoryA\nGetVolumeInformationA\nGetVersionExA\nGetModuleFileNameA\nCreateFileW\nCreateFileMappingW\nMultiByteToWideChar\nCreateThread\nGetEnvironmentVariableA\nSetEnvironmentVariableA\nlstrcpyA\nlstrcpynA\nInternetOpenA\nInternetConnectA\nHttpOpenRequestA\nHttpSendRequestA\nHttpQueryInfoA\nInternetCloseHandle\n\nInternetReadFile\n\n\n-----\n\nInternetSetOptionA\nInternetOpenUrlA\nInternetCrackUrlA\nwsprintfA\nCharToOemW\nGetKeyboardLayoutList\nEnumDisplayDevicesA\nReleaseDC\nGetDC\nGetSystemMetrics\nGetDesktopWindow\nGetWindowRect\nGetWindowDC\nCloseWindow\nRegOpenKeyExA\nRegQueryValueExA\nRegCloseKey\nGetCurrentHwProfileA\nRegEnumKeyExA\nRegGetValueA\nCreateDCA\nGetDeviceCaps\nCreateCompatibleDC\nCreateCompatibleBitmap\nSelectObject\nBitBlt\nDeleteObject\nStretchBlt\nGetObjectW\nGetDIBits\nSaveDC\nCreateDIBSection\nDeleteDC\nRestoreDC\nDsRoleGetPrimaryDomainInformation\nGetModuleFileNameExA\nCryptUnprotectData\nBCryptCloseAlgorithmProvider\nBCryptDestroyKey\nBCryptOpenAlgorithmProvider\nBCryptSetProperty\nBCryptGenerateSymmetricKey\nBCryptDecrypt\nVaultOpenVault\nVaultCloseVault\nVaultEnumerateItems\nVaultGetItemWin8\nVaultGetItemWin7\nVaultFree\nStrCmpCA\nStrStrA\nPathMatchSpecA\nSHGetFolderPathA\nShellExecuteExA\nGdipGetImageEncodersSize\nGdipGetImageEncoders\nGdipCreateBitmapFromHBITMAP\n\nGdiplusStartup\n\n\n-----\n\nGdiplusShutdown\nGdipSaveImageToStream\nGdipDisposeImage\nGdipFree\nCreateStreamOnHGlobal\nGetHGlobalFromStream\nSymMatchString\nHEAD\nHTTP/1.1\nGET\nPOST\nfile\nContent-Type: multipart/form-data; boundary=---Content-Disposition: form-data; name=\"\nContent-Disposition: form-data; name=\"file\"; filename=\"\nContent-Type: application/octet-stream\nContent-Transfer-Encoding: binary\nSOFT:\nPROF: ?\nPROF:\nHOST:\nUSER:\nPASS:\nsqlite3_open\nsqlite3_prepare_v2\nsqlite3_step\nsqlite3_column_text\nsqlite3_finalize\nsqlite3_close\nsqlite3_column_bytes\nsqlite3_column_blob\nencrypted_key\n\"}\nPATH\nPATH=\nNSS_Init\nNSS_Shutdown\nPK11_GetInternalKeySlot\nPK11_FreeSlot\nPK11_Authenticate\nPK11SDR_Decrypt\nSELECT origin_url, username_value, password_value FROM logins\nCookies\\%s_%s.txt\nSELECT HOST_KEY, is_httponly, path, is_secure, (expires_utc/1000000)-11644480800, name, encrypted_value from\ncookies\nTRUE\nFALSE\nAutofill\\%s_%s.txt\nSELECT name, value FROM autofill\nCC\\%s_%s.txt\nSELECT name_on_card, expiration_month, expiration_year, card_number_encrypted FROM credit_cards\nCard number:\nName on card:\nExpiration date:\nHistory\\%s_%s.txt\nSELECT url FROM urls\nDownloads\\%s_%s.txt\n\nSELECT target path tab url from downloads\n\n\n-----\n\nLogin Data\nCookies\nWeb Data\nHistory\nSELECT host, isHttpOnly, path, isSecure, expiry, name, value FROM moz_cookies\nlogins.json\nformSubmitURL\nusernameField\nencryptedUsername\nencryptedPassword\nguid\nSELECT fieldname, value FROM moz_formhistory\nSELECT url FROM moz_places\ncookies.sqlite\nformhistory.sqlite\nplaces.sqlite\n\\Local State\n..\\profiles.ini\nC:\\ProgramData\\\nChrome\n\\Google\\Chrome\\User Data\nChromeBeta\n\\Google\\Chrome Beta\\User Data\nChromeCanary\n\\Google\\Chrome SxS\\User Data\nChromium\n\\Chromium\\User Data\nEdge_Chromium\n\\Microsoft\\Edge\\User Data\nKometa\n\\Kometa\\User Data\nAmigo\n\\Amigo\\User Data\nTorch\n\\Torch\\User Data\nOrbitum\n\\Orbitum\\User Data\nComodo\n\\Comodo\\Dragon\\User Data\nNichrome\n\\Nichrome\\User Data\nMaxthon5\n\\Maxthon5\\Users\nSputnik\n\\Sputnik\\User Data\nEPB\n\\Epic Privacy Browser\\User Data\nVivaldi\n\\Vivaldi\\User Data\nCocCoc\n\\CocCoc\\Browser\\User Data\nUran\n\\uCozMedia\\Uran\\User Data\nQIP\n\\QIP Surf\\User Data\nCent\n\\CentBrowser\\User Data\n\nElements\n\n\n-----\n\n\\Elements Browser\\User Data\nTorBro\n\\TorBro\\Profile\nCryptoTab\n\\CryptoTab Browser\\User Data\nBrave\n\\BraveSoftware\\Brave-Browser\\User Data\nOpera\n\\Opera Software\\Opera Stable\\\nOperaGX\n\\Opera Software\\Opera GX Stable\\\nOperaNeon\n\\Opera Software\\Opera Neon\\User Data\nFirefox\n\\Mozilla\\Firefox\\Profiles\\\nSlimBrowser\n\\FlashPeak\\SlimBrowser\\Profiles\\\nPaleMoon\n\\Moonchild Productions\\Pale Moon\\Profiles\\\nWaterfox\n\\Waterfox\\Profiles\\\nCyberfox\n\\8pecxstudios\\Cyberfox\\Profiles\\\nBlackHawk\n\\NETGATE Technologies\\BlackHawk\\Profiles\\\nIceCat\n\\Mozilla\\icecat\\Profiles\\\nKMeleon\n\\K-Meleon\\\nThunderbird\n\\Thunderbird\\Profiles\\\npasswords.txt\nibnejdfjmmkpcnlpebklmnkoeoihofec\nTronLink\nnkbihfbeogaeaoehlefnkodbefgpgknn\nMetaMask\nfhbohimaelbohpjbbldcngcnapndodjp\nBinance Chain Wallet\nffnbelfdoeiohenkjibnmadjiehjhajb\nYoroi\njbdaocneiiinmjbjlgalhcelgbejmnid\nNifty Wallet\nafbcbjpbpfadlkmhmclhkeeodmamcflc\nMath Wallet\nhnfanknocfeofbddgcijnmhnfnkdnaad\nCoinbase Wallet\nhpglfhgfnhbgpjdenjgmdgoeiappafln\nGuarda\nblnieiiffboillknjnepogjhkgnoapac\nEQUAL Wallet\ncjelfplplebdjjenllpjcblmjkfcffne\nJaxx Liberty\nfihkakfobkmkjojpchpfgcmhfjnmnfpi\nBitApp Wallet\nkncchdigobghenbbaddojjnnaogfppfj\niWallet\namkmjjmmflddogmhpjloimipbofnfjih\n\nWombat\n\n\n-----\n\nnlbmnnijcnlegkjjpcfjclmcfggfefdm\nMEW CX\nnanjmdknhkinifnkgdcggcfnhdaammmj\nGuildWallet\nnkddgncdjgjfcddamfgcmfnlhccnimig\nSaturn Wallet\nfnjhmkhhmkbjkkabndcnnogagogbneec\nRonin Wallet\ncphhlgmgameodnhkjdmkpanlelnlohao\nNeoLine\nnhnkbkgjikgcigadomkphalanndcapjk\nClover Wallet\nkpfopkelmapcoipemfendmdcghnegimn\nLiquality Wallet\naiifbnbfobpmeekipheeijimdpnlpgpp\nTerra Station\ndmkamcknogkgcdfhhbddcghachkejeap\nKeplr\nfhmfendgdocmcbmfikdcogofphimnkno\nSollet\ncnmamaachppnkjgnildpdmkaakejnhae\nAuro Wallet\njojhfeoedkpkglbfimdfabpdfjaoolaf\nPolymesh Wallet\nflpiciilemghbmfalicajoolhkkenfel\nICONex\nnknhiehlklippafakaeklbeglecifhad\nNabox Wallet\nhcflpincpppdclinealmandijcmnkbgn\nKHC\nookjlbkiijinhpmnjffcofjonbfbgaoc\nTemple\nmnfifefkajgofkcjkemidiaecocnkjeh\nTezBox\ndkdedlpgdmmkkfjabffeganieamfklkm\nCyano Wallet\nnlgbhdfgdhgbiamfdfmbikcdghidoadd\nByone\ninfeboajgfhgbjpjbeppbkgnabfdkdaf\nOneKey\ncihmoadaighcejopammfbmddcmdekcje\nLeafWallet\nlodccjjbdhfakaekdiahmedfbieldgik\nDAppPlay\nijmpgkjfkbfhoebgogflfebnmejmfbml\nBitClip\nlkcjlnjfpbikmcmbachjpdbijejflpcm\nSteem Keychain\nonofpnbbkehpmmoabgpcpmigafmmnjhl\nNash Extension\nbcopgchhojmggmffilplmbdicgaihlkp\nHycon Lite Client\nklnaejjgbibmhlephnhpmaofohgkpgkd\nZilPay\naeachknmefphepccionboohckonoeemg\nCoin98 Wallet\nbfnaelmomeimhlpmgjnjophhpkkoljpa\n\nPhantom\n\n\n-----\n\nhifafgmccdpekplomjjkcfgodnhcellj\nCrypto.com\ndngmlblcodfobpdpecaadgfbcggfjfnm\nMaiar DeFi Wallet\nppdadbejkmjnefldpcdjhnkpbjkikoip\nOasis\nhpbgcgmiemanfelegbndmhieiigkackl\nMonstaWallet\nfcckkdbjnoikooededlapcalpionmalo\nMOBOX\njccapkebeeiajkkdemacblkjhhhboiek\nCrust Wallet\nmgffkfbidihjpoaomajlbgchddlicgpn\nPali Wallet\nnphplpgoakhhjchkkhmiggakijnkhfnd\nTON Wallet\nldinpeekobnhjjdofggfgjlcehhmanlj\nHiro Wallet\npocmplpaccanhmnllbbkpgfliimjljgo\nSlope Wallet\nbhhhlbepdkbapadjdnnojkbgioiodbic\nSolflare Wallet\npgiaagfkgcbnmiiolekcfmljdagdhlcm\nStargazer Wallet\ncgeeodpfagjceefieflmdfphplkenlfk\nEVER Wallet\ngjkdbeaiifkpoencioahhcilildpjhgh\npartisia-wallet\nbgjogpoidejdemgoochpnkmdjpocgkha\nEcto Wallet\nifckdpamphokdglkkdomedpdegcjhjdp\nONTO Wallet\nagechnindjilpccclelhlbjphbgnobpf\nFractal Wallet\nalgblmhagnobbnmakepomicmfljlbehg\nADS Wallet\nimijjbmbnebfnbmonjeileijahaipglj\nMoonlet Wallet\nkpjdchaapjheajadlaakiiigcbhoppda\nZEBEDEE\ndlcobpjiigpikoobohmabehhmhfoodbb\nArgent X StarkNet Wallet\nbofddndhbegljegmpmnlbhcejofmjgbn\nX-Wallet\nmapbhaebnddapnmifbbkgeedkeplgjmf\nBiport Wallet\nkfdniefadaanbjodldohaedphafoffoh\nTyphon Wallet\njaooiolkmfcmloonphpiiogkfckgciom\nTwetch Wallet\naijcbedoijmgnlmjeegjaglmepbmpkpi\nLeap Wallet\nfhfffofbcgbjjojdnpcfompojdjjhdim\nLamden Wallet\nagkfnefiabmfpanochlcakggnkdfmmjd\nEarth Wallet\nlpfcbjknijpeeillifnkikgncikgfhdo\n\nNami\n\n\n-----\n\nfecfflganphcinpahcklgahckeohalog\nCoin Wallet\nilhaljfiglknggcoegeknjghdgampffk\nBeam Web Wallet\ndklmlehijiaepdijfnbbhncfpcoeeljf\nFShares Wallet\nfkhebcilafocjhnlcngogekljmllgdhd\nWAGMIswap.io Wallet\nlaphpbhjhhgigmjoflgcchgodbbclahk\nBLUE - Worlds Safest and Simplest Wallet\nmkjjflkhdddfjhonakofipfojoepfndk\nUnification Web Wallet\njnldfbidonfeldmalbflbmlebbipcnle\nInfinity Wallet\nellkdbaphhldpeajbepobaecooaoafpg\nFetch.ai Network Wallet\niokeahhehimjnekafflcihljlcjccdbe\nAlby Wallet\nomajpeaffjgmlpmhbfdjepdejoemifpe\nxBull Wallet\npgojdfajgcjjpjnbpfaelnpnjocakldb\nSugarchain Wallet\npnndplcbkakcplkjnolgbkdgjikjednm\nTronium\nfnnegphlobjdpkhecapkijjdkgcjhkib\nHarmony\nfhilaheimglignddkjgofkcbgekhenbh\nOxygen\ncmbagcoinhmacpcgmbiniijboejgiahi\nJustLiquidity Wallet\nkmmolakhbgdlpkjkcjkebenjheonagdm\nAlgoSigner\nfnabdmcgpkkjjegokfcnfbpneacddpfh\nGoldmint Lite Wallet\nbgpipimickeadkjlklgciifhnalhdjhe\nGeroWallet\nhoighigmnhgkkdaenafgnefkcmipfjon\nEO.Finance\nnlgnepoeokdfodgjkjiblkadkjbdfmgd\nMulti Wallet\nnhihjlnjgibefgjhobhcphmnckoogdea\nWaves Enterprise Wallet\nehibhohmlpipbaogcknmpmiibbllplph\nBluehelix Wallet\nmagbanejlegnbcppjljfhnmfmghialkl\nNebulas Wallet\nfgkaeeikaoeiiggggbgdcjchmdfmamla\nVtimes\npnlfjmlcjdjgkddecgincndfgegkecke\nCrocobit Wallet\nbhghoamapcdpbohphigoooaddinpkbai\nAuthenticator\ngaedmjdfmmahhbjefcbgaolhhanlaolb\nAuthy\noeljdldpnmdbchonielidgobddffflal\nEOS Authenticator\nilgcnhelpchnceeipipijaljkblbcobl\n\nGAuth Authenticator\n\n\n-----\n\nimloifkgjagghnncjkhggdhalmcnfklk\nTrezor Password Manager\n%s\\%s\\Local Extension Settings\\%s\n%s\\CURRENT\n%s\\%s\\Sync Extension Settings\\%s\n%s\\%s\\IndexedDB\\chrome-extension_%s_0.indexeddb.leveldb\nPlugins\\\nHARDWARE\\DESCRIPTION\\System\\CentralProcessor\\0\nProcessorNameString\nSOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\nProductName\nx64\nx86\nDISPLAY\nSOFTWARE\\Microsoft\\Cryptography\nMachineGuid\nSOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\nDisplayName\nDisplayVersion\nscreenshot.jpg\nABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890\n/c timeout /t 5 & del /f /q \"%s\" & exit\nC:\\Windows\\System32\\cmd.exe\n\n## Dynamic linking\n\nThe adress of `GetProcAddress() and` `LoadLibraryA() is retrieved by the same method in Dynamic_Linking_1 looping over`\nthe exported functions of the kernel32.DLL, then it uses `LoadLibraryA() to Load the specified module into the address`\nspace and get a handle that get passed to `GetProcAddress() to retrieve the address of an exported function from the`\nspecified dynamic-link library.\n\nDynamic_Linking_2 is loading the APIs only needed to do some checks if it passes it will load others needed for stealing\nfunctionality.\n\ndword_42774 is `GetProcAddress() it is called in other function which is Dynamic_Linking_3 that will load other APIs needed`\nfor stealing functionality.\n\n\n-----\n\nWe use idapython to rename the global variables with the api name to make reversing easier\n\n\n-----\n\n```\n p\nstart_Addrs = [0x00415F86,0x00415FC0,0x004161A0 ]\nend_Addrs = [0x00415FB7,0x00416176,0x00417034]\nstring_list = []\nfor i in range(len(start_Addrs)):\n  ea = start_Addrs[i]\n  end = end_Addrs[i]\n  while ea <= end:\n    if (idc.print_insn_mnem(ea) == \"push\" )and (idc.get_operand_type(ea, 0) == idc.o_imm):\n      name = idc.get_strlit_contents(idc.get_operand_value(ea, 0)).decode()\n    if (idc.print_insn_mnem(ea) == \"mov\" and (idc.get_operand_type(ea, 0) == idc.o_reg)and\n(idc.get_operand_type(ea, 1) == idc.o_mem)) :\n      temp_name = idc.get_name(idc.get_operand_value(ea, 1))\n      if \"Str_\" == temp_name[0:4]:\n        name = temp_name[4::]\n    if (idc.print_insn_mnem(ea) == \"mov\") and (idc.get_operand_type(ea, 0) == idc.o_mem) and\n(idc.get_operand_type(ea, 1) == idc.o_reg):\n      global_var = idc.get_operand_value(ea, 0)\n      idc.set_name(global_var, name, SN_NOWARN)\n    ea = idc.next_head(ea, end)\n\n## Anti-Sandbox\n\n```\nSince a lot of sandboxes hook and bypass `Sleep() preventing malware being idle over their execution time. The malware first`\ncalls `GetTickCount() function that retrieves the number of milliseconds that have elapsed since the system was started, up to`\n49.7 days, that is our first timestamp. Then calls the `Sleep() to suspend itself for 16 seconds. calling` `GetTickCount()`\nagain gets our second timestamp . The malware checks if at least 12 seconds diffrence between the 2 timestampes . If the\nfunction returns flase it means that the `Sleep() hasn’t been skipped the malware assumes that it is running in a sandbox and`\nexits immediately.\n\n## Anti-CIS\n\nThis is one of the easy tricks to check if the malware is not infected users from specific countries.\n\n\n-----\n\nMars checks the user language to determine if it’s part of the Commonwealth of Independent States (CIS) countrie it gets the\nuser language ID by using GetUserDefaultLangID and it compares the user language ID to:\n\n**Language ID** **Country**\n\n0x43F Kazakhstan\n\n0x443 Uzbekistan\n\n0x82C Azerbaijan\n\n0x43Fu Kazakhstan\n\n0x419u Russia\n\n0x423u Belarus\n\nIf the user language ID matches one of the IDs above, it will exit.\n\n## Anti-Emulation\n\nIf the malware is executed with the computer name `HAL9TH and the username with` `JohnDoe it will exit . This check is done`\nbecause it is the name given to the Windows Defender Emulator, this technique is used by malware to prevent itself from\nrunning in an emulated environment.\n\n\n-----\n\n## Mutex\n\nThe malware creates a mutex object using `CreateMutexA() to avoid having more than one instance running. Then calls`\n\n`GetLastError()` which gets the last error, and if the error code is equal to 183 (ERROR_ALREADY_EXIST) it means that\nmutex already exists and an instance of the malware is already running therefore malware exits.\n\n## Anti-Debug\n\nThe malware create thread that checks `BeingDebugged flag which is Special flag in system tables, which dwell in process`\nmemory and which an operation system sets, can be used to indicate that the process is being debugged. The states of these\nflags can be verified either by using specific API functions or examining the system tables in memory. If the malware is being\ndebugged it exits . The thread is going to keep running until the malware finishes excution or the thread end the malware\nexcution if its being debugged .\n\n\n-----\n\n## Expiration check\n\nThe Expiration date variable contains the date 26/04/2022 20:00:00.\n\nMars uses [GetSystemTime() to get current system date and time as](https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtime) [SYSTEMTIME structe, then calls](https://docs.microsoft.com/en-us/windows/win32/api/minwinbase/ns-minwinbase-systemtime) `sscanf() to parse the`\nExpiration date to a SYSTEMTIME structe . [SystemTimeToFileTime() take SYSTEMTIME structe as argument then convert it to](https://docs.microsoft.com/en-us/windows/win32/api/timezoneapi/nf-timezoneapi-systemtimetofiletime)\nfile time and Expiration date although is converted to file time.\n\nIf the current time exceedes the Expiration time, the malware calls `ExitProcess() to exit immediately.`\n\n## Main Functionality\n\nMars generate random string that will be the name of the zip file contains stolen data.\n\nThe communications between c2 and the malware is described as:\n\n1. sends a GET request to the C2 URL on the `/RyC66VfSGP.php endpoint to grab its configuration .`\n2. fetches all DLLs on the `/request endpoint, the libraries are zipped`\n3. Stolen data are posted to the C2 on the same URL used in step 1.\n\nDlls retrieved:\n\n**DLL Name** **Description** **Save path**\n\n\n-----\n\n**DLL Name** **Description** **Save path**\n\nsqlite3.dll Enables SQLite related operations none (mars doesnt write it on disk, parsed from\nmemory)\n\nfreebl3.dll Library for the NSS (Gecko-based browsers) C:\\ProgramData\\freebl3.dll\n\nmozglue.dll Mozilla Browser Library C:\\ProgramData\\mozglue.dll\n\nmsvcp140.dll Visual C++ Runtime 2015 C:\\ProgramData\\msvcp140.dll\n\n\nnss3.dll Network System Services Library (Gecko-based\nbrowsers)\n\n\nC:\\ProgramData\\nss3.dll\n\n\nsoftokn3.dll Mozilla Browser Library C:\\ProgramData\\softokn3.dll\n\nvcruntime140.dll Visual C++ Runtime 2015 C:\\ProgramData\\vcruntime140.dll\n\nAnother diffrence from the last version is that sqlite3 isnt written on disk, it just get parsed and passed to another function to get\nhandle to it and start loading needed function, the other dll are written .\n\n[Since the C2 was down i got the pcap from Hatching sandbox.](https://tria.ge/220406-k1kttacaf2)\n\n\n-----\n\n## Understanding Configuration Format\n\nconfiguration is base64 encoded\n```\nMXwxfDF8MXwxfDVxRGxQdVZLb1J8RGlzY29yZHwwfCVBUFBEQVRBJVxkaXNjb3JkXExvY2FsIFN0b3JhZ2VcfCp8MXwwfDB8VGVsZWdyYW1\n8MHwlQVBQREFUQSVcVGVsZWdyYW0gRGVza3RvcFx0ZGF0YVx8KkQ4NzdGNzgzRDVEM0VGOEMqLCptYXAqLCpjb25maWdzKnwxfDB8MHw=\n1|1|1|1|1|5qDlPuVKoR|Discord|0|%APPDATA%\\discord\\Local Storage\\ |*|1|0|0|Telegram|0|%APPDATA%\\Telegram\nDesktop\\tdata\\ |*D877F783D5D3EF8C*,*map*,*configs*|1|0|0|\nimport base64\nconfig =\nbase64.b64decode(\"MXwxfDF8MXwxfDVxRGxQdVZLb1J8RGlzY29yZHwwfCVBUFBEQVRBJVxkaXNjb3JkXExvY2FsIFN0b3JhZ2VcfCp8MXwwfDB8VGVsZ\nconfig = config.split(\"|\")\nprint(\"First Part : \\n\",config[0:6])\nprint(\"Second Part :\" )\nfor i in range(6,len(config),7):\n  print(config[i:i+7])\nFirst Part : \n ['1', '1', '1', '1', '1', '5qDlPuVKoR']\nSecond Part :\n['Discord', '0', '%APPDATA%\\\\discord\\\\Local Storage\\\\', '*', '1', '0', '0']\n['Telegram', '0', '%APPDATA%\\\\Telegram Desktop\\tdata\\\\', '*D877F783D5D3EF8C*,*map*,*configs*', '1', '0', '0']\n\n```\nFirst part\n\n**Config** **Meaning**\n\n1 Downloads_history_Flag\n\n1 Browser_History_Flag\n\n1 Autofill_Flag\n\n1 ScreenShoot_Flag\n\n1 Self_Deletion_Flag\n\n5qDlPuVKoR Explorer Credentials FileName\n\nSecond part\n\n**Config** **Meaning**\n\n\n-----\n\n**Config** **Meaning**\n\nDiscord name for the zip file – will contain all the stolen files that related to the current task.so the name\nfor the zip will be name.zip.\n\n0 maybe max size (no indecation of use)\n\n\n%APPDATA%\\discord\\Local\nStorage\\\n\n\nAn environment variable name and folder name – a starting point for the recursive Grabber.\n\n\n - A regex list – contains multiply parameters that are separated by “,” each one of them is a\nregex that represents a file type.\n\n1 is_Recursive\n\n0 Write to zip enabled if 0\n\n0 Exclusion List\n\n## Grabber\n\nlets dig into `Config_Grabber function to see how you it works`\n\nafter receiving the config we can see the it has a lot of `| so it split the config with` `| delimiter and loop through the splited`\nconfig. the first part enables/disable some of the stealer functionality then it starts in part 2 which start grapping files wanted.\n\nas example\n\n[‘Discord’, ‘0’, ‘%APPDATA%\\discord\\Local Storage\\’, ‘*’, ‘1’, ‘0’, ‘0’]\n\nit start recurseively grabbing all files in `discord\\\\Local Storage\\\\ under` `%APPDATA% and put them in discord.zip`\n\n\n-----\n\nIf there is more than one regex as in\n\n[‘Telegram’, ‘0’, ‘%APPDATA%\\Telegram Desktop\\tdata\\’, ‘D877F783D5D3EF8C,map,configs’, ‘1’, ‘0’, ‘0’]\n\nit loops through them and call `Recursive_Grabber with each regex .`\n\n## Browsers\n\nMars steals credentials from browsers by static paths. It has four different methods to steal data from different types of browses,\nlike Gecko-based browsers, Opera, Internet Explorer and Chromium-based browsers.\n\n\n-----\n\n-----\n\n### Data Extraction\n\nAll the extraction functions have the same scheme:\n\n1. The malware saves the addresses of the functions from sqlite3.dll\n\nsqlite3_open\nsqlite3_prepare_v2\nsqlite3_step\nsqlite3_column_bytes\nsqlite3_column_blob\nsqlite3_column_text\nsqlite3_column_finalize\nsqlite3_column_close\n2. It generates a random string (length of 8 characters) and copies the DB file to a temp folder named like the random string\n\n– all the extractions methods will be on the copied DB. In order to extract the data from the DB, the malware has to create\nthe SQL query and query the DB using sqlite3.dll functions.\n3. The malware opens the DB by using sqlite3_open and passes the DB path.\n4. It calls to sqlite3_prepare_v2, the function gets a handle to DB and the SQL query and returns a statement handle.\n5. By using sqlite3_column_bytes/sqlite3_column_blob/sqlite3_column_text, the malware can get the results from the queries\n6. The Credentials in Chromium-based browsers DB are encrypted by DPAPI and, therefore, the malware uses the function\n\nCryptUnprotectData to decrypt the Credentials.\n\nMars steals information from the Windows Vault, which is the default storage vault for the credential manager information. This\nis done through the use of Vaultcli.dll, which encapsulates the necessary functions to access the Vault. The malware loops\nthrough its items using:\n\nVaultEnumerateVaults\nVaultOpenVault\nVaultEnumerateItems\nVaultGetItem\nVaultFree\n\n### Targeted DB Files\n\n**File Name** **Affected Software**\n\n\n-----\n\n**File Name** **Affected Software**\n\nHistory Chromium-based browsers\n\nLogin Data Chromium-based browsers\n\nCookies Chromium-based browsers\n\nWeb Data Chromium-based browsers\n\nformhistory.sqlite Gecko-based browsers\n\ncookies.sqlite Gecko-based browsers\n\nsignongs.sqlite Gecko-based browsers\n\nplaces.sqlite Gecko-based browsers\n\n### Queries Used\n\n**Query**\n\n\n**Target**\n**Browser** **Enabled**\n\n\nSELECT target_path, tab_url from downloads chromium\n, opera\n\nSELECT name, value FROM autofill chromium\n, opera\n\nSELECT url FROM urls chromium\n, opera\n\nSELECT action_url, username_value, password_value FROM logins chromium\n, opera\n\n\nSELECT HOST_KEY, is_httponly, path, is_secure,\n(expires_utc/1000000)-11644480800, name, encrypted_value from\ncookies\n\nSELECT name_on_card, expiration_month, expiration_year,\ncard_number_encrypted FROM credit_cards\n\nSELECT host, isHttpOnly, path, isSecure, expiry, name, value FROM\nmoz_cookies\n\n\nchromium\n, opera\n\nchromium\n, opera\n\n\nby default this feature is disabled, enabled\nif Downloads_history_Flag is set to 1\n\nby default this feature is disabled, enabled\nif Autofill_Flag is set to 1\n\nby default this feature is disabled,enabled\nif Browser_History_Flag is set to 1\n\nenabled by default\n\nenabled by default\n\nenabled by default\n\n\ngecko enabled by default\n\n\nSELECT url FROM moz_places gecko by default this feature is disabled,enabled\nif Browser_History_Flag is set to 1\n\nSELECT fieldname, value FROM moz_formhistory gecko enabled by default\n\n## Cryptocurrency Wallets via browser extensions\n\nMars appears to also target additional Chrome-based browser extensions related to two-factor authentication (2FA) .\n\n\n-----\n\nMars steal files from 3 folders :\n\n1. \\Local Extension Settings\\Extension ID from Google Store\n2. \\Sync Extension Settings\\ Extension ID from Google Store\n3. \\IndexedDB\\Domain Name.indexeddb.leveldb\n\nas example if the victim uses Google Chrome with a crypto browser wallet extension, the extension files will be stored in:\n\nC:\\Users\\Username\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Local Extension Settings\\Extension ID from Google\nStore C:\\Users\\Username\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Sync Extension Settings\\ Extension ID from\nGoogle Store C:\\Users\\Username\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\IndexedDB\\Domain\nName.indexeddb.leveldb\n\n**Type** **Extension name** **Extension id**\n\nCrypto TronLink ibnejdfjmmkpcnlpebklmnkoeoihofec\n\nCrypto MetaMask nkbihfbeogaeaoehlefnkodbefgpgknn\n\nCrypto Binance Chain Wallet fhbohimaelbohpjbbldcngcnapndodjp\n\nCrypto Yoroi ffnbelfdoeiohenkjibnmadjiehjhajb\n\nCrypto Nifty Wallet jbdaocneiiinmjbjlgalhcelgbejmnid\n\nCrypto Math Wallet afbcbjpbpfadlkmhmclhkeeodmamcflc\n\nCrypto Coinbase Wallet hnfanknocfeofbddgcijnmhnfnkdnaad\n\nCrypto Guarda hpglfhgfnhbgpjdenjgmdgoeiappafln\n\nCrypto EQUAL Wallet blnieiiffboillknjnepogjhkgnoapac\n\nCrypto Jaxx Liberty cjelfplplebdjjenllpjcblmjkfcffne\n\nCrypto BitApp Wallet fihkakfobkmkjojpchpfgcmhfjnmnfpi\n\nCrypto iWallet kncchdigobghenbbaddojjnnaogfppfj\n\nCrypto Wombat amkmjjmmflddogmhpjloimipbofnfjih\n\nCrypto MEW CX nlbmnnijcnlegkjjpcfjclmcfggfefdm\n\nCrypto GuildWallet nanjmdknhkinifnkgdcggcfnhdaammmj\n\n\n-----\n\n**Type** **Extension name** **Extension id**\n\nCrypto Saturn Wallet nkddgncdjgjfcddamfgcmfnlhccnimig\n\nCrypto Ronin Wallet fnjhmkhhmkbjkkabndcnnogagogbneec\n\nCrypto NeoLine cphhlgmgameodnhkjdmkpanlelnlohao\n\nCrypto Clover Wallet nhnkbkgjikgcigadomkphalanndcapjk\n\nCrypto Liquality Wallet kpfopkelmapcoipemfendmdcghnegimn\n\nCrypto Terra Station aiifbnbfobpmeekipheeijimdpnlpgpp\n\nCrypto Keplr dmkamcknogkgcdfhhbddcghachkejeap\n\nCrypto Sollet fhmfendgdocmcbmfikdcogofphimnkno\n\nCrypto Auro Wallet cnmamaachppnkjgnildpdmkaakejnhae\n\nCrypto Polymesh Wallet jojhfeoedkpkglbfimdfabpdfjaoolaf\n\nCrypto ICONex flpiciilemghbmfalicajoolhkkenfel\n\nCrypto Nabox Wallet nknhiehlklippafakaeklbeglecifhad\n\nCrypto KHC hcflpincpppdclinealmandijcmnkbgn\n\nCrypto Temple ookjlbkiijinhpmnjffcofjonbfbgaoc\n\nCrypto TezBox mnfifefkajgofkcjkemidiaecocnkjeh\n\nCrypto Cyano Wallet dkdedlpgdmmkkfjabffeganieamfklkm\n\nCrypto Byone nlgbhdfgdhgbiamfdfmbikcdghidoadd\n\nCrypto OneKey infeboajgfhgbjpjbeppbkgnabfdkdaf\n\nCrypto LeafWallet cihmoadaighcejopammfbmddcmdekcje\n\nCrypto DAppPlay lodccjjbdhfakaekdiahmedfbieldgik\n\nCrypto BitClip ijmpgkjfkbfhoebgogflfebnmejmfbml\n\nCrypto Steem Keychain lkcjlnjfpbikmcmbachjpdbijejflpcm\n\nCrypto Nash Extension onofpnbbkehpmmoabgpcpmigafmmnjhl\n\nCrypto Hycon Lite Client bcopgchhojmggmffilplmbdicgaihlkp\n\nCrypto ZilPay klnaejjgbibmhlephnhpmaofohgkpgkd\n\nCrypto Coin98 Wallet aeachknmefphepccionboohckonoeemg\n\n2FA Authenticator bhghoamapcdpbohphigoooaddinpkbai\n\n2FA Authy gaedmjdfmmahhbjefcbgaolhhanlaolb\n\n2FA EOS Authenticator oeljdldpnmdbchonielidgobddffflal\n\n2FA GAuth Authenticator ilgcnhelpchnceeipipijaljkblbcobl\n\n2FA Trezor Password Manager imloifkgjagghnncjkhggdhalmcnfklk\n\n## Crypto Wallets\n\nMars does not just stop at targeting crypto currencies via browser extensions. Many people prefer not to use third-party\napplications and services to store their digital currency. Mars will go through various folders looking for specific files related to\ncryptocurrency.\n\n\n-----\n\nThe first paramter detmerines the path if 0 then it s under %appdata% if 1 it s under %localappdata% then it search for other\nwallets with regex `*wallet*.dat under %appdata%`\n\nMars have dedicated functionality to target the following crypto wallets:\n\n**Wallet**\n**name** **Wallet folder** **Regex**\n\nEthereum %appdata%\\Ethereum\\ keystore\n\nElectrum %appdata%\\Electrum\\wallets\\ .\n\n\nElectrum\nLTC\n\n\n%appdata%\\Electrum-LTC\\wallets\\ .\n\n\nExodus %appdata%\\Exodus\\ exodus.conf.json, window-state.json, \\Exodus\\exodus.wallet\\,\npassphrase.json, seed.seco, info.seco\n\n\nElectron\nCash\n\n\n%appdata%\\ElectronCash\\wallets\\ default_wallet\n\n\nMultiDoge %appdata%\\MultiDoge\\ multidoge.wallet\n\nJaxx %appdata%\\jaxx\\Local Storage\\ file__0.localstorage\n\nAtomic %appdata%\\atomic\\Local Storage\\leveldb\\ 000003.log, CURRENT, LOCK, LOG, MANIFEST.000001, 0000*\n\nBinance %appdata%\\Binance\\ app-store.json\n\nCoinomi %localappdata%\\Coinomi\\Coinomi\\wallets\\ `*.wallet, *.config`\n\nOther %appdata% `*wallet*.dat`\nwallets\n\n## System info\n\nThe malware grabs system info and store it in system.txt file\n\n1. IP and country\n2. Working path to EXE file\n3. Local time and time zone\n4. Language system\n5. Language keyboard layout\n6. Notebook or desktop\n\n\n-----\n\n7. Processor model\n8. Computer name\n9. User name\n10. Domain computer name\n\n11. Machine ID\n12. GUID\n13. Installed software and their versions\n\nMars althouge takes screenshot and then add all stolen files to a zip file which it will exfiltrate back to the c2 and get loader\nconfig.\n\n## Loader\n\nMalware gets loader config as a response after exfiltrating data. This config looks like download_URL|An environment variable\nname and folder name |startup_parameter| .\n\nAfter pasring the config Mars calls `download_file() function with the url and a path which the file will be saved in . Then calls`\n```\nShellExecuteExA() to execute executable with give paramters retrieved from the config.\n\n```\n\n-----\n\n## Self Deletion\n\nMalware gets the path to itself by using `GetModuleFileName() and calls` `ShellExecuteExA() which executes the following`\ncommand\n\n```\n\"C:/Windows/System32/cmd.exe\" /c timeout /t 5 & del /f / path_To_file & exit\n\n```\n\nAfter 5 seconds the executable will be deleted.\n\n## Generalized idapython Script using patterns\n\n\n-----\n\n```\n p p y\nimport string\nseg_mapping = {idaapi.getseg(x).name: (idaapi.getseg(x).start_ea, idaapi.getseg(x).end_ea) for x in\n          idautils.Segments()}\nstart = seg_mapping[0x1][0]\nend = seg_mapping[0x1][1]\ndef sanitize_string(name):\n  return \"\".join([c for c in name if c in string.ascii_letters])[:20].capitalize()\ndef Xor(key, data, length):\n  res = \"\"\n  for i in range(length):\n    res += chr(key[i] ^ data[i])\n  return res\ndef getData (addr):\n  key_addr = idc.prev_head(addr)\n  data_addr = idc.prev_head(key_addr)\n  key_length_addr = idc.prev_head(data_addr)\n  length = idc.get_operand_value(key_length_addr, 0)\n  key = idc.get_bytes(idc.get_operand_value(key_addr,0),length)\n  data = idc.get_bytes(idc.get_operand_value(data_addr,0),length)\n  return key, data,length\ndef rename_APIs(ea,end):\n  func_addr = ea\n  for i in range(20):\n    if (idc.print_insn_mnem(ea) == \"push\" )and (idc.get_operand_type(ea, 0) == idc.o_imm):\n      name = idc.get_strlit_contents(idc.get_operand_value(ea, 0)).decode()\n      break\n    if (idc.print_insn_mnem(ea) == \"mov\" and (idc.get_operand_type(ea, 0) == idc.o_reg)and\n(idc.get_operand_type(ea, 1) == idc.o_mem)) :\n      temp_name = idc.get_name(idc.get_operand_value(ea, 1))\n      if \"Str_\" == temp_name[0:4]:\n        name = temp_name[4::]\n        break    \n    ea = idc.prev_head(ea)\n  ea = func_addr\n  for i in range(20):\n    if (idc.print_insn_mnem(ea) == \"mov\") and (idc.get_operand_type(ea, 0) == idc.o_mem) and\n(idc.get_operand_type(ea, 1) == idc.o_reg):\n        global_var = idc.get_operand_value(ea, 0)\n        idc.set_name(global_var, name, SN_NOWARN)\n        return name     \n    ea = idc.next_head(ea, end)\ndef API_resolve(start,end):\n  Loadlibrarya_addr = 0x0\n  GetProcAddress_pattern = \"8B 55 ?? 52 8B 45 ?? 8B 4D ?? 8B 55 ?? 03 14 ?? 52 E8 ?? ?? ?? ?? 83 C4 ?? 85 C0 75\n??\"\n  GetProcAddress_addr = ida_search.find_binary(start, end, GetProcAddress_pattern, 16, idc.SEARCH_DOWN)\n  GetProcAddress_addr = idaapi.get_func(GetProcAddress_addr).start_ea\n  print('[*] Traget fucntion found at {}'.format(hex(GetProcAddress_addr)))\n  for ref in idautils.XrefsTo(GetProcAddress_addr):\n    addr = ref.frm\n    x = rename_APIs(addr, end)\n    if \"Loadlibrarya\" in x:\n        Loadlibrarya_addr = idc.get_operand_value(idc.next_head(idc.next_head(addr, end), end), 0)\n  new_GetProcAddress_addr = idc.get_operand_value(idc.next_head(idc.next_head(addr, end), end), 0)\n  for ref in idautils.XrefsTo(new_GetProcAddress_addr):\n     addr ref frm\n\n```\n\n-----\n\n```\n           ( )\n  for ref in idautils.XrefsTo(Loadlibrarya_addr):\n    addr = ref.frm\n    rename_APIs(addr, end)\ndef Strings_resolve(start,end):\n  xor_pattern = \"8b 4d ?? 03 4d ?? 0f be 19 8b 55 ?? 52 e8 ?? ?? ?? ?? 83 c4 ?? 8b c8 8b 45 ?? 33 d2 f7 f1 8b 45 ??\n0f be 0c 10 33 d9 8b 55 ?? 03 55 ?? 88 1a eb be\"\n  xor_fun_addr = ida_search.find_binary(start, end, xor_pattern, 16, idc.SEARCH_DOWN)\n  xor_fun_addr = idaapi.get_func(xor_fun_addr).start_ea\n  print('[*] Traget fucntion found at {}'.format(hex(xor_fun_addr)))\n  for ref in idautils.XrefsTo(xor_fun_addr):\n    addr = ref.frm\n    key, data, length = getData(addr)\n    decrypt_string = Xor(key, data, length)\n    idc.set_cmt(addr, decrypt_string, 1)\n    ea = idc.next_head(idc.next_head(addr, end),end)\n    global_var = idc.get_operand_value(ea, 0)\n    idc.set_name(global_var, \"Str_\" + sanitize_string(decrypt_string), SN_NOWARN)\ndef Anit_Reverse():\n  ea = 0\n  while True:\n    ea = min(ida_search.find_binary(ea, idc.BADADDR, \"74 ? 75 ?\", 16, idc.SEARCH_NEXT | idc.SEARCH_DOWN),\n         # JZ / JNZ\n         ida_search.find_binary(ea, idc.BADADDR, \"75 ? 74 ?\", 16,\n                    idc.SEARCH_NEXT | idc.SEARCH_DOWN)) # JNZ / JZ\n    if ea == idc.BADADDR:\n      break\n    idc.patch_byte(ea, 0xEB)\n    idc.patch_byte(ea + 2, 0x90)\n    idc.patch_byte(ea + 3, 0x90)\n    idc.patch_byte(ea + 4, 0x90)\ndef main():\n  Anit_Reverse()\n  Strings_resolve(start,end)\n  API_resolve(start,end)\nmain()\n\n```\nfor more Idapython scripts check my [repo .](https://github.com/X-Junior/Malware-IDAPython-Scripts/)\n\n## IOCs\n\nHashes:\n\n1. md5 : 880924E5583978C615DD03FF89648093\n2. sha1 : EF759F6ECA63D6B05A7B6E395DF3571C9703278B\n3. sha256 : 4bcff4386ce8fadce358ef0dbe90f8d5aa7b4c7aec93fca2e605ca2cbc52218b\n4. imphash : 4E06C011D59529BFF8E1F1C88254B928\n5. ssdeep : 3072:U/E8k9fjpIg+zNch12KbAwSaSMtmSu4/bVBt4b8EG:U/E8k9bwz6/tJc/4xM8EG\nMutex : 92550737836278980100\nFiles:\n\n1. C:\\ProgramData\\freebl3.dll\n2. C:\\ProgramData\\mozglue.dll\n3. C:\\ProgramData\\msvcp140.dll\n4. C:\\ProgramData\\nss3.dll\n5. C:\\ProgramData\\softokn3.dll\n6. C:\\ProgramData\\vcruntime140.dll\nC2 Server : 194.87.218.39\n\n\n-----\n\nC2 Domains:\n\n1. http://194[.]87[.]218[.]39/request\n2. http://194[.]87[.]218[.]39/RyC66VfSGP[.]php\n\n## YARA\n```\nrule Mars_Stealer: Mars Stealer\n{\n  meta:\n    Author = \"X__Junior\"\n    Description = \"Mars Stealer v8 Detection\"\n  strings:\n    $xor ={8b 4d ?? 03 4d ?? 0f be 19 8b 55 ?? 52 e8 ?? ?? ?? ?? 83 c4 ?? 8b c8 8b 45 ?? 33 d2 f7 f1 8b 45 ?? 0f\nbe 0c 10 33 d9 8b 55 ?? 03 55 ?? 88 1a eb be}\n    $debug = {64 A1 30 00 00 00 80 78 02 00}\n     $thread_func = {B8 01 00 00 00  85 ?? 74 ?? E8 ?? ?? ?? ?? 85 ?? 74 ?? 6A 00 FF ?? ?? ?? ?? ?? 6A ?? FF ??\n?? ?? ?? ?? EB ??}\n    $api1 = \"LocalAlloc\" ascii\n    $api2 = \"VirtualProtect\" ascii\n    $api3 = \"SetFileTime\" ascii\n    $api4 = \"LocalFileTimeToFileTime\" ascii\n    $api5 = \"HeapFree\" ascii\n    $api6 = \"VirtualFree\" ascii\n    $api7 = \"VirtualAlloc\" ascii\n    $s1 = \"DPAPI\" ascii\n    $s2 = \"memset\" ascii\n    $s3 = \"msvcrt.dll\" ascii\n    $s4 = \"_mbsnbcpy\" ascii\n    $s5 = \"_mbsstr\" ascii\n  condition:\n    uint16(0) == 0x5A4D and 2 of($api*) and 3 of($s*) and $debug and $xor and $thread_func\n}\n\n Conclusion\n\n```\nThe last sample of mars i saw came packed with custom packer, easy to unpack with x32dbg by just setting a breakpoint on\n```\nVirtualAlloc(), nothing else was changed except for the C2 .\n\n## References\n\n```\n[Great analysis of the previous version https://3xp0rt.com/posts/mars-stealer](https://3xp0rt.com/posts/mars-stealer)\n[https://lp.cyberark.com/rs/316-CZP-275/images/CyberArk-Labs-Racoon-Malware-wp.pdf](https://lp.cyberark.com/rs/316-CZP-275/images/CyberArk-Labs-Racoon-Malware-wp.pdf)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-21 - Deep Analysis of Mars Stealer.pdf"
    ],
    "report_names": [
        "2022-05-21 - Deep Analysis of Mars Stealer.pdf"
    ],
    "threat_actors": [
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a66438a8-ebf6-4397-9ad5-ed07f93330aa",
            "created_at": "2022-10-25T16:47:55.919702Z",
            "updated_at": "2025-03-27T02:05:17.412024Z",
            "deleted_at": null,
            "main_name": "IRON VIKING",
            "aliases": [
                "ATK14 ",
                "BlackEnergy Group",
                "Blue Echidna ",
                "CTG-7263 ",
                "ELECTRUM ",
                "FROZENBARENTS ",
                "Hades/OlympicDestroyer ",
                "IRIDIUM ",
                "Qudedagh ",
                "Sandworm Team ",
                "Seashell Blizzard ",
                "TEMP.Noble ",
                "Telebots ",
                "Voodoo Bear ",
                "APT44 "
            ],
            "source_name": "Secureworks:IRON VIKING",
            "tools": [
                " BlackEnergy",
                " GCat",
                " GreyEnergy",
                " Industroyer",
                " KillDisk",
                " NotPetya",
                " PSCrypt",
                " TeleBot",
                " TeleDoor",
                " xData",
                "BadRabbit"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b3e954e8-8bbb-46f3-84de-d6f12dc7e1a6",
            "created_at": "2022-10-25T15:50:23.339976Z",
            "updated_at": "2025-03-27T02:00:55.446795Z",
            "deleted_at": null,
            "main_name": "Sandworm Team",
            "aliases": [
                "Sandworm Team",
                "ELECTRUM",
                "Telebots",
                "IRON VIKING",
                "BlackEnergy (Group)",
                "Quedagh",
                "Voodoo Bear",
                "IRIDIUM",
                "Seashell Blizzard",
                "FROZENBARENTS",
                "APT44"
            ],
            "source_name": "MITRE:Sandworm Team",
            "tools": [
                "Bad Rabbit",
                "Mimikatz",
                "Exaramel for Linux",
                "Exaramel for Windows",
                "GreyEnergy",
                "PsExec",
                "Prestige",
                "P.A.S. Webshell",
                "VPNFilter",
                "Cyclops Blink",
                "SDelete",
                "AcidRain",
                "Industroyer",
                "Industroyer2",
                "BlackEnergy",
                "Cobalt Strike",
                "NotPetya",
                "KillDisk",
                "PoshC2",
                "Impacket",
                "Invoke-PSImage",
                "Olympic Destroyer"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3a0be4ff-9074-4efd-98e4-47c6a62b14ad",
            "created_at": "2022-10-25T16:07:23.590051Z",
            "updated_at": "2025-03-27T02:02:09.878211Z",
            "deleted_at": null,
            "main_name": "Energetic Bear",
            "aliases": [
                "ATK 6",
                "Blue Kraken",
                "Crouching Yeti",
                "Dragonfly",
                "Electrum",
                "Energetic Bear",
                "Ghost Blizzard",
                "Group 24",
                "ITG15",
                "Iron Liberty",
                "Koala Team",
                "TG-4192"
            ],
            "source_name": "ETDA:Energetic Bear",
            "tools": [
                "Backdoor.Oldrea",
                "CRASHOVERRIDE",
                "Commix",
                "CrackMapExec",
                "CrashOverride",
                "Dirsearch",
                "Dorshel",
                "Fertger",
                "Fuerboos",
                "Goodor",
                "Havex",
                "Havex RAT",
                "Hello EK",
                "Heriplor",
                "Impacket",
                "Industroyer",
                "Karagany",
                "Karagny",
                "LightsOut 2.0",
                "LightsOut EK",
                "Listrix",
                "Oldrea",
                "PEACEPIPE",
                "PHPMailer",
                "PsExec",
                "SMBTrap",
                "Subbrute",
                "Sublist3r",
                "Sysmain",
                "Trojan.Karagany",
                "WSO",
                "Webshell by Orb",
                "Win32/Industroyer",
                "Wpscan",
                "nmap",
                "sqlmap",
                "xFrost"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8941e146-3e7f-4b4e-9b66-c2da052ee6df",
            "created_at": "2023-01-06T13:46:38.402513Z",
            "updated_at": "2025-03-27T02:00:02.824555Z",
            "deleted_at": null,
            "main_name": "Sandworm",
            "aliases": [
                "G0034",
                "IRIDIUM",
                "Blue Echidna",
                "FROZENBARENTS",
                "Seashell Blizzard",
                "IRON VIKING",
                "ELECTRUM",
                "TeleBots",
                "UAC-0113",
                "UAC-0082",
                "APT44",
                "Quedagh",
                "VOODOO BEAR",
                "TEMP.Noble"
            ],
            "source_name": "MISPGALAXY:Sandworm",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535631,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1653685127,
    "ts_modification_date": 1653685127,
    "files": {
        "pdf": "https://archive.orkl.eu/4b29d5713eb166d3c6b73ddb1ebf51a77c0f09a9.pdf",
        "text": "https://archive.orkl.eu/4b29d5713eb166d3c6b73ddb1ebf51a77c0f09a9.txt",
        "img": "https://archive.orkl.eu/4b29d5713eb166d3c6b73ddb1ebf51a77c0f09a9.jpg"
    }
}