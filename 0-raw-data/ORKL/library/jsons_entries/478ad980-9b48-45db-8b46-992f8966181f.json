{
    "id": "478ad980-9b48-45db-8b46-992f8966181f",
    "created_at": "2023-01-12T14:59:54.179788Z",
    "updated_at": "2025-03-27T02:09:18.372495Z",
    "deleted_at": null,
    "sha1_hash": "d8fe9cfd605bc780f59591b568593733ec91b5aa",
    "title": "2020-11-06 - Cobalt Strike 4.2 â€“ Everything but the kitchen sink",
    "authors": "",
    "file_creation_date": "2022-05-28T16:15:49Z",
    "file_modification_date": "2022-05-28T16:15:49Z",
    "file_size": 234957,
    "plain_text": "# Cobalt Strike 4.2 â€“ Everything but the kitchen sink\n\n**[blog.cobaltstrike.com/2020/11/06/cobalt-strike-4-2-everything-but-the-kitchen-sink/](https://blog.cobaltstrike.com/2020/11/06/cobalt-strike-4-2-everything-but-the-kitchen-sink/)**\n\nRaphael Mudge November 6, 2020\n\nCobalt Strike 4.2 is now available. This release overhauls our user exploitation features,\nadds more memory flexibility options to Beacon, adds more behavior flexibility to our postexploitation features, and makes some nice changes to Malleable C2 too.\n\n## User Exploitation Redux\n\n[Cobalt Strikeâ€™s screenshot tool and keystroke logger are examples of user exploitation tools.](https://www.cobaltstrike.com/2016/04/28/user-exploitation-at-scale/)\nThese capabilities are great for risk demonstration and story telling. But, with good UX, these\nfeatures are also powerful capabilities to collect information that aids moving closer to an\nobjective in a network.\n\nCobalt Strikeâ€™s screenshot tool and keystroke logger now report active window, username,\nand desktop session with each of their results. This context helps our GUI, logs, and reports\ndisplay where this information came from. Itâ€™s a subtle change, but a big enhancement:\n\nThe right-click menu in the screenshot and keystroke has updates too. You can now remove\na keystroke buffer or screenshot from the interface. Highlight a row with a color. And, save\nthe keystroke buffer or screenshot to a local file as well.\n\nWe also split screenshot into two commands: screenshot and screenwatch. The screenshot\ncommand takes a single screenshot. The screenwatch command (which can fork&run or\ninject into a specific process) takes screenshots continuously until itâ€™s stopped with the\n**jobkill command.**\n\n\n-----\n\nAs believers in offense in depth, we ve added new options to acquire screenshots and log\nkeystrokes too. The printscreen command forces a PrintScr keypress and grabs the\nscreenshot from the clipboard. This command was inspired by the creative and awesome\n[Advanced Post-Exploitation Workshop given by @zerosum0x0 and](https://github.com/zerosum0x0/defcon-25-workshop) [@aleph__naught at](https://twitter.com/aleph__naught)\n2017â€™s DEF CON 25. And, weâ€™ve added a post-ex -> keylogger [Malleable C2 option to](https://www.cobaltstrike.com/help-malleable-postex#postex)\n[change the keystroke logger between GetAsyncKeyState and](https://medium.com/@ghostlulzhacks/malware-basic-windows-key-logger-746cc09e66aa) [SetWindowsHookEx methods.](https://0x00sec.org/t/windows-keylogging-part-i/99)\n\n## More In-memory Flexibility\n\n[Cobalt Strike has long had an interest in in-memory detection and evasion. I love in-memory](https://www.cobaltstrike.com/2018/02/08/in-memory-evasion/)\ndetections, because I think these tactics put real pressure on post-exploitation survival. But,\nitâ€™s also important to challenge security teams that rely on these tactics, to force thinking\nbeyond that â€œone easy trickâ€ thatâ€™s working right now.\n\nCobalt Strike 4.2 continues to build Beaconâ€™s in-memory flexibility.\n\nBeaconâ€™s Reflective Loader now has two added options for allocating memory for the\nBeacon payload in memory. Set stage -> allocator to HeapAlloc to use RWX heap memory\nfor the Beacon payload. Set stage -> allocator to MapViewOfFile to stick Beacon in mapped\nmemory. This is in addition to VirtualAlloc (the default) and 3.11â€™s [module stomping, which is](https://youtu.be/uWVH9l2GMw4?t=762)\nour way of putting Beacon into image memory.\n\nWeâ€™ve also added new options for content flexibility. Beaconâ€™s Reflective DLL follows\nMetasploitâ€™s conventions to make itself self-bootstrapping. We patch the beginning of the\nDLL (the part with that MZ header) with instructions to call the Reflective Loader with a few\narguments. A common in-memory detection trick is to scan executable memory regions for\nMZ and PE content that looks like a PE/COFF file. These items are easy â€œit has to be thereâ€\ncontent to find a Reflective DLL. Not anymore though.\n\nSet magic_mz_x86 to change the x86 Reflective DLL MZ header in Beacon. This updates\nthe other parts of the loading process that depend on the value. The catch is that valid x86\ninstructions are required for magic_mz_x86. For example, MZ in x86 are the instructions dec\nebp, pop edx. You donâ€™t want to begin execution with unexpected state, so itâ€™s also\nrecommended to undo any state changes made by your instructions. This is why the default\nmagic_mz_x86 value is MZRE. The R and E bytes decode to push edx, inc ebp. They undo\nthe effect of the MZ instructions. The same idea applies for set magic_mz_x64 too.\n\n\n-----\n\nWeâ€™ve also added set magic_pe which changes the PE header magic bytes (and code that\ndepends on these bytes) to something else. You can use whatever you want here, so long as\nitâ€™s two characters.\n\n## Post-ex Omikase Shimasu: Second serving\n\n[Cobalt Strike 3.14 introduced a lot of options to change behaviors, characteristics, and](https://www.cobaltstrike.com/2019/05/02/cobalt-strike-3-14-post-ex-omakase-shimasu/)\ncontent in Cobalt Strikeâ€™s post-exploitation DLLs. Cobalt Strike 4.2 continues this work.\n\nWeâ€™ve added post-ex -> pipename to Malleable C2. This is an option to specify a commaseparated list of pipenames. Cobalt Strike will choose one of these when it executes its postexploitation jobs. #s in the pipename are replaced with a [a-f0-9] character. Weâ€™ve also\nadded set ssh_pipename to change the named pipe used by Cobalt Strikeâ€™s SSH client.\nMultiple pipenames are allowed in this option too.\n\nSome of Beaconâ€™s post-exploitation DLLs do create threads. In a keystroke logger that uses\nGetAsyncKeyState, this isnâ€™t easily avoidable. ðŸ™‚ To help these situations, weâ€™ve introduced\n**post-ex -> thread_hint to Malleable C2. When set, our post-ex DLLs will create a**\nsuspended thread with the specified module!function+0x[offset] address. Update the thread\nto run the post-exploitation capability. And, resume it. This is a way to push back on point-intime analysis that looks for moduleless thread start addresses.\n\n[And, one of my favorite features in Cobalt Strike is the obfuscate and sleep feature. This is](https://www.youtube.com/watch?v=AV4XjxYe4GM&feature=emb_title)\nthe ability for Beacon to mask its content [and code, if youâ€™re RWX] in memory during long\nblocking periods. Obfuscate and sleep is a method to push back on point-in-time analysis\nthat looks for known strings in memory. Now, when post-ex -> obfuscate is true, Cobalt\nStrikeâ€™s execute-assembly, keystroke logger, screenshot, and SSH client features will mask\nmany of their strings while theyâ€™re running.\n\n## Malleable C2 Thingsâ€¦\n\n[And, weâ€™ve made several updates to the communicate side of Malleable C2. Weâ€™ve doubled](https://www.cobaltstrike.com/help-malleable-c2)\nthe maximum size of the global useragent field. Weâ€™ve also doubled the max size of the the\n**http-get -> client and http-post -> client programs too. This will help those of you that had**\nrun into the previous limits in your profile writing.\n\n\n-----\n\nThis release adds the global headers_remove option. This option affects http-get and httppost client blocks. Itâ€™s a late-in-the-transaction option to remove unwanted HTTP client\nheaders from the communication. WinINet, based on its configuration, will force some\nheaders into the transaction. You may specify specify multiple unwanted headers (separate\nthem with commas) in this option.\n\nAnd, Cobalt Strike 4.2 introduces a data content jitter as well. Set data_jitter to a number\nvalue and Cobalt Strike will append a random content and length string (up to the data_jitter\nvalue bytes) to its http-get and http-post server output.\n\n[Check out the release notes to see a full list of whatâ€™s new in Cobalt Strike 4.2. Licensed](https://www.cobaltstrike.com/releasenotes.txt)\nusers may [run the update program to get the latest. To procure Cobalt Strike (or ask about](https://www.cobaltstrike.com/help-update-cobalt-strike)\n[evaluation options), please contact us for more information.](https://www.cobaltstrike.com/special)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-06 - Cobalt Strike 4.2 â€“ Everything but the kitchen sink.pdf"
    ],
    "report_names": [
        "2020-11-06 - Cobalt Strike 4.2 â€“ Everything but the kitchen sink.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535594,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653754549,
    "ts_modification_date": 1653754549,
    "files": {
        "pdf": "https://archive.orkl.eu/d8fe9cfd605bc780f59591b568593733ec91b5aa.pdf",
        "text": "https://archive.orkl.eu/d8fe9cfd605bc780f59591b568593733ec91b5aa.txt",
        "img": "https://archive.orkl.eu/d8fe9cfd605bc780f59591b568593733ec91b5aa.jpg"
    }
}