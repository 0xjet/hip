{
    "id": "b1854592-68c8-4fa0-a657-48ae644f516d",
    "created_at": "2023-01-12T15:00:22.698592Z",
    "updated_at": "2025-03-27T02:15:41.694594Z",
    "deleted_at": null,
    "sha1_hash": "d31959826a552e686882367c9400146169af95aa",
    "title": "2022-03-30 - Detecting COM Object Tasks by DarkHotel",
    "authors": "",
    "file_creation_date": "2022-05-28T16:05:07Z",
    "file_modification_date": "2022-05-28T16:05:07Z",
    "file_size": 961931,
    "plain_text": "# Detecting COM Object Tasks Used by DarkHotel\n\n**[cyberandramen.net/2022/03/30/detecting-com-object-tasks-by-darkhotel/](https://cyberandramen.net/2022/03/30/detecting-com-object-tasks-by-darkhotel/)**\n\nBackground\n\n\nMarch 30, 2022\n\n\nAdversaries frequently utilize scheduled tasks, a legitimate Windows operating system utility\nto establish/maintain persistence and even execute code in a victim network.\n\nScheduled tasks allow for persistence on a victim network between reboots as well as code\nexecution when a certain condition is met (time, user logon, etc.).\n\nIn this specific example, the adversary does not rely on schtasks.exe for task creation, but on\na COM object that loads the Task Scheduler Service.\n\nThis means hunting or detecting anomalous use of schtasks.exe won’t provide the defender\nany tangible information, thus we need to discover other opportunities to find this attack\ntechnique.\n\nTo Detect or Hunt?\n\nA recent article by Trellix details new activity moderately attributed to the DarkHotel APT\ngroup. Please give the Trellix blog a look for additional information on the full attack chain.\n\nThe purpose of this post will be to provide some detection or hunting ideas for COM Objectcreated scheduled tasks.\n\n**1 . Block or audit Office applications from creating executable content.**\n\nFigure 1\nThis detection opportunity likely offers the least effort to implement. The full attack chain\npresented above in Figure 1 courtesy of Microsft Defender for Endpoint (MDE), not only\ndetects the scheduled task, but also a malicious VBS file.\n\nOutright blocking Office applications from executable content may not be feasible in some\nenvironments.\n\n\n-----\n\nMicrosoft s Attack Surface Reduction (ASR) has added a new mode, warn along with audit\nand block. This new ASR mode provides a dialog box notifying the user content was\nblocked, and allowing them to unblock content for 24 hours.\n\nFigure 2\nFor additional information on ASR and the newly added mode, please visit:\n\nhttps://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surfacereduction?view=o365-worldwide\n\n**2 . Image Load event logging with Sysmon**\n\nFigure 2\n\n\n-----\n\nSysmon s Event 7, Image Loaded provides defenders visibility and the opportunity to collect\nevents where DLLs are loaded by processes.\n\nIn this case, it is unlikely Excel.exe has a legitimate reason to load taskschd.dll. Again,\ndepending on how your environment utilizes VBA macro documents, Sysmon and other\nSIEM rules may require tuning.\n\nA Sigma rule and example Splunk query are provided below.\n\nThe above Sigma rule converts to an easy SPL one-liner:\n```\n\"source=sysmon\" (Image=\"*\\\\Excel.exe\" OR Image=\"*\\\\Winword.exe\" OR\nImage=\"*\\\\Powerpnt.exe\") (ImageLoaded=\"*\\\\taskschd.dll\"))\n\n```\nThe malicious Excel file also loads wshom.ocx, part of the Windows Scripting Host, or\nwscript.exe (Figure 3).\n\nThis can be added to the above query by searching for ImageLoaded=”*\\\\wshom.ocx”.\n\n\n-----\n\nFigure 3\n**3 . Scheduled Task created without schtasks.exe**\n\nFigure 4\nThe KQL query in Figure 4 represents a very basic (I’m still trying to grasp KQL), a method to\ndiscover Scheduled Tasks created without schtasks.exe.\n\nIf you look closely at the above, both Tasks are related to running the malware in my lab.\n\nThe two Tasks are labeled “MicrosoftOneDriveMgmt”, and “MicrosoftOneDriveSync”.\n\n\n-----\n\nFigure 5\nAgain as touched on above, MDE captures and logs the command-line arguments and\nprocesses for suspicious wscript.exe use (Figure 6)\n\nFigure 6\n**4 . Scheduled Tasks with a short shelf life**\n\nThis specific case offers an opportunity to detect Scheduled Tasks created (Event ID 4698)\nfor a short period of time. In this case, the task would be executed every five minutes for a\nperiod of one day.\n\nFigure 7\nAs we have seen in the above images, every five minutes the Task reaches out to a C2\nserver. Depending on your environment, this may be a good indicator of beaconing.\n\nConclusion\n\n\n-----\n\nWhile the above technique of utilizing an Office App to create a Scheduled Task via a COM\nObject is not new, I hope this post provides you with ideas to detect Tasks created without\nschtasks.exe.\n\nFurther Reading\n\nIn no specific order,\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-30 - Detecting COM Object Tasks by DarkHotel.pdf"
    ],
    "report_names": [
        "2022-03-30 - Detecting COM Object Tasks by DarkHotel.pdf"
    ],
    "threat_actors": [
        {
            "id": "1dadf04e-d725-426f-9f6c-08c5be7da159",
            "created_at": "2022-10-25T15:50:23.624538Z",
            "updated_at": "2025-03-27T02:00:55.508759Z",
            "deleted_at": null,
            "main_name": "Darkhotel",
            "aliases": [
                "Darkhotel",
                "DUBNIUM",
                "Zigzag Hail"
            ],
            "source_name": "MITRE:Darkhotel",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "b13c19d6-247d-47ba-86ba-15a94accc179",
            "created_at": "2024-05-01T02:03:08.149923Z",
            "updated_at": "2025-03-27T02:05:17.422065Z",
            "deleted_at": null,
            "main_name": "TUNGSTEN BRIDGE",
            "aliases": [
                "DUBNIUM ",
                "DarkHotel ",
                "CTG-1948 "
            ],
            "source_name": "Secureworks:TUNGSTEN BRIDGE",
            "tools": [
                "Nemim"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "2b4eec94-7672-4bee-acb2-b857d0d26d12",
            "created_at": "2023-01-06T13:46:38.272109Z",
            "updated_at": "2025-03-27T02:00:02.790029Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "DUBNIUM",
                "Fallout Team",
                "Luder",
                "Tapaoux",
                "Shadow Crane",
                "APT-C-06",
                "SIG25",
                "Karba",
                "Nemim",
                "Nemin",
                "G0012",
                "ATK52",
                "T-APT-02",
                "TUNGSTEN BRIDGE",
                "Zigzag Hail"
            ],
            "source_name": "MISPGALAXY:DarkHotel",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c0cedde3-5a9b-430f-9b77-e6568307205e",
            "created_at": "2022-10-25T16:07:23.528994Z",
            "updated_at": "2025-03-27T02:02:09.847683Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "APT-C-06",
                "ATK 52",
                "CTG-1948",
                "Dubnium",
                "Fallout Team",
                "Higaisa",
                "Luder",
                "Operation DarkHotel",
                "Operation Daybreak",
                "Operation Inexsmar",
                "Operation PowerFall",
                "Operation The Gh0st Remains the Same",
                "SIG25",
                "Shadow Crane",
                "T-APT-02",
                "Tungsten Bridge",
                "Zigzag Hail"
            ],
            "source_name": "ETDA:DarkHotel",
            "tools": [
                "Asruex",
                "DarkHotel",
                "DmaUp3.exe",
                "GreezeBackdoor",
                "Karba",
                "Nemain",
                "Nemim",
                "Ramsay",
                "Retro",
                "Tapaoux",
                "Trojan.Win32.Karba.e",
                "Virus.Win32.Pioneer.dx",
                "igfxext.exe",
                "msieckc.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535622,
    "ts_updated_at": 1743041741,
    "ts_creation_date": 1653753907,
    "ts_modification_date": 1653753907,
    "files": {
        "pdf": "https://archive.orkl.eu/d31959826a552e686882367c9400146169af95aa.pdf",
        "text": "https://archive.orkl.eu/d31959826a552e686882367c9400146169af95aa.txt",
        "img": "https://archive.orkl.eu/d31959826a552e686882367c9400146169af95aa.jpg"
    }
}