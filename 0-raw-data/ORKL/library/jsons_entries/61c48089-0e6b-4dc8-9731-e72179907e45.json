{
    "id": "61c48089-0e6b-4dc8-9731-e72179907e45",
    "created_at": "2023-01-12T15:09:06.902585Z",
    "updated_at": "2025-03-27T02:13:58.331437Z",
    "deleted_at": null,
    "sha1_hash": "ed459b5cf820505964c2487a47317e5fe86bded1",
    "title": "2021-03-04 - IcedID Banking Trojan Uses COVID-19 Pandemic to Lure New Victims",
    "authors": "",
    "file_creation_date": "2022-05-28T16:58:57Z",
    "file_modification_date": "2022-05-28T16:58:57Z",
    "file_size": 1817681,
    "plain_text": "# IcedID Banking Trojan Uses COVID-19 Pandemic to Lure New Victims\n\n**[f5.com/labs/articles/threat-intelligence/icedid-banking-trojan-uses-covid-19-pandemic-to-lure-new-victims](https://www.f5.com/labs/articles/threat-intelligence/icedid-banking-trojan-uses-covid-19-pandemic-to-lure-new-victims)**\n\nMarch 4, 2021\n\nApp Tiers Affected:\n\nClient\n\nServices\n\n\n-----\n\nAccess\n\nTLS\n\nDNS\n\n\n-----\n\nNetwork\n\nApp Tiers Affected:\n\nClient\n\nServices\n\n\n-----\n\nAccess\n\n\n-----\n\nTLS\n\n\n-----\n\nDNS\n\n\n-----\n\nNetwork\n\n[The IcedID malware, also known as Bokbot, is a banking trojan first discovered in 2017 that](https://www.f5.com/labs/articles/education/banking-trojans-a-reference-guide-to-the-malware-family-tree)\nsteals credentials by tricking browser functions into redirecting traffic. It is a stealthy, fileless\nmalware with anti-sandbox capabilities. Previously, F5 Labs analyzed IcedID decompression\nmethods for web injecting relevant files into a target list. This is a much deeper attack chain\nanalysis of IcedID and its techniques.\n\n## Stage 1: IcedID is Distributed through Microsoft Word Document Email Attachments\n\nIn recent attacks, IcedID has been deployed as part of the TA551, or Shathak, email-based\nmalware distribution campaign, often targeting English-speaking victims. The campaign uses\nlures tied to the COVID-19 pandemic to trick users into opening malicious attachments. Over\nthe past year, F5 Labs has seen that the majority of phishing and fraud attacks have been\ncloaked in pandemic-related lures.\n\nIn the current campaign, IcedID rides in on Microsoft Word documents with a poisoned\nmacro that inserts an installer to install the malware, which is designed to steal users’\ncredentials, payment card data and other sensitive information from major financial\ninstitutions and retailers.\n\n\n-----\n\n## Stage 2: IcedID is Installed and Injected\n\nThe malicious Microsoft Word macro download and executes the installer which relocates\nitself to %APPDATA%\\Local\\{user}\\ or %APPDATA%\\Local\\{GUID}\\ and sets a scheduled\ntask to run every hour or user logon for persistency. Later on the installer tries to download a\nPNG image from several command-and-control (C&C) domains.\n\nInside the PNG is an IcedID loader encrypted with RC4 hidden as a legitimate PNG file, a\ntechnique called steganography to hide itself from security solutions such as antivirus,\nmalware-detecting sandboxes, and static analysis tools.\n\nThe installer transfers control to the RC4-decrypted shellcode that injects itself into other\nprocesses by creating a suspended process, writing the shellcode to the process’s memory,\nsetting an asynchronous procedure call (APC) thread to transfer control to the shellcode, and\nlastly calling NtResumeThread to start the injection.\n\nThe injected process is usually msiexec.exe or svchost.exe, as shown in Figure 1. Both are\ndigitally signed by a well-known Microsoft certificate, making it harder to detect.\n\nFigure 1. IcedID process tree in runtime.\n\n### IcedID APC Injection\n\nIcedID uses part of the process hollowing technique to inject malicious code into suspended\nprocesses and to evade process-based defenses. Figure 2 shows this technique’s specific\ncode snippet for IcedID. The suspended legitimate process is either svchost.exe or\nmsiexec.exe, which are known and signed Microsoft processes.\n\n\n-----\n\nFigure 2. Code injection technique and its functions.\n\nTo use this technique, the malware does the following:\n\n1. Creates a process using CreateProcessA with a SUSPENDED flag,\n2. Allocates memory using NtAllocateVirtualMemory API,\n3. Writes the shellcode to memory using ZwWriteVirtualMemory API,\n4. Changes the memory protections using NtProtectVirtualMemory,\n5. Creates an APC thread routed to the shellcode\n6. With the process still in suspended mode, the technique’s last step is to call\n\nNtResumeThread API to resume the process.\n\n\n-----\n\nOnce this is done, the shellcode walks through the process environment block (PEB)\nstructure, comparing a hash against function names retrieved in order to create dynamic\nresolving (Figure 3 and Figure 4).\n\nFigure 3. Code snippet: IcedID scans the process environment block to find modules by\nencrypted hash.\n\n\n-----\n\nFigure 4. Second code snippet: IcedID scans the process environment block to find modules\nby encrypted hash.\n\nTo make things harder for antimalware controls and security researchers, this technique\ndynamically creates an import table with no strings associated with function names in\nmemory. It does so by making use of the PEB, a data structure within the process’ memory\nto hold information about the current processes. IcedID scans through the PEB, enumerating\nall the module function names, find the needed functions and store them in variables for later\nuse.\n\nF5 Labs Newsletter\n\nOne email per week, with newsletter exclusives\nLatest security research insights\nCISO-level expert analysis\n\nF5 Labs Newsletter\n\n_[The information you provide will be treated in accordance with the F5 Privacy Notice.](https://www.f5.com/company/policies/privacy-policy)_\n\nGreat! You should receive your first email shortly\n\n\n-----\n\n## Stage 3: IcedID Sneaks through the System\n\nWith the malware fully running in the infected system, it now seeks out targets within the\nsystem to ensure it’s in a good place to steal credentials. However, it also needs to continue\nto resist analysis and evade detection by antivirus software.\n\n### IcedID Certificate Store\n\nIcedID creates a tmp file inside the %TEMP% folder (Figure 5), which contains a certificate\nstore used to save all self-signed certificates the malware has generated so it won’t have to\nregenerate the certificate for every website.\n\nFigure 5. IcedID generates code to create a certificate store.\n\n### IcedID String Evasion Techniques\n\nIcedID uses string encryption to avoid being detected. String obfuscation is an evasion\ntechnique that malware uses to hide malicious activity as well as to make static analysis\nharder for researchers and automations. A common way to hide strings is to create a hash\nand compare against a hard coded precalculated hash. IcedID uses this method to find the\nbrowser’s file name without using the associated string, which could be detected within the\nmalware, as shown in Figure 6.\n\n\n-----\n\nFigure 6. IcedID uses string encryption to create a hash and avoid being detected.\n\nAnother evasion technique that IcedID uses is to encrypt the malicious strings beforehand\nand only decrypt them in memory, as shown in Figure 7.\n\n\n-----\n\nFigure 7. IcedID technique that encrypts malicious strings and decrypts them in memory.\n\nFinally, another common IcedID technique is to hide strings within the stacks. It breaks down\nthe string one character at a time and saves it inside a variable, which is put onto the stack,\nas shown in Figure 8.\n\nFigure 8. IcedID hiding strings in the stacks.\n\n### IcedID Anti-debugging and Anti-Sandboxing Techniques\n\nTo hide itself from virtual machines, often used to debug or detect malware, IcedID needs to\ndetermine if it is running in a sandbox. It does this by first calculating the timing execution of\nthe cpuid instruction by using the read time-stamp counter (RDTSC) to count the number of\nCPU cycles since reset. It uses SwitchToThread in this function to measure with RDTSC\nwithout the context switch fluctuations, as shown in Figure 9. Note that the call to\n_SwitchToThread happens prior to the RDTSC instruction to ensure the measurement_\nhappens in the same time slice (without a context switch in the middle of measuring). For a\nmore reliable measure, this is done in a loop 16 times.\n\n\n-----\n\nFigure 9. IcedID using the SwitchToThread anti-sandboxing technique.\n\nWith this information, IcedID can check the hypervisor’s brand using cpuid with\nEAX=0x40000000 and turn on a bit accordingly inside the in_vm variable, as shown in Figure\n10.\n\n\n-----\n\nFigure 10. IcedID checking the hypervisor’s brand using cpuid.\n\n## IcedID Maintains Persistence\n\nTo stay persistent on the infected machine, IcedID copies itself to directory\n%AppData%\\Roaming\\%username%\\ or (in some variants) also copies itself to\nC:\\Users\\%username%\\AppData\\Roaming\\[GUID]\\. It then creates a task in the Task\nScheduler to run the malware upon user logon or every hour, as shown in Figure 11. This\nensures IcedID remains running after reboots.\n\n\n-----\n\nFigure 11. IcedID setting up a malicious task in the Task Scheduler.\n\n**Hashes**\n\n### Installer/Runner\n\n0547235018162552fcbbb67196017100\nD2275febf5f95a75a304ad2c13101f6d\n\n**PNG**\n\ncfb7a24b2f7d58d6d6dbcb91529b8020\n\n### Command-and-Control Domains\n\nblholove[.]co\nmorganholes[.]cyou\nmarmateria[.]cyou\natombody[.]best\n\n### Installer/Runner\n\nMD5: 1705b9771134ce41e4d7e4d0f3b6d344\nMD5: 4fa2f9ed6756fc6e1efba2f6cf54e290\n\n**Command-and-Control Domains**\n\nblholove.co\nmorganholes.cyou\nmarmateria.cyou\n\n\n-----\n\natombody.best\n\n### Installer/Runner\n\nMD5: d2275febf5f95a75a304ad2c13101f6d\n\n**Command-and-Control Domains**\n\nfdelopoh.club\nzedebobo.top\nshmylvaro.pw\nresonanse.cyou\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-04 - IcedID Banking Trojan Uses COVID-19 Pandemic to Lure New Victims.pdf"
    ],
    "report_names": [
        "2021-03-04 - IcedID Banking Trojan Uses COVID-19 Pandemic to Lure New Victims.pdf"
    ],
    "threat_actors": [
        {
            "id": "26a04131-2b8c-4e5d-8f38-5c58b86f5e7f",
            "created_at": "2022-10-25T15:50:23.579601Z",
            "updated_at": "2025-03-27T02:00:55.50292Z",
            "deleted_at": null,
            "main_name": "TA551",
            "aliases": [
                "TA551",
                "GOLD CABIN",
                "Shathak"
            ],
            "source_name": "MITRE:TA551",
            "tools": [
                "QakBot",
                "IcedID",
                "Valak",
                "Ursnif"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "04e34cab-3ee4-4f06-a6f6-5cdd7eccfd68",
            "created_at": "2022-10-25T16:07:24.578896Z",
            "updated_at": "2025-03-27T02:02:10.286803Z",
            "deleted_at": null,
            "main_name": "TA551",
            "aliases": [
                "Gold Cabin",
                "Monster Libra",
                "Shathak",
                "TA551"
            ],
            "source_name": "ETDA:TA551",
            "tools": [
                "BokBot",
                "CRM",
                "Gozi",
                "Gozi CRM",
                "IceID",
                "IcedID",
                "Papras",
                "Snifula",
                "Ursnif",
                "Valak",
                "Valek"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "90f216f2-4897-46fc-bb76-3acae9d112ca",
            "created_at": "2023-01-06T13:46:39.248936Z",
            "updated_at": "2025-03-27T02:00:03.031127Z",
            "deleted_at": null,
            "main_name": "GOLD CABIN",
            "aliases": [
                "Shakthak",
                "TA551",
                "ATK236",
                "G0127",
                "Monster Libra"
            ],
            "source_name": "MISPGALAXY:GOLD CABIN",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "40b623c7-b621-48db-b55b-dd4f6746fbc6",
            "created_at": "2024-06-19T02:03:08.017681Z",
            "updated_at": "2025-03-27T02:05:17.342829Z",
            "deleted_at": null,
            "main_name": "GOLD CABIN",
            "aliases": [
                "TA551 ",
                "Shathak"
            ],
            "source_name": "Secureworks:GOLD CABIN",
            "tools": [
                ""
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536146,
    "ts_updated_at": 1743041638,
    "ts_creation_date": 1653757137,
    "ts_modification_date": 1653757137,
    "files": {
        "pdf": "https://archive.orkl.eu/ed459b5cf820505964c2487a47317e5fe86bded1.pdf",
        "text": "https://archive.orkl.eu/ed459b5cf820505964c2487a47317e5fe86bded1.txt",
        "img": "https://archive.orkl.eu/ed459b5cf820505964c2487a47317e5fe86bded1.jpg"
    }
}