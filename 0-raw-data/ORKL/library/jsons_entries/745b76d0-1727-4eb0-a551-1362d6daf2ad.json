{
    "id": "745b76d0-1727-4eb0-a551-1362d6daf2ad",
    "created_at": "2023-04-26T02:09:25.849248Z",
    "updated_at": "2025-03-27T02:16:34.546832Z",
    "deleted_at": null,
    "sha1_hash": "c55442b94248847e9fd978361486a86daa76b7b5",
    "title": "",
    "authors": "",
    "file_creation_date": "2022-08-18T05:14:26Z",
    "file_modification_date": "2022-08-18T05:14:32Z",
    "file_size": 4673938,
    "plain_text": "# Remediation and Hardening Strategies for Microsoft 365 to Defend Against APT29 (v1.3)\n\n\n-----\n\n## Table of Contents\n\n**Overview............................................................................................................................................4**\n\nBackground.................................................................................................................................4\n\nGoals and Objectives....................................................................................................................4\n\n**Attacker Tactics, Techniques and Procedures (TTPs).......................................................................5**\n\n**Remediation Strategy........................................................................................................................6**\n\nRemediation Sequencing.............................................................................................................7\n\n**AD FS Attack Mitigation......................................................................................................................8**\n\n**Attack Technique: Golden SAML Attack.............................................................................................9**\n\nActive Directory Federation Service Overview.............................................................................9\n\nTechnique...................................................................................................................................11\n\nRemediation.............................................................................................................................. 12\n\nHardening.................................................................................................................................. 13\n\nDetection...................................................................................................................................20\n\n**Microsoft 365 Attack Mitigation....................................................................................................... 21**\n\n**Attack Technique: Modify Trusted Domains....................................................................................22**\n\nAzure AD Federated Domains Overview.....................................................................................22\n\nTechnique..................................................................................................................................22\n\nDetection...................................................................................................................................22\n\nRemediation..............................................................................................................................25\n\n**Attack Technique: Abuse Azure AD Privileged Roles.......................................................................26**\n\nAzure Active Directory Privileged Roles Overview......................................................................26\n\nTechnique..................................................................................................................................26\n\nRemediation..............................................................................................................................26\n\n**Attack Technique: Hijack Azure AD Applications.............................................................................28**\n\nAzure Applications and Service Principals Overview..................................................................28\n\nTechnique..................................................................................................................................29\n\nDetection...................................................................................................................................29\n\nRemediation.............................................................................................................................. 31\n\n\n-----\n\n**Attack Technique: Modify Mailbox Folder Permissions....................................................................33**\n\nMailbox Folder Permission Overview..........................................................................................33\n\nTechnique..................................................................................................................................34\n\nRemediation..............................................................................................................................34\n\nDetection...................................................................................................................................36\n\n**Attack Technique: Application Impersonation................................................................................38**\n\nTechnique..................................................................................................................................38\n\nRemediation..............................................................................................................................39\n\nDetection...................................................................................................................................39\n\n**Attack Technique: Leverage Administrative Access of Service Providers..................................... 41**\n\nDelegated Administration Overview........................................................................................... 41\n\nTechnique.................................................................................................................................. 41\n\nDetection................................................................................................................................... 41\n\nRemediation..............................................................................................................................42\n\n**Attack Technique: Disable Advanced Audit.....................................................................................43**\n\nLicensing Overview....................................................................................................................43\n\nTechnique..................................................................................................................................43\n\nDetection...................................................................................................................................43\n\nRemediation..............................................................................................................................44\n\n**Microsoft 365 Hardening..................................................................................................................45**\n\n**Conclusion........................................................................................................................................52**\n\n\n-----\n\n## Overview\n\n#### Background\n\nIn December 2020, Mandiant uncovered and publicly disclosed a widespread campaign conducted\nby the threat group we track as UNC2452. In some, but not all, of the intrusions associated with\nthis campaign where Mandiant has visibility, the attacker used their access to on-premises\nnetworks to gain unauthorized access to the victim’s Microsoft 365 environment.\n\nIn April 2022, Mandiant announced that UNC2452 had been merged into APT29. This conclusion\n[matches attribution statements previously made by the U.S. Government that the SolarWinds](https://www.whitehouse.gov/briefing-room/statements-releases/2021/04/15/fact-sheet-imposing-costs-for-harmful-foreign-activities-by-the-russian-government/)\nsupply chain compromise was conducted by APT29, a Russia-based espionage group assessed\nto be sponsored by the Russian Foreign Intelligence Service (SVR)\n\n#### Goals and Objectives\n\n[APT29 and other threat actors have used several methodologies to move laterally from on-](https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html)\npremises networks to the cloud, specifically Microsoft 365. This paper will help organizations\n[understand these techniques used by APT29, how to proactively harden their environments,](https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html)\nand how to remediate environments where similar techniques have been observed.\n\nIt is important to note that there is no formal security boundary between on-premises networks\nand cloud services provided by Microsoft 365. If an organization discovers evidence of targeted\nthreat actor activity in their on-premises network, a thorough review of the cloud environment\nis often necessary as well.\n\n[Organizations can use the Azure AD Investigator auditing script, available from the Mandiant](https://github.com/mandiant/Mandiant-Azure-AD-Investigator)\nGitHub repository, to check their Microsoft 365 tenants for indicators relative to the techniques\ndetailed throughout this paper. The script will alert administrators and security practitioners to\nartifacts that may require further review to determine if they are truly malicious or part of\nlegitimate activity.\n\n\n-----\n\n## Attacker Tactics, Techniques\n and Procedures (TTPs)\n\nMandiant has observed APT29 and other threat actors moving laterally to the Microsoft 365\nenvironment, accessing M365 data and staying hidden using a variety of techniques:\n\n1. Steal the Active Directory Federation Services (AD FS) token-signing certificate and use it\n\n[to forge tokens for arbitrary users (sometimes described as Golden SAML). This would allow](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)\nthe attacker to authenticate into a federated resource provider (such as Microsoft 365) as\nany user, without the need for that user’s password or their corresponding multi-factor\nauthentication (MFA) mechanism.\n\n2. Modify or add trusted domains in Azure AD to add a new federated Identity provider (IdP) that\n\nthe attacker controls. This would allow the attacker to forge tokens for arbitrary users and\n[has been described as an Azure AD](https://o365blog.com/post/aadbackdoor/) [backdoor.](https://www.fireeye.com/blog/threat-research/2020/09/detecting-microsoft-365-azure-active-directory-backdoors.html)\n\n3. Compromise the credentials of on-premises user accounts that are synchronized to\n\nMicrosoft 365 and are assigned high privileged directory roles, such as Global Administrator\nor Application Administrator.\n\n4. Hijack an existing Microsoft 365 application by adding a rogue credential to it in order to use\n\nthe legitimate permissions assigned to the application, such as the ability to read email,\nsend email as an arbitrary user, access user calendars, etc., while bypassing MFA.\n\n5. Modify the permissions of folders in a victim mailbox (such as the inbox) to make its contents\n\nreadable by any other user in the victim’s Microsoft 365 environment.\n\n6. Use EWS Impersonation to impersonate any mailbox owner in the Microsoft 365 tenant and\n\nbulk collect mail items.\n\n7. Target and compromise Cloud Service Providers (CSPs) that have permissions to administer\n\ncustomer tenants of organizations that APT29 is targeting, and abuse the access granted to\nthe CSP to perform post-compromise activities against the target organization.\n\n8. Disable the Microsoft 365 Advanced Auditing (now called Purview Audit) license on targeted\n\naccounts to blind security monitoring tools.\n\n\n-----\n\n## Remediation Strategy\n\nDeveloping a successful strategy to eradicate APT29 access to a\nvictim’s environment is contingent upon many factors, so each\norganization must develop their own unique plan. Two of the\nmost important factors are the actions taken by the attacker and\nthe specifics of the victim’s environment.\n\n\nTo help victims plan their own strategy, Table 1 provides a\nhigh-level overview of techniques related to Microsoft 365 with\nlinks to corresponding remediation and hardening steps.\n\n|TABLE 1. Overview of covered T|TTPs.|Col3|Col4|\n|---|---|---|---|\n|Technique|MITRE ATT&CK|Remediation|Hardening|\n|Attack Technique: Golden SAML Attack|TA0006 T1552 T1552.004 T1199|Step 1: Issue new AD FS Certificates Step 2: Revoke Microsoft 365 Refresh Tokens|Step 1: AD FS Service Account – Best Practices Step 2: AD FS Logging and Auditing Step 3: AD FS Servers - Account Access Restrictions and Inbound Connectivity Hardening|\n|Attack Technique: Modify Trusted Domains|T1550|Step 1: Review Configured Domains and Trusts Within Microsoft 365 and Remove Untrusted Domains|Step 1: Filter accounts synced to Azure Active Directory Step 2: Limit Privileged Users to Trusted IPs Step 3: Enhance Mailbox Auditing Step 4: Review Azure Application and Service Principal Permissions Step 5: Enforce multi-factor authentication (MFA) for Accounts Step 6: Review all registered MFA devices Step 7: Review Partner (Cloud Service Provider) Relationships|\n|Attack Technique: Abuse Azure AD Privileged Roles|TA0006 T1552|Step 1: Review and Configure Cloud-Only Accounts for Privileged Role Holders Step 2: Rotate All Passwords for Cloud-Only Accounts Step 3: Invalidate Refresh Tokens for Each Cloud-Only Account||\n|Attack Technique: Hijack Azure AD Applications|T1114 T1114.002 T1098.001|Step 1: Review and Remediate Keys Associated with Service Principals and Applications Step 2: Invalidate All Existing Refresh Tokens||\n|Attack Technique: Modify Mailbox Folder Permissions|T1114 T1114.002 T1098|Step 1: Review and remediate Mailbox Folder Permissions where read privileges have been granted to Anonymous or Default User|Step 1: Review overly permissive mailbox Folder Permissions Step 2: Enable mailbox audit logging action: Update Folder Permissions|\n|Attack Technique: Application Impersonation|T1114 T1114.002|Step 1: Remove Application Impersonation role assignments|Step 1: Audit accounts and groups with ApplicationImpersonation role Step 2: Remove the role where applicable Step 3: Apply a scope to limit the accounts the role can be used to impersonate. Step 4: Add conditional access to restrict logons for accounts holding the role|\n|Attack Technique: Leverage Administrative Access of Service Providers|T1199|Step 1: Review and remove CSP relationship where applicable|Step 1: Review roles granted to CSPs Step 2: Remove or limit the scope of the granted permissions|\n|Attack Technique: Modify User Licenses|T1562|Step 1: Review and re-add Advanced Audit license where they have been removed|Step 1: Limit users with privileged roles|\n\n\n**TABLE 1. Overview of covered TTPs.**\n\n\n-----\n\n#### Remediation Sequencing\n\nTiming and sequencing are critical for the successful execution\nof a remediation plan, especially if an attacker remains active\nduring the containment and eradication timeframes. To\nmaximize the probability of fully eradicating this threat actor\nfrom hybrid Microsoft 365 environments, Mandiant recommends\nsequencing the remediation plan to:\n\n- First, regain control of the on-premises environment. This\n\nenvironment houses and protects the various secrets that\nattackers often abuse to gain initial access and attack cloud\nenvironments.\n\n- Next, rotate secrets and credentials to regain control of the\n\nMicrosoft 365 environment and fully eradicate all attacker\naccess.\n\nTo accomplish these two goals, consider executing a plan similar\nto the following, in order of operation. For actions directly\nrelated to the attacker techniques discussed in this white paper,\nwe included internal jump links to more detailed instructions.\nFor remaining actions, we have linked to public sources where\nappropriate:\n\n1. Implement short term hardening measures to mitigate risk of\n\nsimilar attacks\n\n2. Eliminate any attacker remote access to the\n\non-premises environment, which could include:\n\na. Implementing network blocks and DNS sinkholes\n\nb. Removing remote access backdoors, including impacted\n\nSolarWinds software\n\nc. Un-enrolling attacker multi-factor authentication (MFA)\n\ntokens\n\nd. Rotating secrets associated with remote access MFA\n\ntoken generation\n\n\n3. Rotate impacted on-premises credentials,\n\nwhich could include:\n\na. [Rotating the Kerberos ticket granting ticket account](https://github.com/microsoft/New-KrbtgtKeys.ps1)\n\n[(krbtgt) credentials (twice)](https://github.com/microsoft/New-KrbtgtKeys.ps1)\n\nb. Rotating credentials for “Tier-0” accounts in Active\n\nDirectory\n\nc. Rotating credentials and/or disabling compromised\n\naccounts\n\nd. Rotating credentials for other Active Directory accounts\n\ne. Rotating credentials for local administrator accounts\n\nf. Rotating credentials for cloud connector accounts\n\ni. [On-premises Azure AD DS connector account](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sync-change-addsacct-pass)\n\nii. [Azure AD connector account](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-azureadaccount)\n\niii. [On-premises ADSync Service Account (that runs AD](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sync-change-serviceacct-pass)\n\n[Connect services on servers)](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sync-change-serviceacct-pass)\n\niv. If Azure seamless single sign-on is utilized, rotate the\n\n[decryption key for the on-premises AZUREADSSOACC](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso-faq)\n[computer account](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso-faq)\n\ng. Rotating other internal credentials or secrets\n\n4. Rotate the AD FS token-signing and token-decrypting\n\ncertificates used with SAML tokens (twice)\n\n5. Rotate credentials for impacted cloud accounts\n\n6. Remove attacker created identity providers and custom\n\ndomains\n\n7. Remove attacker certificates and passwords from\n\napplications and service principals\n\n8. Revoke all existing refresh tokens for Microsoft 365\n\nNote: this will force all users to re-enter their credentials to\nutilize Microsoft 365 services through clients such as Outlook\nand Teams.\n\n9. Review and Remediate Mailbox Folder Permissions\n\n10. Review ApplicationImpersonation role holders\n\n\n-----\n\n# AD FS Attack Mitigation\n\n\n-----\n\n## Attack Technique: Golden SAML Attack\n\n#### Active Directory Federation Service Overview\n\n\nActive Directory Federation Services (AD FS) provides an\non-premises authentication workflow for cloud-based\nresources. While other authentication workflows also exist, AD\nFS is a popular option for enterprises that want to maintain\ncontrol of their own authentication. In this workflow, AD FS is an\nIdentity Provider (IdP) because it facilitates user identity\ninformation to cloud-based resources and applications.\n\nMicrosoft AD FS uses a “claim-based” identity model to identify\nroles, permissions, or groups associated with a user\nauthentication. A claim can be any piece of information about\nthe requesting user’s identity, such as a group they belong to, or\nwhether an MFA authentication was performed during login. For\nexample, if MFA occurred during the AD FS login, then the claim\nshown in Figure 1 would be provided by AD FS.\n\nMultiple claims associated with the authentication are packaged\ninto an XML document, known as a SAML token, and digitally\nsigned to ensure verifiability and to prevent unauthorized\nmodification. When Microsoft 365 receives a SAML token issued\nby an AD FS service, it performs the following steps to ensure its\nvalidity before providing access to the resource (listed in no\nparticular order):\n\n- Verify that the digital signature of the SAML token is valid and\n\nuses a known keypair\n\n- Verify the SAML token is constructed properly and complies\n\nwith the standard\n\n- Verify that the SAML token has not expired\n\n- Verify that the token was issued by a source that Microsoft 365\n\nexpects (the issuer)\n\n- Verify that the unique identifier for the user (the ImmutableID)\n\nmatches a user in Azure AD\n\n- Evaluate conditional access policies, if any\n\n\nIn this authentication scheme, two vital pieces of data are the\ndigital signature and the ImmutableID. The ImmutableID is a\nglobally unique identifier (GUID) associated with a user and\nstored in Azure Active Directory (Azure AD). A copy of this GUID\nis also stored in the on-premises Active Directory as the\n[ms-DS-ConsistencyGuid attribute of the User object.](https://docs.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-consistencyguid)\nThis attribute is viewable by any authenticated user in both\nAzure AD and on premises AD.\n\nThe foundation of the security of AD FS is the confidentiality of\nthe token-signing certificate, which is used to digitally sign\nSAML tokens issued by the AD FS service. Exposure of the\ntoken-signing certificate and private key, paired with any\ncompromised AD account (to query users’ ImmutableIDs), would\nallow an attacker to issue their own forged but verifiable SAML\ntokens. Taking it a step further, a one-time extraction of all\nImmutableIDs and the token-signing certificate with private key\nwould allow the attacker to issue SAML tokens for any user in the\norganization regardless of their password and any password\nresets that occur afterwards. The attacker can insert any claim\nthey want into the SAML token. This could include the claim\ndetailed in Figure 1, which states that the user performed MFA at\nthe AD FS service. This forged SAML token will bypass MFA\nrequirements imposed by the cloud application.\n\nThe locations of the token-signing certificate and private key\ndepend on how an organization has chosen to implement AD FS.\nOn-premises AD FS infrastructure can consist of either a single\nor multiple AD FS servers, a database instance, and either single\nor multiple AD FS web application proxy server(s) housed in a\nDMZ (Figure 2). Most organizations will likely leverage an AD FS\nserver farm, using a local Windows Internal Database (WID).\n\n```\n<saml:AttributeValue>http://schemas.microsoft.com/claims/multipleauthn</saml:AttributeValue>\n\n```\n\n**FIGURE 1. Example SAML claim for Microsoft 365.**\n\n\n-----\n\n|N|LB|\n|---|---|\n\n|N|LB|\n|---|---|\n\n\nFirewall\n\n\nActive\nDirectory\n\n##### INTRANET\n\n\nFirewall\n\nWeb Application\nAD FS Proxy\n\n##### DMZ\n\n\n**[FIGURE 2. https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/best-practices-securing-ad-fs](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/best-practices-securing-ad-fs)**\n\n\nIn the default installation of AD FS, the token-signing certificate\nis automatically generated and valid for one year. The AD FS\nservice will handle the certificate rollover process. The following\npoints detail how the token-signing certificate is stored on the\nAD FS server:\n\n- The token-signing certificate is stored as a base64 encoded\n\nencrypted blob within the database used by the AD FS servers.\n\n- The token-signing certificate is protected using a Windows\n\ntechnology called Distributed Key Manager (DKM). AD FS\nuses a key derivation function to derive an AES key that\nis used to decrypt the token-signing certificate stored in\n\n**FIGURE 3. Active Directory - AD FS Container Attributes.**\n\n\nthe AD FS database. This data is stored within an Active\nDirectory attribute CN=ADFS,CN=Microsoft,CN=Program\nData,DC=<domain>,DC=<suffix>. In addition to obtaining\nthe token-signing certificate, an attacker would also need\nto obtain the value from Active Directory for decrypting\nthe token-signing certificate. By default, this value is\nonly readable by the AD FS service account and Domain\nAdministrators (Figure 3).\n\n**Note: If multiple AD FS certificate containers are present in Active**\nDirectory, from an AD FS server, the PowerShell command (GetAdfsProperties).CertificateSharingContainer can be used to identify\nthe container that will be used by DKM.\n\n\n-----\n\nThe AD FS service also makes use of other certificates that are\nout of scope for this whitepaper. For example, each cloud\napplication can define a token-decrypting certificate, which is\nused to encrypt the SAML token as it is transmitted to the cloud\nresource. This option is not widely used.\n\n**Note: If an AD FS server farm model is leveraged, the same token-**\nsigning and decryption certificates are used by all the AD FS servers.\n\nThe default configuration for AD FS uses a built-in MSSQL\ndatabase service called Windows Internal Database (WID). The\nWID service is only accessible from the local host via a specific\nnamed pipe and does not listen on the standard TCP port 1433.\n\nThe WID service stores the backing files for the AD FS database\nin the following locations:\n\n- C:\\Windows\\WID\\Data\\AdfsConfiguration.mdf\n\n- C:\\Windows\\WID\\Data\\AdfsConfiguration_log.ldf\n\nA default configuration of AD FS using the WID service will\ngenerate a database table named IdentityServerPolicy.\n```\nServiceSettings to store the token-signing certificate.\n\n```\n\n#### Technique\n\nOnce APT29 had gained on-premises access to an organization’s\nenvironment, Mandiant observed them targeting on-premises\nAD FS servers with the goal of obtaining the token-signing\ncertificate to forge SAML tokens. There are two steps an\nattacker must take to obtain the token-signing certificate and\nprivate key.\n\nFirst, the attacker must obtain the encrypted token-signing\ncertificate. The threat actor has used a number of techniques to\nextract the encrypted blob from the IdentityServerPolicy.\n```\nServiceSettings table. Mandiant has observed techniques\n\n```\nincluding:\n\n- Stealing the backup files for the database: Connecting\n\nto the server via SMB and copying the database file\n```\n AdfsConfiguration.mdf off the server\n\n```\n- Querying the database via PowerShell: Connecting to the\n\nserver to execute PowerShell that then connects to and\nqueries the WID service for the table rows.\n\n– SELECT ServiceSettingsData from\n```\n  IdentityServerPolicy.ServiceSettings\n\n```\n- Querying the database via custom executable:\n\nWriting a custom executable to disk and executing it.\nThe executable queried the WID for the table row and wrote\nthe output to disk.\n\nNext, the attacker must obtain the secret DKM value from Active\nDirectory to decrypt the token-signing certificate. Mandiant has\nobserved the threat actor using open-source tools such as\nADFind to query Active Directory for the DKM value used to\ndecrypt the encrypted token-signing certificate. Figure 4 details\nan ADFind query used by APT29 to obtain this value.\n\nWith the certificate and DKM value, the attacker now has the\ndata they need to forge SAML tokens and access\ncloud-based resources, while bypassing MFA requirements and\nthe need to know a user’s password (GoldenSAML).\n\n```\nC:\\Windows\\system32\\cmd.exe /C c:\\windows\\temp\\srv.exe -h -sc fo:* -b “CN=ADFS,CN=Microsoft,CN=Program\nData,DC=acme,DC=com”\n\n```\n\n**FIGURE 4. ADFind command to query the secret DKM value.**\n\n\n-----\n\n#### Remediation\n\nIf an attacker is able to connect to an on-premises AD FS server\nand has credentials for either the service account that runs the\nAD FS service or an account that has local administrative\npermissions on AD FS servers, this provides the threat actor\nwith the access needed to extract the token-signing certificate.\n\nIf an organization suspects an attacker has accessed their AD FS\ntoken-signing certificate, two critical steps are required to\nremediate and protect against a GoldenSAML attack.\n\n1. Issue new certificates on the AD FS server(s) and synchronize\n\nthem to Azure AD (and any other cloud applications that use\nAD FS for authentication).\n\n  - Rotate the token-signing AD FS certificate in rapid\n\nsuccession twice.\n\n  - By default, if the certificate is only rotated once, a copy\n\nof the previous (potentially compromised) certificate will\nstill be resident in Azure AD, and can still be used to forge\nSAML tokens. To fully ensure that only new and trusted\ncertificates are available, a “double-tap” is required.\n\n\n2. Immediately revoke all existing refresh tokens for the\n\nMicrosoft 365 tenant.\n\n**Step 1: Issue new AD FS Certificates**\n\n**Note: The certificate rollover will temporarily impact single sign-on**\ncommunications with applications that use AD FS as an IdP.\n\nTo view the properties related to the AD FS certificates,\nreference the PowerShell commands noted in Figure 5.\n\nTo rotate the AD FS token-signing and token-decrypting\ncertificates using PowerShell, the commands noted in Figure 6\ncan be utilized. The commands must be run from the primary AD\nFS server (if an AD FS server farm is utilized).\n\n```\nGet-ADFSCertificate -CertificateType Token-Signing\nGet-ADFSCertificate -CertificateType Token-Decrypting\n\n```\n\n**FIGURE 5. Command to review the properties of AD FS certificates.**\n\n```\n** 1st Iteration **\nSet-ADFSProperties -AutoCertificateRollover $true\nUpdate-AdfsCertificate -CertificateType Token-Decrypting -Urgent\nUpdate-AdfsCertificate -CertificateType Token-Signing -Urgent\nSet-ADFSProperties -AutoCertificateRollover $false\nConnect-MsolService\nGet-MsolFederationProperty -DomainName <domain>\nUpdate-MsolFederatedDomain -DomainName <domain>\nGet-MsolFederationProperty -DomainName <domain>\n** 2nd Iteration **\nSet-ADFSProperties -AutoCertificateRollover $true\nUpdate-AdfsCertificate -CertificateType token-signing\nUpdate-AdfsCertificate -CertificateType token-decrypting\nSet-ADFSProperties -AutoCertificateRollover $false\nConnect-MsolService\nGet-MsolFederationProperty -DomainName <domain>\nUpdate-MsolFederatedDomain -DomainName <domain>\nGet-MsolFederationProperty -DomainName <domain>\n\n```\n\n-----\n\nOnce completed, ensure that the output from the Get -MsolFederationProperty -DomainName command only includes the certificate\nthumbprints and validity dates that match the recently rotated certificates, and that the certificate thumbprint from the previously\n(potentially compromised) certificates are not present in Azure AD.\n\nIf an organization maintains backup copies of the token-signing and token-decrypting certificates, the certificate backups should not\nbe stored on the local AD FS servers and should be secured and password-protected using a separate enterprise vaulting / backupstorage technology (preferably offline storage).\n\n**Step 2: Revoke Microsoft 365 Refresh Tokens**\n\nAfter rotating the AD FS certificates, organizations should immediately revoke all existing refresh tokens for their Microsoft 365 tenant.\nWhile this will result in users being required to reauthenticate, this is a prudent step to ensure that all logged in users authenticate to\nMicrosoft 365 using the new and trusted SAML tokens. Using an account that has Microsoft 365 Global Administrator permissions, the\ncommands noted in Figure 7 can be used to invalidate existing refresh tokens.\n\n```\nConnect-AzureAD\nGet-AzureADuser -all $true | Revoke-AzureADUserAllRefreshToken\n\n```\n\n**FIGURE 7. PowerShell commands to connect to Azure AD and revoke existing refresh tokens.**\n\n#### Hardening\n\n\nProactive hardening steps can be leveraged to secure onpremises AD FS infrastructure. While the scope of generalized\non-premises hardening workstreams can be cumbersome and\noften represent multiple layers of defenses, the most prudent\nsteps related to AD FS hardening and mitigating the previously\nnoted attacker techniques are noted below.\n\n- Step 1: Configure a Group Managed Service Account (gMSA) for\n\nAD FS services\n\n– Alternatively, configure a dedicated on-premises account\n\nthat is only leveraged as an AD FS service account and has\nrestricted access rights\n\n- Step 2: Review AD FS Logging and Auditing Settings\n\n- Step 3: Review Account and Network Access Restrictions for\n\nAD FS Servers\n\n**Step 1: AD FS Service Account – Best Practices**\n\nSince AD FS v3.0 (Windows Server 2012 R2+), a group managed\nservice account (gMSA) can be configured for running AD FS\nservices. The benefits of leveraging a gMSA include a complex\n(120 character) password that is automatically managed and\nrotated on a pre-defined frequency (30 days by default). For\n[additional information, reference https://docs.microsoft.com/](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/configure-a-federation-server)\n[en-us/windows-server/identity/ad-fs/deployment/configure-a-](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/configure-a-federation-server)\n[federation-server.](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/configure-a-federation-server)\n\n\nIf a gMSA cannot be leveraged, a dedicated (non-privileged)\nservice account should be created in Active Directory for\nrunning AD FS services. This account should not be used on any\nadditional systems or services. Additionally, the account should\nbe configured with a strong (> 25 character) password and\nrotated on a periodic basis. For additional information, reference\n[https://docs.microsoft.com/en-us/windows-server/identity/](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/manually-configure-a-service-account-for-a-federation-server-farm)\n[ad-fs/deployment/manually-configure-a-service-account-for-](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/manually-configure-a-service-account-for-a-federation-server-farm)\n[a-federation-server-farm.](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/manually-configure-a-service-account-for-a-federation-server-farm)\n\n**Note: If an organization needs to change the existing AD FS service**\naccount to leverage a gMSA (rather than a static service account), this\nprocess can be complex and may require assistance from Microsoft\nsupport. For specific information related to this process, reference:\n\n[• https://gallery.technet.microsoft.com/scriptcenter/Active-](https://gallery.technet.microsoft.com/scriptcenter/Active-Directory-ddb67df0)\n\n[Directory-ddb67df0](https://gallery.technet.microsoft.com/scriptcenter/Active-Directory-ddb67df0)\n\n[• https://social.technet.microsoft.com/Forums/](https://social.technet.microsoft.com/Forums/windowsserver/en-US/8f558762-f92c-4803-916c-cc36ecc7c988/adfs-2016-change-service-account-to-gmsa?forum=ADFS#75f9b050-ad0b-461a-92a4-796180d6c6d2)\n\n[windowsserver/en-US/8f558762-f92c-4803-916c-](https://social.technet.microsoft.com/Forums/windowsserver/en-US/8f558762-f92c-4803-916c-cc36ecc7c988/adfs-2016-change-service-account-to-gmsa?forum=ADFS#75f9b050-ad0b-461a-92a4-796180d6c6d2)\n[cc36ecc7c988/adfs-2016-change-service-account-](https://social.technet.microsoft.com/Forums/windowsserver/en-US/8f558762-f92c-4803-916c-cc36ecc7c988/adfs-2016-change-service-account-to-gmsa?forum=ADFS#75f9b050-ad0b-461a-92a4-796180d6c6d2)\n[to-gmsa?forum=ADFS#75f9b050-ad0b-461a-92a4-](https://social.technet.microsoft.com/Forums/windowsserver/en-US/8f558762-f92c-4803-916c-cc36ecc7c988/adfs-2016-change-service-account-to-gmsa?forum=ADFS#75f9b050-ad0b-461a-92a4-796180d6c6d2)\n[796180d6c6d2](https://social.technet.microsoft.com/Forums/windowsserver/en-US/8f558762-f92c-4803-916c-cc36ecc7c988/adfs-2016-change-service-account-to-gmsa?forum=ADFS#75f9b050-ad0b-461a-92a4-796180d6c6d2)\n\n[• https://github.com/Microsoft/adfsToolbox/tree/master/](https://github.com/Microsoft/adfsToolbox/tree/master/serviceAccountModule)\n\n[serviceAccountModule](https://github.com/Microsoft/adfsToolbox/tree/master/serviceAccountModule)\n\n\n-----\n\n**Step 2: AD FS Logging and Auditing**\n\nAD FS utilizes two primary event logs on servers that run AD FS\nservices: Admin log and Tracing/Debug log.\n\nWith the default settings, the AD FS service registers its own\nWindows event log group called “AD FS”. The “Admin” event log in\nthis group records high-level events related to the AD FS service\nstatus, service requests and overall service health. If debug\nlogging is enabled, an additional Windows event log group called\n“AD FS Tracing” will be present—housing the “Debug” event log.\n\n**Note: Mandiant does not recommend enabling debug logging unless**\nthere is a specific need to perform troubleshooting for AD FS services.\nEnabling debug logging will generate a large volume of events in a short\ntimeframe, and can greatly impact operational performance of the AD\nFS server(s).\n\nOrganizations can verify their current AD FS audit level by using\nthe Get-AdfsProperties PowerShell cmdlet. AD FS logging\nlevels can be configured and adjusted using the\n```\nSet-AdfsProperties PowerShell cmdlet.\n\n```\n**Note: For an AD FS server farm, any changes to AD FS audit levels will**\nneed to be configured on each server within the farm.\n\nFor AD FS services running on Windows Server 2012 R2, there\nare six configurable audit levels:\n\n- Errors\n\n- FailureAudits\n\n- SuccessAudits\n\n- Information\n\n- Verbose\n\n- Warnings\n\nMandiant’s recommended settings for configuring the audit level **FIGURE 8. AD FS audit logs.**\n\n\n-----\n\nfor AD FS services running on Windows Server 2012 R2 are\nshown in Figure 9.\n\nFor AD FS services running on Windows Server 2016+, there are\nthree configurable audit levels:\n\n- Basic (default): no more than 5 events will be logged for a\n\nsingle request\n\n- Verbose: all events will be logged\n\n- None: auditing is disabled (not recommended)\n\nMandiant’s recommended settings for configuring the audit level\nfor AD FS services running on Windows Server 2016+ is shown in\nFigure 10.\n\n**Note: While Mandiant’s recommendation of including Verbose auditing**\nwill provide the most information related to AD FS events, this setting\nwill likely cause event logs to rotate faster and should be utilized in\nconjunction with event log forwarding to a SIEM.\n\n**Enable AD FS Security and Service Account Auditing**\n\n\nIn addition to audit levels, Mandiant recommends enabling\nsecurity auditing in AD FS. Security auditing provides visibility to\nauthentication events performed through the AD FS service,\nincluding issued claims, security token validation failures, IP\naddresses for requests and user agent information. By default,\nboth “Success audits” and “Failure audits” are not enabled, which\ncan severely affect monitoring and investigative efforts.\n\nTo enable security auditing for AD FS events, implement the\nfollowing steps:\n\n1. On each AD FS server - Navigate to Local Security Policy >\n\nSecurity Settings > Local Policies > User Rights Assignment >\nGenerate security audits (Figure 11).\n\n  - Local Security Setting tab > verify that the AD FS service\n\naccount is listed. If not listed, add the account.\n\n```\nSet-AdfsProperties -LogLevel\n\nErrors,FailureAudits,Information,Verbose,SuccessAudits,Warnings\n\n```\n\n**FIGURE 9. Recommended AD FS audit level for AD FS services on Windows Server 2012R2.**\n\n```\nSet-AdfsProperties -AuditLevel Verbose\n\n```\n\n**FIGURE 10. Recommended AD FS audit level for AD FS services on Windows Server 2016+.**\n\n**FIGURE 11. Local Security Policy - Generate Security Audits configuration.**\n\n\n-----\n\n2. To record audits generated by the AD FS service within the Security event log, on each AD FS server - Navigate to Local Security\n\nPolicy > Security Settings > Advanced Audit Policy Configuration > System Audit Policies > Object Access\n\n  - Audit Application Generated tab > Select both “Success” and “Failure” (Figure 12).\n\n  - This can also be accomplished using an elevated command prompt, and running the command noted in Figure 13.\n\n**FIGURE 12. Local Security Policy – Audit Application Generated configuration.**\n\n```\nauditpol.exe /set /subcategory:”Application Generated” /failure:enable /success:enable\n\n```\n\n**FIGURE 13. Command to enable AD FS service account auditing.**\n\n3. For the AD FS Server Farm – navigate to Start > Programs >\n\nAdministrative Tools, > AD FS Management\n\n  - Actions pane > Edit Federation Service Properties\n\n  - Federation Service Properties > Events tab\n\n  - Select Success Audits and Failure Audits\n\n(Figure 14)\n\n  - Note: Enabling AD FS service auditing can increase\n\nthe volume of events logged on AD FS servers. It is\nrecommended that events captured within event\nlogs on AD FS servers be forwarded to a SIEM, for enhanced\ncorrelation and offline storage for historical review\npurposes.\n\n  - Once AD FS auditing is configured, any successful changes\n\nto the AD FS service configuration will result in Event ID\n307 (ConfigurationChangeSuccessAudit) or Event ID 309\n(WmiConfigurationChangeSuccessAudit) being recorded\nwithin the Security event log on the AD FS server(s). For\ncorrelation, Event ID 510 will contain additional information\nrelated to the configuration changes that were enforced\n(Figure 15).\n\n\n**FIGURE 14. Federation Service Properties - Recommended Auditing Actions**\n(per AD FS Farm).\n\n\n-----\n\n**FIGURE 15. Event IDs related to AD FS configuration setting modifications.**\n\nFor additional information related to AD FS logging and auditing—in addition to specific Event IDs (per Operating System platform) which\n[can be leveraged for troubleshooting and investigative purposes, reference: https://adfshelp.microsoft.com/AdfsEventViewer/](https://adfshelp.microsoft.com/AdfsEventViewer/GetAdfsEventList)\n[GetAdfsEventList](https://adfshelp.microsoft.com/AdfsEventViewer/GetAdfsEventList)\n\n**Enable Domain Auditing for AD FS Distributed Key Manager Access Requests**\n\nThe DKM secret value is required to decrypt the AD FS token-signing certificate and is stored in Active Directory. The Active Directory\ncontainer should only be accessed periodically by the AD FS service account and AD FS service process. To detect anomalous access\nrequests targeting the AD FS Distributed Key Manager (DKM) container in Active Directory, the following monitoring should be configured.\n\n- On Domain Controllers, ensure that the “Audit Directory Service Access” subcategory (within the “DS Access” category) is\n\nconfigured for auditing. This configuration can be enforced using settings defined within a Group Policy Object (GPO) linked to Domain\nControllers (Figure 16).\n\n- Ensure that auditing for “Read All Properties” is configured for the CN=ADFS,CN=Microsoft,CN=Program Data,DC=<domain>,\n```\n DC=<suffix> parent (and child) containers in Active Directory. This can be accomplished using ADSIEdit (Figure 17).\n\n```\n**FIGURE 16. GPO configuration example for enforcing “Directory Service Access” auditing for Domain Controllers.**\n\n**FIGURE 17. Configuring auditing for the ADFS container using ADSIEdit.**\n\n\n-----\n\nWithin Security event logs on Domain Controllers, monitor for Event ID 4662 containing {8d3bca50-1d7e-11d0-a081-00aa006c33ed} in\nthe Properties field of the event:\n\n- ObjectName contains the GUIDs of the AD FS DKM Containers for the token-signing and token-decrypting certificates (can be found\n\nusing ADSIEdit and navigating to CN=ADFS,CN=Microsoft,CN=Program Data,DC=<domain>,DC=<suffix>)\n\n- ObjectName contains the path of CN=CryptoPolicy,CN=ADFS,CN=Microsoft,CN=Program Data,DC=<domain>,DC=<suffix>\n\n- Properties contains the thumbnailPhoto Attribute GUID ({8d3bca50-1d7e-11d0-a081-00aa006c33ed}) which stores\n\nthe DKM Master Key\n\nUsing a privileged account that is granted access to the certificate sharing container, the PowerShell command in Figure 18 can be used\nto test the detection.\n\n```\n(Get-ADObject -filter ‘ObjectClass -eq “Contact” -and name -ne “CryptoPolicy”’ -SearchBase\n“CN=ADFS,CN=Microsoft,CN=Program Data,DC=<domain>,DC=<suffix>” -Properties thumbnailPhoto).\nthumbnailPhoto\n\n```\n\n**FIGURE 18. Command to generate a read event of token-signing certificate attribute.**\n\n**FIGURE 19. Example Event ID 4662 - recorded when accessing the DKM container in AD using PowerShell.**\n\n**Note: When an AD FS server is rebooted or the AD FS service is restarted, the service account legitimately running AD FS services will access the**\ncontainers in Active Directory for certificate decryption using DKM. To further enhance monitoring and reduce false positives, additional correlation on\nAD FS servers related to the detections noted above can be leveraged, including:\n\n- System Event Log - Event ID 7036\n\n- System Event Log – Event ID 1074\n\n**FIGURE 20. System Event Log - Event ID 7036.**\n\n\n-----\n\n**FIGURE 21. System Event Log - Event ID 1074.**\n\n**Step 3: AD FS Servers - Account Access Restrictions and**\n**Inbound Connectivity Hardening**\n\nOn-premises AD FS servers should be considered Tier 0 assets.\nMandiant recommends restricting access to the AD FS servers\nto an even smaller subset of unique accounts than the typical\n“Domain Administrators” group. Furthermore, Mandiant\nrecommends that the accounts in this subset are explicitly\nprevented (via Group Policy) from authenticating to Tier 1 and\nTier 2 assets, to prevent their credentials from being potentially\nrecoverable on less secure systems. Particular attention should\nalso be paid to the local administrator account on the AD FS\nsystem, ensuring that its password is strong and unique.\n\n### AD FS Required Ports and Protocols\n\n\nIn addition to authentication considerations, inbound access to\nAD FS servers should be restricted to the following small subset of\nports / protocols required for inbound connectivity (Figure 22).\n\n- TCP/80 (HTTP)\n\n- TCP/443 (HTTPs)\n\n- TCP/5985 (WinRM)\n\n- TCP/808 (Windows Server 2012 R2) or\n\nTCP/1501 (Windows Server 2016+)\n\n\nProtocol Port (TCP/UDP) Description\n\nHTTP 80 (TCP/UDP) Used to synchronize\nwith Azure AD\n\nHTTPS 443 (TCP/UDP) Used to synchronize\nwith Azure AD\n\nConfigure, Sync Sync\n\nOn-premise Azure AD\nActive Directory Connect Server\n\nTCP/80\nTCP/443\nTCP/5985\n\n\n**Port 808 (Windows Server**\n2012R2) or\n**Port 1501 (Windows Server**\n2016+) is the Net.TCP port\nAD FS uses for the local\nWCF endpoint to transfer\nconfiguration data to the\nservice process and\nPowershell\n\n\nAD FS HTTPS 443 (TCP/UDP) Used for authentication Web\nApplication\nProxy\n\n\nSign-on\n\n\nProtocol Port (TCP/UDP) Description\n\n\nProtocol Port (TCP/UDP) Description\n\n\nDevices\n\n\nHTTPS 443 (TCP/UDP) Used for device\nauthentication\n\nTCP 49443 (TCP) Used for device\nauthentication\n\n\nUser\n\n\n**[FIGURE 22. https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/best-practices-securing-ad-fs](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/best-practices-securing-ad-fs)**\n\n\nCommon ports leveraged for lateral movement can be restricted\n(inbound) for AD FS servers using a Windows Firewall\nconfiguration. Administrative connectivity and access to AD FS\nand AD Connect servers should only be initiated from dedicated\nTier 0 Privileged Access Workstations (PAWs) or hardened jump\nhosts and can be defined as exceptions within Windows Firewall\nrulesets. Ports where inbound connectivity on AD FS servers\nshould be restricted using Windows Firewall rules include:\n\n- Predefined Windows Firewall Rule: File and Print Sharing\n\n– TCP/445, TCP/135 - TCP/139 (SMB)\n\n\n\n- Predefined Windows Firewall Rule: Remote Desktop\n\n– TCP/3389 (RDP)\n\n- Predefined Windows Firewall Rule: Windows Management\n\nInstrumentation (WMI)\n\n– Multiple ports\n\nFor specific Windows Firewall rule configurations that can be\nleveraged to restrict inbound access to these ports, reference:\n[https://www.mandiant.com/media/12611/download.](https://www.mandiant.com/media/12611/download)\n\n\n-----\n\n#### Detection\n\nDetection of forged SAML tokens actively being used against an\norganization has proven to be difficult. One possibility is to\ncompare entries in the Azure AD Sign-Ins log against the\nsecurity event logs of the on-premises AD FS servers to ensure\nthat all authentications originated from AD FS. Technically, every\nsign-in recorded in Azure AD will have a corresponding event in\nthe on-premises security event logs. However, in real-world\nenvironments, this exercise is impractical for most\norganizations due to a variety of reasons:\n\n- Sign-ins in Azure AD may not be recorded for up to 24 hours\n\nafter the event occurs\n\n- One sign-in may generate multiple sign-in records in Azure AD\n\n- One sign-in may generate multiple security event log events on\n\nthe AD FS server\n\n- Time skew between multiple systems\n\n- Event log retention\n\n\nOther resources have also suggested looking for anomalous\nattributes in the SAML tokens themselves. Mandiant has\nobserved APT29 using non-standard claims in the forged SAML\ntokens, as well as extending the lifetime of the forged SAML\ntokens beyond the standard one hour. These attributes are not\nvisible to customers in the Azure AD sign-in logs to be used for\ndetection.\n\nTo detect the use of forged SAML tokens, organization should\ninstead focus on traditional logon analysis techniques.\n[Microsoft’s Cloud Application Security and Azure AD portal’s](https://docs.microsoft.com/en-us/cloud-app-security/getting-started-with-cloud-app-security)\n“Azure AD risky sign-in” reports can be useful to identify sign-in\nevents from anonymous VPN providers and infrequently used\ndevices or locations. Impossible travel events can also help\nidentify suspicious logons.\n\nOrganizations with Sysmon or other process and command\nauditing tools installed on AD FS servers may be able to\nidentify suspicious connections to the AD FS WID from\nunexpected processes.\n\n\n-----\n\n# Microsoft 365 Attack Mitigation\n\n\n-----\n\n## Attack Technique: Modify Trusted Domains\n\n#### Azure AD Federated Domains Overview\n\n\nSimilar to on-premises Active Directory, Azure AD uses the\nconcept of “domains” to manage directories of identities. By\ndefault, an Azure AD instance will represent a single domain\nthat is commonly called the “cloud-only” or “onmicrosoft”\ndomain. The domain’s name will be in the form of\n```\n<domain name>.onmicrosoft.com.\n\n```\nFor a user’s email address to match the organization’s domain\nname (such as fireeye.com), an organization must add their\nregistered domain to Azure AD and prove ownership. If the\norganization intends to use a third-party identity provider such\nas AD FS for authentication, the domain must then be configured\nas federated and a federated realm object will be created.\nThe federated realm object tracks information such as the URL\nfor the federated login page, the URL for the federation\nmetadata, and the public portion of the token-signing certificate\nthat Azure AD will use to validate digitally signed SAML tokens it\nreceives. Any verified domain can be configured as a federated\ndomain. Importantly, a SAML token issued by a federated\ndomain can be used to authenticate users that belong to any of\nthe configured domains in the Microsoft 365 tenant.\n\n#### Technique\n\nThe threat actor must first compromise an account with\npermission to modify or create federated realm objects.\nAccounts with the “Global Administrator” or “Hybrid Identity\nAdministrator” role can perform this action. Global\nAdministrators, in particular, can also add new domains and\nconfigure them for federation. In an earlier investigation of\nsuspected APT29 activity, Mandiant observed connections to a\n[Microsoft 365 tenant with MSOnline PowerShell followed by the](https://docs.microsoft.com/en-us/powershell/module/msonline/?view=azureadps-1.0)\nconfiguration of a new, attacker-controlled domain as federated.\n\n\nA threat actor could also modify the federation settings for an\nexisting domain by configuring a new, secondary, token-signing\ncertificate. This would allow for an attack (similar to Golden\nSAML) where the threat actor controls a private key that is able\nto digitally sign SAML tokens and is trusted by Azure AD.\n\nBoth of these techniques would allow the threat actor to\nauthenticate to Microsoft 365 as any user—bypassing the\nrequirement to leverage a valid password for the account and\nperform MFA.\n\nA more detailed discussion of this attacker technique can be\nfound in the Mandiant blog post, “Detecting Microsoft 365 and\n[Azure Active Directory Backdoors.”](https://www.mandiant.com/resources/detecting-microsoft-365-azure-active-directory-backdoors)\n\n#### Detection\n\nThe Azure AD Audit log and Unified Audit log records when a\ndomain is configured for federated authentication and the\nmodification of federated realm objects. In most organizations,\ndomain federation settings will be updated infrequently.\nOrganizations should create rules to alert on the log events\ngenerated by these activities and audit them to ensure they\nare legitimate.\n\nFigure 23 shows a sample event from the Unified Audit Log that\nis recorded when a new domain is federated resulting in the\ncreation of a federated realm object. This event records the\nuser that performed the action and the source IP address,\nin addition to important details about the federated realm\nobject itself. Outside of traditional analysis techniques such as\nuser activity and IP address analysis, organizations should pay\nattention to the IssuerUri value. This value records the address\nof the IdP that is configured to issue SAML tokens. The address\nshould match an expected value, such as the organization’s\nAD FS server.\n\n\n-----\n\n```\n{\n “OrganizationId”: “xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx”,\n “CreationTime”: “2020-06-23T23:03:32.0000000Z”,\n “RecordType”: 8,\n “Operation”: “Set domain authentication.”,\n “UserType”: 0,\n “Workload”: “AzureActiveDirectory”,\n “ClientIP”: “1.1.1.1”,\n “Version”: 1,\n “UserId”: “doug@victim.onmicrosoft.com”,\n “ObjectId”: “Not Available”,\n “ResultStatus”: “Success”,\n “ModifiedProperties”: [\n {\n “Name”: “IssuerUri”,\n “NewValue”: “[\\r\\n \\”http://any.sts/16B45E3B\\”\\r\\n]”,\n “OldValue”: “[]”\n },\n {\n “Name”: “Included Updated Properties”,\n “NewValue”: “IssuerUri,LiveType”,\n “OldValue”: “”\n },\n {\n “Name”: “LiveType”,\n “NewValue”: “[\\r\\n \\”Federated\\”\\r\\n]”,\n “OldValue”: “[\\r\\n \\”Managed\\”\\r\\n]”\n }\n ],\n }\n\n```\n\n**FIGURE 23. Event recorded when a new domain is federated, and a federated realm object is created.**\n\n\nFigure 24 shows a sample event recorded in the Unified Audit\nLog when an existing federated realm object for a domain is\nmodified. In most organizations, domain federation settings will\nbe updated infrequently. Organizations should create rules to\nalert on the log events that get generated by these activities and\naudit them to ensure they are legitimate. The event records the\n\n\nuser that performed the action, the IP address the action was\nperformed from, as well as the domain that was modified. It does\nnot record what elements of the federated realm object were\nmodified. Additional analysis using MSOnline PowerShell\n(detailed in the hardening and remediation sections) will be\nneeded to identify whether the signing-certificate was modified.\n\n\n-----\n\n```\n{\n “OrganizationId”: “ xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx “,\n “CreationTime”: “2020-12-04T18:41:45.0000000Z”,\n “RecordType”: 8,\n “Operation”: “Set federation settings on domain.”,\n “UserType”: 0,\n “Workload”: “AzureActiveDirectory”,\n “ClientIP”: “1.1.1.1”,\n “Version”: 1,\n “UserId”: “victim@test.onmicrosoft.com”,\n “ResultStatus”: “Success”,\n “Id”: “xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx”,\n “ObjectId”: “Not Available”,\n “ModifiedProperties”: [],\n “AzureActiveDirectoryEventType”: 1,\n “ExtendedProperties”: [\n {\n “Value”: “{}”,\n “Name”: “additionalDetails”\n },\n {\n “Value”: “Domain”,\n “Name”: “extendedAuditEventCategory”\n }\n ],\n “SupportTicketId”: “”,\n “ActorIpAddress”: “1.1.1.1”,\n “Target”: [\n {\n “Type”: 1,\n “ID”: “test.com”\n }\n ],\n “\n}\n\n```\n\n**FIGURE 24. Event recorded when an existing federated realm object is modified.**\n\n\n-----\n\n#### Remediation\n\n[The Azure AD Investigator auditing script, available from the](https://github.com/fireeye/Mandiant-Azure-AD-Investigator)\nMandiant GitHub repository, contains a module that will\nenumerate all domains in a Microsoft 365 tenant. The script will\noutput all unverified domains, domains that are configured for\nfederation, as well as domains with a federated realm object that\n[is evidence of the AADBackdoor tool. Administrators should](https://o365blog.com/post/aadbackdoor/)\nreview this output to ensure that only expected domains are\nconfigured as federated and that the federation login pages are\nexpected as well.\n\n\n**Step 1: Review Configured Domains and Trusts Within**\n**Microsoft 365 and Remove Untrusted Domains**\n\n1. Enumerate all Registered Domains\n\nOrganizations should proactively review the scope of\nconfigured domains within a Microsoft 365 tenant, including\nthe configured authentication methods (Managed or\nFederated). The PowerShell cmdlets noted in Figure 25 will\nprovide a listing of configured domains and the associated\nauthentication methods.\n\n2. Remove unrecognized or suspicious domains\n\nOrganizations should assess each domain’s verification\nstatus and authentication mode. These settings should be\nreviewed for legitimacy and functional operation. If a domain\nis no longer in use, or the domain’s existence cannot be\nreadily identified, it should be investigated and removed from\nthe tenant (Figure 26).\n\n```\nConnect-MsolService\nGet-MsolDomain\nConnect-ExchangeOnline\nGet-FederatedOrganizationIdentifier -IncludeExtendedDomainInfo\nGet-FederationTrust\n\n```\n\n**FIGURE 25. PowerShell cmdlets to review domain configurations.**\n\n```\nConnect-MsolService\n** Will delete a domain from Azure Active Directory. **\nRemove-MsolDomain\n** Will remove a domain and the associated relying party trust settings in AD FS. **\nRemove-MsolFederatedDomain\n\n```\n\n**FIGURE 26. PowerShell commands to remove an Azure AD or federated domain.**\n\n\n-----\n\n## Attack Technique: Abuse Azure AD Privileged Roles\n\n#### Azure Active Directory Privileged Roles Overview\n\nAzure Active Directory uses the concept of roles to confer administrative privileges. Roles can be assigned to users, groups,\napplications, and service principals (covered later in this white paper). There are over 50 roles available in Azure AD and some are\nmore sensitive than others.\n\nTable 2 details some of the highest privileged directory roles that threat actors often target – and should be closely monitored by\n[organizations. This should not be treated as an exhaustive list of privileged roles. For a full listing see https://docs.microsoft.com/](https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference)\n[en-us/azure/active-directory/roles/permissions-reference.](https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference)\n\n|TABLE 2. Azure AD - Highly Privilege|ed Roles.|Col3|\n|---|---|---|\n|Role|Description|Impact|\n|Application administrator|Can create and manage app registrations and enterprise apps|Backdoor existing applications|\n|Cloud application administrator|Can create and manage app registrations and enterprise apps|Backdoor existing applications|\n|Exchange administrator|Manage all aspects of exchange|• Grant access to user mailboxes • Change mail settings|\n|Global administrator|Manage all aspects of Azure AD and Microsoft services that use it|Complete control over the Microsoft 365 environment|\n|Privileged role administrator|Manage role assignments|Privilege escalation via privileged roles|\n|User access administrator|Assign roles in all subscriptions and management groups|Privilege escalation via privileged roles|\n|SharePoint administrator|Can manage all aspects of SharePoint|Complete control over SharePoint including access to sites and documents|\n|Hybrid identity administrator|Can update federation settings for domains|Ability to install an azure AD backdoor|\n\n\n**TABLE 2. Azure AD - Highly Privileged Roles.**\n\n\n#### Technique\n\nOrganizations will often grant privileged roles to user identities\nthat are synced from on-premises Active Directory. Most\ncommonly, this includes a privileged on-premises account being\nused to manage Azure AD and Microsoft 365 resources. This can\npresent a security risk as it facilitates lateral movement from the\non-premises environment to the cloud environment. Mandiant\nhas observed threat actors performing reconnaissance to\nidentify on-premises AD accounts that hold privileged roles and\ntarget them for credential theft. Once in possession of\ncredentials for an account that holds a privileged directory role,\nthe threat actor uses it to connect to Microsoft 365 and establish\na foothold for directly accessing cloud resources without the\ncontinued need for on-premises access.\n\n\n#### Remediation\n\n**Step 1: Review and Configure Cloud-Only Accounts for**\n**Privileged Role Holders**\n\nOrganizations should review the scope of accounts assigned\nprivileged permissions and roles in Microsoft 365. Additionally,\nthe roles and accounts with privileged access should be\ncloud-only accounts (not accounts synced from on-premises\nidentity stores such as Active Directory).\nAll privileged cloud-only accounts should leverage MFA through\neither conditional access polices or security defaults.\n\n1. **Review Accounts assigned Privileged Roles**\n\nUsing the PowerShell commands referenced in Figure 27,\nreview each account that is assigned to a privileged role in\nAzure AD. Any identified on-premises synced accounts that\nare configured with a privileged role in Azure AD should be\nreplaced with a cloud-only account. Cloud-only accounts are\ndenoted by the @<tenant>.onmicrosoft.com domain suffix.\n\n\n-----\n\n```\nConnect-AzureAD\n$Role = Get-AzureADDirectoryRole\n$Role | ForEach-Object {\n $ObjectId = $_.ObjectId\n $displayname = $_.displayname\n $a = Get-AzureADDirectoryRoleMember -objectid $ObjectId | Select-Object ObjectID,\nUserPrincipalName\n $a | Add-Member -NotePropertyName GroupID -NotePropertyValue $ObjectId\n $a | Add-Member -NotePropertyName GroupName -NotePropertyValue $DisplayName\n $a | Export-csv Get-AzureADDirectoryRoleMember.csv -Append -NoTypeInformation\n\n```\n\n**FIGURE 27. PowerShell commands to review privileged role assignments in Azure AD.**\n\n2. **List and review ImmutableID values for cloud-only accounts**\n\nImmutableIDs act as an anchor attribute between synced on-premises identities and their cloud account counterpart. If a cloud-only\naccount has an ImmutableID, then a threat actor could forge a SAML token for the account, even though it is considered cloud-only.\nFor this reason, all cloud-only accounts should not be configured with an ImmutableID. The PowerShell command noted in Figure 28\ncan be leveraged to review cloud-only accounts with an ImmutableID.\n\n3. **For accounts that contain an ImmutableID value, delete and recreate the account**\n\n```\nConnect-MsolService\nGet-MsolUser -All | Where-Object {$_.UserPrincipalName -like “*.onmicrosoft.com”}| Select\nDisplayName,UserPrincipalName,ImmutableID\n\n```\n\n**FIGURE 28. PowerShell command to identify cloud-only accounts with an ImmutableID.**\n\n**Step 2: Rotate All Passwords for Cloud-Only Accounts**\n\nOnce the final set of privileged accounts have been determined, force password changes for all cloud-only accounts that have not had\ntheir passwords recently rotated. The PowerShell command noted in Figure 29 will list all enabled cloud-only accounts and the\ncorresponding last password change value.\n\n```\nConnect-MsolService\nGet-MsolUser -All | Where-Object {($_.UserPrincipalName -like “*.onmicrosoft.com”) -and ($_.\nBlockCredential -eq $false)} | Select DisplayName,UserPrincipalName,LastPasswordChangeTimeStamp\n\n```\n\n**FIGURE 29. PowerShell command to determine the last password change date for accounts.**\n\n**Step 3: Invalidate Refresh Tokens for Each Cloud-Only Account**\n\nAfter rotating credentials for existing accounts, organizations should immediately revoke existing refresh tokens for each account. This\nwill result in users being required to reauthenticate. Using an account that has Microsoft 365 Global Administrator permissions,\ninvalidate each existing account’s refresh token using the PowerShell commands noted in Figure 30.\n\n```\nConnect-AzureAD\nGet-AzureADuser -Identity <UPN> | Revoke-AzureADUserAllRefreshToken\n\n```\n\n**FIGURE 30. PowerShell commands to connect to Azure AD and revoke existing refresh tokens.**\n\n\n-----\n\n## Attack Technique: Hijack Azure AD Applications\n\n#### Azure Applications and Service\n Principals Overview\n\n\nApplications are created in Azure AD to provide API access to\nMicrosoft 365 data by third parties. Different terms are used to\nrefer to applications depending on how they are created and\nhow they are interacted with. This section defines these terms\nbefore a discussion of the threat actor techniques and how to\nprotect against them.\n\n- App Registrations, also known as Applications or Application\n\n**Objects, define the initial instance of an application, including**\nAPI permissions, application secrets, and branding elements.\nThe app registration resides in the tenant where it was\ncreated. For example, the Exchange Online application resides\nin the Microsoft Corporation tenant and the custom application\ncreated by the IT team resides in the organization’s tenant.\nApplication objects serve as a “blueprint” to create a service\nprincipal in any tenant that uses the application.\n\n- Enterprise Applications, also known as Service Principals or\n\n**Application Instances, represent applications that are being**\nused within a Microsoft 365 tenant. These can be third-party\napplications such as a Salesforce integration, or custom\napplications built by the organization. There are also\n“first-party” service principals used for components of\nMicrosoft 365 itself. Examples include Exchange Online,\nMicrosoft Graph, and the Azure Portal. Every tenant using an\napplication will automatically create a service principal for it.\nThere is a one-to-many relationship between applications and\nservice principals.\n\nThe term “applications” is often used to refer to both App\nRegistrations and Enterprise Applications as many concepts\napply to both. This white paper will follow the same practice\ngoing forward and refer to specific terms when needed.\n\n\nThere are two different models when assigning permissions for\napplications to access an API:\n\n- Delegated Permissions, also known as\n\n**OAuth2PermissionGrants, enable an application to perform**\nAPI operations that access or manipulate data on behalf of a\nsigned-in user. A user must sign-in and consent to, or allow,\nthe application to access data on their behalf. An administrator\ncan also consent on the behalf of all users. Delegated\npermissions are out of scope for this white paper.\n\n- Application Permissions, also known as AppRoles and\n\n**AppRoleAssignments, enable an application to perform API**\noperations that access or manipulate data without a signed-in\nuser. Application Permissions allows the application to interact\nwith an API as itself, without a session that is acting on behalf of\na specific user.\n\nBoth Applications and Service Principals can have delegated\nor application permissions associated with them.\n\nIn order to authenticate to Microsoft 365 and access the APIs,\nApplications and service principals can also have credentials in\nthe form of secrets or certificates associated with them.\nThese are roughly analogous to API keys in other cloud\nservices. Administrators can add a credential that is then used\nto connect to Microsoft 365 with the identity of the application\nor service principal. Once the credential has been added to\nMicrosoft 365, its value cannot be extracted. An attacker that\nis able to add a new secret or certificate can connect to Azure\nAD as the application and perform API operations using\nwhatever Application Permissions that are assigned to it. For\nexample, an organization may configure a backup application\nwith the mail.read Application Permission to allow it to read all\nmail in the tenant and create backups. Hijacking an application\n(by adding a rogue secret or certificate) with granted\npermissions will allow the attacker to access data that is\nnormally protected by MFA requirements.\n\n\n-----\n\n#### Technique\n\nMandiant has observed APT29 adding additional certificates or\nsecrets to existing applications and service principals. To\naccomplish this, the threat actor first needed to compromise an\naccount with a privileged directory role that was granted the\nability to modify Enterprise Applications or Application\nRegistrations. A frequently targeted role was the Application\nAdministrator, because it allowed complete control over\napplications in Azure AD. Once in possession of those\ncredentials, APT29 modified the application by using one of the\nfollowing techniques:\n\n- Modification of an application via the browser:\n\nThe attacker connected to the Azure Portal with a web browser\nand added a new secret to an App Registration that had\npermissions to read all mail. There is no supported way to add\na credential to an Enterprise Application (service principal) via\nthe browser.\n\n- Modification of an application via PowerShell:\n\nThe attacker connected to the Microsoft 365 tenant using\nAzure AD PowerShell. Once connected they added certificates\nto App Registrations and Enterprise Applications that had the\n```\n mail.read and files.read permission.\n\n```\nMandiant has observed APT29 first performing reconnaissance\nof an organization’s Azure AD to identify existing applications\nthat already have sensitive permissions set, such as mail.read\nand files.read. Once a viable application was identified, APT29\nadded a rogue credential to it using one of the methods detailed\nabove. At a minimum this allowed APT29 to access any user’s\ndata in the victim tenant without MFA.\n\n**An important note about hijacking an App Registration:**\nApp Registrations are the original copy of an application that\nresides in the creator’s tenant. Any other tenant that uses this\napplication creates a copy of it called a service principal.\nIf a threat actor were to hijack the App Registration of an\napplication that is used by other organizations, the threat actor\nwould be able to access the data of those organizations as well.\n\n\n#### Detection\n\nThe Azure AD Audit log and the Unified Audit Log record when\ncredentials are added to both service principals and App\nRegistrations. In most organizations, credentials will be added to\nservice principals and App Registrations infrequently.\nOrganizations should create rules to alert on the log events that\nget generated by these activities and audit them to ensure they\n[are legitimate. For example, Microsoft has published suggested](https://techcommunity.microsoft.com/t5/azure-sentinel/solarwinds-post-compromise-hunting-with-azure-sentinel/ba-p/1995095)\n[hunting rules using Sentinel to identify these activities.](https://techcommunity.microsoft.com/t5/azure-sentinel/solarwinds-post-compromise-hunting-with-azure-sentinel/ba-p/1995095)\n\nFigure 31 shows a sample event from the Unified Audit Log that is\nrecorded when a credential is added to an App Registration. The\nevent includes the user that performed the action, the ID of the\napplication that was modified, details on the credential that was\nadded, and more. Of note are the ClientIP and ActorIPAddress\nfields. When the credential is added via the Azure Portal, the IP\naddress that gets recorded is a Microsoft IP address. This hides\nthe true IP address of the action and can make searching for\nactivities by IP address prone to missing data.\n\n\n-----\n\n```\n{\n “OrganizationId”: “xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx”,\n “CreationTime”: “2021-01-09T18:40:16.0000000Z”,\n “RecordType”: 8,\n “Operation”: “Update application – Certificates and secrets management “,\n “Workload”: “AzureActiveDirectory”,\n “UserType”: 0,\n “ClientIP”: “20.190.130.49”,\n “Version”: 1,\n “UserId”: “doug@testing.onmicrosoft.com”,\n “ObjectId”: “Application_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx”,\n “Id”: “xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx”,\n “ResultStatus”: “Success”,\n “ModifiedProperties”: [\n {\n “Name”: “KeyDescription”,\n “NewValue”: “[\\r\\n \\”[KeyIdentifier= xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx,KeyType=Password,KeyUsa\nge=Verify,DisplayName=test]\\”\\r\\n]”,\n “OldValue”: “[]”\n },\n {\n “Name”: “Included Updated Properties”,\n “NewValue”: “KeyDescription”,\n “OldValue”: “”\n }\n ],\n “AzureActiveDirectoryEventType”: 1,\n “ExtendedProperties”: [\n {\n “Value”: “{\\”User-Agent\\”:\\”Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36\n(KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36\\”}”,\n “Name”: “additionalDetails”\n },\n }\n}\n\n```\n\n**FIGURE 31. Sample event recorded when a credential is added to an App Registration.**\n\nA similar event is recorded when credentials are added to a service principal. Figure 32 details a sample log event from the Unified\nAudit Log.\n\nWhen a credential that has been added to an application is used to login to Microsoft 365, it is recorded differently than an interactive\nuser sign-in. In the Azure Portal these logins can be viewed by navigating to Sign-Ins under the Azure Active Directory blade and then\nclicking the service principal Sign-ins tab. The sign-in log records the IP address that performed the sign-in, but not the credential that\nwas used. Note that currently these sign-ins are not recorded in the Unified Audit Log.\n\n\n-----\n\n```\n{\n “OrganizationId”: “xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx”,\n “CreationTime”: “2021-01-07T21:32:13.0000000Z”,\n “RecordType”: 8,\n “Operation”: “Add service principal credentials.”,\n “UserType”: 0,\n “Workload”: “AzureActiveDirectory”,\n “ClientIP”: “1.1.1.1”,\n “Version”: 1,\n “UserId”: “doug@test.onmicrosoft.com”,\n “ObjectId”: “xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx”,\n “Id”: “ xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx “,\n “ResultStatus”: “Success”,\n “ModifiedProperties”: [\n {\n “Name”: “KeyDescription”,\n “NewValue”: “[\\r\\n \\”[KeyIdentifier=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx,KeyType=Symmetric,KeyUsa\nge=Verify,DisplayName=]\\”\\r\\n]”,\n “OldValue”: “[]”\n },\n}\n\n```\n\n**FIGURE 32. Sample event recorded when a credential is added to a service principal.**\n\n#### Remediation\n\n[The Azure AD Investigator auditing script, available from the](https://github.com/mandiant/Mandiant-Azure-AD-Investigator)\n[Mandiant GitHub repository, contains a module that will](https://github.com/mandiant/Mandiant-Azure-AD-Investigator)\nenumerate all applications and service principals in a Microsoft\n365 tenant. The script will output all applications and service\nprincipals that have both certain high-risk application\npermissions assigned to them and an assigned credential. These\nare applications that a threat actor may have used to connect to\nMicrosoft 365 and access data. Administrators will need to work\nwith their security and IT teams to validate that the credentials\nadded to the applications and service principals are legitimate.\n\n**Step 1: Review and Remediate Keys Associated with Service**\n**Principals and Applications**\n\nOrganizations can leverage Azure PowerShell to review and\nremediate service principals or applications that may be\nconfigured with credentials for remote authentication using\neither a static secret or certificate.\n\n\n1. **Search for suspicious service principal credentials**\n\nTo search for evidence of credentials that have been\nconfigured or added to a specific service principal, the\nPowerShell command noted in Figure 33 can be leveraged.\nThe command output will include the KeyId, StartDate,\nEndDate, and key type (password / certificate).\n\n2. **Remove suspicious service principal credentials**\n\nTo remove a suspicious credential associated with a specific\nservice principal, the PowerShell commands noted in Figure\n34 can be leveraged.\n\n3. **Search for suspicious Application credentials**\n\nTo search for evidence of credentials that have been\nconfigured or added to a specific Azure application, the\nPowerShell command noted in Figure 35 can be leveraged.\n\n4. **Remove suspicious Application credentials**\n\nTo remove a suspicious credential associated with a specific\napplication, the PowerShell commands noted in Figure 36\ncan be leveraged.\n\n\n-----\n\n```\nConnect-AzAccount\nGet-AzADServicePrincipal -ApplicationID <> | Get-AzADSPCredential\n\n```\n\n**FIGURE 33. PowerShell command to review a service principal – and any associated credentials that may be configured.**\n\n```\nConnect-AzAccount\n** Remove all credentials associated with a service principal **\nGet-AzADServicePrincipal -ObjectId <> | Remove-AzADSpCredential\n** Remove a specific credential (KeyID) associated with a service principal **\nRemove-AzADSpCredential -ObjectId <> -KeyId <>\n** Remove a specific service principal **\nRemove-AzADServicePrincipal -ObjectId <>\n\n```\n\n**FIGURE 34. PowerShell commands to remove credentials associated with a service principal – or remove a specific service principal.**\n\n```\nConnect-AzAccount\nGet-AzADApplication -ApplicationID * | Get-AzADAppCredential\n\n```\n\n**FIGURE 35. PowerShell command to review a service principal – and any associated credentials that may be configured.**\n\n```\nConnect-AzAccount\n** Remove all credentials associated with a service principal **\nGet-AzADApplication -ObjectId <> | Remove- AzADAppCredential\n** Remove a specific credential (KeyID) associated with a service principal **\nRemove-AzADAppCredential -ObjectId <> -KeyId <>\n** Remove a specific application **\nRemove-AzADApplication -ObjectId <>\n\n```\n\n**FIGURE 36. PowerShell commands to remove credentials associated with an application – or remove a specific application.**\n\n**Step 2: Invalidate All Existing Refresh Tokens**\n\nAfter removing malicious credentials, organizations should immediately revoke all existing refresh tokens for their Microsoft 365 tenant.\nThis will result in users being required to reauthenticate. Using an account that has Microsoft 365 Global Administrator permissions,\ninvalidate all existing refresh tokens using the PowerShell commands noted in Figure 37.\n\n```\nConnect-AzureAD\nGet-AzureADuser -all $true | Revoke-AzureADUserAllRefreshToken PowerShell commands to connect to\nAzure AD and revoke existing refresh tokens.\n\n```\n\n**FIGURE 37. PowerShell commands to connect to Azure AD and revoke existing refresh tokens.**\n\n\n-----\n\n## Attack Technique: Modify Mailbox Folder Permissions\n\n#### Mailbox Folder Permission Overview\n\nWithin a Microsoft Exchange mailbox, you can grant granular\naccess permissions to individual folders. These permissions can\nbe granted directly by the mailbox owner, or on behalf of a\nmailbox owner by either an account that has been delegated\naccess to the mailbox or an Exchange administrator. Mailbox\nfolder permissions are frequently used to share a specific folder\nwithin a mailbox with a co-worker instead of delegating rights for\nthe entire mailbox. Administrators will often make a calendar\npublic by granting read access to it for all authenticated users.\n\nMailbox folder permissions can be assigned through either\nindividual folder permissions or roles, which are a collection of\nfolder permissions. The ReadItems permission grants read\naccess to the items in a mailbox folder. The following roles\ninclude permissions that grant read access to folder items:\n\n- Author\n\n- Editor\n\n- NonEditingAuthor\n\n- Owner\n\n- PublishingEditor\n\n- PublishingAuthor\n\n- Reviewer\n\nFor a full listing of mailbox folder permissions and roles see\n[https://docs.microsoft.com/en-us/powershell/module/](https://docs.microsoft.com/en-us/powershell/module/exchange/set-mailboxfolderpermission?view=exchange-ps#parameters)\n[exchange/set-mailboxfolderpermission?view=exchange-](https://docs.microsoft.com/en-us/powershell/module/exchange/set-mailboxfolderpermission?view=exchange-ps#parameters)\n[ps#parameters. Folder permissions can be assigned to users](https://docs.microsoft.com/en-us/powershell/module/exchange/set-mailboxfolderpermission?view=exchange-ps#parameters)\nand mail-enabled security groups. In addition to the individual\nusers in an Microsoft 365 tenant, there are two special users:\n\n- Anonymous: External, unauthenticated users\n\n- Default: Internal, authenticated users\n\n\nBy default, the access right of None is assigned to both the\nDefault and Anonymous user on each mailbox in the tenant. For\neach mailbox, the user-accessible folders (such as Inbox, Sent\nItems, Deleted Items) reside within a hidden root folder called the\n“Top of Information Store”. Just like user-visible folders, folder\npermissions can be granted to it. By default, the Default and\nAnonymous user are assigned the None permission (Figure 38).\n\n\n**FIGURE 38. Top of Information Store Hierarchy.**\n\n\n-----\n\n#### Technique\n\nMandiant has observed threat actors assigning the Default user\npermissions or roles that grant read privileges to items stored in\nthe Inbox and other mailbox folders. By assigning read privileges\nto the Default user, an attacker could then login as any user in\nthe Microsoft 365 tenant and read the items stored in the folder.\nFirst, the threat actor used an administrator account to modify\nmailbox folder permissions for mailboxes of interest in the\ntenant. Then, the threat actor used a low-privileged user to login\non a daily basis and download messages from the mailboxes\nfolders that they previously modified. These logins were only\nrecorded in Azure AD sign-ins because they were coded as\nnon-interactive sign-ins.\n\nMailbox folder permissions can be added or modified using\neither the Outlook client or PowerShell using the\n```\nAdd-MailboxFolderPermission or\n\nSet-MailboxFolderPermission cmdlets.\n\n```\n\n#### Remediation\n\nIf an organization has evidence that a sophisticated threat actor\nhas accessed their Microsoft 365 tenant, they should consider\nauditing mailbox folder permissions for any unauthorized\nmodifications. The Mandiant Azure AD Investigator will enumerate\npermissions for the Top of Information Store and Inbox folders for\nall mailboxes within a tenant and output mailboxes where access\nrights for the Default or Anonymous users are modified from the\ndefault setting of None. Based on the output data from the script,\norganizations will need to determine whether or not the modified\nmailbox folder permissions are legitimate. Given the overly\npermissive nature of the Default and Anonymous users, access\nrights should be revoked and the principle of least privilege should\nbe applied. Organizations should only grant permissions to an\nexplicit list of users based on business need.\n\n**Review and Remove Folder Access Rights Granted for Default**\n**or Anonymous Permissions**\n\n1. **Enumerate Mailbox Folder Permissions (quick)**\n\nThe Mandiant Azure AD Investigator tool includes a cmdlet to\nperform this task.\n\n2. **Enumerate all Folder Permissions for a Specific**\n\n**Mailbox (thorough)**\nGiven the number of folders that exist in each mailbox,\nenumerating every folder permission for every mailbox\nis inefficient. Mandiant recommends a triage approach\nto first identify mailboxes of interest by scanning the\npermissions of specific well-known folders such as Inbox\nand then performing a full review on any of the identified\nmailboxes. The script in Figure 39 will enumerate all assigned\npermissions for all folders for a given mailbox.\n\n3. **Remove untrusted or suspicious permissions**\n\nTo remove any excessive permissions for a folder, the\nPowerShell command noted in Figure 40 can be used.\n\n\n-----\n\n```\n#Check if current session is connected to EXO, else prompt for login\n$EXOCheck = Get-PSSession | Where-Object ComputerName -eq ‘outlook.office365.com’\nIf ($EXOCheck){\n Write-Host “Already connected to: $((Get-AcceptedDomain | Where-Object Default -eq $true).Name)”\n-ForegroundColor Yellow\n $EXOContinue = Read-Host -Prompt “Continue scanning this tenant (Y/n)”\n If ($EXOContinue -match ‘^y$|^yes$|^$’){\n Write-Host ‘Continuing against connected tenant.’ -ForegroundColor Green\n } Else {\n Write-Host ‘Script aborted due to user input, please re-run.’ -ForegroundColor Red\n Break\n }\n} Else {\n Connect-ExchangeOnline\n}\n#Receive user input for UPN\n$User = Read-Host -Prompt “Enter UPN of Mailbox to Review Folder Permissions”\n#Store output file to variable\n$OutputFileName = “Get-UserMailboxFolderPermission.csv”\n#Store all mailboxes to variable\nTry{\n Write-Host -Object “Retrieving Mailboxes, Please Wait....”\n $mbox = Get-EXOMailbox -Identity $User\n}Catch{\n Write-Warning -Message “Problem obtaining a list of mailboxes, check connection or permissions\nto Connect-ExchangeOnline”\n Write-Warning -Message $_\n break\n}\nWrite-Host -Object “Enumerating Mailbox Folder Permissions. Please Wait.....”\n#Retrieve all permissions for all folders in a specific mailbox\nTry{\n $Folders = (Get-MailboxFolderStatistics $mbox.UserPrincipalName).FolderPath\n foreach($folder in $Folders){\n $identity = “$($mbox.UserPrincipalName):$folder”\n Get-MailboxFolderPermission -Identity $identity.Replace(“/”,”\\”) -ErrorAction SilentlyContinue |`\n Select-Object @{Name = ‘UserPrincipalName’; Expression = {$mbox.UserPrincipalName}},\nFolderName,User,@{Label=”AccessRights”;Expression={$_.AccessRights -join “,”}} | `\n Export-Csv -Path $OutputFileName -NoTypeInformation -Append\n }\n}Catch{\n Write-Warning -Message “Problem accessing Mailbox Folders permissions”\n Write-Warning -Message $_\n break\n}\n#output results. Display file location\nWrite-Host -Object “Completed the export of folder permissions. Results have been saved to\n$(Join-Path -Path (Get-Location).Path -ChildPath $OutputFileName)”\n\n```\n\n**FIGURE 39. Permission enumeration script.**\n\n\n-----\n\n```\nConnect-ExchangeOnline\nSet-MailboxFolderPermission -Identity <UPN>:\\<Top of Information Store, Inbox, or Desired Path>\n-User <Anonymous or Default> -AccessRights None\n\n```\n\n**FIGURE 40. PowerShell command to remove mailbox folder permissions for a specific account.**\n\n#### Detection\n\n\nTo proactively monitor for malicious folder permission\nmodifications, specific mailbox auditing must be enabled.\nFor new Microsoft 365 tenants, mailbox auditing is enabled by\ndefault. For pre-existing tenants it must be enabled per mailbox.\nEach mailbox must have the UpdateFolderPermissions action\nenabled for all logon types (owner, delegate and admin). This\nauditing configuration is part of the default audit set when an\norganization enables mailbox auditing. To review mailbox audit\nsettings and enable UpdateFolderPermissions auditing, refer to\nthe Step 3: Enhance Mailbox Auditing.\n\n\nThe mailbox audit log will forward folder permission modification\nevents to the Unified Audit Log. Organizations should create rules\nto alert on ModifyFolderPermission operations where the\nAnonymous or Default user has been assigned permissions other\nthan None.\n\nFigure 41 shows a sample event from the Unified Audit Log\nwhere the Default user has been assigned the Reviewer role for\nan Inbox folder. Note that the terms used in the log record differ\nfrom the terms used to assign or view the permissions in\nOutlook. In the audit log the Everyone value for MemberUpn is the\nsame as default user, and the collection of MemberRights maps\nto the Reviewer role.\n\n\n-----\n\n```\n{\n “CreationTime”: “2021-01-13T14:39:18”,\n “Id”: “xxxxxxxx-xxxx-xxxx-xxxxxxxxxxxx”,\n “Operation”: “ModifyFolderPermissions”,\n “OrganizationId”: “ xxxxxxxx-xxxx-xxxx-xxxxxxxxxxxx”,\n “RecordType”: 2,\n “ResultStatus”: “Succeeded”,\n “UserKey”: “XXXXXXXXXX”,\n “UserType”: 0,\n “Version”: 1,\n “Workload”: “Exchange”,\n “ClientIP”: “1.1.1.1”,\n “UserId”: “vic@acme.net”,\n “AppId”: “00000002-0000-0ff1-ce00-000000000000”,\n “ClientAppId”: “00000002-0000-0ff1-ce00-000000000000”,\n “ClientIPAddress”: “1.1.1.1”,\n “ClientInfoString”: “Client=WebServices;ExchangeWebServicesProxy/CrossSite/EXCH/15.20.3742.012/\nMicrosoft Office/16.0 (Windows NT 10.0; Microsoft Outlook 16.0.12430; Pro)[AppId=00000002-00000ff1-ce00-000000000000];”,\n “ExternalAccess”: false,\n “InternalLogonType”: 0,\n “LogonType”: 0,\n “LogonUserSid”: “S-1-5-21-xxxxxxxx-xxxx-xxxx-xxxxxxxxxxxx “,\n “MailboxGuid”: “ xxxxxxxx-xxxx-xxxx-xxxxxxxxxxxx “,\n “MailboxOwnerSid”: “S-1-5-21-xxxxxxxx-xxxx-xxxx-xxxxxxxxxxxx “,\n “MailboxOwnerUPN”: “vic@acme.net”,\n “OrganizationName”: “acme.onmicrosoft.com”,\n “OriginatingServer”: “MN2PR07MB7040 (15.20.3742.012)\\r\\n”,\n “Item”: {\n “Id”: “xxxxxxxxxxxxxxx”,\n “ParentFolder”: {\n “Id”: “xxxxxxxxxxxxxx”,\n “MemberRights”: “ReadAny, Visible, FreeBusySimple, FreeBusyDetailed”,\n “MemberSid”: “S-1-1-0”,\n “MemberUpn”: “Everyone”,\n “Name”: “Inbox”,\n “Path”: “\\\\Inbox”\n }\n }\n}\n\n```\n\n**FIGURE 41. Modified permission of folder for Default user.**\n\n\n-----\n\n## Attack Technique: Application Impersonation\n\n\nMicrosoft Exchange documentation describes three main\nways for an account to access mail items that reside in\nother mailboxes:[1]\n\n- Mailbox delegation\n\n- Modifying mailbox folder permissions\n\n- Impersonation\n\n[Mandiant and others have previously observed and discussed](https://www.mandiant.com/resources/rpt-m-trends-2017)\nthreat actors using mailbox delegation to access specific\nmailboxes during an intrusion, and later in this white paper we\ndetail how APT29 has used mailbox folder permissions to access\nthe mailboxes of target mailboxes. The last technique,\nimpersonation, is very attractive to threat actors because it can\ngrant access to all mailboxes in a tenant without the need to\nmodify each individually.\n\nImpersonation grants an account the ability to access a mailbox\nand “act as” the mailbox owner. This means that in addition to\nreading the mail in a target mailbox, the account can perform\nother actions in Exchange as if it was the impersonated user. This\nincludes potentially accessing any mailboxes that are currently\ndisabled. It is important to note that impersonation resides within\nExchange Online, and by using it, a threat actor can only perform\nactions within Exchange Online. A threat actor cannot, for\nexample, use impersonation to impersonate a Global Admin and\ncreate new Application Registrations or reset passwords. In 2016,\nBlack Hills Information Security wrote about abusing this role to\nread the mail of all mailboxes in an Exchange environment.[2]\n\n\nIn Exchange, the ability to impersonate other users is controlled\nby a privileged role called ApplicationImpersonation. In\nExchange, Management Role Assignments are used to map\nbuilt-in Exchange roles (such as ApplicationImpersonation) to\nusers. These assignments can also be created with limiting\nscopes so that the role can only be used against a specific set of\nmailboxes. When a Management Role Assignment is created\nwithout any explicit scopes, then the scope is implicitly set to all\nmailboxes in the tenant.\n\n#### Technique\n\nMandiant has observed threat actors first compromising\naccounts that had the Exchange Administrator or Global\nAdministrator roles. To assign the ApplicationImpersonation\nrole, an account must have at least Exchange Administrator\nprivileges. This implicitly includes any user with the Organization\nManagement or Company Administrator roles. After obtaining\nthe right level of privilege, the threat actor logs into the tenant\nusing Exchange Online PowerShell and creates a new\nManagement Role Assignment. The threat actor will create a new\nassignment and give it a name that blends in with other preexisting assignments. Figure 42 shows an example PowerShell\ncommand used to create a new assignment. The threat actor\ndoes not create the role with any restricting scopes, and thus\ncan access any mailbox in the tenant using impersonation.\n\n```\nNew-ManagementRoleAssignment -Name emailbackup-svc -Role ApplicationImpersonation -User john.doe@\nvictim.net\n\n```\n\n**FIGURE 42. PowerShell cmdlet to assign a new Management Role.**\n\nThe threat actor then logs in to the tenant using the account they had granted the ApplicationImpersonation role to and begins to access\nmail items in arbitrary mailboxes. Mandiant has observed the threat actor using this technique to login to Microsoft 365 on a near daily\nbasis and collect all the email items that were created in the victim mailbox since the last collection occurred.\n\n\n-----\n\n#### Remediation\n\nMandiant recommends that organizations investigate each\naccount that has the Application Impersonation role assigned\nand remove it where necessary. In general, only service\naccounts should have this role assigned. The role should be\napplied with a scope that limits the mailboxes it can impersonate\n\n\nand should have logins restricted to specific whitelisted IP\naddresses to limit the impact of any credential compromise. To\nlist the admin role groups and associated members where the\nApplication Impersonation role is assigned, use the PowerShell\ncommand in Figure 43.\n\n```\n$AppImperGroups = Get-RoleGroup | Where-Object Roles -like ApplicationImpersonation\nForEach ($Group in $AppImperGroups){\nGet-RoleGroupMember $Group.Name\n}\n\n```\n\n**FIGURE 43. PowerShell command to enumerate users with Application Impersonation.**\n\nTo remove unnecessary or overly-permissive Management Role Assignments, use the Remove-ManagementRoleAssignment\nPowerShell cmdlet.\n\n#### Detection\n\nOrganizations should monitor their Microsoft 365 tenant for the creation of new Management Role Assignments. This can be done by\ncreating rules to alert on the New-ManagementRoleAssignment operation and further filter for the assignment of the\nApplicationImpersonation role. In the average organization, the assignment of new Management Roles should be relatively uncommon.\nThis log artifact will record the user that created the new Management Role Assignment, the IP address, as well as details on the newly\ncreated role. Figure 44 shows a sample log event.\n\n\n-----\n\n```\n{\n \"CreationTime\": \"2021-02-11T13:52:47\",\n \"Id\": \"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\",\n \"Operation\": \"New-ManagementRoleAssignment\",\n \"OrganizationId\": \"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\",\n \"RecordType\": 1,\n \"ResultStatus\": \"True\",\n \"UserKey\": \"xxxxxxxxxxxxxxxx\",\n \"UserType\": 2,\n \"Version\": 1,\n \"Workload\": \"Exchange\",\n \"ClientIP\": \"1.1.1.1:12345\",\n \"ObjectId\": \"victim.onmicrosoft.com\\\\emailbackup-svc\",\n \"UserId\": \"echange-admin@victim.onmicrosoft.com\",\n \"AppId\": \"\",\n \"ClientAppId\": \"\",\n \"ExternalAccess\": false,\n \"OrganizationName\": \"victim.onmicrosoft.com\",\n \"OriginatingServer\": \"DM6PR07MB6683 (15.20.3846.027)\",\n \"Parameters\": [\n {\n \"Name\": \"Name\",\n \"Value\": \"emailbackup-svc\"\n },\n {\n \"Name\": \"Role\",\n \"Value\": \"ApplicationImpersonation\"\n },\n {\n \"Name\": \"User\",\n \"Value\": \"john.doe@victim.net\"\n }\n ]\n}\n\n```\n\n**FIGURE 44. Microsoft 365 log artifact recording the creation of a new Management Role Assignment.**\n\n\nWhen an account is using impersonation to access another\nmailbox or act as that user, Exchange Online permits the account\nto assume the identity of the impersonated mailbox. This means\nthat all actions performed using impersonation get recorded as\nbeing performed directly by the impersonated (target) user.\nThere is no log artifact in Exchange Online or Azure Active\nDirectory that records when impersonation is used. Instead, a\n```\nUserLoggedIn event is generated for the account that holds the\nApplicationImpersonation role and subsequent impersonated\n\n```\nactions get recorded as the impersonated user. There is no\ndifference between the “Actor” and the “Target Object”.\n\n\nIf the characteristics such as the IP address or user agent\nremain static throughout the duration of the activities, then you\nmay be able to identify impersonated activities by searching for\nthem across all Microsoft 365 logs. If your organization has E5\nadvanced audit enabled, the Mail Items Accessed events will\nrecord access to mail items using impersonation as owner\naccess. Interestingly, even though Mail Items Accessed should\nrecord a Session ID for each mail item access event,\nimpersonated events do not generate one. This may be a good\nindicator to find mail item access via impersonation; however,\nMandiant has not verified if other edge cases can cause the\nSession ID to be null.\n\n\n-----\n\n## Attack Technique: Leverage Administrative Access\n of Service Providers\n\n#### Delegated Administration Overview\n\n\nAzure AD tenants can be configured to have a partner relationship\nwith one or more Microsoft partners and resellers such as a Cloud\nService Provider (CSP). Azure AD accounts in the partner’s tenant\nmay have the Global Administrator and Helpdesk Administrator\nroles assigned within their customer’s Azure AD tenant - allowing\nthe partner to fully manage the Azure tenant, including all\nsubsequent accounts, resources, and subscriptions.\n\n\nMicrosoft refers to these mechanisms as either delegated\nadministration (when used for management of Microsoft 365 and\nAzure AD) or Administer On Behalf Of (AOBO) (when used for\nmanagement of Azure subscriptions). Accounts from the partner\ntenant use their own credentials to authenticate to the customer\ntenant to administer on behalf of the customer. The following\ntable shows the mapping of roles in a partner tenant to a role in a\ncustomer tenant with delegated permissions:\n\n|TABLE 3. Mapping of roles in a partner tena|ant to a role within their customer tenant.|Col3|Col4|\n|---|---|---|---|\n|Role in partner tenant|Exchange Online Role Group (customer tenant)|Azure AD Role (customer tenant)|Azure RBAC Role (customer tenant)|\n|Admin Agent|TenantAdmins_<number>|Global Administrator|Owner|\n|Helpdesk Agent|HelpdeskAdmins_<number>|Helpdesk Administrator|N/A|\n\n\n**TABLE 3. Mapping of roles in a partner tenant to a role within their customer tenant.**\n\n\n**Note: Azure AD role assignments to partner accounts are not visible in the Azure AD portal or when queried via Azure AD PowerShell. To find out if**\ndelegated administration privilege in Azure AD has been granted to the partner, go to Partner relationships page in the Microsoft 365 Admin Portal (see\nRemediation section below for details).\n\n\n#### Technique\n\nMandiant has observed APT29 targeting accounts of Microsoft\nCSPs that have a partner relationship established within their\ndownstream customer tenants. APT29 then used the\ncompromised partner accounts to obtain privileged access to the\nAzure AD tenant or Azure subscriptions of the CSP’s customers.\n\nOnce APT29 had obtained access to downstream customers of\nthe CSP, they continued with compromise of the tenant using a\nvariety of the other techniques described in this white paper.\nBecause the CSP has Global Admin permissions in the\ndownstream tenants, the threat actor has no restrictions on\npost-compromise actions.\n\n\n#### Detection\n\nThe Azure AD sign-in logs record sign-ins by partners who have\nbeen delegated administrative permissions. For enhanced\nvisibility of sign-in events initiated by partner organizations, the\nlogs can be filtered specific to the property of\n\"crossTenantAccessType\" matching \"serviceProvider\".\n\nTo view these sign-ins in the Azure Portal for the Azure AD\nsign-in logs, use the filter for ‘Cross-tenant access type: Service\nprovider’ on the ‘User-sign ins’ tab. This should be done for both\ninteractive and non-interactive sign-ins. (Figure 45).\n\n\n**FIGURE 45. Sign-in Log events from a service provider (image from**\n[https://www.microsoft.com/security/blog/2021/10/25/nobelium-targeting-delegated-administrative-privileges-to-facilitate-broader-attacks/)](https://www.microsoft.com/security/blog/2021/10/25/nobelium-targeting-delegated-administrative-privileges-to-facilitate-broader-attacks/)\n\n\n-----\n\nThe sign-in events will include the username and IP address from which the partner account authenticated. To identify additional\nactions performed by the partner, the sign-in logs can be further correlated with information contained within the Azure AD audit logs,\nunified audit log, and Azure activity logs.\n\n#### Remediation\n\nPartner relationships and their correlated access should be regularly reviewed and verified to ensure that the assigned scope of\npermissions are still required. This can be done in the Microsoft 365 Admin Portal:\n\n1. Sign in as a Global Administrator to the Microsoft 365 Admin Center, go to the Settings > Partner relationships page.\n\n2. On the Partner relationships page, select the row that contains the name of the partner that you want to review.\n\n3. Select the row that contains the name of the partner and review if the delegated administrator access is enabled and if the scope of\n\nprivileged access is necessary.\n\n4. If partner privileged access is not necessary, on the partner page, select Remove roles and select Yes in the dialog box.\n\nAlternatively, the following PowerShell commands can be used to list and verify the partner relationships:\n\n```\n# Retrieve a list of partner relationships\nConnect-MsolService\nGet-MsolPartnerInformation\n\n```\n\n**FIGURE 46. PowerShell commands to list partner relationships.**\n\n**Note: To get accurate output from the Get-MsolPartnerInformation cmdlet, it must be run with Global Administrator permissions.Partners with**\ndelegated administrative access to the tenant will have DapEnabled property set to “true”.\n\nAdditionally, the following PowerShell command can be leveraged to confirm that partner access to the tenant has been removed:\n\n```\n# Retrieve a list of role groups that contain a group from a partner tenant\nConnect-ExchangeOnline\nGet-RoleGroup | ? Capabilities -match Partner_Managed | ? Members -match PartnerRoleGroup\n\n```\n\n**FIGURE 47. PowerShell commands to enumerate role groups that contain a group form a partner tenant.**\n\nIf an organization owns Azure subscriptions, a partner organization may have Azure RBAC role assignments. These should be reviewed\nto ensure that partner's RBAC roles assignments match what is expected. This can be done in the Azure Management Portal:\n\n[1. Login to the Azure Portal (https://portal.azure.com)](https://portal.azure.com)\n\n2. Search for Subscriptions\n\n3. Select the subscription you wish to check\n\n4. Select Access control (IAM)\n\n5. Select the Role assignments tab\n\n6. Review all assignments to ensure they match expectations\n\nAlternatively, the following PowerShell commands can be used to list role assignments to Foreign Group objects within\na current subscription :\n\n```\n# Retrieve role assignments\nConnect-AzAccount\nGet-AzRoleAssignment | ? ObjectType -match ForeignGroup\n\n```\n\n**FIGURE 48. PowerShell commands to list Azure RBAC role assignments to a group from a partner tenant.**\n\n\n-----\n\n## Attack Technique: Disable Advanced Audit\n\n\n#### Licensing Overview\n\nMicrosoft 365 uses a variety of licensing models that control an\nindividual user’s access to services in the Microsoft 365 suite.\nThe licenses can also dictate security and compliance settings\nsuch as log retention and Mail Items Accessed logging with\nAdvanced Auditing. The most common licenses are E1, E3, and\n[E5; however, there are a slew of other license plans and granular](https://www.microsoft.com/en-us/licensing/product-licensing/microsoft-365-enterprise?rtc=1&activetab=m365-enterprise:primaryr5)\nadd-ons that make licensing very complex. Additionally, there\nare licenses for the overall Azure Active Directory tenant that\ndictate security and compliance features.\n\nFor a threat actor, one of the most troublesome logging features\n[is Purview Audit, formerly Advanced Audit. This feature,](https://docs.microsoft.com/en-us/microsoft-365/compliance/advanced-audit?view=o365-worldwide)\navailable with E5 licenses and certain add-ons, enables the Mail\nItems Accessed audit. Mail Items Accessed records the useragent string, timestamp, IP address and user each time a mail\nitem is accessed. The audit records any type of mail access\nwhether it is using the Graph API, Outlook, a browser or other\nmethodology. This is a critical log source to determine if a threat\nactor is accessing a particular mailbox, as well as to determine\nthe scope of exposure. It is the only way to effectively determine\naccess to a particular mailbox when the threat actor is using\ntechniques like Application Impersonation or the Graph API.\n\n#### Technique\n\nThe threat actor must first compromise an account with\npermissions to modify the licenses applied to the tenant or\nindividual users. The user account must have the User.\n```\nReadWrite.All graph API scope to modify user licenses.\n\n```\nMandiant has observed threat actors use Azure AD PowerShell\nas well as the Microsoft Administrator portal to modify user\nlicenses and disable the M365_ADVANCED_AUDIT license. This has\nthe effect of immediately disabling Mail Items Accessed logging\nfor the targeted user.\n\n\n#### Detection\n\nThe Azure AD Audit Log and Microsoft 365 Unified Audit Log\nrecord user license change events. When a user license is\nchanged Azure AD records two different Operations: “Update\nuser” and “Change User License.” Both operations are under the\nAzure Active Directory workload.\n\nThe “Change User License” event will record the identity that\nperformed the modification as well as the user it modified the\nlicense for. The log event will not record what aspect of the\nlicense that changed.\n\nThe \"Update User\" events record in detail the license\nmodifications that occurred; however, the Audit Log will record\nmultiple and potentially duplicative events for a single operation.\nThe details of the license modification are recorded in the\n```\nExtendedAttributes key of the log record. The value contains a\n\n```\nnested JSON object that has been string-escaped one or\nmultiple times, depending on the method used to view the log\nrecord. Mandiant has also observed that the nested object is not\nalways valid JSON, resulting in a parsing error. Within the\n```\nExtendedAttributes JSON object there will be several nested\n\n```\nobjects with GUIDs corresponding to the multiple license SKUs\nthat are applied to the modified user. These GUIDs can be\n[matched to the human readable values on Microsoft’s website.](https://docs.microsoft.com/en-us/azure/active-directory/enterprise-users/licensing-service-plan-reference)\nInvestigators should look for the subkey DisabledPlans, whose\nvalue is a list. This list will contain the GUIDs for the disabled\nlicenses for the user. In the case of Advanced Audit, the GUID is\n```\n2f442157-a11c-46b9-ae5b-6e39ff4e5849 Investigators should\n\n```\npay careful attention they are looking within the NewValues key\nof the JSON object and not the OldValue key. Figure 49 shows an\nexample Sentinel query to identify Update User operations\nwhere Advanced Audit is disabled. Figure 50 shows the relevant\nportion of the log record.\n\n\n-----\n\n```\nAuditLogs\n| where OperationName == \"Update user\" and AdditionalDetails has \"2f442157-a11c-46b9-ae5b-6e39ff4e5849\"\n\n```\n\n**FIGURE 49. Simple Sentinel query for disabled.**\n\n**FIGURE 50. Sample Update User additionalDetails.**\n\n#### Remediation\n\n[The Azure AD Investigator script, available from the Mandiant](https://github.com/mandiant/Mandiant-Azure-AD-Investigator)\nGitHub repository, contains a module that will output users with\nan E5 license applied but do not have advanced auditing enabled.\n\n\nIf the script is run with the right privileges, it can be used to\nenable Advanced Auditing. The Advanced Audit feature can also\nbe re-enabled (or disabled) via the Microsoft Admin Portal.\n\n\n-----\n\n## Microsoft 365 Hardening\n\nThis section contains hardening recommendations for Microsoft 365 that are associated with the attacker techniques described in this\nwhite paper. A comprehensive discussion on Microsoft 365 hardening is outside the scope of this white paper.\n\n**Step 1: Filter accounts synced to Azure Active Directory**\n\nOn-premises Active Directory users that are synced to Azure AD should follow the concept of least privilege. Only identities that\nutilize cloud services should be synced using AD Connect, and any accounts that are deemed to have a level of on-premises\npermissions should not be synced and assigned permissions in Azure AD. This can be accomplished using AD Connect sync filtering,\nwhere four options are available:\n\n- Filter by Domain\n\n- Filter by OU\n\n- Filter by Security Group\n\n- Filter by Attribute\n\n1. **Review Azure AD Sign-In logs**\n\nTo identify on-premises Active Directory users that do not utilize Azure AD, Azure AD Sign-in logs can be reviewed (Figure 51 - Figure 53).\n\n**Review user Azure AD Sign-ins by user UPN:**\n\n```\nConnect-AzureAD\nGet-AzureADAuditSignInLogs -Filter “UserPrincipalName eq <UPN>” | Select-Object UserPrincipalName,\nCreatedDateTime, AppDisplayName, AppId, IpAddress | Export-csv signins.csv -Append\n\n```\n\n**FIGURE 51. PowerShell command to review Azure AD sign-in logs to identify potentially dormant accounts by UPN.**\n\n**Review user Azure AD Sign- ins by Active Directory OU:**\n\n```\n#Export members of AD OU to CSV\nGet-ADUser -Filter * -SearchBase “<OU PATH>” | Select-object UserPrincipalName | Export-csv OUMembers.csv\n#Import CSV into variable\n$Users = Import-csv OUMembers.csv\n#Review OU member logins against Azure AD Sign-in logs\nConnect-AzureAD\nForeach ($user in $users) { $u = $user.UserPrincipalName Get-AzureADAuditSignInLogs -Filter “UserPrincipalName\neq ‘$u’” | Select-Object UserPrincipalName, CreatedDateTime, AppDisplayName, AppId, IpAddress | Export-csv\nsignins.csv -Append\n}\n\n```\n\n**FIGURE 52. PowerShell command to review Azure AD sign-in logs to identify potentially dormant accounts by UPN.**\n\n\n-----\n\n**Review user Azure AD Sign-ins by Active Directory Security Group:**\n\n```\n#Export members of AD Security Group to CSV\nGet-ADGroupMember -Identity <Group Name> -Recursive | Select-object UserPrincipalName | Export-csv\nGroupMembers.csv\n#Import CSV into variable\n$Users = Import-csv GroupMembers.csv\n#Review Group member logins against Azure AD Sign-in logs\nConnect-AzureAD\nForeach ($user in $users) { $u = $user.UserPrincipalName Get-AzureADAuditSignInLogs -Filter “UserPrincipalName\neq ‘$u’” | Select-Object UserPrincipalName, CreatedDateTime, AppDisplayName, AppId, IpAddress | Export-csv\nsignins.csv -Append\n}\n\n```\n\n**FIGURE 53. PowerShell commands to review Azure AD sign-in logs to identify potentially dormant accounts by security group association.**\n\n\n2. Configure filtering with Azure AD Connect\n\nFor more information regarding Azure AD Connect filtering,\nreference:\n[https://docs.microsoft.com/en-us/azure/active-directory/](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sync-configure-filtering)\n[hybrid/how-to-connect-sync-configure-filtering](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sync-configure-filtering)\n\n**Step 2: Limit Privileged Users to Trusted IPs**\n\nWhen privileged accounts are leveraged to access and administer\nMicrosoft 365 resources, connectivity from the accounts should\nonly be permissible from trusted locations, usually representing\npublic IP address blocks managed by an organization.\n\nTo Configure Trusted Networks:\n\n[1. Login to https://portal.azure.com > Azure Active Directory >](https://portal.azure.com)\n\nSecurity > Named Locations\n\n2. Click New Location\n\n3. Provide a Name and IP Ranges\n\na. Check Mark as Trusted location\n\n4. Select Save\n\n\n**Conditional Access Policy Configuration:**\n\n1. Under Security > Conditional Access\n\n2. Select New policy\n\na. Users and Groups > Include\n\ni. Select Directory Roles\n\n     - Check All Roles\n\nb. Users and Groups > Exclude\n\ni. Add Break-Glass Global Administrators\n\n     - Break-Glass Global Administrators should exempt\n\nfrom all CAPs in the event CAPs are not being\napplied as expected.\n\nc. Cloud apps or admins > Include\n\ni. Select All cloud apps\n\nd. Conditions > Locations\n\ni. Under Configure, select Yes\n\nii. Include > Any Location\n\niii. Exclude > select Locations > Choose newly added\n\nlocation\n\ne. Grant > Block Access\n\n**Note: Prior to enabling the policy, to prevent an account from being**\nlocked out of Microsoft 365, it is highly recommended to test the policy\nin Report-Only mode to ensure the configuration acts as expected.\n\nFor additional information related to conditional access policies,\nreference\n\n[• https://docs.microsoft.com/en-us/microsoft-365/security/](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/identity-access-policies?view=o365-worldwide)\n\n[office-365-security/identity-access-policies](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/identity-access-policies?view=o365-worldwide)\n\n[• https://docs.microsoft.com/en-us/azure/active-directory/](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/plan-conditional-access)\n\n[conditional-access/plan-conditional-access](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/plan-conditional-access)\n\n\n-----\n\n**Step 3: Enhance Mailbox Auditing**\n\nEnabling mailbox auditing for users will provide greater visibility into potentially suspicious activity. Mailbox auditing provides\norganizations with visibility related to logon events for mailboxes as well as specific actions that occurred based upon either the mailbox\nowner, delegate, or an administrator. With optimized audit logging in Microsoft 365, organizations are empowered to enhance detection,\nmonitoring, and investigative activities.\n\n1. **Review Mailbox Auditing Settings**\n\nTo verify mailbox auditing settings for configured mailboxes, the PowerShell command noted in Figure 54 can be leveraged.\n\n```\nConnect-ExchangeOnline\nGet-Mailbox -Resultsize Unlimited -Filter {(RecipientTypeDetails -eq “UserMailBox”) -and (SKUAssigned -eq\n“True”)} | Select userprincipalname, Audit* | export-csv EnableMailBoxAudtingSettings.csv\n\n```\n\n**FIGURE 54. PowerShell command to verify mailbox auditing settings.**\n\n2. **Enable Audit Status for all Mailboxes**\n\nTo enforce that mailbox audit logging is enabled for all mail accounts, the PowerShell command noted in Figure 55 can be leveraged.\n\n```\nConnect-ExchangeOnline\nGet-Mailbox -Resultsize Unlimited -Filter {(RecipientTypeDetails -eq “UserMailBox”) -and (SKUAssigned -eq\n“True”)} | Set-Mailbox -AuditEnabled $True\n\n```\n\n**FIGURE 55. PowerShell command to enforce mailbox auditing.**\n\n3. **Set Mailbox audit logging retention**\n\nAt a minimum, Mandiant recommends that auditing for mailbox audit logs be retained for at least 90 days. To enforce this\nconfiguration, the PowerShell command noted in Figure 56 can be leveraged.\n\n```\nConnect-ExchangeOnline\nGet-Mailbox -Resultsize Unlimited -Filter {(RecipientTypeDetails -eq “UserMailBox”) -and (SKUAssigned -eq\n“True”)} | Set-Mailbox -AuditLogAgeLimit 90\n\n```\n\n**FIGURE 56. PowerShell command to enforce a mailbox audit log retention period.**\n\n4. **Enable Verbose Mailbox Auditing Settings**\n\n**Note: Before applying verbose Mailbox Auditing settings, an organization should verify that their centralized log or SIEM platform can handle the**\nincreased logging volume.\n\n**Verbose E3 Licensing Auditing Settings**\n\nAt a minimum, the MailboxLogin action for the Owner Logon Type should be added to each mailbox’s audit settings.\n\nThe PowerShell command noted in Figure 57 will add the MailBoxLogin auditing setting to the AuditOwner logon type for each mailbox:\n\n```\nConnect-ExchangeOnline\nGet-Mailbox -Resultsize Unlimited -Filter {(RecipientTypeDetails -eq “UserMailBox”) -and (SKUAssigned -eq\n“True”)} | Set-Mailbox -AuditOwner @{Add=MailBoxLogin}\n\n```\n\n**FIGURE 57. PowerShell command to enforce a mailbox audit log retention period.**\n\n\n-----\n\nTo enable the highest level of logging available with E3 licensing, the PowerShell command noted in Figure 58 can be run on each mailbox\nto replace auditing settings for each logon type.\n\n```\nConnect-ExchangeOnline\nSet-Mailbox -Identity <UPN> `\n-AuditAdmin MoveToDeletedItems,SoftDelete,HardDelete,SendAs,SendOnBehalf,\nUpdateFolderPermissions,UpdateInboxRules,UpdateCalendarDelegation `\n-AuditDelegate MoveToDeletedItems,SoftDelete,HardDelete,SendAs,\nSendOnBehalf,UpdateFolderPermissions,UpdateInboxRules `\n-AuditOwner MoveToDeletedItems,SoftDelete,HardDelete,MailboxLogin,\nUpdateFolderPermissions,UpdateInboxRules,UpdateCalendarDelegation\n\n```\n\n**FIGURE 58. PowerShell command to replace auditing settings with optimized E3 settings for each logon type.**\n\n**Verbose E5 Licensing Audit Settings**\n\nE5 and E5 Compliance Add-on licensing includes the audit setting MailItemsAccessed. MailItemsAccessed is a reliable logging\nmechanism which replaces the MessageBind logging mechanism. For incident responders, having access to MailItemsAccessed events\nwill provide a better understanding of the scope and the depth of a potential compromise.\n\nMandiant recommends that MailItemsAccessed be enabled for all logon types for highly sensitive mailboxes. The PowerShell command\nnoted in Figure 59 will add the MailItemsAccessed audit setting for the AuditOwner, AuditDelegate, and AuditAdmin logon types for a\nspecific mailbox.\n\n```\nConnect-ExchangeOnline\nSet-Mailbox -Identity <UPN> -AuditOwner @{Add=MailItemsAccessed} -AuditDelegate @\n{Add=MailItemsAccessed} -AuditAudit @{Add=MailItemsAccessed}\n\n```\n\n**FIGURE 59. PowerShell command to add the MailItemsAccessed setting for the AuditOwner, AuditDelegate, and AuditAdmin logon types.**\n\nTo enable the highest level of logging available for E5 licensing, the PowerShell command noted in Figure 60 can be ran on each mailbox\nto replace auditing settings for each logon type.\n\n```\nConnect-ExchangeOnline\nSet-Mailbox -Identity <UPN> `\n-AuditAdmin MoveToDeletedItems,SoftDelete,HardDelete,SendAs,\nSendOnBehalf,UpdateFolderPermissions,UpdateInboxRules,\nUpdateCalendarDelegation,MailItemsAccessed `\n-AuditDelegate MoveToDeletedItems,SoftDelete,HardDelete,SendAs,\nSendOnBehalf,UpdateFolderPermissions,UpdateInboxRules,MailItemsAccessed `\n-AuditOwner MoveToDeletedItems,SoftDelete,HardDelete,MailboxLogin,\nUpdateFolderPermissions,UpdateInboxRules,UpdateCalendarDelegation, MailItemsAccessed\n\n```\n\n**FIGURE 60. PowerShell command to replace auditing settings with optimized E5 settings for each logon type.**\n\n**Note: If Microsoft releases new auditing settings, the new settings will not be automatically applied to mailboxes where custom audit settings have**\npreviously been configured. New auditing settings will need to be manually applied.\n\nFor more information regarding mailbox auditing, reference:\n[https://docs.microsoft.com/en-us/microsoft-365/compliance/enable-mailbox-auditing?view=o365-worldwid](https://docs.microsoft.com/en-us/microsoft-365/compliance/enable-mailbox-auditing?view=o365-worldwide\r)\n\n\n-----\n\n**Step 4: Review Azure Application and Service Principal Permissions**\n\nAzure applications and service principals can be granted access to protected resources in Microsoft 365. For example, a token can be\ngranted to allow a third-party application to read a user’s mailbox or download the contents of a user’s OneDrive account.\n\nOnce an application has been granted permissions, an attacker can utilize the application to access user accounts with little to no other\nsecurity controls. This is commonly leveraged by attackers since they can bypass MFA requirements and maintain persistence to\ntargeted employee’s data.\n\nFor this reason, it is important to have visibility over which applications have been granted OAuth access to user accounts within the tenant.\n\n1. **Run Create-AppConsentGrantReport.ps1 Script**\n\nCreate-AppConsentGrantReport.ps1 is an open-source PowerShell script that will enumerate all permission grants for all\napplications in a Microsoft 365 tenant. This output can then be reviewed to identify overly permissive and suspicious applications.\n\n```\nConnect-AzureAD\n.\\Create-AppConsentGrantReport.ps1 -AdminUPN\n\nglobalreader@contoso.onmicrosoft.com -Path .\\output.xlsx\n\n```\n\n**FIGURE 61. PowerShell command to execute the Create-AppConsentGraphReport.ps1 script - enumerate all permission grants for all applications.**\n\nMany applications have legitimate use cases that warrant permissive access to applications (email applications and cloud-based\ncollaboration platforms) in a Microsoft 365 tenant. The output from this script report should be thoroughly reviewed to determine\nwhich applications can be removed from the tenant or have their privileges reduced.\n\n2. **Apply Application Access Policies**\n\nFor applications that are granted the ‘Application’ Consent Type for mail permissions (Mail.Read,Mail.Send,Mail.ReadWrite,Mail.\nReadBasic,Mail.ReadBasic.All), these applications are granted the rights to all mailboxes in the tenant, without needing specific\naccount credentials to access a mailbox. Applications assigned these permissions can be reviewed by filtering the PermissionType\ncolumn by Application on the ConsentGrantData tab generated within the Create-AppConsentGrantReport report (Figure 62).\n\n**FIGURE 62. Output to review assigned application permissions.**\n\nWhile some legitimate applications require this privilege grant, they commonly do not need access to every mailbox. To limit which\nmailboxes the application can access, it is recommended to apply an Application Access Policy to the application.\n\nFor more information on configuration Application Access Policies, reference:\n[https://docs.microsoft.com/en-us/powershell/module/exchange/new-applicationaccesspolicy?view=exchange-ps](https://docs.microsoft.com/en-us/powershell/module/exchange/new-applicationaccesspolicy?view=exchange-ps)\n\n\n-----\n\n3. **Require Admin Consent to Apps**\n\n[• Login to https://portal.azure.com](https://portal.azure.com)\n\n  - Select Enterprise Applications\n\n  - Select User Settings\n\n  - Set Users can consent to apps accessing company on their\n\nbehalf to No\n\n  - Users can consent to apps accessing company data for the\n\ngroups they own to No\n\n  - Set Users can request admin consent to apps they are\n\nunable to consent to No\n\n  - Select Consent and permissions\n\n  - Under User Consent for Applications select Do not allow\n\nuser consent\n\n  - Under Group owner consent for apps accessing data select\n\nDo not allow group owner consent\n\nFor more information regarding illicit application consent\n[grants, reference: https://docs.microsoft.com/en-us/](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants?view=o365-worldwide)\n[microsoft-365/security/office-365-security/detect-and-](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants?view=o365-worldwide)\n[remediate-illicit-consent-grants?view=o365-worldwide](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants?view=o365-worldwide)\n\n**Step 5: Enforce multi-factor authentication (MFA)**\n**for Accounts**\n\nTo protect against attacks that take advantage of single factor\nauthentication for access to Microsoft 365 services, MFA should\nbe enforced for all accounts with access to a Microsoft 365 tenant.\nAt a minimum, MFA should be used for administrative access to a\nMicrosoft 365 tenant, including when Exchange Online and Azure\nAD PowerShell management functionality is required.\n\nFor smaller organizations that need a quick baseline of enabled\nsecurity settings (including MFA enforcement and blocking\nlegacy authentication protocols) to create a hardened security\nposture for Microsoft 365, the grouping of settings known as\n[“Security Defaults” should be considered. Security Defaults are](https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/concept-fundamentals-security-defaults)\nfree (available at any tier) and replace the older and deprecated\nbaseline policies.\n\n\nSome notes and caveats when using Security Defaults:\n\n- If Conditional Access policies are currently being leveraged\n\n(Azure AD Premium P1 license), Security Defaults should not be\nused.\n\n- If an organization has complex security requirements,\n\nConditional Access policies should be used over Security\nDefaults.\n\n- If an organization has Azure Active Directory Premium\n\nlicenses, Security Defaults should not be used.\n\n- If an organization uses Security Defaults and then decides to\n\nmigrate to using Conditional Access policies, Security Defaults\nwill first need to be disabled.\n\n**Step 6: Review all registered MFA devices**\n\nAs a proactive best practice, organizations should develop a\nprocess to perform periodic reviews of all registered MFA\ndevices to identify any potentially malicious registrations. For\nany devices that do not align to an expected registration, this\nprocess may potentially require re-enrollment for privileged\nand/or user-based accounts.\n\n**Note: This process should also include reviewing any accounts that can**\nbypass MFA requirements, to include evaluating the operational impact\nand associated risk of leveraging such a configuration.\n\nThe PowerShell script syntax noted in Figure 63 can be used to\ngenerate a report of MFA devices registered with Azure AD.\n\n\n-----\n\n```\nConnect-MsolService\n$Result=@()\n$users = Get-MsolUser -All\n$users | ForEach-Object {\n$user = $_\n$mfaStatus = $_.StrongAuthenticationRequirements.State\n$phoneApp = $_.StrongAuthenticationPhoneAppDetails\n$methodTypes = $_.StrongAuthenticationMethods\nif ($mfaStatus -ne $null -or $methodTypes -ne $null)\n{\nif($mfaStatus -eq $null)\n{\n$mfaStatus=’Enabled (Conditional Access)’\n}\n$authMethods = $methodTypes.MethodType\n$defaultAuthMethod = ($methodTypes | Where{$_.IsDefault -eq “True”}).MethodType\n$verifyEmail = $user.StrongAuthenticationUserDetails.Email\n$phoneNumber = $user.StrongAuthenticationUserDetails.PhoneNumber\n$alternativePhoneNumber = $user.StrongAuthenticationUserDetails.AlternativePhoneNumber\n}\nElse\n{\n$mfaStatus = “Disabled”\n$defaultAuthMethod = $null\n$verifyEmail = $null\n$phoneNumber = $null\n$alternativePhoneNumber = $null\n}\n$Result += New-Object PSObject -property @{\nUserName = $user.DisplayName\nUserPrincipalName = $user.UserPrincipalName\nMFAStatus = $mfaStatus\nAuthenticationMethods = $authMethods\nDefaultAuthMethod = $defaultAuthMethod\nMFAEmail = $verifyEmail\nPhoneNumber = $phoneNumber\nAlternativePhoneNumber = $alternativePhoneNumber\nDeviceName = $phoneApp.DeviceName\n}\n}\n$Result | Select UserName,UserPrincipalName,MFAStatus,DefaultAuthMethod,MFAEmail,\nPhoneNumber,AlternativePhoneNumber,DeviceName | export-csv MFAReport.CSV\n\n```\n\n**FIGURE 63. PowerShell script to identify all MFA devices registered with Azure AD.**\n\n\n-----\n\n**Step 7: Review Partner (Cloud Service Provider) Relationships**\n\nOrganizations should review any configured partner relationships that exist within a Microsoft 365 tenant. Partner relationships can\nexist as various partner types, including resellers, advisors and delegated administrators.\n\nThe scope of permissions assigned to partners should be reviewed and verified – as partners can exist as Global Admin or Helpdesk\nAdmin roles. Delegated admin roles (Admin Agents and Helpdesk Agents) are also available when partner relationships are present.\nBased on the roles assigned, members of either groups can access the customer’s Azure AD tenant and Microsoft 365 services using\ntheir partner credentials and perform administrative actions on behalf of the customer.\n\n[Per Microsoft, when a customer grants delegated administration privileges to a partner:](https://docs.microsoft.com/en-us/partner-center/customers-revoke-admin-privileges)\n\n- The Admin Agent group is assigned to the Global Administrator role in the customer’s Azure AD tenant.\n\n- The Helpdesk Agent group is assigned to the Helpdesk Administrator role in the customer’s Azure AD tenant.\n\n1. **Review Microsoft 365 Partner Relationships that have Delegated Admin Privileges**\n\n[• Option 1: Navigate to https://admin.microsoft.com/AdminPortal/Home#/partners within the in Microsoft 365 Admin Center.](https://admin.microsoft.com/AdminPortal/Home#/partners)\n\n  - Option 2: Using PowerShell, review any present DapEnabled values using the Get-MsolPartnerInformation command\n\n2. **Remove DapEnabled Cloud Service Provider Delegated Admin Privileges**\n\nAny cloud service provider delegated administrative privileges should be reviewed and potentially removed. Proactively,\nan organization would want assurance from the cloud service provider that the provider’s network and Microsoft 365 tenant are\nsecured and hardened appropriately.\n\n## Conclusion\n\n[While APT29 has demonstrated a level of sophistication and evasiveness, the observed techniques are both detectable and defensible.](https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html)\nThis white paper outlines steps that represent actionable measures that can be leveraged to not only remediate observed techniques,\nbut also to empower organizations to detect and harden against similar tactics.\n\nAs new information is derived from Mandiant’s frontline visibility, this white paper will be updated with additional techniques and the\nassociated detection, remediation and hardening measures.\n\n###### Learn more at www.mandiant.com\n\n\n**Mandiant**\n11951 Freedom Dr, 6th Fl, Reston, VA 20190\n(703) 935-1700\n833.3MANDIANT (362.6342)\ninfo@mandiant.com\n\n\n**About Mandiant**\nSince 2004, Mandiant® has been a trusted partner to security-conscious\norganizations. Today, industry-leading Mandiant threat intelligence and\nexpertise drive dynamic solutions that help organizations develop more\neffective programs and instill confidence in their cyber readiness.\n\n\n-----\n\n|TABLE 4. Change log|g.|Col3|Col4|\n|---|---|---|---|\n|Publish Date|Document Version|Affected Page(s)|Description|\n|01/19/2021|v1.0|n/a|Original publication|\n|3/18/2021|v1.1|5,6,17,33-37|• Improved directions to detect read attempts of ADFS token-signing attribute • Added new attack technique: Modify Mailbox Folder Permissions|\n|10/28/2021|v1.2|5, 6, 39-43|• Added new attack technique: Application Impersonation • Added new attack technique: Leverage Administrative Access of Service Providers|\n|8/5/2022|v1.3|4-6, 43-44|• Added new attack technique: Disable Advanced Audit|\n\n\n**TABLE 4. Change log.**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://www.mandiant.com/sites/default/files/2022-08/remediation-hardening-strategies-for-m365-defend-against-apt29-white-paper.pdf"
    ],
    "report_names": [
        "remediation-hardening-strategies-for-m365-defend-against-apt29-white-paper.pdf"
    ],
    "threat_actors": [
        {
            "id": "b43e5ea9-d8c8-4efa-b5bf-f1efb37174ba",
            "created_at": "2022-10-25T16:07:24.36191Z",
            "updated_at": "2025-03-27T02:02:10.1909Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "Dark Halo",
                "Nobelium",
                "SolarStorm",
                "StellarParticle",
                "UNC2452"
            ],
            "source_name": "ETDA:UNC2452",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "70872c3a-e788-4b55-a7d6-b2df52001ad0",
            "created_at": "2023-01-06T13:46:39.18401Z",
            "updated_at": "2025-03-27T02:00:03.01553Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "DarkHalo",
                "StellarParticle",
                "NOBELIUM",
                "Solar Phoenix",
                "Midnight Blizzard"
            ],
            "source_name": "MISPGALAXY:UNC2452",
            "tools": [
                "SNOWYAMBER",
                "HALFRIG",
                "QUARTERRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1d3f9dec-b033-48a5-8b1e-f67a29429e89",
            "created_at": "2022-10-25T15:50:23.739197Z",
            "updated_at": "2025-03-27T02:00:55.536417Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "UNC2452",
                "NOBELIUM",
                "StellarParticle",
                "Dark Halo"
            ],
            "source_name": "MITRE:UNC2452",
            "tools": [
                "Sibot",
                "Mimikatz",
                "Cobalt Strike",
                "AdFind",
                "GoldMax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "5b748f86-ac32-4715-be9f-6cf25ae48a4e",
            "created_at": "2024-06-04T02:03:07.956135Z",
            "updated_at": "2025-03-27T02:05:17.407352Z",
            "deleted_at": null,
            "main_name": "IRON HEMLOCK",
            "aliases": [
                "ATK7 ",
                "Blue Kitsune ",
                "Cozy Bear ",
                "The Dukes",
                "UNC2452 ",
                "YTTRIUM ",
                "APT29 "
            ],
            "source_name": "Secureworks:IRON HEMLOCK",
            "tools": [
                " CozyCar",
                " CozyDuke",
                " DiefenDuke",
                " FatDuke",
                " HAMMERTOSS",
                " LiteDuke",
                " MiniDuke",
                " OnionDuke",
                " PolyglotDuke",
                " RegDuke",
                " RegDuke Loader",
                " SeaDuke",
                " Sliver",
                "CosmicDuke"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a241a1ca-2bc9-450b-a07b-aae747ee2710",
            "created_at": "2024-06-19T02:03:08.150052Z",
            "updated_at": "2025-03-27T02:05:17.409596Z",
            "deleted_at": null,
            "main_name": "IRON RITUAL",
            "aliases": [
                "Blue Dev 5 ",
                "BlueBravo ",
                "Cloaked Ursa ",
                "CozyLarch ",
                "Dark Halo ",
                "Midnight Blizzard ",
                "NOBELIUM ",
                "StellarParticle ",
                "UNC2452 ",
                "APT29"
            ],
            "source_name": "Secureworks:IRON RITUAL",
            "tools": [
                " Cobalt Strike",
                " EnvyScout",
                " GoldFinder",
                " GoldMax",
                " NativeZone",
                " RAINDROP",
                " SUNBURST",
                " Sibot",
                " TEARDROP",
                " VaporRage",
                "Brute Ratel C4"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "46b3c0fc-fa0c-4d63-a38a-b33a524561fb",
            "created_at": "2023-01-06T13:46:38.393409Z",
            "updated_at": "2025-03-27T02:00:02.822155Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "The Dukes",
                "Minidionis",
                "Grizzly Steppe",
                "G0016",
                "Blue Kitsune",
                "BlueBravo",
                "SeaDuke",
                "Cloaked Ursa",
                "YTTRIUM",
                "ATK7",
                "Nobelium",
                "UAC-0029",
                "Group 100",
                "COZY BEAR",
                "IRON HEMLOCK",
                "TA421",
                "ITG11"
            ],
            "source_name": "MISPGALAXY:APT29",
            "tools": [
                "QUARTERRIG",
                "SNOWYAMBER",
                "HALFRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f27790ff-4ee0-40a5-9c84-2b523a9d3270",
            "created_at": "2022-10-25T16:07:23.341684Z",
            "updated_at": "2025-03-27T02:02:09.74554Z",
            "deleted_at": null,
            "main_name": "APT 29",
            "aliases": [
                "APT 29",
                "ATK 7",
                "Blue Dev 5",
                "BlueBravo",
                "Cloaked Ursa",
                "CloudLook",
                "Cozy Bear",
                "Dark Halo",
                "Earth Koshchei",
                "Grizzly Steppe",
                "Group 100",
                "ITG11",
                "Iron Hemlock",
                "Iron Ritual",
                "Midnight Blizzard",
                "Minidionis",
                "Nobelium",
                "NobleBaron",
                "Operation Ghost",
                "Operation Office monkeys",
                "Operation StellarParticle",
                "SilverFish",
                "Solar Phoenix",
                "SolarStorm",
                "StellarParticle",
                "TEMP.Monkeys",
                "The Dukes",
                "UNC2452",
                "UNC3524",
                "Yttrium"
            ],
            "source_name": "ETDA:APT 29",
            "tools": [
                "7-Zip",
                "ATI-Agent",
                "AdFind",
                "Agentemis",
                "AtNow",
                "BEATDROP",
                "BotgenStudios",
                "CEELOADER",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobalt Strike",
                "CobaltStrike",
                "CosmicDuke",
                "Cozer",
                "CozyBear",
                "CozyCar",
                "CozyDuke",
                "Danfuan",
                "EnvyScout",
                "EuroAPT",
                "FatDuke",
                "FoggyWeb",
                "GeminiDuke",
                "Geppei",
                "GoldFinder",
                "GoldMax",
                "GraphDrop",
                "GraphicalNeutrino",
                "GraphicalProton",
                "HAMMERTOSS",
                "HammerDuke",
                "LOLBAS",
                "LOLBins",
                "LiteDuke",
                "Living off the Land",
                "MagicWeb",
                "Mimikatz",
                "MiniDionis",
                "MiniDuke",
                "NemesisGemina",
                "NetDuke",
                "OnionDuke",
                "POSHSPY",
                "PinchDuke",
                "PolyglotDuke",
                "PowerDuke",
                "QUIETEXIT",
                "ROOTSAW",
                "RegDuke",
                "Rubeus",
                "SNOWYAMBER",
                "SPICYBEAT",
                "SUNSHUTTLE",
                "SeaDaddy",
                "SeaDask",
                "SeaDesk",
                "SeaDuke",
                "Sharp-SMBExec",
                "SharpView",
                "Sibot",
                "Solorigate",
                "SoreFang",
                "TinyBaron",
                "WINELOADER",
                "WellMail",
                "WellMess",
                "cobeacon",
                "elf.wellmess",
                "reGeorg",
                "tDiscoverer"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1682474965,
    "ts_updated_at": 1743041794,
    "ts_creation_date": 1660799666,
    "ts_modification_date": 1660799672,
    "files": {
        "pdf": "https://archive.orkl.eu/c55442b94248847e9fd978361486a86daa76b7b5.pdf",
        "text": "https://archive.orkl.eu/c55442b94248847e9fd978361486a86daa76b7b5.txt",
        "img": "https://archive.orkl.eu/c55442b94248847e9fd978361486a86daa76b7b5.jpg"
    }
}