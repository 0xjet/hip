{
    "id": "07f282ce-d276-4005-978f-ec8ffaf5f85a",
    "created_at": "2023-01-12T15:05:03.533303Z",
    "updated_at": "2025-03-27T02:17:15.043758Z",
    "deleted_at": null,
    "sha1_hash": "7d686d424f35d941bdaa26a9b378efcc8ffc57d7",
    "title": "2020-03-16 - Shadows in the Rain",
    "authors": "",
    "file_creation_date": "2022-05-27T19:01:46Z",
    "file_modification_date": "2022-05-27T19:01:46Z",
    "file_size": 94999,
    "plain_text": "# Shadows in the Rain\n\n**[medium.com/insomniacs/shadows-in-the-rain-a16efaf21aae](https://medium.com/insomniacs/shadows-in-the-rain-a16efaf21aae)**\n\nasuna amawaka March 16, 2020\n\nasu\nna\n\n\n[asuna amawaka](https://medium.com/@asuna.amawaka?source=post_page-----a16efaf21aae--------------------------------)\n\nMar 16, 2020\n\n\n6 min read\n\nWhen I read Trend Micro’s report on Operation DRBControl[1] in February, one detail stood out\nand piqued my curiosity — there were 3 mutexes connecting a Trochilus RAT sample in the\nincident and a BBSRAT sample that uses a C2 domain linked to the Winnti Group. This came\nas a surprise to me, because I thought BBSRAT was a unique malware family, a “new tool”\nback in 2015 that was attributed by Palo Alto Networks to the attacker group Roaming Tiger.\nThere seem to be no news on BBSRAT all these years, and now when it is mentioned again, it\nis linked to Winnti Group? Interesting.\n\nIs that really a BBSRAT? Only 1 way to find out — analyse it!\n\n**Finding the samples to work on**\n\nMutexes:\n\ncc5d64b344700e403e2sse\n\ncc5d6b4700e403e2sse\n\ncc5d6b4700032eSS\n\nC2:\n\nbot[.]googlerenewals[.]net\n\nLooking up the C2 domain on Virustotal quickly surfaced 3 samples that exhibited callbacks to\nthis C2, and these samples are just the ones we are looking for: they contain the said mutexes!\nThese samples make a copy of itself as diskshadow.exe on disk (a name that is close to\n“diskwinshadow.exe” that is the BBSRAT mentioned in Trend Micro’s report).\n\nThese are self-extracting files that contain other executables within:\n\n\n-----\n\nLet’s jump straight into finding out what these “rain.sdb” are, since they are the meat of the\nmalware.\n\n\n-----\n\nFirst, they are encoded with a simple inversion, then XOR 0x5. Reversing this encoding would\nget us an -almost- perfect PE file, just alter the first two bytes to the correct Magic header. This\nsimple trick of obfuscating the magic header could have been intended to fool signature\nmatching defenses.\n\n\n-----\n\nAfter decoding, we get three unique rain.sdb files. Notice how the two 64-bit files have the\nsame XOR key in their RICH header despite them having different hashes. Assuming that the\nRICH header has not been tampered with, this means that they have the source code and\ncompilation environment. This is not surprising, considering the close compilation timestamps\nthey have.\n\n\n-----\n\nFor the rest of this post, I’ll focus on findings using the file with MD5\n368B555321F56699D2431A3908D52487.\n\nTo start off, let’s take a look at some of the interesting stuff this sample does.\n\n**Hide, hide, hide!**\n\nSince the malware comes in a typical trio — legitimate executable, rogue DLL loaded via loadorder hijacking and malicious payload, I expect to see some kind of injection to happen. True\nenough, callback activities are conducted under the cover of msiexec.exe. There are also other\nchoices of processes for injection, perhaps used in other variants of this sample. Notice this is\nwhere the mutex is created.\n\n\n-----\n\nContents from either the file rain.sdb or regkey “HKCU\\M\\M” are also injected into a created\ncmd.exe.\n\n\n-----\n\nPersistency is achieved through services, a different mutex is created to “mark” that the service\nhas already been created.\n\n\n-----\n\nThe malware also comes with a feature that replaces “InternalGetTcpTable2” in IPHLPAPI.DLL,\nin an attempt to hide the C2 connection when a netstat is done.\n\n**Leave that door open!**\n\nThis sample abused Windows’ Bitsadmin utility to execute any powershell script of the\nattacker’s choice — all he needs to do is to write the powershell commands into the regkey\nHKCU:/M/S, and the BITS job will execute the command as part of the “notification process”\nafter the job is completed (In this case, the job is the copying of mshta.exe). This job will be\nexecuted periodically, and it can stay in the system for 90 days[3] even after the malware has\nbeen cleaned up.\n\nThis is not a groundbreaking trick, though not commonly seen. According to MITRE ATT&CK’s\ndatabase, this persistency technique (T1197[4]) has been observed in malware such as\n_UBOATRAT._\n\n\n-----\n\n**BB phones home**\n\nThe sample accepts the following commands:\n\n\n-----\n\nThe sample sends data to the C2 in the following structure:\n\n\n-----\n\nThe algorithm used for compression is standard ZLIB v1.1.4.\n\n**Yes! That’s a !**\n\nLooking at the C2 commands supported, as well as the structure of the data communicated\nto/fro the C2, they bear strong similarities with the set of BBSRAT analyzed by Palo Alto\nNetworks in 2015.\n\nFurthermore, there are direct code overlaps/resemblance with one of the BBSRAT sample\n(MD5 8CD233D3F226CB1BF6BF15ACA52E0E36). Some of them are as follows:\n\n\n-----\n\nLeft: rain.sdb; Right: BBSRAT (Code logic that performs regular beaconing)\n\n\n-----\n\nLeft: rain.sdb; Right: BBSRAT (Code that receives and decompress data from C2)\n\n\n-----\n\nLeft: rain.sdb; Right: BBSRAT (Switch code that acts upon different C2 commands)\nOne obvious difference lies in the communications with the C2: the 2015 BBSRATs’ beacons\nare HTTP requests (POST with data) that gave it its name (the beacons go to URL with the\npattern /bbs/#/forum.php?sid=#); the rain.sdb sample analyzed does not do the HTTP requests,\nbut instead send the compressed data directly to the C2 (on port 53). It may be likely that the\nchange in port and the omission of communication “wrapper” is intentional to fool network\nsignatures that look out for the suspicious URL. It is unknown however, if the backend BBSRAT\nsupported port 53 all along, or it had been upgraded after 3 years.\n\n**Gh0stly shadows**\n\nWhile doing the analysis of the samples, I’ve noticed some code overlap with another wellknown RAT: the Gh0stRAT. Gh0stRAT is also listed as one of the tools used by the Winnti\n**Group, though it is also known to be used by many other actors since its source code is readily**\navailable online. The overlaps are observed from the following file:\n\n\n-----\n\nF0AB7E27B8DE336B14C8756E6CD41CEA rain.sdb\n\nThere are two modules within the sample that contains code highly similar to Gh0StRAT, one is\nscreencapture (mapped to functions within “ScreenSpy” and “ScreenManager” in Gh0stRAT)\nand the other is shell (mapped to functions within “ShellManager”).\n\nTwo modules’ within rain.sdb that uses Gh0stRAT code\n\n\n-----\n\nLeft: rain.sdb; Right Gh0stRAT 3.6 Source Code Screenspy.cpp\n\n\n-----\n\nLeft: rain.sdb; Right Gh0stRAT 3.6 Source Code Screenspy.cpp\n\n\n-----\n\nLeft: rain.sdb; Right Gh0stRAT 3.6 Source Code ShellManager.cpp\nThere is also a constructor that seem to come from Gh0stRAT’s source code:\n\n\n-----\n\nLeft: rain.sdb; Right Gh0stRAT 3.6 Source Code CursorInfo.h\n**Last Words**\n\nJudging based on the C2 callback and commands, the rain.sdb payloads are definitely a variant\nof BBSRAT. Perhaps the name BBSRAT is now not as descriptive as it was in 2015, since the\ncallbacks are no longer HTTP requests to URLs resembling bbs forums.\n\nI was not able to find samples from the Winnti Group that contain the mutexes mentioned by\nTrend Micro, if anyone has any of such samples please feel free to contact me;) I’ll be happy to\nbe able to do a matching to see if the binaries share any code!\n\nReferences:\n\n\n-----\n\n[1] Operation DRBControl: Uncovering a Cyberespionage Campaign Targeting Gambling\nCompanies in Southeast Asia”, Trend Micro, 18 Feb 2020\n\n[2] “BBSRAT Attacks Targeting Russian Organizations Linked to Roaming Tiger”, Palo Alto\nNetworks, 22 Dec 2015\n\n[3] “Best Practices When Using BITS”, docs.microsoft.com/en-us/windows/win32/bits/bestpractices-when-using-bits\n\n[4] “T1197 BITS Jobs”, attack.mitre.org/techniques/T1197\n\n~~\n\n## Asuna\n\n### The latest Tweets from Asuna (@AsunaAmawaka). [Malware Analyst]. Binary World\n\ntwitter.com\n\nDrop me a DM if you would like to share findings or samples ;)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-03-16 - Shadows in the Rain.pdf"
    ],
    "report_names": [
        "2020-03-16 - Shadows in the Rain.pdf"
    ],
    "threat_actors": [
        {
            "id": "5afe7b81-e99a-4c24-8fcc-250fb0cf40a3",
            "created_at": "2023-01-06T13:46:38.324616Z",
            "updated_at": "2025-03-27T02:00:02.805194Z",
            "deleted_at": null,
            "main_name": "Roaming Tiger",
            "aliases": [
                "BRONZE WOODLAND",
                "Rotten Tomato"
            ],
            "source_name": "MISPGALAXY:Roaming Tiger",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5bbced13-72f7-40dc-8c41-dcce75bf885e",
            "created_at": "2022-10-25T15:50:23.695735Z",
            "updated_at": "2025-03-27T02:00:55.525839Z",
            "deleted_at": null,
            "main_name": "Winnti Group",
            "aliases": [
                "Winnti Group"
            ],
            "source_name": "MITRE:Winnti Group",
            "tools": [
                "PipeMon",
                "Winnti for Windows",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "866c0c21-8de3-4ad5-9887-cecd44feb788",
            "created_at": "2022-10-25T16:07:24.130298Z",
            "updated_at": "2025-03-27T02:02:10.117603Z",
            "deleted_at": null,
            "main_name": "Roaming Tiger",
            "aliases": [
                "Bronze Woodland",
                "CTG-7273",
                "Rotten Tomato"
            ],
            "source_name": "ETDA:Roaming Tiger",
            "tools": [
                "Agent.dhwf",
                "AngryRebel",
                "BBSRAT",
                "Destroy RAT",
                "DestroyRAT",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "Kaba",
                "Korplug",
                "Moudour",
                "Mydoor",
                "PCRat",
                "PlugX",
                "RedDelta",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Xamtrav"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "945a572f-ebe3-4e2f-a288-512fe751cfa8",
            "created_at": "2022-10-25T16:07:24.413971Z",
            "updated_at": "2025-03-27T02:02:10.212853Z",
            "deleted_at": null,
            "main_name": "Winnti Group",
            "aliases": [
                "Wicked Panda",
                "Winnti Group"
            ],
            "source_name": "ETDA:Winnti Group",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "FunnySwitch",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "9bf42584-ca17-47de-a902-3dd63d90b2f8",
            "created_at": "2024-05-01T02:03:08.005172Z",
            "updated_at": "2025-03-27T02:05:17.300423Z",
            "deleted_at": null,
            "main_name": "BRONZE WOODLAND",
            "aliases": [
                "Roaming Tiger ",
                "Rotten Tomato ",
                "CTG-7273 "
            ],
            "source_name": "Secureworks:BRONZE WOODLAND",
            "tools": [
                " PlugX",
                " Zbot",
                "Appat"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "4c68ccd0-caba-4189-9ead-86ac4c2d9b70",
            "created_at": "2024-05-01T02:03:07.930196Z",
            "updated_at": "2025-03-27T02:05:17.251237Z",
            "deleted_at": null,
            "main_name": "BRONZE ATLAS",
            "aliases": [
                "Axiom",
                "BARIUM ",
                "Blackfly ",
                "CTG-2633",
                "GREF",
                "Group 72 ",
                "Red Kelpie ",
                "TG-2633 ",
                "Wicked Panda ",
                "Winnti",
                "APT41 "
            ],
            "source_name": "Secureworks:BRONZE ATLAS",
            "tools": [
                " CCleaner v5.33 backdoor",
                " ChinaChopper",
                " Cobalt Strike",
                " Dicey MSDN",
                " ForkPlayground",
                " HUC Proxy Malware (Htran)",
                " Mimikatz",
                " PipeMon",
                " PlugX",
                " PortReuse",
                " Powershell Empire",
                " RCMD",
                " RbDoor",
                " SPEEDBOAT",
                " ShadowPad",
                " Sidewalk",
                " Speculoos",
                " TeamViewer",
                " Winnkit",
                " Winnti",
                " reg save",
                " vssadmin",
                "Acehash"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "5c13338b-eaed-429a-9437-f5015aa98276",
            "created_at": "2022-10-25T16:07:23.582715Z",
            "updated_at": "2025-03-27T02:02:09.875151Z",
            "deleted_at": null,
            "main_name": "Emissary Panda",
            "aliases": [
                "APT 27",
                "ATK 15",
                "Bronze Union",
                "Budworm",
                "Earth Smilodon",
                "Emissary Panda",
                "Group 35",
                "Iron Taurus",
                "Iron Tiger",
                "LuckyMouse",
                "Operation DRBControl",
                "Operation Iron Tiger",
                "Operation PZChao",
                "Operation SpoiledLegacy",
                "Operation StealthyTrident",
                "Red Phoenix",
                "TEMP.Hippo",
                "TG-3390",
                "ZipToken"
            ],
            "source_name": "ETDA:Emissary Panda",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Agent.dhwf",
                "AngryRebel",
                "Antak",
                "CHINACHOPPER",
                "China Chopper",
                "Destroy RAT",
                "DestroyRAT",
                "FOCUSFJORD",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HTTPBrowser",
                "HTran",
                "HUC Packet Transmit Tool",
                "HighShell",
                "HttpBrowser RAT",
                "HttpDump",
                "HyperBro",
                "HyperSSL",
                "HyperShell",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "Nishang",
                "OwaAuth",
                "PCRat",
                "PlugX",
                "ProcDump",
                "PsExec",
                "RedDelta",
                "SEASHARPEE",
                "Sensocode",
                "SinoChopper",
                "Sogu",
                "SysUpdate",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Token Control",
                "TokenControl",
                "TwoFace",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Xamtrav",
                "ZXShell",
                "gsecdump",
                "luckyowa"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e254cf33-e7f5-407b-a8a1-1a856a9f1c71",
            "created_at": "2025-01-21T02:00:03.599871Z",
            "updated_at": "2025-03-27T02:00:03.480307Z",
            "deleted_at": null,
            "main_name": "Operation DRBControl",
            "aliases": [],
            "source_name": "MISPGALAXY:Operation DRBControl",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6d2910b0-9fea-46a2-84e6-a043b1e023e4",
            "created_at": "2022-10-25T16:07:23.946958Z",
            "updated_at": "2025-03-27T02:02:10.044112Z",
            "deleted_at": null,
            "main_name": "Operation DRBControl",
            "aliases": [],
            "source_name": "ETDA:Operation DRBControl",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535903,
    "ts_updated_at": 1743041835,
    "ts_creation_date": 1653678106,
    "ts_modification_date": 1653678106,
    "files": {
        "pdf": "https://archive.orkl.eu/7d686d424f35d941bdaa26a9b378efcc8ffc57d7.pdf",
        "text": "https://archive.orkl.eu/7d686d424f35d941bdaa26a9b378efcc8ffc57d7.txt",
        "img": "https://archive.orkl.eu/7d686d424f35d941bdaa26a9b378efcc8ffc57d7.jpg"
    }
}