{
    "id": "9cad40e8-ce1c-4c57-8826-e3df30fbe5f4",
    "created_at": "2023-05-06T02:08:20.971978Z",
    "updated_at": "2025-03-27T02:05:31.048836Z",
    "deleted_at": null,
    "sha1_hash": "0a4587bcc584592edd181ee3dd9a4c29b0930830",
    "title": "2023-04-13 - Detecting QakBot- WSF attachments, OneNote files, and generic attack surface reduction",
    "authors": "",
    "file_creation_date": "2023-05-05T01:58:52Z",
    "file_modification_date": "2023-05-05T01:58:52Z",
    "file_size": 648938,
    "plain_text": "# Detecting QakBot: WSF attachments, OneNote files, and generic attack surface reduction\n\n**[sublime.security/blog/detecting-qakbot-wsf-attachments-onenote-files-and-generic-attack-surface-reduction](https://sublime.security/blog/detecting-qakbot-wsf-attachments-onenote-files-and-generic-attack-surface-reduction)**\n\nSam Scholten, Detection Engineering\n\nThis post will cover a brief timeline of QakBot’s evolution, and focus primarily on recently\nobserved attack techniques. We’ll discuss detection methodologies and share MQL rules\nthat anyone can use to detect, prevent, and hunt for these threats in email environments\ntoday. If you're already running Sublime, you received these new protections automatically.\n\nTake control of your email environment\n\n[Deploy Sublime for Free](https://sublime.security/start)\nRequest Demo\n\n## QakBot History and Evolution\n\n\n-----\n\nQakBot, also known as QBot and Pinkslipbot, has been active since 2007 and has been\nconsistently and constantly evolving. Initially, QakBot started as a banking Trojan that utilized\ncommand and control (C2) servers for payload delivery. With modularity being a crucial\ncomponent, QakBot’s primary objective was to steal financial data and login credentials from\nvictims. It was also capable of spying on financial operations and redirecting users to fake\nbanking sites.\n\n‍\n\nOver the years, QakBot has used many different techniques to infect users, including\nmalspam campaigns with malicious attachments, hyperlinks, or embedded images to drop a\nsecond-stage payload. The malware itself has evolved to include a variety of functions and\nnew obfuscation methods to avoid detection.\n\n‍\n\n\n-----\n\nQakBot timeline\n\n## Exploring the latest delivery method\n\n‍\n\nIn early 2023, QakBot was observed using a new method of distribution through Windows\nScript Files (.wsf). In this scenario, the phishing email contains a zip file with a random name,\nwhich includes a wsf file and txt file, and a decoy pdf file.\n\n‍\n\nsample email\nThe malicious attachment is delivered in the following sequence:\n\n\n-----\n\n1. A .zip file containing multiple files, including a decoy .pdf file, a .txt file, and a .wsf file.\n2. The .wsf file is used to execute the malicious code contained in the decoy .pdf file.\n3. The .pdf file contains a script that downloads a .dll file and executes it on the infected\n\nmachine.\n\n‍\n\nThis delivery method is unique in that it uses a .wsf file to execute the malicious code, rather\nthan relying on macros or other scripting languages.\n\n‍\n\nWhen the victim tries to open the .wsf file, javscript is executed to download the QakBot DLL\nfile. The file is usually loaded into the C:\\ProgramData directory and executed using\n“Rundll32.exe” with “Wind” as a parameter. For example:\n\n‍\n\nrundll32 C:\\\\ProgramData\\\\Z8w7V9.SmcisaK,Wind\n\n_[sample](https://bazaar.abuse.ch/sample/1b3b1a86a4344b79d495b80a18399bb0d9f877095029bb9ead2fcc7664e9e89c/)_\n\n## Using MQL to Detect The WSF Variant\n\nLet’s create an MQL rule that can detect this specific delivery method by looking for the\nfollowing characteristics:\n\n1. An inbound email with at least one attachment.\n2. The attachment is an archive.\n3. The archive file contains a .pdf file, .txt file, and .wsf file at a depth of 1.\n\n## The Rule:\n\n[Attachment: Archive with pdf, txt and wsf files](https://github.com/sublime-security/sublime-rules/blob/7c11f34bcead980c85beb0459b4525e637a9be65/detection-rules/attachment_archive_with_pdf_wsf_txt_attached.qakbot.yml#L4)\n\n‍\n\n\n-----\n\nAttachment: Archive with pdf, txt and wsf files (MQL)\n‍\n\n### Breaking Down the Rule:\n\nThe rule is inspecting inbound mail with at least 1 attachment. It uses Sublime’s open-source\nstatic-files, specifically the **[$file_extensions_common_archive list, to determine if the file is](https://github.com/sublime-security/static-files/blob/master/file_extensions_common_archives.txt)**\nan archive.\n\n‍\n\nIf an attachment is found with an archive, we use file_extension to check for archives and\nthe file.explode function, which explodes the archive file. The rule then checks if the archive\nfile contains a .pdf, .txt, and .wsf file at a depth of 1.\n\n‍\n\nIf all of these conditions are met, the rule tags the email as \"Qakbot\" and \"Suspicious\nattachment\" and assigns it a medium severity rating.\n\n‍\n\nTest in Playground\n\n## Attack Surface Reduction\n\n\n-----\n\nIn addition to specific detections, it s important to consider the protections gained by a more\ngeneralized approach. Attack surface reduction (ASR) is a proactive security strategy that\ninvolves minimizing potential avenues of attack for malicious actors by limiting their\nopportunity to do harm.\n\n‍\n\nOne effective way to protect against Qakbot and other similar malware threats is by\n[implementing attack surface reduction (ASR) techniques, such as the rule below. This rule](https://github.com/sublime-security/sublime-rules/blob/7c11f34bcead980c85beb0459b4525e637a9be65/detection-rules/attachment_archive_with_pdf_wsf_txt_attached.qakbot.yml#L4)\nutilizes MQL to scan email content for any links that may lead to an encrypted zip file, and\nthen checks whether the zip file contains a disk image in IMG, ISO, or VHD format.\n\n‍\n\n\n-----\n\nLink to auto-downloaded disk image in encrypted zip (MQL)\n\n## OneNote Attack Surface Reduction\n\n\n-----\n\nIn late 2022, QakBot began using OneNote attachments as part of its campaigns, likely in\nresponse to [Microsoft’s blocking of Office Macros. We can again leverage MQL to surface](https://techcrunch.com/2022/07/22/microsoft-office-macros-blocked-default/)\nthese attempts.\n\nThe [rule below was contributed by @Kyle_Parrish_/Kyle Parrish, a Sublime Community user.](https://github.com/sublime-security/sublime-rules/blob/7c11f34bcead980c85beb0459b4525e637a9be65/detection-rules/attachment_malicious_onenote_commands.yml#L4)\n\n\n-----\n\nMalicious OneNote Commands (MQL)\n‍\n\n‍\n\n\n-----\n\nThis rule aims to identify potential threats in OneNote attachments by searching for specific\nsuspicious commands. It first checks for OneNote files, as well as OneNote files inside\narchives, using Sublime’s [static-files list ($file_extensions_common_archives). The rule](https://github.com/sublime-security/static-files)\nthen uses MQL to scan for specific strings that may indicate malicious behavior, such as\nreferences to shell commands (e.g., Windows Script Host, scheduled tasks), PowerShell,\nand other malware indicators. This is another great example of reducing your attack surface,\nwhile not specifically aimed at Qakbot, but any malware looking to leverage similar delivery\nmechanisms.\n\n## Conclusion\n\nQakbot's unique delivery methods require a multi-layered approach for detection.\n\n‍\n\nOne effective technique for safeguarding against Qakbot and other similar malware threats is\nimplementing Attack Surface Reduction (ASR) measures. By proactively reducing potential\navenues of attack for malicious actors, ASR can significantly minimize the opportunity for\nharm.\n\n‍\n\nAll of the rules described above can be used as both detection rules to prevent new attacks\ngoing forward, as well as a Hunt rules to look for historical attacks. They've all been added to\nthe core [Sublime Rules Feed, which means all Sublime instances, both free and paid,](https://github.com/sublime-security/sublime-rules)\nreceive these new protections by default.\n\nBack to Blog\n\nGet insights on new threats, detection engineering, and industry trends.\n\nThank you! Your submission has been received!\n\nOops! Something went wrong while submitting the form.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-04-13 - Detecting QakBot- WSF attachments, OneNote files, and generic attack surface reduction.pdf"
    ],
    "report_names": [
        "2023-04-13 - Detecting QakBot- WSF attachments, OneNote files, and generic attack surface reduction.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1683338900,
    "ts_updated_at": 1743041131,
    "ts_creation_date": 1683251932,
    "ts_modification_date": 1683251932,
    "files": {
        "pdf": "https://archive.orkl.eu/0a4587bcc584592edd181ee3dd9a4c29b0930830.pdf",
        "text": "https://archive.orkl.eu/0a4587bcc584592edd181ee3dd9a4c29b0930830.txt",
        "img": "https://archive.orkl.eu/0a4587bcc584592edd181ee3dd9a4c29b0930830.jpg"
    }
}