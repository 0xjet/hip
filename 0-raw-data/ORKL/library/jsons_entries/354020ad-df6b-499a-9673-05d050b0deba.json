{
    "id": "354020ad-df6b-499a-9673-05d050b0deba",
    "created_at": "2023-01-12T15:00:11.791158Z",
    "updated_at": "2025-03-27T02:15:39.366107Z",
    "deleted_at": null,
    "sha1_hash": "a9a22cf9772fdb8a58f0488ae52d57098810a39e",
    "title": "2019-03-29 - A Hammer Lurking In The Shadows",
    "authors": "",
    "file_creation_date": "2022-05-28T19:53:17Z",
    "file_modification_date": "2022-05-28T19:53:17Z",
    "file_size": 938038,
    "plain_text": "# A Hammer Lurking In The Shadows\n\n**blog.f-secure.com/a-hammer-lurking-in-the-shadows/**\n\nMarch 29, 2019\n\nAnd then there was ShadowHammer, the supply chain attack on the ASUS Live Update Utility between\nJune and November 2018, which was discovered by Kaspersky earlier this year, and [made public a](https://securelist.com/operation-shadowhammer/89992/)\nfew days ago.\n\nIn short, this is how the trojanized Setup.exe works:\n\n1. An executable embedded in the Resources section has been overwritten by the first-stage\n\npayload.\n2. The program logic has been modified in such a way that instead of installing a software update, it\n\nexecutes a payload implemented as a shellcode.\n3. The payload enumerates the MAC addresses on the victim’s system, creates MD5 hashes of\n\nthem and searches these hashes in a large array of hardcoded values.\n4. If there is a match, it downloads hxxps://asushotfix.com/logo.jpg or\n\nhxxps://asushotfix.com/logo2.jpg, depending on the payload variant. This is meant to be a\nsecond-stage x86 shellcode since it will try to execute it within its own process. However, these\nURLs are not accessible anymore.\n5. If no match, create or update a file “idx.ini”. (Added in July 2018 – more details below)\n\nIf you’re more interested in the technical details, our colleagues at Countercept have made an\n[excellent write-up here.](https://blog.f-secure.com/analysis-shadowhammer-asus-attack-first-stage-payload/)\n\n[More researchers jumped on this threat and wrote their own analysis as well, such as here and](https://www.vkremez.com/2019/03/lets-learn-dissecting-operation.html) [here.](https://mauronz.github.io/shadowhammer-backdoor/)\n\nIn this post we will focus more on the differences between the variants we have discovered, and how\nthe payload evolved over time. We will also cover some findings about the MAC addresses.\n\n\n-----\n\n## Timeline\n\n1. June 2018: The beginning.\n\nIn the first known versions, the embedded executable in the Setup.exe resource section has\nbeen partially overwritten by another smaller executable that contains the shellcode.\n\nThe executable is not encrypted, and has a PDB string which is remarkable to say the least:\n```\n   D:\\C++\\AsusShellCode\\Release\\AsusShellCode.pdb\n\n```\nThe number of targeted MAC address hashes was very low. In the earliest sample we found,\nthere were only 18 devices in scope.\n\nIf there is a match, the shellcode will download the file from the following URL and execute it.\n```\n    hxxps://asushotfix.com/logo.jpg\n\n```\n2. Early July 2018: Introduction of the INI file.\n\nSome interesting functionality was added. If there is NO match with any of the targeted MAC\naddresses (which will be the case for most devices), the payload will create or update an INI file\n“idx.ini”.3 different entries are written with a date value corresponding to 7 days/one week later.\nExample content if it was created today (2019-03-29):\n```\n   [IDX_FILE]\n   XXX_IDN=2019-04-05\n   XXX_IDE=2019-04-05\n   XXX_IDX=2019-04-05\n\n```\nThe INI file is stored 2 levels up in the directory structure from where setup.exe is stored.\n\nSo if the executable path is\n```\n   C:\\Program Files (x86)\\ASUS\\ASUS Live Update\\Temp\\6\\Setup.exe\n\n```\nthen the INI file will be dropped as\n```\n   C:\\Program Files (x86)\\ASUS\\ASUS Live Update\\idx.ini\n\n```\nMore MAC hashes were added per iteration, increasing the number to over 200 in a sample\ncompiled on 23 July 2018.\n\n3. Mid August 2018: Going stealthy.\n\nThen there is a hiatus of a few weeks. Most people were enjoying summer at that time, but it\nlooks like these actors spent that period on rewriting a few things to hide their payload better.The\nmalicious payload is now fully encrypted, and has become real shellcode, i.e. not part of an\nexecutable image. Consequently, the PDB string is gone, and there is no compilation timestamp\nanymore, which makes determining the exact date of creation trickier. From here on, we are\nresorting to the date of first seen.The list of targets grew again, nearly 300 devices now.\n\n\n-----\n\n4. Early September 2018: A new URL.\n\nA small but interesting change was that the URL changed to\n```\n   hxxps://asushotfix.com/logo2.jpg\n\n```\nAlso, a few more hashes were added, totaling 307 entries, the largest number we have\nencountered.\n\n5. Late September 2018: Revisiting the targets.\n\nUntil now, the evolution of the targeted MAC addresses was very consistent: the actors have only\nadded targets. In other words, an older sample always contained a subset of the newer sample.\nThings have changed during the final period of the attack which lasted for more than a month.\nThe number of hashes started fluctuating – with each new variant, some got removed, while new\nones were added. Perhaps the threat actors managed to come up with a shortlist of targets of\ninterest this time?\n\n## MAC Addresses Observations\n\nLooking at the list of MAC addresses, it appears that some of them are wireless adapters from different\nmanufacturers. It’s possible that the attackers gathered these by listening on a wireless network. Also,\nit suggests that the targets are mostly laptops as most of the wireless adapters seem to be Intel /\nAzurewave / Liteon.\n\n\n-----\n\nIf you notice in the chart above, there were about 6 MAC addresses that didn’t resolve to any vendors:\n```\n00ff5eXXXXXX\n00ff91XXXXXX\n00ffaaXXXXXX\n00ffd9XXXXXX\n0c5b8f279a64\nfa94c2XXXXXX\n\n```\n0c:5b:8f:27:9a:64, which was found in 8 samples, appears to be a Huawei wireless chip address. It is\nnot assigned to Huawei, but looks like it’s being used in Huawei E3372 devices, which is a 4G USB\nstick. This particular MAC address is always checked along with a specific Asustek Computer Inc.\nMAC address.\n\n00ff5eXXXXXX is always checked along with a VMWare MAC address, which suggests that this MAC\naddress is used in virtualized environments.\n\n\n-----\n\nIn the most recent sample, there were a total of 18 devices of interest. But here are those that were\nchecked as matches:\n\nHon Hai Precision Ind. Co.,ltd. and Vmware, Inc.\nAzurewave Technology Inc. and Asustek Computer Inc.\nIntel Corporate and Asustek Computer Inc.\nVmware, Inc. and the 00ff5eXXXXXX MAC address\n\n## Indicators of Compromise\n\n**Hashes**\n\n\nSHA1 DATE\n(COMPILATION\nTIMESTAMP/FIRST\nSEEN)\n\n\n# OF\nHARDCODED\nMAC\nADDRESSES\n\n\n# OF\nTARGETED\nDEVICES\n\n\nb0416f8866954196175d7d9a93b9ab505e96712c 2018-06-12 24 18\n\n5039ff974a81caf331e24eea0f2b33579b00d854 2018-06-28 69 50\n\ne01c1047001206c52c87b8197d772db2a1d3b7b4 2018-07-10 75 55\n\nc6bd8969513b2373eafec9995e31b242753119f2 2018-07-16 156 117\n\n2c591802d8741d6aef1a278b9aca06952f035b8f 2018-07-17 197 152\n\n0595e34841bb3562d2c30a1b22ebf20d31c3be86 2018-07-23 294 208\n\ndf4df416c819feb06e4d206ea1ee4c8d07c694ad 2018-08-13 404 287\n\n8e0dfaf40174322396800516b282bf16f62267fa 2018-09-05 433 307\n\n4a8d9a9ca776aaaefd7f6b3ab385dbcfcbf2dfff 2018-09-25 141 86\n\ne793c89ecf7ee1207e79421e137280ae1b377171 2018-09-30 75 41\n\n9f0dbf2ba3b237ff5fd4213b65795595c513e8fa 2018-10-12 22 15\n\ne005c58331eb7db04782fdf9089111979ce1406f 2018-10-19 24 18\n\n**YARA Rules**\n\n\n-----\n\n```\n// older samples check the PDB string in the shellcode\nrule shadowhammer_pdb\n{\n  strings:\n    $str_pdb = \"AsusShellCode.pdb\" ascii nocase\n  condition:\n    all of them\n}\n// newer samples - check manual patches in the setup.exe\nrule shadowhammer_patch\n{\n  strings:\n    $str_msi = \"\\\\419.msi\" ascii wide nocase\n    $str_upd = \"ASUS Live Updata\" ascii wide nocase\n    $str_ins = \"Asusaller Application\" ascii wide nocase\n  condition:\n    2 of them\n}\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-03-29 - A Hammer Lurking In The Shadows.pdf"
    ],
    "report_names": [
        "2019-03-29 - A Hammer Lurking In The Shadows.pdf"
    ],
    "threat_actors": [
        {
            "id": "1c97ccfd-1888-492c-b7b9-bb52c4c3809b",
            "created_at": "2023-01-06T13:46:38.940529Z",
            "updated_at": "2025-03-27T02:00:02.957652Z",
            "deleted_at": null,
            "main_name": "Operation ShadowHammer",
            "aliases": [],
            "source_name": "MISPGALAXY:Operation ShadowHammer",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c7d9878a-e691-4c6f-81ae-84fb115a1345",
            "created_at": "2022-10-25T16:07:23.359506Z",
            "updated_at": "2025-03-27T02:02:09.752427Z",
            "deleted_at": null,
            "main_name": "APT 41",
            "aliases": [
                "BrazenBamboo",
                "Bronze Atlas",
                "Double Dragon",
                "Earth Baku",
                "Grayfly",
                "Operation ColunmTK",
                "Operation CuckooBees",
                "Operation ShadowHammer",
                "Red Kelpie",
                "SparklingGoblin",
                "TA415",
                "TG-2633"
            ],
            "source_name": "ETDA:APT 41",
            "tools": [
                "9002 RAT",
                "ADORE.XSEC",
                "ASPXSpy",
                "ASPXTool",
                "AceHash",
                "Agent.dhwf",
                "Agentemis",
                "AndroidControl",
                "AngryRebel",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BLUEBEAM",
                "Barlaiy",
                "BlackCoffee",
                "Bladabindi",
                "BleDoor",
                "CCleaner Backdoor",
                "CHINACHOPPER",
                "COLDJAVA",
                "China Chopper",
                "ChyNode",
                "Cobalt Strike",
                "CobaltStrike",
                "Crackshot",
                "CrossWalk",
                "CurveLast",
                "CurveLoad",
                "DAYJOB",
                "DBoxAgent",
                "DEADEYE",
                "DEADEYE.APPEND",
                "DEADEYE.EMBED",
                "DEPLOYLOG",
                "DIRTCLEANER",
                "DUSTTRAP",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "DodgeBox",
                "DragonEgg",
                "ELFSHELF",
                "EasyNight",
                "Farfli",
                "FunnySwitch",
                "Gh0st RAT",
                "Ghost RAT",
                "HDD Rootkit",
                "HDRoot",
                "HKDOOR",
                "HOMEUNIX",
                "HUI Loader",
                "HidraQ",
                "HighNoon",
                "HighNote",
                "Homux",
                "Hydraq",
                "Jorik",
                "Jumpall",
                "KEYPLUG",
                "Kaba",
                "Korplug",
                "LATELUNCH",
                "LOLBAS",
                "LOLBins",
                "LightSpy",
                "Living off the Land",
                "Lowkey",
                "McRAT",
                "MdmBot",
                "MessageTap",
                "Meterpreter",
                "Mimikatz",
                "MoonBounce",
                "MoonWalk",
                "Motnug",
                "Moudour",
                "Mydoor",
                "NTDSDump",
                "PACMAN",
                "PCRat",
                "PINEGROVE",
                "PNGRAT",
                "POISONPLUG",
                "POISONPLUG.SHADOW",
                "POTROAST",
                "PRIVATELOG",
                "PipeMon",
                "PlugX",
                "PortReuse",
                "ProxIP",
                "ROCKBOOT",
                "RbDoor",
                "RedDelta",
                "RedXOR",
                "RibDoor",
                "Roarur",
                "RouterGod",
                "SAGEHIRE",
                "SPARKLOG",
                "SQLULDR2",
                "STASHLOG",
                "SWEETCANDLE",
                "ScrambleCross",
                "Sensocode",
                "SerialVlogger",
                "ShadowHammer",
                "ShadowPad Winnti",
                "SinoChopper",
                "Skip-2.0",
                "SneakCross",
                "Sogu",
                "Speculoos",
                "Spyder",
                "StealthReacher",
                "StealthVector",
                "TERA",
                "TIDYELF",
                "TIGERPLUG",
                "TOMMYGUN",
                "TVT",
                "Thoper",
                "Voldemort",
                "WIDETONE",
                "WINNKIT",
                "WINTERLOVE",
                "Winnti",
                "WyrmSpy",
                "X-Door",
                "XDOOR",
                "XMRig",
                "XShellGhost",
                "Xamtrav",
                "ZXShell",
                "ZoxPNG",
                "certutil",
                "certutil.exe",
                "cobeacon",
                "gresim",
                "njRAT",
                "pwdump",
                "xDll"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535611,
    "ts_updated_at": 1743041739,
    "ts_creation_date": 1653767597,
    "ts_modification_date": 1653767597,
    "files": {
        "pdf": "https://archive.orkl.eu/a9a22cf9772fdb8a58f0488ae52d57098810a39e.pdf",
        "text": "https://archive.orkl.eu/a9a22cf9772fdb8a58f0488ae52d57098810a39e.txt",
        "img": "https://archive.orkl.eu/a9a22cf9772fdb8a58f0488ae52d57098810a39e.jpg"
    }
}