{
    "id": "12a8fa3a-c5c2-4d2e-aeb1-b4a39db45b6b",
    "created_at": "2023-01-12T14:58:51.884653Z",
    "updated_at": "2025-03-27T02:06:10.549233Z",
    "deleted_at": null,
    "sha1_hash": "044a87bee3593d595e809f2b40ad6e506be67b2c",
    "title": "2014-12-22 - Virlock- First Self‑Reproducing Ransomware is also a Shape Shifter",
    "authors": "",
    "file_creation_date": "2022-11-28T19:05:10Z",
    "file_modification_date": "2022-11-28T19:05:10Z",
    "file_size": 1458934,
    "plain_text": "# Virlock: First Self‑Reproducing Ransomware is also a Shape Shifter\n\n**[welivesecurity.com/2014/12/22/win32virlock-first-self-reproducing-ransomware-also-shape-shifter/](https://www.welivesecurity.com/2014/12/22/win32virlock-first-self-reproducing-ransomware-also-shape-shifter/)**\n\nDecember 22, 2014\n\nWin32/VirLock is ransomware that locks victims’ screens but also acts as parasitic virus,\ninfecting existing files on their computers. The virus is also polymorphic, which makes it an\ninteresting piece of malware to analyze. This is the first time such combination of malware\nfeatures has been observed.\n\n22 Dec 2014 - 01:55PM\n\nWin32/VirLock is ransomware that locks victims’ screens but also acts as parasitic virus,\ninfecting existing files on their computers. The virus is also polymorphic, which makes it an\ninteresting piece of malware to analyze. This is the first time such combination of malware\nfeatures has been observed.\n\nWin32/VirLock is ransomware that locks victims’ screens but also acts as parasitic virus,\ninfecting existing files on their computers. The virus is also polymorphic, which makes it an\ninteresting piece of malware to analyze. This is the first time such combination of\n**malware features has been observed.**\n\n\n-----\n\n**NOTE: Victims can restore their VirLock-infected files using our standalone cleaner,**\n[available for download.](http://download.eset.com/special/ESETVirlockCleaner.exe)\n\nFollowing the release of ESET’s detailed white-paper covering our research into the\nTorrentLocker ransomware, we can now shed some light on a curious new member of the\nmalware family extorting payments from infected users.\n\nIn most cases, [ransomware is either of the ‘LockScreen’ type or the ‘Filecoder’ type. When](https://www.welivesecurity.com/2014/06/09/ransomware-101-faq/)\na typical Filecoder encrypts files on the victim’s hard drive it usually doesn’t lock the screen,\nor otherwise prevent the victim to use their computer. The ransom notification can be\ndisplayed in several ways, such as displaying on the desktop wallpaper, by opening a text\nfile, or – most commonly – inside a regular window (this was also the method used by\n[Cryptolocker).](https://www.welivesecurity.com/search/?s=cryptolocker&x=0&y=0)\n\nIn some cases, ransomware takes a hybrid approach by both encrypting files and locking\nthe screen by displaying a full screen message and blocking simple methods of closing it.\n[An example of this behavior is Android/Simplocker – the first filecoder for Android.](https://www.welivesecurity.com/2014/06/04/simplocker/)\n\nIn October we discovered a new, previously unseen approach – Win32/VirLock is\nransomware that locks the screen and then not only encrypts existing files, but also infects\nthem by prepending its body to executable files – thus acting as a parasitic virus. Sophos\n[has also written about this interesting piece of malware on their blog.](https://nakedsecurity.sophos.com/2014/12/05/notes-from-sophoslabs-ransomware-with-a-difference-this-one-is-a-true-virus/)\n\nWe have observed a number of variants of the virus last month. This shows that the\nmalware author has been keeping himself busy working on their creation. In fact, the virus\nlooks somewhat like a malicious experiment and due to its polymorphic nature reminds us\nof viruses from the DOS era, such as the [Whale virus. The way VirLock is implemented](http://en.wikipedia.org/wiki/Whale_%28computer_virus%29)\ndemonstrates a high level of programming skills, yet some of its functionality seems to be\nlacking logic, which is somewhat puzzling.\n\nIn this blog post we give a general overview of the virus behavior and explain what makes it\npolymorphic.\n\n## Win32/VirLock overview\n\nA file infected with VirLock will be embedded into a Win32 PE file and the .exe extension\nappended to its name, unless it was already an executable file. When it is executed, it\ndecrypts the original file from within its body, drops it to the current directory and opens it.\nThe decryption methods are described later in the article. This behavior clearly sets it apart\nfrom typical filecoders.\n\nVirLock then installs itself by dropping two randomly named instances of itself (not copies –\nthe virus is polymorphic, so every instance is unique) into the %userprofile% and\n%allusersprofile% directories and adds entries in the Run registry keys under HKCU and\n\n\n-----\n\nHKLM so that they are launched when Windows boots up. These instances, which only\ncontain the virus body without a host file to decrypt, are then launched. More recent variants\nof VirLock also drop a third instance that is registered as a service. This approach serves as\na simple self-defense mechanism for the malware – processes and files get restored when\nthey’re terminated or deleted.\n\nThe dropped instances are responsible for executing the actual malicious payloads.\n\nOne thread takes care of the infection of files. Win32/VirLock looks for host files by crawling\nthrough local and removable drives, and even network shares, to maximize its spreading\npotential. The file extensions intended to be infected differ between VirLock versions. An\nextension list from a recent sample contains the following: *.exe, *.doc, *.xls, *.zip, *.rar,\n*.pdf, *.ppt, *.mdb, *.mp3, *.mpg, *.png, *.gif, *.bmp, *.p12, *.cer, *.psd, *.crt, *.pem, *.pfx,\n*.p12, *.p7b, *.wma, *.jpg, *.jpeg.\n\nAnother thread contains the lockscreen functionality – with typical protective measures like\nshutting down explorer.exe, the Task Manager, and so on – and displays the following\nransom screen.\n\nThe ransom message is self-explanatory, so we will only cover the unique aspects. The\nscreenshot above is from an earlier version, whereas the ones below are from a more\nrecent one. The ransom is expected in Bitcoin and the malware author also gives clear\ninstructions to victims who may not be familiar with the cryptocurrency. The lockscreen even\nallows victims to use an Internet browser and Notepad.\n\n\n-----\n\n-----\n\n-----\n\nThe screen locker is able to do some basic localization based on whether a connection\nattempt to google.com was redirected to either google.com.au, google.ca, google.co.uk, or\n[google.co.nz and return value of the GetUserGeoID function. For those selected countries a](http://msdn.microsoft.com/en-us/library/windows/desktop/dd318138%28v=vs.85%29.aspx)\ndifferent flag, Bitcoin exchanges and displayed currency will be shown. Even the ransom\namount appears to be variable: either 150 USD or 250 USD / GBP / EUR / NZD / CAD /\n**AUD.**\n\n\n-----\n\n## VirLock polymorphism\n\nFrom a technical point of view, probably the most interesting part about this malware is that\nthe virus is polymorphic, meaning its body will be different for each infected host and also\neach time it’s executed. But before we explain how the code changes, we must take a look\nat the multiple layers of encryption it uses.\n\nA simplified execution flow of earlier variants of Win32/VirLock is shown in the following\ninfographic:\n\n\n-----\n\nWhen a Win32/VirLock binary is loaded into memory, the only unencrypted code is\nsomething we’ll call a XOR stub builder; all other code, data and the original file (if present –\nthe same scheme applies to “stand-alone” VirLock instances) are encrypted.\n\nThe following description of the XOR stub builder applies to older variants of Win32/VirLock.\nNewer variants employ a slightly more complex mechanism. The builder contains eight\nsimilar blocks like the one in the example code snippet below.\n\n\n-----\n\nEach block consists of a specific calculated DWORD being written to a specific memory\noffset. The registers, operations (additions and subtractions) and constants are generated\nat random but produce the same desired output. Each of these blocks generates 4-bytes of\nthe XOR stub that is exactly 32-bytes of assembly code. This stub is the next stage in\nWin32/VirLock’s execution.\n\nThe XOR stub, as its name implies, will decrypt a smaller part (Part 1) of the actual VirLock\ncode that consists of several functions. In the example below, the XOR key used is\n0x6B130E06 and the size of Part 1’s is 0x45C.\n\n\n-----\n\nThe rest of the code (Part 2), as well as the contained original file, remain encrypted at this\npoint.\n\nAn interesting feature of Win32/VirLock is that the body of (nearly) every single one of its\nfunctions is also encrypted and contains a decryption stub at the beginning. This\ncomplicates analysis of the malware, as none of the functions’ relevant code is visible in a\ndisassembler. The function encryption is again simple – a checksum from the decryption\nstub is calculated used as the XOR key to the function’s body.\n\nTo make things more fun, after the function’s execution, its body will be encrypted again.\nThe key will be different, however: as shown in the code snippet below, a few garbage\ninstructions within the decryption stub are XORed with a random number (from RDTSC),\nthus effectively changing the checksum that’s used as the key.\n\nThis is the first part of VirLock’s polymorphism – as it executes, its functions are effectively\nchanging in memory as they decrypt and re-encrypt themselves. And the memory\n‘snapshot’ modified this way contributes (more polymorphic levels to follow J) to the virus’s\nuniqueness in each infected file.\n\n\n-----\n\nThe code that makes up Part 1 also contains another decryption function that s used to\ndecrypt Part 2 and the embedded host file. This third type of decryption is only slightly more\ncomplex than the previous ones in that it uses ROR in addition to XOR. The decryption\nkeys for the embedded file and for Part 2 are hard-coded.\n\nTo summarize, we have encryption at three levels:\n\nPart 1 of the code is decrypted by the XOR stub in the beginning\nPart 2 of the code is decrypted by a function within Part 1\nNearly all functions within the virus code (both Part 1 and Part 2) have their bodies\nencrypted. They are decrypted as they execute and are re-encrypted afterwards\n\nSo how exactly is the code polymorphic? At one point in the malware’s execution after Part\n1 and Part 2 have been decrypted, it copies its whole body into a block of allocated\nmemory. Remember: the functions that have executed before this in-memory copy was\ncreated have been re-encrypted with a different key. This copy will be used to infect the\nother files, with the following modifications for each one of them.\n\nWorking backwards through the individual layers, the copy is encrypted again. First, Part 2\nand the host file being infected are encrypted using randomly generated keys. The\nencrypted host file is appended to the in-memory copy and the new encryption keys,\nmemory addresses and offsets are written to the Part 1 code, so that it will be able to\nextract Part 2 and the original file when the new sample is run.\n\nThen the modified Part 1 is encrypted with XOR with a randomly generated DWORD, which\ngets written to the XOR stub in the beginning.\n\nFinally, the XOR stub builder is constructed randomly as described above and the XOR stub\nis overwritten with garbage bytes.\n\nAfter all these steps, we end up with an encrypted copy of the virus in memory with the\noriginal file embedded. This is then written to the hard drive in place of the original file. If the\noriginal document was not an executable (.exe) Win32 PE file, the „.exe“ extension will be\nappended to the filename after the original extension and the original file will be deleted.\nThe newly created infected file will also have the icon of the original host.\n\n## Conclusion\n\nESET’s [LiveGrid® telemetry shows that the number of victims of this new virus is relatively](http://www.eset.com/us/business/whyeset/livegrid/)\n[low and that for now the scale of this threat is nothing like that of TorrentLocker or other](https://www.welivesecurity.com/2014/12/16/torrentlocker-racketeering-ransomware-disassembled-by-eset-experts/)\nwidespread ransomware. Nevertheless, looking at the transactions associated with the\nBitcoin addresses used by the malware reveals that some victims of this fraud have already\npaid up. We will continue monitoring the evolution of this new ransomware strain.\n\n\n-----\n\nWhat makes this ransomware stand out, however, is the fact that it is a functional\npolymorphic parasitic virus. Our analysis of the code has shown that the malware author\nhas truly played around with this venerable means of writing computer virus code.\n\n22 Dec 2014 - 01:55PM\n\n### Sign up to receive an email update whenever a new article is published in our Ukraine Crisis – Digital Security Resource Center\n\n Newsletter\n\n Discussion\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2014/2014-12-22 - Virlock- First Self‑Reproducing Ransomware is also a Shape Shifter.pdf"
    ],
    "report_names": [
        "2014-12-22 - Virlock- First Self‑Reproducing Ransomware is also a Shape Shifter.pdf"
    ],
    "threat_actors": [
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535531,
    "ts_updated_at": 1743041170,
    "ts_creation_date": 1669662310,
    "ts_modification_date": 1669662310,
    "files": {
        "pdf": "https://archive.orkl.eu/044a87bee3593d595e809f2b40ad6e506be67b2c.pdf",
        "text": "https://archive.orkl.eu/044a87bee3593d595e809f2b40ad6e506be67b2c.txt",
        "img": "https://archive.orkl.eu/044a87bee3593d595e809f2b40ad6e506be67b2c.jpg"
    }
}