{
    "id": "78cb0ec2-9358-4c25-88b2-430fcc50dac0",
    "created_at": "2023-01-12T15:08:38.756522Z",
    "updated_at": "2025-03-27T02:08:51.855298Z",
    "deleted_at": null,
    "sha1_hash": "d7cd1b530202c49205c5e67bc8d93c97780dfd55",
    "title": "2016-10-10 - Remsec driver analysis - Part 2",
    "authors": "",
    "file_creation_date": "2022-05-27T21:13:43Z",
    "file_modification_date": "2022-05-27T21:13:43Z",
    "file_size": 245090,
    "plain_text": "# Remsec driver analysis - Part 2\n\n**[artemonsecurity.blogspot.com/2016/10/remsec-driver-analysis-part-2.html](https://artemonsecurity.blogspot.com/2016/10/remsec-driver-analysis-part-2.html)**\n\nIn previous blog post I've described 32-bit driver that has been used by attackers who are\nbehind Strider cybergroup. I also pointed that from my point of view the driver was developed\nby skilled guys, but it contains two flaws. Firstly, authors forget to turn on SMEP again, after\nexecuting user mode code and they disable it each time when client tries to call 0x1173000C\nIOCTL code. Secondly, they try to unload driver dynamically in separate system thread that\ncan lead to code execution from invalid memory (fnThreadStartFunction).\n\nThe dropper also contains one more driver (and its x64 clone) that is also interesting for\nresearch. I should make one clarification about information I posted before. The dropper\nitself doesn't contain rootkit driver as whole file inside, instead it stores only its PE-sections.\nThis means that rootkit PE-file is generated by dropper on-the-fly. So, aswfilt.dll and 32-bit\ncode of another driver as well as its 64-bit clone are stored only as PE-sections. And this is\nanswer on question, why aswfilt.dll has one unnamed section and zeroed timestamp in PEheader. On screenshot below, you can see how the dropper initializes PE-header of\naswfilt.dll driver before it was written to FS as executable file.\n\n\n-----\n\nDriver (Ring 0 code) has following properties:\n\nIt has compact size and its code is stored into two PE sections inside dropper.\nIt has dynamic imports that are stored into special context structure.\nIt has 64-bit clone inside the dropper.\nIt has no DriverEntry function.\nIt serves for one purpose: execute code from ptr that was passed from user mode to\nFastIoDeviceControl handler.\nIt uses undocumented Windows kernel API.\n\nCode and data of aswfilt.dll driver are stored into a separate section with name \".rwxdrv\", as\nyou can see on screenshot below. Another two sections with names \".krwkr32\", \".krdrv32\"\nand \".krwkr64\", \".krdrv64\" are used for storing mentioned above 32-bit Ring 0 code and its\nx64 analog.\n\n\n-----\n\nLike aswfilt.dll, kernel mode code from above mentioned sections uses special context\nstructure where dynamically loaded imports are located. Format of this structure you can see\nbelow.\n\nstruct RootkitStruct {\nPVOID pExAllocatePool;\nPVOID pExFreePool;\nPVOID pExQueueWorkItem;\nPVOID pIofCompleteRequest;\nPVOID pIoCreateDevice;\nPVOID pIoDeleteDevice;\nPVOID pIoDriverObjectType;\nPVOID pIoGetCurrentProcess;\nPVOID pKeInitializeEvent;\nPVOID pKeSetEvent;\nPVOID pKeStackAttachProcess;\nPVOID pKeUnstackDetachProcess;\nPVOID pKeWaitForSingleObject;\nPVOID pObCreateObject;\nPVOID pObInsertObject;\nPVOID pObQueryNameString;\nPVOID pObfDereferenceObject;\nPVOID pZwClose;\nPVOID pZwCreateFile;\nPVOID pBuffer;\nULONG cbBuffer;\nULONG field1;\nPVOID pProcessForAttach;\n};\n\n\n-----\n\nA problem is that start function of new kernel mode code doesn't contain DriverEntry\nfunction, showing for us that, in first, this code is loaded into Ring 0 not by Windows\nfunctions like ZwLoadDriver and in second that it can be loaded into memory with exploit.\nAnyway, start function of this kernel mode code, where the control will be passed at the\nbeginning of its execution, gets already initialized context with corresponding function ptrs.\nThere is no function inside Ring 0 code, which is responsible for filling context with dynamic\nloaded functions ptrs.\n\nFirst action, which fnRootkitStartFunction does, it is creating driver object for loaded Ring 0\ncode (fnCreateDriverObject). This function (fnCreateDriverObject) allocates an object in\nmemory with help of ObCreateObject, initializes it and does it visible for Windows kernel by\ninserting it into objects list with ObInsertObject.\n\n\n-----\n\nNext, it does copying of prepared data with already initialized ptr from user mode buffer to\nsystem buffer and saves ptr to it into DriverExtension->ServiceKeyName.Buffer.\n\nThe driver leverages interesting way for dispatching DeviceControl request. Unlike other\ndrivers that are using IRP_MJ_DEVICE_CONTROL handler in such case, it registers FastIo\nfunction DriverObject->FastIoDispatch.FastIoDeviceControl.\n\n\n-----\n\nAs we already saw in case of aswfilt.dll, DeviceControl handler is responsible for performing\nonly one task: execute function by ptr that has been passed to it from user mode client.\n\nUnfortunately, I haven't a lot of free time for reconstructing logic of Ring 3 code (dropper part)\nand how it forms context for kernel mode code. I know that IOCTL with code 0x839200BF\n(Rootkits_IOCTLs_ExecuteFunction) is used by the dropper only one time in\nfunction fnSendIOCTL_839200BF. It passes to driver ptr to function that located at address\n0x1000741A.\n\nThe dropper also contains some code for exploiting NT Virtual DOS Machine (NTVDM), it\n\n\n-----\n\ncontains section with name .vdmbios and it imports function NtVdmControl. The code also\nuses context structre for calling dynamic imports.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-10-10 - Remsec driver analysis - Part 2.pdf"
    ],
    "report_names": [
        "2016-10-10 - Remsec driver analysis - Part 2.pdf"
    ],
    "threat_actors": [
        {
            "id": "a0d369c1-f0b7-4c70-a3a5-77aabbd17979",
            "created_at": "2022-10-25T15:50:23.311311Z",
            "updated_at": "2025-03-27T02:00:55.438117Z",
            "deleted_at": null,
            "main_name": "Strider",
            "aliases": [
                "ProjectSauron"
            ],
            "source_name": "MITRE:Strider",
            "tools": [
                "Remsec"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "99845f58-2c39-46f7-8369-bb621ebb7002",
            "created_at": "2022-10-25T16:07:24.238844Z",
            "updated_at": "2025-03-27T02:02:10.14785Z",
            "deleted_at": null,
            "main_name": "Strider",
            "aliases": [
                "ProjectSauron"
            ],
            "source_name": "ETDA:Strider",
            "tools": [
                "Backdoor.Remsec",
                "ProjectSauron",
                "Remsec"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536118,
    "ts_updated_at": 1743041331,
    "ts_creation_date": 1653686023,
    "ts_modification_date": 1653686023,
    "files": {
        "pdf": "https://archive.orkl.eu/d7cd1b530202c49205c5e67bc8d93c97780dfd55.pdf",
        "text": "https://archive.orkl.eu/d7cd1b530202c49205c5e67bc8d93c97780dfd55.txt",
        "img": "https://archive.orkl.eu/d7cd1b530202c49205c5e67bc8d93c97780dfd55.jpg"
    }
}