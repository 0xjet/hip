{
    "id": "920863ce-33f3-4daa-ba1e-dbd11cee0d30",
    "created_at": "2023-01-12T15:10:58.772029Z",
    "updated_at": "2025-03-27T02:16:26.570238Z",
    "deleted_at": null,
    "sha1_hash": "71e247a6b9bda574912042785ba12923bc056e40",
    "title": "2022-03-03 - Technical Analysis of The Hermetic Wiper Malware Used to Target Ukraine",
    "authors": "",
    "file_creation_date": "2022-05-29T01:02:52Z",
    "file_modification_date": "2022-05-29T01:02:52Z",
    "file_size": 2519266,
    "plain_text": "# Technical Analysis of The Hermetic Wiper Malware Used to Target Ukraine\n\n**[cloudsek.com/technical-analysis-of-the-hermetic-wiper-malware-used-to-target-ukraine/](https://cloudsek.com/technical-analysis-of-the-hermetic-wiper-malware-used-to-target-ukraine/)**\n\nAnandeshwar Unnikrishnan March 2, 2022\n\n## Executive Summary\n\nOn 23 February 2022, ESET researchers identified a destructive malware, dubbed\n“Hermetic Wiper,“ targeting Ukrainian computers and websites.\nThe Hermetic Wiper malware binary uses a signed digital certificate issued to\n“Hermetica Digital Ltd’ and the driver dropped by the malware has a signed digital\ncertificate issued to “Chengdu Yiwo Tech Development Co Ltd” to circumvent security\nchecks.\nThe malware drops a driver, in the Windows Drivers directory, which is part of the\nEaseus program with the original filename EPMNTDRV.sys.\nIt abuses the driver loaded to the target system, to access its hard disk with higher\nprivileges and to write garbage data into it.\nThe malware then renders the system useless by corrupting booting data, which forces\nthe user to reinstall their Operating System.\n\n## Technical Analysis of Hermetic Wiper Malware\n\n**Leveraging Code-Signing Certificates to Avoid Detection**\n\nThe malware binary’s signed digital certificate is issued to Hermetica Digital Ltd., a\nCyprus based Gaming development company.\nThe malware drops a driver in the Windows Drivers directory. The dropped binary’s\nsigned digital certificate belongs to Chengdu Yiwo Tech Development Co Ltd., the\nowner of Easeus Data, which is a Data Backup and Recovery Company.\n\nSigned digital certificates of the binaries\n\nSigned digital certificates of the binaries\n\n**Obtaining a Handle to the Current Process Token**\n\nThe malware begins by obtaining a handle to the current process’ token.\n\n\n-----\n\nIn Windows, a token is an object that represents the privilege a process holds while\n[running on the system. A full list of privilege constants can be found here.](https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants)\nThe malware uses OpenProcessToken API with the DesiredAccess parameter set to\n0x0028 (TOKEN_QUERY 0x0008 | TOKEN_ADJUST_PRIVILEGES 0x0020).\nThis allows the malware to change privileges assigned to the token.\n\nUsing\n\nOpenProcessToken API to change token privileges\n\n**Changing Token Privileges**\n\nAfter obtaining access to the current process’ token, with privileges set, the malware\nuses LookUpPrivilegeValueW to make sure the current process is assigned following\nprivileges:\n\nSeShutdownPrivilege\nSeBackupPrivilege\nThe AdjustTokenPrivileges API is used to adjust the current token privileges if the\nabove listed privileges are not already assigned to the current process.\n\n\n-----\n\nProcess\n\nof changing token privileges of the current process\n\n**Loading the Payload into the System Memory**\n\nAfter granting privileges, the malware dynamically resolves the addresses of following\nmodules and load them into the current process:\n\n_Wow64DisableWow64FsRedirection_\n_Wow64RevertWow64FsRedirection_\n_IsWow64Process_\nThe Wow64DisableWow64FsRedirection and Wow64RevertWow64FsRedirection\nmodules are responsible for file system redirection on 64 bit versions of Windows. This\ncomes into play when a 32 bit application runs on 64 bit Windows, where the\n_%windir%\\System32 directory is only reserved for 64 bit applications. However, since_\nthe malware sample is a 32 bit application there is a need for the malware to access\nthe System32 directory. This is possible via Wow64DisableWow64FsRedirection. It\nalso helps in accessing the registry without Wow64 redirection.\nThe IsWow64Process is used to determine whether the specified process is running\nunder WOW64, or under an Intel64 of x64 processor. This is mainly used to select the\nappropriate payload to be dropped.\n\n\n-----\n\n_The malware loads the modules into the current process_\n\nThe malware has multiple images of the payload. The malware holds following driver\nimages for later loading:\n\nDRV_X64\nDRV_X86\nDRV_XP_X64 for older generations of Windows\nDRV_XP_X86 for older generations of Windows\n\n_Multiple images of the payload in the malware_\n\n_Multiple images of the payload in the malware_\n\n\n-----\n\nThe version of the system is enumerated using `VerifyVersionInfoW API.`\n\n_System version enumeration_\n\n_using VerifyVersionInfoW_\n\nThe malware selects the payload to be dropped based on the bitness (32/64) in the\nresource section of the Portable Executable (PE). After which, the corresponding\nimage is retrieved from the .rsrc section of the malware and loaded into the system\nmemory.\n\n_Loading the_\n\n_corresponding payload into the system memory_\n\n**Dumping a Driver on the Target System**\n\nThe malware disables CrashDumpEnabled, which dumps the system memory in the\nevent of a crash. CrashDumpEnabled is enabled by default on Windows 10, and has a\ndefault value of 0x7. The malware changes it to 0x0, thus disabling it.\nThis is done to evade forensic analysis if something were to go wrong when the driver\nis loaded on the target system.\n\n\n-----\n\nAfter disabling the crash dump setting in the registry, the malware prepares to copy an\nimage of the driver, kept in the .rsrc section of the PE, to the target system.\nA pipe \\\\\\\\.\\\\EPMNTDRV\\\\ is created to perform the transfer of the data.\n\n_Creating a pipe to transfer data_\n\nThe system directory for drivers C:\\Windows\\system32\\drivers is then retrieved via the\n_GetSystemDirectory API._\n\n\n-----\n\n_Retrieving the system directory for_\n\n_drivers_\n\nThe data is written via the LZOpenFilew and LZCopy APIs. The filename is randomly\ngenerated at runtime, and the name assigned to the file is ttdr.sys.\n\n_Writing the data and generating the ttdr.sys file_\n\nNow the malware has successfully dumped a driver on the target system.\n\n_ttdr.sys dumped on the target system_\n\n\n-----\n\nDriver Loading and Service Creation\n\nTo load a driver on Windows, the process should possess SeLoadDriverPrivilege. The\nmalware checks for such a privilege in the current process using the\n_LookupPrivilegeValueW API._\nIf the process does not have the required privilege, the malware adds it via the\n_AdjustTokenPrivileges API._\n\n_Malware looks for SeLoadDriverPrivilege_\n\nAfter adjusting the privileges, the malware opens Service Control Manager on Windows\nto query active services through the ServicesActive database.\nIt checks for any active services with the name of the dumped driver, which in this case\nis ttdr, via the OpenServiceW API.\n\n_Checking for any active services with the name ttdr_\n\n\n-----\n\nIf the service does not exist, OpenServiceW API returns\n_ERROROSERVICE_DOES_NOTEXIST, and then new service is created via_\nCreateServiceW as shown below\n\n_New service is created via CreateServiceW_\n\nThe StartServiceW API is then used to run the driver on the target system.\n\n_Using StartServiceW_\n\n_API to run the driver on the target system_\n\nThis can be verified by querying the service control to check if the STATE parameter is\nset to “RUNNING.” After this the malware starts interacting with the driver via the\n_IOControlDevice API, which makes the malware a userland component of the deployed_\ndriver .\n\n_Querying the service control_\n\n\n-----\n\nThe symbolic link created for IO communications is verification that the driver has been\nsuccessfully loaded on the system.\n\n_Symbolic link created for IO communications_\n\nIf the service is present, then malware gets the service status from Service Control\nManager using the QueryServiceStatus API.\nThe service configurations are changed, if the service is inactive, via\n_ChangeServiceConfig API. And the flag SERVICE_DEMAND_START (0x00000003) is_\npassed as dwStartType value for the ChangeServiceConfig API.\n\n_Querying and changing the service configurations_\n\n**Clean Up Process**\n\nAs soon as the driver starts running on the target system, it starts the clean up process\nby deleting the service entry in the registry, and the driver image in the\n_C:\\Windows\\system32\\drivers directory._\n\n\n-----\n\n_Deleting service entry from the registry and driver image_\n\nAfter the clean up process, the malware disables Volume Shadow Copy Service (VSS)\non the system, via Service Control Manager. The VSS service is opened via the\n_OpenServiceW API to change the configuration of the service later._\n\n_Disabling the Volume Shadow Copy Service_\n\nA new configuration update is made by passing the 0x00000004 flag\n(SERVICE_DISABLED) to ChangeServiceConfigW, thus disabling VSS by force.\n\n\n-----\n\n_Disabling VSS_\n\nThe malware makes sure the service has stopped, by passing 0x00000001\n```\n   (SERVICE_CONTROL_STOP) as the dwControl parameter value.\n\n```\n_Making sure the service has stopped_\n\n**Corrupting the Hard Disk Data**\n\nThe malware uses the installed driver to read/write hard disk data.\nTo achieve this, the symbolic link used by the driver (\\Device\\EPMNTDRV),\ncommunicates via the DeviceIOControl API, by passing IOCTL codes to make the\ndriver perform a specific task.\nThe malware then accesses the Master Boot Record via \\\\\\\\.\\\\PhysicalDrive0.\nIOCTL codes:\n\n560000 70050\n\n90073 90064\n\n2D1080 90068\n\n700A0\n\n\n-----\n\n_Accessing \\\\\\\\.\\\\PhysicalDrive0_\n\nThe data corruption logic distinguishes NTFS and FAT systems and has different\ncorruption logic for each of the file systems present on the disk.\n\n_NTFS corruption logic_\n\n_Fat corruption logic_\n\nThe malware parses Master File Record fields such as $bitmap and $logfile and other\nNTFS attribute streams such as $DATA, $I30, or $INDEX_ALLOCATION.\nMultiple threads are instantiated by the malware to perform various activities. However,\nthe execution of one of the threads performs InitiateSystemShutdownEx, which is a\nprivileged activity, as the final damage.\n\n\n-----\n\n```\nPerforming InitiateSystemShutdownEx as the final damage\n\n```\nBefore shutting down the system, the malware enumerates the following directories for\ndata wiping:\n\nMy Documents\nDesktop\nAppData\nWindows Event Logs (C:\\Windows\\System32\\winevt\\Logs)\n\n## Indicators of Compromise\n\nMalware Binary:\n1bc44eef75779e3ca1eefb8ff5a64807dbc942b1e4a2672d77b9f6928d292591\nDropped Driver: 6106653B08F4F72EEAA7F099E7C408A4\n3F4A16B29F2F0532B7CE3E7656799125\n\nAuthor Details\n\n[Anandeshwar Unnikrishnan](https://cloudsek.com/author/anadeshwar-unnikrishnan/)\n\n\n-----\n\nThreat Intelligence Researcher, [CloudSEK](https://cloudsek.com/)\nAnandeshwar is a Threat Intelligence Researcher at CloudSEK. He is a strong advocate of\noffensive cybersecurity. He is fuelled by his passion for cyber threats in a global context. He\ndedicates much of his time on Try Hack Me/ Hack The Box/ Offensive Security Playground.\nHe believes that “a strong mind starts with a strong body.” When he is not gymming, he finds\ntime to nurture his passion for teaching. He also likes to travel and experience new cultures.\n\n[Deepanjli Paulraj](https://cloudsek.com/author/deepanjli-paulraj/)\nLead Cyberintelligence Editor, [CloudSEK](https://cloudsek.com/)\nTotal Posts: 3\nDeepanjli is CloudSEK’s Lead Technical Content Writer and Editor. She is a pen wielding\npedant with an insatiable appetite for books, Sudoku, and epistemology. She works on any\nand all content at CloudSEK, which includes blogs, reports, product documentation, and\neverything in between.\n\n×\n\n[Anandeshwar Unnikrishnan](https://cloudsek.com/author/anadeshwar-unnikrishnan/)\nThreat Intelligence Researcher, [CloudSEK](https://cloudsek.com/)\nAnandeshwar is a Threat Intelligence Researcher at CloudSEK. He is a strong advocate of\noffensive cybersecurity. He is fuelled by his passion for cyber threats in a global context. He\ndedicates much of his time on Try Hack Me/ Hack The Box/ Offensive Security Playground.\nHe believes that “a strong mind starts with a strong body.” When he is not gymming, he finds\ntime to nurture his passion for teaching. He also likes to travel and experience new cultures.\n\n\n-----\n\nLatest Posts\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-03 - Technical Analysis of The Hermetic Wiper Malware Used to Target Ukraine.pdf"
    ],
    "report_names": [
        "2022-03-03 - Technical Analysis of The Hermetic Wiper Malware Used to Target Ukraine.pdf"
    ],
    "threat_actors": [
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536258,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653786172,
    "ts_modification_date": 1653786172,
    "files": {
        "pdf": "https://archive.orkl.eu/71e247a6b9bda574912042785ba12923bc056e40.pdf",
        "text": "https://archive.orkl.eu/71e247a6b9bda574912042785ba12923bc056e40.txt",
        "img": "https://archive.orkl.eu/71e247a6b9bda574912042785ba12923bc056e40.jpg"
    }
}