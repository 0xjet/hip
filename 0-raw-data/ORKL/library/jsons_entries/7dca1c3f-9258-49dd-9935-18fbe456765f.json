{
    "id": "7dca1c3f-9258-49dd-9935-18fbe456765f",
    "created_at": "2022-10-25T16:48:16.581978Z",
    "updated_at": "2025-03-27T02:05:53.279052Z",
    "deleted_at": null,
    "sha1_hash": "85ef5daf99603da833a32245fd120028829a666f",
    "title": "Trojan.Apt.Banechant: In-Memory Trojan That Observes For Multiple Mouse Clicks",
    "authors": "FireEye",
    "file_creation_date": "2014-08-05T02:34:24Z",
    "file_modification_date": "2014-08-05T02:34:24Z",
    "file_size": 1734123,
    "plain_text": "# Multiple Mouse Clicks\n\n## Summary\n\nLast December, our senior malware researcher (Mr. Abhishek Singh) posted an article about a Trojan\n\nwhich could detect mouse clicks to evade sandbox analysis. Interestingly, we have found another spear\n\nphishing document that downloads malware which incorporates improved mouse click detection anti\nsandboxing capability. It also leverages multiple advanced evasion techniques to achieve stealth and\n\npersistent infection. The name of malicious document is translated to be “Islamic Jihad.doc”. Hence, we\n\nsuspect that this weaponized document was used to target the governments of Middle East and Central\n\nAsia.\n\nThis new malware is significant for several reasons:\n\n**It detects multiple mouse clicks: In the past, evasion methods using mouse clicks only detected**\n\na single click, making the malware fairly easy to overcome.\n\n**The callback goes to a legitimate URL: Often when malware performs its callback, the**\n\ncommunication goes directly to the CnC server. In this case, the callback goes to a legitimate URL\n\nshortening service, which would then redirect the communication to the CnC server. Automated\n\nblocking technologies are likely to block only the URL shortening service and not the CnC server.\n\n**It has anti-forensic capability: This malware doesn’t kick into high gear immediately. Instead it**\n\nrequires an Internet connection for malicious code to be downloaded to the memory and\n\nexecuted. Unlike predecessors that are very obvious and immediately get to work, this malware is\n\nmerely a husk and its true malicious intent could only be found in the downloaded code. This\n\nprevents forensic investigators from extracting the “true” malicious code from the disk.\n\nOverall, this malware was observed to send information about the computer and set up a backdoor for\n\nremote access. This backdoor provides the attacker the flexibility on how malicious activities could be\n\nexecuted.\n\n## Technical Analysis: How Does it Work?\n\nAfter opening this malicious document, it attempts to download an XOR encoded binary (using a two byte\n\nXOR key) for the stage one payload. It was also observed that the attacker leveraged a shortened URL to\n\n“hide” malicious domains from automated analysis technologies. After investigation, the malicious\n\ndomain was analyzed to be recently registered. See Figure 1 for the first stage download scenario.\n\n\n-----\n\nFigure 1 Stage One Download\n\nThe attacker has designed the stage one malware to be merely a husk. Having the decrypted executable file\n\nalone would not be useful in understanding its intent. It is because a majority of the malicious code is only\n\navailable after downloading the second stage payload. The second stage payload was available as a fake\n\n“JPEG” file from the malicious server. By designing the malware this way, it makes it harder to perform\n\nincidence response and facilitates ease of update of malicious code. Again, in this second stage download,\n\nthe malicious domain was not found in the malware. It made use of the dynamic DNS service provided by\n\n“NO-IP” to indirectly access the malicious domain. See Figure 2 for the second stage download scenario.\n\nThe technical details of each component (shellcode and payload) will be further elaborated.\n\n\n-----\n\nFigure 2 Stage Two Download\n\n## Shellcode Analysis\n\nThe spear phishing document was in RTF format which as designed loads MSCOMCTL.ocx and exploits\n\nCVE 2012-0158. By executing return at 0x27606EFF, it will load EIP with address 0x27583C30 which is\n\ntranslated to be JMP ESP to execute shellcode in the stack. See the figure below.\n\n\n-----\n\nFigure 3 Stack Corruption To “JMP ESP”\n\nLike most modern shellcode, its stub decrypts its body using a simple XOR key (see Figure 4). By stepping\n\nthrough the shellcode, it attempts to download hxxp://ow.ly/iGKKT and saves it to the temp directory\n\nwith a file name prefixed with “moo”, e.g., “moo1.tmp” (see Figure 5). It is important to note that “ow.ly” is\n\nnot a malicious domain. Instead, it is a URL shortening server. It is believed that the rational for such\n\nindirect access is to defeat automated URL blacklisting. Figure 6 depicts how a malicious URL could be\n\nshortened using this service.\n\n\n-----\n\nFigure 4 Single Byte XOR Key 0xF1\n\nFigure 5 URLDownloadToFileA\n\nFigure 6 URL Shortening Service\n\nFrom the network traffic, it is obvious that the real malicious content is located at\n\nhxxp://symbisecure.com/update/winword.pkg (see Figure 7). As an excecutable file usually contains\n\nmany zeros in series, the zeros would become the XOR key when XOR encoded. For example, 0xAA xor\n\n0×00 equals to 0xAA. By examining the content using a hex editor, it is obvious that there are many “9E\n\n44” repeated. Hence, by trying 0x449E (little endian) as an XOR key, it would reveal that it is a PE file. At\n\n\n-----\n\n0x000000E0, it is decrypted to be PE (see Figure 8).\n\nBy generalizing this idea, the single or double byte XOR key can be seen as a dword XOR key as it repeats\n\nover itself. For example, 0x449E XOR key could be seen as 0x449E449E. By counting the DWORD with\n\nthe highest occurance, it could be a probable XOR key if the file is XOR encrypted. This should work for\n\nsamples that are (1, 2 or 4, but not 3 bytes) XOR encrypted.\n\nFigure 7 Stage 1 Download Content\n\n\n-----\n\nFigure 8 Double Byte XOR Encrypted Payload\n\n## Payload Analysis\n\nEven though “winword.pkg” is an executable husk to host malicious code downloaded at the second stage,\n\nit contains a mouse-click check to detect human behaviors. Only if the number of left clicks is three or\n\nmore, will the malware proceed further to download the second stage payload – the true malicious code\n\n(see Figure 9 and Figure 10).\n\n\n-----\n\nFigure 9 Track Number of Left Clicks\n\nFigure 10 Proceed If Left Click Count Is Three Or More\n\nAfter the malware detects sufficient mouse clicks, it proceeds to decrypt its malicious URL to download\n\n\n-----\n\nheader of the downloaded JPG file, it is obvious that downloaded content is not a JPEG file. By doing so, it\n\neffectively downloaded an executable content that is not conformed to PE format to defeat network binary\n\nextraction. A legitimate JPG file should contain the byte sequence “FFD8FFE0xxxx4A46494600” at\n\noffset zero, where “4A464946” corresponds to “JFIF”. Below is the hardcoded URL and user-agent that\n\nis used by this malware sample.\n\nURL: hxxp://kibber.no-ip.org/adserv/logo.jpg\n\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV2)\n\nFigure 11 Malicious Domain Decryption\n\n\n-----\n\nFigure 12 Fake JPG\n\nAfter the JPG file is downloaded and executed directly in the memory, it achieves persistency by creating a\n\nshortcut link file at the start up folder. This link file will execute a copy of itself located at\n\n“C:\\ProgramData\\Google2\\GoogleUpdate.exe” (see Figure 13). It would look legitimate to users as it\n\nmasquerades as a legitimate Google Updater. It “would” appear normal if it attempts to access the\n\nInternet. In comparison, the real “GoogleUpdate.exe” resides in “program files” instead “program data”\n\ndirectory (see Figure 14).\n\n\n-----\n\nFigure 13 Persistency Mechanism\n\nFigure 14 Genuine GoogleUpdate.exe\n\nThe downloaded “JPG” file was analyzed to be a backdoor in the victim’s machine. It lists the running\n\n\n-----\n\ninformation is posted to hxxp://symbisecure.com/adserv/get.php in Base-64 format. After decoding, it is\n\ninteresting that it begins with a Tag named “BaneChant”. After doing a quick search, it seems to be a\n\nsound track composed by Hans Zimmer for the movie “The Dark Knight Rises” (see Figure 16). This is the\n\nreason we name this malware Trojan.APT.BaneChant.\n\nFigure 15 Commands Executed\n\n\n-----\n\nFigure 16 Exfiltrated Computer Information\n\nAs depicted in Figure 17, the malware could perform other tasks as listed below.\n\n1. Command ‘g’: Download and execute a file. The downloaded file has a temporarily file name\n\nprefixed with “java”.\n\n2. Command ‘i’: Run downloaded code (fileless) as a separate thread. The user-agent used is\n\n“Mozilla/5.0 (Windows NT 5.1) AppleWebKit/535.1 (KHTML, like Gecko)”.\n\n3. Command ‘x’: Download and execute, follow by an uninstallation of “GoogleUpdate.exe”. The\n\ndownloaded file has same prefix “java”.\n\n4. Command ‘u’: Uninstall “GoogleUpdate.exe”\n\n\n-----\n\nFigure 17 Backdoor Access\n\n## Conclusion\n\nAs defense technologies advance, malware also evolves. In this instance, we could see that the malware\n\nhas performed a number of tricks to defeat detection.\n\nIt attempts to:\n\n1. Evade sandbox by detecting human behaviors (multiple mouse clicks);\n\n2. Evade network binary extraction technology by performing multi-byte XOR encryption on\n\nexecutable file;\n\n3. Social engineer user into thinking that the malware is legitimate;\n\n4. Avoid forensic and incidence response by using fileless malicious codes; and\n\n5. Prevent automated domain blacklisting by using redirection via URL shortening and Dynamic DNS\n\nservices.\n\n\n-----\n\n[permalink.](http://www.fireeye.com/blog/technical/malware-research/2013/04/trojan-apt-banechant-in-memory-trojan-that-observes-for-multiple-mouse-clicks.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/5ycaruh0zf07h2jy9mpasgm1crninjwp",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2013/2013.04.01.APT_BaneChant/Trojan.APT.BaneChant.pdf"
    ],
    "report_names": [
        "Trojan.APT.BaneChant"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716496,
    "ts_updated_at": 1743041153,
    "ts_creation_date": 1407206064,
    "ts_modification_date": 1407206064,
    "files": {
        "pdf": "https://archive.orkl.eu/85ef5daf99603da833a32245fd120028829a666f.pdf",
        "text": "https://archive.orkl.eu/85ef5daf99603da833a32245fd120028829a666f.txt",
        "img": "https://archive.orkl.eu/85ef5daf99603da833a32245fd120028829a666f.jpg"
    }
}