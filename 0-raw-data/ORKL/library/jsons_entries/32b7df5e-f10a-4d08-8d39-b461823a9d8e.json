{
    "id": "32b7df5e-f10a-4d08-8d39-b461823a9d8e",
    "created_at": "2023-01-12T14:59:12.775856Z",
    "updated_at": "2025-03-27T02:05:34.812216Z",
    "deleted_at": null,
    "sha1_hash": "3e232395e3b747dedb92bdedda8798bb36a809f1",
    "title": "2020-01-31 - Emutet",
    "authors": "",
    "file_creation_date": "2022-05-27T23:09:33Z",
    "file_modification_date": "2022-05-27T23:09:33Z",
    "file_size": 982895,
    "plain_text": "# emotet_network_protocol\n\n**d00rt.github.io/emotet_network_protocol/**\n\n## Emutet\n\n### Summary\n\nEmotet is one of the most active malwares nowadays, every day you can find new\ncampaigns and new binaries. Emotet is a downloader that is able to download new modules\nwith new features.\n\nEmotet is also used to download third party malware on infected machines. Over the last few\nyears Emotet has been seen distributing malware such as IceID, Trickbot and Ursnif.\n\nAll these malware have the capability to steal bank information from infected computers.\nEmotet consists of more than 1 botnet extended worldwide and everyone is aware of the\nnew movements of this botnet, to such an extent that almost every day a new article talking\nabout Emotet is published.\n\n### Repository content\n\nThis repository has been created with the idea of helping the community of cybersecurity\nresearchers and malware researchers. It explains in detail how the network communication\nprotocol used by Emotet to communicate with the C&Cs works.\n\nKnowing all these details, it should be relatively easy to emulate the communication, and\nobtain the new modules and distributed malware directly from the c&c.\n\nThat’s why in this repository there is also the code used to emulate Emotet’s communication.\nThis code is integrated with https://www.capesandbox.com. In this way we only have to pass\nas argument the ID of a CAPE analysis, to automatically instantiate an Emotet bot that will\ntry to download new modules.\n\n### Usage\n\nRemember to install all requeriments first\n\n**Triage Given the following triage analysis https://tria.ge/reports/191017-h6k7yj8vq6/task1**\n```\ncd emutet\npython emutet.py -T --triage 191017-h6k7yj8vq6\n\n```\n**CAPE Given the following cape analysis https://www.capesandbox.com/analysis/3062/**\n\n\n-----\n\n```\ncd emutet\npython emutet.py -T --cape 3062\n\n```\nFor more info read [this](https://d00rt.github.io/emotet_network_protocol/emutet/)\n\nIn case of success something similar to the following will appear on the screen:\n\nIn this way it is possible to track in real time the servers controlled by the attackers and\nanticipate new attacks.\n\nThe following section explains in detail how the network protocol works.\n\n## Network Protocol\n\nOnce a host has been infected with Emotet, the host waits for commands from the control\npanel. One important thing to keep in mind is that each Emotet binary has a configuration.\nThis configuration has two elements:\n\n**A list of IPs and ports. These IPs are directly the C&Cs, from which the different**\nmodules and/or malware to be distributed at that given moment will be downloaded.\n**A RSA public key. This RSA public key is used to encrypt the symmetric session key.**\n\nTo extract this configuration we can use tools like CAPE (https://capesandbox.com) or\n**Triage (https://tria.ge) which extract them automatically. Or we can set up our own**\nsandboxing environment and add the necessary processes to extract this information.\n\n\n-----\n\n**Hatching/Triage - https://tria.ge/reports/191013-xrcw9krzfj/task1**\n\n**CAPE sandbox - https://capesandbox.com/analysis/2974/**\n\nUsing this list together with the public key, communication between the infected host and the\ncontrol panel takes place.\n\n### Summary\n\nIf a system has been infected correctly and the C&Cs are active, the communication from the\ninfected machine to the C&C controlled by the attackers is done in the following way.\n\n\n-----\n\nCommunication consists of 4 steps. The encryption of the communication as well as the\ndetailed content of each packet is described in the following sections. Each step could be\nsummarized as follows:\n\n1. This packet contains the user name, system architecture, the list of processes running\n\nin the system…\n2. The server responds with a PE executable file. This file is used as a session token. The\n\nfile is hashed using the CRC32 algorithm and this value is added in future packages\nsent by the infected host. If this value is wrong when the packets are sent, `step (4)`\nwill never happen, since this value works as a session token.\n3. The same information is sent again as in `step (1), but this time the value obtained`\n\nin `step (2) is added (session token).`\n4. This packet contains a list of PE files. This list usually contains different Emotet\n\nmodules. Although from time to time, in case they are distributing malware, it also\ncontains an additional file, corresponding to the malware that is being distributed at that\nmoment. Emotet modules are DLLs and are loaded directly into memory so they are\nnot saved into disk and are often difficult to obtain them.\n\nBelow is a Wireshark screenshot of a request from a host infected by Emotet.\n\n\n-----\n\nThis capture corresponds to `step (3) or` `step (4), Analyzing a little the response of the`\nserver you can see that it is very small, so you can guess that it has not received any\nmodule. This could mean 2 things.\n\n1. The correct request has not been made and the server does not respond with the\n\nmodules. This is a way for them to protect themselves against bots and curious\npeople…\n2. The country the request was made from is not among Emotet’s targets.\n\nIn the case of receiving some module, the response of the server would be much bigger.\n\nSome fields of the request header should be highlighted. Since probably if these fields are\nmisconfigured the control panel will not respond correctly. This is a typical measure used by\nattackers control panels to go unnoticed and not raise suspicions\n\n\n-----\n\nIt s a POST request.\nThe request is made to a specific path in this case to /mult/vermont/odbc. This path\nvaries as it is randomly generated by Emotet.\nThe Referer field is also added exclusively by Emotet.\nThe Content-Type field does not vary between requests as it is hardcoded in the\nEmotet code.\nThe DNT field is also hardcoded by Emotet.\nFinally to emphasize would be the payload of the request, in this case you see a\nvariable that is assigned data in base64. The name of the variable in this case is\n```\n   t1PfmD50asc and varies between requests as it is randomly generated by Emotet.\n\n```\nHowever the data in base64 is data related to the infected host.\n\nThis article tries to explain how this data is generated and sent/received to/from the server.\nAlso to learn how the Emotet communication protocol works internally and to be able to\ncreate a bot that emulates this communication and to be capable of communicating directly\nwith the control panels. (Although this emulator is already provided in this repository)\n\nThe data that is finally sent and received from the server is basically generated as shown\nbelow:\n\n\n-----\n\nThe data is encoded and encrypted before being sent. The following sections explain how\nthis data is encoded and then encrypted\n\n### Encoding\n\nThis section focuses on how packets sent from the infected host to the server are encoded.\nAlthough the process is similar for packets sent from the server to the infected host, we will\nnot go into detail as these are encoded on the server to which we do not have access.\nHowever, the server’s response is discussed below.\n\nAll packets before being encrypted are encoded in a specific way. In this case Emotet uses\nthe protobufs to encode the data it sends, both from the infected host to the server and from\nthe server to the infected host.\n\nBelow is the definition of these protobuf:\n\n\n-----\n\n```\nsyntax proto2 ;\nmessage HostInfo {\n  required int32 scmanager = 1;\n  required string bot_id = 2;\n  required int32 arch = 3;\n  required int32 session_id = 4;\n  required fixed32 file_crc32 = 5;\n  required string proccess_list = 6;\n  required string unknown = 7;\n}\nmessage C2Request {\n  required int32 command = 1;\n  required bytes data = 2; //HostInfo compressed by zlib\n}\nmessage C2Response {\n  required int32 status = 1;\n  optional bytes file = 2;\n  optional bytes modules = 3;\n}\nmessage Module {\n  required int32 id = 1;\n  required int32 action = 2;\n  required bytes data = 3;\n}\n\n```\nRequests that are sent from the infected host to the server ( `steps (1) and (3) ) are`\ncomposed as follows:\n```\n   HostInfo structure is filled and serialized using the protobuf\n\n```\n\n-----\n\nThe serialized/encoded data is compresed using zlib\nThen the `C2Request structure is filled, the command field always has the value 16`\n(0x10) and the data field is filled with the data compressed in the previous step.\n\nThe server responses are built in the same way, but in this case what the server sends is a\nlist of modules.\n\nAfter encode the data, it’s encrypted as explained below.\n\n### Encryption\n\nOnce the packets are encoded as explained in the previous section, the packer is encrypted\nusing the following encryption scheme:\n\nA 128-bit AES key is generated with which the encoded data is encrypted. In this case\nthe AES CBC mode is used for encryption.\nThe encrypted data is hashed using the SHA-128 algorithm.\nThe AES key used to encrypt the data is encrypted (exported) using the RSA key that\ncontains the binary. This key can be obtained automatically using Triage or CAPE as\nexplained above.\n\nThe encryption scheme used is similar to the one defined by GPG.\n\n\n-----\n\nIn the case of requests from the infected host to the server, this data will be encoded using\nbase64 and sent in the POST request, while the requests from the server to the infected host\nwill be sent in raw. As shown in the Wireshark image\n\n\n-----\n\n## Emotet tracking\n\nIn this section I explain how I have been tracking Emotet for a few weeks since I made\nthe bot. In this section there are technical things but also my personal opinion, because\nI have done this job in my spare time, I have not had nor do I have much time to\ndevote 100% to it and everything is not technically verified. Another thing to keep in\nmind, is that all the tests I have done are black box, because I do not have access to\nthe code of the servers, so in this section you will find many assumptions created\nunder my experience that do not have to be 100% real.\n\nUsing the bot found in this repository, I’ve been tracing the different Emotet botnets for a\ncouple of weeks and here are some conclusions I’ve reached.\n\nAs shown in protobuf definition, emotet modules have 3 fields\n```\nmessage Module {\n  required int32 id = 1;\n  required int32 action = 2;\n  required bytes data = 3;\n}\n   id field. This id identifies the module type. I didn’t find a good explanaition about this\n\n```\nfield. But it follows a pattern. This id is always a value between 300 and 2000. Usually\nthe DLLs have a lower value than the EXEs.\n```\n   action field. This field indicates how the module should be executed. We can find 2\n\n```\nvalues during the time the tracking has lasted, `1 and` `3 . If the value is` `3 it means`\nthat the module must be loaded in memory using a loader Emotet has. If the value is\n```\n   1 it means it is gonna be stored in disk and executed as a new process. The Emotet\n\n```\nmodules (DLLs) usually have the value `3 whereas the malware they are spreading`\n(which are EXE files) have the value `1`\n```\n   data field. A DLL or an EXE file.\n\n```\nThe collected files from the botnet that are in this repository are ordered by id and action.\nThis way maybe someone can guess the real meaning of this id field\n\n### Downloaded modules (DLL files)\n\nDuring these weeks of analysis, I have obtained about 600 unique files distributed inside\nEmotet’s botnets. Most of these files are not in VirusTotal as Emotet does not save them to\ndisk and they are difficult to get if you don’t have a bot. The file\n[emotet_botnet_modules_and_malware.zip contains these files. The password is](https://mega.nz/#!qsVEgAbC!5whFUe2tatnFZcRlAb_JqEMTnzpy3QBSzJ--oM5MPjc) `d00rt-`\n```\nemotet .\n\n```\nEvery time a request is made to download the modules, in case of success, they are always\nreceived in groups of between 3 and 13 modules. If these requests are made on different\ndays the hash of these modules will be different but they will still come in packs of between 3\n\n\n-----\n\nand 13 modules.\n\nI guess (I didn’t have time to analyze all of them) that the functionality of the modules\nremains the same but changes its hash. This way it is more difficult to detect them by the\nantivirus.\n\nAlthough looking at the hash of the modules obtained there are more than 600 different\nmodules, really, I think there are only about 13 unique modules. Simply the modules are\nupdated to change the hash and thus bypass the antivirus.\n\n### Distributed malware\n\nNot all files downloaded from the botnet are modules of Emotet itself. Executable files can\nalso be found. These files are other malwares distributed by Emotet. During the weeks the\nbotnet has been tracketed only samples of Trickbot and Ursnif have been obtained.\n\nThe file [emotet_botnet_malware.zip contains these files. The password is](https://mega.nz/#!Pt1TwQ7b!OwFW8T5mhJ7sX0S_LmZvfZJpooBAp_9BhPaRiv8t7Bg) `d00rt-emotet .`\n\n**SHA-1** **FAMILY** **REPORT**\n\n1aea1121475df57b5802c84583c4dc89500baa75 Trickbot [View report](https://tria.ge/reports/191018-5prbh9aams/task1)\n\n1bbbae729c33ea1ff7f99ddca6317e05a4242d63 Ursnif [View report](https://tria.ge/reports/191018-jyewsk7k72/task1)\n\n2eb72c4993a981c9480427c83338105bcd0d863d Trickbot [View report](https://tria.ge/reports/191018-m9ktjhnaq6/task1)\n\n2f8b0b6435ca18da75e8ae2e6745718124a26f66 Trickbot [View report](https://tria.ge/reports/191018-dj47fcq5ta/task1)\n\n30ebf4174d1703dd66d867ba65cd015d3604c938 Trickbot [View report](https://tria.ge/reports/191018-9z5rvjxg6s/task1)\n\n36c09a576e35a70e5400c545c19f3ad5420e4c33 Trickbot [View report](https://tria.ge/reports/191018-j1rn7h112e/task1)\n\n3ab810973efe13af16639485547817bf1a84bb84 Trickbot [View report](https://tria.ge/reports/191018-hqb4vww18x/task1)\n\n41ed194a7310eae9620d1b4facfbc33fb246c079 Trickbot [View report](https://tria.ge/reports/191018-h4wh8mye46/task1)\n\n428f9a2b4cbc33879806996a030c02f0e60521b9 Trickbot [View report](https://tria.ge/reports/191018-xkfwrmh4f2/task1)\n\n\n-----\n\n**SHA-1** **FAMILY** **REPORT**\n\n42cb5218b9b949231f3c601715e80aab3d416f91 Ursnif [View report](https://tria.ge/reports/191018-ze7jdhqtg6/task1)\n\n4fa87ea1426e9d02c0aebe5fdefd03b42cb6640a Trickbot [View report](https://tria.ge/reports/191018-8bvc9711j2/task1)\n\n5abdb8b16f503976c3e726521c1f93b927931c00 Ursnif [View report](https://tria.ge/reports/191018-xssrgacz7s/task1)\n\n60ae3209413136b40ab2b4fcd11884d6dfeb330b Trickbot [View report](https://tria.ge/reports/191018-5dpavxa8bj/task1)\n\n74e9f572b117ae54bbe6d3055332117071bc6e40 Trickbot [View report](https://tria.ge/reports/191018-yl64kemqrx/task1)\n\n8ad35f111142e94599955379dad6fe8040789f0b Ursnif [View report](https://tria.ge/reports/191018-6cbxhgqhwx/task1)\n\n8ec9d7a0c950e4f013f9afc76d807e597d7cad9a Ursnif [View report](https://tria.ge/reports/191018-qqj5ysk7q6/task1)\n\n9193eaeff8fff6c8b09dc370b9e60ddab5b121a3 Ursnif [View report](https://tria.ge/reports/191018-z54frb66pa/task1)\n\n9957fe40ae9a7a2630593fd82544d4ea39ca47d7 Trickbot [View report](https://tria.ge/reports/191018-pjatzgm2xn/task1)\n\na038cf5f99d17df1e223aaf2f5f80b4b4a440a4e Ursnif [View report](https://tria.ge/reports/191018-7wl797zm62/task1)\n\nb70119e477f01a901a14a0378ced471f93cee7f6 Trickbot [View report](https://tria.ge/reports/191018-n76fe2empj/task1)\n\nd0a308811bd0cf98b7f3c13328f34e192ae9f07c Ursnif [View report](https://tria.ge/reports/191018-dhmnstln9e/task1)\n\necf315df8321b5bee5395cff7add2206d385dab0 Trickbot [View report](https://tria.ge/reports/191018-tgvqksr3x6/task1)\n\need62d01218a450c4130ca196256b90cb815a987 Trickbot [View report](https://tria.ge/reports/191018-jnffne1l7x/task1)\n\nf0a6bef71d57feee7c036899edc337bc1fb69160 Trickbot [View report](https://tria.ge/reports/191018-tfbpyxqage/task1)\n\nfec98b8cdd890124ce5c203a64b38050f5459801 Trickbot [View report](https://tria.ge/reports/191018-qj96et9cnj/task1)\n\n### Country\n\nOne important thing to keep in mind is that it depends on the country from which we make\nthe request the botnet will serve some files or others. So for the tracking has been used a\nVPN to make the request from different countries.\n\nThree different scenarios can happen when we connect from a specific country:\n\n1. The country from which we connect is not among Emotet’s objectives and we do not\n\nreceive any module.\n2. The Country from which we connect only receives modules but not malware. In this\n\ncase, it can be said that this Country is a possible target of Emotet and at that moment\nit is not distributing malware for that Country.\n\n\n-----\n\n3. The Country from which we connect receives the modules and the malware. In this\n\ncase it can be said 100% that this country is a target of Emotet and that they are\ncurrently spreading malware in their botnet.\n\n### Wrong approach but cool map\n\nAfter a few days inside Emotet’s botnet I noticed the following, each bot registered in the\nbotnet is uniquely identified by the `bot_id that is sent to the server (it makes sense) and is`\nidentified in all botnets.\n\n**What does this mean in terms of tracking? Once a bot is registered in the botnet it will**\n**always receive the same files regardless of the Country from which it connects and**\nregardless of which of the 3 knoen botnets it connects.\n\nFor example:\n\nYou create a bot using the emulator with the bot id `D00RT_PC`\nYou connect from Japan to botnet 1\nYou receive 3 modules and 1 malware\n\nFrom that moment if you connect again with the bot id `D00RT_PC from any country and to`\nany botnet, the same modules and the same malware will always be received.\n\nWhen I started to track Emotet I didn’t know this, so my first approach was to always use the\nsame bot id and connect from all countries.\n\n\n-----\n\nAs already explained this approach is not valid … but as I lost time in making this cool map\nand I like it, I leave here a video :D\n\nThe correct way of tracking Emotet is to create a new bot id every time we connect to the\nbotnet. Although this does not always work as explained in the next section and can\ngenerate a lot of noise in the servers controlled by the actors.\n\n### Problems communicating with the botnet\n\nEven having all the knowledge of how the protocol works (from the client side) certain\nproblems have been encountered when communicating with the C&C. Here is a list of things\nto keep in mind in order to make a successful communication:\n\nThe bot id. This field is decisive because sometimes I think I have been banned based\non the bot id. I have also had the feeling that once a bot has been served with a\nmalware, it has a few days of use and then it is banned from the botnet to not distribute\nmore malware (this is just a theory based on my experience).\nCountry. It is important to connect from a country that is among the targets of Emotet.\notherwise we will not get an answer.\nTime and day. I noticed that on weekends the botnets are not usually active so you\nhave to take this into account. Also the time at which you connect can also affect the\ntime to have an answer or another from the C&C.\n\n\n-----\n\n## Interesting related articles\n\n1. [Analysis of Emotet v4](https://www.cert.pl/en/news/single/analysis-of-emotet-v4/) \nPaweł Srokosz\n[2. Exploring Emotet, an elaborate everyday enigma -](https://www.virusbulletin.com/uploads/pdf/conference_slides/2019/VB2019-Nagy.pdf) [Luca Nagy](https://twitter.com/luca_nagy_)\n\n[3. Emotet: The Tricky Trojan that ‘Git Clones - Ofer Caspi, Ben Herzog](https://research.checkpoint.com/emotet-tricky-trojan-git-clones/)\n\n## Last notes\n\nThe Emotet network protocol may change after this release, sorry to all researchers who will\nhave to modify the bot. I’ve seen how the protocol has changed 3 times since I’ve been\nfollowing this family, so if not for this reason they would change it for another reason.\n\nI hope at least that it helps the community to trace this family (until the protocol changes) and\nthat people who are starting in this world know how these advanced malwares work and how\nto trace them.\n\nI want to give a shout-out to [Cryptolaemus,](https://twitter.com/Cryptolaemus1) [Joseph Roosen and the group of researchers for](https://twitter.com/JRoosen)\nthe excellent job tracking the documents, links and binaries that are distributed every day by\nSPAM or whatever by Emotet actors. Also thanks to [CAPE and](https://capesandbox.com/) [Triage for suppoting Emotet](https://tria.ge/)\nconfig extractor :D\n\nI don’t have much time to maintain this repository although I’m open to improvements and\nsuggestions. I will try to answer questions when I can. Sorry, I don’t think I can update the\nrepository very often. Bills don’t pay themselves.\n\nThanks for reading to the end and I hope you enjoyed it as much as I enjoyed doing the bot.\n\n– [d00rt –](https://twitter.com/D00RT_RM)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-31 - Emutet.pdf"
    ],
    "report_names": [
        "2020-01-31 - Emutet.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535552,
    "ts_updated_at": 1743041134,
    "ts_creation_date": 1653692973,
    "ts_modification_date": 1653692973,
    "files": {
        "pdf": "https://archive.orkl.eu/3e232395e3b747dedb92bdedda8798bb36a809f1.pdf",
        "text": "https://archive.orkl.eu/3e232395e3b747dedb92bdedda8798bb36a809f1.txt",
        "img": "https://archive.orkl.eu/3e232395e3b747dedb92bdedda8798bb36a809f1.jpg"
    }
}