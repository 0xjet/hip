{
    "id": "b1c56fa6-ec50-45e0-8a68-295994c21aa2",
    "created_at": "2023-01-12T15:04:15.9711Z",
    "updated_at": "2025-03-27T02:05:52.790736Z",
    "deleted_at": null,
    "sha1_hash": "8e80f251a61abce6b42568dbdb16990b846ae079",
    "title": "2018-02-23 - Avzhan DDoS bot dropped by Chinese drive-by attack",
    "authors": "",
    "file_creation_date": "2022-05-28T02:31:33Z",
    "file_modification_date": "2022-05-28T02:31:33Z",
    "file_size": 575196,
    "plain_text": "# Avzhan DDoS bot dropped by Chinese drive-by attack\n\n**[blog.malwarebytes.com/threat-analysis/2018/02/avzhan-ddos-bot-dropped-by-chinese-drive-by-attack/](https://blog.malwarebytes.com/threat-analysis/2018/02/avzhan-ddos-bot-dropped-by-chinese-drive-by-attack/)**\n\nhasherezade February 23, 2018\n\nThe Avzhan [DDoS bot has been known since 2010, but recently we saw it in wild again,](https://www.malwarebytes.com/ddos/)\n[being dropped by a Chinese drive-by attack. In this post, we’ll take a deep dive into its](https://blog.malwarebytes.com/threat-analysis/2018/02/chinese-criminal-experiments-with-exploits-in-drive-by-download-campaign/)\n[functionality and compare the sample we captured with the one described in the past.](https://www.arbornetworks.com/blog/asert/another-family-of-ddos-bots-avzhan/)\n\n## Analyzed sample\n\n[05dfe8215c1b33f031bb168f8a90d08e – The version from 2010 (reference sample)](https://www.virustotal.com/#/file/7c4f1ec0b56ee017f566fe2efc642b509cda3922d1b953c301ecd89e8b262da5/details)\n\n## Behavioral analysis\n\n**Installation**\n\n[After being deployed, the malware copies itself under a random name into a system folder,](https://www.malwarebytes.com/malware/)\nand then deletes the original sample:\n\n\n-----\n\nIts way to achieve persistence is by registering itself as a Windows Service. Of course, this\noperation requires administrator rights, which means for successful installation, the sample\nmust run elevated. There are no UAC bypass capabilities inside the bot, so it can only rely\non some external droppers, using exploits or social engineering.\n\nExample of added registry keys, related to registering a new service:\n\nWe find it also on the list of the installed services:\n\nThe interesting thing was also that the dropped main sample was infected with another\nmalware, Virut – a very old family (and crashing on 64 bit systems). Once it was deployed, it\nstarted to infect other executables on the disk. More about Virut we will cover in another\npost.\n\n**Network traffic**\n\n\n-----\n\nWe can see that the bot connects to its CnC:\n\nLooking at the network traffic, we see the beacon that is sent. It is in a binary format and\ncontains information collected about the victim system:\n\n[The beacon is very similar to the one described in 2010 by Arbor Networks here. The server](https://www.arbornetworks.com/blog/asert/another-family-of-ddos-bots-avzhan/)\nresponds with a single NULL byte.\n\nDuring the experiments, we didn’t capture traffic related to the typical DDoS activities\nperformed by this bot. However, we can see such capabilities clearly in the code.\n\n## Inside the sample\n\n**Stage 1: the loader**\n\nThe sample is distributed in a packed form. The main sample’s original name is Cache.dat,\nand it exports one function: Ip.\n\n\n-----\n\nLooking inside the Ip, we can easily read that it creates a variable, fills it with strings, and\nthen returns it:\n\n\n-----\n\nThose are the same parameters that we observed during the behavioral analysis. For\nexample, we can see that the service name is “Nationalscm” and the referenced server,\nprobably CnC is: wm.shiquanxian.cn:8080 (that resolves to: 103.85.226.65:8080). So, this is\nlikely the function responsible for filling those parameters and passing them further.\n\nThe main function of this executable is obfuscated, and the flow of the code is hard to follow\n—it consists of small chunks of code connected by jumps, in between of which junk\ninstructions are added:\n\nHowever, just below the function Ip, we see another one that looks readable:\n\n\n-----\n\nLooking at its features, we see that it is a good candidate for a function that actually unpacks\nand installs the payload in the following process:\n\n1. It takes some hardcoded buffer and processes it—that looks like de-obfuscating the\n\npayload.\n2. It searches a function “StartupService” in the export table of the unpacked payload—it\n\ngives us hint that the unpacked content is a PE file.\n3. Finally, it calls the found function within the payload.\n\nWe can confirm this by observing the execution under the debugger. After the decoding\nfunction was called, we see that indeed the buffer becomes a new PE file:\n\n\n-----\n\nAt this moment, we can dump the buffer, trim it, and analyze it separately. It turns out that\nthis is the core of the bot, performing all of the malicious operations. The PE file is in the raw\nformat, so no unmapping is needed. Further, the loader will allocate another area of memory\nand map there the payload into the Virtual Format so that it can be executed.\n\nAnti-dumping tricks\n\nThis malware uses few tricks to evade automated dumpers. First of all, the payload that is\nloaded is not aligned to the beginning of the page:\n\nIf we dump it at this moment, we would also need to unmap it (i.e. by pe_unmapper)\nbecause this time it is in the Virtual Format. However, there are some unpleasant surprises:\nThe relocation table and resources have been removed after use by the loader. This is why it\nis usually more reliable to dump the payload before it is mapped. However, some of the data\ninside the payload may be also filled on load. So if we don’t dump both versions, we may\npossibly miss some information.\n\n\n-----\n\nIn the version from 2010, the outer layer is missing. The malware is distributed via a single\nexecutable that is an equivalent of the payload unpacked from the current sample.\n\n**Stage 2: the core**\n\nBy following the aforementioned steps, we obtain the core DLL, named Server.dll. We find\nthat the core is pretty old—this hash was seen for the first time on VirusTotal more than a\nyear ago. However, it was not described in detail at that time, so I think it is still worth\nanalyzing.\n\nThe sample from 2010, in contrast, is not a DLL but a standalone EXE. Yet, looking at the\nstrings and comparing both with the help of BinDiff, we can see striking similarities that prove\nthat the core didn’t evolve much.\n\n**Execution flow**\n\nThe execution starts in the exported function: StartupServer. At the beginning, the sample\ncalls OutputDebugStringA with non-ascii content. What’s interesting is that the content is not\nrandom. The same bytes were used previously in the loader, just before executing the\nfunction within the payload. Yet, its purpose remains unknown.\n\n\n-----\n\nIt also tries to check if the current DLL has been loaded by the main module that exports a\nfunction “Ip.” If it is so, it calls it:\n\nAs we remember, the function with exactly this name was exported by the outer layer. It was\nsupposed to retrieve the configuration of the bot, such as the CnC address and Windows\nService name. After being retrieved, the data gets copied into the bot’s data section (the\nconfiguration gets hardcoded into the bot).\n\nAfter that, the malware proceeds with its main functionality. We can see that the data that got\nretrieved and hardcoded is later being passed to the function installing the service:\n\n\n-----\n\nBased on the presence of the corresponding registry keys, the malware distinguishes if this\nis its first run or if it had already been installed. Depending on this information, it can take\nalternative paths.\n\nIf the malware was not installed yet, it proceeds with the installation and exits afterward:\n\nOtherwise, it runs its main service function:\n\n\n-----\n\nThe main service function is responsible for communication with the CnC. It deploys a thread\nthat reads commands and deploys appropriate actions:\n\n**Functionality**\n\nFirst the bot connects to the CnC and sends a beacon containing information gathered about\nthe victim system:\n\n\n-----\n\nThe information gathered is detailed, containing processor features as well as the Internet\nspeed. We saw this data being sent during the behavioral analysis.\n\nAfter the successful beaconing, it deploys the main loop, where is listens for the commands\nfrom the CnC, parses them, and executes:\n\nAs we can see, the malware can act as a downloader—it can fetch and deploy a new\nexecutable from the link supplied by the CnC:\n\n\n-----\n\nThe CnC can also push an update of the main bot, as well as instruct the bot to fully remove\nitself.\n\nBut the most important capabilities lie in few different DDoS attacks that can be deployed\nremotely on any given target. The target address, as well as the attack ID, are supplied by\nthe CnC.\n\n\n-----\n\nAmong the requests that are prepared for the attacks, we can see the familiar strings, whose\n[purpose was already described in the report from 2010. We can see the malformed GET](https://www.arbornetworks.com/blog/asert/another-family-of-ddos-bots-avzhan/)\nrequest:\n\n\n-----\n\nAs an alternative, it may use one of the valid GET requests, for example:\n\nThe flooding function is deployed in a new thread, and repeats the requests in a loop until\nthe stop condition is enabled. Example:\n\n\n-----\n\n## Conclusion\n\nThis bot is pretty simple, prepared by an unsophisticated actor. Featurewise, it hasn’t\nchanged much over years. The only additions were intended to obfuscate the malware and\ngive an ability to add the configuration by the outer layer.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-02-23 - Avzhan DDoS bot dropped by Chinese drive-by attack.pdf"
    ],
    "report_names": [
        "2018-02-23 - Avzhan DDoS bot dropped by Chinese drive-by attack.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535855,
    "ts_updated_at": 1743041152,
    "ts_creation_date": 1653705093,
    "ts_modification_date": 1653705093,
    "files": {
        "pdf": "https://archive.orkl.eu/8e80f251a61abce6b42568dbdb16990b846ae079.pdf",
        "text": "https://archive.orkl.eu/8e80f251a61abce6b42568dbdb16990b846ae079.txt",
        "img": "https://archive.orkl.eu/8e80f251a61abce6b42568dbdb16990b846ae079.jpg"
    }
}