{
    "id": "e07de6d6-b3b0-484c-8117-77317eb48f10",
    "created_at": "2023-05-06T02:08:07.48797Z",
    "updated_at": "2025-03-27T02:06:00.997476Z",
    "deleted_at": null,
    "sha1_hash": "be0a60110fddc3cb9f52ea1370d97ef5e53db80a",
    "title": "2023-04-18 - Automating Qakbot Detection at Scale With Velociraptor",
    "authors": "",
    "file_creation_date": "2023-05-05T02:04:11Z",
    "file_modification_date": "2023-05-05T02:04:11Z",
    "file_size": 2067292,
    "plain_text": "# Automating Qakbot Detection at Scale With Velociraptor\n\n**[rapid7.com/blog/post/2023/04/18/automating-qakbot-detection-at-scale-with/](https://www.rapid7.com/blog/post/2023/04/18/automating-qakbot-detection-at-scale-with/)**\n\nRapid7 April 18, 2023\n\n_Last updated at Sat, 22 Apr 2023 20:06:03 GMT_\n\n_By Matt Green, Principal Software Engineer_\n\nIn this blog, you will learn a practical methodology to extract configuration data from recent\nQakbot samples. I will provide some background on Qakbot, then walk through decode\nthemes in an easy to visualize manner. Additionally, I'll share a [Velociraptor artifact to detect](https://www.rapid7.com/products/velociraptor/)\nand automate the decode process at scale.\n\nQakBot or QBot, is a modular malware first observed in 2007 that has been historically\nknown as a banking Trojan. Qakbot is used to steal credentials, financial, or other endpoint\ndata, and in recent years, regularly a loader for other malware leading to hands-on-keyboard\nransomware.\n\nMalicious emails typically include a zipped attachment, LNK, Javascript, Documents, or an\nembedded executable. The example shown in this post was delivered by an email with an\nattached pdf file:\n\nAn example Qakbot infection chain\nQakbot has some notable defense evasion capabilities including:\n\n1. Checking for Windows Defender sandbox and terminating on discovery.\n2. Checking for the presence of running anti-virus or analysis tools, then modifying its\n\nlater stage behavior for evasion.\n3. Dynamic corruption of payload on startup and rewrite on system shutdown.\n\nDue to the commodity nature of Qakbot delivery, capabilities, and end game, it is worth\nextracting configuration from observed samples to scope impact from a given campaign.\nHunting enterprise-wide and finding a previously missed machine or discovering an\nineffective control can prevent a domain-wide ransomware event or similar cyber attacks.\n\n\n-----\n\n## Configuration\n\nQakbot has an RC4 encoded configuration, located inside two resources of the unpacked\npayload binary. The decryption process has not changed significantly in recent times, but for\nsome minor key changes. It uses a SHA1 of a hard coded key that can typically be extracted\nas an encoded string in the .data section of the payload binary. This key often remains static\nacross campaigns, which can speed up analysis if we maintain a recent key list.\n\nCurrent samples undergo two rounds of RC4 decryption with validation built in. The\nvalidation bytes dropped from the data for the second round.\n\nAfter the first round:\n\nThe first 20 bytes in hex is for validation and is compared with the SHA1 of the\nremaining decoded data\nBytes [20:40] is the key used for the second round of decoding.\nThe Data to decode is byte [40:] onwards\nThe same validation process occurs for the second round decoded data\nVerification = data[:20]\nDecodedData = data[20:]\n\n\n-----\n\nFirst round\n\nof Qakbot decode and verification\n\nCampaign information is located inside the smaller resource where, after this decoding and\nverification process, data is clear text.\n\nThe larger resource stores Command and Control configuration. This is typically stored in\nnetaddress format with varying separators. A common technique for finding the correct\nmethod is searching for common ports and separator patterns in the decoded data.\n\n\n-----\n\nEasy to spot C2 patterns: port 443\n\n## Encoded strings\n\nQakbot stores blobs of xor encoded strings inside the .data section of its payload binary. The\ncurrent methodology is to extract blobs of key and data from the referenced key offset which\nsimilarly is reused across samples.\n\nCurrent samples start at offset 0x50, with an xor key, followed by a separator of 0x0000\nbefore encoded data. In recent samples, we have observed more than one string blob and\nthese have occurred in the same format after the separator.\n\n\n-----\n\nEncoded strings .data\n\nNext steps are splitting on separators, decode expected blob pairs and drop any non\nprintable. Results are fairly obvious when decoding is successful as Qakbot produces clean\nstrings. I typically have seen two well defined groups with strings aligning to Qakbot\ncapabilities.\n\n\n-----\n\nDecoded strings: RC4 key highlighted‌\n\n## Payload\n\nQakbot samples are typically packed and need execution or manual unpacking to retrieve\nthe payload for analysis. It's very difficult to obtain this payload remotely at scale, in practice\nthe easiest way is to execute the sample in a VM or sandbox that enables extracting the\npayload with correct PE offsets.\n\nWhen executing locally Qakbot typically injects its payload into a Windows process, and can\nbe detected with yara targeting the process for an unbacked section with\n`PAGE_EXECUTE_READWRITE` protections.\n\nBelow, we have an example of running PE-Sieve / Hollows Hunter tool from Hasherezade.\nThis helpful tool enables detection of several types of process injection, and the dumping of\ninjected sections with appropriately aligned headers. In this case, the injected process is\n`wermgr.exe` but it's worth to note, depending on variant and process footprint, your injected\nprocess may vary.\n\n\n-----\n\nDumping Qakbot payload using pe-sieve\n\n## Automation at scale\n\nNow I have explained the decode process, time to enable both detection and decode\nautomation in Velociraptor.\n\n[I have recently released Windows.Carving.Qakbot which leverages a PE dump capability in](https://docs.velociraptor.app/exchange/artifacts/pages/qakbot/)\nVelociraptor 0.6.8 to enable live memory analysis. The goal of the artifact was to automate\nmy decoding workflow for a generic Qakbot parser and save time for a common analysis. I\nalso wanted an easy to update parser to add additional keys or decode nuances when\nchanges are discovered.\n\n\n-----\n\nWindows.Carving.Qakbot: parameters\nThis artifact uses Yara to detect an injected Qakbot payload, then attempts to parse the\npayload configuration and strings. Some of the features in the artifact cover changes\nobserved in the past in the decryption process to allow a simplified extraction workflow:\n\nAutomatic PE extraction and offset alignment for memory detections.\nStringOffset: the offset of the string xor key and encoded strings is reused regularly.\nPE resource type: the RC4 encoded configuration is typically inside 2 resources, I’ve\nobserved BITMAP and RCDATA\nUnescaped key string: this field is typically reused over samples.\nType of encoding: single or double, double being the more recent.\nHidden TargetBytes parameter to enable piping payload in for analysis.\nWorker threads: for bulk analysis / research use cases.\n\n\n-----\n\nWindows.Carving.Qakbot: live decode\n\n## Research\n\nThe Qakbot parser can also be leveraged for research and run bulk analysis. One caveat is\nthe content requires payload files that have been dumped with offsets intact. This typically\nrequires some post collection filtering or PE offset realignment but enables Velociraptor\nnotebook to manipulate post processed data.\n\nSome techniques I have used to bulk collect samples:\n\nSandbox with PE dumping features: api based collection\nVirustotal search: crowdsourced_yara_rule:0083a00b09|win_qakbot_auto AND\n_tag:pedll AND NOT tag:corrupt (not this will collect some broken payloads)_\n\n\n-----\n\nBulk collection: IPs seen across multiple campaign names and ports\nSome findings from a small data set ~60 samples:\n\nNamed campaigns are typically short and not longer than a few samples over a few\ndays.\nIP addresses are regularly reused and shared across campaigns\nMost prevalent campaigns are “BB” and “obama” prefixed\nMinor campaigns observed: “azd”, “tok” and “rds” with only one or two observed\npayload samples each.\n\nStrings analysis can also provide insights to sample behavior over time to assist analysis. A\ngreat example is the adding to process name list for anti-analysis checks.\n\nBulk collection: Strings highlighting anti-analysis check additions over time\n\n## Conclusion\n\n\n-----\n\nPE dumping, which is not available in expensive paid tools, is a useful capability and enables\nadvanced capability at enterprise scale. For widespread threats like Qakbot, this kind of\ncontent can significantly improve response for blue teams, or even provide insights into\nthreats when analyzed in bulk. In the coming months, we will be publishing a series of similar\nblog posts, offering a sneak peek at some of the types of memory analysis enabled by\nVelociraptor and incorporated into our training courses.\n\nI also would like to thank Jakob Denlinger and James Dunne for their assistance in writing\nthis post.\n\n**References**\n\n1. [Malpedia, QakBot](https://malpedia.caad.fkie.fraunhofer.de/details/win.qakbot)\n2. [Elastic, QBOT Malware Analysis](https://www.elastic.co/security-labs/qbot-malware-analysis)\n3. @hasherezade. Hollows Hunter, [https://github.com/hasherezade/hollows_hunter](https://github.com/hasherezade/hollows_hunter)\n\n## Never miss a blog\n\nGet the latest stories, expertise, and news about security today.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-04-18 - Automating Qakbot Detection at Scale With Velociraptor.pdf"
    ],
    "report_names": [
        "2023-04-18 - Automating Qakbot Detection at Scale With Velociraptor.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1683338887,
    "ts_updated_at": 1743041160,
    "ts_creation_date": 1683252251,
    "ts_modification_date": 1683252251,
    "files": {
        "pdf": "https://archive.orkl.eu/be0a60110fddc3cb9f52ea1370d97ef5e53db80a.pdf",
        "text": "https://archive.orkl.eu/be0a60110fddc3cb9f52ea1370d97ef5e53db80a.txt",
        "img": "https://archive.orkl.eu/be0a60110fddc3cb9f52ea1370d97ef5e53db80a.jpg"
    }
}