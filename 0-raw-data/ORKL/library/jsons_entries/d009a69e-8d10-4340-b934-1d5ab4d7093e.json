{
    "id": "d009a69e-8d10-4340-b934-1d5ab4d7093e",
    "created_at": "2023-01-12T15:08:38.190792Z",
    "updated_at": "2025-03-27T02:05:55.181378Z",
    "deleted_at": null,
    "sha1_hash": "a1007b0fc9faeed55c4b84f94a78895eeaced0ce",
    "title": "2021-08-17 - LockBit Ransomware Analysis Notes",
    "authors": "",
    "file_creation_date": "2022-07-18T18:07:05Z",
    "file_modification_date": "2022-07-18T18:07:05Z",
    "file_size": 2677610,
    "plain_text": "# LockBit Ransomware Analysis Notes\n\n**[amgedwageh.medium.com/lockbit-ransomware-analysis-notes-93a542fc8511](https://amgedwageh.medium.com/lockbit-ransomware-analysis-notes-93a542fc8511)**\n\nAmged Wageh August 17, 2021\n\n[Amged Wageh](https://amgedwageh.medium.com/?source=post_page-----93a542fc8511--------------------------------)\n\nAug 17, 2021\n\n\n14 min read\n\nLockBit is a relatively new family of ransomware that has been discovered for the first time in\n2019, and since then, it keeps evolving in both the social and the technical aspects to keep\nup with the modern ransomware, for example, in the newest versions, the ransom-note\ncontains a threat to the victims to leak their private data if the victim just restored his data\nfrom a backup and didnâ€™t pay the ransom, they explicitly reminds them with the GDPR as a\ndirect way of extortion, as for the technical aspect, they started using multi-threading to\nenhance the performance of the malware and some other technical details that will be\ndescribed in this story .\n\nSo, letâ€™s take a closer look at a sample that have been recently published.\n\n## Sample Info.\n```\n   5761ee98b1c2fea31b5408516a8929ea\n   4d043df23e55088bfc04c14dfb9ddb329a703cc1\n   0a937d4fe8aa6cb947b95841c490d73e452a3cafcd92645afc353006786aba76\n   0x5E4A2B92 (Sun Feb 16 21:58:42 2020)\n\n```\nNOTE: This is the final payload so, weâ€™ll directly dive into the real nefarious stuff of the\nmalware.\n\n## A Quick Look\n\nBy having a very quick look at the sample to get an idea of what kind of binary weâ€™ll be\ndealing with, it appears that the the section names are very normal, the entropy are a little\nhigh for the `.text and the` `.rdata sections but not that high, which indicates that most`\nprobably this binary is not packed however, it applies some obfuscation techniques.\n\n\n-----\n\nThe Sections Entropy\n\n## A Quick Behavioral Analysis\n\nNOTE: I usually give the binary any arbitrary name because I donâ€™t know yet what kind\nof anti-analysis techniques are being applied so, â€œlockbit.exeâ€ and â€œanghami.exeâ€ are\nthe same binary. â€” just so you donâ€™t be confused if youâ€™ve noticed that in that\nscreenshots below.\n\nBy having a quick look at the process tree of the malware, we can see a bunch of\n```\ndllhost.exe executions with CLSIDs of COM objects that are known to be vulnerable to\n\n```\nUAC bypassing, one of them spawns the `lockbit.exe process.`\n\n\n-----\n\nUAC Bypassing\nAlso, we can easily notice that it tries to inhibit the system recovery by deleting the shadow\ncopy, deleting the windows backup catalog, and modifying the boot configuration to disable\nwindows automatic recovery features.\n\nThe Process Tree\nNeglecting the fact that we already know that weâ€™re dealing with a ransomware, that behavior\nis a quick give away that most probably this is the case.\n\nWe can also see that, for some reason, it tries to scan the network by sending a tons of ARP\nrequests to the entire network.\n\nNetwork Scanning\nAnd it will try to connect via port 445 (SMB)\n\n\n-----\n\nSMB Connection\nRegarding the Registry, weâ€™ll notice a huge amount of activities that are related to registry\naccess and modification, but the ones that weâ€™re most interested in are the following keys,\n```\n   SOFTWARE\\LockBit\n   SOFTWARE\\LockBit\\full\n   SOFTWARE\\LockBit\\Public\n   HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\XO1XADpO01\n\n```\nRegistry Modification\nFinally, the background will be changed and all the files will be encrypted and has the\n```\n.lockbit extension.\n\n```\n\n-----\n\nChanging The Background\nAnd of course, the ransom-note will be dropped.\n\nDropping The Ransom-Note\n\n## Analysis Notes\n\n\n-----\n\nAfter performing a full static analysis to the sample and adding meaningful names to the\nvariables and functions, adding few comments to the important sections of code, deobfuscating the strings, and validating the results with a full behavioral analysis, here is some\ninteresting snippets from the malware that could help us understanding the behavior of it and\nbuild detection for it.\n\n## Anti Debugging\n\nThe malware checks the `NtGlobalFlag which exists in the` `PEB (Process Environment`\nBlock) at offset `0x68 to know whether or no the process is being debugged. It performs a`\n```\nTEST to check the value of the flag, if it equals 0x70 (which means the process is being\n\n```\ndebugged), the execution will be transferred to a block of code that exists the process.\n\nAnti Debugging\nAlso, The malware has multiple calls to `Sleep with high number of seconds, this usually`\nbeing done to avoid being automatically analyzed inside a free sandbox, as most of the free\nsandboxes limit the amount of execution time to a limited number of minutes.\n\n## Token Impersonation\n\nThe malware will try to impersonate the token of the logged on user via the physical console\nby firstly getting session identifier of the console session by calling\n```\nWTSGetActiveConsoleSessionId then it will pass that sessionId to\nWTSQueryUserToken to obtain the primary access token of the logged user, if it fails to get\n\n```\nthe token, it will create the process with the current security context by calling\n```\nCreateProcessW however, if it manages to get the userâ€™s access token, it will duplicate the\n\n```\ntoken by calling `DuplicateTokenEx then it will use the duplicate token to create the new`\nprocess using `CreateProcessAsUserW .`\n\n\n-----\n\nToken Impersonation\nUsually malware use this technique for two reasons:\n\n1. if the impersonated user has a higher privilege.\n2. to bypass access controls.\n\n## String Obfuscation\n\nThis sample has all of its strings encrypted via a simple `XOR encryption with a unique key`\nfor each string, each encrypted sequence of bytes will have the fist byte as the key. The\nmalware first loads the encrypted strings onto the stack then, it runs the decryption loop. This\nloop is being noticed in almost all the functions.\n\n\n-----\n\nXOR Decryption\nHere is a very simple python function I wrote to help me decrypting the strings. This function\ntakes the hex values as a string then it will decrypt it.\n```\nimport binasciidef xor_decrypt(data): data = binascii.unhexlify(data) key = data[0]\nresult = '' for byte in data:  result += chr(byte ^ key)return result\n\n## Debugging Messages\n\n```\nThis malware does something very cool which is printing what seems to be debugging\nmessages to a hidden console window. For the malware to be stealthier as much as it could\nbe, all the strings are obfuscated using the same `XOR encryption algorithm we discussed,`\nafter de-obfuscating all the strings and tracking them, analyzing the sample has became\nmuch easier.\n\n\n-----\n\nPrinting Debugging Messages\n\n## Generating And Storing the Decryption Keys\n\nThe malware uses two algorithms for the encryption which are RSA and AES.\n\n\n-----\n\nFirstly, The malware will generate an RSA session key pair then, it will encrypt the private\nkey using a hard-coded public key then, it stores the encrypted key in the\n```\nSOFTWARE\\LockBit\\full registry key and the public key will be stored in\nSOFTWARE\\LockBit\\Public\n\n```\nCreating The SOFTWARE\\LockBit Reg. Key\nThe malware will randomly generate a new AES key for each file. Once itâ€™s being used for\nencrypting the file, the AES key will be encrypted using the RSA public session key and\nappended to the end of the encrypted file. The debugging messages that we mentioned\nearlier have made it easy to detect the function that will generate the session keys as the deobfuscated string says â€œ Generating session keysâ€!\n\n\n-----\n\nSession Keys Generation\nThe following snippets show the keys storing and querying.\n\n\n-----\n\nQuerying The Keys\nFor generating the random numbers, LockBit will use `LoadLibraryA and`\n```\nGetProcAddress to dynamically load bcrypt.dll for importing the BCryptGenRandom\n\n```\nAPI for generating 32 bytes of random numbers, and if it couldnâ€™t load the necessary\nlibraries, itâ€™ll call `CryptAcquireContextW and` `CryptGenRandom to get the job done.`\n\nGenerating Random Numbers\n\n## Utilizing IOCP (Completion I/O ports)\n\nAs we mentioned earlier, LockBit has been technically evolved, one of the technical aspects\nis using the [Windows I/O Completion ports mechanism for providing an efficient threading](https://docs.microsoft.com/en-us/windows/win32/fileio/i-o-completion-ports#:~:text=I%2FO%20completion%20ports%20provide,is%20to%20service%20these%20requests.)\nmodel for processing multiple asynchronous I/O requests on a multiprocessor system.\n\n\n-----\n\nCreating Completion I/O Ports\nThe malware has each function of its behavior separated in a subroutine, it creates an I/O\ncompletion port by calling `CreateIoCompletionPort then, it will enter a loop to create a`\nbunch of threads by calling either one of the undocumented and more stealthier following\nAPIs `NtCreateThreadEx or` `RtlCreateUserThread and it will set the entry point of each`\nthread to one of the subroutines. After that, `NtSetInformationThread will be called for`\nsetting the thread priority for each created thread.\n\n\n-----\n\nThreads Creation\n\n## Privilege Escalation\n\nFirstly, LockBit checks its privileges by getting the process token by calling\n```\nNtOpenProcessToken then, it queries that token via NtQueryInformationToken after\n\n```\nthat, it creates a user security identifier (SID) that matches the administrator group by\npassing `WinBuiltinAdministratorsSid to` `CreateWellKnownSid . Finally, it calls`\n```\nCheckTokenMembership to check whether the current process privileges include the\n\n```\nAdministrator privileges or not.\n\n\n-----\n\nChecking Privileges\n[If it doesnâ€™t include the Administrator privileges, LockBit will perform a UAC bypassing by](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works)\n[calling a windows COM objects that can auto-elevate, and for masquerading, LockBit](https://docs.microsoft.com/en-us/windows/win32/com/the-component-object-model#:~:text=A%20COM%20object%20is%20one,an%20interface%20are%20called%20methods.)\nimplements a publicly available function called `supMasqueradeProcess which allows the`\nmalware to conceal its process information by injecting into a process that runs in a trusted\ndirectory, it choose `explorer.exe to be its target.`\n\n\n-----\n\n```\nsupMasqueradeProcess Implementation\n\n```\n\n-----\n\nFor the actual UAC bypassing, LockBit will call `CoGetObject with the following CLSIDs:`\n```\n   {3E5FC7F9â€“9A51â€“4367â€“9063-A120244FBEC7}\n   {D2E7041B-2927â€“42fb-8E9F-7CE93B6DC937}\n\n```\nCalling CoGetObject\n\n\n-----\n\nQuerying The CLSIDs and Creating The dllhost.exe procsses\n\n## Killing Processes\n\nLockBit calls `CreateToolhelp32Snapshot for getting a snapshot of the running processes`\nthen, it uses `Process32First and` `Process32Next to enumerate the snapshot. For each`\nprocess, itâ€™ll compare its name against a list of a process, and if it matches, it well pass the\nprocess handle that it got by calling `OpenProcess to` `TerminateProcess to terminate the`\nprocess. The list of the processes was also encrypted using `XOR .`\n\n\n-----\n\nProcess Termination\n\n\n-----\n\nProcess Names After Being Decrypted In Memory\n**And here is a list of the process that will be terminated if exists:**\n```\nwxServerwxServerViewsqlmangrRAguisuperviseCultureDefwatchwinwordQBW32QBDBMgrqbupdateax\n CloudAdobe Desktop ServiceCoreSyncAdobe CEF HelpernodeAdobeIPCBrokersynctaskbarsyncworkerInputPersonalizationAdobeCollabSyncBrCtrlCntrBrCcUxSysSimplyConnectionManagerSim\nexp-engineserviceTeamViewer_ServiceTeamViewertv_w32tv_x64TitanVSsmsnotepadRdrCEForacleocssddbsnm\n\n## Stopping Services\n\n```\nLockBit has a list of services that will try to stop by calling `OpenSCManagerA to establish a`\nconnection to the service control manager on the local computer\n\nthen, it loops over a list of predefined services passing each service to `OpenServiceA to`\ncheck the existent of that service, if the service exists, itâ€™ll check its status by calling\n```\nQueryServiceStatusEx and it will call ControlService with the parameter\n0x00000001:\nSERVICE_CONTROL_STOP to stop the service. In order to not cause any crashes to the\n\n```\nsystem, LockBit will stop all the dependent services by calling `EnumDependentServicesA`\nbefore stopping the target service. Those services are mostly backup services, anti-virus\nservices, and other services that may lock some files due to having handles to them.\n\n\n-----\n\nStopping Some Services\n\n\n-----\n\nServices Names After Being Decrypted In Memory\n**Here is a list of the services that LockBit tries to stop:**\n```\nwrapperDefWatchccEvtMgrccSetMgrSavRoamSqlservrsqlagentsqladhlpCulserverRTVscansqlbrows\nusbarbitator64vmwareconverterdbsrv12dbeng8MSSQL$MICROSOFT##WIDMSSQL$VEEAMSQL2012SQLAgent$VEEAMSQL2012SQLBr\nExchangeMSSQL$MICROSOFT##SSEEMSSQL$SBSMONITORINGMSSQL$SHAREPOINTMSSQLFDLauncher$SBSMON\n\n## Excluding Files And Directories\n\n```\nTo avoid any system crashes and to make sure that the system has functional browsers for\nconnection and negotiation, besides avoiding entering an infinite loop of encrypting the\nalready encrypted files and not to encrypt the ransom-notes, LockBit has a list of files,\nfolders, and extensions exclusions.\n\n\n-----\n\nA List Of Exclusions\n**Here is the list of exclusions:**\n```\nwindowsintelrecycle.bintor browserwindowsntmsbuildmicrosoftall userssystem volume\ninformationperflogsgoogleappdatamozillamicrosoft .netmicrosoft sharedinternet\nexplorercommon filesopera intelwindows\njournalntldrntuser.dat.logbootsec.bakautorun.infthumbs.dbiconcahce.dbrestore-myfiles.txt.386.cmd.ani.adv.theme.msi.msp.com.diagpkg.nls.diagcab.lock.mpa.cpl.mod.hta.i\n\n## Mutex Creation\n\n```\n\n-----\n\nFor avoiding multiple infection on the same host, LockBit creates the following mutex\n```\nGlobal\\{BEF590BE-11A6â€“442A-A85B-656C1081E04C} . Firstly, it will try to open that mutex\n\n```\nby calling `OpenMutexA, if it succeeds, which means that host is already infected, it will exit`\nthe process, otherwise, itâ€™ll call `CreateMutexA for creating the mutex then, itâ€™ll proceed with`\nthe rest of the malware functionality.\n\nMutex Creation\n\n## Persistence\n\nIn order to maintain a persistence and to service reboots, LockBit creates the following\nregistry key\n```\nHKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVaersion\\Run\\XO1XADpO01 with a value of\n\n```\n\n-----\n\nit s path on disk.\n\nMaintaining Persistence\n\nAfter Decrypting The Key In Memory\n\n\n-----\n\n## Shutdown Prevention\n\nIn order to ensure that the encryption operation didnâ€™t get disrupted even by shutting the\nsystem down, LockBit will create a shutdown block reason by calling\n```\nShutdownBlockReasonCreate .\n\n```\nCreating Shutdown Block Reason\n\n## Netwrok Enumeration\n\n\n-----\n\nIn order to ensure infecting as many victims as possible, LockBit scans the attached drivers\nand network shares and when it finds files that meets its previously discussed requirements,\nitâ€™ll also encrypt those files.\n\nLockBit starts this function by calling `GetLogicalDrives to git a bitmask representing the`\ncurrently available disk drivers then, it loops over them and passed them to\n```\nGetDriveTypeW to determine the type of the driver whether it is a removable, fixed, CD\n```\nROM, RAM disk, or network drive, it specifically looking for `0x4: DRIVE_REMOTE . Once it`\nfinds a networked drive, it calls `WNetGetConnectionW to retrieve the name of that network`\nresource, then it will do a recursive calls to `WNetOpenEnumW and` `WNetEnumResourceW`\nenumerate the folders and files of that network resource.\n\nNetwork Enumeration\nLockBit can also access the network shares that require user credentials by calling\n```\nWNetAddConnection2W with lpUserName=0 and lpPassword=0 which automatically\n\n```\nsends the username and password of the currently logged in user.\n\n\n-----\n\nConnecting Over SMB\n\nConnecting To Shares With Creds.\n\n## The Ransom Note\n\nWhile LockBit is performing the encryption, it will drop a text file called `Restore-My-`\n```\nFiles.txt which is the ransom-note.\nAll your important files are encrypted!Any attempts to restore your files with the\nthrid-party software will be fatal for your files!RESTORE YOU DATA POSIBLE ONLY\nBUYING private key from us.There is only one way to get your files back:| 1. Download\nTor browser - and install it.| 2. Open link in TOR browser - ?A0C155001DD0CBxxxEDA0D\nThis link only works in Tor Browser! | 3. Follow the instructions on this page ###\nAttention! ### # Do not rename encrypted files. # Do not try to decrypt using third\nparty software, it may cause permanent data loss. # Decryption of your files with the\nhelp of third parties may cause increased price(they add their fee to our). # Tor\nBrowser may be blocked in your country or corporate network. Use or use Tor Browser\nover VPN. # Tor Browser user manual !!! We also download huge amount of your private\ndata, including finance information, clients personal info, network diagrams,\npasswords and so on.Don't forget about GDPR.\n\n```\nThe content of this file is also encrypted and it has been decrypted in memory before writing\nthe files.\n\n\n-----\n\nThe\n\nRansom-Note In Memory\n\n## Self Deleting\n\nAfter a successful execution, LockBit will delete its executable for reducing the artifacts it\nleaves on the infected system. In order to do that, it runs the following command `C ping`\n```\n1.1.1.1 -n 22 > Nul & \\ <the path to the executable>\n\n```\n\n-----\n\nSelf Deleting\n\n## Inhibiting System Recovery\n\nAs almost all ransomware does, LockBit will delete the volume shadow copies, the backup\ncatalog, disable automatic windows recovery, and clear the windows logs as well by running\nthe following commands.\n```\n/c vssadmin delete shadows /all /quiet & wmic shadowcopy delete & bcdedit /set\n{default} bootstatuspolicy ignoreallfailures & bcdedit /set {default} recoveryenabled\nNo & wbadmin delete catalog -quiet/c vssadmin Delete Shadows /All /Quiet/c bcdedit\n/set {default} recoveryenabled No/c bcdedit /set {default} bootstatuspolicy\nignoreallfailures/c wbadmin DELETE SYSTEMSTATEBACKUP/c wbadmin DELETE\nSYSTEMSTATEBACKUP -deleteOldest/c wmic SHADOWCOPY /nointeractive/c wevtutil cl\nsecurity/c wevtutil cl system/c wevtutil cl application\n\n```\nAfter Decrypting The Commands In Memory\n\n\n-----\n\nBehavioral Analysis Artifacts Of The Executed Commands\n\n## Mitre TTPs\n\nThe following is a list of the most important MITRE ATT&CK TTPs identified while analyzing\nthe malware.\n\nMitre TTPs\n\nThanks for reading, your comments and feedback are most welcomed ðŸ™‚\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-17 - LockBit Ransomware Analysis Notes.pdf"
    ],
    "report_names": [
        "2021-08-17 - LockBit Ransomware Analysis Notes.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536118,
    "ts_updated_at": 1743041155,
    "ts_creation_date": 1658167625,
    "ts_modification_date": 1658167625,
    "files": {
        "pdf": "https://archive.orkl.eu/a1007b0fc9faeed55c4b84f94a78895eeaced0ce.pdf",
        "text": "https://archive.orkl.eu/a1007b0fc9faeed55c4b84f94a78895eeaced0ce.txt",
        "img": "https://archive.orkl.eu/a1007b0fc9faeed55c4b84f94a78895eeaced0ce.jpg"
    }
}