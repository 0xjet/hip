{
    "id": "ebb9b72d-e5d1-4483-a870-34f83b0f8f32",
    "created_at": "2023-01-12T14:59:59.228678Z",
    "updated_at": "2025-03-27T02:05:49.248067Z",
    "deleted_at": null,
    "sha1_hash": "d8b0da1c1cd76230f0e75a140f656bcf7a6d7d61",
    "title": "2022-03-15 - Analysis of CaddyWiper, wiper targeting Ukraine",
    "authors": "",
    "file_creation_date": "2022-05-28T03:48:51Z",
    "file_modification_date": "2022-05-28T03:48:51Z",
    "file_size": 5197843,
    "plain_text": "# Analysis of CaddyWiper - Wiper Targeting Ukraine\n\n**[truesec.com/hub/blog/analysis-of-caddywiper-wiper-targeting-ukraine](https://www.truesec.com/hub/blog/analysis-of-caddywiper-wiper-targeting-ukraine)**\n\n### On the March 14, 2022, security company ESET found a third destructive wiper that has been deployed in Ukraine, called CaddyWiper. It has parts that are created to destroy data quickly and in several ways. ESET published their first initial analysis on Twitter Sample analyzed, SHA256: a294620543334a721a2ae8eaaf9680a0786f4b9a216d75b55cfd28f39e9430ea\n\n Truesec has looked into the wiper to understand its inner workings and find ways to detect the malware.\n\n## Malware Execution\n\n### According to the Twitter post by ESET the wiper is deployed by group policy to the infected system. Once run, as administrator, the system will crash and the following screen will be displayed.\n\n\n-----\n\n### Once the computer is rebooted it crashes and will not start anymore and prompt that it cannot locate the operating system.\n\n## Static Analysis\n\n### Investigating the time stamp for the sample, it indicates that is compiled on March 14, 2022, showing that it was done just before the attack was conducted.\n\n\n-----\n\n### Looking at the Import Address table, there is only one function called, DsRoleGetPrimaryDomainInformation, indicating that there are more functionalities in the malware that are hidden from static tools.\n\n If the sample is opened in a disassembler, in this case Ghidra, it can be seen that it uses a lot of stack strings for obfuscation.\n\n\n-----\n\n### To investigate the stack strings, and reveal what they are hiding, first the tool FLOSS was run on the sample that gave the following output.\n\n\n-----\n\n```\nFLOSS static ASCII strings\n!This program cannot be run in DOS mode.\nRich%\n.text\n`.rdata\n@.reloc\nDsRoleGetPrimaryDomainInformation\nNETAPI32.dll\nFLOSS static Unicode strings\njjjjjjjj0040113A\njjjjjj\nFLOSS decoded 13 strings\nC:\\Users\\\nC:\\Users\\*\nFindFirstFileA\nkernel32.dll\nD:\\\\\nD:\\\\*\nWriteFile\\\nadvapi32.dll\nSetEntriesInAclA\nLookupPrivilegeValueA\nDeviceIoControl\nCreateFileW\nWkernel32.dll\nFLOSS extracted 38 stackstrings\nC:\\Users\nnetapi32.dll\nkernel32.dll\nadvapi32.dll\nCreateFileA\nkernel32.dll\nFindFirstFileA\nOpenProcessToken\nCreateFileW\nAdjustTokenPrivileges\nWkernel32.dll\nFreeSid\nSetEntriesInAclA\nAllocateAndInitializeSid\nLocalFree\nSetFilePointer\nLookupPrivilegeValueA\nLocalAlloc\nLoadLibraryA\nGetLastError\nadvapi32.dll\nFindClose\nkernel32.dll\nDeviceIoControl\nCloseHandle\nCloseHandle\n\\kernel32.dll\nCloseHandle\n\n```\n\n-----\n\n```\nSeTakeOwnershipPrivilege\nadvapi32.dll\n\\\\.\\PHYSICALDRIVE9\nkernel32.dll\nLocalFree\nFindNextFileA\nGetFileSize\nGetCurrentProcess\nWriteFile\nSetNamedSecurityInfoA\n\n### To give context for the stacked strings the tool CAPA was used to find the different locations in the code where stacked strings are used.\ncontain obfuscated stackstrings (8 matches)\nnamespace anti-analysis/obfuscation/string/stackstring\nscope basic block\nmatches 0x401000\n0x40114A\n0x4011D0\n0x401750\n0x401A10\n0x402025\n0x40215E\n0x4022A0\n\n To get an overview of the intent of each function in relation to where the different stack strings are used for obfuscation, API calls and libraries are mapped to every function that CAPA found in the sample.\n0x401000 kernel32.dll, advapi32.dll, LoadLibraryA, netapi32.dll\n0x40114A netapi32.dll, netapi32.dll\n0x4011D0 DeviceIoControl, kernel32.dll, CreateFileW, CloseHandle, \\\\.\\PHYSICALDRIVE9\n0x401750 advapi32.dll, LookupPrivilegeValueA, AdjustTokenPrivileges, GetLastErrorc\n0x401A10 advapi32.dll, SetEntriesInAclA, AllocateAndInitializeSid,\nSetNamedSecurityInfoA, kernel32.dll, GetCurrentProcess, OpenProcessToken\n0x402025 SeTakeOwnershipPrivilege, FreeSid, LocalFree, CloseHandle\n0x40215E FreeSid, LocalFree, CloseHandle\n0x4022A0 FindFirstFileA, kernel32.dll, FindNextFileA, CreateFileA, GetFileSize,\nLocalAlloc, SetFilePointer, WriteFile, LocalFree, CloseHandle, FindClose\n\n## Execution Flow\n\n### Upon start the wiper uses the API call DsRoleGetPrimaryDomainInformation to check if the computer is the primary domain controller by comparing to the hard coded value 0x5, that comes from the struct DSROLE_MACHINE_ROLE. If it is the primary domain controller it will exit. This is probably done because the threat actor is using the domain controller as the source of distribution of the wiper and not to ruin its own foothold.\n\n```\n\n-----\n\n### The next part of the wiper is the file destruction part. It calls the function 0x4022A0 that iterates over the files, using the API calls that are resolved from the stack strings, and writes over the first 0xA00000 bytes with zeros.\n\n\n-----\n\n### Then the wiper loops through the alphabet (0x18), starting with D all the way up to Z and then one additional iteration, and applies the data destruction from the function in 0x4022A0 to the files in every partition it finds.\n\n\n-----\n\n### This is the last iteration and has gone past Z to Z+1.\n\n Lastly the wiper loops through a list of open raw access to \\\\\\\\.\\\\PHYSICALDRIVE9 - \\\\\\\\.\\\\PHYSICALDRIVE0 and writing to it using IOCTL_DISK_SET_DRIVE_LAYOUT_EX (0x7c054) by using the API DeviceIoControl. By doing so it erases the Master Boot Record.\n\n## Detection\n\n\n-----\n\n### Since the wiper is using stack strings for obfuscation of the part that interacts with the disk, that part can be used as Yara rule for detection.\n```\nrule caddy_wiper { \n meta:\n description = \"Search for caddy wiper\" \n author = \"Truesec\" \n reference = \"truesec.se\" \n date = \"2022-03-14\" \n hash1 = \"a294620543334a721a2ae8eaaf9680a0786f4b9a216d75b55cfd28f39e9430ea\"\n strings: \n $x1 = {c6 45 ?? 5c c6 45 ?? 00 c6 45 ?? 5c c6 45 ?? 00 c6 45 ?? 2e c6 45 ?? 00 c6 45\n?? 5c c6 45 ?? 00 c6 45 ?? 50 c6 45 ?? 00 c6 45 ?? 48 c6 45 ?? 00 c6 45 ?? 59 c6 45\n?? 00 c6 45 ?? 53 c6 45 ?? 00 c6 45 ?? 49 c6 45 ?? 00 c6 45 ?? 43 c6 45 ?? 00 c6 45\n?? 41 c6 45 ?? 00 c6 45 ?? 4c c6 45 ?? 00 c6 45 ?? 44 c6 45 ?? 00 c6 45 ?? 52 c6 45\n?? 00 c6 45 ?? 49 c6 45 ?? 00 c6 45 ?? 56 c6 45 ?? 00 c6 45 ?? 45} //Stack strings\nfor \\\\.\\PHYSICALDRIVE\n $x2 = {c6 45 ?? 44 c6 45 ?? 65 c6 45 ?? 76 c6 45 ?? 69 c6 45 ?? 63 c6 45 ?? 65 c6 45\n?? 49 c6 45 ?? 6f c6 45 ?? 43 c6 45 ?? 6f c6 45 ?? 6e c6 45 ?? 74 c6 45 ?? 72 c6 45\n?? 6f c6 45 ?? 6c c6 45 ?? 00 c6 45 ?? 6b c6 45 ?? 00 c6 45 ?? 65 c6 45 ?? 00 c6 45\n?? 72 c6 45 ?? 00 c6 45 ?? 6e c6 45 ?? 00 c6 45 ?? 65 c6 45 ?? 00 c6 45 ?? 6c c6 45\n?? 00 c6 45 ?? 33 c6 45 ?? 00 c6 45 ?? 32 c6 45 ?? 00 c6 45 ?? 2e c6 45 ?? 00 c6 45\n?? 64 c6 45 ?? 00 c6 45 ?? 6c c6 45 ?? 00 c6 45 ?? 6c c6 45 ?? 00 c6 45 ?? 00 c6 45\n?? 00 c6 45 ?? 43 c6 45 ?? 72 c6 45 ?? 65 c6 45 ?? 61 c6 45 ?? 74 c6 45 ?? 65 c6 45\n?? 46 c6 45 ?? 69 c6 45 ?? 6c c6 45 ?? 65 c6 45 ?? 57} //Stack strings for\nDeviceIoControl, kernel32.dll, CreateFileW \n $a1 = {c6 85 ?? fe ff ff 61 c6 85 ?? fe ff ff 00 c6 85 ?? fe ff ff 64 c6 85 ?? fe ff\nff 00 c6 85 ?? fe ff ff 76 c6 85 ?? fe ff ff 00 c6 85 ?? fe ff ff 61 c6 85 ?? fe ff\nff 00 c6 85 ?? fe ff ff 70 c6 85 ?? fe ff ff 00 c6 85 ?? fe ff ff 69 c6 85 ?? fe ff\nff 00 c6 85 ?? fe ff ff 33 c6 85 ?? fe ff ff 00 c6 85 ?? fe ff ff 32 c6 85 ?? fe ff\nff 00 c6 85 ?? fe ff ff 2e c6 85 ?? fe ff ff 00 c6 85 ?? fe ff ff 64 c6 85 ?? fe ff\nff 00 c6 85 ?? fe ff ff 6c c6 85 ?? fe ff ff 00 c6 85 ?? fe ff ff 6c c6 85 ?? fe ff\nff 00 c6 85 ?? fe ff ff 00 c6 85 ?? fe ff ff 00 c6 85 ?? ff ff ff 53 c6 85 ?? ff ff\nff 65 c6 85 ?? ff ff ff 74 c6 85 ?? ff ff ff 45 c6 85 ?? ff ff ff 6e c6 85 ?? ff ff\nff 74 c6 85 ?? ff ff ff 72 c6 85 ?? ff ff ff 69 c6 85 ?? ff ff ff 65 c6 85 ?? ff ff\nff 73 c6 85 ?? ff ff ff 49 c6 85 ?? ff ff ff 6e c6 85 ?? ff ff ff 41 c6 85 ?? ff ff\nff 63 c6 85 ?? ff ff ff 6c c6 85 ?? ff ff ff 41} //Stack strings for advapi32.dll\nSetEntriesinAclA\n $a2 = {c6 85 ?? ff ff ff 41 c6 85 ?? ff ff ff 6c c6 85 ?? ff ff ff 6c c6 85 ?? ff ff\nff 6f c6 85 ?? ff ff ff 63 c6 85 ?? ff ff ff 61 c6 85 ?? ff ff ff 74 c6 85 ?? ff ff\nff 65 c6 85 ?? ff ff ff 41 c6 85 ?? ff ff ff 6e c6 85 ?? ff ff ff 64 c6 85 ?? ff ff\nff 49 c6 85 ?? ff ff ff 6e c6 85 ?? ff ff ff 69 c6 85 ?? ff ff ff 74 c6 85 ?? ff ff\nff 69 c6 45 ?? 61 c6 45 ?? 6c c6 45 ?? 69 c6 45 ?? 7a c6 45 ?? 65 c6 45 ?? 53 c6 45\n?? 69 c6 45 ?? 64} //Stack strings for AllocateAndInitializeSid \n condition: \n uint16(0) == 0x5A4D\n and any of ($x*)\n or all of ($a*) and filesize < 50000\n}\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-15 - Analysis of CaddyWiper, wiper targeting Ukraine.pdf"
    ],
    "report_names": [
        "2022-03-15 - Analysis of CaddyWiper, wiper targeting Ukraine.pdf"
    ],
    "threat_actors": [
        {
            "id": "e3492534-85a6-4c87-a754-5ae4a56d7c8c",
            "created_at": "2022-10-25T15:50:23.819113Z",
            "updated_at": "2025-03-27T02:00:55.552554Z",
            "deleted_at": null,
            "main_name": "Threat Group-3390",
            "aliases": [
                "Threat Group-3390",
                "Earth Smilodon",
                "TG-3390",
                "Emissary Panda",
                "BRONZE UNION",
                "APT27",
                "Iron Tiger",
                "LuckyMouse"
            ],
            "source_name": "MITRE:Threat Group-3390",
            "tools": [
                "Systeminfo",
                "gsecdump",
                "PlugX",
                "ASPXSpy",
                "Cobalt Strike",
                "Mimikatz",
                "Impacket",
                "gh0st RAT",
                "certutil",
                "China Chopper",
                "HTTPBrowser",
                "Tasklist",
                "netstat",
                "SysUpdate",
                "HyperBro",
                "ZxShell",
                "RCSession",
                "ipconfig",
                "Clambling",
                "pwdump",
                "NBTscan",
                "Pandora",
                "Windows Credential Editor"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "5c13338b-eaed-429a-9437-f5015aa98276",
            "created_at": "2022-10-25T16:07:23.582715Z",
            "updated_at": "2025-03-27T02:02:09.875151Z",
            "deleted_at": null,
            "main_name": "Emissary Panda",
            "aliases": [
                "APT 27",
                "ATK 15",
                "Bronze Union",
                "Budworm",
                "Earth Smilodon",
                "Emissary Panda",
                "Group 35",
                "Iron Taurus",
                "Iron Tiger",
                "LuckyMouse",
                "Operation DRBControl",
                "Operation Iron Tiger",
                "Operation PZChao",
                "Operation SpoiledLegacy",
                "Operation StealthyTrident",
                "Red Phoenix",
                "TEMP.Hippo",
                "TG-3390",
                "ZipToken"
            ],
            "source_name": "ETDA:Emissary Panda",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Agent.dhwf",
                "AngryRebel",
                "Antak",
                "CHINACHOPPER",
                "China Chopper",
                "Destroy RAT",
                "DestroyRAT",
                "FOCUSFJORD",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HTTPBrowser",
                "HTran",
                "HUC Packet Transmit Tool",
                "HighShell",
                "HttpBrowser RAT",
                "HttpDump",
                "HyperBro",
                "HyperSSL",
                "HyperShell",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "Nishang",
                "OwaAuth",
                "PCRat",
                "PlugX",
                "ProcDump",
                "PsExec",
                "RedDelta",
                "SEASHARPEE",
                "Sensocode",
                "SinoChopper",
                "Sogu",
                "SysUpdate",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Token Control",
                "TokenControl",
                "TwoFace",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Xamtrav",
                "ZXShell",
                "gsecdump",
                "luckyowa"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535599,
    "ts_updated_at": 1743041149,
    "ts_creation_date": 1653709731,
    "ts_modification_date": 1653709731,
    "files": {
        "pdf": "https://archive.orkl.eu/d8b0da1c1cd76230f0e75a140f656bcf7a6d7d61.pdf",
        "text": "https://archive.orkl.eu/d8b0da1c1cd76230f0e75a140f656bcf7a6d7d61.txt",
        "img": "https://archive.orkl.eu/d8b0da1c1cd76230f0e75a140f656bcf7a6d7d61.jpg"
    }
}