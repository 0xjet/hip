{
    "id": "a4b35910-4748-4101-b11e-5b9a1c623dc6",
    "created_at": "2023-01-12T15:06:38.313553Z",
    "updated_at": "2025-03-27T02:06:00.495745Z",
    "deleted_at": null,
    "sha1_hash": "78c0c7d807933891e706d9a53f2bcf77c240c9e9",
    "title": "2020-05-26 - Weaponized Disk Image Files- Analysis, Trends and Remediation",
    "authors": "",
    "file_creation_date": "2022-05-28T21:42:41Z",
    "file_modification_date": "2022-05-28T21:42:41Z",
    "file_size": 3494867,
    "plain_text": "# Weaponized Disk Image Files: Analysis, Trends and Remediation\n\n**[crowdstrike.com/blog/weaponizing-disk-image-files-analysis/](https://www.crowdstrike.com/blog/weaponizing-disk-image-files-analysis/)**\n\nGuillermo Taibo May 26, 2020\n\nThroughout 2019 and the beginning of 2020, the CrowdStrike® Falcon CompleteTM team\ncontinuously observed a spike in the delivery of weaponized disk image files. Files such as\nISO and IMG were sent to infect systems with the goal of delivering remote access trojans\n(RATs) as well as a few other malware variants. We’ve identified that these files are typically\ndelivered via phishing campaigns as an attachment or link — a malicious URL in the body of\nthe email or within crack software downloads.\n\nCyber criminals have been taking advantage of built-in Windows capabilities to mount disk\nimage files once they are opened by the end user. There are multiple disk image file formats,\nbut we have seen ISO and IMG files being abused the most. A disk image is essentially a\nvirtual copy of a physical disk that houses all of the files and requires that it be mounted in\norder to access its contents. The advantages of using disk images, combined with the easy\naccess to purchasing RATs, make this a preferred and effective method for cybercriminals.\n\nIn this blog, I dissect a campaign that uses this method to compromise a system, providing\ninsight into what the CrowdStrike FalconComplete team has observed since 2019. I will also\nprovide step-by-step remediation along with recommendations for how to implement this\napproach in your network.\n\n## Parcel-themed Phishing Email Scenario\n\n\n-----\n\nThe chain starts with a simple email containing a disk image file (.IMG) to socially engineer\nthe victim into viewing the contents. The message seems to be coming from a worldwide\npackage delivery company.\n\nFigure 1. Phishing contents sample. The delivery company did not send this email.\n\nThe attachment in this sample is only 2MB, which raises a flag immediately as disk images\nare typically larger in size.\n\n\n-----\n\nFigure 2. IMG file properties\n\nDouble-clicking on the file allows Windows 8 and Windows 10 to mount the IMG file natively\nto the next available drive. This sample uses a PDF icon as a disguise.\n\n\n-----\n\nFigure 3. IMG file mounted on disk\n\n### Analysis\n\nExeinfo PE identified the binary as a compiled AutoIT script version 3. AutoIT is a scripting\nlanguage used to automate Windows GUI tasks. Cybercriminals would first compile these\nscripts into an executable using the Aut2Exe compiler and further convert it into a disk image\nfile to then distribute it widely in campaigns.\n\nFigure 4. Exeinfo PE against binary `e-voucher.exe`\n\nDumping the rcdata resource and reviewing the strings shows AU3!, a common string seen\nin AutoIT-developed scripts.\n\n\n-----\n\nFigure 5. Hexdump of `e-voucher.exe`\n\nThe AutoIT script is obfuscated, and it is used as a dropper to eventually load the NanoCore\nRAT on the intended system.\n\nFigure 6. Snippet of obfuscated AutoIt script\n\nBeginning on line 9746 in Figure 6, we can see the following three resources:\n\n```\ndusmtask1\n\n```\n```\nbdechangepin2\n\n```\n```\naadWamExtension3\n\n```\n\nThe script merges these three resources and passes the key\n“hwnglongpcoiftynieblwrqseblfkkwvfvbhnizgvvfanyqbrn” as the second parameter to the\nfunction swydxtrwncfvpukruyyjvmtphe(). To decrypt, it creates a hash using CryptCreateHash\nwith this key. Consequently, it then uses the function CryptDeriveKey and creates a separate\nkey from the results of CryptCreateHash. Finally, CryptDecrypt is used to decrypt the\nresource.\n\n\n-----\n\nFigure 7. Encrypted stream prior to CryptDecrypt\n\n\n-----\n\nFigure 8. Contents decrypted after CryptDecrypt returns\n\nOnce the contents are decrypted, it will then use the CreateProcessW function to spawn the\nlegitimate process RegAsm.exe in a suspended state using the process creation flag\n```\n0x00000004 ( CREATE_SUSPENDED )\n\n```\nFigure 9. x32dbg debugger CreateProcessW function starts RegAsm.exe in suspended state\n\nShortly after, it proceeds to allocate memory space for the malicious payload that was\ndecrypted earlier. This memory region is created with memory protection of `0x40`\n( PAGE_EXECUTE_READWRITE )\n\n\n-----\n\nFigure 10. x32dbg debugger VirtualAllocEx allocating memory space\n\nLast, the WriteProcessMemory call is seen to finally write the contents into this newly created\nmemory region.\n\nFigure 11. x32dbg debugger WriteProcessMemory function writing into memory region\n\nInspecting `RegAsm.exe using ProcessHacker shows the memory region` `0x400000 that`\nwas created earlier filled with the payload. The sample is using a well-known technique to\nhollow out `RegAsm.exe and inject its payload.`\n\n\n-----\n\nFigure 12. ProcessHacker showing memory region injected with malicious code\n\nAfter dumping the malicious code out of memory, we can confirm that it is a .NET built binary\npacked with Eazfuscator.\n\n\n-----\n\nFigure 13. Exeinfo displaying packer information on dumped process\n\nRunning de4dot against this copy is able to deobfuscate to see readable strings.\n\nFigure 14. DnsSpy after deobfuscation\n\nThe malware then proceeds to drop a copy of itself to the path\n\n```\nC:\\Users\\username\\PasswordOnWakeSettingFlyout\\DataExchangeHost.exe\n\n```\n\n-----\n\nIn addition, it creates persistence by using a URL shortcut in the StartUp folder that points to\nthe copy of NanoCore RAT to survive reboot. A malicious VBS script named\n```\nAppVEntSubsystems64.vbs is also dropped in the same directory where\nDataExchangeHost.exe resides.\n\n```\nFigure 15. VBS script contents\n\nThe Falcon Complete Team has seen variations of the script above being obfuscated with\nthe same ultimate goal such as in Figure 16.\n\nFigure 16. VbsEdit debugging obfuscated script\n\nA copy of `RegAsm.exe is dropped onto disk and is added to the Run key to boot on user`\nlogon, as seen in Falcon’s Process Tree viewer. Falcon also logs the network connection\nused as the C2 in this sample, as seen in Figure 17.\n\n\n-----\n\nFigure 17. Falcon Process Tree displaying Registry Operations and DNS request\n\nThe functionality of NanoCore RAT has been covered heavily, so this blog will not focus on it.\nFigure 18 shows the same detection in Falcon’s UI but this time being prevented after\nrunning the same sample with the detection and prevention settings set to “Aggressive.”\n\nFigure 18. Prevention policy enabled\n\n**Remediation:**\n\nRemediation Difficulty\n\n\n-----\n\nThe remediation can be summarized in the following steps:\n\n1. Identify and confirm detection originates from a virtual mounted drive:\n\nFind the location of the disk image where it resides\nUnmount the virtual drive\nRemove the IMG from disk\n2. Terminate the injected process\n3. Remove the registry entry\n4. Remove related directories and files\n\n### STEP 1: Identify and Remove the Mounted Disk Image\n\nIn order to identify, confirm and remove the IMG file that was mounted, we first use the class\nWin32_CDROMDrive from WMI in Figure 19 to provide us with information on what is\ncurrently mounted, along with the drive letter and the volume name.\n\nFigure 19. Output of WMI command\n\nNow that we’ve identified what’s mounted, we are using the PowerShell `Get-DiskImage`\ncmdlet to get the objects associated with the IMG file which will indicate where this file\nresides on disk.\n\nFigure 20. Output of Powershell `Get-DiskImage command`\n\n\n-----\n\nUse the image path obtained from the output received on the previous command to unmount\nthis virtual disk. If the process is actively running, terminate it first. Also, you first need to\nunmount this disk or else you will not be able to remove it.\n\nFigure 21. Unmounting IMG file using Dismount-DiskImage\n\n### STEP 2: Terminate the Injected Process\n\nFrom Falcon’s Process Tree, we discovered the injected RegAsm.exe process was running\nunder the process ID 4952. Proceed to terminate this process using the built-in “kill”\ncommand using the process ID discovered.\n\nFigure 22. Terminated process output\n\n### STEP 3: Remove the Registry Entry\n\nNext, we remove the registry entry that was created at infection by using the PowerShell\ncommand in Figure 23.\n\nFigure 23. Deleting registry entry successfully\n\n### STEP 4: Remove Related Directories and Files\n\nLast, we remove all remaining directories and files that were discovered during timeline\nanalysis of the system.\n\nFigure 24. Removing artifacts from disk output\n\nFigure 25. Removing artifacts from disk output\n\n\n-----\n\nFigure 26. Removing artifacts from disk output\n\nThis completes the remediation steps we execute to tackle such variants when discovered.\nNote that in this scenario, we’ve purposely turned off the prevention policy while leaving the\ndetection policy turned on for illustrative purposes.\n\nWithin the scope of our service, we’ve been able to observe Warzone, NanoCore and Agent\nTesla RATs to be the most preferred by cybercriminals among others as seen in Figure 27.\n\nFigure 27. Malware family breakdown\n\nThe entry vector for these have primarily been phishing emails, where users download\nTorrent/Crack software onto their machines disguised as movies, games or music but that\nactually contains infected USB media.\n\n\n-----\n\nFigure 28. Entry vector breakdown\n\nIn regard to verticals, we’ve noticed these campaigns are widely spread across multiple\nverticals, with the hospitality sector being the most affected.\n\n\n-----\n\nFigure 29. Affected verticals observed\n\n## Recommendations\n\n1. Gain advanced visibility across your endpoints with an endpoint detection and\n\n[response (EDR) solution such as the CrowdStrike Falcon® platform. Turn on](https://www.crowdstrike.com/endpoint-security-products/falcon-platform/) next-gen\n[antivirus (NGAV) preventative measures to stop malware.](https://www.crowdstrike.com/epp-101/malware/)\n2. Leverage a Layer 7 firewall that can perform deep packet inspection to examine the\n\ntraffic and block P2P protocol types.\n3. Observe inbound emails received during a short span of time to see the volume of disk\n\nimage files being delivered as attachments. If applicable, block known disk images file\ntypes such as IMG, ISO, DAA, VHD, CDI, VMDK, etc., to reduce the attack surface.\n4. Leverage a proxy to proactively block sites that are uncategorized/unknown, as we’ve\n\n[seen new sites registered shortly before phishing campaigns are executed.](https://www.crowdstrike.com/epp-101/what-is-phishing/)\n5. Incorporate a phishing awareness program internally, and routinely test employees with\n\nphishing test emails.\n\n\n-----\n\nWe ve seen a shift toward cybercriminals using AutoIt and disk images to further achieve\ntheir objectives through various mass phishing campaigns. We believe this shift is primarily\nto evade detection from legacy AV software and bypass the email gateway, as most are not\ninspecting or blocking these file types, and no software is required to mount these disk\nimages as Windows is able to natively mount them. We predict that in 2020, we will continue\nto see this trend as RATs become increasingly accessible to cybercriminals.\n\n**Additional Resources**\n\n_[Learn more about the CrowdStrike Falcon platform by visiting the webpage.](https://www.crowdstrike.com/endpoint-security-products/falcon-platform/)_\n_Learn how you can raise your organization’s cybersecurity maturity to the highest level_\n_[immediately with CrowdStrike Falcon CompleteTM.](https://www.crowdstrike.com/endpoint-security-products/falcon-complete/)_\n_Learn how you can take advantage of automated malware analysis and sandbox by_\n_[visiting the CrowdStrike Falcon SandboxTM webpage.](https://www.crowdstrike.com/endpoint-security-products/falcon-sandbox-malware-analysis/)_\n_Learn how CrowdStrike combines automated analysis with human intelligence to_\n_enable security teams to get ahead of the attacker’s next move_ _by visiting the Falcon_\n_XTM webpage._\n_[Get a full-featured free trial of CrowdStrike Falcon Prevent™ and learn how true next-](https://go.crowdstrike.com/try-falcon-prevent.html?_ga=2.250563012.39441205.1587407352-160409294.1587139430)_\n_gen AV performs against today’s most sophisticated threats._\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-26 - Weaponized Disk Image Files- Analysis, Trends and Remediation.pdf"
    ],
    "report_names": [
        "2020-05-26 - Weaponized Disk Image Files- Analysis, Trends and Remediation.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535998,
    "ts_updated_at": 1743041160,
    "ts_creation_date": 1653774161,
    "ts_modification_date": 1653774161,
    "files": {
        "pdf": "https://archive.orkl.eu/78c0c7d807933891e706d9a53f2bcf77c240c9e9.pdf",
        "text": "https://archive.orkl.eu/78c0c7d807933891e706d9a53f2bcf77c240c9e9.txt",
        "img": "https://archive.orkl.eu/78c0c7d807933891e706d9a53f2bcf77c240c9e9.jpg"
    }
}