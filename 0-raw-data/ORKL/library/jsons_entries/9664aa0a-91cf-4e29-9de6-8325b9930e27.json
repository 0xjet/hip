{
    "id": "9664aa0a-91cf-4e29-9de6-8325b9930e27",
    "created_at": "2023-01-12T15:04:03.076464Z",
    "updated_at": "2025-03-27T02:09:18.133976Z",
    "deleted_at": null,
    "sha1_hash": "f5dcbb7d7cbc48c8c43252ef3ed0cdc372c3034b",
    "title": "2021-12-28 - Attackers are abusing MSBuild to evade defenses and implant Cobalt Strike beacons",
    "authors": "",
    "file_creation_date": "2022-05-28T15:41:22Z",
    "file_modification_date": "2022-05-28T15:41:22Z",
    "file_size": 98365,
    "plain_text": "# Attackers are abusing MSBuild to evade defenses and implant Cobalt Strike beacons\n\n**[morphuslabs.com/attackers-are-abusing-msbuild-to-evade-defenses-and-implant-cobalt-strike-beacons-edac4ab84f42](https://morphuslabs.com/attackers-are-abusing-msbuild-to-evade-defenses-and-implant-cobalt-strike-beacons-edac4ab84f42)**\n\nRenato Marinho December 27, 2021\n\nRe\nnato\n\n\n[Renato Marinho](https://medium.com/@rmarinho?source=post_page-----edac4ab84f42--------------------------------)\n[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa3844a6384ee&operation=register&redirect=https%3A%2F%2Fmorphuslabs.com%2Fattackers-are-abusing-msbuild-to-evade-defenses-and-implant-cobalt-strike-beacons-edac4ab84f42&user=Renato+Marinho&userId=a3844a6384ee&source=post_page-a3844a6384ee----edac4ab84f42---------------------follow_byline-----------)\nDec 27, 2021\n\n\n7 min read\n\nMicrosoft Build Engine is the platform for building applications on Windows, mainly used in\nenvironments where Visual Studio is not installed. Also known as MSBuild, the engine provides\nan XML schema for a project file that controls how the build platform processes and builds\n[software [1]. The project file element named ‘Tasks’ designates independent executable](https://docs.microsoft.com/en-us/visualstudio/msbuild/msbuild?view=vs-2022)\n**components to run during the project building. Tasks are meant to perform build operations but**\nare being abused by attackers to run malicious code under the MSBuild disguise. The\ntechnique is mapped on Mitre ATT&CK as “Trusted Developer Utilities Proxy Execution” —\n[T1127.001.](https://attack.mitre.org/techniques/T1127/001/)\n\nThis is the second malicious campaign I got using MSBuild in less than a week. Usually, it starts\nwith an RDP access using a valid account, spreads over the network via remote Windows\nServices (SCM), and pushes Cobalt Strike beacon to corporate hosts abusing the MSBuild task\nfeature as described in today’s diary.\n\n**Abusing MSBuild**\n\nTo make it easier to understand how attackers are abusing MSBuild, look at Figure 1. It shows\nthe XML file for a simple project (HelloWorld.csproj) with a task named HelloWorld prepared to\ncompile and execute the custom C# code during project building.\n\n\n-----\n\nWhen building the project using MSBuild, as seen in Figure 2, the task HelloWorld will be\nexecuted, which in turn will call the ‘Execute()’ and ‘Start()’ methods, which will finally print the\n“Hello World” message on the console. The ‘Execute()’ method comes from the interface ‘ITask’\n[implemented by the ‘HelloWorld’ class [2].](https://docs.microsoft.com/en-us/visualstudio/msbuild/task-writing?view=vs-2022)\n\n\n-----\n\nNow, let’s look at the malicious MSBuild project file in Figure 3. Using the same principle, when\ncalled by MSBuild, it will compile and execute the custom C#, decode and execute the Cobalt\nStrike beacon on the victim’s machine.\n\n\n-----\n\n-----\n\nIn Figure 5, it’s possible to see the beacon connected to the C2 server (23.227.178.115).\n\n\n-----\n\n**Analyzing the Cobalt Strike beacon**\n\nTo analyze the code executed by the malicious MSBuild project, first, it’s necessary to decrypt\nthe variable ‘buff’ (refer to Figure 3). The variable is decoded during MSBuild execution by the\n“for” loop marked in Figure 6. It runs an XOR function between each byte of the ‘buff’ and\nkey_code arrays. By the end, the ‘buff’ byte array will store the decrypted malicious content.\nThe rest of the code will allocate memory and execute the payload using\n_Marshal.GetDelegateForFunctionPointer._\n\n\n-----\n\nI implemented the same decryption function in Python to decrypt the code, as seen in Figure 7.\nBefore the decryption loop, the script reads the content of buff and key_code from the MSBuild\nproject file and copy to the correspondent variables in the Python script. The script code is\n[available here.](https://github.com/morphuslabs/Tools/blob/main/decrypt_TMP.py)\n\n\n-----\n\nTo profile the resulting binary, I started looking for its hash on VirusTotal, which returned no\nmatches. Continuing the low hanging fruit approach, I did a ‘strings’ and found interesting\nstrings that I have already seen in other Cobalt Strike beacons like “could not create remote\n_thread in %d: %d” and “IEX (New-Object Net.Webclient)._\n_DownloadString(‘http://127.0.0.1:%u/'); %s”._\n\n[To confirm, I used the tool CobaltStrikeParser from Sentinel-One [3]. This tool parses the Cobalt](https://github.com/Sentinel-One/CobaltStrikeParser)\nStrike beacon and extracts its configuration, as seen in Figure 8.\n\n\n-----\n\nThe configuration says that the C2 server (23.227.178.115) will be contacted via HTTPS\n(encrypted traffic) on port TCP/8888. It also informs the endpoint /dpixel for GET requests and\n/submit.php for POST requests and that the spawn processes are rundll32.exe — this is the\nprocess used to run commands requested by C2 on the victim’s machine.\n\nOne usual next step when I have a C2 up and running is to analyze the traffic and try to\ndiscover more about the campaign. To do so in this case, I verified if the private key for the\n[Cobalt Strike beacon is known using a project by Didier Steven’s 1768 [4]. This project not only](https://blog.didierstevens.com/2021/11/21/update-1768-py-version-0-0-10/)\nparses the Cobalt Strike’s beacon configuration but also indicates if the corresponding private\nkey was found by Didier on malicious Cobalt Strike servers on the internet. Read more about\n[this project at [5].](https://blog.didierstevens.com/2021/10/21/public-private-cobalt-strike-keys/)\n\n\n-----\n\nSo, after running the 1768 tool, I could find that the private key is known for the Cobalt Strike\nbeacon analyzed, as seen in Figure 9.\n\nBut, before using the private key to decrypt the Cobalt Strike traffic, remember that the\ncommunication with the C2 is SSL encrypted. In Figure 10, there is a sample captured traffic.\n\n\n-----\n\nOne way to decrypt the SSL traffic is to use a man-in-the-middle approach. To this end, I used\n[the project mitmproxy. The communication schema when using a tool like this is to make the](https://mitmproxy.org/)\nclient, the Cobalt Strike beacon, talk to the SSL proxy and make the SSL proxy to talk with the\nC2 server. In the middle (proxy), we will have the traffic unencrypted.\n\nSee below command I used to run the mitmproxy:\n\n$ SSLKEYLOGFILE=”~/.mitmproxy/sslkeylogfile.txt” mitmproxy -k — mode transparent\n\nThe SSLKEYLOGFILE variable will indicate mitmproxy to store SSL/TLS master keys on the file\nsslkeylogfile.txt. This file can be used to decrypt the traffic in external tools like Wireshark\n\n[https://docs.mitmproxy.org/stable/howto-wireshark-tls/]. The ‘-k’ says to mitmproxy to do not\n\n\n-----\n\nverify upstream server SSL/TLS certificates and the transparent mode is used when the client\ndoes not know or is configured to use a proxy.\n\nBefore running the mitmproxy, remember to enable ‘IP forwarding’ and create the necessary\nNAT rules to redirect the SSL traffic from the client machine (where the Cobalt Strike beacon is\nrunning) mitmproxy port. For my case, the commands were:\n\n$ sudo sysctl -w net.ipv4.ip_forward=1\n$ sudo iptables -t nat -A PREROUTING -i <interface> -p tcp — dport 8888 -j REDIRECT\n— to-port 8080\n\nAnother important thing is installing the mitmproxy certificate on the Windows machine running\nthe beacon. The default certificate is located into ~/.mitmproxy/mitmproxy-ca-cert.cer file. Copy\nit to Windows and install the certificate on Trusted Root Certification Authorities and Trusted\nPublishers, as seen in Figure 11.\n\nOnce the pre-requisites are met, running the mitmproxy could have the SSL unencrypted traffic\ncollected, as seen in Figure 12 and Figure 13.\n\n\n-----\n\n-----\n\nRemember from the Cobalt Strike beacon configuration (Figure 8) that the HTTP get metadata\nis stored into the ‘Cookie’ header encoded with base64. So, the content marked in red in Figure\n13 is the content to be decrypted using the Cobalt Strike private key.\n\nTo decrypt the content, I used another excellent tool from Didier Stevens called cs-decrypt[metadata [6] as seen in Figure 14.](https://blog.didierstevens.com/2021/11/12/update-cs-decrypt-metadata-py-version-0-0-2/)\n\n\n-----\n\nFinally, if you want to have the traffic unencrypted on Wireshark, you can use the SSL/TSL keys\nstored into “~/.mitmproxy/sslkeylogfile.txt”. Import the file using Wireshark menu Edit>Preferences->Protocols->TLS->(Pre)-Master-Secret log file name. After that, it’s possible to\nsee the traffic unencrypted like in Figure 15.\n\n\n-----\n\n**Recommendations**\n\nMSBuild composes the list of applications signed by Microsoft that can allow the execution of\n[other codes. According to Microsoft’s recommendations [7], these applications should be](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/microsoft-recommended-block-rules)\nblocked by the Windows Defender Application Control (WDAC) policy.\n\nThere is a note for MSBuild.exe, though, that if the system is used in a development context to\nbuild managed applications, the recommendation is to allow msbuild.exe in the code integrity\npolicies.\n\n**References**\n\n[1] [https://docs.microsoft.com/en-us/visualstudio/msbuild/msbuild?view=vs-2022](https://docs.microsoft.com/en-us/visualstudio/msbuild/msbuild?view=vs-2022)\n\n[2] [https://docs.microsoft.com/en-us/visualstudio/msbuild/task-writing?view=vs-2022](https://docs.microsoft.com/en-us/visualstudio/msbuild/task-writing?view=vs-2022)\n\n[3] [https://github.com/Sentinel-One/CobaltStrikeParser](https://github.com/Sentinel-One/CobaltStrikeParser)\n\n[4] [https://blog.didierstevens.com/2021/11/21/update-1768-py-version-0-0-10/](https://blog.didierstevens.com/2021/11/21/update-1768-py-version-0-0-10/)\n\n[5] [https://blog.didierstevens.com/2021/10/21/public-private-cobalt-strike-keys/](https://blog.didierstevens.com/2021/10/21/public-private-cobalt-strike-keys/)\n\n\n-----\n\n[6] blog.didierstevens.com/2021/11/12/update-cs-decrypt-metadata-py-version-0–0–2/\n\n[7] https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defenderapplication-control/microsoft-recommended-block-rules\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-28 - Attackers are abusing MSBuild to evade defenses and implant Cobalt Strike beacons.pdf"
    ],
    "report_names": [
        "2021-12-28 - Attackers are abusing MSBuild to evade defenses and implant Cobalt Strike beacons.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535843,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653752482,
    "ts_modification_date": 1653752482,
    "files": {
        "pdf": "https://archive.orkl.eu/f5dcbb7d7cbc48c8c43252ef3ed0cdc372c3034b.pdf",
        "text": "https://archive.orkl.eu/f5dcbb7d7cbc48c8c43252ef3ed0cdc372c3034b.txt",
        "img": "https://archive.orkl.eu/f5dcbb7d7cbc48c8c43252ef3ed0cdc372c3034b.jpg"
    }
}