{
    "id": "eb8a0ecb-66a1-44c9-a72b-5f0e1d6357e6",
    "created_at": "2023-01-12T15:05:59.763421Z",
    "updated_at": "2025-03-27T02:05:50.013236Z",
    "deleted_at": null,
    "sha1_hash": "c89c44fc98cb23ea807146a96836ee30feae1092",
    "title": "2022-07-21 - Lightning Framework- New Undetected “Swiss Army Knife” Linux Malware",
    "authors": "",
    "file_creation_date": "2022-08-18T03:29:21Z",
    "file_modification_date": "2022-08-18T03:29:21Z",
    "file_size": 6740502,
    "plain_text": "# Lightning Framework: New Undetected “Swiss Army Knife” Linux Malware ⚡\n\n**intezer.com/blog/research/lightning-framework-new-linux-threat/**\n\nJuly 21, 2022\n\nWritten by Ryan Robinson - 21 July 2022\n\n\n-----\n\n### Get Free Account\n\nJoin Now\n\n_Lightning Framework is a new undetected Swiss Army Knife-like Linux malware that has modular plugins_\n_and the ability to install rootkits._\n\nYear after year Linux environments increasingly become the target of malware due to continued threat actor\ninterest in the space. Malware targeting Linux environments surged in 2021, with a large amount of\n[innovation resulting in new malicious code, especially in ransomwares, trojans, and botnets. With the rise in](https://www.ibm.com/downloads/cas/ADLMYLAZ)\nuse of the cloud, it is no wonder that malware innovation is still accelerating at breakneck speed in this\nrealm.\n\nThis is a technical analysis of a previously undocumented and undetected Linux threat called the Lightning\n_Framework. It is rare to see such an intricate framework developed for targeting Linux systems. Lightning is_\na modular framework we discovered that has a plethora of capabilities, and the ability to install multiple\ntypes of rootkit, as well as the capability to run plugins. The framework has both passive and active\ncapabilities for communication with the threat actor, including opening up SSH on an infected machine, and\na polymorphic malleable command and control configuration. We are releasing this blog for informational\npurposes. We do not have all the files that are referenced in the framework, but hope that this release will\nhelp others if they possess other pieces of the jigsaw puzzle. We have not observed this malware being\nused in attacks in the wild.\n\n## Technical Analysis of Lightning Framework\n\nThe framework consists of a downloader and core module, with a number of plugins. Some of the plugins\nused by the malware are open-source tools. Below is a figure of the framework layout:\n\n## Overview of the Modules\n\n**Name** **Name on Disk** **Description**\n\n\n-----\n\nLightning.Downloader kbioset The persistent module that downloads the core\nmodule and its plugins\n\nLightning.Core kkdmflush The main module of the Lightning Framework\n\nLinux.Plugin.Lightning.SsHijacker soss There is a reference to this module but no sample\nfound in the wild yet.\n\nLinux.Plugin.Lightning.Sshd sshod OpenSSH with hardcoded private and host keys\n\nLinux.Plugin.Lightning.Nethogs nethoogs There is a reference to this module but no sample\nfound in the wild yet. Presumably the software\n[Nethogs](https://github.com/raboof/nethogs)\n\nLinux.Plugin.Lightning.iftop iftoop There is a reference to this module but no sample\n[found in the wild yet. Presumably the software iftop](https://linux.die.net/man/8/iftop)\n\nLinux.Plugin.Lightning.iptraf iptraof There is a reference to this module but no sample\nfound in the wild yet. Presumably the software\n[IPTraf](http://iptraf.seul.org/)\n\nLinux.Plugin.RootkieHide libsystemd.so.2 There is a reference to this module but no sample\nfound in the wild yet. LD_PRELOAD Rootkit\n\nLinux.Plugin.Kernel elastisearch.ko There is a reference to this module but no sample\nfound in the wild yet. LKM Rootkit\n\n## Lightning.Downloader\n\nThe main function of the downloader module is to fetch the other components and execute the core\nmodule.\n\n[Lightning Downloader result in Intezer Analyze](https://analyze.intezer.com/files/48f9471c20316b295704e6f8feb2196dd619799edec5835734fc24051f45c5b7)\nThe downloader module starts by checking if it is located in the working directory\n```\n/usr/lib64/seahorses/ under the name kbioset . The framework makes heavy use of typosquatting\n\n```\nand masquerading in order to remain undetected. The reference to seahorses masquerades the password\n[and key manager software seahorse. If not it will relocate itself to that working directory and execute that](https://gitlab.gnome.org/GNOME/seahorse)\ncopy. The downloader will fingerprint the host name and network adapters to generate a GUID, which will\nbe sent to the command and control (C2) server.\n\n\n-----\n\nBuilding the GUID\nThe downloader will then contact the C2 to fetch the following modules and plugins:\n\nLinux.Plugin.Lightning.SsHijacker\nLinux.Plugin.Lightning.Sshd\nLinux.Plugin.Lightning.Nethogs\nLinux.Plugin.Lightning.iftop\nLinux.Plugin.Lightning.iptraf\nLightning.Core\n\n\n-----\n\nResources fetched from the C2\nThe method of contacting the C2 will be described below in the malleable C2 section (click here to jump to\nthat section). The downloader will then execute the core module (kkdmflush).\n\n\n-----\n\nExecution of the core module\n\n## Lightning.Core\n\nThe core module is the main module in this framework, it is able to receive commands from the C2 and\nexecute the plugin modules. The module has many capabilities and uses a number of techniques to hide\nartifacts to remain running under the radar.\n\nThe core module modifies the name of the calling thread of the module to kdmflush, to make it appear that\nit is a kernel thread.\n\n\n-----\n\nUsing prctl to modify calling thread name\n[Next the core module sets up persistence by creating a script that is executed upon system boot. This is](https://attack.mitre.org/techniques/T1037/)\nachieved by first creating a file located at `/etc/rc.d/init.d/elastisearch . The name appears to`\ntyposquat elasticsearch. The following contents are written to the file:\n```\n#!/bin/bash\n\n# chkconfig:2345 90 20\n\n/usr/lib64/seahorses/kbioset &\n\n```\nThis script will execute the downloader module upon boot. The service is then added using the\n```\nchkconfig utility.\n\n```\n\n-----\n\nCreation of the init.d script and service\n[The timestamp of the file is modified to hide artifacts, a technique known as “timestomping”. The file has its](https://attack.mitre.org/techniques/T1070/006/)\nlast modified time edited to match that of either `whoami,` `find, or` `su . It will look for each file`\nrespectively until it finds one. This technique is used for most of the files that the framework creates.\n\n\n-----\n\nFile timestamp modification function\nThe malware will attempt to hide its Process ID (PID) and any related network ports. This is achieved by\nwriting the frameworks running PIDs to two files: `hpi and` `hpo . These files are parsed and then the`\nexistence of the file `proc/y.y` is checked. If the file exists, it means that a rootkit has been installed. The\nPIDs are written to `proc/y.y` for use by the rootkit, which may scrub any reference to files running in the\nframework from commands such as `ps` and `netstat .`\n\n\n-----\n\nWriting PID to proc/y.y if it exists (Indication that rootkit exists)\nThe core module will generate a GUID in the same manner as the downloader and contact the C2. The\nresponse is parsed and the command is executed. The core module has the following commands:\n\n**Command** **Description**\n\nSystemInfo Fingerprints the machine\n\nPureShellCommand Runs Shell command\n\nRunShellPure Starts the Linux.Plugin.Lightning.Sshd (SSH Daemon) plugin\n\nCloseShellPure Terminates the Linux.Plugin.Lightning.Sshd plugin\n\nDisconnect Exits the Core module\n\nGetRemotePathInfo Collects the summary of given path\n\nKeepAlive No action, connection remains alive\n\nUploadFileHeader Checks access of file\n\nFileEdit Gets contents of file and time meta\n\nTryPassSSH Adds a public key to the root/.ssh/authorized_keys file\n\n\n-----\n\nDeleteVecFile Deletes the specified file or path\n\nPreDownloadFile Calculates a checksum of the file\n\nDownloadFile Sends a file to the C2\n\nDeleteGuid Removes the framework\n\nUpdateVersion Calls the Downloader module to update the framework\n\nUpdateRemoteVersion Updates the framework including the downloader\n\nSocks5 Sets up a Socks5 proxy\n\nRestorePlug The same as UpdateVersion\n\nGetDomainSetting Fetches the contents of the malleable C2 configuration file (cpc)\n\nSetDomainSetting Updates the contents of the malleable C2 configuration file (cpc)\n\nInstallKernelHide Fetches the OS release\n\nRemoveKernelHide Removes kernel module\n\nUpdateKernelVersion Removes the kernel module and runs uname -r\n\nOverrideFile Overwrites specified file\n\nUploadFileContent Writes data sent from server to file\n\nLocalPluginRequest Either write the LD_PRELOAD rootkit or LKM rootkit\n\n## Network Communication\n\nNetwork communication in the Core and Downloader modules are performed over TCP sockets. The data\nis structured in JSON. The C2 is stored in a polymorphic encoded configuration file that is unique for every\nsingle creation. This means that configuration files will not be able to be detected through techniques such\nas hashes. The key is built into the start of the encoded file.\n\n\n-----\n\nEncoded malleable C2 configuration profile\n\n\n-----\n\nThe dynamic XOR decoding routine\nThe decoded configuration is structured in JSON. The default configuration in the analyzed sample uses a\nlocal IP address `10.2.22[.]67 with the port` `33229 .`\n\n\n-----\n\nDecoded default configuration\nThere is a passive mode of communication available if the actor executes the RunShellPure command.\nThis starts an SSH service on the infected machine with the Linux.Plugin.Lightning.Sshd plugin. The plugin\nis an OpenSSH daemon that has hardcoded private and host keys, allowing the attacker to SSH into the\nmachine with their own SSH key, creating a secondary backdoor.\n\nHardcoded keys inside the modified OpenSSH daemon\n\n## Summary\n\nThe Lightning Framework is an interesting malware as it is not common to see such a large framework\ndeveloped for targeting Linux. Although we do not have all the files, we can infer some of the missing\nfunctionality based on strings and code of the modules that we do possess. Soon we will release a another\nblog about detection opportunities for Lightning Framework using osquery.\n\n\n-----\n\n_We would like to extend a huge thanks to our friends and partners at IBM and SentinelOne for their help_\n_during investigating this threat._\n\n## IOCs for Lightning Framework\n\n### Hashes\n\n**File** **SHA256**\n\nLightning.Downloader [48f9471c20316b295704e6f8feb2196dd619799edec5835734fc24051f45c5b7](https://analyze.intezer.com/files/48f9471c20316b295704e6f8feb2196dd619799edec5835734fc24051f45c5b7)\n\nLightning.Core [fd285c2fb4d42dde23590118dba016bf5b846625da3abdbe48773530a07bcd1e](https://analyze.intezer.com/files/fd285c2fb4d42dde23590118dba016bf5b846625da3abdbe48773530a07bcd1e)\n\nLinux.Plugin.Lightning.Sshd [ad16989a3ebf0b416681f8db31af098e02eabd25452f8d781383547ead395237](https://analyze.intezer.com/files/ad16989a3ebf0b416681f8db31af098e02eabd25452f8d781383547ead395237)\n\n### Sigma Detection Rules\n```\ntitle: Lightning Framework File Path\n\nstatus: experimental\n\ndescription: Detects creation of files related to Lightning Framework.\n\nauthor: Intezer\n\nreferences:\n\n  - https://www.intezer.com\n\nlogsource:\n\n  product: linux\n\n  category: file_create\n\ndetection:\n\n  selection1:\n\n   TargetFilename|startswith:\n\n     - '/usr/lib64/seahorses/'\n\n  selection2: \n\n   TargetFilename|contains:\n\n     - 'kbioset'\n\n     - 'cpc'\n\n     - 'kkdmflush'\n\n     - 'soss'\n\n     - 'sshod'\n\n     - 'nethoogs'\n\n     - 'iftoop'\n\n     - 'iptraof'\n\n  condition: selection1 and selection2\n\nfalsepositives:\n\n  - Unknown.\n\n```\n\n-----\n\n```\n     g g\nstatus: experimental\n\ndescription: Detects communication to default local ip for Lightning Framework\n\nauthor: Intezer\n\nreferences:\n\n - https://intezer.com\n\nlogsource:\n\n category: firewall\n\ndetection:\n\n select_outgoing:\n\n  dst_ip: 10.2.22.67\n\n  dst_port: 33229\n\n condition: select_outgoing\n\nfalsepositives:\n\n - Unknown.\n\n### MITRE ATT&CK\n\n```\n**Tactic** **Technique** **ID** **Description**\n\n\nPersistence Boot or Logon Initialization\nScripts\n\n\n[T1037](https://attack.mitre.org/techniques/T1037/) An init.d script is used for persistence of\ndownloader module\n\n\nPersistence SSH Authorized Keys [T1098.004](https://attack.mitre.org/techniques/T1098/004/) SSH keys can be added to the\n_authorized_keys file_\n\n\nDefense\nEvasion\n\nDefense\nEvasion\n\nDefense\nEvasion\n\nDefense\nEvasion\n\nDefense\nEvasion\n\nDefense\nEvasion\n\nDefense\nEvasion\n\n\nObfuscated Files or\nInformation\n\nDeobfuscate/Decode Files\nor Information\n\n\nHide Artifacts [T1564](https://attack.mitre.org/techniques/T1564/) Many artifacts are hidden including ports,\nPIDs, and file timestamps\n\nMasquerading [T1036](https://attack.mitre.org/techniques/T1036/) Many files are masqueraded as other files\nor tasks\n\nRootkit [T1014](https://attack.mitre.org/techniques/T1014/) LKM and LD_PRELOAD rootkits are used\n\nTimestomp [T1070.006](https://attack.mitre.org/techniques/T1070/006/) Files created by Lightning are modified to\nmatch that of other utilities\n\nFile Deletion [T1070.004](https://attack.mitre.org/techniques/T1070/004/) The framework has the ability to remove\nitself\n\n\n[T1027](https://attack.mitre.org/techniques/T1027/) The C2 profile is encoded on disk\n\n[T1140](https://attack.mitre.org/techniques/T1140/) The C2 profile is decoded with a dynamic\nXOR algorithm\n\n\nDiscovery File and Directory\nDiscovery\n\n\n[T1083](https://attack.mitre.org/techniques/T1083/) The framework can list files and directories\non infected systems\n\n\nDiscovery Network Service Discovery [T1046](https://attack.mitre.org/techniques/T1046/) Multiple plugins can be used to perform\nnetwork service discovery\n\nDiscovery Network Sniffing [T1040](https://attack.mitre.org/techniques/T1040/) Multiple plugins can be used to perform\nnetwork sniffing\n\n\nDiscovery System Information\nDiscovery\n\n\n[T1082](https://attack.mitre.org/techniques/T1082/) Lightning can perform detailed system\nfingerprinting\n\n\n-----\n\nCommand and\nControl\n\nCommand and\nControl\n\nCommand and\nControl\n\nCommand and\nControl\n\n\nData Encoding [T1132](https://attack.mitre.org/techniques/T1132/) Data from the C2 is encoded\n\n\nExfiltration Over C2\nChannel\n\n\nNon-Application Layer\nProtocol\n\n\n[T1095](https://attack.mitre.org/techniques/T1095/) Communication with the C2 is performed\nover TCP\n\n\nProxy [T1090](https://attack.mitre.org/techniques/T1090/) The framework has the ability to start a\nSocks5 proxy\n\n\n[T1041](https://attack.mitre.org/techniques/T1041/) Data can be exfiltrated\n\n\n**Ryan Robinson**\nRyan is a security researcher analyzing malware and scripts. Formerly, he was a researcher on Anomali's\nThreat Research Team.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-07-21 - Lightning Framework- New Undetected “Swiss Army Knife” Linux Malware.pdf"
    ],
    "report_names": [
        "2022-07-21 - Lightning Framework- New Undetected “Swiss Army Knife” Linux Malware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535959,
    "ts_updated_at": 1743041150,
    "ts_creation_date": 1660793361,
    "ts_modification_date": 1660793361,
    "files": {
        "pdf": "https://archive.orkl.eu/c89c44fc98cb23ea807146a96836ee30feae1092.pdf",
        "text": "https://archive.orkl.eu/c89c44fc98cb23ea807146a96836ee30feae1092.txt",
        "img": "https://archive.orkl.eu/c89c44fc98cb23ea807146a96836ee30feae1092.jpg"
    }
}