{
    "id": "2ecef5e5-c488-4fea-a9fe-f726a794d9f0",
    "created_at": "2023-01-12T15:00:31.344183Z",
    "updated_at": "2025-03-27T02:05:59.172255Z",
    "deleted_at": null,
    "sha1_hash": "96940d66c017a351079ca08d6d7b369307934459",
    "title": "2016-11-21 - PrincessLocker – ransomware with not so royal encryption",
    "authors": "",
    "file_creation_date": "2022-05-28T04:56:03Z",
    "file_modification_date": "2022-05-28T04:56:03Z",
    "file_size": 781175,
    "plain_text": "# PrincessLocker – ransomware with not so royal encryption\n\n**[blog.malwarebytes.com/threat-analysis/2016/11/princess-ransomware/](https://blog.malwarebytes.com/threat-analysis/2016/11/princess-ransomware/)**\n\nMalwarebytes Labs November 21, 2016\n\nPrincessLocker ransomware has appeared some time ago and has drawn out attention by\nusing the same template of the site for a victim as Cerber did. It is not a widespread\n[ransomware, so it has taken some time before we got our hands on a sample. In this article,](https://www.malwarebytes.com/ransomware)\n[we dig deeper and try to answer questions about its internal similarities with Cerber (and](https://blog.malwarebytes.com/threat-analysis/2016/03/cerber-ransomware-new-but-mature/)\nother known ransomware).\n\n**_Described version of the PrincessLocker ransomware is found decryptable. You can_**\n**_read details about file recovery_** **_[here.](https://hshrzd.wordpress.com/2016/11/17/princess-locker-decryptor/)_**\n\n## Analyzed sample\n\n Behavioral analysis\n\nOnce executed, Princess Ransomware runs silently. It does not delete the original copy, but\njust encrypts all the data in the background. After finishing the encryption, it pops up a\ndefault browser and displays the ransom note. It drops notes in three file formats: HTML,\n_URL shortcut, and TXT._\n\nNotes have a name following the pattern: !_HOW_TO_RESTORE_<added extension>.<note\n_extension>_\n\n\n-----\n\nThe ransom notes guide the victim into the Tor-based page, which is intended to give more\ninstructions about the payment and data recovery:\n\n\n-----\n\nNames of the encrypted files are not changed – only new extensions are added at the end,\nwhich are randomly generated on each run.\n\nEvery file is encrypted with the same key, which means the same plaintext produces the\nsame ciphertext. The file’s content has high entropy and no patterns are visible, which\nsuggest a strong encryption algorithm, probably AES with chained blocks. See an example\nbelow:\n\n**_square.bmp : left – original, right encrypted with Princess_**\n\n\n-----\n\n## Network communication\n\nDuring the encryption process, the application communicates with its C&C, that is hosted on\na Tor-based site:\n\nConnections list:\n\n\n-----\n\n[First, the malware queries the legitimate address, myexternalip.com/raw, in order to fetch the](http://myexternalip.com/raw)\nvictim’s external IP. After that, requests are sent to the Onion-based C&C. It sends sets of\nBase64-encrypted data.\n\n**Example 1:**\n\nIn the request to n.php, the ransomware posts a set of encrypted and Base64-encoded data:\n```\nQQ8EZkZ_dnFldWFKCVxyWFppe2QCcFFyd15XSxRSDHxcHHNdRVtFWEBGQhRHDAMHBgsHCQABAAoVQw8GWgJXRQ\n\n```\nDecoded to:\n\n**Example 2:**\n\nIn the request to f.php, the ransomware periodically posts smaller chunks of Base64encoded data:\n\n\n-----\n\nAfter decoding the data, we can see that it contains two values: One is the victim ID and the\nsecond is the number of files encrypted at that time.\n\nContent from the above example:\n```\ndj11MGtibTF1ZTdzcmwmZj0xMTQw\n\n```\nDecoded to:\n```\nv=u0kbm1ue7srl&f=1140\n\n## Inside\n\n```\nLike most malware, Princess comes wrapped in the encrypted layer—a tactic that protects\nthe malicious core from the detection. The dropper loads the core module into its own\nmemory (self-injection):\n\n\n-----\n\nThe core module is a DLL with two exported functions:\n\n[The export table reminds us of another ransomware: the Maktub locker:](https://blog.malwarebytes.com/threat-analysis/2016/03/maktub-locker-beautiful-and-dangerous/)\n\n\n-----\n\nThis suggests that the threat actors behind both of them are somehow connected or used\nthe same template to build their product.\n\nThe unpacked DLL is not independent. It needs to be loaded via a dropper, because it calls a\nfunction from the dropper module during execution:\n\nBy this way, authors of this ransomware wanted to make analysis tougher.\n\n**_Attacked targets_**\n\n[This ransomware attacks following drive types: 2 -removable, 3 – fixed, 4 -remote:](https://msdn.microsoft.com/pl-pl/library/windows/desktop/aa364939(v=vs.85).aspx)\n\n**_Encryption_**\n\n\n-----\n\nThe key is generated only once before the encrypting loop is deployed. First, a random\nUnicode string is generated. Then, it is hashed using SHA256 algorithm:\n\nBelow is a sample set of random data that was generated during one of the test sessions:\n```\nkey: SHA256(L\"3igcZhRdWq96m3GUmTAiv9\")\nID: wjn6kdbblpiu \nextension: zzqeb\n\n```\n[The result of the hashing function is used to derive an AES 128 key:](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard)\n\n\n-----\n\nThe derived key is used to encrypt content of each file in 128-byte long chunks:\n\nChunks are encrypted using the function CryptEncrypt from Microsoft Crypto API that is\nloaded dynamically during execution:\n\n\n-----\n\n## Conclusion\n\nComparative analysis of the code with Cerber has proven that although both families share\nthe same template for the Onion page, they do not have any significant internal similarities.\nPrincessLocker is way simpler, the mistake committed in the implementation allowed us to\nwrite a decryptor. It suggests that the authors of this malware are not as experienced.\n\nIt is possible that this ransomware has been built using some fragments of other ransomware\nthat authors got access to rather than being a work of the same authors as Cerber or\nMaktub.\n\nIn order to not give any hints to the threat actors behind the PrincessLocker, we decided to\nnot disclose some parts of the analysis, which could suggest how to fix the discovered bug.\n\n## Appendix\n\nhttp://www.bleepingcomputer.com/news/security/introducing-her-royal-highness-theprincess-locker-ransomware/ – Bleeping Computer about Princess Ransomware\n\n_This was a guest post written by Hasherezade, an independent researcher and programmer_\n_with a strong interest in InfoSec. She loves going in details about malware and sharing threat_\n_[information with the community. Check her out on Twitter @hasherezade and her personal](https://twitter.com/hasherezade)_\n_[blog: https://hshrzd.wordpress.com.](https://hshrzd.wordpress.com/)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-11-21 - PrincessLocker – ransomware with not so royal encryption.pdf"
    ],
    "report_names": [
        "2016-11-21 - PrincessLocker – ransomware with not so royal encryption.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535631,
    "ts_updated_at": 1743041159,
    "ts_creation_date": 1653713763,
    "ts_modification_date": 1653713763,
    "files": {
        "pdf": "https://archive.orkl.eu/96940d66c017a351079ca08d6d7b369307934459.pdf",
        "text": "https://archive.orkl.eu/96940d66c017a351079ca08d6d7b369307934459.txt",
        "img": "https://archive.orkl.eu/96940d66c017a351079ca08d6d7b369307934459.jpg"
    }
}