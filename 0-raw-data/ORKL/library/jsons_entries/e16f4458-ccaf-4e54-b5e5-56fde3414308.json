{
    "id": "e16f4458-ccaf-4e54-b5e5-56fde3414308",
    "created_at": "2023-01-12T15:01:52.358874Z",
    "updated_at": "2025-03-27T02:12:03.928527Z",
    "deleted_at": null,
    "sha1_hash": "5622fa0b9ce164a006063956ef60836a7e128b67",
    "title": "2021-03-06 - Security scripts",
    "authors": "",
    "file_creation_date": "2022-05-28T16:03:26Z",
    "file_modification_date": "2022-05-28T16:03:26Z",
    "file_size": 151520,
    "plain_text": "# Security scripts\n\n**github.com/microsoft/CSS-Exchange/tree/main/Security**\n\nmicrosoft\n\n[Apply new code keyword casing rule](https://github.com/microsoft/CSS-Exchange/commit/43004e6986d2acac4ea2c71a5045e62ab5ca05e5)\n```\n43004e6\n\n```\nFailed to load latest commit information.\n\n**Script** **More Info** **Download**\n\nEOMT [More Info](https://github.com/microsoft/CSS-Exchange/tree/main/Security#exchange-on-premises-mitigation-tool-eomt) [Download](https://github.com/microsoft/CSS-Exchange/releases/latest/download/EOMT.ps1)\n\nExchangeMitigations.ps1 [More Info](https://github.com/microsoft/CSS-Exchange/tree/main/Security#exchangemitigationsps1) Obsolete\n\nhttp-vuln-cve2021-26855.nse [More Info](https://github.com/microsoft/CSS-Exchange/tree/main/Security#http-vuln-cve2021-26855nse) Obsolete\n\nTest-ProxyLogon.ps1 [More Info](https://github.com/microsoft/CSS-Exchange/tree/main/Security#test-proxylogonps1) [Download](https://github.com/microsoft/CSS-Exchange/releases/latest/download/Test-ProxyLogon.ps1)\n\n## Exchange On-premises Mitigation Tool (EOMT)\n\nThis script contains mitigations to help address the following vulnerabilities.\n\n\n-----\n\nCVE-2021-26855\n\nThis is the most effective way to help quickly protect and mitigate your\nExchange Servers prior to patching. We recommend this script over the\n**previous ExchangeMitigations.ps1 script. The Exchange On-premises**\nMitigation Tool automatically downloads any dependencies and runs the\nMicrosoft Safety Scanner. This a better approach for Exchange deployments\nwith Internet access and for those who want an attempt at automated\nremediation. We have not observed any impact to Exchange Server\nfunctionality via these mitigation methods. EOMT.ps1 is completely automated\nand uses familiar mitigation methods previously documented. This script has\nfour operations it performs:\n\n**_+NEW Check for the latest version of EOMT and download it._**\nMitigate against current known attacks using CVE-2021-26855 via a URL\nRewrite configuration\n[Scan the Exchange Server using the Microsoft Safety Scanner](https://docs.microsoft.com/en-us/windows/security/threat-protection/intelligence/safety-scanner-download)\nAttempt to remediate compromises detected by the Microsoft Safety\nScanner.\n\nThis a better approach for Exchange deployments with Internet access and for\nthose who want an attempt at automated remediation. We have not observed\nany impact to Exchange Server functionality via these mitigation methods nor\ndo these mitigation methods make any direct changes that disable features of\nExchange.\n\nUse of the Exchange On-premises Mitigation Tool and the Microsoft Saftey\nScanner are subject to the terms of the Microsoft Privacy Statement:\n[https://aka.ms/privacy](https://aka.ms/privacy)\n\n### Requirements to run the Exchange On-premises Mitigation Tool\n\nExternal Internet Connection from your Exchange server (required to\ndownload the Microsoft Safety Scanner and the IIS URL Rewrite Module).\nPowerShell script must be run as Administrator.\n\n### System Requirements\n\nPowerShell 3 or later\nIIS 7.5 and later\nExchange 2013, 2016, or 2019\nWindows Server 2008 R2, Server 2012, Server 2012 R2, Server 2016,\nServer 2019\n\n\n-----\n\n**_+New If Operating System is older than Windows Server 2016, must_**\n[have KB2999226 for IIS Rewrite Module 2.1 to work.](https://support.microsoft.com/en-us/topic/update-for-universal-c-runtime-in-windows-c0514201-7fe6-95a3-b0a5-287930f3560c)\n\n### Who should run the Exchange On-premises Mitigation Tool\n\n**Situation** **Guidance**\n\n\nIf you have done nothing to\ndate to patch or mitigate this\nissue…\n\nIf you have mitigated using\nany/all of the mitigation\nguidance Microsoft has\ngiven\n(Exchangemitigations.Ps1,\nBlog post, etc..)\n\nIf you have already patched\nyour systems and are\nprotected, but did NOT\ninvestigate for any\nadversary activity, indicators\nof compromise, etc….\n\nIf you have already patched\nand investigated your\nsystems for any indicators of\ncompromise, etc….\n\n\nRun EOMT.PS1 as soon as possible.This will\nboth attempt to remediate as well as mitigate\nyour servers against further attacks. Once\ncomplete, follow patching guidance to update\nyour servers on [http://aka.ms/exchangevulns](http://aka.ms/exchangevulns)\n\nRun EOMT.PS1 as soon as possible. This will\nboth attempt to remediate as well as mitigate\nyour servers against further attacks. Once\ncomplete, follow patching guidance to update\nyour servers on [http://aka.ms/exchangevulns](http://aka.ms/exchangevulns)\n\nRun EOMT.PS1 as soon as possible. This will\nattempt to remediate any existing\ncompromise that may not have been full\nremediated before patching.\n\nNo action is required\n\n\n### Important note regarding Microsoft Safety Scanner\n\nThe Exchange On-premises Mitigation Tool runs the Microsoft Safety Scanner\nin a quick scan mode. If you suspect any compromise, we highly recommend\nyou run it in the FULL SCAN mode. FULL SCAN mode can take a long time but\nif you are not running Microsoft Defender AV as your default AV, FULL SCAN\nwill be required to remediate threats.\n\n### Exchange On-premises Mitigation Tool Examples\n\nThe default recommended way of using EOMT.ps1. This will determine if your\nserver is vulnerable, mitigate if vulnerable, and run MSERT in quick scan\nmode. If the server is not vulnerable only MSERT quick scan will run.\n\n```\n.\\EOMT.ps1\n\n```\n\n-----\n\nTo run a Full MSERT Scan - We only recommend this option only if the initial\nquick scan discovered threats. The full scan may take hours or days to\ncomplete.\n\n```\n.\\EOMT.ps1 -RunFullScan -DoNotRunMitigation\n\n```\n\nTo run the Exchange On-premises Mitigation Tool with MSERT in detect only\nmode - MSERT will not remediate detected threats.\n\n```\n.\\EOMT.ps1 -DoNotRemediate\n\n```\n\nTo roll back the Exchange On-premises Mitigation Tool mitigations\n\n```\n.\\EOMT.ps1 -Rollbackmitigation\n\n```\n\nNote: If ExchangeMitigations.ps1 was used previously to apply mitigations, Use\nExchangeMitigations.ps1 for rollback.\n\n**_+NEW EOMT will now autoupdate by downloading the latest version from_**\nGitHub. To prevent EOMT from fetching updates to EOMT.ps1 from the\ninternet.\n\n```\n.\\EOMT.ps1 -DoNotAutoUpdateEOMT\n\n```\n\n### Exchange On-premises Mitigation Tool Q & A\n\n**Question: What mode should I run EOMT.ps1 in by default?**\n\n**Answer: By default, EOMT.ps1 should be run without any parameters:**\n\nThis will run the default mode which does the following:\n\n1. Checks if your server is vulnerable based on the presence of the SU\n\npatch or Exchange version.\n2. Downloads and installs the IIS URL rewrite tool (only if vulnerable).\n3. Applies the URL rewrite mitigation (only if vulnerable).\n4. Runs the Microsoft Safety Scanner in \"Quick Scan\" mode (vulnerable or\n\n**not).**\n\n**Question: What if I run a full scan and it’s affecting the resources of my**\nservers?\n\n**Answer: You can terminate the process of the scan by running the following**\ncommand in an Administrative PowerShell session.\n\n```\nStop-Process -Name msert\n\n```\n\n-----\n\n**Question: What is the real difference between this script (EOMT.PS1) and the**\nprevious script Microsoft released (ExchangeMitigations.Ps1).\n\n**Answer: The Exchange On-premises Mitigation Tool was released to help pull**\ntogether multiple mitigation and response steps, whereas the previous script\nsimply enabled mitigations. Some details on what each do:\n\n**EOMT.PS1**\n\nMitigation of CVE-2021-26855 via a URL Rewrite configuration.\nMitigation does not impact Exchange functionality.\nMalware scan of the Exchange Server via the Microsoft Safety Scanner\nAttempt to reverse any changes made by identified threats.\n\n**ExchangeMitigations.ps1:**\n\nDoes mitigations for all 4 CVE’s - CVE-2021-26855, CVE-2021-26857,\nCVE-2021-27065 & CVE-2021-26858.\nSome of the mitigation methods impact Exchange functionality.\nDoes not do any scanning for existing compromise or exploitation.\nDoes not take response actions to existing active identified threats.\n\n**Question: What if I do not have an external internet connection from my**\nExchange server?\n\n**Answer: If you do not have an external internet connection, you can still use**\nthe legacy script (ExchangeMitigations.ps1) and other steps from the mitigation\n[blog post: Microsoft Exchange Server Vulnerabilities Mitigations – March 2021](https://msrc-blog.microsoft.com/2021/03/05/microsoft-exchange-server-vulnerabilities-mitigations-march-2021/)\n\n**Question: If I have already ran the mitigations previously, will the Exchange**\nOn-premises Mitigation Tool roll back any of the mitigations?\n\n**Answer: No, please use the legacy script (ExchangeMitigations.ps1) to do**\nrollback. The legacy script supports rollback for the mitigations the Exchange\nOn-premises Mitigation Tool applied.\n\n## Test-ProxyLogon.ps1\n\nFormerly known as Test-Hafnium, this script automates all four of the\n[commands found in the Hafnium blog post. It also has a progress bar and](https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/)\nsome performance tweaks to make the CVE-2021-26855 test run much faster.\n\nDownload the latest release here:\n\n[Download Test-ProxyLogon.ps1](https://github.com/microsoft/CSS-Exchange/releases/latest/download/Test-ProxyLogon.ps1)\n\n\n-----\n\n### Usage\n\nThe most typical usage of this script is to check all Exchange servers and save\nthe reports, by using the following syntax from Exchange Management Shell:\n```\nGet-ExchangeServer | .\\Test-ProxyLogon.ps1 -OutPath\n$home\\desktop\\logs\n\n```\nTo check the local server only, just run the script:\n\n```\n.\\Test-ProxyLogon.ps1 -OutPath $home\\desktop\\logs\n\n```\n\nTo check the local server and copy the identified logs and files to the OutPath:\n\n```\n.\\Test-ProxyLogon.ps1 -OutPath $home\\desktop\\logs -CollectFiles\n\n```\n\nTo display the results without saving them, pass -DisplayOnly:\n\n```\n.\\Test-ProxyLogon.ps1 -DisplayOnly\n\n```\n\n### Frequently Asked Questions\n\n**The script says it found suspicious files, and it lists a bunch of zip files.**\n**What does this mean?**\n\nThe script will flag any zip/7x/rar files that it finds in ProgramData. As noted in\n[this blog post, web shells have been observed using such files for exfiltration.](https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/)\nAn administrator should review the files to determine if they are valid.\nDetermining if a zip file is a valid part of an installed product is outside the\nscope of this script, and whitelisting files by name would only encourage the\nuse of those specific names by attackers.\n\n**I'm having trouble running the script on Exchange 2010.**\n\nIf PowerShell 3 is present, the script can be run on Exchange 2010. It will not\nrun-on PowerShell 2. One can also enable PS Remoting and run the script\nremotely against Exchange 2010. However, the script has minimal functionality\nin these scenarios, as Exchange 2010 is only affected by one of the four\nannounced exploits - CVE-2021-26857. Further, this exploit is only available if\nthe Unified Messaging role is present. As a result, it is often easier to simply\n[run the Get-EventLog command from the blog post, rather than using Test-](https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/)\nProxyLogon.\n\n## ExchangeMitigations.ps1\n\n\n-----\n\n### NOTE: This script is obsolete and is no longer maintained. Please use EOMT.ps1 instead.\n\nThe final release can be downloaded here:\n\n[Download ExchangeMitigations.ps1](https://github.com/microsoft/CSS-Exchange/releases/download/v22.03.03.2154/ExchangeMitigations.ps1)\n\nThis script contains 4 mitigations to help address the following vulnerabilities:\n\nCVE-2021-26855\nCVE-2021-26857\nCVE-2021-27065\nCVE-2021-26858\n\nFor more information on each mitigation please visit\n[https://aka.ms/exchangevulns](https://aka.ms/exchangevulns)\n\n**This should only be used as a temporary mitigation until your Exchange**\n**Servers can be fully patched, recommended guidance is to apply all of**\n**the mitigations at once.**\n\nFor this script to work you must have the IIS URL Rewrite Module installed\nwhich can be done via this script using the -FullPathToMSI parameter.\n\nURL Rewrite Module 2.1 must be installed, you can download version 2.1 here:\n\n[x86 & x64 -https://www.iis.net/downloads/microsoft/url-rewrite](https://www.iis.net/downloads/microsoft/url-rewrite)\n\nFor systems running IIS 8.5 and lower KB2999226 must be installed. Please\nreview the pre-reqs for this KB and download from\nhttps://support.microsoft.com/en-us/topic/update-for-universal-c-runtime-inwindows-c0514201-7fe6-95a3-b0a5-287930f3560c\"\n\nScript requires PowerShell 3.0 and later and must be executed from an\nelevated PowerShell Session.\n\nTo apply all mitigations with MSI install\n```\n.\\ExchangeMitigations.ps1 -FullPathToMSI \"FullPathToMSI\" WebSiteNames \"Default Web Site\" -ApplyAllMitigations\n\n```\nTo apply all mitigations without MSI install\n```\n.\\ExchangeMitigations.ps1 -WebSiteNames \"Default Web Site\" ApplyAllMitigations -Verbose\n\n```\nTo rollback all mitigations\n\n\n-----\n\n```\n.\\ExchangeMitigations.ps1 -WebSiteNames Default Web Site RollbackAllMitigation\n\n```\nTo apply multiple or specific mitigations (out of the 4)\n```\n.\\ExchangeMitigations.ps1 -WebSiteNames \"Default Web Site\" ApplyECPAppPoolMitigation -ApplyOABAppPoolMitigation\n\n```\nTo rollback multiple or specific mitigations\n```\n.\\ExchangeMitigations.ps1 -WebSiteNames \"Default Web Site\" RollbackECPAppPoolMitigation -RollbackOABAppPoolMitigation\n\n## http-vuln-cve2021-26855.nse\n\n### NOTE: This file is obsolete and is no longer maintained. Please use EOMT.ps1 instead.\n\n```\nThe final release can be downloaded here:\n\n[Download http-vuln-cve2021-26855.nse](https://github.com/microsoft/CSS-Exchange/releases/download/v22.03.03.2154/http-vuln-cve2021-26855.nse)\n\nThis file is for use with nmap. It detects whether the specified URL is vulnerable\nto the Exchange Server SSRF Vulnerability (CVE-2021-26855). For usage\ninformation, please read the top of the file.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-06 - Security scripts.pdf"
    ],
    "report_names": [
        "2021-03-06 - Security scripts.pdf"
    ],
    "threat_actors": [
        {
            "id": "529c1ae9-4579-4245-86a6-20f4563a695d",
            "created_at": "2022-10-25T16:07:23.702006Z",
            "updated_at": "2025-03-27T02:02:09.93109Z",
            "deleted_at": null,
            "main_name": "Hafnium",
            "aliases": [
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "ETDA:Hafnium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "7c969685-459b-4c93-a788-74108eab6f47",
            "created_at": "2023-01-06T13:46:39.189751Z",
            "updated_at": "2025-03-27T02:00:03.017103Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "ATK233",
                "G0125",
                "Operation Exchange Marauder",
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "MISPGALAXY:HAFNIUM",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2704d770-43b4-4bc4-8a5a-05df87416848",
            "created_at": "2022-10-25T15:50:23.306305Z",
            "updated_at": "2025-03-27T02:00:55.43633Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "HAFNIUM",
                "Operation Exchange Marauder",
                "Silk Typhoon"
            ],
            "source_name": "MITRE:HAFNIUM",
            "tools": [
                "Tarrask",
                "ASPXSpy",
                "Impacket",
                "PsExec",
                "China Chopper"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535712,
    "ts_updated_at": 1743041523,
    "ts_creation_date": 1653753806,
    "ts_modification_date": 1653753806,
    "files": {
        "pdf": "https://archive.orkl.eu/5622fa0b9ce164a006063956ef60836a7e128b67.pdf",
        "text": "https://archive.orkl.eu/5622fa0b9ce164a006063956ef60836a7e128b67.txt",
        "img": "https://archive.orkl.eu/5622fa0b9ce164a006063956ef60836a7e128b67.jpg"
    }
}