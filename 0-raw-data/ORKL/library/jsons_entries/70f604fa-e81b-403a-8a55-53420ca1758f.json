{
    "id": "70f604fa-e81b-403a-8a55-53420ca1758f",
    "created_at": "2023-01-12T14:59:14.878567Z",
    "updated_at": "2025-03-27T02:16:20.863536Z",
    "deleted_at": null,
    "sha1_hash": "ac4c1d83ea98b3663d71863594dc1fa812c34cce",
    "title": "2019-07-08 - Analyzing KSL0T Turlas Keylogger Part 1",
    "authors": "",
    "file_creation_date": "2022-05-25T14:15:58Z",
    "file_modification_date": "2022-05-25T14:15:58Z",
    "file_size": 611504,
    "plain_text": "# Analyzing KSL0T (Turla’s Keylogger), Part 1 – Reupload\n\n**[0ffset.net/reverse-engineering/malware-analysis/analyzing-turlas-keylogger-1](https://www.0ffset.net/reverse-engineering/malware-analysis/analyzing-turlas-keylogger-1/)**\n\n8 July 2019\n\n[0verfl0w_](https://www.0ffset.net/author/dan489400/)\n8th July 2019\nNo Comments\n\n(This post is a reupload from my old site which is no longer available – you may have seen it\nbefore)\n\nWhilst I’m working through the Hancitor write up and the Flare On challenges, I decided to\ntake a short break and focus on a smaller piece of malware – such as a keylogger, which in\nthis case is on a much larger scale than $32 keylog-as-a-service, as it has been attributed to\na Russian Advanced Persistent Threat group known as Turla, or Waterbug. This APT\ngroup has been in the news quite frequently over the past month,\n[after compromising European government foreign offices and creating an](https://www.zdnet.com/article/turla-backdoors-compromise-two-european-government-offices-defense-contractor/)\n[extremely stealthy backdoor that utilizes PDF files to exfiltrate data, via emails. I noticed](https://www.bleepingcomputer.com/news/security/turla-outlook-backdoor-uses-clever-tactics-for-stealth-and-persistence/)\n[a sample of malware uploaded to VirusBay, tagged with Turla and Venomous](https://beta.virusbay.io/) **Bear (yet**\nanother moniker given to the group), and decided to analyze it. As I statically analyzed a lot\nof the Flare On challenges that I have completed, I decided I wanted to approach this\nsample primarily using static analysis, unless it became too difficult to do so. So, let’s begin\ncracking this sample open!\n\nMD5: 59b57bdabee2ce1fb566de51dd92ec94\n\nAs per usual, I ran the file and strings command on the binary to see the format and if\nthere was anything interesting that was visible. The binary is in fact a DLL, and a 64 bit one.\nThe output of strings displayed a lot of junk, although we are able to see a few error\nmessages and several Windows API calls, such as IsDebuggerPresent, WriteFile, and\ndynamic loading calls; GetModuleHandle, LoadLibrary and GetProcAddress.\n\nAfter opening the file in IDA, we are able to view the entry point of the user\ncode, DLLMain. After a cmp operation, the program jumps to 0x1800019BD, where an\nextremely important function at 0x1800017D0 is called. It might not look like much at a\nfirst glance, just multiple calls with 3 arguments passed to them – until you realize it is\ncalling the same function each time, with the second argument being what seems to be\npointing to some encrypted text …\n\n\n-----\n\n-----\n\nAs you may have guessed, this is in fact a decryption function. When we view the function\ncalled at 0x180001750, we can determine that it is a decryption function based on both\nthe arguments, and on the xor edx, eax. Also take note of the for loop, which compares\nthe value in eax (value stored in arg_10) and the value in var_18.\n\n\n-----\n\nWe can further deduce that var_18 is in fact the counter, based off of this section of code:\n```\nmov   eax, [var_18]\nadd   eax, 1\nmov   [var_18], eax\n\n```\nAs we now know this, we can rename var_18 to Counter. Click on var_18 and push ‘n‘,\nand a prompt will appear, allowing you to rename the variable. We now need to figure out\nwhat the counter value is being compared to, meaning we need to analyze arg_10. As it\nis arg_* and not var_*, we have to look at the arguments passed to this specific function.\nIn this case, the arguments are not passed using the push mnemonic and are\ninstead mov’d into the arguments. As the value in the r8d register is being moved\ninto arg_10, let’s jump back the the calling function to view what was in r8d before\nexecuting the decryption function.\n```\nmov  r8d, 25Eh\nlea  rdx, unk_18000F2F0\nmov  ecx, 47h\ncall sub_180001750\n\n```\nWe can convert the hexadecimal number to decimal by pressing ‘H‘ while selecting it,\nresulting in the decimal value 606. So for this particular call, the XOR algorithm\nloops 606 times, XORing each character. Now we have identified arg_10, we can go ahead\n\n\n-----\n\nand rename it. Next, let s try and figure out the values that are being XOR ed together, to see\nif we can locate the key used and the data being decrypted. The xor mnemonic performs the\nXOR operation on the value in edx, with the value in eax. The result of the operation is\nalways stored in the first argument, in this case the result is stored in edx. We can assume\nthat edx contains the data to be decrypted, and eax contains the key. In order to find these\nvalues out, we have to see what was moved (mov) or loaded (lea) into\nthe edx and eax register.\n\nAs you can see, r8d is moved into edx before the XOR occurs, so we have to then see what\nwas moved into r8d beforehand – which is seen in the third instruction of this\nsegment: movsx r8d, byte ptr [rax+rcx]. Just above this, [rsp+18h+counter] is\nmoved into rcx, and whatever is stored in arg_8 is moved into rax. As we\nknow counter is incremented by 1 each loop, we can determine that the byte ptr\n\n**[rax+rcx] is iterating over something** **606 times, with that something being encrypted**\ncharacters. We can double check this by finding out what is stored in arg_8, the same way\nwe discovered what was in arg_10: unk_18000F2F0, which contains a lot of encrypted\ndata (specifically, 606 bytes of it).\n\n\n-----\n\nNext, let’s find out what is being stored in eax. In this instance, one byte of data\nat [rax+rdx] is being movsx into eax. Therefore, we need to locate the data stored\nin rax and rdx. The data in rax is quite easy to find out, as there is a mov rax,\n**unk_18000F010 before the movsx. When viewing the data at 0x18000F010, we can**\nsee what seems to be more encrypted text – the key used to decrypt the data\nat 18000F2F0. However, it is not that simple. Remember the rdx register that is used?\nWell we can assume that the value in rdx changes on each iteration. In order to figure this\nvalue, we need to look at the div instruction.\nKey Array:\n\n\n-----\n\n```\nmov rax, arg_0\nxor edx, edx\nmov ecx, 100\ndiv ecx\n\n```\nThe div instruction takes one operand – this contains the value to divide rax by. A division\nof 0x8003 by 0x100 in x64 Assembly would look something like this:\n```\nxor rdx, rdx   ; clear dividend\nmov rax, 0x8003  ; dividend\nmov rcx, 0x100  ; divisor\ndiv rcx      ; rcx = 0x80, rdx = 0x3\n\n```\nIt is basically a division, however the remainder value is stored in rdx, meaning rdx is\nequal to 0x3. In the case of the keylogger, the XOR key is decided based on the value\nof rdx, and therefore we need to figure out what rax is, so we can divide it by 0x64 in order\nto get the first value of rdx. We know that arg_0 contains the value of ecx before the\nfunction is executed, which is 0x47. When we convert it to decimal format, it is 71 / 100,\nleaving us with 0.71. The value stored in rdx is 71. Simply perform the modulo operation\n(%) on these two values and you will get 71. This means that the 71st byte in the key array is\n\n\n-----\n\nthe first byte to be used in the XOR: 0x85. For each loop, the value inside of arg_0 is\nincremented by 1, meaning the key byte is always changing – although now that we know\nhow the algorithm works, we can automate the decryption statically, rather than relying on\na debugger.\n```\nmov eax, [rsp+18h+arg_0]\nadd eax, 1\nmov [rsp+18h+arg_0], eax\n\n```\nSo how do we go about the static decryption? Well the answer is IDC, which is a scripting\n[language incorporated inside of IDA. Another option is IDAPython, however that isn’t](https://www.hex-rays.com/products/ida/support/idadoc/157.shtml)\navailable inside the IDA 7 Pro Free version, so we’ll stick with IDC. So far, we know that the\ndecryption part is all contained inside of a loop that loops a pre-determined amount of\ntimes, using a specific key array and a determined data array. In addition, the value that is\nused for the div operation is also passed as an argument. Therefore, we will require 3\narguments for our function: base_data, div, and loop. We will also need 6\nvariables: index, x1, x2, data, i, and base_xor. index will contain the result of the\nmodulo operation, x1 will contain a byte of data from the encrypted text, x2 will contain a\nbyte of data from the key, data will contain the result of the XOR, i will be the counter\nand base_xor will hold the address to the key array. To store an address, simply add\nan 0x to the beginning of said address. The rest of the script will contain the necessary\nincrementations and XOR’s.\n```\nstatic decrypt_data(base_data, div, loop) {\nauto index, x1, x2, data, i, base_xor;\nbase_xor = 0x18000F010;\nfor (i = 0; i &lt; loop; i++) {\n  index = div % 100; // Get value from div % 100\n  x1 = Byte(base_data); // Get byte from encrypted data\n  x2 = Byte(base_xor + index); // Get XOR key using value from div / 100\n  data = x1 ^ x2; // XOR data\n  PatchByte(base_data, data); // Replace enc. byte with dec. byte\n  base_data = base_data + 1; // Increment Encrypted Data\n  div = div + 1; // Increment Divider\n}\n}\n\n```\nIn order to *install* this script into IDA, click File -> Script Command, and then paste it\ninto the dialog box.To call the function, simply type (in the command line at the\nbottom) decrypt_data(0x18000F2F0, 71, 606) to decrypt the first section of data,\nwhich should look like the image below.\n\n\n-----\n\nSelect all of the data and press A, which should arrange it into more legible data, although\nevery second byte is a 0, so we will need to remove them.\n\nAfter removing the 0’s, we are left with this:\n\n\n-----\n\n```\n<#RShift> <#LShift> <#RCtrl> <#LCtrl> <!RShift> <!LShift> <!RCtrl> <!LCtrl> + [] \\\n; / ` ', . <PageUp> <PageDown> <NumLock> <r/> <r*> <r-> <r+> <r1> <r2> <r3> <r4>\n<r5> <r6> <r7> <r8> <r9> <r0> <r.> <F1> <F2> <F3> <F4> <F5> <F6> <F7> <F8> <F9>\n<F10> <F11> <F12> <Down> <Up> <Right> <Left> <Del> <Print> <End> <Insert> <CapsLock>\n<Enter> <Backspace> <Esc> <Tab>\n\n```\nWe can assume that this data is used to log keystrokes when pushing certain buttons such as\nLeft Shift and NumLock, rather than regular characters. To double check that the\ndecryption worked, we can run it in a debugger and check the output. Now that we have\nsuccessfully decrypted the first part, we can do the same to each of the 19 sections of data\n[that are encrypted. If you want to view each decrypted string, you can check them out here.](https://pastebin.com/DrGVU417)\nOne particularly interesting string in the data is msimm.dat, which could be the log file. In\naddition to msimm, one of the strings seemed to indicate the version of said keylogger, as\nwell as a possible name for it: KSL0T Ver = 21.0, although I haven’t found anything\ninteresting linked to the name KSL0T – yet.\n\nAs this post is longer than what I planned it to be, I decided to split them into sections, as\nthere is quite a lot of decryption and functions to analyze – especially since it is static\nanalysis. I am focusing on this approach mainly to demonstrate and teach people that you\ncan still get a lot done through static analysis methods, even if you can’t afford the full\nversion of IDA Pro (which I certainly can’t!), as well as how to use IDC to automate time\nconsuming tasks. In the next part we will be decrypting some more stuff, and then actually\nlocating the loop that performs the keylogging – this should be out soon!\n\n**IOC (MD5):**\n\n**Keylogger: 59b57bdabee2ce1fb566de51dd92ec94**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-07-08 - Analyzing KSL0T Turlas Keylogger Part 1.pdf"
    ],
    "report_names": [
        "2019-07-08 - Analyzing KSL0T Turlas Keylogger Part 1.pdf"
    ],
    "threat_actors": [
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535554,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1653488158,
    "ts_modification_date": 1653488158,
    "files": {
        "pdf": "https://archive.orkl.eu/ac4c1d83ea98b3663d71863594dc1fa812c34cce.pdf",
        "text": "https://archive.orkl.eu/ac4c1d83ea98b3663d71863594dc1fa812c34cce.txt",
        "img": "https://archive.orkl.eu/ac4c1d83ea98b3663d71863594dc1fa812c34cce.jpg"
    }
}