{
    "id": "ae237e35-c7e7-4819-8c22-f7160ecfc5ab",
    "created_at": "2023-01-12T15:00:44.352077Z",
    "updated_at": "2025-03-27T02:05:45.984056Z",
    "deleted_at": null,
    "sha1_hash": "ea388a3b47c38ea6cd05c168f2f42cbb0371e329",
    "title": "2017-07-12 - A .NET malware abusing legitimate ffmpeg",
    "authors": "",
    "file_creation_date": "2022-05-28T04:56:37Z",
    "file_modification_date": "2022-05-28T04:56:37Z",
    "file_size": 1454935,
    "plain_text": "# A .NET malware abusing legitimate ffmpeg\n\n**[blog.malwarebytes.com/threat-analysis/2017/07/malware-abusing-ffmpeg/](https://blog.malwarebytes.com/threat-analysis/2017/07/malware-abusing-ffmpeg/)**\n\nMalwarebytes Labs July 12, 2017\n\nThere is a growing trend among malware authors to incorporate legitimate applications in\n[their malicious package. This time, we analyzed a malware downloading a legitimate ffmpeg.](https://virustotal.com/en/file/ac85032ffb2f22d6d0f903217e73bbdcacd4ac5a0197bd7e69b13709a7a1b70f/analysis/)\nUsing this application, this simple spyware written in .NET got a powerful feature. Most of the\nmalware is sufficient with sending screenshots, made periodically on the infected machine.\nThis malware goes a step further and records full videos, spying on user activities. In this\npost, we will have a look at this and the other threats possessed by this sample.\n\n[The mentioned malware family was first discovered in 2015 by MalwarHunterTeam. Recently](https://twitter.com/malwrhunterteam/status/678973132124889088)\na new wave is being spread.\n\n## Analyzed samples\n\nDownloaded plugins:\n\n[e907ebeda7d6fd7f0017a6fb048c4d23 – remotedesktop.dll](https://www.virustotal.com/en/file/7d822d00cd31f4e3bc7bad3535a6590e2f838cc575b8128e716db59b37eb6fb5/analysis/1497891080/)\n[d628d2a9726b777961f2d1346f988767 – processmanager.dll](https://www.virustotal.com/en/file/dfe4222c135c369797b101929bcb8b7cb303fd446dee7a24fd312395842cd070/analysis/1497890732/)\n\n## Behavioral analysis\n\n\n-----\n\nThe JS file drops the contained executable inside the %TEMP% folder and then runs it. The\nexecutable installs itself under the random name, creating its own folder in %APPDATA%.\nPersistence is achieved with the help of run key. Additional copy of the malware is also\ndropped in the startup folder:\n\nDuring it’s run, the executable creates .tmp files inside it’s installation folder. File content is\nnot encrypted and if we look inside we can notice that it is saving keystrokes and logging the\nrunning applications:\n\nAnother interesting thing we noted is, that the malware downloads legitimate applications:\n_[Rar.exe,](https://virustotal.com/en/file/65d41340cc826c70d2fad878b83b63291128496888b91844b55e360068e83bd5/analysis/)_ _[ffmpeg.exe and related DLLs: DShowNet.dll,](https://virustotal.com/en/file/ac85032ffb2f22d6d0f903217e73bbdcacd4ac5a0197bd7e69b13709a7a1b70f/analysis/)_ _[DirectX.Capture.dll](https://virustotal.com/en/file/5bf397047e7d8c5950f6ba96e851aa8a8909e681a5bc4690324bf8ce1c8b319f/analysis/)_\n\nThe malware has been observed closing and deleting some applications while it is running.\nDuring the tests, it removed i.e. ProcessExplorer and baretail from the attacked machine.\n\n\n-----\n\n## Network communication\n\nThe malware communicates with the CnC server over TCP using port 98.\n\nThe server sends to the client a command “idjamel” and the client responds with the basic\ninfo collected about the victim machine, such as machinename/username, the operating\nsystem installed, and a list of running processes. After the beaconing, the server sends to\nthe client the configuration, i.e. list of the targeted banks.\n\nBot saves the configuration in the registry:\n\nAfter that, the CnC sends a set of Base64 encoded PE files. The content of each file is\nprepended by its name. The non-malicious helper binaries cab be identified by the keyword:\n“djamelreference”. Malicious plugins are identified by “djamelplugin”.\n\nDownloading DShowNET.dll:\n\n\n-----\n\nDownloading a plugin – remotedesktop.dll [(e907ebeda7d6fd7f0017a6fb048c4d23):](https://www.virustotal.com/en/file/7d822d00cd31f4e3bc7bad3535a6590e2f838cc575b8128e716db59b37eb6fb5/analysis/1497891080/)\n\nThe ffmpeg application is downloaded from the URL (pointed by the CnC):\n\nFollowing the address we can see some dummy page, that may possibly be owned by the\nattackers. The Facebook like button points to the account “AnonymousBr4zil”:\n\n\n-----\n\nThe bot reports to the server about the running applications, i.e. sending the text from the\ntitle bars encoded in Base64:\n\nExample:\n```\nawt||UHJvY2VzcyBFeHBsb3JlciAtIFN5c2ludGVybmFsczogd3d3LnN5c2ludGVybmFscy5jb20gW3Rlc3RtY\n\n```\n\n-----\n\nDecoded:\n```\nProcess Explorer - Sysinternals: www.sysinternals.com [testmachine\\tester]\n\n## Inside\n\n```\n**Unpacking**\n\n[The sample is packed with the help of CloudProtector – (thanks to @MalwareHunterTeam for](http://cloudprotector.pw/)\nthe tip). It is the same protector that was used in some other cases that we analyzed earlier\n(read more [here). Just like in the previous case, it decrypts the payload using the custom](https://blog.malwarebytes.com/threat-analysis/2016/07/unpacking-yet-another-net-crypter/)\nalgorithm and the key supplied in the configuration. Then, decrypted executable is loaded in\nthe memory with the help of the RunPE technique (also known as ProcessHollowing).\n\n**The core**\n\nThe unpacked payload is the layer containing all the malicious features. It is not further\nobfuscated, so we can easily decompile it (i.e. using dnSpy) and read the code.\n\nWe can see some classes with descriptive names, i.e. ProtectMe, ScreemCapture,\nSocketClient.\n\n\n-----\n\nAt the first sight, we can see the purpose of this malware: spying the user and backdooring\nthe infected machine.\n\nThe class Form1 is the main module, responsible for communicating with the CnC and\ncoordinating actions. It contains hardcoded data used for the malware installation and the\naddress of the CnC server:\n```\n37.187.92.171:98\n\n```\nThe victim name is copied from the binary and saved in the registry key:\n\nIn case the bot detected a software for e-Carte Bleue (a French payment card), it adds the\ncorresponding string to the identifier, and also sends additional information to the server:\n\n\n-----\n\nEach module runs independently, started in a new thread:\n\n**Video recording**\n\n\n-----\n\nWe can see the fragment of code responsible for downloading the ffmpeg application:\n\nThe main goal of the malware authors is to spy on user’s banking activities. That’s why, the\nvideo recording event is triggered when the victim opens a particular site, related to online\nbanking. The list of targets is supplied by the CnC and saved in the registry under the key\n“ve”, for example:\n\nPeriodically, the check is made, whether the target from the list has been open in the\nbrowser. In case if it was detected, the malware deploys video recorder:\n\n\n-----\n\nThe function “VeifyingTime” compares the title bar with the supplied string.\n\nVideos are recorded with the help of the ffmpeg application:\n\n\n-----\n\nAfter that they are sent to the CnC, encoded in Base64:\n\nThe malware also has a feature of making simple screenshots, saved as JPG. The pictures\nand the captured logs are periodically compressed by the Rar application, and then also sent\nto the CnC:\n\n\n-----\n\n**Keylogger**\n\nThe kyl class name stands for keylogger:\n\n\n-----\n\nIt has also the ability to enumerate opened windows:\n\nThis is the class responsible for creating the .tmp file that was mentioned before:\n\n**Protect Me**\n\nThis class is responsible for disabling the applications that may be used to monitor malware’s\nactivity:\n\n\n-----\n\n**Plugins**\n\nThe basic functionality of the bot can be extended by additional plugins, downloaded from\nthe CnC:\n\nIn the observed case, the bot downloaded two plugins, giving to it capabilities typical for a\nRAT:\n\n_processmanager.dl, written in 2015:_\n\nand remotedesktop.dll, written in 2016:\n\n\n-----\n\nIn contrary to the main module and the previous plugin, the remotedesk.dll is obfuscated.\nNames of its classes and variables are no longer meaningful:\n\n## Conclusion\n\nThis malware is prepared by an unsophisticated actor. Neither the binary nor the\ncommunication protocol is well obfuscated. The used packer is well-known and easy to\ndefeat. However, the malware is rich in features and it seems to be actively maintained. It’s\ncapabilities of spying on the victim and backdooring the attacked machine should not be\ntaken lightly because even a simple threat actor can cause a lot of damage when neglected.\n\n[This malware is detected by Malwarebytes as Backdoor.DuBled.](https://www.malwarebytes.com/premium/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-07-12 - A .NET malware abusing legitimate ffmpeg.pdf"
    ],
    "report_names": [
        "2017-07-12 - A .NET malware abusing legitimate ffmpeg.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535644,
    "ts_updated_at": 1743041145,
    "ts_creation_date": 1653713797,
    "ts_modification_date": 1653713797,
    "files": {
        "pdf": "https://archive.orkl.eu/ea388a3b47c38ea6cd05c168f2f42cbb0371e329.pdf",
        "text": "https://archive.orkl.eu/ea388a3b47c38ea6cd05c168f2f42cbb0371e329.txt",
        "img": "https://archive.orkl.eu/ea388a3b47c38ea6cd05c168f2f42cbb0371e329.jpg"
    }
}