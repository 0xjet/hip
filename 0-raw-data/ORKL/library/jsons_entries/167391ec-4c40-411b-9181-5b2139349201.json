{
    "id": "167391ec-4c40-411b-9181-5b2139349201",
    "created_at": "2023-01-12T15:07:15.101084Z",
    "updated_at": "2025-03-27T02:05:52.616099Z",
    "deleted_at": null,
    "sha1_hash": "c8eef1d2b4787f48bfc4ff7da00a633cf0f0790c",
    "title": "2021-03-08 - Attack Chain Overview- Emotet in December 2020 and January 2021",
    "authors": "",
    "file_creation_date": "2022-05-28T16:52:18Z",
    "file_modification_date": "2022-05-28T16:52:18Z",
    "file_size": 1770937,
    "plain_text": "# Attack Chain Overview: Emotet in December 2020 and January 2021\n\n**[unit42.paloaltonetworks.com/attack-chain-overview-emotet-in-december-2020-and-january-2021/](https://unit42.paloaltonetworks.com/attack-chain-overview-emotet-in-december-2020-and-january-2021/)**\n\nChris Navarrete, Yanhui Jia, Matthew Tennis, Durgesh Sangvikar, Rongbo Shao March 8, 2021\n\nBy [Chris Navarrete,](https://unit42.paloaltonetworks.com/author/chris-navarrete/) [Yanhui Jia,](https://unit42.paloaltonetworks.com/author/yanhui-jia/) [Matthew Tennis,](https://unit42.paloaltonetworks.com/author/matthew-tennis/) [Durgesh Sangvikar and](https://unit42.paloaltonetworks.com/author/durgesh-sangvikar/) [Rongbo Shao](https://unit42.paloaltonetworks.com/author/rongbo-shao/)\n\nMarch 8, 2021 at 6:00 AM\n\n[Category: Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [C2,](https://unit42.paloaltonetworks.com/tag/c2/) [Emotet,](https://unit42.paloaltonetworks.com/tag/emotet/) [Evasion](https://unit42.paloaltonetworks.com/tag/evasion/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/attack-chain-overview-emotet-in-december-2020-and-january-2021/)\n\n## Executive Summary\n\nUnit 42 researchers have identified and analyzed a new update of Emotet, the notorious\nbanking Trojan, that has been active in the wild since December 2020. Emotet has long been\na thorn in the side of defenders with a reputation for its tenacity, longevity and resilient\nevasion techniques.\n\n[Recent actions by international law enforcement have disrupted the Emotet threat actors and](https://www.europol.europa.eu/newsroom/news/world%E2%80%99s-most-dangerous-malware-emotet-disrupted-through-global-action)\ntheir infrastructure. However, the tactics, techniques and procedures (TTPs) employed in this\nEmotet update present an opportunity to expose the inner workings of an active, prominent\nthreat against all industries\n\n\n-----\n\nIn this blog, we will detail the end-to-end attack chain of this Emotet update, including its firststage malicious document lure, the deobfuscation of its payload into a second-stage\nPowerShell loader and the downloading of the third-stage binary R43H.dll.\n\nWe will also detail the persistence mechanisms used by this Emotet update, as well as the\ncommand and control (C2) channel and its indicators of compromise (IOCs). Lastly, we will\ndemonstrate the difficulties that security solutions face against Emotet’s evasion techniques.\n\n[Palo Alto Networks Next-Generation Firewall customers are protected from Emotet with](https://www.paloaltonetworks.com/network-security/next-generation-firewall)\n[Threat Prevention and](https://www.paloaltonetworks.com/products/secure-the-network/subscriptions/threat-prevention) [WildFire security subscriptions. Customers are also protected with](https://www.paloaltonetworks.com/products/secure-the-network/wildfire)\n[Cortex XDR.](https://www.paloaltonetworks.com/cortex/cortex-xdr)\n\n## Attack Chain Analysis\n\n[Emotet is commonly distributed with a Word document attached in phishing emails. Below](https://unit42.paloaltonetworks.com/tag/emotet/)\nare the steps in an [Emotet attack chain:](https://unit42.paloaltonetworks.com/emotet-thread-hijacking/)\n\n1. Word doc distributed and opened with macros enabled.\n2. VBScript macro(s) runs to generate the malicious PowerShell script.\n3. The malicious PowerShell script downloads the initial DLL binary as a loader.\n4. The initial loader drops a follow-up DLL binary that updates itself.\n5. The final DLL steals victims’ sensitive data or conducts further attacks by\n\ncommunicating with C2 servers.\n\n## First-Stage Malware – Word Macro Launcher\n\n(Sha256: 2cb81a1a59df4a4fd222fbcb946db3d653185c2e79cf4d3365b430b1988d485f)\n\nThe analyzed sample is a Microsoft Office OLE2 Compound File Binary Word file. As with\nmany spear-phishing attacks, this one also social-engineers the user to enable macro\nsupport to start the delivery of malicious Visual Basic for Applications (VBA) code.\n\n\n-----\n\nFigure 1. This malicious Word document contains an embedded macro that initiates an\nEmotet attack chain.\nThe embedded VBA macro code is executed when the user opens the lure document in\n[Microsoft Word with macros enabled, spawning a Document_Open() event.](https://docs.microsoft.com/en-us/office/vba/api/word.document.open)\n\nFigure 2. The embedded VBA macro code is obfuscated to impede analysis efforts.\nThe next call is to a function named Jotxu6biv0471oy0(). The behavior of this function and\nfurther execution of the first-stage malware is described below:\n\n[1. Retrieve a single StoryRange of the wdMainTextStory type from the document’s](https://docs.microsoft.com/en-us/office/vba/api/word.storyranges)\nStoryRanges.Item() method and store it in the variable mKbjhqs. The content of that variable\nis the obfuscated payload data that will be deobfuscated later in the attack chain. A\n\n\n-----\n\nStoryRange in the VBA world is used to find or replace text inside a document.\n\nFigure 3.\n\nThe obfuscated payload is extracted from the malicious document and stored.\n2. Collect obfuscated data through a series of GoTo calls, which stores data across several\nvariables. The data is then concatenated and assigned to variable C_tmpi32le9.\n\nFigure 4. The\n\nobfuscated payload is extracted from the malicious document and stored.\n3. The string stored in C_tmpi32le9 is deobfuscated and substituted in a series of function\ncalls displayed in Figure 4.\n\nFigure 5.\n\nReplace function and data before and after obfuscation.\nThe text payload stored in C_tmpi32le9 is deobfuscated with a call to function\nLehj73snaqzhyepdw9(). This function works as a wrapper for function Jumkzxvtzz2s(), which\nimplements a simple string substitution routine. The function also calls the built-in function\nReplace(), which is passed the string ]b2[s as the delimiter to search and replace in the\n[payload string. The resulting payload is the WMI moniker winmgmts:win32_process, which is](https://www.magicsplat.com/book/wmi.html#tab_wmi_monikers)\nstored in variable H4qcty67722xqmrmn.\n\n4. Generate a new object by making a call to the CreateObject() function and passing as\nparameter the winmgmts:win32_process string. The resulting object value is stored in the\n[Fcqv6woostm0 variable, which is an object of the Win32_Process WMI Class. This variable](https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-process)\nis a handle to an object capable of spawning new processes.\n\nFigure 6. Call to\n\nCreateObject(“winmgmts:win32_process”) constructor.\n\n\n-----\n\n5. Perform a length correction routine and store the resulting data in variable\nMa9hdg7q365lpb. A call to function Lehj73snaqzhyepdw9() is made with Ma9hdg7q365lpb\nas a parameter.\n\nFigure 7. Deobfuscated final payload.\n6. A call to method [Win32_Process.Create() is made by referencing the previously](https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/create-method-in-class-win32-process)\ninstantiated object and passing as first parameter the returning value of the previously\nexecuted Lehj73snaqzhyepdw9() function. The returning value contains the deobfuscated\nfinal payload (operating system and PowerShell commands).\n\nFigure 8. Create() function call with parameters.\nThe first stage of this Emotet attack chain ends with the execution of the deobfuscated\npayload originally embedded in the malicious document. The payload contains a series of\ncalls to cmd.exe nested around an obfuscated call to PowerShell with base64 data passed\nas an argument.\n\nFigure\n\n9. Deobfuscated OS and PowerShell commands.\n\n## Second-Stage Malware – PowerShell Downloader\n\nThe second stage of the attack chain begins with nested cmd.exe calls, the first of which\ninvokes msg.exe. This displays a message window to the victim containing a decoy Word\nerror, “Word experienced an error trying to open the file.”\n\nNext, PowerShell is invoked with base64 encoded data as a parameter, and cmd.exe takes\nthe string P^Ow^er^she^L^L as an argument. This argument is crafted using the caret\nescape character (^) to avoid static detection. The -w option sets the PowerShell.exe\nprocess to start in the background. The -ENCOD option tells PowerShell to decode the\nbase64 argument on the fly.\n\n\n-----\n\nFigure 10. Execution of msg.exe and powershell.exe.\n\n**PowerShell - Base64 Analysis**\n\nFigure 11. Decoded base64 PowerShell data.\nThe purpose of this obfuscated code is as follows:\n\n1. Set the security protocol used by the ServicePoint Manager to TLS 1.2.\n\n2. Set the absolute path of a randomly generated file.\n\n3. Generate an array of a total of seven Uniform Resource Identifiers (URIs).\n\n\n-----\n\nFigure 12. Deobfuscated URIs list.\n4. Instantiate a new object of the [WebClient .NET Class, which leverages the DownloadFile()](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-5.0)\nmethod to retrieve files from each item (URI) contained in the array generated in the previous\nstep. The downloaded file will be saved into a fixed absolute path and filename\n%USERPROFILE%\\Ygyhlqt\\Bx5jfmo\\R43H.dll.\n\nIt’s worth mentioning that the folder names used at this step are matched with the ones\ngenerated during macro execution in the first stage of the attack chain.\n\n5. Perform a length check to equal 37652 bytes. This specific check is presumably made to\nensure the binary content was transferred successfully.\n\n6. Execute the downloaded DLL file by executing the rundll32.exe command and providing\nthe Control_RunDLL as an entrypoint function. The following picture shows the deobfuscated\nversion of the entire command.\n\nFigure 13. Execution of rundll32.exe in PowerShell.\nAs described above, the PowerShell script performs several HTTP requests to different\nURIs. The response from the server shows that a DLL file has been downloaded. The name\nof the file is set to NK05DJ2yiA.dll.\n\n\n-----\n\nFigure 14. HTTP download request - First DLL (NK05DJ2yiA.dll).\n\n## Third-Stage Malware – DLL Analysis\n\n(Sha256: bbb9c1b98ec307a5e84095cf491f7475964a698c90b48a9d43490a05b6ba0a79)\n\nKEY： \"k1>@dY0V<o)afFNz7v68r^Kn6)h)OGcSc\"\n\nFigure 15 shows the process tree having a parent process powershell.exe and the\nconsecutive runs of rundll32.exe.\n\nFigure 15. PowerShell.exe and rundll32.exe processes execution.\nThe first process is given the absolute path to R43H.dll as an argument, and the second\nprocess is given a path to a file with a random path and filename. However, both processes\nbegin with the same entrypoint function called Control_RunDLL. The following describes the\ninner workings of this DLL and its participation in the infection chain.\n\nOnce the downloader code receives the second-stage DLL file, it will be saved in the path\n%USERPROFILE%\\Ygyhlqt\\Bx5jfmo\\ and will be renamed to R43H.dll. According to the\ndetection generated by the ExeInfoPE tool, it shows that this is a Microsoft Visual C++ ver.\n~6.0~7.10 executable file.\n\n\n-----\n\nFigure 16.\n\nExeInfoPE file identification on downloaded DLL file.\nDuring the third-stage malware execution, a new absolute path will be randomly generated.\nA call to the MoveFileExW() function will move the file from its original location to this new\none. The absolute path format is as follows:\n\n%SYSTEMROOT%\\system32\\<random_folder_name>\\<random_filename>.\n<random_ext>\n\n[Next, as shown in Figure 17, a call to the CreateProcessW() function sets the value of the](https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessw)\nlpCommandLine parameter, which includes the absolute path of the recently moved DLL file,\nand the aforementioned entrypoint function Control-RunDLL.\n\nFigure 17. Execution of the second DLL file.\nThe actions performed by the second rundll32.exe execution will be described in the FourthStage Malware section.\n\n**Locate and Load Resource Encrypted Data**\n\nThe Emotet malware performs several actions, and one of those is the use of Resource\nWin32 API functions with the objective of loading binary data from the executable resource\nsection, decrypting it and dropping a newly crafted malware.\n\n\n-----\n\nFirst, at offset 0x10002119, a call to the VirtualAlloc() function is made. This will allocate\n0x1B000 (110592d) bytes, a MEM_COMMIT allocation type and memory protection option\nas PAGE_EXECUTE_READWRITE.\n\nFigure 18. VirtualAlloc() and byte-copying (call 100045c0) function.\nAt offset 0x10002128, the function call 100045C0 copies the bytes from the resource section\ninto the newly generated memory allocation from the previous step (see Figure 18). The\nfollowing picture (Figure 19) shows a comparison between the byte contents of the resources\n[taken directly from the Resource Hacker tool and the contents in memory taken directly from](http://www.angusj.com/resourcehacker/)\nthe running process.\n\nFigure 19. Encrypted binary resources data displayed in the Resource Hacker tool.\nDuring the execution of subsequent instructions, a call to the 0x10001D9A function is made.\nThis function has a loop located at offset 0x10001E4D and performs several operations. One\nof these operations is a 1-byte XOR instruction (xor byte ptr [esi+ecx], al) located at offset\n0x10001E4D. Its purpose is to decrypt a total of 110591 bytes of the executable’s resource\n\n\n-----\n\ndata where the PE binary data is stored. The final result is an in-memory reconstructed\nexecutable file. In Figure 19, the encrypted and decrypted data in the process’s memory can\nbe seen.\n\nFigure 19. Encrypted data in PE and decryption of data in memory.\nAt offset 0x10002167, an indirect function pointer call is made to the address pointed to by\nthe EAX register, which is the entrypoint of the Control_RunDLL function of the in-memory\n(dropped) executable file. Figure 20 shows this in a graphical manner for reference.\n\nFigure 20. Indirect call – transferring control to in-memory data.\nOnce the call EAX instruction is executed, the execution control is transferred to the new\nexecutable file.\n\n**Persistency Mechanism**\n\n\n-----\n\nThe Emotet malware installs a new service by calling the CreateServiceW() function, which\nstarts the copy of the malware in an automated manner by the operating system. Figure 21\nshows this new service already installed.\n\nFigure 21. Installation of a new Windows service.\nThe service name is generated randomly and the below list contains different names used\nthroughout several test runs.\n\nProvides Disk Defragmentation capabilities.\nWindows Media Center Service for TV and FM broadcast reception.\nProcesses application compatibility cache requests for applications as they are\nlaunched.\nStarts and stops recording of TV programs within Windows Media Center.\nTransfers files in the background using idle network bandwidth. If the service is\ndisabled, then any applications that depend on BITS, such as Windows Update or MSN\nExplorer, will be unable to automatically download programs and other information.\n\n## Fourth-Stage Malware – DLL Analysis\n\n(Sha256:bd1e56637bd0fe213c2c58d6bd4e6e3693416ec2f90ea29f0c68a0b91815d91a)\n\nAt this stage, the final payload is preparing the environment to submit information to the C2\nserver. To do so, it executes function calls to retrieve the required data to finally perform the\nHTTP request.\n\nThe following steps assume a base address of 0x2E1000 and describe the details and\nsequences followed by the Emotet malware until the delivery of the payload.\n\n\n-----\n\nFigure 22. Function calls that collect and prepare data for exfiltration.\n\n## Fifth-Stage Malware – C2 Traffic\n\nAs can be seen in the function call list, the HttpSendRequestW() API function is used to send\nthe data to the server. This function allows the sender to exceed the amount of data that is\nbeing sent normally by HTTP clients.\n\nFigure 23. HTTP data in memory before being sent to the C2 server.\nFigure 24 shows the data after being sent and captured by Wireshark.\n\n\n-----\n\nFigure 24. Data being sent to the C2 server captured by Wireshark.\n\n## Evasion Technology\n\n1. Uses multiple download links to download the first-stage loader. As long as one\n\ndownload link is not blocked or captured by a security product, the loader download will\nbe successful.\n2. Uses multiple C2 server IP addresses to communicate with C2 servers. As long as one\n\nIP address is not blocked, the communication will be successful.\n3. The C2 communication uses standard HTTP with sensitive information encrypted with\n\ncustom algorithms. From the perspective of security mitigations, it is difficult to\ndifferentiate this strain of C2 from benign traffic.\n\n## Conclusion\n\nEmotet was a potent adversary before coordinated law enforcement action shut down its\ninfrastructure in late January 2021. The attack chain detailed above is elaborate and is\ndesigned to evade security detections. A single security appliance is not equipped to prevent\nan Emotet attack. Only a combination of security solutions – firewalls, sandboxes, endpoints\nand software to integrate all these components can help prevent an Emotet attack.\n\n\n-----\n\nAt the time of this writing, the samples listed in the IOCs section below were not publicly\navailable. However, we have created detections and coverage against their behavior and\ncommunication.\n\nPalo Alto Networks customers are protected from this kind of attack by the following:\n\n[1. Next-Generation Firewalls with](https://www.paloaltonetworks.com/network-security/next-generation-firewall) [Threat Prevention signatures](https://www.paloaltonetworks.com/products/secure-the-network/subscriptions/threat-prevention) [21201,](https://threatvault.paloaltonetworks.com/?query=21201) [21185 and](https://threatvault.paloaltonetworks.com/?query=21185) [21167](https://threatvault.paloaltonetworks.com/?query=21167)\n\nidentify HTTP C2 requests attempting to download the new payload and post sensitive\ninformation.\n[2. WildFire, an NGFW security subscription, and](https://www.paloaltonetworks.com/products/secure-the-network/wildfire) [Cortex XDR identify and block Emotet](https://www.paloaltonetworks.com/cortex/cortex-xdr)\n\nand its droppers.\n\n## Indicators of Compromise\n\n**Samples**\n\n209a975429304f771ef8a619553ffd9b8fc525a254157cbba47f8e64ec30df79\n\n2a8dcfc8f1262e1c6b5f65c52cdccdbcd40ff6218f4f25f82bd3eb025593dbc0\n\n2cb81a1a59df4a4fd222fbcb946db3d653185c2e79cf4d3365b430b1988d485f\n\n36df660c8e323435d2bc7a5516adcadfbd0b220279f634725e407da9f2b9d4f5\n\n3788c8a783fbbd61fa60d41b78568c095a8587db728a61bff67c3ffebfad82a4\n\n704759a244e3f27481f6ad225a0e1c30ae46e411e01612d68ca76fe2fd8cee54\n\n7a18e87591637a8e962386b9c72aed584037a953ce7fe5ae51edba7a0ca57c1a\n\n96a1fea9853e6f77d4449da325dfdb1545b905bdb7ba227d24e6a1a5f8cb3bd4\n\na9668efdb68bf251dae8623cb4f3dc8b9b7f42d77927d287633af94a72e9d1dc\n\nfc3c1ce6491bca2b028ae8806ca84d4b9dcb577fb2551aa871ca23eca19b10f5\n\n**Droppers**\n\n0a0bf0cab20ec7fb530738c4e08f8cd5062ea44c5da3d8a3e6ce0768286d4c51\n\n2a0a1e12a8a948083abe2a0dcbf9128b8ec7f711251f399e730af6645e86d5c8\n\n3b3a9517b61d2af8758e60d067c08edd397ad76b25efe1cbd393229088567002\n\n3bbda08f5e15c5cb4472c6e610f2063eb68f54c0234a2197bc4633f4344ab27f\n\n3e2fd3a5d790a0d4efe1100af08e3e2011f26416154ec11f1315db2ca6ca71bd\n\n\n-----\n\n4eb1928c08d16a9407dbf89ad1279886379a0415bdd7760a3b2d0697f7d287c6\n\n95bc30b35aa2d2baa80b50e970707197a26bd19d7772cbf65ff3d0300fe8e789\n\n97c395e1bd0c35e9b8e6f9d97b470abdfdacec25e0e4e3b987e3813fb902de9f\n\nbbb9c1b98ec307a5e84095cf491f7475964a698c90b48a9d43490a05b6ba0a79\n\nbd1e56637bd0fe213c2c58d6bd4e6e3693416ec2f90ea29f0c68a0b91815d91a\n\n**URLs**\n\nhttp://abrillofurniture[.]com/bph-nclex-wygq4/a7nBfhs/\n\nhttp://allcannabismeds[.]com/unraid-map/ZZm6/\n\nhttp://ezi-pos[.]com/categoryl/x/\n\nhttp://giannaspsychicstudio[.]com/cgi-bin/PP/\n\nhttp://ienglishabc[.]com/cow/JH/\n\nhttps://etkindedektiflik[.]com/pcie-speed/U/\n\nhttps://vstsample[.]com/wp-includes/7eXeI/\n\n**IPs**\n\n5.2.136[.]90\n\n37.46.129[.]215\n\n70.32.89[.]105\n\n110.172.180[.]180\n\n132.248.38[.]158\n\n138.197.99[.]250\n\n152.170.79[.]100\n\n157.245.145[.]87\n\n161.49.84[.]2\n\n190.55.186[.]229\n\n190.247.139[.]101\n\n\n-----\n\n203.157.152[.]9\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-08 - Attack Chain Overview- Emotet in December 2020 and January 2021.pdf"
    ],
    "report_names": [
        "2021-03-08 - Attack Chain Overview- Emotet in December 2020 and January 2021.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536035,
    "ts_updated_at": 1743041152,
    "ts_creation_date": 1653756738,
    "ts_modification_date": 1653756738,
    "files": {
        "pdf": "https://archive.orkl.eu/c8eef1d2b4787f48bfc4ff7da00a633cf0f0790c.pdf",
        "text": "https://archive.orkl.eu/c8eef1d2b4787f48bfc4ff7da00a633cf0f0790c.txt",
        "img": "https://archive.orkl.eu/c8eef1d2b4787f48bfc4ff7da00a633cf0f0790c.jpg"
    }
}