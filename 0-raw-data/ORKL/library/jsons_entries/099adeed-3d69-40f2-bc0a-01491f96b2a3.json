{
    "id": "099adeed-3d69-40f2-bc0a-01491f96b2a3",
    "created_at": "2023-01-12T15:04:14.443849Z",
    "updated_at": "2025-03-27T02:05:46.777269Z",
    "deleted_at": null,
    "sha1_hash": "62bd040825ecc0b52406a4cf53c4be0c1372c9ca",
    "title": "2021-08-09 - IISpy- A complex server‑side backdoor with anti‑forensic features",
    "authors": "",
    "file_creation_date": "2022-05-28T02:46:34Z",
    "file_modification_date": "2022-05-28T02:46:34Z",
    "file_size": 437262,
    "plain_text": "# IISpy: A complex server‑side backdoor with anti‑forensic features\n\n**[welivesecurity.com/2021/08/09/iispy-complex-server-side-backdoor-antiforensic-features/](https://www.welivesecurity.com/2021/08/09/iispy-complex-server-side-backdoor-antiforensic-features/)**\n\nAugust 9, 2021\n\nThe second in our series on IIS threats dissects a malicious IIS extension that employs nifty\ntricks in an attempt to secure long-term espionage on the compromised servers\n\n[Zuzana Hromcová](https://www.welivesecurity.com/author/zhromcova/)\n9 Aug 2021 - 11:30AM\n\nThe second in our series on IIS threats dissects a malicious IIS extension that employs nifty\ntricks in an attempt to secure long-term espionage on the compromised servers\n\n\n-----\n\nESET researchers have discovered and analyzed a previously undocumented backdoor,\nimplemented as an extension for Internet _Information Services (IIS), Microsoft’s web server_\nsoftware. The backdoor, which we named IISpy, uses a variety of tricks to interfere with the\nserver’s logging and to evade detection, in order to perform long-term espionage. IISpy is\ndetected by ESET security solutions as Win{32,64}/BadIIS.\n\n_This blogpost is the second installment in our series where ESET researchers put IIS web_\n_server threats under the microscope – the other parts discuss IIS malware used for_\n_[cybercrime and](https://www.welivesecurity.com/2021/08/06/iistealer-server-side-threat-ecommerce-transactions/)_ _[SEO fraud, respectively. For a comprehensive guide to how to detect,](https://www.welivesecurity.com/2021/08/11/iiserpent-malware-driven-seo-fraud-service/)_\n_analyze and remove IIS malware, refer to our white paper Anatomy of native IIS malware,_\n_where IISpy is featured as one of the studied families (Group 7)._\n\n[Anatomy of native IIS malware](https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf)\n\n[Download Research Paper](https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf)\n\n## Attack overview\n\nAccording to ESET telemetry, this backdoor has been active since at least July 2020, and\nhas been used with Juicy Potato (detected as Win64/HackTool.JuicyPotato by ESET\nsecurity solutions), which is a privilege escalation tool. We suspect the attackers first obtain\ninitial access to the IIS server via some vulnerability, and then use Juicy Potato to obtain the\n[administrative privileges that are required to install IISpy as a native IIS extension.](https://docs.microsoft.com/en-us/iis/get-started/introduction-to-iis/iis-modules-overview)\n\nAccording to our telemetry, IISpy affects a small number of IIS servers located in Canada,\nthe USA and the Netherlands – but this is likely not the full picture, as it is still common for\nadministrators to not use any security software on servers, and thus our visibility into IIS\nservers is limited.\n\nBecause IISpy is configured as an IIS extension, it can see all the HTTP requests received\nby the compromised IIS server, and shape the HTTP response that the server will answer\nwith. IISpy uses this channel to implement its C&C communication, which allows it to\noperate as a passive network implant. As shown in Figure 1, the operator (not the\nbackdoor) initiates the connection by sending a special HTTP request to the compromised\nserver. The backdoor recognizes the attacker request, extracts and executes the embedded\nbackdoor commands, and modifies the HTTP response to include the command output.\n\nThe following backdoor commands are supported:\n\n\n-----\n\nGet system information\nUpload/download files\nExecute files or shell commands\nCreate a reverse shell\nCreate/list/move/rename/delete files and folders\nCreate a mapping between a local and a remote drive\nExfiltrate collected data\n\nIISpy ignores all other HTTP requests sent to the compromised IIS server by its legitimate\nvisitors – of course, these are still handled by the benign server modules.\n\n_Figure 1. IISpy backdoor control mechanism_\n\n## Network communication\n\nThe control requests from IISpy’s operators have a predefined structure, with a specific\n(hidden) relationship between the Cookie and Host headers, and the URL. To identify such\nrequests, IISpy first computes the MD5 hash of both the URL and Host header of an\ninbound HTTP request, and splits each MD5 into four double words:\n\n<h0><h1><h2><h3> = md5(Host Header value)\n<r0><r1><r2><r3> = md5(Raw URL value)\n\nThen, it verifies that the Cookie header contains a substring built from these values:\n\n<r1><h2>=<h3><r2><r3><r0><h0><h1>\n\nFigure 2 illustrates how this substring is assembled. Backdoor commands are embedded in\nthe HTTP body, AES‑CBC encrypted and base64 encoded.\n\n\n-----\n\n_Figure 2. IISpy control HTTP request format_\n\nNote that this structure of control requests is unique to IISpy: all the other known IIS\n[backdoors (that we have documented in our white paper Anatomy of native IIS malware)](https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf)\nare controlled by hardcoded passwords, specific URIs or custom HTTP headers. As\nopposed to those “secrets”, IISpy’s control requests are more difficult to fingerprint and find\nin logs, which is an attempt to keep its C&C communication unnoticed.\n\nAnother such trick is used for the other side of the communication: IISpy embeds its\nencrypted and encoded response within a fake PNG image, between the PNG file headers\nas a TEXT or BLOB chunk. To reply to a control HTTP request, IISpy replaces the original\nHTTP response body (sent by the IIS server) with the fake PNG file, and sets the ContentType header to image/png to give more credibility to this charade.\n\nBoth sides of the C&C communication are AES-CBC encrypted and base64 encoded, using\nthese parameters:\n\nEncryption key:\nDA1F8BE19D9122F6499D72B90299CAB080E9D599C57E802CD667BF53CCC9EAB2\nIV: 668EDC2D7ED614BF8F69FF614957EF83EE\n\n## Technical analysis\n\nFrom the technical standpoint, IISpy is implemented as a native IIS module – a C++ DLL\ndeployed in the %windir%\\system32\\inetsrv\\ or the %windir%\\SysWOW64\\inetsrv folder on\nthe compromised IIS server, under the name cache.dll or logging.dll.\n\nIISpy is configured as an IIS extension in the\n%windir%\\system32\\inetsrv\\config\\ApplicationHost.config configuration file, and so it is\nloaded automatically by the IIS Worker Process (w3wp.exe), which handles all requests\nsent to the IIS web server. As far as execution and persistence goes, configuring IISpy as\nan IIS module itself checks all the boxes – all that’s left to implement inside the malicious\nmodule is the actual request processing (and as a bonus, a few anti-detection and antiforensic tricks). We cover both in this section.\n\n### Module design\n\n\n-----\n\n[IISpy is written using the IIS C++ API, and uses instances of](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/native-code-api-reference) [IHttpContext,](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/ihttpcontext-interface) [IHttpRequest](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/chttpmodule-class)\n[and IHttpResponse interfaces to parse HTTP requests and manipulate the HTTP](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/ihttpresponse-interface)\nresponses.\n\nAs required by all native IIS modules, it exports a function called RegisterModule, where it\ncreates an instance of its core classes and registers their methods for server events using\nthe IHttpModuleRegistrationInfo::SetRequestNotifications method, as shown in Figure 3.\n\n_Figure 3. IISpy’s RegisterModule export_\n\n[IISpy’s core class is inherited from CHttpModule and, as seen in Figure 4, overrides three of](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/chttpmodule-class)\nits methods – event handlers for the server events:\n\nOnBeginRequest is called every time the server starts processing a new HTTP\nrequest, and IISpy uses this handler to parse it in search of attacker requests\n[OnEndRequest, called with the last step within the HTTP request-processing pipeline,](https://docs.microsoft.com/en-us/iis/get-started/introduction-to-iis/introduction-to-iis-architecture#request-processing-in-iis)\nimplements IISpy’s backdoor interpreter\nOnLogRequest, called right before the IIS server logs a processed HTTP request,\nimplements IISpy’s anti-logging feature\n\n\n-----\n\nIISpy registers these handlers with the highest priority (via the\nIHttpModuleRegistrationInfo::SetPriorityForRequestNotification API). Since several IIS\nmodules (malicious and regular) can be registered for the same event, this ensures that\nIISpy’s handler will be executed before any other handlers registered for the same event.\n\n_Figure 4. IISpy’s core class implements three event handlers_\n\n### Backdoor commands\n\nIn its OnEndRequest handler, IISpy decrypts the HTTP body of an attacker’s request and\nextracts its parameters, which are organized as key-value pairs and listed in Table 1.\n\n_Table 1. IISpy attacker request parameters_\n\n**Key** **Value**\n\n/mode Command type\n\n\n-----\n\n**Key** **Value**\n\n/action Command\n\n\n/path\n\n/binary\n\n/data\n\n…\n\n\nCommand arguments (see Table 2 for full list)\n\n\n/credential/username Local user username, used for impersonation\n\n/credential/password Local user password, used for impersonation\n\nIf the credentials are present, IISpy uses them to log in as the user (via LogonUserW,\nImpersonateLoggedOnUser) to execute the backdoor commands in the user’s context. The\nbackdoor commands and arguments are also organized as nested key-value pairs, as listed\nin Table 2.\n\n_Table 2. IISpy backdoor commands and arguments_\n\n\n**Command**\n**type**\n**(/mode**\n**value)**\n\n\n**Command**\n**(/action**\n**value)**\n\n\n**Arguments (key**\n**names)**\n\n\n**Command**\n**description**\n\n\ninit N/A N/A Collects basic\nsystem information:\ncomputer name and\ndomain, username\nand domain, logical\ndrives information.\n\nfile list /path Collects information\nabout the files in the\nspecified folder.\n\n\n**Returned data**\n**(map structure**\n**or description)**\n\n/computer/domain\n\n/computer/name\n\n/user/domain\n\n/user/name\n\n/\n/name\n\n/type\n\n/\n/name\n\n/attr\n\n/size\n\n/create\n\n/access\n\n/write\n\n\nget /path\n\n/binary\n\n\nDownloads the file\nwith the specified\nname from the\ncompromised IIS\nserver.\n\n\nThe contents of the\nfile, encrypted and\nembedded within a\nfake PNG image (a\nPNG header\nfollowed by nonimage data).\n\n\n-----\n\n**Command**\n**type**\n**(/mode**\n**value)**\n\n\n**Command**\n**(/action**\n**value)**\n\n\n**Arguments (key**\n**names)**\n\nCreates a new file\nor directory in the\nspecified path.\nOptional /data\nargument can hold\nthe file content.\n\nUploads a file with\nthe specified name\nto the\ncompromised\nserver. The /data\nentry contains\nbase64-encoded\nfile content.\n\nDeletes the list of\nfiles/directories in\nthe given path.\n\nCopies or renames\nfiles from the list,\nfrom the source\ndirectory to the\ndestination\ndirectory.\n\nModifies file\ntimestamps\n\n\n**Command**\n**description**\n\n/\n/file\n\n/attr\n\n/size\n\n/create\n\n/access\n\n/write\n\n/\n/file\n\n/attr\n\n/size\n\n/create\n\n/access\n\n/write\n\n/files\n\n/code\n\n/name\n\n/files\n\n/code\n\n/name\n\nN/A\n\nCreates a mapping\nbetween a local and\na remote drive,\nusing the specified\ncredentials for the\nnetwork resource.\n\nN/A\n\n\n**Returned data**\n**(map structure**\n**or description)**\n\nN/A\n\n\ncreate /path\n\n/directory\n\n/data\n\nupload /path\n\n/data\n\ndelete /path\n\n/files\n\n/name\n\n/attr\n\nmove /path\n\n/dest\n\n/copy\n\n/files\n\n/name\n\n/new\n\ntime /path\n\n/create\n\n/access\n\n/write\n\n\ndrive map /letter\n\n/share\n\n/username\n\n/password\n\nremove /letter Removes an\nexisting drive\nmapping\n\n\n-----\n\n**Command**\n**type**\n**(/mode**\n**value)**\n\n\n**Command**\n**(/action**\n**value)**\n\n\n**Arguments (key**\n**names)**\n\n\n**Command**\n**description**\n\n\ncmd exec /cmd Executes the\nspecified command,\neither under the\ncontext of the\ncurrent user, or the\nuser provided in\narguments. Returns\nthe command\noutput.\n\n\n**Returned data**\n**(map structure**\n**or description)**\n\n/output\n\n\nAfter executing the backdoor command, IISpy encrypts and encodes its return data and\nuses it to modify the HTTP response to the attacker’s request. The return data is also\norganized as key-value pairs, with the entries listed in Table 2, plus two additional entries\nbased on the GetLastError result (or custom error messages):\n\n/error/code\n/error/message\n\n### Anti-logging feature\n\nFinally, IISpy implements the OnLogRequest event handler – called right before the IIS\nserver logs a processed HTTP request. The backdoor uses this handler to modify the log\nentries for requests coming from the attackers to make them look like casual requests. As\nshown in Figure 5, these steps are taken:\n\nRewrite the HTTP method in the request to GET\nRewrite the URL from the request to /\nDelete these headers from the request: Cookie, Origin, Referer, Sec-Fetch-Mode,\nSec-Fetch-Site, Content-Type, Content-Length, X-Forwarded-IP, X-Forwarded-For, XForwarded-By, X-Forwarded-Proto\n\nWith the log entries modified this way, the attackers attempt to further hide traces of their\nmalicious activities, to make potential forensic analysis more difficult.\n\n\n-----\n\n_Figure 5. IISpy modifies log entries for attacker requests_\n\n## Conclusion\n\nIISpy is a complex server-side backdoor misusing the extensibility of IIS web server\nsoftware for its persistence, execution and C&C mechanisms. With its tricks to blend in with\nthe regular network traffic, and to clear incriminating logs, it is designed for long term\nespionage on compromised IIS servers.\n\nOrganizations that handle sensitive data on their servers should be on the lookout, such as\norganizations that have the Outlook on the web (OWA) service enabled on their Exchange\nemail servers – OWA is implemented via IIS, and makes an interesting target for espionage.\nIn any case, the best way to keep IISpy out of your servers is to keep them up to date, and\ncarefully consider which services are exposed to the internet, to reduce the risk of server\nexploitation.\n\n_Additional technical details on the malware, Indicators of Compromise and YARA rules can_\n_[be found in our comprehensive white paper, and on](https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf)_ _[GitHub. For any inquiries, or to make](https://github.com/eset/malware-ioc/tree/master/badiis)_\n_[sample submissions related to the subject, contact us at: threatintel@eset.com.](http://10.10.0.46/mailto:threatintel@eset.com)_\n\n## Indicators of Compromise (IoCs)\n\n### ESET detection names\n\nWin32/BadIIS.F\n\nWin64/BadIIS.U\n\n### SHA-1\n\n\n-----\n\n22F8CA2EB3AF377E913B6D06B5A3618D294E4331\n435E3795D934EA8C5C7F4BCFEF2BEEE0E3C76A54\nCED7BC6E0F1A15465E61CFEC87AAEF98BD999E15\n\n### Filenames\n\ncache.dll\n\nlogging.dll\n\n## MITRE ATT&CK techniques\n\n_[Note: This table was built using version 9 of the MITRE ATT&CK framework.](https://attack.mitre.org/resources/versions/)_\n\n**Tactic** **ID** **Name** **Description**\n\n\nResource\nDevelopment\n\n\n[T1587.001](https://attack.mitre.org/versions/v9/techniques/T1587/001/) Develop\nCapabilities:\nMalware\n\n\n[T1588.002](https://attack.mitre.org/versions/v9/techniques/T1588/002/) Obtain\nCapabilities:\nTool\n\n\nOperators of IISpy\nhave used Juicy\nPotato, a local\nprivilege escalation\ntool.\n\n\nInitial Access [T1190](https://attack.mitre.org/versions/v9/techniques/T1190/) Exploit PublicFacing Application\n\nExecution [T1059.003](https://attack.mitre.org/versions/v9/techniques/T1059/003/) Command and\nScripting\nInterpreter:\nWindows Command\nShell\n\n\nIISpy is a custom-made malware\nfamily.\n\nIISpy likely obtains its initial access\nto the IIS server via some\nvulnerability in the web application\nor on the server, before it uses the\nprivilege escalation tool Juicy\nPotato to obtain the administrative\nprivileges that are required to\ninstall a native IIS module.\n\nIISpy supports a backdoor\ncommand that uses the Windows\ncommand shell to execute shell\ncommands on the compromised\nIIS server.\n\nIISpy is loaded by IIS Worker\nProcess (w3wp.exe) when the IIS\nserver receives an inbound HTTP\nrequest.\n\n\n[T1569.002](https://attack.mitre.org/versions/v9/techniques/T1569/002/) System\nServices:\nService\nExecution\n\n\nIIS server (and by\nextension, IISpy)\npersists as a\nWindows service.\n\n\nPersistence [T1546](https://attack.mitre.org/versions/v9/techniques/T1546/) Event Triggered\nExecution\n\n\n-----\n\n**Tactic** **ID** **Name** **Description**\n\n\nPrivilege\nEscalation\n\nDefense\nEvasion\n\n\n[T1068](https://attack.mitre.org/versions/v9/techniques/T1068/) Exploitation for\nPrivilege Escalation\n\n[T1134.001](https://attack.mitre.org/versions/v9/techniques/T1134/001/) Access Token\nManipulation: Token\nImpersonation/Theft\n\n\n[T1070](https://attack.mitre.org/versions/v9/techniques/T1070/) Indicator\nRemoval on\nHost\n\n[T1070.006](https://attack.mitre.org/versions/v9/techniques/T1070/006/) Indicator\nRemoval on\nHost:\nTimestomp\n\n\nIISpy has the ability\nto sanitize logging\nof attacker requests\non the IIS server.\n\nIISpy supports a\nbackdoor command\nto modify file\ntimestamps.\n\n\nOperators of IISpy have used a\nlocal privilege escalation tool Juicy\nPotato to elevate privileges.\n\nIISpy has the ability to execute\nbackdoor commands in another\nuser’s context (via LogonUserW,\nImpersonateLoggedOnUser).\n\nIISpy supports a backdoor\ncommand to collect and exfiltrate\nfiles from the compromised IIS\nserver.\n\nIISpy is a passive network implant:\nAdversaries send HTTP requests\nto the compromised IIS server to\ncontrol the backdoor.\n\n\nCollection [T1005](https://attack.mitre.org/versions/v9/techniques/T1005/) Data from Local\nSystem\n\n\nCommand\nand Control\n\n\n[T1071.001](https://attack.mitre.org/versions/v9/techniques/T1071/001/) Application Layer\nProtocol: Web\nProtocols\n\n\n[T1001](https://attack.mitre.org/versions/v9/techniques/T1001/) Data\nObfuscation\n\n\nIISpy operators\nsend commands\nwith a specially\nconstructed\ncombination of\nURLs, Host\nheaders and\ncookies.\n\nIISpy exfiltrates\ndata in a fake PNG\nfile (a PNG header\nfollowed by nonimage data), in an\nattempt to make its\nC&C traffic look like\nregular network\ntraffic.\n\n\n-----\n\n**Tactic** **ID** **Name** **Description**\n\n\n[T1132.001](https://attack.mitre.org/versions/v9/techniques/T1132/001/) Data\nEncoding:\nStandard\nEncoding\n\n[T1573.001](https://attack.mitre.org/versions/v9/techniques/T1573/001/) Encrypted\nChannel:\nSymmetric\nCryptography\n\n[T1105](https://attack.mitre.org/versions/v9/techniques/T1105/) Ingress Tool\nTransfer\n\n\nIISpy encodes the\nC&C\ncommunication with\nbase64 encoding.\n\nIISpy uses AESCBC to encrypt\nC&C\ncommunication.\n\nIISpy supports a\nbackdoor command\nto upload additional\ntools to the\ncompromised IIS\nserver.\n\n\nExfiltration [T1041](https://attack.mitre.org/versions/v9/techniques/T1041/) Exfiltration Over C2\nChannel\n\n9 Aug 2021 - 11:30AM\n\n\nIISpy supports a backdoor\ncommand to exfiltrate data and\nfiles from the compromised IIS\nserver.\n\n\n### Sign up to receive an email update whenever a new article is published in our Ukraine Crisis – Digital Security Resource Center\n\n Newsletter\n\n\n-----\n\n### Discussion\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-09 - IISpy- A complex server‑side backdoor with anti‑forensic features.pdf"
    ],
    "report_names": [
        "2021-08-09 - IISpy- A complex server‑side backdoor with anti‑forensic features.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535854,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1653705994,
    "ts_modification_date": 1653705994,
    "files": {
        "pdf": "https://archive.orkl.eu/62bd040825ecc0b52406a4cf53c4be0c1372c9ca.pdf",
        "text": "https://archive.orkl.eu/62bd040825ecc0b52406a4cf53c4be0c1372c9ca.txt",
        "img": "https://archive.orkl.eu/62bd040825ecc0b52406a4cf53c4be0c1372c9ca.jpg"
    }
}