{
    "id": "8a354e59-0b08-441b-8fba-b729d210f3b0",
    "created_at": "2023-01-12T15:01:52.546319Z",
    "updated_at": "2025-03-27T02:15:35.665677Z",
    "deleted_at": null,
    "sha1_hash": "0d723bfe45d037abfc1926e92e6dc1126fadda5e",
    "title": "2022-02-12 - Analyzing a Stealer MSI using msitools",
    "authors": "",
    "file_creation_date": "2022-05-28T05:07:12Z",
    "file_modification_date": "2022-05-28T05:07:12Z",
    "file_size": 742442,
    "plain_text": "# Analyzing a Stealer MSI using msitools\n\n**[forensicitguy.github.io/analyzing-stealer-msi-using-msitools/](https://forensicitguy.github.io/analyzing-stealer-msi-using-msitools/)**\n\nBy _[Tony Lambert](https://twitter.com/ForensicITGuy)_\nPosted 2022-02-12 Updated 2022-03-28 11 min read\n\n\nFebruary 12, 2022\n\n\n[This post is dedicated to Josh Rickard (@MSAdministrator on Twitter) since his feedback](https://twitter.com/MSAdministrator)\non my blog posts has cut my triage time on MSI files down in a massive way! After writing\n[an analysis of a MSI payload distributing njRAT, Josh hit me up on Twitter to suggest a](https://forensicitguy.github.io/njrat-installed-from-msi/)\n[Python tool he made to analyze MSIs, msi-utils with the caveat that it only worked on](https://github.com/MSAdministrator/msi-utils)\nmacOS. I set off to figure out why it only worked on macOS and, long story short, the\n[journey led me to the msitools package on Linux. I’ll use it in this post to analyze this](https://wiki.gnome.org/msitools)\nsample in MalwareBazaar:\nhttps://bazaar.abuse.ch/sample/1f7830f0117f694b87ae81caed022c82174f9a8d158a0b8e12\n7154e17d1600cc/.\n\n## Getting msitools\n\n2022-02-14 Edit: `msitools is now included in REMnux! To get it run` `remnux`\n```\n   upgrade .\n\n```\nThe `msitools package isn’t installed by default in REMnux, so we have to go install it`\nourselves. This is easily done using `apt .`\n```\n  sudo apt update\n  sudo apt install\n  msitools\n\n```\nOnce the package is installed, we can move on to ripping apart MSI files!\n\n## Triage the MSI Sample\n\nThe Detect-It-Easy and `file output confirm we do have a MSI file.`\n\n\n-----\n\n```\n  remnux@remnux:~/cases/arkei-msi$ diec po.msi \n  filetype: Binary\n  arch: NOEXEC\n  mode: Unknown\n  endianess: LE\n  type: Unknown\n   installer: Microsoft Installer(MSI)\n  remnux@remnux:~/cases/arkei-msi$ file po.msi \n  po.msi: Composite Document File V2 Document, Little Endian, Os: Windows, Version\n  10.0, MSI Installer, Code page: 1252, Title: My App 21.9.9.16, Subject: My App,\n  Author: My App, Keywords: Installer, Template: Intel;1033, Revision Number:\n  {9CE926D0-E487-4691-A805-7922D5CC3D39}, Create Time/Date: Thu Feb 18 21:32:30\n  2021, Last Saved Time/Date: Thu Feb 18 21:32:30 2021, Number of Pages: 200,\n  Number of Words: 12, Name of Creating Application: MSI Wrapper (10.0.50.0),\n  Security: 2\n\n```\nMore specifically, the data from `file indicates the MSI file was created by a tool named`\n“MSI Wrapper (10.0.50.0)”. The tool is likely the one from this web site:\n[https://www.exemsi.com/](https://www.exemsi.com/)\n\n## Enumerating MSI Tables and Streams\n\nWe can start the analysis using `msiinfo to get some information about the file. We`\ndefinitely want to know what table and stream structures we can expect within the MSI.\n```\n  remnux@remnux:~/cases/arkei-msi$ msiinfo tables\n  po.msi \n  _SummaryInformation\n  _ForceCodepage\n  _Validation\n  AdminExecuteSequence\n  AdminUISequence\n  AdvtExecuteSequence\n  Binary\n  Component\n  Directory\n  CustomAction\n  Feature\n  FeatureComponents\n  File\n  Icon\n  InstallExecuteSequence\n  InstallUISequence\n  LaunchCondition\n\n```\n\n-----\n\n```\nMedia\nProperty\nRegistry\nUpgrade\nremnux@remnux:~/cases/arkei-msi$ msiinfo streams\npo.msi \nIcon.ProductIcon\nBinary.bz.CustomActionDll\nBinary.bz.WrappedSetupProgram\nSummaryInformation\nDocumentSummaryInformation\n\n```\n\n-----\n\nAs MSI files go, this one isn’t particularly complex. Depending on the product used, there\ncan be a lot more data in tables and streams. There are a few things we definitely want to\nhit during our analysis here. First, we need to examine the contents of the “CustomAction”\ntable at the very least. The CustomAction table is often interesting with malicious installers\nas adversaries may hide code to execute within the CustomAction table. PurpleFox\nmalware has placed JScript to execute in this table in the past and other malware families\nhave used the table to specify that a malicious DLL should be executed during installation.\nT\n\n## Dumping Tables and Streams\n\nWe can dump out all of the contents using `msidump .`\n```\n  remnux@remnux:~/cases/arkei-msi$ msidump -s -t po.msi \n  Exporting table _SummaryInformation...\n  Exporting table _ForceCodepage...\n  Exporting table _Validation...\n  Exporting table AdminExecuteSequence...\n  Exporting table AdminUISequence...\n  Exporting table AdvtExecuteSequence...\n  Exporting table Binary...\n  Exporting table Component...\n  Exporting table Directory...\n  Exporting table CustomAction...\n  Exporting table Feature...\n  Exporting table FeatureComponents...\n  Exporting table File...\n  Exporting table Icon...\n  Exporting table InstallExecuteSequence...\n  Exporting table InstallUISequence...\n  Exporting table LaunchCondition...\n  Exporting table Media...\n  Exporting table Property...\n  Exporting table Registry...\n  Exporting table Upgrade...\n  Exporting stream Icon.ProductIcon...\n  Exporting stream Binary.bz.CustomActionDll...\n  Exporting stream Binary.bz.WrappedSetupProgram...\n  Exporting stream SummaryInformation...\n  Exporting stream DocumentSummaryInformation...\n  remnux@remnux:~/cases/arkei-msi$ ls -l\n  total 4720\n  -rw-rw-r-- 1 remnux remnux   243 Feb 12 22:44\n  AdminExecuteSequence.idt\n  -rw-rw-r-- 1 remnux remnux   141 Feb 12 22:44 AdminUISequence.idt\n  -rw-rw-r-- 1 remnux remnux   225 Feb 12 22:44\n  AdvtExecuteSequence.idt\n  drwxrwxr-x 2 remnux remnux  4096 Feb 12 22:44 Binary\n  -rw-rw-r-- 1 remnux remnux   132 Feb 12 22:44 Binary.idt\n  -rw-rw-r-- 1 remnux remnux   202 Feb 12 22:44 Component.idt\n\n```\n\n-----\n\n```\n rw rw r 1 remnux remnux  1093 Feb 12 22:44 CustomAction.idt\n...\n\n```\n\n-----\n\nEach of the IDT files contain data from the tables, while two folders named “Binary” and\n“_Streams” hold executable and stream data fetched from the MSI. First up, let’s inspect\nthat CustomAction.idt file.\n\n\n-----\n\n```\n  Action Type  Source Target ExtendedType\n  s72   i2   S72   S255  I4\n  CustomAction  Action\n  bz.EarlyInstallMain   1    bz.CustomActionDll   _InstallMain@4 \n  bz.EarlyInstallSetPropertyForDeferred1 51   bz.EarlyInstallFinish2 \n  [BZ.INIFILE]  \n  bz.EarlyInstallFinish2 1    bz.CustomActionDll   _InstallFinish2@4   \n  bz.LateInstallPrepare  1    bz.CustomActionDll   _InstallPrepare@4   \n  bz.LateInstallSetPropertyForDeferred1  51   bz.LateInstallFinish1 \n  [BZ.INIFILE]  \n  bz.LateInstallFinish1  3073  bz.CustomActionDll   _InstallFinish1@4   \n  bz.LateInstallSetPropertyForDeferred2  51   bz.LateInstallFinish2 \n  [BZ.INIFILE]  \n  bz.LateInstallFinish2  3073  bz.CustomActionDll   _InstallFinish2@4   \n  bz.CheckReboot 1    bz.CustomActionDll   _CheckReboot@4 \n  bz.UninstallPrepare   1    bz.CustomActionDll   _UninstallPrepare@4  \n  bz.UninstallSetPropertyForDeferred1   51   bz.UninstallFinish1  \n  [BZ.INIFILE]  \n  bz.UninstallFinish1   3073  bz.CustomActionDll   _UninstallFinish1@4  \n  bz.UninstallSetPropertyForDeferred2   51   bz.UninstallFinish2  \n  [BZ.INIFILE]  \n  bz.UninstallFinish2   1025  bz.CustomActionDll   _UninstallFinish2@4  \n  bz.UninstallWrapped   1    bz.CustomActionDll   _UninstallWrapped@4 \n\n```\nThe table contents look relatively normal as far as MSI files go. If there were malicious\ncontent here we’d see code chunks that we’d expect to see in JScript or VBScript files. Let’s\ngo take a look at some other interesting tables. The Property table gives some more\ninformation.\n```\n  Property Value\n\n```\n\n-----\n\n```\ns72   l0\nProperty    Property\nUpgradeCode   {3FF46275-96F9-4EBF-9B1E-50CA97E8DB0E}\nALLUSERS    1\nARPNOREPAIR   1\nARPNOMODIFY   1\nARPPRODUCTICON ProductIcon\nBZ.WRAPPED_REGISTRATION None\nBZ.VER 2922\nBZ.CURRENTDIR  *SOURCEDIR*\nBZ.WRAPPED_APPID    {1FC4DB72-5AB1-4002-B9B0-00FAA9B12D8E}\nBZ.COMPANYNAME EXEMSI.COM\nBZ.BASENAME   NEnXoxoXxKaPjctW.exe\nBZ.ELEVATE_EXECUTABLE  administrators\nBZ.INSTALLMODE EARLY\nBZ.WRAPPERVERSION    10.0.50.0\nBZ.EXITCODE   0\nBZ.INSTALL_SUCCESS_CODES    0\nManufacturer  My App\nProductCode   {481C9516-0944-4A5D-B8F1-803936B5D792}\nProductLanguage 1033\nProductName   My App\nProductVersion 21.9.9.16\nSecureCustomProperties \nWIX_DOWNGRADE_DETECTED;WIX_UPGRADE_DETECTED\n\n```\n\n-----\n\nIt looks like the CompanyName for this MSI Wrapper is EXEMSI.COM, consistent with what\nwe expected so far. The BaseName property looks to be `NEnXoxoXxKaPjctW.exe . We`\nhaven’t seen this name anywhere else in the tables so far, so I’m going to guess there’s an\narchive or something inside a stream that contains the executable or content that\ndownloads it. Let’s go look at the _Streams content.\n```\n  remnux@remnux:~/cases/arkei-msi/_Streams$ file *\n  Binary.bz.CustomActionDll:   PE32 executable (DLL) (GUI) Intel 80386, for MS\n  Windows\n  Binary.bz.WrappedSetupProgram: Microsoft Cabinet archive data, Windows 2000/XP\n  setup, 2059637 bytes, 1 file, at 0x2c +A \"NEnXoxoXxKaPjctW.exe\", ID 5658, number\n  1, 64 datablocks, 0x1503 compression\n  DocumentSummaryInformation:  dBase III DBT, version number 0, next free block\n  index 65534\n  Icon.ProductIcon:       Targa image data - Map 32 x 19866 x 1 +1\n  SummaryInformation:      dBase III DBT, version number 0, next free block\n  index 65534\n\n```\nWe have some executable content that looks interesting in _Streams. First, the file\n```\nBinary.bz.CustomActionDll looks like it’s a Windows native DLL file. A “custom action\n\n```\nDLL” is pretty common to see in MSI files from multiple different products. I commonly see\nthis sort of DLL in MSIs made by AdvancedInstaller tools, and those are usually signed. The\nsecond interesting file is `Binary.bz.WrappedSetupProgram . This looks like a Microsoft`\nCAB file that we can unpack using `7z .`\n```\n  remnux@remnux:~/cases/arkei-msi/_Streams$ 7z x Binary.bz.WrappedSetupProgram\n  7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21\n  p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,2 CPUs\n  Intel(R) Core(TM) i7-8550U CPU @ 1.80GHz (806EA),ASM,AES-NI)\n  Scanning the drive for archives:\n  1 file, 2059637 bytes (2012 KiB)\n  Extracting archive: Binary.bz.WrappedSetupProgram\n  --     \n  Path = Binary.bz.WrappedSetupProgram\n  Type = Cab\n\n```\n\n-----\n\n```\nPhysical Size 2059637\nMethod = LZX:21\nBlocks = 1\nVolumes = 1\nVolume Index = 0\nID = 5658\nEverything is Ok\nSize:    2094224\nCompressed: 2059637\nremnux@remnux:~/cases/arkei-msi/_Streams$ ls -l\ntotal 4408\n-rw-rw-r-- 1 remnux remnux 212992 Feb 12 22:44 Binary.bz.CustomActionDll\n-rw-rw-r-- 1 remnux remnux 2059637 Feb 12 22:44 Binary.bz.WrappedSetupProgram\n-rw-rw-r-- 1 remnux remnux 2094224 Feb 9 14:17 NEnXoxoXxKaPjctW.exe\n\n```\n\n-----\n\nAfter a life-affirming message from `7z, the tool successfully unpacked`\n```\nNEnXoxoXxKaPjctW.exe from the CAB. This is the EXE we were looking for after it was\n\n```\nmentioned in Property.idt! Thus ends the MSI triage!\n\n## Triage the EXE\n\nUsing Detect-It-Easy to identify the file helped find a stumbling block.\n```\n  remnux@remnux:~/cases/arkei-msi/_Streams$ diec\n  NEnXoxoXxKaPjctW.exe \n  filetype: PE32\n  arch: I386\n  mode: 32-bit\n  endianess: LE\n  type: GUI\n   protector: Obsidium(-)[-]\n   linker: unknown(2.30)[GUI32]\n\n```\n[The EXE is protected/packed using Obsidium, a commercial packing tool. There’s probably](https://www.obsidium.de/)\na way to unpack it statically or with a debugger, but that’s going to take more effort than I\nwant to put in tonight. The best way from here forward for me will be to lean on a sandbox\nreport.\n\n## How do we know it’s Arkei Stealer?\n\nThe [Tria.ge report for the sample indicates it found evidence of Arkei in the memory dump](https://tria.ge/220211-hzzkgacbe4/behavioral1)\nof process ID 1312, which corresponds to `NEnXoxoXxKaPjctW.exe . Let’s inspect that`\nmemory dump with some YARA rules and see what we can find. After running the sample\nthrough YARA rules from the `yara-rules and` `ditekshen repositories, I couldn’t find a`\nmatch. I assume at this point that the YARA rule is internal/private to Hatching. So let’s see\nif we can find intelligence overlaps in the sandbox telemetry.\n\n\n-----\n\nThe network activity from the report indicates the sample downloaded `mozglue.dll,`\n```\nsqlite3.dll, nss3.dll, freebl3.dll, and a couple others. These DLLs are\n\n```\ncommonly downloaded and loaded into memory by stealers as they provide functionality to\ndecrypt sensitive data within Mozilla Firefox and Chromium-based web browsers. This is\ncommon to Vidar and Arkei, and these two families are similar enough that one may be\nforked from the other. The network telemetry in the sandbox PCAP can also be helpful\nsince it looks like there was a POST request. We can take a look at the data in Wireshark.\nIn Wireshark, we want to filter on `http protocol only so we can immediately find that`\nPOST request.To see the content of the POST, we can right-click on the POST request and\nfollow the HTTP stream. Once we do that, we can see it looks like the malware uploaded a\nZIP archive named `USR1V37900ZM7Q.zip .`\n\nSince this file is uploaded over HTTP, it stands to reason that we can carve it out of the\nnetwork traffic and inspect the contents. We can do this easily with NetworkMiner. Once you\nopen the PCAP in NetworkMiner, all the files get automatically reassembled and written to\ndisk. To inspect one, right-click on the file and either “Open File” or “Open Folder”.\n\n\n-----\n\nAfter unpacking the ZIP we can find just a few files.\n```\n  remnux@remnux:~/cases/arkei-msi/network$\n  tree -a\n  .\n  ├── History\n  │  └── Firefox_n0kj3f68.default  release.txt\n  ├── screenshot.jpg\n  ├── system.txt\n  └── USR1V37900ZM7Q.zip\n\n```\nJust [searching for “screenshot.jpg” + “system.txt” on Google will yield some hits on Oski](https://www.google.com/search?q=%22screenshot.jpg%22+%22system.txt%22)\nstealer, and one on Vidar. This isn’t surprising as Oski reportedly shares some code with\nVidar and Arkei.\n\nThe Firefox and screenshot information will likely be self-explanatory, so let’s start with\n```\nsystem.txt . Stealers commonly capture system configuration data within a text file and\n\n```\nsometimes leave specific toolmarks/artifacts inside those files For example Raccoon often\n\n\n-----\n\nleaves its own name in a systeminfo text file. Previous versions of Vidar, such as in fumik0 s\nanalysis, seem to store system information in a file named `information.txt instead.`\nThis makes me think we’re actually somewhere in Oski stealer territory since it allegedly\nshares some code with Arkei. Lastly, there’s also a possibility this could be Mars stealer\n[based on its similarity to Oski in this analysis as with Oski, there is a](https://3xp0rt.com/posts/mars-stealer) `system.txt file.`\n\nSo why does any of this matter? It matters a bit for threat intelligence tracking and\nattribution to developers. This also shows the great challenge in threat intelligence of trying\nto interpret malware analysis findings and detection details when many malware tools fork\nfrom one another and share artifacts. In worst case scenarios analysts can make\nassessments based on severely flawed or dated information. In many cases, though, the\ndata is “close enough” to still be useful. This can be seen in the Tria.ge report: no matter\nwhat the stealer is, the configuration is still parsed.\n\nThanks for reading!\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-12 - Analyzing a Stealer MSI using msitools.pdf"
    ],
    "report_names": [
        "2022-02-12 - Analyzing a Stealer MSI using msitools.pdf"
    ],
    "threat_actors": [
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535712,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1653714432,
    "ts_modification_date": 1653714432,
    "files": {
        "pdf": "https://archive.orkl.eu/0d723bfe45d037abfc1926e92e6dc1126fadda5e.pdf",
        "text": "https://archive.orkl.eu/0d723bfe45d037abfc1926e92e6dc1126fadda5e.txt",
        "img": "https://archive.orkl.eu/0d723bfe45d037abfc1926e92e6dc1126fadda5e.jpg"
    }
}