{
    "id": "90610f99-6b80-4fbc-a9f3-1178c50c9cb0",
    "created_at": "2023-01-12T15:02:10.09882Z",
    "updated_at": "2025-03-27T02:05:57.060149Z",
    "deleted_at": null,
    "sha1_hash": "8e6b15d0c12fe0593d1443fa845791ebbfa542a0",
    "title": "2022-07-06 - From Follina to Rozena - Leveraging Discord to Distribute a Backdoor",
    "authors": "",
    "file_creation_date": "2022-07-18T18:09:11Z",
    "file_modification_date": "2022-07-18T18:09:11Z",
    "file_size": 276894,
    "plain_text": "# From Follina to Rozena - Leveraging Discord to Distribute a Backdoor\n\n**[fortinet.com/blog/threat-research/follina-rozena-leveraging-discord-to-distribute-a-backdoor](https://www.fortinet.com/blog/threat-research/follina-rozena-leveraging-discord-to-distribute-a-backdoor)**\n\nJuly 6, 2022\n\n[In May 2022, Microsoft published an advisory about CVE-2022-30190, which is about a Microsoft](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-30190)\nWindows Support Diagnostic Tool (MSDT) remote code execution vulnerability. Attackers can\ninject a malicious external link to an OLE Object in a Microsoft Office document, then lure victims\nto click or simply preview the document in order to trigger this exploit. It will then execute a\npayload on the victim’s machine. Since this vulnerability is a public exploit and has high severity,\n[FortiGuard Labs published an Outbreak Alert on 31 May and ast](https://www.fortiguard.com/outbreak-alert/msdt-follina) [blog article to address it on June](https://www.fortinet.com/blog/threat-research/analysis-of-follina-zero-day?utm_source=blog&utm_medium=blog&utm_campaign=analysis-of-follina-zero-day)\n1, 2022.\n\nDuring our tracking last month, we found a document that exploited CVE-2022-30190, aka Follina,\nthen downloaded Rozena to deploy a fileless attack and leverage the public Discord CDN\nattachment service. Rozena is a backdoor malware that is capable of injecting a remote shell\nconnection back to the attacker’s machine. In this blog we will explain how an attacker delivers\nthis payload through this vulnerability, along with details of Rozena and its shellcode.\n\n\n-----\n\n**Affected platforms: Microsoft Windows**\n**Impact parties: Microsoft Windows Users**\n\n**Impact: Full Control of Affected Machine**\n\n**Severity: Critical**\n\n## Exploitation\n\nThe original malicious document (SHA256:\n432bae48edf446539cae5e20623c39507ad65e21cb757fb514aba635d3ae67d6) contains an\nexternal web link as in Figure 1. The relationship directory (word/_rels/document.xml.rels) is an\nXML file that maps relationships within the .docx file, and also with resources outside of the\npackage, such as links or images.\n\nFigure 1. Document.xml.rels contains a malicious external link in oleObject\n\nOnce the document is clicked (as shown in Figure 2), it starts connecting to the external Discord\nCDN attachment space\n‘hxxps://cdn[.]discordapp.com/attachments/986484515985825795/986821210044264468/index[.]htm’\nto download an HTML file.\n\nFigure 2. Connecting to an external link after clicking the document\n\nAfter it downloads the HTML file (SHA256:\n3558840ffbc81839a5923ed2b675c1970cdd7c9e0036a91a0a728af14f80eff3), the document then\ninvokes msdt.exe with a PowerShell command. The complete payload is shown in Figure 3.\n\nFigure 3. index.html invokes MSDT\n\nIt has a little obfuscation with a concatenation of separate strings that assemble at run time to hide\nthe actual command and evade simple string detection. We decoded a Base64 string and the\ncomplete command is shown in Figure 4.\n\nThe PowerShell code will download one batch file cd.bat (SHA256:\n5d8537bd7e711f430dc0c28a7777c9176269c8d3ff345b9560c8b9d4daaca002) and start it with no\nwindow to hide itself. Then it invokes another web request to download Rozena and saves as\n“Word.exe” (SHA256:\n69377adfdfa50928fade860e37b84c10623ef1b11164ccc6c4b013a468601d88) in the Windows\nTasks folder.\n\nThese two files are also downloaded from the Discord CDN attachment space with the same\nchannelID as the external link in the original document.\n\nFigure 4. Base64 decoded command\n\nAs shown in Figure 5, the cd.bat file has four tasks:\n\n\n-----\n\nDownload another document, 1c9c88f811662007.docx (SHA256:\ne3af143ba12209fafdc3089a740d23faf59f6f1508c00d8f56f8cc9d0c8ebf89) for distraction\nKill processes “msdt.exe” and “WINWORD.exe” to wipe out the trace of exploiting CVE2022-30190\nCreate persistence for Rozena “Word.exe” by adding registry run keys.\nDelete the bat file.\n\nFigure 5. cd.bat file contents\n\n## Distraction\n\nBefore diving into Rozena, this attacker decided to distract the victim. The original file has no\ncontent besides an external link in oleObject. To keep the victim from noticing anything odd the\nbatch file downloads another Word document, 1c9c88f811662007.docx with a lot of pictures in it\n(See Figure 6). To make it seem more real, this document is saved in directory\nC:\\\\users\\$env:USERNAME\\Downloads, with a shorter name, 18562.docx.\n\nFigure 6. Word document for distraction\n\n## Rozena\n\nThe attacker leverages the default Window’s feature, which is not to show the file extension.\nTherefore, the attacker tricks the victim as shown in Figure 7. The green one is the document for\ndistraction with no harm, and the red one is Rozena. It uses the Microsoft Word icon while it is an\nexecutable file. The PE header is shown in Figure 8.\n\nFigure 7. Rozena “Word.exe” uses the Microsoft Word file icon\n\nFigure 8. The File header of Rozena\n\nAfter execution, it will create a process for a PowerShell command. We can find the chain from the\nprocess explorer (shown in Figure 9). And the full PowerShell command is shown in Figure 10,\nwhich is Base64-encoded.\n\nFigure 9. Execution of Rozena\n\nFigure 10. Full PowerShell command extracted from Rozena\n\nAs shown in Figure 11, the decoded command has only one job: inject shellcode. First, it defines a\nvariable “$gcr” for the whole injection procedure. It uses DLLImport for kernel32.dll and msvcrt.dll\nfor importing specific APIs: VirtualAlloc, CreateThread, and Memset, to achieve code injection.\nAnd it has some hexadecimal bytes that define the block of code to be injected later. Then it\ncopies these bytes to the allocated memory and injects them into the running PowerShell.exe.\nFinally, it sets up a loop to start sleep. In the bottom part highlighted in red, it encodes the above\ninjection code from “$gcr” with Base64, then invokes a new PowerShell process with parameter ec.\n\n\n-----\n\nFigure 11. Decoded PowerShell command\n\n## Shellcode\n\nWe extracted the shellcode from the command shown in Figure 12 (SHA256:\n27F3BB9AB8FC66C1CA36FA5D62EE4758F1F8FF75666264C529B0F2ABBADE9133). To dive\ndeep in to this, we checked this binary with IDA. It can divide into following steps:\n\n1. Retrieve decode key\n2. Retrieve location relative to EIP (Figure 13)\n3. Decode (XOR)\n\nFigure 12. Extracted shellcode\n\nFigure 13. Retrieve location relative to EIP\n\nFrom the above instructions, we can identify this as Shikata Ga Nai (SGN) encoding. The SGN\nencoding schema is from the most popular exploit framework, Metasploit. It is a polymorphic XOR\nadditive feedback encoder that allows malicious actors to evade detection. After decoding it, the\nmain purpose of this shellcode is to start a reverse shell to the attacker’s host\nmicrosofto.duckdns[.]org with TCP port 55911 as shown in Figure 14.\n\nFigure 14. Reverse shell\n\nThe complete attack scenario from delivering a malicious document and exploiting CVE-202230190 (Follina) to deploying Rozena from the Discord CDN attachment space is shown in Figure\n15.\n\nFigure 15. Attack scenario\n\n## Conclusion\n\nCVE-2022-30190 is a high-severity vulnerability that lets a malicious actor deliver malware though\nan MS Word document. Microsoft already released a patch for it on June 14, 2022. In this blog we\nshowed how an attacker exploits Follina and included details of Rozena and the SGN ShellCode.\nUsers should apply the patch immediately and also apply FortiGuard protection to avoid the\nthreat.\n\n## Fortinet Protections\n\nFortinet released IPS signature MS.Office.MSHTML.Remote.Code.Execution for CVE-202230190 to proactively protect our customers. The signature is officially released in IPS definition\nversion 20.326.\n\nThe downloader and all related malware from that site are detected and blocked by FortiGuard\nAntivirus:\n\n\n-----\n\nMSOffice/CVE_2017_0199.A!tr\n\nBAT/Agent.1A81!tr\n\nJS/Follina.6FB9!tr\n\nData/Shikata.A!tr\n\nW32/PossibleThreat\n\nBoth the downloaded URL and attacker’s host have been rated as \"Malicious Websites\" by the\nFortiGuard Web Filtering service.\n\nThe oleObject data in Microsoft Office files can be disarmed by the FortiGuard Content Disarm &\nReconstruction (CDR) service.\n\nAll Fortinet Protections and Outbreak Detection, Threat Hunting actions for Fortinet SOC solutions\n[can be found in the Folina Outbreak Alert.](https://www.fortiguard.com/outbreak-alert/msdt-follina)\n\n## IOCs\n\nSHA256:\n\n432bae48edf446539cae5e20623c39507ad65e21cb757fb514aba635d3ae67d6\n\n5d8537bd7e711f430dc0c28a7777c9176269c8d3ff345b9560c8b9d4daaca002\n\n3558840ffbc81839a5923ed2b675c1970cdd7c9e0036a91a0a728af14f80eff3\n\n27f3bb9ab8fc66c1ca36fa5d62ee4758f1f8ff75666264c529b0f2abbade9133\n\n69377adfdfa50928fade860e37b84c10623ef1b11164ccc6c4b013a468601d88\n\n_Learn more about Fortinet’s_ _[FortiGuard Labs threat research and intelligence organization and the](https://www.fortinet.com/fortiguard/labs?utm_source=blog&utm_campaign=fortiguard-labs)_\n_[FortiGuard Security Subscriptions and Services portfolio.](https://www.fortinet.com/fortiguard/labs?tab=security-bundles&utm_source=blog&utm_campaign=security-bundles)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-07-06 - From Follina to Rozena - Leveraging Discord to Distribute a Backdoor.pdf"
    ],
    "report_names": [
        "2022-07-06 - From Follina to Rozena - Leveraging Discord to Distribute a Backdoor.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535730,
    "ts_updated_at": 1743041157,
    "ts_creation_date": 1658167751,
    "ts_modification_date": 1658167751,
    "files": {
        "pdf": "https://archive.orkl.eu/8e6b15d0c12fe0593d1443fa845791ebbfa542a0.pdf",
        "text": "https://archive.orkl.eu/8e6b15d0c12fe0593d1443fa845791ebbfa542a0.txt",
        "img": "https://archive.orkl.eu/8e6b15d0c12fe0593d1443fa845791ebbfa542a0.jpg"
    }
}