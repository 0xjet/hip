{
    "id": "341585e5-00dc-41e2-aba1-bf683a1c59b2",
    "created_at": "2023-01-12T15:10:30.609702Z",
    "updated_at": "2025-03-27T02:05:30.110451Z",
    "deleted_at": null,
    "sha1_hash": "0a9930afd2f80ce9f1b09e34f4005d025fac3df0",
    "title": "2017-03-15 - Teardown of Android-Ztorg (Part 2)",
    "authors": "",
    "file_creation_date": "2022-05-27T19:11:00Z",
    "file_modification_date": "2022-05-27T19:11:00Z",
    "file_size": 439050,
    "plain_text": "# Teardown of Android/Ztorg (Part 2)\n\n**[blog.fortinet.com/2017/03/08/teardown-of-android-ztorg-part-2](http://blog.fortinet.com/2017/03/08/teardown-of-android-ztorg-part-2)**\n\nThreat Research\n\n\nMarch 15, 2017\n\n\nBy [Axelle Apvrille | March 15, 2017](http://blog.fortinet.com/blog/search?author=Axelle+Apvrille)\n**UPDATE March 20, 2017 : the sample does not seem to embed root exploits themselves,**\n_but more precisely executables that run rooting tools. Also Agcr64 is curiously a 32-bit_\n_executable, not 64-bit._\n\n[In the part 1 of this blog, we saw that Android/Ztorg.AM!tr silently downloads a remote](http://blog.fortinet.com/2017/03/08/teardown-of-a-recent-variant-of-android-ztorg-part-1)\nencrypted APK, then installs it and launches a method named c() in the n.a.c.q class. In this\nblog post, we’ll investigate what this does.\n\nThis is the method c() of n.a.c.q:\n\nThis prints \"world,\" then waits for 200 seconds before starting a thread named n.a.c.a. I'll\nspare you a few hops, but among the first things we notice is that the sample uses the same\nstring obfuscation routine, except this time it is not named a.b.c.a() but a.a.p.a(). We patch\nthe JEB2 script to deobfuscate those strings:\n\n\n-----\n\n## Embedded Packages\n\nThe sample checks for various packages (om.android.provider.ring.a, com.ndroid.livct.d). If\nthey are present, it starts them. If not, it retrieves them and starts them.\n\nThe way it retrieves the application is quite peculiar. By default, it does not download it from\nthe web, but gets it from a hexadecimal string stored in the code itself. It only downloads\nfrom the web if the hexstring is not present.\n\nIt retrieves many files that way: Android applications, ELF executables and scripts. All of\nthese are embedded in the sample itself. Sometimes, the sample is embedded in an\nencrypted form (making it even more difficult to detect for an anti-virus engine.) This is the\ncase of the mainmtk.apk application, which is retrieved from a DES encrypted hex string.\nThe DES key is built using a homemade algorithm, which consists of numerous Base64\nencodings and decodings.\n\n### Resorting to Encrypted File Download\n\nWhen the files are downloaded from the web, they are not sent in clear text, but are XOR\n**encrypted (see class b.b.b.a.b). The XOR key is contained within the encrypted stream.**\n\nBased on the reverse engineering of the decryption class, we can implement a decryptor.\n[Mine is available here.](https://github.com/cryptax/misc-code/blob/master/DbaXor.java)\n\nFor example, once decrypted, the bx file downloaded from hxxp://ks.freeplayweb.com/lulu/bx\nturns into an ELF executable (a root exploit):\n\n\n-----\n\n### Creating Scripts\n\nThe sample also uses some shell scripts. They are not included in the assets or\n**resources, but embedded in the code. This is probably done so that anti-virus engines**\ncannot directly match or search for those scripts.\n\nFor instance, the code below writes a shell script named boy.\n\nThe script will look as follows, and is used to run shell commands.\n\n\n-----\n\n## Files Summary\n\nNow let's summarize the various files the sample uses. We have applications and ELF\nexecutables. If you want to follow along in the source code, those are retrieved in\nthe b.b.d.a namespace.\n\nThe files are stored locally in the application's directory, in subdirectories named .zog or .zok.\nNote, the name starting with a point will conceal the file to basic file listings.\n\n**File name** **File type** **Description**\n\n\n-----\n\n**File name** **File type** **Description**\n\n\nAgcr32 ELF\nexecutable\n\nAgcr64 ELF\nexecutable\n\n\nRuns root exploit tools, 32 bit version\n\nRuns root exploit tools, expected a 64 bit version, but actually\nit seems it's a 32 bit version too...\n\n\nbbox.apk Application Installs busybox\n\n\nbx ELF\nexecutable\n\ncx ELF\nexecutable\n\nexp ELF\nexecutable\n\n\nRuns root exploit tools\n\nRuns root exploit tools\n\nRuns root exploit tools\n\n\nmaink.apk Zip Contains boy and bx files\n\n\nmainmtk.apk ELF\nexecutable\n\n\nRusn root exploit tools\n\n\nmainm.apk Replacement for com.android.musitk.b\n\nmainp.apk Could not be retrieved (server down)\n\nmains.apk Application Replacement for com.ndroid.livct.d\n\nmains2.apk Application Replacement for com.android.provider.ring.a\n\n\nnn.zip ELF\nexecutable\n\nnp ELF\nexecutable\n\n\nRuns root exploit tools\n\nRuns root exploit tools\n\n\n-----\n\n**File name** **File type** **Description**\n\n\nsupolicy ELF\nexecutable\n\nym32 ELF\nexecutable\n\nym64 ELF\nexecutable\n\nWe see we have:\n\n\ntool\n\nRuns root exploit, 32 bit version\n\nRuns root exploit, 64 bit version\n\n\n**Tools such as busybox and supolicy. These are not malicious. Busybox is used to**\nsupport various Unix commands on Android. Supolicy is used to modify the current SE\nLinux policies on Android, and for instance, switch the phone to permissive policies.\n**Root exploit tools. For example, the executable Agcr32 tries to root the phone by**\nrunning rooting tools. It considers it has succeeded if the output contains the\nkeyword TOY. See below. This is the 32-bit variant.\n\n**Scripts to run commands.**\n\n## Running the exploits\n\n\n-----\n\nOnce the root exploits are on the file system, they need to be run. This is done in the code by\ncreating a new process that runs sh, writing the shell commands to the process's output\nstream, and reading the responses on the input stream.\n\n## Payload\n\nLet's put pieces together.\n\nThe sample:\n\nGets numerous exploits, tools and scripts to root the device. The files are embedded in\nthe code itself, or retrieved from external websites.\nLowers the SE Linux policy and attempts to root the device.\n\nOnce the device is rooted, the sample gets to its real payload:\n\n\n-----\n\n**Replaces some system files with its own versions. For example, it creates a**\nbackup of the original /system/bin/debuggerd, replaces it with its own .zog/.k file,\nassigns it to root, and changes its SE Linux security context.\n**Installs various applications and runs them. In the case of this sample, those**\napplications are com.android.provider.ring.a, com.ndroid.livct.d, and\ncom.android.musitk.b. The .zog/.k ELF executable also downloads other applications\nfrom a remote server and installs them. The screenshot below shows\nthe .zog/.k starting a key assistance application (am start -n) and downloading from\nhttp://api.agoall.com/ (no longer responds.)\n\nSo, we have a malware that roots victims' devices without their knowledge, and uses this\nprivilege to install other malicious applications.\n\n\n-----\n\n## Conclusion\n\nThis concludes the analysis of the sample silently downloaded by the Android/Ztorg.AM!tr\nsample that we studied in Part 1 of this blog.\n\nMy guess is that you will agree with me that this malware is very advanced. There is string\nobfuscation, multiple levels of encryption (nested), root exploits, tools, and scripts hidden\ninside the code. The malware will be difficult to remove from the device, because it spans\nacross many locations and replaces system binaries.\n\nThis malware is detected as Android/Ztorg.K!tr. Its sha256 sum\nis 5324460dfe1d4f774a024ecc375e3a858c96355f71afccf0cb67438037697b06.\n\nThe downloader (see Part 1) is detected as Android/Ztorg.AM!tr.\n\nIts sha256 sum is\n2c546ad7f102f2f345f30f556b8d8162bd365a7f1a52967fce906d46a2b0dac4.\n\n-- the Crypto Girl\n\n### Related Posts\n\nCopyright © 2022 Fortinet, Inc. All Rights Reserved\n\n[Terms of ServicesPrivacy Policy](https://www.fortinet.com/corporate/about-us/legal.html)\n| Cookie Settings\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-03-15 - Teardown of Android-Ztorg (Part 2).pdf"
    ],
    "report_names": [
        "2017-03-15 - Teardown of Android-Ztorg (Part 2).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536230,
    "ts_updated_at": 1743041130,
    "ts_creation_date": 1653678660,
    "ts_modification_date": 1653678660,
    "files": {
        "pdf": "https://archive.orkl.eu/0a9930afd2f80ce9f1b09e34f4005d025fac3df0.pdf",
        "text": "https://archive.orkl.eu/0a9930afd2f80ce9f1b09e34f4005d025fac3df0.txt",
        "img": "https://archive.orkl.eu/0a9930afd2f80ce9f1b09e34f4005d025fac3df0.jpg"
    }
}