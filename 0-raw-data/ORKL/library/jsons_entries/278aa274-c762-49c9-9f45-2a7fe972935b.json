{
    "id": "278aa274-c762-49c9-9f45-2a7fe972935b",
    "created_at": "2023-01-12T15:09:51.736292Z",
    "updated_at": "2025-03-27T02:06:01.785555Z",
    "deleted_at": null,
    "sha1_hash": "129672c3a8b9cbe07e1519ccdfee5ba3c8f4b66d",
    "title": "2020-04-01 - REvil Ransomware-as-a-Service An analysis of a ransomware affiliate operation",
    "authors": "",
    "file_creation_date": "2022-05-25T12:08:12Z",
    "file_modification_date": "2022-05-25T12:08:12Z",
    "file_size": 518291,
    "plain_text": "# REvil Ransomware-as-a-Service: An analysis of a ransomware affiliate operation\n\n**[intel471.com/blog/revil-ransomware-as-a-service-an-analysis-of-a-ransomware-affiliate-operation](https://intel471.com/blog/revil-ransomware-as-a-service-an-analysis-of-a-ransomware-affiliate-operation/)**\n\nBy the Intel 471 Malware Intelligence team.\n\n## Summary\n\nREvil aka Sodinokibi, Sodin is a ransomware family operated as a ransomware-as-a-service (RaaS). Deployments of REvil first were observed\nin April 2019, where attackers leveraged a vulnerability in Oracle WebLogic servers tracked as CVE-2019-2725.\n\nREvil is highly configurable and allows operators to customize the way it behaves on the infected host. Some of its features include:\n\nExploits a kernel privilege escalation vulnerability to gain SYSTEM privileges using CVE-2018-8453.\nWhitelists files, folders and extensions from encryption.\nKills specific processes and services prior to encryption.\nEncrypts files on local and network storage.\nCustomizes the name and body of the ransom note, and the contents of the background image.\nExfiltrates encrypted information on the infected host to remote controllers.\nREvil uses Hypertext Transfer Protocol Secure (HTTPS) for communication with its controllers.\n\n## Capabilities Overview\n\nRansomware.\n\n## Behaviour Overview\n\nUses a persistence mechanism.\nEncrypts additional resources.\nSupports privilege escalation.\n\n## Adversary intelligence\n\n**Developers**\n\nREvil ransomware first was advertised on a Russian language cybercrime forum in June 2019. The main actor associated with advertising and\npromoting REvil ransomware is called Unknown aka UNKN. The RaaS is operated as an affiliate service, where affiliates spread the malware\nby acquiring victims and the REvil operators maintain the malware and payment infrastructure. Affiliates receive 60% to 70% of the ransom\npayment.\n\nDue to source code and behavior similarities between REvil and GandCrab, it was suggested there might be a connection tying the developers\nof the two ransomware families together. In addition to the similarities in the code, supplemental evidence tying GandCrab and REvil together\nis that GandGrab officially \"retired\" just before REvil appeared in the wild. REvil is maintained actively and is under constant development,\njust as GandCrab was. The most recent REvil ransomware at the time of this report was version 2.1.\n\nThe actor Unknown acknowledged the public reports linking REvil to GandCrab with the following statement:\n```\n“We used to be affiliates of the (GandCrab) affiliate program. We bought the source code and started our own\nbusiness. We developed custom features for our purposes”\n\n```\nDespite the plausible alibi given by actor Unknown, the evidence suggests that REvil is a continuation of the GandCrab RaaS operation with\nnew software, but operated by the same individuals.\n\nThe actors behind REvil include their master public key in all REvil binaries. Therefore, they are able to decrypt the files independently of the\naffiliates running the campaigns.\n\n**Operators**\n\nREvil is a RaaS, in the sense that a single group operates and manages the development of the ransomware while access is sold to affiliates. A\nfield in the configuration file named pid is used to identify the affiliate that the sample belongs to. We have confirmed that a field in the\nmalware configuration named sub is used to identify affiliate campaigns, and not the affiliates themselves, as frequently is reported. In\naddition, the attacker's public key can identify the same operator when used across multiple samples.\n\nTwo prominent users on the aforementioned Russian language cybercrime forum vouched for Unknown's ransomware service:\n\n**kerberos - A moderator on the aforementioned forum and long-standing cybercriminal.**\n**lalartu - A cybercrime actor known to participate in GandCrab and REvil ransomware affiliate programs.**\n\n\n-----\n\ne acto **a a tu s pe so a** o at o poss b y was e eased o a c ous pu poses o do ed by a o at o secu ty esea c e\nknown as UnderTheBreach (see: https://medium.com/@underthebreach/tracking-down-revils-lalartu-by-utilizing-multiple-osint-methods2bf3a6c65a80). We have not been able to verify the conclusions asserted in this post.\n\n## Infrastructure\n\nREvil ransomware configurations contain more than 1,000 controllers. Interestingly, the live domains we verified all were WordPress websites,\nso it is probable they might be compromised by the operators or purchased from other cybercriminals.\n\nThe configuration also contains domain names that were not registered at the time of this report, for example:\n\n$ whois andersongilmour[.]co[.]uk\n\nNo match for \"andersongilmour[.]co[.]uk.\"\n\nThis domain name was not registered at the time of this report.\n\nIt is likely most of the domains present in the configuration are decoys, with only a few real REvil controllers scattered inside the list.\n\n## Detection\n\nThis section describes the methods used to detect a REvil sample.\n\n**Static Detection**\n\nUnpacked REvil samples can be detected statically by looking up patterns in the code and in cryptographic functions used by the ransomware.\n\n**Dynamic Detection**\n\nDynamic detection of REvil samples is possible by running Yara signatures on the memory resident image. In addition, the ransomware creates\nthe following interesting artifacts:\n\nA .txt file with a ransom note on each directory encrypted by the ransomware.\nA .bmp image in the temporary directory set as the desktop background after the encryption.\nA registry key SOFTWARE which can be present under either HKEY_LOCAL_MACHINE or HKEY_CURRENT_USER.\nAn alphanumeric file extension between 5 and 10 characters in length appended to the original extension of an encrypted file.\n\n**Yara Signatures**\n\nWe decided not to release Yara signatures to avoid burning them and affecting the work of other researchers. However, we will release them to\nnetwork defenders and infosec professionals upon request. Email us at revil-yara-reqREMOVEME@intel471[.]com (remove the\n\"REMOVEME\" text from the email address) from your corporate email address (for validation purposes only) and we will send through our\nYara signatures.\n\n## Exploits\n\nREvil ransomware exploits a kernel privilege escalation vulnerability in win32k.sys tracked as CVE-2018-8453 to gain SYSTEM privileges on\nthe infected host. If the configuration instructs a sample to execute this exploit, it will allocate executable memory, decrypt the exploit code in\nthe newly allocated region and invoke it.\n\nThe screenshot below shows the window name sysshadow and the application programming interface (API) DestroyWindow inside the\nembedded exploit, proving it is the CVE-2018-8453 vulnerability.\n\n## Open Source Intelligence (OSINT)\n\nFor more information on REvil, we suggest the following public resources:\n\nREvil/Sodinokibi Ransomware (see: [https://www.secureworks.com/research/revil-sodinokibi-ransomware ).](https://www.secureworks.com/research/revil-sodinokibi-ransomware)\n\n\n-----\n\nc ee a y es Sod o b a a v a so wa e as a Se v ce W at e Code e s Us (see:\nhttps://www.mcafee.com/blogs/other-blogs/mcafee-labs/mcafee-atr-analyzes-sodinokibi-aka-revil-ransomware-as-a-service-what-thecode-tells-us/ ).\nTracking REvil (see: [https://www.kpn.com/security-blogs/Tracking-REvil.htm ).](https://www.kpn.com/security-blogs/Tracking-REvil.htm)\nDefeating Sodinokibi/REvil String-Obfuscation in Ghidra (see: https://blag.nullteilerfrei.de/2020/02/02/defeating-sodinokibi-revilstring-obfuscation-in-ghidra/ ).\n\n## Static Analysis\n\nREvil ransomware incorporates techniques to make the task of static analysis more difficult for an analyst. Most of the strings used during\nexecution are decrypted at runtime only when needed. In addition, the imports are resolved dynamically from 32-bit hashes and placed into\nglobal variables early in execution.\n\n**Hard-coded Strings**\n\nVery few strings are hard coded inside REvil ransomware samples and the most interesting are:\n\n**L“ServicesActive”: This string is passed to the OpenSCManagerW API to retrieve active services.**\n**“expand 32-byte kexpand 16-byte”: The constants used by the Salsa20 symmetric encryption algorithm.**\n\n**String Encryption**\n\nREvil ransomware decrypts most of the strings it uses during execution at runtime.\n\nAs the screenshot above reveals, these strings are Rivest Cipher 4 (RC4) encrypted and are\ndecrypted using a function we renamed to rc4_decrypt_string. Below is its prototype and the\nmeaning of each parameter:\n```\nvoid rc4_decrypt_string(BYTE *rc4_array, int rc4_key_offset, int\nrc4_key_length, int buffer_length, BYTE *out_buffer)\n\n```\n**rc4_array: A pointer to a contiguous array in the .data section containing the RC4 keys**\nand the encrypted strings. Each RC4 key is followed directly by the string it decrypts.\n**rc4_key_offset: The offset to the RC4 key within the array.**\n**rc4_key_length: The length of the RC4 key.**\n**buffer_length: The length of the RC4 encrypted buffer.**\n**out_buffer: Pre-allocated memory or stack space where the decrypted string is copied.**\n\nThe image below shows the layout of two adjacent elements of the array:\n\nThe decrypted strings are not terminated by NULL characters, therefore, the code must\nterminate these strings explicitly.\n\n## Malware Behavior\n\nThe behavior of the following samples was analyzed for this report:\n\n**Sample** **SHA256**\n\nREvil packed 6953d86d09cb8ed34856b56f71421471718ea923cd12c1e72224356756db2ef1\n\nREvil not packed 372c8276ab7cad70ccf296722462d7b8727e8563c0bfe4344184e1bc3afc27fc\n\nREvil not packed ec0c653d5e10fec936dae340bf97c88f153cc0cdf7079632a38a19c876f3c4fe\n\n**Process Execution**\n\nDuring its initialization phase, REvil starts by dynamically resolving the imports it needs to function correctly. This is accomplished in a loop\nthat reads hard-coded 32-bit values from an array in the .data section, then each value is decoded and resolved to the correct API by the\nresponsible function rvl_resolve_api. Then the 32-bit value is overwritten with the pointer to the API.\n\nAs shown in the disassembly above, additional APIs are resolved by their names with the help of the GetProcAddress API.\n\nWith everything in place, REvil creates a global mutual exclusion object (mutex) with a hard-coded name i.e., Global\\1DE3C565-E22C**8190-7A66-494816E6C5F5. This is used to ensure only a single instance of the ransomware sample is running.**\n\nThe REvil ransomware always attempts to run with elevated privileges and does so using two techniques. One technique relies on exploiting the\nCVE-2018-8453 vulnerability to gain SYSTEM privileges on the host. However, to determine whether it should execute the exploit or not, REvil\nchecks its configuration. Another technique always is executed if the process is not elevated. It relies on calling ShellExecuteW to prompt the\n\n\n-----\n\nuse to u t e sa p e as a ad st ato . s s acco p s ed a te oop u t t e use\nagrees to run the elevated process. Starting with version 2.1, the privilege escalation exploit code\nwas removed.\n\nREvil’s configuration is in JavaScript Object Notation (JSON) and is initially RC4 encrypted. It is\nstored in the following fashion at the beginning of a portable executable (PE) section named\n**.yhwfq9:**\n\nIt is important to mention the cyclic redundancy check (CRC32) value is calculated and validated\nfor the encrypted configuration.\n\nAfter decrypting the configuration in dynamically allocated memory, REvil parses it using the\n[open-source json-parser C library (see: https://github.com/udp/json-parser). For an example of](https://github.com/udp/json-parser)\na REvil configuration, see the Appendix section below.\n\nThe first JSON field checked is exp, which can be true or false and indicates whether the CVE2018-8453 vulnerability should be exploited. If the exploit isn’t executed or failed, REvil resorts\nto the second technique previously described in this section.\n\nWhen REvil executes with higher privileges, it starts its main initialization phase where it reads the necessary JSON fields into the .data section\nand initializes registry values inside a new subkey named SOFTWARE. When doing registry operations in general, REvil first tries to use the\n**HKEY_LOCAL_MACHINE hive and it switches to use HKEY_CURRENT_USER only if that fails. The configuration fields, registry keys**\nand their values are described in the below Configuration section.\n\nThe other important task in this phase is filling the ransom note template, which is present in base64 inside the configuration field nbody.\n```\n---=== Welcome. Again. ===--\n```\n\n\n[+] Whats Happen? [+]\n\nYour files are encrypted, and currently unavailable. You can check it: all files on your computer has extension {EXT}.\nBy the way, everything is possible to recover (restore), but you need to follow our instructions. Otherwise, you cant return your data (NEVER).\n\n[+] What guarantees? [+]\n\nIts just a business. We absolutely do not care about you and your deals, except getting benefits. If we do not do our work and liabilities - nobody\nwill not cooperate with us. Its not in our interests.\nTo check the ability of returning files, You should go to our website. There you can decrypt one file for free. That is our guarantee.\nIf you will not cooperate with our service - for us, its does not matter. But you will lose your time and data, cause just we have the private key.\nIn practise - time is much more valuable than money.\n\n[+] How to get access on website? [+]\n\nYou have two ways:\n\n1) [Recommended] Using a TOR browser!\n[a) Download and install TOR browser from this site: https://torproject.org/](https://torproject.org/)\nb) Open our website: hxxp://aplebzu47wgazapdqks6vrcv6zcnjppkbxbr6wketf56nf6aq2nmyoyd[.]onion/{UID}\n\n2) If TOR blocked in your country, try to use VPN! But you can use our secondary website. For this:\na) Open your any browser (Chrome, Firefox, Opera, IE, Edge)\nb) Open our secondary website: hxxp://decryptor[.]cc/{UID}\n\nWarning: secondary website can be blocked, thats why first variant much better and more available.\n\nWhen you open our website, put the following data in the input form:\nKey:\n\n{KEY}\n\nExtension name:\n\n{EXT}\n\n----------------------------------------------------------------------------------------\n!!! DANGER !!!\nDONT try to change files by yourself, DONT use any third party software for restoring your data or antivirus solutions - its may entail damge of\nthe private key and, as result, The Loss all data.\n!!! !!! !!!\n\n\n-----\n\nON O : ts you te ests to get you es bac . o ou s de, we (t e best spec a sts) a e eve yt g o esto g, but p ease\nshould not interfere.\n!!! !!! !!!\n\nREvil fills this template with a file extension (EXT), a user identifier (UID) and a key (KEY):\n\nThe extension is generated randomly from alphanumeric characters and is between 5 and 10 characters in length.\nThe user identifier is a hardware ID generated from the main volume’s serial number and the system’s CPU information. This ID is\ncalculated as follows:\n\nRetrieve the main volume 32-bit serial number.\nGenerate a CRC32 checksum of the volume serial with a seed value equal to 1337.\nRetrieve central processing unit (CPU) information i.e., “Intel(R) Core(TM) i7-6700HQ CPU @ 2.60GHz.”\nGenerate a CRC32 checksum of the CPU information string with the volume serial CRC32 hash as a seed value.\nConcatenate the CPU information CRC32 hash with the volume serial number into a 16-byte hexadecimal string i.e.,\n8100F233BC097E90.\n\nThe key submitted by the victim to the operator through the website is a JSON string:\n```\n{ \"ver\":\"%d\", # REvil's version: hard coded to 0x200 (v2.00). \"pid\":\"%s\", # The \"pid\" field in the configuration.\n\"sub\":\"%s\", # The \"sub\" field in the configuration. \"pk\":\"%s\", # The public key \"pk\" field in the configuration.\n\"uid\":\"%s\", # The hardware ID. \"sk\":\"%s\", # The victim's generated secret key encrypted with the \"pk\" public key.\nThis key is necessary for decryption. \"unm\":\"%s\", # The username of the Windows account. \"net\":\"%s\", # The computer\nname. \"grp\":\"%s\", # The domain name. \"lng\":\"%s\", # Language i.e., \"fr-FR\". \"bro\":%s, # \"true\" or \"false\". Is immune\nto infection, whitelisted language and keyboard layout. \"os\":\"%s\", # Windows product name. \"bit\":%d, # CPU\narchitecture: 86 or 64. \"dsk\":\"%s\", # A base64 encoded structure with information on the mounted volumes. \"ext\":\"%s\"\n# The encrypted files extension i.e., \".g19b9wy\" }\n\n```\nThis is encrypted with a hard-coded public key in the binary code before it is stored in the registry and the template. It also is communicated to\nthe controllers later in execution. See the Encryption section below for information on how REvil encrypts data.\n\nNext, REvil checks the configuration field dbg to see if it’s running in debug mode. If that is not the case, geolocation checks based on the\nsystem’s language and the keyboard layout are conducted so the ransomware does not attempt to encrypt files on whitelisted systems. The\nfollowing are whitelisted system language IDs for the analyzed sample:\n\n## The whitelisted keyboard layouts include:\n\nRomanian\nRussian\nUkrainian\nBelarusian\nEstonian\nLatvian\nLithuanian\nTajik\nPersian\nArmenian\nAzerbaijani\nGeorgian\nKazakh\nKyrgyz\nTurkmen\nUzbek\nTatar\n\nFor the check to succeed and REvil to exit, both a whitelisted system language and a whitelisted keyboard layout must be present. Otherwise,\nthe ransomware continues its execution normally.\n\nAt this stage, REvil performs the following actions before starting the encryption. First, it will try to stop and delete services if the names match\none of the regular expressions in the svc JSON configuration list, for example:\n\n\n-----\n\n```\n    g g [,, q,,,, p, g, p,\n\"vss\", \"sql\", \"backup\", \"qb\", \"sophos\", \"sage\" ]\n\n```\nThen it will terminate all processes with names that match the elements of the prc JSON array, for instance:\n```\n<strong>\"prc\":</strong>[ \"w3wp\", \"thunderbird\", \"mydesktopqos\", \"powerpnt\", \"outlook\", \"srv\", \"infopath\",\n\"msaccess\", \"ocautoupds\" ]\n\n```\nFinally REvil will delete the volume shadow copies. The way this is accomplished depends on the Windows version:\n\nWindows versions 5.1 and earlier:\n```\ncmd.exe /c vssadmin.exe Delete Shadows /All /Quiet & bcdedit /set {default} recoveryenabled No & bcdedit /set\n{default} bootstatuspolicy ignoreallfailures\n\n```\nWindows versions 5.2 and later, under PowerShell:\n```\nGet-WmiObject Win32_Shadowcopy | ForEach-Object {$_.Delete();}\n\n```\n\nAt this stage, REvil enters the file encryption phase. It is possible to run REvil with command-line arguments that will impact how encryption\nis carried out. The following table describes these arguments:\n\n**Argument** **Description**\n\n-full Encrypts all the data in the target files.\n\n-fast Only encrypts the first MB of each file. Mutually exclusive with the -full argument.\n\n-path Recursively encrypts the files inside a single directory specified after the argument. The desktop background image remains\nunchanged when this argument is supplied.\n\n-nolan Does not encrypt files on shared network storage.\n\n-nolocal Does not encrypt files on local storage.\n\nTwo values that the et configuration field can take are equivalent to the command-line arguments -full and -fast. Additionally, the presence of\none of these command-line arguments overrides the value of this field. Below are the values this field can take with a description of each value:\n\n\n**Encryption type**\n**values**\n\n\n**Description**\n\n\n0 Equivalent to the command-line argument -full\n\n1 Equivalent to the command-line argument -fast\n\n2 Encrypts 1 MB then skips the number of MBs supplied in the spsize field repeatedly, until the end of the file is\nreached.\n\nBefore encrypting a file or directory, REvil determines whether its name matches any entry in the whitelist configuration entries. The\nwhitelisted folders, files and extensions are lists stored in the wht JSON configuration field as fld, fls and ext.\n\nREvil ransomware also avoids encrypting a file more than once by determining if it previously was encrypted. This is achieved by examining\nwhether the metadata it stores at the end of encrypted files exists.\n\nTo encrypt the files, REvil relies on multithreading and input/output (I/O) completion ports, allowing it to perform asynchronous I/O and\nprocess multiple files simultaneously.\n\nEach file is encrypted with a different key derived from a single public key linked to the victim. See the Encryption section below for details on\nhow REvil implements file encryption.\n\nAfter the encryption is complete, REvil generates a bitmap image and sets it as the desktop background.\n\nAfterward, REvil ransomware reads the Boolean configuration field net to determine whether it\nshould communicate with its controllers. See the Communications section below for more\ndetails.\n\nFinally, REvil ransomware marks its binary code for deletion during the next reboot and\nterminates execution.\n\n**Configuration**\n\nThe table below describes each field of the REvil JSON configuration:\n\n\n-----\n\n**Argument** **Description**\n\npk The attacker’s public key encoded in base64.\n\npid The affiliate ID. In v2.0 and earlier, this was an integer. From 2.1 it became a Bcrypt hash.\n\nsub An integer value. The campaign identifier.\n\ndbg Boolean value that determines if REvil should run in debug mode.\n\net An integer value specifying the encryption type.- 0: Fast encryption. - 1: Full encryption. - 2: Encrypt 1 MB then skip the number\nof MBs specified by the spsize field.\n\nspsize Specifies the number of MBs to skip when the encryption type is 2.\n\nwipe A Boolean value that indicates whether REvil should wipe folders specified in the wfld element. We have not seen this option\nimplemented in the analyzed samples.\n\nwfld The folders to be wiped by REvil.\n\nwht Contains three lists of elements that REvil will not encrypt: - fld: Whitelisted folders. - fls: Whitelisted files. - ext: Whitelisted\nextensions.\n\nprc A list of regular expressions that REvil matches against processes to terminate them.\n\nnet If this Boolean value is set to true, REvil communicates with its controllers.\n\ndmn A string of controllers separated by a semicolon.\n\nsvc A list of regular expressions to match against running services to stop and delete them.\n\nnbody The template of the ransom note encoded in base64.\n\nnname The file name of the ransom note to be dropped inside encrypted directories.\n\nexp Indicates if REvil should exploit the CVE-2018-8453 vulnerability to escalate privileges.\n\nimg The text to be written in the background image encoded in base64.\n\narn When set to true, REvil persists in the system.\n\nThe registry values that REvil creates are described below:\n\n**Value name** **Description**\n\n1TfXk Victim’s secret key encrypted with the attacker’s public key present in the configuration.\n\n2YEdLY Victim’s secret key encrypted with a master public key hard coded in the binary code.\n\naah The attacker’s public key.\n\nfdle The victim’s public key.\n\nAaZW1s3 The extension appended to files after encryption.\n\nQaUXNv2P The victim’s key encrypted with a second hard-coded public key in the binary code.\n\n**Encryption**\n\nREvil ransomware implements encryption schemes involving an elliptic curve called Curve25519, Salsa20, SHA-3, CRC32 and Advanced\nEncryption Standard (AES). We identified the specific open-source implementations utilized by REvil:\n\nCurve25519: [https://github.com/vstakhov/opt-cryptobox/tree/master/curve25519 .](https://github.com/vstakhov/opt-cryptobox/tree/master/curve25519)\nSalsa20: [https://cr.yp.to/snuffle/salsa20/merged/salsa20.c .](https://cr.yp.to/snuffle/salsa20/merged/salsa20.c)\n\nThis subsection delves into the details of how these algorithms are used to encrypt data and files.\n\n**Encryption keys**\n\nREvil ransomware relies on Curve25519 to generate public and secret key pairs and to create shared keys for encryption. What follows defines\nthe Curve25519 keys referred to throughout this subsection:\n\n**Key-pair name** **Description**\n\ncrypt (crypt_public/crypt_secret) The victim’s main key pair used for file encryption.\n\nfile (file public / file secret) A random key pair generated for each encrypted file\n\n\n-----\n\nattacker (attacker_public /\nattacker_secret)\n\nmaster (master_public /\nmaster_secret)\n\nuser_config (user_config_public /\nuser_config_secret)\n\n**Data encryption**\n\n\nThe attacker’s key pair. attacker_public is present under the pk configuration field.\n\nThe master key pair. master_public is hard coded inside the binary code and is the same across all\nREvil samples.\n\nThe user configuration key pair. user_config_public is hard coded in the binary code and is used to\nencrypt the user key we find encrypted in the ransom note.\n\n\nREvil ransomware encrypts all important data it stores in the registry. For instance, the user key present in the ransom note and in the registry\nis a JSON dictionary encrypted using the method we describe in the paragraphs that follow.\n\nTo encrypt a buffer, REvil invokes the following function:\n```\nBYTE* rvl_encrypt_data(BYTE *hispublic, BYTE *buffer, int buffer_length, BYTE *out_buffer_length)\n\n```\n\nThis function requires a 32-byte Curve25519 public key, a buffer to encrypt and its length. The end result is a pointer to the buffer in the return\nvalue and its length in the output parameter out_buffer_length.\n\nInternally, this function performs the following actions:\n\nAllocate buffer_length bytes plus an extra 56 bytes to hold the final data.\nZero out the first 4 bytes of the allocated buffer.\nCopy the buffer to encrypt after the zeroed double word.\nGenerate a new Curve25519 key pair we call new_public and new_secret.\nCalculate a Curve25519 shared key between the hispublic key supplied in the arguments and the new_secret. The recipient of the message\ncan use the secret key and new_public to obtain the same shared key.\nHash the shared key using the SHA-3 algorithm.\nClear the shared key from memory.\nClear new_secret from memory.\nGenerate a random 128-bit AES initialization vector.\nEncrypt the buffer using AES with the SHA-3 hash as a key. The buffer to encrypt includes the prepended 32-bit NULL value.\nClear the SHA-3 hash from memory.\nCalculate the CRC32 of the encrypted buffer.\nAppend the following elements to the encrypted buffer in this order:\n\nThe generated new_public key (32 bytes).\nThe initialization vector (16 bytes).\nCRC32 of the encrypted buffer (4 bytes).\n\nThe end result looks like:\n\nAs an example, after decoding the user key present in the ransom note using base64, we see it\nrespects this same format:\n\nIn order for the attackers to decrypt this data and retrieve the JSON dictionary and as a result the\nencrypted victim’s crypt_secret key, they must do the following:\n\nVerify the CRC32 hash of the encrypted data.\nCalculate a Curve25519 shared key using the new_public key in the data and the attacker’s\nsecret user_config_secret.\nHash the shared key using SHA-3.\nRetrieve the AES initialization vector and decrypt the buffer using AES.\nRemove the NULL double word at the start of the buffer.\n\nIt is important to mention the victim’s crypt_secret key is encrypted the same way using the attacker’s attacker_public key (registry value\n“1TfXk”) and the master_public key (registry value “2YEdLY”).\n\n**File encryption**\n\nREvil ransomware encryption works by encrypting the files in 1 MB increments unless the file size is smaller, the remaining bytes to encrypt\nare less than 1 MB or when the encryption type specified is not full encryption. Contents of the file are read, encrypted and written back to the\nfile overwriting the original content. After the encryption is complete, metadata is written to the end of file and the file is renamed to include\nthe generated file extension (registry value AaZW1s3).\n\nFor each given file, REvil ransomware starts encryption by initializing a structure used throughout the process. Its first part includes the\nWindows OVERLAPPED structure used for asynchronous I/O followed by custom fields REvil uses. The most interesting part of this\nstructure was reverse engineered to the following:\n\n\n-----\n\n```\n    g yp g g g yp { pp ;\n<em>/*..SNIP..*/</em> <strong>struct</strong> _rvl_metadata { BYTE crypt_secret_w_attacker_pub[88]; <em>// same as\nregistry value \"1TfXk\".</em> BYTE crypt_secret_w_master_pub[88]; <em>// same as registry value \"2YEdLY\".</em> BYTE\nfile_public[32]; <em>// The file_public key.</em> BYTE salsa20_iv[8]; <em>// salsa20 initialization vector.</em>\nDWORD crc32_file_public; <em>// CRC32 hash of file_public.</em> DWORD et; <em>// The encryption type.</em> DWORD\nspsize; <em>// spsize field if applicable.</em> DWORD encrypted_null; <em>// A NULL value encrypted with salsa20.\n</em> } metadata; <em>/*..SNIP..*/</em> } rvl_filecrypt_struct, *prvl_filecrypt_struct;\n\n```\nThis metadata substructure is appended to the end of every encrypted file, is used by the decrypter and by REvil to verify a file previously was\nencrypted.\n\nThe Salsa20 symmetric encryption key is the SHA-3 hash of a shared key derived from the victim’s crypt_public key and the secret of a\ngenerated key pair: file_secret.\n\nTo decrypt a file, both the victim’s crypt_secret key and the file_public key must be known:\n\nIt is possible to decrypt the crypt_secret knowing either the operators’ attacker_secret or master_secret keys and by applying the same\nlogic described in the Data encryption subsection.\nIt is possible to retrieve the per file file_public key from the end of an encrypted file after validating its CRC32 hash.\nHaving attained both a public and a secret key from previous steps, generate a shared Curve25519 key and hash it using SHA-3.\nCopy the value of the Salsa20 initialization vector from the metadata structure at the end of the file.\nTest decrypting the encrypted NULL double word with the SHA-3 hash as a key.\nDetermine the encryption type used to perform correct decryption of the file, then start decrypting accordingly.\n\nBy following this scheme, the attackers are sure not to divulge their secret keys when sending\ndecrypters to victims. On their side, attackers only have to decrypt the victim’s crypt_secret key\nand send back a decrypter embedding this key.\n\n**Persistence mechanism**\n\nPrior to version 2.1, REvil ransomware persists on the machine if the arn configuration field is set to true. It writes its path to the registry key\n**SOFTWARE for persistence. The value name of the entry for the analyzed sample is k51299BQXH.**\n\nBefore terminating execution, REvil marks its executable file for deletion during the next reboot. As a result, the persistence path will become\ninvalid.\n\nThe persistence mechanism was removed from REvil version 2.1.\n\n## Protections\n\nREvil ransomware does not implement any protections.\n\n## Communications\n\nREvil ransomware only initiates communication with its controllers when the configuration field net is set to true. In that case, REvil extracts\nthe controller list from the dmn configuration string and proceeds to build a custom URL in a loop for each controller before initiating\ncommunications.\n\nEach controller is preceded by the string https://, followed by a random path chosen from hard-coded values and then terminated by a\nrandom file name. The regular expression below matches all random URL paths generated by REvil ransomware:\n```\n\\/(wpcontent|static|content|include|uploads|news|data|admin)\\/(images|pictures|image|temp|tmp|graphic|assets|pics|game)\\/([az]{2}){1,10}\\.(jpg|png|gif)\n\n```\nREvil then proceeds to send a POST request containing the victim’s key stored in the registry value QaUXNv2P to the controllers. Afterward,\nthe controller response is read into a buffer that subsequently is ignored and freed.\n\n## Appendix\n\n**Appendix 1: REvil configuration**\n\nExample of a REvil configuration. We redacted most of the controllers for readability:\n```\n{ \"pk\":\"YO9E7ouT83RseZgGnLR2DxiFRbXiteYQirOJcZOjplo=\",\n\"pid\":\"$2a$10$7qQ70syLvX5aslSuSa9AWurg843zRR.433XEtfk2rGURjN9e.xNz6\", \"sub\":\"3195\", \"dbg\":<strong>false</strong>,\n\"et\":1, \"wipe\":<strong>false</strong>, \"wht\":{ \"fld\":[ \"programdata\", \"perflogs\", \"application data\", \"appdata\",\n\"$windows.~bt\", \"system volume information\", \"windows\", \"tor browser\", \"google\", \"msocache\", \"boot\", \"windows.old\",\n\n```\n\n-----\n\n```\n       ,, ], [,,,,\n\"bootsect.bak\", \"desktop.ini\", \"thumbs.db\", \"ntuser.ini\", \"ntuser.dat.log\", \"ntldr\", \"bootfont.bin\" ], \"ext\":[ \"msp\",\n\"rom\", \"rtp\", \"shs\", \"mod\", \"cur\", \"msc\", \"nomedia\", \"deskthemepack\", \"diagcab\", \"diagcfg\", \"msstyles\", \"scr\", \"hta\",\n\"idx\", \"ics\", \"lock\", \"diagpkg\", \"icns\", \"msi\", \"themepack\", \"key\", \"bin\", \"theme\", \"bat\", \"cab\", \"nls\", \"spl\",\n\"icl\", \"sys\", \"drv\", \"lnk\", \"cmd\", \"adv\", \"cpl\", \"ico\", \"com\", \"exe\", \"ocx\", \"dll\", \"hlp\", \"mpa\", \"prf\", \"wpx\",\n\"ani\", \"msu\", \"ps1\", \"386\" ] }, \"wfld\":[ \"backup\" ], \"prc\":[ \"w3wp\", \"thunderbird\", \"mydesktopqos\", \"powerpnt\",\n\"outlook\", \"srv\", \"infopath\", \"msaccess\", \"ocautoupds\", \"qb\", \"core\", \"mspub\", \"store\", \"ssms\", \"dbeng50\", \"ax32\",\n\"sql\", \"exchange\", \"onenote\", \"ocssd\", \"sage\", \"pos\", \"word\", \"java\", \"sophos\", \"xfssvccon\", \"visio\", \"synctime\",\n\"oracle\", \"crm\", \"excel\", \"dbs\", \"ocomm\", \"svc$\" ],\n\"dmn\":\"sweering[.]fr;shiresresidential[.]com;bogdanpeptine[.]ro;ruralarcoiris[.]com;echtveilig[.]nl\", \"net\":\n<strong>false</strong>, \"svc\":[ \"memtas\", \"crm\", \"quickbooks\", \"svc$\", \"veeam\", \"oracle\", \"mepocs\", \"exchange\",\n\"pos\", \"vss\", \"sql\", \"backup\", \"qb\", \"sophos\", \"sage\" ],\n\"nbody\":\"LQAtAC0APQA9AD0AIABXAGUAbABjAG8AbQBlAC4AIABBAGcAYQBpAG4ALgAgAD0APQA9AC0ALQAtAA0ACgANAAoAWwArAF0AIABXAGgAYQB0AHM\n\"nname\":\"{EXT}-readme.txt\", \"exp\":<strong>false</strong>,\n\"img\":\"QQBsAGwAIABvAGYAIAB5AG8AdQByACAAZgBpAGwAZQBzACAAYQByAGUAIABlAG4AYwByAHkAcAB0AGUAZAAhAA0ACgANAAoARgBpAG4AZAAgAHsAR\n\"arn\":<strong>false</strong> }\n\n## Anti-virus (AV) classifications\n\n```\n**AV** **Alias**\n\nALYac Trojan.Ransom.Sodinokibi\n\nIkarus Trojan-Ransom.Sodinokibi\n\nClamAV Win.Ransomware.Sodinokibi\n\nESET-NOD32 Win32/Filecoder.Sodinokibi\n\nFortinet W32/Sodinokibi.B!tr.ransom\n\nMalwarebytes Ransom.Sodinokibi\n\nMicrosoft Ransom:Win32/Sodinokibi\n\nRising Ransom.Sodin\n\nTrendMicro HouseCall Win32.SODINOKIB.SMTH\n\nViRobot Trojan.Win32.Z.Sodinokibi\n\nWebroot W32.Ransom.Sodinokibi\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-04-01 - REvil Ransomware-as-a-Service An analysis of a ransomware affiliate operation.pdf"
    ],
    "report_names": [
        "2020-04-01 - REvil Ransomware-as-a-Service An analysis of a ransomware affiliate operation.pdf"
    ],
    "threat_actors": [
        {
            "id": "67fbc7d7-ba8e-4258-b53c-9a5d755e1960",
            "created_at": "2022-10-25T16:07:24.077859Z",
            "updated_at": "2025-03-27T02:02:10.101173Z",
            "deleted_at": null,
            "main_name": "Promethium",
            "aliases": [
                "APT-C-41",
                "Promethium",
                "StrongPity"
            ],
            "source_name": "ETDA:Promethium",
            "tools": [
                "StrongPity",
                "StrongPity2",
                "StrongPity3",
                "Truvasys"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536191,
    "ts_updated_at": 1743041161,
    "ts_creation_date": 1653480492,
    "ts_modification_date": 1653480492,
    "files": {
        "pdf": "https://archive.orkl.eu/129672c3a8b9cbe07e1519ccdfee5ba3c8f4b66d.pdf",
        "text": "https://archive.orkl.eu/129672c3a8b9cbe07e1519ccdfee5ba3c8f4b66d.txt",
        "img": "https://archive.orkl.eu/129672c3a8b9cbe07e1519ccdfee5ba3c8f4b66d.jpg"
    }
}