{
    "id": "da4a8e9e-1718-4088-916a-af0a91f2d045",
    "created_at": "2023-01-12T15:06:36.288489Z",
    "updated_at": "2025-03-27T02:05:36.352014Z",
    "deleted_at": null,
    "sha1_hash": "70f7fb52354a25112db626abdb2d0b0611e6b96b",
    "title": "2017-11-05 - Let's Learn- Lethic Spambot & Survey of Anti-Analysis Techniques",
    "authors": "",
    "file_creation_date": "2022-05-28T04:12:16Z",
    "file_modification_date": "2022-05-28T04:12:16Z",
    "file_size": 1278300,
    "plain_text": "# Let's Learn: Lethic Spambot & Survey of Anti-Analysis Techniques\n\n**[vkremez.com/2017/11/lets-learn-lethic-spambot-survey-of.html](http://www.vkremez.com/2017/11/lets-learn-lethic-spambot-survey-of.html)**\n\n**[Goal: Reverse the latest Lethic spambot, shared by Brad from Malware Traffic Analysis with](http://www.malware-traffic-analysis.net/2017/11/02/index.html)**\nthe focus on its plethora of various anti-analysis and anti-virtual machine checks.\n\n**Source:**\n\nLethic original spambot\n[(e324c63717a4c2011fde7d1af0d8dbe8ddb0897fe4e7f80f3147a7498e2166fe)](https://www.virustotal.com/#/file/e324c63717a4c2011fde7d1af0d8dbe8ddb0897fe4e7f80f3147a7498e2166fe/detection)\n\n**Background**\n\n[While analyzing the Lethic spambot (thanks to @malware_traffic), unpacked and reviewed](https://twitter.com/malware_traffic/status/926235399500062721)\nsome of the bot internals. By and large, the spambot leverages process injection into\nexplorer.exe through usual WriteProcessMemory and CreateRemoteThread. This Lethic\nhardcoded call back IP is 93[.]190[.]139[.]16. Another unique feature of this Trojan is\npersistency in C:\\RECYCLER\\* as “backwindow32.exe” and usual registry RUN keys.\n\n\n-----\n\n**Malware checks:**\nI. Wine check\nII. Anti-analysis process check\nIII. Anti-analysis DLL check\nIV. UserName check\nV. Path string check\nVI. Virtual Machine (VM) process check\nVII. VM registry and VM CreateFile check\nVIII. Anti-sleep bypass check\nIX. Anti-debugger check\n\n**I. Wine check**\nThe Lethic spambot checks for the presence of Wine on the victim machine as follows\nchecking the ntdll and kernel32 DLL's for the following functions via GetProcAddress API:\n\nwine_get_version\nwine_get_unix_file_name\n\nA.   wine_get_version\n\n\n-----\n\nThe pseudo-coded C++ function is as follows:\n\n_signed int anti_wine_get_version()_\n\n_{_\n\n_HMODULE hModule;_\n\n_signed int v2;_\n\n_v2 = 0;_\n\n_hModule = GetModuleHandleA(\"ntdll.dll\");_\n\n\n-----\n\n_if ( hModule && GetProcAddress(hModule, wine_get_version ) )_\n\n_v2 = 1;_\n\n_return v2;_\n\n_}_\nB.   wine_get_unix_file_name\n\nThe pseudo-coded C++ function is as follows:\n_signed int wine_get_unix_file_name()_\n\n_{_\n\n_HMODULE hModule;_\n\n_signed int v2;_\n\n_v2 = 0;_\n\n_hModule = GetModuleHandleA(\"kernel32.dll\");_\n\n_if ( hModule && GetProcAddress(hModule, \"wine_get_unix_file_name\") )_\n\n_v2 = 1;_\n\n_return v2;_\n\n_}_\n**II. Anti-analysis process check**\n\n\n-----\n\nThe Trojan checks for the following processes and suspends threads if they exist on the\nhost:\n\nregmon.exe\n\nfilemon.exe\n\nprocdump.exe\n\nprocexp.exe\n\nwireshark.exe\n\nprcview.exe\n\nsysinspector.exe\n\nsniff_hit.exe\n\nproc_watch.exe\n\napimonitor exe\n\n\n-----\n\ntcpview.exe\n\npetools.exe\n\nvmtoolsd.exe\n\nautoruns.exe\nThe suspend thread function is as follows:\n\n_HANDLE __cdecl suspend_thread_function (int a1)_\n\n_{_\n\n_HANDLE result;_\n\n_HANDLE hThread;_\n\n_THREADENTRY32 te;_\n\n_HANDLE hSnapshot;_\n\n_te.dwSize = 0;_\n\n_te.cntUsage = 0;_\n\n_te.th32ThreadID = 0;_\n\n_te.th32OwnerProcessID = 0;_\n\n_te.tpBasePri = 0;_\n\n_te.tpDeltaPri = 0;_\n\n_te.dwFlags = 0;_\n\n_result = CreateToolhelp32Snapshot(4u, 0);_\n\n_hSnapshot = result;_\n\n_if ( result != (HANDLE)-1 )_\n\n_{_\n\n_te.dwSize = 28;_\n\n_if ( Thread32First(hSnapshot, &te) )_\n\n_{_\n\n\n-----\n\n_do_\n\n_{_\n\n_if ( te.th32OwnerProcessID == a1 )_\n\n_{_\n\n_hThread = OpenThread(2u, 0, te.th32ThreadID);_\n\n_SuspendThread(hThread);_\n\n_CloseHandle(hThread);_\n\n_}_\n\n_}_\n\n_while ( Thread32Next(hSnapshot, &te) );_\n\n_}_\n\n_result = (HANDLE)CloseHandle(hSnapshot);_\n\n_}_\n\n_return result;_\n\n_}_\n**III. Anti-analysis DLL check**\nThe malware checks for the presence of loaded DLL’s.\n\n\n-----\n\nThe list of all checked DLL is as follows:\napi_log.dll\n\nlog_api32.dll\n\ndir_watch.dll\n\npstorec.dll\n\nvmcheck.dll\n\nwpespy.dll\n\nsnxhk.dll\n**IV. UserName check**\nThe malware checks for specific host usernames via retrieving them with GetUserName API\nand converting them to upper case.\n\n\n-----\n\nThe list of the checked usernames is as follows:\n\nMALTEST\n\nTEQUILABOOMBOOM\n\nSANDBOX\n\nVIRUS\n\nMALWARE\n**V. Path string check**\nThe malware checks for specific path strings aliases via retrieving them with\nGetModuleFileName API and converting them to upper case.\n\n\n-----\n\nThe list of the checked path strings is as follows:\nSAMPLE\n\nMALWARE\n\nSANDBOX\n\nVIRUS\nThe malware also checks if it is named “sample.”\n\n**VI. Virtual Machine (VM) process check**\n\n\n-----\n\nLethic checks for the presence of the VM-related processes.\n\nThe full list of all checked processes is as follows:\nvmusrvc.exe\n\nvmsrvc.exe\n\nxsvc_depriv.exe\n\nxenservice.exe\n**VII. VM registry keys check**\nThe malware checks for the registry artefacts associated with VM.\n\nThe following registry locations and values are checked:\nA. HKLM\\HARDWARE\\DEVICEMAP\\Scsi\\Scsi Port 0\\Scsi Bus 0\\Target Id 0\\Logical Unit Id\n0\\Identifier\n\nVMWARE\nQEMU\n\nB. HKLM\\HARDWARE\\Description\\System\\SystemBiosVersion\n\nVBOX\nQEMU\n\n\n-----\n\nC. HKLM\\HARDWARE\\Description\\System\\VideoBiosVersion\n\nVIRTUALBOX\nBOCHS\n\nD. HKLM\\SOFTWARE\\Oracle\\VirtualBox Guest Additions\n\nE. The malware tries to create a file “\\\\\\\\.\\\\VBoxGuest” and checks if it exists.\n\n\n-----\n\nThe C++ pseudocode is as follows:\n\n_signed int vm_createfile_check()_\n\n_{_\n\n_signed int v1;_\n\n_HANDLE hObject;_\n\n_v1 = 0;_\n\n_hObject = CreateFileW(L\"\\\\\\\\.\\\\VBoxGuest\", 1u, 1u, 0, 4u, 0, 0);_\n\n_if ( hObject != (HANDLE)-1 )_\n\n_{_\n\n_CloseHandle(hObject);_\n\n_v1 = 1;_\n\n_}_\n\n_return v1;_\n\n_}_\n**VIII. Anti-sleep bypass check**\nThe malware implements Sleep API patch/hook check preventing the analyst from\npatching/hooking Sleep to a return.\n\n\n-----\n\nThe routine is as follows:\n\n_signed int anti_sleep_hook_check()_\n\n_{_\n\n_DWORD v0;_\n\n_signed int v2;_\n\n_v2 = 1;_\n\n_v0 = GetTickCount();_\n\n_Sleep(500);_\n\n\n-----\n\n_if ( GetTickCount() - v0 <= 440 )_\n\n_Sleep(0);_\n\n_else_\n\n_v2 = 0;_\n\n_return v2;_\n\n_}_\n**IX. Anti-debugger check**\nThe malware calls IsDebuggerPresent and CheckRemoteDebuggerPresent APIs to check\nfor the debugger presence.\n\nThe function in C++ is as follows:\n\n\n-----\n\n_int anti_debugger_check()_\n\n_{_\n\n_BOOL pbDebuggerPresent;_\n\n_int v2;_\n\n_pbDebuggerPresent = 0;_\n\n_v2 = 0;_\n\n_if ( IsDebuggerPresent() || CheckRemoteDebuggerPresent((HANDLE)0xFFFFFFFF,_\n_&pbDebuggerPresent) && pbDebuggerPresent )_\n\n_v2 = 1;_\n\n_return v2;_\n\n_}_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-11-05 - Let's Learn- Lethic Spambot & Survey of Anti-Analysis Techniques.pdf"
    ],
    "report_names": [
        "2017-11-05 - Let's Learn- Lethic Spambot & Survey of Anti-Analysis Techniques.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535996,
    "ts_updated_at": 1743041136,
    "ts_creation_date": 1653711136,
    "ts_modification_date": 1653711136,
    "files": {
        "pdf": "https://archive.orkl.eu/70f7fb52354a25112db626abdb2d0b0611e6b96b.pdf",
        "text": "https://archive.orkl.eu/70f7fb52354a25112db626abdb2d0b0611e6b96b.txt",
        "img": "https://archive.orkl.eu/70f7fb52354a25112db626abdb2d0b0611e6b96b.jpg"
    }
}