{
    "id": "04ce3e3f-da42-4a65-8223-68e0b8e5919a",
    "created_at": "2023-01-12T15:06:16.461508Z",
    "updated_at": "2025-03-27T02:17:02.269179Z",
    "deleted_at": null,
    "sha1_hash": "23c75188146e109ca9f7eb31607643a3a6f32079",
    "title": "2017-01-26 - Malware ChChes interacts with C & C server using Cookie header",
    "authors": "",
    "file_creation_date": "2022-05-28T16:50:16Z",
    "file_modification_date": "2022-05-28T16:50:16Z",
    "file_size": 1134459,
    "plain_text": "# Cookieヘッダーを用いてC&Cサーバとやりとりするマルウ エアChChes(2017-01-26)\n\n**jpcert.or.jp/magazine/acreport-ChChes.html**\n\n[JPCERT/CC](https://blogs.jpcert.or.jp/ja/retiree_blog/)\n\n2017/01/26\n\n[ChChes](https://blogs.jpcert.or.jp/ja/tags/chches/)\n\n[メール](http://10.10.0.46/mailto:?subject=Cookie%E3%83%98%E3%83%83%E3%83%80%E3%83%BC%E3%82%92%E7%94%A8%E3%81%84%E3%81%A6C%26C%E3%82%B5%E3%83%BC%E3%83%90%E3%81%A8%E3%82%84%E3%82%8A%E3%81%A8%E3%82%8A%E3%81%99%E3%82%8B%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A8%E3%82%A2ChChes%282017-01-26%29&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fja%2F2017%2F01%2Fchches.html)\n\n\n-----\n\nJPCERT/CCでは、2016年10月頃から国内の組織に対して、実行ファイルを含むZIPファイ\nルを添付した標的型メールが送信されていることを確認しています。標的型メールは、実在\nの人物を騙り、国内のフリーメールアドレスから送信されています。また、実行ファイルは\nWord文書にアイコン偽装されており、これを実行するとChChesと呼ばれるマルウエアに感\n染します。\n\n今回はChChesの通信内容の特徴などについて紹介します。\n\n標的型メールに添付されているZIPファイル\n\n標的型メールに添付されているZIPファイルには、実行ファイルのみが含まれる場合と、加\nえてダミーのWord文書を同梱している場合があります。以下は、後者の例です。\n\n図 1：添付さ\n\nれているZIPファイルの例\n上記の事例では、類似したファイル名が2つ並び、片方はダミーのWord文書、もう片方は\nWord文書のアイコンに偽装した実行ファイルとなっており、この実行ファイルを実行する\nことでChChesに感染します。実行ファイルには特定のコードサイニング証明書により署名\n\n\n-----\n\nされている検体を複数確認しています。なお、ダミーのWord文書は無害なもので、ファイ\nル名に関連した実在するオンライン記事の内容が、Word文書化されています。コードサイ\nニング証明書の詳細はAppendix Aに記載しています。\n\n**ChChesの通信内容について**\n\nChChesは、特定のサイトとHTTPで通信を行い、コマンドおよびモジュールを受信するマ\nルウエアです。ChChesは、単体では実行できる機能はほとんどなく、C&Cサーバと通信す\nる中でモジュールを受信し、メモリ上に展開することで機能を拡張します。\n\n以下はChChesが送信するHTTP GETリクエストの例です。なお、GETではなくHEADが使\nわれる場合もあります。\n```\nGET /X4iBJjp/MtD1xyoJMQ.htm HTTP/1.1\nCookie: uHa5=kXFGd3JqQHMfnMbi9mFZAJHCGja0ZLs%3D;KQ=yt%2Fe～省略～\nAccept: */*\nAccept-Encoding: gzip, deflate\nUser-Agent: [ユーザエージェント]\nHost: [ホスト名]\nConnection: Keep-Alive\nCache-Control: no-cache\n\n```\n上記のように、HTTPリクエストのパスには/[ランダムな文字列].htmが使われますが、\nCookieフィールドの値はランダムではなく、C&Cサーバとのやりとりに使われるデータが\n暗号化された状態で含まれています。この値は、以下のPythonスクリプトで復号することが\nできます。\n```\ndata_list = cookie_data.split(';')\ndec = []\nfor i in range(len(data_list)):\n  tmp = data_list[i]\n  pos = tmp.find(\"=\")\n  key = tmp[0:pos]\n  val = tmp[pos:]\n  md5 = hashlib.md5()\n  md5.update(key)\n  rc4key = md5.hexdigest()[8:24]\n  rc4 = ARC4.new(rc4key)\n  dec.append(rc4.decrypt(val.decode(\"base64\"))[len(key):])\nprint(\"[*] decoded: \" + \"\".join(dec))\n\n```\n以下は、感染後に発生する通信の大まかな流れです。\n\n\n-----\n\n図 2：通信の流れ\n\n最初のリクエスト\n\nChChesが最初に送信するHTTPリクエスト（リクエスト1)のCookieフィールドの値に\nは'A'で始まるデータが暗号化された状態で含まれています。以下は、送信されるデータの例\nです。\n\n図 3：最初に送信\n\nされるデータの例\n図 3に示すように、送信されるデータにはコンピュータ名などの情報が含まれます。なお、\n暗号化されたデータのフォーマットはChChesのバージョンにより異なります。詳細につい\nてはAppendix Bに記載します。\n\n\n-----\n\nChChesは、リクエスト1のレスポンスとして、感染端末を識別するIDとなる文字列をC&C\nサーバから受信します（レスポンス1）。このとき、感染端末を識別するIDは以下のように\nSet-Cookieフィールドの値に含まれます。\n\n図 4：最初のリク\n\nエストに対するレスポンスの例\n\nモジュールおよびコマンドの要求\n\n次に、ChChes は、モジュールおよびコマンドを受信するためのHTTPリクエスト（リクエ\nスト2）を送信します。このとき、Cookieフィールドの値には'B'で始まる以下のデータが暗\n号化された状態で含まれています。\n```\nB[感染端末を識別するID]\n\n```\nリクエスト2のレスポンスとして、暗号化された状態のモジュールおよびコマンド（レスポ\nンス2）をC&Cサーバから受信します。以下は受信したモジュールおよびコマンドの復号後\nの例です。\n\n図 5：受信したモ\n\nジュールおよびコマンドの復号後のデータ\n上記のように、コマンドとモジュールが1つのデータとして受信する場合と、コマンドのみ\nを受信する場合があります。以降、受信したコマンドの実行結果がC&Cサーバに送信され、\n再びモジュールおよびコマンドを受信する処理に戻ります。このようにして、C&Cサーバか\nら繰り返し命令を受信することで、感染端末は外部からの遠隔操作を受けることになりま\nす。\n\n\n-----\n\nJPCERT/CCの調査では、これまでに、以下の機能を持ったモジュールの存在を確認してお\nり、これが実質的にはChChesのボット機能であると言えます。\n\nAESによる通信の暗号化\nシェルコマンドの実行\nファイルのアップロード\nファイルのダウンロード\nDLLのロードおよび実行\nボットコマンドのタスク一覧\n\n特に、AESによる通信の暗号化を行うモジュールは、感染後、比較的初期の段階で受信され\nることを確認しています。これにより、その後のC&Cサーバとのやりとりは、これまでの通\n信の暗号化に加えて、AESで暗号化されることになります。\n\nおわりに\n\nChChesは、2016年10月頃から確認されるようになった比較的新しい種類のマルウエアで\nす。今後も標的型攻撃で使われる可能性があるため、JPCERT/CCでは引き続き、ChChes\nとそれを利用した標的型攻撃に注目していきます。\n今回解説した検体のハッシュ値に関しては、Appendix Cに記載しています。また、これま\nでにJPCERT/CCで確認しているChChesの通信先Appendix Dに記載していますので、この\nような通信先にアクセスしている端末がないかご確認ください。\n\n分析センター 中村 祐\n\n**Appendix A コードサイニング証明書**\n\n検体に付加されているコードサイニング証明書の情報は以下の通りです。\n```\n$ openssl x509 -inform der -text -in mal.cer \nCertificate:\n  Data:\n    Version: 3 (0x2)\n    Serial Number:\n      3f:fc:eb:a8:3f:e0:0f:ef:97:f6:3c:d9:2e:77:eb:b9\n  Signature Algorithm: sha1WithRSAEncryption\n    Issuer: C=US, O=VeriSign, Inc., OU=VeriSign Trust Network, OU=Terms of use at\nhttps://www.verisign.com/rpa (c)10, CN=VeriSign Class 3 Code Signing 2010 CA\n    Validity\n      Not Before: Aug 5 00:00:00 2011 GMT\n      Not After : Aug 4 23:59:59 2012 GMT\n    Subject: C=IT, ST=Italy, L=Milan, O=HT Srl, OU=Digital ID Class 3 - Microsoft\nSoftware Validation v2, CN=HT Srl\n    Subject Public Key Info:\n\n```\n～省略～\n\n\n-----\n\n図 6：コードサイニン\n\nグ証明書\n**Appendix B ChChesのバージョン**\n\n以下は、これまでに確認しているChChesのバージョン番号と検体のPEヘッダから取得した\nコンパイルタイムをプロットしたものです。\n\n図 7：ChChesの\n\n各バージョンのコンパイルタイム\n以下は、ChChesのバージョン毎の最初のHTTPリクエストに含まれる暗号化されたデータ\nのフォーマットと各値の説明です。\n\n表 1: バージョン毎の送信フォーマッ\nト\n\nバージョン 送信フォーマット\n\n\n-----\n\n1.0.0 A<a>*<b>?3618468394?<c>?<d>*<f>\n\n1.2.2 A<a>*<b>?3618468394?<c>?<d>*<f>\n\n1.3.0 A<a>*<b>?3618468394?<c>?<d>*<f>\n\n1.3.2 A<a>*<b>?3618468394?<c>?<d>*<g>\n\n1.4.0 A<a>*<b>?3618468394?<c>?<d>*<g>\n\n1.4.1 A<a>*<b>?3618468394?<c>?<d> (<e>)*<g>\n\n1.6.4 A<a>*<b>*<h>?3618468394?<c>?<d> (<e>)*\n<g>\n\n表 2：～の説明\n\n記号 データ サイズ 備考\n\n<a> コンピュータ名 可変 英数大文字\n\n<b> プロセスID 可変\n\n<c> テンポラリフォルダのパス 可変 %TEMP%の値\n\n<d> マルウエアのバージョン 可変 例：1.4.1\n\n<e> 画面の解像度 可変 例：1024x768\n\n<f> explorer.exeのバージョン 可変 例：6.1.7601.17567\n\n<g> kernel32.dllのバージョン 可変 例：6.1.7601.17514\n\n<h> SIDのMD5値の一部 16バイト 例：0345cb0454ab14d7\n\n**Appendix C 検体のSHA-256ハッシュ値**\n\nChChes\n\n5961861d2b9f50d05055814e6bfd1c6291b30719f8a4d02d4cf80c2e87753fa1\nae6b45a92384f6e43672e617c53a44225e2944d66c1ffb074694526386074145\n2c71eb5c781daa43047fa6e3d85d51a061aa1dfa41feb338e0d4139a6dfd6910\n19aa5019f3c00211182b2a80dd9675721dac7cfb31d174436d3b8ec9f97d898b\n316e89d866d5c710530c2103f183d86c31e9a90d55e2ebc2dda94f112f3bdb6d\n\n\n-----\n\nefa0b414a831cbf724d1c67808b7483dec22a981ae670947793d114048f88057\ne90064884190b14a6621c18d1f9719a37b9e5f98506e28ff0636438e3282098b\n9a6692690c03ec33c758cb5648be1ed886ff039e6b72f1c43b23fbd9c342ce8c\nbc2f07066c624663b0a6f71cb965009d4d9b480213de51809cdc454ca55f1a91\ne6ecb146f469d243945ad8a5451ba1129c5b190f7d50c64580dbad4b8246f88e\ne88f5bf4be37e0dc90ba1a06a2d47faaeea9047fec07c17c2a76f9f7ab98acf0\nd26dae0d8e5c23ec35e8b9cf126cded45b8096fc07560ad1c06585357921eeed\n2965c1b6ab9d1601752cb4aa26d64a444b0a535b1a190a70d5ce935be3f91699\n312dc69dd6ea16842d6e58cd7fd98ba4d28eefeb4fd4c4d198fac4eee76f93c3\n4ff6a97d06e2e843755be8697f3324be36e1ebeb280bb45724962ce4b6710297\n45d804f35266b26bf63e3d616715fc593931e33aa07feba5ad6875609692efa2\ncb0c8681a407a76f8c0fd2512197aafad8120aa62e5c871c29d1fd2a102bc628\n75ef6ea0265d2629c920a6a1c0d1dd91d3c0eda86445c7d67ebb9b30e35a2a9f\n471b7edbd3b344d3e9f18fe61535de6077ea9fd8aa694221529a2ff86b06e856\nae0dd5df608f581bbc075a88c48eedeb7ac566ff750e0a1baa7718379941db86\n646f837a9a5efbbdde474411bb48977bff37abfefaa4d04f9fb2a05a23c6d543\n3d5e3648653d74e2274bb531d1724a03c2c9941fdf14b8881143f0e34fe50f03\n9fbd69da93fbe0e8f57df3161db0b932d01b6593da86222fabef2be31899156d\n723983883fc336cb575875e4e3ff0f19bcf05a2250a44fb7c2395e564ad35d48\nf45b183ef9404166173185b75f2f49f26b2e44b8b81c7caf6b1fc430f373b50b\n\n**Appendix D通信先一覧**\n\narea.wthelpdesk.com\ndick.ccfchrist.com\nkawasaki.cloud-maste.com\nkawasaki.unhamj.com\nsakai.unhamj.com\nscorpion.poulsenv.com\ntrout.belowto.com\nzebra.wthelpdesk.com\nhamiltion.catholicmmb.com\ngavin.ccfchrist.com\n\n[メール](http://10.10.0.46/mailto:?subject=Cookie%E3%83%98%E3%83%83%E3%83%80%E3%83%BC%E3%82%92%E7%94%A8%E3%81%84%E3%81%A6C%26C%E3%82%B5%E3%83%BC%E3%83%90%E3%81%A8%E3%82%84%E3%82%8A%E3%81%A8%E3%82%8A%E3%81%99%E3%82%8B%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A8%E3%82%A2ChChes%282017-01-26%29&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fja%2F2017%2F01%2Fchches.html)\n\nこの記事の筆者\n\n[JPCERT/CC](https://blogs.jpcert.or.jp/ja/retiree_blog/)\n\n\n-----\n\n記事に関するご意見・ご質問は、お問い合わせフォームにご記入ください。\n\nこのページは役に立ちましたか？\n\n0人が「このページが役に立った」と言っています。\n\nその他、ご意見・ご感想などございましたら、ご記入ください。\n\nこちらはご意見・ご感想用のフォームです。各社製品については、各社へお問い合わせくだ\nさい。\n\njavascriptを有効にすると、ご回答いただけます。 ありがとうございました。\n\n## 関連記事\n\nHUI Loaderの分析\n\nAnti-UPX Unpackingテクニック\n\nモバイル端末を狙うマルウェアへの対応FAQ\n\n\n-----\n\n攻撃グループLuoYuが使用するマルウェアWinDealer\n\n攻撃グループBlackTechが使用するマルウェアGh0stTimes\n\n≪ [前へ](https://blogs.jpcert.or.jp/ja/2017/01/plugx2.html)\n[トップに戻る](https://www.jpcert.or.jp/ja/)\n[次へ](https://blogs.jpcert.or.jp/ja/2017/02/chches_ps1.html) ≫\n\n\n-----",
    "language": "JA",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-01-26 - Malware ChChes interacts with C & C server using Cookie header.pdf"
    ],
    "report_names": [
        "2017-01-26 - Malware ChChes interacts with C & C server using Cookie header.pdf"
    ],
    "threat_actors": [
        {
            "id": "2646f776-792a-4498-967b-ec0d3498fdf1",
            "created_at": "2022-10-25T15:50:23.475784Z",
            "updated_at": "2025-03-27T02:00:55.479958Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Palmerworm"
            ],
            "source_name": "MITRE:BlackTech",
            "tools": [
                "Kivars",
                "PsExec",
                "TSCookie",
                "Flagpro",
                "Waterbear"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d3a7123c-f519-49a0-a234-de24a1ef052a",
            "created_at": "2022-10-25T16:47:55.545211Z",
            "updated_at": "2025-03-27T02:05:17.254744Z",
            "deleted_at": null,
            "main_name": "BRONZE CANAL",
            "aliases": [
                "CTG-6177 ",
                "Circuit Panda ",
                "Palmerworm ",
                "Shrouded Crossbow ",
                "BlackTech"
            ],
            "source_name": "Secureworks:BRONZE CANAL",
            "tools": [
                " DRIGO",
                " Flagpro",
                " Gh0stTimes",
                " PLEAD",
                " Spiderpig",
                " Waterbear",
                "Bifrose"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75024aad-424b-449a-b286-352fe9226bcb",
            "created_at": "2023-01-06T13:46:38.962724Z",
            "updated_at": "2025-03-27T02:00:02.964002Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "CIRCUIT PANDA",
                "Temp.Overboard",
                "G0098",
                "Red Djinn",
                "HUAPI",
                "Palmerworm",
                "T-APT-03",
                "Manga Taurus",
                "Earth Hundun"
            ],
            "source_name": "MISPGALAXY:BlackTech",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "efa7c047-b61c-4598-96d5-e00d01dec96b",
            "created_at": "2022-10-25T16:07:23.404442Z",
            "updated_at": "2025-03-27T02:02:09.781478Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Circuit Panda",
                "Earth Hundun",
                "Manga Taurus",
                "Operation PLEAD",
                "Operation Shrouded Crossbow",
                "Operation Waterbear",
                "Palmerworm",
                "Radio Panda",
                "Red Djinn",
                "T-APT-03",
                "TEMP.Overboard"
            ],
            "source_name": "ETDA:BlackTech",
            "tools": [
                "BIFROST",
                "BUSYICE",
                "BendyBear",
                "Bluether",
                "CAPGELD",
                "DRIGO",
                "Deuterbear",
                "Flagpro",
                "GOODTIMES",
                "Gh0stTimes",
                "IconDown",
                "KIVARS",
                "LOLBAS",
                "LOLBins",
                "Linopid",
                "Living off the Land",
                "TSCookie",
                "Waterbear",
                "XBOW",
                "elf.bifrose"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b72c2616-cc7c-4c47-a83d-6b7866b94746",
            "created_at": "2023-01-06T13:46:39.425297Z",
            "updated_at": "2025-03-27T02:00:03.08718Z",
            "deleted_at": null,
            "main_name": "Red Nue",
            "aliases": [
                "LuoYu"
            ],
            "source_name": "MISPGALAXY:Red Nue",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535976,
    "ts_updated_at": 1743041822,
    "ts_creation_date": 1653756616,
    "ts_modification_date": 1653756616,
    "files": {
        "pdf": "https://archive.orkl.eu/23c75188146e109ca9f7eb31607643a3a6f32079.pdf",
        "text": "https://archive.orkl.eu/23c75188146e109ca9f7eb31607643a3a6f32079.txt",
        "img": "https://archive.orkl.eu/23c75188146e109ca9f7eb31607643a3a6f32079.jpg"
    }
}