{
    "id": "197b7d30-e511-491f-99a5-94c5de1b27de",
    "created_at": "2023-01-12T15:09:14.742072Z",
    "updated_at": "2025-03-27T02:16:25.525946Z",
    "deleted_at": null,
    "sha1_hash": "27c18dd5f4ad337c218c97922f2dfea555a39470",
    "title": "2015-05-20 - Bedep Ad-Fraud Botnet Analysis – Exposing the Mechanics Behind 153.6M Defrauded Ad Impressions A Day",
    "authors": "",
    "file_creation_date": "2022-10-02T12:18:46Z",
    "file_modification_date": "2022-10-02T12:18:46Z",
    "file_size": 986522,
    "plain_text": "# Bedep Ad-Fraud Botnet Analysis – Exposing the Mechanics Behind 153.6M Defrauded Ad Impressions A Day\n\n**sentrant.com/2015/05/20/bedep-ad-fraud-botnet-analysis-exposing-the-mechanics-behind-153-6m-defrauded-ad-**\nimpressions-a-day/index.html\n\nPosted by Sergei Frankoff 20 May\n0 Comments\n\n[Following on from our post on Angler EK we are going to expose the mechanics behind the](https://sentrant.com/2015/05/12/briefing-angler-exploit-kit/index.html)\nBedep ad-fraud malware. Recently Bedep has been observed as the payload dropped by the\nAnger EK in a series of **[malvertising campaigns. These campaigns have lead to a rapid](https://blog.malwarebytes.org/exploits-2/2015/01/top-adult-site-xhamster-victim-of-large-malvertising-campaign/)**\n[rise in the rate of Bedep infections, with Arbour Networks observing just above 80K](http://www.arbornetworks.com/asert/2015/04/bedeps-dga-trading-foreign-exchange-for-malware-domains/)\ninfections over a 3-day period.\n\nBedep has the ability to load multiple custom modules after infecting a host. In this briefing,\nwe will examine Bedep’s ad-fraud module and provide insight into how traffic from this bot is\nlaundered into the advertising ecosystem and used to defraud advertisers.\n\nBedep’s ad-fraud module is fairly sophisticated but it’s not as advanced as some of the adfraud bots we have analyzed, for example Kovter. It has features to circumvent current adfraud detection capabilities such as user behaviour emulation and referrer spoofing. With\nthese features, the bot is successful in defrauding advertisers on various sites, including ads\nfrom some large advertisers such as American Express, British Airways, **BMO, and Ford**\non reputable exchanges such as Google’s doubleclick.\n\n\n-----\n\n## Bedep Traffic in The Advertising Ecosystem\n\nWhile the topic of how bot traffic is introduced into the advertising ecosystem is complex, we\nare going to use Bedep as an example to illustrate one of the more common ways that bot\ntraffic is laundered into the ecosystem before it is used to defraud advertisers.\n\nModern ad-fraud bots don’t directly click on ads as many may expect. Instead they use low\nquality PPC exchanges to route their traffic to publishers who pay these exchanges for traffic.\nOnce the bot lands on the publisher’s site, it automatically defrauds all the ad impressions on\nthe site (and in some cases the video ads as well). The publisher has little incentive to block\nthis traffic as they are still being paid for the impressions, and likewise the low quality PPC\nexchange has little incentive not to pay the bot masters as the publishers are paying them.\nWe want to be clear; neither the publishers nor the low quality PPC exchange may be\nknowingly supporting the bot traffic, however, as long as they are still being paid there is little\nincentive for them to investigate where the traffic originates.\n\nModern Traffic Laundering\n\nBedep uses multiple PPC exchanges backed by thousands of publishers to launder its traffic.\nWe have simply chosen one example to illustrate the full laundering chain.\n\nWe start with the PPC URL that is sent from the ad-fraud module’s command and control\nserver (C2). Here we see it redirects to the domain c.feed-xml.com which is a PPC feed for\nthe **[VertaMedia PPC exchange.](http://vertamedia.com/)**\n\n\n-----\n\nBedep C2 Click URL directing browser to VertaMedia exchange\n\nNext the VirtaMedia exchange redirects the bot another PPC exchange this time hosted by\n**[eZanga. We see something interesting here, the Virta Media exchange has added the](http://www.ezanga.com/)**\nfollowing search parameters to the eZanaga request\n“heavy+truck+insurance+home+carpet+cleaners”.\n\nBedep browser is redirected from VirtuMedia exchange to eZanga exchange\n\nFinally eZanga redirects the bot to a publisher’s site virtustyle.com.\n\n\n-----\n\neZanga redirects Bedep browser to publisher virtustyle.com\n\nOnce the Bedep Ad-Fraud bot is finally redirected to the publisher’s site virtustyle.com, it\nloads the site and defrauds all of the impression ads. Some of the exchanges that are\nserving ads on virtustyle.com are:\n\nAdRoll\nConversant Media\nCriteo\nVibrant Media\n\nIn our lab we observed a single Bedep bot load, on average, one website a minute. This is\ndue to the multiple threads that the Bedep operates, each running a seperate browser\ninstance. If we use the botnet size observed by Arbor as 80K bots and assume that each\ninfected machine is only operational for 8 hours a day, it means the Bedep botnet is visiting\n**38.4M websites each day. To better estimate the impact of this fraud we can take a**\nconservative estimate of 4 ads per page which gives us a minimum of 153.6M defrauded ad\n**impressions a day. In our lab we observed Bedep loading multiple websites that used ad-**\nstuffing to load hundreds of ads at a time. As a result we would expect the real number of\ndefrauded ad impressions to be a multiple larger than our 153.6M/day estimation.\n\n## The Bedep Bot\n\n\n-----\n\nThe loader portion of Bedep is the initial malware that is installed after a host is infected. The\nloader is responsible for setting up persistence on the infected host and downloading\nadditional malware modules to monetize the infected host. The loader’s downloaded\npayloads come in both 32bit and 64bit versions depending on the operating system of the\nvictim.\n\nLike most current malware, the loader code has been designed with some light anti-analysis\ntricks, the most frustrating of which is the fact that all strings are encrypted. We have\n[released a string decryption tool on our github to assist with the decryption of these strings.](https://github.com/Sentrant/MiscTools/tree/master/bedep)\nOnce the strings have been decrypted the logic of the loader is fairly straight forward; it\ninstalls a persistence mechanism then calls out to its command and control server (C2) to\ndownload and run the monetization module (in this case an ad-fraud module).\n\n## Persistence\n\nWhen the loader is run it creates a hidden folder with a UUID the %PROGRAMDATA%. It\nthen copies itself to the folder as a DLL using a benign sounding name, in this case\n**FntCache.dll.**\n\nBedep hidden folder and persistence DLL\n\nFor persistence, the loader creates a special Shell Extension for the current user that loads\nthis DLL.\n\nThe server to run the malicious loader DLL is located in the registry here:\n\n**HKU\\<User SID>\\Software\\Classes\\CLSID\\{F6BF8414-962C-40FE-90F1-**\n**B80A7E72DB9A}\\InprocServer32**\n\nThe Shell Extension is registered to the current user here:\n\n**HKU\\<User SID>\\Software\\Classes\\Drive\\ShellEx\\FolderExtensions\\{F6BF8414-962C-**\n**40FE-90F1-B80A7E72DB9A}**\n\n\n-----\n\nBedep Shell Extension persistence mechanism\n\n## Loader C2 Communication\n\nThe Bedep loader uses a domain generation algorithm to dynamically generate the domain it\n[is going to connect to. The folks over at Arbor have provided an excellent article explaining](http://www.arbornetworks.com/asert/2015/04/bedeps-dga-trading-foreign-exchange-for-malware-domains/)\nhow the DGA works and they even provided a tool to re-generate the domains. Instead of\nposting the same information here we suggest you head over and read their report.\n\nThe C2 traffic itself is composed of a series of POST messages that contain encrypted\nmessages.\n\nBedep C2 traffic example\n\nAfter analyzing the algorithm used to encrypt the message we determined that it was a\ncustom implementation of AES that used a 16 byte key (AES128). The key is encrypted and\nhard coded in the binary. The developers had also cleverly encrypted the AES s-box in an\nattempt to make analysis of the algorithm more difficult. The IV used in the AES encryption is\nrandomly generated for each request and prepended to the cypher text after encryption. The\nIV plus cypher text is then base64 encoded and sent as the message in the POST.\n\n\n-----\n\nBedep encryption algorythm\n\n[We have released a tool that can be used to decrypt Bedep traffic on our Github.](https://github.com/Sentrant/MiscTools/tree/master/bedep)\n\nThe actual messages that are sent from the Bedep loader to the C2 are formatted JSON\nwhile messages that are returned by the C2 are delimitated by the ‘#’ character and are\nspecific to the request sent by the bot. The command set used in the communication\nconsists of the following.\n\n### Message Header\n\n**Attribute** **Description**\n\nprotocolVersion The version of the communication protocol. This is hard coded in the\nbot. This parameter must always be present in the request.\n\nrev Bot revision. This is hardcoded in the bot. This parameter must always\nbe present in the request.\n\nbuildId Build ID for the bot. This is hardcoded in the bot. This parameter must\nalways be present in the request.\n\n\n-----\n\nbotId This is a unique ID that is assigned to the bot by the C2 on first\ncommunication. This parameter must be present in all requests after the\ninitial communication.\n\ntags Tags is an array that contains the commands.\n\n### Command Set\n\n**Attribute** **Description**\n\nping This is the first command that is sent by the bot to establish communication\nwith the C2. The C2 responds with ID assigned to the bot.\n\nzoo This command is used to download a set of DLLs. Currently we have not\ninvestigated the purpose of these DLLs.\n\nupdate This command is used to download and run the Bedep payload. In this case\nthe ad-fraud module.\n\nstat This command is used to upload statistics on a specific job or command that\nthe bot is executing.\n\nWe recently noticed a slightly new variation on the traffic format for Bedep where the\nencrypted message is split over a series of parameters in the POST message. These new\nrequests also have URL paths generated from the following strings (thanks to Moritz Kroll for\nposting the full list to VirusTotal).\n\n\n-----\n\n```\nfunctions_picturecomment.php\n\nfunctions_online.php\n\nfunctions_notice.php\n\nfunctions_newpost.php\n\nfunctions_misc.php\n\nfunctions_log_error.php\n\nfunctions_login.php\n\nfunctions_legacy.php\n\nfunctions_infractions.php\n\nfunctions_forumlist.php\n\nfunctions_forumdisplay.php\n\nfunctions_filesystemxml.php\n\nfunctions_file.php\n\nfunctions_faq.php\n\nfunctions_facebook.php\n\nfunctions_external.php\n\nfunctions_editor.php\n\nfunctions_digest.php\n\nfunctions_databuild.php\n\nfunctions_cms_layout.php\n\nfunctions_calendar.php\n\nfunctions_bigthree.php\n\nfunctions_banning.php\n\nfunctions_attach.php\n\nfunctions_album.php\n\nfunctions_ad.php\n\nfunctions.phÿ\n\ndatabase_error_page.html\n\ndatabase_error_message_ajax.html\n\ndatabase_error_message.html\n\nclass_dm_groupmessage.php\n\nclass_dm_forum.php\n\nclass_dm_event.php\n\nclass_dm_discussion.php\n\nclass_dm_deletionlog_blog.php\n\nclass_dm_deletionlog.php\n\nclass_dm_cms_widget.php\n\nclass_dm_cms_layout.php\n\nclass_dm_blog_trackback.php\n\nclass_dm_blog_rate.php\n\nclass_dm_blog_custom_block.php\n\nclass_dm_blog_category.php\n\nclass_dm_blog.php\n\nclass_dm_attachment.php\n\nclass_dm_album.php\n\nclass_dm.php\n\nclass_dbalter.php\n\nclass_datastore.php\n\nclass_database_slave.php\n\nclass_database_explain.php\n\nclass_core.php\n\nclass_bootstrap_framework.php\n\n```\n\n-----\n\n```\nclass_bootstrap.php\n\nclass_blog_response.php\n\nclass_blog_entry.php\n\nclass_block.php\n\nclass_bitfield_builder.php\n\nclass_bbcode_blog.php\n\nclass_bbcode_alt.php\n\nclass_bbcode.php\n\nclass_apiclient.php\n\nclass_akismet.php\n\nclass_ajax_output.php\n\nblog_init.php\n\nblog_functions_shared.php\n\nblog_functions_search.php\n\nblog_functions_post.php\n\nblog_functions_online.php\n\nblog_functions_main.php\n\nblog_functions_category.php\n\nblog_functions.php\n\nxmlsitemap.php\n\nwidget.php\n\nshowthread.php\n\nshowpost.php\n\nsendmessage.php\n\nsearch.php\n\nreport.php\n\nregister.php\n\nprofile.php\n\npostings.php\n\nposthistory.php\n\npoll.php\n\nonline.php\n\nnewthread.php\n\nnewreply.php\n\nmisc.php\n\nmemberlist.php\n\nmember.php\n\nlogin.php\n\nlist.php\n\ninfraction.php\n\ngroupsubscription.php\n\ngroup.php\n\nglobal.php\n\nforumdisplay.php\n\ncss.php\n\nconverse.php\n\ncontent.php\n\nblog_post.php\n\nblog_attachment.php\n\nblog_ajax.php\n\nattachment.php\n\nassetmanage.php\n\n```\n\n-----\n\n```\nannouncement.php\n\nclear.php\n\nasset.php\n\najax.php\n\nalbum.php\n\ncalendar.php\n\nblog.php\n\nforum.php\n\nindex.php\n\ninclude\n\n```\nTo use our decryption tool with this new format of traffic you simply need to extract all the\nvalues from the parameters passed in the message body and concatenate them into a single\nstring.\n\nNew Bedep C2 traffic example\n\nThe values from the parameters in the request shown above have been extracted and\ncombined into the base64 string shown below. Once extracted and combined in this fashion\nthe string can be decrypted using the tool we released.\n\nExtracted Bedep base64 string\n\n## Bedep Ad-Fraud Module\n\nThe Bedep Ad-Fraud module that is downloaded via the “update” comes in both 32bit and\n64bit versions. This module does not persist on the host and is downloaded when the Bedep\nloader is started after a reboot. The Bedep loader uses process hallowing to inject the AdFraud module into benign processes.\n\n\n-----\n\nProcesses injected with Bedep ad-fraud module\n\nDuring operation, the Ad-Fraud module receives URLs of sites to browse from its command\nand control (C2) server. It then opens a hidden instance of an embedded Internet Explorer\nbrowser and programatically directs the browser to load the URLs it has received. We will\nexplain this process in detail below.\n\n## Hidden Browser Setup\n\nIn order to hide its activity from users of the infected host the module creates a virtual\ndesktop that is uses to house all of its windows. More information on virtual desktops and a\n[tool used to display them can be found in this blog post. In this case the module creates a](http://herrcore.blogspot.ca/2014/11/exposing-malware-in-hidden-desktops.html)\ndesktop called Default IME and then moves its process to this desktop.\n\nBedep creates a virtual desktop called “Default IME”\n\nIn addition to using a virtual desktop to hide the presence of its browser windows the AdFraud module also sets a number of in-line hooks in its process space to suppress events\nthat might notify a user that there is a hidden browser running on their host.\n\n\n-----\n\nBedep hooks to hide browser\n\nThe PlaySound and waveOutOpen hooks simply null out the functions and serve to\nsuppress any sounds that might be generated by the Ad-Fraud module’s browsing, such as\nthe audio from videos. The SetFocus and DialogBox hooks also null out the functions but\nthey serve to suppress any visual queues that might indicate the presence of a hidden\nbrowser, such as pop-ups.\n\nIn parallel with the hooks the module also sets a number of registry keys to configure the\nbehaviour of the embedded Internet Explorer browsers that it controls. This configuration is\nboth an attempt to suppress events that might notify a user of the operation of the browsers\nand also an attempt to make the embed Internet Explorer browser behave similar to a real\nInternet Explorer browsers. When the Internet Explorer browser is embedded and controlled\nprogramatically some of its features differ from those of a real Internet Explorer browser. A\nsubset of these features can be detected by anti-fraud solutions as a way to detect bot traffic.\nTo circumvent these detection methods the Bedep Ad-Fraud module sets these registry keys\nto ensure its embedded browsers have the same features as a real Internet Explorer\nbrowser.\n\n\n-----\n\n## Ad-Fraud C2 Communication\n\nOne of the more peculiar aspects of the Bedep Ad-Fraud module is that its C2\ncommunications are not encrypted. Given the level of sophistication in the Bedep loader C2\nencryption it is surprising to see that the Ad-Fraud C2 traffic is sent in clear text.\n\nBedep Ad-Fraud module C2 traffic\n\nAs shown above the C2 sends a URL to load along with some attributes for the ad-fraud\nmodule to spoof in its embedded Internet Explorer browser.\n\n**Click Attribute** **Example**\n\nClick URL http://[censored]/r.php?key=[censored]\n\nSpoof Referer http://new-april-discount.net/search.php\n\nSpoof User Agent Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64;\nTrident/6.0)\n\n\nSpoof\nLanguage/Location\n\n\nen-US\n\n\n## Click URL Navigation\n\nBefore navigating to the click URL the Ad-Fraud module creates another set of hooks to\nspoof the Language/Location and other attributes.\n\nBedep hooks to spoof User Agent and Language/Location\n\n\n-----\n\nBedep uses its API hooks to spoof these values for its whole process space which means it\ndoesn’t need to deal with the mechanics of where these values might be queried (ie.\njavascript, browser, flash, etc). This makes Bedep’s feature spoofing more robust than some\nless advanced ad-fraud bots. The referer URL is spoofed by setting it directly using the\nembedded Internet Explorer control API.\n\nOnce the click URL has been loaded in the embedded browser the Ad-Fraud module uses\nsome simple browsing behaviour emulation techniques in an attempt to trick any fraud\ndetection service. An example of this behaviour is some random mouse movement and left\nclicking.\n\nBedep example of random mouse move and click\n\nIn addition to the behaviour emulation, the ad-fraud module also injects javascript that\nattempts to play any flash videos on the page.\n\nBedep inject javascript to automatically play flash videos\n\n## Conclusions\n\n\n-----\n\nWhile not the most advanced ad-fraud bot available Bedep represents a new type of\nadvance ad-fraud threat that is actively circumventing traditional ad-fraud detection and\ndefrauding high quality impressions from well established exchanges.\n\nWhile we are actively working with our partners to identify and eliminate Bedep ad-fraud\ntraffic from the advertising ecosystem, we need help from security vendors and incident\nresponders to detect and remove this threat from endpoints. Our hope is that our report and\naccompanying tools will be of assistance.\n\nWe have intentionally removed some of our analysis from this report because it;\n\nmay have given the malware developers insight into how we are able to detect this bot\nand/or,\nwe believe it was not necessary information from an incident response perspective.\n\nThat being said, if you have any questions about our analysis or would like to know more feel\nfree to **[contact us. We are happy to share more information privately.](https://sentrant.com/contact/index.html)**\n\n## Prior and Parallel Research\n\nKafeine has an excellent overview of Angler and Bedep. Also contains a note on Bedep’s\npersistence mechanism.\n\n**http://malware.dontneedcoffee.com/2015/01/unpatched-vulnerability-0day-in-**\n**flash.html**\n\nArbor have an excellent analysis of the Bedep DGA and they also released a tool to replicate\nit.\n\n**http://www.arbornetworks.com/asert/2015/04/bedeps-dga-trading-foreign-exchange-**\n**for-malware-domains/**\n\nSpider labs have a report detailing some of the ad-fraud traffic they observed.\n\n**https://www.trustwave.com/Resources/SpiderLabs-Blog/Bedep-trojan-malware-**\n**spread-by-the-Angler-exploit-kit-gets-political/**\n\nMalwarebytes have a post explaining how Bedep is tied to recent malvertising attacks.\n\n**https://blog.malwarebytes.org/exploits-2/2015/01/top-adult-site-xhamster-victim-of-**\n**large-malvertising-campaign/**\n\nZscaler also have a post covering Bedep related malvertising attacks.\n\n**[http://research.zscaler.com/2015/01/malvertising-leading-to-flash-zero-day.html](http://research.zscaler.com/2015/01/malvertising-leading-to-flash-zero-day.html)**\n\n\n-----\n\n## Reference MD5 Hashes\n\nClick Module: 2faf2044e18837d23aa325cb21f17c4b\n\nLoader DLL (persistence): 46df78cf0eea2915422d84928dbc2462\n\nLoader DLL (from Angler EK): 854646bdcf4da69c975dd627f5635037\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-05-20 - Bedep Ad-Fraud Botnet Analysis – Exposing the Mechanics Behind 153.6M Defrauded Ad Impressions A Day.pdf"
    ],
    "report_names": [
        "2015-05-20 - Bedep Ad-Fraud Botnet Analysis – Exposing the Mechanics Behind 153.6M Defrauded Ad Impressions A Day.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536154,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1664713126,
    "ts_modification_date": 1664713126,
    "files": {
        "pdf": "https://archive.orkl.eu/27c18dd5f4ad337c218c97922f2dfea555a39470.pdf",
        "text": "https://archive.orkl.eu/27c18dd5f4ad337c218c97922f2dfea555a39470.txt",
        "img": "https://archive.orkl.eu/27c18dd5f4ad337c218c97922f2dfea555a39470.jpg"
    }
}