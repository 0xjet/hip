{
    "id": "61608afe-bdcf-4a6f-ad6c-7cd9674f0b33",
    "created_at": "2023-01-12T15:06:04.964101Z",
    "updated_at": "2025-03-27T02:05:32.523068Z",
    "deleted_at": null,
    "sha1_hash": "d39915f088af3c9949ef7247010e1d34819c45c2",
    "title": "2016-12-14 - MiKey - A Linux keylogger",
    "authors": "",
    "file_creation_date": "2022-10-02T12:11:16Z",
    "file_modification_date": "2022-10-02T12:11:16Z",
    "file_size": 481560,
    "plain_text": "# securitykitten.github.io/2016-12-14-mikey.md at master · malware-kitten/securitykitten.github.io · GitHub\n\n**[github.com/malware-kitten/securitykitten.github.io/blob/master/_posts/2016-12-14-mikey.md](https://github.com/malware-kitten/securitykitten.github.io/blob/master/_posts/2016-12-14-mikey.md)**\n\nmalware-kitten\n\nCannot retrieve contributors at this time\n\n**layout** **title** **date**\n\ncategory-post MiKey - A Linux keylogger 2016-12-14 00:00:00 -0500\n\n## Summary:\n\nLinux malware is slowly becoming more popular. Within the past couple\nyears there were several major incidents that cited the use of Windows\nbackdoors being ported to Linux. Through our research on the Windows\nKLRD keylogger from the Odinaff report, we were able to discover several\nnew keyloggers. The focus of this blog post is MiKey, a little-known and\npoorly detected keylogger.\n\n\n-----\n\nAt the time of this writing, the malware wasn t detected by a single engine\non Virustotal.\n\n## Analysis\n\nThe malware is a 64 bit Linux executable:\n```\n9c07ed03f5bf56495e1d365552f5c9e74bb586ec45dffced2a8368490da4c829: ELF\n64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked,\ninterpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32,\nBuildID[sha1]=550c58e6a9bc88b8724fd8ab7fd79a6c58c12d28, not stripped\n\n\n```\nAnd depends on the following libraries:\n```\n    linux-vdso.so.1 (0x00007ffd25123000)\n\n    libX11.so.6 => /usr/lib/x86_64-linux-gnu/libX11.so.6\n(0x00007f7f56420000)\n\n    libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2\n(0x00007f7f5621c000)\n\n    libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6\n(0x00007f7f55e7e000)\n\n    libxcb.so.1 => /usr/lib/x86_64-linux-gnu/libxcb.so.1\n(0x00007f7f55c56000)\n\n    /lib64/ld-linux-x86-64.so.2 (0x00005597839c6000)\n\n    libXau.so.6 => /usr/lib/x86_64-linux-gnu/libXau.so.6\n(0x00007f7f55a52000)\n\n    libXdmcp.so.6 => /usr/lib/x86_64-linux-gnu/libXdmcp.so.6\n(0x00007f7f5584a000)\n\n\n```\nAnalyzing the symbol table for this binary yielded some interesting function\nnames. (Full output omitted for readability):\n\n\n-----\n\n```\n  63: 00000000004014b2  79 FUNC  GLOBAL DEFAULT  14\ncreateProccess\n\n  64: 0000000000400ed6  128 FUNC  GLOBAL DEFAULT  14\ninitPlugins\n\n  67: 0000000000400f56  105 FUNC  GLOBAL DEFAULT  14 moduleFeed\n\n  68: 000000000040102d 1157 FUNC  GLOBAL DEFAULT  14 keylogger\n\n  75: 0000000000400dc6  159 FUNC  GLOBAL DEFAULT  14 handleArgs\n\n  83: 0000000000400e65  113 FUNC  GLOBAL DEFAULT  14\nmoduleHandleArgs\n\n  85: 00000000004015fc  209 FUNC  GLOBAL DEFAULT  14 addData\n\n  87: 0000000000400cd0  42 FUNC  GLOBAL DEFAULT  14 _start\n\n  88: 0000000000400fbf  110 FUNC  GLOBAL DEFAULT  14\naddParentheses\n\n  92: 0000000000401501  126 FUNC  GLOBAL DEFAULT  14 main\n\n  103: 0000000000400b00   0 FUNC  GLOBAL DEFAULT  11 _init\n\n```\nComments left by the compiler provide evidence it was compiled on\nUbuntu 16.04.2:\n```\n9c07ed03f5bf56495e1d365552f5c9e74bb586ec45dffced2a8368490da4c829:  \nfile format elf64-x86-64\n\n\n```\nContents of section .comment:\n```\n 0000 4743433a 20285562 756e7475 20352e34 GCC: (Ubuntu 5.4\n\n 0010 2e302d36 7562756e 7475317e 31362e30 .0-6ubuntu1~16.0\n\n 0020 342e3229 20352e34 2e302032 30313630 4.2) 5.4.0 20160\n\n 0030 36303900               609. \n\n\n```\nThis is further evidenced by the build path in the binary:\n```\n/home/ubuntu/MiKey-64-ubuntu\n\n\n```\nThe strace tool was used to quickly identify high-level function workflows\nand identify potential focus areas. One anomaly identified was a failed file\nopening, “mikey-text.so.” So we began there.\n```\nopen(\"./tls/x86_64/mikey-text.so\", O_RDONLY|O_CLOEXEC) = -1 ENOENT\n(No such file or directory)\n\nopen(\"./tls/mikey-text.so\", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such\nfile or directory)\n\nopen(\"./x86_64/mikey-text.so\", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No\nsuch file or directory)\n\nopen(\"./mikey-text.so\", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file\nor directory)\n\n\n```\nThe malware isn’t explicitly searching these directories for mikey-text.so.\nThis is a side effect of dlopen. From the man page:\n\n\n-----\n\n```\n If, at the time that the program was started, the environment\nvariable LD_LIBRARY_PATH was defined to contain a colon-separated\nlist of directories, then these are searched. (As a security measure\nthis variable is ignored for set-user-ID and set-group-ID programs.)”\n\n```\nAfter a little searching we located a second binary (SHA-256\nbc6d25dff00dfb68b19b362c409d2cf497e5dd97d9d6e5ce2bde2ba706f2bdb3)\nwhich contained the string “mikey-text.c.” From this, we assessed that\nmickey-text.so is the compiled version of this binary.\n\nUsing this assertion, we renamed the second binary to mikey-text.so and\nplaced it in the load path identified using strace. This caused the\nsuccessful execution of the malware. The output file (out.log) contained\nthe logged keystrokes with associated timestamps.\n\nThrough static analysis, we were able to identify that when the keylogger\nstarts up, it loaded plugins, handle arguments, and then forked its process.\n\nWhen loading the plugins, the keylogger looked for a single hardcoded\nplugin name “mikey-text.so” and called dlopen to obtain a handle to it.\n\nOnce everything was loaded, the main functionality of the program was\nhandled through the “keylogger” function.\n\nTo better understand Linux keyloggers and associated function calls, basic\nX function knowledge is critical. As a quick primer, here are some routines\nused by the “keylogger” function to query information about keystrokes or\nsimply harvest raw keystroke data.\n\n\n-----\n\n**Function** **Purpose**\n\nXOpenDisplay Returns a display structure that serves as the\nconnection to the X server. Communication is\nthen carried out through TCP or IPC.\n\nXQueryKeymap Uses the structure from the display to gather\ninformation about the state of the keyboard.\nInformation about which keys are currently\npressed can be gathered using this call.\n\nXkbKeycodeToKeysym Uses the structure from the display to return\nthe keysym for a particular key.\n\nXKeysymToString Converts the previously obtained keysym.\n\nXGetInputFocus Controls focus on the desktop.\n\nOnce the keycode is retrieved, it’s compared against a large switch table to\nconvert each keycode into a string. This is no different than most\nkeyloggers.\n\nNon-printable keystrokes are then identified and substituted with humanreadable outputs.\n\nIf there is a non-printable character returned, a small method to format the\nstring in parentheses is called to make for nice output into the log.\n\nOnce completed, the data is stored into a buffer and passed to a loadable\nmodule. The Linux dlsym method provides similar functionality as\n“LoadLibrary” on Windows. The previous handle from dlopen is being\n\n\n-----\n\npassed to dlsym, which we can now use to call the method getFeed from\nmikey-text.so.\n\nPeering into the “getFeed” function on mikey-text.so it simply calls the _log\nfunction.\n\n\n-----\n\nThe _log function will call _time and _localtime (to harvest the timestamps)\nand build these into a format string.\n\nAt this point, the output file is opened for writing with the appended (“a+”)\nflag and the file is written to using the _fputs method. If no option for -output was provided to mikey-text.so then the default name of “out.log” is\nprovided. The screenshot below identifies the contents of cs:outputfile_ptr\nas a pointer to the name of the output file.\n\nOutside of a small method to parse arguments, there isn’t much more\nfunctionality to mikey-text.so. It’s a simple logging plugin for the main\nMiKey keylogger. Booz Allen assesses that additional plugins may exist\n(for C2 communication, or to hook to other files), but is unable to confirm at\nthis time.\n\n\n-----\n\nTo run the keylogger and give a custom argument for an output file named\nkeylogged.txt, the following command can be used. In addition, providing\nthe “-b” option will “background” the process.\n\nChecking processes on the host, the command “ps aux” was issued.\n\nAnd checking the output of the keylogged file:\n\n## Conclusion\n\nSmall utilities that are built for a specific purpose often bypass AV with\nease. Attackers are able to write a functional keylogger that will dump the\ncontents to a local file. By having modular code, the authors could build\nplugins that achieve whatever task they need. The plugin nature of this\ncode also puts the reverse engineer at a disadvantage. Without access to\neach module, only specific known functions of the tool can be\ndocumented.\n\nOne unnerving aspect of this keylogger is that, without an active command\nand control capability, the attacker would need to be confident in their\nability to repeatedly gain remote access to the victim computer to retrieve\nthe keylogged information.\n\nAll it takes to catch this is basic process and file monitoring, but if our Linux\nfield experience is any indicator, there aren’t many shops with this level of\nvisibility on non-Windows workstations.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-12-14 - MiKey - A Linux keylogger.pdf"
    ],
    "report_names": [
        "2016-12-14 - MiKey - A Linux keylogger.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535964,
    "ts_updated_at": 1743041132,
    "ts_creation_date": 1664712676,
    "ts_modification_date": 1664712676,
    "files": {
        "pdf": "https://archive.orkl.eu/d39915f088af3c9949ef7247010e1d34819c45c2.pdf",
        "text": "https://archive.orkl.eu/d39915f088af3c9949ef7247010e1d34819c45c2.txt",
        "img": "https://archive.orkl.eu/d39915f088af3c9949ef7247010e1d34819c45c2.jpg"
    }
}