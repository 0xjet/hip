{
    "id": "5badca0a-a683-4e62-b891-26c044a582e8",
    "created_at": "2023-01-12T15:03:58.818454Z",
    "updated_at": "2025-03-27T02:13:47.92159Z",
    "deleted_at": null,
    "sha1_hash": "d4f3f86e0186ac00e154928b052a2e8c5a078ff3",
    "title": "2022-02-02 - TrickBot Gang Uses Template-Based Metaprogramming in Bazar Malware",
    "authors": "",
    "file_creation_date": "2022-05-28T02:36:16Z",
    "file_modification_date": "2022-05-28T02:36:16Z",
    "file_size": 1444290,
    "plain_text": "# TrickBot Gang Uses Template-Based Metaprogramming in Bazar Malware\n\n**[securityintelligence.com/posts/trickbot-gang-template-based-metaprogramming-bazar-malware/](https://securityintelligence.com/posts/trickbot-gang-template-based-metaprogramming-bazar-malware/)**\n\n[Home&nbsp/](https://securityintelligence.com/) [Endpoint](https://securityintelligence.com/category/topics/endpoint/)\nTrickBot Gang Uses Template-Based Metaprogramming in Bazar Malware\n\n[Endpoint February 2, 2022](https://securityintelligence.com/category/topics/endpoint/)\n\n\n-----\n\nBy [Kevin Henson 6 min read](https://securityintelligence.com/author/kevin-henson/)\nMalware authors use various techniques to obfuscate their code and protect against reverse\n[engineering. Techniques such as control flow obfuscation using Obfuscator-LLVM and](https://github.com/obfuscator-llvm/obfuscator/wiki)\nencryption are often observed in malware samples.\n\nThis post describes a specific technique that involves what is known as metaprogramming,\nor more specifically template-based metaprogramming, with a particular focus on its\nimplementation in the Bazar family of malware (BazarBackdoor/BazarLoader). Bazar is best\n[known for its ties to the cybercrime gang that develops and uses the TrickBot Trojan. It is a](https://securityintelligence.com/posts/trickbot-gang-doubles-down-enterprise-infection/)\n[major cybercrime syndicate that is highly active in the online crime arena.](https://securityintelligence.com/posts/trickbot-gang-doubles-down-enterprise-infection/)\n\n## A Few Words About Metaprogramming\n\nMetaprogramming is a technique where programs are designed to analyze or generate new\ncode at runtime. Developers typically use metaprogramming techniques to make their code\nmore efficient, modular and maintainable. Template-based metaprogramming incorporates\ntemplates that serve as models for code reuse. The templates can be written to handle\nmultiple data types.\n\nFor example, the basic function template shown below can be used to define multiple\nfunctions that return the maximum of two values such as two numbers or two strings. The\ntype is generalized in the template parameter <typename T>, as a result, a and b will be\ndefined based on the usage of the function. One of the “magical” attributes of templates is\nthat the max() function doesn’t actually exist until it’s called and compiled. For the example\nbelow, three functions will be created at compile time, one for each call.\n\n\n-----\n\n//Sample function template\n\ntemplate<typename T>\n\nT max (T a, T b)\n\n{\n\n// if b < a then yield a else yield b\n\nreturn b < a ? a : b;\n\n}\n\n// Calls to max()\n\nmax(10,5);\n\nmax(5.5, 8.9);\n\nmax(“reverse”, “engineering”);\n\nTemplates can be quite complex; however, this high-level understanding will suffice in\ngrasping how the concept is used to a malware author’s advantage.\n\n## Malware Development\n\nMalware authors take advantage of the metaprogramming technique to both obfuscate\nimportant data and ensure that certain elements, such as code patterns and encryption keys,\nare generated uniquely with each compilation. This hinders analysis and makes developing\nsignatures for static detection more difficult because the encryption code changes with each\ncompiled sample.\n\nThe key components in metaprogramming used to accomplish this type of obfuscation are\nthe templates and another feature called constexpr functions. In simple terms, a constexpr\nfunction’s return value is determined at compile time.\n\nTo illustrate how this works, the following sections will compare samples compiled from the\nopen-source library ADVobfuscator to Bazar samples found in the wild. The adoption of more\nadvanced programming techniques within the Bazar malware family is especially relevant\nsince the operators of Bazar are highly active in attacks against organizations across the\nglobe.\n\n### ADVobfuscator\n\n\n-----\n\nTo get a better understanding of how template programming is utilized with respect to string\nobfuscation, let’s take a look at two header files from ADVobfuscator. [ADVobfuscator is](https://github.com/andrivet/ADVobfuscator)\ndescribed as an “Obfuscation library based on C++11/14 and metaprogramming.” The\nMetaRandom.h and MetaString.h header files from the library are discussed below.\n\n### MetaRandom.h\n\nThe MetaRandom.h header file generates a pseudo-random number at compile time. The file\nimplements the keyword constexpr in its template classes. The constexpr keyword declares\nthat the value of a function or variable can be evaluated at compile time and, in this example,\nfacilitates the generation of a pseudo-random integer seed based on the compilation time\nthat is then used to generate a key.\n\nnamespace\n\n{\n\n// I use current (compile time) as a seed\n\nconstexpr char time[] = __TIME__; // __TIME__ has the following format: hh:mm:ss in\n24-hour time\n\n// Convert time string (hh:mm:ss) into a number\n\nconstexpr int DigitToInt(char c) { return c – ‘0’; }\n\nconst int seed = DigitToInt(time[7]) +\n\nDigitToInt(time[6]) * 10 +\n\nDigitToInt(time[4]) * 60 +\n\nDigitToInt(time[3]) * 600 +\n\nDigitToInt(time[1]) * 3600 +\n\nDigitToInt(time[0]) * 36000;\n\n}\n\n_Figure 1: Code Block 1 MetaRandom.h_\n\n### MetaString.h\n\nThe MetaString.h header file consists of versions of a template class named MetaString that\nrepresents an encrypted string. Through template programming, MetaString can encrypt\neach string with a new algorithm and key during compilation of the code. As a result, a\n\n\n-----\n\nsample could be produced with the following string obfuscation:\n\nEach character in the string is XOR encrypted with the same key.\nEach character in the string is XOR encrypted with an incrementing key.\nThe key is added to each character of the string. As a result, decryption requires\nsubtracting the key from each character.\n\nHere is a sample MetaString implementation from ADVobfuscator.\n\nThis template defines a MetaString with an algorithm number (N), a key value and a list of\nindexes. The algorithm number controls which of the three obfuscation methods are used\nand is determined at compile time.\n\ntemplate<int N, char Key, typename Indexes>\n\nstruct MetaString;\n\n_Figure 2: Code Block 2 MetaString.h_\n\nThis is a specific implementation of MetaString based on the above template. The algorithm\nnumber (N) is 0, K is the pseudo-random key and I (Indexes) represent the character index\nin the string. When the algorithm number 0 is generated at compile time, this implementation\nis used to obfuscate the string. If the algorithm number 1 is generated, the corresponding\nimplementation is used. ADVobfuscator uses the C++ macro __COUNTER__ to generate\nthe algorithm number.\n\ntemplate<char K, int… I>\n\nstruct MetaString<0, K, Indexes<I…>>\n\n{\n\n// Constructor. Evaluated at compile time.\n\nconstexpr ALWAYS_INLINE MetaString(const char* str)\n\n: key_{ K }, buffer_{ encrypt(str[I], K)… } { }\n\n// Runtime decryption. Most of the time, inlined\n\ninline const char* decrypt()\n\n{\n\nfor (size_t i = 0; i < sizeof…(I); ++i)\n\n\n-----\n\nbuffer_[i] = decrypt(buffer_[i]);\n\nbuffer_[sizeof…(I)] = 0;\n\nLOG(“— Implementation #” << 0 << ” with key 0x” << hex(key_));\n\nreturn const_cast<const char*>(buffer_);\n\n}\n\nprivate:\n\n// Encrypt / decrypt a character of the original string with the key\n\nconstexpr char key() const { return key_; }\n\nconstexpr char ALWAYS_INLINE encrypt(char c, int k) const { return c ^ k; }\n\nconstexpr char decrypt(char c) const { return encrypt(c, key()); }\n\nvolatile int key_; // key. “volatile” is important to avoid uncontrolled over-optimization by\nthe compiler\n\nvolatile char buffer_[sizeof…(I) + 1]; // Buffer to store the encrypted string + terminating\nnull byte\n\n};\n\n_Figure 3: Code Block 3 MetaString.h_\n\n## ADVobfuscator Samples\n\nInteresting code patterns are observed when samples are built using ADVobfuscator. For\n[example, after compiling the Visual Studio project found in the public Github repo, the](https://github.com/andrivet/ADVobfuscator)\nresulting code shows the characters of the string being moved to the stack, followed by a\ndecryption loop.\n\nThese snippets illustrate the dynamic nature of the library. Each string is obfuscated using\none of the three obfuscation methods previously described. Not only are the methods\ndifferent, the opcodes — the values in blue, which are commonly used in developing YARA\nrules — can vary as well for the same obfuscation method. This makes developing\nsignatures, parsers and decoders more difficult for analysts. Notably, the same patterns are\nobserved in BazarLoader and BazarBackdoor samples.\n\n\n-----\n\n**XOR encryption with the same keyXOR encryption with the same key** **XOR encryption with an incrementing keyXOR encryption with an incrementing key**\n\n_Figure 4: Compiled ADVobfuscator Exemplar Samples_\n\n## BazarBackdoor/BazarLoader\n\nBazarLoader and BazarBackdoor are malware families attributed to the TrickBot threat\ngroup, a.k.a. ITG23. Both are written in C++ and compiled for 64bit and 32bit Windows.\nBazarLoader is known to download and execute BazarBackdoor, and both use the Emercoin\nDNS domain (.bazar) when communicating with their C2 servers.\n\nOther attributes of the loader and backdoor include extensive use of API function hashing\nand string obfuscation where each string is encrypted with varying keys. The string\nobfuscation methodology implemented in these files is interesting when compared with the\nADVobfuscator samples previously described.\n\n### Bazar String Obfuscation\n\nThe string obfuscation implemented in variants of BazarLoader and BazarBackdoor is similar\nto what is implemented in ADVobfuscator. For example, the BazarBackdoor sample\n_189cbe03c6ce7bdb691f915a0ddd05e11adda0d8d83703c037276726f32dff56 detailed in_\nFigure 5 contains a modified version of the string obfuscation techniques found in\n_ADVobfuscator. In Figure 5, the string is moved to the stack four bytes at a time and the key_\nused in the decryption loop is four bytes.\n\n\n-----\n\n_Figure 5: XOR String Decryption 1_\n\n_Figure 6: XOR String Decryption 2_\n\n## TrickBot and Bazar — Ongoing Code Evolution\n\nBased on the similarities discovered through the analysis performed by X-Force, it is evident\nthat the authors of BazarLoader and BazarBackdoor malware utilize template-based\nmetaprogramming. While it is possible to break the resulting string obfuscation, the ultimate\nintent of the malware author is to hinder reverse engineering and evade signature-based\ndetection. Metaprogramming is just one tool in the threat actors’ toolbox. Understanding how\nthese techniques work helps reverse engineers create tools to increase the efficiency of\nanalysis and stay in step with the constant threat malware poses.\n\n[Kevin Henson](https://securityintelligence.com/author/kevin-henson/)\nMalware Reverse Engineer, IBM\n\nKevin joined IBM Security’s X-Force IRIS team as a Malware Reverse Engineer in November\n2018 after 21 years of experience in supporting various commercial,...\n\n\n-----\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-02 - TrickBot Gang Uses Template-Based Metaprogramming in Bazar Malware.pdf"
    ],
    "report_names": [
        "2022-02-02 - TrickBot Gang Uses Template-Based Metaprogramming in Bazar Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "63061658-5810-4f01-9620-7eada7e9ae2e",
            "created_at": "2022-10-25T15:50:23.752974Z",
            "updated_at": "2025-03-27T02:00:55.538582Z",
            "deleted_at": null,
            "main_name": "Wizard Spider",
            "aliases": [
                "Wizard Spider",
                "UNC1878",
                "TEMP.MixMaster",
                "Grim Spider",
                "FIN12",
                "GOLD BLACKBURN",
                "ITG23",
                "Periwinkle Tempest",
                "DEV-0193"
            ],
            "source_name": "MITRE:Wizard Spider",
            "tools": [
                "TrickBot",
                "AdFind",
                "BITSAdmin",
                "Bazar",
                "LaZagne",
                "Nltest",
                "GrimAgent",
                "Dyre",
                "Ryuk",
                "Conti",
                "Emotet",
                "Rubeus",
                "Mimikatz",
                "Diavol",
                "PsExec",
                "Cobalt Strike"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e6a21528-2999-4e2e-aaf4-8b6af14e17f3",
            "created_at": "2022-10-25T16:07:24.422115Z",
            "updated_at": "2025-03-27T02:02:10.216817Z",
            "deleted_at": null,
            "main_name": "Wizard Spider",
            "aliases": [
                "DEV-0193",
                "Gold Blackburn",
                "Gold Ulrick",
                "Grim Spider",
                "ITG23",
                "Operation BazaFlix",
                "Periwinkle Tempest",
                "TEMP.MixMaster",
                "Wizard Spider"
            ],
            "source_name": "ETDA:Wizard Spider",
            "tools": [
                "AdFind",
                "Agentemis",
                "Anchor_DNS",
                "BEERBOT",
                "BazarBackdoor",
                "BazarCall",
                "BazarLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "Conti",
                "Diavol",
                "Dyranges",
                "Dyre",
                "Dyreza",
                "Dyzap",
                "Gophe",
                "Invoke-SMBAutoBrute",
                "KEGTAP",
                "LaZagne",
                "LightBot",
                "PowerSploit",
                "PowerTrick",
                "PsExec",
                "Ryuk",
                "SessionGopher",
                "TSPY_TRICKLOAD",
                "Team9Backdoor",
                "The Trick",
                "TheTrick",
                "Totbrick",
                "TrickBot",
                "TrickLoader",
                "TrickMo",
                "Upatre",
                "bazaloader",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bc119938-a79c-4e5f-9d4d-dc96835dfe2e",
            "created_at": "2024-06-04T02:03:07.799286Z",
            "updated_at": "2025-03-27T02:05:17.337094Z",
            "deleted_at": null,
            "main_name": "GOLD BLACKBURN",
            "aliases": [
                "Periwinkle Tempest ",
                "Wizard Spider ",
                "ITG23 "
            ],
            "source_name": "Secureworks:GOLD BLACKBURN",
            "tools": [
                " Buer Loader",
                " Dyre",
                " Team9",
                " TrickBot",
                "BazarLoader"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535838,
    "ts_updated_at": 1743041627,
    "ts_creation_date": 1653705376,
    "ts_modification_date": 1653705376,
    "files": {
        "pdf": "https://archive.orkl.eu/d4f3f86e0186ac00e154928b052a2e8c5a078ff3.pdf",
        "text": "https://archive.orkl.eu/d4f3f86e0186ac00e154928b052a2e8c5a078ff3.txt",
        "img": "https://archive.orkl.eu/d4f3f86e0186ac00e154928b052a2e8c5a078ff3.jpg"
    }
}