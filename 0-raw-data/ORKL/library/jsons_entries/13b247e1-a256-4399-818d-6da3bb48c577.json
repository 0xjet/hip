{
    "id": "13b247e1-a256-4399-818d-6da3bb48c577",
    "created_at": "2023-01-12T14:59:59.714388Z",
    "updated_at": "2025-03-27T02:09:30.453992Z",
    "deleted_at": null,
    "sha1_hash": "bc2d0debe6c574a984c6af2c6deee3df2feb8eef",
    "title": "2021-02-09 - Extracting the Cobalt Strike Config from a TEARDROP Loader",
    "authors": "",
    "file_creation_date": "2022-05-28T19:14:37Z",
    "file_modification_date": "2022-05-28T19:14:37Z",
    "file_size": 1268271,
    "plain_text": "# Extracting the Cobalt Strike Config\n\n**[blog.securehat.co.uk/malware-analysis/extracting-the-cobalt-strike-config-from-a-teardrop-loader](https://blog.securehat.co.uk/malware-analysis/extracting-the-cobalt-strike-config-from-a-teardrop-loader)**\n\nExtracting the Cobalt Strike Config from a TEARDROP Loader\n\nThis blog post will cover how to use dynamic analysis to extract the underlying Cobalt Strike\nconfig from a recent TEARDROP sample\n\nIntroduction\n\nDuring the analysis of the SolarWinds supply chain compromise in 2020, a second-stage\npayload was identified and dubbed TEARDROP. Analysis of the discovered samples showed\n[that TEARDROP ultimately loaded a Cobalt Strike beacon into memory. A good overview of](https://www.cobaltstrike.com/)\nthe SolarWinds supply chain attack and follow on compromise activity can be found here:\n\nSunburst: Supply Chain Attack Targets SolarWinds Users\n\nsymantec\n\nDespite wide discussion and coverage in security industry, actual samples of the\nTEARDROP malware were not initially made publicly accessible. However on 05-02-2021,\nthe two TEARDROP samples referenced in the Symantec blog above were uploaded to\nVirusTotal.\n\n[For the remainder of this blog post we will analyse one of the uploaded TEARDROP samples](https://www.virustotal.com/gui/file/b820e8a2057112d0ed73bd7995201dbed79a79e13c79d4bdad81a22f12387e07/detection)\nwith the goal of extracting the underlying Cobalt Strike config.\nThis blog post is not an exhaustive analysis of the TEARDROP loader and its behaviour, it\nfocuses purely on extracting the Cobalt Strike beacon and the associated config information.\n\nAnalysis of the TEARDROP Sample\n\nInitial Analysis\n\nLoading the sample into PEStudio we can see that we're dealing with a 64bit DLL with a lot\nof DLL exports:\n\n\n-----\n\nThe high number of DLL exports makes it slightly more challenging to move onto dynamic\nanalysis as we first need to identify which export we want to analyse. To keep this blog post\ndigestible, we will skip this step for now and instead we can use the information provided in\nthe Symantec report (as linked above) to give us the correct DLL export for the starting point\nof our analysis: `Tk_CreateImageType`\n\nHow to Analyse a Specific DLL Export in x64dbg\n\nNow that we know we want to analyse the `Tk_CreateImageType export, we need to get to`\nthat location in our favourite debugging tool. This is a little more challenging to do with a DLL\nas we can't directly call the export using x64dbg, but fortunately it's still easy enough to\nachieve with the following steps:\n\n1. 1.\n\nOpen `rundll32.exe in x64dbg`\n\n2. 2.\n\nConfigure x64dbg to automatically break on DLL entry\n\n3. 3.\n\nConfigure the rundll32.exe command line arguments to call our DLL and desired export\n\n4. 4.\n\nBreakpoint on the entrypoint of our desired DLL export and run until we get to that\nlocation\n\n\n-----\n\nFirst of all we re going to open `rundll32.exe in x64dbg (File -> Open ->`\n```\nC:\\Windows\\System32\\rundll32.exe ) and then also configure x64dbg to automatically\n\n```\npause on every DLL entry point (Options -> Preferences -> DLL Entry):\n\nNow we can change the command line arguments passed to `rundll32.exe so that when`\nit's launched it will execute our DLL at the `Tk_CreateImageType export. To do this go to`\nFile -> Change Command Line:\n\n\n-----\n\nAfter hitting OK, and restarting the debugging process (Debug -> Restart), we can now\nallow execution to proceed knowing that x64dbg will automatically breakpoint at the\nentrypoint of every DLL, including our target DLL. Keep pressing F9 (or Debug -> Run) while\nkeeping an eye on current DLL location listed in the bottom bar of x64ddb until we see that\nwe've hit our target DLL (teardrop.dll in this case):\n\nIn the screenshot above we can see that we've successfully hit `teardrop.dll in x64dbg`\nand specifically we are at the first TLS Callback of the DLL. Thread Local Storage (TLS)\ncallbacks execute before the main entry point of PE files and have both legitimate and nonlegitimate use-cases. Some malware samples have been known to leverage TLS Callbacks\nas a way to check if the process is being analysed before the main execution of the sample\nis reached:\n\nhttps://www.fireeye.com/blog/threat-research/2013/02/the-number-of-the-beast.html\n\nwww.fireeye.com\n\nFor now we will move past the TLS callbacks and circle back later on if we need to dig\ndeeper into the sample. Keep pressing F9 until we reach `DLLMain of` `teardrop.dll :`\n\nNow that we're in the target DLL, all we need to do is breakpoint on the\n```\nTk_CreateImageType export. To do this we can go to the Symbols tab, select\nteardrop.dll in the left pane and then right click on the correct export in the right pane\n\n```\nand select `Toggle Breakpoint :`\n\nFinally we can once again allow debugging to continue (Debug -> Run) until the status bar in\nthe bottom of the x64dbg window shows that we've reached the start of the\n```\nTk_CreateImageType export:\n\n```\n\n-----\n\nAt this point you may want to change the preferences of x64dbg so that it no longer breaks\non every DLL entry, this will make debugging easier and we can easily jump back to the\nCreateImageType export now that we have a breakpoint set.\n\nTracking Memory Activity\n\nAs mentioned at the start of this blog post, the main aim of the TEARDROP loader is to load\na Cobalt Strike beacon into memory on the victim machine. Using this knowledge we can\nmake an assumption that by breakpointing on memory related API calls we should hopefully\nbe able to find the Cobalt Strike beacon being loaded into memory.\n\nTo start off this analysis route, we will set breakpoints on the following APIs:\n\n**VirtualAlloc - allocate memory regions in the current process**\n\n**VirtualProtect - used to change the protection on a memory region**\n\n**VirtualQuery - gather information about a memory region in the current process**\n\n**VirtualFree - releases a memory region in the current process**\n\nIf suspect that a sample may do some form of process injection, we may also want to set\nbreakpoints on APIs such as VirtualAllocEx, OpenProcess, CreateRemoteThread,\n**CreateProcessInternalW etc. However for this sample these breakpoints won't be**\nnecessary.\n\nThe easiest way to do this is to type `bp <API> in the command window towards the bottom`\nof the x64dbg window:\n\nNow that we have our breakpoints set, the initial plan is to follow the steps below:\n\n1. 1.\n\nBreak on calls to VirtualAlloc\n\n2. 2.\n\nTrack the allocated memory regions returned by the API call\n\n3. 3.\n\nInspect these regions as execution continues to identify interesting content being\nloaded into memory\n\n\n-----\n\nIn its default configuration Cobalt Strike beacons are loaded into memory in the form of a PE\nfile, so by tracking the contents of allocated memory regions we should hopefully be able to\nspot the Cobalt Strike PE file being loaded into memory prior to execution.\n\nTracking the Memory Regions Allocated by VirtualAlloc\n\nAllow the execution of the program to continue until we hit the first instance of\n```\nVirtualAlloc being called:\n\n```\nInspecting the [documentation for](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) `VirtualAlloc shows us that the return value of a`\nsuccessful call is the \"base address of the allocated region of pages\". By clicking `Debug ->`\n```\nReturn to User Code after the breakpoint on VirtualAlloc we can allow the API call to\n\n```\ncomplete and the base address of the new memory region should be now be stored in the\nRAX register. We can follow this memory region by right clicking on the RAX register and\nselecting \"Follow in Dump\":\n\n\n-----\n\nAfter clicking on Follow in dump we can see the allocated memory region in the x64dbg\ndump window towards the bottom on the screen:\n\nAs we allow the execution of the program to continue we should see the contents of this\nmemory region change, and hopefully we will see a PE file appear in this window relating to\nthe Cobalt Strike beacon. If we hit subsequent `VirtualAlloc calls, we can follow the`\nsame process as above and track the regions in the different dump tabs.\n\nAfter allowing the execution of the program to continue, tracking a number of allocated\nmemory regions, and allowing execution to continue over a number of `VirtualProtect`\nbreakpoints, we can spot the start of a PE file in one of the memory regions:\n\nDumping the PE File to Disk\n\nAlmost any time we see a PE file being loaded into memory during malware analysis, it's\nworth dumping it to disk and analysing it further. In this case we're hoping that this is our\nCobalt Strike beacon, so to progress the analysis of this sample we can dump this region of\nmemory to disk.\n\nTo do this we can do the following:\n\n1. 1.\n\nRight click on the desired memory region in the dump tab\n\n\n-----\n\n2. 2.\n\nClick \"Follow In Memory Map\"\n\n3. 3.\n\nIn the new window that appears, right click on the highlighted memory region\n\n4. 4.\n\nClick \"Dump Memory to File\"\n\n\n-----\n\nNow that we have the PE file on disk, the final step is to attempt to extract the Cobalt Strike\nconfig information so that we can identify IOCs and configuration information. Although we\nhaven't confirmed that this PE file is definitely a Cobalt Strike beacon at this point, it's a safe\nbet when we take into account that the Symantec blog post reported that the sample will\nultimately load a beacon into memory.\n\nFortunately it's very easy to check by using Sentinal One's Cobalt Strike config extractor:\n\nGitHub - Sentinel-One/CobaltStrikeParser\n\nGitHub\n\nInspecting the parser code we can see that it looks for one of three byte patterns in order to\nidentify the presence of a Cobalt Strike config. If any of the byte patterns are found, then the\nparser will attempt to decode and print the configuration information of the Cobalt Strike\nbeacon. The byte patterns that the parser looks for are:\n\n1\n\nSTART_PATTERNS = {\n\n2\n\n3: b'\\x69\\x68\\x69\\x68\\x69\\x6b..\\x69\\x6b\\x69\\x68\\x69\\x6b..\\x69\\x6a',\n\n3\n\n4: b'\\x2e\\x2f\\x2e\\x2f\\x2e\\x2c..\\x2e\\x2c\\x2e\\x2f\\x2e\\x2c..\\x2e'\n\n4\n\n}\n\n5\n\nSTART_PATTERN_DECODED =\nb'\\x00\\x01\\x00\\x01\\x00\\x02..\\x00\\x02\\x00\\x01\\x00\\x02..\\x00'\n\nCopied!\n\nThe first two patterns reflect the two different XOR keys used in version 3 (0x69) and version\n4 (0x2e).\n\nRunning the parser over the PE file that we extracted from the TEARDROP sample confirms\nthat the file is a Cobalt Strike beacon and that we can successfully extract the config:\n\n1\n\n\n-----\n\n-> % python parse_beacon_config.py teardrop_pefile.bin\n\n2\n\nBeaconType - HTTPS\n\n3\n\nPort - 443\n\n4\n\nSleepTime - 14400000\n\n5\n\nMaxGetSize - 1049217\n\n6\n\nJitter - 23\n\n7\n\nMaxDNS - 255\n\n8\n\nC2Server - infinitysoftwares[.]com,/files/information_055.pdf\n\n9\n\nUserAgent - Not Found\n\n10\n\nHttpPostUri - /wp-admin/new_file.php\n\n11\n\nMalleable_C2_Instructions - Remove 313 bytes from the end\n\n12\n\nRemove 324 bytes from the beginning\n\n13\n\nXOR mask w/ random key\n\n\n-----\n\n14\n\nHttpGet_Metadata - Not Found\n\n15\n\nHttpPost_Metadata - Not Found\n\n16\n\nSpawnTo - b'\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00'\n\n17\n\nPipeName \n18\n\nDNS_Idle - 208.67.220.220\n\n19\n\nDNS_Sleep - 0\n\n20\n\nSSH_Host - Not Found\n\n21\n\nSSH_Port - Not Found\n\n22\n\nSSH_Username - Not Found\n\n23\n\nSSH_Password_Plaintext - Not Found\n\n24\n\nSSH_Password_Pubkey - Not Found\n\n25\n\nHttpGet_Verb - GET\n\n26\n\n\n-----\n\nHttpPost_Verb - POST\n\n27\n\nHttpPostChunk - 0\n\n28\n\nSpawnto_x86 - %windir%\\syswow64\\print.exe\n\n29\n\nSpawnto_x64 - %windir%\\sysnative\\msiexec.exe\n\n30\n\nCryptoScheme - 0\n\n31\n\nProxy_Config - Not Found\n\n32\n\nProxy_User - Not Found\n\n33\n\nProxy_Password - Not Found\n\n34\n\nProxy_Behavior - Use IE settings\n\n35\n\nWatermark - 943010104\n\n36\n\nbStageCleanup - True\n\n37\n\nbCFGCaution - False\n\n38\n\nKillDate - 0\n\n\n-----\n\n39\n\nbProcInject_StartRWX - False\n\n40\n\nbProcInject_UseRWX - False\n\n41\n\nbProcInject_MinAllocSize - 8493\n\n42\n\nProcInject_PrependAppend_x86 - b'\\x90\\x90'\n\n43\n\nEmpty\n\n44\n\nProcInject_PrependAppend_x64 - b'\\x0f\\x1f\\x00'\n\n45\n\nEmpty\n\n46\n\nProcInject_Execute - ntdll:RtlUserThreadStart\n\n47\n\nCreateThread\n\n48\n\nNtQueueApcThread\n\n49\n\nSetThreadContext\n\n50\n\nProcInject_AllocationMethod - NtMapViewOfSection\n\n51\n\n\n-----\n\nbUsesCookies - True\n\n52\n\nHostHeader \nCopied!\n\nReferences\n\nSunburst: Supply Chain Attack Targets SolarWinds Users\n\nsymantec\n\nGitHub - Sentinel-One/CobaltStrikeParser\n\nGitHub\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-02-09 - Extracting the Cobalt Strike Config from a TEARDROP Loader.pdf"
    ],
    "report_names": [
        "2021-02-09 - Extracting the Cobalt Strike Config from a TEARDROP Loader.pdf"
    ],
    "threat_actors": [
        {
            "id": "b43e5ea9-d8c8-4efa-b5bf-f1efb37174ba",
            "created_at": "2022-10-25T16:07:24.36191Z",
            "updated_at": "2025-03-27T02:02:10.1909Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "Dark Halo",
                "Nobelium",
                "SolarStorm",
                "StellarParticle",
                "UNC2452"
            ],
            "source_name": "ETDA:UNC2452",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "70872c3a-e788-4b55-a7d6-b2df52001ad0",
            "created_at": "2023-01-06T13:46:39.18401Z",
            "updated_at": "2025-03-27T02:00:03.01553Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "DarkHalo",
                "StellarParticle",
                "NOBELIUM",
                "Solar Phoenix",
                "Midnight Blizzard"
            ],
            "source_name": "MISPGALAXY:UNC2452",
            "tools": [
                "SNOWYAMBER",
                "HALFRIG",
                "QUARTERRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "1d3f9dec-b033-48a5-8b1e-f67a29429e89",
            "created_at": "2022-10-25T15:50:23.739197Z",
            "updated_at": "2025-03-27T02:00:55.536417Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "UNC2452",
                "NOBELIUM",
                "StellarParticle",
                "Dark Halo"
            ],
            "source_name": "MITRE:UNC2452",
            "tools": [
                "Sibot",
                "Mimikatz",
                "Cobalt Strike",
                "AdFind",
                "GoldMax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f27790ff-4ee0-40a5-9c84-2b523a9d3270",
            "created_at": "2022-10-25T16:07:23.341684Z",
            "updated_at": "2025-03-27T02:02:09.74554Z",
            "deleted_at": null,
            "main_name": "APT 29",
            "aliases": [
                "APT 29",
                "ATK 7",
                "Blue Dev 5",
                "BlueBravo",
                "Cloaked Ursa",
                "CloudLook",
                "Cozy Bear",
                "Dark Halo",
                "Earth Koshchei",
                "Grizzly Steppe",
                "Group 100",
                "ITG11",
                "Iron Hemlock",
                "Iron Ritual",
                "Midnight Blizzard",
                "Minidionis",
                "Nobelium",
                "NobleBaron",
                "Operation Ghost",
                "Operation Office monkeys",
                "Operation StellarParticle",
                "SilverFish",
                "Solar Phoenix",
                "SolarStorm",
                "StellarParticle",
                "TEMP.Monkeys",
                "The Dukes",
                "UNC2452",
                "UNC3524",
                "Yttrium"
            ],
            "source_name": "ETDA:APT 29",
            "tools": [
                "7-Zip",
                "ATI-Agent",
                "AdFind",
                "Agentemis",
                "AtNow",
                "BEATDROP",
                "BotgenStudios",
                "CEELOADER",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobalt Strike",
                "CobaltStrike",
                "CosmicDuke",
                "Cozer",
                "CozyBear",
                "CozyCar",
                "CozyDuke",
                "Danfuan",
                "EnvyScout",
                "EuroAPT",
                "FatDuke",
                "FoggyWeb",
                "GeminiDuke",
                "Geppei",
                "GoldFinder",
                "GoldMax",
                "GraphDrop",
                "GraphicalNeutrino",
                "GraphicalProton",
                "HAMMERTOSS",
                "HammerDuke",
                "LOLBAS",
                "LOLBins",
                "LiteDuke",
                "Living off the Land",
                "MagicWeb",
                "Mimikatz",
                "MiniDionis",
                "MiniDuke",
                "NemesisGemina",
                "NetDuke",
                "OnionDuke",
                "POSHSPY",
                "PinchDuke",
                "PolyglotDuke",
                "PowerDuke",
                "QUIETEXIT",
                "ROOTSAW",
                "RegDuke",
                "Rubeus",
                "SNOWYAMBER",
                "SPICYBEAT",
                "SUNSHUTTLE",
                "SeaDaddy",
                "SeaDask",
                "SeaDesk",
                "SeaDuke",
                "Sharp-SMBExec",
                "SharpView",
                "Sibot",
                "Solorigate",
                "SoreFang",
                "TinyBaron",
                "WINELOADER",
                "WellMail",
                "WellMess",
                "cobeacon",
                "elf.wellmess",
                "reGeorg",
                "tDiscoverer"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535599,
    "ts_updated_at": 1743041370,
    "ts_creation_date": 1653765277,
    "ts_modification_date": 1653765277,
    "files": {
        "pdf": "https://archive.orkl.eu/bc2d0debe6c574a984c6af2c6deee3df2feb8eef.pdf",
        "text": "https://archive.orkl.eu/bc2d0debe6c574a984c6af2c6deee3df2feb8eef.txt",
        "img": "https://archive.orkl.eu/bc2d0debe6c574a984c6af2c6deee3df2feb8eef.jpg"
    }
}