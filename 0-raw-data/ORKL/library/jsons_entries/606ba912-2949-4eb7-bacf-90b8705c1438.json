{
    "id": "606ba912-2949-4eb7-bacf-90b8705c1438",
    "created_at": "2023-01-12T15:08:39.478847Z",
    "updated_at": "2025-03-27T02:05:57.82457Z",
    "deleted_at": null,
    "sha1_hash": "9871fa3549363d96cce3347cb237dc3129eee181",
    "title": "2022-10-31 - A Technical Analysis of Pegasus for Android - Part 3",
    "authors": "",
    "file_creation_date": "2022-11-28T18:57:42Z",
    "file_modification_date": "2022-11-28T18:57:42Z",
    "file_size": 6052871,
    "plain_text": "# A technical analysis of Pegasus for Android – Part 3\n\n**[cybergeeks.tech/a-technical-analysis-of-pegasus-for-android-part-3/](https://cybergeeks.tech/a-technical-analysis-of-pegasus-for-android-part-3/)**\n\nSummary\n\nPegasus is a spyware developed by the NSO group that was repeatedly analyzed\nby [Amnesty International and](https://www.amnesty.org/en/latest/research/2021/07/forensic-methodology-report-how-to-catch-nso-groups-pegasus/) [CitizenLab. In this article, we dissect the Android version that](https://citizenlab.ca/2020/12/the-great-ipwn-journalists-hacked-with-suspected-nso-group-imessage-zero-click-exploit/)\n[was initially analyzed by Lookout in this paper, and we recommend reading it along with this](https://info.lookout.com/rs/051-ESQ-475/images/lookout-pegasus-android-technical-analysis.pdf)\npost. During our research about Pegasus for Android, we’ve found out that vendors wrongly\n[attributed some undocumented APK files to Pegasus, as highlighted by a researcher here.](https://twitter.com/maldr0id/status/1492520053702602755)\nWe’ve splitted the analysis into 3 parts because of the code’s complexity and length. We’ve\nalso tried to keep the sections name proposed by Lookout whenever it was possible so that\nanybody could follow the two approaches more easily. In this last part, we’re presenting the\nWAP Push messages that could be used to autoload content on the phone without user\ninteraction, the C2 communication over the MQTT protocol, the exploitation of a vulnerability\nin MediaPlayer that was not disclosed before, and the ability of the spyware to track phone’s\n[locations. You can consult the second part of the Pegasus analysis here.](https://cybergeeks.tech/a-technical-analysis-of-pegasus-for-android-part-2/)\n\n**Analyst:** [@GeeksCyber](https://twitter.com/GeeksCyber)\n\nTechnical analysis\n\nSHA256: ade8bef0ac29fa363fc9afd958af0074478aef650adeb0318517b48bd996d5d5\n\n**Pegasus initialization**\n\nThe agent extracts the Android version, a string that uniquely identifies the build, and tries to\nretrieve a configuration value called “isItFirstRunEver” that indicates if this is the first run of\nthe malware:\n\nFigure 1\nThe process verifies whether the “/data/data/com.network.android” directory exists on the\ndevice; otherwise, it is created. The existence of the directory means that this is not the first\nexecution of the malware, and the “isItFirstRunEver” value is set to false using the\nputBoolean function:\n\n\n-----\n\nFigure 2\n\nIt checks the existence of the malicious APK file on the phone and will use the superuser\nbinary called “/system/csk” to run commands with root privileges:\n\nFigure 3\nA check for an antidote file called “/sdcard/MemosForNotes” is performed, and the spyware\nremoves itself if this file is found (see figure 4).\n\n\n-----\n\nFigure 4\n\n[The agent calls multiple functions that steal information from the targeted applications, as](https://cybergeeks.tech/a-technical-analysis-of-pegasus-for-android-part-1/)\nshown in the figure below.\n\nFigure 5\n\nA value called “screen_off_timeout”, which represents the number of milliseconds before the\ndevice goes to sleep or begins to dream after inactivity, is extracted by the process and is\ncompared with 15 seconds. Other configuration values such as\n“wasPhoneWasUnmutedAfterTapNicly” [sic], “originalVibrateValue”, and\n“originalRingerValue” are also extracted from configuration:\n\n\n-----\n\nFigure 6\n**WAP Push Messages**\n\nThe process logs a message that indicates a change in the WAP settings:\n\nFigure 7\n\nIt retrieves the file permissions of\n“/data/data/com.android.mms/shared_prefs/com.android.mms_preferences.xml” and\nchanges them using the chmod command:\n\nFigure 8\n\nFigure 9\n\n\n-----\n\nFigure 10\nThe LD_LIBRARY_PATH environment variable is modified, and the above file’s permissions\nare set to read & write (0666):\n\nFigure 11\nThe agent changes the WAP settings to enable push messages, as highlighted in the figure\nbelow.\n\nFigure 12\nThe malware verifies if the Build.FINGERPRINT value contains “JPKJ2”, and it stops the\nMessages app:\n\nFigure 13\nThe superuser binary called “/system/csk” is expected to be found on the phone (see figure\n14).\n\nFigure 14\n\n\n-----\n\nThe malicious process checks for the existence of the SMS/MMS database at\n“/data/data/com.android.providers.telephony/databases/mmssms.db”:\n\nFigure 15\nThe permissions of the “mmssms.db”, “mmssms.db-shm”, and “mmssms.db-wal” databases\nare changed to 0777 (read, write, & execute for owner, group and others):\n\n\n-----\n\nFigure 16\n\nFigure 17\n\n\n-----\n\nFigure 18\nThe agent opens one of the above databases and runs the following SQL query via a\nfunction call to rawQuery:\n\nFigure 19\nThe index of the “href”, “_id”, “read”, “seen”, and “thread_id” columns is extracted:\n\n\n-----\n\nFigure 20\nThe spyware tries to delete some WAP push messages that could be used to automatically\nopen a link in a browser on the phone without user interaction:\n\n\n-----\n\nFigure 21\n\n\n-----\n\nFigure 22\nThe WAP messages are deleted by calling the SQLiteDatabase.delete method:\n\n\n-----\n\nFigure 23\n\n\n-----\n\nFigure 24\n**Message Queue Telemetry Transport (MQTT)**\n\nAnother way to communicate with the command and control infrastructure is using the MQTT\nprotocol.\n\nThe “should_use_mqtt” configuration value establishes whether the agent is allowed to\ncommunicate with the C2 servers via MQTT, as shown below:\n\nFigure 25\n\n\n-----\n\nAnother config value called mqttAllowedConnectionType indicates if the phone is allowed to\ncommunicate via MQTT while it’s connected to Wi-Fi (value = 1), mobile data (value = 4), or\nwhen the device is roaming (value = 8):\n\nFigure 26\n\nThe malware retrieves connection status information about all network types via a function\ncall to getAllNetworkInfo and compares the type of the network with “WIFI” and “MOBILE”:\n\nFigure 27\n\n\n-----\n\nThe isNetworkRoaming function is utilized to verify whether the phone is roaming:\n\nFigure 28\n\nFigure 29\nThe application extracts the current date and ensures that the token id found in the\nconfiguration is not null:\n\nFigure 30\n\nThe following values are obtained from the configuration:\n\nmqttIdPref – identify a client in combination with the username\n\nmqttQos – quality of service for MQTT connections\n\nmqttHost – attacker’s MQTT host\n\nmqttPort – MQTT port number\n\n\nFigure 31\n\n\n-----\n\nThe mqttUsername config value represents the username used during the authentication\nwith the MQTT server, and the “mqttPassword” value is the password used during the\nauthentication process:\n\nFigure 32\nThe malware logs a message containing the MQTT URL, username, and password and then\ncalls a function that will start the communication:\n\nFigure 33\nThe MQTT broker URL is constructed by the malicious process:\n\nFigure 34\nThe “mqttKaTimer” configuration value represents the MQTT keep alive timer (see figure 35).\n\n\n-----\n\nFigure 35\n\nFinally, the process makes network connections with the attacker’s infrastructure over MQTT\nand compares the broker URL with “tcp://”, “ssl://”, and “local://”:\n\nFigure 36\n\n\n-----\n\nFigure 37\nThe maximum number of reconnection attempts is stored in a configuration value called\n“mqttRecCount”:\n\n\n-----\n\nFigure 38\nThe agent tries to subscribe to an MQTT topic specified in the configuration, as highlighted in\nfigure 39.\n\n\n-----\n\nFigure 39\nThe application logs multiple messages that indicate the successful connection and the\nsubscription to the topic:\n\n\n-----\n\nFigure 40\nThe NetworkInfo.isConnected method is used to verify whether there is an active internet\nconnection on the device:\n\n\n-----\n\nFigure 41\nThe binary receives the messages from within the topic on the broker that contain\ncommands to be executed:\n\nFigure 42\n[All commands are added to a queue as we already described in part 2:](https://cybergeeks.tech/a-technical-analysis-of-pegasus-for-android-part-2/)\n\n\n-----\n\nFigure 43\nThe parameter “s=” contains a checksum that will be checked against another computed\nvalue in order to confirm that the command was transmitted by the threat actor:\n\n\n-----\n\nFigure 44\nThe command transmitted via MQTT contains a token value that identifies the infected\ndevice, as displayed in the figure below.\n\n\n-----\n\nFigure 45\nThe command will not be executed if the checksums don’t match:\n\n\n-----\n\nFigure 46\n[The commands received via SMS that we already described here can be also transmitted](https://cybergeeks.tech/a-technical-analysis-of-pegasus-for-android-part-2/)\nusing the MQTT protocol:\n\n\n-----\n\nFigure 47\n**Email attachments**\n\nThe emailAttCmdcommand can be used to retrieve emails and attachments from the\nEmailProviderBody.db database:\n\n\n-----\n\nFigure 48\n\n\n-----\n\nFigure 49\n**Download files**\n\nThe malware has the ability to download additional files/packages from a remote URL (see\nfigure 50).\n\n\n-----\n\nFigure 50\nThe process opens a connection to a specific URL using the openConnection function and\nsets the read timeout to 120s and the connect timeout to 1800s:\n\n\n-----\n\nFigure 51\nThe response body is read by calling the URLConnection.getInputStream and\nBufferedInputStream.read functions:\n\n\n-----\n\nFigure 52\nA file is populated with the buffer downloaded from the remote URL via a call to\nFileOutputStream.write:\n\n\n-----\n\nFigure 53\n**Vulnerability exploitation in MediaPlayer**\n\nTo the best of our knowledge, this is the first mention that Pegasus for Android exploited a\nvulnerability in MediaPlayer. Unfortunately, the file responsible for exploitation called\n“/data/data/com.network.android/output.mp3” is empty, and we couldn’t retrieve its content:\n\n\n-----\n\nFigure 54\nThe MP3 file is populated at runtime using the FileOutputStream.write function. The file’s\npermissions are set to 511 by the malware:\n\nFigure\n\n55\n\nFigure 56\nThe setDataSource method is utilized to set the data source for MediaPlayer. The application\nprepares and starts the playback, which we believe would result in exploiting a vulnerability:\n\nFigure 57\n\n**Track phone’s location**\n\nPegasus spyware has the ability to monitor the device’s location. It verifies if the GPS\nprovider is active by calling the isProviderEnabled function and then obtains location\ninformation using the requestLocationUpdates function:\n\n\n-----\n\nFigure 58\nThe location is stored in an XMLSerializer object containing the latitude, the longitude, the\naltitude of the location, the estimated horizontal accuracy radius, and the speed at the time of\nthe location:\n\nFigure 59\n\n\n-----\n\nFigure 60\nThe process retrieves the current location of the device via a call to getCellLocation and the\nnumeric name (MCC+MNC) of the current registered operator using getNetworkOperator.\nThe GSM cell id and the GSM location area code are also stored in the XMLSerializer object:\n\nFigure 61\n\nFigure 62\n\n\n-----\n\nFigure 63\n**Other relevant activities**\n\nThe agent compares the Android version with 2.3 and then the phone model with a list, as\nshown below:\n\n\n-----\n\nFigure 65\n\n\n-----\n\n[As we already described in part 1, the malware has the capability to upgrade itself:](https://cybergeeks.tech/a-technical-analysis-of-pegasus-for-android-part-1/)\n\nFigure 66\nThe application obtains the serial number of the SIM and extracts the “local” configuration\nvalue:\n\n\n-----\n\nFigure 67\nThe “NetworkWindowSim” config value is extracted and compared with the value described\nabove. If these two values don’t match, it means that the SIM was changed, and the config\nvalue is changed accordingly (see figure 68).\n\n\n-----\n\nFigure 68\nThe spyware verifies if the “/data/reinslock” file exists on the device, which indicates that the\napplication was reinstalled:\n\n\n-----\n\nFigure 69\nAs we’ve seen during the entire analysis, the threat actor didn’t make any efforts to hide the\ntrue purpose of the APK. Figure 70 reveals the message stating that Pegasus was\nsuccessfully initialized:\n\nFigure 70\nThis concludes our 3-part analysis of Pegasus for Android. We believe that some of the\nfunctionalities presented here are also used by recent malware families, and our analysis\nmight represent the first step in detecting them.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-10-31 - A Technical Analysis of Pegasus for Android - Part 3.pdf"
    ],
    "report_names": [
        "2022-10-31 - A Technical Analysis of Pegasus for Android - Part 3.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536119,
    "ts_updated_at": 1743041157,
    "ts_creation_date": 1669661862,
    "ts_modification_date": 1669661862,
    "files": {
        "pdf": "https://archive.orkl.eu/9871fa3549363d96cce3347cb237dc3129eee181.pdf",
        "text": "https://archive.orkl.eu/9871fa3549363d96cce3347cb237dc3129eee181.txt",
        "img": "https://archive.orkl.eu/9871fa3549363d96cce3347cb237dc3129eee181.jpg"
    }
}