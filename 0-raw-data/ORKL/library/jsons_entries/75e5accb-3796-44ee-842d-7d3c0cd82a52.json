{
    "id": "75e5accb-3796-44ee-842d-7d3c0cd82a52",
    "created_at": "2022-10-25T16:48:23.182308Z",
    "updated_at": "2025-03-27T02:16:59.328768Z",
    "deleted_at": null,
    "sha1_hash": "99f8d948b133c10f03dc642ffdefc72ec6ef4cf5",
    "title": "",
    "authors": "",
    "file_creation_date": "2016-08-25T11:01:41Z",
    "file_modification_date": "2016-08-25T11:01:47Z",
    "file_size": 1956302,
    "plain_text": "# Technical Analysis of Pegasus Spyware\n\n##### An Investigation Into Highly Sophisticated Espionage Software\n\n\n-----\n\n### Contents\n\n###### Executive Summary\n\nBackground\n\nDisclosure Timeline\n\n###### Attack Overview\n\nProfessional Grade Development\n\nEvolution of Software\n\n###### The Trident Vulnerabilities\n\nCVE-2016-4655: Memory Corruption in Safari Webkit\n\nCVE-2016-4656: Kernel Information Leak Circumvents KASLR\n\nCVE-2016-4657: Memory Corruption in Kernel leads to Jailbreak\nJailbreak Persistence\n\n###### Spyware Analysis\n\nInstallation and Persistence\n\nPersistence: JSC Privilege Escalation\n\nDisabling Updates\n\nJailbreak Detection\n\nDevice Monitoring\n\nStealth Update to Command & Control Infrastructure\n\nSelf Destruction\n\nData Gathering\n\nCalendar\n\nContacts\n\nGPS location\n\nCapturing User Passwords\n\nWiFi and Router Passwords\n\nInterception of Calls and Messages\n\nProcess Injection: converter\n\nSkype\n\nTelegram\n\nWhatsApp\nViber\n\nReal-Time Espionage\n\n###### Conclusion\n\nCredits\n\nAppendix A: TLS Certificate Information\n\nAppendix B: IOCs for Jailbreak Detection\n\n\n-----\n\n### Executive Summary\n\n\n## T\n\n\nhis report is an in-depth technical look at a targeted espionage attack being actively leveraged against an\n\nundetermined number of mobile users around the world. Lookout researchers have done deep analysis on\n\n[a live iOS sample of the malware, detailed in this report. Citizen Lab’s investigation links the software and](https://citizenlab.org/2016/08/million-dollar-dissident-iphone-zero-day-nso-group-uae/)\n\n\ninfrastructure to that of NSO Group which offers a product called Pegasus solution. Pegasus is professionally developed\n\nand highly advanced in its use of zero-day vulnerabilities, code obfuscation, and encryption. It uses sophisticated func\ntion hooking to subvert OS- and application-layer security in voice/audio calls and apps including Gmail, Facebook,\n\nWhatsApp, Facetime, Viber, WeChat, Telegram, Apple’s built-in messaging and email apps, and others. It steals the victim’s\n\ncontact list and GPS location, as well as personal, Wi-Fi, and router passwords stored on the device. The iOS version of the\n\nattack uses what we refer to as Trident, an exploit of three related zero-day vulnerabilities in iOS, which Apple patched in\n\niOS 9.3.5, available as of the publishing of this report.\n\nAccording to news reports, NSO Group sells weaponized software that targets mobile phones to governments and has\n\nbeen operating since 2010, according to its LinkedIn page. The Pegasus spyware has existed for a significant amount of\n\ntime, and is advertised and sold for use on high-value targets for multiple purposes, including high-level espionage on\n\niOS, Android, and Blackberry.\n\nThis spyware is extremely sophisticated and modular, in addition to allowing customization. It uses strong encryption to\n\nprotect itself from detection by traditional security tools and has a vigorous monitoring and self-destruct mechanism.\n\nLookout’s analysis determined that the malware exploits three zero-day vulnerabilities, Trident, in Apple’s iOS:\n\n**1.** **CVE-2016-4655: Memory Corruption in Webkit - A vulnerability in Safari WebKit allows the attacker to compro-**\n\nmise the device when the user clicks on a link.\n\n**2.** **CVE-2016-4656: Kernel Information Leak - A kernel base mapping vulnerability that leaks information to the**\n\nattacker that allows him to calculate the kernel’s location in memory.\n\n**3.** **CVE-2016-4657: Kernel Memory corruption leads to Jailbreak - 32 and 64 bit iOS kernel-level vulnerabilities that**\n\nallow the attacker to silently jailbreak the device and install surveillance software.\n\nThe attack sequence begins with a simple phishing scheme: send a text (or Twitter or other type of) message with a\n\nbenign-looking URL, user clicks on link, open web browser, load page, exploit a browser or operating system vulnerability,\n\ninstall software to gather information and to ensure that the software stays installed on the device (“persistence”). As soon\n\nas the targeted victim clicks the link, the attack occurs silently, with no indication to the user or device administrators that\n\nanything has occurred or that any new processes are running.\n\nThe Pegasus software is highly configurable: depending on the country of use and feature sets purchased by the user of\n\nthe spyware, the surveillance capabilities include remotely accessing text messages, iMessages, calls, emails, logs, and\n\nmore from apps including Gmail, Facebook, Skype, WhatsApp, Viber, Facetime, Calendar, Line, Mail.Ru, WeChat,\n\nSurespot, Tango, Telegram, and others.\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **3**\n\n\n-----\n\nBased on artifacts in the code, this spyware has been in the wild for more than two years. The exploits have configuration\n\nsettings that go all the way back to iOS 7, which was released in 2013 and superseded in 2014.\n\nPegasus takes advantage of how integrated mobile devices are in our lives and the combination of features only available\n\non mobile — always connected (WiFi, 3G/4G), voice communications, camera, email, messaging, GPS, passwords, and\n\ncontact lists. As a result of its functional modularity, the breadth of communications and user data it monitors, and the tai\nlored methods it instruments into other applications to exfiltrate data from them, to date, Pegasus is the most sophisticat\ned privately-developed attack Lookout has encountered on a mobile endpoint. It hooks into widely used secure messen\nger applications to copy cleartext data out of them before the user’s app can encrypt and send it. From the perspective\n\nof the user and the people they’re communicating with, their communications are secure, while the administrator of the\n\nPegasus instance has secretly intercepted the clear text of their communication. Pegasus carries a high price tag averaging at\n\nover $25,000 per target. In at least one instance, NSO Group sold 300 licenses for $8 million USD.[1]\n\nThis report presents the technical details of the attack from the beginning of the exploit chain to the end. It includes\n\nanalysis of the Trident zero-day iOS vulnerabilities that the toolkit was using to jailbreak the phone. We also look in-depth\n\nat the components of the espionage software, and have exposed the type of capabilities that an advanced mobile attack\ner using this software possesses.\n\nTrident (the vulnerabilities disclosed in coordination with this report) were present in the latest versions of iOS, up to iOS\n\n9.3.4, the latest iOS version as of August 2016 when we made these discoveries. Researchers from Lookout and Citizen\n\nLab responsibly disclosed the exploits and their related vulnerabilities to Apple. Given the severity of Trident,\n\nApple worked extremely quickly to patch these vulnerabilities and has released iOS 9.3.5 to address them. With the\n\nrelease of the patched OS, we are publishing the technical details of the attack and exploits.\n\n1 http://www.prensa.com/locales/ruta-pago-NSO-Group_0_4266323503.html\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **4**\n\n\n-----\n\n### Background\n\nAs mobile phones continue to be tightly integrated into our personal and work lives, malicious actors are actively creating\n\nsophisticated applications that can run on victims’ devices without either their knowledge of the threat’s presence, or of\n\nthe actors’ intent. This can be seen in the diversity of threats that target mobile devices: from those that are financially mo\ntivated, such as adware, banking trojans, and SMS fraud, to those seeking personal information or corporate intellectual\n\nproperty. Spyware, a malicious application designed to retrieve specific information from an infected device without the\n\nvictim’s knowledge, falls into the latter camp.\n\nSpyware applications often include the ability to extract a victim’s SMS messages, contact details, record their calls,\n\naccess their call logs, or remotely activate a device’s microphone and camera to surreptitiously capture audio, video,\n\nand image content.\n\nIn addition to these rich features, some spyware also has the equally important ability to remotely deliver the malicious\n\napplication to a target device. This is a complex and technically challenging problem, as evidenced by the amount of\n\n[money private security firms and corporate bug bounty programs pay for zero-day exploits that facilitate this remote](https://www.zerodium.com/ios9.html)\n\ndelivery.\n\nTwo private security firms, Gamma Group and Hacking Team, both made headlines after media outlets revealed that the\n\norganizations developed mobile surveillance software that has been sold to oppressive governments. These products are\n\noften very expensive and generally only accessible to well-funded attackers given the complexity involved in creating this\n\nkind of mobile spyware, and the fact that it includes zero-day exploits.\n\nThe Israeli based NSO Group has managed to avoid the spotlight of the cyber security community despite being in oper\nation for over five years. Founded in 2010 by Niv Carmi, Shalev Hulio, and Omri Lavie, NSO Group has publicly stated that\n\nit develops and sells mobile phone surveillance software to governments around the world. It has claimed that its surveil\nlance capability is undetectable with one of the founders stating, “We’re a complete ghost.” [2] Private equity firm Francisco\n\nPartners acquired NSO Group in 2014 for $110 million. The founders of NSO Group play in both the cyber offense and\n\ndefense spaces, having also founded the mobile security company Kaymera.[3]\n\n2 http://blogs.wsj.com/digits/2014/08/01/can-this-israeli-startup-hack-your-phone/\n3 http://www.bloomberg.com/news/2014-09-29/israeli-entrepreneurs-play-both-sides-of-the-cyber-wars.html\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **5**\n\n\n-----\n\n### Disclosure Timeline\n\nCitizen Lab reported the existence of the malware to Lookout on August 12, 2016. Lookout and Citizen Lab worked\n\ntogether to analyze the software and attempt to determine the severity of the vulnerabilities and the capabilities of the\n\nmalware until August 15, 2016 when we reported the information to Apple.\n\nThe three organizations worked together from August 15, 2016 to the release of the vulnerability patches in iOS 9.3.5 on\n\nAugust 25, 2016.\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **6**\n\n\n-----\n\n### Attack Overview\n\nThe attack is very simple in its delivery and silent in delivering its payload. The attack starts when the attacker sends a\n\nwebsite URL (through SMS, email, social media, or any other message) to an identified target. The user only has to take\n\none action--click on the link. Once the user clicks the link, the software silently carries out a series of exploits against the\n\nvictim’s device to remotely jailbreak it so that the espionage software packages can be installed. The user’s only indication\n\nthat anything happened will be that the browser closes after the link is clicked.\n\nThe espionage software contains malicious code, processes, and apps that are used to spy, collect data, and report back\n\nwhat the user does on the device. This spyware can access and exfiltrate messages, calls, emails, logs, and more from\n\napps including, but not limited to:\n\n     - Gmail\n\n     - Facetime\n\n     - Facebook\n\n     - Line\n\n     - Mail.Ru\n\n\n\n- Calendar\n\n- WeChat\n\n- Surespot\n\n- Tango\n\n- WhatsApp\n\n- Viber\n\n- Skype\n\n- Telegram\n\n\nCVE-2016-4655 Two kernel exploits\nExploit against Safari (CVE-2016-4656\n& CVE-2016-4657)\njailbreak the device\n\n\n1. Persistence and stealth monitoring\n\n2. Establishes communication\nto Command & Control\nInfrastructure\n\n3. Hooks all communication\nand starts stealing data\n\n\nIn order to accomplish this, the spyware, once it jailbreaks the user’s phone, does not download malicious versions of\n\nthese apps to the victim’s device in order to capture data, rather it compromises the original apps already installed on the\n\ndevice. This includes pre-installed apps such as Facetime and Calendar and those from the official App Store.\n\nUsually, iOS security mechanisms prevent normal apps from spying on each other, but spying “hooks” can be installed\n\non a jailbroken device. Pegasus takes advantage of both the remote jailbreak exploit and a technique called “hooking.”\n\nThe hooking is accomplished by inserting Pegasus’ dynamic libraries into the legitimate processes running on the device.\n\nThese dynamic libraries can be used to hook the apps using a framework called Cydia Mobile Substrate, known to the\n\niOS jailbreak community, and which Pegasus uses as part of the exploit.\n\nA user infected with this spyware is under complete surveillance by the attacker because, in addition to the apps listed\n\nabove, it also spies on:\n\n     - Phone calls\n\n     - Call logs\n\n     - SMS messages the victim sends or receives\n\n     - Audio and video communications that (in the words a founder of NSO Group) turns the phone into a “walkie-talkie”[4]\n\n4 http://www.ft.com/cms/s/9869fd34-c7ac-11e2-be27-00144feab7de,Authorised=false.html?siteedition=intl&_i_location=http%3A%2F%2Fwww.\nft.com%2Fcms%2Fs%2F0%2F9869fd34-c7ac-11e2-be27-00144feab7de.html%3Fsiteedition%3Dintl&_i_referer=&classification=conditional_standard&iab=barrier-app#axzz4I8PLStjS\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **7**\n\n\n-----\n\nAccess to this content could be used to gain further access into other accounts owned by the target, such as banking,\n\nemail, and other services he/she may use on or off the device.\n\nThe attack is comprised of three separate stages that contain both the exploit code and the espionage software. The\n\nstages are sequential; each stage is required to successfully decode, exploit, install, and run the subsequent stage.\n\nEach stage leverages one of the Trident vulnerabilities in order to run successfully.\n\n**STAGE 1** **Delivery and WebKit vulnerability:** This stage comes down over the initial URL in the form of an HTML\n\nfile (1411194s) that exploits a vulnerability (CVE-2016-4655) in WebKit (used in Safari and other browsers).\n\n**STAGE 2** **Jailbreak: This stage is downloaded from the first stage code based on the device type (32-bit vs 64-**\n\nbit). Stage 2 is downloaded as an obfuscated and encrypted package. Each package is encrypted with unique keys\n\nat each download, making traditional network-based controls ineffective. It contains the code that is needed to\n\nexploit the iOS Kernel (CVE-2016-4656 and CVE-2016-4657) and a loader that downloads and decrypts a package\n\nfor stage 3.\n\n**STAGE 3** **Espionage software: This stage is downloaded by stage 2 and is also based on the device type (32-bit**\n\nvs 64-bit). Stage 3 contains the espionage software, daemons, and other processes that are used after the de\nvice has been jailbroken in stage 2. Stage 3 installs the hooks into the applications the attacker wishes to spy on.\n\nAdditionally, stage 3 detects if the device was previously jailbroken through another method and, if so, removes\n\nany access to the device that the jailbreak provides, such as via SSH. The software also contains a failsafe to remove\n\nitself if certain conditions are present.\n\nThe third stage deploys a number of files deployed in a standard unix tarball (test222.tar), each of which has its own pur\npose (that we describe later in this report):\n\n  - ca.crt - root TLS certificate that is added to keystore (see Appendix A)\n\n  - ccom.apple.itunesstored.2.csstore - Standalone javascript that is run from the command line at reboot and is used to\n\nrun unsigned code and jailbreak the kernel on device reboot\n\n  - converter - injects dylib in a process by pid. It is a renamed version of the cynject from the Cydia open-source\n\nlibrary\n\n  - libaudio.dylib - The base library for call recording\n\n  - libdata.dylib - A renamed version of the Cydia substrate open-source library\n\n  - libimo.dylib - Generic chat sniffer library\n\n  - libvbcalls.dylib - Viber sniffer\n\n  - libwacalls.dylib - Whatsapp sniffer\n\n  - lw-install - Spawns all sniffing services\n\n  - systemd - Sends reports and files to server\n\n  - watchdog\n\n  - workerd - SIP module\n\nThe attack we investigated works on iOS up to 9.3.4. The developers maintain a large table in their code that attacks\n\nall iOS versions from 7.0 up to and including iOS 9.3.3. While the code we investigated did not contain the appropriate\n\nvalues to initially work on iOS 9.3.4, the exploits we investigated would still work, and it is trivial for the attackers to update\n\nthe table so that the attack will work on 9.3.4.\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **8**\n\n\n-----\n\nOne other unique property of this attack is that standard jailbreak detections fail to report that the device has been ex\nploited. The attack and installation of the spying software is designed to be as silent as possible to the target.\n\n#### Professional Grade Development\n\nPegasus is well designed in terms of its modularity and efficiency. For example, the kernel exploits call upon magic tables\n\nfor each of the platforms that map out kernel memory for each version and phone model. The mapping for iOS 9.2.1 on\n\nthe iPhone 6 is shown here:\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **9**\n\n\n-----\n\nNote that each function location in memory (as an offset from the base of the kernel) is mapped. Each of these will be\n\nused later in the kernel version.\n\nAdditionally, the code is extremely modular, relative to other malware our researchers have encountered. We found com\nmon libraries and common formats with similar naming conventions. For example, the libwacalls (WhatsApp Call Library)\n\nand libvbcalls (Viber Call Library) use similar formats with similar function names and common standards. Unlike most\n\nmalware authors, the code in Pegasus is clean and efficient, with evidence of professional and careful design.\n\nFinally, we see evidence of a robust quality assurance process for their development: even their first stage exploit con\ntains both debugging and QA-specific functions of the type one would expect from an enterprise-class software develop\nment organization.\n\n#### Evolution of Software\n\nThe malware has been in operation for well over a year, which has enabled it to develop a degree of software maturity,\n\nand as a result it is capable of exploiting multiple iOS versions. An excerpt from the magic table that maps addresses in\n\nthe kernel shows that the exploit supports versions of the phone from the iPhone 4s up to the iPhone 6s Plus.\n\nThe kernel exploit includes checks that indicate that the exploit works against iOS 7 (which was released in 013):\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **10**\n\n\n-----\n\n### The Trident Vulnerabilities\n\nThe software contains multiple zero-day vulnerabilities, referred to here as Trident, used against iOS 9.3.3, each of which would have\n\nworked against current 9.3.4 as of the date of discovery. With the 9.3.5 patches, these vulnerabilities will no longer work.\n\n#### CVE-2016-4655: Memory Corruption in Safari Webkit\n\nA memory corruption vulnerability exists in Safari Webkit that allows an attacker to execute arbitrary code. Pegasus ex\nploits this vulnerability to obtain initial code execution privileges within the context of the Safari web browser.\n\nThis vulnerability is complex and Lookout continues to work on analyzing this vulnerability and will publish additional\n\nfindings as they become available.\n\n#### CVE-2016-4656: Kernel Information Leak Circumvents KASLR\n\nBefore Pegasus can execute its jailbreak, it must determine where the kernel is located in memory. Kernel Address Space\n\nLayout Randomization (KASLR) makes this task difficult by mapping the kernel into different and unpredictable locations\n\nin memory. In short, before attacking the kernel, Pegasus has to find it.\n\nThe attacker has found a way to locate the kernel by using a function call that leaks a non-obfuscated kernel memory\n\naddress in the return value, allowing the kernel’s actual memory location to be mapped.\n\n#### CVE-2016-4657: Memory Corruption in Kernel leads to Jailbreak\n\nThe third vulnerability in Pegasus’ Trident is the one that is used to jailbreak the phone. A memory corruption vulnerability\n\nin the the kernel is used to corrupt memory in both the 32- and 64-bit versions.  The exploits are performed differently on\n\neach version.\n\nThis vulnerability is complex and Lookout continues to work on analyzing this vulnerability and will publish additional\n\nfindings as they become available.\n\n#### Jailbreak Persistence\n\nOnce the kernel has been exploited, both exploits perform similar tasks to prepare the system to be jailbroken:\n\n- Disable kernel security protections including code signing\n\n- Remount the system partition\n\n- Clear the Safari caches (to help cover their tracks)\n\n- Write the jailbreak files (including the main loader as /sbin/mount_nfs)\n\nTo gain persistence, Pegasus replaces the system daemon rtbuddyd with a copy of the jsc binary and creates a link to a\n\nscript that is similar to the exploit for CVE-2016-4655, which we will describe later.\n\nAs a final step, the exploit removes /etc/nfs.conf which triggers the file to load /sbin/mount_nfs (which is the stage 3 jail\nbreak loader). Because /sbin/mount_nfs is run as root, the code is run with full privileges.\n\n\n-----\n\n### Spyware Analysis\n\nPegasus is one of the most sophisticated pieces of surveillance and espionage software that Lookout has investigated. It\n\nhas a novel mechanism to install and hide itself and obtain persistence on the system. Once it is resident, it uses a num\nber of ways to hide its communications and protect itself from discovery, and it hooks into a large number of the phone’s\n\nfunctions in order to gather data and intercept messages and calls.\n\n#### Installation and Persistence\n\nThe spyware is installed during the stage 3 execution by running the lw-install binary. Lw-install sets up a few of the key\n\nstructures of the product, as well as establishes persistence across reboots (and has a few protective functions to ensure\n\nthat the software doesn’t accidentally brick the phone).\n\nThe first thing that lw-install does is check the iOS version; it runs different commands depending on whether it is running\n\non iOS 9 or a previous version.\n\nIf it is installed on iOS 9, lw-install runs “/sbin/launchctl load” on .plist files dropped into /Library/LaunchDaemons (which\n\nis normally empty or used to hold launchd plists for jailbroken services, such as sshd). This will ensure that these files get\n\nlaunched and started on reboot.\n\nIf the OS is not iOS 9, the first thing that lw-install does is remove the following files:\n\nThen it starts\n\nNote that lw_install appears to log to /private/var/wireless/Library/com.apple.wifid.r.log\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **12**\n\n\n-----\n\n#### Persistence: JSC Privilege Escalation\n\nPegasus implements its persistence mechanism through the use of a developer tool called “jsc” that is part of the iOS\n\nenvironment. Jsc is intended to allow users to execute javascript using the webkit engine outside the context of a web\n\nbrowser.[6] In this case, a memory corruption issue in the tool is used by Pegasus to attain persistence.\n\nAs part of the installation process for persistence, the daemon rtbuddyd is replaced by a copy of jsc (which is a signed\n\nbinary and allowed to run code). On device reboot rtbuddyd will run and load --early-boot, which is a link to the\n```\ncom.apple.itunesstored.2.cstore file. The com.apple.itunesstored.2.csstore file is structured similarly to the exploit\n\n```\nfor CVE-2016-4655. This loads shellcode which is used to re-exploit the kernel each time that the system is rebooted and start\n\nthe running daemons. The execution flow of this code is:\n\n  - Run the jsc script calling --early-boot\n\n  - Run the exploit that maps the kernel base\n\n  - Run the kernel exploit\n\n  - Spawn the main running daemons of Pegasus: systemd, watchdogd\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **13**\n\n\n-----\n\n[As Citizen Lab mentioned in their report, Pegasus puts its own protection above all else. From the manual, as quoted by](https://citizenlab.org/2016/08/million-dollar-dissident-iphone-zero-day-nso-group-uae/\r)\n\nCitizen Lab:\n\n_In general, we understand that it is more important that the source will not be exposed and the target will suspect_\n\n_nothing than keeping the agent alive and working._\n\nTo this end, Pegasus has a large number of features that enable it to maintain its secrecy. It constantly monitors the phone\n\nfor status and disables any other access to the phone by previous/other jailbreaking software. Pegasus also contains a\n\ncomplex self-destruct mechanism which completely removes it from the phone.\n\n#### Disabling Updates\n\nThe Stage 3 loader ensures that the phone won’t receive auto-updates going forward:\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **14**\n\n\n-----\n\n#### Jailbreak Detection\n\nThe stage 3 loader also checks the device to see if it had been previously jailbroken:\n\nThe software also checks during each startup:\n\n#### Device Monitoring\n\nIn order to maintain its ability to run, communicate and monitor its own status, the software disables the phone’s “Deep\n\nSleep” functionality:\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **15**\n\n\n-----\n\nThe software also keeps a close eye on the battery status of the current device:\n\nAdditionally, the software monitors the current connection state and tracks which types of networks the phone is connect\ned to, potentially in order to determine the bandwidth and ability to send full data across the network:\n\n6 https://trac.webkit.org/wiki/JSC\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **16**\n\n\n6 https://trac.webkit.org/wiki/JSC\n\n\n-----\n\n#### Stealth Update to Command & Control Infrastructure\n\nThe software has multiple stealth communication channels. The systemd binary that Pegasus employs appears to use SMS\n\nmessaging as a communication channel. This functionality has been carefully implemented with instructions delivered via\n\nSMS masquerading as two-factor authentication messages from popular services such as Facebook, Google, and Ever\nnote. These instructions mirror the structure and expected content of legitimate two-factor authentication messages iden\ntically. An example of an attacker-provided instruction via SMS (captured originally by Citizen Lab) can be seen below.\n\nDespite appearing as a legitimate password reset from Google, this message actually contains an instruction for Pegasus\n\nto update the command and control servers that it can communicate to. It appears Pegasus is capable of receiving five\n\ntypes of instructions via SMS, with the instruction ID determined based on the last number of the verification code. For\n\nexample, in the message above this is 9.\n\nThis functionality appears to allow Pegasus to be updated out of band if http or https was not available. In the event C2\n\ninfrastructure was taken down or unavailable, this functionality provides Pegasus with a lifeline to the actors controlling it\n\nwith instructions on where to find the new C2 servers. This functionality is unprecedented in spyware and provides the\n\nability for Pegasus to persist even when infrastructure is compromised or taken down.\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **17**\n\n\n-----\n\nThe various message texts are below:\n\n#### Self Destruction\n\nThe Pegasus software has a highly sensitive self-destruct mechanism to ensure that the product is not discovered.\n\nWhen the software appears to be threatened, it will self destruct, removing its persistence mechanism (removing the\n\ncloned rtbuddyd and exploit com.apple.itunesstored.2.csstore described above).\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **18**\n\n\n-----\n\nPegasus will also remove all of its libraries (for example, the audio recording tools):\n\n#### Data Gathering\n\nAs Pegasus’ fundamental purpose is to spy on the owner of the phone, one of its main operations is to gather data.\n\nThe data- gathering functionality of Pegasus is among the most complete and comprehensive we have seen in any spy\nware package. It gathers everything from obvious high-value data like passwords, contacts, and calendar entries to data\n\nfrom numerous social networks. The full list of data types gathered is long, so we will examine only how it grabs certain\n\npieces of high- value data in order to show how the product works.\n\nThe full list of apps is:\n\n\n\n  - SMS/iMessage\n\n  - Calendar\n\n  - Address Book\n\n  - Gmail - mail and attachments\n\n  - Viber - calls and messages\n\n  - Facebook - address book and messages\n\n  - WhatsApp - messages and calls\n\n  - Telegram - messages\n\n  - Skype\n\n#### Calendar\n\n\n\n- Line\n\n- Kakao\n\n- WeChat\n\n- Surespot\n\n- Imo.im\n\n- Mail.Ru\n\n- Tango\n\n- VK\n\n- Odnoklassniki\n\n\nAs high-value PII, the “systemd” process grabs each VCAL file from the calendar and sends it through a message:\n\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **19**\n\n\n-----\n\n#### Contacts\n\nThe software also gathers contacts from the system, dumping the victim’s entire address book.\n\n#### GPS location\n\nPegasus also constantly updates and sends the location of the phone:\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **20**\n\n\n-----\n\n#### Capturing User Passwords\n\nOne of the most significant sets of private data on a phone is stored in the various user keychains. Apple’s KeyChain holds\n\nall of a user’s stored authentication info (usernames and passwords).  Pegasus’ “systemd” process loads the keychain and\n\ndumps all of the victim’s data.\n\n\n-----\n\n#### WiFi and Router Passwords\n\nIn addition to stealing all of the victim’s passwords, Pegasus interrogates the list of every Wi-Fi network that the phone has\n\nsaved and grabs all of the SSIDs and WEP/WAP keys and users.\n\nPegasus also grabs the router password for Apple devices like Airport, Time Capsule, etc.\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **22**\n\n\n-----\n\n#### Interception of Calls and Messages\n\nPegasus has a sophisticated set of audio and messaging intercept libraries that are modular and extensible. The base\n\nlibraries for audio (libaudio.dylib) and messaging (libimo.dylib) are comprehensive, but there are specialized libraries for\n\neach of the key intercept protocols.\n\nThe libaudio library registers a number of notification observers that record audio when fired. These observers listen for\n\nnotification IDs that get posted by various Pegasus modules. In the analyzed sample, this included notifications from the\n\nWhatsApp and Viber modules (, libwacalls.dylib and libvbcalls.dylib).\n\n###### Normal Phone\n\n Pegasus  Infected Phone\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **23**\n\n\n-----\n\n#### Process Injection: converter\n\nThe interception of real-time calls from the chat messengers (e.g., WhatsApp, Viber) comes through a library that is inject\ned into their process space dynamically at run time. The “converter” binary (the mechanism through which this occurs) is a\n\n[version of the cynject open-source library available here: https://github.com/r-plus/substrate/blob/master/cynject.cpp](https://github.com/r-plus/substrate/blob/master/cynject.cpp)\n\nThe library takes a pid as an argument and injects a dylib into running process using Mach kernel APIs. The usage for converter\n\nis: start (usage: %s <pid> <dylib> [args...])\n\nConverter has the following entitlements:\n\n```\n<key>com.apple.springboard.debugapplications</key>\n<true/>\n<key>get-task-allow</key>\n<true/>\n<key>task_for_pid-allow</key>\n<true/>\n\n```\n\nAdditionally, converter has a failsafe key combination that it listens for on the keyboard to dynamically unload the injected\n\nlibraries.\n\n#### Skype\n\nPegasus pulls all of the data about calls out of the Skype database on the device.\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **24**\n\n\n-----\n\nPegasus also saves any calls that Skype has previously recorded by reading them out of the Skype database files.\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **25**\n\n\n-----\n\n#### Telegram\n\n WhatsApp\n\nThe Pegasus authors have instrumented the interception of WhatsApp messages and calls within the samples that we have ob\ntained. In addition to logging the appropriate information for messages and calls, the software also loads a library (libwacalls.\n\ndylib) that is designed to hook key WhatsApp functions and intercept various communication types.\n\nThis library issues system-wide notifications when calls are connected, interrupted, or ended, and when another call event\n\noccurs. Any application can receive these events provided they know the ID of the notification. Throughout Pegasus these\n\nnotifications are unique and conspicuous, and they are made up of a sequence that’s 56 characters long and appears to be the\n\noutput of a sha224 hash function. Another Pegasus module responsible for recording audio included notification observers\n\nthat explicitly listen for these IDs. It seems that when these notifications are sent from libwacalls, and consequently handled by\n\nlibaudio.dylib, Pegasus records the current WhatsApp call a victim is making.\n\nLibaudio saves audio recordings from WhatsApp calls in the following directories:\n\n  - micFileName - /private/var/tmp/cr/x.<call_id>.caf\n\n  - spkFileName - /private/var/tmp/cr/t.<call_id>.caf\n\n  - sentryFileName - /private/var/tmp/cr/z.<call_id>.caf\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **26**\n\n\n-----\n\n-----\n\nlibwacalls first checks that Cydia Mobile substrate exists by attempting to load and link /usr/lib/libdata.dylib. If it isn’t present\n\nthen libwacalls exits. Otherwise execution continues, resulting in the decryption of several strings that are used to identify class\nes and methods to be hooked.\n\nLibwacalls is responsible for hooking the following methods that belong to the CallManager class:\n```\n • setCallConnected\n • setCallInterrupted\n • setCallInterruptedByPeer\n • endCall\n\n```\nThe following method is also hooked that belongs to the CallLogger class:\n```\n • addCallEvent\n\n```\nAll hooks rely on distributed notifications for IPC. As a result all hooks post a system-wide notification, with each notification\n\ncontaining a unique identifier that notification observers must reference exactly in order to receive. In all cases notification IDs\n\nare 56 characters, likely a sha224 hash digest. The functionality of these hooks is as follows:\n\n**Hook method** **Information included in Notification** **Notification IDs**\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **28**\n\n\n-----\n\n#### Viber\n\nThe samples of Pegasus we obtained were configured to obtain all of the calls from Viber through the libvbcalls library, which\n\nprovides hooks for Viber. These hooks are implemented similar to the ways seen in the libwacalls dynamic library, where hook\ning of key WhatsApp functions occur. Hooking in libvbcalls takes place when calls are first started and when they finish.\n\nCallEnded hooking logs the time the call finished and posts it in a system wide notification.\n\nThe following notification IDs are posted by libvbcalls:\n\n  - onCallStarted : eb899b6873eb166859e610915dd002ea21b6057bd31fc6c1b38f27e2\n\n  - onCallEnded : b79cd49420fbeba629a0290bc890c66924dd8452d0c2fd5ba9b327d0\n\nAs with libwacalls these notifications are picked up by libaudio.dylib and appear to result in call recording taking place.\n\nLibaudio also saves audio recordings of ViberCalls to the following directories. These are the same as those used by WhatsApp\n\nexcept for the sentryFileName. All three paths are listed below.\n\n  - micFileName - /private/var/tmp/cr/x.<call_id>.caf\n\n  - spkFileName - /private/var/tmp/cr/t.<call_id>.caf\n\n  - sentryFileName - /private/var/tmp/cr/vb.<call_id>.caf\n\n#### Real-Time Espionage\n\nIn addition to the ability to grab all the input and output of the phone, the phone can be used as an audio and video recorder.\n\nAs Omri Lavie, NSO’s co-founder, told the Financial Times, “Your smartphone today is the new walkie-talkie.”[7] These functions\n\nare on display below:\n\n7 http://www.haaretz.com/israel-news/business/economy-finance/1.574805\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **29**\n\n\n-----\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **30**\n\n\n-----\n\n### Conclusion\n\nWe rely on mobile devices to both store our digital assets and give us access to them. Our phones are always with us\n\nand have become a main form of voice, video- and messaging-based communication. This makes our mobile devices\n\nhighly valuable targets for motivated attackers.\n\nNSO Group reportedly has hundreds of employees and makes millions of dollars in annual revenue, effectively as\n\na cyber arms dealer, from the sale of its sophisticated mobile attack software. NSO is only one example of this type\n\nof cyber mercenary: we know that it is not the only one, as we’ve seen with the Hacking Team, Finfisher, and other\n\norganizations that compete in this space.\n\nWhile this report is focused on the iOS version of the software, Lookout and Citizen Lab are aware that NSO Group\n\nadvertises Android and Blackberry versions and are investigating those as well.\n\nThis report shows the importance of keeping our devices up to date with the latest patches and exercising vigilance\n\nwith the security of our mobile devices.\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **31**\n\n\n-----\n\n#### Appendix A: TLS Certificate Information\n\n**File: ca.crt**\n\nCertificate:\n\nData:\n\nVersion: 1 (0x0)\n\nSerial Number:\n\na9:c2:dc:41:57:dc:50:14\n\nSignature Algorithm: sha256WithRSAEncryption\n\nIssuer: CN=Asterisk Private CA, O=My Super Company\n\nValidity\n\nNot Before: Jul 18 11:21:53 2016 GMT\n\nNot After : Jul 17 11:21:53 2021 GMT\n\nSubject: CN=Asterisk Private CA, O=My Super Company\n\nSubject Public Key Info:\n\nPublic Key Algorithm: rsaEncryption\n\nRSA Public Key: (4096 bit)\n\nModulus (4096 bit):\n\n00:b0:8e:1b:24:7e:b4:d6:10:ab:10:fd:ce:a1:eb:\n\n2d:d7:c8:38:d3:ce:bb:a3:9a:30:0e:72:08:46:01:\n\n2d:c5:3e:3e:82:c1:4a:4e:a7:44:d8:94:2b:30:0c:\n\ndd:c3:b3:6b:bf:69:d2:0d:01:6c:e1:c5:db:f0:7c:\n\n50:3b:ba:cc:47:64:63:67:bf:50:62:49:33:74:d1:\n\nc4:57:e8:57:2b:6c:4b:b5:63:81:66:7b:cf:0e:c2:\n\n92:80:f9:ce:d9:e9:f5:f2:95:18:77:d7:24:47:62:\n\nff:2d:bc:09:fa:f4:4d:92:53:df:85:cc:38:39:9f:\n\n14:ef:16:f1:6d:63:47:c9:44:1e:6a:0a:70:00:bd:\n\n92:a5:c2:ec:d1:8d:02:bf:ae:cb:8b:5e:03:8a:67:\n\nd0:ee:02:80:b7:a7:94:9f:b5:0f:dc:3a:d6:ea:ec:\n\n3d:8d:3e:ae:e9:54:f1:39:a4:fc:53:01:ad:ce:6a:\n\ne6:56:53:fe:7d:92:0f:5c:0b:0a:03:18:94:aa:4e:\n\nfc:8d:f0:69:ee:a2:c1:a9:0c:6d:1e:69:78:28:73:\n\n69:e4:aa:ca:b0:0f:49:d9:ca:b2:71:72:d9:25:ec:\n\n3e:6c:c0:10:68:aa:a3:b6:71:fd:69:f3:d0:4e:c2:\n\n24:3f:69:1f:5a:5d:5e:02:8f:67:e7:40:52:1f:34:\n\n17:7a:47:c8:6e:d1:fc:d2:99:6a:97:c5:1b:c1:87:\n\n2a:4f:04:f7:7a:33:dc:3a:d0:be:5e:67:26:b7:d1:\n\n4e:0e:fa:d4:78:44:ef:e1:a2:a5:fa:f3:ae:e4:9b:\n\n5f:34:a5:9b:45:b0:dc:ca:a0:19:94:6f:c3:c1:0a:\n\n79:84:35:a3:ad:2d:33:82:28:8a:e2:97:f1:82:2c:\n\n49:80:ef:ae:10:d4:cf:83:ed:b3:0c:58:e8:1c:74:\n\n7d:12:30:e6:bc:fb:08:b7:04:44:51:5e:95:4d:17:\n\nd3:e7:8e:ab:93:88:7f:7f:91:01:c9:d4:61:15:8b:\n\n6f:23:41:49:58:e4:bd:81:d9:90:07:8a:c0:99:da:\n\n2f:f0:21:f1:96:52:7e:a5:5e:69:3d:1a:da:b0:19:\n\n24:7e:d6:5a:98:b6:4a:18:54:1f:b9:e5:ed:63:d5:\n\ne6:6d:1c:67:59:91:52:14:55:aa:94:86:b1:77:43:\n\n\n-----\n\nfe:b4:5c:d6:8b:57:e1:cf:de:84:37:4f:7a:26:0b:\n\n92:ec:c1:3c:9c:45:31:b9:b6:ad:ef:4e:51:73:53:\n\n96:06:16:9d:e8:67:d1:8e:08:aa:1a:93:0f:7e:fc:\n\n8a:f0:9d:ed:13:db:dd:ab:78:5e:32:99:ac:41:b6:\n\n09:75:a8:9c:ff:6e:72:95:44:e8:dc:38:30:e3:21:\n\n81:0b:bf\n\nExponent: 65537 (0x10001)\n\nSignature Algorithm: sha256WithRSAEncryption\n\n7e:ce:86:7c:1d:d7:10:b6:67:11:a0:1a:be:01:34:b8:12:f5:\n\n61:2a:af:a6:30:94:dd:35:6f:fb:80:aa:4d:a1:80:9b:80:63:\n\nd7:02:71:8d:07:4f:57:94:03:bd:1c:b8:44:83:08:6b:be:72:\n\n47:e4:bc:d7:51:ce:ee:3f:30:84:d9:eb:41:3d:7f:9c:6b:37:\n\n58:d2:94:71:be:38:dc:97:fb:0e:60:2b:d1:88:e4:72:74:6f:\n\n85:3a:60:84:f1:58:40:2c:9d:5e:f7:a9:4b:3e:aa:6a:ed:08:\n\nd8:4c:d1:33:1f:5d:ff:b9:6e:98:9f:71:6b:19:50:6d:c3:58:\n\ndd:15:76:e3:d9:80:df:da:c3:55:11:f6:cb:6a:08:64:c1:8d:\n\nf9:f6:d3:c3:30:61:bd:55:4f:34:88:96:0c:ea:96:6a:37:14:\n\nb0:f2:8f:5e:16:fa:ca:9a:28:7c:68:e1:6f:07:f3:a1:7d:a4:\n\na4:40:5c:c6:e9:ce:98:a2:95:b2:09:93:ba:b5:a3:62:38:7d:\n\nd3:9f:1d:36:2d:29:4a:c6:96:a8:d1:2d:de:a9:2a:8b:43:33:\n\nd5:f1:a5:71:10:32:33:a0:fa:8b:4e:04:d4:12:4f:26:1f:d8:\n\n82:27:cc:c2:a9:17:a7:65:3d:3c:45:42:77:5a:c0:10:6e:57:\n\nd2:84:89:45:bc:49:5f:be:0d:cc:ec:21:6c:06:16:f1:43:8f:\n\n58:ce:93:68:7e:46:ea:fd:db:e0:9b:42:44:52:66:f8:01:d7:\n\n29:7a:61:b6:be:13:94:48:02:bc:68:34:46:73:91:64:76:95:\n\n14:08:ba:9e:41:59:76:83:ab:88:c3:60:74:75:37:34:08:24:\n\n91:2f:ba:81:65:d3:b8:a8:b4:28:79:71:ad:7c:95:db:7e:9c:\n\n6b:30:44:3a:b6:b1:66:83:ab:1c:a5:77:f7:63:d1:da:30:a0:\n\n2e:65:d4:0c:c4:ec:8d:d3:4c:32:e8:71:e5:25:2b:81:97:cc:\n\nad:c9:f2:d9:7d:01:48:10:7c:86:51:db:39:da:f3:64:0a:1d:\n\nb2:35:d8:21:2e:27:7c:c7:b3:8f:28:14:95:90:5c:17:1f:7b:\n\n7c:a2:e8:18:4a:31:39:89:dc:8b:56:99:df:d0:26:0a:85:70:\n\ne8:e1:d0:ad:59:92:35:98:a5:7d:4f:51:46:2a:3a:cf:85:79:\n\n5d:07:63:44:6c:a4:81:82:d8:d5:40:32:95:ac:d8:77:c3:af:\n\n8b:fc:ad:2b:ef:04:87:80:0c:dd:c0:ec:87:2d:1f:06:51:8f:\n\nda:71:1b:f6:c4:17:5a:6f:e6:f2:b2:d4:90:b9:76:a7:e8:71:\n\n56:30:33:4f:58:15:b6:2b\n\n#### Appendix B: IOCs for Jailbreak Detection\n\nIndicators of Compromise for the jailbreaks used in Pegasus\n```\n/--early-boot\n/var/root/test.app\n/private/var/tmp/crw\n/private/var/tmp/cr\n/private/var/tmp/st_data\n\n```\n\n-----\n\n# Authors\n\n###### Max Bazaliy, Lookout\n\n Michael Flossman, Lookout\n\n Andrew Blaich, Lookout \n\n\n###### Seth Hardy, Lookout\n\n Kristy Edwards, Lookout\n\n Mike Murray, Lookout\n\n\n###### Additional credit goes to the other researchers who have worked on this analysis:\n\n From Lookout: Christina Olson, Christoph Hebeisen, Pat Ford, Colin Streicher, \n\n Robert Nickle, John Roark\n\n From Citizen Lab: Bill Marczak, John Scott Railton\n\nWebsite: www.lookout.com\nBlog: blog.lookout.com\nTwitter: @lookout\n\nAbout Lookout:\n\n_Lookout is a cybersecurity company that makes it possible for individuals and enterprises to be both mobile and secure. With 100 million mobile sensors_\n_fueling a dataset of virtually all the mobile code in the world, the Lookout Security Cloud can identify connections that would otherwise go unseen -_\n_predicting and stopping mobile attacks before they do harm. The world’s leading mobile network operators, including AT&T, Deutsche Telekom, EE, KDDI,_\n_Orange, Sprint, T-Mobile and Telstra, have selected Lookout as its preferred mobile security solution. Lookout is also partnered with such enterprise leaders_\n_as AirWatch, Ingram Micro and MobileIron. Headquartered in San Francisco, Lookout has offices in Amsterdam, Boston, London, Sydney, Tokyo, Toronto and_\n_Washington, D.C._\n\n\n-----\n\n**TECHNICAL ANALYSIS OF PEGASUS SPYWARE |** **35**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2016/2016.08.25.lookout-pegasus-technical-analysis/lookout-pegasus-technical-analysis.pdf"
    ],
    "report_names": [
        "lookout-pegasus-technical-analysis"
    ],
    "threat_actors": [
        {
            "id": "a3687241-9876-477b-aa13-a7c368ffda58",
            "created_at": "2022-10-25T16:07:24.496902Z",
            "updated_at": "2025-03-27T02:02:10.256629Z",
            "deleted_at": null,
            "main_name": "Hacking Team",
            "aliases": [],
            "source_name": "ETDA:Hacking Team",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e90c06e4-e3e0-4f46-a3b5-17b84b31da62",
            "created_at": "2023-01-06T13:46:39.018236Z",
            "updated_at": "2025-03-27T02:00:02.978356Z",
            "deleted_at": null,
            "main_name": "Hacking Team",
            "aliases": [],
            "source_name": "MISPGALAXY:Hacking Team",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716503,
    "ts_updated_at": 1743041819,
    "ts_creation_date": 1472122901,
    "ts_modification_date": 1472122907,
    "files": {
        "pdf": "https://archive.orkl.eu/99f8d948b133c10f03dc642ffdefc72ec6ef4cf5.pdf",
        "text": "https://archive.orkl.eu/99f8d948b133c10f03dc642ffdefc72ec6ef4cf5.txt",
        "img": "https://archive.orkl.eu/99f8d948b133c10f03dc642ffdefc72ec6ef4cf5.jpg"
    }
}