{
    "id": "489d52df-8612-4e32-987b-5f683d08720c",
    "created_at": "2023-01-12T15:06:43.78813Z",
    "updated_at": "2025-03-27T02:15:35.445682Z",
    "deleted_at": null,
    "sha1_hash": "96f132379ef92503b9bcdd7256d7b50fbb083b30",
    "title": "2021-06-08 - PuzzleMaker attacks with Chrome zero-day exploit chain",
    "authors": "",
    "file_creation_date": "2022-05-28T05:09:48Z",
    "file_modification_date": "2022-05-28T05:09:48Z",
    "file_size": 436044,
    "plain_text": "# PuzzleMaker attacks with Chrome zero-day exploit chain\n\n**[securelist.com/puzzlemaker-chrome-zero-day-exploit-chain/102771/](https://securelist.com/puzzlemaker-chrome-zero-day-exploit-chain/102771/)**\n\nAuthors\n\n[Costin Raiu](https://securelist.com/author/costin/)\n\nBoris Larin\n\nAlexey Kulaev\n\nOn April 14-15, 2021, Kaspersky technologies detected a wave of highly targeted attacks\nagainst multiple companies. Closer analysis revealed that all these attacks exploited a chain\nof Google Chrome and Microsoft Windows zero-day exploits. While we were not able to\nretrieve the exploit used for remote code execution (RCE) in the Chrome web browser, we\nwere able to find and analyze an elevation of privilege (EoP) exploit that was used to escape\nthe sandbox and obtain system privileges.\n\n\n-----\n\nThe elevation of privilege exploit was fine-tuned to work against the latest and most\nprominent builds of Windows 10 (17763 – RS5, 18362 – 19H1, 18363 – 19H2, 19041 –\n20H1, 19042 – 20H2) and it exploits two distinct vulnerabilities in the Microsoft Windows OS\nkernel. On April 20, 2021, we reported these vulnerabilities to Microsoft and they assigned\nCVE-2021-31955 to the information disclosure vulnerability and CVE-2021-31956 to the\nelevation of privilege vulnerability. Both vulnerabilities were patched on June 8, 2021, as a\npart of the June Patch Tuesday.\n\n## Remote code execution exploit\n\nAll of the observed attacks were conducted through Chrome browser. Unfortunately, we were\nunable to retrieve the JavaScript with full exploit code, but the timeframe of attacks and\nevents preceding it led us to suspect one particular vulnerability.\n\nOn April 6-8, 2021 the Pwn2Own competition took place. This is a computer hacking contest\nwhere the Google Chrome web browser was one of the targets. According to the ZDI (Zero\n[Day Initiative, the organizer of Pwn2Own) website, one participating team was able to](https://www.zerodayinitiative.com/blog/2021/4/2/pwn2own-2021-schedule-and-live-results)\ndemonstrate a successful exploitation of the Chrome renderer process using a Typer\nMismatch bug.\n\n[On April 12, 2021, the developers of Chromium committed two (issue 1196683, issue](https://chromium-review.googlesource.com/c/v8/v8/+/2820971)\n[1195777) Typer-related bug fixes to the open-source repository of V8 – a JavaScript engine](https://chromium-review.googlesource.com/c/v8/v8/+/2817791)\n[used by Chrome and Chromium web browsers. One of these bug fixes (issue 1196683) was](https://chromium-review.googlesource.com/c/v8/v8/+/2820971)\nintended to patch a vulnerability that was used during Pwn2Own, and both bug fixes were\ncommitted together with regression tests – JavaScript files to trigger these vulnerabilities.\nLater on the same day, a user with the Twitter handle @r4j0x00 published a working remote\ncode execution exploit on GitHub, targeting an up-to-date version of Google Chrome. That\n[exploit used a vulnerability from issue 1196683 to execute a shellcode in the context of the](https://chromium-review.googlesource.com/c/v8/v8/+/2820971)\nbrowser renderer process.\n\n\n-----\n\n**_Screenshot of tweet with Chrome zero-day published on April 12, 2021_**\n\nThe published exploit didn’t contain a sandbox escape exploit and was therefore intended to\nwork only when the browser was launched with the command line option –no-sandbox.\n\nOn April 13, 2021, Google released Chrome update 89.0.4389.128 for Windows, Mac and\nLinux with a fix for two vulnerabilities; CVE-2021-21220 (used during Pwn2Own) was one of\nthem.\n\nSome of our customers who were attacked on April 14-15, 2021, already had their Chrome\nbrowser updated to 89.0.4389.128, and that’s why we think the attackers didn’t use CVE2021-21220 in their attacks.\n\nOn April 14, 2021, Google released Chrome update 90.0.4430.72 for Windows, Mac and\nLinux with a fix for 37 vulnerabilities. On the same day, a new Chrome exploit was presented\nto the public.\n\n\n-----\n\n**_Screenshot of GitHub repository with Chrome zero-day published on April 14, 2021_**\n\n[This newly published exploit used a vulnerability from issue 1195777, worked on the newly](https://chromium-review.googlesource.com/c/v8/v8/+/2817791)\nreleased Chrome 90.0.4430.72, and was fixed as CVE-2021-21224 only a few days later, on\nApril 20, 2021.\n\nWe suspect the attackers were also able to use this JavaScript file with regression test to\ndevelop the exploit (or acquire it from someone else) and were probably using CVE-202121224 in their attacks.\n\n## Elevation of privilege exploit\n\nCVE-2021-31955 is an information disclosure vulnerability in ntoskrnl.exe. The vulnerability\nis affiliated with a Windows OS feature called SuperFetch. It was introduced in Windows\nVista and is aimed to reduce software loading times by pre-loading commonly used\napplications into memory. For SuperFetch purposes the function NtQuerySystemInformation\nimplements a special system information class SystemSuperfetchInformation. This system\ninformation class incorporates more than a dozen of different SuperFetch information\nclasses. The vulnerability lies in the fact that data returned by the NtQuerySystemInformation\nfunction for the SuperFetch information class SuperfetchPrivSourceQuery contains\nEPROCESS kernel addresses for currently executed processes\n\n\n-----\n\n[It s noteworthy that this vulnerability can be observed in code that was available on GitHub](https://github.com/zodiacon/WindowsInternals/blob/master/MemInfo/MemInfo.cpp)\nfor a few years before we caught it in the wild and Microsoft patched it.\n\n**_CVE-2021-31955 can be observed in the source code of the MemInfo utility_**\n\nThe other vulnerability, CVE-2021-31956, is a heap-based buffer overflow in ntfs.sys. The\nfunction NtfsQueryEaUserEaList processes a list of extended attributes for the file and stores\nthe retrieved values to buffer. This function is accessible via ntoskrnl syscall and among\nother things it’s possible to control the size of the output buffer. If the size of the extended\nattribute is not aligned, the function will calculate a padding and the next extended attribute\nwill be stored 32-bit aligned. The code checks if the output buffer is long enough to fit the\nextended attribute with padding, but it doesn’t check for possible integer-underflow. As a\nresult, a heap-based buffer overflow can happen.\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n\nfor ( cur_ea_list_entry = ea_list; ; cur_ea_list_entry = next_ea_list_entry )\n\n{\n\n...\n\nout_buf_pos = (DWORD *)(out_buf + padding + occupied_length);\n\nif ( NtfsLocateEaByName(eas_blocks_for_file, eas_blocks_size, &name,\n&ea_block_pos) )\n\n{\n\n\n-----\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n22\n\n23\n\n24\n\n25\n\n26\n\n27\n\n28\n\n29\n\n\nea_block = eas_blocks_for_file + ea_block_pos;\n\nea_block_size = ea_block->DataLength + ea_block->NameLength + 9;\n\nif ( ea_block_size <= out_buf_length - padding ) // integer-underflow is possible\n\n{\n\nmemmove(out_buf_pos, (const void *)ea_block, ea_block_size); // heap buffer\noverflow\n\n*out_buf_pos = 0;\n\n}\n\n}\n\nelse\n\n{\n\n...\n\n}\n\n...\n\noccupied_length += ea_block_size + padding;\n\nout_buf_length -= ea_block_size + padding;\n\npadding = ((ea_block_size + 3) & 0xFFFFFFFC) - ea_block_size;\n\n...\n\n}\n\n\n**_Pseudo-code for vulnerable code in function NtfsQueryEaUserEaList_**\n\nThe exploit uses CVE-2021-31956 along with Windows Notification Facility (WNF) to create\narbitrary memory read and write primitives. We are planning to publish more information\nabout this technique in the future.\n\n\n-----\n\nAs the exploit uses CVE-2021-31955 to get the kernel address of the EPROCESS structure,\nit is able to use the common post exploitation technique to steal SYSTEM token. However,\nthe exploit uses a rarely used “PreviousMode” technique instead. We have seen this\n[technique used by the CHAINSHOT framework and even made a presentation about it at](https://github.com/oct0xor/presentations/blob/master/2019-02-Overview%20of%20the%20latest%20Windows%20OS%20kernel%20exploits%20found%20in%20the%20wild.pdf)\nCanSecWest/BlueHat in 2019. The exploit uses this technique to inject a malware module\ninto the system process and execute it.\n\n## Malware modules\n\nBesides the aforementioned exploits, the full attack chain consists of four additional malware\nmodules, which will be referred to as:\n\nStager\nDropper\nService\nRemote shell\n\nThe stager module is used to notify that exploitation was successful. It also downloads and\nexecutes a more complex malware dropper module from a remote server. Each stager\nmodule is delivered to the victim with a personalized configuration blob that defines the C&C\nURL, Session ID, keys to decrypt the next stage of malware, and other information.\n\nAll the stager module samples that we’ve discovered so far were configured to use the same\nURL address – hxxps://p{removed}/metrika_upload/index.php – to download the encrypted\nmalware dropper module.\n\nWe believe there is a chance that the remote code execution JavaScript exploit was also\nhosted on the same legitimate-looking geopolitical news portal, but we found no evidence of\na classic watering hole attack. The victimology suggests a highly targeted delivery of\nexploits.\n\nThe dropper module is used to install two executables that pretend to be legitimate files\nbelonging to Microsoft Windows OS. One of these files (%SYSTEM%\\WmiPrvMon.exe) is\nregistered as a service and is used as a launcher for the second executable. This second\nexecutable (%SYSTEM%\\wmimon.dll) has the functionality of a remote shell and can be\nconsidered the main payload of the attack. We couldn’t find any similarities between this and\nother known malware.\n\nThe remote shell module has a hardcoded URL of the C&C server inside (mediaseoengine[.]com). All the communication between C&C server and client is authorized and\nencrypted. The remote shell module is able to download and upload files, create processes,\nsleep for specified amounts of time and delete itself from the compromised machine.\n\n\n-----\n\nNone of the artifacts we analyzed appear to have strong connections to any known threat\nactors. The only similarity to CHAINSHOT we observed is the “PreviousMode” technique,\nalthough this is publicly known and may be used by various groups. We are calling the threat\nactor behind these attacks PuzzleMaker.\n\nKaspersky products detect this exploit and malware modules with the verdicts:\n\nPDM:Exploit.Win32.Generic\nPDM:Trojan.Win32.Generic\nUDS:DangerousObject.Multi.Generic\n\nKaspersky products detected these attacks with the help of the Behavioral Detection Engine\nand the Exploit Prevention component. Over the past few years, we have built a multitude of\nexploit protection technologies into our products that have detected many zero-days,\nrepeatedly proving their effectiveness. We will continue to improve defenses for our users by\nenhancing technologies and working with third-party vendors to patch vulnerabilities, making\nthe internet more secure for everyone.\n\nMore information about these attacks and the actor behind them is available to customers of\nthe Kaspersky Intelligence Reporting service. Contact: intelreports@kaspersky.com.\n\nKaspersky would like to thank Microsoft for their prompt analysis of the report and patches.\n\n## IoCs\n\nmedia-seoengine[.]com\n\n**%SYSTEM%\\WmiPrvMon.exe**\n\nMD5 [09A5055DB44FC1C9E3ADD608EFFF038C](https://opentip.kaspersky.com/09A5055DB44FC1C9E3ADD608EFFF038C/)\n\nSHA-1 [BFFA4462901B74DBFBFFAA3A3DB27DAA61211412](https://opentip.kaspersky.com/BFFA4462901B74DBFBFFAA3A3DB27DAA61211412/)\n\nSHA-256\n[982F7C4700C75B81833D5D59AD29147C392B20C760FE36B200B541A0F841C8A9](https://opentip.kaspersky.com/982F7C4700C75B81833D5D59AD29147C392B20C760FE36B200B541A0F841C8A9/)\n\n**%SYSTEM%\\wmimon.dll**\n\nMD5 [D6B850C950379D5EE0F254F7164833E8](https://opentip.kaspersky.com/D6B850C950379D5EE0F254F7164833E8/)\n\nSHA-1 [E63ED3B56A5F9A1EA5C92D3D2444196EA13BE94B](https://opentip.kaspersky.com/E63ED3B56A5F9A1EA5C92D3D2444196EA13BE94B/)\n\nSHA-256\n[8A17279BA26C8FBE6966EA3300FDEFB1ADAE1B3ED68F76A7FC81413BD8C1A5F6](https://opentip.kaspersky.com/8A17279BA26C8FBE6966EA3300FDEFB1ADAE1B3ED68F76A7FC81413BD8C1A5F6/)\n\n[Browser](https://securelist.com/tag/browser/)\n[Google Chrome](https://securelist.com/tag/google-chrome/)\n[Malware Technologies](https://securelist.com/tag/malware-technologies/)\n[Microsoft Windows](https://securelist.com/tag/microsoft-windows/)\n\n\n-----\n\n[Targeted attacks](https://securelist.com/tag/targeted-attacks/)\n[Trojan](https://securelist.com/tag/trojan/)\n[Vulnerabilities and exploits](https://securelist.com/tag/vulnerabilities-and-exploits/)\n\nAuthors\n\n[Costin Raiu](https://securelist.com/author/costin/)\n\nBoris Larin\n\nAlexey Kulaev\n\nPuzzleMaker attacks with Chrome zero-day exploit chain\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-08 - PuzzleMaker attacks with Chrome zero-day exploit chain.pdf"
    ],
    "report_names": [
        "2021-06-08 - PuzzleMaker attacks with Chrome zero-day exploit chain.pdf"
    ],
    "threat_actors": [
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536003,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1653714588,
    "ts_modification_date": 1653714588,
    "files": {
        "pdf": "https://archive.orkl.eu/96f132379ef92503b9bcdd7256d7b50fbb083b30.pdf",
        "text": "https://archive.orkl.eu/96f132379ef92503b9bcdd7256d7b50fbb083b30.txt",
        "img": "https://archive.orkl.eu/96f132379ef92503b9bcdd7256d7b50fbb083b30.jpg"
    }
}