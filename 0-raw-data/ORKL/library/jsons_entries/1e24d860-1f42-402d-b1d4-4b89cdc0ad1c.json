{
    "id": "1e24d860-1f42-402d-b1d4-4b89cdc0ad1c",
    "created_at": "2023-01-12T15:07:49.774307Z",
    "updated_at": "2025-03-27T02:05:31.134295Z",
    "deleted_at": null,
    "sha1_hash": "d40d2d658c9a78ed4b25d789a42315b3135ddd56",
    "title": "2019-12-24 - Unpacking Payload used in Bottle EK",
    "authors": "",
    "file_creation_date": "2022-05-27T22:07:27Z",
    "file_modification_date": "2022-05-27T22:07:27Z",
    "file_size": 673008,
    "plain_text": "# Unpacking Payload used in Bottle EK\n\n**[pwncode.io/2019/12/unpacking-payload-used-in-bottle-ek.html](http://www.pwncode.io/2019/12/unpacking-payload-used-in-bottle-ek.html)**\n\n[On December 13th 2019, @nao_sec discovered a new Exploit kit targeting users in Japan](https://twitter.com/nao_sec)\nand it was given the name, Bottle Exploit Kit.\n\n[@nao_sec described in their blog the details of the Exploit Kit including the two](https://nao-sec.org/2019/12/say-hello-to-bottle-exploit-kit.html)\nvulnerabilities (CVE-2018-8174 and CVE-2018-15982) which were exploited in this attack.\n\nIn this article, I will go into the details of the multiple stages of unpacking the payload used in\nBottle Exploit Kit.\n\n**tl;dr** : Multiple stages of packing are used in the payload. The XOR decryption routine used is\ncommon for all the payloads related to Bottle Exploit Kit and can be used to discover more\ninstances.\n\n**MD5 hash of the sample discussed** : ee98ef74c496447847f1876741596271\n\nThe WinMain() subroutine creates a new Thread as shown below:\n\n\n-----\n\nThe newly created Thread creates another Thread in turn as shown below:\n\nThe first stage of unpacking is performed by Thread 2 (function start address: 0x40105b).\nThe figure highlights the important stages of unpacking:\n\nThe main stages of unpacking of the first stage are:\n\n1. VirtualAlloc() to allocate memory to decrypt stage 1.\n2. RtlMoveMemory() to copy 0x1ed8 bytes of encrypted data from 0x412db8 to memory\nallocated in step 1.\n3. XOR decryption routine at address: 0x401000 is invoked. The XOR decryption key is 0x3c\nbytes in length and is passed as an argument to the XOR decryption routine.\n4. VirtualAlloc() is called again to decompress the XOR decrypted output of step 3.\n5. Decompression is performed using RtlDecompressBuffer()\n6. A new Thread with function start address set to decompressed code in step 5 is started.\n\nThe XOR decryption routine mentioned in step 3 above is as shown below:\n\n\n-----\n\nThe next decrypted stage looks as shown below:\n\nAnother layer of XOR decryption is done by stage 2 which gives us the following decrypted\ndata:\n\nIn the next stage of execution, it performs the System Language Check using the\nAPI, GetUserDefaultUILanguage() as shown below:\n\n\n-----\n\nThe system language code is compared with 0x411 which corresponds to Japanese System\nLanguage. The payload will execute completely only if the system language code is: 0x411.\n\nHere is the list of decrypted strings:\n\n0000000028DF  0000000028DF   0  shlwapi.dll\n0000000028EB  0000000028EB   0  User32.dll\n0000000028F6  0000000028F6   0  Advapi32.dll\n000000002903  000000002903   0  ntdll.dll\n00000000290D  00000000290D   0  Ws2_32.dll\n000000002918  000000002918   0  Wininet.dll\n000000002924  000000002924   0  Urlmon.dll\n00000000292F  00000000292F   0  bcdfghklmnpqrstvwxzaeiouyT\n000000002A56  000000002A56   0  DataDirectory %s\n000000002A77  000000002A77   0  POST %s HTTP/1.1\n000000002A89  000000002A89   0  Host: %s\n000000002A93  000000002A93   0  Connection: close\n000000002AA6  000000002AA6   0  Accept: */*\n000000002AB3  000000002AB3   0  User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64)\n000000002AE4  000000002AE4   0  Accept-Encoding: identity\n000000002AFF  000000002AFF   0  Content-Type: application/x-www-form-urlencoded\n000000002B30  000000002B30   0  Content-Length: %d\n000000002B4C  000000002B4C   0  WSAStartup\n000000002B57  000000002B57   0  socket\n000000002B5E  000000002B5E   0  setsockopt\n000000002B69  000000002B69   0  connect\n000000002B7B  000000002B7B   0  closesocket\n000000002952  000000002952   0  AppData\\LocalLow\n000000002974  000000002974   0  \\Data\\Tor\n000000002988  000000002988   0  \\Data\\Tor\\geoip\n0000000029A8  0000000029A8   0  \\Data\\Tor\\geoip6\n0000000029CA  0000000029CA   0  \\Tor\\taskhost.exe\n0000000029EE  0000000029EE   0  \\Tor\\tor.exe\n000000002A08  000000002A08   0  \\torrc\n000000002A16  000000002A16   0  1.zip\n000000002A22  000000002A22   0  1.exe\n000000002A2E  000000002A2E   0  -o -qq \"%s\" -d \"%s\"\n000000002A66  000000002A66   0  s-f \"%s\"\n000000002B86  000000002B86   0  t.jpg\n000000002B9B  000000002B9B   0  ALLUSERSPROFILE\n000000002BBB  000000002BBB   0  rundll32.exe\n\n\n-----\n\nFrom the Decrypted Strings above, we can see that it will make a Network Request to\ndownload TOR browser.\n\nThe XOR decryption routine used in the payload is the same among all the samples (DLL\nand EXE files) related to Bottle Exploit Kit instances.\n\nHere are more MD5 hashes of payloads used in Bottle Exploit Kit:\n\n5c9522927945f7fde17724360e9fec64\nd408c3f58c3407e5d37ec524db03deb9\nd6ae17d1d8ba79de1f936092297e44f9\nd1bdc7c37f66702bf72d41a9276777dc\n894794945683db1e708d2e9304821b19\n6c71ca4978095b24a10487a84215d5bd\nee98ef74c496447847f1876741596271\ne65322b4add2e5183616ce283e99614f\nc67c6f2f212ffe7d99c7238c959c95e6\n972d77bd40b0acfa9c0ffaf12b7cbba4\n8fdd5e90c33b4feb83b74b3922c09c6d\ne753d7a35a9144dd820d4d6e9be970ee\n\nThe only change is the XOR decryption key.\n\nc0d3inj3cT\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-12-24 - Unpacking Payload used in Bottle EK.pdf"
    ],
    "report_names": [
        "2019-12-24 - Unpacking Payload used in Bottle EK.pdf"
    ],
    "threat_actors": [
        {
            "id": "fce5181c-7aab-400f-bd03-9db9e791da04",
            "created_at": "2022-10-25T15:50:23.759799Z",
            "updated_at": "2025-03-27T02:00:55.540135Z",
            "deleted_at": null,
            "main_name": "Transparent Tribe",
            "aliases": [
                "Transparent Tribe",
                "COPPER FIELDSTONE",
                "APT36",
                "Mythic Leopard",
                "ProjectM"
            ],
            "source_name": "MITRE:Transparent Tribe",
            "tools": [
                "DarkComet",
                "ObliqueRAT",
                "njRAT",
                "Peppy"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "c68fa27f-e8d9-4932-856b-467ccfe39997",
            "created_at": "2023-01-06T13:46:38.450585Z",
            "updated_at": "2025-03-27T02:00:02.836543Z",
            "deleted_at": null,
            "main_name": "Operation C-Major",
            "aliases": [
                "C-Major",
                "Transparent Tribe",
                "Mythic Leopard",
                "ProjectM",
                "APT 36",
                "TMP.Lapis",
                "Green Havildar",
                "COPPER FIELDSTONE",
                "APT36",
                "Earth Karkaddan",
                "Storm-0156"
            ],
            "source_name": "MISPGALAXY:Operation C-Major",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "abb24b7b-6baa-4070-9a2b-aa59091097d1",
            "created_at": "2022-10-25T16:07:24.339942Z",
            "updated_at": "2025-03-27T02:02:10.179404Z",
            "deleted_at": null,
            "main_name": "Transparent Tribe",
            "aliases": [
                "APT 36",
                "APT-C-56",
                "Copper Fieldstone",
                "Earth Karkaddan",
                "Green Havildar",
                "Mythic Leopard",
                "Operation C-Major",
                "Operation Honey Trap",
                "Operation Transparent Tribe",
                "ProjectM",
                "STEPPY-KAVACH",
                "Storm-0156",
                "TEMP.Lapis",
                "Transparent Tribe"
            ],
            "source_name": "ETDA:Transparent Tribe",
            "tools": [
                "Amphibeon",
                "Android RAT",
                "Bezigate",
                "Bladabindi",
                "Bozok",
                "Bozok RAT",
                "BreachRAT",
                "Breut",
                "CapraRAT",
                "CinaRAT",
                "Crimson RAT",
                "DarkComet",
                "DarkKomet",
                "ElizaRAT",
                "FYNLOS",
                "Fynloski",
                "Jorik",
                "Krademok",
                "Limepad",
                "Luminosity RAT",
                "LuminosityLink",
                "MSIL",
                "MSIL/Crimson",
                "Mobzsar",
                "MumbaiDown",
                "Oblique RAT",
                "ObliqueRAT",
                "Peppy RAT",
                "Peppy Trojan",
                "Quasar RAT",
                "QuasarRAT",
                "SEEDOOR",
                "Scarimson",
                "SilentCMD",
                "Stealth Mango",
                "UPDATESEE",
                "USBWorm",
                "Waizsar RAT",
                "Yggdrasil",
                "beendoor",
                "klovbot",
                "njRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536069,
    "ts_updated_at": 1743041131,
    "ts_creation_date": 1653689247,
    "ts_modification_date": 1653689247,
    "files": {
        "pdf": "https://archive.orkl.eu/d40d2d658c9a78ed4b25d789a42315b3135ddd56.pdf",
        "text": "https://archive.orkl.eu/d40d2d658c9a78ed4b25d789a42315b3135ddd56.txt",
        "img": "https://archive.orkl.eu/d40d2d658c9a78ed4b25d789a42315b3135ddd56.jpg"
    }
}