{
    "id": "3b48bb6d-46ed-4b81-adf9-8db76fe61e38",
    "created_at": "2023-01-12T15:01:45.82496Z",
    "updated_at": "2025-03-27T02:16:25.866324Z",
    "deleted_at": null,
    "sha1_hash": "85a9c748ebd276ec22b27f5358bc8d6596ea1440",
    "title": "2020-06-24 - Magnitude exploit kit - evolution",
    "authors": "",
    "file_creation_date": "2022-05-28T05:09:36Z",
    "file_modification_date": "2022-05-28T05:09:36Z",
    "file_size": 528499,
    "plain_text": "# Magnitude exploit kit – evolution\n\n**securelist.com/magnitude-exploit-kit-evolution/97436/**\n\nAuthors\n\nBoris Larin\n\nExploit kits are not as widespread as they used to be. In the past, they relied on the use of\nalready patched vulnerabilities. Newer and more secure web browsers with automatic\nupdates simply do not allow known vulnerabilities to be exploited. It was very different back\nin the heyday of Adobe Flash because it’s just a plugin for a web browser, meaning that even\nif the user has an up-to-date browser, there’s a non-zero chance that Adobe Flash may still\nbe vulnerable to 1-day exploits. Now that Adobe Flash is about to reach its end-of-life date at\nthe end of this year, it is disabled by default in all web browser and has pretty much been\nreplaced with open standards such as HTML5, WebGL, WebAssembly. The decline of exploit\nkits can be linked to the decline of Adobe Flash, but exploit kits have not disappeared\ncompletely. They have adapted and switched to target users of Internet Explorer without the\nlatest security updates installed.\n\nMicrosoft Edge replaced Internet Explorer as a default web browser with the release of\nWindows 10 in 2015, but Internet Explorer is still installed for backward compatibility on\nmachines running Windows 10 and it has remained a default web browser for Windows\n\n\n-----\n\n7/8/8.1. The switch to Microsoft Edge development also meant that Internet Explorer would\nno longer be actively developed and would only receive vulnerability patches without general\nsecurity improvements. Still, somehow, Internet Explorer remains a relatively popular web\n[browser. According to NetMarketShare, as of April 2020 Internet Explorer is used on 5.45%](https://meterpreter.org/netmarketshare-april-data-windows-os-decrease-edge-was-firmly-in-second-place/)\nof desktop computers (for comparison, Firefox accounts for 7.25%, Safari 3.94%, Edge\n7.76%). Despite the security of Internet Explorer being five years behind that of its modern\n[counterparts, it supports a number of legacy script engines. CVE-2018-8174 is a vulnerability](https://securelist.com/delving-deep-into-vbscript-analysis-of-cve-2018-8174-exploitation/86333/)\nin a legacy VBScript engine that was originally discovered in the wild as an exploited zeroday. The majority of exploit kits quickly adopted it as their primary exploit.\n\n[Since the discovery of CVE-2018-8174 a few more vulnerabilities for Internet Explorer have](https://securelist.com/delving-deep-into-vbscript-analysis-of-cve-2018-8174-exploitation/86333/)\nbeen discovered as in-the-wild zero-days: CVE-2018-8653, CVE-2019-1367, CVE-20191429, and CVE-2020-0674. All of them exploited another legacy component of Internet\nExplorer – a [JScript engine. It felt like it was just a matter of time until exploit kits adopted](https://googleprojectzero.blogspot.com/2017/12/apacolypse-now-exploiting-windows-10-in_18.html)\nthese new exploits.\n\nExploit kits still play a role in today’s threat landscape and continue to evolve. For this\nblogpost I studied and analyzed the evolution of one of the most sophisticated exploit kits out\nthere – Magnitude EK – for a whole year.\n\nThis blogpost in a nutshell:\n\nMagnitude EK continues to deliver ransomware to Asia Pacific (APAC) countries via\nmalvertising\nStudy of the exploit kit’s activity over a period of 12 months shows that Magnitude EK is\nactively maintained and undergoes continuous development\nIn February this year Magnitude EK switched to an exploit for the more recent\nvulnerability CVE-2019-1367 in Internet Explorer (originally discovered as an exploited\nzero-day in the wild)\nMagnitude EK uses a previously unknown elevation of privilege exploit for CVE-20188641 developed by a prolific exploit writer\n\n## Introduction\n\nMagnitude EK is one of the longest-standing exploit kits. It was on offer in underground\nforums from [2013 and later became a private exploit kit. As well as a change of actors, the](https://malware.dontneedcoffee.com/2014/02/and-real-name-of-magnitude-is.html)\n[exploit kit has switched its focus to deliver ransomware to users from specific Asia Pacific](https://blog.trendmicro.com/trendlabs-security-intelligence/magnitude-exploit-kit-now-targeting-korea-with-magniber-ransomware/)\n(APAC) countries via malvertising.\n\n\n-----\n\n_Active attacks by Magnitude EK in 2019 according to Kaspersky Security Network (KSN)_\n_[(download)](https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2020/06/23085939/sl_magnitude_exploit_kit_01-en-2019.png)_\n\n\n-----\n\n_Active attacks by Magnitude EK in 2020 according to Kaspersky Security Network (KSN)_\n_[(download)](https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2020/06/23090011/sl_magnitude_exploit_kit_02-en-2020.png)_\n\nOur statistic shows that this campaign continues to target APAC countries to this day and\nduring the year in question Magnitude EK always used its own ransomware as a final\npayload.\n\n### Infection vector\n\n[Like the majority of exploit kits out there, in 2019 Magnitude EK used CVE-2018-8174.](https://securelist.com/delving-deep-into-vbscript-analysis-of-cve-2018-8174-exploitation/86333/)\nHowever, the attackers behind Magnitude EK were one of the first to adopt the much newer\n[vulnerability CVE-2019-1367 and they have been using it as their primary exploit since](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-1367)\n\n\n-----\n\nFebruary 11, 2020. As was the case with CVE-2018-8174, they didn t develop their own\nexploit for CVE-2019-1367, instead reusing the original zero-day and modifying it with their\nown shellcode and obfuscation.\n\nCVE-2019-1367 is a Use-After-Free vulnerability due to a garbage collector not tracking a\nvalue that was not rooted in the legacy JavaScript engine jscript.dll. By default, Internet\nExplorer 11 uses Jscript9.dll, but it’s still possible to execute the script using the legacy\nengine by enabling compatibility mode with Internet Explorer 7/8. This can be done with the\nfollowing script attributes:\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n\n<meta http-equiv=\"x-ua-compatible\" content=\"IE=EmulateIE8\" />\n\n<script language=\"JScript.Compact\">…</script>\n\n<meta http-equiv=\"x-ua-compatible\" content=\"IE=EmulateIE8\" />\n\n<script language=\"JScript.Encode\">…</script>\n\n\n[The original exploit uses JScript.Compact, a special profile defined for embedded devices.](https://www.ecma-international.org/publications/files/ECMA-ST-WITHDRAWN/Ecma-327.pdf)\nBut JScript.Encode is much more interesting because it was developed by Microsoft to\nprotect scripts and prevent source code from being copied. This script attribute can execute\nscripts encoded with Microsoft Script Encoder (screnc.exe) and it also disables script\ndebugging. Basically, it’s a DRM for JavaScript. Magnitude EK changed from its original\nexploit to take advantage of this feature.\n\n\n-----\n\n**_Exploit packed with JScript.Encode technique_**\n\n**_Unpacked exploit. Shellcode, names and some strings are obfuscated_**\n\n## Shellcode\n\n\n-----\n\nTheir shellcodes piqued my interest. They use a huge number of different shellcode\nencoders, from the classical Metasploit shikata_ga_nai encoder and DotNetToJScript to a\nvariety of custom encoders and stagers.\n\nIt was also impossible not to notice the changes happening to their main shellcode\nresponsible for launching the ransomware payload. The attackers are fine-tuning their\narsenal on a regular basis.\n\nMagnitude EK has existed since at least 2013, but below you can see just the changes to\npayload/shellcode that occurred over the period of one year (June 2019 to June 2020).\nDuring this period we observed attacks happening almost every day.\n\n**Timeline of shellcode/payload changes**\n\nDate Description\n\n\nJune\n2019\n\nJuly 20,\n2019\n\nNovember\n11, 2019\n\nNovember\n20, 2019\n\nNovember\n23, 2019\n\n\nShellcode downloads a payload that’s decrypted with a custom xor-based\nalgorithm. All strings are assembled on stack and to change payload the URL\nshellcode needs to be recompiled. The payload is a PE module. The module\nexport function name is hardcoded to “GrfeFVGRe”. The payload is executed\nin an Internet Explorer process. It contains an elevation of privilege exploit\nwith support for x86 and x64 versions of Windows and an encrypted\nransomware payload. After elevation of privilege it injects the ransomware\npayload to other processes, spawns the wuapp.exe process and injects there\nas well. If process creation fails, it also runs the ransomware from the current\nprocess.\n\nPayload module export function name is auto-generated.\n\nShellcode tries to inject the payload to other processes. If API function\nProcess32First fails, it spawns the process wuapp.exe from Windows\ndirectory and injects the payload there. The injection method is\nWriteProcessMemory + CreateRemoteThread.\nThe payload is ransomware without elevation of privilege. The payload\nmodule export function name is hardcoded again, but now to “lssrcdxhg”.\n\nLooks like they messed up the folder with shellcodes; in some attacks they\nuse a shellcode from June, and later the same day they start to use their\nNovember shellcode with the new hardcoded export name\n“by5eftgdbfgsq323”.\n\nThey start to use the elevation of privilege exploit again, but now they also\ncheck the integrity level of the process. If it’s a low integrity process, then they\nexecute the payload with the exploit in the current process; if that’s not the\ncase, then it’s injected into other processes. The process is no longer created\nfrom shellcode, but it’s still created from the payload. The payload module\nexport name is hardcoded to “gv65eytervsawer2”.\n\n\n-----\n\nJanuary\n17, 2020\n\nJanuary\n27, 2020\n\nFebruary\n4, 2020\n\nFebruary\n10, 2020\n\nFebruary\n11, 2020\n\nFebruary\n17, 2020\n\nFebruary\n28, 2020\n\nMarch 1,\n2020\n\nMarch 6,\n2020\n\nMarch 10,\n2020\n\nMarch 16,\n2020\n\n\nIt looks like the attackers had a short holiday at the beginning of the year. The\nshellcode remains the same, but the payload module export function name is\nhardcoded to “i4eg65tgq3f4”. The payload changed a bit. The name of the\ncreated process is now assembled on stack. The name of the process also\nchanged – it no longer spawns a wuapp.exe, but instead launches the\ncalculator calc.exe and injects the ransomware payload there.\n\nThe payload is no longer a PE module but plain shellcode. The payload\nconsists of ransomware without elevation of privilege.\n\nThe payload is a PE module again, but once again the export name is autogenerated.\n\nThe shellcode comes with two URLs for different payloads. The shellcode\nchecks the integrity level and depending on process integrity level, it executes\nthe elevation of privilege payload or uses the ransomware payload\nstraightaway. All strings and function imports in the exploit are now\nobfuscated. The payload does not spawn a new process, and only injects to\nothers.\n\nMagnitude EK starts using CVE-2019-1367 as its primary exploit. The\nattackers use the shellcode from January 27, 2020, but they have modified it\nto check for the name of a particular process. If the process exists, they don’t\nexecute the payload from Internet Explorer. The process name is “ASDSvc”\n(AhnLab, Inc.).\n\nThe attackers switch to the shellcode from February 10, 2020, but the\npayload module export function name is hardcoded to “xs324qsawezzse”.\n\nShellcode encryption is removed. The payload module export function name\nis hardcoded to “sawd6vf3y5”.\n\nStrings are no longer stored on stack.\n\nBack to the shellcode from February 17, 2020.\n\nThe attackers add some functionality implemented after February 17, 2020:\npayload encryption is removed and strings are no longer stored on stack. The\npayload module export function name is still hardcoded to “xs324qsawezzse”.\n\nFunctionality added so as not to inject into a particular process (explorer.exe).\nThe injection method is also changed to NtCreateSection +\nNtMapViewOfSection + RtlCreateUserThread.\n\n\n-----\n\nApril 2,\n2020\n\nApril 4,\n2020\n\nApril 7,\n2020\n\nMay 5,\n2020\n\nMay 6,\n2020\n\n\nThe attackers add some functionality similar to that used in November 2019.\nThey check the integrity level of a process and if it’s a low integrity process,\nthey execute the payload from the current process. If that’s not the case, they\ninject it to other processes (other than explorer.exe) and at the end create a\nnew process and inject it there as well. The created processes are\nC:\\Program Files\\Windows Media Player\\wmlaunch.exe or C:\\Program Files\n(x86)\\Windows Media Player\\wmlaunch.exe depending on whether it’s a\nWOW64 process or not.\n\nShellcode updated to use a new injection technique: NtQueueApcThread.\nThe shellcode also comes with a URL for a ransomware payload without\nelevation of privilege. The shellcode checks the integrity level and if it’s a low\nintegrity process, the shellcode calls ExitProcess(). Use of the hardcoded\nexport name “xs324qsawezzse” is also stopped.\n\nBack to the shellcode from April 2, 2020.\n\nPreviously the attackers adjusted their injection method, but now they revert\nback to injection via the WriteProcessMemory + CreateRemoteThread\ntechnique.\n\nThey continue to make changes to the code injection method. From now on\nthey use NtCreateThreadEx.\n\n\n## Elevation of privilege exploit\n\nThe elevation of privilege exploit used by Magnitude EK is quite interesting. When I saw it for\nthe first time, I wasn’t able to recognize this particular exploit. It exploited a vulnerability in\nthe win32k kernel driver and closer analysis revealed that this particular vulnerability was\nfixed in December 2018. According to Microsoft, only two win32k-related elevation of\nprivilege vulnerabilities were fixed that month – CVE-2018-8639 and CVE-2018-8641.\nMicrosoft previously shared more information with us about CVE-2018-8639, so we can say\nwith some certainty that the encountered exploit uses vulnerability CVE-2018-8641. The\nexploit has huge code similarities with another zero-day that we had found previously – CVE2019-0859. Based on these similarities, we attribute this exploit to the prolific exploit writer\nknown as “Volodya”, “Volodimir” or “BuggiCorp”. Volodya is famous for selling zero-day\nexploits to both APT groups and criminals. In the past, Volodya advertised his services at\nexploit(dot)in, the same underground forum where Magnitude EK was once advertised. We\ndon’t currently know if the exploit for CVE-2018-8641 was initially used as a zero-day exploit\nor it was developed as a 1-day exploit through patch diffing. It’s also important to note that a\npublic exploit for CVE-2018-8641 also exists, but it’s incorrectly designated to CVE-20188639 and it exploits the vulnerability in another fashion, meaning there are two completely\ndifferent exploits for the same vulnerability.\n\n## Ransomware\n\n\n-----\n\nMagnitude EK uses its own ransomware as its final payload. The ransomware comes with a\ntemporary encryption key and list of domain names and the attackers change them\nfrequently. Files are encrypted with the use of Microsoft CryptoAPI and the attackers use\nMicrosoft Enhanced RSA and AES Cryptographic Provider (PROV_RSA_AES). The\ninitialization vector (IV) is generated pseudo randomly for each file and a 0x100 byte long\nblob with encrypted IV is appended to the end of the file. The ransomware doesn’t encrypt\nthe files located in common folders such as documents and settings, appdata, local settings,\nsample music, tor browser, etc. Before encryption, the extensions of files are checked\nagainst a hash table of allowed file extensions that contains 715 entries. A ransom note is\nleft in each folder with encrypted files and at the end a notepad.exe process is created to\ndisplay the ransom note. To hide the origin of the executed process, the ransomware uses\none of two techniques: “wmic process call create” or “pcalua.exe –a … -c …”. After\nencryption the ransomware also attempts to delete backups of the files with the “wmic\nshadowcopy delete” command that is executed with a UAC-bypass.\n\n**_Example of Magnitude EK ransom note_**\n\nThe core of the ransomware did not undergo many changes throughout the year. If we\ncompare old samples with more recent versions, there are only a few notable changes:\n\n\n-----\n\nIn older versions, immediately at launch the payload gets the default UI language of the\noperating system using the GetSystemDefaultUILanguage API function and compares\nthe returned value against a couple of hardcoded language IDs (e.g. zh-HK – Hong\nKong S.A.R., zh-MO – Macao S.A.R., zh-CN – People’s Republic of China, zh-SG –\nSingapore, zh-TW – Taiwan, ko-KR – Korea, ms-BN – Brunei Darussalam, ms-MY –\nMalaysia). If the language ID doesn’t match, then ExitProcess() will be executed. In\nnewer versions, the check for the language ID was removed.\nIn older versions, the ransomware deletes file backups with the command “cmd.exe /c\n“%SystemRoot%\\system32\\wbem\\wmic shadowcopy delete” via UAC-bypass in\neventvwr.exe. In the newer version, the command is obfuscated with caret character\ninsertion “cmd.exe /c “%SystemRoot%\\system32\\wbem\\wmic ^s^h^a^d^o^w^c^o^p^y^\n^d^e^l^e^t^e” and executed via UAC-bypass in CompMgmtLauncher.exe.\n\n## Conclusions\n\nThe total volume of attacks performed by exploit kits has decreased, but they still exist, are\nstill active, and still pose a threat, and therefore need to be treated seriously. Magnitude is\nnot the only active exploit kit and we see other exploit kits that are also switching to newer\nexploits for Internet Explorer. We recommend installing security updates, migrating to a\nnewer operating system (make sure you stay up to date with Windows 10 builds) and also\nnot using Internet Explorer as your web browser. Throughout the entire Magnitude EK\ncampaign we have detected the use of Internet Explorer exploits with the verdict\nPDM:Exploit.Win32.Generic.\n\n[Browser](https://securelist.com/tag/browser/)\n[Exploit Kits](https://securelist.com/tag/exploit-kits/)\n[Malware Descriptions](https://securelist.com/tag/malware-descriptions/)\n[Malware Technologies](https://securelist.com/tag/malware-technologies/)\n[Ransomware](https://securelist.com/tag/ransomware/)\n[Vulnerabilities and exploits](https://securelist.com/tag/vulnerabilities-and-exploits/)\n\nAuthors\n\nBoris Larin\n\nMagnitude exploit kit – evolution\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-24 - Magnitude exploit kit - evolution.pdf"
    ],
    "report_names": [
        "2020-06-24 - Magnitude exploit kit - evolution.pdf"
    ],
    "threat_actors": [
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535705,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1653714576,
    "ts_modification_date": 1653714576,
    "files": {
        "pdf": "https://archive.orkl.eu/85a9c748ebd276ec22b27f5358bc8d6596ea1440.pdf",
        "text": "https://archive.orkl.eu/85a9c748ebd276ec22b27f5358bc8d6596ea1440.txt",
        "img": "https://archive.orkl.eu/85a9c748ebd276ec22b27f5358bc8d6596ea1440.jpg"
    }
}