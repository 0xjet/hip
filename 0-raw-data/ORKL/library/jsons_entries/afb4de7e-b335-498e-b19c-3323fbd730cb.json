{
    "id": "afb4de7e-b335-498e-b19c-3323fbd730cb",
    "created_at": "2023-01-12T15:04:37.259529Z",
    "updated_at": "2025-03-27T02:05:50.06511Z",
    "deleted_at": null,
    "sha1_hash": "0ed717f2f3c05d4bc61d875cdce12fba185d387f",
    "title": "2020-02-28 - Golang wrapper on an old obscene malware",
    "authors": "",
    "file_creation_date": "2022-05-28T21:41:13Z",
    "file_modification_date": "2022-05-28T21:41:13Z",
    "file_size": 305217,
    "plain_text": "# Golang wrapper on an old obscene malware\n\n**[sysopfb.github.io/malware/2020/02/28/Golang-Wrapper-on-an-old-malware.html](https://sysopfb.github.io/malware/2020/02/28/Golang-Wrapper-on-an-old-malware.html)**\n\nRandom RE February 28, 2020\n\nFeb 28, 2020\n\n[The malware in this report has been blogged about before by a Russian researcher1, he](https://habr.com/ru/post/27040/)\nreferred to is as “Obscene Trojan” so that’s what I will also call it and we will go over it’s\nfunctionality in depth later in this blog but the more interesting part to me is the initial layer\naround the malware, it’s in Golang! This layer serves both as a wrapper layer that you would\nnormally expect to see with crypters but also a dropper as it drops the decoded malware to\ndetonate it instead of loading it into memory but the concept of a golang crypter is interesting\nnonetheless and after going through all the layers I stepped back and checked what the\ndetection ratings were and was incredibly surprised to find that these wrapper layers took a\n12 year old malware from completely detected to almost FUD.\n\nInitial sample: 769d1396b0cef006bcaafd2de850fc97bf51fd14813948ef2bc3f8200bcb5eab\n\nThis Golang wrapper is designed to ZLIB decompress and RC4 decrypt the next file hidden\ninside itself.\n\n\n-----\n\nDumping the data blog out we can verify this manually.\n```\n>>> open('test.zz', 'wb').write(t)\n>>> zobj = zlib.decompressobj()\n>>> t2 = zobj.decompress(t)\n>>> t2[:100]\n'\\x9e\\xd6\\x02\\x1e\\x19n\\xa0^\\xd0\\x83Ga\\xcfq\\xd6\\x08\\x943\\x00\\x7f\\xf4n\\x96\\x05\\xe5\\xf7\\x\n\\xc4<R\\xf5'\n>>> rc4 = ARC4.new('vckxjm')\n>>> t3 = rc4.decrypt(t2)\n>>> t3[:100]\n'MZ\\x90\\x00\\x03\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\xff\\xff\\x00\\x00\\x8b\\x00\\x00\\x00\\x00\\x00\\x0\n program cannot be'\n\n```\nNext layer: 0015001917bc98a899536c6d72fcf0774e5b14ab66f07ccbdc4cc205d70475dd\n\nAfter decoding the next exe file out we are left with another golang wrapped file that does the\nsame thing as the previous layer but it has a differen’t RC4 key.\n\n\n-----\n\nNext unpacked file:\nde2688f007dac98b579d5ed364febc8bb07bc3dc26e4b548d659ecb1974d9f46\n\nThis file appears to be a SFX RAR exe but at the end of the day it is also just another layer\nand is designed to drop an EXE file to disk and detonate it.\n\nDropped binary:\nafa085105a16b1284a811da11db2457778c4a267f2fa8a551dec3b8a665c11f9\n\nThis file looks like a compiled lua binary but we don’t really need to decompile it as we can\nsee a large base64 blob inside it and a similar looking 6 byte string below it.\n```\n<snip>\ndIMAASIwzdmExocRQqzw0ytzQGCfKbvWFXldCcNuyFmZY0eOxzmzJtMrzn1VV6VBF8hH6CZpopOVvkCx\nQpeoBQy3fp/3XNCVyDc90aYiPtcwqjfbX3jSEDbspcg8AT08aUmJqm+RU53bFB8u3vL+HQzNNv17YHeX\nkHA5yz6ttQuwpZ0rzTHvh11DBxVFQwWLaVi1Y718ORqmrc5DcWTMCvEjagiP4qeJWUmP2N0XwQ08fXU1\nbuFfXfD6xBg8ugXKanSFFTsGuIJIC+QPePPjvTWoeJueb4y5IvPVJUT688HgNTo18eufF2CCyjMs/Zem\nXb+7K1DeYNbF/mPbJrcqtovOdd7X4HSwcbh+0MwwWNnWak4kCT/JRumZBztD1iBMuVIJZv0V/48+rBq9\nnHigHzW0fv6XFFZhzThqkHx0GEr9i/MMromlXCHSm7A=\nrc4_key\nyovzgz\n    tmp_file\ngetenv\nTEMP\ntmpname\n.exe\n\n```\nBase64 decoding and then RC4 decrypting this blob gives us our next binary:\n1ca71bba30fb17e83fea05ef5e2d467f86bff27b6087b574fa51f94f0f725441\n\n[This binary is the unpacked trojan that a blog from 2008 calls “Obscene Trojan”[1],](https://habr.com/ru/post/27040/)\ncoincidentally it also has a compilation timestamp of 2008 so I’m unsure if it was just recently\nuploaded or if someone is testing the crypter layers for detection.\n\nHas some anti debugging by using obscure opcodes that some debuggers can have\nproblems with.\n\n\n-----\n\n[Also a VM check[3].](https://www.aldeid.com/wiki/VMXh-Magic-Value)\n\nThe malware has most of its important strings encoded using a single byte XOR.\n\n\n-----\n\n```\nPython>for addr in XrefsTo(0x40f09e, flags 0):\n     addr = addr.frm\n     print(hex(addr)),\n     addr = idc.PrevHead(addr)\n     offset = GetOperandValue(addr, 0)\n     t = GetString(offset)\n     t = bytearray(t)\n     for i in range(len(t)):\n          t[i] ^= 2\n     print(t)\nPython>\n0x40f22eL advapi32.dll\n0x40f256L kernel32.dll\n0x40f27eL GetProcAddress\n0x40f2acL GetEnvironmentVariableA\n0x40f2daL WinExec\n0x40f308L CopyFileA\n0x40f336L SetFileAttributesA\n0x40f364L RegSetValueExA\n0x40f392L RegOpenKeyA\n0x40f3c0L RegCloseKey\n0x40f3eeL http://fewfwe.com/\n0x40f400L http://fewfwe.net/\n0x40f421L cftmon.exe\n0x40f442L spools.exe\n0x40f463L ftpdll.dll\n0x40f541L Software\\Microsoft\\Windows\\CurrentVersion\\Run\\\n0x40f5d8L SYSTEM\\CurrentControlSet\\Services\\Schedule\n0x40f68bL SystemDrive\n0x40f8c2L windir\n0x40f8deL COMRUTERNAME\n0x40f8f0L \\system32\n0x40f911L USERPROFILE\n0x40f938L \\Local Settings\\Application Data\n0x40f97fL \\drivers\\\n0x40f9b7L \\Local Settings\\Application Data\\\n0x40f9efL \\update.dat\n0x40fa16L \\drivers\\\n0x40fa2dL sysproc.sys\n0x40fa54L \\mpr.dat\n0x40fa7bL \\mpr2.dat\n0x40faa2L \\mpr32.dat\n0x40fb61L \\mpz.tmp\n0x40fb88L \\r43q34.tmp\n0x40fda5L wininet.dll\n0x40fdcbL InternetOpenA\n0x40fdf7L InternetOpenUrlA\n0x40fe23L InternetReadFile\n0x410007L Content-Type: application/x-www-form-urlencoded\n0x410304L c:\\stop\n\n```\nThere is also an encoded file stored inside of it which was also blogged about in 2008 but\nwas discussed as being downloaded by the previous trojan instead of being dropped\n[directly[2]: f198e63cc1ba3153e27905881bcb8a81fa404f659b846b972b1c8f228e4185d4](https://habr.com/ru/post/27053/)\n\n\n-----\n\nThe trojan sets the filename that it will have.\n\nThis DLL will hook send, WSASend, recv and WSARecv; primarily for harvesting data from\ntraffic over ports 110, 80, 25 and 21. The harvested data is written to files while the main\ntrojan piece will read the files and ship the data off.\n\nReceiving function hooks:\n\n\n-----\n\nSending function hooks:\n\n\n-----\n\nThe receiving hook checks which port is being used before harvesting data.\n\n\n-----\n\nThe data being harvested looks like email data which will be written to one of the files.\n\n\n-----\n\nThe send hook function performs similar harvesting but it also has different code for port 21\nand 80 traffic. For port 21 it will check for ‘USER’ and ‘PASS’ such as with FTP traffic.\n\n\n-----\n\nThe data will then be harvested.\n\nThe data will be written to a different file.\n\n\n-----\n\nThe send hook code will also look for ‘gzip,’ in outbound over port 80 and overwrite it,\nprobably to prevent an Accept-Encoding header from including gzip.\n\nAs I mentioned at the beginning of the blog the most interesting aspect of this to me\npersonally is the ability of a few simple wrappers and a golang crypter taking an old malware\nto almost FUD.\n\n\n-----\n\nReferences:\n\n1. https://habr.com/ru/post/27040/\n2. https://habr.com/ru/post/27053/\n3. https://www.aldeid.com/wiki/VMXh-Magic-Value\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-02-28 - Golang wrapper on an old obscene malware.pdf"
    ],
    "report_names": [
        "2020-02-28 - Golang wrapper on an old obscene malware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535877,
    "ts_updated_at": 1743041150,
    "ts_creation_date": 1653774073,
    "ts_modification_date": 1653774073,
    "files": {
        "pdf": "https://archive.orkl.eu/0ed717f2f3c05d4bc61d875cdce12fba185d387f.pdf",
        "text": "https://archive.orkl.eu/0ed717f2f3c05d4bc61d875cdce12fba185d387f.txt",
        "img": "https://archive.orkl.eu/0ed717f2f3c05d4bc61d875cdce12fba185d387f.jpg"
    }
}