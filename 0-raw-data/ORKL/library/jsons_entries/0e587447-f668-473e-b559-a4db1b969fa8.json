{
    "id": "0e587447-f668-473e-b559-a4db1b969fa8",
    "created_at": "2023-01-12T15:05:50.21379Z",
    "updated_at": "2025-03-27T02:05:38.379277Z",
    "deleted_at": null,
    "sha1_hash": "80cb392d9f83dc81c8ecc1636f123b5beb22c8e0",
    "title": "2020-06-02 - Hunting Malicious Macros",
    "authors": "",
    "file_creation_date": "2022-05-27T19:09:46Z",
    "file_modification_date": "2022-05-27T19:09:46Z",
    "file_size": 776548,
    "plain_text": "# Hunting Malicious Macros\n\n**[blog.pwntario.com/team-posts/antons-posts/hunting-malicious-macros](https://blog.pwntario.com/team-posts/antons-posts/hunting-malicious-macros#first)**\n\nHunting Malicious Macros\n\n1. 1.\n\n[Hunting Malicious Macros](https://blog.pwntario.com/team-posts/antons-posts/hunting-malicious-macros#first)\n\nTaking a look at the MITRE ATT&CK page for malicious macros, it's clear that this technique\nis a favourite among APT groups.\n\nMicrosoft Office is indeed ubiquitous in a corporate office setting and presents defenders with\na very large attack surface.\n\n\"Just disable macros\" is a great idea, but many critical business processes run on the back\nof decades-old macros; for better or for worse.\n\nTo get a sense of how widely malicious macros are utilized, take a look at the technique via\nMITRE: [T1566.001](https://attack.mitre.org/beta/techniques/T1566/001/)\nIn this post I will cover detection techniques that provide relatively robust coverage for\ndetecting malicious macros in your own environment. I'll be using Sysmon to generate the\nlog data and Splunk to query that data, I'll also highlight some Sigma rules that can help with\nMacro detections.\n\nBefore I dive in, I need to acknowledge that this work definitely stands on the shoulders of\ngiants and I'll be referencing their work heavily throughout.\n\nAtomic Red Team\n\nRed Canary have done the defensive world a huge solid and have provided a script that\ngenerates macros for you so that detections can be tested, so let's start there:\n\n[Blog Post](https://redcanary.com/blog/testing-initial-access-with-generate-macro-in-atomic-red-team/)\n[Script Used](https://github.com/redcanaryco/atomic-red-team/blob/master/ARTifacts/Initial_Access/generate-macro.ps1)\n```\nNote: Originally these macro tests download other scripts from the Red\nCanary repo to do other things with the macro, for the purposes of my\ntesting, however, I only wanted to test the original macro execution so I\nmodified these scripts slightly to just call out to Google instead of\nrunning the full blown tests.\n\n```\nWe generate our macro, which outputs an Excel file:\n\n\n-----\n\nNow let's take a look at what Sysmon shows us when this macro is executed, using the\n[SwiftOnSecurity Config](https://github.com/SwiftOnSecurity/sysmon-config/blob/master/sysmonconfig-export.xml)\nUsing this basic Splunk Query:\n\n1\n\nindex=sysmon EventCode=1 Image=*Excel*\n\n2\n\n| table Image,ParentImage,CommandLine\n\nCopied!\n\nGives us these results:\n\nNot very interesting, the typical \"Excel has Spawned PowerShell or a Command Prompt\"\ndetection has failed here, as these macros use techniques which circumvent this particular\ndetection (More details about this are in the Red Canary Blog post linked above)\n\nIf we observe Excel behaviour through something like Procmon, we can see that Excel loads\nspecific DLLs when a macro is loaded. We can configure Sysmon to look for this type of\nbehaviour.\n\nLet's enhance our Sysmon config a little bit with the following:\n\n1\n\n\n-----\n\n<RuleGroup name= groupRelation= or >\n\n2\n\n<ImageLoad onmatch=\"include\">\n\n3\n\n<Rule name=\"Macro Image Load\" groupRelation=\"or\">\n\n4\n\n<ImageLoaded condition=\"end with\">VBE7INTL.DLL</ImageLoaded>\n\n5\n\n<ImageLoaded condition=\"end with\">VBE7.DLL</ImageLoaded>\n\n6\n\n<ImageLoaded condition=\"end with\">VBEUI.DLL</ImageLoaded>\n\n7\n\n</Rule>\n\n8\n\n</ImageLoad>\n\n9\n\n</RuleGroup>\n\nCopied!\n\nWith this logic, we should see an event when any of the above DLLs are loaded.\n\nAfter updating the Sysmon config and running the macro again, we can now do something\nlike:\n\n1\n\nindex=sysmon RuleName=\"Macro Image Load\"\n\n2\n\n| stats values(ImageLoaded) by Image\n\n\n-----\n\nCopied!\n\nWhich gives us these results:\n\nNow we know that a macro was executed by Excel which is a great start. As mentioned\nearlier, these macro tests break typical process hierarchy detections, so searching for what\nspawned out of Excel directly is not going to work in this case.\n\nAll we know so far from a detection standpoint is that Excel executed some kind of macro,\nbut we don't know what the macro did or whether it was malicious or not. We can, however,\npivot off the data point that we do have and group our events by time to see what was\nlaunched around the time that the Excel macro was executed.\n\n1\n\nindex=sysmon\n\n2\n\n| bin span=5s _time\n\n3\n\n| stats values(RuleName),values(Image),values(CommandLine) by _time\n\nCopied!\n\nWe group our events into buckets of 5 second time intervals - my thinking here is the\nmalicious processes executed via the macro may not spawn directly from Excel, but they\nwould be grouped together tightly by time.\n\nIn this query, I am not querying for a specific event type, I just want to see all Sysmon events\ngrouped into time buckets, and then I want to take a look at the events surrounding the\n\"Macro Image Load\" rule name.\n\nLet's take a look at the results:\n\nWe caught some false positives in our little dragnet, but also found the 'malicious' commands\nexecuted by our macro.\n\n\n-----\n\nContinuing with the Red Canary macro tests, let s look at option 2 in the tests: Chain\n_Reaction Download and execute with Excel, wmiprvse_\n\nUsing the same time bucketing technique, we can see the execution of wmiprvse.exe around\nthe time that an Excel macro was launched:\n\nIf we observe Excel behaviour when launching normally versus launching a macro that loads\nwmiprvse.exe, we can see the wbemdisp.dll being loaded, so let's add that to our Sysmon\nconfig as well:\n\n1\n\n<Rule groupRelation=\"and\" name=\"Office WMI Image Load\">\n\n2\n\n<Image condition=\"begin with\">C:\\Program Files (x86)\\Microsoft Office\\root\\Office16\\\n</Image>\n\n3\n\n<ImageLoaded\ncondition=\"is\">C:\\Windows\\SysWOW64\\wbem\\wbemdisp.dll</ImageLoaded>\n\n4\n\n</Rule>\n\nCopied!\n\n[I came across this particular detection technique in Samir's fantastic blog post:](https://twitter.com/SBousseaden)\n[https://blog.menasec.net/2019/02/threat-hunting-doc-with-macro-invoking.html](https://blog.menasec.net/2019/02/threat-hunting-doc-with-macro-invoking.html)\n_If you are at all interested in Threat Hunting, I highly encourage you to check that blog out_\n_and give Samir a follow_\n\nThis rule will fire when the wbemdisp.dll is loaded by any executable within the Office16\nfolder, it can be tuned to be more specific as well.\n\nHere's what the data looks like in Splunk:\n\n\n-----\n\nNow let's take a look at the Red Canary tests number 4 and 5 - Shell and\nShellBrowserWindow. These two methods interact with COM, so we can configure our\nSysmon Config as follows:\n\n1\n\n<Rule groupRelation=\"and\" name=\"Office COM Image Load - Combase\">\n\n2\n\n<Image condition=\"begin with\">C:\\Program Files (x86)\\Microsoft Office\\root\\Office16\\\n</Image>\n\n3\n\n<ImageLoaded condition=\"is\">C:\\Windows\\SysWOW64\\combase.dll</ImageLoaded>\n\n4\n\n</Rule>\n\n5\n\n<Rule groupRelation=\"and\" name=\"Office COM Image Load - coml2\">\n\n6\n\n<Image condition=\"begin with\">C:\\Program Files (x86)\\Microsoft Office\\root\\Office16\\\n</Image>\n\n7\n\n<ImageLoaded condition=\"is\">C:\\Windows\\SysWOW64\\coml2.dll</ImageLoaded>\n\n8\n\n</Rule>\n\n9\n\n<Rule groupRelation=\"and\" name=\"Office COM Image Load - comsvc\">\n\n10\n\n\n-----\n\n<Image condition= begin with >C:\\Program Files (x86)\\Microsoft Office\\root\\Office16\\\n</Image>\n\n11\n\n<ImageLoaded condition=\"is\">C:\\Windows\\SysWOW64\\comsvcs.dll</ImageLoaded>\n\n12\n\n</Rule>\n\nCopied!\n\nFiring up our macros again and looking at the following Splunk query:\n\n1\n\nindex=sysmon Image=*Excel*\n\n2\n\n| stats values(ImageLoaded) by Image,RuleName\n\nCopied!\n\nWe can see Excel loading the Macro as well as COM DLLs:\n\nNow we know that Excel launched some kind of macro, and used COM, neat!\n\nExcel 4 Macros\n\n[Outflank publishes tons of next-level macro techniques regularly, let's take a look at the](https://www.outflank.nl/)\n[following script which is a Proof of Concept which uses COM to generated an Excel 4 Macro](https://github.com/outflanknl/Scripts/blob/master/ShellcodeToJScript.js)\nto load Shellcode via JScript.\nA few things stand out as abnormal using this technique, using the data we have already in\nour Sysmon config, we can see:\n\nExcel Loading a COM DLL\n\nExcel being launched from a non-standard directory\n\n\n-----\n\nRunPE\n\nI used [Clement Labro's implementation of RunPE in my testing, you can grab it here and](https://twitter.com/itm4n)\nread more about it here:\n\n[https://itm4n.github.io/vba-runpe-part1/](https://itm4n.github.io/vba-runpe-part1/)\n[https://itm4n.github.io/vba-runpe-part2/](https://itm4n.github.io/vba-runpe-part2/)\n\nClement describes the technique succinctly:\n\n[RunPE] consists in running code inside the memory of a legit process in order to hide\nits actual activity.\n\nTo my simpleton brain, if I hear \"inside the memory of a legit process\" I think of injection, so\nlet's configure our Sysmon config to look for this, with the following snippet:\n\n1\n\n<RuleGroup name=\"\" groupRelation=\"or\">\n\n2\n\n<ProcessAccess onmatch=\"include\">\n\n3\n\n<Rule groupRelation=\"and\" name=\"Office Injection via VBA\">\n\n4\n\n<SourceImage condition=\"begin with\">C:\\Program Files (x86)\\Microsoft Office\\Root\\Office16\\\n</SourceImage>\n\n5\n\n<CallTrace condition=\"contains\">\\Microsoft Shared\\VBA</CallTrace>\n\n6\n\n</Rule>\n\n7\n\n</ProcessAccess>\n\n\n-----\n\n8\n\n</RuleGroup>\n\nCopied!\n\nTaking a look at the data this produces, we see Word injecting into Word via VBA:\n\nPutting the pieces together a little bit, we're starting to get a good idea of what our Office\nProcesses are doing, we can see:\n\nWMI ImageLoads by Office Processes\n\nVBA ImageLoads by Office Processes\n\nOffice Injections via VBA\n\nCOM use by Office Processes\n\nEvil Clippy\n\nEvilClippy is a tool created by Outflank that provides functionality to stomp VBA code and\nhide macros from the Office GUI, you can grab the tool here:\n\n[https://github.com/outflanknl/EvilClippy](https://github.com/outflanknl/EvilClippy)\nAnd read more about VBA Stomping here:\n\n[https://vbastomp.com/](https://vbastomp.com/)\nI want to keep things super simple so I'm using the following \"real\" VBA code:\n\n1\n\nSub AutoOpen()\n\n2\n\nCall Shell(\"powershell.exe\", vbNormalFocus)\n\n3\n\nEnd Sub\n\n\n-----\n\nCopied!\n\nTo launch a PowerShell Window when I open up my Word doc, but I'm using EvilClippy to\n'stomp' the document with the following VBA Code:\n\n1\n\nSub AutoOpen()\n\n2\n\nCall Shell(\"calc.exe\", vbNormalFocus)\n\n3\n\nEnd Sub\n\nCopied!\n\nThis is what my document looks like, the VBA code is telling me the macro will launch calc,\nbut when I Enable Content, the document will launch PowerShell instead, sneaky!\n\nFake Macro Code:\n\nWhat the document actually does:\n\n\n-----\n\nWhile Sysmon can't detect VBA Stomping specifically, our current Sysmon config gives us a\nbunch of clues that a macro was executed and that our Word document executed\nPowerShell.\n\nLooking at the following Splunk query:\n\n1\n\nindex=sysmon EventCode=10\n\n2\n\n| table SourceImage,TargetImage,RuleName\n\nCopied!\n\nWe can see our earlier injection Sysmon config snippet being put to work:\n\nPutting it together - Covenant\n\nThus far we've looked at isolated techniques, but how well does our Sysmon configuration\nwork for a macro that launches a Covenant stager - let's find out.\n\n[Covenant is available here: https://github.com/cobbr/Covenant - thank you](https://github.com/cobbr/Covenant) [Ryan!](https://twitter.com/cobbr_io)\nAnd I am using the following post to generate my Macro:\n[https://3xpl01tc0d3r.blogspot.com/2020/02/gadgettojscript-covenant-donut.html - Thank you](https://3xpl01tc0d3r.blogspot.com/2020/02/gadgettojscript-covenant-donut.html)\n[Chirag!](https://twitter.com/chiragsavla94)\nWith everything in place, we can start our Word document and confirm that we see the\ncallback in Covenant:\n\n\n-----\n\nChecking our logs, we see that the VBA Images were loaded, so we know a macro ran, but\nnot much else, there's no processes spawned from Word since everything happens in\nmemory. How can we enhance our detections further?\n\nWe know that Covenant is a .NET framework, so we can assume that it needs to load some\ntype of .NET DLLs at startup.\n\nLet's add the following to our Sysmon config:\n\n1\n\n<Rule groupRelation=\"and\" name=\"Office .NET Abuse: Assembly DLLs\">\n\n2\n\n<Image condition=\"begin with\">C:\\Program Files (x86)\\Microsoft Office\\root\\Office16\\\n</Image>\n\n3\n\n<ImageLoaded condition=\"begin with\">C:\\Windows\\assembly\\</ImageLoaded>\n\n4\n\n</Rule>\n\n5\n\n<Rule groupRelation=\"and\" name=\"Office .NET Abuse: GAC\">\n\n6\n\n<Image condition=\"begin with\">C:\\Program Files (x86)\\Microsoft Office\\root\\Office16\\\n</Image>\n\n7\n\n<ImageLoaded condition=\"begin\nwith\">C:\\Windows\\Microsoft.NET\\assembly\\GAC_MSIL</ImageLoaded>\n\n8\n\n\n-----\n\n</Rule>\n\n9\n\n<Rule groupRelation=\"and\" name=\"Office .NET Abuse: CLR\">\n\n10\n\n<Image condition=\"begin with\">C:\\Program Files (x86)\\Microsoft Office\\root\\Office16\\\n</Image>\n\n11\n\n<ImageLoaded condition=\"end with\">clr.dll</ImageLoaded>\n\n12\n\n</Rule>\n\nCopied!\n\nLet's run our macro again and check the logs with the following query:\n\n1\n\nindex=sysmon EventCode=7\n\n2\n\n| stats values(ImageLoaded) by Image,RuleName\n\nCopied!\n\nNow you know that a macro was executed and that the Office process executing the macro\nloaded the DLLs necessary for some kind of .NET functionality, a great jumping off point for\nfurther investigation.\n\n[Check out the Sigma Repo where I contributed a few rules looking for this kind of activity, we](https://github.com/Neo23x0/sigma/tree/master/rules/windows/sysmon)\n[can use uncoder.io to convert the Sigma rule into a Splunk query:](https://uncoder.io/)\n\n\n-----\n\n[We could also convert Sigma rules to Splunk searches programmatically with this awesome](https://github.com/P4T12ICK/Sigma2SplunkAlert)\n[project by Patrick Bareiss](https://twitter.com/bareiss_patrick)\n\n## Bonus Round - Velociraptor\n\nNow that your cool new macro alerts have fired, you'd probably want to take a closer look at\nthe host.\n\nLet's try that with Velociraptor, we find our host, and collect some macro artifacts:\n\n\n-----\n\nNow we take a look at the results, and we can see that not only did Velociraptor find our\nmacros, but it also ripped them open, revealing the actual VBA code:\n\nWhile this output is great, our VBA stomped macro keeps it's secrets :)\n\nWe can also see the output of any Trust Record modifications for further evidence of macro\nexecution:\n\n[The folks at Outflank made a nice post about trust records here including providing a](https://outflank.nl/blog/2018/01/16/hunting-for-evil-detect-macros-being-executed/)\nSysmon config snippet to monitor for this kind of activity in real-time, how awesome!\n\nClosing Notes\n\nMy aim with this post was to provide some detection ideas for an attack vector that is\ncommonly utilized by real-world malware and attackers. The Sysmon configuration snippets,\nSplunk queries and Sigma rules will undoubtedly generate false positives in a real corporate\n\n\n-----\n\nenvironment and are not a silver bullet for detecting malicious attacker activity via macros.\nI'm sure there are bypasses available and used for this stuff, but you have to start\nsomewhere and at least make attackers work for a foothold in your environment.\n\nMore Credits\n\nThese resources / people helped me put this post together in one way or another:\n\n[https://twitter.com/decalage2](https://twitter.com/decalage2)\n[https://github.com/decalage2/oletools/wiki/olevba](https://github.com/decalage2/oletools/wiki/olevba)\n[https://twitter.com/DissectMalware](https://twitter.com/DissectMalware)\n[http://www.decalage.info/](http://www.decalage.info/)\n[https://twitter.com/DidierStevens](https://twitter.com/DidierStevens)\n[http://didierstevens.com/](http://didierstevens.com/)\n[https://twitter.com/OrOneEqualsOne](https://twitter.com/OrOneEqualsOne)\n[https://posts.specterops.io/capability-abstraction-fbeaeeb26384](https://posts.specterops.io/capability-abstraction-fbeaeeb26384)\n[https://twitter.com/cyb3rops](https://twitter.com/cyb3rops)\n[https://twitter.com/Cyb3rWard0g](https://twitter.com/Cyb3rWard0g)\n[https://github.com/hunters-forge](https://github.com/hunters-forge)\n[https://twitter.com/SBousseaden](https://twitter.com/SBousseaden)\n[https://twitter.com/c_APT_ure](https://twitter.com/c_APT_ure)\n[https://github.com/olafhartong/sysmon-modular](https://github.com/olafhartong/sysmon-modular)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-02 - Hunting Malicious Macros.pdf"
    ],
    "report_names": [
        "2020-06-02 - Hunting Malicious Macros.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535950,
    "ts_updated_at": 1743041138,
    "ts_creation_date": 1653678586,
    "ts_modification_date": 1653678586,
    "files": {
        "pdf": "https://archive.orkl.eu/80cb392d9f83dc81c8ecc1636f123b5beb22c8e0.pdf",
        "text": "https://archive.orkl.eu/80cb392d9f83dc81c8ecc1636f123b5beb22c8e0.txt",
        "img": "https://archive.orkl.eu/80cb392d9f83dc81c8ecc1636f123b5beb22c8e0.jpg"
    }
}