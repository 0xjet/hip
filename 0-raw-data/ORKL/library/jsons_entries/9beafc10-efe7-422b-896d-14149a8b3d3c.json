{
    "id": "9beafc10-efe7-422b-896d-14149a8b3d3c",
    "created_at": "2023-01-12T15:10:52.944456Z",
    "updated_at": "2025-03-27T02:05:42.072902Z",
    "deleted_at": null,
    "sha1_hash": "7efb2a640130f23c36ddbd037cb1cb913fc40aad",
    "title": "2021-07-05 - Real-Time Prevention of the Kaseya VSA Supply Chain REvil Ransomware Attack",
    "authors": "",
    "file_creation_date": "2022-05-28T16:13:37Z",
    "file_modification_date": "2022-05-28T16:13:37Z",
    "file_size": 757403,
    "plain_text": "# Real-Time Prevention of the Kaseya VSA Supply Chain REvil Ransomware Attack\n\n**[blog.morphisec.com/real-time-prevention-of-the-kaseya-vsa-supply-chain-revil-ransomware-attack](https://blog.morphisec.com/real-time-prevention-of-the-kaseya-vsa-supply-chain-revil-ransomware-attack)**\n\nPosted by [Morphisec Labs on July 5, 2021](https://blog.morphisec.com/author/morphisec-labs)\n\n[Tweet](https://twitter.com/share)\n\n\n-----\n\n## Introduction\n\nOn July 2, 2021, [Morphisec Keep, our Cloud Workload Protection Platform, successfully](https://www.morphisec.com/products/morphisec-keep-server-protection)\nidentified and prevented a REvil Ransomware infection within some of our customer\ndomains. This attack was automatically blocked in real time due to Morphisec's proactive\nprotection mechanism, which resulted in no harm to the customer.\n\nAttacks like this demonstrate the critical nature of a strong prevention strategy for servers.\nAny such strategy needs to acknowledge that supply chain attacks such as this one can\noften bypass the most up-to-date network, identity, and antivirus controls. The following is a\nsummary of our findings after preventing this attack in several customer environments.\n\n## Technical details\n\n### Initial Findings\n\nMost of the attacked endpoints were Windows servers. The Morphisec Keep product\nimmediately and automatically identified the process chain that led to the prevented\nransomware execution as shown in the screenshot below. This attack is particularly evasive\nbecause all the attack chain components are signed with digital certificates, starting from the\nKaseya process, continuing with a vulnerable Microsoft Defender process, and ending with\nthe side-loaded signed ransomware.\n\n\n-----\n\nFigure 1: The threat summary in the Morphisec GUI\n\nThe initial stage begins with AgentMon.exe – a legitimate process for the Kaseya Virtual\n_Server Administrator Agent. Then this process executes suspicious Windows batch_\ncommands via cmd.exe.\n\nThose batch commands are followed by the execution of a malicious file named agent.exe.\nThe following process then executes a legitimate signed Windows Defender process\n(MsMpEng.exe) that was dropped in the “C:\\Windows\\” directory.\n\n[This Windows Defender application file is known for its side-loading vulnerability that has](https://www.a12d404.net/security/2019/01/04/side-loading-fun-4.html)\nsince been patched. Once executed it loads a malicious DLL file named mpsvc.dll that was\nalso dropped within the Windows directory.\n\nThis mpsvc.dll DLL is the actual functionality of the ransomware. Morphisec automatically\nblocked its execution and prevented the servers from being infected.\n\n### The Batch Commands\n\nThese commands are executed after the agent.crt file is dropped by a hijacked update\nroutine called 'Kaseya VSA Agent Hot-fix’.\n\nThe first part sleeps for about 1.5 hours by utilizing the ping command to localhost. Then, it\nexecutes a PowerShell command that first disables Microsoft Defender security features,\nsuch as Real-Time Protection, Intrusion Prevention System, Script Scanning, Automatic\nSample Submission, Controlled Folder Access, and network protection.\n\nFigure 2: Batch command execution by AgentMon.exe\n\n\n-----\n\nNext, it copies certutil.exe, a legitimate executable under the name cert.exe, and adds a\nrandom value to the end of the executable – this breaks the detection of certutil utilization by\nthird-party vendors. It will later use this executable to decode agent.crt, delete it, and execute\nthe decoded payload: agent.exe.\n\n### The Loader (agent.exe)\n\nThe loader is signed with a certificate named “PB03 TRANSPORT LTD,” a basic loader\nwithout any obfuscations. The loader contains two resources:\n\n‘SOFTIS’: Contains MsMpEng.exe, the legitimate executable\n‘MODLIS’: Contains mpsvc.dll, the malicious payload\n\nOnce the resources are loaded into memory, the loader writes these files to C:\\Windows and\nexecutes the MsMpEng.exe file (as System).\n\nFigure 3: The agent.exe loader execution flow\n\n### Bug in Production?\n\nAs others have written, there are two different hashes for mpsvc.dll that represent the same\npayload. The only difference is that one of them is padded with nulls at the end.\n\nFigure 4: The differences between mpsvc.dll files\n\nThe instance without the nulls is the DLL that was extracted from the ‘MODLIS’\nresource\nThe instance with the null padding is the one saved within the Windows directory\n\nWhile the unpadded instance is digitally signed, the padding breaks the file digital signature\nin the other instance, so what has gone wrong?\n\n\n-----\n\nThe actual size of the DLL within the resource is 807,816 bytes while the size of bytes for\nwriting this file within the loader is 808,328 bytes (0xC5588 in the agent.exe execution flow\nfigure). This difference results in the null padding that breaks the digital signature and leads\nto a potential successful detection by some vigilant vendors.\n\n## Conclusion\n\nAttacks like this demonstrate the importance of real-time prevention that does not rely on\nsignatures by leveraging zero-trust at the endpoint. As shown in the first screenshot, all\ncomponents of this attack are signed. This attacker is adept at abusing the implicit trust given\nto signed processes so their attacks can progress in target environments. Furthermore,\ndetection-centric technology, like EDR, cannot be relied on when malicious activity is present\non servers. The attacker is simply too close to their final goal for it to make sense to rely on\nreactive remediation through human intervention.\n\n[Morphisec Keep is built to deal with evasive threats like this automatically, in real time, and](https://www.morphisec.com/products/morphisec-keep-server-protection)\nwithout prior knowledge of the attack. Through Morphisec Keep, you can extend your zerotrust strategy beyond identity and the network so that attacks like this one, where the supply\nchain is compromised, can still be prevented when they can land on the endpoint and make\ntheir way into the process memory.\n\n## IOCs\n\nagent.exe (REvil Loader):\nd55f983c994caa160ec63a59f6b4250fe67fb3e8c43a388aec60a4a6978e9f1e\n\nmpsvc.dll saved on disk (REvil payload):\n\n8dd620d9aeb35960bb766458c8890ede987c33d239cf730f93fe49d90ae759dd\n\nmpsvc.dll within agent.exe resource (REvil payload):\n\ne2a24ab94f865caeacdf2c3ad015f31f23008ac6db8312c2cbfb32e4a5466ea2\n\n[Contact SalesInquire via Azure](http://10.10.0.46/mailto:sales@morphisec.com)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-05 - Real-Time Prevention of the Kaseya VSA Supply Chain REvil Ransomware Attack.pdf"
    ],
    "report_names": [
        "2021-07-05 - Real-Time Prevention of the Kaseya VSA Supply Chain REvil Ransomware Attack.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536252,
    "ts_updated_at": 1743041142,
    "ts_creation_date": 1653754417,
    "ts_modification_date": 1653754417,
    "files": {
        "pdf": "https://archive.orkl.eu/7efb2a640130f23c36ddbd037cb1cb913fc40aad.pdf",
        "text": "https://archive.orkl.eu/7efb2a640130f23c36ddbd037cb1cb913fc40aad.txt",
        "img": "https://archive.orkl.eu/7efb2a640130f23c36ddbd037cb1cb913fc40aad.jpg"
    }
}