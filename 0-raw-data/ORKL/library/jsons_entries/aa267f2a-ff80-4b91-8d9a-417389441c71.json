{
    "id": "aa267f2a-ff80-4b91-8d9a-417389441c71",
    "created_at": "2023-01-12T14:59:13.427978Z",
    "updated_at": "2025-03-27T02:17:23.489724Z",
    "deleted_at": null,
    "sha1_hash": "0c7a8a75dcd8f57690f43b4bdaa850953d01de86",
    "title": "2021-08-17 - Secrets behind the Lazarus’s VHD ransomware",
    "authors": "",
    "file_creation_date": "2022-05-28T21:48:15Z",
    "file_modification_date": "2022-05-28T21:48:15Z",
    "file_size": 1326761,
    "plain_text": "# Secrets behind the Lazarus’s VHD ransomware\n\n**[seguranca-informatica.pt/secrets-behind-the-lazaruss-vhd-ransomware/](https://seguranca-informatica.pt/secrets-behind-the-lazaruss-vhd-ransomware/)**\n\n## Introduction\n\n\nAugust 17, 2021\n\n\n[Data encryption malware is one of the most popular malware families in recent years and](https://resources.infosecinstitute.com/topic/nist-ransomware-recovery-guide-what-you-need-to-know/)\ntargets mass volumes of users and companies around the world. In this article, we will take a\ndeep dive into a new VHD ransomware distributed in the wild by the Lazarus group — the\n[criminals behind the WannaCry incident in 2017.](https://seguranca-informatica.pt/o-minerador-fileless-powerghost-aproveita-o-eternalblue-para-se-disseminar-na-rede/#.X7FRmWj7QuU)\n\nThe VHD ransomware is one of the most dangerous threats today. This is because it tries to\nchange system settings, disable some programs and functions of the target operating\nsystems, and demands payment in cryptocurrency via a ransom note dropped during the\nransomware execution. The Lazarus group have been using this ransomware, which uses\nmethods typical of APT attacks but specialized in financial cybercrime.\n\nThe activity of the Lazarus Group surged in 2014 and 2015, where custom-tailored malware\nwas used in its cyberattacks. The group has been linked to several major cyberattacks,\nincluding the 2014 Sony Pictures hack, several SWIFT banking attacks since 2016, and the\nWannaCry ransomware infection in May 2017.\n\n## Lazarus’s VHD ransomware\n\n[Researchers from Kaspersky detailed a new VHD ransomware used by the group between](https://securelist.com/lazarus-on-the-hunt-for-big-game/97757/)\nMarch and May 2020. The analyzed samples have been deployed over the network of the\ntarget enterprises, brute-forcing the SMB service on every discovered machine and using the\n\n\n-----\n\n[MATA malware framework documented by Kaspersky here and also used by the Lazarus](https://securelist.com/mata-multi-platform-targeted-malware-framework/97746/)\ngroup.\n\nInitially, criminals gain access to the target infrastructures via widespread botnet infections\nsuch as Emotet and Trickbot families or by exploiting vulnerable VPN gateways. When\ncriminals have a good understanding of the target’s finances and IT processes and network,\nthey escalated their privileges on the compromised systems and installed a backdoor that is\npart of the MATA malware framework. The criminals leverage the backdoor to control the\nActive Directory server and use it to deliver VHD ransomware to all systems in the target\nnetwork within 10 hours using the help of a Python-based loader.\n\nAfter finishing the infection chain with the ransomware deployment, criminals enter a new\nphase: negotiation.\n\n**_Figure 1: High-level diagram of the Hakuna MATA and VHD ransomware._**\n\nVHD is a standard ransomware tool that spreads through the drives connected to the target\ndevice, encrypts all the files and deletes all System Volume Information folders that prevent\nthe impacted system could be restored. The ransomware binary is protected with VMProtect\npacker in order to prevent its analysis. The binary sections vmp0, vmp1 are the first signal of\nthis packer.\n\n\n-----\n\n**_Figure 2: Binary sections (vmp0 and vmp1 — VMProtect packer)._**\n\nAs observed in the PorEx diagram below, some parts of the binary were obfuscated, such as\nthe malware config, ransom note details and so on.\n\n**_Figure 3: PortEx diagram — VHD ransomware._**\n\nOne interesting detail this threat is related to some services that are suspended to preserve\nimportant files from modification such as Microsoft Exchange and SQL server. Next, the\nservices suspended during the ransomware operation are presented.\n\n**_Figure 4: Services stoped during the ransomware execution._**\n\nHere’s a complete list of stoped services during VHD ransomware execution:\n\n\n-----\n\n```\nsc stop Microsoft Exchange Anti spam Update \nsc stop \"Microsoft Exchange Active Directory Toplogy\"\nsc stop \"Microsoft Exchange Compliance Audit\"\nsc stop \"Microsoft Exchange Compliance Service\"\nsc stop \"Microsoft Exchange DAG Management\"\nsc stop \"Microsoft Exchange Diagnostics\"\nsc stop \"Microsoft Exchange EdgeSync\"\nsc stop \"Microsoft Exchange Frontend Transport\"\nsc stop \"Microsoft Exchange Health Manager\"\nsc stop \"Microsoft Exchange IMAP4\"\nsc stop \"Microsoft Exchange Health Manager Recovery\"\nsc stop \"Microsoft Exchange Information Store\"\nsc stop \"Microsoft Exchange IMAP4 Backend\"\nsc stop \"Microsoft Exchange Mailbox Assistants\"\nsc stop \"Microsoft Exchange Mailbox Transport Delivery\"\nsc stop \"Microsoft Exchange POP3\"\nsc stop \"Microsoft Exchange POP3 Backend\"\nsc stop \"SQL Server Agent (TESTINSTANCE)\"\nsc stop \"SQL Server (TESTINSTANCE)\"\n\n```\nSome important Windows calls are also executed during the malware operation. Some of\nthem are described in a brief way below to a better understanding of how the malware works.\n\n**Calls loaded from kernel32.dll**\n\n**CreateFileW()** Creates or opens a file or I/O device during malware\nexecution.\n\n**FindFirstFileW()** Searches a directory for a file or subdirectory with a\nname that matches a specific name (or partial name if\nwildcards are used).\n\n**FindNextFileW()** Continues a file search from a previous call to the\nFindFirstFile, FindFirstFileEx, or FindFirstFileTransacted\nfunctions.\n\n**GetLogicalDrives()** Retrieves a bitmask representing the currently available\ndisk drives.\n\n**IsDebuggerPresent()** Determines whether the calling process is being\ndebugged by a user-mode debugger (used to prevent\nmalware running in virtual machines).\n\n**IsProcessorFeaturePresent()** Determines whether the specified processor feature is\nsupported by the current computer (used in anti-debug\ntechniques).\n\n**CreateMutexW()** Creates or opens a named or unnamed mutex object\n(used to prevent further ransomware infections).\n\n**Call loaded from shell32.dll**\n\n\n-----\n\n**SHEmptyRecycleBinW()** Empties the Recycle Bin on the specified drive.\n\n**Call loaded from user32.dll**\n\n**ShowWindow()** Sets the specified window’s show state. Used to hide the ransomware\nwindow during its execution.\n\nEvery time a file is encrypted, it is renamed. The extension “.vhd” is appended to the end of\nthe file name.\n\n**_Figure 5: Ransomware extension (.vhd) is appended to the file name whenever a file is_**\n_encrypted._\n\nThe ransom note is also dropped into the desktop folder “HowToDecrypt.txt” with the\ninstructions for paying the ransom and recovering the damaged files.\n\n\n-----\n\n**_Figure 6: Damage files and ransom note dropped into the desktop folder._**\n\nThe ransomware is written in C++ and the files are encrypted with a combination of AES-256\nin ECB mode and RSA-2048. The ransomware uses Mersenne Twister as a source of\nrandomness, but unfortunately for the victims, the RNG is reseeded every time new data is\nconsumed. The combination of ECB and AES is not semantically secure, which means the\npatterns of the original clear data are preserved upon encryption.\n\nVHD implements a mechanism to resume operations if the encryption process is interrupted.\nFor instance, for files larger than 16MB, the ransomware stores the current cryptographic\nmaterials on the hard drive, in cleartext. This information is not deleted securely afterwards,\nwhich implies there may be a chance to recover some of the damaged files.\n\n\n-----\n\n**_Figure 7: Details about cryptographic algorithms and Mersenne Twister block with the RNG_**\n_seed._\n\nA strategy often used by malware developers is the usage of mutex entries to prevent further\ninfections when a target device has already been infected. VHD ransomware creates during\nits execution the mutex “AEEAEE SET”, as observed below.\n\n\n-----\n\n```\n \\Sessions\\1\\BaseNamedObjects\\AEEAEE SET \n\"AEEAEE SET\"\n\n```\nThe malware’s plan is not very complex, as presented by the MITRE ATT&CK matrix below.\nOny some functions to hide its presence and calls to scan the target device and drives and\nalso to access the system files are used by the malicious binary.\n\n## Preventing against ransomware incidents\n\nThere is not a perfect formula to fight ransomware incidents, but some measures can be\nenumerated to prevent some situations:\n\nProvide social engineering training and explain to employees how following simple\nrules helps to avoid ransomware incidents.\nEnsure that software, applications and systems are up to date.\nUse endpoint protection solutions to prevent malicious infections.\nUse vulnerability management and monitoring systems to identify potential unpatched\nflaws and to detect incidents in real time.\nUse [canary files to detect ransomware early.](https://resources.infosecinstitute.com/topic/ransomware-deletion-methods-and-the-canary-in-the-coal-mine/)\nPerform cybersecurity audits and mitigate any weaknesses discovered in order to\nprevent attacks in the wild, both from the external and internal perspective.\n\n**The article was initially published by Pedro Tavares on** **[resources.infosecinstitute.com.](https://resources.infosecinstitute.com/topic/lazaruss-vhd-ransomware-malware-spotlight/)**\n\n**All rights reserved ® infosecinstitute.com**\n\n[Pedro Tavares](https://seguranca-informatica.pt/author/pipocaz/)\n**[Pedro Tavares is a professional in the field of information security working as an Ethical](https://www.linkedin.com/in/sirpedrotavares/)**\nHacker/Pentester, Malware Researcher and also a Security Evangelist. He is also a founding\nmember at CSIRT.UBI and Editor-in-Chief of the security computer blog segurancainformatica.pt.\n\nIn recent years he has invested in the field of information security, exploring and analyzing a\nwide range of topics, such as pentesting (Kali Linux), malware, exploitation, hacking, IoT and\nsecurity in Active Directory networks. He is also Freelance Writer (Infosec. Resources\n[Institute and Cyber Defense Magazine) and developer of the 0xSI_f33d – a feed that](https://feed.seguranca-informatica.pt/)\ncompiles phishing and malware campaigns targeting Portuguese citizens.\n\n[Read more here.](https://seguranca-informatica.pt/contacto/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-17 - Secrets behind the Lazarus’s VHD ransomware.pdf"
    ],
    "report_names": [
        "2021-08-17 - Secrets behind the Lazarus’s VHD ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "32a223a8-3c79-4146-87c5-8557d38662ae",
            "created_at": "2022-10-25T15:50:23.703698Z",
            "updated_at": "2025-03-27T02:00:55.528031Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Lazarus Group",
                "Labyrinth Chollima",
                "HIDDEN COBRA",
                "Guardians of Peace",
                "NICKEL ACADEMY",
                "Diamond Sleet"
            ],
            "source_name": "MITRE:Lazarus Group",
            "tools": [
                "RawDisk",
                "Proxysvc",
                "BADCALL",
                "FALLCHILL",
                "WannaCry",
                "HOPLIGHT",
                "TYPEFRAME",
                "Dtrack",
                "HotCroissant",
                "HARDRAIN",
                "Dacls",
                "KEYMARBLE",
                "TAINTEDSCRIBE",
                "AuditCred",
                "netsh",
                "ECCENTRICBANDWAGON",
                "AppleJeus",
                "BLINDINGCAN",
                "ThreatNeedle",
                "Volgmer",
                "Cryptoistic",
                "RATANKBA",
                "Bankshot",
                "Torisma",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "9e767b38-12ae-4ef7-9878-5ce1701066d7",
            "created_at": "2024-05-01T02:03:08.131819Z",
            "updated_at": "2025-03-27T02:05:17.413497Z",
            "deleted_at": null,
            "main_name": "NICKEL ACADEMY",
            "aliases": [
                "COVELLITE ",
                "CTG-2460 ",
                "Diamond Sleet ",
                "Guardians of Peace",
                "HIDDEN COBRA ",
                "High Anonymous",
                "Labyrinth Chollima ",
                "NNPT Group",
                "New Romanic Cyber Army Team",
                "Temp.Hermit ",
                "The Lazarus Group ",
                "UNC577 ",
                "Who Am I?",
                "Whois Team",
                "ZINC ",
                "Black Artemis "
            ],
            "source_name": "Secureworks:NICKEL ACADEMY",
            "tools": [
                " DarkMessenger",
                " Destover",
                " Duuzer",
                " HOPLIGHT",
                " Joanap",
                " KorHigh",
                " LiveJinx",
                " Volgmer",
                "Brambul"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8bc1a044-a23b-4904-903c-13f463605cb3",
            "created_at": "2024-05-01T02:03:08.136237Z",
            "updated_at": "2025-03-27T02:05:17.415795Z",
            "deleted_at": null,
            "main_name": "NICKEL GLADSTONE",
            "aliases": [
                "Bluenoroff ",
                "CTG-6459 ",
                "Citrine Sleet ",
                "HIDDEN COBRA ",
                "Lazarus Group",
                "Sapphire Sleet ",
                "Stardust Chollima ",
                "APT38 "
            ],
            "source_name": "Secureworks:NICKEL GLADSTONE",
            "tools": [
                " Bankshot",
                " CATCH22",
                " CCGC_Proxy",
                " Cur1Agent",
                " Ratankba",
                " Server_TrafficForwarder",
                " Wcry",
                "AlphaNC"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a2b92056-9378-4749-926b-7e10c4500dac",
            "created_at": "2023-01-06T13:46:38.430595Z",
            "updated_at": "2025-03-27T02:00:02.831633Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Operation DarkSeoul",
                "APT38",
                "ATK117",
                "DEV-1222",
                "G0032",
                "APT 38",
                "Stardust Chollima",
                "APT-C-26",
                "ATK3",
                "Diamond Sleet",
                "Hidden Cobra",
                "Unit 121",
                "Subgroup: Bluenoroff",
                "NICKEL GLADSTONE",
                "DEV-0139",
                "Andariel",
                "Operation Troy",
                "COVELLITE",
                "TA404",
                "Lazarus group",
                "Dark Seoul",
                "G0082",
                "NewRomanic Cyber Army Team",
                "Bluenoroff",
                "Appleworm",
                "Nickel Academy",
                "COPERNICIUM",
                "Hastati Group",
                "Bureau 121",
                "Operation AppleJeus",
                "Whois Hacking Team",
                "Citrine Sleet",
                "Sapphire Sleet",
                "Group 77",
                "Labyrinth Chollima",
                "Operation GhostSecret",
                "BeagleBoyz"
            ],
            "source_name": "MISPGALAXY:Lazarus Group",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f32df445-9fb4-4234-99e0-3561f6498e4e",
            "created_at": "2022-10-25T16:07:23.756373Z",
            "updated_at": "2025-03-27T02:02:09.966155Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "APT-C-26",
                "ATK 3",
                "Appleworm",
                "Citrine Sleet",
                "DEV-0139",
                "Diamond Sleet",
                "Gleaming Pisces",
                "Gods Apostles",
                "Gods Disciples",
                "Group 77",
                "Guardians of Peace",
                "Hastati Group",
                "Hidden Cobra",
                "ITG03",
                "Jade Sleet",
                "Labyrinth Chollima",
                "Lazarus Group",
                "NewRomanic Cyber Army Team",
                "Operation 99",
                "Operation AppleJeus",
                "Operation AppleJeus sequel",
                "Operation Blockbuster: Breach of Sony Pictures Entertainment",
                "Operation CryptoCore",
                "Operation Dream Job",
                "Operation Dream Magic",
                "Operation Flame",
                "Operation GhostSecret",
                "Operation In(ter)caption",
                "Operation LolZarus",
                "Operation Marstech Mayhem",
                "Operation No Pineapple!",
                "Operation North Star",
                "Operation Phantom Circuit",
                "Operation Sharpshooter",
                "Operation Ten Days of Rain / DarkSeoul",
                "Operation Troy",
                "SectorA01",
                "Slow Pisces",
                "TA404",
                "TraderTraitor",
                "UNC2970",
                "UNC4034",
                "UNC4736",
                "UNC4899",
                "UNC577",
                "Whois Hacking Team"
            ],
            "source_name": "ETDA:Lazarus Group",
            "tools": [
                "3CX Backdoor",
                "3Rat Client",
                "3proxy",
                "AIRDRY",
                "ARTFULPIE",
                "ATMDtrack",
                "AlphaNC",
                "Alreay",
                "Andaratm",
                "AngryRebel",
                "AppleJeus",
                "Aryan",
                "AuditCred",
                "BADCALL",
                "BISTROMATH",
                "BLINDINGCAN",
                "BTC Changer",
                "BUFFETLINE",
                "BanSwift",
                "Bankshot",
                "Bitrep",
                "Bitsran",
                "BlindToad",
                "Bookcode",
                "BootWreck",
                "BottomLoader",
                "Brambul",
                "BravoNC",
                "Breut",
                "COLDCAT",
                "COPPERHEDGE",
                "CROWDEDFLOUNDER",
                "Castov",
                "CheeseTray",
                "CleanToad",
                "ClientTraficForwarder",
                "CollectionRAT",
                "Concealment Troy",
                "Contopee",
                "CookieTime",
                "Cyruslish",
                "DAVESHELL",
                "DBLL Dropper",
                "DLRAT",
                "DRATzarus",
                "DRATzarus RAT",
                "Dacls",
                "Dacls RAT",
                "DarkComet",
                "DarkKomet",
                "DeltaCharlie",
                "DeltaNC",
                "Dembr",
                "Destover",
                "DoublePulsar",
                "Dozer",
                "Dtrack",
                "Duuzer",
                "DyePack",
                "ECCENTRICBANDWAGON",
                "ELECTRICFISH",
                "Escad",
                "EternalBlue",
                "FALLCHILL",
                "FYNLOS",
                "FallChill RAT",
                "Farfli",
                "Fimlis",
                "FoggyBrass",
                "FudModule",
                "Fynloski",
                "Gh0st RAT",
                "Ghost RAT",
                "Gopuram",
                "HARDRAIN",
                "HIDDEN COBRA RAT/Worm",
                "HLOADER",
                "HOOKSHOT",
                "HOPLIGHT",
                "HOTCROISSANT",
                "HOTWAX",
                "HTTP Troy",
                "Hawup",
                "Hawup RAT",
                "Hermes",
                "HotCroissant",
                "HotelAlfa",
                "Hotwax",
                "HtDnDownLoader",
                "Http Dr0pper",
                "ICONICSTEALER",
                "Joanap",
                "Jokra",
                "KANDYKORN",
                "KEYMARBLE",
                "Kaos",
                "KillDisk",
                "KillMBR",
                "Koredos",
                "Krademok",
                "LIGHTSHIFT",
                "LIGHTSHOW",
                "LOLBAS",
                "LOLBins",
                "Lazarus",
                "LightlessCan",
                "Living off the Land",
                "MATA",
                "MBRkiller",
                "MagicRAT",
                "Manuscrypt",
                "Mimail",
                "Mimikatz",
                "Moudour",
                "Mydoom",
                "Mydoor",
                "Mytob",
                "NACHOCHEESE",
                "NachoCheese",
                "NestEgg",
                "NickelLoader",
                "NineRAT",
                "Novarg",
                "NukeSped",
                "OpBlockBuster",
                "PCRat",
                "PEBBLEDASH",
                "PLANKWALK",
                "POOLRAT",
                "PSLogger",
                "PhanDoor",
                "Plink",
                "PondRAT",
                "PowerBrace",
                "PowerRatankba",
                "PowerShell RAT",
                "PowerSpritz",
                "PowerTask",
                "Preft",
                "ProcDump",
                "Proxysvc",
                "PuTTY Link",
                "QUICKRIDE",
                "QUICKRIDE.POWER",
                "Quickcafe",
                "QuiteRAT",
                "R-C1",
                "ROptimizer",
                "Ratabanka",
                "RatabankaPOS",
                "Ratankba",
                "RatankbaPOS",
                "RawDisk",
                "RedShawl",
                "Rifdoor",
                "Rising Sun",
                "Romeo-CoreOne",
                "RomeoAlfa",
                "RomeoBravo",
                "RomeoCharlie",
                "RomeoCore",
                "RomeoDelta",
                "RomeoEcho",
                "RomeoFoxtrot",
                "RomeoGolf",
                "RomeoHotel",
                "RomeoMike",
                "RomeoNovember",
                "RomeoWhiskey",
                "Romeos",
                "RustBucket",
                "SHADYCAT",
                "SHARPKNOT",
                "SIGFLIP",
                "SIMPLESEA",
                "SLICKSHOES",
                "SORRYBRUTE",
                "SUDDENICON",
                "SUGARLOADER",
                "SheepRAT",
                "SierraAlfa",
                "SierraBravo",
                "SierraCharlie",
                "SierraJuliett-MikeOne",
                "SierraJuliett-MikeTwo",
                "SimpleTea",
                "SimplexTea",
                "SmallTiger",
                "Stunnel",
                "TAINTEDSCRIBE",
                "TAXHAUL",
                "TFlower",
                "TOUCHKEY",
                "TOUCHMOVE",
                "TOUCHSHIFT",
                "TOUCHSHOT",
                "TWOPENCE",
                "TYPEFRAME",
                "Tdrop",
                "Tdrop2",
                "ThreatNeedle",
                "Tiger RAT",
                "TigerRAT",
                "Trojan Manuscript",
                "Troy",
                "TroyRAT",
                "VEILEDSIGNAL",
                "VHD",
                "VHD Ransomware",
                "VIVACIOUSGIFT",
                "VSingle",
                "ValeforBeta",
                "Volgmer",
                "Vyveva",
                "W1_RAT",
                "Wana Decrypt0r",
                "WanaCry",
                "WanaCrypt",
                "WanaCrypt0r",
                "WannaCry",
                "WannaCrypt",
                "WannaCryptor",
                "WbBot",
                "Wcry",
                "Win32/KillDisk.NBB",
                "Win32/KillDisk.NBC",
                "Win32/KillDisk.NBD",
                "Win32/KillDisk.NBH",
                "Win32/KillDisk.NBI",
                "WinorDLL64",
                "Winsec",
                "WolfRAT",
                "Wormhole",
                "YamaBot",
                "Yort",
                "ZetaNile",
                "concealment_troy",
                "http_troy",
                "httpdr0pper",
                "httpdropper",
                "klovbot",
                "sRDI"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535553,
    "ts_updated_at": 1743041843,
    "ts_creation_date": 1653774495,
    "ts_modification_date": 1653774495,
    "files": {
        "pdf": "https://archive.orkl.eu/0c7a8a75dcd8f57690f43b4bdaa850953d01de86.pdf",
        "text": "https://archive.orkl.eu/0c7a8a75dcd8f57690f43b4bdaa850953d01de86.txt",
        "img": "https://archive.orkl.eu/0c7a8a75dcd8f57690f43b4bdaa850953d01de86.jpg"
    }
}