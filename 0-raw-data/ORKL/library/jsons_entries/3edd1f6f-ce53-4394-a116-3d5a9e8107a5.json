{
    "id": "3edd1f6f-ce53-4394-a116-3d5a9e8107a5",
    "created_at": "2023-01-12T15:08:46.667893Z",
    "updated_at": "2025-03-27T02:06:05.593192Z",
    "deleted_at": null,
    "sha1_hash": "3547be394c7a86af110f4db6204e4a3706855d6b",
    "title": "2016-03-01 - Look Into Locky Ransomware",
    "authors": "",
    "file_creation_date": "2022-05-28T02:30:24Z",
    "file_modification_date": "2022-05-28T02:30:24Z",
    "file_size": 1091687,
    "plain_text": "# Look Into Locky Ransomware\n\n**[blog.malwarebytes.com/threat-analysis/2016/03/look-into-locky/](https://blog.malwarebytes.com/threat-analysis/2016/03/look-into-locky/)**\n\nhasherezade March 1, 2016\n\nLocky is a new [ransomware that has been released (most probably) by the Dridex gang](https://www.malwarebytes.com/ransomware)\n[(source). Not surprisingly, it is well prepared, which means that the threat actor behind it has](https://www.proofpoint.com/us/threat-insight/post/Dridex-Actors-Get-In-the-Ransomware-Game-With-Locky)\ninvested sufficient resources for it, including its mature infrastructure. Let’s take a look.\n\n## Analyzed samples\n\n[7a23368ee84781d7584e058a9922f324](https://www.virustotal.com/en/file/2a40da48c9dc3e20bc6e30c986306ceccbc2d8be55b355b7a73d95c1a54319a4/analysis/)\n\n[payload: 74dde1905eff75cf3328832988a785de <- main focus of this analysis](https://www.virustotal.com/en/file/03f6ab1b482eac4acfb793c3e8d0656d7c33cddb5fc38416019d526f43577761/analysis/1456362770/)\n[d9df60c24ceca5c4d623ff48ccd4e9b9](https://www.virustotal.com/en/file/e99e4bfeaa78d23d10f74d8756aba77e8a4bdbf38c16291832959b15faf3753b/analysis/)\n[e7aad826559c8448cd8ba9f53f401182](https://www.virustotal.com/en/file/1a45085e959a449637a89174b1737f4d03d7e73dd7acfa3cfb96042a735cf400/analysis/)\n\n## Behavioral analysis\n\nLocky is usually delivered via downloader in MS Office document (i.e. DOC) or JavaScript –\ne-mail attachment in a phishing campaign. The payload is a 32-bit Windows executable,\n[containing the malicious core packed in a crypter/dropper (they are various, with various](https://blog.malwarebytes.org/development/2015/12/malware-crypters-the-deceptive-first-layer/)\nicons).\n\n\n-----\n\nAfter being deployed it disappears and runs its dropped copy (renamed to svchost.exe)\nfrom the %TEMP% folder.\n\n### Encryption process\n\nFiles that have been encrypted are fully renamed. The beginning of the name (first 16\ncharacters) is the unique ID of the victim. Then comes the ID of the file and the extension\n**.locky that is typical for this ransomware.**\n\nThe encrypted content has a high level of entropy and no patterns are visible.\n\nBelow: visualization of raw bytes of square.bmp. Left: unencrypted, right: encrypted.\n\n\n-----\n\nAfter executing, Locky displays the ransom note in text and bitmap forms, setting the latter\nas the affected user’s wallpaper.\n\nText is localized to the language detected in the system. Translation looks professional\nenough (not from the auto translator), which may indicate that the threat actors target\nmultiple countries – and prepared about this particular detail well. See sample translations\n[(Polish, Spanish) here.](https://gist.github.com/hasherezade/a6b3f511fcf26d78cef8)\n\n### Registry keys\n\nLooking at the registry we can find that a few elements have been added.\n\nKey in autorun, to start the malware automatically after the system restart:\n\n\n-----\n\nData specific to the victim – individual ID, public RSA key and text of the ransom note to be\ndisplayed:\n\nPublic key stored in the registry:\n\n\n-----\n\n### Website for the victim\n\nEach Locky victim has a Web page that can be accessed via Tor. These pages contain\nfurther instructions to the victim and support for managing payments.\n\n## Network communication\n\nLocky communicates with the CnC, but it is difficult to analyze it via simple sniffing tools\nbecause full communication is encrypted:\n\n\n-----\n\nMore about the protocol can be learned by reading the code…\n\n## Inside\n\n[Every sample of Locky comes packed in some crypter, so the code is unreadable at first.](https://blog.malwarebytes.org/development/2015/12/malware-crypters-the-deceptive-first-layer/)\n\n\n-----\n\nHowever, the core itself is not that obfuscated. After unpacking the outer layer of its defense,\nwe can see valid strings and function calls. They give some explanation to the unreadable\nnetwork capture. The RSA key as well as the ransom note are fetched from the server by a\nHTTP based protocol. The current sample comes with a list of 3 IP addresses.\n\n31.41.47.37\n188.138.88.184\n85.25.138.187\n\n[Additionally it makes use of DGA – Domain Generation Algorithm (more described here).](http://blog.fortinet.com/post/a-closer-look-at-locky-ransomware-2)\n\n### Communication protocol\n\nLocky’s communication protocol is pretty simple: it consists of a POST request with\nparameters in a typical key=value format. However, as mentioned before, they are not sent\nby an open text, but wrapped and encrypted. First, the request is prepared and it’s\nparameters are filled. Then its MD5 is calculated. Both elements are concatenated and\nencrypted together.\n\nExample of wrapped request (before encryption):\n\n\n-----\n\nSimilarly, when the response comes, first it gets decrypted, then its MD5 is validated – and if\nit passed the validation then it is parsed.\n\nExample of received response (encrypted):\n\nDecrypting:\n\n\n-----\n\nDecrypted response turns out to be an RSA key prompted by its hash:\n\nLocky uses 3 commands (identified by the key act):\n\ngetkey\ngettext\nstats\n\nWe have explained the actions in further detail below.\n\n**[getkey] Initial registration and fetching the RSA key:**\n```\nid=[16]&act=getkey&affid=1&lang=[2:lang]&corp=[0-1]&serv=[0-1]&os=[Windows name]&sp=\n[num]&x64=[0-1]\n\n```\nUnique user ID is 16 byte long hexadecimal string, created locally (pseudocode):\n```\nwin_dir = GetWindowsDirectory\nmount_point_name = GetVolumeNameForVolumeMountPoint(win_dir)\nGUID = get_GUID(mount_point_name)\nmd5sum = MD5(GUID)\nid = md5sum.uppercase().substr(0,16)\n\n```\nAfter that follows:\n\n[Language: obtained by functions: GetLocaleInfo,](https://msdn.microsoft.com/en-us/library/windows/desktop/dd318101%28v=vs.85%29.aspx) [GetUserDefaultUILanguage. System info –](https://msdn.microsoft.com/en-us/library/windows/desktop/dd318137%28v=vs.85%29.aspx)\nfetched by [GetVersionEx and](https://msdn.microsoft.com/en-us/library/windows/desktop/ms724451%28v=vs.85%29.aspx) [GetSystemMetrics(SM_SERVERR2) and translated to the built](https://msdn.microsoft.com/en-us/library/windows/desktop/ms724385%28v=vs.85%29.aspx)\nin lists. [IsWow64Process is used to identify if the system is 64bit.](https://msdn.microsoft.com/en-us/library/windows/desktop/ms684139%28v=vs.85%29.aspx)\n\n**[gettext] Fetching the ransom text:**\n```\nid=[16]&act=gettext&lang=[2:lang]\n\n```\n**[stats] Sending statistics about encrypted files:**\n```\nid=[16]&act=stats&path=[root_path]&encrypted=[num]&failed=[num]&length=[num]\n\n### What is attacked?\n\n```\n\n-----\n\nLocky attacks 3 types of local drives: fixed, removable and ramdisks…\n\n[…as well as network resources. Network shares are mapped using WNetAddConnection2](https://msdn.microsoft.com/en-us/library/windows/desktop/aa385413%28v=vs.85%29.aspx)\n\n\n-----\n\nFor every drive a new encrypting thread is started.\n\n### How does the encryption work?\n\nIn the ransom note attackers claimed that Locky uses both RSA and AES algorithms.\nLooking at the code we can confirm this. Cryptography is implemented using Windows\nCrypto API and really uses the mentioned algorithms.\n\nFirst, RSA key (2048 bit) is fetched from the server and imported:\n\nThe RSA key is used to encrypt AES keys, which are randomly generated for each file.\n\nBelow – importing a random AES key (128 bit long):\n\n\n-----\n\nProcessing of the files starts by enumerating them and storing in a list. Then the encryption\nproceeds by this list.\n\nEvery thread collects statistics about the encrypted files (i.e summary of how many files has\nbeen encrypted in a particular path):\n\n\n-----\n\nStatistics are encrypted and sent to the C&C.\n\n### Ransom note\n\nAs mentioned before, ransom note in a language detected language by\n[GetUserDefaultUILanguage is downloaded from the server.](https://msdn.microsoft.com/en-us/library/windows/desktop/dd318137%28v=vs.85%29.aspx)\n\nMost ransomware drops ransom notes in HTML form, and then opens it in a Web browser.\nLocky does something more interesting: it renders and sets a bitmap as wallpaper.\n\n\n-----\n\nBitmap rendering:\n\nWallpaper settings are edited by registry keys:\n\n\n-----\n\nAfter successful rendering and saving the bitmap, it sets it as a wallpaper using\n[SystemParamsInfo (action 0x14 = SPI_SETDESKWALLPAPER)](https://msdn.microsoft.com/en-us/library/windows/desktop/ms724947%28v=vs.85%29.aspx)\n\n## Conclusion\n\nLocky struck in February but it has already gained popularity. Due to the fact that it is a wide\nspread attack, carried by the same entities that distribute Dridex, it easily triggered interest of\nmany researchers. Upon closer inspection, however, we can say that it is not that different\nfrom common ransomware. It looks solidly written and well prepared, but it doesn’t show too\nmuch novelty so far.\n\n## Appendix\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-03-01 - Look Into Locky Ransomware.pdf"
    ],
    "report_names": [
        "2016-03-01 - Look Into Locky Ransomware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536126,
    "ts_updated_at": 1743041165,
    "ts_creation_date": 1653705024,
    "ts_modification_date": 1653705024,
    "files": {
        "pdf": "https://archive.orkl.eu/3547be394c7a86af110f4db6204e4a3706855d6b.pdf",
        "text": "https://archive.orkl.eu/3547be394c7a86af110f4db6204e4a3706855d6b.txt",
        "img": "https://archive.orkl.eu/3547be394c7a86af110f4db6204e4a3706855d6b.jpg"
    }
}