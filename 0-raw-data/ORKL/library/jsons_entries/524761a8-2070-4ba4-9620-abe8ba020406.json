{
    "id": "524761a8-2070-4ba4-9620-abe8ba020406",
    "created_at": "2023-01-12T15:06:19.542494Z",
    "updated_at": "2025-03-27T02:05:56.772612Z",
    "deleted_at": null,
    "sha1_hash": "ffb31815755fcf3c8b7140cd314d73354370ec6b",
    "title": "2016-03-23 - New self‑protecting USB trojan able to avoid detection",
    "authors": "",
    "file_creation_date": "2022-05-28T01:24:03Z",
    "file_modification_date": "2022-05-28T01:24:03Z",
    "file_size": 448752,
    "plain_text": "# New self‑protecting USB trojan able to avoid detection\n\n**[welivesecurity.com/2016/03/23/new-self-protecting-usb-trojan-able-to-avoid-detection/](http://www.welivesecurity.com/2016/03/23/new-self-protecting-usb-trojan-able-to-avoid-detection/)**\n\nMarch 23, 2016\n\nA unique data-stealing trojan has been spotted on USB devices in the wild – and it is\ndifferent from typical data-stealing malware, reports ESET's Tomáš Gardoň.\n\n[Tomáš Gardoň](https://www.welivesecurity.com/author/tgardon/)\n23 Mar 2016 - 02:49PM\n\nA unique data-stealing trojan has been spotted on USB devices in the wild – and it is\ndifferent from typical data-stealing malware, reports ESET’s Tomáš Gardoň.\n\n\n-----\n\nA unique data-stealing trojan has been spotted on USB devices in the wild – and it is\ndifferent from typical data-stealing malware. Each instance of this trojan relies on the\nparticular USB device on which it is installed and it leaves no evidence on the compromised\nsystem. Moreover, it uses a very special mechanism to protect itself from being reproduced\nor copied, which makes it even harder to detect.\n\nIn this article we will examine the technical details of this interesting malware.\n\n”What really sets this malware apart is its self-protection mechanism.”\n\nWhere other malware uses ‘good old-fashioned approaches’ like Autorun files or crafted\nshortcuts in order to get users to run it, USB Thief uses also another technique. This\nmethod depends on the increasingly common practice of storing portable versions of\npopular applications such as Firefox, NotePad++ and TrueCrypt on USB drives.\n\nThe malware takes advantage of this trend by inserting itself into the command chain of\nsuch applications, in the form of a plugin or a dynamically linked library (DLL). And\ntherefore, whenever such an application is executed, the malware will also be run in the\nbackground.\n\nWhat really sets this malware apart, however, is its self-protection mechanism.\n\n## The protection mechanism\n\nThe malware consists of six files. Four of them are executables and the other two contain\nconfiguration data. To protect itself from copying or reverse engineering, the malware uses\ntwo techniques. Firstly, some of the individual files are AES128-encrypted; secondly, their\nfilenames are generated from cryptographic elements.\n\nThe AES encryption key is computed from the unique USB device ID, and certain disk\nproperties of the USB drive hosting the malware. Hence, the malware can only run\nsuccessfully from that particular USB device.\n\nThe name of the next file in malware execution chain is based on actual file content and its\ncreation time. It is the first five bytes of SHA512 hash computed from mentioned attributes\n(file content concatenated with eight bytes of the creation time).\n\nBecause of this, filenames are different for every instance of this malware. Moreover,\ncopying malware to a different place will replace the file creation time so that malicious\nactions associated with the previous locality cannot be reproduced. For a better\nunderstanding of the naming technique, please see the image below.\n\nIt was quite challenging to analyze this malware because we had no access to any\nmalicious USB device. Moreover, we had no dropper, so we could not create a suitably\nafflicted USB drive under controlled conditions for further analysis.\n\n\n-----\n\nOnly the submitted files can be analyzed, so the unique device ID had to be brute-forced\nand combined with common USB disk properties. Moreover, after successful decryption of\nthe malware files, we had to find out the right order of the executables and configuration\nfiles, because the file copying process to get the samples to us had changed the file\ncreation timestamp on the samples.\n\nThe execution flow of malware is quite simple. Each loader, in turn, loads and executes the\nfollowing loader identified by computed hash according to the naming technique described\nabove. However the execution must always start with the first stage loader, otherwise the\nmalware terminates itself.\n\n## First stage loader\n\n\n-----\n\nThe first stage loader is just the malware s starting point and its main goal is to trick the user\ninto running it. This can be done in several ways, but the most interesting is the use of\nportable applications. We have seen portable Notepad++ compromised by a malicious\nplugin as well as a TrueCrypt portable compromised by a malicious “RichEd20.dll”. This\nloader also checks whether it is executed from a USB device and whether it is writeable,\nwhich is important because the payload will store stolen data here.\n\n## Second stage loader\n\nThe second stage loader is located using the first stage hash. Subsequently, its\nconfiguration file is found using its own hash. The configuration file contains the encrypted\nname of the parent process to be verified. This is an anti-debugging trick, which will cause\ntermination of the malware if it is running under a different parent process, i.e. a debugger.\nFinally, the hash of the configuration file is used to compute the name of the third stage\nloader.\n\n## Third stage loader\n\nThe third stage loader handles some anti-AV checks. If one of the processes running is\n“avpui.exe” (Kaspersky security software) or “AVKTray.exe” (G Data security software) is\nrunning, execution is stopped.\n\nIts configuration file is found by same technique as used by its predecessor, as is the\npayload executable. It also creates a named pipe to be used to pass the configuration data\nto the payload. The pipe name consists of the first 30 bytes of a SHA512 hash computed\nfrom the computer name.\n\n## Payload\n\nFinally, the payload implements the actual data-stealing functionality. The executable is\ninjected into a newly created “%windir%\\system32\\svchost.exe -k netsvcs” process.\nConfiguration data includes information on what data should be gathered, how they should\nbe encrypted, and where they should be stored.\n\nThe output destination must always be on the same removable device. In the case we\nanalyzed, it was configured to steal all data files such as images or documents, the whole\nwindows registry tree (HKCU), file lists from all of the drives, and information gathered using\nan imported open-source application called “WinAudit”. It encrypts the stolen data using\n[elliptic curve cryptography.](https://en.wikipedia.org/wiki/Elliptic_curve_cryptography)\n\n## Conclusion\n\n\n-----\n\nIt would not be difficult to redesign the malware to change from a data-stealing\npayload to any other malicious payload.”\n\nIn addition to the interesting concept of self-protecting multi-stage malware, the (relatively\nsimple) data-stealing payload is very powerful, especially since it does not leave any\nevidence on the affected computer. After the USB is removed, nobody can find out that data\nwas stolen.Also, it would not be difficult to redesign the malware to change from a datastealing payload to any other malicious payload.\n\nAs ESET’s statistics shows, that malware is not very widespread. However, it possesses the\nability to be used in targeted attacks – especially at computers that are not connected to the\ninternet for security reasons.\n\nOur detection name:\n\npayload: Win32/PSW.Stealer.NAI trojan\nloaders : Win32/TrojanDropper.Agent.RFT trojan\n\nSHA1 hashes of decrypted binaries:\n\n2C188C395AB32EAA00E6B7AA031632248FF38B2E\nB03ABE820C0517CCEF98BC1785B7FD4CDF958278\n66D169E1E503725A720D903E1DFAF456DB172767\n4B2C60D77915C5695EC9D3C4364E6CD6946BD33C\n76471B0F34ABB3C2530A16F39E10E4478CB6816D\n\n23 Mar 2016 - 02:49PM\n\n### Sign up to receive an email update whenever a new article is published in our Ukraine Crisis – Digital Security Resource Center\n\n Newsletter\n\n Discussion\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-03-23 - New self‑protecting USB trojan able to avoid detection.pdf"
    ],
    "report_names": [
        "2016-03-23 - New self‑protecting USB trojan able to avoid detection.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535979,
    "ts_updated_at": 1743041156,
    "ts_creation_date": 1653701043,
    "ts_modification_date": 1653701043,
    "files": {
        "pdf": "https://archive.orkl.eu/ffb31815755fcf3c8b7140cd314d73354370ec6b.pdf",
        "text": "https://archive.orkl.eu/ffb31815755fcf3c8b7140cd314d73354370ec6b.txt",
        "img": "https://archive.orkl.eu/ffb31815755fcf3c8b7140cd314d73354370ec6b.jpg"
    }
}